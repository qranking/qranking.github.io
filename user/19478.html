<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (youcune)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (youcune さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>727</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/fcfb4ad3d7c1edf9dc96">シェルスクリプトを書くときはset -euしておく</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-03 17:56:47</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ShellScript]</b> <b>[Bash]</b> <b>[Linux]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>1行目を</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -eu</span>
</pre></div></div>

<p>とするか、または、</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">set</span> -eu
</pre></div></div>

<p>を書いておく。以下解説。</p>

<h2>
<span id="set--e" class="fragment"></span><a href="#set--e"><i class="fa fa-link"></i></a><code>set -e</code>
</h2>

<p>エラーがあったらシェルスクリプトをそこで打ち止めにしてくれる（<code>exit 0</code>以外が返るものがあったら止まるようになる）。「あっあれここでうまくいってないからデータ準備できてないのにあれあれっもうやめて！」ってなるのを防げる。</p>

<h2>
<span id="set--u" class="fragment"></span><a href="#set--u"><i class="fa fa-link"></i></a><code>set -u</code>
</h2>

<p>未定義の変数を使おうとしたときに打ち止めにしてくれる。Perlでいう<code>use strict 'vars';</code>的なもの。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>rm -rf <span class="nv">$TMEP_DIR</span>/
</pre></div></div>

<p>って気軽な気持ちで書いてしまって、「ん、やたら時間かかると思ったらスペルミスうわなにをするやめ」ってなるのを防げる。</p>

<h2>
<span id="一部だけ例外にしたい" class="fragment"></span><a href="#%E4%B8%80%E9%83%A8%E3%81%A0%E3%81%91%E4%BE%8B%E5%A4%96%E3%81%AB%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>一部だけ例外にしたい</h2>

<p>はてなブックマークのコメントより</p>

<blockquote>
<p>-e は command1 || command2 みたいなことが出来なくなるの使うことないな。-uは付けといて良いが。</p>
</blockquote>

<p>確かにおっしゃるとおりですね。コマンドの失敗を考慮して書いている部分については（もしくはやたら<code>exit 0</code>以外するコマンドを呼ばないといけないときなど）、スクリプトの一部に限り <code>-e</code> を無効にしたいかもしれません。そんなときは以下のようにできます。こうするとエラーハンドリングを全部しっかり考えて作っていない限りは使わない意味はない気がします。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">set</span> -eu

<span class="c1"># :</span>
<span class="c1"># do something</span>
<span class="c1"># :</span>

<span class="c1"># ここからは set -e を無効にする</span>
<span class="nb">set</span> +e

command1 <span class="o">||</span> command2

<span class="c1"># ここからは再度有効にする</span>
<span class="nb">set</span> -e

<span class="c1"># :</span>
<span class="c1"># do something</span>
<span class="c1"># :</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>247</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/222777415f00d19cccb4">システムのgemにrailsをインストールせずrails newする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-06 09:29:10</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[bundler]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>よく入門書で</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ gem install rails
$ rails new project
</pre></div></div>

<p>みたいにしろと書いてありますが、これだとシステムのgemにインストールされます。システムのgemはbundlerいっこにして、必要なものは<code>vendor/bundle</code>に格納し、<code>bundle exec</code>で呼び出すのがクリーンでいいですよね。下記のようにします。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ gem install bundler
$ mkdir project
$ <span class="nb">cd</span> project
$ bundle init
Writing new Gemfile to /path/to/project/Gemfile
</pre></div></div>

<p>のように、Gemfileだけ生まれるので、</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ vi Gemfile
<span class="c1"># A sample Gemfile</span>
<span class="nb">source</span> <span class="s2">"https://rubygems.org"</span>

gem <span class="s2">"rails"</span>
</pre></div></div>

<p>のようにコメントアウトを外してやります。あとは</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ bundle install --path vendor/bundle
$ bundle <span class="nb">exec</span> rails new .
</pre></div></div>

<p>でOK。Gemfileが存在するので上書きするかどうか聞いてきますが上書きしちゃってください。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>156</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/5b783f7fde45d0fd4b35">gem install pgしてNo pg_configとなる対処法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-05 14:52:24</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Gem]</b> <b>[rubygems]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="ubuntuなどdebian系" class="fragment"></span><a href="#ubuntu%E3%81%AA%E3%81%A9debian%E7%B3%BB"><i class="fa fa-link"></i></a>UbuntuなどDebian系</h2>

<p>UbuntuなどDebian系は、<a href="http://toriniku.hatenablog.com/entry/20111012/1318390958" rel="nofollow noopener" target="_blank">pg_config... no →libpq-dev いれとけ - 鶏肉がいいよね。</a>によると、</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ sudo aptitude install libpq-dev
</pre></div></div>

<p>とするとよさげ。</p>

<h2>
<span id="centosなどredhat系" class="fragment"></span><a href="#centos%E3%81%AA%E3%81%A9redhat%E7%B3%BB"><i class="fa fa-link"></i></a>CentOSなどRedhat系</h2>

<p>CentOSなどRedhat系では、</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ sudo yum -y install postgresql-devel
</pre></div></div>

<p>でよさそう。</p>

<h2>
<span id="mac-os-x" class="fragment"></span><a href="#mac-os-x"><i class="fa fa-link"></i></a>Mac OS X</h2>

<p>Mac OS Xでは、homebrewが入っていれば</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ brew install postgresql
</pre></div></div>

<p>とする。そしたら <code>/usr/local/Cellar/postgresql/9.3.2/bin/pg_config</code> あたりにpg_configが生まれる。</p>

<h2>
<span id="pg_configがあるはずと思う場合" class="fragment"></span><a href="#pg_config%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AF%E3%81%9A%E3%81%A8%E6%80%9D%E3%81%86%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>pg_configがあるはずと思う場合</h2>

<p>自分の場合はPostgreSQL 9.3をインストールしていて、デフォルトとは別の場所にpg_configファイルがあったので、以下のようにして場所を指定してやった。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ gem install pg --with-pg-config<span class="o">=</span>/usr/pgsql-9.3/bin/pg_config
</pre></div></div>

<p>また、bundle installの中でこのエラーが出るようなら、以下のようにしてbundle installの過程でインストールされるgemに引数を渡せる模様。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ bundle config build.pg --with-pg-config<span class="o">=</span>/usr/pgsql-9.3/bin/pg_config
$ bundle install
</pre></div></div>

<h2>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h2>

<ul>
<li><a href="http://toriniku.hatenablog.com/entry/20111012/1318390958" rel="nofollow noopener" target="_blank">pg_config... no →libpq-dev いれとけ - 鶏肉がいいよね。</a></li>
<li><a href="http://stackoverflow.com/questions/5167829/how-can-i-pass-a-parameter-for-gem-installation-when-i-run-bundle-install" rel="nofollow noopener" target="_blank">ruby on rails - How can I pass a parameter for gem installation when I run bundle install? - Stack Overflow</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>109</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/a5cc93313641b69b62f8">CentOSでrbenvをシステムにインストールする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-09 19:10:42</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[CentOS]</b> <b>[rbenv]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>rbenvのよくあるインストール手順はユーザのホームディレクトリに入れるパターンが多いですが、複数ユーザで共有したかったのでシステムにインストールしてみることにしました。ここでは /usr/local/rbenv にインストールするものとして説明します。別の場所にインストールする場合は適宜よみかえてください。以下その手順です。</p>

<p>まずビルドに必要なパッケージを導入します。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># yum install -y git gcc gcc-c++ openssl-devel readline-devel</span>
</pre></div></div>

<p>次にソースをとってきます。下記の例では <code>/usr/local</code> にインストールすることにします。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># cd /usr/local</span>
<span class="c1"># git clone git://github.com/sstephenson/rbenv.git rbenv</span>
<span class="c1"># git clone git://github.com/sstephenson/ruby-build.git rbenv/plugins/ruby-build</span>
</pre></div></div>

<p>ぼくの環境のCentOS 6.5では、全ユーザの <code>.bashrc</code> の中で <code>/etc/profile.d/</code> 配下がロードされるようになっていました。なので、PATHの設定を全ユーザに反映させるため、 <code>/etc/profile.d/rbenv.sh</code> とかを作成し下記のように書きます。 <code>--no-rehash</code> をつけないとログインのたび rehash するので遅くなるようです。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">/etc/profile.d/rbenv.sh</span></div>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">RBENV_ROOT</span><span class="o">=</span><span class="s2">"/usr/local/rbenv"</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RBENV_ROOT</span><span class="si">}</span><span class="s2">/bin:</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">eval</span> <span class="s2">"</span><span class="k">$(</span>rbenv init --no-rehash -<span class="k">)</span><span class="s2">"</span>
</pre></div>
</div>

<p>上記をロードします。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># source /etc/profile.d/rbenv.sh</span>
</pre></div></div>

<p>Rubyは下記のようにrootでインストールします。gemは、<a href="http://qiita.com/youcune/items/222777415f00d19cccb4" id="reference-fc3537484390a7321dfb">システムにはbundlerだけ入れておいてあとはpathを指定して管理するのがよい</a>でしょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># rbenv install 2.1.0</span>
<span class="c1"># gem install bundler --no-ri --no-rdoc</span>
</pre></div></div>

<h2>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h2>

<ul>
<li><a href="http://office.tsukuba-bunko.org/ppoi/entry/systemwide-rbenv" rel="nofollow noopener" target="_blank">rbenvをシステムワイドにインストールする » つくば日記(仮)</a></li>
<li><a href="http://qiita.com/sonots/items/a309520b9cce1b7631a5" id="reference-19f6e4671c1f15c95491">Ruby - オレオレ rbenv 運用 Tips - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />5位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>88</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/12b153c08db695952e47">僕の中でRailsのflashの使い方が落ち着いてきた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-26 16:11:04</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[bootstrap]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ご報告です。今まで試行錯誤という感じで使っていたのですが、Railsのflashの使い方が落ち着いてきました。</p>

<h2>
<span id="そもそもflashとは" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82flash%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>そもそもflashとは</h2>

<p>セッションに一時的にメッセージを入れておける機能です。何も考えずに使うと次回のリクエストに有効です。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">some_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'そのページはログインしないと見れないよ！'</span>
<span class="n">redirect_to</span> <span class="n">login_path</span>
</pre></div>
</div>

<p>のように使うのが有効と思います。詳しくは調べてください。</p>

<h2>
<span id="bootstrapとともに使う" class="fragment"></span><a href="#bootstrap%E3%81%A8%E3%81%A8%E3%82%82%E3%81%AB%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>Bootstrapとともに使う</h2>

<p>上記のように説明されることが多い flash ですが、実態は Hash なので、任意のキーが使用できます。ぼくはよく Bootstrap を使うので、 Alerts コンポーネントと組み合わせて使っています。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">some_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'success!'</span>
<span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'info'</span>
<span class="n">flash</span><span class="o">[</span><span class="ss">:warning</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'warning'</span>
<span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'danger'</span>
</pre></div>
</div>

<div class="code-frame" data-lang="haml">
<div class="code-lang"><span class="bold">some_view.html.haml</span></div>
<div class="highlight"><pre><span></span><span class="p">-</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">type</span><span class="p">,</span> <span class="n">msg</span><span class="o">|</span>
  <span class="nt">%div</span><span class="p">{</span><span class="ss">class</span><span class="p">:</span> <span class="s2">"alert alert-</span><span class="si">#{</span><span class="n">type</span><span class="si">}</span>"}= msg
</pre></div>
</div>

<p>のようにするのに落ち着きました。</p>

<p>ご意見大歓迎です。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />6位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>87</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/ec1d0b34bd542d8c7f2f">Rails(ActiveRecord)でN:Nの自己結合を実装する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-05 08:06:32</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[ActiveRecord]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Twitterみたいなユーザ同士をフォローする仕組みを実装するにあたり、ActiveRecordでN:Nの自己結合を実装するのにちょっとハマったので書いておきます。</p>

<h2>
<span id="前提" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90"><i class="fa fa-link"></i></a>前提</h2>

<ul>
<li>usersテーブルがある</li>
<li>User同士のフォロー関係を登録するfollowsテーブルがある</li>
</ul>

<p>具体的なmigrationは以下。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">20130825021654_create_users.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>
      <span class="c1"># :</span>
      <span class="c1"># :</span>
      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">20140303134930_create_follows.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CreateFollows</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:follows</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:from_user_id</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:to_user_id</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>

      <span class="n">t</span><span class="o">.</span><span class="n">index</span> <span class="ss">:from_user_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">index</span> <span class="ss">:to_user_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">index</span> <span class="o">[</span><span class="ss">:from_user_id</span><span class="p">,</span> <span class="ss">:to_user_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="やりたいこと" class="fragment"></span><a href="#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>やりたいこと</h2>

<p>下記のようなインターフェイスで実装したいとします。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">following</span> <span class="c1"># フォローしているUserの配列が返る</span>
<span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>  <span class="c1"># フォローされているUserの配列が返る</span>
</pre></div></div>

<h2>
<span id="ハマりポイント" class="fragment"></span><a href="#%E3%83%8F%E3%83%9E%E3%82%8A%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>ハマりポイント</h2>

<ul>
<li>リレーションがN:N</li>
<li>Railsのデフォルトでは <code>user_id</code> を結合に使うが、今回は同じテーブルを結合するので使えない</li>
</ul>

<h2>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h2>

<p>まずUserからFollow、FollowからUserに1:Nのリレーションをはります。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">user.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">has_many</span> <span class="ss">:follows</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:from_user_id</span>
</pre></div>
</div>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">follow.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">belongs_to</span> <span class="ss">:from_user</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="no">User</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:from_user_id</span>
</pre></div>
</div>

<p>こうすると、 <code>User.find(1).follows</code> でFollowが、　<code>Follow.find(1).from_user</code> でフォロー元のUserというリレーションができます。次に、これら1:Nのリレーションを結合する設定をUserに追加します。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">user.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">has_many</span> <span class="ss">:follows</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:from_user_id</span>
<span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:follows</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:to_user</span> <span class="c1"># ← 追加</span>
</pre></div>
</div>

<p>これで、 <code>User.find(1).following</code> でフォロー先のUserの配列が取得できるようになりました。followed側も同様に実装できます。</p>

<h2>
<span id="最終形" class="fragment"></span><a href="#%E6%9C%80%E7%B5%82%E5%BD%A2"><i class="fa fa-link"></i></a>最終形</h2>

<p>最終的に下記のようになりました。条件の異なる2つの <code>has_many :follows</code> が必要になるのでリネームしました。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">user.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">has_many</span> <span class="ss">:follows_from</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="no">Follow</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:from_user_id</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
<span class="n">has_many</span> <span class="ss">:follows_to</span><span class="p">,</span>   <span class="ss">class_name</span><span class="p">:</span> <span class="no">Follow</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:to_user_id</span><span class="p">,</span>   <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
<span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:follows_from</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:to_user</span>
<span class="n">has_many</span> <span class="ss">:followed</span><span class="p">,</span>  <span class="ss">through</span><span class="p">:</span> <span class="ss">:follows_to</span><span class="p">,</span>   <span class="ss">source</span><span class="p">:</span> <span class="ss">:from_user</span>
</pre></div>
</div>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">follow.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">belongs_to</span> <span class="ss">:from_user</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="no">User</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:from_user_id</span>
<span class="n">belongs_to</span> <span class="ss">:to_user</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="no">User</span><span class="p">,</span>   <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:to_user_id</span>
</pre></div>
</div>

<h2>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h2>

<p>下記のようなインターフェイスを追加したくなりました。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">user.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">user</span><span class="o">.</span><span class="n">followed_by?</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>

<p>最初は下記のように <code>any?</code> にブロックを渡して評価していました。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">user.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<p>しかしこれでは普通にSELECT文が走って全件インスタンス化しているようだったので下記のようにしてみたところ、 <code>SELECT COUNT(*)</code> が走るようになったのでこちらのほうがパフォーマンスがよいでしょう。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">user.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 指定ユーザをフォローしているかどうかを返す</span>
<span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">any?</span>
<span class="k">end</span>

<span class="c1"># 指定ユーザにフォローされているかどうかを返す</span>
<span class="k">def</span> <span class="nf">followed_by?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">followed</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">any?</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />7位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>57</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/143e46aa1ee079f5a57c">SVNからgitへの移行</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-31 21:03:57</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> <b>[svn]</b> <b>[GitLab]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="svnからgitへの移行" class="fragment"></span><a href="#svn%E3%81%8B%E3%82%89git%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C"><i class="fa fa-link"></i></a>SVNからgitへの移行</h1>

<p>社内プロジェクトをSVNからGitLab上で管理されているgitリポジトリに移行してみましたのでその手順をまとめてみます。</p>

<p>まずSVNのワーキングディレクトリで下記を実行します。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ svn log --xml <span class="p">|</span> grep <span class="s2">"&lt;author"</span> <span class="p">|</span> sort -u <span class="p">|</span> perl -pe <span class="s1">'s/&lt;author&gt;(.*?)&lt;\/author&gt;/$1 = /'</span> &gt; users.txt
</pre></div></div>

<p>最近のMacではgrep -Pオプションがなくなったらしいので、<a href="http://git-scm.com/book/ja/ch8-2.html" rel="nofollow noopener" target="_blank">Gitへの移行</a>の手順から若干アレンジしています。そうしたらusers.txtにSVNにコミットしたユーザの一覧ができるので、名前とメールアドレスを設定していきます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Subversionのユーザ名 = Gitのユーザ名 &lt;メールアドレス&gt; 
</pre></div></div>

<p>こんな感じです。GitLabで管理したかったので、自分の知ってる人であるような気がするユーザ名はGitLab上の名前とメールアドレスを一致させました。</p>

<p>次に、ワーキングディレクトリの外に別のディレクトリを作ります。この作業ではSVNから取り直すみたいなのでもうワーキングディレクトリは用済みです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ git svn clone --no-metadata -A users.txt -t tags -b branches -T trunk http://hogehoge.jp/svn
</pre></div></div>

<p>こんな感じみたいです。で、ここでエラーがいろいろでます。</p>

<h2>
<span id="author--not-defined-in-userstxt-file-の対処法" class="fragment"></span><a href="#author--not-defined-in-userstxt-file-%E3%81%AE%E5%AF%BE%E5%87%A6%E6%B3%95"><i class="fa fa-link"></i></a>Author: ***** not defined in users.txt file の対処法</h2>

<p>なぜか知らないけどusers.txtに入っていないみたいです。users.txtに手作業で指摘されたユーザを追加してコマンド再実行でうまくいきました。</p>

<h2>
<span id="found-possible-branch-point-の対処法" class="fragment"></span><a href="#found-possible-branch-point-%E3%81%AE%E5%AF%BE%E5%87%A6%E6%B3%95"><i class="fa fa-link"></i></a>Found possible branch point の対処法</h2>

<p>gitリポジトリの中の.git/configから</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>branches = branches/*:refs/remotes/svn/branches/*
tags = tags/*:refs/remotes/svn/tags/*
</pre></div></div>

<p>みたいなのを消して再実行するとうまくいきました（<a href="http://stackoverflow.com/questions/15387812/git-svn-found-possible-branch-point" rel="nofollow noopener" target="_blank">参考</a>）。</p>

<p>あとはブランチとタグをもってくるんですが、<a href="http://git-scm.com/book/ja/ch8-2.html" rel="nofollow noopener" target="_blank">Git - Git への移行</a>の通りで特に難なくできたのでこっちを見て下さい。</p>

<p>また、こうするとファイルのタイムスタンプが作業した時刻になってしまうため、 <a href="http://qiita.com/Koichi-Kobayashi@github/items/47e37f02268d402e38a5" id="reference-1d4c89d131d892710ee5">SVNからGitに移行した後にやること - Qiita [キータ]</a> に書いてある方法でコミットしたタイムスタンプに変更できます。</p>

<h1>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h1>

<ul>
<li><a href="http://git-scm.com/book/ja/ch8-2.html" rel="nofollow noopener" target="_blank">Git - Git への移行</a></li>
<li><a href="http://d.hatena.ne.jp/next49/20130408/p2" rel="nofollow noopener" target="_blank">SubversionのリポジトリからGitに移行する - 発声練習</a></li>
<li><a href="http://stackoverflow.com/questions/15387812/git-svn-found-possible-branch-point" rel="nofollow noopener" target="_blank">git svn - Git Svn - Found possible branch point - Stack Overflow</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />8位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>31</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/f5371d449d2486c67357">Rangeの範囲内からランダムに数値を選ぶ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-22 20:26:54</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="誤りの例" class="fragment"></span><a href="#%E8%AA%A4%E3%82%8A%E3%81%AE%E4%BE%8B"><i class="fa fa-link"></i></a>誤りの例</h2>

<p>以下で一見良さそうなんですが、そもそもやりたいことができません。Rangeオブジェクトいっこの配列ができるので、この返り値はRangeになります。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="o">[</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">10000</span><span class="o">].</span><span class="n">sample</span>
</pre></div></div>

<h2>
<span id="好ましくない例" class="fragment"></span><a href="#%E5%A5%BD%E3%81%BE%E3%81%97%E3%81%8F%E3%81%AA%E3%81%84%E4%BE%8B"><i class="fa fa-link"></i></a>好ましくない例</h2>

<p>これもダメです。to_aしたらメモリに展開され、数が少なければそんなに影響ないですが、多いと悲劇になります。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">10000</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sample</span>
</pre></div></div>

<h2>
<span id="よい例" class="fragment"></span><a href="#%E3%82%88%E3%81%84%E4%BE%8B"><i class="fa fa-link"></i></a>よい例</h2>

<p>Random#randは引数にRangeを渡せます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="no">Random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />9位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>28</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/71e18e7bd5219b4a07f8">Middlemanでsitemap.xmlを生成する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-13 17:52:27</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[middleman]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="builderでxml構築" class="fragment"></span><a href="#builder%E3%81%A7xml%E6%A7%8B%E7%AF%89"><i class="fa fa-link"></i></a>builderでXML構築</h2>

<p>Middlemanをつかっていて、sitemap.xmlを生成したいと思ったのでいろいろ調べて試してみました。大まかな方針は、builderを使ってsitemapから必要なものを取り出してXMLを生成します。</p>

<p>まず、 <code>Gemfile</code> に下記1行を追加して <code>bundle install</code> します。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s1">'builder'</span>
</pre></div></div>

<p>次に、 <code>source/sitemap.xml.builder</code> を作成し、下記追加します。 <code>http://example.com</code> の部分は各自の環境に合わせて変更してください。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="ss">layout</span><span class="p">:</span> <span class="kp">false</span>
<span class="o">---</span>
<span class="n">xml</span><span class="o">.</span><span class="n">instruct!</span>
<span class="n">xml</span><span class="o">.</span><span class="n">urlset</span> <span class="s2">"xmlns"</span> <span class="o">=&gt;</span> <span class="s2">"http://www.sitemaps.org/schemas/sitemap/0.9"</span> <span class="k">do</span>
  <span class="n">sitemap</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">resource</span><span class="o">|</span>
    <span class="n">xml</span><span class="o">.</span><span class="n">url</span> <span class="k">do</span>
      <span class="n">xml</span><span class="o">.</span><span class="n">loc</span> <span class="s2">"http://example.com</span><span class="si">#{</span><span class="n">resource</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span> <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">destination_path</span> <span class="o">=~</span> <span class="sr">/\.html$/</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>上記の方法で、 <code>*.html</code> ファイルのみを対象に <code>sitemap.xml</code> を生成できます。あとは Search Console で設定してあげると完了です。</p>

<h2>
<span id="応用例" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>応用例</h2>

<p>これで必要最低限のものはそろっています。ほかにフィールドを追加したければ少し工夫が必要です。</p>

<h3>
<span id="lastmod" class="fragment"></span><a href="#lastmod"><i class="fa fa-link"></i></a>lastmod</h3>

<p>必須フィールドではないのでなくてもいいですが、クローラーに更新を伝えるために指定しておきたい気がします。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">xml</span><span class="o">.</span><span class="n">lastmod</span> <span class="no">File</span><span class="o">.</span><span class="n">mtime</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">source_file</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-%d'</span><span class="p">)</span>
</pre></div></div>

<p>上記のようにすると、ファイルの更新日時のタイムスタンプが入ります。ただ、自分の場合はgit管理していて、他のマシンでpullするとずれてしまいます。ここはFrontmatterで指定するのがいい気がします。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>---
modifiy_date: 2014-01-13
---
</pre></div></div>

<p>上記のような感じで追加しておき、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>lastmod = resource.data.modify_date.presence || resource.data.date.presence
xml.lastmod lastmod if lastmod.present?
</pre></div></div>

<p>のようにしておくと、 <code>modify_date</code> を見て、ない場合は <code>date</code> が入り、それもない場合は <code>lastmod</code> 要素自体が生成されなくなります。</p>

<h3>
<span id="changefreq--priority" class="fragment"></span><a href="#changefreq--priority"><i class="fa fa-link"></i></a>changefreq / priority</h3>

<p>ぼくは <code>changefreq</code> や <code>priority</code> を指定するために、ファイル名のパターンを定義しておいて、マッチすればその値を書き出すようにしています。たとえば以下のような感じです。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">changefreqs</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'index.html'</span> <span class="o">=&gt;</span> <span class="ss">:weekly</span><span class="p">,</span>
  <span class="sr">/^mono\//</span> <span class="o">=&gt;</span> <span class="ss">:daily</span>
<span class="p">}</span>
<span class="c1"># :</span>
<span class="c1"># : 中略</span>
<span class="c1"># :</span>
<span class="n">changefreqs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="p">,</span> <span class="n">freq</span><span class="o">|</span>
  <span class="k">next</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">resource</span><span class="o">.</span><span class="n">destination_path</span> <span class="o">!=</span> <span class="n">file</span>
  <span class="k">next</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Regexp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">resource</span><span class="o">.</span><span class="n">destination_path</span> <span class="o">!~</span> <span class="n">file</span>
  <span class="n">xml</span><span class="o">.</span><span class="n">changefreq</span> <span class="n">freq</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">break</span>
<span class="k">end</span>
</pre></div></div>

<p><a href="https://raw.githubusercontent.com/youcune/youcune.com/master/source/sitemap.xml.builder" rel="nofollow noopener" target="_blank">全文はGithubにあげている</a>ので参照してみてください。もっといい方法があればコメントでおしえてください！</p>

<h2>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h2>

<ul>
<li><a href="https://github.com/middleman/middleman/issues/259" rel="nofollow noopener" target="_blank">Sitemap generator · Issue #259 · middleman/middleman</a></li>
<li><a href="http://www.e2esound.com/wp/2013/12/10/getting_started_sitemap/" rel="nofollow noopener" target="_blank">Middleman のサイトマップを使ってみる | e2esound.com業務日誌</a></li>
<li><a href="http://holy-seo.net/blog/seo/sitemap-sml-method-described-merit/" rel="nofollow noopener" target="_blank">sitemap.xmlの記載方法と書式、設置する事で得られるメリット | SEO Imagination！ブログ</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />10位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>23</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/43a2c83fc7c70d468f53">apple-touch-iconの機種/OS別サイズとlinkタグの書き方</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-21 11:30:05</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML5]</b> <b>[iOS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>iOS7でapple-touch-iconのサイズが変わっていたので調べてみました。</p>

<table>
<thead>
<tr>
<th style="text-align: center">機種</th>
<th style="text-align: center">iOS</th>
<th style="text-align: center">Retina</th>
<th style="text-align: center">非Retina</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">iPhone</td>
<td style="text-align: center">～6</td>
<td style="text-align: center">114x114</td>
<td style="text-align: center">57x57</td>
</tr>
<tr>
<td style="text-align: center">iPhone</td>
<td style="text-align: center">7～8</td>
<td style="text-align: center">120x120</td>
<td style="text-align: center">なし *1</td>
</tr>
<tr>
<td style="text-align: center">iPhone6Plus</td>
<td style="text-align: center">8</td>
<td style="text-align: center">180x180</td>
<td style="text-align: center">なし *1</td>
</tr>
<tr>
<td style="text-align: center">iPad *2</td>
<td style="text-align: center">～6</td>
<td style="text-align: center">144x144</td>
<td style="text-align: center">72x72</td>
</tr>
<tr>
<td style="text-align: center">iPad *2</td>
<td style="text-align: center">7～8</td>
<td style="text-align: center">152x152</td>
<td style="text-align: center">76x76</td>
</tr>
</tbody>
</table>

<p>*1 RetinaでないiPhone(3GS/3G)はiOS7にアップグレードできない<br>
*2 iPad/iPad miniは画面サイズは違うが解像度は同じ</p>

<h2>
<span id="linkタグの書き方" class="fragment"></span><a href="#link%E3%82%BF%E3%82%B0%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9"><i class="fa fa-link"></i></a>linkタグの書き方</h2>

<p><a href="https://developer.apple.com/library/ios/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html" rel="nofollow noopener" target="_blank">Safari Web Content Guide: Configuring Web Applications</a> より引用。サイズごとに別のファイルを指定できる。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"apple-touch-icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"touch-icon-iphone.png"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"apple-touch-icon"</span> <span class="na">sizes</span><span class="o">=</span><span class="s">"76x76"</span> <span class="na">href</span><span class="o">=</span><span class="s">"touch-icon-ipad.png"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"apple-touch-icon"</span> <span class="na">sizes</span><span class="o">=</span><span class="s">"120x120"</span> <span class="na">href</span><span class="o">=</span><span class="s">"touch-icon-iphone-retina.png"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"apple-touch-icon"</span> <span class="na">sizes</span><span class="o">=</span><span class="s">"152x152"</span> <span class="na">href</span><span class="o">=</span><span class="s">"touch-icon-ipad-retina.png"</span><span class="p">&gt;</span>
</pre></div></div>

<p>sizes属性を省略すると60x60とみなされ、デバイスに最適なサイズがHTMLに明示されていない場合は最適なサイズより大きいものの中で最小のものが選択される。</p>

<h2>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h2>

<p>めんどくさいからもう256pxぐらいで作っとけばいいんじゃないですかね？</p>

<h2>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h2>

<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html" rel="nofollow noopener" target="_blank">Safari Web Content Guide: Configuring Web Applications</a></li>
<li><a href="http://stackoverflow.com/questions/19029342/favicons-best-practice-for-2013" rel="nofollow noopener" target="_blank">apple touch icon - Favicons - Best practice for 2013 - Stack Overflow</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />11位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>16</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/b1b66a709ceb7baae5fe">SQL ServerのUPDATE SET FROM JOIN (WHERE)の挙動を調べてみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-15 07:38:08</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[SQLServer]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>この記事は昔書いた記事をブログから移行したものです。</p>

<h2>
<span id="update-set-from-join-where-の挙動にはクセがある" class="fragment"></span><a href="#update-set-from-join-where-%E3%81%AE%E6%8C%99%E5%8B%95%E3%81%AB%E3%81%AF%E3%82%AF%E3%82%BB%E3%81%8C%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>UPDATE SET FROM JOIN (WHERE) の挙動にはクセがある！</h2>

<p>SQL Serverで他のテーブルの値でUPDATEしたい、ってときは、UPDATE SET FROM JOIN (WHERE)という構文がよく使われると思います。いまぼくが携わっているプロジェクトでもよく使われていたんですが、ぼくにはあまりよくわかりませんでした。と、いうことで、一体どういった動作をするのか検証してみました。</p>

<p>お急ぎの方のために結論を先に申し上げておきます。</p>

<ol>
<li>キホンは、JOINしたレコードの値でUPDATE</li>
<li>JOINの結果が0件になると、UPDATEされない</li>
<li>複数行JOINできてしまったら、TOP 1した結果でUPDATE</li>
</ol>

<p>です。それでは以下で詳しく説明していきます。</p>

<p>ここでは、STUDENTが受講したテストのSCOREを記録するというサンプルを考えてみましょう。この学校では、毎日テストが行われ（なんと休日も！）、その結果を日々記録しています。そして、全生徒の「昨日のスコア」が見れてしまうのです。生徒たちは、「あっ、アイツこんな点数取ってる」と、お互い切磋琢磨しています。「昨日のスコア」は、夜間にSCORESテーブルからSTUDENTSテーブルにコピーされ、STUDENTSテーブルは誰でも参照可能になります。</p>

<p>まず、今回使用するデータの準備です。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">STUDENTS</span><span class="p">(</span>
    <span class="n">ID</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">NAME</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">YESTERDAY_SCORE</span> <span class="nb">INTEGER</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">SCORES</span><span class="p">(</span>
    <span class="n">STUDENT_ID</span> <span class="nb">INTEGER</span> <span class="k">REFERENCES</span> <span class="n">STUDENTS</span><span class="p">(</span><span class="n">ID</span><span class="p">),</span>
    <span class="n">TEST_DATE</span> <span class="nb">DATE</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="n">GETDATE</span><span class="p">(),</span>
    <span class="n">SCORE</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">STUDENTS</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'太郎'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">STUDENTS</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'次郎'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">STUDENTS</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'三郎'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">);</span>
</pre></div></div>

<p>これで準備ができました。テーブルの中身を確認しておきましょう。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">STUDENTS</span><span class="p">;</span>
</pre></div></div>

<table>
<thead>
<tr>
<th style="text-align: center">ID</th>
<th style="text-align: center">NAME</th>
<th style="text-align: right">YESTERDAY_SCORE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1</td>
<td style="text-align: center">太郎</td>
<td style="text-align: right"><em>NULL</em></td>
</tr>
<tr>
<td style="text-align: center">2</td>
<td style="text-align: center">次郎</td>
<td style="text-align: right"><em>NULL</em></td>
</tr>
<tr>
<td style="text-align: center">3</td>
<td style="text-align: center">三郎</td>
<td style="text-align: right"><em>NULL</em></td>
</tr>
</tbody>
</table>

<h2>
<span id="キホンはjoinしたレコードの値でupdate" class="fragment"></span><a href="#%E3%82%AD%E3%83%9B%E3%83%B3%E3%81%AFjoin%E3%81%97%E3%81%9F%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%80%A4%E3%81%A7update"><i class="fa fa-link"></i></a>キホンは、JOINしたレコードの値でUPDATE</h2>

<p>今日は10月17日水曜日、大安吉日です。まず、今日のテストの結果をINSERTします。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'2012-10-17'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'2012-10-17'</span><span class="p">,</span>  <span class="mi">7</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'2012-10-17'</span><span class="p">,</span>  <span class="mi">4</span><span class="p">);</span>
</pre></div></div>

<p>太郎さんはがんばりました。では、この結果をSCORESテーブルからSTUDENTSテーブルにコピーしましょう。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">STUDENTS</span>
<span class="k">SET</span> <span class="n">YESTERDAY_SCORE</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">SCORE</span>
<span class="k">FROM</span> <span class="n">STUDENTS</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">SCORES</span>
  <span class="k">ON</span> <span class="n">STUDENTS</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">STUDENT_ID</span>
  <span class="k">AND</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">TEST_DATE</span> <span class="o">=</span> <span class="s1">'2012-10-17'</span>
<span class="p">;</span>
</pre></div></div>

<p>はい、明快です。JOINに成功したレコードの値でUPDATEされることになります。STUDENTSテーブルは以下のようになるでしょう。</p>

<table>
<thead>
<tr>
<th style="text-align: center">ID</th>
<th style="text-align: center">NAME</th>
<th style="text-align: right">YESTERDAY_SCORE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1</td>
<td style="text-align: center">太郎</td>
<td style="text-align: right">10</td>
</tr>
<tr>
<td style="text-align: center">2</td>
<td style="text-align: center">次郎</td>
<td style="text-align: right">7</td>
</tr>
<tr>
<td style="text-align: center">3</td>
<td style="text-align: center">三郎</td>
<td style="text-align: right">4</td>
</tr>
</tbody>
</table>

<p>わかりやすく、便利な機能ですね。</p>

<h2>
<span id="joinの結果が0件になるとupdateされない" class="fragment"></span><a href="#join%E3%81%AE%E7%B5%90%E6%9E%9C%E3%81%8C0%E4%BB%B6%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%A8update%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>JOINの結果が0件になると、UPDATEされない</h2>

<p>10月18日、今日は三郎さんはお休みでした。しゃあなし2人で受講しました。今日の分をINSERTします。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'2012-10-18'</span><span class="p">,</span>  <span class="mi">9</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'2012-10-18'</span><span class="p">,</span>  <span class="mi">6</span><span class="p">);</span>
</pre></div></div>

<p>では、この値をSTUDENTSテーブルにコピーするとどうなるでしょうか、ということがぼくは知りたかったのです。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">STUDENTS</span>
<span class="k">SET</span> <span class="n">YESTERDAY_SCORE</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">SCORE</span>
<span class="k">FROM</span> <span class="n">STUDENTS</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">SCORES</span>
  <span class="k">ON</span> <span class="n">STUDENTS</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">STUDENT_ID</span>
  <span class="k">AND</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">TEST_DATE</span> <span class="o">=</span> <span class="s1">'2012-10-18'</span>
<span class="p">;</span>
</pre></div></div>

<p>と、日付だけを変更して実行しました。すると「2行処理されました」と出力され、その結果は以下のようになります。</p>

<table>
<thead>
<tr>
<th style="text-align: center">ID</th>
<th style="text-align: center">NAME</th>
<th style="text-align: right">YESTERDAY_SCORE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1</td>
<td style="text-align: center">太郎</td>
<td style="text-align: right">9</td>
</tr>
<tr>
<td style="text-align: center">2</td>
<td style="text-align: center">次郎</td>
<td style="text-align: right">6</td>
</tr>
<tr>
<td style="text-align: center">3</td>
<td style="text-align: center">三郎</td>
<td style="text-align: right">4</td>
</tr>
</tbody>
</table>

<p>あれ、三郎さんのYESTERDAY_SCOREが昨日のままです。なるほど、JOINの結果が0行となるときは、UPDATEされないのですね。これではテストを受けたのかどうかわかりません。ちなみに、</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">STUDENTS</span>
<span class="k">SET</span> <span class="n">YESTERDAY_SCORE</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">SCORE</span>
<span class="k">FROM</span> <span class="n">STUDENTS</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">SCORES</span>
  <span class="k">ON</span> <span class="n">STUDENTS</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">STUDENT_ID</span>
  <span class="k">AND</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">TEST_DATE</span> <span class="o">=</span> <span class="s1">'2012-10-18'</span>
<span class="k">WHERE</span> <span class="n">STUDENTS</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">;</span>
</pre></div></div>

<p>のようにWHERE句をつけたところで、「0行処理されました」となり、やっぱりUPDATEされません。では、先ほどのSQLを以下のようにするとどうでしょうか。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">STUDENTS</span>
<span class="k">SET</span> <span class="n">YESTERDAY_SCORE</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">SCORE</span>
<span class="k">FROM</span> <span class="n">STUDENTS</span>
<span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">SCORES</span> <span class="c1">-- INNER JOIN から LEFT OUTER JOIN に変更</span>
  <span class="k">ON</span> <span class="n">STUDENTS</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">STUDENT_ID</span>
  <span class="k">AND</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">TEST_DATE</span> <span class="o">=</span> <span class="s1">'2012-10-18'</span>
<span class="p">;</span>
</pre></div></div>

<p>「3行処理されました」だそうです。よし。つまり、INNER JOINの結果では0行ですが、LEFT JOINとした場合にはNULLを含めた行が返ります。従って、実行後は以下のようになります。</p>

<table>
<thead>
<tr>
<th style="text-align: center">ID</th>
<th style="text-align: center">NAME</th>
<th style="text-align: right">YESTERDAY_SCORE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1</td>
<td style="text-align: center">太郎</td>
<td style="text-align: right">9</td>
</tr>
<tr>
<td style="text-align: center">2</td>
<td style="text-align: center">次郎</td>
<td style="text-align: right">6</td>
</tr>
<tr>
<td style="text-align: center">3</td>
<td style="text-align: center">三郎</td>
<td style="text-align: right"><em>NULL</em></td>
</tr>
</tbody>
</table>

<p>これでテストを受けていないとわかりますね。</p>

<h2>
<span id="複数行joinできてしまったらtop-1した結果でupdate" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E8%A1%8Cjoin%E3%81%A7%E3%81%8D%E3%81%A6%E3%81%97%E3%81%BE%E3%81%A3%E3%81%9F%E3%82%89top-1%E3%81%97%E3%81%9F%E7%B5%90%E6%9E%9C%E3%81%A7update"><i class="fa fa-link"></i></a>複数行JOINできてしまったら、TOP 1した結果でUPDATE</h2>

<p>10月19日、三郎さんはテストを一回お休みできてラッキーと思っていたのもつかの間、先生から2日分のテストをするよう命じられてしまいました。今日の成績をINSERTします。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'2012-10-19'</span><span class="p">,</span>  <span class="mi">8</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'2012-10-19'</span><span class="p">,</span>  <span class="mi">5</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'2012-10-19'</span><span class="p">,</span>  <span class="mi">3</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">SCORES</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'2012-10-19'</span><span class="p">,</span>  <span class="mi">2</span><span class="p">);</span>
</pre></div></div>

<p>結果は散々でした。今日はこれまでと同じコピーの処理でどうなるのでしょうか。昨日の反省を踏まえ、LEFT OUTER JOINとし、日付を変えて実行してみます。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">STUDENTS</span>
<span class="k">SET</span> <span class="n">YESTERDAY_SCORE</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">SCORE</span>
<span class="k">FROM</span> <span class="n">STUDENTS</span>
<span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">SCORES</span>
  <span class="k">ON</span> <span class="n">STUDENTS</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">STUDENT_ID</span>
  <span class="k">AND</span> <span class="n">SCORES</span><span class="p">.</span><span class="n">TEST_DATE</span> <span class="o">=</span> <span class="s1">'2012-10-19'</span>
<span class="p">;</span>
</pre></div></div>

<p>結果は以下のようになりました。</p>

<table>
<thead>
<tr>
<th style="text-align: center">ID</th>
<th style="text-align: center">NAME</th>
<th style="text-align: right">YESTERDAY_SCORE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1</td>
<td style="text-align: center">太郎</td>
<td style="text-align: right">8</td>
</tr>
<tr>
<td style="text-align: center">2</td>
<td style="text-align: center">次郎</td>
<td style="text-align: right">5</td>
</tr>
<tr>
<td style="text-align: center">3</td>
<td style="text-align: center">三郎</td>
<td style="text-align: right">3</td>
</tr>
</tbody>
</table>

<p>今日の日付で2件取得できるはずですが、実際にUPDATEされる値は1レコードのみのようです。複数レコード取得される可能性のある場合、予期せぬ結果となることも考えられます。使いどころをよく考えるべきでしょう。</p>

<p>と、まあ、ここまで調べてきてわかったことですが、UPDATE SET FROM JOINは便利ですが、気をつけて使うようにしましょう。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />12位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/203fdc0b757e386b6345">Macで「開発元が未確認のため開けません」の対処法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-03 12:03:28</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> <b>[OSX]</b> <b>[MacOSX]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="macで開発元が未確認のため開けませんの対処法" class="fragment"></span><a href="#mac%E3%81%A7%E9%96%8B%E7%99%BA%E5%85%83%E3%81%8C%E6%9C%AA%E7%A2%BA%E8%AA%8D%E3%81%AE%E3%81%9F%E3%82%81%E9%96%8B%E3%81%91%E3%81%BE%E3%81%9B%E3%82%93%E3%81%AE%E5%AF%BE%E5%87%A6%E6%B3%95"><i class="fa fa-link"></i></a>Macで「開発元が未確認のため開けません」の対処法</h1>

<h2>
<span id="そもそもこのエラー自体を出さず未確認のものもジャンジャン許可するなら" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%81%93%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E8%87%AA%E4%BD%93%E3%82%92%E5%87%BA%E3%81%95%E3%81%9A%E6%9C%AA%E7%A2%BA%E8%AA%8D%E3%81%AE%E3%82%82%E3%81%AE%E3%82%82%E3%82%B8%E3%83%A3%E3%83%B3%E3%82%B8%E3%83%A3%E3%83%B3%E8%A8%B1%E5%8F%AF%E3%81%99%E3%82%8B%E3%81%AA%E3%82%89"><i class="fa fa-link"></i></a>そもそもこのエラー自体を出さず、未確認のものもジャンジャン許可するなら</h2>

<p>ぼくが書くより丁寧な解説を見つけました。<a href="http://m.designbits.jp/12110214/" rel="nofollow noopener" target="_blank">Mac OS X Mountain Lionでアプリ起動時に「開発元が未確認のため開けません」エラーが出るときは | memobits</a>を読んどけばいいと思います。</p>

<h2>
<span id="このファイルのみ個別に許可するなら" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%81%BF%E5%80%8B%E5%88%A5%E3%81%AB%E8%A8%B1%E5%8F%AF%E3%81%99%E3%82%8B%E3%81%AA%E3%82%89"><i class="fa fa-link"></i></a>このファイルのみ個別に許可するなら</h2>

<p>ターミナルでそのファイルのあるディレクトリに行き、下記コマンドを打つと開けるようになります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ xattr -d com.apple.quarantine &lt;filename&gt;
</pre></div></div>

<p>特定ディレクトリ以下すべてに適用する場合は、 <code>man xattr</code> によると <code>-r</code> オプションを付与すれば <code>recursively</code> になるらしいです（英単語が読めない）。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ xattr -r -d com.apple.quarantine &lt;dirname&gt;
</pre></div></div>

<h1>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h1>

<ul>
<li><a href="http://m.designbits.jp/12110214/" rel="nofollow noopener" target="_blank">Mac OS X Mountain Lionでアプリ起動時に「開発元が未確認のため開けません」エラーが出るときは | memobits</a></li>
<li><a href="http://koexuka.blogspot.jp/2012/05/macls.html" rel="nofollow noopener" target="_blank">オデの日記＠WEB系: macでlsしたときの＠（アットマーク）</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />13位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/5983b4facf646cbf1961">Railsで日本語を含むURLを扱う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-19 16:20:06</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>/こんにちは.txt とブラウザにうつと、 /%E3%81%93%E3%82%93%E3%81%AB%E3%81%A1%E3%81%AF.txt とリクエストが飛びます。これを Controller で /こんにちは.txt に戻すだけのことに若干ハマったのでメモしておきます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="no">URI</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</pre></div></div>

<p>上記のようにしても正しくデコードできません。これは <code>request.path.encoding</code> が <code>#&lt;Encoding:ASCII-8BIT&gt;</code> になっているためです。これが正しいやり方なのかどうかはわかりませんが、以下のようにするとうまくいきました。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="no">URI</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="s2">"UTF-8"</span><span class="p">))</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />14位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/ff856de32495191e45e8">RailsのAssets Pipelineや静的ファイルがうまく動かないときにチェックすべき項目</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-11 18:31:07</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>新しいRailsプロジェクトを作ると、よくAssets Pipelineや静的ファイルのホストあたりでうまくいかず悲しい思いをするのでぼくがよくぶつかった問題をまとめておきました。主に、「developmentではうまくいくのにproductionでうまくいかない」場合のことを書きます。</p>

<h2>
<span id="assets-以下においた-javascripts-stylesheets-がコンパイルされない" class="fragment"></span><a href="#assets-%E4%BB%A5%E4%B8%8B%E3%81%AB%E3%81%8A%E3%81%84%E3%81%9F-javascripts-stylesheets-%E3%81%8C%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>assets/ 以下においた javascripts, stylesheets がコンパイルされない</h2>

<p>特に何も考えず開発すると、 application.js, application.css のみがコンパイル対象になり、読ませたいファイルはここからrequireしていく必要があります。requireされていないもので assets/ の中に勝手においたものはコンパイルされません。 javascript, stylesheet 以外はすべてコンパイルされますので画像は勝手において大丈夫です。</p>

<h2>
<span id="public-以下においた静的ファイルが認識されない" class="fragment"></span><a href="#public-%E4%BB%A5%E4%B8%8B%E3%81%AB%E3%81%8A%E3%81%84%E3%81%9F%E9%9D%99%E7%9A%84%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E8%AA%8D%E8%AD%98%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>public/ 以下においた静的ファイルが認識されない</h2>

<p><a href="https://devcenter.heroku.com/articles/rails4" rel="nofollow noopener" target="_blank">Rails4＋Herokuでは何も考えないとこの現象になる気がします</a>。また、（ApacheやNginxを使っていない場合と思いますが、）Railsのアプリケーションサーバに静的ファイルを配信したい場合は、config/environments/production.rbに下記を設定する必要があります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">serve_static_assets</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div></div>

<p>ただ、静的ファイルが見つからない場合に全部アプリケーションサーバに問い合わせが飛ぶのであまりよろしくはないです。</p>

<p>フィードバック歓迎です！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />15位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/010593d27189fa7c771b">RailsのHelperにブロックを渡す</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-28 07:37:11</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>「特定の条件を満たした時に中身を表示、満たしていないときには何も出さない」という処理を、同じ条件で中身は違うというものをいろんなところに書きたかったのでHelperに実装してみました。</p>

<div class="code-frame" data-lang="haml">
<div class="code-lang"><span class="bold">some_view.html.haml</span></div>
<div class="highlight"><pre><span></span><span class="p">=</span> <span class="n">lock</span> <span class="k">do</span>
  条件を満たした！
</pre></div>
</div>

<p>erbなら以下のようになると思います。</p>

<div class="code-frame" data-lang="erb">
<div class="code-lang"><span class="bold">some_view.html.erb</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;%=</span> <span class="n">lock</span> <span class="k">do</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  条件を満たした！</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>

<p>としておいて、helper側は以下のようにします。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">application_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">some_condition?</span>
    <span class="n">capture</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="s1">'今は見れません！'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p><code>capture(&amp;block)</code> がミソですね。</p>

<p><a href="http://apidock.com/rails/ActionView/Helpers/TagHelper/block_called_from_erb%3F" rel="nofollow noopener" target="_blank">block_called_from_erb?はRails3からは天に召されている</a>ので注意。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />16位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/3522d3462dc9bb7bdfdc">Railsで絶対レコードあるのにUser.find(1)でActiveRecord::RecordNotFoundとなってしまう場合</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-24 10:56:57</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Couldn't find User with id=1 [WHERE "user"."type" IN (0)]
</pre></div></div>

<p>のようなエラーで「なぜ指定していないtypeが条件に入っているの？」とハマってしまったのでメモ。typeは予約語でした。既存のDBに接続して使っていたので気づけませんでした。</p>

<p><a href="http://qiita.com/ryonext/items/1a813639ab2a2a00058e" id="reference-befb4b250e5e3eb192cd">Rails - ActiveRecordで"type"という名前のカラムがあるとエラーが出る場合の対応 - Qiita [キータ]</a> にあるように、</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">/app/models/user.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">self</span><span class="o">.</span><span class="n">inheritance_column</span> <span class="o">=</span> <span class="ss">:_type_disabled</span>
</pre></div>
</div>

<p>を指定すれば治りました。ネーミングルールこわい……。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />17位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/aaf8f25325c5a3499c21">SQL Server 8115: 「expression をデータ型 int に変換中に、算術オーバーフロー エラーが発生しました。」の傾向と対策</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-15 07:47:01</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[SQLServer]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>この記事は昔書いた記事をブログから移行したものです。</p>

<p>表題のエラーで悩んだので悩んだ過程をメモしておきます。</p>

<p>この問題の原因は、</p>

<ul>
<li>SQL Server（だけに限らず他のRDBMSでも）では、暗黙の型変換が行われる</li>
<li>演算を行う場合、最大精度の型に合わせて演算が行われる</li>
</ul>

<p>という特徴です。つまり、このエラーが発生する最も簡単なSQLは以下のようになります。</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="mi">46340</span> <span class="o">*</span> <span class="mi">46340</span><span class="p">;</span> <span class="c1">-- OK!</span>
<span class="k">SELECT</span> <span class="mi">46341</span> <span class="o">*</span> <span class="mi">46341</span><span class="p">;</span> <span class="c1">-- Error</span>
</pre></div></div>

<p>これは、46341がintと解釈され、intとintの演算結果がintの範囲（-2,147,483,648～2,147,483,647）に収まりきらないためエラーになります。SQL Serverには明示的な型変換のためのCAST関数が用意されていて、</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">CAST</span><span class="p">(</span><span class="mi">46341</span> <span class="k">AS</span> <span class="nb">BIGINT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">46341</span><span class="p">;</span> <span class="c1">-- OK!</span>
</pre></div></div>

<p>とすることで、bigintとintの演算となり、結果は最大精度のbigintになるためエラーになりません。また、</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">CAST</span><span class="p">(</span><span class="mi">46341</span> <span class="o">*</span> <span class="mi">46341</span> <span class="k">AS</span> <span class="nb">BIGINT</span><span class="p">);</span> <span class="c1">-- Error</span>
</pre></div></div>

<p>のような書き方もエラーです。これも最初の特徴にあてはめて考えると、intとintの演算を先にしてしまうのでエラーになるのは自明ですね。。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />18位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/003f2fae1402d3cf3727">RubyMineでGo To Declarationできないときの対処法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-12 11:10:46</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[RubyMine]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>RubyMineでcommand+クリックしてもGo To Declarationしてもジャンプできなかったので困った。以下のようにしたら治りました。</p>

<p><code>File → Invalidate Caches / Restart...</code></p>

<p>公式は英語だけどけっこう情報が豊富だった。Googleで検索するよりこっちのほうが効率よさそう。</p>

<h2>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h2>

<ul>
<li><a href="http://youtrack.jetbrains.com/issue/RUBY-13891" rel="nofollow noopener" target="_blank">'Go To Declaration' not working with New Projects : RUBY-13891</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>youcuneさんの<br />19位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/youcune/items/e377f04a5ad84d340590">RailsでURLの末尾のスラッシュ有無によって処理を分岐させる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-18 18:49:08</center>
	</td>
	<td style="width:200px;">
		@youcune<br />(合同会社ユーキューブ 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/19478/profile-images/1506391318">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ざっと調べた限り、 routes.rb だけではできなさそう。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">get</span> <span class="s1">'*path'</span> <span class="o">=&gt;</span> <span class="s1">'application#routing'</span>
</pre></div>
</div>

<p>みたいにしてサクッとControllerに処理を委譲してやる。ただ、 <code>request.path</code> や <code>request.uri</code> なども末尾のスラッシュを勝手に消してしまうので、 <code>request.env['REQUEST_PATH']</code> あたりで判断する。</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
