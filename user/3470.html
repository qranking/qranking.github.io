<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (TsuyoshiUshio@github)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (TsuyoshiUshio@github さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />1位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>163</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/b9ae6e3a4ee63da66cd1">技術師匠の皆様の教えを記録する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-11 09:19:02</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ベストプラクティス]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>私には何名かの師匠がいる。私は技術力は３流なので、ちゃんとしたプログラマになりたい。だから、イケてる人をみると教えを得るようにしている。見返すことができるように、その内容をまとめておく。</p>

<h1>
<span id="1-小さなハローワールドを繰り返しブログに記録する" class="fragment"></span><a href="#1-%E5%B0%8F%E3%81%95%E3%81%AA%E3%83%8F%E3%83%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%AB%E3%83%89%E3%82%92%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97%E3%83%96%E3%83%AD%E3%82%B0%E3%81%AB%E8%A8%98%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. 小さなハローワールドを繰り返し、ブログに記録する</h1>

<p>私のNo.1 師匠である、かずきさんから教えてもらったこと。彼と Hackfest に参加した時に、APIリファレンスを見ることなく、APIの中身のアーキテクチャまで理解していながら、高速に開発する姿は最高だった。一方私は、何しても人の三倍かかって、しょっちゅう Google のお世話になっている。</p>

<p>彼に教えてもらったことが、このことで、「小さなハローワールド」を繰り返すということだ。何か新しいこと、に出会ったら、難しいことをしなくていいので、自分の手の届くような小さなハローワールドレベルのプログラムを書く。その時に重要なのは、ドキュメントにあるコードをそのままではなく、自分なりに少し変えて作る。そしてそれをブログに書く。</p>

<p>コードを変えるのは、やっぱり自分でできるようになっているかすることもあるだろうし、ブログに書く時に、他人に説明する程で書くのがいい。自分で理解できていないことがその時にわかる。他の人のためにブログを書いているわけではないので、アクセスとかは気にしなくていいが、「他の人が理解」できるように書くことで、理解を深めて、自分にも記憶に残りやすくなる。また忘れた時も便利。</p>

<p>これを実践している時に感じたポイントは、「問題を小さく分ける」ということ。結構難しいが、複数のことが絡み合うから、ややこしい。だから、同時に試す要素は１要素にする。そのために、面倒でも、新しいプロジェクトを作ると良い。人間は難しいことを一気に解決できない。こうしたハローワールドを繰り返しているといつしか高いところにいることに気づくとのこと。このメソッドは相当強力であると感じている。</p>

<p><a href="https://camo.qiitausercontent.com/82ac0950ec2d9f40e7715dff946b2d8f1b6cdc29/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33626236396366362d333538302d356636322d636632622d3265323163643364326336372e706e67" target="_blank" rel="nofollow noopener"><img width="889" alt="Screen Shot 2017-11-11 at 10.24.05 AM.png" src="https://camo.qiitausercontent.com/82ac0950ec2d9f40e7715dff946b2d8f1b6cdc29/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33626236396366362d333538302d356636322d636632622d3265323163643364326336372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/3bb69cf6-3580-5f62-cf2b-2e21cd3d2c67.png"></a></p>

<p>私のQiita のエントリがそれなのだが、いかに他の人にとってどうでもいい内容をブログにしているかわかるだろう。ポイントは、自分にとってわからないことか、そして、自分にとって小さなハローワールドかだ。だから、他の人にとって役に立つか、とか既知の情報であるかは気にしていない。</p>

<p>ちなみに、他の人に役立ちそうだなと思った時で、英語にも既存のリソースがなさげな時は英語で書いている。</p>

<p>*<a href="https://blogs.technet.microsoft.com/livedevopsinjapan/" rel="nofollow noopener" target="_blank">Live DevOps in Japan</a></p>

<h1>
<span id="2-コマンドを使ったらその前後で何が変わるかを理解する" class="fragment"></span><a href="#2-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%89%E3%81%9D%E3%81%AE%E5%89%8D%E5%BE%8C%E3%81%A7%E4%BD%95%E3%81%8C%E5%A4%89%E3%82%8F%E3%82%8B%E3%81%8B%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. コマンドを使ったらその前後で何が変わるかを理解する</h1>

<p>どんな技術でも使いこなし、とてつもなく学習が早く、衝撃的な Hack力を持つ Ken さんに教えてもらったこと。彼は、新しいコマンドを使うときは、なんとなく動いたとかではなくて、コマンドを使ったら前後で何が変化するか？を理解するという。diff みたいなものを使って、前後でどう状態が変化したかまでを理解すると良いとのこと。</p>

<h1>
<span id="3-ドキュメントを読む" class="fragment"></span><a href="#3-%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%82%92%E8%AA%AD%E3%82%80"><i class="fa fa-link"></i></a>3. ドキュメントを読む</h1>

<p>Ken さん曰く、ドキュメントは、正しい、もしくは、過去正しかったことが書かれていることが基本なので、ここをしっかり読むことが重要という話だった。とても当たり前のように感じるが、最近英語のドキュメントを読むことが多いが、英語だと特に億劫になって、「多分こんな感じだろー」みたいな感じで飛ばし読みすることが多い。そうすると、読み飛ばしていたところに、注意事項が書いてあったりして無駄にどはまりしてしまったりも良くする。私の場合英語力がいまいちなのでそれでもミスることも多いが、まず焦らずドキュメントを読むところから始めている。</p>

<h1>
<span id="4-ジタバタしない" class="fragment"></span><a href="#4-%E3%82%B8%E3%82%BF%E3%83%90%E3%82%BF%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>4. ジタバタしない</h1>

<p>同じく Ken さんのアドバイスで、何かに詰まったら、そこであーでもない、こーでもない、と試行錯誤しないということ。まずは、誰かに聞く（MLなど）そして、投げた後は他のことをする。確かにそっちの方が効率が良い。やはりジタバタの時間はいつも相当無駄になっている。</p>

<h1>
<span id="5-トリプルディスプレイを使う" class="fragment"></span><a href="#5-%E3%83%88%E3%83%AA%E3%83%97%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%82%A4%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>5. トリプルディスプレイを使う</h1>

<p>Ken さんに、ディスプレイ４つだと扱えない。３つが最高と聞いたので、実際やってみた。これは最高だ。持ち運び用のセカンドディスプレイも検討中。後、エディタのショートカットとか、terminal とかのコマンドは、時間をかけて覚えた方がいいとのこと。普段動作のものなので、生産性に効いてくるからとのこと。</p>

<h1>
<span id="6-arm-を愛でるコードを読む" class="fragment"></span><a href="#6-arm-%E3%82%92%E6%84%9B%E3%81%A7%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E8%AA%AD%E3%82%80"><i class="fa fa-link"></i></a>6. ARM を愛でる、コードを読む</h1>

<p>これはインフラ野郎、真壁さんの教え。彼に、なんでどこにもドキュメントに出ていないような情報を知れるのですか？と聞くと、疑問に思ったことは、MLで聞いてみたり、試しているみたい。Managed で背景は一瞬見えなさそうでも、どう動いているかを把握されようとしていた。また、AKS の仕組みの調査も、ARMを愛でたりしているらしい。それでビールが飲めるらしい。他にアーキテクチャ的な部分も、コードを読んで確かめている様子。彼から聞いたのではないが、疑問があったらほっておかずに、調べてみるのがいいのかもしれない。確かにどうしてもわからなければ、聞けば良いかも。</p>

<h1>
<span id="7-ビデオを見るアーキテクチャに時間を使う" class="fragment"></span><a href="#7-%E3%83%93%E3%83%87%E3%82%AA%E3%82%92%E8%A6%8B%E3%82%8B%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%81%AB%E6%99%82%E9%96%93%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>7. ビデオを見る、アーキテクチャに時間を使う</h1>

<p>同僚の超絶センスいい Kanio の言葉。コードを書いてばかりではなく、アーキテクチャにも時間を使うのが重要らしい。なぜ、そんなインターナルを知っているのか聞くと、ビデオをみたり、わからないところを質問したりしているとこのこと。コードと、アーキテクチャのバランスを取るのが必要らしい。そういえば私はコードばかりで、こちらの方はやっていなかったので、もう少しこちらもやってみる。</p>

<h1>
<span id="8-わからないところは質問する" class="fragment"></span><a href="#8-%E3%82%8F%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D%E3%81%AF%E8%B3%AA%E5%95%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>8. わからないところは質問する</h1>

<p>達人から複数いただいた回答で、インターナルの様子など、わからない時は、質問する。確かに単純だけど、ドキュメントなかったら諦めてしまっていた。やってみる。</p>

<h1>
<span id="9-マイクロソフト内で検索する" class="fragment"></span><a href="#9-%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%BD%E3%83%95%E3%83%88%E5%86%85%E3%81%A7%E6%A4%9C%E7%B4%A2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>9. マイクロソフト内で検索する</h1>

<p>マイクロソフト内限定だけど、社内の検索サイトで検索すると色々情報が落ちているらしい。それを読んでみる。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>このブログも自分のためにまとめてみた。今後こっそりアップデートされるかも。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />2位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/71146d3baa45231d8bb6">Angular 4 でマテリアルデザインを使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-27 03:29:01</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> <b>[MaterialDesign]</b> <b>[Angular2]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Angular 4 で、マテリアルデザインを適用してアプリを作ろうと思ったんだけど、無茶苦茶にハマったので、ちゃんと動く手順をメモしておく。</p>

<p><a href="https://camo.qiitausercontent.com/eb9380e7bdcf5199c3b02d3b283104f949439d8e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34623131306262642d396536332d366532322d306637372d3038336438353961656237352e706e67" target="_blank" rel="nofollow noopener"><img width="1103" alt="Screen Shot 2017-09-26 at 11.06.27 AM.png" src="https://camo.qiitausercontent.com/eb9380e7bdcf5199c3b02d3b283104f949439d8e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34623131306262642d396536332d366532322d306637372d3038336438353961656237352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4b110bbd-9e63-6e22-0f77-083d859aeb75.png"></a></p>

<h1>
<span id="ハマった方法" class="fragment"></span><a href="#%E3%83%8F%E3%83%9E%E3%81%A3%E3%81%9F%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>ハマった方法</h1>

<p>私は、Angular の初心者なので、何から始めたらいいのかわからず、本に書いてある通り、<code>quick-start</code> のリポジトリを元に、material design の npm  を追加しました。すると、バージョン問題が発生するので、ちゃんとバージョンを合わせたり、ライブラリのバージョンが違うので、ディレクトリが違うため、<code>systems.config.js</code> にライブラリを追記したりと、色々やりましたが、ライブラリ取得時の404エラーは治ることなく、数時間格闘しましたが無理なので、寝ました。</p>

<h1>
<span id="うまくいく方法" class="fragment"></span><a href="#%E3%81%86%E3%81%BE%E3%81%8F%E3%81%84%E3%81%8F%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>うまくいく方法</h1>

<p>　しかし、問題は、「quick-start」を元にしているからであって、複雑なことを減らすとうまくいくようです。（特に初心者はいきなりたくさんのことを学べないので）現時点でうまく行った方法をシェアします。</p>

<p>基本的には Resource のコーナーで書いて置いた方法のミックスです。</p>

<h2>
<span id="angular-cli-を入れる" class="fragment"></span><a href="#angular-cli-%E3%82%92%E5%85%A5%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>Angular CLI を入れる</h2>

<p><a href="https://cli.angular.io/" rel="nofollow noopener" target="_blank">Angular CLI</a> を入れます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>npm install -g @angular/cli
</pre></div></div>

<h2>
<span id="マテリアルデザインのテンプレートを生成する" class="fragment"></span><a href="#%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>マテリアルデザインのテンプレートを生成する</h2>

<p><a href="https://coursetro.com/posts/code/67/Angular-4-Material-Tutorial" rel="nofollow noopener" target="_blank">Angular 4 Material Tutorial</a> に従って、マテリアルデザインの Angular4 のテンプレートがあるので、それを使います。ライブラリの依存問題は、時間がかかるので楽な方法で。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ng new ng4-material
</pre></div></div>

<h2>
<span id="マテリアルデザインのnpm-を追加" class="fragment"></span><a href="#%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AEnpm-%E3%82%92%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>マテリアルデザインのnpm を追加</h2>

<p>マテリアルデザインのライブラリを追加していきます。ポイントは、<code>cdk</code>を先に追加しないとうまくいきません。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ npm install --save @angular/cdk
$ npm install --save @angular/material @angular/animations
</pre></div></div>

<p><code>hammerjs</code> も入れておきます。md-slide-toggle, md-slider, mdTooltipは、hammerjs に依存しているので、入れとく方がいいでしょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ npm install --save hammerjs
</pre></div></div>

<p>そして、<code>src/main.ts</code> に追加しておきます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>import 'hammerjs';
</pre></div></div>

<h2>
<span id="ライブラリの組み込み" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>ライブラリの組み込み</h2>

<p>npm で入れたライブラリを組み込んでいきます。</p>

<h3>
<span id="style-の追加" class="fragment"></span><a href="#style-%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>style の追加</h3>

<p><code>src/style.css</code> にお好みのスタイルを追加します。アイコンも加えてこんな感じで。<code>body</code> 以降はオプションですが、最初の二行がポイントです。アイコンを取得するのと、インポートしたマテリアルデザインのテーマをインポートしています。</p>

<div class="code-frame" data-lang="css"><div class="highlight"><pre><span></span><span class="p">@</span><span class="k">import</span> <span class="s1">'~https://fonts.googleapis.com/icon?family=Material+Icons'</span><span class="p">;</span>
<span class="p">@</span><span class="k">import</span> <span class="s1">'~@angular/material/prebuilt-themes/indigo-pink.css'</span><span class="p">;</span>

<span class="nt">body</span> <span class="p">{</span>
    <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">font-family</span><span class="p">:</span> <span class="n">Roboto</span><span class="p">,</span> <span class="kc">sans-serif</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">md-card</span> <span class="p">{</span>
    <span class="k">max-width</span><span class="p">:</span> <span class="mi">80</span><span class="kt">%</span><span class="p">;</span>
    <span class="k">margin</span><span class="p">:</span> <span class="mi">2</span><span class="kt">em</span> <span class="kc">auto</span><span class="p">;</span>
    <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">md-toolbar-row</span> <span class="p">{</span>
    <span class="k">justify-content</span><span class="p">:</span> <span class="kc">space-between</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="p">.</span><span class="nc">done</span> <span class="p">{</span>
    <span class="k">position</span><span class="p">:</span> <span class="kc">fixed</span><span class="p">;</span>
    <span class="k">bottom</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">right</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">color</span><span class="p">:</span> <span class="kc">white</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div></div>

<h3>
<span id="indexhtml" class="fragment"></span><a href="#indexhtml"><i class="fa fa-link"></i></a>index.html</h3>

<p>特に何もしなくても大丈夫ですが、アイコンインポートしています。（多分不要）</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Ng4Material<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">base</span> <span class="na">href</span><span class="o">=</span><span class="s">"/"</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"icon"</span> <span class="na">type</span><span class="o">=</span><span class="s">"image/x-icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"favicon.ico"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://fonts.googleapis.com/icon?family=Material+Icons"</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">app-root</span><span class="p">&gt;&lt;/</span><span class="nt">app-root</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h3>
<span id="material-の追加" class="fragment"></span><a href="#material-%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>Material の追加</h3>

<p><code>material.module.ts</code> にまとめて、マテリアル関係のインポートを書いておきます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>import { NgModule } from '@angular/core';

import {
  MdButtonModule,
  MdMenuModule,
  MdToolbarModule,
  MdIconModule,
  MdCardModule
} from '@angular/material';

@NgModule({
  imports: [
    MdButtonModule,
    MdMenuModule,
    MdToolbarModule,
    MdIconModule,
    MdCardModule
  ],
  exports: [
    MdButtonModule,
    MdMenuModule,
    MdToolbarModule,
    MdIconModule,
    MdCardModule
  ]
})
export class MaterialModule {}
</pre></div></div>

<h3>
<span id="appmodulets" class="fragment"></span><a href="#appmodulets"><i class="fa fa-link"></i></a>app.module.ts</h3>

<p>先ほどのマテリアルデザインのインポートを読み込んでいます。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">BrowserModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/platform-browser'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">FormsModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/forms'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">HttpModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/http'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">MaterialModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./material.module'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">BrowserAnimationsModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/platform-browser/animations'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>

<span class="kd">@NgModule</span><span class="p">({</span>
  <span class="nx">declarations</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span>
  <span class="p">],</span>
  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">HttpModule</span><span class="p">,</span>
    <span class="nx">MaterialModule</span><span class="p">,</span>
    <span class="nx">BrowserAnimationsModule</span>
  <span class="p">],</span>
  <span class="nx">providers</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">bootstrap</span><span class="o">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</pre></div></div>

<h3>
<span id="appcomponenthtml" class="fragment"></span><a href="#appcomponenthtml"><i class="fa fa-link"></i></a>app.component.html</h3>

<p>あとは、マテリアルデザインを使って、読み込まれる html を作成す流だけ。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">md-toolbar</span> <span class="na">color</span><span class="o">=</span><span class="s">"primary"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;</span><span class="nt">md-icon</span><span class="p">&gt;</span>mood<span class="p">&lt;/</span><span class="nt">md-icon</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Muscke Hack<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-icon-button</span> <span class="err">[</span><span class="na">md-menu-trigger-for</span><span class="err">]="</span><span class="na">menu</span><span class="err">"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">md-icon</span><span class="p">&gt;</span>more_vert<span class="p">&lt;/</span><span class="nt">md-icon</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">md-toolbar</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">md-menu</span> <span class="na">x-position</span><span class="o">=</span><span class="s">"before"</span> <span class="err">#</span><span class="na">menu</span><span class="o">=</span><span class="s">"mdMenu"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-menu-item</span><span class="p">&gt;</span>Option 1<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-menu-item</span><span class="p">&gt;</span>Option 2<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">md-menu</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">md-card</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-button</span><span class="p">&gt;</span>All<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-raised-button</span><span class="p">&gt;</span>Of<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-raised-button</span> <span class="na">color</span><span class="o">=</span><span class="s">"primary"</span><span class="p">&gt;</span>The<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-raised-button</span> <span class="na">color</span><span class="o">=</span><span class="s">"accent"</span><span class="p">&gt;</span>Buttons<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">md-card</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"done"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-fab</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">md-icon</span><span class="p">&gt;</span>check circle<span class="p">&lt;/</span><span class="nt">md-icon</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>あとは実行</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>npm start
</pre></div></div>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p><code>ng new ng4-material</code> のテンプレートを使うとアホみたいに簡単にできました。<code>quick-start</code> のテンプレートを使うから酷い目にあったようです。本当は、quick-start は、テストとか色々な環境が揃っているので、こちらを元にしたかったのですが、これなら、こちらを元にして、テストを足した方が楽そうです。</p>

<p>やはり、依存性の問題を解決するのは時間がかかるので、そこに当たらないテンプレートを使った方がいいと感じました。さ、やっとコーディングだ。</p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://cli.angular.io/" rel="nofollow noopener" target="_blank">Angular CLI</a></li>
<li><a href="https://coursetro.com/posts/code/67/Angular-4-Material-Tutorial" rel="nofollow noopener" target="_blank">Angular 4 Material Tutorial</a></li>
<li><a href="https://github.com/angular/material2/blob/master/guides/getting-started.md" rel="nofollow noopener" target="_blank">material2/guides/getting-started.md</a></li>
<li><a href="https://alligator.io/angular/angular-material-2/" rel="nofollow noopener" target="_blank">Getting Started With Angular Material 2</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />3位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/df2f05a72585233975f2">Azure で とっても簡単に python のサーバレス環境を作ってみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-22 17:14:30</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[Azure]</b> <b>[logicapps]</b> <b>[OpenFaaS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>同僚から、Azure のサーバーレスに対して一つのリクエストをもらった。彼は、python で書きたいらしい。サーバーレスのもっとも良いところは、サーバーをある意味気にしなくていいところだが、使ったぶんだけ課金というパートを除けば、常にクラスタをデプロイしたままでのサーバーレス環境も生産性という意味では悪くないかもしれない。</p>

<p><a href="https://camo.qiitausercontent.com/42767fa8a65fb0719c1185e731af7e3f1ab2901a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64316462316535372d306563302d333963332d613337632d3132623036656365663033632e706e67" target="_blank" rel="nofollow noopener"><img width="945" alt="Screen Shot 2017-09-22 at 12.59.11 AM.png" src="https://camo.qiitausercontent.com/42767fa8a65fb0719c1185e731af7e3f1ab2901a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64316462316535372d306563302d333963332d613337632d3132623036656365663033632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/d1db1e57-0ec0-39c3-a37c-12b06ecef03c.png"></a></p>

<p>自分がサーバーレスの世界に求めるのは、何と言っても簡単さだ。だから、セットアップもできるだけしたくない。今回は、たまたまハッカソンで触った OpenFaaS という Swarm / k8s にデプロイしたら動くシンプルなものを作って、彼のデマンドに答えてみたい。OpenFaaS は、ストレージや、キューのトリガーすらない、httpだけの非常にシンプルなものだ。</p>

<h1>
<span id="基礎的なアイデア" class="fragment"></span><a href="#%E5%9F%BA%E7%A4%8E%E7%9A%84%E3%81%AA%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2"><i class="fa fa-link"></i></a>基礎的なアイデア</h1>

<p>基礎的なアイデアはとしてもシンプルだ。彼からのお題は、ブロブにアップロードした画像解析をpython でサクッとしたいとのことだ。ライブラリが充実しているから python がいいらしい。ところが、Azure Functions は今の所、Windows ベースなので、Python や Ruby が使えたところで、ネィティブエクステンション系のライブラリは相当辛いだろう。</p>

<p>だから、こんな感じはどうだろう？</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Blob -&gt; Logic Apps -&gt; OpenFaaS -&gt; Blob
</pre></div></div>

<p>単純にいうと、ブロブに何かアップロードされたら、Logic Apps が拾って、httpのリクエストを、Open FaaS に投げる。Open FaaS は同期もしくは、非同期でそのリクエストを受け取って、リスクエストに格納されたファイル名にアクセスして、取得して分析するという感じ。このクソシンプルな作戦だと、OpenFaaSじゃなくても他のでも使える。ちなみに、Azure Container Instance を使わなかったのは、今の所オースケストレーターがないから。また、高負荷にも多分耐えられないから（スケールしないので）今後楽しみね。</p>

<h1>
<span id="openfaas-でファンクションを作る" class="fragment"></span><a href="#openfaas-%E3%81%A7%E3%83%95%E3%82%A1%E3%83%B3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>OpenFaaS でファンクションを作る</h1>

<p>まずは、OpenFaaS 側でファンクションを作ろう。必要なものは、２つだけ。シンプルなエコーもどきを、実装しよう。JSON の方がいいだろうから、JSON でエコーするようにする。OpenFaaS のセットアップは、私のブログポストを参考にしてほしい。</p>

<ul>
<li><a href="https://blogs.technet.microsoft.com/livedevopsinjapan/2017/09/19/open-faas-on-acs-kubernetes/" rel="nofollow noopener" target="_blank">OpenFaaS on ACS (Kubernetes)</a></li>
<li><a href="https://blogs.technet.microsoft.com/livedevopsinjapan/2017/09/21/openfaas-on-azure-swarm/" rel="nofollow noopener" target="_blank">OpenFaaS on Azure (Swarm)</a></li>
</ul>

<p>必要なものは、２つだけ。 handler.py と、storage.yaml 。ファンクションの名前をつけたディレクトリを作って、そこに、handler.py を置くだけ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>├── storage
│   └── handler.py
├── storage.yaml
</pre></div></div>

<p>handler.py</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>   
    <span class="k">print</span><span class="p">(</span><span class="s1">'{ "recieve" : '</span> <span class="o">+</span> <span class="n">req</span> <span class="o">+</span> <span class="s2">"}"</span><span class="p">)</span>
</pre></div></div>

<p>storage.yaml (名前はなんでも良い)</p>

<div class="code-frame" data-lang="yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">provider</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">faas</span>
  <span class="l l-Scalar l-Scalar-Plain">gateway</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://13.93.212.187:8080</span>

<span class="l l-Scalar l-Scalar-Plain">functions</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">storage-trigger</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">lang</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
    <span class="l l-Scalar l-Scalar-Plain">handler</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">./storage/</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tsuyoshiushio/storage-trigger</span>
</pre></div></div>

<p>どちらも一回書いてしまえばクソ簡単。デプロイしよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>faas-cli -action build -f ./storage.yaml
faas-cli -action push -f ./storage.yaml
faas-cli -action deploy -f ./storage.yaml
</pre></div></div>

<p>準備おっけー。ちなみに、OpenFaaS は内部で Docker を使っているので、ネイティブエクステンション問題は問題ない。Windows Container にも対応しているらしい。（それだったら、Azure Function使うけどw)</p>

<p><a href="https://camo.qiitausercontent.com/0603f261689be04bac2c920451f37afbeec74bda/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39343762396465312d666639642d636563612d656331312d3339666165633134346139622e706e67" target="_blank" rel="nofollow noopener"><img width="945" alt="Screen Shot 2017-09-22 at 12.59.11 AM.png" src="https://camo.qiitausercontent.com/0603f261689be04bac2c920451f37afbeec74bda/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39343762396465312d666639642d636563612d656331312d3339666165633134346139622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/947b9de1-ff9d-ceca-ec11-39faec144a9b.png"></a></p>

<h1>
<span id="logic-apps-を設定する" class="fragment"></span><a href="#logic-apps-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Logic Apps を設定する</h1>

<p><a href="https://azure.microsoft.com/en-us/services/logic-apps/" rel="nofollow noopener" target="_blank">Logic Apps</a> は、Azure のサーバーレスのオファーの一つで、コーディングレスで、いろんなサービスをつなぐことができる。Azure に限らない。いろんなイベントを拾うことができる。Blob にアップされたらとか、VM ができたら、<a href="https://azure.microsoft.com/en-us/services/event-grid/" rel="nofollow noopener" target="_blank">Event Grid</a> という仕組みもできたので、ほぼ全てのイベントを拾うことができる。<br>
  イベントきっかけで、いろんなサービスを連携させることができる。今回は、ブロブのイベントを拾って、OpenFaaS で作ったファンクションに連携させる。ちなみに、事前に、Storage Account は作成しておいた。</p>

<p>ちなみに Logic Apps の　Web action でハマったところは、最初、このアプリがBad Request で帰ってきたこと。正しい Json ではないとのこと。原因は、Logic Apps 側の設定ではなく、Function が返してきたレスポンスが、正しい Json ではないから。手元を散々見直してハマったが、実は、向こう側の問題だったということ。</p>

<p><a href="https://camo.qiitausercontent.com/8557142579fd7273fc663e37f05245e33b083101/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32623762616331332d663435312d373866342d653130632d3361353032346466343030322e706e67" target="_blank" rel="nofollow noopener"><img width="571" alt="Screen Shot 2017-09-22 at 1.07.18 AM.png" src="https://camo.qiitausercontent.com/8557142579fd7273fc663e37f05245e33b083101/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32623762616331332d663435312d373866342d653130632d3361353032346466343030322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/2b7bac13-f451-78f4-e10c-3a5024df4002.png"></a></p>

<p>これを、保存して実行させておいて、ブロブに何かの画像をアップさせる<br>
<a href="https://camo.qiitausercontent.com/a5d21bc0276e865c10e8e01fab459cce9dfc23ec/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62326366323831642d306433342d313530612d616537322d6533333738316361363830642e706e67" target="_blank" rel="nofollow noopener"><img width="949" alt="Screen Shot 2017-09-22 at 1.08.48 AM.png" src="https://camo.qiitausercontent.com/a5d21bc0276e865c10e8e01fab459cce9dfc23ec/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62326366323831642d306433342d313530612d616537322d6533333738316361363830642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/b2cf281d-0d34-150a-ae72-e33781ca680d.png"></a></p>

<p>そしたら、自動的に、Logic Apps がイベントを拾って、ファイル名を、ファンクションにポストする</p>

<p><a href="https://camo.qiitausercontent.com/06217dcc49043147554aafd6123c3c79d1f525f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30333139653361342d313464322d653531382d643165662d3530363835613130313062332e706e67" target="_blank" rel="nofollow noopener"><img width="327" alt="Screen Shot 2017-09-22 at 1.09.59 AM.png" src="https://camo.qiitausercontent.com/06217dcc49043147554aafd6123c3c79d1f525f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30333139653361342d313464322d653531382d643165662d3530363835613130313062332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/0319e3a4-14d2-e518-d1ef-50685a1010b3.png"></a></p>

<p>あとは、自分で、Azure SDK を使ってキューを取りに行かないと行けないけど、かなり楽チンじゃないかなぁー。</p>

<h1>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h1>

<p>次回は、ここから発展させてみて、色々繋げてみる。また、Function を作ったら、できれば、Logic Apps を書くのを自動化できないかなとかふと思ってみたり。</p>

<h1>
<span id="リソース" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>リソース</h1>

<ul>
<li><a href="https://blogs.technet.microsoft.com/livedevopsinjapan/2017/09/19/open-faas-on-acs-kubernetes/" rel="nofollow noopener" target="_blank">OpenFaaS on ACS (Kubernetes)</a></li>
<li><a href="https://blogs.technet.microsoft.com/livedevopsinjapan/2017/09/21/openfaas-on-azure-swarm/" rel="nofollow noopener" target="_blank">OpenFaaS on Azure (Swarm)</a></li>
<li><a href="https://github.com/alexellis/faas" rel="nofollow noopener" target="_blank">Functions as a Service (OpenFaaS) - a serverless framework for Docker &amp; Kubernetes</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />4位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/6f9861053ca42328bfba">JavaScript の関数に関するあれこれ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-18 03:37:47</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>JavaScript シリーズの最後は、JavaScript の関数に関するまとめ。自分の知らないことを中心にいくつかサンプルを書いて見ます。</p>

<h1>
<span id="関数の順番" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E3%81%AE%E9%A0%86%E7%95%AA"><i class="fa fa-link"></i></a>関数の順番</h1>

<p>JavaScript では、関数の定義は、関数を使用する前でも、後でも構いません。実行される時に、関数は全て前に持ってこられます。</p>

<h1>
<span id="arguments" class="fragment"></span><a href="#arguments"><i class="fa fa-link"></i></a>arguments</h1>

<p>JavaScript には予約されている<code>arguments</code> というプロパティがあります。それを使うと、可変のプロパティも扱えます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">printArgs</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">x</span> <span class="o">=</span> <span class="nx">printArgs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">"Hello"</span><span class="p">)</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1
true
Hello
</pre></div></div>

<h1>
<span id="関数の引数" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E3%81%AE%E5%BC%95%E6%95%B0"><i class="fa fa-link"></i></a>関数の引数</h1>

<p>関数の引数には、値渡しと、参照渡しがあります。プリミティブ型は値渡しで、オブジェクトだと参照渡しとのことです。下記の例では、statement は、文字列型、empはオブジェクトです。<br>
<code>changeValues</code> 内で、パラメータに対して新しい値をアサインしていますが、実際に反映されるのは、オブジェクト (emp) のみです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">changeValues</span><span class="p">(</span><span class="nx">statement</span><span class="p">,</span> <span class="nx">emp</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">statement</span> <span class="o">=</span> <span class="s2">"Hi, guys"</span><span class="p">;</span>
    <span class="nx">emp</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">"Taro"</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">statement</span> <span class="o">=</span> <span class="s2">"Hello guys"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Employee</span><span class="p">(</span><span class="s2">"Yamada"</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">statement</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="nx">changeValues</span><span class="p">(</span><span class="nx">statement</span><span class="p">,</span> <span class="nx">emp</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">statement</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Hello guys
Yamada
Hello guys
Taro
</pre></div></div>

<h1>
<span id="call" class="fragment"></span><a href="#call"><i class="fa fa-link"></i></a>call</h1>

<p>メソッドを呼び出す方法はいくつかありますが、その一つが、<code>call</code> を使う方法です。call を使うと、他のオブジェクトに属するメソッドを使えます。下記の例では、<code>emp</code> のメソッドを、<code>myEmp</code> の属性に対して実行しています。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">emp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s2">"Tsuyoshi"</span><span class="p">,</span>
    <span class="nx">baseSalary</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="nx">salary</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">baseSalary</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">myEmp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s2">"Takeru"</span><span class="p">,</span>
    <span class="nx">baseSalary</span><span class="o">:</span> <span class="mi">200</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">salary</span><span class="p">());</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">salary</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">myEmp</span><span class="p">));</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Tsuyoshi
201
401
</pre></div></div>

<h1>
<span id="apply" class="fragment"></span><a href="#apply"><i class="fa fa-link"></i></a>apply</h1>

<p>call とほぼ同じですが、引数を配列で扱えます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">90</span><span class="p">]))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>90
39
</pre></div></div>

<h1>
<span id="self-invoke-method" class="fragment"></span><a href="#self-invoke-method"><i class="fa fa-link"></i></a>self invoke method</h1>

<p>関数は通常定義するだけでは、実行されませんが、定義して、即実行したい時に使います。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="s2">"default"</span><span class="p">;</span>

<span class="c1">// self invoke method</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"hello!"</span><span class="p">;</span>
<span class="p">})();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</pre></div></div>

<p><code>(function() {...})();</code> とすることにより、その場で関数が実行されるので、<code>value</code> の値が書き換えられます。実行結果はこちら。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>hello!
</pre></div></div>

<h1>
<span id="closure" class="fragment"></span><a href="#closure"><i class="fa fa-link"></i></a>closure</h1>

<p>クロージャを使うと、関数に、通常 JavaScript ではできない、プライベートのプロパティや、関数を持つことができます。ポイントは、戻り値として関数を返しているところです。素直に考えると、関数を返した時点では、演算は行われず、関数を実行した時点での、<code>counter</code> が参照されそうです。ところが、クロージャでは、この関数が戻された時の、状態を保持したまま返されます。</p>

<p>だから、次のようなコードを書くと、<code>add1</code> <code>add2</code> それぞれで、値がインクリメントされます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">add1</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;}</span>
<span class="p">})();</span>

<span class="kd">var</span> <span class="nx">add2</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;}</span>
<span class="p">})();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">add1</span><span class="p">());</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">add1</span><span class="p">());</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">add2</span><span class="p">());</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">add2</span><span class="p">());</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1
2
1
2
</pre></div></div>

<h2>
<span id="通常の関数とクロージャの違い" class="fragment"></span><a href="#%E9%80%9A%E5%B8%B8%E3%81%AE%E9%96%A2%E6%95%B0%E3%81%A8%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>通常の関数と、クロージャの違い</h2>

<p>通常の関数と比べると、クロージャは関数を返しています。通常の関数だと、毎回<code>count</code>が初期化されるため、値を保持できません。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">unction</span> <span class="nx">execFunc</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">add</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">display</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">count</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">add</span><span class="p">();</span>
    <span class="nx">display</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">execFunc</span><span class="p">();</span>
<span class="nx">execFunc</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">execClosure</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">display</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">count</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">closure</span> <span class="o">=</span> <span class="nx">execClosure</span><span class="p">();</span>
<span class="nx">closure</span><span class="p">.</span><span class="nx">add</span><span class="p">();</span>
<span class="nx">closure</span><span class="p">.</span><span class="nx">display</span><span class="p">();</span>
<span class="nx">closure</span><span class="p">.</span><span class="nx">add</span><span class="p">();</span>
<span class="nx">closure</span><span class="p">.</span><span class="nx">display</span><span class="p">();</span>

</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1
1
1
2
</pre></div></div>

<h2>
<span id="private-の実現" class="fragment"></span><a href="#private-%E3%81%AE%E5%AE%9F%E7%8F%BE"><i class="fa fa-link"></i></a>Private の実現</h2>

<p>この仕組みを利用して、プライベート属性を実現することができます。クロージャが戻されると、元々の関数の方には、クロージャからアクセスできますが、直接はアクセスできません。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span>
<span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">modify</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">counter</span> <span class="o">+=</span> <span class="nx">num</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">modify</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">modify</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">counter</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">})();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">count</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
<span class="nx">count</span><span class="p">.</span><span class="nx">add</span><span class="p">();</span>
<span class="nx">count</span><span class="p">.</span><span class="nx">add</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">count</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
<span class="nx">count</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">count</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>

<span class="nx">count</span><span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// error</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0
2
1

 count.modify(1); // error
       ^

TypeError: count.modify is not a function
</pre></div></div>

<h1>
<span id="クロージャとクラス" class="fragment"></span><a href="#%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>クロージャとクラス</h1>

<p>ちなみに、状態を持てるということは、クラスと何が違うの？と思ってしまいます。</p>

<p>クロージャとクラスを比較すると、クロージャーの方がメモリをよく食う（メソッドが毎回インスタンス化されるので）しかし、テスタビリティは優れているという話もあります。（まだ調べていません。メモ程度）。となると、後のメリットである、Private を作れるという話ですが、ここまでやって、private を作るべきか？というと微妙かもと思います。効率を考えると基本クラスで問題なさげですが、クロージャの良いユースケースがあったらぜひ教えてください。</p>

<p>次のリソースの中には、DI を使っているときはクロージャはしやすいという記事がありました。ちなみに、使っていないときは、Class の方がモックが楽で、Clousure を使っているとできるけどダークマジックが必要とあります。clousure は liablity (責任を持つこと）に有利で、class はメモリ効率で有利とあります。</p>

<h1>
<span id="リソース" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>リソース</h1>

<ul>
<li><a href="https://www.w3schools.com/js/js_function_closures.asp" rel="nofollow noopener" target="_blank">Function Closures</a></li>
<li><a href="http://qiita.com/cocottejs/items/0c1756ac7e7ec8bae7cb" id="reference-bac33aeca854de0f8223">クラスの落とし穴2 - メソッドとクロージャ</a></li>
<li><a href="https://www.reddit.com/r/javascript/comments/6enbvb/classes_vs_closures_performance/" rel="nofollow noopener" target="_blank">Classes vs. Closures - Performance</a></li>
<li><a href="https://medium.com/engineering-livestream/javascript-classes-vs-closures-3-3-9d9233eb0a5c" rel="nofollow noopener" target="_blank">Javascript Classes vs. Closures (3/3) Testability</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />5位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/4f4308b5bd8fd4e423ae">Angular material のバージョンアップで出会ったいくつかのエラーと解決方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-19 15:53:20</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Node.js]</b> <b>[MaterialDesign]</b> <b>[Angular2]</b> <b>[angularMaterial]</b> <b>[angular-cli]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Angular cli をつかって、Angular material と組み合わせてアプリを作ったが、私の環境で動いてたもの (Mac) が他の人の環境 (PC) で全く動かなかったので、何をしたかをメモしておく。</p>

<h1>
<span id="cannot-read-property-length-of-undefined" class="fragment"></span><a href="#cannot-read-property-length-of-undefined"><i class="fa fa-link"></i></a>Cannot read property 'length' of undefined</h1>

<p><code>npm install</code> 後、 <code>ng serve</code> で発生。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ng serve
Cannot read property 'length' of undefined
</pre></div></div>

<p>これから全く想像がつかないが、<code>src/enviornments/environment.ts</code> に問題がある。無いばあいは、ちゃんと作らないとこのエラーが出る。</p>

<ul>
<li><a href="https://github.com/angular/angular-cli/issues/5053" rel="nofollow noopener" target="_blank">ERROR in Cannot read property 'length' of undefined #5053</a></li>
</ul>

<h1>
<span id="angularmaterialmaterial-has-no-exported-member-mdbuttonmodule" class="fragment"></span><a href="#angularmaterialmaterial-has-no-exported-member-mdbuttonmodule"><i class="fa fa-link"></i></a>@angular/material/material"' has no exported member 'MdButtonModule'.</h1>

<p>こちらは、angular material がアップデートされて、<code>MdXXXX</code> 系が使えなくなったため、<code>MatXXX</code> に切り替える必要があった。ts ファイルと、html の修正の必要性ありだが基本的に置換で可能。</p>

<ul>
<li><a href="https://github.com/angular/material2/issues/7692" rel="nofollow noopener" target="_blank">Build Error: <code>@angular/material/material"' has no exported member</code> #7692</a></li>
</ul>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span>
  <span class="nx">MdMenuModule</span><span class="p">,</span>
  <span class="nx">MdToolbarModule</span><span class="p">,</span>
  <span class="nx">MdIconModule</span><span class="p">,</span>
  <span class="nx">MdTabsModule</span><span class="p">,</span>
  <span class="o">:</span>
</pre></div></div>

<p>を</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span>
  <span class="nx">MatMenuModule</span><span class="p">,</span>
  <span class="nx">MatToolbarModule</span><span class="p">,</span>
  <span class="nx">MatIconModule</span><span class="p">,</span>
  <span class="nx">MatTabsModule</span><span class="p">,</span>
</pre></div></div>

<p>に変える。これだけではなくて、html　も</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">md-grid-list</span> <span class="na">cols</span><span class="o">=</span><span class="s">"2"</span> <span class="na">rowHeight</span><span class="o">=</span><span class="s">"1:1"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">md-grid-tile</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">md-card</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-card"</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">md-card-header</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">mat-card-avatar</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-header-image"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">md-card-title</span><span class="p">&gt;</span>{{car.name}}<span class="p">&lt;/</span><span class="nt">md-card-title</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">md-card-subtitle</span><span class="p">&gt;</span>{{car.company}}<span class="p">&lt;/</span><span class="nt">md-card-subtitle</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">md-card-header</span><span class="p">&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">mat-grid-list</span> <span class="na">cols</span><span class="o">=</span><span class="s">"2"</span> <span class="na">rowHeight</span><span class="o">=</span><span class="s">"1:1"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">mat-grid-tile</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">mat-card</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-card"</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">mat-card-header</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">mat-card-avatar</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-header-image"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">mat-card-title</span><span class="p">&gt;</span>{{car.name}}<span class="p">&lt;/</span><span class="nt">mat-card-title</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">mat-card-subtitle</span><span class="p">&gt;</span>{{car.company}}<span class="p">&lt;/</span><span class="nt">mat-card-subtitle</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">mat-card-header</span><span class="p">&gt;</span>
</pre></div></div>

<p>基本的に <code>md-</code> を <code>mat-</code> の一括置換でオッケー。これの置換を逃れたものとして</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">mdInput</span>
</pre></div></div>

<p>などを</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>
<span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">matInput</span>
</pre></div></div>

<p>にする必要があった。</p>

<h1>
<span id="get-httplocalhost4200sockjs-nodeinfot1508392326937-neterr_connection_refused" class="fragment"></span><a href="#get-httplocalhost4200sockjs-nodeinfot1508392326937-neterr_connection_refused"><i class="fa fa-link"></i></a>GET <a href="http://localhost:4200/sockjs-node/info?t=1508392326937" class="autolink" rel="nofollow noopener" target="_blank">http://localhost:4200/sockjs-node/info?t=1508392326937</a> net::ERR_CONNECTION_REFUSED</h1>

<p><a href="https://camo.qiitausercontent.com/744e996166d5dd55ccbda7d519663fd208cdfc77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34343634633032322d666136612d336330622d363033342d6338363738653636373664612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/744e996166d5dd55ccbda7d519663fd208cdfc77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34343634633032322d666136612d336330622d363033342d6338363738653636373664612e706e67" alt="error.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4464c022-fa6a-3c0b-6034-c8678e6676da.png"></a></p>

<p>これは、Angular CLI （というか、webpack)のバグっぽい。修正できないが回避策はある。<code>ng serve</code> してブラウザで開くときに、<code>localhost</code> ではなく、<code>127.0.0.1</code> を使う。この回避策は、問題が起きたときのみで良いみたい。</p>

<ul>
<li><a href="https://github.com/webpack/webpack-dev-server/issues/416" rel="nofollow noopener" target="_blank">sockjs-node ERR_CONNECTION_REFUSED when accessing from network #416</a></li>
</ul>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>そんなわけで、ちょっとバージョンアップしたらいろいろ修正の必要があったが、なんとかちゃんと動くようになった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />6位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/75e8f2f3fc1d6f758971">SPA から AD B2C で認証し、API Management 経由で Azure Functions を使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-05 02:18:31</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ActiveDirectory]</b> <b>[SPA]</b> <b>[AzureFunctions]</b> <b>[ApiManagement]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今回は前回の記事の続きです。<a href="https://qiita.com/TsuyoshiUshio@github/items/a2a4a7eef923af4e6267" id="reference-5439983f74d175718a80">前回</a>は、SPA と Active Directory B2C を使って、認証、トークン発行して、Azure Functions の方では、トークンの認証だけを行う時のやり方を書いて見ましたが、今回は、Azure Functions と SPA の間に、API Management をかまして見ます。</p>

<p><a href="https://camo.qiitausercontent.com/1f3f3a3d5f5719d1f2539f6300a5eef2bb924069/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66353463666439612d636538342d393261662d616235372d6439663562373539326433622e6a706567" target="_blank" rel="nofollow noopener"><img width="500" alt="Slide1.jpeg" src="https://camo.qiitausercontent.com/1f3f3a3d5f5719d1f2539f6300a5eef2bb924069/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66353463666439612d636538342d393261662d616235372d6439663562373539326433622e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f54cfd9a-ce84-92af-ab57-d9f5b7592d3b.jpeg"></a></p>

<p><a href="https://docs.microsoft.com/en-us/azure/api-management/api-management-key-concepts" rel="nofollow noopener" target="_blank">API Management</a>は、柔軟にバックエンドのAPIを公開するために、URLの付け替え、認証、Development Portalなどの機能が柔軟に揃っています。</p>

<p><a href="https://camo.qiitausercontent.com/26699c519a8ff8adb9ede1b5b2f794304a279585/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37396133626564392d623132612d633363302d356338312d6564396462306661353261622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/26699c519a8ff8adb9ede1b5b2f794304a279585/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37396133626564392d623132612d633363302d356338312d6564396462306661353261622e706e67" alt="Screen Shot 2017-11-05 at 12.46.47 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/79a3bed9-b12a-c3c0-5c81-ed9db0fa52ab.png"></a></p>

<p>こんな感じの API 公開用のページも作ってくれて、なかなかいい感じです。サービスはいいのですが、ドキュメントがいまいちわかりにくいという問題があります。今回は、これを、Active Directory B2C で認証を行って、API マネジメントでトークンの確認を行い、APIマネジメントの部分で、JWT トークンをパースして、中にあるクレームをHTTP Header に入れて、バックエンドの Azure Functions に渡すということをして見ます。</p>

<h1>
<span id="azure-active-directory-b2c-の設定" class="fragment"></span><a href="#azure-active-directory-b2c-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Azure Active Directory B2C の設定</h1>

<p>設定の意味合い、方法は、前回の記事とほぼ同じになりますので、スクリーンショットのみ載せます。SPA は前回のと同じです。(URL のみ API Management に向けています)</p>

<ul>
<li><a href="https://qiita.com/TsuyoshiUshio@github/items/a2a4a7eef923af4e6267">SPA から Azure Functions を使う時のActive Directory B2C 認証設定方法</a></li>
</ul>

<h2>
<span id="application-の設定-api-management-用" class="fragment"></span><a href="#application-%E3%81%AE%E8%A8%AD%E5%AE%9A-api-management-%E7%94%A8"><i class="fa fa-link"></i></a>Application の設定 (API Management 用)</h2>

<p>Reply URL に関しては、API Management 側では、トークンの確認しかしませんので、Reply URL は本来不要ですが、設定しておきます。今回は<code>backend</code> というサブディレクトリにしています。</p>

<p><a href="https://camo.qiitausercontent.com/8b6fcda2d0589851d49b07c92453a8513a7394ab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38343037633863632d343466332d643165662d616334302d6334333336626436316562612e706e67" target="_blank" rel="nofollow noopener"><img width="749" alt="Screen Shot 2017-11-05 at 12.51.40 AM.png" src="https://camo.qiitausercontent.com/8b6fcda2d0589851d49b07c92453a8513a7394ab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38343037633863632d343466332d643165662d616334302d6334333336626436316562612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/8407c8cc-44f3-d1ef-ac40-c4336bd61eba.png"></a></p>

<p>スコープ名はなんでもいいですが、今回は <code>api.read</code> という名前にして見ました。</p>

<p><a href="https://camo.qiitausercontent.com/a82d4f28dcd030716cb3bc26a2b14e759e511eb3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63663830383831332d616461642d333834352d333834302d6165633538333439373331342e706e67" target="_blank" rel="nofollow noopener"><img width="1105" alt="Screen Shot 2017-11-05 at 12.54.12 AM.png" src="https://camo.qiitausercontent.com/a82d4f28dcd030716cb3bc26a2b14e759e511eb3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63663830383831332d616461642d333834352d333834302d6165633538333439373331342e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/cf808813-adad-3845-3840-aec583497314.png"></a></p>

<h2>
<span id="spa-の設定" class="fragment"></span><a href="#spa-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>SPA の設定</h2>

<p>これは前回と同じです。今回のSPAはローカルで動かしているので、Reply URL もローカルのアドレスになっています。</p>

<p><a href="https://camo.qiitausercontent.com/f93ee8dccd36443185d9a9bda3bce24cca2763c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63316265343733382d363135652d313538652d643935372d3436663933363139373832312e706e67" target="_blank" rel="nofollow noopener"><img width="802" alt="Screen Shot 2017-11-05 at 12.55.44 AM.png" src="https://camo.qiitausercontent.com/f93ee8dccd36443185d9a9bda3bce24cca2763c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63316265343733382d363135652d313538652d643935372d3436663933363139373832312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/c1be4738-615e-158e-d957-46f936197821.png"></a></p>

<p>ポイントとしては、新たに追加した、API Management の Application をしっかり足すことです。</p>

<p><a href="https://camo.qiitausercontent.com/d5841b03d85c655727acc7958f5d37c7343fd242/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63376631363538302d623864372d633461362d333431392d6162396531646539346632352e706e67" target="_blank" rel="nofollow noopener"><img width="1209" alt="Screen Shot 2017-11-05 at 12.55.59 AM.png" src="https://camo.qiitausercontent.com/d5841b03d85c655727acc7958f5d37c7343fd242/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63376631363538302d623864372d633461362d333431392d6162396531646539346632352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/c7f16580-b8d7-c4a6-3419-ab9e1de94f25.png"></a></p>

<h2>
<span id="sign-up-sign-in-policy" class="fragment"></span><a href="#sign-up-sign-in-policy"><i class="fa fa-link"></i></a>Sign up/ Sign In policy</h2>

<p>これも前回と同じです。</p>

<p>この赤で括った部分が、openid-configuration のメタデータです。あとで使います。</p>

<p><a href="https://camo.qiitausercontent.com/4c3ede63c10db6e0eb84c3966ad9b9dc0b377551/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34623237356538612d613539312d613936622d616330332d6535363966636435383931352e706e67" target="_blank" rel="nofollow noopener"><img width="587" alt="Screen Shot 2017-11-05 at 12.59.51 AM.png" src="https://camo.qiitausercontent.com/4c3ede63c10db6e0eb84c3966ad9b9dc0b377551/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34623237356538612d613539312d613936622d616330332d6535363966636435383931352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4b275e8a-a591-a96b-ac03-e569fcd58915.png"></a></p>

<p>いくつか設定できますが、今回特にポイントとなる「Claim」を説明します。これは、Azure B2C で認証したのち、<code>Authorization: Bearer ....</code> という形態でヘッダにJWT トークンが格納されるのですが、クレームは、このトークンの中にどの認証情報を含むかという設定です。ここでは、あとで使う <code>emails</code> に注目しましょう。</p>

<p><a href="https://camo.qiitausercontent.com/923d50bc513dee4b9f3794bde6b16d7dcbcc38c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62303862336337362d653931622d666263312d663733612d3430623534316536393938302e706e67" target="_blank" rel="nofollow noopener"><img width="851" alt="Screen Shot 2017-11-05 at 1.00.13 AM.png" src="https://camo.qiitausercontent.com/923d50bc513dee4b9f3794bde6b16d7dcbcc38c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62303862336337362d653931622d666263312d663733612d3430623534316536393938302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/b08b3c76-e91b-fbc1-f73a-40b541e69980.png"></a></p>

<h1>
<span id="api-management" class="fragment"></span><a href="#api-management"><i class="fa fa-link"></i></a>API Management</h1>

<p>API Management を起動して、Publisher Portal のリンクをクリックすると、次のような画面になります。<br>
<a href="https://camo.qiitausercontent.com/098db0da80cf43ffb852fa1854a0cfa5113a6c02/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65626538316563362d386662642d613762352d393035302d3262363036633862383738362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/098db0da80cf43ffb852fa1854a0cfa5113a6c02/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65626538316563362d386662642d613762352d393035302d3262363036633862383738362e706e67" alt="Screen Shot 2017-11-05 at 1.06.49 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/ebe81ec6-8fbd-a7b5-9050-2b606c8b8786.png"></a></p>

<p>設定していきます。</p>

<h2>
<span id="products" class="fragment"></span><a href="#products"><i class="fa fa-link"></i></a>Products</h2>

<p>最初にプロダクトを設定します。今後、API を公開していきますが、そのグループとして、プロダクトという単位があります。この単位で、APIを公開するかどうかというのを設定します。最初は、APIを登録しても、API Management に接続しても、バックエンドのAPI (Azure Functions) にアクセスできない問題がありま下が、これは、Products を設定すればオッケーです。</p>

<p><a href="https://camo.qiitausercontent.com/7231989ed073e6eb8da5c4b4c9b2aace558e8803/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62376365303361382d343334612d383739662d363239322d6130626161636335383164312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7231989ed073e6eb8da5c4b4c9b2aace558e8803/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62376365303361382d343334612d383739662d363239322d6130626161636335383164312e706e67" alt="Screen Shot 2017-11-05 at 1.08.47 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/b7ce03a8-434a-879f-6292-a0baacc581d1.png"></a></p>

<h3>
<span id="product--settings" class="fragment"></span><a href="#product--settings"><i class="fa fa-link"></i></a>Product / Settings</h3>

<p>ここでは、Require subscription のチェックを外します。デフォルトではこのチェックが付いています。JWT のチェックをする場合は、後ほど出てくる Policies の設定で行うので、ここでは、チェックを外しておきます。</p>

<p><a href="https://camo.qiitausercontent.com/e15945c9f18807e0a3c95c710fecad628210f8fe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34623463323264652d346131322d393034662d343236612d3735376264396139646461342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e15945c9f18807e0a3c95c710fecad628210f8fe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34623463323264652d346131322d393034662d343236612d3735376264396139646461342e706e67" alt="Screen Shot 2017-11-05 at 1.09.27 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4b4c22de-4a12-904f-426a-757bd9a9dda4.png"></a></p>

<h2>
<span id="apis" class="fragment"></span><a href="#apis"><i class="fa fa-link"></i></a>APIs</h2>

<p>Settings での設定を見ていきます。</p>

<h3>
<span id="settings" class="fragment"></span><a href="#settings"><i class="fa fa-link"></i></a>Settings</h3>

<ul>
<li>Web service URL</li>
</ul>

<p>Azure Functions の function のURLを入力します。例えば、<code>https://apimgbackend.azurewebsites.net/api/HttpTrigger?code=xasdfasdfasdgasdgasdgagalllacad923gdaga&amp;name=Azure</code> みたいな感じだとしても、最初のホスト名までで結構です。</p>

<ul>
<li>Web API URL suffix</li>
</ul>

<p>API Management 経由でこの バックエンド API を呼ぶ時のURLになります。これを設定すると、下に、どんなURLになるのかが表示されています。(This is what the Web API URL is going to look like:のところ) </p>

<ul>
<li>Web API URL Schema</li>
</ul>

<p>今はHTTP を設定しています。なぜかというと、SSL証明書を設定しないと、HTTPs を選べないからです。WebApps/Functions とかだと、デフォルトであるので不要なのですが、プロダクションで使うものなので、どうせ証明書がいるので、HTTPS を使いたければ、設定する必要があります。ここでは、テストなので HTTP にしています。</p>

<p><a href="https://camo.qiitausercontent.com/cab2a3834bc86d6ce086523398ee2db0860e1827/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38653262646636302d383433612d643164642d636433372d6462323533636663383532652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cab2a3834bc86d6ce086523398ee2db0860e1827/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38653262646636302d383433612d643164642d636433372d6462323533636663383532652e706e67" alt="Screen Shot 2017-11-05 at 1.23.07 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/8e2bdf60-843a-d1dd-cd37-db253cfc852e.png"></a></p>

<h3>
<span id="operations" class="fragment"></span><a href="#operations"><i class="fa fa-link"></i></a>Operations</h3>

<p>ここに、API をちゃんと登録しないと、公開されませんし、開発者ドキュメントに反映されません。必要な文を登録しましょう。</p>

<p><a href="https://camo.qiitausercontent.com/8c22d2aaec099120432dd8ee4c4e1d69de789449/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62323833303339392d376236312d653764392d613463332d3339623338666264643732332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8c22d2aaec099120432dd8ee4c4e1d69de789449/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62323833303339392d376236312d653764392d613463332d3339623338666264643732332e706e67" alt="Screen Shot 2017-11-05 at 1.23.18 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/b2830399-7b61-e7d9-a4c3-39b38fbdd723.png"></a></p>

<p>ここでは、Api Management の提供するホスト名に対して、<code>http://xxxx/backend?name=Azure</code> というリクエストを送ると、バックエンド Function に対して <code>https://yyyyy/api/HttpTriggerCSharp1?code=xxxxxxxxx&amp;name=Azure</code> といったようなルーティングをしようとしています。{name} の箇所がバックエンド側の設定 (Rewrite URL template) に引き継がれます。</p>

<p><em>URL template</em></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>/backend?name={name}
</pre></div></div>

<p><em>Rewrite URL template</em></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>api/HttpTriggerCSharp1?code=h8o7xxxxxxxxxPqafQ==&amp;name={name}
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/e9543777df6b36084f40b1e51a26869d47e7f450/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66396565656436642d393431372d613364372d623264372d3431616161376634643138362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e9543777df6b36084f40b1e51a26869d47e7f450/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66396565656436642d393431372d613364372d623264372d3431616161376634643138362e706e67" alt="Screen Shot 2017-11-05 at 1.46.07 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f9eeed6d-9417-a3d7-b2d7-41aaa7f4d186.png"></a></p>

<h2>
<span id="policies" class="fragment"></span><a href="#policies"><i class="fa fa-link"></i></a>Policies</h2>

<p>今回最大のポイントとなるところです。</p>

<p>次の画面になります。Product / API / Operation を選択して、それに対して、ポリシーを適用していきます。最後に全体を載せますが、個別に設定しておきます。 XML で設定できるようです。</p>

<h3>
<span id="validate-jwt" class="fragment"></span><a href="#validate-jwt"><i class="fa fa-link"></i></a>Validate JWT</h3>

<p>SPA 側で認証したAccess Token を検証します。</p>

<p>ポイントとしては、<code>open-config</code> のところで、<code>Sign up/ Sign In policy</code>のところで、獲得した、open config のメタデータをここに貼っておきます。また、<code>audience</code> のところは、Azure Active Directory B2C で設定したAPI Management の Application ID になります。</p>

<p>また、ここで、<code>required-claim</code> というのもありますが、ここにクレームを書いておくと、そのクレームがJWTトークンに含まれいていることが必須になります。ですのでここでは、特に設定していません。</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span>        <span class="nt">&lt;validate-jwt</span> <span class="na">header-name=</span><span class="s">"Authorization"</span> <span class="na">failed-validation-httpcode=</span><span class="s">"401"</span> <span class="na">failed-validation-error-message=</span><span class="s">"Unauthorized. Access token is missing or invalid."</span><span class="nt">&gt;</span>
            <span class="nt">&lt;openid-config</span> <span class="na">url=</span><span class="s">"https://login.microsoftonline.com/someorganication.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=B2C_1_SPA-APIManagement"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;audiences&gt;</span>
                <span class="c">&lt;!-- API Management Application ID --&gt;</span>
                <span class="nt">&lt;audience&gt;</span>782a51e6-4186-4258-95cc-7c6720ec4e72<span class="nt">&lt;/audience&gt;</span>
            <span class="nt">&lt;/audiences&gt;</span>
            <span class="c">&lt;!--&lt;required-claims&gt;</span>
<span class="c">                &lt;claim name="id" match="all"&gt;</span>
<span class="c">                    &lt;value&gt;xxx&lt;/value&gt;</span>
<span class="c">                &lt;/claim&gt;</span>
<span class="c">            &lt;/required-claims&gt;--&gt;</span>
        <span class="nt">&lt;/validate-jwt&gt;</span>
</pre></div></div>

<h3>
<span id="cors" class="fragment"></span><a href="#cors"><i class="fa fa-link"></i></a>CORS</h3>

<p>SPA の場合 CORS が必要なので設定しておきます。見ての通りですね。<code>origin</code> のところに、SPAのURLを書いておきます。</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span>
        <span class="nt">&lt;cors&gt;</span>
            <span class="nt">&lt;allowed-origins&gt;</span>
                <span class="c">&lt;!--&lt;origin&gt;*&lt;/origin&gt;--&gt;</span>
                <span class="c">&lt;!-- allow any --&gt;</span>
                <span class="c">&lt;!-- OR a list of one or more specific URIs (case-sensitive) --&gt;</span>
                <span class="nt">&lt;origin&gt;</span>http://localhost:6420<span class="nt">&lt;/origin&gt;</span>
                <span class="c">&lt;!-- URI must include scheme, host, and port. If port is omitted, 80 is assumed for http and 443 is assumed for https. --&gt;</span>
            <span class="nt">&lt;/allowed-origins&gt;</span>
            <span class="nt">&lt;allowed-methods&gt;</span>
                <span class="c">&lt;!-- allow any --&gt;</span>
                <span class="nt">&lt;method&gt;</span>*<span class="nt">&lt;/method&gt;</span>
            <span class="nt">&lt;/allowed-methods&gt;</span>
            <span class="nt">&lt;allowed-headers&gt;</span>
                <span class="c">&lt;!-- allow any --&gt;</span>
                <span class="nt">&lt;header&gt;</span>*<span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;/allowed-headers&gt;</span>
        <span class="nt">&lt;/cors&gt;</span>
</pre></div></div>

<h3>
<span id="jwt-の-parse-と-set-header" class="fragment"></span><a href="#jwt-%E3%81%AE-parse-%E3%81%A8-set-header"><i class="fa fa-link"></i></a>JWT の Parse と Set Header</h3>

<p>JTW をパースして、B2Cで設定したクレームを取得して、ヘッダにセットしておきます。そうするとバックエンド側で、JWTのパースが不要になります。単に <code>TryParseJwt(out jwt)</code> メソッドでパースして、Jwt のインスタンスを取得して、値をヘッダーにセットする<code>set-header</code> タグを使っているだけですね。簡単。<code>emails</code> というクレームを、<code>x-b2c-email-claim</code> というヘッダにセットしています。</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span>        <span class="nt">&lt;set-header</span> <span class="na">name=</span><span class="s">"x-b2c-email-claim"</span> <span class="na">exists-action=</span><span class="s">"override"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>@{
        var emails = "default@email.com";
        var authHeader = context.Request.Headers.GetValueOrDefault("Authorization", "");
        if (authHeader?.Length &gt; 0)
        {
          string[] authHeaderParts = authHeader.Split(' ');
          if (authHeaderParts?.Length == 2 <span class="err">&amp;&amp;</span> authHeaderParts[0].Equals("Bearer", StringComparison.InvariantCultureIgnoreCase))
          {
            Jwt jwt;
            if (authHeaderParts[1].TryParseJwt(out jwt))
            {
              emails = jwt.Claims.GetValueOrDefault("emails", emails);
            }
          }
        }
        return emails;
      }<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/set-header&gt;</span>
</pre></div></div>

<p>これで、API Management 側の設定は完了です。Policy のソース全体を載せておきます。</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span><span class="nt">&lt;policies&gt;</span>
    <span class="nt">&lt;inbound&gt;</span>
        <span class="nt">&lt;validate-jwt</span> <span class="na">header-name=</span><span class="s">"Authorization"</span> <span class="na">failed-validation-httpcode=</span><span class="s">"401"</span> <span class="na">failed-validation-error-message=</span><span class="s">"Unauthorized. Access token is missing or invalid."</span><span class="nt">&gt;</span>
            <span class="nt">&lt;openid-config</span> <span class="na">url=</span><span class="s">"https://login.microsoftonline.com/someorganication.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=B2C_1_SPA-APIManagement"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;audiences&gt;</span>
                <span class="c">&lt;!-- API Management Application ID --&gt;</span>
                <span class="nt">&lt;audience&gt;</span>782a51e6-4186-4258-95cc-7c6720ec4e72<span class="nt">&lt;/audience&gt;</span>
            <span class="nt">&lt;/audiences&gt;</span>
            <span class="c">&lt;!--&lt;required-claims&gt;</span>
<span class="c">                &lt;claim name="id" match="all"&gt;</span>
<span class="c">                    &lt;value&gt;xxx&lt;/value&gt;</span>
<span class="c">                &lt;/claim&gt;</span>
<span class="c">            &lt;/required-claims&gt;--&gt;</span>
        <span class="nt">&lt;/validate-jwt&gt;</span>
        <span class="nt">&lt;cors&gt;</span>
            <span class="nt">&lt;allowed-origins&gt;</span>
                <span class="c">&lt;!--&lt;origin&gt;*&lt;/origin&gt;--&gt;</span>
                <span class="c">&lt;!-- allow any --&gt;</span>
                <span class="c">&lt;!-- OR a list of one or more specific URIs (case-sensitive) --&gt;</span>
                <span class="nt">&lt;origin&gt;</span>http://localhost:6420<span class="nt">&lt;/origin&gt;</span>
                <span class="c">&lt;!-- URI must include scheme, host, and port. If port is omitted, 80 is assumed for http and 443 is assumed for https. --&gt;</span>
            <span class="nt">&lt;/allowed-origins&gt;</span>
            <span class="nt">&lt;allowed-methods&gt;</span>
                <span class="c">&lt;!-- allow any --&gt;</span>
                <span class="nt">&lt;method&gt;</span>*<span class="nt">&lt;/method&gt;</span>
            <span class="nt">&lt;/allowed-methods&gt;</span>
            <span class="nt">&lt;allowed-headers&gt;</span>
                <span class="c">&lt;!-- allow any --&gt;</span>
                <span class="nt">&lt;header&gt;</span>*<span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;/allowed-headers&gt;</span>
        <span class="nt">&lt;/cors&gt;</span>
        <span class="nt">&lt;set-header</span> <span class="na">name=</span><span class="s">"x-b2c-email-claim"</span> <span class="na">exists-action=</span><span class="s">"override"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>@{
        var emails = "default@email.com";
        var authHeader = context.Request.Headers.GetValueOrDefault("Authorization", "");
        if (authHeader?.Length &gt; 0)
        {
          string[] authHeaderParts = authHeader.Split(' ');
          if (authHeaderParts?.Length == 2 <span class="err">&amp;&amp;</span> authHeaderParts[0].Equals("Bearer", StringComparison.InvariantCultureIgnoreCase))
          {
            Jwt jwt;
            if (authHeaderParts[1].TryParseJwt(out jwt))
            {
              emails = jwt.Claims.GetValueOrDefault("emails", emails);
            }
          }
        }
        return emails;
      }<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/set-header&gt;</span>
        <span class="nt">&lt;base</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;rewrite-uri</span> <span class="na">template=</span><span class="s">"api/HttpTriggerCSharp1?code=h8o7xxxxxxxxxPqafQ==&amp;amp;name={name}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inbound&gt;</span>
    <span class="nt">&lt;backend&gt;</span>
        <span class="nt">&lt;base</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/backend&gt;</span>
    <span class="nt">&lt;outbound&gt;</span>
        <span class="nt">&lt;base</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/outbound&gt;</span>
    <span class="nt">&lt;on-error&gt;</span>
        <span class="nt">&lt;base</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/on-error&gt;</span>
<span class="nt">&lt;/policies&gt;</span>
</pre></div></div>

<h1>
<span id="spa側の設定変更" class="fragment"></span><a href="#spa%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4"><i class="fa fa-link"></i></a>SPA側の設定変更</h1>

<p><a href="https://qiita.com/TsuyoshiUshio@github/items/a2a4a7eef923af4e6267">前回</a>とソースは同じですが、b2cScopes と webApi の変更をお忘れなく。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span>        <span class="kd">var</span> <span class="nx">applicationConfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">clientID</span><span class="o">:</span> <span class="s1">'84270d3d-1c67-4d18-8436-f3a121b1ebef'</span><span class="p">,</span>
            <span class="nx">authority</span><span class="o">:</span> <span class="s2">"https://login.microsoftonline.com/tfp/someorganication.onmicrosoft.com/B2C_1_SPA_Local"</span><span class="p">,</span>
            <span class="nx">b2cScopes</span><span class="o">:</span> <span class="p">[</span><span class="s2">"https://someorganication.onmicrosoft.com/backend/api.read"</span><span class="p">],</span>
            <span class="nx">webApi</span><span class="o">:</span> <span class="s1">'http://sometest.azure-api.net/backend/backend?name=Azure'</span><span class="p">,</span>
        <span class="p">};</span>
</pre></div></div>

<p>なお、現在のURLはデベロッパーポータルからとって来れます。スクリーンショットでは、401 になっていますが、これは、Policy で、JWTトークンの設定をしているからで、その設定をする前だと、ここでAPIのテストもすることができます。テストをする前だと、各種言語で、このAPIにアクセスするための、サンプルコードまでついていますので、これはいい感じ。</p>

<p><a href="https://camo.qiitausercontent.com/0bcd175f5d213fc4ed05a80b7740fec71dbc1642/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65666462646161372d303639632d366162362d346333632d6636646132393030653832382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0bcd175f5d213fc4ed05a80b7740fec71dbc1642/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65666462646161372d303639632d366162362d346333632d6636646132393030653832382e706e67" alt="Screen Shot 2017-11-05 at 1.54.57 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/efdbdaa7-069c-6ab6-4c3c-f6da2900e828.png"></a></p>

<h1>
<span id="azure-functions-側のコード" class="fragment"></span><a href="#azure-functions-%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>Azure Functions 側のコード</h1>

<p>ここでは、SPA では、API Management のエンドポイントがバレるのは防げないので、トークンの確認をして保護しています。API Management からは、Azure Functions をhttps で接続するようにして、中を読み取られれないようにします。その上で、Policyで設定したクレームを単に表示してみましょう。C# の HttpTrigger に、// Get Auth Parameter value の項目を追加しただけです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">Run</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"C# HTTP trigger function processed a request."</span><span class="p">);</span>

    <span class="c1">// parse query parameter</span>
    <span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">req</span><span class="p">.</span><span class="n">GetQueryNameValuePairs</span><span class="p">()</span>
        <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">q</span> <span class="p">=&gt;</span> <span class="kt">string</span><span class="p">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="s">"name"</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Value</span><span class="p">;</span>

    <span class="c1">// Get Auth Parameter value</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">keyValue</span> <span class="k">in</span> <span class="n">req</span><span class="p">.</span><span class="n">Headers</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">keyValue</span><span class="p">.</span><span class="n">Key</span> <span class="p">+</span> <span class="s">": "</span> <span class="p">+</span> <span class="n">keyValue</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="c1">// Get request body</span>
    <span class="kt">dynamic</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">req</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">ReadAsAsync</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>

    <span class="c1">// Set name to query string or body data</span>
    <span class="n">name</span> <span class="p">=</span> <span class="n">name</span> <span class="p">??</span> <span class="n">data</span><span class="p">?.</span><span class="n">name</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">name</span> <span class="p">==</span> <span class="k">null</span>
        <span class="p">?</span> <span class="n">req</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">BadRequest</span><span class="p">,</span> <span class="s">"Please pass a name on the query string or in the request body"</span><span class="p">)</span>
        <span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="s">"Hello "</span> <span class="p">+</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="実行" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>実行</h1>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>node server.js
</pre></div></div>

<p>を実行して、認証します。</p>

<p><a href="https://camo.qiitausercontent.com/d3dee32872193cb696c6ab022287397e942448d2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30356131323538382d363261312d306266372d396633322d3664353264626462346533382e706e67" target="_blank" rel="nofollow noopener"><img width="783" alt="Screen Shot 2017-11-05 at 2.03.39 AM.png" src="https://camo.qiitausercontent.com/d3dee32872193cb696c6ab022287397e942448d2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30356131323538382d363261312d306266372d396633322d3664353264626462346533382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/05a12588-62a1-0bf7-9f32-6d52dbdb4e38.png"></a></p>

<p><code>login</code> をクリックして認証</p>

<p><a href="https://camo.qiitausercontent.com/8ef8c36542aa8e2cc9b22b1a7576b310c824d8e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30336230386162382d623433632d616664632d386335322d6338313832646663343533322e706e67" target="_blank" rel="nofollow noopener"><img width="1816" alt="Screen Shot 2017-11-05 at 2.03.49 AM.png" src="https://camo.qiitausercontent.com/8ef8c36542aa8e2cc9b22b1a7576b310c824d8e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30336230386162382d623433632d616664632d386335322d6338313832646663343533322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/03b08ab8-b43c-afdc-8c52-c8182dfc4532.png"></a></p>

<p>トークンが帰ってきたので、<code>Call Web API</code> クリック。バックエンドがコールされる</p>

<p><a href="https://camo.qiitausercontent.com/a485f1047ae7f0fceea837ab3c92a665e7f47ab8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39343266663862652d663034632d336533612d376333612d3134306330396566363831642e706e67" target="_blank" rel="nofollow noopener"><img width="798" alt="Screen Shot 2017-11-05 at 2.04.39 AM.png" src="https://camo.qiitausercontent.com/a485f1047ae7f0fceea837ab3c92a665e7f47ab8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39343266663862652d663034632d336533612d376333612d3134306330396566363831642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/942ff8be-f04c-3e3a-7c3a-140c09ef681d.png"></a></p>

<p><code>Azure Functions</code> が動く。ログを見ると、しっかりと、emails クレームが取得できている！</p>

<p><a href="https://camo.qiitausercontent.com/c4038a2bc5e14b810394f204d3ee69c929d8a809/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38326263303966352d623765362d613462352d336131342d6537626338333764636264322e706e67" target="_blank" rel="nofollow noopener"><img width="1153" alt="Screen Shot 2017-11-05 at 2.04.57 AM.png" src="https://camo.qiitausercontent.com/c4038a2bc5e14b810394f204d3ee69c929d8a809/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38326263303966352d623765362d613462352d336131342d6537626338333764636264322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/82bc09f5-b7e6-a4b5-3a14-e7bc837dcbd2.png"></a></p>

<h1>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h1>

<p>ざっとみていると、どうやらここまでの設定は、Git に保存してそこからクローンとかできそう。これは、再作成の時に便利そうですね。</p>

<p><a href="https://camo.qiitausercontent.com/5913b42d5ea3b10431f9aec789fb2bfdaa2c6fa1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33326266646632362d386366372d396432362d383737382d6431633265306363623438382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5913b42d5ea3b10431f9aec789fb2bfdaa2c6fa1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33326266646632362d386366372d396432362d383737382d6431633265306363623438382e706e67" alt="Screen Shot 2017-11-05 at 2.05.23 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/32bfdf26-8cf7-9d26-8778-d1c2e0ccb488.png"></a></p>

<p><code>Save configuration to repository</code> をクリックすると、ここで、Git リポジトリができて、設定がセーブされる感じ</p>

<p><a href="https://camo.qiitausercontent.com/ba78595d2531f66ca3e98808b0aa75adb8392e58/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37643831393562622d303931622d616539302d393738652d6231643039333764303365362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ba78595d2531f66ca3e98808b0aa75adb8392e58/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37643831393562622d303931622d616539302d393738652d6231643039333764303365362e706e67" alt="Screen Shot 2017-11-05 at 2.11.59 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7d8195bb-091b-ae90-978e-b1d0937d03e6.png"></a></p>

<p>パスワードを生成したら、普通にクローンできた。これはいいね。</p>

<p><a href="https://camo.qiitausercontent.com/02c6b0e908e0c66577ef66a60a8a92c3656beb6e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35396665636166332d353639332d386634382d373937362d3666626265366364623430392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/02c6b0e908e0c66577ef66a60a8a92c3656beb6e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35396665636166332d353639332d386634382d373937362d3666626265366364623430392e706e67" alt="Screen Shot 2017-11-05 at 2.14.06 AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/59fecaf3-5693-8f48-7976-6fbbe6cdb409.png"></a></p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://qiita.com/TsuyoshiUshio@github/items/a2a4a7eef923af4e6267">SPA から Azure Functions を使う時のActive Directory B2C 認証設定方法</a></li>
<li><a href="http://devjourney.com/blog/2017/03/23/extract-jwt-claims-in-azure-api-management-policy/" rel="nofollow noopener" target="_blank">Extract JWT Claims in Azure API Management Policy</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/api-management/api-management-policy-expressions" rel="nofollow noopener" target="_blank">API Management policy expressions</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />7位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/2f2cc6e40d11b7bd7d47">Serverless Framework on Azure 試してみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-02 21:58:44</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Azure]</b> <b>[AzureFunctions]</b> <b>[ServerlessFramework]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ちょっと試しに、Serverless Framework を試してみた。</p>

<ul>
<li><a href="https://serverless.com/framework/docs/providers/azure/guide/quick-start/" rel="nofollow noopener" target="_blank">Serverless Framework Azure - Quick Start</a></li>
</ul>

<h1>
<span id="セットアップ方法" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>セットアップ方法</h1>

<p>これはとても簡単。<code>node v6.5.0</code>以上が入っているなら次のでおっけー。なんの問題もなくインストールできた。（当方 Mac Book Pro)</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>npm install -g serverless 
npm install -g serverless-azure-functions
</pre></div></div>

<p>これで終了。簡単だ。</p>

<h1>
<span id="function-を作成してデプロイ" class="fragment"></span><a href="#function-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%A6%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4"><i class="fa fa-link"></i></a>function を作成してデプロイ。</h1>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ serverless create --template azure-nodejs --path my-service --name my-unique-name
$ cd my-service
$ npm install
</pre></div></div>

<p>これも手順の通りだ。テンプレートができているので、デプロイしよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>serverless deploy
Serverless: Packaging service...
Serverless: Excluding development dependencies...
Serverless: Logging in to Azure
Serverless: Open a browser to https://aka.ms/devicelogin and provide the following code (which is copied to your clipboard!) to complete the login process: GYS4UB337
</pre></div></div>

<p>ログインのコードを求められるので、ブラウザで上記のURLを打ってコードを入れると、デプロイされる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Serverless: Creating resource group: my-unique-name-rg
Serverless: Creating function app: my-unique-name
Serverless: Waiting for Kudu endpoint...
Serverless: Parsing Azure Functions Bindings.json...
Serverless: Building binding for function: hello event: httpTrigger
Serverless: Building binding for function: hello event: http
Serverless: Packaging function: hello
Serverless: Syncing Triggers....Response statuscode: 200
Serverless: Running Kudu command del package.json...
Serverless: Uploading pacakge.json...
Serverless: Running Kudu command npm install --production...
Serverless: Successfully created Function App
</pre></div></div>

<p>リソースグループが作られて、そこに、functions が作られて、デプロイされている。</p>

<h1>
<span id="service-principal-を使ったデプロイ" class="fragment"></span><a href="#service-principal-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4"><i class="fa fa-link"></i></a>Service Principal を使ったデプロイ</h1>

<p>Azure に慣れている人だったら、なんでサービスプリンシパルを使わないんだろうと思うだろう。もちろん、サポートされている。次の環境変数をセットしてみよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>export azureSubId='&lt;subscriptionId&gt;'
export azureServicePrincipalTenantId='&lt;tenantId&gt;'
export azureServicePrincipalClientId='&lt;servicePrincipalName&gt;'
export azureServicePrincipalPassword='&lt;password&gt;'
</pre></div></div>

<p>次に、<code>serverless.yaml</code> ができているのでそれを編集。自分の好きなFunctions の名前を指定できる。どうやらバインディングスも多少は設定できるっぽい。<code>service</code> と書いている項目が、<code>FunctionsApp</code> 名になっている。つまり、この中に <code>functions</code> をたくさん持てる単位。</p>

<div class="code-frame" data-lang="yaml"><div class="highlight"><pre><span></span>
<span class="c1"># Welcome to Serverless!</span>
<span class="c1">#</span>
<span class="c1"># This file is the main config file for your service.</span>
<span class="c1"># It's very minimal at this point and uses default values.</span>
<span class="c1"># You can always add more config options for more control.</span>
<span class="c1"># We've included some commented out config examples here.</span>
<span class="c1"># Just uncomment any of them to get that config option.</span>
<span class="c1">#</span>
<span class="c1"># For full config options, check the docs:</span>
<span class="c1">#    docs.serverless.com</span>
<span class="c1">#</span>
<span class="c1"># Happy Coding!</span>

<span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-unique-name</span>

<span class="c1"># You can pin your service to only deploy with a specific Serverless version</span>
<span class="c1"># Check out our docs for more details</span>
<span class="c1"># frameworkVersion: "=X.X.X"</span>

<span class="l l-Scalar l-Scalar-Plain">provider</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure</span>
  <span class="l l-Scalar l-Scalar-Plain">location</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">West US</span>

<span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">serverless-azure-functions</span>

<span class="c1"># you can add packaging information here</span>
<span class="c1">#package:</span>
<span class="c1">#  include:</span>
<span class="c1">#    - include-me.js</span>
<span class="c1">#    - include-me-dir/**</span>
<span class="c1">#  exclude:</span>
<span class="c1">#    - exclude-me.js</span>
<span class="c1">#    - exclude-me-dir/**</span>

<span class="l l-Scalar l-Scalar-Plain">functions</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">hello</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">handler</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">handler.hello</span>
    <span class="l l-Scalar l-Scalar-Plain">events</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">x-azure-settings</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">authLevel</span> <span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">anonymous</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">x-azure-settings</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">direction</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">out</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">res</span>

<span class="c1"># The following are a few examples of other events you can configure:</span>
<span class="c1">#</span>
<span class="c1"># events:</span>
<span class="c1">#   - queue: YourQueueName</span>
<span class="c1">#     x-azure-settings:</span>
<span class="c1">#       connection : StorageAppSettingName</span>
<span class="c1">#   - blob:</span>
<span class="c1">#     x-azure-settings:</span>
<span class="c1">#       name: bindingName</span>
<span class="c1">#       direction: in</span>
</pre></div></div>

<p>ちなみにここで早まってはいけない。一つ重大なポイントがある。<code>service</code> に既存の<code>FunctionsApp</code> 名を指定してデプロイしてはいけない。</p>

<p>それを、私がやった結果w</p>

<p><a href="https://camo.qiitausercontent.com/f04d4cffcf428c5ad5e685cce8bb4931c52e78f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38313335393762622d353864302d313963352d643039372d3634333833393365303739392e706e67" target="_blank" rel="nofollow noopener"><img width="486" alt="Screen Shot 2017-10-02 at 8.58.41 PM.png" src="https://camo.qiitausercontent.com/f04d4cffcf428c5ad5e685cce8bb4931c52e78f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38313335393762622d353864302d313963352d643039372d3634333833393365303739392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/813597bb-58d0-19c5-d097-6438393e0799.png"></a></p>

<p><code>serverless deploy</code> は、サービス全体のデプロイ（つまり、FunctionsApp) のデプロイなので、なんと、既存のがあったら、がっつり既存の functions を削除して作り直そうとしてしまう。（その上失敗するw）</p>

<p>だから、使われていない、<code>Service</code> 名を使って、デプロイすると、無事デプロイされる。</p>

<p><a href="https://camo.qiitausercontent.com/851deca27ce32985089672b9fa2c88013f75e4d9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34663431356662632d316334372d316161642d656232652d6337393162356663656262662e706e67" target="_blank" rel="nofollow noopener"><img width="1071" alt="Screen Shot 2017-10-02 at 9.56.26 PM.png" src="https://camo.qiitausercontent.com/851deca27ce32985089672b9fa2c88013f75e4d9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34663431356662632d316334372d316161642d656232652d6337393162356663656262662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4f415fbc-1c47-1aad-eb2e-c791b5fcebbf.png"></a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>実際に触ってみると、相当軽快にデプロイできた。コマンドラインというのも嬉しい。ただし、<a href="https://github.com/serverless/serverless-azure-functions" rel="nofollow noopener" target="_blank">serverless/serverless-azure-functions</a> をみても、コマンドのサブコマンドが未実装なのが多い。これはコントリビュートするしかないだろう。しかし、コマンドが充実したら実に快適な感じなので、ちょっと貢献してみたいプロジェクトだ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />8位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/7cd5634a66efe32b7aa7">Visual Studio Code for Mac C# 試したら、インテリセンスが効かずエラーが出たのでその対処</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-10 11:56:55</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[C#]</b> <b>[VisualStudioCode]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>単なるじぶんに対するメモ。</p>

<h1>
<span id="net-core-入っているのにインストールしろと言われる" class="fragment"></span><a href="#net-core-%E5%85%A5%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%AB%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%82%8D%E3%81%A8%E8%A8%80%E3%82%8F%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>.NET Core 入っているのにインストールしろと言われる</h1>

<p>Visual Studio Code で　C# を Mac から試したら、何やらエラーが出てうまく動かなかった。<code>.NET Core</code> を入れろや！というエラーメッセージが出てくるのだが、そんなものとっくに入っている。ちなみに</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ dotnet --info
.NET Command Line Tools (2.0.0)

Product Information:
 Version:            2.0.0
 Commit SHA-1 hash:  cdcd1928c9

Runtime Environment:
 OS Name:     Mac OS X
 OS Version:  10.12
 OS Platform: Darwin
 RID:         osx.10.12-x64
 Base Path:   /usr/local/share/dotnet/sdk/2.0.0/

Microsoft .NET Core Shared Framework Host

  Version  : 2.0.0
  Build    : e8b8861ac7faf042c87a5c2f9f2d04c98b69f28d
</pre></div></div>

<p>ちゃんと動くし。インターネットで調べるとバグという話もあるが、載っている開放ではうまくいかない。<br>
下記のようなエラーも出ていた。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>.net core mac Microsoft.Build.Exceptions.InvalidProjectFileException: The SDK 'Microsoft.NET.Sdk' specified could not be found.
</pre></div></div>

<ul>
<li><a href="https://github.com/OmniSharp/omnisharp-vscode/issues/627" rel="nofollow noopener" target="_blank">The .NET CLI tools cannot be located #627</a></li>
</ul>

<p>このポストで、Windows の場合複数バージョンがあるとダメみたいなことが書いてあったので、ふと思いついて、.NET Core を消して再起動するとうまくいった。</p>

<h1>
<span id="net-core-を-mac-で再インストールしてみる" class="fragment"></span><a href="#net-core-%E3%82%92-mac-%E3%81%A7%E5%86%8D%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>.NET Core を Mac で　再インストールしてみる</h1>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre><span></span><span class="gp">#</span> delete the dotnet folder under /usr/local/share/dotnet
<span class="go">1. cd /usr/local/share/dotnet &amp;&amp; ls</span>
<span class="go">2. sudo rm -rf dotnet</span>

<span class="gp">#</span> delete the dotnet reference file at /etc/paths.d/dotnet
<span class="go">1. cd /etc/paths.d &amp;&amp; ls</span>
<span class="go">2. sudo rm dotnet</span>
</pre></div></div>

<ul>
<li><a href="https://gist.github.com/sandrovicente/5590f5ac993d9d7fef038fd2858efcc3" rel="nofollow noopener" target="_blank">Steps to uninstall a DotNet CLI version on Mac OS X</a></li>
</ul>

<p>これでおっけー。インテリセンス！これないとC# のよさ半減よね。</p>

<p><a href="https://camo.qiitausercontent.com/52edc7bcff4e0c89c360c51f763f50df1d994ec6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32633162303732392d393733362d613631612d653933332d3965363762363836396662382e706e67" target="_blank" rel="nofollow noopener"><img width="1019" alt="Screen Shot 2017-10-10 at 11.56.13 AM.png" src="https://camo.qiitausercontent.com/52edc7bcff4e0c89c360c51f763f50df1d994ec6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32633162303732392d393733362d613631612d653933332d3965363762363836396662382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/2c1b0729-9736-a61a-e933-9e67b6869fb8.png"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />9位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/41c085a5e68fea0ff9bb">Azure Functions を TypeScript で書いてみる。</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-05 23:12:10</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> <b>[AzureFunctions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Mac で、Azure Functions をいじろうと思って、C# もかけるけど、まずは、node + Azure Functions CLI の組み合わせで、書いてみようと思った。簡単な、 CosmosDB に接続するサンプル。</p>

<h1>
<span id="噂の-callback-hell" class="fragment"></span><a href="#%E5%99%82%E3%81%AE-callback-hell"><i class="fa fa-link"></i></a>噂の Callback hell</h1>

<p>一番簡単そうな、CosmosDB の node からのチュートリアルをやってみた。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/cosmos-db/documentdb-nodejs-application" rel="nofollow noopener" target="_blank">Build a Node.js web application using Azure Cosmos DB</a></li>
</ul>

<p>コードが見当たらなかったので、自分で書いたのを GitHub に上げておいた。</p>

<ul>
<li><a href="https://github.com/TsuyoshiUshio/ToDo" rel="nofollow noopener" target="_blank">ToDo</a></li>
</ul>

<p>ちなみに、こんな感じのが３ファイルぐらい必要だった。単なる ToDo に、、、orz</p>

<p><em>taskDao.js</em></p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">DocumentDBClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'documentdb'</span><span class="p">).</span><span class="nx">DocumentClient</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">docdbUtils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./docdbUtils'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">TaskDao</span><span class="p">(</span><span class="nx">documentDBClient</span><span class="p">,</span> <span class="nx">databaseId</span><span class="p">,</span> <span class="nx">collectionId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">documentDBClient</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">databaseId</span> <span class="o">=</span> <span class="nx">databaseId</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collectionId</span> <span class="o">=</span> <span class="nx">collectionId</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">database</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">TaskDao</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="nx">docdbUtils</span><span class="p">.</span><span class="nx">getOrCreateDatabase</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">databaseId</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">database</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
                <span class="nx">docdbUtils</span><span class="p">.</span><span class="nx">getOrCreateCollection</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">_self</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collectionId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">coll</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">find</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">querySpec</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">queryDocuments</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">_self</span><span class="p">,</span> <span class="nx">querySpec</span><span class="p">).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">addItem</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="nx">item</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
        <span class="nx">item</span><span class="p">.</span><span class="nx">completed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">createDocument</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">_self</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">updateItem</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">itemId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">itemId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">doc</span><span class="p">.</span><span class="nx">completed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">replaceDocument</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_self</span><span class="p">,</span> <span class="nx">doc</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replaced</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">replaced</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">getItem</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">itemId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">querySpec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">query</span><span class="o">:</span> <span class="s1">'SELECT * FROM root r WHERE r.id = @id'</span><span class="p">,</span>
            <span class="nx">parameters</span><span class="o">:</span> <span class="p">[{</span>
                <span class="nx">name</span><span class="o">:</span> <span class="s1">'@id'</span><span class="p">,</span>
                <span class="nx">value</span><span class="o">:</span> <span class="nx">itemId</span>
            <span class="p">}]</span>
        <span class="p">};</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">queryDocuments</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">_self</span><span class="p">,</span> <span class="nx">querySpec</span><span class="p">).</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">TaskDao</span><span class="p">;</span>
</pre></div></div>

<p>私の感想は、、、これが、コールバックヘルと言うやつか、、、こんなしょーもないことするのに、こんなコードが要るとは、、、辛すぎる。だった。そうだ、TypeScript だったらどうだろう。楽じゃないかな？</p>

<p>ライブラリを調べてみるとあった！</p>

<ul>
<li><a href="https://github.com/jcormont/documentdb-typescript" rel="nofollow noopener" target="_blank">jcormont/documentdb-typescript</a></li>
</ul>

<p>こ、これだ、これしかない！　これを使って、Functions を書いてみよう。</p>

<h1>
<span id="azure-functions-を-typescript-対応にしてみる" class="fragment"></span><a href="#azure-functions-%E3%82%92-typescript-%E5%AF%BE%E5%BF%9C%E3%81%AB%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>Azure Functions を TypeScript 対応にしてみる</h1>

<p>とりあえず、HttpTrigger を TypeScript に変えてみる。ちなみに、Azure Functions の TypeScript は、現在 Preview になって要るが、Azure Functions CLI の、2.0はまだ対応していない。自力だ。</p>

<h2>
<span id="function-app-を作成" class="fragment"></span><a href="#function-app-%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>Function App を作成</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ func init
Writing .gitignore
Writing host.json
Writing local.settings.json
Created launch.json

Initialized empty Git repository in /Users/ushio/Codes/AzureFunctions/some/.git/
</pre></div></div>

<h2>
<span id="functions-を作成" class="fragment"></span><a href="#functions-%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>Functions を作成</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ func new
Select a language: 
1. C#
2. JavaScript
Choose option: 2
JavaScript
Select a template: 
1. BlobTrigger
2. HttpTrigger
3. QueueTrigger
4. TimerTrigger
Choose option: 2
HttpTrigger
Function name: [HttpTriggerJS] 
Writing /Users/ushio/Codes/AzureFunctions/some/HttpTriggerJS/index.js
Writing /Users/ushio/Codes/AzureFunctions/some/HttpTriggerJS/sample.dat
Writing /Users/ushio/Codes/AzureFunctions/some/HttpTriggerJS/function.json
</pre></div></div>

<p>テンプレートが生成された</p>

<h2>
<span id="typescript-環境を作る" class="fragment"></span><a href="#typescript-%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>TypeScript 環境を作る</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>cd HttpTriggerJS
npm init
tsc --init
cp index.js index.ts
</pre></div></div>

<p><code>index.ts</code> を次のように変える</p>

<p><em>index.ts</em></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>export async function run (context: any, req: any) {
</pre></div></div>

<p><code>typeconfig.json</code> を次のように変える。これをしないと、async メソッドは、promise を返さないとエラーになる。ところが、最初の１つ目のfunction では返しても仕方がないケースがあるので、新しいバージョンの TypeScript ではエラーにならなくなっている。</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">"compilerOptions"</span><span class="p">:</span> <span class="p">{</span>
    <span class="err">/*</span> <span class="err">Basic</span> <span class="err">Options</span> <span class="err">*/</span>                       
    <span class="nt">"target"</span><span class="p">:</span> <span class="s2">"ES2015"</span><span class="p">,</span>                          <span class="err">/*</span> <span class="err">Specify</span> <span class="err">ECMAScript</span> <span class="err">target</span> <span class="err">version:</span> <span class="err">'ES3'</span> <span class="err">(default),</span> <span class="err">'ES5',</span> <span class="err">'ES2015',</span> <span class="err">'ES2016',</span> <span class="err">'ES2017',</span> <span class="err">or</span> <span class="err">'ESNEXT'.</span> <span class="err">*/</span>
    <span class="nt">"module"</span><span class="p">:</span> <span class="s2">"commonjs"</span><span class="p">,</span>                     <span class="err">/*</span> <span class="err">Specify</span> <span class="err">module</span> <span class="err">code</span> <span class="err">generation:</span> <span class="err">'commonjs',</span> <span class="err">'amd',</span> <span class="err">'system',</span> <span class="err">'umd'</span> <span class="err">or</span> <span class="err">'es2015'.</span> <span class="err">*/</span>
    <span class="nt">"lib"</span><span class="p">:</span> <span class="p">[</span> <span class="s2">"es2015"</span><span class="p">],</span>   
</pre></div></div>

<h2>
<span id="cant-find-process-error" class="fragment"></span><a href="#cant-find-process-error"><i class="fa fa-link"></i></a>can't find <code>process</code> error</h2>

<p>もしかすると、こんなエラーに出会うかもしれない。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>index.ts(7,34): error TS2304: Cannot find name 'process'.
index.ts(7,65): error TS2304: Cannot find name 'process'.
</pre></div></div>

<p>このケースは、これで解消する。そもそも <code>process</code> 見つからんとかおかしいよね。これはバグ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>npm install --save-dev @types/node
</pre></div></div>

<p>下記の議論をみてみると詳細が書いてありJます。</p>

<ul>
<li><a href="https://stackoverflow.com/questions/35551185/typescript-read-arguments-from-command-line-error-ts2304-cannot-find-name-p" rel="nofollow noopener" target="_blank">TypeScript: read arguments from command line - error TS2304: Cannot find name 'process'</a></li>
</ul>

<p>下記のエラーは先ほどの<code>typeconfig.json</code> の設定で解消されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>error TS2705: An async function or method in ES5/ES3 requires the 'Promise' constructor.  Make sure you have a declaration for the 'Promise' constructor or include 'ES2015' in your `--lib` option.
</pre></div></div>

<h1>
<span id="ついに-azure-functions" class="fragment"></span><a href="#%E3%81%A4%E3%81%84%E3%81%AB-azure-functions"><i class="fa fa-link"></i></a>ついに Azure Functions</h1>

<p>ここまで設定すると、無事、CosmosDB にアクセスするファンクションが動きました。簡単！</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">DB</span> <span class="nx">from</span> <span class="s2">"documentdb-typescript"</span><span class="p">;</span>


<span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">run</span> <span class="p">(</span><span class="nx">context</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">req</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'JavaScript HTTP trigger function processed a request.'</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DB</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="s2">"COSMOS_DB_HOST"</span><span class="p">],</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="s2">"COSMOS_DB_KEY"</span><span class="p">]);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">enableConsoleLog</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">openAsync</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">getAccountInfoAsync</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">dbs</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">listDatabasesAsync</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1">// status: 200, /* Defaults to 200 */</span>
            <span class="nx">body</span><span class="o">:</span> <span class="s2">"Hello! "</span> <span class="o">+</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span> <span class="nx">dbs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">db</span> <span class="o">=&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">status</span>: <span class="kt">400</span><span class="p">,</span>
            <span class="nx">body</span><span class="o">:</span> <span class="s2">"Please pass a name on the query string or in the request body"</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">done</span><span class="p">();</span>
<span class="p">};</span>
</pre></div></div>

<p>ちなみに、上記のは、<code>documentdb-typescript</code> のサンプルそのままだが、最初は、サンプルのままだと、エラーだった。Issue を書いて、解決したので、プルリクエストを書いておいた。</p>

<p><a href="https://github.com/jcormont/documentdb-typescript/issues/14" rel="nofollow noopener" target="_blank">TypeError: Cannot read property 'getDatabaseAccount' of undefined</a></p>

<p>次のコミットが参考になります。 <a href="https://github.com/TsuyoshiUshio/TypeScriptCosmosSpike/commit/7eaf996c4ce05c93df3ea9586e3836fed672bf5a" rel="nofollow noopener" target="_blank">commit</a>.</p>

<h1>
<span id="todo" class="fragment"></span><a href="#todo"><i class="fa fa-link"></i></a>ToDo</h1>

<p>残念ながら、TypeScript のローカルデバッグはできません。（生成されたjsはできると思うけど）。どうやったらできるか考えてみます。</p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<p>実は、このサンプルを GitHub においています。</p>

<ul>
<li><a href="https://github.com/TsuyoshiUshio/TypeScriptCosmosSpike" rel="nofollow noopener" target="_blank">TsuyoshiUshio/TypeScriptCosmosSpike</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />10位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/2a81a55bceed5fa11c4f">Docker のインストールの意味を完全に理解してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-22 00:10:48</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[docker]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>昨日は、Docker Swarm 関連でひどい目にあった。もう何回目だろうこの手のインストールで時間を使うのは。もういい加減嫌になった。</p>

<p>どうやったらもっと確実にいけるだろう？なぜ、毎回時間がかかるんだろう。今回、Docker Swarm のインストールがうまくいかない原因をしらべたかった。事実としては</p>

<ul>
<li>Docker for Azure なら動く</li>
<li>acs-engine をバージョンアップしたら動かない（同じバージョンで）</li>
<li>ログは出ているが、それがダメなのかわからない（syslog  で出ている）</li>
<li>マスターはちゃんと動作していない。ブートのログを見ても、エラーは見つからない。</li>
</ul>

<p>結局のところ何かと考えると、Docker for Azure のスクリプトと、acs-engine のスクリプトを比較したら問題がわかりそうなのだが、なぜそうしないか？というと、わかりそうにないから。<br>
多分理由は「理解」していないからだ。なんとなく、インストール手順にしたがっていても、理解していないから、自分の中で確信をモテないからだろう。よっしゃ。一発、docker のインストール手順から一コマンド残らず全部意味を理解してみよう。そしたら、次回からはもっと早いだろう。<br>
自分のメモなので、全部英語だけど、たまに日本語での意味を書いてみる。</p>

<h1>
<span id="install-docker" class="fragment"></span><a href="#install-docker"><i class="fa fa-link"></i></a>Install Docker</h1>

<p><a href="https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/#os-requirements" rel="nofollow noopener" target="_blank">Get Docker CE for Ubuntu</a></p>

<p>I installed VMScale Set. I can configure Several VM's with VNet. However, it will take some time. I focus on installing/configurting Swarm.</p>

<p>今回は、Vnetを作るのめんどくさいので、Portalから、VMSS をデプロイして、試した。今回はスクリプトの理解が目的</p>

<h1>
<span id="1-understand-architecture" class="fragment"></span><a href="#1-understand-architecture"><i class="fa fa-link"></i></a>1. Understand Architecture</h1>

<p>You can read [32-bit vs 64-bit vs ARM in regards to programs and OSes]<br>
In this case, x86-64 a.k.a. x64, amd64 (Not IA64)<br>
(<a href="https://unix.stackexchange.com/questions/125295/32-bit-vs-64-bit-vs-arm-in-regards-to-programs-and-oses" class="autolink" rel="nofollow noopener" target="_blank">https://unix.stackexchange.com/questions/125295/32-bit-vs-64-bit-vs-arm-in-regards-to-programs-and-oses</a>)</p>

<p>いつもなんとなくわかった気になっている「アーキテクチャ」ってなんだろうって調べて見た。アーキテクチャの種類ごとにバイナリが違うのは当然だけど、いろんな用語が出てくる。でも、<code>x86-64</code> <code>x64</code> <code>amd64</code> はみんな同じ意味か、、、なんと無くそう思っていたけど、調べると確信がもてる。</p>

<p>I checked the Inbound NAT rules. </p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ssh azureuser@13.93.236.169 -p 50001 -A
</pre></div></div>

<h1>
<span id="apt-関連" class="fragment"></span><a href="#apt-%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>apt 関連</h1>

<p>apt もなんとなく意味わかるけど、言われるがままにインストールしているパッケージはどんなものだろう？下に英語だけどメモしておいた。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get install apt-transport-https ca-certificates curl software-properties-common
</pre></div></div>

<ul>
<li>Enable APT to use https: <a href="https://packages.debian.org/sid/apt-transport-https" rel="nofollow noopener" target="_blank">Package: apt-transport-https (1.5~rc4)</a>
</li>
<li>Certificate to allow SSL-based application: <a href="https://packages.debian.org/sid/ca-certificates" rel="nofollow noopener" target="_blank">Package: ca-certificates</a>
</li>
<li>Provides an abstraction of the used apt repositories: <a href="https://packages.debian.org/sid/admin/software-properties-common" rel="nofollow noopener" target="_blank">Package: software-properties-common</a>
</li>
</ul>

<h1>
<span id="gpg-keyって" class="fragment"></span><a href="#gpg-key%E3%81%A3%E3%81%A6"><i class="fa fa-link"></i></a>GPG Keyって？</h1>

<p>なんとなくやっているオペレーションやけど、これは、GPG(GNU Privacy Gard) というツール（暗号化、復号化のツール）のキーをダウンロードしている。docker のパッケージを復号化するためだ。それを、<code>apt-key</code> コマンドでキーに追加している。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
</pre></div></div>

<p><code>apt-key</code> enable us to manage API key for apt package authentication. GPG key<br>
is used for the key management. You can make sure if a key is installed. </p>

<p>だから、<code>apt-key list</code> をすると、キーが追加されたのが確認される。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ apt-key list
/etc/apt/trusted.gpg
--------------------
pub   1024D/437D05B5 2004-09-12
uid                  Ubuntu Archive Automatic Signing Key &lt;ftpmaster@ubuntu.com&gt;
sub   2048g/79164387 2004-09-12

pub   4096R/C0B21F32 2012-05-11
uid                  Ubuntu Archive Automatic Signing Key (2012) &lt;ftpmaster@ubuntu.com&gt;

pub   4096R/EFE21092 2012-05-11
uid                  Ubuntu CD Image Automatic Signing Key (2012) &lt;cdimage@ubuntu.com&gt;

pub   1024D/FBB75451 2004-12-30
uid                  Ubuntu CD Image Automatic Signing Key &lt;cdimage@ubuntu.com&gt;

pub   4096R/0EBFCD88 2017-02-22
uid                  Docker Release (CE deb) &lt;docker@docker.com&gt;
sub   4096R/F273FCD8 2017-02-22

</pre></div></div>

<p>Also you can try for docker by fingerprint</p>

<h1>
<span id="finger-print-ってなんだ" class="fragment"></span><a href="#finger-print-%E3%81%A3%E3%81%A6%E3%81%AA%E3%82%93%E3%81%A0"><i class="fa fa-link"></i></a>finger print ってなんだ？</h1>

<p>指紋という意味だけど、いつもやっているフィンガープリントはなんのためだろう。これは、public key が、目的のものであるか確認するために、本来はpublic key は長いけど、短く、それが該当するキーか調べている。下記のコマンドは、ちゃんと、該当のキー(ここでは docker) が入ったか確認している。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo apt-key fingerprint 0EBFCD88
pub   4096R/0EBFCD88 2017-02-22
      Key fingerprint = 9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88
uid                  Docker Release (CE deb) &lt;docker@docker.com&gt;
sub   4096R/F273FCD8 2017-02-22
</pre></div></div>

<ul>
<li><p>GNU Privacy Guard (GPG, also GnuPG) is free encryption software : <a href="https://kb.iu.edu/d/awio" rel="nofollow noopener" target="_blank">What is GPG, and how do I use it to encrypt files on IU's research computing systems?</a></p></li>
<li><p><a href="http://jnug.net/po4a/apt-key.ja.8.html" rel="nofollow noopener" target="_blank">APT-KEY</a></p></li>
<li><p><a href="https://en.wikipedia.org/wiki/Public_key_fingerprint" rel="nofollow noopener" target="_blank">Public key fingerprint</a></p></li>
</ul>

<p>In public-key cryptography, a public key fingerprint is a short sequence of bytes used to identify a longer public key. Fingerprints are created by applying a cryptographic hash function to a public key. Since fingerprints are shorter than the keys they refer to, they can be used to simplify certain key management tasks. In Microsoft software, "thumbprint" is used instead of "fingerprint".</p>

<h1>
<span id="add-apt-repository-は何をしているか" class="fragment"></span><a href="#add-apt-repository-%E3%81%AF%E4%BD%95%E3%82%92%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>add-apt repository は何をしているか？</h1>

<p>これは、<code>apt-get</code> で取得する先のリポジトリを登録している。ふわっとわかるけど、何しているのだろう。ちなみに<code>deb</code> はバイナリのリポジトリを示している。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"
</pre></div></div>

<ul>
<li><p><a href="https://askubuntu.com/questions/885903/what-does-sudo-add-apt-repository-do" rel="nofollow noopener" target="_blank">What does “sudo add-apt-repository” do?</a></p></li>
<li><p><a href="https://wiki.debian.org/SourcesList" rel="nofollow noopener" target="_blank">SourcesList</a></p></li>
</ul>

<p><code>lsb-release -cs</code> コマンドは、どのバージョンの、Ubuntu かを見ている。<code>16.04</code> は、<code>xential</code>。そして、<code>stable</code> のバージョンを指定している。他にも、<code>edge</code> とかあるらしい。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ lsb_release -cs
xenial
</pre></div></div>

<p>xenial == Ubuntu 16.04</p>

<p>You can make sure if the new repo is installed. <code>deb</code> means binary repo. <code>deb src</code> is also there. </p>

<h1>
<span id="etcaptsourceslist-で確認する" class="fragment"></span><a href="#etcaptsourceslist-%E3%81%A7%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>/etc/apt/sources.list で確認する</h1>

<p>ちゃんと、リポジトリが登録されたか確認している。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ cat /etc/apt/sources.list
  :
  deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
  :
</pre></div></div>

<h1>
<span id="docker-ce-インストール" class="fragment"></span><a href="#docker-ce-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>docker-ce インストール</h1>

<p>最終的についにインストールを実行。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get install docker-ce
</pre></div></div>

<p>I can see the docker-ce 17.06 installed.</p>

<h1>
<span id="apt-get-でインストールされたパッケージはどこに行くの" class="fragment"></span><a href="#apt-get-%E3%81%A7%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%9F%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AF%E3%81%A9%E3%81%93%E3%81%AB%E8%A1%8C%E3%81%8F%E3%81%AE"><i class="fa fa-link"></i></a>apt-get でインストールされたパッケージはどこに行くの？</h1>

<p><code>dpkg</code> コマンドで調べると一覧が見れる。</p>

<p>BTW, where the app is installed? </p>

<ul>
<li><p><a href="http://d.hatena.ne.jp/hiro_nemu/20090327/1238168139" rel="nofollow noopener" target="_blank">apt-getでインストールしたパッケージはどこに入ったのか。</a></p></li>
<li><p><a href="https://matome.naver.jp/odai/2139540287718538401" rel="nofollow noopener" target="_blank">apt-getの仕組み</a></p></li>
<li><p><a href="https://askubuntu.com/questions/173465/what-is-dpkg-for" rel="nofollow noopener" target="_blank">What is dpkg for?</a><br>
As has been said, dpkg is a low-level system tool to extract, analyse, unpack and install or remove .deb files. </p></li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ dpkg -L docker-ce
/.
/etc
/etc/init.d
/etc/init.d/docker
/etc/default
/etc/default/docker
/etc/init
/etc/init/docker.conf
/lib
/lib/udev
/lib/udev/rules.d
/lib/udev/rules.d/80-docker-ce.rules
/lib/systemd
/lib/systemd/system
/lib/systemd/system/docker.socket
/lib/systemd/system/docker.service
/usr
/usr/share
/usr/share/zsh
/usr/share/zsh/vendor-completions
/usr/share/zsh/vendor-completions/_docker
/usr/share/docker-ce
/usr/share/docker-ce/contrib
/usr/share/docker-ce/contrib/mkimage
/usr/share/docker-ce/contrib/mkimage/debootstrap
/usr/share/docker-ce/contrib/mkimage/rinse
/usr/share/docker-ce/contrib/mkimage/solaris
/usr/share/docker-ce/contrib/mkimage/mageia-urpmi
/usr/share/docker-ce/contrib/mkimage/.febootstrap-minimize
/usr/share/docker-ce/contrib/mkimage/busybox-static
/usr/share/docker-ce/contrib/mkimage-arch-pacman.conf
/usr/share/docker-ce/contrib/mkimage-debootstrap.sh
/usr/share/docker-ce/contrib/mkimage.sh
/usr/share/docker-ce/contrib/nuke-graph-directory.sh
/usr/share/docker-ce/contrib/mkimage-yum.sh
/usr/share/docker-ce/contrib/mkimage-alpine.sh
/usr/share/docker-ce/contrib/mkimage-pld.sh
/usr/share/docker-ce/contrib/desktop-integration
/usr/share/docker-ce/contrib/desktop-integration/README.md
/usr/share/docker-ce/contrib/desktop-integration/gparted
/usr/share/docker-ce/contrib/desktop-integration/gparted/Dockerfile
/usr/share/docker-ce/contrib/desktop-integration/chromium
/usr/share/docker-ce/contrib/desktop-integration/chromium/Dockerfile
/usr/share/docker-ce/contrib/mkimage-crux.sh
/usr/share/docker-ce/contrib/mkimage-busybox.sh
/usr/share/docker-ce/contrib/check-config.sh
/usr/share/docker-ce/contrib/mkimage-rinse.sh
/usr/share/docker-ce/contrib/mkimage-arch.sh
/usr/share/docker-ce/contrib/mkimage-archarm-pacman.conf
/usr/share/man
/usr/share/man/man8
/usr/share/man/man8/dockerd.8.gz
/usr/share/man/man1
/usr/share/man/man1/docker-container-top.1.gz
/usr/share/man/man1/docker-load.1.gz
/usr/share/man/man1/docker-container-commit.1.gz
/usr/share/man/man1/docker-restart.1.gz
/usr/share/man/man1/docker-container-create.1.gz
/usr/share/man/man1/docker-save.1.gz
/usr/share/man/man1/docker-events.1.gz
/usr/share/man/man1/docker-start.1.gz
/usr/share/man/man1/docker-config-create.1.gz
/usr/share/man/man1/docker-inspect.1.gz
/usr/share/man/man1/docker-stack-ps.1.gz
/usr/share/man/man1/docker-container-update.1.gz
/usr/share/man/man1/docker-service-create.1.gz
/usr/share/man/man1/docker-kill.1.gz
/usr/share/man/man1/docker-secret-inspect.1.gz
/usr/share/man/man1/docker-swarm-join.1.gz
/usr/share/man/man1/docker-stats.1.gz
/usr/share/man/man1/docker-build.1.gz
/usr/share/man/man1/docker-logout.1.gz
/usr/share/man/man1/docker-checkpoint-rm.1.gz
/usr/share/man/man1/docker-run.1.gz
/usr/share/man/man1/docker-network-connect.1.gz
/usr/share/man/man1/docker-network-prune.1.gz
/usr/share/man/man1/docker-image-build.1.gz
/usr/share/man/man1/docker-image-pull.1.gz
/usr/share/man/man1/docker-checkpoint-create.1.gz
/usr/share/man/man1/docker-volume-prune.1.gz
/usr/share/man/man1/docker-system.1.gz
/usr/share/man/man1/docker-container-exec.1.gz
/usr/share/man/man1/docker-network-ls.1.gz
/usr/share/man/man1/docker-swarm.1.gz
/usr/share/man/man1/docker-stack-services.1.gz
/usr/share/man/man1/docker-config-inspect.1.gz
/usr/share/man/man1/docker-stack-ls.1.gz
/usr/share/man/man1/docker-image-save.1.gz
/usr/share/man/man1/docker-checkpoint-ls.1.gz
/usr/share/man/man1/docker-update.1.gz
/usr/share/man/man1/docker-history.1.gz
/usr/share/man/man1/docker-rename.1.gz
/usr/share/man/man1/docker-config-rm.1.gz
/usr/share/man/man1/docker-container-wait.1.gz
/usr/share/man/man1/docker-attach.1.gz
/usr/share/man/man1/docker-system-df.1.gz
/usr/share/man/man1/docker-plugin-push.1.gz
/usr/share/man/man1/docker-diff.1.gz
/usr/share/man/man1/docker-network-create.1.gz
/usr/share/man/man1/docker-container-attach.1.gz
/usr/share/man/man1/docker-node-demote.1.gz
/usr/share/man/man1/docker-image-history.1.gz
/usr/share/man/man1/docker-service.1.gz
/usr/share/man/man1/docker-port.1.gz
/usr/share/man/man1/docker-image-load.1.gz
/usr/share/man/man1/docker-node.1.gz
/usr/share/man/man1/docker-system-events.1.gz
/usr/share/man/man1/docker-plugin-upgrade.1.gz
/usr/share/man/man1/docker-container-rename.1.gz
/usr/share/man/man1/docker-import.1.gz
/usr/share/man/man1/docker-service-scale.1.gz
/usr/share/man/man1/docker-container-port.1.gz
/usr/share/man/man1/docker-network-disconnect.1.gz
/usr/share/man/man1/docker-service-ps.1.gz
/usr/share/man/man1/docker-plugin.1.gz
/usr/share/man/man1/docker-node-ls.1.gz
/usr/share/man/man1/docker-image.1.gz
/usr/share/man/man1/docker-container-restart.1.gz
/usr/share/man/man1/docker-secret-ls.1.gz
/usr/share/man/man1/docker-container-logs.1.gz
/usr/share/man/man1/docker-pause.1.gz
/usr/share/man/man1/docker-plugin-create.1.gz
/usr/share/man/man1/docker-plugin-install.1.gz
/usr/share/man/man1/docker-container-run.1.gz
/usr/share/man/man1/docker-version.1.gz
/usr/share/man/man1/docker-swarm-leave.1.gz
/usr/share/man/man1/docker-plugin-enable.1.gz
/usr/share/man/man1/docker-unpause.1.gz
/usr/share/man/man1/docker-swarm-unlock-key.1.gz
/usr/share/man/man1/docker-volume-rm.1.gz
/usr/share/man/man1/docker-network.1.gz
/usr/share/man/man1/docker-logs.1.gz
/usr/share/man/man1/docker-swarm-update.1.gz
/usr/share/man/man1/docker-image-inspect.1.gz
/usr/share/man/man1/docker-stop.1.gz
/usr/share/man/man1/docker-wait.1.gz
/usr/share/man/man1/docker-node-promote.1.gz
/usr/share/man/man1/docker-node-rm.1.gz
/usr/share/man/man1/docker-container-stats.1.gz
/usr/share/man/man1/docker-container-diff.1.gz
/usr/share/man/man1/docker-service-inspect.1.gz
/usr/share/man/man1/docker-volume-inspect.1.gz
/usr/share/man/man1/docker-export.1.gz
/usr/share/man/man1/docker-swarm-unlock.1.gz
/usr/share/man/man1/docker-container-cp.1.gz
/usr/share/man/man1/docker-service-update.1.gz
/usr/share/man/man1/docker-container-rm.1.gz
/usr/share/man/man1/docker-network-inspect.1.gz
/usr/share/man/man1/docker-search.1.gz
/usr/share/man/man1/docker-image-push.1.gz
/usr/share/man/man1/docker-volume-ls.1.gz
/usr/share/man/man1/docker-config-ls.1.gz
/usr/share/man/man1/docker-network-rm.1.gz
/usr/share/man/man1/docker-container-start.1.gz
/usr/share/man/man1/docker-service-rm.1.gz
/usr/share/man/man1/docker-container-stop.1.gz
/usr/share/man/man1/docker-image-tag.1.gz
/usr/share/man/man1/docker-tag.1.gz
/usr/share/man/man1/docker-image-ls.1.gz
/usr/share/man/man1/docker-container.1.gz
/usr/share/man/man1/docker-deploy.1.gz
/usr/share/man/man1/docker-login.1.gz
/usr/share/man/man1/docker-commit.1.gz
/usr/share/man/man1/docker-service-logs.1.gz
/usr/share/man/man1/docker-secret.1.gz
/usr/share/man/man1/docker-secret-rm.1.gz
/usr/share/man/man1/docker-container-prune.1.gz
/usr/share/man/man1/docker-swarm-init.1.gz
/usr/share/man/man1/docker-plugin-ls.1.gz
/usr/share/man/man1/docker-image-import.1.gz
/usr/share/man/man1/docker-service-ls.1.gz
/usr/share/man/man1/docker-swarm-join-token.1.gz
/usr/share/man/man1/docker-node-update.1.gz
/usr/share/man/man1/docker-push.1.gz
/usr/share/man/man1/docker-images.1.gz
/usr/share/man/man1/docker-swarm-ca.1.gz
/usr/share/man/man1/docker-container-inspect.1.gz
/usr/share/man/man1/docker-plugin-inspect.1.gz
/usr/share/man/man1/docker-stack-rm.1.gz
/usr/share/man/man1/docker-create.1.gz
/usr/share/man/man1/docker-volume-create.1.gz
/usr/share/man/man1/docker-image-rm.1.gz
/usr/share/man/man1/docker-config.1.gz
/usr/share/man/man1/docker-pull.1.gz
/usr/share/man/man1/docker-system-prune.1.gz
/usr/share/man/man1/docker-volume.1.gz
/usr/share/man/man1/docker-ps.1.gz
/usr/share/man/man1/docker.1.gz
/usr/share/man/man1/docker-cp.1.gz
/usr/share/man/man1/docker-secret-create.1.gz
/usr/share/man/man1/docker-container-unpause.1.gz
/usr/share/man/man1/docker-info.1.gz
/usr/share/man/man1/docker-checkpoint.1.gz
/usr/share/man/man1/docker-container-export.1.gz
/usr/share/man/man1/docker-plugin-set.1.gz
/usr/share/man/man1/docker-rmi.1.gz
/usr/share/man/man1/docker-node-ps.1.gz
/usr/share/man/man1/docker-node-inspect.1.gz
/usr/share/man/man1/docker-plugin-disable.1.gz
/usr/share/man/man1/docker-top.1.gz
/usr/share/man/man1/docker-system-info.1.gz
/usr/share/man/man1/docker-container-ls.1.gz
/usr/share/man/man1/docker-rm.1.gz
/usr/share/man/man1/docker-plugin-rm.1.gz
/usr/share/man/man1/docker-exec.1.gz
/usr/share/man/man1/docker-container-pause.1.gz
/usr/share/man/man1/docker-container-kill.1.gz
/usr/share/man/man1/docker-stack-deploy.1.gz
/usr/share/man/man1/docker-stack.1.gz
/usr/share/man/man1/docker-image-prune.1.gz
/usr/share/man/man5
/usr/share/man/man5/docker-config-json.5.gz
/usr/share/man/man5/Dockerfile.5.gz
/usr/share/fish
/usr/share/fish/vendor_completions.d
/usr/share/fish/vendor_completions.d/docker.fish
/usr/share/bash-completion
/usr/share/bash-completion/completions
/usr/share/bash-completion/completions/docker
/usr/share/doc
/usr/share/doc/docker-ce
/usr/share/doc/docker-ce/README.md.gz
/usr/share/doc/docker-ce/changelog.Debian.gz
/usr/share/nano
/usr/share/nano/Dockerfile.nanorc
/usr/bin
/usr/bin/docker-containerd-shim
/usr/bin/docker-containerd
/usr/bin/docker-runc
/usr/bin/docker
/usr/bin/docker-init
/usr/bin/docker-containerd-ctr
/usr/bin/docker-proxy
/usr/bin/dockerd
/usr/lib
/usr/lib/docker
</pre></div></div>

<p>You can refer available version </p>

<p>ちなみに、本番環境では、適当なバージョンを入れずに、ちゃんとした狙い通りのを入れたい。<code>apt-cache madison</code> コマンドで使えるバージョンを確認。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ apt-cache madison docker-ce
 docker-ce | 17.06.2~ce-0~ubuntu | https://download.docker.com/linux/ubuntu xenial/stable amd64 Packages
 docker-ce | 17.06.1~ce-0~ubuntu | https://download.docker.com/linux/ubuntu xenial/stable amd64 Packages
 docker-ce | 17.06.0~ce-0~ubuntu | https://download.docker.com/linux/ubuntu xenial/stable amd64 Packages
 docker-ce | 17.03.2~ce-0~ubuntu-xenial | https://download.docker.com/linux/ubuntu xenial/stable amd64 Packages
 docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://download.docker.com/linux/ubuntu xenial/stable amd64 Packages
 docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://download.docker.com/linux/ubuntu xenial/stable amd64 Packages
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span> $ sudo docker version
Client:
 Version:      17.06.2-ce
 API version:  1.30
 Go version:   go1.8.3
 Git commit:   cec0b72
 Built:        Tue Sep  5 20:00:17 2017
 OS/Arch:      linux/amd64

Server:
 Version:      17.06.2-ce
 API version:  1.30 (minimum version 1.12)
 Go version:   go1.8.3
 Git commit:   cec0b72
 Built:        Tue Sep  5 19:59:11 2017
 OS/Arch:      linux/amd64
 Experimental: false
</pre></div></div>

<ul>
<li><a href="https://unix.stackexchange.com/questions/276037/why-apt-madison/276040" rel="nofollow noopener" target="_blank">Why apt madison?</a></li>
<li><a href="https://askubuntu.com/questions/447/how-can-i-see-all-versions-of-a-package-that-are-available-in-the-archive" rel="nofollow noopener" target="_blank">How can I see all versions of a package that are available in the archive?</a></li>
</ul>

<h1>
<span id="apt-get-バージョン指定" class="fragment"></span><a href="#apt-get-%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>apt-get バージョン指定</h1>

<p>明確にバージョンは本来指定した方が良い。明日には変わるかもしれないから。</p>

<p>You can specify the exact version </p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo apt-get install docker-ce=&lt;VERSION&gt;
</pre></div></div>

<p>Verify the installation</p>

<p>動作確認。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo docker run hello-world
</pre></div></div>

<h1>
<span id="sudo-をやめる" class="fragment"></span><a href="#sudo-%E3%82%92%E3%82%84%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>sudo をやめる</h1>

<p>現在のユーザを、docker groupにa参加させれば良い。docker は<code>/var/run/docker.sock</code>でソケット通信しているので、その権限設定がグループには読み書きを許可している。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo groupadd docker
sudo gpasswd -a $USER docker
-- logout / login again
docker run hello-world
</pre></div></div>

<ul>
<li><a href="https://askubuntu.com/questions/477551/how-can-i-use-docker-without-sudo" rel="nofollow noopener" target="_blank">How can I use docker without sudo?</a></li>
</ul>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>完全理解をやって見たけど、かなり頭がスッキリする。時間がかかっても、最初の１回目はこれをやるべきだなぁ。次はSwarm に突入。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />11位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/4d37158c2f574b9c2de4">JavaScript のプロトタイプを理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-18 02:06:52</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>prototype</code> はふわっと知っているけど、実はよくわかっていないので、調べて見た。</p>

<p>JavaScript は、クラスベースのオブジェクト指向と違って、あくまでプロトタイプベース。<code>class</code> キーワードがあるが、単なるシンタックスシュガーである。</p>

<h1>
<span id="prototype" class="fragment"></span><a href="#prototype"><i class="fa fa-link"></i></a>prototype</h1>

<p>継承に関して言えば、JavaScript はオブジェクトしかない。各オブジェクトはプライベートプロパティ([[Prototype]]と呼ばれる) を持っていて、これは、他のオブジェクト（これは、prototypeと呼ばれる) を持っている。プロトタイプオブジェクトは、自身にプロトタイプオブジェクトを持っている。そのチェーンが null （つまりプロトタイプオブジェクトがnull) に到達すると、そのチェーンが終了する。これをプロトタイプチェーンと呼ぶ。イメージとしてはこんな感じか？</p>

<p><a href="https://camo.qiitausercontent.com/8e377a7e39bd9a498e796f2a68b1fd385b4375ea/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32306538366236662d646363642d616439662d363939302d3463313837356463623836382e706e67" target="_blank" rel="nofollow noopener"><img width="988" alt="Screen Shot 2017-09-17 at 9.30.38 AM.png" src="https://camo.qiitausercontent.com/8e377a7e39bd9a498e796f2a68b1fd385b4375ea/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32306538366236662d646363642d616439662d363939302d3463313837356463623836382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/20e86b6f-dccd-ad9f-6990-4c1875dcb868.png"></a></p>

<h1>
<span id="object" class="fragment"></span><a href="#object"><i class="fa fa-link"></i></a>Object</h1>

<p>JavaScript の全てのオブジェクトは、<code>Object</code> のインスタンスになっている。<code>Object</code> がプロトタイプチェーンのトップになる。JavaScript の オブジェクトは、ダイナミックなバッグみたいなもので、(own properties と呼ばれる) JavaScript のオブジェクトは、プロトタイプオブジェクトへのリンクをもつ。ある、オブジェクトのプロパティにアクセスすると、そのオブジェクトが持っているプロパティだけでなく、そのオブジェクトのプロパティになければ、プロトタイプのプロパティも参照される。そこになければ、その先のプロトタイプのプロパティ、、、といったようにそのチェーンを辿って参照する。それがnull になるまで。<br>
　</p>

<h1>
<span id="prototype-の参照" class="fragment"></span><a href="#prototype-%E3%81%AE%E5%8F%82%E7%85%A7"><i class="fa fa-link"></i></a>prototype の参照</h1>

<p>prototype は、<code>obj.[[Prototype]]</code> に格納されているが、それはプライベートになっている。<code>Object.getPrototypeOf()</code> や、<code>Object.setPrototypeOf()</code> 経由でアクセスされる。これは、<code>__proto__</code> と同等である。</p>

<p>他にも、<code>func.prototype</code> というものもある。これは、この関数のコンストラクタを使った時に、全てのインスタンスオブジェクトに対して、<code>[[Prototype]]</code> をアサインするものになる。</p>

<h1>
<span id="prototype-のサンプルコード" class="fragment"></span><a href="#prototype-%E3%81%AE%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>prototype のサンプルコード</h1>

<p>上記の理屈を理解すべく、サンプルコードを書いて見た。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">b</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nx">c</span><span class="o">:</span> <span class="mi">4</span>
<span class="p">});</span>

<span class="nx">obj</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="p">{</span>
     <span class="nx">c</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
     <span class="nx">d</span><span class="o">:</span> <span class="mi">6</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">c</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">d</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">e</span><span class="p">);</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1
2
5
6
undefined
</pre></div></div>

<p>Prototype のチェーンにないもの <code>e</code> のみが undefined になり、それ以外は、チェーンを辿って表示されている。興味深いものは、<code>b</code> の結果で、２番目のプロトタイプオブジェクトで、<code>b=3</code> にしているが、先に、最初のオブジェクトですでに、<code>b</code>が存在するので、その先のチェーンまで調査されない。</p>

<h1>
<span id="メソッドとprototype" class="fragment"></span><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8prototype"><i class="fa fa-link"></i></a>メソッドと、prototype</h1>

<p>次に、メソッドタイプのものを作成してみる。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">Graph</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vertices</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">edges</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="nx">Graph</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">addVertex</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Graph</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'vertices'</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'edges'</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'addVertex'</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'addVertex'</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">g</span><span class="p">));</span>
</pre></div></div>

<p>前回のポストでもある通り、<code>Graph.prototype</code> を用いると、インスタンス作成時に、毎回メソッド分のメモリが必要にならない。これは、<code>addVertex</code> のメソッドが、プロトタイプからのリンクになっているからで、新しいインスタンスを作っても、単にそこにリンクが貼られるだけだからだ。だから、上記のプログラムを作って、どこにプロパティがあるかを調査すると、メソッドのみが、プロトタイプに存在することがわかる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>true
true
false
true
{ addVertex: [Function: addVertex] }
</pre></div></div>

<p>試しに、同じ方式で、プロパティもいけるか試してみる。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">SomeObj</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">age</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">age</span> <span class="o">=</span> <span class="nx">age</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">SomeObj</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s2">"Proto desu"</span><span class="p">,</span>
    <span class="nx">salary</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> 
    <span class="nx">print</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">age</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">some</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SomeObj</span><span class="p">(</span><span class="s2">"Tsuyoshi"</span><span class="p">,</span> <span class="mi">46</span><span class="p">);</span>
<span class="nx">some</span><span class="p">.</span><span class="nx">print</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">some</span><span class="p">.</span><span class="nx">salary</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">some</span><span class="p">));</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Tsuyoshi 46
100
{ name: 'Proto desu', salary: 100, print: [Function: print] }
</pre></div></div>

<p>しっかり、想定通りの結果になっている。プロパティも同じ方法が使える。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>これでかなりプロトタイプに関して学べた気がします。挙動がわかってスッキリ！次は、JavaScript の関数に関して書いて見ます。</p>

<h1>
<span id="リソース" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>リソース</h1>

<p>今回の記事はほぼこのページから学びました。</p>

<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Inheritance_and_the_prototype_chain" rel="nofollow noopener" target="_blank">Inheritance and the prototype chain</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />12位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/a2a4a7eef923af4e6267">SPA から Azure Functions  を使う時のActive Directory B2C 認証設定方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-01 01:58:31</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[SPA]</b> <b>[AzureActiveDirectory]</b> <b>[AzureFunctions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>SPA -&gt; Azure Functions にアクセスするときに、Azure Active Directory B2C を使って認証をしたいときにどのように設計するべきか？と言うのを考えて実装してみました。</p>

<p><a href="https://camo.qiitausercontent.com/cf2a7f79ba243716fd77a795d15615f3b31abf02/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61616137343133372d343661662d623065362d376435352d6639353639393434663734622e706e67" target="_blank" rel="nofollow noopener"><img width="1033" alt="Screen Shot 2017-11-01 at 12.50.24 AM.png" src="https://camo.qiitausercontent.com/cf2a7f79ba243716fd77a795d15615f3b31abf02/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61616137343133372d343661662d623065362d376435352d6639353639393434663734622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/aaa74137-46af-b0e6-7d55-f9569944f74b.png"></a></p>

<h1>
<span id="spa-と-azure-functions-間の認証方式" class="fragment"></span><a href="#spa-%E3%81%A8-azure-functions-%E9%96%93%E3%81%AE%E8%AA%8D%E8%A8%BC%E6%96%B9%E5%BC%8F"><i class="fa fa-link"></i></a>SPA と Azure Functions 間の認証方式</h1>

<p>SPA には様々な制約があります。例えば環境変数を受け取れないなどの制約です。SPAに埋め込んだエンドポイントのURLは全てユーザ側にわかってしまいます。と言うことは、どうやって、認証・認可を行えばいいでしょう？一つの方法は、Azure Active Directory B2C を使って認証します。イメージ図は次の通りです。</p>

<p><a href="https://camo.qiitausercontent.com/047e8cf41058f1ecf2d9b9d6a1750961103e30c0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62653261376362322d346238622d386133632d323036302d3236663964306633613936362e6a706567" target="_blank" rel="nofollow noopener"><img width="1000" alt="Slide1.jpeg" src="https://camo.qiitausercontent.com/047e8cf41058f1ecf2d9b9d6a1750961103e30c0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62653261376362322d346238622d386133632d323036302d3236663964306633613936362e6a706567" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/be2a7cb2-4b8b-8a3c-2060-26f9d0f3a966.jpeg"></a></p>

<p>大まかな方式としては、SPA の JavaScriptのADの認証ライブラリを使って認証し、アクセストークンを取得します。そのアクセストークンをつけて、Azure Functions にリクエストを送信し、Azure Functions 側では、そのアクセストークンが妥当かをAzure Active Directory B2C に問い合わせて認証すると言うものです。この方式であれば、エンドポイントがわかっても、認証しなければ、API にアクセスすることはできません。</p>

<ul>
<li>
<a href="https://github.com/AzureAD/microsoft-authentication-library-for-js" rel="nofollow noopener" target="_blank">Microsoft Authentication Library Preview for JavaScript (MSAL.js)</a> </li>
</ul>

<h1>
<span id="spa-を実装する" class="fragment"></span><a href="#spa-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>SPA を実装する。</h1>

<p>SPA のログイン実装をするためのサンプルが存在します。</p>

<ul>
<li><a href="https://github.com/Azure-Samples/active-directory-b2c-javascript-msal-singlepageapp" rel="nofollow noopener" target="_blank">A single page application (SPA) calling a Web API. Authentication is done with Azure AD B2C by leveraging MSAL.js</a></li>
</ul>

<p>これの設定をすれば良い感じです。じゃあ、Azure Active Directory B2C の設定からみていきましょう。</p>

<h1>
<span id="ad-b2c-を設定する" class="fragment"></span><a href="#ad-b2c-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>AD B2C を設定する</h1>

<h2>
<span id="functions-アプリケーション-の設定" class="fragment"></span><a href="#functions-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Functions アプリケーション の設定</h2>

<p><em>Application ID</em></p>

<p>これは、CLIENT_ID とか言われたりするものです。アプリケーションのIDです。</p>

<p><em>Reply URL</em> <br>
一般的にAD で認証された後、リダイレクトされるURLです。このシナリオでは、Azure Functions 側からリダイレクトすることはないのですがAzure Functions のURlを書いておきます。</p>

<p><em>App ID URL</em><br>
なにそれ？と言う感じですが、Azure Functions のURLの最初のサブディレクトリを書いておきます。ここでは、<code>api</code> になっています。これが、Functions Application の識別子になっているようです。</p>

<p><a href="https://camo.qiitausercontent.com/12148db42184613db2fc53af896eda4c666bffdb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39646233346163322d356238342d393763362d336263362d6164663437623139646338632e706e67" target="_blank" rel="nofollow noopener"><img width="862" alt="Screen Shot 2017-11-01 at 1.03.12 AM.png" src="https://camo.qiitausercontent.com/12148db42184613db2fc53af896eda4c666bffdb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39646233346163322d356238342d393763362d336263362d6164663437623139646338632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/9db34ac2-5b84-97c6-3bc6-adf47b19dc8c.png"></a></p>

<p><em>Scope</em> </p>

<p>公開するスコープです。ここでは、新しいスコープとして、<code>func.read</code> と言うスコープを設定してみました。</p>

<p><a href="https://camo.qiitausercontent.com/3d2e72c95dc13471baee7fdffe5bfe791837851a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64353939363836352d643939332d306231352d373965382d3031613234616631393338352e706e67" target="_blank" rel="nofollow noopener"><img width="1108" alt="Screen Shot 2017-11-01 at 1.03.31 AM.png" src="https://camo.qiitausercontent.com/3d2e72c95dc13471baee7fdffe5bfe791837851a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64353939363836352d643939332d306231352d373965382d3031613234616631393338352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/d5996865-d993-0b15-79e8-01a24af19385.png"></a></p>

<h1>
<span id="spa-アプリケーションの設定" class="fragment"></span><a href="#spa-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>SPA アプリケーションの設定</h1>

<p>SPA 側のアプリケーションの登録です。App ID URI は不要です。Reply URL は、認証後、サンプルアプリはローカルで動くので、このURL にしています。こちらにリダイレクトされます。</p>

<p><a href="https://camo.qiitausercontent.com/2a64b9838869be5d3a1fab73eb664c2ba2140b3d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33613933373333652d383135312d376461322d313534322d3262343238376663353034362e706e67" target="_blank" rel="nofollow noopener"><img width="928" alt="Screen Shot 2017-11-01 at 1.03.48 AM.png" src="https://camo.qiitausercontent.com/2a64b9838869be5d3a1fab73eb664c2ba2140b3d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33613933373333652d383135312d376461322d313534322d3262343238376663353034362e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/3a93733e-8151-7da2-1542-2b4287fc5046.png"></a></p>

<p>また、SPA 側のアプリケーションでは、<code>API access</code> の設定が必要です。これは、先ほど　Function アプリケーションと、そちらで設定したスコープが見えるようになりますので、それを選択してセーブします。</p>

<p><a href="https://camo.qiitausercontent.com/44348bcf2e6cd3796b0e076ea6e4f52ccdf70833/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30663665383863352d343534312d333530382d653338322d3933613630626230663637622e706e67" target="_blank" rel="nofollow noopener"><img width="1131" alt="Screen Shot 2017-11-01 at 1.04.10 AM.png" src="https://camo.qiitausercontent.com/44348bcf2e6cd3796b0e076ea6e4f52ccdf70833/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30663665383863352d343534312d333530382d653338322d3933613630626230663637622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/0f6e88c5-4541-3508-e382-93a60bb0f67b.png"></a></p>

<h2>
<span id="sign-up--sign-in-policy" class="fragment"></span><a href="#sign-up--sign-in-policy"><i class="fa fa-link"></i></a>Sign up / Sign in policy</h2>

<p>ここでは、赤枠のところを保存しておきましょう。メタ情報です。</p>

<p><a href="https://camo.qiitausercontent.com/76f00aeb77c5ff1f946a8d8cb3aae85b98117f1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64383464643664342d356435352d363037622d363465302d3435383765393637346164342e706e67" target="_blank" rel="nofollow noopener"><img width="956" alt="Screen Shot 2017-11-01 at 1.06.03 AM.png" src="https://camo.qiitausercontent.com/76f00aeb77c5ff1f946a8d8cb3aae85b98117f1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64383464643664342d356435352d363037622d363465302d3435383765393637346164342e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/d84dd6d4-5d55-607b-64e0-4587e9674ad4.png"></a></p>

<p>この後は、個別の設定を載せておきます。これらは、サインインに必要な属性の設定だったり、認証済みのリソースに渡される内容の設定だったりしています。<br>
<a href="https://camo.qiitausercontent.com/962a5a2e085dcfb52ded51c6949bf1a619053535/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35336434663864382d306332632d346262632d623138352d3334656465346337356365312e706e67" target="_blank" rel="nofollow noopener"><img width="578" alt="Screen Shot 2017-11-01 at 1.06.17 AM.png" src="https://camo.qiitausercontent.com/962a5a2e085dcfb52ded51c6949bf1a619053535/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35336434663864382d306332632d346262632d623138352d3334656465346337356365312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/53d4f8d8-0c2c-4bbc-b185-34ede4c75ce1.png"></a><br>
<a href="https://camo.qiitausercontent.com/5972b0c48cf250cc3a92ce775948fa102cf31930/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66613732656436302d393562312d636162392d626665352d3139663631613737643463642e706e67" target="_blank" rel="nofollow noopener"><img width="844" alt="Screen Shot 2017-11-01 at 1.06.26 AM.png" src="https://camo.qiitausercontent.com/5972b0c48cf250cc3a92ce775948fa102cf31930/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66613732656436302d393562312d636162392d626665352d3139663631613737643463642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/fa72ed60-95b1-cab9-bfe5-19f61a77d4cd.png"></a><br>
<a href="https://camo.qiitausercontent.com/de0cbfcc59ce9fecba7b5d5f89096352ae72aaaf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61653361613165302d373261642d323365302d616635642d3733616635313562653666622e706e67" target="_blank" rel="nofollow noopener"><img width="848" alt="Screen Shot 2017-11-01 at 1.06.36 AM.png" src="https://camo.qiitausercontent.com/de0cbfcc59ce9fecba7b5d5f89096352ae72aaaf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61653361613165302d373261642d323365302d616635642d3733616635313562653666622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/ae3aa1e0-72ad-23e0-af5d-73af515be6fb.png"></a></p>

<p>さて、準備環境</p>

<h2>
<span id="spa-application-の設定" class="fragment"></span><a href="#spa-application-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>SPA Application の設定</h2>

<p>先ほどのサンプルをClone したら次の箇所を変更します。</p>

<p><em>CLIENT_ID</em> SPA アプリケーションの Application ID<br>
<em>authority</em> "<a href="https://login.microsoftonline.com/tfp/%7Btenant%7D.onmicrosoft.com/%7BSign" class="autolink" rel="nofollow noopener" target="_blank">https://login.microsoftonline.com/tfp/{tenant}.onmicrosoft.com/{Sign</a> UP/ Sign in Policy Name}"<br>
<em>b2cScopes</em> "{Function App ID URL}/{Function App Policy name}"<br>
<em>webApi</em> "認証後、アクセスする Azure Functions の URL"</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>        var applicationConfig = {
            clientID: '84270d3d-1c67-4d18-8436-f3a121b1ebef',
            authority: "https://login.microsoftonline.com/tfp/someorganication.onmicrosoft.com/B2C_1_SPA_Local",
            b2cScopes: ["https://someorganication.onmicrosoft.com/api/func.read"],
            webApi: 'https://removebackend.azurewebsites.net/api/HttpTriggerCSharp1?name=Azure',
        };
</pre></div></div>

<p>ここでポイントは、<code>b2cScopes</code> です。<code>CLIENT_ID</code>がSPA のIDであるため、ここも、SPA側の設定をしそうなものですが、ここは、Functions アプリケーション側の設定です。SPA からみて、どのリソースにアクセスするか？と言うリストです。（これをみて、AD B2C の方で認証して、アクセスできるリソースを取ってきます。</p>

<p>私は当初、ここを間違えていて、ずっと悩んでいました。なぜかと言うと、ここで、間違えるとバックエンドにアクセス時ではなく、ログイン時にエラーになります。（だから、SPAの設定が悪いと思った。）実際は、ログインすると、アクセスできるリソースの情報と権限が渡されるので、ログイン時にすでに査定されているので、間違えているとログイン時に落ちます。そのケースだと、下記のエラーになります。</p>

<p><a href="https://camo.qiitausercontent.com/9953b53bbc55b666df70760419726c0be092be23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37623936363261642d383231352d636263642d656164302d6365303436313865663232662e706e67" target="_blank" rel="nofollow noopener"><img width="604" alt="Screen Shot 2017-11-01 at 1.37.21 AM.png" src="https://camo.qiitausercontent.com/9953b53bbc55b666df70760419726c0be092be23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37623936363261642d383231352d636263642d656164302d6365303436313865663232662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7b9662ad-8215-cbcd-ead0-ce04618ef22f.png"></a></p>

<p>このケースは、<code>b2cScopes</code> が間違っていると思われます。これで　SPAは準備おっけー</p>

<h1>
<span id="azure-functions-側の認証" class="fragment"></span><a href="#azure-functions-%E5%81%B4%E3%81%AE%E8%AA%8D%E8%A8%BC"><i class="fa fa-link"></i></a>Azure Functions 側の認証</h1>

<p>前回のポストで、Azure Function に直接 B2C の認証をかける方式は試しましたが、トークンの確認だけのパターンはまだなので、やってみます。前回と同じく Authentication /Authorization &gt; Active Directory Settings を設定します。</p>

<p><a href="https://camo.qiitausercontent.com/5d9703ef39e3ba4372d08ab7686bd4cdd963b229/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34386534373738392d343238332d333737662d653730352d3233393962613661383761372e706e67" target="_blank" rel="nofollow noopener"><img width="581" alt="Screen Shot 2017-11-01 at 1.40.30 AM.png" src="https://camo.qiitausercontent.com/5d9703ef39e3ba4372d08ab7686bd4cdd963b229/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34386534373738392d343238332d333737662d653730352d3233393962613661383761372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/48e47789-4283-377f-e705-2399ba6a87a7.png"></a></p>

<p><em>CLIENT_ID</em>: Function アプリケーションの Application ID<br>
<em>Issuer Url</em>: Sign up / Sign in policy で出てきたメタ情報<br>
<em>ALLOWED TOKEN AUDIENCE</em>: SPA アプリケーションの Application ID</p>

<p>と言う感じで設定します。</p>

<p>この設定をしてから、Azure Functions の画面からテストをすると、401 になります。準備完了。</p>

<p><a href="https://camo.qiitausercontent.com/0964f5c7c79ebe2703fe25b1b1f037208f68e224/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65636465306264342d383239652d306637612d643139392d6430316532666336613334372e706e67" target="_blank" rel="nofollow noopener"><img width="1152" alt="Screen Shot 2017-11-01 at 12.17.21 AM.png" src="https://camo.qiitausercontent.com/0964f5c7c79ebe2703fe25b1b1f037208f68e224/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65636465306264342d383239652d306637612d643139392d6430316532666336613334372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/ecde0bd4-829e-0f7a-d199-d01e2fc6a347.png"></a></p>

<h1>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h1>

<p>これですでに実行していいのですが、サンプルのアプリケーションは、ログイン時にポップアップが出てきて、認証します。しかし、ポップアップじゃなくしたい場合は、次のようにします。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span>
        <span class="kd">var</span> <span class="nx">clientApplication</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Msal</span><span class="p">.</span><span class="nx">UserAgentApplication</span><span class="p">(</span><span class="nx">applicationConfig</span><span class="p">.</span><span class="nx">clientID</span><span class="p">,</span> <span class="nx">applicationConfig</span><span class="p">.</span><span class="nx">authority</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errorDesc</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">tokenType</span><span class="p">)</span> <span class="p">{</span>

        <span class="p">});</span>
        <span class="nx">logMessage</span><span class="p">(</span><span class="s2">"here"</span><span class="p">);</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clientApplication</span><span class="p">.</span><span class="nx">isCallback</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="nb">window</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">clientApplication</span><span class="p">.</span><span class="nx">acquireTokenSilent</span><span class="p">(</span><span class="nx">applicationConfig</span><span class="p">.</span><span class="nx">b2cScopes</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">logMessage</span><span class="p">(</span><span class="s2">"accessToken"</span> <span class="o">+</span> <span class="nx">accessToken</span><span class="p">);</span>
                    <span class="nx">updateUI</span><span class="p">();</span>
                <span class="p">});</span>
                <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">clientApplication</span><span class="p">.</span><span class="nx">getUser</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">login</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">logMessage</span><span class="p">(</span><span class="s2">"step1"</span><span class="p">);</span>
            <span class="nx">clientApplication</span><span class="p">.</span><span class="nx">loginRedirect</span><span class="p">(</span><span class="nx">applicationConfig</span><span class="p">.</span><span class="nx">b2cScopes</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">idToken</span><span class="p">)</span> <span class="p">{</span>
</pre></div></div>

<p>login の中身を、loginPopup ではなく、loginRedirectにして、リダイレクトで戻ってきたときに、clientApplication オブジェクトが生成されたあとに、　<code>acquireTokenSilent</code> を取ってきて、下の方で、トークンにつけて渡しています。</p>

<p>全ソースコードを上げておきました。</p>

<ul>
<li><p><a href="https://github.com/TsuyoshiUshio/SPAB2CRedirect" rel="nofollow noopener" target="_blank">SPA authenticate by Azure Active Directory B2C sample with Redirect</a></p></li>
<li><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/guidedsetups/active-directory-singlepageapp-javascriptspa-use" rel="nofollow noopener" target="_blank">ユーザーのサインインに Microsoft Authentication Library (MSAL) を使用する<br>
</a></p></li>
</ul>

<h1>
<span id="実行" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>実行</h1>

<p>クライアントアプリケーションを起動し、操作すると、無事ログインして、バックエンドのAzure Functions が呼ばれたことが確認できました。簡単！</p>

<p><a href="https://camo.qiitausercontent.com/c49b69d607b959e955f7b8ee455db3e55f1eac0f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36643834396263622d366338392d393164662d656461362d3336666239346663623537632e706e67" target="_blank" rel="nofollow noopener"><img width="1033" alt="Screen Shot 2017-11-01 at 12.50.24 AM.png" src="https://camo.qiitausercontent.com/c49b69d607b959e955f7b8ee455db3e55f1eac0f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36643834396263622d366338392d393164662d656461362d3336666239346663623537632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/6d849bcb-6c89-91df-eda6-36fb94fcb57c.png"></a></p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li>
<a href="https://github.com/AzureAD/microsoft-authentication-library-for-js" rel="nofollow noopener" target="_blank">Microsoft Authentication Library Preview for JavaScript (MSAL.js)</a> </li>
<li><a href="https://github.com/Azure-Samples/active-directory-b2c-javascript-msal-singlepageapp" rel="nofollow noopener" target="_blank">A single page application (SPA) calling a Web API. Authentication is done with Azure AD B2C by leveraging MSAL.js</a></li>
<li>
<a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-reference-spa" rel="nofollow noopener" target="_blank">Azure AD B2C: Single-page app sign-in by using OAuth 2.0 implicit flow</a>
*<a href="https://stackoverflow.com/questions/42640158/azure-active-directory-allow-token-audiences" rel="nofollow noopener" target="_blank">Azure active directory - Allow token audiences</a>
</li>
<li><a href="https://github.com/Azure-Samples/active-directory-b2c-javascript-nodejs-webapi" rel="nofollow noopener" target="_blank">Node.js Web API with Azure AD B2C</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />13位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/c87236e29af16927b13b">Terraform の plugin   を理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-25 19:06:37</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Go]</b> <b>[Terraform]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>この前、Terraform の Azure Provider に機能追加のプルリクエストを送りました。受けれられるといいな。</p>

<ul>
<li><a href="https://github.com/terraform-providers/terraform-provider-azurerm/pull/331" rel="nofollow noopener" target="_blank">Adding Operational Insight Workspace (a.k.a Log Analytics)</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/2f10454313a405adf22d86303ddde8fb957356cc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33303764366131362d323833662d326538642d306433322d6135636665646138323939662e706e67" target="_blank" rel="nofollow noopener"><img width="1397" alt="Screen Shot 2017-09-25 at 2.31.27 AM.png" src="https://camo.qiitausercontent.com/2f10454313a405adf22d86303ddde8fb957356cc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33303764366131362d323833662d326538642d306433322d6135636665646138323939662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/307d6a16-283f-2e8d-0d32-a5cfeda8299f.png"></a></p>

<p>さて、アプリはできたのですが、一つだけどうやってやっているのかが想像つかない箇所がありました。それは、<code>plugin</code> です。terraform のプラグインは、バイナリを作って</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>terraform init
</pre></div></div>

<p>とやると読み込まれます。しかも、terraform のプラグインである Azure Provider の方は、明らかに実行用のライブラリです。んーなんで？と思いました。その秘密は、というハシコープで書かれている、go-plugin というプラグインを使っていることでした。基本的な仕組みは、内部で、rpc を使って、クライアントサーバー型になっているという構造になっています。</p>

<ul>
<li><a href="https://github.com/hashicorp/go-plugin" rel="nofollow noopener" target="_blank">go-plugin</a></li>
</ul>

<p>それだけでは、よくわからないので、サンプルを作って理解してみましょう。</p>

<h1>
<span id="terraform-っぽいサンプル" class="fragment"></span><a href="#terraform-%E3%81%A3%E3%81%BD%E3%81%84%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>　Terraform っぽいサンプル</h1>

<p>サンプルは、Terraform を理解するためなので、Terraformっぽく作っています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>.
├── common
│   └── provider.go
├── main.go
├── plugin
│   ├── azure_provider
│   └── azure_provider.go
</pre></div></div>

<p>こんな感じです。plugin の方が、Azure Provider 相当です。こちらの方も個別でバイナリを作ります。ポイントは、common クライアントとサーバーの両方で使うインターフェイスや　struct を置いてあることです。そこからみてみましょう。</p>

<h1>
<span id="common" class="fragment"></span><a href="#common"><i class="fa fa-link"></i></a>common</h1>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">provider</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">"net/rpc"</span>

    <span class="nx">plugin</span> <span class="s">"github.com/hashicorp/go-plugin"</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">ProviderRPC</span> <span class="kd">struct</span><span class="p">{</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">Client</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProviderRPC</span><span class="p">)</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resp</span> <span class="kt">string</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="s">"Plugin.Create"</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">resp</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProviderRPC</span><span class="p">)</span> <span class="nx">Update</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resp</span> <span class="kt">string</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="s">"Plugin.Update"</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">resp</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProviderRPC</span><span class="p">)</span> <span class="nx">Delete</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resp</span> <span class="kt">string</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="s">"Plugin.Delete"</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">resp</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProviderRPC</span><span class="p">)</span> <span class="nx">Get</span><span class="p">(</span><span class="nx">id</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Scheme</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">Scheme</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="s">"Plugin.Get"</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">resp</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ProviderRPCServer</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Impl</span> <span class="nx">Provider</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ProviderRPCServer</span><span class="p">)</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">*</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="o">*</span><span class="nx">resp</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Impl</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Scheme</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Default</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Provider</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Create</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span>
    <span class="nx">Update</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span>
    <span class="nx">Delete</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span>
    <span class="nx">Get</span><span class="p">(</span><span class="nx">id</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Scheme</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ProviderPlugin</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Impl</span> <span class="nx">Provider</span>
<span class="p">}</span>

<span class="c1">// Server</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProviderPlugin</span><span class="p">)</span> <span class="nx">Server</span><span class="p">(</span><span class="o">*</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">MuxBroker</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ProviderRPCServer</span><span class="p">{</span><span class="nx">Impl</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Impl</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Client</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">ProviderPlugin</span><span class="p">)</span> <span class="nx">Client</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">MuxBroker</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">Client</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ProviderRPC</span><span class="p">{</span><span class="nx">client</span><span class="p">:</span> <span class="nx">c</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

</pre></div></div>

<p>長々としていますが、ポイントは、シンプルで、<code>Schema</code> という構造体があって、それを rpc で転送します。 Schema は例えば、リソース（Log Analytics とか、　SQL サーバーとか）の定義情報が入っているイメージです。それぞれによって違うので、　interface{} 型にしています。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span>
<span class="kd">type</span> <span class="nx">Scheme</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Default</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Provider</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Create</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span>
    <span class="nx">Update</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span>
    <span class="nx">Delete</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span>
    <span class="nx">Get</span><span class="p">(</span><span class="nx">id</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Scheme</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ProviderPlugin</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Impl</span> <span class="nx">Provider</span>
<span class="p">}</span>
</pre></div></div>

<p>あとは、Azure だけではなくて、いろんなプロバイダが使えるように、インタフーェイスをきっていますが、ポイントは使えるメソッドは同じにしています。他には、RPC用のクライアントも書いています。もちろん先ほどのスキーマを使ってやりとりをしています。ProviderPlugin 構造体の中で使うようになっています。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">ProviderRPC</span> <span class="kd">struct</span><span class="p">{</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">Client</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProviderRPC</span><span class="p">)</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resp</span> <span class="kt">string</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="s">"Plugin.Create"</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">resp</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="provider" class="fragment"></span><a href="#provider"><i class="fa fa-link"></i></a>Provider</h1>

<p>最終的にこの場所が呼ばれます。これは、Create の例です。本来ここに、Azure SDK を使って、実際にインフラを作成します。ここでは、Scheme からデータを受け取って、メッセージを表示しています。go-plugin の方では、サンプルが単純なデータのやりとりだけだったので、構造体にしてみました。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">AzureProvider</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">logger</span> <span class="nx">hclog</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">AzureProvider</span><span class="p">)</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">provider</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Debug</span><span class="p">(</span><span class="s">"Creating Azure Resources ..."</span><span class="p">)</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Debug</span><span class="p">(</span><span class="s">"message: "</span> <span class="o">+</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">Default</span><span class="p">.(</span><span class="kt">string</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">"123"</span>
<span class="p">}</span>
</pre></div></div>

<p>ここは、サーバーが呼ばれると、"azure" というキーがきたら、実行されるようになっています。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">hclog</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">hclog</span><span class="p">.</span><span class="nx">LoggerOptions</span><span class="p">{</span>
        <span class="nx">Level</span><span class="p">:</span>      <span class="nx">hclog</span><span class="p">.</span><span class="nx">Trace</span><span class="p">,</span>
        <span class="nx">Output</span><span class="p">:</span>     <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
        <span class="nx">JSONFormat</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="nx">azureProvider</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">AzureProvider</span><span class="p">{</span>
        <span class="nx">logger</span><span class="p">:</span> <span class="nx">logger</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">pluginMap</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">{</span>
        <span class="s">"azure"</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">provider</span><span class="p">.</span><span class="nx">ProviderPlugin</span><span class="p">{</span><span class="nx">Impl</span><span class="p">:</span> <span class="nx">azureProvider</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">Debug</span><span class="p">(</span><span class="s">"Now Azure Provider Serving"</span><span class="p">)</span>

    <span class="nx">plugin</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">ServeConfig</span><span class="p">{</span>
        <span class="nx">HandshakeConfig</span><span class="p">:</span> <span class="nx">handshakeConfig</span><span class="p">,</span>
        <span class="nx">Plugins</span><span class="p">:</span>         <span class="nx">pluginMap</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="client" class="fragment"></span><a href="#client"><i class="fa fa-link"></i></a>client</h1>

<p>プロバイダのコンフィグを書いて、サーバー側と同じ設定にします。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">handshakeConfig</span> <span class="p">=</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">HandshakeConfig</span><span class="p">{</span>
    <span class="nx">ProtocolVersion</span><span class="p">:</span>  <span class="mi">1</span><span class="p">,</span>
    <span class="nx">MagicCookieKey</span><span class="p">:</span>   <span class="s">"PROVIDER_PLUGIN"</span><span class="p">,</span>
    <span class="nx">MagicCookieValue</span><span class="p">:</span> <span class="s">"azure"</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">pluginMap</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">{</span>
    <span class="s">"azure"</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">provider</span><span class="p">.</span><span class="nx">ProviderPlugin</span><span class="p">{},</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">hclog</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">hclog</span><span class="p">.</span><span class="nx">LoggerOptions</span><span class="p">{</span>
        <span class="nx">Name</span><span class="p">:</span>   <span class="s">"client"</span><span class="p">,</span>
        <span class="nx">Output</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
        <span class="nx">Level</span><span class="p">:</span>  <span class="nx">hclog</span><span class="p">.</span><span class="nx">Debug</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="nx">client</span> <span class="o">:=</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">ClientConfig</span><span class="p">{</span>
        <span class="nx">HandshakeConfig</span><span class="p">:</span> <span class="nx">handshakeConfig</span><span class="p">,</span>
        <span class="nx">Plugins</span><span class="p">:</span>         <span class="nx">pluginMap</span><span class="p">,</span>
        <span class="nx">Cmd</span><span class="p">:</span>             <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="s">"./plugin/azure_provider"</span><span class="p">),</span>
        <span class="nx">Logger</span><span class="p">:</span>          <span class="nx">logger</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Kill</span><span class="p">()</span>
    <span class="nx">rpcClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">raw</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rpcClient</span><span class="p">.</span><span class="nx">Dispense</span><span class="p">(</span><span class="s">"azure"</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">azureProvider</span> <span class="o">:=</span> <span class="nx">raw</span><span class="p">.(</span><span class="nx">provider</span><span class="p">.</span><span class="nx">Provider</span><span class="p">)</span>
    <span class="nx">message</span> <span class="o">:=</span> <span class="s">"Hello"</span>
    <span class="nx">scheme</span> <span class="o">:=</span> <span class="nx">provider</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">{</span>
        <span class="nx">message</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">azureProvider</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">scheme</span><span class="p">))</span>
<span class="p">}</span>
</pre></div></div>

<p>一旦、設定をしてしまうと、まるでローカル呼び出しのようにサーバーにアクセスできていますね！<br>
サーバーと言っても、terraform では同じマシンにある前提ですが、それでもとても便利な仕組みです。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">azureProvider</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">scheme</span><span class="p">))</span>
</pre></div></div>

<h1>
<span id="プログラムをコンパイル実行する" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>プログラムをコンパイル、実行する</h1>

<ul>
<li>
<a href="https://github.com/TsuyoshiUshio/go-plugin-sample" rel="nofollow noopener" target="_blank">go-plugin-sample</a> に全ソースコードを環境付きで置いておきました。</li>
</ul>

<p>Plugin のコンパイル</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ go build -o ./plugin/azure_provider ./plugin/azure_provider.go
</pre></div></div>

<p>これで、plugin のバイナリができます。</p>

<p>main のコンパイル</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ go build -o terrappoi .
</pre></div></div>

<p>プラグインとは全く個別に、別の環境としてコンパイルして、バイナリができます。<br>
実行してみましょう。</p>

<h1>
<span id="実行結果" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>実行結果</h1>

<p>バッチリ、RPC 通信して、うまくデータもやりとりできているのがわかりますね！すごくいい感じ！</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>invincible:go-plugin-sample ushio$ ./terrappoi
2017-09-25T02:25:43.516-0700 [DEBUG] client: starting plugin: path=./plugin/azure_provider args=[./plugin/azure_provider]
2017-09-25T02:25:43.521-0700 [DEBUG] client: waiting for RPC address: path=./plugin/azure_provider
2017-09-25T02:25:43.531-0700 [DEBUG] client.azure_provider: Now Azure Provider Serving: timestamp=2017-09-25T02:25:43.530-0700
2017-09-25T02:25:43.532-0700 [DEBUG] client.azure_provider: plugin address: timestamp=2017-09-25T02:25:43.532-0700 address=/var/folders/5b/rt6_lb397_3d92vp67g98pgr0000gn/T/plugin663688024 network=unix
2017-09-25T02:25:43.534-0700 [DEBUG] client.azure_provider: Creating Azure Resources ...: timestamp=2017-09-25T02:25:43.534-0700
2017-09-25T02:25:43.534-0700 [DEBUG] client.azure_provider: message: Hello: timestamp=2017-09-25T02:25:43.534-0700
123
2017-09-25T02:25:43.537-0700 [DEBUG] client: plugin process exited: path=./plugin/azure_provider
</pre></div></div>

<h1>
<span id="ハマったところ" class="fragment"></span><a href="#%E3%83%8F%E3%83%9E%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>ハマったところ</h1>

<p>最初下記のようなエラーが出ていました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span> ./terrappoi
2017-09-24T02:56:32.393-0700 [DEBUG] plugin: starting plugin: path=./plugin/azure_provider args=[./plugin/azure_provider]
2017-09-24T02:56:32.397-0700 [DEBUG] plugin: waiting for RPC address: path=./plugin/azure_provider
2017-09-24T02:56:32.406-0700 [DEBUG] plugin.azure_provider: Now Azure Provider Serving: timestamp=2017-09-24T02:56:32.406-0700
2017-09-24T02:56:32.406-0700 [DEBUG] plugin.azure_provider: plugin address: timestamp=2017-09-24T02:56:32.406-0700 address=/var/folders/5b/rt6_lb397_3d92vp67g98pgr0000gn/T/plugin930697090 network=unix
2017-09-24T02:56:32.410-0700 [DEBUG] plugin: plugin process exited: path=./plugin/azure_provider
panic: gob: local interface type *interface {} can only be decoded from remote interface type; received concrete type Scheme

goroutine 1 [running]:
github.com/TsuyoshiUshio/go-plugin-sample/common.(*ProviderRPC).Create(0xc420214140, 0x14548c0, 0xc42021c460, 0xc42021c460, 0xc420214140)
        /Users/ushio/Codes/rpc/src/github.com/TsuyoshiUshio/go-plugin-sample/common/provider.go:15 +0xcc
main.main()
        /Users/ushio/Codes/rpc/src/github.com/TsuyoshiUshio/go-plugin-sample/main.go:50 +0x4fd
</pre></div></div>

<p>特にこの部分。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>panic: gob: local interface type *interface {} can only be decoded from remote interface type; received concrete type Scheme
</pre></div></div>

<p>なんだこれ？という感じですが、内部で、gob というパッケージを使っていますが、その gob は、シリアライズ、デシリアライズをします。その際に、型があっていないというエラーです。結構、型は完全一致しなくてもいいのですが、特定の時に、エラーが出るようです。下記のサイトがおすすめ。</p>

<ul>
<li><a href="https://golang.org/pkg/encoding/gob/" rel="nofollow noopener" target="_blank">Package gob</a></li>
<li><a href="http://www.funcmain.com/gob_encoding_an_interface" rel="nofollow noopener" target="_blank">Gob encoding an interface</a></li>
<li><a href="https://qiita.com/TsuyoshiUshio@github/items/c27207d4db60f5c04a62" id="reference-02e028b5bba3cc5046f7">Go の Signed Int の gob バイナリエンコーディングアルゴリズムを理解する</a></li>
</ul>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<p>上記以外</p>

<ul>
<li><a href="https://github.com/hashicorp/go-plugin" rel="nofollow noopener" target="_blank">go-plugin</a></li>
<li>
<a href="https://github.com/TsuyoshiUshio/go-plugin-sample" rel="nofollow noopener" target="_blank">go-plugin-sample</a> </li>
<li><a href="https://github.com/kardianos/govendor" rel="nofollow noopener" target="_blank">govendor</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />14位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf">Azure Functions とパフォーマンスチューニングその１ - Queue-Based Load Leveling pattern</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-15 02:18:25</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[C#]</b> <b>[AzureFunctions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Cloud のデザインパターンで、<a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling" rel="nofollow noopener" target="_blank">Queue-Based Load Leveling pattern</a> というのがある。Serverless をやっているとアーキテクチャをもっと勉強しとくほうがいいなと思って、少しづつパターンを検証してみようと思っている。ふと思い立って、このパターンを Azure Functions で本当にそうなのか試してみることにした。</p>

<p><a href="https://camo.qiitausercontent.com/20ece77cb998d7dcad696e5c901c9ffb580fc7fd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35366163353863352d623662652d636330632d633739382d6434646363303365616331362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/20ece77cb998d7dcad696e5c901c9ffb580fc7fd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35366163353863352d623662652d636330632d633739382d6434646363303365616331362e706e67" alt="queue-based-load-leveling-pattern.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/56ac58c5-b6be-cc0c-c798-d4dcc03eac16.png"></a></p>

<p>このパターンは、高負荷の時にパフォーマンス問題を引き起こすケースに使える。例えば、アプリケーションがスケールして、それが一気にデータベースに書き込むようなケースはどう解決するか？という話だ。そこで、Queue を挟むといいですよ。という話になる。じゃあ、実際に、Azure Functions で試してみよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>HttpTrigger -&gt; AzureFunctions -&gt; CosmosDB
</pre></div></div>

<p>という構成と、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>HttpTrigger -&gt; AzureFunctions -&gt; StorageQueue -&gt; QueueTriggger -&gt; Azure Functions -&gt; CosmosDB
</pre></div></div>

<p>つまりこんな感じのシンプルなテスト。</p>

<p><a href="https://camo.qiitausercontent.com/e5c2d24a52c062367f262e8e66332581073049f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34336163626562382d333762612d653836362d663932342d3666393364643762333131382e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e5c2d24a52c062367f262e8e66332581073049f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34336163626562382d333762612d653836362d663932342d3666393364643762333131382e6a706567" alt="compare.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/43acbeb8-37ba-e866-f924-6f93dd7b3118.jpeg"></a></p>

<p>という構成で、どちらがパフォーマンスが良いかを検証してみよう。このぱたーんにしたがうと当然後者！になりそうである。最初は Consumption プランで試してみた。</p>

<h1>
<span id="前者のほうが何故かパフォーマンスが良いという初回の結果" class="fragment"></span><a href="#%E5%89%8D%E8%80%85%E3%81%AE%E3%81%BB%E3%81%86%E3%81%8C%E4%BD%95%E6%95%85%E3%81%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%8C%E8%89%AF%E3%81%84%E3%81%A8%E3%81%84%E3%81%86%E5%88%9D%E5%9B%9E%E3%81%AE%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>前者のほうが何故かパフォーマンスが良いという初回の結果</h1>

<p>とりあえず 2000　ユーザぐらいの負荷をかけてみる。</p>

<h2>
<span id="ダイレクト" class="fragment"></span><a href="#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>ダイレクト</h2>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">Run</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">IAsyncCollector</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">outputDocument</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"DirectWrite Trigged!"</span><span class="p">);</span>
    <span class="c1">// Get request body</span>
    <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="k">await</span> <span class="n">req</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">ReadAsStringAsync</span><span class="p">();</span>
    <span class="k">await</span> <span class="n">outputDocument</span><span class="p">.</span><span class="n">AddAsync</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">req</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="s">"Thank your for the message"</span><span class="p">);</span>

<span class="p">}</span>

</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/ff1fda23eb65935a78b04442a9dd25894ce429c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66343230383535662d393837322d313332352d666434652d3437376436353031653362352e706e67" target="_blank" rel="nofollow noopener"><img width="628" alt="DirectConsumptionPlan01.png" src="https://camo.qiitausercontent.com/ff1fda23eb65935a78b04442a9dd25894ce429c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66343230383535662d393837322d313332352d666434652d3437376436353031653362352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f420855f-9872-1325-fd4e-477d6501e3b5.png"></a></p>

<h2>
<span id="queue-を介した結果" class="fragment"></span><a href="#queue-%E3%82%92%E4%BB%8B%E3%81%97%E3%81%9F%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>Queue を介した結果</h2>

<p><a href="https://camo.qiitausercontent.com/c07edea71ed93cad2d17cc6ece723e3f122cb44d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34653032363765342d356465312d363633622d613431382d3064653339393962393436632e706e67" target="_blank" rel="nofollow noopener"><img width="656" alt="InDirectConsumptionPlan01.png" src="https://camo.qiitausercontent.com/c07edea71ed93cad2d17cc6ece723e3f122cb44d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34653032363765342d356465312d363633622d613431382d3064653339393962393436632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4e0267e4-5de1-663b-a418-0de3999b946c.png"></a></p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">Run</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">IAsyncCollector</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">outputQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"C# HTTP trigger function processed a request."</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="k">await</span> <span class="n">req</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">ReadAsStringAsync</span><span class="p">();</span>
    <span class="n">outputQueueItem</span><span class="p">.</span><span class="n">AddAsync</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">req</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="s">"Thank you for sending messages"</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></div>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">string</span> <span class="n">myQueueItem</span><span class="p">,</span><span class="n">IAsyncCollector</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">outputDocument</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="err">$</span><span class="s">"C# Queue trigger function processed: {myQueueItem}"</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">outputDocument</span><span class="p">.</span><span class="n">AddAsync</span><span class="p">(</span><span class="n">myQueueItem</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></div>

<h2>
<span id="ななんでやねん" class="fragment"></span><a href="#%E3%81%AA%E3%81%AA%E3%82%93%E3%81%A7%E3%82%84%E3%81%AD%E3%82%93"><i class="fa fa-link"></i></a>な、なんでやねん</h2>

<p>というわけで結果をみると、なんでやねんとしか言いようのない結果になった。想定と逆だ。ちなみに、何回か繰り返すと、これは、Queue がとか、ダイレクトがとかではなくて、ダイレクトでもエラー三昧になったり、出力が安定しない。一体何なんだろうと思ったのだが、原因は簡単だった。Consumptionプランは、マイクロビリングと言われるつかっただけの課金でオートスケールする。オートスケールはリクエストのカウントでスケールするようだ。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-gb/azure/azure-functions/functions-scale" rel="nofollow noopener" target="_blank">Azure Functions hosting plans comparison</a></li>
</ul>

<p>つまり、HttpTrigger が大量のデータをさばくためには、スケールアウトしていないといけないが、この負荷テストの設定だと、一気に2000ユーザのアクセスが来るようになっているので、スケールするまえに、リクエストが来すぎてやられている、もしくは、負荷をかけた後だと、スケールアウトがなされた状態だと、それでも負荷に耐えれている（たぶんデータベースのデータ量とかも関係している）という推測を立てた。</p>

<p>説明を読むと、スケールコントローラーがその役割を果たしている様子。</p>

<p><a href="https://camo.qiitausercontent.com/c690f7b7eea2deaecbc7a4e40f0d7e7fdc83b20b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37636636626162362d333739302d383733332d613834332d3935363934356131373436632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c690f7b7eea2deaecbc7a4e40f0d7e7fdc83b20b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37636636626162362d333739302d383733332d613834332d3935363934356131373436632e706e67" alt="central-listener.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7cf6bab6-3790-8733-a843-956945a1746c.png"></a></p>

<p>エラーを見てみるとこんな感じのだったりする。明らかに</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Host Error: Microsoft.Azure.WebJobs.Script: Host thresholds exceeded: [Connections]. 
Session Id: 2ade43e7040548e49a6d620323e9a863
Timestamp: 2017-11-13T13:55:31.367Z
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>503 - Service Unavailable
</pre></div></div>

<p>だから、たまたまスケールした時にあたっているかということになる。元々、Httpで大量のデータを受け付けるというより、Event Hub や、IoTHub で受け付けるようにするといいのかもしれない。</p>

<ul>
<li><a href="https://blogs.msdn.microsoft.com/appserviceteam/2017/09/19/processing-100000-events-per-second-on-azure-functions/" rel="nofollow noopener" target="_blank">Processing 100,000 Events Per Second on Azure Functions</a></li>
</ul>

<p>上記の方法だとなんと100,000 Event / Sec でもさばけている様子だ。だからきっとHttpTrigger の制約で、それは、Web サイトのアクセスと同じような感じでかんがえるとよいかもしれない。</p>

<p>だから、負荷試験をするときに、この設定では、一気に2000ユーザ同時だが、段階を追ってあげていくと、よいのかもしれない。</p>

<p><a href="https://camo.qiitausercontent.com/4b40fb08c8ceba8b9b7086904d883b230507f537/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65303665653335332d306536642d353061662d343432352d6166663339636333343161612e706e67" target="_blank" rel="nofollow noopener"><img width="361" alt="Step01.png" src="https://camo.qiitausercontent.com/4b40fb08c8ceba8b9b7086904d883b230507f537/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65303665653335332d306536642d353061662d343432352d6166663339636333343161612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/e06ee353-0e6d-50af-4425-aff39cc341aa.png"></a></p>

<p>すると、少しエラーがでているが、Queue を介するほうではしっかりと、大体対応できているのがわかる。やっぱりスケールの原因っぽい。</p>

<p><a href="https://camo.qiitausercontent.com/9808c9ed748efb44bdeee62048413eed599c2b16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30623532643134312d323961342d353334652d663664622d6165636338373834346434632e706e67" target="_blank" rel="nofollow noopener"><img width="617" alt="step02.png" src="https://camo.qiitausercontent.com/9808c9ed748efb44bdeee62048413eed599c2b16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30623532643134312d323961342d353334652d663664622d6165636338373834346434632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/0b52d141-29a4-534e-f6db-aecc87844d4c.png"></a><br>
<a href="https://camo.qiitausercontent.com/97cad082aa01776a998345715e1b31079741603e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34666330383634652d376638642d366133642d343532352d3636616362366432343865352e706e67" target="_blank" rel="nofollow noopener"><img width="889" alt="step03.png" src="https://camo.qiitausercontent.com/97cad082aa01776a998345715e1b31079741603e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34666330383634652d376638642d366133642d343532352d3636616362366432343865352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4fc0864e-7f8d-6a3d-4525-66acb6d248e5.png"></a></p>

<p>Consumption Plan では、オートスケールなので、大量のリクエストをさばきたいときは、EventHub 経由で非同期にするか、ある程度スケールするように温めるかということになる。ただ、このグラフを見ていると、ある程度のところで、サーバーがスケールしているっぽいのがわかる。今度は、8000 ユーザをステップ実行で流してみる。</p>

<p><a href="https://camo.qiitausercontent.com/cbd86da85ddd966d90f96cda1b97e90f77e36a8b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33643734616335372d363931392d356335612d393935332d3037383266323837653161652e706e67" target="_blank" rel="nofollow noopener"><img width="618" alt="800001.png" src="https://camo.qiitausercontent.com/cbd86da85ddd966d90f96cda1b97e90f77e36a8b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33643734616335372d363931392d356335612d393935332d3037383266323837653161652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/3d74ac57-6919-5c5a-9953-0782f287e1ae.png"></a><br>
<a href="https://camo.qiitausercontent.com/d62a869b7d0a330d8ec0c99b95cf1dc7409afcd5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61333337626637622d323462312d373635662d656637342d6265383639653263353761352e706e67" target="_blank" rel="nofollow noopener"><img width="896" alt="800002.png" src="https://camo.qiitausercontent.com/d62a869b7d0a330d8ec0c99b95cf1dc7409afcd5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61333337626637622d323462312d373635662d656637342d6265383639653263353761352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a337bf7b-24b1-765f-ef74-be869e2c57a5.png"></a><br>
<a href="https://camo.qiitausercontent.com/48bf1952175c3830a7cea79f1425482145be6a1c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35303363663764392d303863322d663765332d643061662d3830623163383539386630362e706e67" target="_blank" rel="nofollow noopener"><img width="710" alt="800003.png" src="https://camo.qiitausercontent.com/48bf1952175c3830a7cea79f1425482145be6a1c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35303363663764392d303863322d663765332d643061662d3830623163383539386630362e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/503cf7d9-08c2-f7e3-d0af-80b1c8598f06.png"></a></p>

<p>途中でスケールしている感じがわかる。スケールが間に合っていない。ただ、耐えき照れていないところは、Consumption plan のサーバーの限界かもしれない。しかし、どんどんスケールしている雰囲気なのは興味深い。やっぱりHttpで高い負荷を受けるときは、AppService Plan を選択するか、もしくは、EventHub/IoTHub で受ける（可能なら）というのが良さげだ。おそらく、Azure Functions の限界ではなく、Consumption Plan の HttpTrigger の限界というべきかもしれない。</p>

<h1>
<span id="app-service-plan-を試す" class="fragment"></span><a href="#app-service-plan-%E3%82%92%E8%A9%A6%E3%81%99"><i class="fa fa-link"></i></a>App Service Plan を試す</h1>

<p>そうすると、このパターンを試すためには、App Service Plan で試すほうがいいかもしれない。そっちのほうが比較がちかくなるだろう。最初から10台のサーバーを並べることにしてみた。1 Core 1.75 GB RAM のプランなので一番しょぼい奴だ。</p>

<h2>
<span id="ダイレクト-1" class="fragment"></span><a href="#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88-1"><i class="fa fa-link"></i></a>ダイレクト</h2>

<p><a href="https://camo.qiitausercontent.com/b0d54ed22e7f731afbb08b526fe71a3b2224e4a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63346237376532342d643933312d393038332d626132372d3431383362306638323263352e706e67" target="_blank" rel="nofollow noopener"><img width="615" alt="AppDirect01.png" src="https://camo.qiitausercontent.com/b0d54ed22e7f731afbb08b526fe71a3b2224e4a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63346237376532342d643933312d393038332d626132372d3431383362306638323263352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/c4b77e24-d931-9083-ba27-4183b0f822c5.png"></a></p>

<p>Internal Server Error 500 で落ちている。</p>

<h2>
<span id="queue-経由" class="fragment"></span><a href="#queue-%E7%B5%8C%E7%94%B1"><i class="fa fa-link"></i></a>Queue 経由</h2>

<p><a href="https://camo.qiitausercontent.com/ead0f72931a0868a9fc217d11eced3df28e9362e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61326232653161362d666162622d343365392d616264642d3739316461613039363835312e706e67" target="_blank" rel="nofollow noopener"><img width="606" alt="AppInDirect01.png" src="https://camo.qiitausercontent.com/ead0f72931a0868a9fc217d11eced3df28e9362e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61326232653161362d666162622d343365392d616264642d3739316461613039363835312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a2b2e1a6-fabb-43e9-abdd-791daa096851.png"></a></p>

<p>こちらは、1 は、Bad Gateway になっている。</p>

<p>Queue 経由だとほぼエラーが出なくなっている。ダイレクトだと、１０並列で、Cosmosに叩き込むことになるので、エラーになっていると思われる。</p>

<p>ただ気になるのは、リクエスト数の違いだ。なぜ違うんだろう。私がうまく負荷テストをやれていない可能性がある。ただ、サーバーのログを見てもエラーにはなっていないので、Queue 経由のほうが高い負荷に耐えられそうだ。</p>

<p>基本的に高い負荷に耐えてもらおうと思うと、</p>

<ul>
<li>Consumption Plan で事前に負荷をかけて、温める</li>
<li>App Service Plan で、スケールをすでにさせておく</li>
</ul>

<p>後者が特に安定するだろう。App Service Plan はマイクロビリングの意味では意味をなさないかもしれないが、サーバーレスの生産性に注目して、マイクロビリングにこだわらないならいい感じかもしれない。</p>

<h1>
<span id="app-service-plan-で高級サーバーでぶん殴ってみる" class="fragment"></span><a href="#app-service-plan-%E3%81%A7%E9%AB%98%E7%B4%9A%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%A7%E3%81%B6%E3%82%93%E6%AE%B4%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>App Service Plan で高級サーバーでぶん殴ってみる</h1>

<p>折角なのでためしに、高級サーバーで、14 サーバー並列にしてみよう。</p>

<p><a href="https://camo.qiitausercontent.com/14c60db480d2c3a210965a0a1185ebb8f7af8e24/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37336130633439612d313033652d336131342d313238382d3636373433363834383935352e706e67" target="_blank" rel="nofollow noopener"><img width="296" alt="expensiveapp.png" src="https://camo.qiitausercontent.com/14c60db480d2c3a210965a0a1185ebb8f7af8e24/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37336130633439612d313033652d336131342d313238382d3636373433363834383935352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/73a0c49a-103e-3a14-1288-667436848955.png"></a></p>

<h2>
<span id="だめだった" class="fragment"></span><a href="#%E3%81%A0%E3%82%81%E3%81%A0%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>だめだった</h2>

<p>2000 user -&gt; 8000 user まで、段階的に上げてみたがうまくいかず。ネックは違うところにあるかもしれない。</p>

<p><a href="https://camo.qiitausercontent.com/8d4a1cf218e3d0419a0677e2b35c1fb617c1fc25/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34653066653630652d613437382d646434352d366264362d3832356562346535396230382e706e67" target="_blank" rel="nofollow noopener"><img width="681" alt="expensiveapp01.png" src="https://camo.qiitausercontent.com/8d4a1cf218e3d0419a0677e2b35c1fb617c1fc25/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34653066653630652d613437382d646434352d366264362d3832356562346535396230382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4e0fe60e-a478-dd45-6bd6-825eb4e59b08.png"></a><br>
<a href="https://camo.qiitausercontent.com/f1d182c67aa958e9fc4718b4108cbfa207e20f77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65396264343739632d663863662d346130662d313937322d6333613365643562633064332e706e67" target="_blank" rel="nofollow noopener"><img width="892" alt="expensiveapp02.png" src="https://camo.qiitausercontent.com/f1d182c67aa958e9fc4718b4108cbfa207e20f77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65396264343739632d663863662d346130662d313937322d6333613365643562633064332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/e9bd479c-f8cf-4a0f-1972-c3a3ed5bc0d3.png"></a><br>
<a href="https://camo.qiitausercontent.com/1eff2dc01d788f6a4406eac6b967f8a8ca155889/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37386165663231642d313465382d613662352d623233612d3266393032323461306631372e706e67" target="_blank" rel="nofollow noopener"><img width="665" alt="expensiveapp03.png" src="https://camo.qiitausercontent.com/1eff2dc01d788f6a4406eac6b967f8a8ca155889/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37386165663231642d313465382d613662352d623233612d3266393032323461306631372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/78aef21d-14e8-a6b5-b23a-2f90224a0f17.png"></a></p>

<p>残念ながら、Application Insight をセットしていなかったので、Internal Error の内容はわからず。<br>
<a href="https://camo.qiitausercontent.com/e26182371f77f2acf66ca21afa90f7ef1cf7476c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35323862373639362d626536342d663263322d366538642d3737333530346430323865622e706e67" target="_blank" rel="nofollow noopener"><img width="580" alt="expensiveapp04.png" src="https://camo.qiitausercontent.com/e26182371f77f2acf66ca21afa90f7ef1cf7476c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35323862373639362d626536342d663263322d366538642d3737333530346430323865622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/528b7696-be64-f2c2-6e8d-773504d028eb.png"></a></p>

<p>Azure Functions の件数を見ても、エラーはないので、何かサーバーレベルの問題と思われる（ちなみに、件数は、Queue トリガーのほうが少ないので Lost している）<br>
<a href="https://camo.qiitausercontent.com/c3a9fe874f9d2f145e3fc39cf307a1c48ce55e7d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63323164303537662d666663652d333435642d323161382d3034633231353861363334322e706e67" target="_blank" rel="nofollow noopener"><img width="874" alt="expensiveapp05.png" src="https://camo.qiitausercontent.com/c3a9fe874f9d2f145e3fc39cf307a1c48ce55e7d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63323164303537662d666663652d333435642d323161382d3034633231353861363334322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/c21d057f-ffce-345d-21a8-04c2158a6342.png"></a><br>
<a href="https://camo.qiitausercontent.com/c161bd5ad8f9b75caa19cabf88dd9b0c0ed11f09/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37373730336438342d393765662d616436382d393537312d6630626437336465373537632e706e67" target="_blank" rel="nofollow noopener"><img width="894" alt="expensiveapp06.png" src="https://camo.qiitausercontent.com/c161bd5ad8f9b75caa19cabf88dd9b0c0ed11f09/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37373730336438342d393765662d616436382d393537312d6630626437336465373537632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/77703d84-97ef-ad68-9571-f0bd73de757c.png"></a></p>

<p>Cosmos 側がねっくなのでは？とも思ったがそうではないようす。400RU のチープなやつだが、一時的に超えても、問題ないようす。</p>

<p><a href="https://camo.qiitausercontent.com/4557dcaad842127361cfead1dba610925811fa99/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f31373230353034632d613334322d636434352d313639352d3262373731613930373266312e706e67" target="_blank" rel="nofollow noopener"><img width="769" alt="expensive07.png" src="https://camo.qiitausercontent.com/4557dcaad842127361cfead1dba610925811fa99/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f31373230353034632d613334322d636434352d313639352d3262373731613930373266312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/1720504c-a342-cd45-1695-2b771a9072f1.png"></a></p>

<h1>
<span id="次回" class="fragment"></span><a href="#%E6%AC%A1%E5%9B%9E"><i class="fa fa-link"></i></a>次回</h1>

<p>まずは、私の Azure Functions と、WebApps のチューニング、負荷試験の知識が足りないとおもわれるので、自分でうんうんうなってないで、人の助けを借りることにしよう。この結果は適切ではない可能性がある。まずは原因調査から。</p>

<p>次は、C#, Node, Durable Functions の比較、App Service Plan でもっといいサーバーを使ってみるとどうなるかとかを試してみよう。</p>

<p>負荷試験ツール（今回はVSTS) もちゃんと調べたほうがよさそう。あまり設定項目無いからこんなもんと思ってたけど一応目を通しておこう。</p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li>
<a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling" rel="nofollow noopener" target="_blank">Queue-Based Load Leveling pattern</a> </li>
<li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />15位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/14b623609b335397b314">SPA を Azure Functions Proxy を使って公開する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-19 22:06:49</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[MaterialDesign]</b> <b>[Angular2]</b> <b>[AzureFunctions]</b> <b>[angular-cli]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Angular 4 + Material Design で、SPA を作成した。これを Blob にアップロードして見た。</p>

<ul>
<li><a href="https://qiita.com/TsuyoshiUshio@github/items/e6df17eaf2324841e331" id="reference-b55a7a2d32b9b6a26de1">SPA を Blob Storage にあげて、Azure Functions をバックエンドにしてみる。</a></li>
</ul>

<p>折角なので、Azure Function の Proxy を使って、URL を blob の URL じゃないようにしたいと考えた。そしたら、次のような記事があった。</p>

<ul>
<li><a href="https://blog.stephencleary.com/2017/08/azure-functions-spa.html" rel="nofollow noopener" target="_blank">Azure Functions SPA</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-proxies" rel="nofollow noopener" target="_blank">Work with Azure Functions Proxies (preview)</a></li>
<li><a href="https://azure.microsoft.com/en-us/resources/samples/functions-proxies/" rel="nofollow noopener" target="_blank">Azure Function Proxies samples</a></li>
</ul>

<p>簡単にできそうだ。</p>

<h1>
<span id="azure-functions-を設定しても動かなかった理由" class="fragment"></span><a href="#azure-functions-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%82%82%E5%8B%95%E3%81%8B%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a>Azure Functions を設定しても動かなかった理由</h1>

<p>自分で同じようにやって見たが、なぜか全く動かない。ルーティングしない。とても悩んだが理由は簡単だった。Azure Functions 2.0 (Preview)では現在のところ、思ったように動かない雰囲気。少なくともやりたかったことは動かない様子。解決策は簡単で、Azure Functions 1.0 (GAのもの) を使えば、上記の記事の通りの設定でうまくいった。</p>

<h1>
<span id="設定の詳細" class="fragment"></span><a href="#%E8%A8%AD%E5%AE%9A%E3%81%AE%E8%A9%B3%E7%B4%B0"><i class="fa fa-link"></i></a>設定の詳細</h1>

<p>実際にルーティングしたいサイトは、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>http://xxxx.blob.core.windows.net/web/index.html
http://xxxx.blob.core.windows.net/web/asset/xxx.png
http://xxxx.blob.core.windows.net/web/dashboard
</pre></div></div>

<p>みたいな感じだったりする。 このような設定にしたい場合は、下記のようにすると良い。</p>

<p><a href="https://camo.qiitausercontent.com/10d34faf7de56e3cda629460b710546b61bd2da1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61336664333332372d383636332d616431342d396538652d3635613439633965393766652e706e67" target="_blank" rel="nofollow noopener"><img width="1113" alt="Screen Shot 2017-10-19 at 9.54.54 PM.png" src="https://camo.qiitausercontent.com/10d34faf7de56e3cda629460b710546b61bd2da1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61336664333332372d383636332d616431342d396538652d3635613439633965393766652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a3fd3327-8663-ad14-9e8e-65a49c9e97fe.png"></a></p>

<p>ポイントは、変数になる箇所に、例えば、<code>{*url}</code> みたいなのを書いて、バックエンドの方にも、それを引き継いだ <code>{url}</code> みたいなのを書くとそこがワイルドカードになる。</p>

<h1>
<span id="todo" class="fragment"></span><a href="#todo"><i class="fa fa-link"></i></a>TODO</h1>

<p>今日は、Azure Functions 2.0 では、　Proxyがうまく動かないのが、わからなかったので、時間を使ってしまった。次にしたいところは次のこと。</p>

<ul>
<li>ユーザー認証</li>
<li>カスタムドメイン</li>
<li>Continuous Delivery</li>
<li>index.html を単なる <code>/</code> にしたい</li>
</ul>

<p>など！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />16位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/e3711749e7a2765f7eb0">Webpack についてちょっと試してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-02 23:43:36</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[webpack]</b> <b>[AzureFunctions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Azure Functions の Cold start 問題に関しては、<code>App Service Plan</code> + <code>Always On</code> option を使う方法があるが、それに加えて、node の場合は、<code>webpack</code> を使うと良さげ。C# の場合はプリコンパイルオプション。今日はさらっと試しただけのなので、明日以降色々試してみたい。</p>

<ul>
<li><a href="https://github.com/Azure/azure-webjobs-sdk-script/issues/298" rel="nofollow noopener" target="_blank">Cold start of Azure Function with large npm module trees is slow in Consumption plan #298</a></li>
<li><a href="https://github.com/Azure/Azure-Functions/issues/131" rel="nofollow noopener" target="_blank">Cold Start and Warm Start on Consumption Plan #131</a></li>
</ul>

<p>まずは<a href="https://webpack.js.org/concepts/" rel="nofollow noopener" target="_blank">webpack</a>についてちょっと試してみた。</p>

<h1>
<span id="webpack-でビルドしてみる" class="fragment"></span><a href="#webpack-%E3%81%A7%E3%83%93%E3%83%AB%E3%83%89%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>Webpack でビルドしてみる</h1>

<p>ここに便利なリポジトリがあった。</p>

<ul>
<li><a href="https://github.com/christopheranderson/azure-functions-webpack-sample" rel="nofollow noopener" target="_blank">Example WebPack with Azure Functions</a></li>
</ul>

<p>ちょっとインストラクションが古いけど、下記のようにすればできる。clone して下記のようにする。<a href="https://github.com/Azure/azure-functions-cli" rel="nofollow noopener" target="_blank">Azure Functions CLI</a>はインストールずみのこと。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>npm install
npm run build
func init
func host start
</pre></div></div>

<p>これで、サーバーが動く</p>

<p><a href="https://camo.qiitausercontent.com/aaf10c9af1fbc33fdeda63b81c7b643ebfbea487/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63626263626664652d646462302d356237392d346530362d6466343037346134383536652e706e67" target="_blank" rel="nofollow noopener"><img width="682" alt="Screen Shot 2017-10-02 at 11.30.48 PM.png" src="https://camo.qiitausercontent.com/aaf10c9af1fbc33fdeda63b81c7b643ebfbea487/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63626263626664652d646462302d356237392d346530362d6466343037346134383536652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/cbbcbfde-ddb0-5b79-4e06-df4074a4856e.png"></a></p>

<h1>
<span id="webpack-の実態をみる" class="fragment"></span><a href="#webpack-%E3%81%AE%E5%AE%9F%E6%85%8B%E3%82%92%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>webpack の実態をみる。</h1>

<p>webpack のやりたいことは、すぐにわかる。<code>build/index.js</code> というファイルができてるのでみてみよう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span>
<span class="cm">/******/</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">modules</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// webpackBootstrap</span>
<span class="cm">/******/</span>        <span class="c1">// The module cache</span>
<span class="cm">/******/</span>        <span class="kd">var</span> <span class="nx">installedModules</span> <span class="o">=</span> <span class="p">{};</span>
<span class="cm">/******/</span>
<span class="cm">/******/</span>        <span class="c1">// The require function</span>
<span class="cm">/******/</span>        <span class="kd">function</span> <span class="nx">__webpack_require__</span><span class="p">(</span><span class="nx">moduleId</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/******/</span>
<span class="cm">/******/</span>                <span class="c1">// Check if module is in cache</span>
<span class="cm">/******/</span>                <span class="k">if</span><span class="p">(</span><span class="nx">installedModules</span><span class="p">[</span><span class="nx">moduleId</span><span class="p">])</span> <span class="p">{</span>
<span class="cm">/******/</span>                        <span class="k">return</span> <span class="nx">installedModules</span><span class="p">[</span><span class="nx">moduleId</span><span class="p">].</span><span class="nx">exports</span><span class="p">;</span>
<span class="cm">/******/</span>                <span class="p">}</span>
<span class="cm">/******/</span>                <span class="c1">// Create a new module (and put it into the cache)</span>
<span class="cm">/******/</span>                <span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">installedModules</span><span class="p">[</span><span class="nx">moduleId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/******/</span>                        <span class="nx">i</span><span class="o">:</span> <span class="nx">moduleId</span><span class="p">,</span>
<span class="cm">/******/</span>                        <span class="nx">l</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="cm">/******/</span>                        <span class="nx">exports</span><span class="o">:</span> <span class="p">{}</span>
<span class="cm">/******/</span>                <span class="p">};</span>
<span class="cm">/******/</span>
<span class="cm">/******/</span>                <span class="c1">// Execute the module function</span>
<span class="cm">/******/</span>                <span class="nx">modules</span><span class="p">[</span><span class="nx">moduleId</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">__webpack_require__</span><span class="p">);</span>
<span class="cm">/******/</span>
 <span class="o">:</span> <span class="nx">以下続く</span>
</pre></div></div>

<h1>
<span id="webpack-の今回の目的での効能" class="fragment"></span><a href="#webpack-%E3%81%AE%E4%BB%8A%E5%9B%9E%E3%81%AE%E7%9B%AE%E7%9A%84%E3%81%A7%E3%81%AE%E5%8A%B9%E8%83%BD"><i class="fa fa-link"></i></a>webpack の今回の目的での効能</h1>

<p>つまり、一つのファイルに、node_moduleの下にあるライブラリをまとめている。もともと、<code>webpack</code> の <code>Azure Functions</code> による使用のきっかけは、<code>consumption plan</code> での起動が、<code>webpack</code> をするとかなり早くなるという話だった。</p>

<p><a href="https://camo.qiitausercontent.com/010d8ab58e037f5697b67d7dfd461a9e01db1516/68747470733a2f2f63616d6f2e67697468756275736572636f6e74656e742e636f6d2f656139306630656262336437346265656338316636656135366238346230366634383134366339652f3638373437343730373333613266326637343666366336343631376137353732363536323663366636323631363336333635373337333734363537333734326536323663366636323265363336663732363532653737363936653634366637373733326536653635373432663734363537333734326635373635363237303631363336623530363537323636366637323664363136653633363533323265373036653637" target="_blank" rel="nofollow noopener"><img width="682" src="https://camo.qiitausercontent.com/010d8ab58e037f5697b67d7dfd461a9e01db1516/68747470733a2f2f63616d6f2e67697468756275736572636f6e74656e742e636f6d2f656139306630656262336437346265656338316636656135366238346230366634383134366339652f3638373437343730373333613266326637343666366336343631376137353732363536323663366636323631363336333635373337333734363537333734326536323663366636323265363336663732363532653737363936653634366637373733326536653635373432663734363537333734326635373635363237303631363336623530363537323636366637323664363136653633363533323265373036653637" data-canonical-src="https://camo.githubusercontent.com/ea90f0ebb3d74beec81f6ea56b84b06f48146c9e/68747470733a2f2f746f6c64617a757265626c6f62616363657373746573742e626c6f622e636f72652e77696e646f77732e6e65742f746573742f5765627061636b506572666f726d616e6365322e706e67"></a></p>

<p>つまり、ファイルを１つにまとめることで、起動時のスピードが早くなるらしい。これが、どんな感じになっているか、各ファイルをみてみよう。</p>

<h1>
<span id="webpack-のやること" class="fragment"></span><a href="#webpack-%E3%81%AE%E3%82%84%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>webpack のやること</h1>

<p><code>build</code> をみると、単純に、<code>webpack</code> を実行している。</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="err">cat</span> <span class="err">package.json</span> 
<span class="p">{</span>
  <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"asdf"</span><span class="p">,</span>
  <span class="nt">"version"</span><span class="p">:</span> <span class="s2">"1.0.0"</span><span class="p">,</span>
  <span class="nt">"description"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
  <span class="nt">"main"</span><span class="p">:</span> <span class="s2">"index.js"</span><span class="p">,</span>
  <span class="nt">"scripts"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"build"</span><span class="p">:</span> <span class="s2">"webpack"</span>
  <span class="p">},</span>
  <span class="nt">"author"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
  <span class="nt">"license"</span><span class="p">:</span> <span class="s2">"ISC"</span><span class="p">,</span>
  <span class="nt">"dependencies"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"lodash"</span><span class="p">:</span> <span class="s2">"^4.17.4"</span><span class="p">,</span>
    <span class="nt">"ms-rest-azure"</span><span class="p">:</span> <span class="s2">"^1.15.4"</span>
  <span class="p">},</span>
  <span class="nt">"devDependencies"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"webpack"</span><span class="p">:</span> <span class="s2">"^2.2.1"</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></div></div>

<p>webpack は、<code>webpack.config.js</code> を見てライブラリをまとめる作業を実施。どこに、結果を吐き出すかも書いている。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cat</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">js</span> 
<span class="kd">var</span> <span class="nx">webpack</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpack'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">entry</span><span class="o">:</span> <span class="s1">'./index.js'</span><span class="p">,</span>
  <span class="nx">target</span><span class="o">:</span> <span class="s1">'node'</span><span class="p">,</span>
  <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s2">"build"</span><span class="p">),</span>
    <span class="nx">filename</span><span class="o">:</span> <span class="s1">'index.js'</span><span class="p">,</span>
    <span class="nx">library</span><span class="o">:</span> <span class="s2">"index"</span><span class="p">,</span>
    <span class="nx">libraryTarget</span><span class="o">:</span> <span class="s2">"commonjs2"</span>
  <span class="p">},</span>
  <span class="nx">node</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">__filename</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">__dirname</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>
</pre></div></div>

<p>ちなみに、参照されている、<code>./index.js</code>は、各functions を参照。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cat</span> <span class="nx">index</span><span class="p">.</span><span class="nx">js</span> 
<span class="kd">var</span> <span class="nx">HttpTriggerJS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./HttpTriggerJS/index'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">HTTPJS2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./HTTPJS2/index'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">HttpTriggerJS</span><span class="o">:</span> <span class="nx">HttpTriggerJS</span><span class="p">,</span>
    <span class="nx">HTTPJS2</span><span class="o">:</span> <span class="nx">HTTPJS2</span>
<span class="p">}</span>
</pre></div></div>

<p>そして、各functions は、生成された <code>build/index.js</code> を参照している。</p>

<p>function.json</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="err">cat</span> <span class="err">function.json</span> 
<span class="p">{</span>
  <span class="nt">"disabled"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">"scriptFile"</span><span class="p">:</span><span class="s2">"../build/index.js"</span><span class="p">,</span>
  <span class="nt">"entryPoint"</span><span class="p">:</span><span class="s2">"HttpTriggerJS"</span><span class="p">,</span>
  <span class="nt">"bindings"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">"authLevel"</span><span class="p">:</span> <span class="s2">"function"</span><span class="p">,</span>
      <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"httpTrigger"</span><span class="p">,</span>
      <span class="nt">"direction"</span><span class="p">:</span> <span class="s2">"in"</span><span class="p">,</span>
      <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"req"</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"http"</span><span class="p">,</span>
      <span class="nt">"direction"</span><span class="p">:</span> <span class="s2">"out"</span><span class="p">,</span>
      <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"$return"</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div></div>

<p>functions の記述は変更がない。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cat</span> <span class="nx">index</span><span class="p">.</span><span class="nx">js</span> 
<span class="kd">let</span> <span class="nx">msRestAzure</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ms-rest-azure'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'lodash'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'JavaScript HTTP trigger function processed a request.'</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1">// status: 200, /* Defaults to 200 */</span>
            <span class="nx">body</span><span class="o">:</span> <span class="s2">"Hello "</span> <span class="o">+</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">status</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
            <span class="nx">body</span><span class="o">:</span> <span class="s2">"Please pass a name on the query string or in the request body"</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">};</span>
</pre></div></div>

<p>このように、webpack を使うと、ライブラリが１つのファイルにまとめられて、立ち上げが高速課されるようだなぁ。とわかった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />17位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/c27207d4db60f5c04a62">Go の Signed Int の gob バイナリエンコーディングアルゴリズムを理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-25 17:17:09</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Go]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Terraform のプラグイン機構を理解したかったのだが、その過程で、gob を理解しないといけないことがわかった。その時に、解説を読むと、エンコーディングアルゴリズムが出てきたのだが、さっぱり意味がわからなかった。だから、それを理解してみた。結局これを理解するだけで一日ぶち潰れた。その理由として、この辺りの英語を理解する能力がなかったことと、コンピューターサイエンスの基礎となる数学が理解できていなかったことにある。</p>

<p><a href="https://camo.qiitausercontent.com/2d2597ef7a2cf9af1634f2a0d84e6542588ccff5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61393131353763362d396236372d643235312d633937362d3230303331646239356237392e706e67" target="_blank" rel="nofollow noopener"><img width="1115" alt="Screen Shot 2017-09-25 at 1.11.04 AM.png" src="https://camo.qiitausercontent.com/2d2597ef7a2cf9af1634f2a0d84e6542588ccff5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61393131353763362d396236372d643235312d633937362d3230303331646239356237392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a91157c6-9b67-d251-c976-20031db95b79.png"></a></p>

<h1>
<span id="理解したいアルゴリズム" class="fragment"></span><a href="#%E7%90%86%E8%A7%A3%E3%81%97%E3%81%9F%E3%81%84%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0"><i class="fa fa-link"></i></a>理解したいアルゴリズム</h1>

<p>これは、<a href="https://golang.org/pkg/encoding/gob/" rel="nofollow noopener" target="_blank">Package gob</a>の解説に出てくる表現で最初はナンノコッチャと思った。ここは英語力のなさの問題。</p>

<blockquote>
<p>An unsigned integer is sent one of two ways. If it is less than 128, it is sent as a byte with that value. Otherwise it is sent as a minimal-length big-endian (high byte first) byte stream holding the value, preceded by one byte holding the byte count, negated. Thus 0 is transmitted as (00), 7 is transmitted as (07) and 256 is transmitted as (FE 01 00).</p>
</blockquote>

<p>翻訳をするとこんな感じ。</p>

<p>Unsigned integer は、２通りのうち、１通りの方法で送られる。もし、それが128以下なら、バイトの値で送られる。そうでなければ、最短の<a href="http://www.ertl.jp/%7Etakayuki/readings/info/no05.html" rel="nofollow noopener" target="_blank">ビッグエンディアン</a>の値を持ったバイトストリームで送られる。最初の１バイトは、バイトカウントで、無視される。そのため、0 は、(00), 7 は、(07), 256 は、(FE 01 00) として転送される。</p>

<p>英文でうまく理解できなかったのは、 proceded (To begin to carry on an action or a process:) の意味で、最初のバイトという意味合い。negrected は無視されるという意味。おそらくこんな感じ。256 は２バイト必要なので、FEは 16bit だと下記のような２進数になるので、おそらく、Unsigned Int の<code>-2</code> を表す。２の補数に関してはあとで説明する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>-2 byte     = 0000 0000 0000 0010　の２の補数
              1111 1111 1111 1110 = FE
</pre></div></div>

<p>ううむスッキリしない。バイトカウントはマイナスで表現するとは書いてないし。困ったときはコードだ。</p>

<h1>
<span id="gob-のソースを拝見する" class="fragment"></span><a href="#gob-%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%92%E6%8B%9D%E8%A6%8B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>gob のソースを拝見する</h1>

<p>ここのソースを参考に自分なりにサンプルを書いてみる。該当部分のコードを書いてみた。<br>
<a href="https://github.com/golang/go/blob/master/src/encoding/gob/encode.go" rel="nofollow noopener" target="_blank">encode.go</a></p>

<p>ポイントは下記の部分。ここをしっかり理解する。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">getUnsignedInt</span><span class="p">(</span><span class="nx">x</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>　　<span class="c1">// 1. 配列の確保</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span>
    <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="mh">0x7F</span> <span class="p">{</span>          <span class="c1">// 128 以下のケース</span>
        <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nb">byte</span><span class="p">(</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">b</span>
    <span class="p">}</span>
    <span class="nx">binary</span><span class="p">.</span><span class="nx">BigEndian</span><span class="p">.</span><span class="nx">PutUint64</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nx">x</span><span class="p">)</span>  <span class="c1">// 2. ビックエンディアンでバイト化</span>
    <span class="nx">a</span> <span class="o">:=</span> <span class="nx">bits</span><span class="p">.</span><span class="nx">LeadingZeros64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>             <span class="c1">// 3. 先頭の0のビットを取得</span>
    <span class="nx">bc</span> <span class="o">:=</span> <span class="nx">a</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>                            <span class="c1">// 4. 8 で割って 先頭バイトを取得</span>
    <span class="nx">buf</span><span class="p">[</span><span class="nx">bc</span><span class="p">]</span> <span class="p">=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nx">bc</span> <span class="o">-</span> <span class="nx">uint64Size</span><span class="p">)</span>        <span class="c1">// 5. 先頭バイトにバイトサイズを格納</span>
    <span class="nx">data</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[</span><span class="nx">bc</span> <span class="p">:</span> <span class="nx">uint64Size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>           <span class="c1">// 6. 別のバイトに、先頭バイトからのスライスを移送</span>
    <span class="k">return</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">data</span>
<span class="p">}</span>
</pre></div></div>

<p>の部分。こいつをデバッガで動作をみながら理解する。128 以下のケースは単純に８ビットに格納しているだけなので、難しさはない。</p>

<h2>
<span id="1-配列の確保" class="fragment"></span><a href="#1-%E9%85%8D%E5%88%97%E3%81%AE%E7%A2%BA%E4%BF%9D"><i class="fa fa-link"></i></a>1. 配列の確保</h2>

<p>最初に配列の確保をしている。これは、Int が様々なサイズがあるが、そのサイズ+1 の配列を確保している。例えば、64bit のUnsigned Int なら、8バイトだが、それプラス１バイトにしている。つまり、バイトサイズを入れるところを確保している</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>□　□□□□　□□□□
↑先頭はバイトサイズ＋Int64 の最大値8バイトを確保
</pre></div></div>

<h2>
<span id="2-ビックエンディアンでバイト化" class="fragment"></span><a href="#2-%E3%83%93%E3%83%83%E3%82%AF%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%82%A2%E3%83%B3%E3%81%A7%E3%83%90%E3%82%A4%E3%83%88%E5%8C%96"><i class="fa fa-link"></i></a>2. ビックエンディアンでバイト化</h2>

<p>今回、<code>256</code> を代入するとどうなるかを考える。</p>

<p><code>256</code> を 16ビットで考えるとこんな感じ。Int64 はこれで、先頭に、0000 が埋められれている感じ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0b`0000 0001 0000 0000` 0x0100
</pre></div></div>

<p><a>binary.BigEndian.PutUint64(buf[1:], x) </a>は、64ビットの1バイト目から、バッファに、値を詰める。最初の１バイトは、バイトサイズだから故意にスキップしている。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>□　□□□□　□□■■

0x00  0x00 0x00 0x00 0x00  0x00 0x00 0x01 0x00
</pre></div></div>

<p>といった感じでデータがセットされる。</p>

<h2>
<span id="3-先頭の0のビットを取得" class="fragment"></span><a href="#3-%E5%85%88%E9%A0%AD%E3%81%AE0%E3%81%AE%E3%83%93%E3%83%83%E3%83%88%E3%82%92%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>3. 先頭の0のビットを取得</h2>

<p><a href="https://godoc.org/math/bits#LeadingZeros64" rel="nofollow noopener" target="_blank">a := bits.LeadingZeros64(x) </a> は、先頭の使っていないビットを取得する。例えば、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>bits.LeadingZero64(0) = 64
bits.LeadingZero63(0) = 63
</pre></div></div>

<p>こんな感じ。ちなみに、<code>x=256</code> の時の値は<code>55</code>になっている。</p>

<h2>
<span id="4-8-で割って-先頭バイトを取得" class="fragment"></span><a href="#4-8-%E3%81%A7%E5%89%B2%E3%81%A3%E3%81%A6-%E5%85%88%E9%A0%AD%E3%83%90%E3%82%A4%E3%83%88%E3%82%92%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>4. 8 で割って 先頭バイトを取得</h2>

<p>これは、あくまで２進数なので、今欲しいのは、先頭の空きバイト数が欲しい。８で割っても良いが、<code>&gt;&gt; 3</code> のシフトを使って、それを表現する。すると、値は、6 になる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>□　□□□□　□□■■
　　　　　　↑ここ
</pre></div></div>

<p>つまり、先頭のバイトサイズを格納する領域をのぞいて、先頭バイトの位置を出している。</p>

<h2>
<span id="5-先頭バイトにバイトサイズを格納" class="fragment"></span><a href="#5-%E5%85%88%E9%A0%AD%E3%83%90%E3%82%A4%E3%83%88%E3%81%AB%E3%83%90%E3%82%A4%E3%83%88%E3%82%B5%E3%82%A4%E3%82%BA%E3%82%92%E6%A0%BC%E7%B4%8D"><i class="fa fa-link"></i></a>5. 先頭バイトにバイトサイズを格納</h2>

<p>uint64Size は、uint64 のバイトサイズ。つまり８バイト。ここで、先ほど取得した、先頭のバイト（６バイト目）から、全体のバイト数（８バイト）を引いている。つまり、<code>-2</code> になる。バイトサイズは、つまり、UnsignInt の全体バイト数から、使っているバイト数を引いた値になるので、マイナス値になる。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="nx">buf</span><span class="p">[</span><span class="nx">bc</span><span class="p">]</span> <span class="p">=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nx">bc</span> <span class="o">-</span> <span class="nx">uint64Size</span><span class="p">)</span> 
</pre></div></div>

<p>バイトサイズは</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>-2 = 2 の 2 の補数 = 
2:       0000 0010
2の補数:  1111 1110　 (0xFE)
</pre></div></div>

<p>さらに、もう一点、ポイントがあって、そのバイトサイズの値を、bc (先頭からのバイト数）のバッファに格納している。 つまり格納されたサイズの一つ手前のバイトに格納している。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>□　□□□□　□○■■ 0x00  0x00 0x00 0x00 0x00  0x00 0xFE 0x01 0x00
　　　　　 ↑ここ
</pre></div></div>

<h2>
<span id="6-別のバイトに先頭バイトからのスライスを移送" class="fragment"></span><a href="#6-%E5%88%A5%E3%81%AE%E3%83%90%E3%82%A4%E3%83%88%E3%81%AB%E5%85%88%E9%A0%AD%E3%83%90%E3%82%A4%E3%83%88%E3%81%8B%E3%82%89%E3%81%AE%E3%82%B9%E3%83%A9%E3%82%A4%E3%82%B9%E3%82%92%E7%A7%BB%E9%80%81"><i class="fa fa-link"></i></a>6. 別のバイトに、先頭バイトからのスライスを移送</h2>

<p>bc の位置から、最後までを移送している</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="nx">data</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[</span><span class="nx">bc</span> <span class="p">:</span> <span class="nx">uint64Size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>buf
□　□□□□　□○■■ 0x00  0x00 0x00 0x00 0x00  0x00 0xFE 0x01 0x00
　　　　　 ↑ここ
data
○■■ 0xFE 0x01 0x00
</pre></div></div>

<p>これで、この仕様のエンコードの方法が理解できました。</p>

<p>全体のコードを書いておきます。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">getUnsignedInt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"%x"</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span> <span class="o">:=</span> <span class="nx">getUnsignedInt</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"%x"</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">d</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"%x"</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">uint64Size</span> <span class="p">=</span> <span class="mi">8</span>

<span class="kd">func</span> <span class="nx">getUnsignedInt</span><span class="p">(</span><span class="nx">x</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span>
    <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="mh">0x7F</span> <span class="p">{</span>
        <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nb">byte</span><span class="p">(</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">b</span>
    <span class="p">}</span>
    <span class="nx">binary</span><span class="p">.</span><span class="nx">BigEndian</span><span class="p">.</span><span class="nx">PutUint64</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nx">x</span><span class="p">)</span>
    <span class="nx">a</span> <span class="o">:=</span> <span class="nx">bits</span><span class="p">.</span><span class="nx">LeadingZeros64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="nx">bc</span> <span class="o">:=</span> <span class="nx">a</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
    <span class="nx">buf</span><span class="p">[</span><span class="nx">bc</span><span class="p">]</span> <span class="p">=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nx">bc</span> <span class="o">-</span> <span class="nx">uint64Size</span><span class="p">)</span>
    <span class="nx">data</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[</span><span class="nx">bc</span> <span class="p">:</span> <span class="nx">uint64Size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">data</span>
<span class="p">}</span>

</pre></div></div>

<h1>
<span id="signed-int-のエンコーディング" class="fragment"></span><a href="#signed-int-%E3%81%AE%E3%82%A8%E3%83%B3%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>Signed Int のエンコーディング</h1>

<p>次がもっとも辛かったパート。やっと理解できましたので、解説します。</p>

<blockquote>
<p>A signed integer, i, is encoded within an unsigned integer, u. Within u, bits 1 upward contain the value; bit 0 says whether they should be complemented upon receipt. The encode algorithm looks like this:</p>
</blockquote>

<p>Signed Integer i は、Unsigned Integer u として、エンコードされます。uの中で、1ビット目とそれ以上は、値を持っています。ビット０は、補数にするかいなかを決めます。アルゴリズムは次のようです。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">u</span> <span class="kt">uint</span>
<span class="k">if</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">u</span> <span class="p">=</span> <span class="p">(^</span><span class="nb">uint</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">|</span> <span class="mi">1</span> <span class="c1">// complement i, bit 0 is 1</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">u</span> <span class="p">=</span> <span class="p">(</span><span class="nb">uint</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// do not complement i, bit 0 is 0</span>
<span class="p">}</span>
<span class="nx">encodeUnsigned</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span>
</pre></div></div>

<blockquote>
<p>The low bit is therefore analogous to a sign bit, but making it the complement bit instead guarantees that the largest negative integer is not a special case. For example, -129=^128=(^256&gt;&gt;1) encodes as (FE 01 01).</p>
</blockquote>

<p>０ビット目はだから、符号ビットのようなものです。しかし、補数化することによって、最大の負の整数が、スペシャルケースにならないようにしています。例えば、<code>-129</code>は<code>^128</code>であり、<code>^256&gt;&gt;1</code>でエンコード化した結果は (FE 01 01)です。</p>

<p>なんだこれは、、、ガチで意味がわからない、、、文書を読んでも全くわからない。Facebook の友達とやりとりして、私は、そもそも、２の歩数がわかっていないとわかりました。</p>

<h1>
<span id="補数について学ぶ" class="fragment"></span><a href="#%E8%A3%9C%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E5%AD%A6%E3%81%B6"><i class="fa fa-link"></i></a>補数について学ぶ</h1>

<p>ちなみに、補数に関しては、この方のブログが最高でした。</p>

<ul>
<li><a href="http://d.hatena.ne.jp/simply-k/20100824/1282743815" rel="nofollow noopener" target="_blank">2の補数を理解する (1)</a></li>
</ul>

<h2>
<span id="1-の補数1s-complement" class="fragment"></span><a href="#1-%E3%81%AE%E8%A3%9C%E6%95%B01s-complement"><i class="fa fa-link"></i></a>1 の補数　(1s complement)</h2>

<p>補数には２種類あります。例えば８ビットの表現での１の補数は、ビットを反転した値になります。１の補数の意味は、ある値に対して、その補数を足すと、ギリギリ桁が増えないという値です。</p>

<p>例えば</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0010 1110 0x0A 0xBA
</pre></div></div>

<p>の１の補数は</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1101 0001 0xB1 0x01
</pre></div></div>

<p>になります。２つを足すと</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1111 1111 0xFF 0xFF
</pre></div></div>

<p>になり、桁あふれしない最大数になっています。</p>

<h2>
<span id="2-の補数-2s-complement" class="fragment"></span><a href="#2-%E3%81%AE%E8%A3%9C%E6%95%B0-2s-complement"><i class="fa fa-link"></i></a>2 の補数 (2s complement)</h2>

<p>２の補数は、足したら、桁あふれする数です。つまり</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0010 1110
</pre></div></div>

<p>の２の補数は、先ほどの１の補数に対して、１を足せば求められます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1101 0001 + 1 = 
1101 0010
</pre></div></div>

<p>二つを足すと</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1 0000 0000
</pre></div></div>

<p>になります。これは、2のn(ビットの桁数）ここでは、２の８乗になります。この値になるようなものが、２の補数です。</p>

<h2>
<span id="2-の補数の用途" class="fragment"></span><a href="#2-%E3%81%AE%E8%A3%9C%E6%95%B0%E3%81%AE%E7%94%A8%E9%80%94"><i class="fa fa-link"></i></a>2 の補数の用途</h2>

<p>２の補数は、Signed Int　でマイナスの値を表すのに使われます。SignedInt では、先頭１ビットが、符号ビットになり、<code>0</code> ならば、正の数、<code>1</code>ならば負の数としてバイナリが表現されます。</p>

<p>例えばこんな感じ</p>

<p>-127 のバイナリを求めたい時は、127 の２の補数を求めます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0111 1111 (127)
1000 0001 (-127) ２の補数
</pre></div></div>

<p>とても、簡単です。さらに、なぜこんなことをするかというと、色々都合が良いのです。例えば、計算をするとすると</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>10 - 127 を計算するとすると 10 + (-127) になりますので、

  0000 1010 (10)
+ 1000 0001 (-127)
-------------------
  1000 1011 (-117)
</pre></div></div>

<p>ちなみに、性質上、２の補数から、その２の補数を求めると、元の数になります。１の補数も同じです。</p>

<p>だからこの場合、あっているかは、２の補数を求めてみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>  1000 1011 (-127)
  0111 0101 (117)
</pre></div></div>

<p>完璧ですね。このため、この表現を使うことによって、電子回路で演算子を作るときに、マイナスの回路を組まなくてもよくなります。</p>

<h2>
<span id="１６ビットの演算" class="fragment"></span><a href="#%EF%BC%91%EF%BC%96%E3%83%93%E3%83%83%E3%83%88%E3%81%AE%E6%BC%94%E7%AE%97"><i class="fa fa-link"></i></a>１６ビットの演算</h2>

<blockquote>
<p>For example, -129=^128=(^256&gt;&gt;1) encodes as (FE 01 01).</p>
</blockquote>

<p>とか言っていましたが、上記の理屈が理解できても、この理屈はさっぱり理解できません。なんで、-129 が、<code>01 01</code> になるんだろう、、、、補数は、何ビットで考えるを考えないと、値は変わってきますので、多分おそらく、この作者は、16 bit を想定して考えているのだと思います。そして、補数を計算してみましょう。特に、-129なんてどうやって表すんだろう、、、８ビットならわかるけど。だって、先頭ビットの符号をどう考えるのよ。</p>

<p>苦しんでいたら、友人が助けてくれました。</p>

<blockquote>
<p>Harada Kiro 0b1111 1111 1111 1111 = -1 なので、そこから128ひけばよろしい。</p>
</blockquote>

<p>なんでそもそも、これが、<code>-1</code> やねん、、、普通に１６ビットで補数を考えてみよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0000 0000 0000 0001 (1)
1111 1111 1111 1111 (-1)
</pre></div></div>

<p>あ、ほんまや、反転して、１を足したらこれになる。さらに彼は</p>

<blockquote>
<p>Harada Kiro 0b0000000000000000 から、1引くと？</p>
</blockquote>

<p>１の補数をとって、足せばいいから</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0000 0000 0000 0001 (1)
1111 1111 1111 1111 (-1)

 0000 0000 0000 0000 (0)
+1111 1111 1111 1111 (-1)
---------------------
 1111 1111 1111 1111 (-1)

</pre></div></div>

<p>なるほど。</p>

<p>彼は最初に</p>

<blockquote>
<p>Harada Kiro 0b1111111111111111 = -1 なので、そこから128ひけばよろしい。</p>
</blockquote>

<p>と言っていたので、その通りにしてみよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>  0000 0000 1000 0000 (128)
  1111 1111 1000 0000 (-128)

  1111 1111 1111 1111 (-1)
 +1111 1111 1000 0000 (-128)
--------------------------
1 1111 1111 0111 1111 (-129) 
</pre></div></div>

<p>ややこしいですが、先頭の桁が上がりますが、この先頭のビットが同じなので、補数の計算ルールにより、先頭の１は無視できます。これもこのブログが最高</p>

<ul>
<li>
<a href="http://d.hatena.ne.jp/simply-k/20100825/1282743815" rel="nofollow noopener" target="_blank">2の補数を理解する (2)</a> </li>
</ul>

<p>つまり、<code>-129</code> の二進数表現は、<code>0x 1111 1111 0111 1111</code></p>

<blockquote>
<p>For example, -129=^128=(^256&gt;&gt;1) encodes as (FE 01 01).</p>
</blockquote>

<p>さて、これに戻ると、色々謎が出てきます。<code>^128</code> ってなんやねん。という話です。プログラミングの演算の<code>^</code> は、XOR ですが、XOR には、何ビットに対して XOR やねんという問題が生じます。リファレンスを読んでみましょう。</p>

<ul>
<li>
<a href="https://www.tutorialspoint.com/go/go_operators.htm" rel="nofollow noopener" target="_blank">Go - Operators</a> </li>
</ul>

<p>これを見ると</p>

<blockquote>
<p>^ Binary XOR Operator copies the bit if it is set in one operand but not both.    (A ^ B) will give 49, which is 0011 0001</p>
</blockquote>

<p>と書いてあります。単独で使った場合は、よくわかりませんが、Int32 ならその範囲、Int64 ならその範囲で XOR と思われます。つまりこの場合は、筆者は、１６ビットを想定しているはず。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1111 1111 0111 1111 (-129)
0000 0000 1000 0000 (128)
1111 1111 0111 1111 (^128 = 128 XOR 0x FFFFFFFF)

0000 0001 0000 0000 (256)
1111 1110 1111 1111 (^256) 
1111 1111 0111 1111 (^256 &gt;&gt; 1)
</pre></div></div>

<p>確かに。で、なんで、それが、<code>(FE 01 01)</code> になるのよ。</p>

<ul>
<li><a href="http://www.geocities.jp/zaqzaqpa/2sinsuu11.htm" rel="nofollow noopener" target="_blank">算術シフト演算</a></li>
</ul>

<blockquote>
<p>Signed Integer i は、Unsigned Integer u として、エンコードされます。uの中で、1ビット目とそれ以上は、値を持っています。ビット０は、補数にするかいなかを決めます。アルゴリズムは次のようです。</p>
</blockquote>

<p>と言っていますので、普通と反対で、このエンコーディングでは、０ビット目が符号ビットみたいな役割になっている様子です。ちなみに、先ほど添付したコードは動きませんので、本家のコードをみてみました。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="c1">// encodeInt writes an encoded signed integer to state.w.</span>
<span class="c1">// The low bit of the encoding says whether to bit complement the (other bits of the)</span>
<span class="c1">// uint to recover the int.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">state</span> <span class="o">*</span><span class="nx">encoderState</span><span class="p">)</span> <span class="nx">encodeInt</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="kt">uint64</span>
    <span class="k">if</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">x</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(^</span><span class="nx">i</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">|</span> <span class="mi">1</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">x</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">encodeUint</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div>

<p>プラスの場合は簡単で、 値を、単に左シフトしています。一番右のビットが０だと正の数なので例えば、129 だと</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0000 0000 1000 0001 (129)
を左シフトするので
0000 0001 0000 0010 (シフト後)
</pre></div></div>

<p>なるほど、これだと、デコードの時も、シフトしたら終わりですね。</p>

<p>じゃあ次に、負の数。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>x = uint64(^i&lt;&lt;1) | 1
</pre></div></div>

<p>をまず理解する必要があります。実験により、<code>^</code> は、１の補数とわかりました。それに対して、<code>&lt;&lt;1</code>シフトをしています。ここは、先ほどと同じです。 <code>| 1</code> はなんでしょうか？</p>

<blockquote>
<p>Bitwise OR    |</p>
</blockquote>

<ul>
<li>
<a href="https://www.tutorialspoint.com/go/go_operators.htm" rel="nofollow noopener" target="_blank">Go - Operators</a> </li>
</ul>

<p>とあります。つまり、1 のORなので、意味合いとしては、０のビットを１にするということですね。<br>
やってみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>1111 1111 0111 1111 (-129)
0000 0000 1000 0000 (^-129)
0000 0001 0000 0000 (&lt;&lt; 1)
0000 0001 0000 0001 (| 1) = OR 1

= 0x01 01

</pre></div></div>

<p>おー、やっとわかったわー。しかし長すぎた、、、、わしは、terraform のアーキテクチャを理解したいだけなのに、何故こうなった、、、</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>１日丸々深夜まで、たった一つのことを理解するのに時間を費やしてしまいました。なんでこんなことになったのでしょう。１つは英語力です。日本で数学を学んだので、数学の用語がわからなかったので、意味が取れていなかったということがあります。もう一方で、数学の知識です。２の補数とか、そんなの習ったかなぁぐらい、少なくともさっぱり忘れていました。もしくは知りませんでした。<br>
　最後に、Kiro さんをはじめ、助けてくださった人のおかげなのですが、ここまで困ったときは、もっと素直に人に相談すればよかったかもしれません。最後のTipsなのですが、最終的にここのgob のマニュアルに書いてあったことを理解できたのは、上記の全てももちろん重要ですが、最後は、コードを読みました。やっぱコードが一番確実です。色々試行錯誤コードを書いたり、何故<code>FE</code>になるのかの確信が持てたのも、コードを書いて、デバッグツールを使って、値を確かめたから、意味が理解できました。デバッガ最高！やっぱりコードだけは嘘つきません。</p>

<p>次はやっと、gob に到達できる、、、（本当は、terraform の pluginの仕組みを理解したかったりするだけなのですが)</p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://golang.org/pkg/encoding/gob/" rel="nofollow noopener" target="_blank">Package gob</a></li>
<li><a href="http://www.ertl.jp/%7Etakayuki/readings/info/no05.html" rel="nofollow noopener" target="_blank">ビッグエンディアン</a></li>
<li><a href="https://github.com/golang/go/blob/master/src/encoding/gob/encode.go" rel="nofollow noopener" target="_blank">encode.go</a></li>
<li><a href="http://d.hatena.ne.jp/simply-k/20100824/1282743815" rel="nofollow noopener" target="_blank">2の補数を理解する (1)</a></li>
<li>
<a href="http://d.hatena.ne.jp/simply-k/20100825/1282743815" rel="nofollow noopener" target="_blank">2の補数を理解する (2)</a> </li>
<li>
<a href="https://www.tutorialspoint.com/go/go_operators.htm" rel="nofollow noopener" target="_blank">Go - Operators</a> </li>
<li><a href="http://www.geocities.jp/zaqzaqpa/2sinsuu11.htm" rel="nofollow noopener" target="_blank">算術シフト演算</a></li>
<li><a href="https://gist.github.com/TsuyoshiUshio/22fc9f3af0b927d6191ef1bf7e77b46e" rel="nofollow noopener" target="_blank">自分が格闘したコード Gistに置いた</a></li>
</ul>

<h1>
<span id="補足" class="fragment"></span><a href="#%E8%A3%9C%E8%B6%B3"><i class="fa fa-link"></i></a>補足</h1>

<p>Takashi Okawa さんが、単項の <code>^</code> 演算子の仕様について、Go の言語仕様に書いてあることを教えてくれました。ここのページで、<code>^</code> で検索するといいです。<br>
* <a href="http://golang.jp/go_spec#Operators" rel="nofollow noopener" target="_blank">Go プログラミング言語仕様</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />18位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/9879ea04cdd606982a65">VSCode + Typescript でデバッグを有効にする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-24 00:51:26</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> <b>[VSCode]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>タイプスクリプトで作っているプロジェクトで、VSCode でデバッグを有効にしてみたかったので、やってみた。</p>

<h1>
<span id="sourcemap" class="fragment"></span><a href="#sourcemap"><i class="fa fa-link"></i></a>SourceMap</h1>

<p>tsconfigに SourceMap の定義を有効にする。これにより <code>*.js.map</code> ファイルができて、ブレークポイントが設置できるようになる。</p>

<p><em>tsconfig.json</em></p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">"compilerOptions"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"target"</span><span class="p">:</span> <span class="s2">"es6"</span><span class="p">,</span>
        <span class="nt">"module"</span><span class="p">:</span> <span class="s2">"commonjs"</span><span class="p">,</span>
        <span class="nt">"sourceMap"</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div></div>

<h1>
<span id="launchjson" class="fragment"></span><a href="#launchjson"><i class="fa fa-link"></i></a>Launch.json</h1>

<p>VSCode のDebug から下記のようにして新しいデバッグの定義を作る。<br>
<a href="https://camo.qiitausercontent.com/5518dad005d5d6871d937f02ec4cf4e4cb102a7b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36636330613636342d623935382d363163382d333836362d6536303862373165353865332e706e67" target="_blank" rel="nofollow noopener"><img width="352" alt="01.png" src="https://camo.qiitausercontent.com/5518dad005d5d6871d937f02ec4cf4e4cb102a7b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36636330613636342d623935382d363163382d333836362d6536303862373165353865332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/6cc0a664-b958-61c8-3866-e608b71e58e3.png"></a><br>
Node-Mocha を選択してテンプレを作る。</p>

<p><code>launch.json</code> ができるので次のようにしてみる。</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="err">//</span> <span class="err">Use</span> <span class="err">IntelliSense</span> <span class="err">to</span> <span class="err">learn</span> <span class="err">about</span> <span class="err">possible</span> <span class="err">attributes.</span>
    <span class="err">//</span> <span class="err">Hover</span> <span class="err">to</span> <span class="err">view</span> <span class="err">descriptions</span> <span class="err">of</span> <span class="err">existing</span> <span class="err">attributes.</span>
    <span class="err">//</span> <span class="err">For</span> <span class="err">more</span> <span class="err">information,</span> <span class="err">visit:</span> <span class="err">https://go.microsoft.com/fwlink/?linkid=830387</span>
    <span class="nt">"version"</span><span class="p">:</span> <span class="s2">"0.2.0"</span><span class="p">,</span>
    <span class="nt">"configurations"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"node"</span><span class="p">,</span>
            <span class="nt">"request"</span><span class="p">:</span> <span class="s2">"launch"</span><span class="p">,</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"Mocha Tests(k8s tasks)"</span><span class="p">,</span>
            <span class="nt">"program"</span><span class="p">:</span> <span class="s2">"${workspaceFolder}/node_modules/mocha/bin/_mocha"</span><span class="p">,</span>
            <span class="nt">"preLaunchTask"</span><span class="p">:</span> <span class="s2">"Typescipt compile"</span><span class="p">,</span>
            <span class="nt">"args"</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">"-u"</span><span class="p">,</span>
                <span class="s2">"tdd"</span><span class="p">,</span>
                <span class="s2">"--timeout"</span><span class="p">,</span>
                <span class="s2">"999999"</span><span class="p">,</span>
                <span class="s2">"--colors"</span><span class="p">,</span>
                <span class="s2">"${workspaceFolder}/Tests/L*.js"</span>
            <span class="p">],</span>
            <span class="nt">"internalConsoleOptions"</span><span class="p">:</span> <span class="s2">"openOnSessionStart"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"node"</span><span class="p">,</span>
            <span class="nt">"request"</span><span class="p">:</span> <span class="s2">"launch"</span><span class="p">,</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"Launch Program"</span><span class="p">,</span>
            <span class="nt">"program"</span><span class="p">:</span> <span class="s2">"${file}"</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div></div>

<p>ポイントを説明する</p>

<table>
<thead>
<tr>
<th style="text-align: left">名前</th>
<th style="text-align: left">意味</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">type</td>
<td style="text-align: left">デバッガーのタイプ。node はビルドイン</td>
</tr>
<tr>
<td style="text-align: left">request</td>
<td style="text-align: left">ランチの設定。launch か attach</td>
</tr>
<tr>
<td style="text-align: left">name</td>
<td style="text-align: left">タスクの名前</td>
</tr>
<tr>
<td style="text-align: left">program</td>
<td style="text-align: left">実行するプログラム</td>
</tr>
<tr>
<td style="text-align: left">preLaunchTask</td>
<td style="text-align: left">デバッグの前に実行するタスク。<code>task.json</code> で定義されたもの</td>
</tr>
<tr>
<td style="text-align: left">args</td>
<td style="text-align: left">プログラムの引数</td>
</tr>
<tr>
<td style="text-align: left">internalConsoleOptions</td>
<td style="text-align: left">デバッグコンソールのオプション</td>
</tr>
</tbody>
</table>

<ul>
<li><a href="https://code.visualstudio.com/docs/editor/debugging" rel="nofollow noopener" target="_blank">debugging </a></li>
</ul>

<p>ほとんどは、Node-Mocha のテンプレートのままで大丈夫だが、できれば、typescript のコンパイルがかかるようにしたかったので、preLaunchTask を設定している。preLaunchTask は</p>

<h1>
<span id="custom-task-を作成する" class="fragment"></span><a href="#custom-task-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Custom Task を作成する</h1>

<ul>
<li><a href="https://code.visualstudio.com/docs/editor/tasks" rel="nofollow noopener" target="_blank">Custom Tasks</a></li>
</ul>

<p>で説明されているタスクを作る。<code>Ctrl+Shift+P</code> でConfigureTaskを選んで、てきとうにタスクを選んでみる。すると、.vscode/task.json ができる。<br>
それを次のようにする。先ほどのデバッグのぺーじにずばりがあったので、ちょっとだけ改造した。この名前と、さっきの、<code>preLaunchTask</code> を同じにする。</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="err">//</span> <span class="err">See</span> <span class="err">https://go.microsoft.com/fwlink/?LinkId=733558</span>
    <span class="err">//</span> <span class="err">for</span> <span class="err">the</span> <span class="err">documentation</span> <span class="err">about</span> <span class="err">the</span> <span class="err">tasks.json</span> <span class="err">format</span>
    <span class="nt">"version"</span><span class="p">:</span> <span class="s2">"2.0.0"</span><span class="p">,</span>
    <span class="nt">"tasks"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">"label"</span><span class="p">:</span> <span class="s2">"Typescipt compile"</span><span class="p">,</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"shell"</span><span class="p">,</span>
            <span class="nt">"command"</span><span class="p">:</span> <span class="s2">"tsc -p ."</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

</pre></div></div>

<h1>
<span id="デバッグ" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0"><i class="fa fa-link"></i></a>デバッグ</h1>

<p>これでデバッグ環境構築完了。いい感じね。</p>

<p><a href="https://camo.qiitausercontent.com/2818df53e50cc3a10aba47b614b8e9637a0ca986/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39663865663634622d383133312d636434382d393961652d3630613931366332316336662e706e67" target="_blank" rel="nofollow noopener"><img width="1364" alt="03.png" src="https://camo.qiitausercontent.com/2818df53e50cc3a10aba47b614b8e9637a0ca986/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39663865663634622d383133312d636434382d393961652d3630613931366332316336662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/9f8ef64b-8131-cd48-99ae-60a916c21c6f.png"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />19位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/ed8292373a88786a0a64">Logic Apps を Configuration as Code する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-06 01:46:00</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[AzureResourceManager]</b> <b>[logicapps]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Logic Apps を画面からポチポチ作るのは楽勝だが、これを再作成するためのスクリプトを作成するためにはどうしたらいいだろう？ CI/CDもやってみたいだろう。</p>

<h1>
<span id="戦略を考える" class="fragment"></span><a href="#%E6%88%A6%E7%95%A5%E3%82%92%E8%80%83%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>戦略を考える</h1>

<p>既に既存の Logic Apps があるが、これをどうやって、デプロイ可能にしたらいいだろう。ポータルでポチポチ作成したものを元に作成は可能だ。Logic Apps の設定はARMテンプレートのフォーマットになっていて、実際にデプロイは、ARM テンプレートにこのCode View の内容を入れて Deploy すればよい。ただ問題がある。</p>

<p><a href="https://camo.qiitausercontent.com/fb34ca1b6cf697f649f2ad59ac252620f8774e8c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30363333376465352d376662362d643335632d393664382d3734373261623430323961322e706e67" target="_blank" rel="nofollow noopener"><img width="1137" alt="2017-11-06_01h03_32.png" src="https://camo.qiitausercontent.com/fb34ca1b6cf697f649f2ad59ac252620f8774e8c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30363333376465352d376662362d643335632d393664382d3734373261623430323961322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/06337de5-7fb6-d35c-96d8-7472ab4029a2.png"></a></p>

<p>すでに、作成されたLogic Apps では、様々な情報が直接ここに埋め込まれている。だから、そのまま他の環境にデプロイできるようなテンプレートにするためにはクレンジングしないといけない。<br>
　もしそれを手作りでやるとなると、ここの内容をコピーして、ハードコードで書いている部分をパラメータ化するように変えて、これを、Logic Appsをデプロイするときに、Automation Script のリンクから得られる<code>template.json</code> にはめ込めばよい。技術的には。ただ、Logic Apps で変更が入った時に毎回このオペレーションをやっていたらやってられないだろう。</p>

<h1>
<span id="お勧めのソリューション" class="fragment"></span><a href="#%E3%81%8A%E5%8B%A7%E3%82%81%E3%81%AE%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>お勧めのソリューション</h1>

<p>私は Serverless Conf のキーノートのデモを結構つくったのだが、その中にLogic App を含んでいた。しかし、それは、コード化していないので、リポジトリに乗せていなかったので、乗せたくなった。また自動でデプロイできるようにしたい。しかも変更しやすくしたい。ブランチを作ってみた。</p>

<ul>
<li><a href="https://github.com/Azure-Samples/customer-car-reviews/tree/feature/SPAbackendLogicApps/CarReviews/logicapps/CreateCar/CarReviewDemos" rel="nofollow noopener" target="_blank">customer-car-reviews/CarReviews/logicapps/CreateCar/</a></li>
</ul>

<p>私は普段は Mac 使いだがこのケースに限ってはWindows に Visual Studio (多分 Community でも良い) をぶち込んで、Logic Apps Tools を extension として追加してそれを使う方法がおすすめだ。いったんリポジトリに入ってしまえば、<code>template.json</code> <code>parameter.json</code> という JSON ファイルになるので、Mac だろうが、Linux だろうがデプロイできるようになる。ただ、Logic Apps のメンテはポータルではなく、Visual Studio からやるのが一番かっこよく出来る。理由は下記の通り</p>

<ul>
<li>テンプレートが常にデプロイ可能なものがバックエンドで生成される</li>
<li>ポータルと全く同じ操作性でLogic Apps を作成できる</li>
<li>強力すぎるインテリセンス</li>
</ul>

<p>Mac の Visual Studio でも Logic Apps Tools がサポートされたらそっちに乗り換えるといいだろう。現時点では、最高の方法はVSで Logic Apps を開発するのが良い。それをGit などにシェアするとデプロイ自体はどの環境でも出来る。だから、チームで一台だけ Windows マシンを用意しておけばよいだろう。</p>

<h1>
<span id="vs-での開発とマイグレーションの様子" class="fragment"></span><a href="#vs-%E3%81%A7%E3%81%AE%E9%96%8B%E7%99%BA%E3%81%A8%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E6%A7%98%E5%AD%90"><i class="fa fa-link"></i></a>VS での開発とマイグレーションの様子</h1>

<p>実際に私が簡単な Logic App を VSのものにマイグレーションした作戦を共有したい。最初に、既存の Logic App の Code view から、コード自体は取得しておくのが良い。次に Logic Apps Tools をインストールして、普通にプロジェクトを作成する。</p>

<p>Logic App Tools のインストールは、Visual Studio の <code>Tools/Extensions and Updates...</code> から、<code>Logic Apps Tools</code> を選んで入れると良い。詳細は<a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-deploy-from-vs" rel="nofollow noopener" target="_blank">こちら</a></p>

<h1>
<span id="編集作業" class="fragment"></span><a href="#%E7%B7%A8%E9%9B%86%E4%BD%9C%E6%A5%AD"><i class="fa fa-link"></i></a>編集作業</h1>

<p>Resource Group の開発を選ぶと、Logic Apps が選べるようになっている。プロジェクトを作って、<code>LogicApp.json</code>を右クリックし、 <code>Open with Logic App Designer</code> を選ぶ</p>

<p><a href="https://camo.qiitausercontent.com/b70cfd69a5606f7155095bb1fb9089ab4a731952/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36343634303361642d653936392d616363632d633436352d3961656535306461383361332e706e67" target="_blank" rel="nofollow noopener"><img width="348" alt="002.png" src="https://camo.qiitausercontent.com/b70cfd69a5606f7155095bb1fb9089ab4a731952/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36343634303361642d653936392d616363632d633436352d3961656535306461383361332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/646403ad-e969-accc-c465-9aee50da83a3.png"></a></p>

<p>すると、ポータルで見たのと同じ画面が、同じ操作性で登場する。これ凄い。こちらの画面もコードを見ることができるので、先ほどPortal で取得した json を必要な部分はコピーして作成する。ここでは、めんどくさいスキーマの部分は、私は Portal からコピーした。ハードコードのIDなどが入っているわけではないからだ。</p>

<p><a href="https://camo.qiitausercontent.com/3779a3d71cdf556f8486d367a18c01ab3c1bd37e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63656362626466662d383862652d373963362d643564632d6331653366623962613033642e706e67" target="_blank" rel="nofollow noopener"><img width="1368" alt="03.png" src="https://camo.qiitausercontent.com/3779a3d71cdf556f8486d367a18c01ab3c1bd37e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63656362626466662d383862652d373963362d643564632d6331653366623962613033642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/cecbbdff-88be-79c6-d5dc-c1e3fb9ba03d.png"></a></p>

<h2>
<span id="デプロイ" class="fragment"></span><a href="#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4"><i class="fa fa-link"></i></a>デプロイ</h2>

<p>試しにここから Azure にデプロイしてみよう。プロジェクトを右クリックすると、Deploy出来るようになっているので、サブスクリプションいれたりして、デプロイしよう。</p>

<p><a href="https://camo.qiitausercontent.com/3a1279411feb7b98aee6629282839cbb34f2e891/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37383064613834642d366266662d656263622d316466632d6431633636643734643839392e706e67" target="_blank" rel="nofollow noopener"><img width="397" alt="04.png" src="https://camo.qiitausercontent.com/3a1279411feb7b98aee6629282839cbb34f2e891/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37383064613834642d366266662d656263622d316466632d6431633636643734643839392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/780da84d-6bff-ebcb-1dfc-d1c66d74d899.png"></a></p>

<p>出来ている。同じのが Azure に</p>

<p><a href="https://camo.qiitausercontent.com/577e4932b5ae51d4e06836d24eb5f25c4c2a5617/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37306432653638652d353832392d393234372d636166362d3439616130373239353438352e706e67" target="_blank" rel="nofollow noopener"><img width="1108" alt="05.png" src="https://camo.qiitausercontent.com/577e4932b5ae51d4e06836d24eb5f25c4c2a5617/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37306432653638652d353832392d393234372d636166362d3439616130373239353438352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/70d2e68e-5829-9247-caf6-49aa07295485.png"></a></p>

<p>全く同じ</p>

<p><a href="https://camo.qiitausercontent.com/4799172fd07da766c4e6877a70afc7edae671153/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38393661666562662d366636352d356163612d313831332d3537303538373338636339392e706e67" target="_blank" rel="nofollow noopener"><img width="1368" alt="06.png" src="https://camo.qiitausercontent.com/4799172fd07da766c4e6877a70afc7edae671153/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38393661666562662d366636352d356163612d313831332d3537303538373338636339392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/896afebf-6f65-5aca-1813-57058738cc99.png"></a></p>

<p>あとは、ここで作成したものをGitリポジトリに格納して終わり。これで、継続的デリバリで自動的に Logic Apps デプロイでもなんでも可能だ。そうやって作ったコードを貼っておく。VSのプロジェクトを作るときに、ちゃんとGitリポジトリを作成するチェックを入れておくと、git init が実行されて、.gitignore が作られるので、それを入れておけば、シークレット系も安心ですね。</p>

<ul>
<li><a href="https://github.com/Azure-Samples/customer-car-reviews/tree/feature/SPAbackendLogicApps/CarReviews/logicapps/CreateCar" rel="nofollow noopener" target="_blank">Logic Apps ARMテンプレート: customer-car-reviews/CarReviews/logicapps/CreateCar/</a></li>
</ul>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://blog.mexia.com.au/preparing-azure-logic-apps-for-cicd" rel="nofollow noopener" target="_blank">Preparing Azure Logic Apps for CI/CD using ARM Templates</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-create-deploy-template" rel="nofollow noopener" target="_blank">Create templates for logic apps deployment and release management</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-deploy-from-vs" rel="nofollow noopener" target="_blank">Design, build, and deploy Azure Logic Apps in Visual Studio</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=VinaySinghMSFT.AzureLogicAppsToolsforVisualStudio-18551" rel="nofollow noopener" target="_blank">Azure Logic Apps Tools for Visual Studio 2017</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />20位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/e6df17eaf2324841e331">SPA を Blob Storage にあげて、Azure Functions をバックエンドにしてみる。</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-19 01:13:36</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> <b>[Angular2]</b> <b>[AzureFunctions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>これは大した苦労なくできたが、自分向けへのメモ</p>

<p>Angular 4 で作成した、SPA をプロダクションでビルドする。ポイントは、コンテナ名がもし、<code>web</code> だったら次のようにしてビルドする。ローカルPCでテストする時は、<code>base href</code> は、<code>/</code> になるはずだ。しかし、例えばblob とかにアップロードすると、URL が <code>https://xxxx.blob.core.windows.net/web/index.html</code> とかになるだろう。そのため、本番環境では、もしそうなら、<code>--base-href</code> フラグをつけて、<code>base href</code> を指定しておく。</p>

<h1>
<span id="プロジェクトのビルド" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89"><i class="fa fa-link"></i></a>プロジェクトのビルド</h1>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span> ng b -prod --base-href /web/
</pre></div></div>

<p>すると<code>dist</code> ディレクトリ配下にファイルが生成される。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ng b -prod --base-href /web/
Date: 2017-10-18T15:40:25.216Z                                                t Hash: 8d4581caef41aa5fde78
Time: 16687ms
chunk {0} polyfills.d8d3d78a4deb2ab66856.bundle.js (polyfills) 66.1 kB {4} [initial] [rendered]
chunk {1} main.5c27cd4d6d08e4aeef7c.bundle.js (main) 54.9 kB {3} [initial] [rendered]
chunk {2} styles.0363122755f82fabd526.bundle.css (styles) 52.4 kB {4} [initial] [rendered]
chunk {3} vendor.0a6d7c376a3409d9df1d.bundle.js (vendor) 788 kB [initial] [rendered]
chunk {4} inline.4f1fb8581b76445ec606.bundle.js (inline) 1.45 kB [entry] [rendered]
</pre></div></div>

<h1>
<span id="blob-へのアップロード" class="fragment"></span><a href="#blob-%E3%81%B8%E3%81%AE%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>blob へのアップロード</h1>

<p>これらのファイルを blob にアップロードする。私はコンテナ名を、<code>web</code> にして、permission は、<code>blob</code> にしている。（リードオンリー）</p>

<p>私は、<a href="https://azure.microsoft.com/en-us/features/storage-explorer/" rel="nofollow noopener" target="_blank">Azure Storage Explorer</a> を使っている。</p>

<h1>
<span id="cors-の設定" class="fragment"></span><a href="#cors-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>CORS の設定</h1>

<p>Azure Functions 側で、CORS の設定が必要。Azure Functions の Function App から、API &gt; CORS を選んで、blob の URL を設定してあげると、SPA から、それらのURLをコールできるようになる。</p>

<h1>
<span id="成果" class="fragment"></span><a href="#%E6%88%90%E6%9E%9C"><i class="fa fa-link"></i></a>成果</h1>

<p>まだ公開できないが、SPA + Azure Functions + Logic App + Cosmos DB によるデモサイトを公開できた。</p>

<h1>
<span id="残課題" class="fragment"></span><a href="#%E6%AE%8B%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>残課題</h1>

<p>アップロードは特に難しくなく、すんなり動いたが、いくつか残件があるが、夜遅いのでまた明日。</p>

<p><em>TODO</em></p>

<ul>
<li>
<a href="https://xxxx.blob.core.windows.net/web/index.html" class="autolink" rel="nofollow noopener" target="_blank">https://xxxx.blob.core.windows.net/web/index.html</a> ではなく、<a href="https://xxxx.blob.core.windows.net/web" class="autolink" rel="nofollow noopener" target="_blank">https://xxxx.blob.core.windows.net/web</a> でアクセスしたい</li>
<li>Azure Functions Proxy 経由で使いたい</li>
<li>minify 化されているが、javascript のコードが読めるので、バックエンドのURLはバレてしまう。</li>
</ul>

<p>明日はよく知っている人に上記のことを聞いてみよう。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />21位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/d2ab2f57a0c6d4cfc7f3">Azure Container Instances を Azure Container Registory からポートを複数持った状態でプロビジョンする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-14 00:23:49</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Azure]</b> <b>[AzureContainerInstances]</b> <b>[AzureContainerRegistry]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今日は、<a href="https://blogs.technet.microsoft.com/livedevopsinjapan/2017/10/13/migration-tips-from-iaas-to-web-app-for-containers-on-azure/" rel="nofollow noopener" target="_blank">Web App for Containers をハック</a>していたが、Web App なので、コンテナのポートを２つ以上公開することができない。その状況でもコンテナをデプロイするために、Azure Container Instances を使ってみた。時間がなかったので、３０分以内に終わらせるため、この方法を選んだ。</p>

<h1>
<span id="コマンドラインでは複数ポートを指定できない" class="fragment"></span><a href="#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%A7%E3%81%AF%E8%A4%87%E6%95%B0%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>コマンドラインでは複数ポートを指定できない</h1>

<p><a href="https://docs.microsoft.com/en-us/azure/container-instances/container-instances-overview" rel="nofollow noopener" target="_blank">Azure Container Instance</a> は、CLI, Portal, PowerShellの３つの方法がよく紹介されている。 <a href="https://docs.microsoft.com/en-us/azure/container-registry/" rel="nofollow noopener" target="_blank">Azure Container Registry</a> においているコンテナをプロビジョンするにはどうしたらいいのだろう。パスワードで保護されているし。<code>az</code> コマンドでは、Container Registry のパスワードを入力できるが、ポータルや、CLI だと、ポートの複数指定ができない。</p>

<h1>
<span id="arm-テンプレートでデプロイする" class="fragment"></span><a href="#arm-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%A7%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ARM テンプレートでデプロイする</h1>

<p>ところが、Azure Container Instances REST-API を見るとどうやらできそう。具体的には、ARM テンプレートを使えば良い。</p>

<p>I upload the sample template on the gist. Please have a look. You can deploy it using az command.</p>

<ul>
<li><a href="https://gist.github.com/TsuyoshiUshio/0660ac26e043ea1afe9e782d7bdc25e9" rel="nofollow noopener" target="_blank">Azure Container Instances deploy sample with two ports and ACR credential</a></li>
</ul>

<p>ポイントはいくつかで、まずは複数ポート。簡単に設定できる。</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span>                    <span class="s2">"containers"</span><span class="err">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"kirinmq"</span><span class="p">,</span>
                            <span class="nt">"properties"</span><span class="p">:</span> <span class="p">{</span>
                                <span class="nt">"image"</span><span class="p">:</span> <span class="s2">"{YOUR_ACR_HOST_NAME}.azurecr.io/mq"</span><span class="p">,</span>
                                <span class="nt">"ports"</span><span class="p">:</span> <span class="p">[</span>
                                    <span class="p">{</span>
                                        <span class="nt">"port"</span><span class="p">:</span> <span class="s2">"5555"</span> 
                                    <span class="p">},</span>
                                    <span class="p">{</span>
                                        <span class="nt">"port"</span><span class="p">:</span> <span class="s2">"5556"</span>
                                    <span class="p">}</span>
                                <span class="p">],</span>
</pre></div></div>

<p>次に、ACR のクレデンシャル。そのままだ。ちなみにこのコンフィグをどこから見つけてきたかというと、ACI の REST API スペックから。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/rest/api/container-instances/ContainerGroups/CreateOrUpdate#definitions_imageregistrycredential" rel="nofollow noopener" target="_blank">Container Groups - Create Or Update</a></li>
</ul>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span>                <span class="s2">"properties"</span><span class="err">:</span> <span class="p">{</span>
                    <span class="nt">"imageRegistryCredentials"</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="nt">"password"</span><span class="p">:</span> <span class="s2">"{YOUR_ACR_PASSWORD}"</span><span class="p">,</span>
                            <span class="nt">"server"</span><span class="p">:</span> <span class="s2">"{YOUR_ACR_HOST_NAME}.azurecr.io"</span><span class="p">,</span>
                            <span class="nt">"username"</span><span class="p">:</span> <span class="s2">"{YOUR_ACR_USER_NAME"</span><span class="p">}</span>

                    <span class="p">],</span>
</pre></div></div>

<p>デプロイ。ちなみに、現在は使えるロケーションが限られてるので、注意。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>az group create --name resourceGroupName --location westus
az group deployment create -n someDeploy --template-file azuredeploy.json -g resourceGroupName
</pre></div></div>

<h1>
<span id="rest-api-を観察する" class="fragment"></span><a href="#rest-api-%E3%82%92%E8%A6%B3%E5%AF%9F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Rest API を観察する</h1>

<ul>
<li><a href="https://docs.microsoft.com/en-us/rest/api/container-instances/ContainerGroups/CreateOrUpdate#definitions_imageregistrycredential" rel="nofollow noopener" target="_blank">Container Groups - Create Or Update</a></li>
</ul>

<p>を観察して見ると色々面白い設定ができる。先の Gist にもしてあるが、コンテナで使う、CPUとか、メモリの確保とかができる。まるで、オーケストレータのようだ。Win/Linux の両方に対応している。マウントもできるようす。これは面白いね！</p>

<h1>
<span id="コンテナグループ" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97"><i class="fa fa-link"></i></a>コンテナグループ</h1>

<p>ちなみに、アーキテクチャ的には、同じVMに乗っかるコンテナグループという概念がある様子。Kubernetes の pod に似た概念で、同じコンテナグループのコンテナはVMを共有する。</p>

<p><a href="https://camo.qiitausercontent.com/8f2a443c1e9f2ca2ca686c648ae0b3a269fc3c76/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32356230346638372d396161392d313636342d633665372d3030386534353062396536632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8f2a443c1e9f2ca2ca686c648ae0b3a269fc3c76/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32356230346638372d396161392d313636342d633665372d3030386534353062396536632e706e67" alt="container-groups-example.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/25b04f87-9aa9-1664-c6e7-008e450b9e6c.png"></a></p>

<p>コンテナインスタンスの課金を見ると、CPU、メモリとか、リクエスト単位みたい。とかそういうものなので、コンテナグループを分けると、別のVMであることを保証するなら、コンテナグループを作ると、基本的にVMを占有とか可能なのだろうか？</p>

<p><a href="https://camo.qiitausercontent.com/37a9bb9217418ede843a960d5b3848d945d29026/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65393930336264662d323736342d386238342d356332312d6439666338333638323163302e706e67" target="_blank" rel="nofollow noopener"><img width="1156" alt="Screen Shot 2017-10-13 at 11.53.34 PM.png" src="https://camo.qiitausercontent.com/37a9bb9217418ede843a960d5b3848d945d29026/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65393930336264662d323736342d386238342d356332312d6439666338333638323163302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/e9903bdf-2764-8b84-5c21-d9fc836821c0.png"></a></p>

<h1>
<span id="debugの方法" class="fragment"></span><a href="#debug%E3%81%AE%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>Debugの方法</h1>

<p>さて、ハック時間内にできなかったことは、Debug の方法。やっぱコンテナはログが命。コンテナグループ、リソースグループ、コンテナ名を指定したらログが見える。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ az container logs -n myContainerGroup -g resourceGroupName --container-name mq
Stopping nginx: [FAILED]
Starting nginx: [  OK  ]
Stopping sshd: [FAILED]
Generating SSH2 RSA host key: [  OK  ]
Generating SSH1 RSA host key: [  OK  ]
Generating SSH2 DSA host key: [  OK  ]
Starting sshd: [  OK  ]
</pre></div></div>

<p>おお、手元からログ見れた。<a href="https://blogs.technet.microsoft.com/livedevopsinjapan/2017/10/13/migration-tips-from-iaas-to-web-app-for-containers-on-azure/" rel="nofollow noopener" target="_blank">Migration tips from IaaS to Web App for Containers on Azure</a> の作戦で、シンボリックリンクを貼るとちゃんとデバッグできそう。また、コンテナ自身のコンフィグもみれる。先ほどの ARM テンプレートの実行結果みたいな感じ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ az container show -n myContainerGroup -g resourceGroupName
{
  "containers": [
    {
      "command": null,
      "environmentVariables": [],
      "image": "{YOUR_ACR_HOST_NAME}.azurecr.io/mq",
      "instanceView": {
        "currentState": {
          "detailStatus": "",
          "exitCode": null,
          "finishTime": null,
          "startTime": "2017-10-13T06:15:13+00:00",

</pre></div></div>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/container-instances/container-instances-troubleshooting" rel="nofollow noopener" target="_blank">Troubleshoot deployment issues with Azure Container Instances</a></li>
<li><a href="https://docs.microsoft.com/en-us/cli/azure/container?view=azure-cli-latest#az_container_logs" rel="nofollow noopener" target="_blank">az container command</a></li>
</ul>

<p>見れない時は、<code>Activity Log</code> で。エラーはこんなのが書いてあった。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Error code
LocationNotAvailableForResourceType
Message
The provided location 'japaneast' is not available for resource type 'Microsoft.ContainerInstance/containerGroups'. List of available regions for the resource type is 'westus,eastus,westeurope'.
</pre></div></div>

<p>明らか！</p>

<p>削除もあるね</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>＄ az container delete -n mq -g resourceGroupName -y
$ az container list -g resourceGroupName
[]

</pre></div></div>

<p>うん、簡単だ！</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>ほんまこれサーバーレスよね。思ったより、細かく設定できそうなので、これは色々遊べそうだ！</p>

<ul>
<li><a href="https://azure.microsoft.com/en-us/services/container-instances/" rel="nofollow noopener" target="_blank">Container Instances</a></li>
<li><a href="https://github.com/seanmck/azure-quickstart-templates/tree/master/101-aci-linuxcontainer-public-ip-multiple-ports" rel="nofollow noopener" target="_blank">Azure Container Instances</a></li>
<li><a href="https://docs.microsoft.com/en-us/rest/api/container-instances/ContainerGroups/CreateOrUpdate#definitions_imageregistrycredential" rel="nofollow noopener" target="_blank">Container Groups - Create Or Update</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />22位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/03a0d169d440a64535dc">Azure Functions CLI + Node + Mac で extension を追加する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-10 23:16:48</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Node.js]</b> <b>[MacOSX]</b> <b>[AzureFunctions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>これも自分用のメモ。Azure Functions では、トリガーとかの extension 追加する方法があるみたい。特に、C# だったらたまに記事を見かける。</p>

<h1>
<span id="azure-functions-に-extension-を追加したいnode--mac-で" class="fragment"></span><a href="#azure-functions-%E3%81%AB-extension-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%81%84node--mac-%E3%81%A7"><i class="fa fa-link"></i></a>Azure Functions に Extension を追加したい。Node + Mac で</h1>

<ul>
<li><a href="https://mikhail.io/2017/07/authoring-custom-binding-azure-functions/" rel="nofollow noopener" target="_blank">Authoring a Custom Binding for Azure Functions</a></li>
</ul>

<p>それはええねんけど、わし、Mac で Node 書いているねんけど、こういうときカスタムのエクステンション追加したいときどうなるんよ。これ、思いっきり nuget やし。例えばこれ。</p>

<ul>
<li><a href="https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB/3.0.0-beta4" rel="nofollow noopener" target="_blank">Microsoft.Azure.WebJobs.Extensions.CosmosDB</a></li>
</ul>

<p>これは、今は、コマンドラインで楽勝でできるみたい。CLI を使って。</p>

<h1>
<span id="azure-functions-cli-をアップデートする" class="fragment"></span><a href="#azure-functions-cli-%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Azure Functions CLI をアップデートする</h1>

<p>Azure Functions の CLI が古いとダメみたい。私のダメだったバージョンは、これ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ func --help

                  %%%%%%
                 %%%%%%
            @   %%%%%%    @
          @@   %%%%%%      @@
       @@@    %%%%%%%%%%%    @@@
     @@      %%%%%%%%%%        @@
       @@         %%%%       @@
         @@      %%%       @@
           @@    %%      @@
                %%
                %

Azure Functions Core Tools (2.0.0)
Function Runtime Version: 2.0.11280.0
Usage: func [context] [context] &lt;action&gt; [-/--options]

Contexts:
azure      Commands to log in to Azure and manage resources
function   Commands for creating and running functions locally
host       Commands for running the Functions host locally
settings   Commands for managing environment settings for the local Functions host
templates  Commands for listing available function templates
</pre></div></div>

<p>アップデートしてみよう。私が使っているのは preview のものだから、<code>@core</code> が付いている。これは、Azure Functions の 2.0 </p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ npm uninstall -g azure-functions-core-tools@core 
$ npm install -g azure-functions-core-tools@core --unsafe-perm
</pre></div></div>

<p>がっつり入れ替え。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ func

                  %%%%%%
                 %%%%%%
            @   %%%%%%    @
          @@   %%%%%%      @@
       @@@    %%%%%%%%%%%    @@@
     @@      %%%%%%%%%%        @@
       @@         %%%%       @@
         @@      %%%       @@
           @@    %%      @@
                %%
                %

Azure Functions Core Tools (2.0.0)
Function Runtime Version: 2.0.11308.0
Usage: func [context] [context] &lt;action&gt; [-/--options]

Contexts:
azure       Commands to log in to Azure and manage resources
extensions  Commands for installing extensions
function    Commands for creating and running functions locally
host        Commands for running the Functions host locally
settings    Commands for managing environment settings for the local Functions host
templates   Commands for listing available function templates

</pre></div></div>

<p>おお、新たなサブコマンドが増えている。</p>

<h1>
<span id="エクステンションのインストール" class="fragment"></span><a href="#%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%86%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>エクステンションのインストール</h1>

<p><code>func extensions install</code> コマンドを使う。ログの通り、FunctionApp のディレクトリに、<code>functions-extensions</code> というディレクトリができてそこに、格納される。これらは、<code>.NET Core</code> のライブラリ</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ func extensions install -p Microsoft.Azure.WebJobs.Extensions.CosmosDB -v 3.0.0-beta4
  Writing /var/folders/5b/rt6_lb397_3d92vp67g98pgr0000gn/T/tmp5igzx3.tmp
info : Adding PackageReference for package 'Microsoft.Azure.WebJobs.Extensions.CosmosDB' into project '/Users/ushio/Codes/Azure/carreviewbackend/functions-extensions/extensions.csproj'.
log  : Restoring packages for /Users/ushio/Codes/Azure/carreviewbackend/functions-extensions/extensions.csproj...
info :   GET https://api.nuget.org/v3-flatcontainer/microsoft.azure.webjobs.script.extensionsmetadatagenerator/index.json
info :   OK https://api.nuget.org/v3-flatcontainer/microsoft.azure.webjobs.script.extensionsmetadatagenerator/index.json 896ms
info :   GET https://api.nuget.org/v3-flatcontainer/microsoft.azure.webjobs.script.extensionsmetadatagenerator/1.0.0-beta2/microsoft.azure.webjobs.script.extensionsmetadatagenerator.1.0.0-beta2.nupkg
info :   OK https://api.nuget.org/v3-flatcontainer/microsoft.azure.webjobs.script.extensionsmetadatagenerator/1.0.0-beta2/microsoft.azure.webjobs.script.extensionsmetadatagenerator.1.0.0-beta2.nupkg 935ms
log  : Installing Microsoft.Azure.WebJobs.Script.ExtensionsMetadataGenerator 1.0.0-beta2.
info : Package 'Microsoft.Azure.WebJobs.Extensions.CosmosDB' is compatible with all the specified frameworks in project '/Users/ushio/Codes/Azure/carreviewbackend/functions-extensions/extensions.csproj'.
info : PackageReference for package 'Microsoft.Azure.WebJobs.Extensions.CosmosDB' version '3.0.0-beta4' added to file '/Users/ushio/Codes/Azure/carreviewbackend/functions-extensions/extensions.csproj'.

Microsoft (R) Build Engine version 15.3.409.57025 for .NET Core
Copyright (C) Microsoft Corporation. All rights reserved.

  extensions -&gt; /Users/ushio/Codes/Azure/carreviewbackend/bin/extensions.dll

Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:02.57
</pre></div></div>

<p>おおお！入ったっぽい！これで、Azure Functions 2.0 でも、Cosmos DB のバインデイングが使えるように！</p>

<h1>
<span id="エクステンションをazure-で使う" class="fragment"></span><a href="#%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%86%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92azure-%E3%81%A7%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>エクステンションをAzure で使う</h1>

<p>で、ローカルはこれでええけど、Azure どうするのよ。これが、もっと簡単だった。</p>

<p><code>func azure functionapp publish FUNCTION_APP_NAME</code> これだけで、Azure にアップロードしてくれるみたい。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ func azure functionapp publish carreviewver2
Publish /Users/ushio/Codes/Azure/carreviewbackend contents to an Azure Function App. Locally deleted files are not removed from destination.
Getting site publishing info...
Creating archive for current directory...
Uploading archive...
Upload completed successfully.

</pre></div></div>

<h1>
<span id="azure-で確認" class="fragment"></span><a href="#azure-%E3%81%A7%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>Azure で確認</h1>

<p>Azure Functions の DEVELOPMENT TOOL &gt; Console で確認して見る。うん。入ってる！これはいけてるな！まだプレビューだけど。</p>

<p><a href="https://camo.qiitausercontent.com/f5f7d55d73e350645fd3844b72451b031b616e39/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f31346465663230312d656239392d383266622d383937332d3561653965373033643763612e706e67" target="_blank" rel="nofollow noopener"><img width="936" alt="Screen Shot 2017-10-10 at 11.15.52 PM.png" src="https://camo.qiitausercontent.com/f5f7d55d73e350645fd3844b72451b031b616e39/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f31346465663230312d656239392d383266622d383937332d3561653965373033643763612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/14def201-eb99-82fb-8973-5ae9e703d7ca.png"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />23位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/0f3c5c212044ea8364eb">Angular 4 から、Logic Apps  経由で　CosmosDBに書き出して見る。</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-10 22:55:08</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Angular2]</b> <b>[logicapps]</b> <b>[CosmosDB]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>本来は、Azure Functions で作る予定だったサービスがあったのだが、質問があってサーバーサイドを作るのは回答待ちだった。その間も作業を進めたかったので、ふと思いついて代わりに、Logic Apps でサクッと作ってみたので、いつも通り自分用にブログしておく。</p>

<p># 1. Cosmos DB を作成する。</p>

<p>Azure Portal から普通に作れば良い。 CosmosDB -&gt; Collection を作って行く。一つのポイントは、Collectionを作る際の Partition Key が聞かれるようになったこと。これは、どのキーを元にして、分散させるか？という設定になる。（CosmosDB は、プラネットスケールで分散するので）今回は、とりあえず <code>name</code> にしてみた。</p>

<p><a href="https://camo.qiitausercontent.com/5c4c2b0904659a658baad4d8b310c7f7db14141e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65646132303562352d343461662d313031632d336136372d3130356436643439636539362e706e67" target="_blank" rel="nofollow noopener"><img width="316" alt="Screen Shot 2017-10-10 at 9.56.14 PM.png" src="https://camo.qiitausercontent.com/5c4c2b0904659a658baad4d8b310c7f7db14141e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65646132303562352d343461662d313031632d336136372d3130356436643439636539362e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/eda205b5-44af-101c-3a67-105d6d49ce96.png"></a></p>

<h1>
<span id="2-client-を作成する" class="fragment"></span><a href="#2-client-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. Client を作成する。</h1>

<p>これも、普通にポータルからできて、特に難しいことはないので割愛。今回のアプリは</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Angular 4 -&gt; Logic Apps -&gt; CosmosDB
</pre></div></div>

<p>Angular のコードはとても単純なもので例えばこんなの。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Car</span> <span class="p">{</span>
    <span class="nx">name</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">company</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">description</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">image_url</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">state</span>: <span class="kt">string</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div></div>

<p>単にこれをアップロードしたい。画面も割愛で、ロジック部分のみ書くと下記の感じ。<code>submit()</code> イベントが発生したら、単にアップロードする。URL先は、単純にLog Apps であとで登場する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>import { Component } from '@angular/core';
import { Car } from './car';
import { Http, Headers, RequestOptions } from '@angular/http';
declare const Buffer;
import * as fs from 'fs';

@Component({
  selector: 'app-root',
  templateUrl: './car-detail.component.html'
})
export class CarDetailComponent {
  title = 'Car Reviews';
  image = 'assets/noimage.jpg';
  car: Car;


  constructor(private http:Http) {
      this.car = new Car();
      this.car.name = "";
      this.car.company = "";
      this.car.description = "";
      this.car.image_url = "assets/noimage.jpg";
      this.car.state = "pending";
  }

  submit() {

    let headers = new Headers();
    headers.append("Content-Type", "application/json");
    let options = new RequestOptions({
      headers: headers
    });
    let data = this.car;
    this.http.post("https://prod-07.japaneast.logic.azure.com:443/workflows/69c3cbe052374fa3bc54a51c6ed00935/triggers/manual/paths/invoke?api-version=2016-10-01&amp;sp=%2Ftriggers%2Fmanual%2Frun&amp;sv=1.0&amp;sig=tkPN9Gciye_QJHfwreCsJmWqGUuEIGHijsWUXDY9Ltk", data, options)
    .subscribe(
      data =&gt; console.log(data),
      error =&gt; console.log(error)
    );
  }

}
</pre></div></div>

<h1>
<span id="3-logic-apps-を設定する" class="fragment"></span><a href="#3-logic-apps-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. Logic Apps を設定する</h1>

<h2>
<span id="31request-を選択" class="fragment"></span><a href="#31request-%E3%82%92%E9%81%B8%E6%8A%9E"><i class="fa fa-link"></i></a>3.1`Request を選択</h2>

<p>まずは、リクエストきっかけで起動させる</p>

<p><a href="https://camo.qiitausercontent.com/29731129cb61c859a3fa70e4fc3968be44f06be5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34333936336337652d323965352d353432612d383136632d3531626666353537343366302e706e67" target="_blank" rel="nofollow noopener"><img width="1262" alt="LogicApp01.png" src="https://camo.qiitausercontent.com/29731129cb61c859a3fa70e4fc3968be44f06be5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34333936336337652d323965352d353432612d383136632d3531626666353537343366302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/43963c7e-29e5-542a-816c-51bff55743f0.png"></a></p>

<p>次にこれ。選択。</p>

<p><a href="https://camo.qiitausercontent.com/d9b2073fa83e113bfd7c90ab7454f5ac00d2a937/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63633338383761392d616465662d326138392d643761652d3933303261376135656662382e706e67" target="_blank" rel="nofollow noopener"><img width="624" alt="LogicApp02.png" src="https://camo.qiitausercontent.com/d9b2073fa83e113bfd7c90ab7454f5ac00d2a937/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63633338383761392d616465662d326138392d643761652d3933303261376135656662382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/cc3887a9-adef-2a89-d7ae-9302a7a5efb8.png"></a></p>

<h2>
<span id="32-request-の設定" class="fragment"></span><a href="#32-request-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>3.2. Request の設定</h2>

<p>なんかこんな画面になるので下のリンクをクリック。</p>

<p><a href="https://camo.qiitausercontent.com/8dd9fe2ec807750e2f3cebf75012c33443cd7943/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36346536653532662d613337392d356230642d363734392d3531353434303862366161312e706e67" target="_blank" rel="nofollow noopener"><img width="612" alt="LogicApp03.png" src="https://camo.qiitausercontent.com/8dd9fe2ec807750e2f3cebf75012c33443cd7943/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36346536653532662d613337392d356230642d363734392d3531353434303862366161312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/64e6e52f-a379-5b0d-6749-5154408b6aa1.png"></a></p>

<p>こいつに、引き渡したいサンプルの JSONの例 を書いて見る。</p>

<p><a href="https://camo.qiitausercontent.com/7807dc2142c8c585568f9fb078d4ce25214272c6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63383465383761652d386266372d353433392d666261622d3163313765653765356236302e706e67" target="_blank" rel="nofollow noopener"><img width="801" alt="LogicApp04.png" src="https://camo.qiitausercontent.com/7807dc2142c8c585568f9fb078d4ce25214272c6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63383465383761652d386266372d353433392d666261622d3163313765653765356236302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/c84e87ae-8bf7-5439-fbab-1c17ee7e5b60.png"></a></p>

<p>おー勝手に定義ができた。クライアントから送るときに、<code>Content-Type: application/json</code> の設定を忘れないでね！と言われるが、勝手にスキーマ定義ができている。</p>

<p><a href="https://camo.qiitausercontent.com/56cce2c4230414a12ba3befbd3c708d63df8069f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35343331653432332d633363612d353430642d383061612d6263623238336139383063612e706e67" target="_blank" rel="nofollow noopener"><img width="606" alt="LogicApp05.png" src="https://camo.qiitausercontent.com/56cce2c4230414a12ba3befbd3c708d63df8069f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35343331653432332d633363612d353430642d383061612d6263623238336139383063612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/5431e423-c3ca-540d-80aa-bcb283a980ca.png"></a></p>

<h2>
<span id="33-cosmos-db-の設定" class="fragment"></span><a href="#33-cosmos-db-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>3.3. Cosmos DB の設定</h2>

<p>続けてコスモス。登録もしくは、更新の奴を選ぶ。</p>

<p><a href="https://camo.qiitausercontent.com/fb0375fb0d0635acaa90564675f299ae193a88e3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64613731366531362d353834342d656265322d623764322d6630373730373262383232312e706e67" target="_blank" rel="nofollow noopener"><img width="601" alt="LogicApp06.png" src="https://camo.qiitausercontent.com/fb0375fb0d0635acaa90564675f299ae193a88e3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64613731366531362d353834342d656265322d623764322d6630373730373262383232312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/da716e16-5844-ebe2-b7d2-f077072b8221.png"></a></p>

<p>で、こんな感じに設定して見る。先に作った<code>Request</code> のデータをみてくれるので、項目をダブルクリックしたら定義ができる。ちなみに、CosmosDB の Partition Key を指定したので、それも足しておく。</p>

<p><a href="https://camo.qiitausercontent.com/39e54b1a713be969c797848d5cb81eb8cd885092/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66633434626566302d646138302d633961392d663764612d3536653733353964666261652e706e67" target="_blank" rel="nofollow noopener"><img width="601" alt="LogicApp07.png" src="https://camo.qiitausercontent.com/39e54b1a713be969c797848d5cb81eb8cd885092/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66633434626566302d646138302d633961392d663764612d3536653733353964666261652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/fc44bef0-da80-c9a9-f7da-56e7359dfbae.png"></a></p>

<h1>
<span id="クライアントからの送信そしてエラー" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%8B%E3%82%89%E3%81%AE%E9%80%81%E4%BF%A1%E3%81%9D%E3%81%97%E3%81%A6%E3%82%A8%E3%83%A9%E3%83%BC"><i class="fa fa-link"></i></a>クライアントからの送信、そしてエラー、、、</h1>

<p>一応クライアントから、メッセージを投げてみたが、うまくいかない様子。エラーは、トップ画面からみれるので、クリック。</p>

<p><a href="https://camo.qiitausercontent.com/e35f5399b830d4c99b4723bc5e7a64cf0fadc7e3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66386564303337612d626162322d326135382d356237652d3833356635626561366264632e706e67" target="_blank" rel="nofollow noopener"><img width="1262" alt="LogicApp08.png" src="https://camo.qiitausercontent.com/e35f5399b830d4c99b4723bc5e7a64cf0fadc7e3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66386564303337612d626162322d326135382d356237652d3833356635626561366264632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f8ed037a-bab2-2a58-5b7e-835f5bea6bdc.png"></a></p>

<p>エラーみて見ると、ID がないらしい。</p>

<p><a href="https://camo.qiitausercontent.com/09d5294cd6d18bd98e51dafcbecbba1bc3cbf82d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36646162306166662d363534642d636337382d303662352d6361356232323438366435302e706e67" target="_blank" rel="nofollow noopener"><img width="1108" alt="LogicApp09.png" src="https://camo.qiitausercontent.com/09d5294cd6d18bd98e51dafcbecbba1bc3cbf82d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36646162306166662d363534642d636337382d303662352d6361356232323438366435302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/6dab0aff-654d-cc78-06b5-ca5b22486d50.png"></a></p>

<h2>
<span id="guid" class="fragment"></span><a href="#guid"><i class="fa fa-link"></i></a>guid()</h2>

<p>ID なんて自分で振ってよー！と思って Kanio にちょっと聞いて見ると、関数が使えるらしい。今回は、<code>guid()</code> をセレクト。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-workflow-definition-language" rel="nofollow noopener" target="_blank">Workflow Definition Language schema for Azure Logic Apps</a></li>
</ul>

<p>ちなみに、GUI の画面だけど裏は、Json になっているので、コードも編集できる。<code>@{guid()}</code> みたいな感じで足して見る。</p>

<p><a href="https://camo.qiitausercontent.com/ea5d5a720e344de2e8cdb21522678d6aeca1f0a4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34396338623630342d366438372d666561312d373261662d3765663933363538373762372e706e67" target="_blank" rel="nofollow noopener"><img width="599" alt="LogicApp10.png" src="https://camo.qiitausercontent.com/ea5d5a720e344de2e8cdb21522678d6aeca1f0a4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34396338623630342d366438372d666561312d373261662d3765663933363538373762372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/49c8b604-6d87-fea1-72af-7ef9365877b7.png"></a></p>

<h1>
<span id="成功" class="fragment"></span><a href="#%E6%88%90%E5%8A%9F"><i class="fa fa-link"></i></a>成功！</h1>

<p>おー、動いた。</p>

<p><a href="https://camo.qiitausercontent.com/ef920b4625345241a5d8a564c5d89f1ad89dd54c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66346166646336662d373835622d613864322d666631662d3734396234663663316238362e706e67" target="_blank" rel="nofollow noopener"><img width="491" alt="LogicApp11.png" src="https://camo.qiitausercontent.com/ef920b4625345241a5d8a564c5d89f1ad89dd54c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66346166646336662d373835622d613864322d666631662d3734396234663663316238362e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f4afdc6f-785b-a8d2-ff1f-749b4f6c1b86.png"></a></p>

<p>Cosmos DB 見てみよう。</p>

<p><a href="https://camo.qiitausercontent.com/40f7ead6b0957090fdbdcfc4229716e136864c46/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37636564373133342d643139372d643834312d633934322d3564376135333666313236642e706e67" target="_blank" rel="nofollow noopener"><img width="858" alt="LogicApp14.png" src="https://camo.qiitausercontent.com/40f7ead6b0957090fdbdcfc4229716e136864c46/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37636564373133342d643139372d643834312d633934322d3564376135333666313236642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7ced7134-d197-d841-c942-5d7a536f126d.png"></a></p>

<p>しっかり入ってる。ちなみに、先ほどの Logic Apps の編集画面に戻るとかっちょよくなっていた。</p>

<p><a href="https://camo.qiitausercontent.com/c6abde248bc118423b30f6b9ff7f8f26b2f38408/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38643538613564382d333936342d386439372d613466622d3566386466393365323638642e706e67" target="_blank" rel="nofollow noopener"><img width="641" alt="LogicApp12.png" src="https://camo.qiitausercontent.com/c6abde248bc118423b30f6b9ff7f8f26b2f38408/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38643538613564382d333936342d386439372d613466622d3566386466393365323638642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/8d58a5d8-3964-8d97-a4fb-5f8df93e268d.png"></a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>思い立ってから、試して見て１時間ぐらいでできた。こら簡単だわ。慣れたらきっともっと早いだろうなぁ。一般的なシナリオはもうこれでいいんじゃないだろうか？w コネクターとか、トリガーも見て見ると、Microsoft にかかわらずがっつりある。これは楽だわ。ちなみに、プログラマとしては、設定だけやとおもろないので、こういうコネクターやトリガーを書いてみたいですね。</p>

<p><a href="https://camo.qiitausercontent.com/11666474d378d263af56b231864a9b47e340e859/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39633565313039622d616161382d643335372d396331652d3539643537626363366137392e706e67" target="_blank" rel="nofollow noopener"><img width="628" alt="Screen Shot 2017-10-10 at 10.46.23 PM.png" src="https://camo.qiitausercontent.com/11666474d378d263af56b231864a9b47e340e859/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39633565313039622d616161382d643335372d396331652d3539643537626363366137392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/9c5e109b-aaa8-d357-9c1e-59d57bcc6a79.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/10ec7fb56c2fae2196ab85d380abbfc973aed04a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36626336653738372d373065612d353864372d313432352d3433656635346531343164622e706e67" target="_blank" rel="nofollow noopener"><img width="620" alt="Screen Shot 2017-10-10 at 10.46.59 PM.png" src="https://camo.qiitausercontent.com/10ec7fb56c2fae2196ab85d380abbfc973aed04a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36626336653738372d373065612d353864372d313432352d3433656635346531343164622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/6bc6e787-70ea-58d7-1425-43ef54e141db.png"></a></p>

<p>ざっとみたけど、結構簡単にできそう。意外と、Logic Apps おもろいかもw</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/logic-apps/custom-connector-overview" rel="nofollow noopener" target="_blank">Custom connectors overview</a></li>
</ul>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-workflow-definition-language" rel="nofollow noopener" target="_blank">Workflow Definition Language schema for Azure Logic Apps</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />24位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/70b9dbb1d0362ba4f478">Angular 4 +  マテリアルデザインでの Tips </a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-05 22:50:18</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> <b>[MaterialDesign]</b> <b>[Angular4]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今日は一日今まで学んでいた Angular の仕事が振られたので、画面デザイン系で格闘してみたので、いくつかの Tips を整理しておく。</p>

<h1>
<span id="複数の-image-upload-の実装" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E3%81%AE-image-upload-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>複数の Image Upload の実装</h1>

<p>Image をアップロードするというのは、Web でも基本的なシナリオだが、Angular 4 + Material Design　でもいくつかの実装方法がある。</p>

<p>最初は</p>

<ul>
<li><a href="https://aberezkin.github.io/ng2-image-upload/#/readme" rel="nofollow noopener" target="_blank">Angular Image Upload</a></li>
</ul>

<p>を使おうとして、実は実装までしたのだが、最終的に、どうもデザインがかっこよくないため、結局断念した。他にもいくつかのソリューションが存在する。</p>

<ul>
<li><a href="https://valor-software.com/ng2-file-upload/" rel="nofollow noopener" target="_blank">ng2-file-upload</a></li>
</ul>

<p>は結構かっこいい。プログレスバーも付いている。しかし、ちょい複雑。</p>

<ul>
<li><a href="http://demo.geekslabs.com/materialize-v1.0/form-file-uploads.html" rel="nofollow noopener" target="_blank">Materialized: File Upload</a></li>
</ul>

<p>これなんか超かっこいい。ドラック＆ドロップでインタラクティブで美しい。でも、JQueryの実装になっているのでううむ。となった。他にも、大抵完成度の高いものは、Angular 1.x 用だったりした。大変困ったのだが、結局なんのプラグインも使わず実装することにした。</p>

<h1>
<span id="image-upload-の実装" class="fragment"></span><a href="#image-upload-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Image Upload の実装</h1>

<p><a href="https://camo.qiitausercontent.com/0483f8a1a20eecd05be4b87d39ccec8bb3054f91/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61383836643466632d633538332d666461642d623139632d6666343965356566623731632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0483f8a1a20eecd05be4b87d39ccec8bb3054f91/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61383836643466632d633538332d666461642d623139632d6666343965356566623731632e706e67" alt="Screen Shot 2017-10-05 at 10.12.31 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a886d4fc-c583-fdad-b19c-ff49e5efb71c.png"></a></p>

<p>最終的にカードを使ったシンプルなものにしてみた。しかし、実を言うと、Angular4 + Material Design (Angular Material) は、Input のtype="file" つまりアップロードのインプットに対応していない。普通にやるとだっさださになる。</p>

<p><a href="https://camo.qiitausercontent.com/366db8fe058970136da2e3c914e51e50cb898b62/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37373062346331612d326634622d633036632d636332642d3334646465356338343836642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/366db8fe058970136da2e3c914e51e50cb898b62/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37373062346331612d326634622d633036632d636332642d3334646465356338343836642e706e67" alt="Screen Shot 2017-10-05 at 10.17.01 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/770b4c1a-2f4b-c06c-cc2d-34dde5c8486d.png"></a></p>

<p>ううむ。これはかっこ悪すぎる。せっかく他はマテリアルデザインに対応しているのに、、、どうしたら上のようになるかと言うと、次のようにする。ラベルをつけて、そっちの方に、マテリアルデザインのスタイルシートのクラスを当ててしまう作戦。input 自体はHidden にしてしまう。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">hidden</span><span class="o">=</span><span class="s">"true"</span> <span class="na">id</span><span class="o">=</span><span class="s">"input-file-id"</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">accept</span><span class="o">=</span><span class="s">"image/*"</span> <span class="err">(</span><span class="na">change</span><span class="err">)="</span><span class="na">upload</span><span class="err">(</span><span class="na">fl</span><span class="err">.</span><span class="na">files</span><span class="err">)"</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"input-file-id"</span> <span class="na">class</span><span class="o">=</span><span class="s">"mat-raised-button mat-basic"</span><span class="p">&gt;</span>Choose image<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</pre></div></div>

<p>これは、下記の記事を参考に、<a href="https://material.angular.io/" rel="nofollow noopener" target="_blank">Angular Material</a> 用に書き直したもの。考え方は同じ。</p>

<ul>
<li><a href="https://stackoverflow.com/questions/31867194/file-upload-with-angular-material" rel="nofollow noopener" target="_blank">File Upload with Angular Material</a></li>
</ul>

<h1>
<span id="画面遷移で苦しむ" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB%E3%81%A7%E8%8B%A6%E3%81%97%E3%82%80"><i class="fa fa-link"></i></a>画面遷移で苦しむ</h1>

<p>他に、低レベルな問題としては、最初、Routing をしているのに、画面が切り替わらない問題があった。マニュアルをみて</p>

<p><em>app-routing.modules.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span>     <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">RouterModule</span><span class="p">,</span> <span class="nx">Routes</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">DashboardComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./dashboard.component'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">CarDetailComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./car-detail.component'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">routes</span>: <span class="kt">Routes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">redirectTo</span><span class="o">:</span> <span class="s1">'/dashboard'</span><span class="p">,</span> <span class="nx">pathMatch</span><span class="o">:</span> <span class="s1">'full'</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">'dashboard'</span><span class="p">,</span> <span class="nx">component</span>: <span class="kt">DashboardComponent</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">'detail'</span><span class="p">,</span> <span class="nx">component</span>: <span class="kt">CarDetailComponent</span> <span class="p">}</span>
<span class="p">];</span>

<span class="kd">@NgModule</span><span class="p">({</span>
    <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span> <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(</span><span class="nx">routes</span><span class="p">)],</span>
    <span class="nx">exports</span><span class="o">:</span> <span class="p">[</span> <span class="nx">RouterModule</span><span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppRoutingModule</span> <span class="p">{}</span>

</pre></div></div>

<p><em>app.module.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">BrowserModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/platform-browser'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">FormsModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/forms'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">HttpModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/http'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">MaterialModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./material.module'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">BrowserAnimationsModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/platform-browser/animations'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">ImageUploadModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'angular2-image-upload'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">AppRoutingModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./app-routing.module'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">CarDetailComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./car-detail.component'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">DashboardComponent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./dashboard.component'</span><span class="p">;</span>

<span class="kd">@NgModule</span><span class="p">({</span>
  <span class="nx">declarations</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">CarDetailComponent</span><span class="p">,</span>
    <span class="nx">DashboardComponent</span>
  <span class="p">],</span>
  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">HttpModule</span><span class="p">,</span>
    <span class="nx">MaterialModule</span><span class="p">,</span>
    <span class="nx">BrowserAnimationsModule</span><span class="p">,</span>
    <span class="nx">AppRoutingModule</span><span class="p">,</span>
    <span class="nx">ImageUploadModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(),</span>
  <span class="p">],</span>
  <span class="nx">providers</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">bootstrap</span><span class="o">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</pre></div></div>

<p>とマニュアルにしたがっているのに、例えば下記のように書いてみると、<code>gotoDetail()</code> イベントが発生すると、ちゃんとURLは切り替わるのだが、画面は切り替わらず、悩んだ。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppComponent</span> <span class="p">{</span>
  <span class="nx">title</span> <span class="o">=</span> <span class="s1">'Car Reviews'</span><span class="p">;</span>
  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">router</span>: <span class="kt">Router</span><span class="p">)</span> <span class="p">{}</span>

    <span class="nx">gotoDetail</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/detail'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>結論としては、ちゃんとマニュアル読めや！と言う話だった。</p>

<p>* <a href="https://angular.io/tutorial/toh-pt5" rel="nofollow noopener" target="_blank">Angular Tutorial: Routing</a></p>

<p><code>&lt;router-outlet&gt;&lt;/router-outlet&gt;</code> のタグの部分が、画面遷移による切り替え部分になる。当初は</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>app-routing.module.ts
app.component.html
app.component.ts
app.mdoule.ts
some-detail.component.html
some-detail.component.ts
material.module.ts
</pre></div></div>

<p>２画面アプリなので、<code>app.component</code> と合わせて２セットしか作らなかったが、これではダメだった。<code>app.component</code> には各画面で共通する処理を書いた方が良さげ。 今は、画面定義はヘッダーとフッターのみにして、` タグのみにしている。</p>

<p><em>app.component.html</em> </p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">md-toolbar</span> <span class="na">color</span><span class="o">=</span><span class="s">"primary"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">md-icon</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-icon"</span><span class="p">&gt;</span>collections<span class="p">&lt;/</span><span class="nt">md-icon</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>{{title}}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-spacer"</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">md-icon</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-icon"</span><span class="p">&gt;</span>home<span class="p">&lt;/</span><span class="nt">md-icon</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">md-toolbar</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">router-outlet</span><span class="p">&gt;&lt;/</span><span class="nt">router-outlet</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">md-toolbar</span> <span class="na">color</span><span class="o">=</span><span class="s">"light"</span> <span class="na">role</span><span class="o">=</span><span class="s">"aria-labelledby"</span> <span class="na">class</span><span class="o">=</span><span class="s">"footer"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-spacer"</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;</span><span class="nt">font</span> <span class="na">size</span><span class="o">=</span><span class="s">"3"</span><span class="p">&gt;</span>Serverless!<span class="p">&lt;/</span><span class="nt">font</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">md-icon</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-icon"</span><span class="p">&gt;</span>flash_on<span class="p">&lt;/</span><span class="nt">md-icon</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">md-toolbar</span><span class="p">&gt;</span> 
</pre></div></div>

<p>最終的なファイル構成はこんな感じ。基本的に１画面につき、ワンセットの、<code>.ts</code> と <code>.html</code> が必要</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>app-routing.module.ts
app.component.html
app.component.ts
app.mdoule.ts
some-detail.component.html
some-detail.component.ts
dashboard.component.html
dashboard.component.ts
material.module.ts
</pre></div></div>

<h1>
<span id="フッターを下部に配置する" class="fragment"></span><a href="#%E3%83%95%E3%83%83%E3%82%BF%E3%83%BC%E3%82%92%E4%B8%8B%E9%83%A8%E3%81%AB%E9%85%8D%E7%BD%AE%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>フッターを下部に配置する</h1>

<p>これは、単純に CSS にクラスを追加して、先の、フッターのところに、class を追加した。大きさを調整してこんな感じ。文字のサイズは、<code>&lt;font size="3"&gt;</code> とかで調整している。</p>

<div class="code-frame" data-lang="css"><div class="highlight"><pre><span></span>  <span class="p">.</span><span class="nc">footer</span> <span class="p">{</span>
    <span class="k">position</span><span class="p">:</span> <span class="kc">fixed</span><span class="p">;</span>
    <span class="k">bottom</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div></div>

<h1>
<span id="アイコンをつける" class="fragment"></span><a href="#%E3%82%A2%E3%82%A4%E3%82%B3%E3%83%B3%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>アイコンをつける</h1>

<p>アイコンは簡単。</p>

<ul>
<li><a href="https://material.io/icons/" rel="nofollow noopener" target="_blank">MATERIAL DESIGN: Icons</a></li>
</ul>

<p>から、該当するアイコンを探して、次のようにするだけ。<code>md-icon</code> でくくってあげると良い。ちなみに、スペースが名前に含まれているアイコンは、<code>_</code> で接続すると良い。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">button</span> <span class="na">md-fab</span> <span class="na">color</span><span class="o">=</span><span class="s">"accent"</span><span class="p">&gt;&lt;</span><span class="nt">md-icon</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-icon"</span><span class="p">&gt;</span>file_upload<span class="p">&lt;/</span><span class="nt">md-icon</span><span class="p">&gt;&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</pre></div></div>

<h1>
<span id="angular-image-upload-のエラー" class="fragment"></span><a href="#angular-image-upload-%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC"><i class="fa fa-link"></i></a>Angular Image upload のエラー</h1>

<p>最初は、実は、Angular Image upload をつか追おうとして、こんなコードをサンプルを元に書いて</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">image-upload</span>
                        <span class="na">url</span><span class="o">=</span><span class="s">"https://httpbin.org/status/200"</span>
                        <span class="na">buttonCaption</span><span class="o">=</span><span class="s">"PRESS ME AAAAAAAAAH"</span>
                        <span class="na">dropBoxMessage</span><span class="o">=</span><span class="s">"DROP ON ME AAAAAAAAAH"</span>
                        <span class="na">clearButtonCaption</span><span class="o">=</span><span class="s">"CLEAR ME AAAAAAAAAH"</span>
                        <span class="err">[</span><span class="na">uploadedFiles</span><span class="err">]="</span><span class="na">images</span><span class="err">"</span><span class="p">&gt;</span>
                      <span class="p">&lt;/</span><span class="nt">image-upload</span><span class="p">&gt;</span>
</pre></div></div>

<p>こんなエラーをゲット。いつもながらJS のエラーは一見意味がわからない。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ERROR TypeError: Cannot read property 'length' of undefined
</pre></div></div>

<p>結論としては、最後のものを外せば良い。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">image-upload</span>
                        <span class="na">url</span><span class="o">=</span><span class="s">"https://httpbin.org/status/200"</span>
                        <span class="na">buttonCaption</span><span class="o">=</span><span class="s">"PRESS ME AAAAAAAAAH"</span>
                        <span class="na">dropBoxMessage</span><span class="o">=</span><span class="s">"DROP ON ME AAAAAAAAAH"</span>
                        <span class="na">clearButtonCaption</span><span class="o">=</span><span class="s">"CLEAR ME AAAAAAAAAH"</span><span class="p">&gt;</span>
                      <span class="p">&lt;/</span><span class="nt">image-upload</span><span class="p">&gt;</span>

</pre></div></div>

<p>出るには出るが、ダサい、、、w</p>

<p><a href="https://camo.qiitausercontent.com/d1a3e7a3fb6106b270e66c4b694bdf30843a2946/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61636663366165662d633339612d316537662d393765612d6365353061346265666535332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d1a3e7a3fb6106b270e66c4b694bdf30843a2946/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61636663366165662d633339612d316537662d393765612d6365353061346265666535332e706e67" alt="Screen Shot 2017-10-05 at 10.45.16 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/acfc6aef-c39a-1e7f-97ea-ce50a4befe53.png"></a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>今日つまづいたところ、学んだことをメモとして書いておいた。Angular2 そして Material Desgin初めてなので、色々勘違いしているかもしれない。その時は、ぜひご指摘ください。</p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://embed.plnkr.co/?show=preview" rel="nofollow noopener" target="_blank">Angular Example</a></li>
<li>
<a href="http://httpbin.org/status/200" rel="nofollow noopener" target="_blank">http://httpbin.org/status/200</a> &lt;- こんなのあるのね。便利</li>
<li>
<a href="https://material.io/guidelines/#" rel="nofollow noopener" target="_blank">Material Deign - introduction</a> をちゃんと読む方がいいのかな。</li>
<li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />25位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/fdeac05069b7cdb5a777">Mockery を試してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-26 02:14:06</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Node.js]</b> <b>[TypeScript]</b> <b>[mockery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://github.com/Microsoft/vsts-task-lib" rel="nofollow noopener" target="_blank">vsts-task-lib</a>で使われている <a href="https://github.com/mfncooper/mockery" rel="nofollow noopener" target="_blank">mockery</a>の挙動が謎だったので、ハローワールドレベルから試して見た。とっても、しょーもないことでクソハマったが、それも含めて書いておく。</p>

<h1>
<span id="mockery-のmock-方式" class="fragment"></span><a href="#mockery-%E3%81%AEmock-%E6%96%B9%E5%BC%8F"><i class="fa fa-link"></i></a>mockery の　mock 方式</h1>

<p>ドキュメントを読んでいると、node のモックは難しいらしく、普通のフレームワークとは違う方式をとっている様子。基本的な話をすると、<code>require(...)</code> が呼ばれたタイミングで、<code>require</code> の先のモジュールをモックにごっそり入れ替えるという方式みたい。</p>

<p>ちなみに、そういう方式なので、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>test.js -&gt; index.js -&gt; special.js
</pre></div></div>

<p>といった感じになっているときに、<code>require('index.js')</code> にも、<code>require('special.js')</code> にもモックをかけられる。つまり、モジュールを読んだ先のモジュールもモックができる。</p>

<h1>
<span id="コードサンプル" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>コードサンプル</h1>

<p>コードを書いてみよう。vsts-task-lib もそうなので、あえて、typescript で記述する。</p>

<p><em>test.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chai'</span><span class="p">).</span><span class="nx">expect</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Index</span> <span class="o">=</span> <span class="s2">"../index"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">mockery</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mockery'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">mock_index_module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">request</span>: <span class="kt">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"I'm mocking"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">mock_special_module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">get_rest_api</span>: <span class="kt">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'mock special rest api'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'Array'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">'mockery testing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">it</span><span class="p">(</span><span class="s1">'is no mock testing'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">index</span><span class="p">.</span><span class="nx">request</span><span class="p">()).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'real http request result'</span><span class="p">);</span>            
        <span class="p">});</span>
        <span class="nx">it</span><span class="p">(</span><span class="s1">'mocks index'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">registerAllowable</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">registerMock</span><span class="p">(</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">mock_index_module</span><span class="p">);</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">enable</span><span class="p">({</span> <span class="nx">useCleanCache</span>: <span class="kt">true</span><span class="p">});</span>
            <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">index</span><span class="p">.</span><span class="nx">request</span><span class="p">()).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">"I'm mocking"</span><span class="p">);</span>
            <span class="c1">// expect(index.other_request()).to.equal('real other response body'); // error</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">disable</span><span class="p">();</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">deregisterAll</span><span class="p">();</span>
        <span class="p">})</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">'mocks special'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">registerAllowable</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">registerMock</span><span class="p">(</span><span class="s2">"./special"</span><span class="p">,</span> <span class="nx">mock_special_module</span><span class="p">);</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">enable</span><span class="p">({</span> <span class="nx">useCleanCache</span>: <span class="kt">true</span><span class="p">});</span> <span class="c1">// 要注意。指定しないと動かない。useCleanChache と間違えてた。</span>
            <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">index</span><span class="p">.</span><span class="nx">request</span><span class="p">()).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">"mock special rest api"</span><span class="p">);</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">disable</span><span class="p">();</span>
            <span class="nx">mockery</span><span class="p">.</span><span class="nx">deregisterAll</span><span class="p">();</span>
        <span class="p">})</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div></div>

<p><em>index.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">special</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./special'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">request() {</span>
    <span class="k">return</span> <span class="nx">special</span><span class="p">.</span><span class="nx">get_rest_api</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">other_request() {</span>
    <span class="k">return</span> <span class="nx">special</span><span class="p">.</span><span class="nx">get_other_api</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nx">request</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">other_request</span> <span class="o">=</span> <span class="nx">other_request</span><span class="p">;</span>

</pre></div></div>

<p><em>special.ts</em></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>export function get_rest_api() {
    return 'real http request result';
};


export function get_other_api() {
    return 'real other response body';
}
</pre></div></div>

<p>ポイントはいくつかあって、mock をかけたいときは、mock を登録して、有効化する必要がある。<br>
使っているメソッドを解説して行きたい。サンプルでは、一段めのモジュール、二段目のモジュールに両方モックをかけている。</p>

<h2>
<span id="mockeryregisterallowablesome_mock_package" class="fragment"></span><a href="#mockeryregisterallowablesome_mock_package"><i class="fa fa-link"></i></a>mockery.registerAllowable('./some_mock_package')</h2>

<p><code>registerAllowable</code> は、モック対象のパッケージとその配下のパッケージに関してモックをかけるぞと宣言するもの。実際は、その配下の<code>require</code> でモックをしなかったらワーニングが出てしまうのでそれを防ぐために記述する。同時に書こうと思ったら</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>mockery.registerAllowables(['async', 'path', 'util']) 
</pre></div></div>

<p>という感じでもかける。終わったら <code>deregisterAllowable</code> をしておく。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>mockery.registerAllowable('./my-source-under-test', true)
</pre></div></div>

<p>という風にもかけるらしい。node はデフォルトでは、モジュールを１回しか読まない。同じパッケージに対して違うMockをかけたい時もあるだろう。そういう時は、<code>unhooking</code> というらしいが、上記のように、<code>true</code> を指定することで、nodeのモジュールが一旦ディレジスターされる。</p>

<h2>
<span id="mockeryregistermockspecial-mock_special_module" class="fragment"></span><a href="#mockeryregistermockspecial-mock_special_module"><i class="fa fa-link"></i></a>mockery.registerMock("./special", mock_special_module)</h2>

<p>これは、Mock するモジュールを指定する。<code>./special</code> の部分は、ワイルドカードとか、かしこい機能がないので、<code>require</code> で呼ばれる時と全く同じ記述が必要らしい。<code>mock_special_module</code> はモック対象を記述する。こんな感じ。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">mock_index_module</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">request</span>: <span class="kt">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"I'm mocking"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="mockeryenable-usecleancache-true" class="fragment"></span><a href="#mockeryenable-usecleancache-true"><i class="fa fa-link"></i></a>mockery.enable({ useCleanCache: true})</h2>

<p>Mock を有効化している。ここの部分で気をつけるのがキャッシュだ。ここでは、<code>useCleanCache</code> に<code>true</code> をセットしている。私もキャッシュの恐ろしさを思い知った（クソハマった）node モジュールのexport は常にキャッシュされる。これは、モックをものすごく難しくしている。<code>mockery</code> は、モジュールのキャッシュをクリアするメカニズムを持っている。このオプションを指定すると、以前のキャッシュうは消されるので良い。</p>

<p>私がハマったのは、<code>useCleanCache</code> をスペルミスしていて、気づかず、エラーも特にでずなぜか Mockがかからないという状態になった。他にも、<code>mockery.resetCache()</code> なんてメソッドもある様子。</p>

<h2>
<span id="var-index--requiresome_mock_package" class="fragment"></span><a href="#var-index--requiresome_mock_package"><i class="fa fa-link"></i></a>var index = require('./some_mock_package')</h2>

<p>あとは、Mock 対象のモジュールを読み込めばいい。実際にモックがかかるのが、そのモジュールの配下としても、一段目のモジュールを指定する。ここのモジュールは<code>registerAllowable</code> と同じになるはず。mockeryを有効化して、<code>require</code>をした瞬間から、この配下の<code>require</code> に登録したmockがあれば、差し替えられる。</p>

<p>ちなみに、Mockのモジュールは、差し替え対象のモジュールが、<code>function A</code>, <code>function B</code> を持っていたとすると、両方の記述が必要になる。（実際は、<code>function A</code> だけモックしたいケースもあるだろうが、そのケースは、function B` から本物にデリゲートするのが良さげかも。</p>

<h1>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h1>

<p>Mockery の動作イメージは掴めたと思う。ただ、<code>issue</code> を見ていると、多くの人が、<code>mock</code>がかからない問題をレポートしている。ただ、私のように、<code>issue</code>を見ると、初期化のタイミングのミスだったり、そういう、普通のMockフレームワークと使い勝手が違うところに起因するようだ。キャッシュが難しいとよくよくわかったのであった。</p>

<p>ちなみに、サンプルソースは、上げておいた。</p>

<ul>
<li><a href="https://github.com/TsuyoshiUshio/MockerySpike" rel="nofollow noopener" target="_blank">TsuyoshiUshio/MockerySpike</a></li>
</ul>

<p>本当はここからもっと実験して見たいところだが、先ほどのしょうもない問題で引っかかって今２時なので寝ることにする。無念。しょーもないものほどハマってしまう。キャッシュは恐ろしいということで。  </p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />26位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/da5fda563d12bd35bbd1">Azure Functions と Azure Active Directory B2C を連携させる　その２</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-29 02:55:29</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Facebook]</b> <b>[AzureActiveDirectory]</b> <b>[AzureFunctions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>前回の記事 <a href="https://qiita.com/TsuyoshiUshio@github/items/8e6c604fa698e39de959" id="reference-406dffe7eb72d2fb2af4">Azure Functions と Azure Active Directory B2C を連携させる　その１<br>
</a>に続いて、Azure Active Directory B2C の Local 認証(email による、ADユーザによる認証）に加えて、ソーシャルによくある Facebook から情報を持ってきて、ログインしたり、新しいユーザを作ったりする機能のセットアップを試してみる。下の図はその設定が終わった図だ。</p>

<p><a href="https://camo.qiitausercontent.com/adb514100b5a43bf158ebace96fcbed6262637f6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61613335613935322d376639392d356138312d323961662d3832653562386438616262302e706e67" target="_blank" rel="nofollow noopener"><img width="1333" alt="Screen Shot 2017-10-29 at 12.32.57 AM.png" src="https://camo.qiitausercontent.com/adb514100b5a43bf158ebace96fcbed6262637f6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61613335613935322d376639392d356138312d323961662d3832653562386438616262302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/aa35a952-7f99-5a81-29af-82e5b8d8abb0.png"></a></p>

<h1>
<span id="facebook-application-を作成する" class="fragment"></span><a href="#facebook-application-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Facebook Application を作成する</h1>

<p>最初に、Facebook Application の登録を行う。方法はここに書いてある。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-fb-app" rel="nofollow noopener" target="_blank">Azure Active Directory B2C: Provide sign-up and sign-in to consumers with Facebook accounts</a></li>
</ul>

<p>全くこのままなので、特に問題ないが、一応自分のを晒しておくとこんな感じ。前回と同じところに設定してみた。</p>

<p>特にポイントとなるのは、ここで、App ID と App Secret を控えておくこと。</p>

<p><a href="https://camo.qiitausercontent.com/59bd1bbfcd64eac4856ea6c06031bb49c1fe60bd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33326136393134662d373232352d323463652d373437342d3438363065663065383036312e706e67" target="_blank" rel="nofollow noopener"><img width="1191" alt="Screen Shot 2017-10-29 at 2.17.49 AM.png" src="https://camo.qiitausercontent.com/59bd1bbfcd64eac4856ea6c06031bb49c1fe60bd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33326136393134662d373232352d323463652d373437342d3438363065663065383036312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/32a6914f-7225-24ce-7474-4860ef0e8061.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/1bf8372ee2248ebe7d107e117ecb77f8f1a094f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37633439616431632d636138352d346239652d326666652d6262373537346232373238352e706e67" target="_blank" rel="nofollow noopener"><img width="937" alt="Screen Shot 2017-10-29 at 2.28.06 AM.png" src="https://camo.qiitausercontent.com/1bf8372ee2248ebe7d107e117ecb77f8f1a094f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37633439616431632d636138352d346239652d326666652d6262373537346232373238352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7c49ad1c-ca85-4b9e-2ffe-bb7574b27285.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/02987fc99836b147d14f7b64e3402cdc8f32d6dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37653563396330352d346538382d313865632d366661342d6661306138643361366262392e706e67" target="_blank" rel="nofollow noopener"><img width="1187" alt="Screen Shot 2017-10-29 at 2.18.11 AM.png" src="https://camo.qiitausercontent.com/02987fc99836b147d14f7b64e3402cdc8f32d6dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37653563396330352d346538382d313865632d366661342d6661306138643361366262392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7e5c9c05-4e88-18ec-6fa4-fa0a8d3a6bb9.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/e81c34e2c14426718dcbbde97f4eea6f9d5e1949/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66366239343636332d643534642d306630362d313562362d3237323738346439333030372e706e67" target="_blank" rel="nofollow noopener"><img width="1197" alt="Screen Shot 2017-10-29 at 2.18.21 AM.png" src="https://camo.qiitausercontent.com/e81c34e2c14426718dcbbde97f4eea6f9d5e1949/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66366239343636332d643534642d306630362d313562362d3237323738346439333030372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f6b94663-d54d-0f06-15b6-272784d93007.png"></a></p>

<h1>
<span id="b2c-側の設定の追加" class="fragment"></span><a href="#b2c-%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>B2C 側の設定の追加</h1>

<h2>
<span id="identity-provider" class="fragment"></span><a href="#identity-provider"><i class="fa fa-link"></i></a>identity provider</h2>

<p>新たに Facebook を登録する。</p>

<p>先ほどの、Facebook Application の App ID と App Secret をここに登録する。</p>

<p><a href="https://camo.qiitausercontent.com/809d41c97fc797d0f56366b344178dc0f1d71545/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39653064616330392d326432392d386666332d386230342d3134303330616163326534662e706e67" target="_blank" rel="nofollow noopener"><img width="540" alt="Screen Shot 2017-10-29 at 2.18.42 AM.png" src="https://camo.qiitausercontent.com/809d41c97fc797d0f56366b344178dc0f1d71545/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39653064616330392d326432392d386666332d386230342d3134303330616163326534662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/9e0dac09-2d29-8ff3-8b04-14030aac2e4f.png"></a></p>

<h2>
<span id="sign-up-or-sign-in-policies" class="fragment"></span><a href="#sign-up-or-sign-in-policies"><i class="fa fa-link"></i></a>Sign-up or sign-in policies</h2>

<p>ここは、新しいのを作るのでなく既存のを選択して編集する。identity provider として　Facebookを登録すると、新たに、Facebook が選択可能になるので選択してセーブするだけ。</p>

<p><a href="https://camo.qiitausercontent.com/725cfec2ae321edd5f3fd2870875a491cea4c620/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66623363346433352d656132642d323266662d626433362d3461636333316461663634642e706e67" target="_blank" rel="nofollow noopener"><img width="896" alt="Screen Shot 2017-10-29 at 2.33.41 AM.png" src="https://camo.qiitausercontent.com/725cfec2ae321edd5f3fd2870875a491cea4c620/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66623363346433352d656132642d323266662d626433362d3461636333316461663634642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/fb3c4d35-ea2d-22ff-bd36-4acc31daf64d.png"></a></p>

<p><em>NOTE:</em> ちなみにここで、reply url が <code>..../.auth/login/aad/callback</code> になっているが、これはこれで良い。ちなみに facebook 専用の reply url は <code>..../.auth/login/facebook/callback</code> だが、今回は専用ではないので、この reply url ではない。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-mobile-how-to-configure-facebook-authentication" rel="nofollow noopener" target="_blank">How to configure your App Service application to use Facebook login</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/7f0ccd79002c9abf42d06564fdc8fd2fdd11e643/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30353966636363622d663065332d326664622d386136392d6264326364646330623335372e706e67" target="_blank" rel="nofollow noopener"><img width="584" alt="Screen Shot 2017-10-29 at 2.19.16 AM.png" src="https://camo.qiitausercontent.com/7f0ccd79002c9abf42d06564fdc8fd2fdd11e643/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30353966636363622d663065332d326664622d386136392d6264326364646330623335372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/059fcccb-f0e3-2fdb-8a69-bd2cddc0b357.png"></a></p>

<h1>
<span id="azure-functions-の設定" class="fragment"></span><a href="#azure-functions-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Azure Functions の設定</h1>

<p>設定は変更する必要はない。紛らわしいのが プロバイダとして、Facebook という項目があることで、Action to take when request is not authenticated のところでも、Log in with Facebook というのが選べるが、ここは、Active Directory のままで良い。私は間違えて、Facebook もコンフィグしているが使われていない。<br>
　Facebook というのは、Facebook の単独認証のことで、今回は、新しいユーザを作っても、Facebook から情報をもらって、AD にユーザ登録をする。だからAD の認証なのだ。上にややこしい注意書きが出ているが無視して良い。そもそもここに書いてあることは Functions では設定できない。</p>

<p><a href="https://camo.qiitausercontent.com/96fd81f070c6fd3cd57bf8aa8f2a38dceb4d8191/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66313537613933652d316565652d653031322d336331642d3339663238656364613365652e706e67" target="_blank" rel="nofollow noopener"><img width="577" alt="Screen Shot 2017-10-29 at 2.38.23 AM.png" src="https://camo.qiitausercontent.com/96fd81f070c6fd3cd57bf8aa8f2a38dceb4d8191/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66313537613933652d316565652d653031322d336331642d3339663238656364613365652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f157a93e-1eee-e012-3c1d-39f28ecda3ee.png"></a></p>

<h1>
<span id="悲惨なる結果" class="fragment"></span><a href="#%E6%82%B2%E6%83%A8%E3%81%AA%E3%82%8B%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>悲惨なる結果</h1>

<p>実はこの設定は完璧なのだが、私がトライすると、悲惨なことになった。Facebookの認証のページも出てくるのだが、最終的につぎのようになメッセージが帰ってきた。B2C, Facebookのアクティビティログにも特に何も出ていない。インターネットをみても、それらしい情報もない。</p>

<blockquote>
<p>You do not have permission to view this directory or page.</p>
</blockquote>

<p>正直、１日ぐらい悩んで、今わかった。なぜわかったかというと、Azure Functions には、Kudo という仕組みがあり、中身がみれる。</p>

<p><a href="https://camo.qiitausercontent.com/595036732cf6c9f9d3d98538c2a3ff7c22054cc8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34363632366135652d333933322d636263642d313962302d3863353364376236383137372e706e67" target="_blank" rel="nofollow noopener"><img width="1154" alt="Screen Shot 2017-10-29 at 2.44.42 AM.png" src="https://camo.qiitausercontent.com/595036732cf6c9f9d3d98538c2a3ff7c22054cc8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34363632366135652d333933322d636263642d313962302d3863353364376236383137372e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/46626a5e-3932-cbcd-19b0-8c53d7b68177.png"></a></p>

<p>散々色々設定を試してダメだった挙句、ふと思いついてここをみると</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>2017-10-28T15:58:05  PID[14244] Error       An error of type 'server_error' occurred during the login process: 'AADB2C90243: The IDP's client key/secret is not properly configured.
Correlation ID: 3a08ed5b-ed71-4763-94a0-2b9e0771474a
Timestamp: 2017-10-28 15:58:05Z
'
2017-10-28T15:58:48  PID[14244] Error       An error of type 'server_error' occurred during the login process: 'AADB2C90243%3a+The+IDP%27s+client+key%2fsecret+is+not+properly+configured.%0d%0aCorrelation+ID%3a+4fadd580-fa82-49be-8c79-16265b84e22d%0d%0aTimestamp%3a+2017-10-28+15%3a58%3a48Z%0d%0a'

</pre></div></div>

<p>な、なんだと、IDP's client key/secret が間違っているだと、、、俺は確かに、Facebook Application のページからコピー＆ペーストしたはず、、、もう一度、、、</p>

<p>原因がわかった。なんと、私は、OneNote にコピペしたのだが、その時に先頭が大文字になっていた orz。こんな単純なことが原因だったとは、、、orz</p>

<p><a href="https://camo.qiitausercontent.com/3423ad8b77f976908056d1cb796fb11b647241e1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33323737633565612d323134332d636261352d656264632d3061636432633866363032642e706e67" target="_blank" rel="nofollow noopener"><img width="1333" alt="Screen Shot 2017-10-29 at 12.32.57 AM.png" src="https://camo.qiitausercontent.com/3423ad8b77f976908056d1cb796fb11b647241e1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33323737633565612d323134332d636261352d656264632d3061636432633866363032642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/3277c5ea-2143-cba5-ebdc-0acd2c8f602d.png"></a></p>

<p>そして、ついに、エラーが出ずここに来た！</p>

<p><a href="https://camo.qiitausercontent.com/cad9b03be8244667d9f1c0d8ee06d2baa4e838b0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33653139313735392d386435612d346331612d383261392d3666663032663133333765622e706e67" target="_blank" rel="nofollow noopener"><img width="1315" alt="Screen Shot 2017-10-29 at 2.49.20 AM.png" src="https://camo.qiitausercontent.com/cad9b03be8244667d9f1c0d8ee06d2baa4e838b0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33653139313735392d386435612d346331612d383261392d3666663032663133333765622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/3e191759-8d5a-4c1a-82a9-6ff02f1337eb.png"></a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>B2C は結局むっちゃくちゃ簡単に設定できたのだった。ただ一点間抜けにもパスワードの先頭が大文字になっていたことをのぞいて、、、いけてるエンジニアになるときは、ロジカルに考えよう。まずログを見よう。話はそれからだ。</p>

<p>よし、これで、Facebook まで組み込めた。明日は、多要素認証を決めて終わりだ！</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-mobile-how-to-configure-active-directory-authentication" rel="nofollow noopener" target="_blank">How to configure your App Service application to use Azure Active Directory login</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />27位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/a5bc75817e39579227ad">Angular 4 マテリアルデザインのダイアログ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-28 23:40:32</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[MaterialDesign]</b> <b>[Angular4]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今日は、マテリアルデザインのダイアログを初めて触って最初動かなかったので、メモとして残しておく。やりたいことは、何かを登録したら、登録しました！とダイアログを出して、画面遷移したいという簡単なもの。</p>

<p>ハマりポイントは一箇所だけ。</p>

<ul>
<li><a href="https://material.angular.io/components/dialog/overview" rel="nofollow noopener" target="_blank">Angular Material / Diaglog</a></li>
</ul>

<p>基本このままだけど、ドキュメントが古い。<code>Mdxxx</code> は <code>Matxxx</code> に置き換えて参照すること。だから、ダイアログを出したいところに、こんな感じで書けばいいでしょう。</p>

<h1>
<span id="動くと思われたコード" class="fragment"></span><a href="#%E5%8B%95%E3%81%8F%E3%81%A8%E6%80%9D%E3%82%8F%E3%82%8C%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>動くと思われたコード</h1>

<p>あとは、必要なタイミングで、openDialog() を呼び出したらいいだけなんちゃう？</p>

<p><em>xxxx.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span><span class="nx">MatDialog</span><span class="p">,</span> <span class="nx">MatDialogRef</span><span class="p">,</span> <span class="nx">MAT_DIALOG_DATA</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/material'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Router</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
 <span class="o">:</span>

<span class="kr">export</span> <span class="kr">class</span> <span class="nx">xxxComponent</span> <span class="p">{</span>
  <span class="kr">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">dialog</span>:<span class="kt">MatDialog</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">router</span>:<span class="kt">Router</span><span class="p">)</span> <span class="p">{}</span>
    <span class="nx">openDialog</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">dialogRef</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dialog</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">ConfirmDialog</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">width</span><span class="o">:</span> <span class="s1">'400px'</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="s1">'215px'</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">name</span>: <span class="kt">this.car.name</span><span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">dialogRef</span><span class="p">.</span><span class="nx">afterClosed</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"The dialog was closed"</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/dashboard'</span><span class="p">]);</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">@Component</span><span class="p">({</span>
  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'confirm-dialog'</span><span class="p">,</span>
  <span class="nx">template</span><span class="o">:</span> <span class="err">`</span>
  <span class="o">&lt;</span><span class="nx">h2</span> <span class="nx">mat</span><span class="o">-</span><span class="nx">dialog</span><span class="o">-</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">Success</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
  <span class="o">&lt;</span><span class="nx">mat</span><span class="o">-</span><span class="nx">dialog</span><span class="o">-</span><span class="nx">content</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Thank</span> <span class="nx">you</span> <span class="k">for</span> <span class="nx">uploading</span><span class="o">!&lt;</span><span class="err">/p&gt;</span>
  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{{</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">}}</span> <span class="nx">is</span> <span class="nx">waiting</span> <span class="k">for</span> <span class="nx">evaluation</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
  <span class="o">&lt;</span><span class="err">/mat-dialog-content&gt;</span>
  <span class="o">&lt;</span><span class="nx">mat</span><span class="o">-</span><span class="nx">dialog</span><span class="o">-</span><span class="nx">actions</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">mat</span><span class="o">-</span><span class="nx">button</span> <span class="p">[</span><span class="nx">mat</span><span class="o">-</span><span class="nx">dialog</span><span class="o">-</span><span class="nx">close</span><span class="p">]</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span><span class="nx">Close</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
  <span class="o">&lt;</span><span class="err">/mat-dialog-actions&gt;</span>
  <span class="err">`</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">ConfirmDialog</span> <span class="p">{</span>
     <span class="kr">constructor</span><span class="p">(</span>
      <span class="kr">public</span> <span class="nx">dialogRef</span>: <span class="kt">MatDialogRef</span><span class="o">&lt;</span><span class="nx">ConfirmDialog</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="kd">@Inject</span><span class="p">(</span><span class="nx">MAT_DIALOG_DATA</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">data</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{}</span>

      <span class="nx">onClick</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dialogRef</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="p">}</span>
<span class="p">}</span>

</pre></div></div>

<p><em>material.module.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span>
  <span class="nx">MatMenuModule</span><span class="p">,</span>
  <span class="nx">MatToolbarModule</span><span class="p">,</span>
  <span class="nx">MatIconModule</span><span class="p">,</span>
  <span class="nx">MatTabsModule</span><span class="p">,</span>
  <span class="nx">MatCardModule</span><span class="p">,</span>
  <span class="nx">MatGridListModule</span><span class="p">,</span>
  <span class="nx">MatButtonModule</span><span class="p">,</span>
  <span class="nx">MatInputModule</span><span class="p">,</span>
  <span class="nx">MatDialogModule</span><span class="p">,</span>   <span class="o">&lt;-</span> <span class="err">追加</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/material'</span><span class="p">;</span>

<span class="kd">@NgModule</span><span class="p">({</span>
  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">MatMenuModule</span><span class="p">,</span>
    <span class="nx">MatToolbarModule</span><span class="p">,</span>
    <span class="nx">MatIconModule</span><span class="p">,</span>
    <span class="nx">MatTabsModule</span><span class="p">,</span>
    <span class="nx">MatCardModule</span><span class="p">,</span>
    <span class="nx">MatGridListModule</span><span class="p">,</span>
    <span class="nx">MatButtonModule</span><span class="p">,</span>
    <span class="nx">MatInputModule</span><span class="p">,</span>
    <span class="nx">MatDialogModule</span> <span class="o">&lt;-</span> <span class="err">追加</span>
  <span class="p">],</span>
  <span class="nx">exports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">MatMenuModule</span><span class="p">,</span>
    <span class="nx">MatToolbarModule</span><span class="p">,</span>
    <span class="nx">MatIconModule</span><span class="p">,</span>
    <span class="nx">MatTabsModule</span><span class="p">,</span>
    <span class="nx">MatCardModule</span><span class="p">,</span>
    <span class="nx">MatGridListModule</span><span class="p">,</span>
    <span class="nx">MatButtonModule</span><span class="p">,</span>
    <span class="nx">MatInputModule</span><span class="p">,</span>
    <span class="nx">MatDialogModule</span> <span class="o">&lt;-</span> <span class="err">追加</span>
  <span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">MaterialModule</span> <span class="p">{}</span>
</pre></div></div>

<p>しかし、実際は動かない。<code>entryComponents</code> に足すの忘れてない？的なエラーがでる。<br>
で、<code>entryComponents</code>って何よ？</p>

<h1>
<span id="entrycomponents-を設定する" class="fragment"></span><a href="#entrycomponents-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>entryComponents を設定する</h1>

<ul>
<li><a href="https://stackoverflow.com/questions/43815995/what-is-the-difference-between-declarations-and-entrycomponents" rel="nofollow noopener" target="_blank">What is the difference between declarations and entryComponents</a></li>
</ul>

<blockquote>
<p>The entryComponents array is used to define only components that are not found in html and created dynamically with ComponentFactoryResolver. Angular needs this hint to find them and compile. All other components should just be listed in the declarations array.</p>
</blockquote>

<p>つまり、entryComponents に登録するものは、HTML には出てこないが、ダイナミックに作成されるもの。まさにダイアログはそれだね。<code>app.module.ts</code> に追加すると良い</p>

<p><em>app.module.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kd">@NgModule</span><span class="p">({</span>
  <span class="nx">declarations</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">CarDetailComponent</span><span class="p">,</span>
    <span class="nx">DashboardComponent</span><span class="p">,</span>
    <span class="nx">ConfirmDialog</span>   <span class="o">&lt;-</span> <span class="err">追加した</span>
  <span class="p">],</span>
  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">HttpModule</span><span class="p">,</span>
    <span class="nx">MaterialModule</span><span class="p">,</span>
    <span class="nx">BrowserAnimationsModule</span><span class="p">,</span>
    <span class="nx">AppRoutingModule</span><span class="p">,</span>
    <span class="nx">ImageUploadModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(),</span>
  <span class="p">],</span>
  <span class="nx">entryComponents</span><span class="o">:</span> <span class="p">[</span> <span class="o">&lt;-</span> <span class="err">追加した</span>
    <span class="nx">ConfirmDialog</span>
  <span class="p">],</span>
  <span class="nx">providers</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">bootstrap</span><span class="o">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</pre></div></div>

<p>無事、しっかりとダイアログがオープンした。　</p>

<h1>
<span id="ダイアログへの値の引き渡し" class="fragment"></span><a href="#%E3%83%80%E3%82%A4%E3%82%A2%E3%83%AD%E3%82%B0%E3%81%B8%E3%81%AE%E5%80%A4%E3%81%AE%E5%BC%95%E3%81%8D%E6%B8%A1%E3%81%97"><i class="fa fa-link"></i></a>ダイアログへの値の引き渡し</h1>

<p>他のポイントとしては、ダイアログに何か情報を引き渡したいときはつぎのようにしてあげると良い</p>

<p><em>html</em></p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{data.name}} is waiting for evaluation<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</pre></div></div>

<p><em>xxxx.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span>    <span class="nx">openDialog</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">dialogRef</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dialog</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">ConfirmDialog</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">width</span><span class="o">:</span> <span class="s1">'400px'</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="s1">'215px'</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">name</span>: <span class="kt">this.car.name</span><span class="p">}</span>
    <span class="p">});</span>
</pre></div></div>

<p>簡単でした。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />28位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/8e6c604fa698e39de959">Azure Functions と Azure Active Directory B2C を連携させる　その１</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-27 23:45:43</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[AzureActiveDirectory]</b> <b>[AzureFunctions]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Azure Functions を 使うときに認証をかけたい場合があるだろう。今回は、つぎの３つのテーマを達成するために少しづつやってみよう。</p>

<p><a href="https://camo.qiitausercontent.com/088f10a99b48b4f18411c054976b005f0752bce6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36653830373437622d353930372d316437612d373132662d6534653435323930313061652e706e67" target="_blank" rel="nofollow noopener"><img width="1225" alt="Screen Shot 2017-10-27 at 10.36.15 PM.png" src="https://camo.qiitausercontent.com/088f10a99b48b4f18411c054976b005f0752bce6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36653830373437622d353930372d316437612d373132662d6534653435323930313061652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/6e80747b-5907-1d7a-712f-e4e4529010ae.png"></a></p>

<ul>
<li>Azure Functions と、<a href="https://azure.microsoft.com/en-us/services/active-directory-b2c/" rel="nofollow noopener" target="_blank">Azure Active Directory B2c</a> を連携させてユーザ認証する</li>
<li>Facebook と連携してアカウントを作れるようにする</li>
<li>多要素認証を有効にする</li>
<li>RBAC</li>
</ul>

<p>まずは今回は最初の一つ目からやってみたい。</p>

<h1>
<span id="1-azure-active-directory-b2c-を作成する" class="fragment"></span><a href="#1-azure-active-directory-b2c-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. Azure Active Directory B2C を作成する</h1>

<p><a href="https://azure.microsoft.com/en-us/services/active-directory-b2c/" rel="nofollow noopener" target="_blank">Azure Active Directory B2C</a> はクラウドのID マネジメントシステムで、一般ユーザ向けに認証認可の管理や、多くの、SNSとの連携 (Facebook, Google 等) 多要素認証など、コンシューマ向けのID管理で必要なことは一通りできる様子。さて、これをServerless の基盤と合わせて設定するとどれぐらいでできるだろうか？</p>

<h2>
<span id="11-azure-active-directory-b2c-とテナントと作成する" class="fragment"></span><a href="#11-azure-active-directory-b2c-%E3%81%A8%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E3%81%A8%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1.1. Azure Active Directory B2C とテナントと作成する</h2>

<p>最初に、Azure Active Directory B2C を作成する。普通にポータルから作れる。するとつぎのような選択が出て来るので、Create a new Azure AD B2C Tenant を選ぶ。これを選ぶと、テナントが作られる。</p>

<p><a href="https://camo.qiitausercontent.com/ec42b818e36430c09d2329f499c805e3ffeb844a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35316630623730662d383535322d636133362d636638382d6639333934656436346335662e706e67" target="_blank" rel="nofollow noopener"><img width="582" alt="Screen Shot 2017-10-27 at 10.37.57 PM.png" src="https://camo.qiitausercontent.com/ec42b818e36430c09d2329f499c805e3ffeb844a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35316630623730662d383535322d636133362d636638382d6639333934656436346335662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/51f0b70f-8552-ca36-cf88-f9394ed64c5f.png"></a></p>

<p>なぜかJapan がないので、US にしておくが、つぎのような画面が出て来るので、情報を入れて、Create を押すと、テナントと、Azure Active Directory B2C が出来上がる。</p>

<p><a href="https://camo.qiitausercontent.com/6fab3887fc1455fc6b094a4189657c43a2fd8b4b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32646534316661312d386332622d633831392d633965632d6537613737373162363530332e706e67" target="_blank" rel="nofollow noopener"><img width="318" alt="Screen Shot 2017-10-27 at 10.38.40 PM.png" src="https://camo.qiitausercontent.com/6fab3887fc1455fc6b094a4189657c43a2fd8b4b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32646534316661312d386332622d633831392d633965632d6537613737373162363530332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/2de41fa1-8c2b-c819-c9ec-e7a7771b6503.png"></a></p>

<p>ところが、これだけだと、サブスクリプションが紐づいてないので、何もできない。紐付けよう</p>

<p><a href="https://camo.qiitausercontent.com/746f18a77dfafcdac66e7165db02fecef816f0d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37306366373463322d633830642d356661612d393464652d3464663737613431623764322e706e67" target="_blank" rel="nofollow noopener"><img width="871" alt="Screen Shot 2017-10-27 at 10.45.35 PM.png" src="https://camo.qiitausercontent.com/746f18a77dfafcdac66e7165db02fecef816f0d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37306366373463322d633830642d356661612d393464652d3464663737613431623764322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/70cf74c2-c80d-5faa-94de-4df77a41b7d2.png"></a></p>

<h2>
<span id="12b2c-とサブスクリプションを紐付ける" class="fragment"></span><a href="#12b2c-%E3%81%A8%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E7%B4%90%E4%BB%98%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>1.2.　B2C とサブスクリプションを紐付ける</h2>

<p>これで、サブスクリプションとの紐付けができた。リソースグループに、B2C ができているので、それをクリックして、こちらをクリック</p>

<p><a href="https://camo.qiitausercontent.com/bb1d97e59a28ade9fec1a5f99125794af3bdc19b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61316463306337312d393830392d383063382d343863392d3232376463396631383733662e706e67" target="_blank" rel="nofollow noopener"><img width="242" alt="Screen Shot 2017-10-27 at 10.47.14 PM.png" src="https://camo.qiitausercontent.com/bb1d97e59a28ade9fec1a5f99125794af3bdc19b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61316463306337312d393830392d383063382d343863392d3232376463396631383733662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a1dc0c71-9809-80c8-48c9-227dc9f1873f.png"></a></p>

<h1>
<span id="2-アプリケーションを作成する" class="fragment"></span><a href="#2-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. アプリケーションを作成する</h1>

<p>認証をかけてリソースを守る対象を「アプリケーション」として登録する。</p>

<h2>
<span id="21-azure-function-を作成する" class="fragment"></span><a href="#21-azure-function-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2.1. Azure Function を作成する</h2>

<p>適当に Http Trigger の Function を作成してみよう。</p>

<p><a href="https://camo.qiitausercontent.com/3e60a39f22382921d6771cc4f95e5c9d26e84467/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64313431313434302d326638362d383630322d663866302d3638643937393939313337322e706e67" target="_blank" rel="nofollow noopener"><img width="1099" alt="Screen Shot 2017-10-27 at 10.54.33 PM.png" src="https://camo.qiitausercontent.com/3e60a39f22382921d6771cc4f95e5c9d26e84467/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64313431313434302d326638362d383630322d663866302d3638643937393939313337322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/d1411440-2f86-8602-f8f0-68d979991372.png"></a></p>

<p>URL が取得できる。</p>

<h2>
<span id="22-アプリケーションを登録する" class="fragment"></span><a href="#22-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2.2. アプリケーションを登録する</h2>

<p>この 保護する対象のアプリケーションを B2C に登録しよう。</p>

<p><a href="https://camo.qiitausercontent.com/c5ced4afe5cba7ade02a0deb84eab284226dc1ea/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34393738356135362d393364362d393161382d373038662d3663323730353664666633332e706e67" target="_blank" rel="nofollow noopener"><img width="577" alt="Screen Shot 2017-10-27 at 10.50.23 PM.png" src="https://camo.qiitausercontent.com/c5ced4afe5cba7ade02a0deb84eab284226dc1ea/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34393738356135362d393364362d393161382d373038662d3663323730353664666633332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/49785a56-93d6-91a8-708f-6c27056dff33.png"></a></p>

<p><code>Add</code> ボタンをクリックしてアプリを登録</p>

<p>アプリを登録するときのポイントは一つだけで、Reply URL に保護対象のFunction App のURL + <code>.auth/login/aad/callback</code> というURLにする。これは、AD側で認証してもらった後に、Azure Functions 側に戻って来るときのURLだ。ここで、ADからのトークンを受け取って、ユーザを登録したり認証したりする。</p>

<p><a href="https://camo.qiitausercontent.com/d4475ca820c85dddc65aeb55ebacfb4139aa70f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64663061376261622d353837382d363735302d356239362d3564393432653832636237622e706e67" target="_blank" rel="nofollow noopener"><img width="581" alt="Screen Shot 2017-10-27 at 10.57.58 PM.png" src="https://camo.qiitausercontent.com/d4475ca820c85dddc65aeb55ebacfb4139aa70f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64663061376261622d353837382d363735302d356239362d3564393432653832636237622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/df0a7bab-5878-6750-5b96-5d942e82cb7b.png"></a></p>

<p>アプリができると、IDが振られる</p>

<p><a href="https://camo.qiitausercontent.com/5ce4ad7d630c46543cf850de07f21b43b0dd533b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30633436643965642d333066632d643933662d313964622d6330353034633730613137302e706e67" target="_blank" rel="nofollow noopener"><img width="698" alt="Screen Shot 2017-10-27 at 10.58.51 PM.png" src="https://camo.qiitausercontent.com/5ce4ad7d630c46543cf850de07f21b43b0dd533b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30633436643965642d333066632d643933662d313964622d6330353034633730613137302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/0c46d9ed-30fc-d93f-19db-c0504c70a170.png"></a></p>

<p>ただ、これだけだと、まだ何もできない。</p>

<h2>
<span id="3-sign-up-or-sign-in-policy-を設定する" class="fragment"></span><a href="#3-sign-up-or-sign-in-policy-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. Sign up or Sign in Policy を設定する</h2>

<p>まずは追加ボタン</p>

<p><a href="https://camo.qiitausercontent.com/b6045556715bae594cf98f9d4e2636f692c700b0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66343934353236352d386630622d333164632d306335352d3438626131623831623134642e706e67" target="_blank" rel="nofollow noopener"><img width="485" alt="Screen Shot 2017-10-27 at 11.03.01 PM.png" src="https://camo.qiitausercontent.com/b6045556715bae594cf98f9d4e2636f692c700b0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66343934353236352d386630622d333164632d306335352d3438626131623831623134642e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f4945265-8f0b-31dc-0c55-48ba1b81b14d.png"></a></p>

<p>今回は、一般ユーザをe-mail/passowrd で認証するので、Local 認証というのを選ぶ</p>

<p><a href="https://camo.qiitausercontent.com/344406a375dfa1efe27734931e3aa2cc659687fb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36396130663337302d323165632d623066332d613864322d6639633366376465643363352e706e67" target="_blank" rel="nofollow noopener"><img width="894" alt="Screen Shot 2017-10-27 at 11.05.02 PM.png" src="https://camo.qiitausercontent.com/344406a375dfa1efe27734931e3aa2cc659687fb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36396130663337302d323165632d623066332d613864322d6639633366376465643363352e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/69a0f370-21ec-b0f3-a8d2-f9c3f7ded3c5.png"></a></p>

<p>Select sign-up attributes はサインアップするときに必要な項目を定義する。もちろんe-mail (password はカウントしない）だけでやりたいので、<code>e-mail</code> のみ選択。</p>

<p><a href="https://camo.qiitausercontent.com/d01a757464b985c4959f5989904822821f56ac9d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32313439336431302d633966642d396635362d326632302d3434373636353164323036302e706e67" target="_blank" rel="nofollow noopener"><img width="849" alt="Screen Shot 2017-10-27 at 11.05.25 PM.png" src="https://camo.qiitausercontent.com/d01a757464b985c4959f5989904822821f56ac9d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32313439336431302d633966642d396635362d326632302d3434373636353164323036302e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/21493d10-c9fd-9f56-2f20-4476651d2060.png"></a></p>

<p>Select Application Claim は、認証後にアプリにどういう情報を渡すか？という設定。いろんな値が渡せる。基本的にリクエストヘッダーから取得できる様子。</p>

<ul>
<li><a href="https://docs.microsoft.com/ja-jp/azure/app-service/app-service-authentication-overview" rel="nofollow noopener" target="_blank">Azure App Service での認証および承認</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/6a05f3a94bf5e8bba3e60f224294d58046236a8f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38613731303133342d663937392d623839612d303233312d3331356434666637663535612e706e67" target="_blank" rel="nofollow noopener"><img width="841" alt="Screen Shot 2017-10-27 at 11.05.44 PM.png" src="https://camo.qiitausercontent.com/6a05f3a94bf5e8bba3e60f224294d58046236a8f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38613731303133342d663937392d623839612d303233312d3331356434666637663535612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/8a710134-f979-b89a-0231-315d4ff7f55a.png"></a></p>

<p>最終的に、この画面になるので、Create を押すとポリシーができる。</p>

<p><a href="https://camo.qiitausercontent.com/6c38d0d713376f2f58a6981a72f44e59ec9fa467/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37666537633135302d393363342d383833612d353661352d6664336461333232363265342e706e67" target="_blank" rel="nofollow noopener"><img width="311" alt="Screen Shot 2017-10-27 at 11.06.43 PM.png" src="https://camo.qiitausercontent.com/6c38d0d713376f2f58a6981a72f44e59ec9fa467/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37666537633135302d393363342d383833612d353661352d6664336461333232363265342e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7fe7c150-93c4-883a-56a5-fd3da32262e4.png"></a></p>

<h1>
<span id="3-azure-function-の設定" class="fragment"></span><a href="#3-azure-function-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>3. Azure Function の設定</h1>

<p>Authentication / Authorization をクリック</p>

<p><a href="https://camo.qiitausercontent.com/306ac763e7634505b4a0f1512af8779d28684ce4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64666634353933632d616539632d343838362d646565632d3134666431353730623331382e706e67" target="_blank" rel="nofollow noopener"><img width="1052" alt="Screen Shot 2017-10-27 at 11.15.00 PM.png" src="https://camo.qiitausercontent.com/306ac763e7634505b4a0f1512af8779d28684ce4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64666634353933632d616539632d343838362d646565632d3134666431353730623331382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/dff4593c-ae9c-4886-deec-14fd1570b318.png"></a></p>

<p>設定画面が出て来るので、<code>App Service Authentication</code> を <code>On</code> にして、Action to take when request is not authenticated を<code>Log in with Active Directory</code> に設定し、Azure Active Directory をクリック</p>

<p><a href="https://camo.qiitausercontent.com/bea150d41db38d5d544aa3e01a73e44a7a030e8f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37376638323435312d353330302d373330312d346462342d3634363463353461633631662e706e67" target="_blank" rel="nofollow noopener"><img width="580" alt="Screen Shot 2017-10-27 at 11.17.05 PM.png" src="https://camo.qiitausercontent.com/bea150d41db38d5d544aa3e01a73e44a7a030e8f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37376638323435312d353330302d373330312d346462342d3634363463353461633631662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/77f82451-5300-7301-4db4-6464c54ac61f.png"></a></p>

<p>設定に行く前に、先ほど設定したSign up or Sign in Policy を開いてみるとつぎのような画面になっている。赤で囲んだところをコピーしておく。よくみると、Application で設定した値が設定されているのがわかるだろう。</p>

<p><a href="https://camo.qiitausercontent.com/e626ad468a39be75b8a14799830176e446f87ff4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64303765386562382d383635342d646334382d626130362d3662636130633030333964382e706e67" target="_blank" rel="nofollow noopener"><img width="577" alt="Screen Shot 2017-10-27 at 11.18.47 PM.png" src="https://camo.qiitausercontent.com/e626ad468a39be75b8a14799830176e446f87ff4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64303765386562382d383635342d646334382d626130362d3662636130633030333964382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/d07e8eb8-8654-dc48-ba06-6bca0c0039d8.png"></a></p>

<p>そして、先ほどの、AD の設定画面に戻る。</p>

<p>Client ID に Application を作成したら取得できた Application ID をセットする。Issuer Url には、先ほど Sign up or Sign in Policy で取得したURLを貼っておく。これは、AD B2C とテナントの発行者のURL。</p>

<p><a href="https://camo.qiitausercontent.com/fbd0203c3d5b0e11dcc05b87d579878e73524817/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35323136623331622d353037342d373233342d636136622d3339383230633461663231322e706e67" target="_blank" rel="nofollow noopener"><img width="576" alt="Screen Shot 2017-10-27 at 11.20.31 PM.png" src="https://camo.qiitausercontent.com/fbd0203c3d5b0e11dcc05b87d579878e73524817/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35323136623331622d353037342d373233342d636136622d3339383230633461663231322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/5216b31b-5074-7234-ca6b-39820c4af212.png"></a></p>

<p>これで設定OK！しっかりセーブしておこう</p>

<p><a href="https://camo.qiitausercontent.com/f085e82fec68c525e426e7ed32f204eca07f5a76/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30386362643861632d636464362d643436642d656665322d3531333165383166636364362e706e67" target="_blank" rel="nofollow noopener"><img width="575" alt="Screen Shot 2017-10-27 at 11.20.55 PM.png" src="https://camo.qiitausercontent.com/f085e82fec68c525e426e7ed32f204eca07f5a76/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30386362643861632d636464362d643436642d656665322d3531333165383166636364362e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/08cbd8ac-cdd6-d46d-efe2-5131e81fccd6.png"></a></p>

<ol>
<li>動作確認</li>
</ol>

<p>Sign up or Sign in Policyをサイド開けてみよう。よくみると、Run now というボタンがある。実はこれで設定を試せる。押してみよう。</p>

<p><a href="https://camo.qiitausercontent.com/4b88d3dd364f2ba90a8daba73a813632e3a4a7d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32306266643635322d393665382d323436332d323762662d3435666532376561333833312e706e67" target="_blank" rel="nofollow noopener"><img width="574" alt="Screen Shot 2017-10-27 at 11.31.42 PM.png" src="https://camo.qiitausercontent.com/4b88d3dd364f2ba90a8daba73a813632e3a4a7d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32306266643635322d393665382d323436332d323762662d3435666532376561333833312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/20bfd652-96e8-2463-27bf-45fe27ea3831.png"></a></p>

<p>できてるっぽい</p>

<p><a href="https://camo.qiitausercontent.com/875e8722996b1e7058af2196a74cd37b7052ad53/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64323338303538372d346564362d333161652d373830362d3331393634343163346162332e706e67" target="_blank" rel="nofollow noopener"><img width="1346" alt="Screen Shot 2017-10-27 at 11.33.37 PM.png" src="https://camo.qiitausercontent.com/875e8722996b1e7058af2196a74cd37b7052ad53/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64323338303538372d346564362d333161652d373830362d3331393634343163346162332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/d2380587-4ed6-31ae-7806-3196441c4ab3.png"></a></p>

<p>せっかくなので、さっき作ってみた Azure Functions をテストしてみる。テスト実行してみると、しっかり、401 の認証エラーになる。さて、最後のテスト</p>

<p><a href="https://camo.qiitausercontent.com/21d7e50a6298018876a7ac5463b16e4bb0c992f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37663264633065612d393662332d366662302d656632652d3330633433353864643635612e706e67" target="_blank" rel="nofollow noopener"><img width="1148" alt="Screen Shot 2017-10-27 at 11.35.17 PM.png" src="https://camo.qiitausercontent.com/21d7e50a6298018876a7ac5463b16e4bb0c992f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37663264633065612d393662332d366662302d656632652d3330633433353864643635612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7f2dc0ea-96b3-6fb0-ef2e-30c4358dd65a.png"></a></p>

<p>Azure Functions のURLを入れてブラウザを叩く。Sign up/in 画面きたー！アカウントないから、サインアップする。</p>

<p><a href="https://camo.qiitausercontent.com/d1fe73d3623560bfd38a3f6e3dd9ca3412f52d00/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32383838653132302d643932362d303431312d666361302d3135666238353162666239652e706e67" target="_blank" rel="nofollow noopener"><img width="1329" alt="Screen Shot 2017-10-27 at 11.36.33 PM.png" src="https://camo.qiitausercontent.com/d1fe73d3623560bfd38a3f6e3dd9ca3412f52d00/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32383838653132302d643932362d303431312d666361302d3135666238353162666239652e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/2888e120-d926-0411-fca0-15fb851bfb9e.png"></a></p>

<p>ちゃんと、e-mail が本当にあるか確認してくれる。そしてセーブ。</p>

<p><a href="https://camo.qiitausercontent.com/f91c20f37e9ae2d90d60123c4f78041912a30388/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36353066343734332d316137352d353435652d613935372d6134393538376431393966612e706e67" target="_blank" rel="nofollow noopener"><img width="440" alt="Screen Shot 2017-10-27 at 11.37.07 PM.png" src="https://camo.qiitausercontent.com/f91c20f37e9ae2d90d60123c4f78041912a30388/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36353066343734332d316137352d353435652d613935372d6134393538376431393966612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/650f4743-1a75-545e-a957-a49587d199fa.png"></a></p>

<p>認証されて動いた！！！</p>

<p><a href="https://camo.qiitausercontent.com/64f2bf5a0daab8a0b963cc3b58bf7f04eaf86a43/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61346361636463652d383961302d363432652d663764342d3166366235326636376336392e706e67" target="_blank" rel="nofollow noopener"><img width="855" alt="Screen Shot 2017-10-27 at 11.38.27 PM.png" src="https://camo.qiitausercontent.com/64f2bf5a0daab8a0b963cc3b58bf7f04eaf86a43/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61346361636463652d383961302d363432652d663764342d3166366235326636376336392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a4cacdce-89a0-642e-f7d4-1f6b52f67c69.png"></a></p>

<p>そして、AD B2C の方には新しいユーザが登録されている。</p>

<p><a href="https://camo.qiitausercontent.com/c56a74d1227526588f96f6dd85c578a144796f5c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65303936633466372d383232352d376664362d396331612d6330313162663663376230332e706e67" target="_blank" rel="nofollow noopener"><img width="1076" alt="Screen Shot 2017-10-27 at 11.39.11 PM.png" src="https://camo.qiitausercontent.com/c56a74d1227526588f96f6dd85c578a144796f5c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65303936633466372d383232352d376664362d396331612d6330313162663663376230332e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/e096c4f7-8225-7fd6-9c1a-c011bf6c7b03.png"></a></p>

<h1>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h1>

<p>次回は、Facebook 認証と多要素認証について書いてみたい！これは楽チンだわ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />29位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/4243ee860b217534c0d2">Angular 4 で Connection String や Secret を Environment Variables から取得する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-18 20:05:13</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> <b>[Angular2]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://12factor.net/" rel="nofollow noopener" target="_blank">The twelve-factor app</a> にある通り、環境依存の情報は、環境変数から設定するようにしたい。しかし、SPA の Angular とかだったらどうするんだろう？きっとこれは基礎的なことなのだけど、意外と自分には難しかったので、今まで学んだことを自分のために、ブログにしておきたい。</p>

<h1>
<span id="environment-variables-を-angular-4-から使う" class="fragment"></span><a href="#environment-variables-%E3%82%92-angular-4-%E3%81%8B%E3%82%89%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>Environment Variables を Angular (4) から使う</h1>

<p>ベストプラクティス的なものがないのかなぁ。と色々調べて見たけど、Facebook でなきを入れていたらヒントをもらえた。</p>

<p><a href="https://camo.qiitausercontent.com/543b1c989a8aaca89700bf4855ce340a51c938b5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62653035363062332d366335382d663661352d383363372d6537376430636338323933322e706e67" target="_blank" rel="nofollow noopener"><img width="501" alt="Screen Shot 2017-10-18 at 7.20.37 PM.png" src="https://camo.qiitausercontent.com/543b1c989a8aaca89700bf4855ce340a51c938b5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62653035363062332d366335382d663661352d383363372d6537376430636338323933322e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/be0560b3-6c58-f6a5-83c7-e77d0cc82932.png"></a></p>

<ul>
<li><a href="https://github.com/angular/angular-cli/issues/4318" rel="nofollow noopener" target="_blank">Request: Method to pass environment variables during build vs file. #4318</a></li>
<li><a href="https://github.com/AngularClass/angular-starter/wiki/How-to-pass-environment-variables%3F" rel="nofollow noopener" target="_blank">How to pass environment variables?</a></li>
</ul>

<h2>
<span id="環境変数を取り込む仕組みのあれこれ" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%82%92%E5%8F%96%E3%82%8A%E8%BE%BC%E3%82%80%E4%BB%95%E7%B5%84%E3%81%BF%E3%81%AE%E3%81%82%E3%82%8C%E3%81%93%E3%82%8C"><i class="fa fa-link"></i></a>環境変数を取り込む仕組みのあれこれ。</h2>

<p>ちなみに、Angular では、環境変数は取り込めない。よくよく考えると、SPA は、ブラウザにダウンロードされて使うのだから、そらそうだ。</p>

<p>上記の記事を読んでいると、どうやら、Angular には、<code>environment</code> という仕組みがあるらしい。そのenvironmentを環境によって変えられる様子。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>src/environments/
├── environment.prod.ts
└── environment.ts
</pre></div></div>

<p>ここを、プロジェクトをビルドする時に切り替える。例えばこんな感じ。</p>

<p>_environment.prod.ts </p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">production</span>: <span class="kt">true</span><span class="p">,</span>
  <span class="nx">hostUrl</span><span class="o">:</span> <span class="s2">"http://some.prod"</span>
<span class="p">};</span>
</pre></div></div>

<p>_environment.ts</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">production</span>: <span class="kt">false</span><span class="p">,</span>
  <span class="nx">hostUrl</span><span class="o">:</span> <span class="s2">"http://some.dev"</span>
<span class="p">}</span>
</pre></div></div>

<p><em>app.component.html</em> に 下記のコードを入れておく。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&lt;h2&gt; ServerName: {{hostUrl}}&lt;/h2&gt;
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ng serve 
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/5099c1789e5acc2f579a1bf98009c4aa285cba1c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35623436633863652d626438302d616531322d303464332d6135663361663363616339612e706e67" target="_blank" rel="nofollow noopener"><img width="886" alt="Screen Shot 2017-10-18 at 7.41.04 PM.png" src="https://camo.qiitausercontent.com/5099c1789e5acc2f579a1bf98009c4aa285cba1c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35623436633863652d626438302d616531322d303464332d6135663361663363616339612e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/5b46c8ce-bd80-ae12-04d3-a5f3af3cac9a.png"></a></p>

<p>だと、デフォルトが起動する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ng serve --environment prod
</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/29ac50c87a3b09f0217c3aebc1ddab75a50f070f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66613831626337372d343736342d346662632d306239652d6163303239326166333662662e706e67" target="_blank" rel="nofollow noopener"><img width="823" alt="Screen Shot 2017-10-18 at 7.41.58 PM.png" src="https://camo.qiitausercontent.com/29ac50c87a3b09f0217c3aebc1ddab75a50f070f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66613831626337372d343736342d346662632d306239652d6163303239326166333662662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/fa81bc77-4764-4fbc-0b9e-ac0292af36bf.png"></a></p>

<p>これでプロダクションが起動した。</p>

<h2>
<span id="環境変数を埋め込む" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>環境変数を埋め込む</h2>

<p>少なくとも <a href="https://cli.angular.io/" rel="nofollow noopener" target="_blank">Angular CLI</a>を使っている時はこの方式で行けそう。いきなり本物のプロジェクトに盛り込むより、プロジェクトを生成してみよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ng new host-inject
</pre></div></div>

<p>この状態から、環境変数を取り込んで見たい。環境変数は Angular では直接取り込めない。色々読んでいると、ビルド時に、プリコンパイルして盛り込むというのが良さげ。</p>

<p>NOTE: 最初、process.env を直接実行しようとしたけど、これは見つかららないと言われる。ちなみにこれは、<code>tsconfig.app.json</code> の下記の部分を追加すると、解消された。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>"CompilerOptions": {
  typs["node"],
    :
}
</pre></div></div>

<p><em>scripts/prebuild.ts</em> というファイルを作ってみる。 テンプレート <em>environment.ts.template</em> を元に、環境変数を取り込んで作成をするシンプルなもの。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">fs</span> <span class="nx">from</span> <span class="s1">'fs'</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">path</span> <span class="nx">from</span> <span class="s1">'path'</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">ejs</span> <span class="nx">from</span> <span class="s1">'ejs'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">environmentFilesDirectory</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'../src/environments'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">targetEnvironmentTemplateFileName</span> <span class="o">=</span> <span class="s1">'environment.ts.template'</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">targetEnvironemntFileName</span> <span class="o">=</span> <span class="s1">'environment.ts'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">defaultEnvValues</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">SOME_HOST</span><span class="o">:</span> <span class="s2">"http://default.com"</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">environmentTemplate</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">environmentFilesDirectory</span><span class="p">,</span> <span class="nx">targetEnvironmentTemplateFileName</span><span class="p">),</span>
    <span class="p">{</span><span class="nx">encoding</span><span class="o">:</span> <span class="s1">'utf-8'</span><span class="p">}</span>
<span class="p">);</span>
<span class="kd">let</span> <span class="nx">obj</span>:<span class="kt">any</span> <span class="o">=</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="nb">Object</span><span class="p">).</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">defaultEnvValues</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">ejs</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">environmentTemplate</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">environmentFilesDirectory</span><span class="p">,</span> <span class="nx">targetEnvironemntFileName</span><span class="p">),</span> <span class="nx">output</span><span class="p">);</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

</pre></div></div>

<p>ちなみに、<code>(&lt;any&gt;Object).assign</code> の部分は当初、Object に assign が見つからないと怒られた。<code>&lt;any&gt;</code> をつけて解決。</p>

<ul>
<li><a href="https://stackoverflow.com/questions/35959372/property-assign-does-not-exist-on-type-objectconstructor" rel="nofollow noopener" target="_blank">Property 'assign' does not exist on type 'ObjectConstructor'</a></li>
</ul>

<p><em>enviornment.ts.template</em> </p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">production</span>: <span class="kt">false</span><span class="p">,</span>
  <span class="nx">hostUrl</span><span class="o">:</span> <span class="s2">"&lt;%= SOME_HOST %&gt;"</span>
<span class="p">};</span>

</pre></div></div>

<p>これを実行するために、package.json に、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>"prebuild": "tsc scripts/prebuild.ts &amp;&amp; node scripts/prebuild.js",
</pre></div></div>

<p>を追加した。</p>

<p>プリビルドする。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ npm run prebuild
</pre></div></div>

<p>しっかり、ファイルがジェネレートされた。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ env
SOME_HOST=http://some.com
</pre></div></div>

<p><em>environment.ts</em></p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">production</span>: <span class="kt">false</span><span class="p">,</span>
  <span class="nx">hostUrl</span><span class="o">:</span> <span class="s2">"http://some.com"</span>
<span class="p">};</span>

</pre></div></div>

<p>バッチリできている。先ほど紹介してもらった記事を見ても、ジェネレートする方法が一番スッキリきた。</p>

<h1>
<span id="本当にこの方式で問題ないのか" class="fragment"></span><a href="#%E6%9C%AC%E5%BD%93%E3%81%AB%E3%81%93%E3%81%AE%E6%96%B9%E5%BC%8F%E3%81%A7%E5%95%8F%E9%A1%8C%E3%81%AA%E3%81%84%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>本当にこの方式で問題ないのか？</h1>

<p>問題は、この方式だと、結局のところ、ブラウザから URL が見れちゃったりするんじゃないの？と思ったが、意外に見えないようだ。もちろん、enviornments の下をうっかり公開する設定にしてないことが大切だとは思うが。よく、SPA を Blob Storage に置くとかの例があるが、ああいうのはどうしているんだろう。Azure Functions Proxy などで制限する感じだろうか。次はその辺をやってみたい。</p>

<p>ちなみに、全てのソースコードはこちらに置いています。</p>

<ul>
<li><a href="https://github.com/TsuyoshiUshio/host-inject" rel="nofollow noopener" target="_blank">TsuyoshiUshio/host-inject</a></li>
</ul>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://medium.com/@kudresov/a-better-way-to-inject-environmental-variables-in-angular-d3b2d01a3c5e" rel="nofollow noopener" target="_blank">A better way to inject environmental variables in Angular</a></li>
<li><a href="https://github.com/angular/angular-cli/issues/4318" rel="nofollow noopener" target="_blank">Request: Method to pass environment variables during build vs file. #4318</a></li>
<li><a href="https://github.com/AngularClass/angular-starter/wiki/How-to-pass-environment-variables%3F" rel="nofollow noopener" target="_blank">How to pass environment variables?</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />30位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/cff85d6d4428dddace06">IoT Edge を触ってみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-17 23:43:19</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[AzureFunctions]</b> <b>[IoTEdge]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Azure の IoT Edge を触ってみた。たまたま社内のハッカソンがあった。私は社内のハッカソンの時は普段触っていない技術を触るようにしている。</p>

<p><a href="https://camo.qiitausercontent.com/62fe2ed47df8737c3a3f9d9311886596ac82c643/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65646339646336652d663266382d313436372d633237332d3864366365383939373866382e706e67" target="_blank" rel="nofollow noopener"><img width="1385" alt="Screen Shot 2017-10-17 at 10.34.54 PM.png" src="https://camo.qiitausercontent.com/62fe2ed47df8737c3a3f9d9311886596ac82c643/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65646339646336652d663266382d313436372d633237332d3864366365383939373866382e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/edc9dc6e-f2f8-1467-c273-8d6ce89978f8.png"></a></p>

<p>本当は、ML をやりたかったが、他にやっている人がいたので、今回は、IoT Edge を担当することになった。IoT Edge は、下記のビデオがわかりやすいが、Intelligent edge と呼ばれるサービスで、サーバーで動いているAzure Functions や、Stream Analytics そしてマシンラーニングを、ローカル（Edge) で動かせるとのことだ。</p>

<ul>
<li><a href="https://azure.microsoft.com/en-us/campaigns/iot-edge/" rel="nofollow noopener" target="_blank">Introducing IoT Edge</a></li>
</ul>

<p>//build で見た時は相当衝撃だったので、今のうちに IoT Edge に触れておきたい。（ちなみに、現状では残念ながら上記の機能を持った IoT Edge 2.0 はリリースされていない様子。無念）ま、ともかく、今日学んだことをメモしておく。</p>

<h1>
<span id="iot-edge-のアーキテクチャ" class="fragment"></span><a href="#iot-edge-%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3"><i class="fa fa-link"></i></a>IoT Edge のアーキテクチャ</h1>

<p>試しに、Ubuntu 14.04 のマシンを Edge と見立ててサンプルが動く環境を作って見た。とてもスムースだった。</p>

<p><a href="https://camo.qiitausercontent.com/ead138832847cb6908f5cf7b49ac209ad452a04d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61656534393431632d616633372d366465362d326237352d3131613332346636363339302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ead138832847cb6908f5cf7b49ac209ad452a04d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61656534393431632d616633372d366465362d326237352d3131613332346636363339302e706e67" alt="image2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/aee4941c-af37-6de6-2b75-11a324f66390.png"></a></p>

<p>Edge 側のアーキテクチャはとてもシンプルだ。（ver1.x) ポイントは、各モジュールが、Broker を経由してデータをやりとりしていること。また、ブローカーを通じて、IoT Hub の方とも通信する。<br>
　ちなみに、Azure Functions も現在のバージョンでも、IoT Hubをサポートしているので、Broker を経由して、メッセージを投げると、IoT Hub にメッセージが送られて、そこからさらに、Azure Functions をキックするということが可能だ。</p>

<h1>
<span id="edge-のインストール" class="fragment"></span><a href="#edge-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Edge のインストール</h1>

<p>こちらもほぼ苦労したところがない。手順のまま。尚環境は、手元に、マシンがないので、Ubuntu 14.04 LTE で代用した。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-linux-iot-edge-get-started" rel="nofollow noopener" target="_blank">Explore Azure IoT Edge architecture on Linux</a></li>
</ul>

<h2>
<span id="関連ライブラリのインストール" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>関連ライブラリのインストール</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get install curl build-essential libcurl4-openssl-dev git cmake pkg-config libssl-dev uuid-dev valgrind libglib2.0-dev libtool autoconf
</pre></div></div>

<h2>
<span id="iot-edge-ファイルの取得とビルド" class="fragment"></span><a href="#iot-edge-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E5%8F%96%E5%BE%97%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89"><i class="fa fa-link"></i></a>iot-edge ファイルの取得とビルド</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>git clone https://github.com/Azure/iot-edge.git
cd iot-edge
tools/build.sh --disable-natibe-remote-modules
</pre></div></div>

<p>ちなみに、<code>samples/hello_world/src/hello_world_lin.json</code> は次のようになっている。このような設定ファイルを見ていると、ブローカーのイメージがうっさらわかるかもしれない。これは、<code>logger</code> <code>hello_world</code> の二つの構成になっていて、<code>hello_world</code>の出力を<code>logger</code> に書き込んでいる。 </p>

<p><em>hello_world</em>lin.json_</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">"modules"</span> <span class="p">:</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">"name"</span> <span class="p">:</span> <span class="s2">"logger"</span><span class="p">,</span>
            <span class="nt">"loader"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"native"</span><span class="p">,</span>
            <span class="nt">"entrypoint"</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">"module.path"</span><span class="p">:</span> <span class="s2">"./modules/logger/liblogger.so"</span>
            <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">"args"</span> <span class="p">:</span> <span class="p">{</span><span class="nt">"filename"</span><span class="p">:</span><span class="s2">"log.txt"</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"name"</span> <span class="p">:</span> <span class="s2">"hello_world"</span><span class="p">,</span>
            <span class="nt">"loader"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"native"</span><span class="p">,</span>
            <span class="nt">"entrypoint"</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">"module.path"</span><span class="p">:</span> <span class="s2">"./modules/hello_world/libhello_world.so"</span>
            <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">"args"</span> <span class="p">:</span> <span class="kc">null</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">"links"</span><span class="p">:</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">"source"</span><span class="p">:</span> <span class="s2">"hello_world"</span><span class="p">,</span>
            <span class="nt">"sink"</span><span class="p">:</span> <span class="s2">"logger"</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div></div>

<p>バイナリの<code>hello_world_sample</code> を実行する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>./samples/hello_world/hello_world_sample ../samples/hello_world/src/hello_world_lin.json
</pre></div></div>

<p>出力はそのまま。マニュアル通りだった。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[{
    "time": "Mon Apr 11 13:42:50 2016",
    "content": "Log started"
}, {
    "time": "Mon Apr 11 13:42:50 2016",
    "properties": {
        "helloWorld": "from Azure IoT Gateway SDK simple sample!"
    },
    "content": "aGVsbG8gd29ybGQ="
}, {
    "time": "Mon Apr 11 13:42:55 2016",
    "properties": {
        "helloWorld": "from Azure IoT Gateway SDK simple sample!"
    },
    "content": "aGVsbG8gd29ybGQ="
}, {
    "time": "Mon Apr 11 13:43:00 2016",
    "properties": {
        "helloWorld": "from Azure IoT Gateway SDK simple sample!"
    },
    "content": "aGVsbG8gd29ybGQ="
}, {
    "time": "Mon Apr 11 13:45:00 2016",
    "content": "Log stopped"
}]
</pre></div></div>

<h1>
<span id="iot-hub-と接続する" class="fragment"></span><a href="#iot-hub-%E3%81%A8%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>IoT Hub と接続する。</h1>

<p>次はこちらのチュートリアル。こちらもほぼそのまんま。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-linux-iot-edge-simulated-device" rel="nofollow noopener" target="_blank">Use Azure IoT Edge to send device-to-cloud messages with a simulated device (Linux)</a></li>
</ul>

<p><code>samples/simulated_device_cloud_upload_sample/src/simulated_device_cloud_upload_lin.json</code> を埋める。自分の</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">"modules"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"IotHub"</span><span class="p">,</span>
          <span class="nt">"loader"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"native"</span><span class="p">,</span>
            <span class="nt">"entrypoint"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"module.path"</span><span class="p">:</span> <span class="s2">"./modules/iothub/libiothub.so"</span>
            <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">"args"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"IoTHubName"</span><span class="p">:</span> <span class="s2">"removeiot"</span><span class="p">,</span>
              <span class="nt">"IoTHubSuffix"</span><span class="p">:</span> <span class="s2">"azure-devices.net"</span><span class="p">,</span>
              <span class="nt">"Transport"</span><span class="p">:</span> <span class="s2">"HTTP"</span>
            <span class="p">}</span>
          <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"mapping"</span><span class="p">,</span>
          <span class="nt">"loader"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"native"</span><span class="p">,</span>
            <span class="nt">"entrypoint"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"module.path"</span><span class="p">:</span> <span class="s2">"./modules/identitymap/libidentity_map.so"</span>
            <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">"args"</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="nt">"macAddress"</span><span class="p">:</span> <span class="s2">"01:01:01:01:01:01"</span><span class="p">,</span>
                <span class="nt">"deviceId"</span><span class="p">:</span> <span class="s2">"&lt;&lt;insert here deviceId&gt;&gt;"</span><span class="p">,</span>
                <span class="nt">"deviceKey"</span><span class="p">:</span> <span class="s2">"&lt;&lt;insert here deviceKey&gt;&gt;"</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"BLE1"</span><span class="p">,</span>
          <span class="nt">"loader"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"native"</span><span class="p">,</span>
            <span class="nt">"entrypoint"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"module.path"</span><span class="p">:</span> <span class="s2">"./modules/simulated_device/libsimulated_device.so"</span>
            <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">"args"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"macAddress"</span><span class="p">:</span> <span class="s2">"01:01:01:01:01:01"</span>
            <span class="p">}</span>
          <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"Logger"</span><span class="p">,</span>
          <span class="nt">"loader"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"native"</span><span class="p">,</span>
            <span class="nt">"entrypoint"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"module.path"</span><span class="p">:</span> <span class="s2">"./modules/logger/liblogger.so"</span>
            <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">"args"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"filename"</span><span class="p">:</span> <span class="s2">"deviceCloudUploadGatewaylog.log"</span>
            <span class="p">}</span>
          <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">"links"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">"source"</span><span class="p">:</span> <span class="s2">"*"</span><span class="p">,</span>
            <span class="nt">"sink"</span><span class="p">:</span> <span class="s2">"Logger"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"source"</span><span class="p">:</span> <span class="s2">"BLE1"</span><span class="p">,</span>
            <span class="nt">"sink"</span><span class="p">:</span> <span class="s2">"mapping"</span>
        <span class="p">},</span>

        <span class="p">{</span>
            <span class="nt">"source"</span><span class="p">:</span> <span class="s2">"mapping"</span><span class="p">,</span>
            <span class="nt">"sink"</span><span class="p">:</span> <span class="s2">"IotHub"</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div></div>

<p>ちなみに、device id は、IoT Hub の方で、生成する。Device Explorer で作成できる。</p>

<p><a href="https://camo.qiitausercontent.com/0f61c5e8e5aa670cfc64447a21cc199cb5bea2f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32393461616461362d353638342d653161312d306135652d3030346164636233626464622e706e67" target="_blank" rel="nofollow noopener"><img width="1124" alt="Screen Shot 2017-10-17 at 11.30.02 PM.png" src="https://camo.qiitausercontent.com/0f61c5e8e5aa670cfc64447a21cc199cb5bea2f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32393461616461362d353638342d653161312d306135652d3030346164636233626464622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/294aada6-5684-e1a1-0a5e-004adcb3bddb.png"></a></p>

<p>これで実行</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>./samples/simulated_device_cloud_upload/simulated_device_cloud_upload_sample ../samples/simulated_device_cloud_upload/src/simulated_device_cloud_upload_lin.json
</pre></div></div>

<p>ただ、これだと結果がわからないので、Azure Functions に繋いでみる</p>

<h1>
<span id="azure-functions-を生成してみる" class="fragment"></span><a href="#azure-functions-%E3%82%92%E7%94%9F%E6%88%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>Azure Functions を生成してみる。</h1>

<p>実は、現在の、Azure Functions では、IoT Hub に直接バインドすることができた。私の好きな、TypeScript + IoT Hub のバインディングスを使って繋いで見た。</p>

<p>特に解説はないが、最初<code>message</code> の持っているプロパティがわからなかったので、<code>Object.getOwnPropertyNames</code> で調べて見た。そして、ダンプして見た。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">run</span><span class="p">(</span><span class="nx">context</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">IoTHubMessages</span>: <span class="kt">any</span><span class="p">[])</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">TypeScript</span> <span class="nx">eventhub</span> <span class="nx">trigger</span> <span class="kd">function</span> <span class="nx">called</span> <span class="k">for</span> <span class="nx">message</span> <span class="nx">array</span> <span class="nx">$</span><span class="p">{</span><span class="nx">IoTHubMessages</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>


    <span class="nx">IoTHubMessages</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">message</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">names</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"properyName: "</span> <span class="o">+</span><span class="nx">names</span><span class="p">);</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"temperature = "</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">temperature</span><span class="p">);</span>

        <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Processed</span> <span class="nx">message</span> <span class="nx">$</span><span class="p">{</span><span class="nx">message</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">done</span><span class="p">();</span>
<span class="p">};</span>
</pre></div></div>

<p><em>function.json</em></p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">"bindings"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"eventHubTrigger"</span><span class="p">,</span>
      <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"IoTHubMessages"</span><span class="p">,</span>
      <span class="nt">"direction"</span><span class="p">:</span> <span class="s2">"in"</span><span class="p">,</span>
      <span class="nt">"path"</span><span class="p">:</span> <span class="s2">"samples-workitems"</span><span class="p">,</span>
      <span class="nt">"connection"</span><span class="p">:</span> <span class="s2">"removeiot_events_IOTHUB"</span><span class="p">,</span>
      <span class="nt">"cardinality"</span><span class="p">:</span> <span class="s2">"many"</span><span class="p">,</span>
      <span class="nt">"consumerGroup"</span><span class="p">:</span> <span class="s2">"$Default"</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">"disabled"</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>
</pre></div></div>

<p>IoT Edge からしっかりデータがきているのがわかる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>2017-10-17T14:35:08  Welcome, you are now connected to log-streaming service.
2017-10-17T14:36:05.464 Function started (Id=1dd2fa3e-83e0-456c-974c-6a2eec896dae)
2017-10-17T14:36:05.464 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:05.464 properyName: temperature
2017-10-17T14:36:05.464 temperature = 10
2017-10-17T14:36:05.464 Processed message [object Object]
2017-10-17T14:36:05.464 Function completed (Success, Id=1dd2fa3e-83e0-456c-974c-6a2eec896dae, Duration=7ms)
2017-10-17T14:36:07.051 Function started (Id=68e2efd1-54bb-4fe3-b275-15371b004a31)
2017-10-17T14:36:07.051 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:07.051 properyName: temperature
2017-10-17T14:36:07.051 temperature = 11
2017-10-17T14:36:07.051 Processed message [object Object]
2017-10-17T14:36:07.051 Function completed (Success, Id=68e2efd1-54bb-4fe3-b275-15371b004a31, Duration=1ms)
2017-10-17T14:36:09.050 Function started (Id=6da7743e-1070-4049-bc58-30c94901bdc4)
2017-10-17T14:36:09.050 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:09.050 properyName: temperature
2017-10-17T14:36:09.050 temperature = 12
2017-10-17T14:36:09.050 Processed message [object Object]
2017-10-17T14:36:09.050 Function completed (Success, Id=6da7743e-1070-4049-bc58-30c94901bdc4, Duration=1ms)
2017-10-17T14:36:11.048 Function started (Id=5dea256e-c500-4c4f-a404-17cdf3c76852)
2017-10-17T14:36:11.048 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:11.048 properyName: temperature
2017-10-17T14:36:11.048 temperature = 13
2017-10-17T14:36:11.048 Processed message [object Object]
2017-10-17T14:36:11.048 Function completed (Success, Id=5dea256e-c500-4c4f-a404-17cdf3c76852, Duration=0ms)
2017-10-17T14:36:13.057 Function started (Id=f82e8fc7-c171-4646-abbd-f1868bf64be5)
2017-10-17T14:36:13.057 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:13.057 properyName: temperature
2017-10-17T14:36:13.057 temperature = 14
2017-10-17T14:36:13.057 Processed message [object Object]
2017-10-17T14:36:13.057 Function completed (Success, Id=f82e8fc7-c171-4646-abbd-f1868bf64be5, Duration=0ms)
2017-10-17T14:36:15.101 Function started (Id=03da80a3-ebae-4019-96fd-d85c329553a3)
2017-10-17T14:36:15.101 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:15.101 properyName: temperature
2017-10-17T14:36:15.101 temperature = 15
2017-10-17T14:36:15.101 Processed message [object Object]
2017-10-17T14:36:15.101 Function completed (Success, Id=03da80a3-ebae-4019-96fd-d85c329553a3, Duration=1ms)
2017-10-17T14:36:17.064 Function started (Id=ed63f63b-9e58-4ed3-9fb2-a02cd59cdd4d)
2017-10-17T14:36:17.064 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:17.064 properyName: temperature
2017-10-17T14:36:17.064 temperature = 16
2017-10-17T14:36:17.064 Processed message [object Object]
2017-10-17T14:36:17.064 Function completed (Success, Id=ed63f63b-9e58-4ed3-9fb2-a02cd59cdd4d, Duration=1ms)
2017-10-17T14:36:19.064 Function started (Id=633e5861-d81d-4e1f-b3dd-9e50b135997e)
2017-10-17T14:36:19.064 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:19.064 properyName: temperature
2017-10-17T14:36:19.064 temperature = 17
2017-10-17T14:36:19.064 Processed message [object Object]
2017-10-17T14:36:19.064 Function completed (Success, Id=633e5861-d81d-4e1f-b3dd-9e50b135997e, Duration=0ms)
2017-10-17T14:36:21.062 Function started (Id=49cc53ae-7e9a-4344-a114-b9b6a380915f)
2017-10-17T14:36:21.062 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:21.062 properyName: temperature
2017-10-17T14:36:21.062 temperature = 18
2017-10-17T14:36:21.062 Processed message [object Object]
2017-10-17T14:36:21.062 Function completed (Success, Id=49cc53ae-7e9a-4344-a114-b9b6a380915f, Duration=1ms)
2017-10-17T14:36:23.048 Function started (Id=740a9a65-5554-4738-aaeb-670d49bff0d1)
2017-10-17T14:36:23.048 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:23.048 properyName: temperature
2017-10-17T14:36:23.048 temperature = 19
2017-10-17T14:36:23.048 Processed message [object Object]
2017-10-17T14:36:23.048 Function completed (Success, Id=740a9a65-5554-4738-aaeb-670d49bff0d1, Duration=1ms)
2017-10-17T14:36:25.057 Function started (Id=3bcd6cb6-7c29-4ca6-b0d8-f8271f24dda3)
2017-10-17T14:36:25.057 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:25.057 properyName: temperature
2017-10-17T14:36:25.057 temperature = 20
2017-10-17T14:36:25.057 Processed message [object Object]
2017-10-17T14:36:25.057 Function completed (Success, Id=3bcd6cb6-7c29-4ca6-b0d8-f8271f24dda3, Duration=1ms)
2017-10-17T14:36:27.060 Function started (Id=7240e6e5-f974-4490-9baf-f7550e09b6b1)
2017-10-17T14:36:27.060 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:27.060 properyName: temperature
2017-10-17T14:36:27.060 temperature = 21
2017-10-17T14:36:27.060 Processed message [object Object]
2017-10-17T14:36:27.060 Function completed (Success, Id=7240e6e5-f974-4490-9baf-f7550e09b6b1, Duration=1ms)
2017-10-17T14:36:29.069 Function started (Id=912b8bae-fc4c-47e2-bc73-0591316ef597)
2017-10-17T14:36:29.069 TypeScript eventhub trigger function called for message array [object Object]
2017-10-17T14:36:29.069 properyName: temperature
2017-10-17T14:36:29.069 temperature = 22
2017-10-17T14:36:29.069 Processed message [object Object]
2017-10-17T14:36:29.069 Function completed (Success, Id=912b8bae-fc4c-47e2-bc73-0591316ef597, 
</pre></div></div>

<p>ちなみに、Service Bus を経由して使う方法は昔はメジャーだったらしい。今は、Azure Functions 直接が主流ね。つまり下記のは古い。</p>

<ul>
<li><a href="https://azure.microsoft.com/en-us/blog/how-to-use-azure-functions-with-iot-hub-message-routing/" rel="nofollow noopener" target="_blank">How to use Azure Functions with IoT Hub message routing</a></li>
</ul>

<h1>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h1>

<p>ちなみに、本当は、IoT Edge の Edge にコンテナダウンロードしたかったので、悔しいから、Functions をコンテナで動かせる Dockerfile 書いてみようかな。</p>

<p>あと、IoT Edge とくみあわせていい感じになりそうなサービスがあるので、次回試してみたい。ちなみにこのハックは日を空けて３日づつくので</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/time-series-insights/time-series-insights-send-events" rel="nofollow noopener" target="_blank">Send events to a Time Series Insights environment using event hub</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/iot-dps/quick-create-simulated-device" rel="nofollow noopener" target="_blank">Create and provision a simulated device using IoT Hub Device Provisioning Service (preview)</a></li>
</ul>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://github.com/azure/iot-edge" rel="nofollow noopener" target="_blank">Azure / iot-edge</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />31位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/c185826a24435267618d">TypeScript の enum を JSON オブジェクトにワンライナーで変換する。</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-01 22:52:20</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Angular をやっている時に、enum からプルダウンメニューを作っている時に、enum を JSON に一発変換できないかなぁと思って、色々試してみました。</p>

<h1>
<span id="enum-の構造" class="fragment"></span><a href="#enum-%E3%81%AE%E6%A7%8B%E9%80%A0"><i class="fa fa-link"></i></a>enum の構造</h1>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">enum</span> <span class="nx">FoodType</span> <span class="p">{</span>
    <span class="nx">breakfast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">lunch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">dinner</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">snack</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">}</span>
</pre></div></div>

<p>これをどうやって JSON に変換するか考えます。</p>

<h1>
<span id="イテレーション" class="fragment"></span><a href="#%E3%82%A4%E3%83%86%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>イテレーション</h1>

<p>enum はどうやらイテレートできるっぽいので、次のようなコードを書いてみます。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">foodType</span> <span class="k">in</span> <span class="nx">FoodType</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"log:"</span> <span class="o">+</span> <span class="nx">foodType</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div>

<p>実行結果はまさかの、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>log:0
log:1
log:2
log:3
log:breakfast
log:lunch
log:dinner
log:snack
</pre></div></div>

<p>キーと値が一緒こたんに出てくるという感じ。</p>

<p>じゃあ、こんなコードでどうだ。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">foodType</span> <span class="k">in</span> <span class="nx">FoodType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Number</span><span class="p">(</span><span class="nx">foodType</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"log:"</span> <span class="o">+</span><span class="nx">foodType</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>log:0
log:breakfast
log:lunch
log:dinner
log:snack
</pre></div></div>

<p>なんで０が数字じゃないとか、のたまっています、、なんでやねん。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">foodType</span> <span class="k">in</span> <span class="nx">FoodType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">foodType</span><span class="p">)</span> <span class="o">||</span> <span class="nx">foodType</span> <span class="o">==</span> <span class="s1">'0'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Log:"</span> <span class="o">+</span> <span class="nx">foodType</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>これやと文句ないか？強引やけど。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Log:0
Log:1
Log:2
Log:3
</pre></div></div>

<h1>
<span id="enum-の変換" class="fragment"></span><a href="#enum-%E3%81%AE%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>enum の変換</h1>

<p>enum のキーから値をとったり、その逆はいけるだろうか？</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span>
<span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">FoodType</span><span class="p">[</span><span class="s2">"breakfast"</span><span class="p">];</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">FoodType</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
</pre></div></div>

<p>そのへんは柔軟っぽい。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>0
breakfast
</pre></div></div>

<p>よっしゃ、この情報があれば、あとはJSON に変換できる。</p>

<h1>
<span id="json-への変換" class="fragment"></span><a href="#json-%E3%81%B8%E3%81%AE%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>JSON への変換</h1>

<p>ループでまず書くとこんなの。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">result</span>: <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">foodType</span> <span class="k">in</span> <span class="nx">FoodType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">foodType</span><span class="p">)</span> <span class="o">||</span> <span class="nx">foodType</span> <span class="o">==</span> <span class="s1">'0'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">foodType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="nx">foodType</span><span class="p">,</span> <span class="s2">"value"</span><span class="o">:</span> <span class="nx">FoodType</span><span class="p">[</span><span class="nx">foodType</span><span class="p">]};</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[ { key: '0', value: 'breakfast' },
  { key: '1', value: 'lunch' },
  { key: '2', value: 'dinner' },
  { key: '3', value: 'snack' } ]
</pre></div></div>

<h1>
<span id="ワンライナーでjson変換" class="fragment"></span><a href="#%E3%83%AF%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%8A%E3%83%BC%E3%81%A7json%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>ワンライナーで、JSON変換</h1>

<p>そして、ワンライナーで書いてみる。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">FoodType</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">||</span> <span class="nx">v</span> <span class="o">==</span> <span class="s1">'0'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">k</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">k</span><span class="p">),</span> <span class="s2">"value"</span><span class="o">:</span> <span class="nx">FoodType</span><span class="p">[</span><span class="nb">Number</span><span class="p">(</span><span class="nx">k</span><span class="p">)]</span> <span class="p">}});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</pre></div></div>

<p>行けた。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[ { key: 0, value: 'breakfast' },
  { key: 1, value: 'lunch' },
  { key: 2, value: 'dinner' },
  { key: 3, value: 'snack' } ]
</pre></div></div>

<p>ポイントとしては、map のところで渡すものは、<code>k =&gt;</code> の右側は、普通に変換したい値でよかったが、ここにはコールバックを入れる必要があるらしく、関数の戻り値っぽく書いていると動いた。単に <code>{"key": Number(k), "value": FoodType(Number(k)]}</code> とかだとエラーになってしまった。</p>

<p>とはいえ、うまくかけたので、ワンライナーの方で実装します。</p>

<p>以上。</p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li><a href="https://stackoverflow.com/questions/21293063/how-to-programmatically-enumerate-an-enum-type-in-typescript-0-9-5" rel="nofollow noopener" target="_blank">How to programmatically enumerate an enum type in Typescript 0.9.5?</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />32位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/d436c80e1831e4b30c06">Angular 4 でマテリアルデザインを使う　データバインディング編</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-01 19:26:11</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> <b>[MaterialDesign]</b> <b>[Angular2]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>前回の投稿 <a href="https://qiita.com/TsuyoshiUshio@github/items/71146d3baa45231d8bb6" id="reference-1e8b329f5578c151b64f">Angular 4 でマテリアルデザインを使う</a>で、とりあえずインストールまでできたので、次に、データのバインディングをマテリアルデザインを適用しながらやってみたい。</p>

<h1>
<span id="最初の落とし穴" class="fragment"></span><a href="#%E6%9C%80%E5%88%9D%E3%81%AE%E8%90%BD%E3%81%A8%E3%81%97%E7%A9%B4"><i class="fa fa-link"></i></a>最初の落とし穴</h1>

<p>Angular4 と マテリアルデザインのインストールのブログはあっても、なかなか、Angular 4 のバインディングと一緒に書いている記事は見当たらなかった。多分みんな慣れているからだろう。マテリアルデザインも、Angular も同時に初心者の人はあまりやらないのかな。そこで、何かを参考に基本的なことをやるわけですが、ここで強烈にはまったのが、プロジェクト間違い。</p>

<ul>
<li>
<a href="https://material.angularjs.org/latest/" rel="nofollow noopener" target="_blank">AngularJS Material</a> というプロジェクトと、<a href="https://material.angular.io/" rel="nofollow noopener" target="_blank">Angular Material</a> は全く別のプロジェクトである。</li>
</ul>

<p>という事実だ。最初間違えて AngularJS Material を参考にコードを書いてたら、モジュールが見つからないとか出てきて、初心者の私は死亡、もう、REACT にしようかなぁとか頭によぎった。エラーをググってみると、「AngularJS Material と、Angular Materialは別プロジェクト」ということが書いてあった。、、、ムッチャややこしいわ。ちなみに、「AngularJS Material」 はどうやら、Angular 1.x向けのよう。だから、我々は、基本的に<a href="https://material.angular.io/" rel="nofollow noopener" target="_blank">Angular Material</a> を参考にすると良い。基本的にドキュメントは丁寧なのでわかりやすい。</p>

<h1>
<span id="フォームの作成" class="fragment"></span><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>フォームの作成</h1>

<p>まずは基本的なフォームを作ろうとしている。それをバインディングしてみる。</p>

<h2>
<span id="please-add-a-ngmodule-annotation-error" class="fragment"></span><a href="#please-add-a-ngmodule-annotation-error"><i class="fa fa-link"></i></a>"Please add a <a href="/NgModule" class="user-mention js-hovercard" title="NgModule" data-hovercard-target-type="user" data-hovercard-target-name="NgModule">@NgModule</a> annotation" error</h2>

<p>最初にやっていると当たったエラー。JavaScript のエラーは理由がよくわからないのも多いなぁ。</p>

<ul>
<li><a href="https://github.com/angular/angular-cli/issues/6429" rel="nofollow noopener" target="_blank">"Please add a @NgModule annotation" error in 1.0.4. Works in 1.0.3.</a></li>
</ul>

<p>詳細は上記の記事だけど、具体的には、<code>tsconfig.json</code> に <code>path</code> のエントリを追加する。angular-cli を使っているプロジェクトだと、<a href="https://github.com/angular/angular-cli/blob/master/docs/documentation/stories/linked-library.md" rel="nofollow noopener" target="_blank">Linked libraries</a>というのが必要らしく、コンパイルの時のリンクのパスを<code>tsconfig.json</code>に指定する必要がある。このエラーメッセージからは到底わからないのが辛いところ。</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span></span>    <span class="s2">"paths"</span><span class="err">:</span> <span class="p">{</span>
      <span class="nt">"@angular/*"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"..node_modules/@angular/*"</span>
      <span class="p">]</span>
    <span class="p">}</span><span class="err">,</span>
</pre></div></div>

<h1>
<span id="インプットフォームの作成" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%83%97%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>インプットフォームの作成</h1>

<p>とりあえず、食事を入力するフォームを作ってみる。まずは、ドメインクラスの定義</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Food</span> <span class="p">{</span>
    <span class="nx">name</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">date</span>: <span class="kt">Date</span><span class="p">;</span>
    <span class="nx">calorie</span>: <span class="kt">number</span><span class="p">;</span>
    <span class="nx">protein</span>: <span class="kt">number</span><span class="p">;</span>
    <span class="nx">carb</span>: <span class="kt">number</span><span class="p">;</span>
    <span class="nx">fat</span>: <span class="kt">number</span><span class="p">;</span>
    <span class="nx">meal_kind</span>: <span class="kt">FoodType</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>簡単のため、まずは、名前と日付程度を試してみる。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span>
<span class="kd">@Component</span><span class="p">({</span>
  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-root'</span><span class="p">,</span>
  <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">'./food-detail.component.html'</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">FoodDetailComponent</span> <span class="p">{</span>
  <span class="nx">food</span>: <span class="kt">Food</span><span class="p">;</span>
  <span class="kr">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">food</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Food</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">food</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">"Taro"</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">food</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

  <span class="p">}</span>

  <span class="nx">title</span> <span class="o">=</span> <span class="s1">'Muscle Hack'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="テキスト入力" class="fragment"></span><a href="#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E5%85%A5%E5%8A%9B"><i class="fa fa-link"></i></a>テキスト入力</h2>

<p>テキスト入力を可能にするためには、</p>

<ul>
<li>
<a href="https://material.angular.io/components/input/overview" rel="nofollow noopener" target="_blank">Input</a> </li>
</ul>

<p>が参考になる。テキスト入力のコンポーネントを使うためには、上記のページの  <code>API</code> に書いている通り、<code>import {MatInputModule} from '@angular/material';</code> を追加する。具体的には下記の通り。<a href="https://qiita.com/TsuyoshiUshio@github/items/71146d3baa45231d8bb6">前回の記事</a>の通り、私は、<code>material.module.ts</code> という名前で、マテリアル系のインポートは分離している。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span>
  <span class="nx">MdButtonModule</span><span class="p">,</span>
  <span class="nx">MdMenuModule</span><span class="p">,</span>
  <span class="nx">MdToolbarModule</span><span class="p">,</span>
  <span class="nx">MdIconModule</span><span class="p">,</span>
  <span class="nx">MdCardModule</span><span class="p">,</span>
  <span class="nx">MatInputModule</span><span class="p">,</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/material'</span><span class="p">;</span>

<span class="kd">@NgModule</span><span class="p">({</span>
  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">MdButtonModule</span><span class="p">,</span>
    <span class="nx">MdMenuModule</span><span class="p">,</span>
    <span class="nx">MdToolbarModule</span><span class="p">,</span>
    <span class="nx">MdIconModule</span><span class="p">,</span>
    <span class="nx">MdCardModule</span><span class="p">,</span>
    <span class="nx">MatInputModule</span><span class="p">,</span>
  <span class="p">],</span>
  <span class="nx">exports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">MdButtonModule</span><span class="p">,</span>
    <span class="nx">MdMenuModule</span><span class="p">,</span>
    <span class="nx">MdToolbarModule</span><span class="p">,</span>
    <span class="nx">MdIconModule</span><span class="p">,</span>
    <span class="nx">MdCardModule</span><span class="p">,</span>
    <span class="nx">MatInputModule</span><span class="p">,</span>
  <span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">MaterialModule</span> <span class="p">{}</span>
</pre></div></div>

<p>通常の入力フォームはこんな感じでいける。バインディングは、通常の、<a href="https://angular.io/tutorial" rel="nofollow noopener" target="_blank">Angular</a> の時と同じ。<br>
私は、<a href="https://embed.plnkr.co/?show=preview" rel="nofollow noopener" target="_blank">Angular Example - Tour of Heroes: Part 6</a>とかを参考に書いている。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span>    <span class="p">&lt;</span><span class="nt">md-form-field</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-full-width"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">mdInput</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"Name"</span> <span class="na">name</span><span class="o">=</span><span class="s">"name"</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">food</span><span class="err">.</span><span class="na">name</span><span class="err">"</span> <span class="na">disabled</span> <span class="na">value</span><span class="o">=</span><span class="s">"Ushio"</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">md-form-field</span><span class="p">&gt;</span>
</pre></div></div>

<p>これだと、極めてそっけない画面になる。これは悲しい。</p>

<p><a href="https://camo.qiitausercontent.com/7e33b2e9493051a989cc6fde918ed7350c3d2135/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39643230643539622d633662622d366638352d303332392d3332383963653033386565662e706e67" target="_blank" rel="nofollow noopener"><img width="242" alt="Screen Shot 2017-10-01 at 6.47.19 PM.png" src="https://camo.qiitausercontent.com/7e33b2e9493051a989cc6fde918ed7350c3d2135/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39643230643539622d633662622d366638352d303332392d3332383963653033386565662e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/9d20d59b-c6bb-6f85-0329-3289ce038eef.png"></a></p>

<p>もう少し見栄えを良くしたい。じゃあ、とりあえず、ツールバーをつけてみよう。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">md-toolbar</span> <span class="na">colo</span><span class="o">=</span><span class="s">"primary"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Msucle Hack<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">md-toolbar</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">md-form-field</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-full-width"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">mdInput</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"Name"</span> <span class="na">name</span><span class="o">=</span><span class="s">"name"</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">food</span><span class="err">.</span><span class="na">name</span><span class="err">"</span> <span class="na">disabled</span> <span class="na">value</span><span class="o">=</span><span class="s">"Ushio"</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">md-form-field</span><span class="p">&gt;</span>

</pre></div></div>

<p><a href="https://camo.qiitausercontent.com/fea38f8c78e7166918053100e4b0937cf1c46a43/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63623637626638352d353664302d343961372d636338382d3732303964666139313032312e706e67" target="_blank" rel="nofollow noopener"><img width="361" alt="Screen Shot 2017-10-01 at 6.49.05 PM.png" src="https://camo.qiitausercontent.com/fea38f8c78e7166918053100e4b0937cf1c46a43/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63623637626638352d353664302d343961372d636338382d3732303964666139313032312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/cb67bf85-56d0-49a7-cc88-7209dfa91021.png"></a></p>

<p>ぐぬぬ。地味だ、思った色と違う。なんでや！と思ったけど、単にtypo. <code>color</code></p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">md-toolbar</span> <span class="na">color</span><span class="o">=</span><span class="s">"primary"</span><span class="p">&gt;</span>
</pre></div></div>

<p>やっと思った色に。</p>

<p><a href="https://camo.qiitausercontent.com/4fffd7c2b3e6b884a68211ffba69cc42bae4bdef/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64663239353136392d616264342d313066322d306466382d3034343635666663393231632e706e67" target="_blank" rel="nofollow noopener"><img width="293" alt="Screen Shot 2017-10-01 at 6.50.48 PM.png" src="https://camo.qiitausercontent.com/4fffd7c2b3e6b884a68211ffba69cc42bae4bdef/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64663239353136392d616264342d313066322d306466382d3034343635666663393231632e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/df295169-abd4-10f2-0df8-04465ffc921c.png"></a></p>

<p>しかし、まだまだ、ダサい、なんかサンプルと違う。そうだカードを入れてみよう。</p>

<div class="code-frame" data-lang="html"></div>

<p>それっぽくなった。</p>

<p><a href="https://camo.qiitausercontent.com/70d3366a1eee2233c6b03fdcd58124f6df538524/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30656565383935662d363430652d353261622d363336382d3261333833316162646335392e706e67" target="_blank" rel="nofollow noopener"><img width="356" alt="Screen Shot 2017-10-01 at 6.52.29 PM.png" src="https://camo.qiitausercontent.com/70d3366a1eee2233c6b03fdcd58124f6df538524/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30656565383935662d363430652d353261622d363336382d3261333833316162646335392e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/0eee895f-640e-52ab-6368-2a3831abdc59.png"></a></p>

<h2>
<span id="date-picker" class="fragment"></span><a href="#date-picker"><i class="fa fa-link"></i></a>Date Picker</h2>

<p>次に Date Picker をつけてみたい。やっぱ日付は、部品があるので使いたい。</p>

<ul>
<li><a href="https://material.angular.io/components/datepicker/overview" rel="nofollow noopener" target="_blank">Datepicker</a></li>
</ul>

<p>を同じく参考にする。ただし、今回は、このページの <code>API</code> で必要とされているモジュール以外にも必要になるモジュールが存在した。<br>
<code>MdNativeDateModule</code> だ。同じく、<code>material.module.ts</code> の記述はこう変わった。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span>
  <span class="nx">MdButtonModule</span><span class="p">,</span>
  <span class="nx">MdMenuModule</span><span class="p">,</span>
  <span class="nx">MdToolbarModule</span><span class="p">,</span>
  <span class="nx">MdIconModule</span><span class="p">,</span>
  <span class="nx">MdCardModule</span><span class="p">,</span>
  <span class="nx">MatInputModule</span><span class="p">,</span>
  <span class="nx">MdNativeDateModule</span><span class="p">,</span>
  <span class="nx">MatDatepickerModule</span><span class="p">,</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/material'</span><span class="p">;</span>

<span class="kd">@NgModule</span><span class="p">({</span>
  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">MdButtonModule</span><span class="p">,</span>
    <span class="nx">MdMenuModule</span><span class="p">,</span>
    <span class="nx">MdToolbarModule</span><span class="p">,</span>
    <span class="nx">MdIconModule</span><span class="p">,</span>
    <span class="nx">MdCardModule</span><span class="p">,</span>
    <span class="nx">MatInputModule</span><span class="p">,</span>
    <span class="nx">MdNativeDateModule</span><span class="p">,</span>
    <span class="nx">MatDatepickerModule</span><span class="p">,</span>
  <span class="p">],</span>
  <span class="nx">exports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">MdButtonModule</span><span class="p">,</span>
    <span class="nx">MdMenuModule</span><span class="p">,</span>
    <span class="nx">MdToolbarModule</span><span class="p">,</span>
    <span class="nx">MdIconModule</span><span class="p">,</span>
    <span class="nx">MdCardModule</span><span class="p">,</span>
    <span class="nx">MatInputModule</span><span class="p">,</span>
    <span class="nx">MdNativeDateModule</span><span class="p">,</span>
    <span class="nx">MatDatepickerModule</span><span class="p">,</span>
  <span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">MaterialModule</span> <span class="p">{}</span>
</pre></div></div>

<p>次に、<code>food-detail.compent.html</code> を書き換える</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">md-toolbar</span> <span class="na">color</span><span class="o">=</span><span class="s">"primary"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Msucle Hack<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">md-toolbar</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">md-card</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-form"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">md-form-field</span> <span class="na">class</span><span class="o">=</span><span class="s">"example-full-width"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">mdInput</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"Name"</span> <span class="na">name</span><span class="o">=</span><span class="s">"name"</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">food</span><span class="err">.</span><span class="na">name</span><span class="err">"</span> <span class="na">disabled</span> <span class="na">value</span><span class="o">=</span><span class="s">"Ushio"</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">md-form-field</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">md-form-field</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">mdInput</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">food</span><span class="err">.</span><span class="na">date</span><span class="err">"</span> <span class="na">name</span><span class="o">=</span><span class="s">"date"</span> <span class="err">[</span><span class="na">mdDatepicker</span><span class="err">]="</span><span class="na">myDatepicker</span><span class="err">"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">md-datepicker-toggle</span> <span class="na">mdSuffix</span> <span class="err">[</span><span class="na">for</span><span class="err">]="</span><span class="na">myDatepicker</span><span class="err">"</span><span class="p">&gt;&lt;/</span><span class="nt">md-datepicker-toggle</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">md-datepicker</span> <span class="err">#</span><span class="na">myDatepicker</span><span class="p">&gt;&lt;/</span><span class="nt">md-datepicker</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">md-form-field</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">md-card</span><span class="p">&gt;</span>
</pre></div></div>

<p>こちらのハマりどころは、先ほどのライブラリの追加ぐらいで特にない。ちなみに、<code>md-datepicker-toggle</code> から、<code>mdSuffix</code> を抜くと見栄えがおかしくなるので、<code>mdSuffix</code>をつけて、場所を調整すること。</p>

<p>うむ。それっぽい。バインディングもしっかりできている。</p>

<p><a href="https://camo.qiitausercontent.com/8f579c5ca54f05ec9e1e563c2670a5bcca68e8f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30323532656230612d663165342d393861322d333035342d3834393235393333643237312e706e67" target="_blank" rel="nofollow noopener"><img width="777" alt="Screen Shot 2017-10-01 at 7.02.54 PM.png" src="https://camo.qiitausercontent.com/8f579c5ca54f05ec9e1e563c2670a5bcca68e8f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30323532656230612d663165342d393861322d333035342d3834393235393333643237312e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/0252eb0a-f1e4-98a2-3054-84925933d271.png"></a></p>

<p>うーん。しかし、日本的には表示が違うかな。ロケールを指定しよう。<code>material.module.ts</code> のところに、次の記述を追加。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span>  <span class="nx">providers</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="nx">provide</span>: <span class="kt">MAT_DATE_LOCALE</span><span class="p">,</span> <span class="nx">useValue</span><span class="o">:</span> <span class="s1">'ja-JP'</span><span class="p">},</span>
  <span class="p">],</span>
</pre></div></div>

<p>もしくは、<code>food-detail.component.ts</code> のFoodDetailComponent を次のようにする。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">class</span> <span class="nx">FoodDetailComponent</span> <span class="p">{</span>
  <span class="nx">food</span>: <span class="kt">Food</span><span class="p">;</span>
  <span class="kr">constructor</span><span class="p">(</span><span class="nx">dateAdapter</span>: <span class="kt">DateAdapter</span><span class="o">&lt;</span><span class="nx">NativeDateAdapter</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dateAdapter</span><span class="p">.</span><span class="nx">setLocale</span><span class="p">(</span><span class="s1">'ja-JP'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">food</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Food</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">food</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">"Taro"</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">food</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

  <span class="p">}</span>
</pre></div></div>

<p>試すとどちらでも動作した。</p>

<p><a href="https://camo.qiitausercontent.com/c01b5473faf4b59848ceb392436726fa3e659982/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32383433313734652d626534632d633234362d613062622d3432363763336531363237622e706e67" target="_blank" rel="nofollow noopener"><img width="767" alt="Screen Shot 2017-10-01 at 7.17.38 PM.png" src="https://camo.qiitausercontent.com/c01b5473faf4b59848ceb392436726fa3e659982/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32383433313734652d626534632d633234362d613062622d3432363763336531363237622e706e67" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/2843174e-be4c-c246-a0bb-4267c3e1627b.png"></a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>久々に、JavaScript のフロントエンドを触ったが、やっぱデバッグが面倒だ。デバックメッセージからストレートに意味が取れないことが多い。やっぱり、<code>npm start</code> をして、部品を一つ一つ追加していって、動くのを確認する方が良さげ。というのも、何かを追加したら、画面が出なくなってガサーとエラーがはかれるわけだけど、部品ごとに区切らないと、デバッグがしにくい。これがちょっとした学び。</p>

<p>次は、enum を使って、選択肢を作ってみたいな。</p>

<h1>
<span id="リソース" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>リソース</h1>

<ul>
<li><a href="https://coursetro.com/posts/code/67/Angular-4-Material-Tutorial" rel="nofollow noopener" target="_blank">Angular 4 Material Tutorial</a></li>
<li><a href="https://angular.io/docs" rel="nofollow noopener" target="_blank">Angular</a></li>
<li><a href="https://material.angular.io/" rel="nofollow noopener" target="_blank">Angular Material</a></li>
<li><a href="https://github.com/angular/angular-cli/issues/6429" rel="nofollow noopener" target="_blank">"Please add a @NgModule annotation" error in 1.0.4. Works in 1.0.3.</a></li>
<li><a href="https://qiita.com/TsuyoshiUshio@github/items/71146d3baa45231d8bb6">Angular 4 でマテリアルデザインを使う</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />33位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/05ad39fe088e1f5b5371">Go の Enum 表現</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-23 16:17:05</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Go]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Terraform のプルリクをレビュー　してもらっている時に、次のようなコメントをもらった。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="o">+</span>   <span class="nx">resGroup</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">"resource_group_name"</span><span class="p">).(</span><span class="kt">string</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>   <span class="nx">skuName</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">"sku"</span><span class="p">)</span>
<span class="o">+</span>   <span class="nx">sku</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getSku</span><span class="p">(</span><span class="nx">skuName</span><span class="p">)</span>
<span class="o">+</span>   <span class="kd">func</span> <span class="nx">getSku</span><span class="p">(</span><span class="nx">skuName</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">operationalinsights</span><span class="p">.</span><span class="nx">Sku</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">skuName</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="nx">skuEnum</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getSkuNameEnum</span><span class="p">(</span><span class="nx">skuName</span><span class="p">.(</span><span class="kt">string</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">operationalinsights</span><span class="p">.</span><span class="nx">Sku</span><span class="p">{</span>
        <span class="nx">Name</span><span class="p">:</span> <span class="nx">skuEnum</span><span class="p">,</span>
    <span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div></div>

<p>こうなっているのを下記のように。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span>
<span class="nx">since</span> <span class="nx">we</span> <span class="nx">can</span> <span class="nx">just</span> <span class="nx">cast</span> <span class="nx">directly</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">Enum</span><span class="p">,</span> <span class="nx">we</span> <span class="nx">can</span> <span class="nx">replace</span> <span class="nx">this</span> <span class="nx">with</span><span class="p">:</span>

<span class="nx">sku</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">operationalinsights</span><span class="p">.</span><span class="nx">Sku</span><span class="p">{</span>
 <span class="nx">Name</span><span class="p">:</span> <span class="nx">operationalinsights</span><span class="p">.</span><span class="nx">SkuNameEnum</span><span class="p">(</span><span class="nx">skuName</span><span class="p">),</span>
<span class="p">}</span>
</pre></div></div>

<p>てっきり、ゴリゴリ書かないと行けないと思ったけどいらんかった。確認してみよう。</p>

<h1>
<span id="go-の-enum" class="fragment"></span><a href="#go-%E3%81%AE-enum"><i class="fa fa-link"></i></a>Go の enum</h1>

<p>Go では、Enum はないが、idiom としてこんな感じの様子。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">SkuNameEnum</span> <span class="kt">string</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="c1">// Free specifies the free state for sku name enum.</span>
    <span class="nx">Free</span> <span class="nx">SkuNameEnum</span> <span class="p">=</span> <span class="s">"Free"</span>
    <span class="c1">// PerNode specifies the per node state for sku name enum.</span>
    <span class="nx">PerNode</span> <span class="nx">SkuNameEnum</span> <span class="p">=</span> <span class="s">"PerNode"</span>
    <span class="c1">// Premium specifies the premium state for sku name enum.</span>
    <span class="nx">Premium</span> <span class="nx">SkuNameEnum</span> <span class="p">=</span> <span class="s">"Premium"</span>
    <span class="c1">// Standalone specifies the standalone state for sku name enum.</span>
    <span class="nx">Standalone</span> <span class="nx">SkuNameEnum</span> <span class="p">=</span> <span class="s">"Standalone"</span>
    <span class="c1">// Standard specifies the standard state for sku name enum.</span>
    <span class="nx">Standard</span> <span class="nx">SkuNameEnum</span> <span class="p">=</span> <span class="s">"Standard"</span>
    <span class="c1">// Unlimited specifies the unlimited state for sku name enum.</span>
    <span class="nx">Unlimited</span> <span class="nx">SkuNameEnum</span> <span class="p">=</span> <span class="s">"Unlimited"</span>
<span class="p">)</span>
</pre></div></div>

<p>わざわざ、<code>string</code> を、<code>SkuNameEnum</code> というタイプに変更している。これにより、SkuNameEnum という型を定義して、なおかつ、続くconst によって、固定の値を定義している。</p>

<p>使ってみよう。</p>

<div class="code-frame" data-lang="go"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">skuName1</span> <span class="o">:=</span> <span class="nx">SkuNameEnum</span><span class="p">(</span><span class="nx">Free</span><span class="p">)</span>
    <span class="nx">skuName2</span> <span class="o">:=</span> <span class="nx">SkuNameEnum</span><span class="p">(</span><span class="s">"Standalone"</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">skuName1</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">skuName2</span><span class="p">))</span>
<span class="p">}</span>
</pre></div></div>

<p>実行してみる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>FreeStandalone
</pre></div></div>

<p>ちゃんと使える。この構文はよく考えたら型変換の、<code>int("2")</code> とかと同じ構文だ。キャストがしっかりできている。また一つ学んだ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />34位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/05aea30bf58f77108420">Decorator のイメージ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-18 08:03:02</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Angular をやっていて、デコレータが出てきた。Java などでいうアノテーションだが、どのような仕組みなのかスッキリしないので、ちょっとだけ試して見た。</p>

<h1>
<span id="クラスの-decorator" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE-decorator"><i class="fa fa-link"></i></a>クラスの Decorator</h1>

<p>Decorator の実態は関数だ。クラスのデコレータはコンストラクタに対してかける。<br>
ここでは、新しいプロパティを追加定義している。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">classDecorator</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kr">extends</span> <span class="p">{</span><span class="k">new</span><span class="p">(...</span><span class="nx">args</span>:<span class="kt">any</span><span class="p">[])</span><span class="o">:</span><span class="p">{}}</span><span class="o">&gt;</span><span class="p">(</span><span class="kr">constructor</span><span class="o">:</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kr">class</span> <span class="kr">extends</span> <span class="kr">constructor</span> <span class="p">{</span>
        <span class="nx">newProperty</span> <span class="o">=</span> <span class="s2">"new property"</span><span class="p">;</span>
        <span class="nx">hello</span> <span class="o">=</span> <span class="s2">"Overriden"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">@classDecorator</span>
<span class="kr">class</span> <span class="nx">Greeter01</span> <span class="p">{</span>
    <span class="nx">hello</span>: <span class="kt">string</span> 
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">m</span>: <span class="kt">string</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">hello</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">new</span> <span class="nx">Greeter01</span><span class="p">(</span><span class="s2">"This is it"</span><span class="p">));</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>class_1 { hello: 'Overriden', newProperty: 'new property' }

</pre></div></div>

<h1>
<span id="メソッドのデコレータ" class="fragment"></span><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E3%83%87%E3%82%B3%E3%83%AC%E3%83%BC%E3%82%BF"><i class="fa fa-link"></i></a>メソッドのデコレータ</h1>

<p>メソッドのデコレータで、ロガーを書いてみる。おそらく、リフレクションとか使うと、<br>
引数とかもダンプできそうだが、元々の目的と異なるので、ここでは深堀しない。ポイントは、関数の引数に、ターゲットのオブジェクト、呼ばれたメソッド名、そして、プロパディディスクリプタが呼ばれた時に引き渡される。関数を呼び出しているので、このケースでは、descriptionはnull になった。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">logger</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">propertyKey</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">description</span>: <span class="kt">PropertyDescriptor</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">propertyKey</span> <span class="o">+</span> <span class="s2">" is called"</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">Greeter02</span> <span class="p">{</span>
    <span class="kd">@logger</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">greet</span><span class="p">(</span><span class="nx">message</span>:<span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I'm Greeter 02 "</span> <span class="o">+</span> <span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">greeter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Greeter02</span><span class="p">();</span>
<span class="nx">greeter</span><span class="p">.</span><span class="nx">greet</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">);</span>
</pre></div></div>

<p>実行結果</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>{ value: [Function],
  writable: true,
  enumerable: true,
  configurable: true }
I'm Greeter 02 hello
</pre></div></div>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>ざっくりと、デコレータのイメージがつかめた。ただし、ここを本気でやろうと思ったら、リフレクションの深堀が必須っぽいので、今日はこの辺にしておく。</p>

<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor" rel="nofollow noopener" target="_blank">Object.getOwnPropertyDescriptor()</a></li>
<li><a href="https://www.typescriptlang.org/docs/handbook/decorators.html" rel="nofollow noopener" target="_blank">Decorators
</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />35位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/d64392a360f86dbc1e22">JavaScript のクラスの書き方のいくつか</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-17 16:42:48</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>このポストは、壮大なヤクの毛刈りの最中なので、いつもにまして、私以外には意味のないポストである。<a href="http://qiita.com/takeharu/items/809114f943208aaf55b3" id="reference-e95d05f9dfd35a7df54b">JavaScriptのプロトタイプからオブジェクト指向を学ぶ</a>この方の一連のポストから、学ぶ方が効率がいいだろう。</p>

<p>さて、自分のために、その１。JavaScript のクラスの書き方のいくつか。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">Employee</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">baseSalary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">baseSalary</span> <span class="o">=</span> <span class="nx">baseSalary</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getSalary</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">baseSalary</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Employee</span><span class="p">(</span><span class="s2">"Tsuyoshi"</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">getSalary</span><span class="p">());</span>
</pre></div></div>

<p>まずは、これは問題のある書き方。何故かというと、Employee の生成のたびに、getSalary() メソッドも生成されるから。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Tsuyoshi
201
</pre></div></div>

<p>実際、このコードは次のものと同じらしい。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">EmployeeNative</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">baseSalary</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">baseSalary</span> <span class="o">=</span> <span class="nx">baseSalary</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">getSalary</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">baseSalary</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">emp</span> <span class="o">=</span> <span class="nx">EmployeeNative</span><span class="p">(</span><span class="s2">"Tsuyoshi"</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">getSalary</span><span class="p">());</span>
</pre></div></div>

<p>つまり、<code>new</code> キーワードは、オブジェクトを返しているに過ぎない。その時に、この書き方だと、毎回メソッドを作成することになる。オススメは次のもの。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">EmployeePrototype</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">baseSalary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">baseSalary</span> <span class="o">=</span> <span class="nx">baseSalary</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">EmployeePrototype</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getSalary</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">baseSalary</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EmployeePrototype</span><span class="p">(</span><span class="s2">"Tsuyoshi"</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emp</span><span class="p">.</span><span class="nx">getSalary</span><span class="p">());</span>
</pre></div></div>

<p><code>prototype</code> を用いて定義するもの。prototype は、既存のプロトタイプに、後からプロパティ（関数含む）を追加できるもの。ここでは、<code>EmployeePrototype</code> に対して、後から、プロパティを追加している。こうすると、どうなるかというと、新たに</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EmployeePrototype</span><span class="p">(</span><span class="s2">"Yamada"</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
</pre></div></div>

<p>みたいなコードを書いたとしても、</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">EmployeePrototype</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">baseSalary</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">baseSalary</span> <span class="o">=</span> <span class="nx">baseSalary</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">self</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>になるので、メモリ効率的にメソッド分だけ有利になる。しかし、プロトタイプがなんであるかは、まだちょっとスッキリしないので、次のポストで掘り下げてみる。</p>

<ul>
<li><a href="https://www.w3schools.com/js/js_object_prototypes.asp" rel="nofollow noopener" target="_blank">JavaScript Object Prototypes</a></li>
<li>
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/prototype" rel="nofollow noopener" target="_blank">Object.prototype</a> </li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
