<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (TsuyoshiUshio@github)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (TsuyoshiUshio@github さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1020</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/89030baca68b05a9783d">Chefを読んで実行するための全知識</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-16 18:42:33</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[chef]</b> <b>[chef-solo]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>このドキュメントでは、Chefを実行して、インフラを作成したい人が、既存のレシピがあるのを前提に、Chefの概要を理解するためのドキュメントです。Chef-soloの構成のみに対応した記述になっています。理解が間違えているところとかあればご指摘ください。</p>

<h2>
<span id="1-chefの概要" class="fragment"></span><a href="#1-chef%E3%81%AE%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>1. Chefの概要</h2>

<h3>
<span id="11-chefとは" class="fragment"></span><a href="#11-chef%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>1.1. Chefとは</h3>

<p>シェフは、インフラストラクチャーをコードに変換するための自動化プラットフォームです。仮想環境でも、物理環境でも、クラウドでも使う事ができます。インフラストラクチャを自動化することで、プロダクトのマーケット投入を早めたり、スケールや複雑さに対応したり、システムを安全に保ちます。</p>

<h3>
<span id="12-chefの仕組み" class="fragment"></span><a href="#12-chef%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF"><i class="fa fa-link"></i></a>1.2. Chefの仕組み</h3>

<p>Chefはサーバーをセットアップして、希望の状態にするための「クックブック」「ノードオブジェクト」というDSL(設定ファイルっぽいもの)をローカルのワークステーションで作成します。それらのDSLをローカルのバーチャルマシンや、クラウド、物理サーバーに反映させると、サーバーのセットアップが完了します。</p>

<p><a href="https://camo.qiitausercontent.com/ab55c5ec505afacfff5e5e960dea8c4a6b60e416/687474703a2f2f7777772e676574636865662e636f6d2f696d616765732f63686172742d62617369632d696e7374616c6c6174696f6e2e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ab55c5ec505afacfff5e5e960dea8c4a6b60e416/687474703a2f2f7777772e676574636865662e636f6d2f696d616765732f63686172742d62617369632d696e7374616c6c6174696f6e2e6a7067" alt="Chefの全体像" data-canonical-src="http://www.getchef.com/images/chart-basic-installation.jpg"></a></p>

<h3>
<span id="13-chefで使われる用語" class="fragment"></span><a href="#13-chef%E3%81%A7%E4%BD%BF%E3%82%8F%E3%82%8C%E3%82%8B%E7%94%A8%E8%AA%9E"><i class="fa fa-link"></i></a>1.3. Chefで使われる用語</h3>

<p>Chefで使われる代表的な用語は次のような物です。chefはServer-Client形式のものと、単独で使うものがありますが、本ドキュメントでは後者を取り扱います。</p>

<h4>
<span id="131-cookbookとreceipe" class="fragment"></span><a href="#131-cookbook%E3%81%A8receipe"><i class="fa fa-link"></i></a>1.3.1. cookbookとreceipe</h4>

<p>cookbookというのは、お料理本の意味で、複数のreceipe(レシピ)を含みます。一つのcookbookが一つの料理の料理方法が載っています。例えばカレーです。receipeは、カレーでも、様々なカレーがあるので、そのカレーの種類だけ作り方があり、それがreceipeにまとまっているイメージです。<br>
 　技術的にいうと、MySQLとかApacheとか毎にcookbookがあり、その中にいくつかreceipeがあります。例えばMySQLのMasterとか、Slaveとかです。具体的なreceipeを適用すると、そこで設定されたとおりに、実際のサーバーが出来上がります.receipeには、こうなってほしいという望まれるサーバーの状態が定義されています。</p>

<h4>
<span id="132-knife" class="fragment"></span><a href="#132-knife"><i class="fa fa-link"></i></a>1.3.2. knife</h4>

<p>chefは料理の例えになっています。料理をするには包丁とかが必要になります。<a href="http://docs.opscode.com/chef/knife.html" rel="nofollow noopener" target="_blank">knife</a>は、実際にcookbookをサーバーに適用する時に使うコマンドです。</p>

<h3>
<span id="14-chefの考え方" class="fragment"></span><a href="#14-chef%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9"><i class="fa fa-link"></i></a>1.4. Chefの考え方</h3>

<h4>
<span id="141-immutable-infrastructure" class="fragment"></span><a href="#141-immutable-infrastructure"><i class="fa fa-link"></i></a>1.4.1. Immutable Infrastructure</h4>

<p>最近は仮想化の発達により、クラウドや、仮想マシンにより、カンタンにサーバーのインスタンスを作ったり、壊したりということができるようになりました。また、アプリケーションのインストール等も従来は、手で手順を作って、その手順に従ってコマンドを打って環境を作っていました。最近は、サーバーへのインストールや設定、そしてインスタンスの起動や停止といったことまで「プログラム」で実行できるようになりました。この動きをInfrastracture as a codeといいます。この流れで出てきた考えがImmutable infrastructureという考えです。通常のサーバーは一度セットアップのあとは、ライブラリのバージョンアップ、設定変更にあわせて、サーバーで操作を行い、サーバーの状態を変更してきました。ところが、こういう事をすると、サーバーにより、差異がでてきたり、インストールしているパッケージの整合性が取れなくなったり、挙動がおかしくなったり、操作ミスしたりといったようにいろいろな問題が発生してきます。</p>

<p>　ですので、一度作成したサーバーのレシピは、サーバー側では設定変更を行わず、あくまで、Chefのようなプロビジョニングツールの方で、レシピ等を変更するようにします。つまり、サーバーの状態はいつも同じ（不変）な状態をキープできるようになります。そうすると、どこでも、何回セットアップしたとしても、まったく同じ状態のサーバーがでてきます。<br>
　<br>
　ポイントは、サーバー側で設定変更等をしないことです。あくまでレシピを変更しましょう。<br>
　</p>

<h4>
<span id="142-冪等性" class="fragment"></span><a href="#142-%E5%86%AA%E7%AD%89%E6%80%A7"><i class="fa fa-link"></i></a>1.4.2. 冪等性</h4>

<p>レシピを作るときには、冪等性という性質をもっている事が重要視されます。冪等性は、Chefにおいては、何回レシピを適用しても、結果（サーバーの状態）が同じになるような性質です。例えば、最初にApacheのレシピを作ったときに、まず、Aapcheをインストールするところまで作ったとして、レシピを流してサーバーを作りました。次に、設定ファイルの変更をレシピに追加して、再度レシピを同じサーバーに流れた時にも、１からインスタンスを上げて同じレシピを流した時でも同じ結果が得られるような作りにしましょうということです。　</p>

<h4>
<span id="143-捨てやすくすること" class="fragment"></span><a href="#143-%E6%8D%A8%E3%81%A6%E3%82%84%E3%81%99%E3%81%8F%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>1.4.3. 捨てやすくすること</h4>

<p>　Chefのようなツールがあれば、サーバーがおかしくなったらいつでも、それを捨てて、すぐにクラウドでインスタンスを立ち上げて、Chefを流して、セットアップするというのが非常に短時間でできます。<br>
　だから、一度作成したインスタンスをずっと使おうという発想ではなくて、今まで使っていたインスタンスはいつでも捨ててChefを流したら同じ状態になるような設計にしましょう。</p>

<h2>
<span id="2-chefの実行方法" class="fragment"></span><a href="#2-chef%E3%81%AE%E5%AE%9F%E8%A1%8C%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>2. Chefの実行方法</h2>

<h3>
<span id="21-chefのインストール" class="fragment"></span><a href="#21-chef%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>2.1. chefのインストール</h3>

<p>次のコマンドもしくは、Gemfileに記述しましょう</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>% gem install chef
% gem install knife-solo 
</pre></div></div>

<p>尚、このGemが使える前提条件は次の通りです。</p>

<ul>
<li>Unix, Linux, MacOSX, MS Windows</li>
<li>MacOSXの場合はXCodeをインストールする</li>
<li>githubのアカウントが必要なのでgitもインストールしておく</li>
<li>サーバーにアクセスできるようにする(SSHで)</li>
<li>サーバーのドメイン名か、IPAddressが事前にあること</li>
</ul>

<p><a href="http://docs.opscode.com/install_workstation.html" rel="nofollow noopener" target="_blank">Install Chef 11.x on Workspation</a></p>

<h3>
<span id="22-初期セットアップ" class="fragment"></span><a href="#22-%E5%88%9D%E6%9C%9F%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97"><i class="fa fa-link"></i></a>2.2. 初期セットアップ</h3>

<h4>
<span id="221-リポジトリの設定" class="fragment"></span><a href="#221-%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>2.2.1. リポジトリの設定</h4>

<p>chefのファイルは、GitHub等のレポジトリで管理するのが望ましいでしょう。１つのプロジェクトに対して１つのchef用リポジトリというレベルの粒度で作成しましょう。</p>

<p>knifeコマンドを使ってリポジトリを初期化します。knifeの設定ファイル(~/.chef/knife.rb)等が作成されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>% knife solo init chef
</pre></div></div>

<h3>
<span id="23-ディレクトリの構造" class="fragment"></span><a href="#23-%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%81%AE%E6%A7%8B%E9%80%A0"><i class="fa fa-link"></i></a>2.3. ディレクトリの構造</h3>

<p>適当ですが、私のプロジェクトのchefディレクトリ以下は次のような構成になっています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ tree -L 2
.
|-- Berksfile
|-- Berksfile.lock
|-- Gemfile
|-- Gemfile.lock
|-- cookbooks
|   |-- Berksfile.lock
|   |-- apache2
|   |-- apt
|   |-- aws
|   |-- build-essential
|   |-- chef_handler
|   |-- database
|   |-- homebrew
|   |-- iptables
|   |-- logrotate
|   |-- mysql
|   |-- openssl
|   |-- pacman
|   |-- postgresql
|   |-- windows
|   |-- xfs
|   `-- yum
|-- data_bags
|-- environments
|-- nodes
|   |-- vagrant.json
|   `-- mysql01.json
|-- roles
|   |-- all_in_one.json
|   |-- app_server.json
|   |-- mysql_master_server.json
|   |-- mysql_slave_server.json
|   `-- varnish_server.json
|-- site-cookbooks
|   |-- info-base
|   |-- mysql55
|   |-- mysql56
|   `-- varnish
`-- vendor
    `-- bundle
</pre></div></div>

<h4>
<span id="231-一般的なディレクトリ" class="fragment"></span><a href="#231-%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA"><i class="fa fa-link"></i></a>2.3.1. 一般的なディレクトリ</h4>

<p>各ディレクトリについて説明していきます。</p>

<table>
<thead>
<tr>
<th style="text-align: left">ディレクトリ</th>
<th style="text-align: right">名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">cookbooks</td>
<td style="text-align: right">インターネットから取得したcookbookが複数格納されます</td>
</tr>
<tr>
<td style="text-align: left">data_bags</td>
<td style="text-align: right">ドメインデータが格納されます</td>
</tr>
<tr>
<td style="text-align: left">environments</td>
<td style="text-align: right">staging/production等環境固有の状態が格納されます</td>
</tr>
<tr>
<td style="text-align: left">nodes</td>
<td style="text-align: right">個別のノードの状態が格納されます</td>
</tr>
<tr>
<td style="text-align: left">roles</td>
<td style="text-align: right">役割(web-server/db-server等)の状態が格納されます</td>
</tr>
<tr>
<td style="text-align: left">site-cookbooks</td>
<td style="text-align: right">自作のcookbookが作成されます</td>
</tr>
</tbody>
</table>

<h5>
<span id="2311-cookbooks" class="fragment"></span><a href="#2311-cookbooks"><i class="fa fa-link"></i></a>2.3.1.1. cookbooks</h5>

<p>インターネットから取得したcookbookが格納されます。このセクションは自分で触らない方がよいと思います。中身を読むだけにしましょう。Berksというツールを使って、このcookbookを取得します。<a href="http://community.opscode.com/cookbooks" rel="nofollow noopener" target="_blank">Opscode Community</a>に存在するcookbookを取得して使う事ができます。</p>

<p>cookbookの具体的な中身に関してはこの後解説いたします。</p>

<h5>
<span id="2312-data_bags" class="fragment"></span><a href="#2312-data_bags"><i class="fa fa-link"></i></a>2.3.1.2. data_bags</h5>

<p>このセクションには、OSでセットアップするユーザ等、OSセットアップに関する「ドメイン」のデータを格納します。<br>
 具体的にはSSHの鍵のデータもここで保持されたりします。</p>

<h5>
<span id="2313-environments" class="fragment"></span><a href="#2313-environments"><i class="fa fa-link"></i></a>2.3.1.3. environments</h5>

<p>staging/production/develop等の環境の違いに関する設定が記述されます。</p>

<h5>
<span id="2314-nodes" class="fragment"></span><a href="#2314-nodes"><i class="fa fa-link"></i></a>2.3.1.4. nodes</h5>

<p>　個別の具体的なnodeに対する設定や状態が記述されます。</p>

<h5>
<span id="2315-roles" class="fragment"></span><a href="#2315-roles"><i class="fa fa-link"></i></a>2.3.1.5. roles</h5>

<p>web-server, db-server等、サーバーの種類別の設定や状態が記述されます。</p>

<h5>
<span id="2316-site-cookbooks" class="fragment"></span><a href="#2316-site-cookbooks"><i class="fa fa-link"></i></a>2.3.1.6. site-cookbooks</h5>

<p>cookbooks以外の、自分たちで作ったcookbookをここに格納します。 </p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ tree -L 3

|-- chef
|   |-- Berksfile
|   |-- Berksfile.lock
|   |-- Gemfile
|   |-- Gemfile.lock
|   |-- cookbooks
|   |   |-- Berksfile.lock
|   |   |-- apache2
|   |   |-- apt
|   |   |-- aws
|   |   |-- build-essential
|   |   |-- chef_handler
|   |   |-- database
|   |   |-- homebrew
|   |   |-- iptables
|   |   |-- logrotate
|   |   |-- mysql
|   |   |-- openssl
|   |   |-- pacman
|   |   |-- postgresql
|   |   |-- windows
|   |   |-- xfs
|   |   `-- yum
|   |-- data_bags
|   |-- environments
|   |-- nodes
|   |   |-- vagrant.json
|   |   |-- info_ec2.json
|   |   `-- mysql01.json
|   |-- roles
|   |   |-- all_in_one.json
|   |   |-- app_server.json
|   |   |-- mysql_master_server.json
|   |   |-- mysql_slave_server.json
|   |   `-- varnish_server.json
|   |-- site-cookbooks
|   |   |-- info-base
|   |   |-- mysql55
|   |   |-- mysql56
|   |   `-- varnish
|   `-- vendor
|       `-- bundle
</pre></div></div>

<h3>
<span id="23-chefのファイルの読み方" class="fragment"></span><a href="#23-chef%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E8%AA%AD%E3%81%BF%E6%96%B9"><i class="fa fa-link"></i></a>2.3. Chefのファイルの読み方</h3>

<p>chefの設定を読み解くためには、nodesディレクトリにある、nodeオブジェクトファイル(jsonファイル)からたどってみるのがいいと思います。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ tree -L 2
.
|-- Berksfile
|-- Berksfile.lock
|-- Gemfile
|-- Gemfile.lock
|-- cookbooks
|   |-- Berksfile.lock
|   |-- apache2
|   |-- apt
|   |-- aws
|   |-- build-essential
|   |-- chef_handler
|   |-- database
|   |-- homebrew
|   |-- iptables
|   |-- logrotate
|   |-- mysql
|   |-- openssl
|   |-- pacman
|   |-- postgresql
|   |-- windows
|   |-- xfs
|   `-- yum
|-- data_bags
|-- environments
|-- nodes
|   |-- vagrant.json
|   `-- mysql01.json
|-- roles
|   |-- all_in_one.json
|   |-- app_server.json
|   |-- mysql_master_server.json
|   |-- mysql_slave_server.json
|   `-- varnish_server.json
|-- site-cookbooks
|   |-- info-base
|   |-- mysql55
|   |-- mysql56
|   `-- varnish
`-- vendor
    `-- bundle
</pre></div></div>

<h4>
<span id="231-nodesnodeファイル" class="fragment"></span><a href="#231-nodesnode%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>2.3.1. nodes/nodeファイル</h4>

<p>ちなみに、nodes/roles/environmentのディレクトリのファイルは、書き方は同じになっています。これらは設定を整理するために分割されているだけです。後述の特定のルールによって設定が上書きされます。例えば今のnodeファイルを見てみましょう。</p>

<p>これは、rolesにあるall_in_oneというのを実行(run_list)する事だけが示されています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># vagrant.json

{"run_list":["role[all_in_one]"]}
</pre></div></div>

<p>じゃあ、次にRoleのall_in_one.jsonを見てみます。</p>

<h4>
<span id="232-rolesのファイル" class="fragment"></span><a href="#232-roles%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>2.3.2. rolesのファイル</h4>

<p>文法は先ほどのものと同じです。<br>
こちらのファイルはいろいろ定義されていますね。このroleは、Vagrantで作ったローカルの仮想マシンに、全てのプロダクトをぶち込むファイルになっています。<br>
読むポイントは次の要素です。</p>

<table>
<thead>
<tr>
<th style="text-align: left">ディレクトリ</th>
<th style="text-align: right">名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">default_attributes</td>
<td style="text-align: right">レシピの設定内容を定義します</td>
</tr>
<tr>
<td style="text-align: left">description</td>
<td style="text-align: right">ファイルの目的を記述します</td>
</tr>
<tr>
<td style="text-align: left">run_list</td>
<td style="text-align: right">実行するレシピを順に記述します</td>
</tr>
<tr>
<td style="text-align: left">override_attributes</td>
<td style="text-align: right">レシピの設定内容を強制的に上書きします</td>
</tr>
</tbody>
</table>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>{
    "name": "all_in_one",
    "chef_type": "role",
    "json_class": "Chef::Role",
    "default_attributes": {
        "mysql": {
            "server_root_password" : "password",
            "server_repl_password" : "password",
            "server_debian_password" : "password"
        },
        "varnish": {
            "backend_host" : "127.0.0.1",
            "backend_port" : "8080",
            "listen_port" : "80"
        }
    },
    "description": "For vargrant environment. All in one package",
    "run_list": [
        "base::packages",
        "info-base",
        "ruby",
        "ruby::passenger",
        "apache2",
        "supervisor",
        "varnish",
        "yum::remi",
        "mysql::server"
    ],
    "env_run_lists" : {},
    "override_attributes": {
        "yum" : {
            "remi" : {
                "includepkgs" : "compat-mysql* mysql*"
            }
        },
        "apache": {
            "listen_ports" : ["8080"]
        }
    }
}
</pre></div></div>

<p>基本的に大きなポイントはrun_listと、attributesの設定です。run_listは、実行するレシピ、attributeは、サーバーの設定ファイルに書かれるような設定値を定義します。この設定値は、cookbook/role/environment/nodeで定義されたものが、下記のルールの従って上書きされます。最終的な上書きされた結果がサーバーに反映されます。多分サーバーを作る時は、cookbookには、デフォルトの値が書かれて、roleで、webサーバー等のサーバー種別毎に決まった値が設定されます。environmentには、staging/production毎に違うような値のみを記述します。最終的にnodeでnode毎に違う情報（ホスト名等）のみを上書きします。こうしておくと、設定値がDRYになるのでオススメです。</p>

<p>この上書きルールですが、下記の図がわかりやすいかと思います。</p>

<p><a href="https://camo.qiitausercontent.com/2c96238fcb39f34960c50aec84835ee8329e1b30/687474703a2f2f646f63732e6f7073636f64652e636f6d2f5f696d616765732f6f766572766965775f636865665f617474726962757465735f707265636564656e63652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2c96238fcb39f34960c50aec84835ee8329e1b30/687474703a2f2f646f63732e6f7073636f64652e636f6d2f5f696d616765732f6f766572766965775f636865665f617474726962757465735f707265636564656e63652e706e67" alt="" data-canonical-src="http://docs.opscode.com/_images/overview_chef_attributes_precedence.png"></a><br>
<a href="https://camo.qiitausercontent.com/e37d6d8166f9e781cc16bc1fa9ea070f9056400f/687474703a2f2f646f63732e6f7073636f64652e636f6d2f5f696d616765732f6f766572766965775f636865665f617474726962757465735f7461626c652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e37d6d8166f9e781cc16bc1fa9ea070f9056400f/687474703a2f2f646f63732e6f7073636f64652e636f6d2f5f696d616765732f6f766572766965775f636865665f617474726962757465735f7461626c652e706e67" alt="" data-canonical-src="http://docs.opscode.com/_images/overview_chef_attributes_table.png"></a></p>

<p>具体的には例えば次のページにかいてあります。</p>

<p><a href="http://docs.opscode.com/essentials_roles.html" rel="nofollow noopener" target="_blank">About Roles</a></p>

<p>他にもenvironment等も設定される可能性がありますので、書き方が同じなので省略します。次に、具体的なcookbookを見てみましょう。単純なのがよいので、私の作成したvarnishのモノを見てみましょう。</p>

<h4>
<span id="233-cookbookの読み方" class="fragment"></span><a href="#233-cookbook%E3%81%AE%E8%AA%AD%E3%81%BF%E6%96%B9"><i class="fa fa-link"></i></a>2.3.3. cookbookの読み方</h4>

<p>cookbookを自分で作りたい時は次のコマンドで実行します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ knife cookbook create varnish -o site-cookbooks
</pre></div></div>

<p>site-cookbooksのvarnishディレクトリに行くと次のようなファイルができています。読む側とすると重要なのは、attributes, receipes, templatesの３つです。それぞれ次のような意味です。</p>

<table>
<thead>
<tr>
<th style="text-align: left">ディレクトリ</th>
<th style="text-align: right">名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">attributes</td>
<td style="text-align: right">デフォルトの設定情報を定義します</td>
</tr>
<tr>
<td style="text-align: left">files</td>
<td style="text-align: right">アップロードしたいファイルを格納します</td>
</tr>
<tr>
<td style="text-align: left">receipes</td>
<td style="text-align: right">レシピの実行内容を記述します</td>
</tr>
<tr>
<td style="text-align: left">templates</td>
<td style="text-align: right">設定ファイルのテンプレートを記述します</td>
</tr>
</tbody>
</table>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ tree
.
├── CHANGELOG.md
├── README.md
├── attributes
│   └── default.rb
├── definitions
├── files
│   └── default
├── libraries
├── metadata.rb
├── providers
├── recipes
│   └── default.rb
├── resources
└── templates
    └── default
        ├── default.vcl.erb
        └── varnish.erb
</pre></div></div>

<p>最初に読みたいのは、receipe/default.rbです。cookbookがrun_listで実行されたらまずコレが呼ばれます。細かい事は説明しませんが、書いてあることだけを説明します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>remote_file "/tmp/#{node['varnish']['file_name']}" do
  source "#{node['varnish']['remote_uri']}"
end


rpm_package node['varnish']['rpm_package_name'] do
    action :install
    options "--nosignature"
    provider Chef::Provider::Package::Rpm
   source "/tmp/#{node['varnish']['file_name']}"
end

package "varnish" do
  action :install
end

template "/etc/varnish/default.vcl" do
  source "default.vcl.erb"
  mode  644
  owner "root"
  group "root"
  notifies :restart, "service[varnish]"
  action :create
end

template "/etc/sysconfig/varnish" do
  source "varnish.erb"
  mode  644
  owner "root"
  group "root"
  notifies :restart, "service[varnish]"
  action :create
end

service "varnish" do
  supports :status =&gt; true, :restart =&gt; true, :reload =&gt; true
  action [ :enable, :start ]
end
</pre></div></div>

<p>ちなみにvarnishのインストール手順 (CentOS)はこんな感じです</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>% rpm --nosignature -i http://repo.varnish-cache.org/redhat/varnish-3.0/el6/noarch/varnish-release/varnish-release-3.0-1.el6.noarch.rpm
% yum install varnish
</pre></div></div>

<p>これは、インストールだけですが、設定ファイルとして、/etc/varnish/default.vclと、/etc/sysconfig/varnishを設定する必要があります。</p>

<p>尚、package等のアクションは、"chef package"などでgoogleすれば、一撃でリファレンスがでてきます。<br>
例えばここです <a href="http://docs.opscode.com/resource_package.html" rel="nofollow noopener" target="_blank">package - Chef docs</a></p>

<h5>
<span id="2331-remote_file" class="fragment"></span><a href="#2331-remote_file"><i class="fa fa-link"></i></a>2.3.3.1. remote_file</h5>

<p>リモートからファイルをとってきて格納するための記述です</p>

<h5>
<span id="2332-rpm_package" class="fragment"></span><a href="#2332-rpm_package"><i class="fa fa-link"></i></a>2.3.3.2. rpm_package</h5>

<p>これは、rpmコマンドに相当する記述です。</p>

<h5>
<span id="2333-package" class="fragment"></span><a href="#2333-package"><i class="fa fa-link"></i></a>2.3.3.3. package</h5>

<p>yum, apt等のパッケージインストールのためのコマンドです。OSによって発行されるコマンドが異なります。</p>

<h5>
<span id="2334-template" class="fragment"></span><a href="#2334-template"><i class="fa fa-link"></i></a>2.3.3.4. template</h5>

<p>設定ファイルを作成したり、書き換えたりします。notifiesという設定をすると、このファイルが書き換えられた後のアクションが記述できます。ここでは、varnishの設定ファイルが書き換えられたら再起動になっています。</p>

<h5>
<span id="2335-service" class="fragment"></span><a href="#2335-service"><i class="fa fa-link"></i></a>2.3.3.5. service</h5>

<p>サービス化と自動起動の設定をします。</p>

<h5>
<span id="2336-bash" class="fragment"></span><a href="#2336-bash"><i class="fa fa-link"></i></a>2.3.3.6 bash</h5>

<p>この他によく使われる物としてbashというアクションがあります。これは、サーバー側でコマンドを発行するためのものです。出来るだけbashを使わないようにします。というのも、他のアクションは、冪等性が考慮されているので、何回実行しても同じ結果になるようになっています。ところが自分でこのbashを作ると、冪等性のコーディングをしないといけませんし、OS毎の挙動の違いも場合によっては自分で書かないといけません。これは面倒です。</p>

<h5>
<span id="attributes" class="fragment"></span><a href="#attributes"><i class="fa fa-link"></i></a>attributes</h5>

<p>　さて、default.rbでは、node['varnish']['file_name']といったような記述が見受けられます。これらの変数の具体的な定義がattributesに書かれています。この値はRole/Environment/Nodeで上書きされる可能性があります。<br>
　<br>
<code><br>
default['varnish']['versions']   = "3.0-1.el6"<br>
default['varnish']['file_name']  = "varnish-release-3.0-1.el6.noarch.rpm"<br>
default['varnish']['remote_uri'] = "http://repo.varnish-cache.org/redhat/varnish-3.0/el6/noarch/varnish-release/varnish-release-3.0-1.el6.noarch.rpm"<br>
default['varnish']['rpm_package_name'] = "varnish-release"<br>
default['varnish']['backend_host'] = "127.0.0.1"<br>
default['varnish']['backend_port'] = "80"<br>
default['varnish']['listen_port'] = "6081"<br>
</code></p>

<h5>
<span id="templates" class="fragment"></span><a href="#templates"><i class="fa fa-link"></i></a>templates</h5>

<p>templateアクションで設定ファイルを作る事を選択した場合は、templatesディレクトリの下に定義ファイルを作りましょう。上記のattributesで設定した値を使う事ができます</p>

<p>default.vcl.erb</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span> backend default {
.host = "&lt;%= node['varnish']['backend_host']%&gt;";
.port = "&lt;%= node['varnish']['backend_port']%&gt;";
}

acl backend_apps { "127.0.0.1";}

sub vcl_recv {
   if (client.ip ~ backend_apps &amp;&amp; req.http.X-REFRESH) {
     set req.hash_always_miss = true;
   }
}

</pre></div></div>

<p>他のcookbook等もこれで一通り読み込むことができます。</p>

<h3>
<span id="24-chefの実行" class="fragment"></span><a href="#24-chef%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>2.4. Chefの実行</h3>

<p>さて、Chefのnodeオブジェクトを実行して、実際にサーバーを望ましい状態にしてみましょう。</p>

<h4>
<span id="241-berksfile" class="fragment"></span><a href="#241-berksfile"><i class="fa fa-link"></i></a>2.4.1. Berksfile</h4>

<p>そのまえに、まず、プロジェクトで使うcookbookを取得してみましょう。自分で作るもの以外は既存のものを使用して、attribute部分のみをrole/environment/nodeで書き換えることができます。Berksは、rubyのGemfileのcookbook版みたいな感じです。ここに欲しいcookbookを書いておきましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>site :opscode
cookbook 'mysql', '~&gt; 4.0.20'
cookbook 'database'
cookbook 'apache2'
cookbook 'yum'

</pre></div></div>

<p>そして、実行します。</p>

<p><a href="http://berkshelf.com/" rel="nofollow noopener" target="_blank">Berkshelf</a></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>% gem install berkshelf
% berks install
</pre></div></div>

<p>berkshelfのgemはGemfileに書いておくといいでしょう。これによりcookbooksディレクトリ以下にcookbookが取得されます。</p>

<h4>
<span id="242-レシピの実行" class="fragment"></span><a href="#242-%E3%83%AC%E3%82%B7%E3%83%94%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>2.4.2. レシピの実行</h4>

<p>さて、遂にレシピを実行する時がきました。読み込んで理解したレシピを流してみましょう。<br>
ここでは、解説しませんが、Vagrant等をつかって、仮想マシンを用意しておきましょう。</p>

<h5>
<span id="2421-事前設定" class="fragment"></span><a href="#2421-%E4%BA%8B%E5%89%8D%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>2.4.2.1. 事前設定</h5>

<p>レシピを流したいサーバーに、<code>% ssh server_name</code> でログイン出来るように設定しておきましょう。<a href="http://www.vagrantup.com/" rel="nofollow noopener" target="_blank">vargrant</a>を使っていない場合は必要ありませんが、vargantの環境の場合は次のようなコマンドが有効です。sshの設定は周りの人に聞いてみてください。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>% vagrant ssh-config --host server_name &gt;&gt; ~/.ssh/config
</pre></div></div>

<h5>
<span id="2422-why-run" class="fragment"></span><a href="#2422-why-run"><i class="fa fa-link"></i></a>2.4.2.2. Why-Run</h5>

<p>実際にレシピを流す前に、サーバーにレシピを流したら一体どうなるか？(Why-Run)を確認するコマンドがあります。実行はnode以下のファイルを指定するといいでしょう。-WオプションがWhy-Runのオプションです。これを実行すると、サーバーで実行される予定の内容がプリントされます。もしエラーが発生したら、上記のファイルを修正します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>bundle exec knife solo cook server_name nodes/vagrant.json -W
</pre></div></div>

<h5>
<span id="2423-knife-solo" class="fragment"></span><a href="#2423-knife-solo"><i class="fa fa-link"></i></a>2.4.2.3. knife-solo</h5>

<p><a href="http://docs.opscode.com/chef/knife.html" rel="nofollow noopener" target="_blank">knife solo</a>コマンドのサブコマンドcookで実際にサーバーをレシピの状態に反映させてみます。Why-Runで動作確認したら、-Wオプションをとってコマンド実行しましょう。 ここでは、server_nameというsshでログインできるサーバーにnodes/vagrant.jsonのnodeオブジェクトから呼ばれるレシピが実行されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>bundle exec knife solo cook server_name nodes/vagrant.json
</pre></div></div>

<p>これで、無事サーバーがセットアップされるはずです。</p>

<h2>
<span id="4-参考文献" class="fragment"></span><a href="#4-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>4. 参考文献</h2>

<p><a href="http://docs.opscode.com/" rel="nofollow noopener" target="_blank">Chef</a></p>

<p><a href="http://www.amazon.co.jp/%E5%85%A5%E9%96%80Chef-Solo-Infrastructure-as-Code-ebook/dp/B00BSPH158" rel="nofollow noopener" target="_blank">入門 Chef Solo</a></p>

<p><strong>Chef Fundamentals Module 1</strong> (下のアイコンをクリックすると、チュートリアルが見れます！) </p>

<p><a href="https://learnchef.opscode.com/screencasts/fundi-webinar-week-1/" rel="nofollow noopener" target="_blank"><img src="https://camo.qiitausercontent.com/f56f666052765fbae2c4494f251f0982d4acdccd/68747470733a2f2f7777772e796f75747562652e636f6d2f79742f6272616e642f6d656469612f696d6167652f79742d6272616e642d646f776e6c6f6164732d6c6f676f2d666f722d7765622e706e67" alt="Chef Fundamentals Module 1" data-canonical-src="https://www.youtube.com/yt/brand/media/image/yt-brand-downloads-logo-for-web.png"></a><br>
ちなみに、同じところに沢山のChefのVideoチュートリアルがあります.</p>

<p>他にも<a href="http://www.youtube.com/user/Opscode" rel="nofollow noopener" target="_blank">Youtube Opscode</a>でもいろいろな講演をみることができます。</p>

<p>以上です</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>559</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/28f4c127c911170cad49">Startupプログラマの為の新アジャイルマニュフェスト(Kent Beck: beyond agile programming)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-30 02:13:07</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[agile]</b> <b>[lean]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>Kent Beck氏がスタートアップのイベントに登壇し、素晴らしい講演をしたビデオを友人のタイムラインから見つけました。<a href="http://www.justin.tv/startuplessonslearned/b/262656520" rel="nofollow noopener" target="_blank">Startup Lessons Learnd: Kent Beck talks beyond agile programming</a> </p>

<p>アジャイルマニュフェストは10年が経過して、誰かの為にソフトウェアを作っていた時代から、スタートアップの時代に移行し、内容が一部古くなっていました。ところがこの講演でKentBeck氏は、それに対する素晴らしい回答をしてくれています。この内容が2010に行われているとは驚きです。</p>

<p>今回、このビデオを未熟なりにディクテーションして、適当ですが、日本語訳を作ってみました。本人に承認を取るつもりですが、ダメなら削除するつもりです。</p>

<p>スタートアップ時代のプログラマの考え方のヒントが沢山つまっているのではないでしょうか？つい、熱くなってしまいました。</p>

<p>また、ディクテーションも日本語訳もこれでいいかわからない部分もあるので、「違うだろ！」と思ったら是非Pull Requestを送っていただければと思います。皆さんのお役に立てれば幸いです！</p>

<h2>
<span id="kent-beck--beyond-agile-programming" class="fragment"></span><a href="#kent-beck--beyond-agile-programming"><i class="fa fa-link"></i></a>Kent Beck : Beyond agile programming</h2>

<h3>
<span id="1-ごあいさつ" class="fragment"></span><a href="#1-%E3%81%94%E3%81%82%E3%81%84%E3%81%95%E3%81%A4"><i class="fa fa-link"></i></a>1. ごあいさつ</h3>

<p>皆さん、こんな朝早くからおいでいただきありがとうございます。何か凄い事を達成したことをお話できるわけではありませんが、皆さんが来てくれて本当に嬉しいです。</p>

<p>私は今日予定されている講演の中で、最もイマイチなアントレプレナーとして講演する名誉を授かりありがとうございます。私は、11のスタートアップに関わってきました。しかも、その中の1社すらも凄いお金を稼いだわけではありません。</p>

<p>大きな規模で成功したのは、一つだけ。JUnitです。</p>

<p>私はお話する内容（リーンスタートアップの分野)に豊富な知識があるわけではありませんので、オープニングスピーチをしてしまっていいのだろうかとは思っています。しかし、皆さんにはすぐにお話しする事を理解していただけると思いますのでお話を始めたいと思います。</p>

<p>しかし、私はあきらめません。リーンスタートアップのスタッフの皆さんが、新しいビジネスに挑戦するエネルギーを私にくれたのですから！<br>
 特に私が人生を費やして磨き上げてきた技術的な側面からお話したいと思います。</p>

<h3>
<span id="2-やぎのかゆいところ" class="fragment"></span><a href="#2-%E3%82%84%E3%81%8E%E3%81%AE%E3%81%8B%E3%82%86%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>2. やぎのかゆいところ</h3>

<p>私は南オレゴンの、片田舎のさらにはずれにすんでいます。そして、やぎを飼っています。２匹のあかちゃんで、すごく可愛くてふわっふわなんです。彼らと外に出ていたときに、背中の方かた、その下の方にかけて掻いてあげていました。多分虫かなにかで、気持ち悪かったのでしょう。そして、お尻のあたりを掻いてあげたら突然、やぎが気持ちよさそうに啼きました「あー、気持ちいい」って多分。</p>

<p>面白い。私がいろいろなところを掻いてあげても、何もおこらなかったのに、あるポイント、つまりやぎがかゆいポイントを掻いてあげると、今までとずっと同じ事をしていても、やぎが気持ちよくなるのです。この事は、私は想像できませんでした。多くの他の場所でやっていた、効果薄だった同じ事が、突然、すっごくやぎにとってもむちゃくちゃ効果的な事になったのです。スタートアップもこれに似ていると思います。</p>

<p>あなたが何かをやり続けていても、レスポンスが無い。やっても、やっても、レスポンスが無い。８個目ぐらいのアイデアで、突然何かが起こる。これは、あなたがエッジだからわけではありません。違う場所を掻いていたからであって、あるポイントに当たると、突然何かが起こって、（顧客の）リアクションがあなたに教えてくれます。ここが、特別なポイントだと。私はこういった幸運をキャリアの中で何回か経験しています。ソフトウェアパターンとか、テスト駆動開発とか、100ぐらいのスケールしたアイデアがありますが、これは、「かゆいところ」にあたったのです。</p>

<h3>
<span id="3-アントレプレナーがするべきこと" class="fragment"></span><a href="#3-%E3%82%A2%E3%83%B3%E3%83%88%E3%83%AC%E3%83%97%E3%83%AC%E3%83%8A%E3%83%BC%E3%81%8C%E3%81%99%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>3. アントレプレナーがするべきこと</h3>

<p>アントレプレナーとして、私が探しているのはこの「かゆいところ」です。どのように沢山の時間やりつづけるかではありません。チェーンソーの通路を通るようなものではないのです。かゆくないところを何回も掻くようなことではありません。</p>

<p>私がやるべき事は、かゆいところを探す事です。それは、いろいろな要素が絡み合っています。タイミングであったり、幸運であったり、掻く事で自体であったり。</p>

<p>あなたが掻く事をしなければ、かゆいところを見つけることはできません。</p>

<h3>
<span id="4-リーンスタートアップ" class="fragment"></span><a href="#4-%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%88%E3%82%A2%E3%83%83%E3%83%97"><i class="fa fa-link"></i></a>4. リーンスタートアップ</h3>

<p>リーンスタートアップは、このことの素晴らしい例です。何かのタイミングだったり、人々や、マーケットがOKをくれるメッセージだったり。世界中で、エリックがやっているのと同じような事を多くの人が実践しています。</p>

<p>１年前、かゆいポイントにはヒットしませんでした。が、リーンスタートアップに関する事がありました。過去１５年の私のビジネスモデルとの組み合わせです。</p>

<h3>
<span id="5-資本効率のお話" class="fragment"></span><a href="#5-%E8%B3%87%E6%9C%AC%E5%8A%B9%E7%8E%87%E3%81%AE%E3%81%8A%E8%A9%B1"><i class="fa fa-link"></i></a>5. 資本効率のお話</h3>

<p>自分がやろうと思っている事を、バリバリのモチベーションで始めます。素晴らしい資本効率はソフトウェアの中にだけある訳ではありません。ここにいる皆さんは、多分ソフトウェア畑の人がおおいですよね。多分ハードウェア系の人もいるでしょう。</p>

<p>資本効率が一番重要な事になったとしたら、あなたはきっと資本効率をよくするために、新しいビジネスモデルが必要になることでしょう。そして、資本効率がよくなるようなマーケットも必要になるでしょう。</p>

<p>そういうものが確立できて、次に来るのが、コミュニティのプラクティスでしょう、そして人々、リーンスタートアップの一部を担う、それぞれの個人だったり、名前だったり、メッセージだったり。デリバリの方法だったり、一緒にするタイミングだったり。</p>

<p>私にとって、リーンスタートアップは、これらの「レスポンス」を送ってくれます。世界中のかゆいところに当たった時のレスポンスを返してくれます。それが起こったら素晴らしいですね。</p>

<h3>
<span id="6-basic-loop" class="fragment"></span><a href="#6-basic-loop"><i class="fa fa-link"></i></a>6. Basic Loop</h3>

<p>だから、我々はわかったのです。基本的なループがあることに気づいたのです。</p>

<p>Build(ビルド), measure(測定), learn(学び)です。私はビルドをします。私はビルドを作るときに、本当に価値のある事をする事を選択できたら、とてもいい気分になります。測定したり、学んだり、数学的な事をやってみたり、ビルドをつくったり。</p>

<p>なぜなら、私はビルダーだからです。それが心地よいのです。</p>

<p>このループを、リーンシンキングの観点から見た場合、このループは本当は逆向きの方向進むのです（バックワード）。</p>

<p>ビルドから始める事。これは、私がやったことで、失敗続きだった方向なのです。ですので、皆さんは真似しなくてもいいと思います。もし、試してみたかったらやってみたらいいですが。しかし、このループは逆向きの方向が望ましいのです。</p>

<h3>
<span id="7-マルチテーブル" class="fragment"></span><a href="#7-%E3%83%9E%E3%83%AB%E3%83%81%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB"><i class="fa fa-link"></i></a>7. マルチテーブル</h3>

<p>みなさんに２つのお話をしましょう。今スタートアップをやっているのです。</p>

<p>マルチテーブルが出来ることって良くないですか？</p>

<p>あなたがオンラインのポーカーをやっているとします。最初は１対１でプレイができるようにします。しかし、それは相当退屈でしょう。だってリアルで出来る事ですから。</p>

<p>20ゲームのポーカーを一度にやること。コレはマルチテーブルといいます。</p>

<h3>
<span id="8-マルチテーブル作戦" class="fragment"></span><a href="#8-%E3%83%9E%E3%83%AB%E3%83%81%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E4%BD%9C%E6%88%A6"><i class="fa fa-link"></i></a>8. マルチテーブル作戦</h3>

<p>　スタートアップとしては、資本効率を上げるためには、20人の人は１つのアイデアのスタートアップに要らないです。10人, 5人, 2人, 1人とどまる事をしりません。</p>

<p>　それだけの人がいたら、あなたは、同時に２つのスタートアップができます。同時に２つのスタートアップが一度にできます。マルチテーブルみたいなものです。私は２つのことを試せるし、全くもって間違った事をやってることに気づいても致命的ではありません。<br>
　</p>

<h3>
<span id="9-tddの例" class="fragment"></span><a href="#9-tdd%E3%81%AE%E4%BE%8B"><i class="fa fa-link"></i></a>9. TDDの例</h3>

<p>　<br>
なぜ、テスト駆動開発というクレイジーなアイデアを思いついたのでしょう。実際のコードを書く前に、テストコードを書きます。もちろん実体がないのですから、テストは最初はいつも失敗します。ところがいったんテストが動くようにコードを書けば、それはクールな事に変わるのです。だから、私はスクリーンキャストをしようと思っています。</p>

<p>TDDに関しては、本を書いて売っても儲かりません。他のメディア展開が必要です。自分でテスト駆動開発をやっているところを録画して、いい情報と、楽しめるナレーションをかぶせてみる。私にとっては一度にやるのは大変ですが、私が録音して公開すれば、人々が考えている事がわかるでしょう。</p>

<p>これが、ループを逆向きにまわす事でしょうか。ビルドから始まっています。</p>

<p>私は、いくつかのエピソードをVimeoに上げます。最初の１０分を。それから、編集します。それから、人々が１００回ぐらい見てくれたらOKでしょう、そうなったらマーケットに出します。</p>

<h3>
<span id="10-学習につまづく" class="fragment"></span><a href="#10-%E5%AD%A6%E7%BF%92%E3%81%AB%E3%81%A4%E3%81%BE%E3%81%A5%E3%81%8F"><i class="fa fa-link"></i></a>10. 学習につまづく</h3>

<p>しかし、私は「学習」フェーズでつまづいてしまいました。だから、先に「ビルド」して、「計測」しました。しかし、何が「学習」を押し進められたのでしょうか？</p>

<p>たぶん、何人かは興味をもってくれたとは思います。</p>

<p>私は逆向きのループに関して学びます。私はものづくりからはじめました。飛び越えて、モノ作りをすることから。</p>

<p>そして、今私は完成させるために、出版社さんとかスタッフの方を探しています。</p>

<p>しかし、私はこの流れでは、何か重要なバリューを失った気がするのです。<br>
　</p>

<h3>
<span id="11-次のプロジェクト" class="fragment"></span><a href="#11-%E6%AC%A1%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>11. 次のプロジェクト</h3>

<p>対照的な次にプロジェクトを紹介させてください。次は、ニーズから始めました。私が出来るならば見つけ出したいだろうニーズです。（注：多分仮説の事かと思います）</p>

<p>49歳の脳みそは、昔のようにはいきません。私の脳力は、昔のようにはいきません。</p>

<p>ゆっくりしたらダメですかね？私が失った脳力を復活させられないだろうか？</p>

<p>そこで、私は小さなゲームを作り始めました。私はこれをわざと秘密にしておきました。ものすごくいいアイデアを持っていたからではありません。<br>
　フィードバックを受ける準備ができていなかったからです。そこで、私はアナウンスできる状態になるまで、アナウンスをしないようにしようと思いました。その代わり私は「質問」から始めたのです。<br>
　<br>
　私が速く、クリアに考えられるようになる手助けができないだろうか？<br>
　<br>
　「学習」の次は、「測定」です。私は「ミス」と「成功」を測定します。そして次にコードを書く事です。<br>
　<br>
　　仮説があっているかを確認するために、測定して、そのために、コードを書くのです。<br>
　　</p>

<h3>
<span id="12-バックワードループ" class="fragment"></span><a href="#12-%E3%83%90%E3%83%83%E3%82%AF%E3%83%AF%E3%83%BC%E3%83%89%E3%83%AB%E3%83%BC%E3%83%97"><i class="fa fa-link"></i></a>12. バックワードループ</h3>

<p>私は考え方を改善することができました。私は今回は完全に前回と違う気分でした。なぜなら私は逆向きのループをまわせたからです。<br>
　<br>
このループは、「学習ー測定ービルド」と呼ぶべきだと思います。「ビルドー測定ー学習」ではありません。私は「ニーズ」から始めたいのです。</p>

<p>次の質問は、このツールを自分以外の他の人が考えるときに使えるかです。この質問も正しいのであれば、次の質問は、このツールを誰か買ってくれるか？です。これが今私がやっていることです。質問から始めること。学習から始める事。次に測定がそれを助けて、最後にビルドです。</p>

<h3>
<span id="13-pushモデル" class="fragment"></span><a href="#13-push%E3%83%A2%E3%83%87%E3%83%AB"><i class="fa fa-link"></i></a>13. pushモデル</h3>

<p>「学習ー測定ービルド」のサイクルはプルの原則です。リーンの原則です。他に、プッシュ型というのもあります。</p>

<p>プッシュ型は大抵の人々が仕事のスケジュールを立てるやりかたです。各プログラマをできるだけ効率的に働かせて、ものをつくります。その後、誰かが買ってくれるかを確認します。これがプッシュモデルです。プロダクトをつくって、それを誰かが買ってくれるかを確認する。</p>

<p>プルモデルの考え方によれば、プッシュ型は、ミクロの効率を上げますが、マクロの効率を犠牲にします。プログラマは効率的にものを作りますが、できたものは誰も欲しくないといように。</p>

<p>これらの、失敗は、我々は、完璧で、洗練されていて、ぴっかぴかに磨きをかけたプロダクトを作っている事に関係するのです。ただし、誰も実際には買ってくれない、、、</p>

<h3>
<span id="14-pullモデル" class="fragment"></span><a href="#14-pull%E3%83%A2%E3%83%87%E3%83%AB"><i class="fa fa-link"></i></a>14. pullモデル</h3>

<p>　プッシュ型の考えの、ソフトウェアエンジニアリングとしてよい仕事をしようとする事は、沢山のバリューを生む事にはなりません。</p>

<p>　今日お話ししたい、最初の原則は、プルの原則です。「学習ー測定ービルド」はスタートアップでしっかりしたものを作る原則だし、２つめの原則は、フローの原則です。<br>
　</p>

<h3>
<span id="15-アジャイルマニフェスト" class="fragment"></span><a href="#15-%E3%82%A2%E3%82%B8%E3%83%A3%E3%82%A4%E3%83%AB%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>15. アジャイルマニフェスト</h3>

<p>フローの原則はアジャイルマニフェストの後で説明します。アジャイルマニフェストが作られたとき、私は病気で死にかけていていましたので、ミーティングのことははっきり覚えていません。</p>

<p>ジムハイスミスと、マーチンファウラーは、考えをまとめるにあたって、本当に貢献してくれましたし、賞賛されるべきです。</p>

<p>10年前、アジャイルマニュフェストは、ソフトゥエアの世界を一歩先に進めました。</p>

<p>その部屋にいた人が同意できることは、あまり多くはありませんでした。我々が同意出来た事は、人々に魅力的であること。そこで、我々はAgileという言葉を取り上げました。</p>

<p>なぜなら、みんながアジャイルになりたがっていたからです。もし、あなたのアイデアがみんなに受け入れられてもらえるように名前をつけるとき、みんなが、すでに知っていて、その言葉が、忠告してくれたり、どういう事が起こるのかを語ってくれるようにするのがいいでしょう。</p>

<h3>
<span id="16-プロセスやツールより個人と相互作用" class="fragment"></span><a href="#16-%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%84%E3%83%84%E3%83%BC%E3%83%AB%E3%82%88%E3%82%8A%E5%80%8B%E4%BA%BA%E3%81%A8%E7%9B%B8%E4%BA%92%E4%BD%9C%E7%94%A8"><i class="fa fa-link"></i></a>16. プロセスやツールより、個人と相互作用</h3>

<p>昔、いいソフトウェアを作る為には、我々はよいプロセスやツールを持つべきだという考えがありました。</p>

<p>もし、あなたが正しいプロセスを持ったならば、誰が実行するかは重要ではありません。だから、あなたはモンキーを雇って、ソフトウェアを書かせたら、まったく同じものが出来るあがることになります。</p>

<p>だから、プロセスやツールでは、十分ではありません。そこで、こういう事でソフトウェア開発の世界を一歩先に進めました。</p>

<p>人そのものや、人々が相互にコミュニケーションを取るのが重要だよ。プロセスとかよりもね。</p>

<p>これが、１０年前の一歩でした。</p>

<h3>
<span id="17-チームのビジョンのチームの決め毎" class="fragment"></span><a href="#17-%E3%83%81%E3%83%BC%E3%83%A0%E3%81%AE%E3%83%93%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%81%E3%83%BC%E3%83%A0%E3%81%AE%E6%B1%BA%E3%82%81%E6%AF%8E"><i class="fa fa-link"></i></a>17. チームのビジョンのチームの決め毎</h3>

<p>これは、私がスタートアップのプログラマを始めたので、これでは十分ではなくなってしまいました。それを越える必要がでてきたのです。</p>

<p>今の私は、私がどうやっていい仕事をするか？ということを考えるのではなく、チームが如何にいい仕事をするか？という事を考える必要があるのです。</p>

<p>この事は、時には実践的ですが、時にはあまり面白くない事も起こることを意味します。</p>

<p>もし、チームが沢山の事を達成できるためには、私がベストと自分で思える事をする事を少なくしないと行けないケースがあります。</p>

<p>自分が、問題を解決するクールなテクニックをしっているとします。そして、チームの他のだれも、そのドメインのPhDを持っていません。もちろん、その問題を解く為の技術的なベストな方法もしりません。</p>

<p>　もし、自分がその事をしる唯一の人だとすると、自分ならそれをやれるけど、自分はチームの一員だといって、一歩引く必要があります。<br>
　<br>
　私は一歩ひいて、チーム全体としてもっと達成できるように手伝います。<br>
　<br>
　そして、そのような状況だと、私はテストを動かすことも、タスクを引き受けることもNOといわないといけないかもしれません。そのかわり、チームにルールをフィットさせることをしないと行けないでしょう。<br>
　<br>
　しかし、こういったことは、チーム全体のパフォーマンスを上げる傾向にあります。チームのビジョンと、チームのルールを守ってもらうことは、個人のパフォーマンスを最適化することの先をいっています。<br>
　</p>

<h3>
<span id="18-包括的なドキュメントより動くソフトウェア" class="fragment"></span><a href="#18-%E5%8C%85%E6%8B%AC%E7%9A%84%E3%81%AA%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%82%88%E3%82%8A%E5%8B%95%E3%81%8F%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2"><i class="fa fa-link"></i></a>18. 包括的なドキュメントより、動くソフトウェア</h3>

<p>アジャイルマニフェストには４つの価値があります。</p>

<p>次は、全てがドキュメント化されていれば、上手く行くという迷信です。</p>

<p>そういったドキュメントは、いつもソフトウェアにくらべて古くなっていました。だから、それはもっともよくある勘違いです。</p>

<p>だから、ドキュメントではなく、動くソフトウェアに重点を置いたのは、大きな一歩だったのです。</p>

<p>もし、あなたが凍結されたシステムの完璧なるドキュメントをもっていたとすると、そのシステムは、すでに誰のものでもない問題を解決することになります。</p>

<p>だから、今日の問題を解決するソフトウエアをもつことが重要です。だからこの事はとても大きな一歩でした。</p>

<h3>
<span id="19-学習を検証すること" class="fragment"></span><a href="#19-%E5%AD%A6%E7%BF%92%E3%82%92%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>19. 学習を検証すること</h3>

<p>スタートアップの環境では、10回に9回は、どうやってソフトウェアを書いていいのかわかりません。</p>

<p>　フライトキャスターがいて、彼らの仕事は凄いテクノロジーの責任をもっているとします。私はそういう環境で働くのは好きです。なぜなら、私は、他の２つのサイクルの事を無視することができますから。これは素晴らしい。しかし、、、<br>
　<br>
　スタートアップでは、動くソフトウェアで進捗を測定することはできません。<br>
　<br>
　スタートアップは、ほとんど不可能なことのリストで始まるのです。<br>
　<br>
　これは、「検証しないと致命的になる仮定」と呼ばれます。つまり、その仮定が覆ると、そのビジネス自体が成り立たなくなるのです。例えば誰かがお金をはらってくれるかとか、顧客を獲得できるのかとか。<br>
　<br>
　ほとんど不可能な事に首を突っ込むゲームみたいなものです。<br>
　<br>
　だれか、このWebゲームにお金を払ってくれますか？もし、それがほとんど不可能だったとして。そら、誰も払ってくれないでしょう。<br>
　これは、いつだってクレイジーなアイデアです。<br>
　<br>
　しかし、ほとんど不可能リストをもって、スタートアップを始める事はとても価値のあることなのです。<br>
　<br>
　あなたが、その不可能を可能に変えることに成功したらどうなるでしょう？<br>
　<br>
　動作するソフトウェアは、その解の一部にはなりえますが、最高の回答ではありません。</p>

<p>　だから、アジャイル開発をこえて、組織として、学習する機会をつくり出すことが重要なのです。単純にコードを書く事ではなくてです。<br>
　</p>

<h3>
<span id="20-契約交渉よりも顧客との対話" class="fragment"></span><a href="#20-%E5%A5%91%E7%B4%84%E4%BA%A4%E6%B8%89%E3%82%88%E3%82%8A%E3%82%82%E9%A1%A7%E5%AE%A2%E3%81%A8%E3%81%AE%E5%AF%BE%E8%A9%B1"><i class="fa fa-link"></i></a>20. 契約交渉よりも、顧客との対話</h3>

<p>10年前の、その他の伝説としては、正しい契約をすれば、全てが上手く行くというお話です。反対の事は正しいと思います。あなたがチームを訪問することができたなら。</p>

<p>　あなたが、ソフトウェアをみて、サプライやとカスタマーの間の契約がゲームオーバーと言えば、あなたはなにもできません。<br>
　<br>
　この点では、契約はあまりよくありません。<br>
　<br>
　顧客との対話が、最初に細かい事を決めて契約をすることよりも重要という話しをした事は大きな一歩です。<br>
　</p>

<h3>
<span id="21-顧客発見" class="fragment"></span><a href="#21-%E9%A1%A7%E5%AE%A2%E7%99%BA%E8%A6%8B"><i class="fa fa-link"></i></a>21. 顧客発見</h3>

<p>　今、あなたはスタートアップです。あなたには顧客がいません。<br>
　<br>
　私はコラボレートしたいですが、いないのです。コラボレートする顧客がいないのであれば、スティーブブランクが行っているとおり、ビルの外にでて、顧客を探してくるしかありません。顧客がいるなら、顧客との対話は重要です。でも、いなかったら見つけましょう。　<br>
　<br>
　ですので、スタートアップの場合は、それを越えるひつようがあります。<br>
　</p>

<h3>
<span id="22-計画に従うよりも変化を抱擁する" class="fragment"></span><a href="#22-%E8%A8%88%E7%94%BB%E3%81%AB%E5%BE%93%E3%81%86%E3%82%88%E3%82%8A%E3%82%82%E5%A4%89%E5%8C%96%E3%82%92%E6%8A%B1%E6%93%81%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>22. 計画に従うよりも、変化を抱擁する</h3>

<p>　10-15年前の伝説として、ソフトウェア開発を上手く行かせる方法は計画をたてることだという話しがありました。<br>
　<br>
　働くために、計画を立てて、正しく計画を実行する。これは何回もプロジェクトマネージャから聞いた事です。<br>
　<br>
　多分計画を一生懸命立てても、いろいろ変わってしまうことに気づくでしょう。だから、変化を抱擁することが重要といったことは、とても大きな一歩です。<br>
　<br>
　　実際の世界は、計画よりずっと柔軟なものです。<br>
　　<br>
　変化に対応する事のメタファーは、変化に対応してプロジェクトを実行することなのです。いい感じですね。<br>
　<br>
　</p>

<h3>
<span id="23-変化を起こす" class="fragment"></span><a href="#23-%E5%A4%89%E5%8C%96%E3%82%92%E8%B5%B7%E3%81%93%E3%81%99"><i class="fa fa-link"></i></a>23. 変化を起こす</h3>

<p>あなたは今やスタートアップの一員です。変更するものがまだありません。</p>

<p>なぜなら、何も動いていないからです。最初に慣性の法則で習った事を確立させることが必要です。</p>

<p>これは、変化を起こすことが必要です。ただ、対応するのではありません。</p>

<p>あなたが（世界に）変化を起こさなければ、スタートアップとしては、何もしていないのと同じ事です。</p>

<p>軍隊は変化を起こす事について、偉大なコンセプトを持っています。<br>
　<br>
あるチームは、自ら事を起こします。一方他のチームは、それに反応します。</p>

<p>ある、歴史的に有名な軍隊ののリーダーがいます。彼は、何かを始めることについてのいい教訓です。</p>

<p>　あなたが300人の部下しかないとして、あなたは、他のチームがせめて来るのを待ちません。なぜなら、あなたが事を起こすと、圧倒的に優位に立てるからです。もちろん、あなたは危険にさらされます。<br>
　<br>
　　一方、他のリーダーは、あなたが何をしでかすかばかりを心配しています。そして、彼自身が何をするかには頭がまわりません。<br>
　　</p>

<h3>
<span id="24-the-civil-war" class="fragment"></span><a href="#24-the-civil-war"><i class="fa fa-link"></i></a>24. the Civil War</h3>

<p>このことは、Civil Warでも起こりました。グラント将軍は、西の軍隊にいきました。レポーターは彼にたずねました。彼がRoberty Leeが次に何をすると思っているかと。彼は答えました。「私はLeeが何を次にするかには興味がない。私が次に何をして彼を心配させるかのことを考えているんだ」</p>

<p>このことが、Civil Warの展開を変える事になった。</p>

<h3>
<span id="25-アジャイルマニフェストを越えて" class="fragment"></span><a href="#25-%E3%82%A2%E3%82%B8%E3%83%A3%E3%82%A4%E3%83%AB%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88%E3%82%92%E8%B6%8A%E3%81%88%E3%81%A6"><i class="fa fa-link"></i></a>25. アジャイルマニフェストを越えて</h3>

<p>だから、私にとっては、アジャイル開発を越えて、スタートアップは、チームビジョンをもって、規律をもって、全体を最適化しないといけない。</p>

<p>　プロセスやツールは、人のアウトプットを最大化しない。ソフトウェアを作る事よりも、学習することにフォーカスをあてよう。<br>
　<br>
　そして、ニーズからはじめて逆のループをまわそう。顧客を見つけるのだ。<br>
　<br>
　そして、変化を単に待つんじゃなくて、自ら変化を起こすのだ。<br>
　</p>

<h3>
<span id="26-プルの原則" class="fragment"></span><a href="#26-%E3%83%97%E3%83%AB%E3%81%AE%E5%8E%9F%E5%89%87"><i class="fa fa-link"></i></a>26. プルの原則</h3>

<p>最初の原則はプルの原則でした。私は２番目の原則について話すといっていましたね。</p>

<p>　あなたが欲しいことに対する学習からはじめて、逆のループをまわして、あなたの欲しいものを作るのだ。<br>
　</p>

<h3>
<span id="27-フローの原則" class="fragment"></span><a href="#27-%E3%83%95%E3%83%AD%E3%83%BC%E3%81%AE%E5%8E%9F%E5%89%87"><i class="fa fa-link"></i></a>27. フローの原則</h3>

<p>２番目の原則は、フローの原則です。もし、あなたが２つのデリバリを半々の機能でリリースできるなら、１つのデリバリをするよりも、ずっと価値がある事です。</p>

<p>私は別の日にノルウェーの男について話していました。年上で大きなコンサルティングファームにいました。彼は私にスタータアップの戦略を教えてくれたのです。</p>

<p>開発者が、本当に磨き上げたプロダクトをつくりました。素晴らしすぎて誰も文句をいうことが出来ないぐらいです。あなたはそれに１年を費やしました。本当にいいものをつくりあげてリリースしました。そして、フィードバックを得ました。誰もこれを買いたくなかったのです。こういうことは起こるのです。</p>

<p>　だから、半分のプロダクトをつくって、仮説と検証をしっかりやりましょう。しっかり学んだ後に、磨き上げましょう。<br>
　<br>
　３ヶ月。これがフローの原則が有効に働く期間です。<br>
　<br>
　全体のサイクルを如何に短く出来るか？これが我々が考えるべき事です。<br>
　</p>

<h3>
<span id="28-ペイメントゲートウェイ" class="fragment"></span><a href="#28-%E3%83%9A%E3%82%A4%E3%83%A1%E3%83%B3%E3%83%88%E3%82%B2%E3%83%BC%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A4"><i class="fa fa-link"></i></a>28. ペイメントゲートウェイ</h3>

<p>　ゲームの話しを考えましょう。私の妻は私がプログラムコードを書いてお金にならない状況にうんざりしています。だから、このゲームが売れるのかというのを早く検証したいのです。</p>

<p>　儲かるかな？このゲームは２つのパートからできています。あなたは最初のパートをプレイします。<br>
　<br>
　そして、あなたが、最初のパートに熱中したなら、「購入」ボタンがでてきて、購入すると、次のパートに進めるという感じです。だから、私はエンジニアと話しをして、これをやるためには、ペイメントゲートウェイをつくらなあかんなと。<br>
　<br>
　私は考えました。これは、スタートアップエンジニアリングのエンジニアリングゲームであると。だから、これを分割できないだろうかと。分けられないように見えるタスクを小さなピースにできないだろうか？<br>
　<br>
　これは、クールなパズルです。あなたは「学習ー測定ービルド」を通じて解決するのです。全てのエンジニアの脳みそをフル回転させて、自分がオッケーと思えるアイデアを思いつきました。だからお話します。<br>
　<br>
　私が考えた事は、ペイメントゲートウェイなしで、どうやって実装できるだろいうか？ということでした。最初のパートが終わったあとに、購入ボタンがあらわれて、ボタンを押すと、次のパートが始まります。ただし、我々にメッセージが飛ぶようにするのです。<br>
　<br>
　だから、我々は、みんなが「購入ボタン」を押してくれるかどうかを知る事ができるのです。しかし、みんなが「購入ボタン」を押すと、後半のパートを無料で遊べてしまうのです。<br>
　<br>
　最高でしょう。顧客ができないのです。私は顧客がいないので、ペイメントゲートウェイがあるかどうかは、たいした問題ではないのですから。<br>
　<br>
　もし、私は100万の顧客を獲得したら、そして、私がペイメントゲートウェイを実装していなかったら、お腹いっぱいになってしまうでしょう。<br>
　<br>
　しかし、私は「購入ボタン」を押してくれるかどうかだけが知りたいのです。<br>
　</p>

<h3>
<span id="29-全体のループを考える" class="fragment"></span><a href="#29-%E5%85%A8%E4%BD%93%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%97%E3%82%92%E8%80%83%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>29. 全体のループを考える</h3>

<p>　スタートアップの開発者として、全体のループを考える必要があります。<br>
　<br>
　最も大きな違いは、どのように私が最高のソフトウェア開発をするかを考えるのではなく、「学習ー測定ービルド」のループを如何に早くまわすかということを考えるのです。<br>
　<br>
　できるだけ、早くループをまわして、出来る限り最高のバリューを各サイクルで得ようとします。<br>
　<br>
　私はそれらを達成するために、エンジニアリングを実施します。例えばモックアップとか。ソフトウェアすら必要ありません。インデックスカードとか、シャーピーとか。まぁ、私は嫌いですけど。<br>
　<br>
　今１８時間を節約したって？<br>
　私はいいエンジニアか？って。そのとおり。<br>
　<br>
　私は他のエンジニアの友達を感心させたい。しかし、彼らはスタートアップの問題をかかている。<br>
　</p>

<h3>
<span id="30-良いスタートアップのエンジニアリングとは" class="fragment"></span><a href="#30-%E8%89%AF%E3%81%84%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%AE%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>30. 良いスタートアップのエンジニアリングとは</h3>

<p>時々は、ハッカーになったっていい。</p>

<p>しかし、基本的にはあまりよくない。</p>

<p>我々はコピペして、２行変えるだけだぜ！</p>

<p>みんな、こんなゲームをプレイしたい？例えば我々が、注意深くリファクタリング、リファクタリング、リファクタリング、、、、三昧な</p>

<p>それは、エンジニアとしては気分がいいかもしれない。しかし、それはスタートアップのエンジニアリングとしては、あまりよくない。それらは、もっとも安い方法じゃないからだ。</p>

<p>ループをまわすことは、スタートアップでいつもハックを繰り返すことじゃないんだ。</p>

<h3>
<span id="31-モードを変える" class="fragment"></span><a href="#31-%E3%83%A2%E3%83%BC%E3%83%89%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>31. モードを変える</h3>

<p>もし、ゲームがヒットしたらどうなるだろう、スケールしてしまったら。あなたは、そのサイクルから、モードを変える必要がある。あなたがやるべき事は、顧客を魅了できるかどうか確かめることでは無くなっているからだ。</p>

<p>今や、あなたが学習するべき事は、どうやったら顧客を倍にできるかだ。</p>

<p>テスト駆動開発や、自動化、リファクタリング、レスポンシブデザイン、そして、スタッフの仕事を妨げる事無く、平行で変更できるようにするようになることだ。</p>

<p>そして、今のお金の流れから、どうやったらより多くのお金を獲得できるかを学習するのだ。</p>

<p>そのとき、エンジニアリングはシフトする。完璧にスループット指向になる。どうやったらエンジニアリングチームのコストを減らす事ができるだろうか？</p>

<p>どうしたら、運用コストを下げる事ができるだろうか？<br>
他に何かできることは？</p>

<p>スタートアップの良いエンジニアリングができるエンジニアになることです。</p>

<p>これらのフェーズで、これらモードチェンジ、つまり考え方の移行は本当に難しい事です。私もこの移行でトラブルになりました。</p>

<p>多くの他の人が、多くのエンジニアリングチームが機能を出来るだけ早く作るようにしていることを見てきました。</p>

<h3>
<span id="32-先週より２倍早く機能を実装できたぜ" class="fragment"></span><a href="#32-%E5%85%88%E9%80%B1%E3%82%88%E3%82%8A%EF%BC%92%E5%80%8D%E6%97%A9%E3%81%8F%E6%A9%9F%E8%83%BD%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%A7%E3%81%8D%E3%81%9F%E3%81%9C"><i class="fa fa-link"></i></a>32. 先週より２倍早く機能を実装できたぜ</h3>

<p>そして、彼らは気分よくなります。先週より、２倍早く機能を実装できた。俺たちクールだぜ！</p>

<p>もし、あなたが顧客を獲得してスケールしたとき、最高のエンジニアリング戦略は、機能を削減することです。</p>

<p>これらの、考え方の移行は本当に難しい。なぜならこれらは、技術の問題ではなくて、文化の問題だからです。</p>

<h3>
<span id="33-結論" class="fragment"></span><a href="#33-%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>33. 結論</h3>

<p>リーンスタートアップでの、モノ作りのゴールは、ループをまわす時間を最小化し、そこから得られるバリューを最大化させることです。</p>

<h2>
<span id="原文" class="fragment"></span><a href="#%E5%8E%9F%E6%96%87"><i class="fa fa-link"></i></a>原文</h2>

<p>ディクテーションしたものなので、不正確な内容が含まれていることをご了承ください。</p>

<h3>
<span id="1-introduction" class="fragment"></span><a href="#1-introduction"><i class="fa fa-link"></i></a>1. Introduction</h3>

<p>Thank you very much thank you all for your coming early in the morning and for those of you perform early in the morning.It’s not such an accomplishment for you to be here but I’m glad you’re here too.</p>

<p>I have the the privilege and honour of being the worst entrepreneur on the schedule today. I (las can?) have been involved in 11 startups but none of which have made significant money.</p>

<p>Only one of which has been successful on large-scale that’s JUnit.</p>

<p>I wasn’t quite sure about opening my speech by disclaiming any ability in the area that we are talking about. But I figured you’d figure it out soon enough anyway so I should just open up.</p>

<p>But the thing is I haven’t given up because I can see especially<br>
the lean startup stuff is brought me new energy for continuing trying’ out the businesses.</p>

<p>Around the technical capabilities that I spent most of my life<br>
trying to refine.</p>

<h3>
<span id="2-goats-story" class="fragment"></span><a href="#2-goats-story"><i class="fa fa-link"></i></a>2. Goats story</h3>

<p>I live in the southern Oregon, we are out on the boonies.<br>
And we have goats , no, really goats.We just had two babies. They are so cute it’s like a little furry 80-80.</p>

<p>They are wonderful. But the other day I was out with the goats and I was starting to scratch the goats cause the bug you otherwise and the goat was okay whatever I went down the back in little further down the back. And then right near their hip, this goes to hip all of sudden, goats just went. Oh. That’s feels great.Ooh. </p>

<p>it’s interesting so I can scratch all over these skills, nothing, And I hit this one spot and all of this itchy spot you know, hit an itchy spot and all of a sudden the same activity that I’ve been doing all along turns into something wonderful for this goat. </p>

<p>I mean I can’t really imagine what it’s like I don’t want to really imagine what it’s like but I can see you that the same activity and lots of different places small effect and all of a sudden that same little activity has a completely outsized effects on the goat’s experience of the an... those scratchin’ and that’s so little like startups for me.</p>

<p>You keep doing stuff no response and you do stuff no response you do stuff no response and then you do the eighth idea you try out takes off is not like you’re edging. It’s not your scratching any different you just hit an itchy spot and when you hit an itchy spot, all of sudden the reaction tells you this is something special and I’ve had the good fortune to have that happen several times in my career, Where software patterns or test driven development. Those I mean I had hundred ideas that scale but those at that time really hit an itchy spot.</p>

<h3>
<span id="3-entrepreneur" class="fragment"></span><a href="#3-entrepreneur"><i class="fa fa-link"></i></a>3. Entrepreneur</h3>

<p>And  as an entrepreneur that’s what I’m looking for that itchy spot not　how can I somehow sustain hundred hour weeks I mean It’s not like a getting the chainsaw aisle to scratch the goaded doesn’t work not not twice.</p>

<p>But how can I take the things that I do and find a spot that that really some there’s it it’s a combination of factors right there su..There’s timing there’s luck and there’s scratching.</p>

<p>If you’re not scratching, you’re not getting to hit the itchy spot guarantee you that. </p>

<h3>
<span id="4-lean-startup" class="fragment"></span><a href="#4-lean-startup"><i class="fa fa-link"></i></a>4. Lean Startup</h3>

<p>And lean startups is a great example of this for me too. Because something about the timing the message that people the market were all just right.</p>

<p>So in the world. There are probably thousands of people, Doing the same kinds of things that Eric was doing.</p>

<p>A year ago and it just didn’t hit an itchy spot but something about lean startups and the combination of pay my and my business model for the last 15 years.</p>

<h3>
<span id="5-capital-efficiency" class="fragment"></span><a href="#5-capital-efficiency"><i class="fa fa-link"></i></a>5. Capital efficiency</h3>

<p>Start working what am I going to do there’s a bunch of motivation The incredible capital efficiencies not just in software I mean I think most people here probably in software but but hardware businesses, too. </p>

<p>Their capital efficiencies go up to a factor of 10. So you got the need for a new business model you have capital efficiency You have markets that are much more efficient.</p>

<p>And all of that came to and then a community of practice people there are isolated people who are doing parts of lean startups And the name the message The way of the deliver,  the timing all of the came together so for me.</p>

<p>Lean startups sends this response and the the response around the globe is really that’s one of those itchy spot.And it’s great that it’s happening.</p>

<h3>
<span id="6-basic-loop-1" class="fragment"></span><a href="#6-basic-loop-1"><i class="fa fa-link"></i></a>6. Basic loop</h3>

<p>So we see. Here’s the here’s the basic loop</p>

<p>Build, measure and learn, I’m a build guy. That’s that’s what I do that’s what I’m comfortable doing. If I have a choice between doing something really valuable In measure or learn or doing something really trivial and build I’ll build every every time Because I’m a builder it’s what I’m comfortable to do it.</p>

<p>When I looked at this from Lean thinking kind of perspective one thing I realises it this loop is actually backward.</p>

<p>It is the way that I’ve done it and I told you I have a long record of failure doing it that direction. so if you don’t want to, you don’t need to try it. </p>

<p>You can if you want but this loop is backwards.</p>

<h3>
<span id="7-multitable" class="fragment"></span><a href="#7-multitable"><i class="fa fa-link"></i></a>7. multitable</h3>

<p>I’ll tell you two stories I had two.<br>
Startups going right now.</p>

<p>Is not cool that we can multitable now? You are in the poker when people play online poker.</p>

<p>They started playing two games at once and this was considered rule you can play two games well, turns out pokers mostly boring so you can actually play.</p>

<p>20 games of poker once that’s called multitable. </p>

<h3>
<span id="8-multitable-strategy" class="fragment"></span><a href="#8-multitable-strategy"><i class="fa fa-link"></i></a>8. multitable strategy</h3>

<p>Startups, As the capital efficiency increases right you don’t need 20 people to do is start up and you don’t need 10 people to start up then you can do start of 5 And with 2 ,with 1 is not stopping there.</p>

<p>You can do two startups, you can do five startups the once. I mean  at some point it’s got it end but It’s cool that that’s that that kind of multi tabling as possible so so I have two things going one of them I’m doing completely wrong And now I’m hoping to get some ideas here today so I thought...</p>

<h3>
<span id="9-tdd-example" class="fragment"></span><a href="#9-tdd-example"><i class="fa fa-link"></i></a>9. TDD example</h3>

<p>Why have this test driven development idea you know which is this crazy idea that you write the test before you write the code, but test always fails, so why do you write it down well, turns out to be really cool work really well so that I’ll do some screen casts.</p>

<p>About TDD you know you can’t make money selling books anymore (Sycanth) so I got to find some other media strategy So maybe I’ll do some screen cast. so I’ll record myself doing test driven development And then you know do a little narration trying to be both informative and entertaining which is actually too much for me to do once but they have it so I’ll record these and then I’ll put them out there and see what people think.</p>

<p>That’s running the loop backwards. That starts with the build.</p>

<p>So I recorded a couple episodes of putting up on Vimeo the first 10 minutes and edited And then I saw what like people yeah people view Vimeo hundred times okay so there’s some market out there </p>

<h3>
<span id="10-stuck-on-learning" class="fragment"></span><a href="#10-stuck-on-learning"><i class="fa fa-link"></i></a>10. Stuck on learning</h3>

<p>But I’m kind of stuck on the learning phase. so I built, I measured but what is the how strengthen the learn.</p>

<p>I guess some people are interested.</p>

<p>Where do I go from here. I learn the loop backwards on that project. </p>

<p>I started it with making something because I just jumped to make in things. </p>

<p>And and now I’m kind of stuck I’ll push it through to completion of you don’t get them out there and find a publisher and out all that stuff.</p>

<p>But I get the feeling I lost a lot of value in that sequence. </p>

<h3>
<span id="11-the-next-project" class="fragment"></span><a href="#11-the-next-project"><i class="fa fa-link"></i></a>11. The next project</h3>

<p>Let me contrast that with my my next project which started with the need I wanted to find out if I could.</p>

<p>To not my 49-year-old brain so I know my memories not as good as it used to be, My cognitive skills aren’t as good as they used but.</p>

<p>Can I slow down? Can I recover some of what I lost?</p>

<p>So I built a little game and I’ll be cagey about this not because I’m trying of Build some you know build up interest I can see all of you are really excited about this idea.</p>

<p>But but because I’m not ready for more feedback so I’ll announce it when the time comes to announce it but I started with a question.</p>

<p>Can I help myself think faster and more clearly?</p>

<p>Well okay so now what’s the measurement of that I think a task. I thymic. And I measure the mistakes okay so now what software what I need to write. </p>

<p>In order to measure that in order to know whether or not.</p>

<h3>
<span id="12-the-loop-backwards" class="fragment"></span><a href="#12-the-loop-backwards"><i class="fa fa-link"></i></a>12. the loop backwards</h3>

<p>I can improve my thinking. That one feels completely different because I ran the loop backwards</p>

<p>So the loop I think really should be called learn measure build. I don’t I don’t say build measure learn I say learn measure build because I want to start with a need. now the next question is can somebody else use the same tools also help their thinking.</p>

<p>Turned out the answer to that is yes then the next question is Can we get somebody pay for this.  and that’s what I’m working on now  but It starts with a question learn then when the measurements are needed to support that And then build. </p>

<h3>
<span id="13-push" class="fragment"></span><a href="#13-push"><i class="fa fa-link"></i></a>13. push</h3>

<p>this learn measure build. Is the principle of pull.  in the lean manufacturing you got push.</p>

<p>This is the way most people schedule work.  You know, let me ... How can I get my programmers working as Good as possible, or as most efficiently as possible?  Then then we’ll see if anybody will buy it. that’s the push model.</p>

<p>Build this product and see if anybody will buy it. the pull model says... That gains micro efficiencies like the programmers to work really fast in that environment, but it sacrifices a macro efficiencies by building things and people don’t actually want.</p>

<p>The number of those fails starts that I was talking about we are building products complicated sophisticated carefully polished products.</p>

<p>But nobody ever actually bought so</p>

<h3>
<span id="14-pull" class="fragment"></span><a href="#14-pull"><i class="fa fa-link"></i></a>14. pull</h3>

<p>In that environment looking at it from push perspective, Trying to do a better job of software engineering is not actually going to creating more value.</p>

<p>So the first principle little talk about Today is is a principle of pull. </p>

<p>Learn measure build is a way of making a concrete for for start ups the second one is the principal of flow.</p>

<h3>
<span id="15-agile-manifesto" class="fragment"></span><a href="#15-agile-manifesto"><i class="fa fa-link"></i></a>15. Agile manifesto</h3>

<p>That after I finished taking a shot at the Agile manifesto that I was at the meeting where the agile manifesto was written, I was deathly ill and on some ungodly antibiotics so I don’t actually remember much of the meeting.</p>

<p>Jim Highsmith and Martin Fowler really deserve the credit for pulling all his pieces together. </p>

<p>10 years ago the agile manifesto was a step forward.</p>

<p>It was a least common denominator of the people in the room that is that with those were the things we all could agree on And we wanted to make it attractive to people so we picked the word agile.</p>

<p>Because everybody wants to be agile well it turns out if you name your idea something that everybody, wants Everybody will say they already are that so Just word of warning or where you are is gonna happen. oh yeah. we’ll in.</p>

<p>Here’s our here’s our 60 page lean products Beck.<br>
Bro here’s a lean stealth stealth wants instant yet ha ha</p>

<p>Lean private beta. Is it’s a get one. And I make a great button.<br>
I mean such an in joke though but then you know you had some ache.</p>

<p>Anyway oh and end that the reason it’s back at A is because my parents had a good sense to have a name beginning the alphabet.</p>

<h3>
<span id="16-individuals-and-interactions-over-processes-and-tools" class="fragment"></span><a href="#16-individuals-and-interactions-over-processes-and-tools"><i class="fa fa-link"></i></a>16. Individuals and interactions over processes and tools</h3>

<p>Agile manifesto anyway so processes and tools there was a day when When people thought in the non-focusing I’m just on the build process when people thought That what you needed to do to build software better was to have better processes and tools if you have the right tools.</p>

<p>And if you have the right processes it wouldn’t matter who was executed. You could have any monkey write the software and it would come out exactly the same.</p>

<p>Turns out that’s true.</p>

<p>So process and tools are not  enough what You need at that point it was a big step forward to say</p>

<p>hey, The people matter and how they interact with each other matters More than following some set process.</p>

<p>So that was a step forward 10 years ago</p>

<h3>
<span id="17-team-vision-and-disipline" class="fragment"></span><a href="#17-team-vision-and-disipline"><i class="fa fa-link"></i></a>17. Team vision and disipline</h3>

<p>If I look at software development as I practice it in startups though That’s not enough I need to go beyond that</p>

<p>So it would be as an individual in a team building a startup</p>

<p>I need to think not about how good a job I can do but how good a job we’re doing.</p>

<p>That means sometimes very I mean there’s some practical and sometimes unattractive implications of that sometimes.</p>

<p>If I should do less than What I believe to be the very best in order for the team to achieve more.</p>

<p>So I might know about some really cool technique for solving a problem.</p>

<p>But nobody else in the team has a PhD in that particular little area, So even though that might be the technically best way of solving the problem.</p>

<p>I need to back away from that and say hey I’m on it yes but I’m on a team, If I’m the only person who understands this part of the system.</p>

<p>Then I need to back away from everything I know so the team can achieve more.</p>

<p>I might be in a situation where I can check this scene and I don’t have to run the test. And I need to say no the way we do things here is And have the discipline to fit in to.</p>

<p>what the whole team is doing the individuals interacting have a tendency to optimise their own performance.</p>

<p>But team vision and discipline goes beyond that to talk about How are we going to make the most progress we can together.</p>

<h3>
<span id="18-working-software-over-comprehensive-documentation" class="fragment"></span><a href="#18-working-software-over-comprehensive-documentation"><i class="fa fa-link"></i></a>18. Working software over comprehensive documentation</h3>

<p>So there’s four bolts and then manifesto and go through </p>

<p>(Brigitte) so the second one is about comprehensive documentation there was a day when The story was if you had everything documented if you had everything written down Then you’ll be just fine right. </p>

<p>You would’nt have to go like Talk to people you could just open up the book and read what the software did except Always the documentation was out of date.</p>

<p>it was the best misleading.</p>

<p>And and that was about it and ten years ago he looked at that said You know, documentation is not the point working software is a big step forward.</p>

<p>So if you have a perfect documentation for frozen system solves the problem nobody has anymore</p>

<p>That’s just not as good as having some software That solves today’s problems and that was a big step forward.</p>

<p>But the problem is it only goes so far</p>

<h3>
<span id="19-validated-learning" class="fragment"></span><a href="#19-validated-learning"><i class="fa fa-link"></i></a>19. Validated learning</h3>

<p>In a startup environment, it’s not that you don’t know how to write the software nine times out of 10.</p>

<p>I mean  my hats off to somebody like a flight Caster who Clearly has some heavy duty technology behind what they do And I would frankly love to work in that environment because then I could pretend like I could ignore the Other two parts the cycle when that’ll be cool. but </p>

<p>You can’t measure progress by working software in a start up</p>

<p>you start out a startup with a list of almost impossibles </p>

<p>Used to call them the potentially fatal assumptions but that’s two negative you know you Potentially fatal assumption somebody will pay money for this you know that we can acquire customers.</p>

<p>That this will be an engaging game whatever those are all protected(pretend) almost it’s almost impossible.</p>

<p>Did somebody will pay money for a game on the web right really</p>

<p>Well if it’s only almost impossible when you have something.</p>

<p>If it’s clearly true then you don’t have anything. </p>

<p>Hey it’s always it’s always the crazy ideas that worked out</p>

<p>That is the most valuable to you start out every start up with his list of almost impossible.</p>

<p>And to succeed you need to find out Which of those really is impossible and which of them turns out With some work to be possible.</p>

<p>Working software can be part of answering those questions but it isn’t necessarily the best way to answer those questions.</p>

<p>So beyond agile software development is about creating the opportunity for learning as an organisation.</p>

<p>Not just about writing code.</p>

<h3>
<span id="20-customer-collaboration-over-contract-negotiation" class="fragment"></span><a href="#20-customer-collaboration-over-contract-negotiation"><i class="fa fa-link"></i></a>20. Customer collaboration over contract negotiation</h3>

<p>Another myth from 10 years ago that if you just have the right contract everything would be clearing goes smoothly</p>

<p>And the counterfactual is true you could go visiting team.</p>

<p>You look at their soft that that the contracted between the supplier and customer he says Game over you’re finished there’s no way that you’re going to be successful with this.</p>

<p>Just because the contract was wrong so with that point</p>

<p>It’s it’s a big step forward to say collaborating with customers is much better than trying to nail down all the details right at the beginning.</p>

<p>Yes yes that is definitely much better so </p>

<h3>
<span id="21-customer-discovery" class="fragment"></span><a href="#21-customer-discovery"><i class="fa fa-link"></i></a>21. Customer discovery</h3>

<p>Now you’re startup. you don’t have customer</p>

<p>I’d like to collaborate I want to collaborate you can hear an echo. but that’s it. what  you do If you don’t have a customer with whom to collaborate well and Steve Blank will give you chapter and verse of this and I hope I can pick up some pointers You have to go find out who your customer is. customer collaborations great if you got a customer and if you don’t you got to go find them. </p>

<p>So agile development in a startup or development in a startup, it needs to go beyond </p>

<h3>
<span id="22-responding-to-change-over-following-a-plan" class="fragment"></span><a href="#22-responding-to-change-over-following-a-plan"><i class="fa fa-link"></i></a>22. Responding to change over following a plan</h3>

<p>Just what it says in the agile manifest so there was a day 10 to 15 years ago when the myth was the way it is software project is made a plan.</p>

<p>Plan to work,  work the plan right if I heard that one more time from project manager.</p>

<p>I was going to do something was a glass two or three felony.Depending on how annoy you got, so if if your Plan the work  with the plan and you realise now this Things change too much. then responding to change is a big step forward.</p>

<p>To say no it’s it’s not enough to follow the plan because Things just change too much. reality diverges from the plan Reality is the much less flexible than planned?</p>

<p>There was the one fundamental point that follows the plan thing Is that reality bends a lot less than the plan bends. </p>

<p>So saying let’s response to change our metaphor for executing the project to be responding to change </p>

<p>Well cool mean thats, it’s a big step forward</p>

<h3>
<span id="23-initiating-change" class="fragment"></span><a href="#23-initiating-change"><i class="fa fa-link"></i></a>23. Initiating change</h3>

<p>Now you’re in a startup nothings changing yet </p>

<p>Because nothings moving. you have to establish Momentum first. development in a startup</p>

<p>Requires initiating change not just responding to it</p>

<p>Now this is where my anti-responsibility hackles start going up you know where I basically I don’t want to be responsible</p>

<p>I know it’s have to but I don’t like it and I’m like oh it’s up to me.</p>

<p>To initiate change that because if you don’t initiate change the startup, you don’t have anything.</p>

<p>Not even moving. the military has this is great concept of  being the initiative</p>

<p>One side has the initiative in any given engagement that’s the people who are acting in the other person’s reacting.</p>

<p>And there are military leaders through history who’s been very good at seizing the initiative </p>

<p>So you know you you only got, you know, you 300 people but you don’t wait for the other guy to come in Smack you take the initiative because when you have the initiative you got a whole bunch of advantages yes you’re exposed</p>

<p>But the other guy if you can make sure the other guy is busy </p>

<p>Worrying about what you’re going to do he doesn’t have time to think about what he’s can do to you </p>

<h3>
<span id="24-the-civil-war-1" class="fragment"></span><a href="#24-the-civil-war-1"><i class="fa fa-link"></i></a>24. the Civil War</h3>

<p>This happen late in the Civil War when Grant went to the <br>
 To the armies the east and a reporter asked him well you know<br>
 What what do you think Roberty Lee is going to do next and Grant said I don’t I don’t care what Lee is going to do next I’m going to make him worry about what I’m going to do next.</p>

<p>And that was the point that the that the Civil War turn around.</p>

<h3>
<span id="25-beyond-the-agile-manifesto" class="fragment"></span><a href="#25-beyond-the-agile-manifesto"><i class="fa fa-link"></i></a>25. beyond the agile manifesto</h3>

<p>So that for me is beyond agile development in the startups Team vision in discipline looking at the whole.</p>

<p>Process and not just what one not maximising one person’s output.</p>

<p>Focusing on learning instead of producing software.</p>

<p>So it starts with the need in move backwards discovering customers.</p>

<p>And this change initiation process instead of Waiting for the change that happen them and then responding.</p>

<p>I don’t know how many minutes that means have left. It’s ok.</p>

<h3>
<span id="26-the-principle-of-pull" class="fragment"></span><a href="#26-the-principle-of-pull"><i class="fa fa-link"></i></a>26. the principle of pull</h3>

<p>So the I told you I was going to talk about this the second principle so the first principle was the principle of pull.</p>

<p>That is start with Build you start with learning that you want to have an work backwards to the building you need.</p>

<h3>
<span id="27-the-principle-of-flow" class="fragment"></span><a href="#27-the-principle-of-flow"><i class="fa fa-link"></i></a>27. the principle of flow</h3>

<p>And the second principle is a principle of flow principle of flow says If you have all other things be equal Two deliveries half-and-half is more valuable than one delivery of the whole thing.</p>

<p>And I was talking to a guy in the Norway the other day, Senior guy in a big consulting company and he was telling me his start up strategy.</p>

<p>What is the builder really finally polished product so nobody could possibly complain about it. You know you spend a year and you make something that’s really good and send it out.</p>

<p>And I said well so sometimes when you do that you get the message back.</p>

<p>Nobody wants to buy this. oh yeah happens.</p>

<p>So could you build half the product and got an question answered Yeah sure when you been so polished okay how about you know.</p>

<p>Three months. that’s the principle of flow at work I’m trying to think.</p>

<p>How can we shorten the time through entire cycle.</p>

<h3>
<span id="28-payment-gateway" class="fragment"></span><a href="#28-payment-gateway"><i class="fa fa-link"></i></a>28. Payment gateway</h3>

<p>As came up the other day with respect to the game. so my wife is tired of me writing programs don’t make any money so one of my Really you can ask her. so so one of the things I want to validate early in this (price) of  this game is </p>

<p>Can I make money. so the game has likes a couple of natural parts of divides into two parts And I thought okay so you do the first part.</p>

<p>And you get addicted to the game right that’s how it’s supposed to work And then there’s a button that pit uses I’ll pay to use the second part And I was talking to reengineer is working with on this and he said okay so we have to set up the payment gateway and …</p>

<p>And I thought how could we slice this finer to me this is the engineering game of start up engineering is Taking tasks that seem monolithic cutting them into little pieces of rearranging pieces.</p>

<p>It’s a cool puzzle to solve by the time you’ve gone through learn and measure and you get the build that’s the point<br>
All of my engineering synapses are firing I’m thinking how can we slice up so I thought Okay here’s my cool idea now in this room this is unlikely to be remarkable but I’m proud of myself so I’m just telling you.</p>

<p>That is I thought how can we do this without having to set up the payment gateway …He said So how about if we write the first boad has the game we put the buy button And when you present buy, it just opens up the second half of the game but sends us a message.</p>

<p>So we know whether anybody’s going to press the buy button is right now we don’t know if anybody’s going to press the buy button.</p>

<p>but everybody press the buy button and we just get the second half of the game for free.</p>

<p>This is whereas wonderful not having customers, so what I love not having customers because when I make mistakes like oh not implementing the payment gateway is not a big deal.</p>

<p>If I had 1 million customers and I didn’t implement the payment gateway, I’ll be stuffed.</p>

<p>But I just want to find out if anybody’s going to press the buy button.</p>

<h3>
<span id="29-thnk-about-whole-loop" class="fragment"></span><a href="#29-thnk-about-whole-loop"><i class="fa fa-link"></i></a>29. thnk about whole loop</h3>

<p>As a developer in a startup, I have to be thinking about that whole loop.</p>

<p>And that’s really what’s different it is not how can I do Of the best software development it’s how can I Tightened the learn measure building loop as fast as possible.</p>

<p>Make it shortest as possible and extract the maximum possible value added each cycle through that loop.</p>

<p>I should do the engineering that achieves that Well sometimes that’s going to look like  Mockups wanting not me software at all. you know I got an index card some sharpies I don’t like this.</p>

<p>Now, I just saved 18 hours.<br>
Am I good engineer? Yeah.</p>

<p>I want to impress my other engineer friends but they got their own startup  problem.</p>

<h3>
<span id="30-good-startup-engineering" class="fragment"></span><a href="#30-good-startup-engineering"><i class="fa fa-link"></i></a>30. Good startup engineering</h3>

<p>That’s okay so sometimes it’s going to look like hackery.</p>

<p>Base awful hackery. yeah we just copy this files of changing two lines.</p>

<p>Is anybody going to our people gonna to play the game is  more like this and like that Well we could carefully retractor ….</p>

<p>Well I might feel good but it feels good to do good engineering But that’s not  good start up engineering. not if there’s a cheaper way.</p>

<p>To get through that loop that doesn’t mean that always in startup you just hack hack hack and so you ever do.</p>

<h3>
<span id="31-switch-modes" class="fragment"></span><a href="#31-switch-modes"><i class="fa fa-link"></i></a>31. Switch modes</h3>

<p>What happens when you hit it ,when you hits scaling.<br>
You got to switch modes from the cycle you’re going through isn’t can I attract customers.</p>

<p>But that’s not the learning you’re trying to to create it’s like that that learning you’re trying to create is<br>
Is there any way we can handle twice as many customers that’s the learning you need at that point whole boy you need.</p>

<p>Test driven development oh boy do you need automation and re-factoring and responsive design and being able to make your changes in parallel without disrupting stuff.</p>

<p>And at some point when you’re saying when the learning is can we make more money from our current revenue stream.</p>

<p>Then engineering shifts yet again to to being absolutely throughput oriented how can you reduce the cost of engineering team.</p>

<p>How can you reduce the operational costs.<br>
And it’s something else yet again.</p>

<p>To be an engineer good engineering in a start up.</p>

<p>Go through all those phases and notices the need to switch Making those transition seems to be really really hard I say that because I have trouble making this transition.</p>

<p>To see a number of other people to do also so can you realise it for a while the engineering team builds features faster and faster.</p>

<h3>
<span id="32-we-can-build-the-future-twice-as-fast-this-week-as-we-did-last" class="fragment"></span><a href="#32-we-can-build-the-future-twice-as-fast-this-week-as-we-did-last"><i class="fa fa-link"></i></a>32. We can build the future twice as fast this week as we did last</h3>

<p>And he feel Good. we can build the future twice as fast this week as we did last cool. that’s pretty cool.</p>

<p>When you hit scaling when you’re optimal engineering strategies probably removing features.</p>

<p>And carefully tuning the feature instead remain all of a sudden the value system has to change </p>

<p>Right how you kept score has to change and making those transitions seems to be Very difficult because there’s much cultural as they are is there technical.</p>

<h3>
<span id="33-conclusion" class="fragment"></span><a href="#33-conclusion"><i class="fa fa-link"></i></a>33. Conclusion</h3>

<p>But the goal of building in the lean start up Is minimising the time through the loop and maximising the value that is extracted from us.</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>TsuyoshiUshio@githubさんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>302</kbd>
		<a target="_blank" href="https://qiita.com/TsuyoshiUshio@github/items/e3902d33e3867368e695">Varnishに関していろいろ調べて試してみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-11 16:08:55</center>
	</td>
	<td style="width:200px;">
		@TsuyoshiUshio@github<br />(Simplearchitect 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Varnish]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="1-varnishとは" class="fragment"></span><a href="#1-varnish%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>1. Varnishとは</h2>

<p>Varnishはリバースプロキシを提供するためのミドルウェアである。Varnishを導入することで、Readが多いアプリケーションサーバーの前に設置することで、レスポンスの向上や、アプリケーションサーバーの負荷軽減が見込まれる。また、キャッシュの破棄等も明確に設定できるのが嬉しい。</p>

<p><a href="https://www.varnish-cache.org" rel="nofollow noopener" target="_blank">Varnish</a></p>

<h2>
<span id="2varnishサーバーの構築" class="fragment"></span><a href="#2varnish%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E6%A7%8B%E7%AF%89"><i class="fa fa-link"></i></a>2.Varnishサーバーの構築</h2>

<h3>
<span id="21varnishのインストール" class="fragment"></span><a href="#21varnish%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>2.1.Varnishのインストール</h3>

<p>CentOS系のAmazonLinuxを使ってVanish環境を構築してみる</p>

<p>Red Hat Enterprise Linux 6.4 - ami-5769f956 (64-bit) / ami-bb68f8ba (32-bit)<br>
Red Hat Enterprise Linux version 6.4, EBS-boot.</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo rpm --nosignature -i http://repo.varnish-cache.org/redhat/varnish-3.0/el6/noarch/varnish-release/varnish-release-3.0-1.el6.noarch.rpm

$ sudo yum install varnish
</pre></div></div>

<p><a href="https://www.varnish-cache.org/installation/redhat" rel="nofollow noopener" target="_blank">Varnishインストール手順</a></p>

<h3>
<span id="22転送先ホストの設定" class="fragment"></span><a href="#22%E8%BB%A2%E9%80%81%E5%85%88%E3%83%9B%E3%82%B9%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>2.2.転送先ホストの設定</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo vim /etc/varnish/default.vcl
</pre></div></div>

<p>転送先を例えばyahooに設定してみた例は次の通り</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>backend default {
  .host = "www.yahoo.co.jp";
  .port = "80";
}
</pre></div></div>

<h3>
<span id="23varnishのポートの設定" class="fragment"></span><a href="#23varnish%E3%81%AE%E3%83%9D%E3%83%BC%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>2.3.Varnishのポートの設定</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo vim /etc/sysconfig/varnish
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>VARNISH_LISTEN_PORT=80
</pre></div></div>

<h3>
<span id="24サービスの起動" class="fragment"></span><a href="#24%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E8%B5%B7%E5%8B%95"><i class="fa fa-link"></i></a>2.4.サービスの起動</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo service varnish start
</pre></div></div>

<p>ちなみに、AmazonEC2のRedHatの場合、セキュリティグループを設定しても、自前でiptablesを設定する必要がある</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl http://localhost:80 (Webブラウザからはアクセス不可だが、サーバー内から可能)
$ sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT
$ sudo sudo iptables --list
$ sudo /sbin/service iptable save
</pre></div></div>

<p>これで動作する事を確認した。 </p>

<h2>
<span id="3キャッシュクリアの方法" class="fragment"></span><a href="#3%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AF%E3%83%AA%E3%82%A2%E3%81%AE%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>3.キャッシュクリアの方法</h2>

<p><a href="https://www.varnish-software.com/static/book/Cache_invalidation.html" rel="nofollow noopener" target="_blank">Cash Invalidation</a></p>

<p>Varnishのキャッシュをクリアする方法は次の4つがある</p>

<ul>
<li>ttlの設定時限設定</li>
<li>purge オブジェクト１つに対するキャッシュクリア</li>
<li>ban 正規表現を使ったキャッシュクリアの予約(SmartBan)</li>
<li>set req_hash_always_miss = true あるURLに対するキャッシュのクリア</li>
</ul>

<p>今回の実験では、キャッシュミスの方法、SmartBan(Banの正規表現)、ttlの時限設定を試してみた。</p>

<p>結論としては、一括でキャッシュをクリアできるのは、SmartBanのみであり、実施するとすればそれになる。それ以外の可能性だと、ttlの時限設定も良い。元々Varnishのデフォルトでは、キャッシュがクリアされるのが2分の時限設定がもうけられている。2分のタイムラグが許容されるなら、方式がカンタンになるのでよいと思われる。</p>

<h3>
<span id="31キャッシュミスの設定" class="fragment"></span><a href="#31%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%83%9F%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>3.1.キャッシュミスの設定</h3>

<p>最初にテストした方式は、キャッシュされているオブジェクトをその場でキャッシュクリアする方法である。ただし、この方法では、URLで指定したオブジェクトしか、キャッシュミスにすることができない。</p>

<p>/etc/varnish/default.vcl</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>backend default {
.host = "127.0.0.1";
.port = "80";
}


acl backend_apps { "127.0.0.1";}

sub vcl_recv {
   if (client.ip ~ backend_apps &amp;&amp; req.http.X-REFRESH) {
     set req.hash_always_miss = true;
   }
}

</pre></div></div>

<p>実行イメージ</p>

<p>※この時は、ローカルのvagrant環境に、CentOS64をぶち込んでテストしています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@vagrant-centos64 www]$ cat index.html 
hello 9
[vagrant@vagrant-centos64 www]$ cat test.html 
test 7
[vagrant@vagrant-centos64 www]$ curl http://127.0.0.1:6081
hello 8
[vagrant@vagrant-centos64 www]$ curl http://127.0.0.1:6081/test.html
test 6
[vagrant@vagrant-centos64 www]$ curl -H 'X-REFRESH: DOIT' http://127.0.0.1:6081/
hello 9
[vagrant@vagrant-centos64 www]$ curl http://127.0.0.1:6081
hello 9
[vagrant@vagrant-centos64 www]$ curl http://127.0.0.1:6081/test.html
test 6
[vagrant@vagrant-centos64 www]$ curl -H 'X-REFRESH: DOIT' http://127.0.0.1:6081/test.html
test 7
[vagrant@vagrant-centos64 www]$ curl http://127.0.0.1:6081
hello 9
[vagrant@vagrant-centos64 www]$ curl http://127.0.0.1:6081/test.html
test 7
</pre></div></div>

<p>この方式では今回の要求（サブディレクトリの下を一括してキャッシュクリア）を満たせない。対象の数が少ない場合はこれでもいいかもしれない</p>

<h3>
<span id="32smartban方式" class="fragment"></span><a href="#32smartban%E6%96%B9%E5%BC%8F"><i class="fa fa-link"></i></a>3.2.SmartBan方式</h3>

<p>通常のBANや、Purge、キャッシュミスの方式は、ある特定のオブジェクトに対応するため、一括でキャッシュをクリアしたい用途には向いていない。そのような場合は、Smart Banを用いるのが良い</p>

<p>BANの方式はキャッシュをすぐにクリアするのではなく、対象のキャッシュをBANにしておき、次にそのURLがリクエストされた際に、バックエンドのサーバーに読みにいくといった挙動をする。</p>

<h4>
<span id="321-smartbanの設定とテスト" class="fragment"></span><a href="#321-smartban%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>3.2.1. SmartBanの設定とテスト</h4>

<p>次のファイルをApacheのwwwルートに配置する。そのファイルを取得した後に、キャッシュがかかっているのを確認したのち、キャッシュを破棄するコマンドをhttpで発行する</p>

<p>次のシェルで４つのファイルの取得をVarnishに依頼している</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>#!/bin/bash
curl http://127.0.0.1:6081/index.html
curl http://127.0.0.1:6081/test.html
curl http://127.0.0.1:6081/sub/1.html
curl http://127.0.0.1:6081/sub/2.html
</pre></div></div>

<p>最初に、リクエストを送った後に、ファイルをの中身を書き換えるが、キャッシュされて、新しいものに反映されない（これは期待通りの動作）</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.6
test.html
ver 1.6
1.html
ver 1.6
2.html
ver 1.6
[vagrant@vagrant-centos64 www]$ sudo vi index.html 
[vagrant@vagrant-centos64 www]$ sudo vi test.html 
[vagrant@vagrant-centos64 www]$ sudo vi sub/1.html 
[vagrant@vagrant-centos64 www]$ sudo vi sub/2.html 
[vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.6
test.html
ver 1.6
1.html
ver 1.6
2.html
ver 1.6
[vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.6
test.html
ver 1.6
1.html
ver 1.6
2.html
ver 1.6

</pre></div></div>

<p>varnishの設定ファイルには次のように記述されている。これは、BANというMethodのリクエストが送られてきた時に、/subディレクトリ以下の全てのhtmlと、/test.htmlのキャッシュをbanに入れる、つまり次回アクセスされたときに、バックエンドに取得するような設定になっている。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ cat /etc/varnish/default.vcl

backend default {
.host = "127.0.0.1";
.port = "80";
}


sub vcl_recv {
if (req.request == "BAN") {
  ban("req.url ~ ^/sub/.*.html");
  ban("req.url ~ ^/test.html");
  error 200 "Banned.";
}

}

</pre></div></div>

<h4>
<span id="322キャッシュの破棄のコマンド" class="fragment"></span><a href="#322%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E7%A0%B4%E6%A3%84%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89"><i class="fa fa-link"></i></a>3.2.2.キャッシュの破棄のコマンド</h4>

<p>キャッシュの廃棄はdefault.vclの書き方次第だが、上記の書き方の場合、次のコマンドで、キャッシュが破棄される。（注：refresh.htmlは何でも良い）尚、banに関しては後で述べるvarnishadmで発行することも可能</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl -X BAN http://127.0.0.1:6081/refresh.html
</pre></div></div>

<h4>
<span id="323キャッシュ破棄の確認" class="fragment"></span><a href="#323%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E7%A0%B4%E6%A3%84%E3%81%AE%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>3.2.3.キャッシュ破棄の確認</h4>

<p>その後、アクセスすると、無事キャッシュが破棄されて、内容が反映される</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@vagrant-centos64 www]$ curl -X BAN http://127.0.0.1:6081/refresh.html

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;200 Banned.&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Error 200 Banned.&lt;/h1&gt;
    &lt;p&gt;Banned.&lt;/p&gt;
    &lt;h3&gt;Guru Meditation:&lt;/h3&gt;
    &lt;p&gt;XID: 666764559&lt;/p&gt;
    &lt;hr&gt;
    &lt;p&gt;Varnish cache server&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;

</pre></div></div>

<p>この様子は、varnishadmコマンドを実行していると、バックエンドのサーバーにBanが設定されているのが確認できる。（説明書には、varnishadminは、varnishdに-Tを設定しないとダメと書いてあったが、実際はデフォルトで使えた）</p>

<p>最初はbanのリストを表示しても、何も表示されない</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo varnishadm  
varnish&gt; ban.list
200        
Present bans:
</pre></div></div>

<p>curlでコマンドを送ると次のようになる</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>varnish&gt; ban.list
200        
Present bans:
1394437574.186510     0     req.url ~ ^/test.html
1394437574.186499     0     req.url ~ ^/sub/.*.html
</pre></div></div>

<p>実際にシェルで確認すると、ファイルの中身が最新になっていることが確認できた</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.7
test.html
ver 1.7
1.html
ver 1.7
2.html
ver 1.7
</pre></div></div>

<h3>
<span id="33キャッシュオブジェクトのタイムアウト" class="fragment"></span><a href="#33%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88"><i class="fa fa-link"></i></a>3.3.キャッシュオブジェクトのタイムアウト</h3>

<p>キャッシュミスを設定する方法、SmartBanを設定する方法を解説したが、その他にも、キャッシュしたオブジェクトのタイムアウトを設定する方法がある。Varnishのデフォルトのタイムアウトは、120秒なので、それを利用して、キャッシュのタイムアウトが有効である事を確認する。</p>

<h4>
<span id="331デフォルトタイムアウトの挙動" class="fragment"></span><a href="#331%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E3%81%AE%E6%8C%99%E5%8B%95"><i class="fa fa-link"></i></a>3.3.1.デフォルトタイムアウトの挙動</h4>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@vagrant-centos64 www]$ date
Mon Mar 10 09:07:11 UTC 2014
vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.7
test.html
ver 1.7
1.html
ver 1.7
2.html
ver 1.7
[vagrant@vagrant-centos64 www]$ sudo vi index.html 
[vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.7
test.html
ver 1.7
1.html
ver 1.7
2.html
ver 1.7
</pre></div></div>

<p>途中で、ファイルを更新しているのだが、キャッシュヒットして、反映されない。２分待ってみる。何もしなくても、キャッシュが破棄されている。キャッシュのタイムアウトは別途設定可能である。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.8
test.html
ver 1.7
1.html
ver 1.7
2.html
ver 1.7
[vagrant@vagrant-centos64 www]$ date
Mon Mar 10 09:10:02 UTC 2014

</pre></div></div>

<h4>
<span id="332ttlのデフォルト値の変更" class="fragment"></span><a href="#332ttl%E3%81%AE%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fa fa-link"></i></a>3.3.2.ttlのデフォルト値の変更</h4>

<p>キャッシュのデフォルト値の変更は、/etc/sysconfig/varnishの次の項目を設定すれば変更できる。実際にテストしてみたが、ちゃんと動作した。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># Default TTL used when the backend does not specify one
VARNISH_TTL=120
</pre></div></div>

<p>下の例では、VARNISH_TTLを300(5分)に設定し、元々のデフォルトの2分ではキャッシュクリアされていないが、5分後にはキャッシュがクリアされている事を確認できる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@vagrant-centos64 www]$ ./request.sh
index.html
ver 1.8
test.html
ver 1.7
1.html
ver 1.7
2.html
ver 1.7
[vagrant@vagrant-centos64 www]$ date
Tue Mar 11 03:51:59 UTC 2014
[vagrant@vagrant-centos64 www]$ sudo vi index.html 
[vagrant@vagrant-centos64 www]$ sudo vi test.html 
[vagrant@vagrant-centos64 www]$ sudo vi sub/1.html 
[vagrant@vagrant-centos64 www]$ sudo vi sub/2.html 
[vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.8
test.html
ver 1.7
1.html
ver 1.7
2.html
ver 1.7
[vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.8
test.html
ver 1.7
1.html
ver 1.7
2.html
ver 1.7
[vagrant@vagrant-centos64 www]$ date
Tue Mar 11 03:54:21 UTC 2014
[vagrant@vagrant-centos64 www]$ ./request.sh 
index.html
ver 1.9
test.html
ver 1.9
1.html
ver 1.9
2.html
ver 1.9
[vagrant@vagrant-centos64 www]$ date
Tue Mar 11 03:58:52 UTC 2014
</pre></div></div>

<h4>
<span id="323キャッシュ対象によるタイムアウトの変更" class="fragment"></span><a href="#323%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E5%AF%BE%E8%B1%A1%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fa fa-link"></i></a>3.2.3.キャッシュ対象によるタイムアウトの変更</h4>

<p>また、キャッシュの時間をコンテンツによって変化させたい場合も対応できる。この場合は、default.vclに記述すればよい。</p>

<p>詳細は、<a href="https://www.varnish-software.com/static/book/VCL_Basics.html" rel="nofollow noopener" target="_blank">Varnish Book:VCL Basics</a>を参考にすればよい。例えばこんな例が載っている.次の例は,jpgファイルを強制的に60sでタイムアウトさせる例。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sub vcl_fetch {
        if (req.url ~ "\.jpg$") {
                set beresp.ttl = 60s;
        }
}
</pre></div></div>

<h3>
<span id="34-varnishlog" class="fragment"></span><a href="#34-varnishlog"><i class="fa fa-link"></i></a>3.4. varnishlog</h3>

<p>Varnishは、マネージメントインスタンスと、チャイルドインスタンスから出来ている。コマンドには、varnishadmin, varnishlog, varnish… の３つがある。varnishadminはvarnishを操作可能になる。(Banの発行も可能) varnishlogは現在のリクエストの状態を見る事ができる。どのリクエストでバックエンドに行ったかを見る事ができる</p>

<p>varnishlogの例</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@vagrant-centos64 varnish]$ varnishlog -b -o -i TxURL
   14 BackendOpen  b default 127.0.0.1 60909 127.0.0.1 80
   14 TxURL        b /sub/1.html
   14 BackendReuse b default
   14 TxURL        b /sub/2.html
   14 BackendReuse b default
   14 BackendClose b default
   14 BackendOpen  b default 127.0.0.1 60912 127.0.0.1 80
   14 TxURL        b /index.html
   14 BackendReuse b default
   14 TxURL        b /test.html
   14 BackendReuse b default
   14 TxURL        b /sub/1.html
   14 BackendReuse b default
   14 TxURL        b /sub/2.html
   14 BackendReuse b default
   14 BackendClose b default
   14 BackendOpen  b default 127.0.0.1 60936 127.0.0.1 80
   14 TxURL        b /sub/1.html
   14 BackendReuse b default
   14 TxURL        b /sub/2.html
   14 BackendReuse b default
   14 BackendClose b default
   14 BackendOpen  b default 127.0.0.1 60939 127.0.0.1 80
   14 TxURL        b /index.html
   14 BackendReuse b default
   14 TxURL        b /test.html
   14 BackendReuse b default
</pre></div></div>

<h3>
<span id="35-varnishstat" class="fragment"></span><a href="#35-varnishstat"><i class="fa fa-link"></i></a>3.5. varnishstat</h3>

<p>varnishのヘルスチェックができるvarnishstatは下記の通り。詳細の見方はGettingStaredの記事を参照。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo varnishstat

0+01:54:13
Hitrate ratio:        6        6        6
Hitrate avg:     0.7500   0.7500   0.7500

          36         0.00         0.01 client_conn - Client connections accepted
          36         0.00         0.01 client_req - Client requests received
          24         0.00         0.00 cache_hit - Cache hits
          12         0.00         0.00 cache_miss - Cache misses
           3         0.00         0.00 backend_conn - Backend conn. success
           9         0.00         0.00 backend_reuse - Backend conn. reuses
           2         0.00         0.00 backend_toolate - Backend conn. was closed
          12         0.00         0.00 backend_recycle - Backend conn. recycles
          12         0.00         0.00 fetch_length - Fetch with Length
          10          .            .   n_sess_mem - N struct sess_mem
           4          .            .   n_object - N struct object
           6          .            .   n_objectcore - N struct objectcore
           6          .            .   n_objecthead - N struct objecthead

</pre></div></div>

<h2>
<span id="4設計のtipsとアーキテクチャ" class="fragment"></span><a href="#4%E8%A8%AD%E8%A8%88%E3%81%AEtips%E3%81%A8%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3"><i class="fa fa-link"></i></a>4.設計のTipsとアーキテクチャ</h2>

<h3>
<span id="41varnishのアーキテクチャ" class="fragment"></span><a href="#41varnish%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3"><i class="fa fa-link"></i></a>4.1.Varnishのアーキテクチャ</h3>

<h3>
<span id="411varnishとプロセス" class="fragment"></span><a href="#411varnish%E3%81%A8%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9"><i class="fa fa-link"></i></a>4.1.1.Varnishとプロセス</h3>

<p>Varnishは大きくわけると、Managementプロセスと、Child/cacheプロセスに分かれる。Child/cacheプロセスがキャッシュを行い、Managementプロセスがそれを管理する。varnishadmコマンドで管理コマンドを発行できる。反映は、Varnishを再起動する事無く行える。（尚、varnishadmはリモートからでも操作できるように設定可能）</p>

<p>アーキテクチャの図は次のURLのProcess Architectureの項を参考にすると良い</p>

<p><a href="https://www.varnish-software.com/static/book/Tuning.html" rel="nofollow noopener" target="_blank">Tuning The Varnish Book</a></p>

<h3>
<span id="411vclvarnish-configuration-language" class="fragment"></span><a href="#411vclvarnish-configuration-language"><i class="fa fa-link"></i></a>4.1.1.VCL(Varnish Configuration Language)</h3>

<p>Varnishは、VCL(Varnish Configuration Language)というステートマシンがあり、それがコンセプトの中心になっている。それを操作するのは、defalt.vclだったりvarnishadmだったりする。</p>

<p>次のフロー(VCL request flow)を参考にするとよい</p>

<p><a href="https://www.varnish-software.com/static/book/VCL_Basics.html" rel="nofollow noopener" target="_blank">VCL Basics - The Varnish Book</a></p>

<p>このURLを参考にすると、default.vclの書き方は全て理解できる。基本的なラインとしては、リクエストされると、vcl_recvの状態に遷移する。例えば次のvcl_recvと比較してみよう。次のvcl_recvはVarnishのデフォルト実装である。上のURLの状態がメソッド名(vcl_recv)等で、return句で返却しているのが、次の状態(pipe/pass/lookup)である。returnで返すのは-1等の値ではなく、次の状態への状態遷移を記述する。</p>

<p>ループは書けないが、if文を書く事ができる。ifの中身は、次のような比較や正規表現もサポートされている<br>
このif文の分岐によって、クライアントから送られてきたHTTPヘッダ、デバイス種類、Methodを用いで分岐し、キャッシュをさけたり、キャッシュのタイムアウトを調整したり、BANにしたり等の様々の操作を行うことができる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sub vcl_recv {
    if (req.restarts == 0) {
        if (req.http.x-forwarded-for) {
            set req.http.X-Forwarded-For =
                req.http.X-Forwarded-For + ", " + client.ip;
        } else {
            set req.http.X-Forwarded-For = client.ip;
        }
    }
    if (req.request != "GET" &amp;&amp;
      req.request != "HEAD" &amp;&amp;
      req.request != "PUT" &amp;&amp;
      req.request != "POST" &amp;&amp;
      req.request != "TRACE" &amp;&amp;
      req.request != "OPTIONS" &amp;&amp;
      req.request != "DELETE") {
        /* Non-RFC2616 or CONNECT which is weird. */
        return (pipe);
    }
    if (req.request != "GET" &amp;&amp; req.request != "HEAD") {
        /* We only deal with GET and HEAD by default */
        return (pass);
    }
    if (req.http.Authorization || req.http.Cookie) {
        /* Not cacheable by default */
        return (pass);
    }
    return (lookup);
}
</pre></div></div>

<h3>
<span id="413-vclで使えるfunction" class="fragment"></span><a href="#413-vcl%E3%81%A7%E4%BD%BF%E3%81%88%E3%82%8Bfunction"><i class="fa fa-link"></i></a>4.1.3. VCLで使えるfunction</h3>

<p>VCLで使えるfunctionは次の通り</p>

<ul>
<li>regsub(str, regex, sub)</li>
<li>regsuball(str, regex, sub)</li>
<li>ban_url(regex)</li>
<li>ban(expression)</li>
<li>purge;</li>
<li>return(restart)</li>
<li>return()</li>
<li>hash_data()</li>
</ul>

<p>regsub/regsuballがURLの書き換え系、ban_url, ban, purgeがキャッシュのクリア系, return 次の状態遷移の為のfuntion. hash_dataはhash inputに文字を足す為のもの.</p>

<p>次のURLは、VCLのリファレンス</p>

<p><a href="https://www.varnish-cache.org/docs/trunk/reference/vcl.html" rel="nofollow noopener" target="_blank">VCL</a></p>

<h3>
<span id="42-サイジング" class="fragment"></span><a href="#42-%E3%82%B5%E3%82%A4%E3%82%B8%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>4.2. サイジング</h3>

<p>Varnishのサイジングとしては、キャッシュするオブジェクトにそれぞれ1kbのオーバーヘッドがかかる。例えば1,000,000オブジェクトあるとすると、1GBのメモリが必要になる。それ以外に100MB程度のメモリを消費する詳細は同じく次のURLに</p>

<p><a href="https://www.varnish-software.com/static/book/Tuning.html" rel="nofollow noopener" target="_blank">Tuning The Varnish Book</a></p>

<p>ちなみに上記のURLには、スレッド数等の他のパラメータも掲載されている。</p>

<h3>
<span id="43-ログについて" class="fragment"></span><a href="#43-%E3%83%AD%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>4.3. ログについて</h3>

<p>ログファイルはデフォルトでは書かれない。これは、ログのサイズがすぐふくれあがってしまうため。<br>
次のURLのLog dataを参照</p>

<p><a href="https://www.varnish-software.com/static/book/Getting_started.html" rel="nofollow noopener" target="_blank">Getting started - The Varnish Book</a></p>

<h2>
<span id="5参考資料" class="fragment"></span><a href="#5%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99"><i class="fa fa-link"></i></a>5.参考資料</h2>

<p>Varnish Bookというリソースが特に良いが、他の物も記述する</p>

<h3>
<span id="51キャッシュの無効化の記事" class="fragment"></span><a href="#51%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E7%84%A1%E5%8A%B9%E5%8C%96%E3%81%AE%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>5.1.キャッシュの無効化の記事</h3>

<p>これは一番詳しい記述<br>
<a href="https://www.varnish-software.com/static/book/Cache_invalidation.html" rel="nofollow noopener" target="_blank">Varnish Book: Cache invalidation</a></p>

<p>公式資料 <a href="https://www.varnish-cache.org/docs/3.0/tutorial/purging.html" rel="nofollow noopener" target="_blank">Purging and banning</a></p>

<p><a href="https://www.varnish-software.com/blog/bans-and-purges-varnish-30" rel="nofollow noopener" target="_blank">Bans and purges in Varnish</a></p>

<p>curlのオプション解説</p>

<p><a href="http://curl.haxx.se/docs/manpage.html" rel="nofollow noopener" target="_blank">curl the man page</a></p>

<h3>
<span id="52varnishの全体像" class="fragment"></span><a href="#52varnish%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F"><i class="fa fa-link"></i></a>5.2.Varnishの全体像</h3>

<p>一番まとまっているGetting Startedこれを見れば全貌がわかる。</p>

<p>◎<a href="https://www.varnish-software.com/static/book/Getting_started.html" rel="nofollow noopener" target="_blank">Getting started</a></p>

<p>Varnish Command Line Interface</p>

<p>コマンドラインインターフェイスは、varnishadmで使えるコマンド群</p>

<p>◎VCLの解説。コレを読めばdefault.vclの意味が分かる<br>
<a href="https://www.varnish-software.com/static/book/VCL_Basics.html" rel="nofollow noopener" target="_blank">Varnish Book:VCL Basics</a></p>

<p>公式資料 <a href="https://www.varnish-cache.org/docs/trunk/reference/varnish-cli.html" rel="nofollow noopener" target="_blank">Varnish CLI</a></p>

<h3>
<span id="43varnishの設定" class="fragment"></span><a href="#43varnish%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>4.3.Varnishの設定</h3>

<p>◎チューニングの決定版。アーキテクチャも説明されている<br>
<a href="https://www.varnish-software.com/static/book/Tuning.html" rel="nofollow noopener" target="_blank">Varnish Book: Tuning</a></p>

<p>公式のサイジング資料だが、上記のTuningに全て載っている<a href="https://www.varnish-cache.org/docs/3.0/tutorial/sizing_your_cache.html" rel="nofollow noopener" target="_blank">Sizing your cache</a></p>

<p>◎varnishdの公式説明でフォルト値が見れるのがポイント。全部よまなくていいけど、デフォルト値がわかるのがよい<br>
<a href="https://www.varnish-cache.org/docs/3.0/reference/varnishd.html" rel="nofollow noopener" target="_blank">varnishd</a></p>

<p>設定ファイルのサンプル<br>
<a href="https://gist.github.com/reifman/4651558" rel="nofollow noopener" target="_blank">/etc/default/varnish</a></p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
