<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (4kizuki)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (4kizuki さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>4kizukiさんの<br />1位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>199</kbd>
		<a target="_blank" href="https://qiita.com/4kizuki/items/9eddae1205dc00e9dccc">属人化を避ける</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-21 11:16:45</center>
	</td>
	<td style="width:200px;">
		@4kizuki<br><img width="80" height="80" src="https://avatars3.githubusercontent.com/u/23712113?v=3">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GitHub]</b> <b>[プログラミング]</b> <b>[環境構築]</b> <b>[プログラミング教育]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>このQiitaは、マサカリや編集リクエスト歓迎です</p>

<h1>
<span id="属人化って" class="fragment"></span><a href="#%E5%B1%9E%E4%BA%BA%E5%8C%96%E3%81%A3%E3%81%A6"><i class="fa fa-link"></i></a>属人化って？</h1>

<p>「○○さんがいないとプロジェクトが進まない！」という状況</p>

<p>例えば…</p>

<ul>
<li>ある手続きについて、マニュアルがない、仕様書もない</li>
<li>マニュアルなしで操作できるのが○○さん一人</li>
</ul>

<p>より強い表現をすれば、○○さんが任意にプロジェクトの進行を止められる状態</p>

<h1>
<span id="用語" class="fragment"></span><a href="#%E7%94%A8%E8%AA%9E"><i class="fa fa-link"></i></a>用語</h1>

<table>
<thead>
<tr>
<th>用語</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>プロジェクト</td>
<td>チーム全体で進めるもの</td>
</tr>
<tr>
<td>タスク</td>
<td>個人またはチームの一部で進めるもの</td>
</tr>
<tr>
<td>モジュール</td>
<td>プロジェクトの断片で、タスクは基本的にモジュールを作る</td>
</tr>
</tbody>
</table>

<h1>
<span id="属人化の理由" class="fragment"></span><a href="#%E5%B1%9E%E4%BA%BA%E5%8C%96%E3%81%AE%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a>属人化の理由</h1>

<h2>
<span id="個人の問題" class="fragment"></span><a href="#%E5%80%8B%E4%BA%BA%E3%81%AE%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>個人の問題</h2>

<ul>
<li>手抜きやバグを隠す<br>
たとえば、仕様書外の動作を実装し、それをプロジェクトで利用する</li>
<li>解雇されないための保険的行動</li>
</ul>

<h2>
<span id="チームの問題" class="fragment"></span><a href="#%E3%83%81%E3%83%BC%E3%83%A0%E3%81%AE%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>チームの問題</h2>

<ul>
<li>マニュアルを作る文化の欠如</li>
<li>他人のタスクに対する無関心</li>
<li>他人の監査なしにプロジェクトを更新可能</li>
</ul>

<h1>
<span id="どうやって属人化を避けるのか" class="fragment"></span><a href="#%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E5%B1%9E%E4%BA%BA%E5%8C%96%E3%82%92%E9%81%BF%E3%81%91%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>どうやって属人化を避けるのか</h1>

<h2>
<span id="間違った対策" class="fragment"></span><a href="#%E9%96%93%E9%81%95%E3%81%A3%E3%81%9F%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>間違った対策</h2>

<ul>
<li>○○さん以外にもマニュアルなしで操作できる人間を育成

<ul>
<li>育成した人が全滅すればやっぱり同じ状況</li>
<li>全員がすべてのプロジェクトに精通するとかはムリ</li>
</ul>
</li>
</ul>

<h2>
<span id="正しい対策" class="fragment"></span><a href="#%E6%AD%A3%E3%81%97%E3%81%84%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>正しい対策</h2>

<ul>
<li>モジュールごとに仕様書を用意</li>
<li>間違って使うことが難しい仕様とする

<ul>
<li>即ち、仕様書を読まなくてもある程度正確に使える</li>
</ul>
</li>
<li>お互いにコードレビューさせる</li>
</ul>

<h2>
<span id="具体的にはどうすれば良い" class="fragment"></span><a href="#%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E8%89%AF%E3%81%84"><i class="fa fa-link"></i></a>具体的にはどうすれば良い？</h2>

<h3>
<span id="テスト仕様書利用例" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E4%BB%95%E6%A7%98%E6%9B%B8%E5%88%A9%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>テスト・仕様書・利用例</h3>

<ul>
<li>テストは仕様書のベースとなる</li>
<li>仕様書を見れば、深い動作がわかるようになる</li>
<li>仕様書を読まなくても、利用例を見れば使える</li>
</ul>

<h3>
<span id="全員がテストできる環境を作る" class="fragment"></span><a href="#%E5%85%A8%E5%93%A1%E3%81%8C%E3%83%86%E3%82%B9%E3%83%88%E3%81%A7%E3%81%8D%E3%82%8B%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>全員がテストできる環境を作る</h3>

<ul>
<li>前提条件の少ないテスト

<ul>
<li>たとえば、「テストしようと思ったら、DBが初期化されてなくてテストできなかった！」を避ける</li>
<li>この時、「データベースくらい自分で初期化しろ！」ではなく、テスト内で自動的にDBやテーブルを生成させるようにする</li>
<li>一般に、テストは単体テストであるように作ること(依存性や、環境の前提条件が可能な限り少ない) (2017/10/23追記)</li>
</ul>
</li>
</ul>

<p>　</p>

<ul>
<li>モジュール化

<ul>
<li>モジュール単位でリポジトリが存在し、モジュール単位でテストが可能</li>
<li>プロジェクトの<code>Issue</code>や<code>Pull Requests</code>が混雑しなくなる</li>
<li>気楽に問題を報告できるし、問題の原因がどこにあるかを特定しやすい</li>
</ul>
</li>
</ul>

<h3>
<span id="相互にチェックしあう体制" class="fragment"></span><a href="#%E7%9B%B8%E4%BA%92%E3%81%AB%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%97%E3%81%82%E3%81%86%E4%BD%93%E5%88%B6"><i class="fa fa-link"></i></a>相互にチェックしあう体制</h3>

<ul>
<li>コードレビューのルーチンワーク化

<ul>
<li>あるモジュールをレビューする人が複数存在する環境</li>
</ul>
</li>
<li>プロジェクトやモジュールの<code>master</code>ブランチへのアクセス権を限定し、マージの際に品質チェックが入るようにする</li>
<li>このタイミングで、仕様書外の動作を弾くことができる (2017/10/23追記)</li>
</ul>

<h1>
<span id="やってはいけないこと" class="fragment"></span><a href="#%E3%82%84%E3%81%A3%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>やってはいけないこと</h1>

<ul>
<li>仕様書やマニュアルの<strong>確定</strong>

<ul>
<li>これらもしっかりとVCSで管理し、問題点を共有</li>
<li>コロコロ変わる仕様書はダメだが、全く変わらない仕様書は負の遺産を生みだす</li>
<li>仕様書も、悪いと思ったら悪いといえるようにしよう</li>
</ul>
</li>
</ul>

<p>　</p>

<ul>
<li>仕様書が大量に存在 (読むのが大変)

<ul>
<li>間違って使うことが難しいようにする</li>
<li>モジュール間でインターフェースを統一</li>
<li>利用例を充実させる</li>
</ul>
</li>
</ul>

<p>　</p>

<ul>
<li>プロを使わない

<ul>
<li>すなわち、「<strong>質問するな、調べろ</strong>」が徹底されてしまうのはよくない</li>
<li>属人化の排除を行う目的は、「<strong>誰でも、ある程度の短時間で理解ができる</strong>」状況を作ること</li>
<li>ある程度調べて分からなければ、やはりその道のプロに聞くべき</li>
</ul>
</li>
</ul>

<h1>
<span id="こっちも読んでね" class="fragment"></span><a href="#%E3%81%93%E3%81%A3%E3%81%A1%E3%82%82%E8%AA%AD%E3%82%93%E3%81%A7%E3%81%AD"><i class="fa fa-link"></i></a>こっちも読んでね</h1>

<p><a href="https://qiita.com/4kizuki/items/3b60443ccd473d192c21" id="reference-40bd590782e0690eb69b">続・属人化を避ける</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>4kizukiさんの<br />2位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>44</kbd>
		<a target="_blank" href="https://qiita.com/4kizuki/items/3b60443ccd473d192c21">続・属人化を避ける</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-23 13:48:26</center>
	</td>
	<td style="width:200px;">
		@4kizuki<br><img width="80" height="80" src="https://avatars3.githubusercontent.com/u/23712113?v=3">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GitHub]</b> <b>[プログラミング]</b> <b>[環境構築]</b> <b>[プログラミング教育]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>このQiitaは、マサカリや編集リクエスト歓迎です。まだドラフトチックなので、不適切な表現などあるかもしれませんが、よろしくお願いします。</p>

<p>前回書いた<a href="https://qiita.com/4kizuki/items/9eddae1205dc00e9dccc" id="reference-359c061c4b1c82ffe705">Qiita: 属人化を避ける</a>の反響が大きかったので、各種コメントへの返信を兼ねて、いろいろ書きます</p>

<h1>
<span id="だいじなこと" class="fragment"></span><a href="#%E3%81%A0%E3%81%84%E3%81%98%E3%81%AA%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>だいじなこと</h1>

<h2>
<span id="アイデアを出すこととコードを書くことは別" class="fragment"></span><a href="#%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2%E3%82%92%E5%87%BA%E3%81%99%E3%81%93%E3%81%A8%E3%81%A8%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8F%E3%81%93%E3%81%A8%E3%81%AF%E5%88%A5"><i class="fa fa-link"></i></a>「アイデアを出すこと」と「コードを書くこと」は別</h2>

<p>コードを書く際は、必ず属人化を避けるべきです。一方で、アイデアを出す際は、これは属人化というより個人の才能に依ります。いわゆる、スティーブジョブズのようなカリスマは、この「アイデアを出すこと」に特化した人物です</p>

<p>この、「アイデアを出すこと」が脱属人化によって取り締まられてしまうのだけは絶対に避ける必要があります</p>

<h2>
<span id="アイデアマンとコーダーの分離" class="fragment"></span><a href="#%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2%E3%83%9E%E3%83%B3%E3%81%A8%E3%82%B3%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AE%E5%88%86%E9%9B%A2"><i class="fa fa-link"></i></a>アイデアマンとコーダーの分離</h2>

<p>一般に、アイデアに優れたメンバーがいた場合(Aさんとします)、Aさんはコーディングよりアイデアを出すことに集中すべきです。このとき、Aさんの仕事は利用例や仕様書の概要を組み立てることです。一方、この利用例や仕様書の概要をもとにプログラムを作成する際、Aさんはアイデアを出すことに集中しているので、主にほかの人が担当することになります。このとき、<strong>コードを書く人が</strong>先の属人化を避けるためのプロセスを実行するべきといえるでしょう</p>

<p>もちろん、Aさんはアイデアだけ、BさんはAさんのアイデアを実現するだけ、という風に完全に分離しろというわけではありませんが…</p>

<h2>
<span id="アイデアを出すことは属人化していいの" class="fragment"></span><a href="#%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2%E3%82%92%E5%87%BA%E3%81%99%E3%81%93%E3%81%A8%E3%81%AF%E5%B1%9E%E4%BA%BA%E5%8C%96%E3%81%97%E3%81%A6%E3%81%84%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>アイデアを出すことは属人化していいの？</h2>

<p><strong>はい、構いません</strong></p>

<p>アイデア生成プロセスはむしろ個人のスキルなので、このプロセスを脱属人化させてはいけません。その代わり、アイデアから生まれた製品は脱属人化を図ってください。ただし、チームとしてアイデアを出すことが仕事の場合（例えばコンサルティングファームに所属している場合など）はこの限りではありません</p>

<h1>
<span id="ではどのようにプロジェクトを回すのか" class="fragment"></span><a href="#%E3%81%A7%E3%81%AF%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E5%9B%9E%E3%81%99%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>では、どのようにプロジェクトを回すのか</h1>

<p>ここからは、理想論がある程度混ざってきますので、皆さんの環境に応じて適宜読み替えてください</p>

<h2>
<span id="1-アイデアを持ち寄る方法を設ける" class="fragment"></span><a href="#1-%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2%E3%82%92%E6%8C%81%E3%81%A1%E5%AF%84%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E8%A8%AD%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>1. アイデアを持ち寄る方法を設ける</h2>

<p>良い考えは共有されるべきです。とりあえず批判を抜きにして、個人個人が「こうするべき」と思ったことを持ち寄ります。会議を開いたり、もしくは、githubなどの<code>Project</code>機能を用いて共有します。このとき、細かい仕様書は確定させず、どのような使い方ができれば便利かを重視してください</p>

<h2>
<span id="2-利用例が定まってから仕様書を固める" class="fragment"></span><a href="#2-%E5%88%A9%E7%94%A8%E4%BE%8B%E3%81%8C%E5%AE%9A%E3%81%BE%E3%81%A3%E3%81%A6%E3%81%8B%E3%82%89%E4%BB%95%E6%A7%98%E6%9B%B8%E3%82%92%E5%9B%BA%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>2. 利用例が定まってから、仕様書を固める</h2>

<p>カリスマ的アイデアにせよ、普遍的アイデアにせよ、利用例(入力と出力の概要)をさらに精錬し、仕様書(契約プログラミングにおける、前提、普遍、事後条件を定義)とします。この段階は、メンテナンス性を高め、属人化を弾くことを意識します</p>

<p>さらに、テスト駆動開発を採用している場合は、この段階でテストコードを書きます。テストコードは「利用例」をもとに、予測される動作を網羅的に記述します</p>

<h2>
<span id="3-仕様書が固まったらそれに従うようにコードを書く" class="fragment"></span><a href="#3-%E4%BB%95%E6%A7%98%E6%9B%B8%E3%81%8C%E5%9B%BA%E3%81%BE%E3%81%A3%E3%81%9F%E3%82%89%E3%81%9D%E3%82%8C%E3%81%AB%E5%BE%93%E3%81%86%E3%82%88%E3%81%86%E3%81%AB%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>3. 仕様書が固まったら、それに従うようにコードを書く</h2>

<p>仕様書外の動作や、契約が満たされないことは言語道断ですが、そもそも仕様書通りに動かすことが難しかったりする場合は1か2に戻ります。<strong>決して、仕様書通りに動かせないからといって自分で仕様を変更してはいけません</strong></p>

<p>コードは疎結合性を守り、必ずテストを実行してください。テストが用意されていない場合は、ここでテストを書きます</p>

<h2>
<span id="4-コードが完成したら複数の他人にコードレビューをしてもらう" class="fragment"></span><a href="#4-%E3%82%B3%E3%83%BC%E3%83%89%E3%81%8C%E5%AE%8C%E6%88%90%E3%81%97%E3%81%9F%E3%82%89%E8%A4%87%E6%95%B0%E3%81%AE%E4%BB%96%E4%BA%BA%E3%81%AB%E3%82%B3%E3%83%BC%E3%83%89%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC%E3%82%92%E3%81%97%E3%81%A6%E3%82%82%E3%82%89%E3%81%86"><i class="fa fa-link"></i></a>4. コードが完成したら複数の他人にコードレビューをしてもらう</h2>

<p>このプロセスによって<strong>属人化を完全に排除</strong>します。レビュワーはコーディング規約はもちろん、疎結合性および仕様書との適合性について検証をする必要があります</p>

<p>もちろん、完成前にレビューをしてもらっても構いません</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>4kizukiさんの<br />3位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/4kizuki/items/1c89061c3531fec6580f">クラスに余計な機能を持たせないようにしよう</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-25 20:13:30</center>
	</td>
	<td style="width:200px;">
		@4kizuki<br><img width="80" height="80" src="https://avatars3.githubusercontent.com/u/23712113?v=3">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>PHPのクラスには、デフォルトで豊富な機能が付属していますが、これらの機能は、正しく使わなければバグの温床となります。よって、利用しない機能はシャットアウトするべきと考えます。</p>

<p><a href="https://github.com/4kizuki/php-bsc" rel="nofollow noopener" target="_blank">2017/09/28: githubにリポジトリを製作しました。</a></p>

<h1>
<span id="プロパティの自動追加" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%81%AE%E8%87%AA%E5%8B%95%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>プロパティの自動追加</h1>

<p>PHPでは、クラス宣言に書いていないプロパティにアクセスしようとしたとき、そのプロパティを<code>public</code>アクセス権限で作成する機能があります。</p>

<div class="code-frame" data-lang="PHP"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">MyClass</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="s1">'This is a pen.'</span><span class="p">;</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="nv">$var</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyClass</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$var</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>     <span class="c1">// This is a pen.</span>
</pre></div></div>

<p>また、標準クラスである<code>stdClass</code>は、配列として扱うことを前提として作られたクラスで、配列からオブジェクトへの変換時に自動で作られます。</p>

<div class="code-frame" data-lang="PHP"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$arr</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'This is a pen.'</span> <span class="p">];</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="nv">$arr</span><span class="p">;</span>

<span class="nb">var_dump</span><span class="p">(</span> <span class="nv">$var</span> <span class="nx">instanceof</span> <span class="k">stdClass</span> <span class="p">);</span>   <span class="c1">// true</span>

<span class="nv">$var</span><span class="o">-&gt;</span><span class="s1">'message2'</span> <span class="o">=</span> <span class="s1">'This isn\'t a pen.'</span><span class="p">;</span>

<span class="k">echo</span> <span class="nv">$var</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>     <span class="c1">// This is a pen.</span>
<span class="k">echo</span> <span class="nv">$var</span><span class="o">-&gt;</span><span class="na">message2</span><span class="p">;</span>    <span class="c1">// This isn't a pen.</span>
</pre></div></div>

<h2>
<span id="問題点" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E7%82%B9"><i class="fa fa-link"></i></a>問題点</h2>

<p>typo(打ち間違い)により、意図しない動作を引き起こします。例えば次の例を見てください。</p>

<div class="code-frame" data-lang="PHP"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">MyClass</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$message</span> <span class="o">=</span> <span class="s1">'Old Message'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>

        <span class="c1">// messageではなくmrssageに代入していますが、エラーが出ません。</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mrssage</span> <span class="o">=</span> <span class="s1">'New Message'</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">EchoMessage</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">WrongEchoMessage</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Notice:  Undefined Property</span>
        <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mtssage</span><span class="p">;</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="nv">$var</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyClass</span><span class="p">;</span>
<span class="nv">$var</span><span class="o">-&gt;</span><span class="na">EchoMessage</span><span class="p">(</span> <span class="p">);</span>       <span class="c1">// 'New Message'を期待しているのに、'Old Message'が出力されます。</span>
<span class="k">echo</span> <span class="nv">$var</span><span class="o">-&gt;</span><span class="na">mrssage</span><span class="p">;</span>         <span class="c1">// 本来見えてはいけない内部データ'New Message'が見えます。</span>
<span class="nv">$var</span><span class="o">-&gt;</span><span class="na">WrongEchoMessage</span><span class="p">(</span> <span class="p">);</span>  <span class="c1">// 'New Message'を期待しているのに、なにも出力されません。</span>
</pre></div></div>

<p>この動作の問題点は以下の３つです。</p>

<ul>
<li>書き換えが行われたはずなのに実際は書き換えが行われていません。Immutableでないクラス設計の際は、どこで書き換えが行われなかったのか(どこにtypoがあるのか)を探すのに時間がかかります。</li>
<li>本来は隠されるべきデータであるはずの<code>$message</code>に、(不正なアクセス方法ではあるが)<code>$mrssage</code>を用いることでアクセスができます(自動追加されたプロパティは<code>public</code>扱いのため)。すなわち、隠蔽が破られる恐れがあります。</li>
<li>存在しない<code>$mtssage</code>にアクセスしてもNoticeが発生するのみなので、(開発体系にもよるが)気づかない、もしくは無視される恐れがあります。</li>
</ul>

<h2>
<span id="この動作を止めるには" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E5%8B%95%E4%BD%9C%E3%82%92%E6%AD%A2%E3%82%81%E3%82%8B%E3%81%AB%E3%81%AF"><i class="fa fa-link"></i></a>この動作を止めるには</h2>

<p>マジックメソッドをオーバーロードして、クラスの動作を書き換えます。<br>
<a href="http://php.net/manual/ja/language.oop5.overloading.php#object.set" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/language.oop5.overloading.php#object.set</a><br>
マジックメソッドの中には、アクセス不可能プロパティ(アクセス権限がない、もしくは宣言されていない)へのアクセス時に自動で呼ばれるものがあります。デフォルトでは、前述したように配列として扱う動作をします。</p>

<div class="code-frame" data-lang="PHP">
<div class="code-lang"><span class="bold">アクセス不可能プロパティに係るマジックメソッド</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">public</span> <span class="nx">__set</span>   <span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span> <span class="p">,</span> <span class="nx">mixed</span> <span class="nv">$value</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span>
<span class="k">public</span> <span class="nx">__get</span>   <span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">mixed</span>
<span class="k">public</span> <span class="nx">__isset</span> <span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">bool</span>
<span class="k">public</span> <span class="nx">__unset</span> <span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span>
</pre></div>
</div>

<p>以上の4つのメソッドが、このような場合に呼ばれるメソッドです。例えば次のようにして、これらの動作をカスタマイズできます。</p>

<div class="code-frame" data-lang="PHP">
<div class="code-lang"><span class="bold">実装例</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">InaccessiblePropertyException</span> <span class="k">extends</span> <span class="nx">\LogicException</span> <span class="p">{</span> <span class="p">}</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">StrictPropertyAccess</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__get</span><span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">InaccessiblePropertyException</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__set</span><span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$v</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">InaccessiblePropertyException</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__isset</span><span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">bool</span> <span class="p">{</span>

        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__unset</span><span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">InaccessiblePropertyException</span><span class="p">;</span>

    <span class="p">}</span>

<span class="p">}</span>

</pre></div>
</div>

<h1>
<span id="シリアライズ" class="fragment"></span><a href="#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA"><i class="fa fa-link"></i></a>シリアライズ</h1>

<p>PHPには、変数の状態を文字列に変換する「シリアライズ」の機能があります。利用方法は以下の通りです。</p>

<div class="code-frame" data-lang="PHP">
<div class="code-lang"><span class="bold">save.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$arr</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'I'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'John Smith'</span><span class="p">,</span>
        <span class="s1">'age'</span>  <span class="o">=&gt;</span> <span class="mi">32</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'You'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Saburo Kato'</span><span class="p">,</span>
        <span class="s1">'age'</span>  <span class="o">=&gt;</span> <span class="mi">55</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>

<span class="nv">$s</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span> <span class="nv">$arr</span> <span class="p">);</span>
<span class="k">echo</span> <span class="nv">$s</span><span class="p">;</span>
<span class="c1">// a:2:{s:1:"I";a:2:{s:4:"name";s:10:"John Smith";s:3:"age";i:32;}s:3:"You";a:2:{s:4:"name";s:11:"Saburo Kato";s:3:"age";i:55;}}</span>

<span class="nb">file_put_contents</span><span class="p">(</span> <span class="s1">'info.phpserialized'</span><span class="p">,</span> <span class="nv">$s</span> <span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="PHP">
<div class="code-lang"><span class="bold">load.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$arr</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span> <span class="nb">file_get_contents</span><span class="p">(</span> <span class="s1">'info.phpserialized'</span> <span class="p">)</span> <span class="p">);</span>

<span class="nb">var_dump</span><span class="p">(</span> <span class="nv">$arr</span> <span class="p">);</span>
</pre></div>
</div>

<p>このように、どのような変数であっても文字列化して保存することができるため非常に便利な機能です。たとえば、PHPのセッション管理などにおいてはこの機能が利用されていますし、セッションに限らず複数ページにまたがって単一のデータを利用したい時などに重宝します。</p>

<h2>
<span id="問題点-1" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E7%82%B9-1"><i class="fa fa-link"></i></a>問題点</h2>

<p>配列や基本型についてはほぼ問題が発生しませんが、オブジェクトの予期しないシリアライズには問題がつきものです。最もわかりやすい例がリソース型です。次のようなクラス(良い設計ではありませんが)を考えましょう。</p>

<div class="code-frame" data-lang="PHP">
<div class="code-lang"><span class="bold">FileReader.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">EoFException</span> <span class="k">extends</span> <span class="nx">\RuntimeException</span> <span class="p">{</span> <span class="p">}</span>

<span class="k">class</span> <span class="nc">FileReader</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$file</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span> <span class="nx">string</span> <span class="nv">$fileName</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span> <span class="nv">$fileName</span><span class="p">,</span> <span class="s1">'r'</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nb">fclose</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">Read</span><span class="p">(</span> <span class="nx">int</span> <span class="nv">$length</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span><span class="p">(</span> <span class="nb">feof</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span> <span class="p">)</span> <span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">EoFException</span><span class="p">;</span>

        <span class="k">return</span> <span class="nb">fread</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">,</span> <span class="nv">$length</span> <span class="p">);</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<p>このクラスは、普通に使用する分には問題なく動作します。しかし、シリアライズを行った後デシリアライズを行っても、すでにファイルハンドルは無効となっています。そのため、デシリアライズ後は正常に動作しません。</p>

<p>(より正確には、resource型をシリアライズする際は、常に値が0として文字列化されてしまいます。)</p>

<h2>
<span id="この動作を正しく使うには" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E5%8B%95%E4%BD%9C%E3%82%92%E6%AD%A3%E3%81%97%E3%81%8F%E4%BD%BF%E3%81%86%E3%81%AB%E3%81%AF"><i class="fa fa-link"></i></a>この動作を正しく使うには</h2>

<p><code>Serializable</code>インターフェイスを実装するか、マジックメソッド<code>__wakeup</code>および<code>__sleep</code>をオーバーロードします。この辺りの解説はここでは行いません。</p>

<h2>
<span id="この動作を止めるには-1" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E5%8B%95%E4%BD%9C%E3%82%92%E6%AD%A2%E3%82%81%E3%82%8B%E3%81%AB%E3%81%AF-1"><i class="fa fa-link"></i></a>この動作を止めるには</h2>

<p>この動作を止めることは、すなわちクラスの保存性を損なうことになります。しかし、そもそも保存することを検討していないクラスであれば無効化してしまうのがいいでしょう。先ほどと同様に、マジックメソッドをオーバーロードして、クラスの動作を書き換えます。<br>
<a href="http://php.net/manual/ja/language.oop5.magic.php#object.sleep" class="autolink" rel="nofollow noopener" target="_blank">http://php.net/manual/ja/language.oop5.magic.php#object.sleep</a></p>

<div class="code-frame" data-lang="PHP">
<div class="code-lang"><span class="bold">シリアライズに係るマジックメソッド</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">public</span> <span class="nx">__sleep</span>  <span class="p">(</span> <span class="p">)</span> <span class="o">:</span> <span class="k">array</span>
       <span class="nx">__wakeup</span> <span class="p">(</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span>
</pre></div>
</div>

<p>以上二つのメソッドを書き換えます。例えば次のようにしてください。</p>

<div class="code-frame" data-lang="PHP">
<div class="code-lang"><span class="bold">実装例</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UnserializableException</span> <span class="k">extends</span> <span class="nx">\LogicException</span> <span class="p">{</span> <span class="p">}</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">Unserializable</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__sleep</span> <span class="p">(</span> <span class="p">)</span> <span class="o">:</span> <span class="k">array</span> <span class="p">{</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">UnserializableException</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="fm">__wakeup</span> <span class="p">(</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">UnserializableException</span><span class="p">;</span>

    <span class="p">}</span>

<span class="p">}</span>

</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>4kizukiさんの<br />4位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/4kizuki/items/6eeeacf21a157c326524">PHPで作る列挙型を改良してみました</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-26 10:48:59</center>
	</td>
	<td style="width:200px;">
		@4kizuki<br><img width="80" height="80" src="https://avatars3.githubusercontent.com/u/23712113?v=3">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>以下の記事で、PHPにて列挙型を扱う方法が記載されています。この記事にて紹介されている列挙型を改良しましたので、ご紹介します。<br>
<a href="https://qiita.com/Hiraku/items/71e385b56dcaa37629fe" class="autolink" id="reference-61ebf49a03f3373e4517">https://qiita.com/Hiraku/items/71e385b56dcaa37629fe</a></p>

<p>利用方法などについては、上記の元記事を参考にしてください。</p>

<p><a href="https://github.com/4kizuki/php-enum" rel="nofollow noopener" target="_blank">2017/09/28: githubにリポジトリを製作しました。</a></p>

<h1>
<span id="改良の概要" class="fragment"></span><a href="#%E6%94%B9%E8%89%AF%E3%81%AE%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>改良の概要</h1>

<ul>
<li>重い処理であるリフレクションを利用する回数を、クラスにつき一回に制限しました。改良元では、コンストラクタ内にて必ずリフレクションを行っていたため、パフォーマンスのボトルネックとなっていました。</li>
<li>エラー処理を厳密にしました。文字列および整数以外の列挙型を拒否し、さらに<code>__callStatic</code>において、存在しない列挙定数を指定した場合も厳格に例外を投げるようにしました。</li>
<li>PHP5を切り捨てました。PHP7に合わせ、タイプヒントを導入したため、さらに厳密になりました。</li>
</ul>

<h1>
<span id="共通基底クラスenum" class="fragment"></span><a href="#%E5%85%B1%E9%80%9A%E5%9F%BA%E5%BA%95%E3%82%AF%E3%83%A9%E3%82%B9enum"><i class="fa fa-link"></i></a>共通基底クラス<code>Enum</code>
</h1>

<p>以降で扱う<code>IntEnum</code>および<code>StringEnum</code>クラスの基底クラスですが、このクラスを継承して列挙型を作ることもできます。このクラスを基底クラスとした場合、列挙定数として整数型および文字列型のどちらも利用することができますが、たとえば<code>string(1): "1"</code>と<code>int: 1</code>のように共存しえないものもあります。列挙定数の型が一致しないことは望ましい設計とは言えないので、基本的には後述する拡張クラスを利用してください。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">Enum.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">InvalidArgumentException</span><span class="p">,</span> <span class="nx">LogicException</span><span class="p">,</span> <span class="nx">ReflectionClass</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">EnumConstantTypeException</span> <span class="k">extends</span> <span class="nx">LogicException</span> <span class="p">{</span> <span class="p">}</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">Enum</span> <span class="p">{</span>

    <span class="k">private</span> <span class="k">static</span> <span class="nv">$___constants</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>
    <span class="k">protected</span> <span class="nv">$scalar</span><span class="p">;</span>


    <span class="sd">/***************************************************************************</span>
<span class="sd">     * </span>
<span class="sd">     * 初期化に関するもの</span>
<span class="sd">     * </span>
<span class="sd">     **************************************************************************/</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span> <span class="nv">$scalar</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">self</span><span class="o">::</span><span class="na">_init</span><span class="p">(</span> <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$___constants</span><span class="p">[</span> <span class="k">static</span><span class="o">::</span><span class="na">class</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">][</span> <span class="nv">$scalar</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">scalar</span> <span class="o">=</span> <span class="nv">$scalar</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">final</span> <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="fm">__callStatic</span><span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$args</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span> <span class="nv">$args</span> <span class="p">)</span> <span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span> <span class="p">);</span>

        <span class="nx">self</span><span class="o">::</span><span class="na">_init</span><span class="p">(</span> <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$___constants</span><span class="p">[</span> <span class="k">static</span><span class="o">::</span><span class="na">class</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">][</span> <span class="nv">$name</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span> <span class="p">);</span>

        <span class="nv">$class</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">class</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">(</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$___constants</span><span class="p">[</span> <span class="k">static</span><span class="o">::</span><span class="na">class</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">][</span> <span class="nv">$name</span> <span class="p">]</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">final</span> <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_init</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$___constants</span><span class="p">[</span> <span class="k">static</span><span class="o">::</span><span class="na">class</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

            <span class="nv">$csts</span> <span class="o">=</span> <span class="p">(</span> <span class="k">new</span> <span class="nx">ReflectionClass</span><span class="p">(</span> <span class="k">static</span><span class="o">::</span><span class="na">class</span> <span class="p">)</span> <span class="p">)</span><span class="o">-&gt;</span><span class="na">getConstants</span><span class="p">(</span> <span class="p">);</span>
            <span class="nv">$vals</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>

            <span class="k">foreach</span><span class="p">(</span> <span class="nv">$csts</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span> <span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="k">static</span><span class="o">::</span><span class="na">_validate_constants</span><span class="p">(</span> <span class="nv">$value</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">EnumConstantTypeException</span><span class="p">;</span>

                <span class="nv">$vals</span><span class="p">[</span><span class="nv">$value</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

            <span class="p">}</span>

            <span class="nx">self</span><span class="o">::</span><span class="nv">$___constants</span><span class="p">[</span> <span class="k">static</span><span class="o">::</span><span class="na">class</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nv">$csts</span><span class="p">,</span> <span class="nv">$vals</span> <span class="p">];</span>

        <span class="p">}</span>

    <span class="p">}</span>


    <span class="sd">/***************************************************************************</span>
<span class="sd">     * </span>
<span class="sd">     * 値の取得に関するもの</span>
<span class="sd">     * </span>
<span class="sd">     **************************************************************************/</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">value</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">scalar</span><span class="p">;</span> <span class="p">}</span>


    <span class="sd">/***************************************************************************</span>
<span class="sd">     * </span>
<span class="sd">     * その他ユーティリティ</span>
<span class="sd">     * </span>
<span class="sd">     **************************************************************************/</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_validate_constants</span><span class="p">(</span> <span class="nv">$value</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">bool</span> <span class="p">{</span>

        <span class="k">return</span> <span class="p">(</span> <span class="nb">is_int</span><span class="p">(</span> <span class="nv">$value</span> <span class="p">)</span> <span class="k">or</span> <span class="nb">is_string</span><span class="p">(</span> <span class="nv">$value</span> <span class="p">)</span> <span class="p">);</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="整数型列挙クラスintenum" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0%E5%9E%8B%E5%88%97%E6%8C%99%E3%82%AF%E3%83%A9%E3%82%B9intenum"><i class="fa fa-link"></i></a>整数型列挙クラス<code>IntEnum</code>
</h1>

<p>列挙定数に整数型以外を許容しません。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">IntEnum.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Enum</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">IntEnum</span> <span class="k">extends</span> <span class="nx">Enum</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span> <span class="nx">int</span> <span class="nv">$scalar</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span> <span class="nv">$scalar</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">final</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">value</span><span class="p">(</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">int</span> <span class="p">{</span> 

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">value</span><span class="p">(</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">final</span> <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_validate_constants</span><span class="p">(</span> <span class="nv">$value</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">bool</span> <span class="p">{</span>

        <span class="k">return</span> <span class="nb">is_int</span><span class="p">(</span> <span class="nv">$value</span> <span class="p">);</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="文字列型列挙クラスstringenum" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E5%9E%8B%E5%88%97%E6%8C%99%E3%82%AF%E3%83%A9%E3%82%B9stringenum"><i class="fa fa-link"></i></a>文字列型列挙クラス<code>StringEnum</code>
</h1>

<p>列挙定数に文字列型以外を許容しません。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">StringEnum.php</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Enum</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">StringEnum</span> <span class="k">extends</span> <span class="nx">Enum</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span> <span class="nx">string</span> <span class="nv">$scalar</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span> <span class="nv">$scalar</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">final</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">value</span><span class="p">(</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">value</span><span class="p">(</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">final</span> <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_validate_constants</span><span class="p">(</span> <span class="nv">$value</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">bool</span> <span class="p">{</span>

        <span class="k">return</span> <span class="nb">is_string</span><span class="p">(</span> <span class="nv">$value</span> <span class="p">);</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>4kizukiさんの<br />5位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/4kizuki/items/be052a60250b9b8640f2">バリデーション関数定義のベストプラクティス(設計的な話)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-11 05:30:31</center>
	</td>
	<td style="width:200px;">
		@4kizuki<br><img width="80" height="80" src="https://avatars3.githubusercontent.com/u/23712113?v=3">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PHP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>値のバリデーションは、アプリケーションにおいて頻繁に行われる処理ですが、作成者によってその実装方法がまちまちだったりします。</p>

<h1>
<span id="よくある例-自分は嫌いです" class="fragment"></span><a href="#%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E4%BE%8B-%E8%87%AA%E5%88%86%E3%81%AF%E5%AB%8C%E3%81%84%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>よくある例 (自分は嫌いです)</h1>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">bad_definition.php</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">MyValidator</span><span class="p">(</span> <span class="nv">$x</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">bool</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nb">is_int</span><span class="p">(</span> <span class="nv">$x</span> <span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="何が問題なのか" class="fragment"></span><a href="#%E4%BD%95%E3%81%8C%E5%95%8F%E9%A1%8C%E3%81%AA%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>何が問題なのか</h3>

<p><code>MyValidator</code>を指定する際にこうなる</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">usage</span></div>
<div class="highlight"><pre><span></span><span class="nv">$validator</span> <span class="o">=</span> <span class="s1">'MyValidator'</span><span class="p">;</span>  <span class="c1">// ここが即値なので気持ち悪いんです！！</span>
<span class="nv">$validator</span><span class="p">(</span> <span class="mi">33</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">);</span>
</pre></div>
</div>

<h1>
<span id="良いパターン1" class="fragment"></span><a href="#%E8%89%AF%E3%81%84%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B31"><i class="fa fa-link"></i></a>良いパターン1</h1>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">good_definition1.php</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">MyValidator</span><span class="p">(</span> <span class="nv">$x</span> <span class="o">=</span> <span class="k">null</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// クラスのstaticメソッドの場合は__METHOD__を利用のこと</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">func_num_args</span><span class="p">(</span> <span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="no">__FUNCTION__</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">is_int</span><span class="p">(</span> <span class="nv">$x</span> <span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">usage</span></div>
<div class="highlight"><pre><span></span><span class="nv">$validator</span> <span class="o">=</span> <span class="nx">MyValidator</span><span class="p">(</span> <span class="p">);</span>
<span class="nv">$validator</span><span class="p">(</span> <span class="mi">33</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">);</span>
</pre></div>
</div>

<h3>
<span id="コードを解読するうえで重要なポイント" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E8%A7%A3%E8%AA%AD%E3%81%99%E3%82%8B%E3%81%86%E3%81%88%E3%81%A7%E9%87%8D%E8%A6%81%E3%81%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>コードを解読するうえで重要なポイント</h3>

<ul>
<li>
<code>func_num_args( )</code>は、省略された引数をカウントしません。すなわち、以下のアサーションが成立します。</li>
</ul>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">func_num_args</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">retArgNum</span><span class="p">(</span> <span class="nv">$x</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="nv">$y</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="nv">$z</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">int</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nb">func_num_args</span><span class="p">(</span> <span class="p">);</span>

<span class="p">}</span>

<span class="nb">assert</span><span class="p">(</span> <span class="nx">retArgNum</span><span class="p">(</span> <span class="p">)</span>            <span class="o">===</span> <span class="mi">0</span> <span class="p">);</span>
<span class="nb">assert</span><span class="p">(</span> <span class="nx">retArgNum</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>          <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
<span class="nb">assert</span><span class="p">(</span> <span class="nx">retArgNum</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>       <span class="o">===</span> <span class="mi">2</span> <span class="p">);</span>
<span class="nb">assert</span><span class="p">(</span> <span class="nx">retArgNum</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>    <span class="o">===</span> <span class="mi">3</span> <span class="p">);</span>
<span class="nb">assert</span><span class="p">(</span> <span class="nx">retArgNum</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">);</span>   <span class="c1">// オーバーしていても！</span>
</pre></div>
</div>

<h3>
<span id="何がいいのか" class="fragment"></span><a href="#%E4%BD%95%E3%81%8C%E3%81%84%E3%81%84%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>何がいいのか</h3>

<ul>
<li>既存の(よくある例)バリデータと互換性がある</li>
<li>関数名の指定に即値を使わない</li>
</ul>

<h1>
<span id="良いパターン2" class="fragment"></span><a href="#%E8%89%AF%E3%81%84%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B32"><i class="fa fa-link"></i></a>良いパターン2</h1>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">good_definition2.php</span></div>
<div class="highlight"><pre><span></span><span class="k">interface</span> <span class="nx">Validator</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">Validate</span><span class="p">(</span> <span class="nv">$x</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">bool</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">class</span> <span class="nc">MyValidator</span> <span class="k">implements</span> <span class="nx">Validator</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">Validate</span><span class="p">(</span> <span class="nv">$x</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">bool</span> <span class="p">{</span>

        <span class="k">return</span> <span class="nb">is_int</span><span class="p">(</span> <span class="nv">$x</span> <span class="p">);</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">usage</span></div>
<div class="highlight"><pre><span></span><span class="nv">$validator</span> <span class="o">=</span> <span class="nx">MyValidator</span><span class="o">::</span><span class="na">class</span><span class="p">;</span>
<span class="nv">$v</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$validator</span><span class="p">;</span>
<span class="nv">$v</span><span class="o">-&gt;</span><span class="na">Validate</span><span class="p">(</span> <span class="mi">33</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">);</span>
</pre></div>
</div>

<h3>
<span id="何がいいのか-1" class="fragment"></span><a href="#%E4%BD%95%E3%81%8C%E3%81%84%E3%81%84%E3%81%AE%E3%81%8B-1"><i class="fa fa-link"></i></a>何がいいのか</h3>

<ul>
<li>オブジェクトになっているので継承が使える</li>
<li>もちろん、即値を使わない</li>
</ul>

<h3>
<span id="気になる点" class="fragment"></span><a href="#%E6%B0%97%E3%81%AB%E3%81%AA%E3%82%8B%E7%82%B9"><i class="fa fa-link"></i></a>気になる点</h3>

<ul>
<li>毎回オブジェクトを作るのでパフォーマンス的にはどうだろう？</li>
</ul>

<h1>
<span id="最後にコメント" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>最後にコメント</h1>

<p>パターン2については、値の注入をコンストラクタにして、オブジェクトをイミュータブルにするのもよいプラクティスですが、今回はわかりやすくこのような形としました。</p>

<p>個人的には、連想配列は即値のオンパレードなので大っ嫌いです( )。入力値はクラスで渡させるようにすることで、バリデーションとロジックを分離できます。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">bad_practice</span></div>
<div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">DomainException</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">MyFunction</span><span class="p">(</span> <span class="k">array</span> <span class="nv">$x</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// $xに関して延々とバリデーション</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span> <span class="nv">$x</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">DomainException</span><span class="p">(</span> <span class="s1">'\'data\' not exists'</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span> <span class="nv">$x</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">DomainException</span><span class="p">(</span> <span class="s1">'\'data\' is not array'</span> <span class="p">);</span>
    <span class="c1">// etc..</span>

    <span class="c1">// ロジック</span>
    <span class="nv">$y</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'sql_return'</span><span class="p">];</span>
    <span class="nv">$z</span> <span class="o">=</span> <span class="nv">$y</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
    <span class="c1">// etc..</span>

<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">good_practice</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyFunctionData</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* こことか、ほかのsetterでバリデーションをする */</span>

    <span class="p">}</span>

    <span class="c1">// $dataをプライベートにし、GetDataをfinalにしないと、継承により不正なデータを送り込めるので注意！</span>
    <span class="k">private</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="k">final</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">GetData</span><span class="p">(</span> <span class="p">)</span> <span class="o">:</span> <span class="k">array</span> <span class="p">{</span>

        <span class="cm">/* もちろん、実際はこんな大雑把な返し方ではなく、データごとに個別にgetterを用意する */</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">;</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">MyFunction</span><span class="p">(</span> <span class="nx">MyFunctionData</span> <span class="nv">$mfd</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// この時点で$xの正しさが保証されている(MyFunctionDataによって)</span>
    <span class="nv">$x</span> <span class="o">=</span> <span class="nv">$mfd</span><span class="o">-&gt;</span><span class="na">GetData</span><span class="p">(</span> <span class="p">);</span>

    <span class="c1">// ロジック</span>
    <span class="nv">$y</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'sql_return'</span><span class="p">];</span>
    <span class="nv">$z</span> <span class="o">=</span> <span class="nv">$y</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
    <span class="c1">// etc..</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
