<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (kidach1)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (kidach1 さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1171</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/15cfee9ec66804c3afd2">Ruby block/proc/lambdaの使いどころ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-18 10:44:33</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>(2015/10/13追記) <br>
今なら、他言語には無名関数やcallback関数というものがありますねとか、イベント駆動の世界を覗いてから戻ってくるとより腑に落ちるかもしれませんとか、もう少し全体観の中で説明する気がしますが、当時は本記事の様な理解が役に立ったことは事実なので、引き続き公開を続けます。</p>

<p>(2013/11/29追記) block_given? について</p>

<p>Twitter上で「Kernel.#block_given?についての解説があってもよさそう」と<br>
指摘を頂きましたので、<a href="http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2#ps1">本文下部</a>に追記しました。</p>

<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>Ruby on Rails Tutorialのエッセンスを自分なりに整理してみる4</p>

<p>Railsを触る際知っていると便利なRubyの基礎 [ブロックとかシンボルとか]<br>
<a href="http://qiita.com/kidachi_/items/46a6e49b6306655ccd64" class="autolink" id="reference-38f86efb94b33fccf144">http://qiita.com/kidachi_/items/46a6e49b6306655ccd64</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter4）<br>
<a href="http://railstutorial.jp/chapters/rails-flavored-ruby?version=4.0#fnref-4_11" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/rails-flavored-ruby?version=4.0#fnref-4_11</a></p>

<h2>
<span id="流れ" class="fragment"></span><a href="#%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>流れ</h2>

<ul>
<li>ブロックとは何か</li>
<li>yield、Procとは何か</li>
<li>Proc補足</li>
<li>で、ブロックやProcって何が嬉しいの？</li>
</ul>

<h2>
<span id="ブロックとは何か" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>ブロックとは何か</h2>

<p>ひとことで言うと</p>

<h3>
<span id="doendもしくはで囲われた引数となるためのカタマリ" class="fragment"></span><a href="#doend%E3%82%82%E3%81%97%E3%81%8F%E3%81%AF%E3%81%A7%E5%9B%B2%E3%82%8F%E3%82%8C%E3%81%9F%E5%BC%95%E6%95%B0%E3%81%A8%E3%81%AA%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E3%82%AB%E3%82%BF%E3%83%9E%E3%83%AA"><i class="fa fa-link"></i></a>do~end（もしくは{~}）で囲われた、引数となるためのカタマリ。</h3>

<p>ブロックについて調べようとするとだいたい「yield(いーるど)」とか「Proc」とかが<br>
混ざってきてよく分からなくなるけど、実際はこれだけです。</p>

<p>yieldは「ブロックを呼び出すもの」、Procは「ブロックをオブジェクト化したもの」であり、<br>
ブロック自体とは別物（詳しくは後述）。</p>

<h4>
<span id="ブロックの性質" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AE%E6%80%A7%E8%B3%AA"><i class="fa fa-link"></i></a>ブロックの性質</h4>

<ul>
<li>それ単体では存在できず、メソッドの引数にしかなれない

<ul>
<li>「do~endのカタマリ」がその辺に単体で転がっているのは見た事ないはず。</li>
</ul>
</li>
<li>引数として渡されたブロックは、yieldによって実行される</li>
</ul>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#ブロックを受け取るメソッドの定義</span>
<span class="k">def</span> <span class="nf">give_me_block</span>
  <span class="k">yield</span>
<span class="k">end</span>

<span class="c1">#メソッドの引数としてブロック（do~end）を渡して、実行</span>
<span class="n">give_me_block</span> <span class="k">do</span>
  <span class="nb">p</span> <span class="s2">"Hello, block!"</span>
<span class="k">end</span>
<span class="o">=&gt;</span> <span class="s2">"Hello, block!"</span>    <span class="c1">#give_me_block内で、yieldによって呼び出された。</span>
</pre></div></div>

<p>ただ、yieldというのはあるべき手順をすっ飛ばしているため分かりづらい。<br>
以下の流れを追っていくと理解しやすいです。</p>

<h3>
<span id="そもそもブロックとは引数であることを明示した書き方も存在する" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%A8%E3%81%AF%E5%BC%95%E6%95%B0%E3%81%A7%E3%81%82%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E6%98%8E%E7%A4%BA%E3%81%97%E3%81%9F%E6%9B%B8%E3%81%8D%E6%96%B9%E3%82%82%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>「そもそもブロックとは引数であること」を明示した書き方も存在する</h3>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#メソッド定義</span>
<span class="k">def</span> <span class="nf">give_me_block</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">block</span> <span class="p">)</span>
  <span class="n">block</span><span class="o">.</span><span class="n">call</span>
<span class="k">end</span>

<span class="c1">#実行</span>
<span class="n">give_me_block</span> <span class="k">do</span>
  <span class="nb">p</span> <span class="s2">"Hello, block!"</span>
<span class="k">end</span>
<span class="o">=&gt;</span> <span class="s2">"Hello, block!"</span>
</pre></div></div>

<p><code>def give_me_block( &amp;block )</code>で、ブロック引数を受け取ることを明示している。</p>

<h3>
<span id="blockのって" class="fragment"></span><a href="#block%E3%81%AE%E3%81%A3%E3%81%A6"><i class="fa fa-link"></i></a>&amp;blockの「&amp;」って？</h3>

<p>&amp;を付けることで、実際に引数にブロックが渡ってきた際、<br>
Procオブジェクトに変換している。</p>

<h3>
<span id="procオブジェクトって" class="fragment"></span><a href="#proc%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A3%E3%81%A6"><i class="fa fa-link"></i></a>Procオブジェクトって？</h3>

<ul>
<li>ブロックをオブジェクト化したものがProc

<ul>
<li>ブロックがそれ単体では存在できないことを思い出す （→オブジェクト化してしまえばok）</li>
<li>ブロックをオブジェクトに変換することで、引き渡されたメソッド（give_me_block）内で扱えるようにする</li>
</ul>
</li>
<li>Procオブジェクトは、callで呼び出すことが出来る

<ul>
<li>2行目の<code>block.call</code>の正体はこれ。</li>
</ul>
</li>
</ul>

<h3>
<span id="ちなみにブロック引数は仮引数の中で一番最後に定義されていなければならない" class="fragment"></span><a href="#%E3%81%A1%E3%81%AA%E3%81%BF%E3%81%AB%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E5%BC%95%E6%95%B0%E3%81%AF%E4%BB%AE%E5%BC%95%E6%95%B0%E3%81%AE%E4%B8%AD%E3%81%A7%E4%B8%80%E7%95%AA%E6%9C%80%E5%BE%8C%E3%81%AB%E5%AE%9A%E7%BE%A9%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>ちなみに、ブロック引数は、仮引数の中で一番最後に定義されていなければならない</h3>

<p>以下みたいなのはNG</p>

<ul>
<li>def give_me_block( &amp;block1, param1 )</li>
<li>def give_me_block( &amp;block1, &amp;block2 )</li>
</ul>

<p>つまるところ<strong>引数として渡せるブロックは一つだけ</strong>。</p>

<h3>
<span id="以上を踏まえると" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8A%E3%82%92%E8%B8%8F%E3%81%BE%E3%81%88%E3%82%8B%E3%81%A8"><i class="fa fa-link"></i></a>以上を踏まえると</h3>

<p>こんな考え方も出来る。</p>

<p>「どうせブロック引数は一つしか取れないんだから</p>

<h4>
<span id="呼び出し箇所をblockcallなんて明示せずにyieldで統一しちゃえば良いじゃん" class="fragment"></span><a href="#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E7%AE%87%E6%89%80%E3%82%92blockcall%E3%81%AA%E3%82%93%E3%81%A6%E6%98%8E%E7%A4%BA%E3%81%9B%E3%81%9A%E3%81%AByield%E3%81%A7%E7%B5%B1%E4%B8%80%E3%81%97%E3%81%A1%E3%82%83%E3%81%88%E3%81%B0%E8%89%AF%E3%81%84%E3%81%98%E3%82%83%E3%82%93"><i class="fa fa-link"></i></a>呼び出し箇所を<code>block.call</code>なんて明示せずに、<code>yield</code>で統一しちゃえば良いじゃん」</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#メソッド定義</span>
<span class="k">def</span> <span class="nf">give_me_block</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">block</span> <span class="p">)</span>
  <span class="k">yield</span>    <span class="c1"># block.callをやめてyieldに変更</span>
<span class="k">end</span>

<span class="c1">#実行</span>
<span class="n">give_me_block</span> <span class="k">do</span>
  <span class="nb">p</span> <span class="s2">"Hello, block!"</span>
<span class="k">end</span>
<span class="o">=&gt;</span> <span class="s2">"Hello, block!"</span>
</pre></div></div>

<h3>
<span id="さらに" class="fragment"></span><a href="#%E3%81%95%E3%82%89%E3%81%AB"><i class="fa fa-link"></i></a>さらに</h3>

<h4>
<span id="ブロックは全部yieldが示すんだから仮引数blockもいらなくね" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AF%E5%85%A8%E9%83%A8yield%E3%81%8C%E7%A4%BA%E3%81%99%E3%82%93%E3%81%A0%E3%81%8B%E3%82%89%E4%BB%AE%E5%BC%95%E6%95%B0block%E3%82%82%E3%81%84%E3%82%89%E3%81%AA%E3%81%8F%E3%81%AD"><i class="fa fa-link"></i></a>「ブロックは全部yieldが示すんだから、仮引数（&amp;block）もいらなくね？」</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#メソッド定義</span>
<span class="k">def</span> <span class="nf">give_me_block</span>    <span class="c1"># (&amp;block)を除去</span>
  <span class="k">yield</span>
<span class="k">end</span>

<span class="c1">#実行</span>
<span class="n">give_me_block</span> <span class="k">do</span>
  <span class="nb">p</span> <span class="s2">"Hello, block!"</span>
<span class="k">end</span>
<span class="o">=&gt;</span> <span class="s2">"Hello, block!"</span>
</pre></div></div>

<p>これが<strong>色々省略されまくったyield文の正体</strong>です。</p>

<p>一見give_me_blockは何も引数をとらないメソッドのように見えるのに、<br>
その内部にyieldを持っている以上「ブロックを引数として受けとるメソッドである」<br>
ということを認識しないといけない。</p>

<p>Rubyコードを読み解く際によく注意しておかなければならない点の一つのみたいです。</p>

<p>以下記事でまつもとさんが話しているのもそんな話。<br>
<a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20070621/275509/?P=3" class="autolink" rel="nofollow noopener" target="_blank">http://itpro.nikkeibp.co.jp/article/COLUMN/20070621/275509/?P=3</a><br>
「もし最初から暗黙の引数みたいなデザインをしていたら、<br>
今許しているアンパサンド「＆」の文法は必須にして、yieldはなくして、<br>
「＆」が付いていないのにブロックを渡したらエラーになるとか…」</p>

<h2>
<span id="proc補足" class="fragment"></span><a href="#proc%E8%A3%9C%E8%B6%B3"><i class="fa fa-link"></i></a>Proc補足</h2>

<p>上でも説明していますが補足含めて。</p>

<ul>
<li>ブロックをオブジェクト化したものがProc</li>
<li>Procオブジェクトはcallで呼び出すことが出来る</li>
<li>Procに引数を期待する書き方も出来る

<ul>
<li>「メソッドの引数となるProcにさらに引数が期待できる」って混乱しそうですが・・</li>
</ul>
</li>
<li>Proc.newとlambdaはほぼ同義</li>
</ul>

<h4>
<span id="procオブジェクトの定義と呼び出しサンプル" class="fragment"></span><a href="#proc%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E5%AE%9A%E7%BE%A9%E3%81%A8%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>Procオブジェクトの定義と呼び出しサンプル</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#インスタンス生成</span>
<span class="n">proc1</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
  <span class="nb">p</span> <span class="s2">"hoge"</span>
<span class="k">end</span>

<span class="c1">#実行</span>
<span class="n">proc1</span><span class="o">.</span><span class="n">call</span>
<span class="o">=&gt;</span> <span class="s2">"hoge"</span>
</pre></div></div>

<h4>
<span id="呼び出されるcallされる際に引数が渡されることを期待する書き方サンプル" class="fragment"></span><a href="#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%95%E3%82%8C%E3%82%8Bcall%E3%81%95%E3%82%8C%E3%82%8B%E9%9A%9B%E3%81%AB%E5%BC%95%E6%95%B0%E3%81%8C%E6%B8%A1%E3%81%95%E3%82%8C%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E6%9C%9F%E5%BE%85%E3%81%99%E3%82%8B%E6%9B%B8%E3%81%8D%E6%96%B9%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>呼び出される（callされる）際に引数が渡されることを期待する書き方サンプル</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#インスタンス生成</span>
<span class="n">proc2</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>    <span class="c1">#sが仮引数</span>
  <span class="nb">p</span> <span class="s2">"Hello, </span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="c1">#実行</span>
<span class="n">proc2</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"Proc"</span><span class="p">)</span>    <span class="c1">#"Proc"が実引数</span>
<span class="o">=&gt;</span> <span class="s2">"Hello, Proc!"</span>
</pre></div></div>

<h4>
<span id="procnewとlambdaはほぼ同義" class="fragment"></span><a href="#procnew%E3%81%A8lambda%E3%81%AF%E3%81%BB%E3%81%BC%E5%90%8C%E7%BE%A9"><i class="fa fa-link"></i></a>Proc.newとlambdaはほぼ同義</h4>

<p>以下の記述で上の2例と同じ結果が得られる</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#インスタンス生成</span>
<span class="n">lambda1</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="nb">p</span> <span class="s2">"hoge"</span> <span class="p">}</span>
<span class="c1">#実行</span>
<span class="n">lambda1</span><span class="o">.</span><span class="n">call</span>
<span class="o">=&gt;</span> <span class="s2">"hoge"</span>

<span class="n">lambda2</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="nb">p</span> <span class="s2">"Hello, </span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">!"</span> <span class="p">}</span>
<span class="n">lambda2</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"Proc"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"Hello, Proc!"</span>
</pre></div></div>

<p>※細かくはProcとlambdaには違いが存在しますが、ここでは触れません。<br>
補足は以下等を参照ください。</p>

<p>RubyでlambdaとProcの違いは？<br>
<a href="http://qa.atmarkit.co.jp/q/68" class="autolink" rel="nofollow noopener" target="_blank">http://qa.atmarkit.co.jp/q/68</a></p>

<h2>
<span id="でブロックやprocって何が嬉しいの" class="fragment"></span><a href="#%E3%81%A7%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%84proc%E3%81%A3%E3%81%A6%E4%BD%95%E3%81%8C%E5%AC%89%E3%81%97%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>で、ブロックやProcって何が嬉しいの？</h2>

<p>一つ目は</p>

<h3>
<span id="メソッドを後々の利用時に柔軟に拡張出来る" class="fragment"></span><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%BE%8C%E3%80%85%E3%81%AE%E5%88%A9%E7%94%A8%E6%99%82%E3%81%AB%E6%9F%94%E8%BB%9F%E3%81%AB%E6%8B%A1%E5%BC%B5%E5%87%BA%E6%9D%A5%E3%82%8B"><i class="fa fa-link"></i></a>メソッドを後々の利用時に柔軟に拡張出来る</h3>

<p>例えば、開発者Aが「5という数で好きな事をしてもらうメソッドを作ろう」と<br>
考えた場合、以下のようになります。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">magic_five_box</span><span class="p">(</span><span class="n">after_input</span><span class="p">,</span> <span class="n">someProc</span><span class="p">)</span>
  <span class="n">someProc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">after_input</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>開発者B「私は5を使って足し算します」</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">sum_proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="k">end</span>

<span class="n">magic_five_box</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sum_proc</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">8</span>
</pre></div></div>

<p>開発者C「私なら文字列を5回表示させます」</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">string_proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="p">,</span> <span class="n">string</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">string</span> <span class="o">*</span> <span class="n">x</span>
<span class="k">end</span>

<span class="n">magic_five_box</span><span class="p">(</span><span class="s1">'happy_proc! '</span><span class="p">,</span> <span class="n">string_proc</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"happy_proc! happy_proc! happy_proc! happy_proc! happy_proc! "</span>
</pre></div></div>

<p>このメソッド例は大した意味は持ちませんが、<br>
使い方によって有効に利用できそうな雰囲気が伝わったでしょうか。</p>

<p>下の記事はブロックのことを「メソッドに対するメソッドのMix-in」と表現しています。</p>

<p>Rubyのブロックはメソッドに対するメソッドのMix-inだ！<br>
<a href="http://melborne.github.io/2008/08/09/Ruby-Mix-in/" class="autolink" rel="nofollow noopener" target="_blank">http://melborne.github.io/2008/08/09/Ruby-Mix-in/</a></p>

<p>よく考えてみると、Ruby標準の<strong>eachやmapなどもブロックを受け取るメソッド</strong>です。</p>

<p>「配列を扱うならこれ、という『土台』は用意しておくから、<br>
細かい部分はブロックを加えて自由に料理して」という思想ですね。</p>

<h3>
<span id="状態を持った関数クロージャとしての機能が得られる" class="fragment"></span><a href="#%E7%8A%B6%E6%85%8B%E3%82%92%E6%8C%81%E3%81%A3%E3%81%9F%E9%96%A2%E6%95%B0%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AE%E6%A9%9F%E8%83%BD%E3%81%8C%E5%BE%97%E3%82%89%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>状態を持った関数（クロージャ）としての機能が得られる</h3>

<p>ブロック/Proc二つ目のメリットはこちら。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="nb">proc</span><span class="o">.</span><span class="n">call</span>
<span class="o">=&gt;</span><span class="mi">2</span>
<span class="nb">proc</span><span class="o">.</span><span class="n">call</span>
<span class="o">=&gt;</span><span class="mi">3</span>
<span class="nb">proc</span><span class="o">.</span><span class="n">call</span>
<span class="o">=&gt;</span><span class="mi">4</span>
</pre></div></div>

<p>Procオブジェクト（proc）は外側のスコープに存在するnへの参照を保持し、<br>
呼び出す度にnをインクリメントできるメソッドができました。</p>

<p>が、クロージャの細かい特徴/用途となるとまた長い話になるので、<br>
詳しくは以下等を参照してみてください。</p>

<p>私が今までクロージャを理解できなかった理由Add Starfoussin<br>
<a href="http://d.hatena.ne.jp/artgear/20120115/1326635158" class="autolink" rel="nofollow noopener" target="_blank">http://d.hatena.ne.jp/artgear/20120115/1326635158</a></p>

<p><a></a></p>

<h2>
<span id="20131129追記-kernelblock_given-について" class="fragment"></span><a href="#20131129%E8%BF%BD%E8%A8%98-kernelblock_given-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>(2013/11/29追記) Kernel.#block_given? について</h2>

<h3>
<span id="block_givenとは" class="fragment"></span><a href="#block_given%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>block_given?とは</h3>

<p>名前の通り、引数としてブロックが与えられたかどうかを判別するメソッド。</p>

<h3>
<span id="利用例" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>利用例</h3>

<p>開発者A<br>
「7という数で好きな事をしてもらうメソッドを作ろう。<br>
でも、<strong>もしブロックが渡されなくても使えるようにしよう。</strong>」</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wonder_seven_box</span>
  <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">yield</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nb">p</span> <span class="s2">"Don't mind. Feel free to call me."</span>    <span class="c1"># ブロックが与えられなければこちら</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>開発者B「私は7を使って足し算します」</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">wonder_seven_box</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="nb">p</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">x</span>
<span class="k">end</span>
<span class="o">=&gt;</span> <span class="mi">10</span>
</pre></div></div>

<p>開発者C「私なら文字列を7回表示させます」</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">wonder_seven_box</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="nb">p</span> <span class="s2">"happy_block! "</span> <span class="o">*</span> <span class="n">x</span>
<span class="k">end</span>
<span class="o">=&gt;</span> <span class="s2">"happy_block! happy_block! happy_block! happy_block! happy_block! happy_block! happy_block! "</span>
</pre></div></div>

<p>開発者D「ブロックよく分からない」</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">wonder_seven_box</span>
<span class="o">=&gt;</span> <span class="s2">"Don't mind. Feel free to call me."</span>
</pre></div></div>

<p>ブロックを与えなくても呼び出すことが出来ました。</p>

<h2>
<span id="block_givenを整理していて気になった事" class="fragment"></span><a href="#block_given%E3%82%92%E6%95%B4%E7%90%86%E3%81%97%E3%81%A6%E3%81%84%E3%81%A6%E6%B0%97%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F%E4%BA%8B"><i class="fa fa-link"></i></a>block_given?を整理していて気になった事</h2>

<p>※本項はRubyの言語仕様に関する疑問点の備忘録です。<br>
「ブロックとProcをちゃんと理解する」からは少しずれますので、<br>
不要であれば読み飛ばして頂ければと思います。</p>

<h3>
<span id="細かいけど" class="fragment"></span><a href="#%E7%B4%B0%E3%81%8B%E3%81%84%E3%81%91%E3%81%A9"><i class="fa fa-link"></i></a>細かいけど</h3>

<p>お気づきかと思いますが、magic_five_boxの例ではProcベースでしたが、<br>
今回のwonder_seven_boxはブロックベースとなっています。</p>

<p>というのも、<strong>proc_given?のようなメソッドが見当たらなかったので。</strong></p>

<p>つまり、procの場合は、</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">magic_five_box</span><span class="p">(</span><span class="n">after_input</span><span class="p">,</span> <span class="n">someProc</span><span class="p">)</span>
  <span class="n">someProc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">after_input</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>の例が示す通り、<strong>Procオブジェクトを受け取る前提</strong>の記述となるため、<br>
block_given?に類する判定がそもそも必要ない。</p>

<p>一方でブロックの場合は</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wonder_seven_box</span>
  <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">yield</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nb">p</span> <span class="s2">"Don't mind. Feel free to call me."</span>    <span class="c1"># ブロックが与えられなければこちら</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>上記例で見た通り、<br>
<strong>ブロックを引数に取っても取らなくても良い、より柔軟なメソッド</strong><br>
を作ることが出来ます。</p>

<p>ただ、まつもとさんが仰っている内容（以下再掲）を鑑みた時、ひとつ疑問が生まれました。</p>

<p><a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20070621/275509/?P=3" class="autolink" rel="nofollow noopener" target="_blank">http://itpro.nikkeibp.co.jp/article/COLUMN/20070621/275509/?P=3</a><br>
「もし最初から暗黙の引数みたいなデザインをしていたら、<br>
今許しているアンパサンド「＆」の文法は必須にして、yieldはなくして、<br>
「＆」が付いていないのにブロックを渡したらエラーになるとか…」</p>

<p>つまり以下の記述をスタンダードにした方が良いかも、ということですね。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">give_me_block</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">block</span> <span class="p">)</span>
  <span class="n">block</span><span class="o">.</span><span class="n">call</span>
<span class="k">end</span>
</pre></div></div>

<p>そしてこの記述の場合、ブロックは<strong>渡されて来ることが前提</strong>となりそうです。</p>

<p>（もちろん、</p>

<ul>
<li>引数にブロックを期待する場合のみ、引数が渡されないケースも許容する</li>
</ul>

<p>（メソッド内でblock_given?で判定）</p>

<p>というデザインもあり得るとは思いますが、<br>
<strong>通常のメソッド定義と見た目はほぼ一緒なのにルールだけ違う</strong>という状況になってしまいます。）</p>

<p>何が気になっているのかというと、</p>

<h4>
<span id="本来-kernelblock_given-は必須の実装なのか" class="fragment"></span><a href="#%E6%9C%AC%E6%9D%A5-kernelblock_given-%E3%81%AF%E5%BF%85%E9%A0%88%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%AA%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>本来 Kernel.#block_given? は必須の実装なのか？</h4>

<p>ということ。実は</p>

<h4>
<span id="yieldという特殊な存在に引き摺られて後付けで実装された" class="fragment"></span><a href="#yield%E3%81%A8%E3%81%84%E3%81%86%E7%89%B9%E6%AE%8A%E3%81%AA%E5%AD%98%E5%9C%A8%E3%81%AB%E5%BC%95%E3%81%8D%E6%91%BA%E3%82%89%E3%82%8C%E3%81%A6%E5%BE%8C%E4%BB%98%E3%81%91%E3%81%A7%E5%AE%9F%E8%A3%85%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>（yieldという特殊な存在に引き摺られて）後付けで実装された</h4>

<p>ものであり</p>

<h4>
<span id="想定外のもっと言うと本来不要な柔軟性を生み出している" class="fragment"></span><a href="#%E6%83%B3%E5%AE%9A%E5%A4%96%E3%81%AE%E3%82%82%E3%81%A3%E3%81%A8%E8%A8%80%E3%81%86%E3%81%A8%E6%9C%AC%E6%9D%A5%E4%B8%8D%E8%A6%81%E3%81%AA%E6%9F%94%E8%BB%9F%E6%80%A7%E3%82%92%E7%94%9F%E3%81%BF%E5%87%BA%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>想定外の（もっと言うと本来不要な）柔軟性を生み出している</h4>

<p>ものだったりしないのでしょうか。</p>

<p>→仮に通常の引数に対してblock_given?に類するものがあったとすると、<br>
　こんなことをしてる訳で。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_method</span> <span class="p">(</span> <span class="n">args</span> <span class="p">)</span>
  <span class="k">if</span> <span class="n">args_given?</span>
    <span class="n">hoge</span>
  <span class="k">else</span>
    <span class="n">fuga</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>果たしてこれをポジティブに「柔軟」と捉えるべきか。</p>

<h5>
<span id="ご相談" class="fragment"></span><a href="#%E3%81%94%E7%9B%B8%E8%AB%87"><i class="fa fa-link"></i></a>ご相談</h5>

<p>もしこのあたりの成り立ちのストーリーに詳しい方、<br>
または言語デザインに対するご指摘をお持ちの方がいらっしゃいましたら<br>
ぜひご教示頂けると嬉しいです！</p>

<p>※同時に、Ruby初心者の考察であるため、的を外している点ありましたら<br>
突っ込みを頂けますと幸いですm(_ _)m</p>

<h2>
<span id="ブロックproc参考御礼" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AFproc%E5%8F%82%E8%80%83%E5%BE%A1%E7%A4%BC"><i class="fa fa-link"></i></a>ブロック/Proc参考＆御礼</h2>

<p>数あるブロックの記事を読んでもいまいちすっきりできなかった自分でしたが、<br>
以下の記事で目から鱗が落ちました。</p>

<p>Rubyの動かないコード（初級編）ブロックとクロージャの性質<br>
<a href="http://d.hatena.ne.jp/language_and_engineering/20101118/p1" class="autolink" rel="nofollow noopener" target="_blank">http://d.hatena.ne.jp/language_and_engineering/20101118/p1</a></p>

<p>分かりやすい記事をありがとうございました！</p>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>[Rails] TwitterBootstrapとSassとAssetPipeline<br>
<a href="http://qiita.com/kidachi_/items/4c47b28b2a74c723d835" class="autolink" id="reference-3d30586796a54ed27e21">http://qiita.com/kidachi_/items/4c47b28b2a74c723d835</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>824</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/e63c1607705178aa257c">Vagrant basics</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-09 19:57:39</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[vagrant]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>仮想環境（VirtualBoxなど）上への仮想マシンの立ち上げ、操作が可能。</p>

<h2>
<span id="用語" class="fragment"></span><a href="#%E7%94%A8%E8%AA%9E"><i class="fa fa-link"></i></a>用語</h2>

<h3>
<span id="プロバイダ" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%90%E3%82%A4%E3%83%80"><i class="fa fa-link"></i></a>プロバイダ</h3>

<p>仮想環境<br>
eg.VirtualBoxやVM Ware、EC2など</p>

<h3>
<span id="プロビジョニング" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%93%E3%82%B8%E3%83%A7%E3%83%8B%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>プロビジョニング</h3>

<p>ミドルウェアの設定やインストールを行うツール<br>
eg.シェルスクリプト、Chef（chef-solo, chef-client）、Puppetなど</p>

<h3>
<span id="boxファイル" class="fragment"></span><a href="#box%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>Boxファイル</h3>

<p>仮想マシン起動の際にベースとなるイメージファイルのこと。<br>
仮想環境ごとに必要。<br>
通常はOSイメージから作成する。<br>
Vagrant利用の上で最低限必要な設定（Vagrantユーザの作成、sshdの起動、プロビジョニングツールのインストール）のみを行っておくのが普通。</p>

<h3>
<span id="vagrantfile" class="fragment"></span><a href="#vagrantfile"><i class="fa fa-link"></i></a>Vagrantfile</h3>

<p>構築する仮装マシンのスペックやプロビジョニングツールの指定など、仮想マシンの構成を記述する。<br>
Rubyベース。<br>
基本的に、本ファイルとプロビジョニングツールの設定ファイルの2つがあれば、どこでも同じ環境を再現できる。</p>

<h2>
<span id="コマンド" class="fragment"></span><a href="#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89"><i class="fa fa-link"></i></a>コマンド</h2>

<h3>
<span id="基本" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC"><i class="fa fa-link"></i></a>基本</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># バージョン確認
$ vagrant -v

# ヘルプ
$ vagrant -h
</pre></div></div>

<h3>
<span id="仮想環境のベースとなるboxファイルを準備" class="fragment"></span><a href="#%E4%BB%AE%E6%83%B3%E7%92%B0%E5%A2%83%E3%81%AE%E3%83%99%E3%83%BC%E3%82%B9%E3%81%A8%E3%81%AA%E3%82%8Bbox%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>仮想環境のベースとなるBoxファイルを準備</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant box add NAME URL
</pre></div></div>

<div class="code-frame" data-lang="sample"><div class="highlight"><pre><span></span># sample
$ vagrant box add centos64 http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20130427.box
（Vagrantfileのconfig.vm.boxディレクトリで指定する。）
</pre></div></div>

<p>BoxファイルはVeeweeで作成することも出来る。<br>
<a href="http://www.ryuzee.com/contents/blog/6614" class="autolink" rel="nofollow noopener" target="_blank">http://www.ryuzee.com/contents/blog/6614</a></p>

<h3>
<span id="box一覧の確認" class="fragment"></span><a href="#box%E4%B8%80%E8%A6%A7%E3%81%AE%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>Box一覧の確認</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant box list
</pre></div></div>

<h3>
<span id="vagrantfileの作成" class="fragment"></span><a href="#vagrantfile%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>Vagrantfileの作成</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant init BOX_NAME
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># sample
$ vagrant init centos64
</pre></div></div>

<h3>
<span id="vagrantfileの設定" class="fragment"></span><a href="#vagrantfile%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Vagrantfileの設定</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">sample.rb</span></div>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span><span class="o">=</span><span class="s2">"centos64"</span>

    <span class="sr">//</span><span class="err">ネットワークの設定</span>
    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span><span class="s2">"192.168.33.10"</span>

    <span class="sr">//</span><span class="no">GUI</span><span class="err">モードの設定</span>
    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>※ホストオンリーネットワーク<br>
　→ホストOSとゲストOS間でのみ通信できるネットワーク。<br>
　　上記では、ゲスト側に192.168.33.10（任意）を割り当てている。</p>

<p>以下は古い書き方。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>誤）config.vm.network :hostonly, "192.168.33.10"
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>正）config.vm.network :private_network, ip:"192.168.33.10"
</pre></div></div>

<h3>
<span id="仮想マシンの起動" class="fragment"></span><a href="#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E8%B5%B7%E5%8B%95"><i class="fa fa-link"></i></a>仮想マシンの起動</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant up
</pre></div></div>

<p>※Vagrantfileと同じディレクトリで実行する</p>

<p>GUIモードにしているとVirtualBoxが起動するので、id/passともに"vagrant"でログイン</p>

<h3>
<span id="sshでログイン" class="fragment"></span><a href="#ssh%E3%81%A7%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>sshでログイン</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant ssh
</pre></div></div>

<p>※仮想マシンにてsshdが起動している必要あり。</p>

<h3>
<span id="通常の方法でssh出来るようにする" class="fragment"></span><a href="#%E9%80%9A%E5%B8%B8%E3%81%AE%E6%96%B9%E6%B3%95%E3%81%A7ssh%E5%87%BA%E6%9D%A5%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>通常の方法でssh出来るようにする。</h3>

<p>Chef Soloをknife-soloで動かすことを見越して、通常のsshアクセス、つまり</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ssh 192.168.33.10
</pre></div></div>

<p>でsshできるようにする。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># ~/.ssh/config
Host 192.168.33.*
IdentityFile ~/.vagrant.d/insecure_private_key
User vagrant
</pre></div></div>

<p>もしくは</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant ssh-config --host melody
</pre></div></div>

<p>で仮想サーバへのssh設定を吐き出してくれるため、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant ssh-config --host melody &gt;&gt; ~/.ssh/config
</pre></div></div>

<p>とすることで</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ssh melody
</pre></div></div>

<p>でログインできるようになる。</p>

<h3>
<span id="sshログイン時の設定確認" class="fragment"></span><a href="#ssh%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E6%99%82%E3%81%AE%E8%A8%AD%E5%AE%9A%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>sshログイン時の設定確認</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant ssh-config
</pre></div></div>

<h3>
<span id="status確認" class="fragment"></span><a href="#status%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>status確認</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant status
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Current machine states:
default                   running (virtualbox)
（仮想マシン名）　　（status）
</pre></div></div>

<h3>
<span id="仮想マシンの停止" class="fragment"></span><a href="#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E5%81%9C%E6%AD%A2"><i class="fa fa-link"></i></a>仮想マシンの停止</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant halt
</pre></div></div>

<h3>
<span id="仮想マシンの削除" class="fragment"></span><a href="#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E5%89%8A%E9%99%A4"><i class="fa fa-link"></i></a>仮想マシンの削除</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant destroy
</pre></div></div>

<h3>
<span id="仮想マシンのエクスポート" class="fragment"></span><a href="#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>仮想マシンのエクスポート</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant package
</pre></div></div>

<p>→package.boxという名前のBoxファイルが生成される。<br>
それを配布し、受け取った側は</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vagrant box add new_box package.box
</pre></div></div>

<p>で利用できる。</p>

<h2>
<span id="vagrantをより便利に" class="fragment"></span><a href="#vagrant%E3%82%92%E3%82%88%E3%82%8A%E4%BE%BF%E5%88%A9%E3%81%AB"><i class="fa fa-link"></i></a>vagrantをより便利に</h2>

<h3>
<span id="sahara" class="fragment"></span><a href="#sahara"><i class="fa fa-link"></i></a>sahara</h3>

<p>saharaを用いると、簡単に仮想マシンの状態保存・ロールバックが出来ます。</p>

<p>saharaでVagrantの状態管理<br>
<a href="http://qiita.com/kidachi_/items/ba365905b2a770c72be1" class="autolink" id="reference-e1ec2122e92826d8c95f">http://qiita.com/kidachi_/items/ba365905b2a770c72be1</a></p>

<h3>
<span id="chef関連" class="fragment"></span><a href="#chef%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>chef関連</h3>

<p>サーバ構成管理ツールといえばchef。</p>

<p>Chefの基本<br>
<a href="http://qiita.com/kidachi_/items/9d569b8673e70ef93f0e" class="autolink" id="reference-72be65dc6ee81cd15506">http://qiita.com/kidachi_/items/9d569b8673e70ef93f0e</a></p>

<p>knife-soloによるChefの実行<br>
<a href="http://qiita.com/kidachi_/items/b222fb2892e6108c46d5" class="autolink" id="reference-37e57e9cc006bba50b99">http://qiita.com/kidachi_/items/b222fb2892e6108c46d5</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>550</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/07637a5baa0da7d52e6a">sar(sysstat)によるボトルネック特定</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-24 23:32:37</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Linux]</b> <b>[インフラ]</b> <b>[sar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="sarsysstatとは" class="fragment"></span><a href="#sarsysstat%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>sar(sysstat)とは</h2>

<p>LoadAverageやCPU使用率、ディスクI/Oの状態を表示できるコマンド。<br>
何より便利なのは、過去にさかのぼれる点。</p>

<h2>
<span id="sarのインストール" class="fragment"></span><a href="#sar%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>sarのインストール</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># yum install sysstat
</pre></div></div>

<p>インストールすると、ログを取り始めます。</p>

<h2>
<span id="sarのログ取得間隔の変更" class="fragment"></span><a href="#sar%E3%81%AE%E3%83%AD%E3%82%B0%E5%8F%96%E5%BE%97%E9%96%93%E9%9A%94%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fa fa-link"></i></a>sarのログ取得間隔の変更</h2>

<p>/etc/cron.d/sysstat を編集します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$sudo vi /etc/cron.d/sysstat 
# run system activity accounting tool every 10 minutes
*/10 * * * * root /usr/lib64/sa/sa1 1 1
</pre></div></div>

<p>デフォルト10分間隔（*/10）になっているので、好みの間隔に変更。</p>

<h2>
<span id="主要コマンド一覧" class="fragment"></span><a href="#%E4%B8%BB%E8%A6%81%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>主要コマンド一覧</h2>

<table>
<thead>
<tr>
<th style="text-align: left">コマンド</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">sar -q</td>
<td>loadaverage</td>
</tr>
<tr>
<td style="text-align: left">sar -u</td>
<td>CPU使用率</td>
</tr>
<tr>
<td style="text-align: left">sar -b</td>
<td>I/O</td>
</tr>
<tr>
<td style="text-align: left">sar -r</td>
<td>メモリとスワップ使用率</td>
</tr>
<tr>
<td style="text-align: left">sar -s time</td>
<td>指定時間以降のデータ</td>
</tr>
<tr>
<td style="text-align: left">sar -e time</td>
<td>指定時間までのデータ</td>
</tr>
<tr>
<td style="text-align: left">sar -f /var/log/sa/sa01</td>
<td>日付別の過去データ</td>
</tr>
</tbody>
</table>

<h2>
<span id="-qでloadaverageをチェック" class="fragment"></span><a href="#-q%E3%81%A7loadaverage%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>-qでLoadAverageをチェック</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ sar -q -s <span class="m">21</span>:00:00
<span class="m">21</span>時00分01秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15
<span class="m">21</span>時05分01秒         <span class="m">1</span>       <span class="m">203</span>      <span class="m">0</span>.19      <span class="m">0</span>.20      <span class="m">0</span>.16
<span class="m">21</span>時10分01秒         <span class="m">0</span>       <span class="m">203</span>      <span class="m">0</span>.21      <span class="m">0</span>.18      <span class="m">0</span>.17
<span class="m">21</span>時15分01秒         <span class="m">2</span>       <span class="m">209</span>      <span class="m">0</span>.11      <span class="m">0</span>.18      <span class="m">0</span>.17
<span class="m">21</span>時20分01秒         <span class="m">1</span>       <span class="m">208</span>      <span class="m">0</span>.38      <span class="m">0</span>.20      <span class="m">0</span>.18
<span class="m">21</span>時25分01秒         <span class="m">0</span>       <span class="m">210</span>      <span class="m">0</span>.10      <span class="m">0</span>.20      <span class="m">0</span>.18
平均値:          <span class="m">1</span>       <span class="m">207</span>      <span class="m">0</span>.20      <span class="m">0</span>.19      <span class="m">0</span>.17
</pre></div></div>

<p>ldavg-xが、過去x分間のLoadAverageを示します。</p>

<h2>
<span id="loadaverageの上昇が見られたら" class="fragment"></span><a href="#loadaverage%E3%81%AE%E4%B8%8A%E6%98%87%E3%81%8C%E8%A6%8B%E3%82%89%E3%82%8C%E3%81%9F%E3%82%89"><i class="fa fa-link"></i></a>LoadAverageの上昇が見られたら</h2>

<p>基本的に、</p>

<ul>
<li>CPU負荷（プロセス不足）</li>
<li>I/O負荷</li>
</ul>

<p>のどちらかに切り分けられます。</p>

<h2>
<span id="-uでcpu使用率をチェック" class="fragment"></span><a href="#-u%E3%81%A7cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>-uでCPU使用率をチェック</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ sar -u -s <span class="m">21</span>:00:00

<span class="m">21</span>時00分01秒       CPU     %user     %nice   %system   %iowait    %steal     %idle
<span class="m">21</span>時05分01秒       all     <span class="m">11</span>.42      <span class="m">0</span>.00      <span class="m">3</span>.89      <span class="m">0</span>.16      <span class="m">0</span>.00     <span class="m">84</span>.52
<span class="m">21</span>時10分01秒       all     <span class="m">11</span>.32      <span class="m">0</span>.00      <span class="m">3</span>.44      <span class="m">0</span>.45      <span class="m">0</span>.00     <span class="m">84</span>.79
<span class="m">21</span>時15分01秒       all     <span class="m">10</span>.74      <span class="m">0</span>.00      <span class="m">3</span>.41      <span class="m">0</span>.20      <span class="m">0</span>.00     <span class="m">85</span>.64
<span class="m">21</span>時20分01秒       all     <span class="m">10</span>.26      <span class="m">0</span>.00      <span class="m">3</span>.29      <span class="m">0</span>.13      <span class="m">0</span>.00     <span class="m">86</span>.32
<span class="m">21</span>時25分01秒       all     <span class="m">10</span>.81      <span class="m">0</span>.00      <span class="m">3</span>.60      <span class="m">0</span>.15      <span class="m">0</span>.00     <span class="m">85</span>.44
<span class="m">21</span>時30分01秒       all      <span class="m">9</span>.41      <span class="m">0</span>.00      <span class="m">3</span>.03      <span class="m">0</span>.17      <span class="m">0</span>.00     <span class="m">87</span>.39
平均値:        all     <span class="m">10</span>.66      <span class="m">0</span>.00      <span class="m">3</span>.44      <span class="m">0</span>.21      <span class="m">0</span>.00     <span class="m">85</span>.68

</pre></div></div>

<p>sar -uは、CPUがどのようなモードになっていたのか、<br>
それぞれのモードの割合を示してくれる。</p>

<table>
<thead>
<tr>
<th style="text-align: left">モード</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">%user</td>
<td>アプリケーション（ユーザプロセス）が使用している状態</td>
</tr>
<tr>
<td style="text-align: left">%system</td>
<td>カーネル（OSなど）が使用している状態</td>
</tr>
<tr>
<td style="text-align: left">%iowait</td>
<td>ディスクI/O待ち状態</td>
</tr>
<tr>
<td style="text-align: left">%idle</td>
<td>CPUが何の処理もしない待機状態（I/O待ちの時間は除く）</td>
</tr>
</tbody>
</table>

<p>※steal、niceは省きます。詳細は下部の参考を参照ください。</p>

<h2>
<span id="sar--u-から分かること" class="fragment"></span><a href="#sar--u-%E3%81%8B%E3%82%89%E5%88%86%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>sar -u から分かること</h2>

<h4>
<span id="userかsystemが高いとcpuボトルネックもしくはメモリ不足" class="fragment"></span><a href="#user%E3%81%8Bsystem%E3%81%8C%E9%AB%98%E3%81%84%E3%81%A8cpu%E3%83%9C%E3%83%88%E3%83%AB%E3%83%8D%E3%83%83%E3%82%AF%E3%82%82%E3%81%97%E3%81%8F%E3%81%AF%E3%83%A1%E3%83%A2%E3%83%AA%E4%B8%8D%E8%B6%B3"><i class="fa fa-link"></i></a>%userか%systemが高いと・・・CPUボトルネック（もしくはメモリ不足）</h4>

<p>（%userならアプリケーション側。%systemならカーネル側。）</p>

<h4>
<span id="iowaitが高いとディスクioボトルネック" class="fragment"></span><a href="#iowait%E3%81%8C%E9%AB%98%E3%81%84%E3%81%A8%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AFio%E3%83%9C%E3%83%88%E3%83%AB%E3%83%8D%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>%iowaitが高いと・・・ディスクI/Oボトルネック。</h4>

<h2>
<span id="-bでディスクio状況をチェック" class="fragment"></span><a href="#-b%E3%81%A7%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AFio%E7%8A%B6%E6%B3%81%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>-bでディスクI/O状況をチェック</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sar -b -s 21:00:00
21時00分01秒       tps      rtps      wtps   bread/s   bwrtn/s
21時05分01秒     15.67      0.00     15.67      0.00    363.44
21時10分01秒     15.42      0.00     15.42      0.00    389.58
21時15分01秒     16.25      0.00     16.25      0.00    355.18
21時20分01秒     13.50      0.00     13.50      0.00    313.71
21時25分01秒     15.98      0.00     15.97      0.05    351.94
21時30分01秒     14.43      0.00     14.43      0.00    313.95
21時35分01秒     13.22      0.00     13.22      0.00    296.66
</pre></div></div>

<table>
<thead>
<tr>
<th style="text-align: left">項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">tps</td>
<td>秒間I/Oリクエスト 数の合計。</td>
</tr>
<tr>
<td style="text-align: left">rtps</td>
<td>秒間読み込みIOリクエスト数の合計。</td>
</tr>
<tr>
<td style="text-align: left">wtps</td>
<td>秒間書き込みIOリクエスト数の合計。</td>
</tr>
<tr>
<td style="text-align: left">bread/s</td>
<td>秒間読み込み（ブロック単位）IOリクエストのデータ量の合計。</td>
</tr>
<tr>
<td style="text-align: left">bwrtn/s</td>
<td>秒間書き込み（ブロック単位）IOリクエストのデータ量の合計。</td>
</tr>
</tbody>
</table>

<h2>
<span id="-rでメモリとスワップの使用状況をチェック" class="fragment"></span><a href="#-r%E3%81%A7%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%A8%E3%82%B9%E3%83%AF%E3%83%83%E3%83%97%E3%81%AE%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%B3%81%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>-rでメモリとスワップの使用状況をチェック</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sar -r -s 21:00:00
21時00分01秒 kbmemfree kbmemused  %memused kbbuffers  kbcached kbswpfree kbswpused  %swpused  kbswpcad
21時05分01秒    655456   3388400     83.79    254316   1595220   2152620        80      0.00         0
21時10分01秒    642676   3401180     84.11    254364   1596728   2152620        80      0.00         0
21時15分01秒    598616   3445240     85.20    254376   1598160   2152620        80      0.00         0
21時20分01秒    598744   3445112     85.19    254388   1599628   2152620        80      0.00         0
21時25分01秒    681552   3362304     83.15    254396   1601256   2152620        80      0.00         0
21時30分01秒    548508   3495348     86.44    254416   1602084   2152620        80      0.00         0
</pre></div></div>

<p>重要なのは以下でしょうか。</p>

<table>
<thead>
<tr>
<th style="text-align: left">項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">kbmemfree</td>
<td>メモリ空き容量(kb)</td>
</tr>
<tr>
<td style="text-align: left">kbmemused</td>
<td>メモリ使用量(kb)</td>
</tr>
<tr>
<td style="text-align: left">%memused</td>
<td>メモリ使用率</td>
</tr>
<tr>
<td style="text-align: left">kbswpfree</td>
<td>スワップ空き容量(kb)</td>
</tr>
<tr>
<td style="text-align: left">kbswpused</td>
<td>スワップ使用量(kb)</td>
</tr>
<tr>
<td style="text-align: left">%swpused</td>
<td>スワップ使用率</td>
</tr>
</tbody>
</table>

<h2>
<span id="過去データを日時指定して実行" class="fragment"></span><a href="#%E9%81%8E%E5%8E%BB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E6%97%A5%E6%99%82%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%A6%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>過去データを日時指定して実行</h2>

<p>例えば当月15日の23:30以降のデータを見たい時は・・</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sar -u  -s 23:30:00 -f /var/log/sa/sa15

23時30分01秒       CPU     %user     %nice   %system   %iowait    %steal     %idle
23時35分01秒       all      7.20      0.00      2.39      0.17      0.00     90.24
23時40分01秒       all      8.35      0.00      2.65      0.12      0.00     88.89
23時45分01秒       all      6.76      0.00      2.31      0.10      0.00     90.83
23時50分01秒       all      7.27      0.00      2.36      0.12      0.00     90.25
23時55分01秒       all      8.18      0.00      2.66      0.12      0.00     89.03
平均値:        all      7.55      0.00      2.47      0.12      0.00     89.85
</pre></div></div>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>sarコマンド - CPU・ネットワーク・メモリ・ディスク情報確認<br>
<a href="http://www.syboos.jp/linux/doc/sar-command.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.syboos.jp/linux/doc/sar-command.html</a></p>

<p>sarコマンドの見方<br>
<a href="http://linux.alohakeakua.net/archives/488" class="autolink" rel="nofollow noopener" target="_blank">http://linux.alohakeakua.net/archives/488</a></p>

<p>CPU利用率: stealとは<br>
<a href="http://d.hatena.ne.jp/mir/20080407/p1" class="autolink" rel="nofollow noopener" target="_blank">http://d.hatena.ne.jp/mir/20080407/p1</a></p>

<p>nice：優先順位を上げてプログラムを実行する<br>
<a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20060228/231193/" class="autolink" rel="nofollow noopener" target="_blank">http://itpro.nikkeibp.co.jp/article/COLUMN/20060228/231193/</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>496</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/46a6e49b6306655ccd64">便利なRubyイディオム</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-18 10:42:58</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="rubyならこう書くあれこれ" class="fragment"></span><a href="#ruby%E3%81%AA%E3%82%89%E3%81%93%E3%81%86%E6%9B%B8%E3%81%8F%E3%81%82%E3%82%8C%E3%81%93%E3%82%8C"><i class="fa fa-link"></i></a>「Rubyならこう書く」あれこれ</h2>

<ul>
<li>Arrayオブジェクト</li>
<li>Rangeオブジェクト</li>
<li>ブロックとProcオブジェクト</li>
<li>シンボルとハッシュ</li>
<li>クラスとコンストラクタ</li>
</ul>

<p>（追記）<br>
ブロックとProcオブジェクトについては、長くなったので以下に分離しました。</p>

<p>[Ruby基礎] ブロックとProcをちゃんと理解する<br>
<a href="http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2" class="autolink" id="reference-846e42bf13842fcdf72a">http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2</a></p>

<h2>
<span id="配列array" class="fragment"></span><a href="#%E9%85%8D%E5%88%97array"><i class="fa fa-link"></i></a>配列（Array）</h2>

<h4>
<span id="要素の操作" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E6%93%8D%E4%BD%9C"><i class="fa fa-link"></i></a>要素の操作</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span>
<span class="c1">#配列要素の分割</span>
<span class="o">&gt;</span> <span class="s2">"foo bar bazz"</span><span class="o">.</span><span class="n">split</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"bazz"</span><span class="o">]</span>

<span class="c1">#配列要素の指定文字列での分割</span>
<span class="o">&gt;</span> <span class="s2">"fooxbarxxxxbazz"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="s2">"bazz"</span><span class="o">]</span>

<span class="c1">#配列要素の順番入れ替え</span>
<span class="o">&gt;</span> <span class="s2">"foo bar bazz"</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">reverse</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"bazz"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"foo"</span><span class="o">]</span>

<span class="c1">#配列要素の順番入れ替え</span>
<span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">"foo bar bazz"</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">shuffle</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bazz"</span><span class="o">]</span>

</pre></div></div>

<h4>
<span id="要素の追加" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>要素の追加</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#配列要素の追加</span>
<span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bazz"</span><span class="p">,</span> <span class="mi">8</span><span class="o">]</span>

<span class="c1">#配列要素の追加2</span>
<span class="o">&gt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bazz"</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="o">]</span>

<span class="c1">#配列要素の追加3（chain）</span>
<span class="o">&gt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s1">'fuga'</span> <span class="o">&lt;&lt;</span> <span class="s1">'moga'</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bazz"</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">"fuga"</span><span class="p">,</span> <span class="s2">"moga"</span><span class="o">]</span>

<span class="c1">#配列要素の結合</span>
<span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">join</span>
<span class="o">=&gt;</span> <span class="s2">"barfoobazz810fugamoga"</span>

<span class="c1">#配列要素の結合2</span>
<span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"bar, foo, bazz, 8, 10, fuga, moga"</span>

</pre></div></div>

<h2>
<span id="範囲range" class="fragment"></span><a href="#%E7%AF%84%E5%9B%B2range"><i class="fa fa-link"></i></a>範囲（Range）</h2>

<h4>
<span id="範囲から配列生成" class="fragment"></span><a href="#%E7%AF%84%E5%9B%B2%E3%81%8B%E3%82%89%E9%85%8D%E5%88%97%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>範囲から配列生成</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#「.」2つで後方の要素（9）を含む</span>
<span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="o">]</span>

<span class="c1">#「.」3つで後方の要素（9）は含まない</span>
<span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="o">...</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="o">]</span>
</pre></div></div>

<h4>
<span id="配列要素を範囲で指定して取得" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E8%A6%81%E7%B4%A0%E3%82%92%E7%AF%84%E5%9B%B2%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%A6%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>配列要素を範囲で指定して取得</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#文字列を配列に変換</span>
<span class="o">&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="sx">%w[foo bar baz fuga moga]</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"baz"</span><span class="p">,</span> <span class="s2">"fuga"</span><span class="p">,</span> <span class="s2">"moga"</span><span class="o">]</span>

<span class="c1">#配列から指定範囲を取り出す</span>
<span class="o">&gt;</span> <span class="n">b</span><span class="o">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"baz"</span><span class="o">]</span>

</pre></div></div>

<h4>
<span id="配列要素を範囲で指定して取得2" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E8%A6%81%E7%B4%A0%E3%82%92%E7%AF%84%E5%9B%B2%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%A6%E5%8F%96%E5%BE%972"><i class="fa fa-link"></i></a>配列要素を範囲で指定して取得2</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#配列へ変換</span>
<span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="o">]</span>

<span class="c1">#配列の最後の要素指定</span>
<span class="o">&gt;</span> <span class="n">c</span><span class="o">[</span><span class="mi">5</span><span class="o">..</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="o">]</span>

<span class="c1">#配列の最後の要素指定2</span>
<span class="o">&gt;</span> <span class="n">c</span><span class="o">[</span><span class="mi">5</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="o">]</span>

</pre></div></div>

<h4>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#範囲は文字列に対しても利用出来る</span>
<span class="o">&gt;</span> <span class="p">(</span><span class="s1">'a'</span><span class="o">..</span><span class="s1">'e'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">,</span> <span class="s2">"d"</span><span class="p">,</span> <span class="s2">"e"</span><span class="o">]</span>
</pre></div></div>

<h2>
<span id="ブロック" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>ブロック</h2>

<p>分かりづらかったので少し丁寧に。</p>

<ul>
<li>ブロックとは何か</li>
<li>yield、Procとは何か</li>
<li>Proc補足</li>
<li>で、ブロックやProcって何が嬉しいの？</li>
</ul>

<p>の順でいきます。</p>

<p>（追記）<br>
本項は以下を参照。</p>

<p>[Ruby基礎] ブロックとProcをちゃんと理解する<br>
<a href="http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2" class="autolink">http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2</a></p>

<h2>
<span id="シンボル" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB"><i class="fa fa-link"></i></a>シンボル</h2>

<p>文字列と近いが、少々性質が異なる。<br>
内部的な比較の際、文字列は1文字ずつ比べる必要があるが、<br>
シンボルは一度に全体を比較可能。<br>
→ハッシュ等のキーとして理想的な性質。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1">#文字列は分割できる</span>
<span class="o">&gt;&gt;</span> <span class="s2">"name"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"n"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"e"</span><span class="o">]</span>
<span class="c1">#シンボルは分割できない</span>
<span class="o">&gt;&gt;</span> <span class="ss">:name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="ss">NoMethodError</span><span class="p">:</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`split' for :name:Symbol</span>

<span class="sb">#文字列は（分割して）reverseできる</span>
<span class="sb">&gt;&gt; "foobar".reverse</span>
<span class="sb">=&gt; "raboof"</span>
<span class="sb">#シンボルは（分割して）reverseできない</span>
<span class="sb">&gt;&gt; :foobar.reverse</span>
<span class="sb">NoMethodError: undefined method `</span><span class="n">reverse</span><span class="err">'</span> <span class="k">for</span> <span class="ss">:foobar:Symbol</span>
</pre></div></div>

<p>Ruby 1.9以降では、シンボルをキーとして扱う場合の特別な記法をサポート。<br>
以下の二つは同義。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="ss">:hoge</span> <span class="o">=&gt;</span> <span class="s1">'hoge'</span><span class="p">,</span> <span class="ss">:fuga</span> <span class="o">=&gt;</span> <span class="s1">'fuga'</span><span class="p">}</span>
<span class="p">{</span> <span class="ss">hoge</span><span class="p">:</span> <span class="s1">'hoge'</span><span class="p">,</span> <span class="ss">fuga</span><span class="p">:</span> <span class="s1">'fuga'</span><span class="p">}</span>
</pre></div></div>

<p>よって以下二つも同義。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"hogefuga"</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">"foo@example.com"</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:name</span><span class="o">=&gt;</span><span class="s2">"hogefuga"</span><span class="p">,</span> <span class="ss">:email</span><span class="o">=&gt;</span><span class="s2">"foo@example.com"</span><span class="p">}</span>

<span class="o">&gt;&gt;</span> <span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"hogefuga"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@example.com"</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:name</span><span class="o">=&gt;</span><span class="s2">"hogefuga"</span><span class="p">,</span> <span class="ss">:email</span><span class="o">=&gt;</span><span class="s2">"foo@example.com"</span><span class="p">}</span>

<span class="o">&gt;&gt;</span> <span class="n">h1</span> <span class="o">==</span> <span class="n">h2</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>

<p>ハッシュがよりスムーズに記述できる。</p>

<h4>
<span id="ハッシュをブロックに渡す" class="fragment"></span><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AB%E6%B8%A1%E3%81%99"><i class="fa fa-link"></i></a>ハッシュをブロックに渡す</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success</span><span class="p">:</span> <span class="s2">"It worked!"</span><span class="p">,</span> <span class="ss">error</span><span class="p">:</span> <span class="s2">"It failed."</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:success</span><span class="o">=&gt;</span><span class="s2">"It worked!"</span><span class="p">,</span> <span class="ss">:error</span><span class="o">=&gt;</span><span class="s2">"It failed."</span><span class="p">}</span>

<span class="o">&gt;&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="o">&gt;&gt;</span>   <span class="nb">puts</span> <span class="s2">"Key </span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> has value </span><span class="si">#{</span><span class="n">value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">"</span>
<span class="o">&gt;&gt;</span> <span class="k">end</span>
<span class="no">Key</span> <span class="ss">:success</span> <span class="n">has</span> <span class="n">value</span> <span class="s2">"It worked!"</span>
<span class="no">Key</span> <span class="ss">:error</span> <span class="n">has</span> <span class="n">value</span> <span class="s2">"It failed."</span>
</pre></div></div>

<p>→ブロックにはkeyとvalueの二つが渡ることになる。</p>

<p>※inspectはオブジェクトを可視化して返す<br>
inspectを用いない場合、</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="o">&gt;&gt;</span>   <span class="nb">puts</span> <span class="s2">"Key </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2"> has value </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
<span class="o">&gt;&gt;</span> <span class="k">end</span>
<span class="no">Key</span> <span class="n">success</span> <span class="n">has</span> <span class="n">value</span> <span class="no">It</span> <span class="n">worked!</span>
<span class="no">Key</span> <span class="n">error</span> <span class="n">has</span> <span class="n">value</span> <span class="no">It</span> <span class="n">failed</span><span class="o">.</span>
</pre></div></div>

<p>こうなる。</p>

<h2>
<span id="railsに現れるruby" class="fragment"></span><a href="#rails%E3%81%AB%E7%8F%BE%E3%82%8C%E3%82%8Bruby"><i class="fa fa-link"></i></a>Railsに現れるRuby</h2>

<p>上のハッシュの知識をもとに、Rails内で使うRubyの記述を読み解いてみる。</p>

<h4>
<span id="cssを出力するタグの例" class="fragment"></span><a href="#css%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B0%E3%81%AE%E4%BE%8B"><i class="fa fa-link"></i></a>cssを出力するタグの例</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="sx">%= stylesheet_link_tag "application", media: "all",</span>
<span class="sx">                                       "data-turbolinks-track" =</span><span class="o">&gt;</span> <span class="kp">true</span> <span class="o">%&gt;</span>
</pre></div></div>

<p>いくつか特徴がある。</p>

<ol>
<li>メソッド呼び出しの丸かっこは省略可能。
→以下は同義</li>
</ol>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">stylesheet_link_tag</span><span class="p">(</span><span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>

<ol>
<li>最後の引数がハッシュの場合、波括弧は省略可能。
→以下は同義</li>
</ol>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="p">{</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                     <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>

<ol>
<li>シンボルではハイフンを使用できない
（mediaは「media:」という新式の記法なのに、data-turbolinks-trackは
「"data-turbolinks-track" =&gt;」という旧式記法である理由）</li>
</ol>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">-</span><span class="n">turbolinks</span><span class="o">-</span><span class="ss">track</span><span class="p">:</span> <span class="kp">true</span>  <span class="c1">#NG。シンボルではハイフンを使用できない</span>
<span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>  <span class="c1">#OK</span>
</pre></div></div>

<h4>
<span id="結果出力されるタグ" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%82%8B%E3%82%BF%E3%82%B0"><i class="fa fa-link"></i></a>結果、出力されるタグ</h4>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">data-turbolinks-track</span><span class="o">=</span><span class="s">"true"</span> <span class="na">href</span><span class="o">=</span><span class="s">"/assets/application.css"</span> <span class="na">media</span><span class="o">=</span><span class="s">"all"</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="p">/&gt;</span>
</pre></div></div>

<h2>
<span id="クラスとコンストラクタ" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF"><i class="fa fa-link"></i></a>クラスとコンストラクタ</h2>

<h4>
<span id="string" class="fragment"></span><a href="#string"><i class="fa fa-link"></i></a>String</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">"hoge"</span>
<span class="o">=&gt;</span> <span class="s2">"hoge"</span>

<span class="c1">#明示的な書き方</span>
<span class="o">&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"hoge"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"hoge"</span>
</pre></div></div>

<h4>
<span id="array" class="fragment"></span><a href="#array"><i class="fa fa-link"></i></a>Array</h4>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>

<span class="c1">#明示的な書き方</span>
<span class="o">&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
</pre></div></div>

<h4>
<span id="hash--コンストラクタが特殊" class="fragment"></span><a href="#hash--%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%8C%E7%89%B9%E6%AE%8A"><i class="fa fa-link"></i></a>Hash =&gt; コンストラクタが特殊</h4>

<p>hashのコンストラクタに値を渡した場合、<br>
「キーが存在しない場合に返されるデフォルト値」として定義される。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># 何も値を渡さずに初期化</span>
<span class="o">&gt;&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
<span class="o">=&gt;</span> <span class="p">{}</span>
<span class="o">&gt;&gt;</span> <span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>            <span class="c1"># 存在しないキー :foo</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>  <span class="c1"># キーが存在しない場合のデフォルト値はnil</span>

<span class="c1"># 値を渡して初期化</span>
<span class="o">&gt;&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># デフォルト値をnilから0に変更</span>
<span class="o">=&gt;</span> <span class="p">{}</span>
<span class="o">&gt;&gt;</span> <span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="mi">0</span>    <span class="c1"># キーが存在しない場合のデフォルト値は0</span>
</pre></div></div>

<h2>
<span id="module" class="fragment"></span><a href="#module"><i class="fa fa-link"></i></a>Module</h2>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">ApplicationHelper</span>
</pre></div></div>

<p>通常（生のRuby）では、moduleはincludeを使い呼び出す（MixidIn）ことができる。</p>

<p>が、Railsは自動で呼び出してくれるため、定義さえすれば全てのViewで利用することが出来る。</p>

<h2>
<span id="もう一歩踏み込むならこちら" class="fragment"></span><a href="#%E3%82%82%E3%81%86%E4%B8%80%E6%AD%A9%E8%B8%8F%E3%81%BF%E8%BE%BC%E3%82%80%E3%81%AA%E3%82%89%E3%81%93%E3%81%A1%E3%82%89"><i class="fa fa-link"></i></a>もう一歩踏み込むならこちら</h2>

<p>[Ruby] 便利な組み込みクラスのメソッド達<br>
Enumerable編<br>
<a href="http://qiita.com/kidachi_/items/a00558cfb0a6a3e23f4b" class="autolink" id="reference-a2411f2c23a708ef9879">http://qiita.com/kidachi_/items/a00558cfb0a6a3e23f4b</a><br>
Array編<br>
<a href="http://qiita.com/kidachi_/items/e9cb26c4e6cb36b70a1c" class="autolink" id="reference-b3e012d9e30cfe3f36e7">http://qiita.com/kidachi_/items/e9cb26c4e6cb36b70a1c</a><br>
Hash編<br>
<a href="http://qiita.com/kidachi_/items/651b5b5580be40ad047e" class="autolink" id="reference-807633ba710f3938ec52">http://qiita.com/kidachi_/items/651b5b5580be40ad047e</a><br>
String編<br>
<a href="http://qiita.com/kidachi_/items/7b355eb355b2d1390cf5" class="autolink" id="reference-560a2a29979a36c14f93">http://qiita.com/kidachi_/items/7b355eb355b2d1390cf5</a></p>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>[Ruby基礎] ブロックとProcをちゃんと理解する<br>
<a href="http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2" class="autolink">http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />5位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>266</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/cd63063fa98aaa5030bd">TwilioとRailsで、1通1円のSMS認証を実装してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-05 22:55:38</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[twilio]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="3行まとめ" class="fragment"></span><a href="#3%E8%A1%8C%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>3行まとめ</h2>

<ul>
<li>Twilioなら、自分だけの電話番号を簡単取得。</li>
<li>SMS受信のタイミングで任意のAPIをキックしてくれます。送信者の情報も取得できるので、それを用いて認証機能を実現。</li>
<li>コストは1通（1認証）あたり1円！（ただし最初にチャージが必要なので初期投資2000円から）</li>
</ul>

<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<h3>
<span id="sms認証とは" class="fragment"></span><a href="#sms%E8%AA%8D%E8%A8%BC%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>SMS認証とは</h3>

<p>ユーザ登録を行うメディアにおいて、<br>
不正なユーザ（いわゆる複アカなど）の防止策として有効な対策の一つです。</p>

<p>例えばこちら等。<br>
FullCourt<br>
<a href="https://www.fullcourt.co/ja/docs/samplecode/smsauthentication" class="autolink" rel="nofollow noopener" target="_blank">https://www.fullcourt.co/ja/docs/samplecode/smsauthentication</a></p>

<p>ざっくり言うと、</p>

<ol>
<li>ユーザは認証画面で電話番号を入力</li>
<li>メディアサーバは、SMS認証サービスへSMS送信依頼</li>
<li>SMS認証サービスはユーザのスマホ/携帯電話にSMSを送信</li>
<li>ユーザはSMSで送られてきた認証トークン（パスワード）を見て、認証画面に入力</li>
<li>サーバはユーザからの入力内容と、SMS送信時にDBに保管しておいたトークンを突き合わせ、認証</li>
</ol>

<p><a href="https://camo.qiitausercontent.com/92ab7e820646ceeac3498a2420e5f09827fc7206/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f37633831366332382d323962352d393237372d383162332d6662633331393862623439392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/92ab7e820646ceeac3498a2420e5f09827fc7206/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f37633831366332382d323962352d393237372d383162332d6662633331393862623439392e706e67" alt="スクリーンショット_2014_02_04_9_45.png" title="スクリーンショット_2014_02_04_9_45.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/7c816c28-29b5-9277-81b3-fbc3198bb499.png"></a></p>

<p>こんな流れです。<br>
電話番号が取得出来るので、以後の複アカを防ぐこともできます。</p>

<p>導入事例の有名どころだとアメーバピグさん等。<br>
【お知らせ】SMS認証について<br>
<a href="http://ameblo.jp/pigg-staff/entry-11522530986.html" class="autolink" rel="nofollow noopener" target="_blank">http://ameblo.jp/pigg-staff/entry-11522530986.html</a></p>

<p>ですが、実際の導入にはなかなかのネックが存在します。</p>

<h3>
<span id="問題は" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E3%81%AF"><i class="fa fa-link"></i></a>問題は・・</h3>

<p>コスト。<br>
1通（1認証）10円前後が相場だと思います。<br>
上記のFullCourtさんだと<a href="https://www.fullcourt.co/ja/sms" rel="nofollow noopener" target="_blank">8円／日本国内1通</a>とのことでした。</p>

<p>けっこうなお値段ですが、SMS送信自体の価格を各キャリアが定めているので、<br>
どうしても最低限そこはコストとなってしまいます。</p>

<h3>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h3>

<p>ということで、今回は電話・SMSを気軽に開発者が扱えるサービスTwilioを使って<br>
もっと安く仕上げられそうな仕組みを実装してみました。</p>

<h2>
<span id="twilioとは" class="fragment"></span><a href="#twilio%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Twilioとは</h2>

<p>電話やSMSを扱えるAPIサービス。<br>
<a href="http://twilio.kddi-web.com/" class="autolink" rel="nofollow noopener" target="_blank">http://twilio.kddi-web.com/</a><br>
シリコンバレーの企業のサービスですが、日本ではKDDIが<br>
代理店になっており、国内でも気軽に扱えます。</p>

<h3>
<span id="価格" class="fragment"></span><a href="#%E4%BE%A1%E6%A0%BC"><i class="fa fa-link"></i></a>価格</h3>

<p>料金（Price）<br>
<a href="http://twilio.kddi-web.com/price/index.html" class="autolink" rel="nofollow noopener" target="_blank">http://twilio.kddi-web.com/price/index.html</a></p>

<p>最初の表の下の方ですね。<br>
送信料はやはり10円弱（Softbankだけ安いですが）。<br>
しかし、<strong>受信料は1円</strong>です。</p>

<p>ということで、<strong>受信のみで成り立つSMS認証</strong>を考えてみたいと思います。</p>

<h2>
<span id="受信型認証のイメージ" class="fragment"></span><a href="#%E5%8F%97%E4%BF%A1%E5%9E%8B%E8%AA%8D%E8%A8%BC%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>受信型認証のイメージ</h2>

<p>これでどうでしょう。</p>

<ol>
<li>認証画面で、ユーザに電話番号とユーザ識別ID、認証トークン（パスワード）を表示</li>
<li>ユーザはスマホ/携帯電話から、指定の電話番号宛に、ユーザ識別IDと認証トークンをSMS送信</li>
<li>TwilioサーバはMediaAPIをキック</li>
<li>サーバはTwilioから渡された認証トークンより、ユーザを認証。</li>
</ol>

<p><a href="https://camo.qiitausercontent.com/c0a28cdeca38a302a84e1968548e4736a0304c9b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62396161336139392d643937352d326534352d363333322d3764366636313935313865372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c0a28cdeca38a302a84e1968548e4736a0304c9b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62396161336139392d643937352d326534352d363333322d3764366636313935313865372e706e67" alt="スクリーンショット_2014_02_04_9_42.png" title="スクリーンショット_2014_02_04_9_42.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/b9aa3a99-d975-2e45-6332-7d6f619518e7.png"></a></p>

<p>2の部分が<strong>受信</strong>になっていますね。これなら<strong>1通（1認証）1円</strong>です！</p>

<p>ということで、こちらで実装をすすめていきます。</p>

<h2>
<span id="twilioアカウントの作成と電話番号の取得" class="fragment"></span><a href="#twilio%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90%E3%81%A8%E9%9B%BB%E8%A9%B1%E7%95%AA%E5%8F%B7%E3%81%AE%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>Twilioアカウントの作成と電話番号の取得</h2>

<p>まずは、以下記事を参考にアカウントの作成を行います。</p>

<p>Twilio（トゥイリオ）を触ってみた<br>
<a href="http://www.casleyconsulting.co.jp/blog-engineer/twilio/twilio%EF%BC%88%E3%83%88%E3%82%A5%E3%82%A4%E3%83%AA%E3%82%AA%EF%BC%89%E3%82%92%E8%A7%A6%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F/" class="autolink" rel="nofollow noopener" target="_blank">http://www.casleyconsulting.co.jp/blog-engineer/twilio/twilio%EF%BC%88%E3%83%88%E3%82%A5%E3%82%A4%E3%83%AA%E3%82%AA%EF%BC%89%E3%82%92%E8%A7%A6%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F/</a></p>

<p>記事内までで、トライアルの電話番号で電話利用ができるようになりますが、<br>
<strong>SMSは利用できません。</strong></p>

<p>次はSMSを利用できる電話番号を取得します。</p>

<h2>
<span id="sms用電話番号の取得" class="fragment"></span><a href="#sms%E7%94%A8%E9%9B%BB%E8%A9%B1%E7%95%AA%E5%8F%B7%E3%81%AE%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>SMS用電話番号の取得</h2>

<p>注：ここからはお金がかかります！<br>
（電話番号維持費は月1ドル。ただしはじめに2000円のチャージが必要なため、実質2000円）</p>

<p>※有料アカウントの体系を詳しく知っておきたい方は一度以下に目を通しておくと良いかもしれません。<br>
よくある質問(FAQ)/課金 &amp; 料金<br>
<a href="https://twilioforkwc.zendesk.com/forums/22006727-%E8%AA%B2%E9%87%91-%E6%96%99%E9%87%91" class="autolink" rel="nofollow noopener" target="_blank">https://twilioforkwc.zendesk.com/forums/22006727-%E8%AA%B2%E9%87%91-%E6%96%99%E9%87%91</a></p>

<p>それでは行きましょう。<br>
まず、「電話番号」のページから、「電話番号を購入」をクリック。</p>

<p><a href="https://camo.qiitausercontent.com/21ea0ac0780cdcacdd0a66161ed873c8c68239ed/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f34313362336433342d663564332d343464342d306430372d6131393230323438303563312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/21ea0ac0780cdcacdd0a66161ed873c8c68239ed/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f34313362336433342d663564332d343464342d306430372d6131393230323438303563312e706e67" alt="スクリーンショット_2014_02_03_9_31-2.png" title="スクリーンショット_2014_02_03_9_31-2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/413b3d34-f5d3-44d4-0d07-a192024805c1.png"></a></p>

<p>国は「アメリカ」を選択（※）し、特に何も入力せず「検索」をクリック。</p>

<p><a href="https://camo.qiitausercontent.com/1d12a62e1cb4791b95043bc76a472e3f5ba9dc62/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62363434323561362d303864372d636331622d653636302d3132353630643239383431332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1d12a62e1cb4791b95043bc76a472e3f5ba9dc62/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62363434323561362d303864372d636331622d653636302d3132353630643239383431332e706e67" alt="スクリーンショット_2014_02_03_9_36.png" title="スクリーンショット_2014_02_03_9_36.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/b64425a6-08d7-cc1b-e660-12560d298413.png"></a></p>

<p>※現在日本の電話番号ではSMSは使えないようです。<br>
しかも海外の番号の方がずっと安いので、迷わず取得しましょう。</p>

<p>この後、一覧に出てきた番号をクリック（どれでも良いです。）すると、<br>
「アップグレードが必要」と言われます。</p>

<p>そのまま指示に従い、クレカ情報を入力すればokです。<br>
※途中で自動チャージのON/OFFを選択しますが、とりあえずOFFの方が無難でしょう。</p>

<p>この後、自分はだいぶハマったのですが、<br>
しばらく時間が立たないとアップグレードされず、電話番号を購入できるようになりません。</p>

<p>しかもあるページではアップグレード済みの表示（※）なのに、<br>
電話番号購入ページではトライアルアカウント表示のままになっていたり。</p>

<p>※グローバルナビ右の登録アドレスの下に、<br>
トライアルアカウントの場合は「トライアル」、<br>
アップグレードした場合はチャージ分の金額が表示されます。</p>

<p>ちなみに自分はブラウザを変えて閲覧したら上手くいきました。<br>
セッション管理等の実装に不具合があるのかもしれません。</p>

<p>ともかく、これでSMS用電話番号が取得できました！</p>

<h2>
<span id="sms送信時にキックするapiを用意する" class="fragment"></span><a href="#sms%E9%80%81%E4%BF%A1%E6%99%82%E3%81%AB%E3%82%AD%E3%83%83%E3%82%AF%E3%81%99%E3%82%8Bapi%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>SMS送信時にキックするAPIを用意する</h2>

<p>Twilioでは、取得した電話番号にSMSが届いたタイミングでキックするAPIを設定することができます。</p>

<p>取得電話番号のページから簡単に設定できます。</p>

<p><a href="https://camo.qiitausercontent.com/804d32d1612f203d2d0a663bd5fac5be7e8b1a0c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62396364653732362d393233372d346639612d653763392d6134376663303134366234382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/804d32d1612f203d2d0a663bd5fac5be7e8b1a0c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62396364653732362d393233372d346639612d653763392d6134376663303134366234382e706e67" alt="スクリーンショット_2014_02_04_23_29.png" title="スクリーンショット_2014_02_04_23_29.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/b9cde726-9237-4f9a-e7c9-a47fc0146b48.png"></a></p>

<p>緑の枠内にキックするAPIを設定すればok。</p>

<p>テストしてみましょう。<br>
取得した電話番号宛にSMSを送信します。</p>

<p><a href="https://camo.qiitausercontent.com/12bad592c7fa2d96c315d148f7fa06ddfa8d85a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f32343136303264612d363538392d393866362d353662362d6337396539396461376138652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/12bad592c7fa2d96c315d148f7fa06ddfa8d85a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f32343136303264612d363538392d393866362d353662362d6337396539396461376138652e706e67" alt="スクリーンショット_2014_02_04_9_53.png" title="スクリーンショット_2014_02_04_9_53.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/241602da-6589-98f6-56b6-c79e99da7a8e.png"></a></p>

<p>キックしたサーバのログを確認すると・・</p>

<p><a href="https://camo.qiitausercontent.com/22459f4f7a893fa6cb93465479ee1faae05506e1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f38633738326264662d353134342d616532662d613238342d3936326664316634383433362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/22459f4f7a893fa6cb93465479ee1faae05506e1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f38633738326264662d353134342d616532662d613238342d3936326664316634383433362e706e67" alt="スクリーンショット_2014_02_04_23_10.png" title="スクリーンショット_2014_02_04_23_10.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/8c782bdf-5144-ae2f-a284-962fd1f48436.png"></a></p>

<p>来ています！</p>

<p>たったこれだけで、以下の図で言う2,3の箇所が実現出来てしまいました。</p>

<p><a href="https://camo.qiitausercontent.com/c0a28cdeca38a302a84e1968548e4736a0304c9b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62396161336139392d643937352d326534352d363333322d3764366636313935313865372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c0a28cdeca38a302a84e1968548e4736a0304c9b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62396161336139392d643937352d326534352d363333322d3764366636313935313865372e706e67" alt="スクリーンショット_2014_02_04_9_42.png" title="スクリーンショット_2014_02_04_9_42.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/b9aa3a99-d975-2e45-6332-7d6f619518e7.png"></a></p>

<p>あとは、投げられてくるパラメータを料理して、1,3,4の箇所を実装しましょう。</p>

<p>取得出来るパラメータはこうです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">"AccountSid"</span><span class="o">=&gt;</span><span class="s2">"hogehoge"</span><span class="p">,</span>
    <span class="s2">"MessageSid"</span><span class="o">=&gt;</span><span class="s2">"SMbfea2d641027f6f3434bf656c0b55d97"</span><span class="p">,</span>
    <span class="s2">"Body"</span><span class="o">=&gt;</span><span class="s2">"Hello, Qiita!"</span><span class="p">,</span>
    <span class="s2">"ToZip"</span><span class="o">=&gt;</span><span class="s2">"60081"</span><span class="p">,</span>
    <span class="s2">"ToCity"</span><span class="o">=&gt;</span><span class="s2">"FOX LAKE"</span><span class="p">,</span>
    <span class="s2">"FromState"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span>
    <span class="s2">"ToState"</span><span class="o">=&gt;</span><span class="s2">"IL"</span><span class="p">,</span>
    <span class="s2">"SmsSid"</span><span class="o">=&gt;</span><span class="s2">"SMbfea2d641027f6f3434bf656c0b55d97"</span><span class="p">,</span>
    <span class="s2">"To"</span><span class="o">=&gt;</span><span class="s2">"+18xxxxxxxx"</span><span class="p">,</span>
    <span class="s2">"ToCountry"</span><span class="o">=&gt;</span><span class="s2">"US"</span><span class="p">,</span>
    <span class="s2">"FromCountry"</span><span class="o">=&gt;</span><span class="s2">"JP"</span><span class="p">,</span>
    <span class="s2">"SmsMessageSid"</span><span class="o">=&gt;</span><span class="s2">"SMbfea2d641027f6f3434bf656c0b55d97"</span><span class="p">,</span>
    <span class="s2">"ApiVersion"</span><span class="o">=&gt;</span><span class="s2">"2010-04-01"</span><span class="p">,</span>
    <span class="s2">"FromCity"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span>
    <span class="s2">"SmsStatus"</span><span class="o">=&gt;</span><span class="s2">"received"</span><span class="p">,</span>
    <span class="s2">"NumMedia"</span><span class="o">=&gt;</span><span class="s2">"0"</span><span class="p">,</span>
    <span class="s2">"From"</span><span class="o">=&gt;</span><span class="s2">"+8180xxxxxxxx"</span><span class="p">,</span>
    <span class="s2">"FromZip"</span><span class="o">=&gt;</span><span class="s2">""</span>
<span class="p">}</span>
</pre></div></div>

<p>ユーザの送信内容や電話番号などがPOSTパラメータとして取得できる訳ですね。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">params</span><span class="o">[</span><span class="ss">:From</span><span class="o">]</span> <span class="c1"># ユーザの電話番号</span>
<span class="n">params</span><span class="o">[</span><span class="ss">:Body</span><span class="o">]</span> <span class="c1"># ユーザ入力値。ユーザidと認証トークンを入力してもらう。</span>
</pre></div></div>

<p>※ユーザ入力値（params[:Body]）は、今回は</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">user_id</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="n">token</span>
</pre></div></div>

<p>の形式を指定（認証ページでユーザに依頼）すると都合が良さそうです。</p>

<p>さて、これらがあれば1,3,4は実装できそうですね。<br>
こんなイメージでしょうか。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SmsAuthController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="no">TWILIO_NUMBER</span> <span class="o">=</span> <span class="s1">'+81xxxxxxxx'</span>  <span class="c1"># 電話番号</span>

  <span class="c1"># 認証ページ（GET）</span>
  <span class="c1"># viewでは@sender_num, @user.sms_token, @user.idを表示</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="vi">@sender_num</span> <span class="o">=</span> <span class="no">TWILIO_NUMBER</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">sms_token</span> <span class="o">=</span> <span class="n">generate_token</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">save!</span>
  <span class="k">end</span>

  <span class="c1"># 認証処理（POST）</span>
  <span class="k">def</span> <span class="nf">verify</span>
    <span class="k">begin</span>
      <span class="n">params_check</span><span class="p">;</span><span class="n">format_params</span><span class="p">;</span><span class="n">user_check</span><span class="p">;</span><span class="n">token_check</span><span class="p">;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"valid user!"</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">code</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"error: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">code</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="ss">message</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="p">}</span>
      <span class="k">return</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="c1"># 認証token生成</span>
  <span class="k">def</span> <span class="nf">generate_token</span>
    <span class="p">((</span><span class="mi">0</span><span class="o">..</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span> <span class="o">+</span> <span class="p">(</span><span class="s2">"a"</span><span class="o">..</span><span class="s2">"z"</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span> <span class="o">+</span> <span class="p">(</span><span class="s2">"A"</span><span class="o">..</span><span class="s2">"Z"</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">join</span>
  <span class="k">end</span>

  <span class="c1"># パラメータチェック</span>
  <span class="k">def</span> <span class="nf">params_check</span>
    <span class="k">raise</span> <span class="s1">'Body is invalid'</span> <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:Body</span><span class="o">].</span><span class="n">nil?</span>
    <span class="k">raise</span> <span class="s2">"Body isn't contain underscore"</span> <span class="k">if</span> <span class="o">!</span><span class="n">params</span><span class="o">[</span><span class="ss">:Body</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)</span>
    <span class="k">raise</span> <span class="s1">'From is invalid'</span> <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:From</span><span class="o">].</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># パラメータ整形</span>
  <span class="c1"># params[:Body]は「user_id + '_' + token」の形式を想定</span>
  <span class="k">def</span> <span class="nf">format_params</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:Body</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)</span>
    <span class="vi">@user_id</span> <span class="o">=</span> <span class="n">body</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="vi">@token</span> <span class="o">=</span> <span class="n">body</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">mobile_number</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:From</span><span class="o">].</span><span class="n">sub</span><span class="p">(</span><span class="sr">/^\+81/</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span>
    <span class="k">raise</span> <span class="s1">'user_id is nil'</span> <span class="k">if</span> <span class="vi">@user_id</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">raise</span> <span class="s1">'token is nil'</span> <span class="k">if</span> <span class="vi">@token</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">raise</span> <span class="s1">'mobile_number is nil'</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">mobile_number</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># ユーザチェック</span>
  <span class="k">def</span> <span class="nf">user_check</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="vi">@user_id</span><span class="p">)</span>
    <span class="k">raise</span> <span class="s1">'user is invalid'</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># 認証トークンチェック</span>
  <span class="k">def</span> <span class="nf">token_check</span>
    <span class="k">raise</span> <span class="s1">'token is invalid'</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">sms_token</span> <span class="o">==</span> <span class="vi">@token</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">save!</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div>

<p>indexが1、verifyが3,4の工程にあたりますね。</p>

<p><a href="https://camo.qiitausercontent.com/c0a28cdeca38a302a84e1968548e4736a0304c9b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62396161336139392d643937352d326534352d363333322d3764366636313935313865372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c0a28cdeca38a302a84e1968548e4736a0304c9b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62396161336139392d643937352d326534352d363333322d3764366636313935313865372e706e67" alt="スクリーンショット_2014_02_04_9_42.png" title="スクリーンショット_2014_02_04_9_42.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/b9aa3a99-d975-2e45-6332-7d6f619518e7.png"></a></p>

<p>ひとまず、これにて完成です。</p>

<p>Twilioを用いることで、本当に「1認証1円」が実現できました。<br>
これまでコストの面でSMS認証の導入を見送っていた方も、ぜひ検討してみてください！</p>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<p>以下の点をブラッシュアップしていきたいなと思っています。</p>

<p>・ユーザビリティの検討（ユーザに一定の情報量（ユーザ識別ID/認証token）を入力してもらうことになるため）。<br>
・電話番号を偽装してSMS送信されることはないか？その他不正行為の検討＆対策。<br>
・ちょっと捻れば、「受信型SMS認証サービス」として第三者へ提供することも・・</p>

<p>今回は完全に手探りでの検討だったので、その他仕組みの不足点など<br>
お気づきの点ありましたら突っ込み頂けますと幸いです！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />6位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>214</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/b222fb2892e6108c46d5">knife-soloによるChefの実行</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-14 18:58:25</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[chef]</b> <b>[knife]</b> <b>[knife-solo]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="前提" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90"><i class="fa fa-link"></i></a>前提</h2>

<h3>
<span id="knifeとは" class="fragment"></span><a href="#knife%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>knifeとは</h3>

<p>Chefレポジトリを操作するためのツール。</p>

<p>chef solo環境で利用するのは主に以下の二つ<br>
・knife cookbook（クックブックの作成）<br>
・knife solo</p>

<p>前者は生のchef soloを利用する場合に用いる。<br>
詳しくは以下。</p>

<p>Chefの基本<br>
<a href="http://qiita.com/kidachi_/items/9d569b8673e70ef93f0e" class="autolink" id="reference-eaf9aacb00135b95c9d3">http://qiita.com/kidachi_/items/9d569b8673e70ef93f0e</a></p>

<h3>
<span id="knife-soloとは" class="fragment"></span><a href="#knife-solo%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>knife-soloとは</h3>

<p>今回のトピックはこちら。<br>
それ単体でリポジトリやクックブックの作成、実行まで一括して行ってくれる。<br>
基本はchef soloを利用したい場合はこのknife soloに頼ればok。</p>

<h2>
<span id="knifeの初期設定" class="fragment"></span><a href="#knife%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>knifeの初期設定</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ knife configure
</pre></div></div>

<p>諸々の質問事項は全てデフォルトでok。<br>
初期化が完了すると<br>
~/.chef/knife.rbに設定ファイルが保存される。</p>

<h2>
<span id="knife-solo" class="fragment"></span><a href="#knife-solo"><i class="fa fa-link"></i></a>knife-solo</h2>

<p>knifeのプラグイン（gem）。<br>
chef solo利用にあたり便利な機能をknifeに追加する。<br>
手元（ホストOS）のレシピをリモートにrsyncでゲストOS側に転送した後<br>
chef-soloを実行し、その出力を送り返してくれる便利機能などが付属。</p>

<p>chef-soloだとchefを流す対象（リモートのサーバ）にログインして<br>
そこでchef-soloする必要があるが、<br>
knife-soloならローカルからホストを指定して流せば良いので手軽。</p>

<h3>
<span id="インストール" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>インストール</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ gem install knife-solo
</pre></div></div>

<p>ver0.3.0の場合は、knifeの設定ファイル~/.chef/knife.rbに<br>
knife-soloが利用するテンポラリディレクトリのパスを設定する。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">knife.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">knife</span><span class="o">[</span><span class="ss">:solo_path</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'/tmp/chef-solo'</span>
</pre></div>
</div>

<h2>
<span id="knifeによるリポジトリの生成" class="fragment"></span><a href="#knife%E3%81%AB%E3%82%88%E3%82%8B%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AE%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>knifeによるリポジトリの生成</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ knife solo init chef-repo
</pre></div></div>

<p>chef-soloに最適なレイアウトでChefリポジトリを作ってくれる。</p>

<p>構成</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ls -1 chef-repo
cookbooks/
data_bags/
nodes/
roles/
site-cookbooks/
</pre></div></div>

<h2>
<span id="site-cookbooks配下に新たなcookbookを作成する" class="fragment"></span><a href="#site-cookbooks%E9%85%8D%E4%B8%8B%E3%81%AB%E6%96%B0%E3%81%9F%E3%81%AAcookbook%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>site-cookbooks配下に新たなcookbookを作成する</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ knife cookbook create &lt;cookbook_name&gt; -o site-cookbooks
</pre></div></div>

<p>※chef-repo/cookbooksとchef-repo/site-cookbooksの違い（推奨の使い方）<br>
前者はダウンロードしてきたサードパーティのcookbooksを、<br>
後者には自分で作成したcookbooksを入れる。</p>

<h2>
<span id="knifeの各設定" class="fragment"></span><a href="#knife%E3%81%AE%E5%90%84%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>knifeの各設定</h2>

<p>プロジェクト直下の<code>.chef/knife.rb</code>で設定する。<br>
※knife configureの際生成される<code>~/.chef/knife.rb</code>とは別なので注意！</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">chef/knife.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">log_level</span>                <span class="ss">:info</span>
<span class="n">log_location</span>             <span class="no">STDOUT</span>
<span class="n">node_name</span>                <span class="s1">'taniguchidaiki'</span>
<span class="n">client_key</span>               <span class="s1">'/work/OPServer/.chef/hoge.pem'</span>
<span class="n">validation_client_name</span>   <span class="s1">'chef-validator'</span>
<span class="n">validation_key</span>           <span class="s1">'/etc/chef-server/chef-validator.pem'</span>
<span class="n">chef_server_url</span>          <span class="s1">'https://kidachi.local:443'</span>
<span class="n">syntax_check_cache_path</span>  <span class="s1">'/work/OPServer/.chef/syntax_check_cache'</span>

<span class="n">role_path</span> <span class="s1">'/work/OPServer/roles'</span>
<span class="c1"># 上記の通り、cookbooksでなくsite-cookbooks</span>
<span class="n">cookbook_path</span>  <span class="s1">'/work/OPServer/site-cookbooks'</span>
<span class="n">data_bag_path</span> <span class="s1">'/work/OPServer/data_bags'</span>

<span class="n">knife</span><span class="o">[</span><span class="ss">:solo_path</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'/tmp/chef-solo'</span>

</pre></div>
</div>

<h2>
<span id="レシピ転送リモート実行コマンド一覧" class="fragment"></span><a href="#%E3%83%AC%E3%82%B7%E3%83%94%E8%BB%A2%E9%80%81%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E5%AE%9F%E8%A1%8C%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>レシピ転送&amp;リモート実行コマンド一覧</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>
# 指定hostに対してchef-soloをインストール
# 以後リモートホスト上でchef-soloが通るように、いい感じに調整してくれる。
$ knife solo prepare &lt;host&gt;
$ knife solo prepare &lt;user&gt;@&lt;host&gt;

# &lt;host&gt;でchef-soloを実行させる
$ knife solo cook &lt;host&gt;

# run_listを個別に指定（ver0.3.0以降）
$ knife solo cook &lt;host&gt; -o hello::default, nginx::default

# &lt;host&gt;に転送したレシピ群を削除
$ knife solo clean &lt;host&gt;

# 新規Chefリポジトリを作成
$ knife solo init chef-repo

</pre></div></div>

<p>※knife-soloがssh経由でchef-soloを実行する際、sshに使われるログインユーザはsudoかつパスワードなしでchef-soloを実行できる権限を持っている必要あり（VagrantやEC2は初期状態でOK）。</p>

<p>※複数サーバにknife-soloしたい場合は、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ echo node1 node2 node3 | xargs -n 1 knife solo cook
</pre></div></div>

<h2>
<span id="指定hostにchef-soloをインストール" class="fragment"></span><a href="#%E6%8C%87%E5%AE%9Ahost%E3%81%ABchef-solo%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>指定hostにchef-soloをインストール</h2>

<p>実際にやってみる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ knife solo prepare 192.168.33.10
Bootstrapping Chef...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
101  6790  101  6790    0     0    944      0  0:00:07  0:00:07 --:--:-- 17146
Downloading Chef 11.6.2 for el...
Installing Chef 11.6.2
警告: /tmp/tmp.1zXqJZ9U/chef-11.6.2.x86_64.rpm: ヘッダ V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY
準備中...                ########################################### [100%]
   1:chef                   ########################################### [100%]
Thank you for installing Chef!
Generating node config 'nodes/192.168.33.10.json'...
</pre></div></div>

<p>成功。</p>

<h3>
<span id="ホストosからknife-soloする際の注意" class="fragment"></span><a href="#%E3%83%9B%E3%82%B9%E3%83%88os%E3%81%8B%E3%82%89knife-solo%E3%81%99%E3%82%8B%E9%9A%9B%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>ホストOSからknife-soloする際の注意</h3>

<p>通常の方法でssh出来るようにしておく。<br>
→knife-soloの際、ホストからゲストへ通常のsshアクセス、つまり</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ssh 192.168.33.10
</pre></div></div>

<p>でsshできるようになっている必要がある。</p>

<p>~/.ssh/configに以下追記。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># ~/.ssh/config
Host 192.168.33.*
IdentityFile ~/.vagrant.d/insecure_private_key
User vagrant
</pre></div></div>

<h2>
<span id="run_listの設定" class="fragment"></span><a href="#run_list%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>run_listの設定</h2>

<p>chef-repos内のnodesディレクトリ内jsonファイル（今回は192.168.33.10.json）に<br>
run_list（実行したいレシピ名）を記述する。</p>

<div class="code-frame" data-lang="json">
<div class="code-lang"><span class="bold">102.168.33.10.json</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">"run_list"</span><span class="p">:[</span>
      <span class="s2">"recipe[apache]"</span><span class="p">,</span>
      <span class="s2">"recipe[build-essential]"</span><span class="p">,</span>
      <span class="s2">"recipe[chef_handler]"</span><span class="p">,</span>
      <span class="s2">"recipe[git]"</span><span class="p">,</span>
      <span class="s2">"recipe[iptables]"</span><span class="p">,</span>
      <span class="s2">"recipe[mysql55]"</span><span class="p">,</span>
      <span class="s2">"recipe[php54]"</span><span class="p">,</span>
      <span class="s2">"recipe[postfix]"</span><span class="p">,</span>
      <span class="s2">"recipe[runit]"</span><span class="p">,</span>
      <span class="s2">"recipe[yum]"</span>
    <span class="p">]</span>
<span class="p">}</span>

</pre></div>
</div>

<h2>
<span id="knife-solo実行" class="fragment"></span><a href="#knife-solo%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>knife-solo実行</h2>

<p>※レシピは既成とする。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ knife solo cook 192.168.33.10
</pre></div></div>

<p>いろいろエラーが出た。</p>

<h2>
<span id="エラー1" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC1"><i class="fa fa-link"></i></a>エラー1</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>WARNING: Local cookbook_path '/var/chef/cookbooks' does not exist
WARNING: Local cookbook_path '/var/chef/site-cookbooks' does not exist
WARNING: Local role_path '/var/chef/roles' does not exist
WARNING: Local data_bag_path '/var/chef/data_bags' does not exist
</pre></div></div>

<p>path設定がデフォルトのままだったのでこけた。</p>

<p>Vagrantfileに適切なpathを設定し、vagrant reload。</p>

<div class="code-frame" data-lang="Vagrantfile"><div class="highlight"><pre><span></span>   config.vm.provision :chef_solo do |chef|
     chef.cookbooks_path = "/work/chef-repo/cookbooks"
     chef.roles_path = "/work/chef-repo/roles"
     chef.data_bags_path = "/work/chef-repo/data_bags"
  #   chef.add_recipe "mysql"
  #   chef.add_role "web"
  #
  #   # You may also specify custom JSON attributes:
  #   chef.json = { :mysql_password =&gt; "foo" }
   end
</pre></div></div>

<p>※ちなみにこの設定は~/.chef/knife.rbの設定に上書きされる。<br>
※今回は knife solo initを使っていなかったので、rolesとdata_bagsディレクトリがそもそも存在していなかった。chef-repo配下に自分で作成して解決。</p>

<h2>
<span id="エラー2" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC2"><i class="fa fa-link"></i></a>エラー2</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Recipe: mysql55::default
  * package[mysql-server] action install
================================================================================
Error executing action `install` on resource 'package[mysql-server]'
================================================================================

Chef::Exceptions::Package
-------------------------
Version 5.5.32-1.el5.remi of mysql-server not found. Did you specify both version and release? (version-release, e.g. 1.84-10.fc6)
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Recipe: php54::default
  * package[php] action install
================================================================================
Error executing action `install` on resource 'package[php]'
================================================================================


Chef::Exceptions::Package
-------------------------
Version 5.4.20-1.el5.remi of php not found. Did you specify both version and release? (version-release, e.g. 1.84-10.fc6)

</pre></div></div>

<p>mysql、phpそれぞれ、レシピで指定したバージョンが見つからないと。</p>

<p>yumからinstall可能なmysqlをチェック</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@localhost ~]$  yum --enablerepo=epel,remi,rpmforge info mysql
Loaded plugins: fastestmirror
Determining fastest mirrors
 * base: ftp.nara.wide.ad.jp
 * extras: ftp.nara.wide.ad.jp
 * updates: ftp.nara.wide.ad.jp
Available Packages
Name        : mysql
Arch        : x86_64
Version     : 5.1.69
Release     : 1.el6_4
Size        : 907 k
Repo        : updates
Summary     : MySQL client programs and shared libraries
URL         : http://www.mysql.com
License     : GPLv2 with exceptions
Description : MySQL is a multi-user, multi-threaded SQL database server. MySQL is a
            : client/server implementation consisting of a server daemon (mysqld)
            : and many different client programs and libraries. The base package
            : contains the standard MySQL client programs and generic MySQL files.
</pre></div></div>

<p>Versionが古い。またRepoがCentOSデフォルト（updates）になっている。<br>
→epel/remiリポジトリを追加する。</p>

<h2>
<span id="リポジトリを追加有効化する" class="fragment"></span><a href="#%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%92%E8%BF%BD%E5%8A%A0%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>リポジトリを追加/有効化する</h2>

<p>CentOSにyumリポジトリを追加<br>
<a href="http://qiita.com/kidachi_/items/40f862181050b78b9cc7" class="autolink" id="reference-a368e477c9200d05a93b">http://qiita.com/kidachi_/items/40f862181050b78b9cc7</a><br>
//TODO 本当はここもChef化したい。</p>

<h3>
<span id="mysqlphpそれぞれをリポジトリから落とせるバージョンに最適化する" class="fragment"></span><a href="#mysqlphp%E3%81%9D%E3%82%8C%E3%81%9E%E3%82%8C%E3%82%92%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%8B%E3%82%89%E8%90%BD%E3%81%A8%E3%81%9B%E3%82%8B%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%AB%E6%9C%80%E9%81%A9%E5%8C%96%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>mysql,phpそれぞれをリポジトリから落とせるバージョンに最適化する。</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo vi chef-repo/cookbooks/mysql55//attributes/default.rb
default['mysql55']['version'] = "5.5.34-1.el6.remi"
default['mysql55']['server-id'] = "0"
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo vi chef-repo/cookbooks/php54//attributes/default.rb
default['php54']['version'] = "5.4.20-1.el5.remi"
</pre></div></div>

<h3>
<span id="remiを常時有効化enabled1にする" class="fragment"></span><a href="#remi%E3%82%92%E5%B8%B8%E6%99%82%E6%9C%89%E5%8A%B9%E5%8C%96enabled1%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>remiを常時有効化（enabled=1）にする。</h3>

<p>//TODO 後々依存関係が出たりするので、常時有効はあまり良くないとか？</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">/etc/yum.repos.d/remi.repo（ゲスト）</span></div>
<div class="highlight"><pre><span></span>[remi]
name=Les RPM de remi pour Enterprise Linux 5 - $basearch
baseurl=http://rpms.famillecollet.com/el5.$basearch/
http://iut-info.univ-reims.fr/remirpms/el5.$basearch/
enabled=1
priority=1
</pre></div>
</div>

<h3>
<span id="vagrantfile上でも各リポジトリを有効化" class="fragment"></span><a href="#vagrantfile%E4%B8%8A%E3%81%A7%E3%82%82%E5%90%84%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96"><i class="fa fa-link"></i></a>Vagrantfile上でも各リポジトリを有効化。</h3>

<div class="code-frame" data-lang="Vagrantfile（ホスト）"><div class="highlight"><pre><span></span>vmclient.vm.provision :chef_solo do |chef|
    ~
  chef.add_recipe "yum::epel"
  chef.add_recipe "yum::remi"
    ~
end
</pre></div></div>

<p>参考）<br>
Chef の サードパーティ Cookbook を利用して、yum のリポジトリを追加してみる<br>
<a href="http://girigiribauer.com/archives/1095" class="autolink" rel="nofollow noopener" target="_blank">http://girigiribauer.com/archives/1095</a></p>

<h2>
<span id="再度knife-solo実行" class="fragment"></span><a href="#%E5%86%8D%E5%BA%A6knife-solo%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>再度knife-solo実行</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ knife solo cook 192.168.33.10
Running Chef on 192.168.33.10...
Checking Chef version...
Uploading the kitchen...
Generating solo config...
Running Chef...
Starting Chef Client, version 11.6.2
Compiling Cookbooks...
Recipe: chef_handler::default
  * remote_directory[/var/chef/handlers] action create
    ~
    ~
Chef Client finished, 40 resources updated
</pre></div></div>

<p>成功。</p>

<div class="code-frame" data-lang="json">
<div class="code-lang"><span class="bold">102.168.33.10.json</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">"run_list"</span><span class="p">:[</span>
      <span class="s2">"recipe[apache]"</span><span class="p">,</span>
      <span class="s2">"recipe[build-essential]"</span><span class="p">,</span>
      <span class="s2">"recipe[chef_handler]"</span><span class="p">,</span>
      <span class="s2">"recipe[git]"</span><span class="p">,</span>
      <span class="s2">"recipe[iptables]"</span><span class="p">,</span>
      <span class="s2">"recipe[mysql55]"</span><span class="p">,</span>
      <span class="s2">"recipe[php54]"</span><span class="p">,</span>
      <span class="s2">"recipe[postfix]"</span><span class="p">,</span>
      <span class="s2">"recipe[runit]"</span><span class="p">,</span>
      <span class="s2">"recipe[yum]"</span>
    <span class="p">]</span>
<span class="p">}</span>

</pre></div>
</div>

<p>これで、今後上記のミドルウェアは全てChefベースで展開できる。</p>

<h2>
<span id="補足" class="fragment"></span><a href="#%E8%A3%9C%E8%B6%B3"><i class="fa fa-link"></i></a>補足</h2>

<p>vagrant関連記事は以下</p>

<p>Vagrantの基本<br>
<a href="http://qiita.com/kidachi_/items/e63c1607705178aa257c" class="autolink" id="reference-1368923c374fda2cbafc">http://qiita.com/kidachi_/items/e63c1607705178aa257c</a></p>

<p>saharaでVagrantの状態管理<br>
<a href="http://qiita.com/kidachi_/items/ba365905b2a770c72be1" class="autolink" id="reference-9c9beeab369e8f999e8c">http://qiita.com/kidachi_/items/ba365905b2a770c72be1</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />7位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>205</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/a00558cfb0a6a3e23f4b">[Ruby] 便利な組み込みクラスのメソッド達（Enumerable編）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-06 09:49:17</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p><a href="http://www.amazon.co.jp/gp/product/4774158798/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4774158798&amp;linkCode=as2&amp;tag=kidachi-22" rel="nofollow noopener" target="_blank">パーフェクトRuby</a>を読んでいて便利だと思ったもの一覧です。</p>

<p>Array編<br>
<a href="http://qiita.com/kidachi_/items/e9cb26c4e6cb36b70a1c" class="autolink" id="reference-290289697191cbb69807">http://qiita.com/kidachi_/items/e9cb26c4e6cb36b70a1c</a><br>
Hash編<br>
<a href="http://qiita.com/kidachi_/items/651b5b5580be40ad047e" class="autolink" id="reference-1e8f8cd0f3e9d6c7d2ca">http://qiita.com/kidachi_/items/651b5b5580be40ad047e</a><br>
String編<br>
<a href="http://qiita.com/kidachi_/items/7b355eb355b2d1390cf5" class="autolink" id="reference-a7d9c0d5644bc6f6e6d2">http://qiita.com/kidachi_/items/7b355eb355b2d1390cf5</a></p>

<h2>
<span id="enumerable" class="fragment"></span><a href="#enumerable"><i class="fa fa-link"></i></a>Enumerable</h2>

<p>ArrayやHash、Rangeなど、「オブジェクトの集まり」を表現するクラスには<br>
Enumerableがincludeされており、それら全てのクラスで活用できる。</p>

<h2>
<span id="繰り返し処理" class="fragment"></span><a href="#%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>繰り返し処理</h2>

<h3>
<span id="each_with_index" class="fragment"></span><a href="#each_with_index"><i class="fa fa-link"></i></a>each_with_index</h3>

<p>配列のkeyとvalueを両方繰り返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java)</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span>
<span class="o">&gt;</span>   <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
<span class="o">&gt;</span> <span class="k">end</span>
<span class="mi">0</span><span class="p">:</span> <span class="no">Ruby</span>
<span class="mi">1</span><span class="p">:</span> <span class="no">Python</span>
<span class="mi">2</span><span class="p">:</span> <span class="no">Java</span>
</pre></div></div>

<h3>
<span id="reverse" class="fragment"></span><a href="#reverse"><i class="fa fa-link"></i></a>reverse</h3>

<p>末尾から順に繰り返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java)</span><span class="o">.</span><span class="n">reverse</span> <span class="p">{</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">val</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Ruby"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="each_slice" class="fragment"></span><a href="#each_slice"><i class="fa fa-link"></i></a>each_slice</h3>

<p>要素をn個ずつ区切って繰り返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">each_slice</span> <span class="mi">2</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span>
<span class="o">&gt;</span>   <span class="nb">p</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="k">end</span>
<span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>
<span class="o">[</span><span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"C"</span><span class="o">]</span>
<span class="o">[</span><span class="s2">"Smalltalk"</span><span class="p">,</span> <span class="s2">"Brainfuck"</span><span class="o">]</span>

<span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">each_slice</span> <span class="mi">4</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">|</span>
<span class="o">&gt;</span>   <span class="nb">p</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="k">end</span>
<span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"C"</span><span class="o">]</span>
<span class="o">[</span><span class="s2">"Smalltalk"</span><span class="p">,</span> <span class="s2">"Brainfuck"</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>    <span class="c1"># 帳尻が合わなかった部分はnil</span>
</pre></div></div>

<h3>
<span id="each_cons" class="fragment"></span><a href="#each_cons"><i class="fa fa-link"></i></a>each_cons</h3>

<p>n個の連続した要素を1つずつずらしながら繰り返す</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">each_cons</span> <span class="mi">2</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span>
<span class="o">&gt;</span>   <span class="nb">p</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="k">end</span>
<span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>
<span class="o">[</span><span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="o">[</span><span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"C"</span><span class="o">]</span>
<span class="o">[</span><span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Smalltalk"</span><span class="o">]</span>
<span class="o">[</span><span class="s2">"Smalltalk"</span><span class="p">,</span> <span class="s2">"Brainfuck"</span><span class="o">]</span>
</pre></div></div>

<h2>
<span id="評価結果を配列で返却" class="fragment"></span><a href="#%E8%A9%95%E4%BE%A1%E7%B5%90%E6%9E%9C%E3%82%92%E9%85%8D%E5%88%97%E3%81%A7%E8%BF%94%E5%8D%B4"><i class="fa fa-link"></i></a>評価結果を配列で返却</h2>

<h3>
<span id="map" class="fragment"></span><a href="#map"><i class="fa fa-link"></i></a>map</h3>

<p>元の配列の各要素を変換して、新しい配列をつくる</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">upcase</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"RUBY"</span><span class="p">,</span> <span class="s2">"PYTHON"</span><span class="p">,</span> <span class="s2">"JAVA"</span><span class="o">]</span>
</pre></div></div>

<p>※eachとの比較</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="nb">p</span> <span class="n">s</span><span class="o">.</span><span class="n">upcase</span><span class="p">}</span>
<span class="s2">"RUBY"</span>
<span class="s2">"PYTHON"</span>
<span class="s2">"JAVA"</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
</pre></div></div>

<p>eachは、戻り値には変更はない。</p>

<h2>
<span id="条件確認" class="fragment"></span><a href="#%E6%9D%A1%E4%BB%B6%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>条件確認</h2>

<h3>
<span id="all" class="fragment"></span><a href="#all"><i class="fa fa-link"></i></a>all?</h3>

<p>配列の要素が全て真であればtrueを返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="kp">true</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">true</span><span class="o">].</span><span class="n">all?</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="kp">true</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span><span class="o">].</span><span class="n">all?</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
</pre></div></div>

<h3>
<span id="none" class="fragment"></span><a href="#none"><i class="fa fa-link"></i></a>none?</h3>

<p>配列の要素が全て偽であればtrueを返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">].</span><span class="n">none?</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="kp">true</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span><span class="o">].</span><span class="n">none?</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
</pre></div></div>

<h3>
<span id="any" class="fragment"></span><a href="#any"><i class="fa fa-link"></i></a>any?</h3>

<p>配列の要素のうち一つでも真であればtrueを返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="kp">true</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span><span class="o">].</span><span class="n">any?</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">].</span><span class="n">any?</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
</pre></div></div>

<h3>
<span id="one" class="fragment"></span><a href="#one"><i class="fa fa-link"></i></a>one?</h3>

<p>配列の要素のうち一つだけ真であればtrueを返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">true</span><span class="o">].</span><span class="n">one?</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">].</span><span class="n">one?</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="kp">false</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">true</span><span class="o">].</span><span class="n">one?</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
</pre></div></div>

<h3>
<span id="条件確認ブロック" class="fragment"></span><a href="#%E6%9D%A1%E4%BB%B6%E7%A2%BA%E8%AA%8D%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>条件確認*ブロック</h3>

<p>all?, none?, any?, one?はそれぞれブロックを渡す事が出来る。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># 要素が全て整数ならtrue</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="o">].</span><span class="n">all?</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">Integer</span><span class="p">)}</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="c1"># 要素が全て文字列ならtrue</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="o">].</span><span class="n">all?</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">String</span><span class="p">)}</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">].</span><span class="n">all?</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">String</span><span class="p">)}</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>

<h2>
<span id="部分的な要素の取得" class="fragment"></span><a href="#%E9%83%A8%E5%88%86%E7%9A%84%E3%81%AA%E8%A6%81%E7%B4%A0%E3%81%AE%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>部分的な要素の取得</h2>

<h3>
<span id="grep" class="fragment"></span><a href="#grep"><i class="fa fa-link"></i></a>grep</h3>

<p>各要素に対してgrepをかけ、マッチする要素を取得する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># 正規表現にマッチする要素を取得</span>
<span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java)</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">/y/</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>

<span class="c1"># 指定の型にマッチする要素を取得</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="o">].</span><span class="n">grep</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="o">].</span><span class="n">grep</span><span class="p">(</span><span class="nb">Integer</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="detect" class="fragment"></span><a href="#detect"><i class="fa fa-link"></i></a>detect</h3>

<p>戻り値が最初に真になった要素を取得</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby"</span>
</pre></div></div>

<h3>
<span id="select" class="fragment"></span><a href="#select"><i class="fa fa-link"></i></a>select</h3>

<p>戻り値が真になった要素を全て取得。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="reject" class="fragment"></span><a href="#reject"><i class="fa fa-link"></i></a>reject</h3>

<p>戻り値が真になった要素以外を全て取得。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Smalltalk"</span><span class="p">,</span> <span class="s2">"Brainfuck"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="take" class="fragment"></span><a href="#take"><i class="fa fa-link"></i></a>take</h3>

<p>先頭から任意の数の要素を取得。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="drop" class="fragment"></span><a href="#drop"><i class="fa fa-link"></i></a>drop</h3>

<p>先頭から任意の数の要素をスキップしたものを取得。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Smalltalk"</span><span class="p">,</span> <span class="s2">"Brainfuck"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="take_while" class="fragment"></span><a href="#take_while"><i class="fa fa-link"></i></a>take_while</h3>

<p>ブロックが最初に偽を返すまでの要素を取得。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">take_while</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="drop_while" class="fragment"></span><a href="#drop_while"><i class="fa fa-link"></i></a>drop_while</h3>

<p>ブロックが最初に偽を返してからそれより後の要素を取得。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span><span class="o">.</span><span class="n">drop_while</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Smalltalk"</span><span class="p">,</span> <span class="s2">"Brainfuck"</span><span class="o">]</span>
</pre></div></div>

<h2>
<span id="畳み込み演算" class="fragment"></span><a href="#%E7%95%B3%E3%81%BF%E8%BE%BC%E3%81%BF%E6%BC%94%E7%AE%97"><i class="fa fa-link"></i></a>畳み込み演算</h2>

<h3>
<span id="inject" class="fragment"></span><a href="#inject"><i class="fa fa-link"></i></a>inject</h3>

<p>直前のブロックの戻り値が入った変数と、現在の要素が入った変数二つを利用して演算できる。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">inject</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="n">num</span><span class="o">|</span> <span class="n">result</span> <span class="o">+</span> <span class="n">num</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="mi">10</span>    <span class="c1"># 0 +1 + 2 + 3 + 4</span>
</pre></div></div>

<p>第一引数には初期値（上記では0）を設定可能。<br>
初期値を省略すると、先頭の要素が初期値として用いられる。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">inject</span> <span class="p">{</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="n">num</span><span class="o">|</span> <span class="n">result</span> <span class="o">+</span> <span class="n">num</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="mi">10</span>    <span class="c1"># 1 + 2 + 3 + 4</span>
</pre></div></div>

<p>繰り返しの度に呼び出すメソッドをシンボルで受け取ることも可能。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">inject</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">10</span>
<span class="o">&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">inject</span><span class="p">(</span><span class="ss">:*</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">24</span>
</pre></div></div>

<h2>
<span id="繰り返しとオブジェクトの更新" class="fragment"></span><a href="#%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97%E3%81%A8%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E6%9B%B4%E6%96%B0"><i class="fa fa-link"></i></a>繰り返しとオブジェクトの更新</h2>

<h3>
<span id="each_with_object" class="fragment"></span><a href="#each_with_object"><i class="fa fa-link"></i></a>each_with_object</h3>

<p>要素を繰り返しながら、オブジェクトを更新していき、最終的に行き着いた値が戻り値となる。<br>
引数には、初期値となるオブジェクトを渡す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java)</span><span class="o">.</span><span class="n">each_with_object</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">result</span><span class="o">|</span>
<span class="o">&gt;</span>   <span class="nb">p</span> <span class="n">result</span>
<span class="o">&gt;</span>   <span class="n">result</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">length</span>
<span class="o">&gt;</span> <span class="k">end</span>
<span class="p">{}</span>
<span class="p">{</span><span class="s2">"Ruby"</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">}</span>
<span class="p">{</span><span class="s2">"Ruby"</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">=&gt;</span><span class="mi">6</span><span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="s2">"Ruby"</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">=&gt;</span><span class="mi">6</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">}</span>
</pre></div></div>

<h2>
<span id="要素のグルーピング" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%94%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>要素のグルーピング</h2>

<h3>
<span id="group_by" class="fragment"></span><a href="#group_by"><i class="fa fa-link"></i></a>group_by</h3>

<p>特定の条件に基づいて要素をグルーピングする。<br>
ブロックを評価した結果がkeyとなるハッシュが返却される。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">].</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">class</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="nb">String</span><span class="o">=&gt;[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span><span class="p">,</span> <span class="nb">Float</span><span class="o">=&gt;[</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="o">]</span><span class="p">,</span> <span class="no">Fixnum</span><span class="o">=&gt;[</span><span class="mi">1000</span><span class="o">]</span><span class="p">}</span>
</pre></div></div>

<h3>
<span id="partition" class="fragment"></span><a href="#partition"><i class="fa fa-link"></i></a>partition</h3>

<p>ブロックの戻り値が真か偽かによって二つのグループに分けた、新しい配列を返却する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">].</span><span class="n">partition</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="o">]]</span>
</pre></div></div>

<h2>
<span id="最小値と最大値" class="fragment"></span><a href="#%E6%9C%80%E5%B0%8F%E5%80%A4%E3%81%A8%E6%9C%80%E5%A4%A7%E5%80%A4"><i class="fa fa-link"></i></a>最小値と最大値</h2>

<h3>
<span id="min-max-minmax" class="fragment"></span><a href="#min-max-minmax"><i class="fa fa-link"></i></a>min, max, minmax</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">range</span><span class="o">.</span><span class="n">max</span>
<span class="o">=&gt;</span> <span class="mi">5</span>
<span class="o">&gt;</span> <span class="n">range</span><span class="o">.</span><span class="n">min</span>
<span class="o">=&gt;</span> <span class="mi">1</span>
<span class="o">&gt;</span> <span class="n">range</span><span class="o">.</span><span class="n">minmax</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="min_by-max_by-minmax_by" class="fragment"></span><a href="#min_by-max_by-minmax_by"><i class="fa fa-link"></i></a>min_by, max_by, minmax_by</h3>

<p>ブロックで評価した結果の値で比較する。<br>
（「何の最小値/最大値か」を決める事が出来る）</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">lang</span> <span class="o">=</span> <span class="sx">%w(Ruby Python Java C)</span>
<span class="o">&gt;</span> <span class="n">lang</span><span class="o">.</span><span class="n">min_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">length</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="s2">"C"</span>
<span class="o">&gt;</span> <span class="n">lang</span><span class="o">.</span><span class="n">max_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">length</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="s2">"Python"</span>
<span class="o">&gt;</span> <span class="n">lang</span><span class="o">.</span><span class="n">minmax_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">length</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>
</pre></div></div>

<h2>
<span id="ソート" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>ソート</h2>

<h3>
<span id="sort-sort_by" class="fragment"></span><a href="#sort-sort_by"><i class="fa fa-link"></i></a>sort, sort_by</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">lang</span> <span class="o">=</span> <span class="sx">%w(Ruby Python Java C)</span>
<span class="c1"># アルファベット順</span>
<span class="o">&gt;</span> <span class="n">lang</span><span class="o">.</span><span class="n">sort</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Ruby"</span><span class="o">]</span>
<span class="c1"># 要素の長さ(1)</span>
<span class="o">&gt;</span> <span class="n">lang</span><span class="o">.</span><span class="n">sort</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">length</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>
<span class="c1"># 要素の長さ(2)</span>
<span class="o">&gt;</span> <span class="n">lang</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">str</span><span class="o">|</span> <span class="n">str</span><span class="o">.</span><span class="n">length</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>
</pre></div></div>

<p>sort_byは、各要素に対して1度しかメソッド呼び出し（今回は.length）を行わないため、sortより高速。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />8位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>196</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/651b5b5580be40ad047e">[Ruby] 便利な組み込みクラスのメソッド達（Hash編）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-06 09:49:39</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p><a href="http://www.amazon.co.jp/gp/product/4774158798/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4774158798&amp;linkCode=as2&amp;tag=kidachi-22" rel="nofollow noopener" target="_blank">パーフェクトRuby</a>を読んでいて便利だと思ったもの一覧です。</p>

<p>Enumerable編<br>
<a href="http://qiita.com/kidachi_/items/a00558cfb0a6a3e23f4b" class="autolink" id="reference-54e225674a745de17f33">http://qiita.com/kidachi_/items/a00558cfb0a6a3e23f4b</a><br>
Array編<br>
<a href="http://qiita.com/kidachi_/items/e9cb26c4e6cb36b70a1c" class="autolink" id="reference-862c13910ed4d601bc69">http://qiita.com/kidachi_/items/e9cb26c4e6cb36b70a1c</a><br>
String編<br>
<a href="http://qiita.com/kidachi_/items/7b355eb355b2d1390cf5" class="autolink" id="reference-438c7e93480c580c5dea">http://qiita.com/kidachi_/items/7b355eb355b2d1390cf5</a></p>

<h2>
<span id="繰り返し処理" class="fragment"></span><a href="#%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>繰り返し処理</h2>

<h3>
<span id="each" class="fragment"></span><a href="#each"><i class="fa fa-link"></i></a>each</h3>

<p>ハッシュのキーと値を繰り返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">Ruby</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">Python</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">Java</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:Ruby</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:Python</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:Java</span><span class="o">=&gt;</span><span class="mi">3</span><span class="p">}</span>

<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="o">&gt;</span>   <span class="nb">p</span> <span class="s2">"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
<span class="o">&gt;</span> <span class="k">end</span>
<span class="s2">"Ruby: 1"</span>
<span class="s2">"Python: 2"</span>
<span class="s2">"Java: 3"</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:Ruby</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:Python</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:Java</span><span class="o">=&gt;</span><span class="mi">3</span><span class="p">}</span>
</pre></div></div>

<h3>
<span id="each_key" class="fragment"></span><a href="#each_key"><i class="fa fa-link"></i></a>each_key</h3>

<p>ハッシュのキーだけ繰り返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
<span class="o">&gt;</span>   <span class="nb">p</span> <span class="s2">"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
<span class="o">&gt;</span> <span class="k">end</span>
<span class="s2">"Ruby"</span>
<span class="s2">"Python"</span>
<span class="s2">"Java"</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:Ruby</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:Python</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:Java</span><span class="o">=&gt;</span><span class="mi">3</span><span class="p">}</span>
</pre></div></div>

<h3>
<span id="each_value" class="fragment"></span><a href="#each_value"><i class="fa fa-link"></i></a>each_value</h3>

<p>ハッシュの値だけ繰り返す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">each_value</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
<span class="o">&gt;</span>   <span class="nb">p</span> <span class="s2">"</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
<span class="o">&gt;</span> <span class="k">end</span>
<span class="s2">"1"</span>
<span class="s2">"2"</span>
<span class="s2">"3"</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:Ruby</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:Python</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:Java</span><span class="o">=&gt;</span><span class="mi">3</span><span class="p">}</span>
</pre></div></div>

<h2>
<span id="マージ" class="fragment"></span><a href="#%E3%83%9E%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>マージ</h2>

<h3>
<span id="merge" class="fragment"></span><a href="#merge"><i class="fa fa-link"></i></a>merge</h3>

<p>複数のハッシュを1つにまとめる。<br>
キーが重複している場合は、引数として渡された方のハッシュの値で上書きされる。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">hash1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">Ruby</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">Python</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="o">&gt;</span> <span class="n">hash2</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">Java</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">Python</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
<span class="o">&gt;</span> <span class="n">hash1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">hash2</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:Ruby</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:Python</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="ss">:Java</span><span class="o">=&gt;</span><span class="mi">3</span><span class="p">}</span>
</pre></div></div>

<h2>
<span id="キーと値の入れ替え" class="fragment"></span><a href="#%E3%82%AD%E3%83%BC%E3%81%A8%E5%80%A4%E3%81%AE%E5%85%A5%E3%82%8C%E6%9B%BF%E3%81%88"><i class="fa fa-link"></i></a>キーと値の入れ替え</h2>

<h3>
<span id="invert" class="fragment"></span><a href="#invert"><i class="fa fa-link"></i></a>invert</h3>

<p>キーと値を入れ替えた新しいハッシュを生成する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="p">{</span><span class="ss">Ruby</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">Python</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">.</span><span class="n">invert</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="mi">1</span><span class="o">=&gt;</span><span class="ss">:Ruby</span><span class="p">,</span> <span class="mi">2</span><span class="o">=&gt;</span><span class="ss">:Python</span><span class="p">}</span>

<span class="c1"># 入れ替えの結果キーが重複した場合は、片方の値が消滅する。</span>
<span class="o">&gt;</span> <span class="p">{</span><span class="ss">Java</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">Ruby</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">.</span><span class="n">invert</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="mi">3</span><span class="o">=&gt;</span><span class="ss">:Ruby</span><span class="p">}</span>
</pre></div></div>

<h2>
<span id="キーや値の存在確認" class="fragment"></span><a href="#%E3%82%AD%E3%83%BC%E3%82%84%E5%80%A4%E3%81%AE%E5%AD%98%E5%9C%A8%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>キーや値の存在確認</h2>

<h3>
<span id="has_key-has_value" class="fragment"></span><a href="#has_key-has_value"><i class="fa fa-link"></i></a>has_key?, has_value?</h3>

<p>キーや値が存在するかどうかチェックする。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">Ruby</span><span class="p">:</span> <span class="kp">nil</span><span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:Ruby</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">}</span>

<span class="c1"># 存在するキーでも存在しないキーもどちらもnilを返す</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">[</span><span class="ss">:Ruby</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">[</span><span class="ss">:Python</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>

<span class="c1"># has_key?で区別する。</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="ss">:Ruby</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="ss">:Python</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="kp">false</span>

<span class="c1"># 値の存在チェックしたい場合はhas_value?を用いる。</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">has_value?</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">has_value?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
</pre></div></div>

<h2>
<span id="キーや値の取得" class="fragment"></span><a href="#%E3%82%AD%E3%83%BC%E3%82%84%E5%80%A4%E3%81%AE%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>キーや値の取得</h2>

<h3>
<span id="keys-values" class="fragment"></span><a href="#keys-values"><i class="fa fa-link"></i></a>keys, values</h3>

<p>キーや値を配列で取得する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">Ruby</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">Python</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">Java</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">keys</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:Ruby</span><span class="p">,</span> <span class="ss">:Python</span><span class="p">,</span> <span class="ss">:Java</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">values</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>

<span class="c1"># 値からキーを取得するにはHash#key</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="ss">:Ruby</span>
<span class="c1"># キーから値を取得するにはHash#values_at</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="ss">:Ruby</span><span class="p">,</span> <span class="ss">:Python</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
</pre></div></div>

<h2>
<span id="デフォルト値" class="fragment"></span><a href="#%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4"><i class="fa fa-link"></i></a>デフォルト値</h2>

<h3>
<span id="デフォルト値の設定" class="fragment"></span><a href="#%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>デフォルト値の設定</h3>

<p>存在しないキーを呼んだ時に返す値を設定。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">has_default</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'We love Ruby!'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">{}</span>
<span class="o">&gt;</span> <span class="n">has_default</span><span class="o">[</span><span class="ss">:aaaa</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="s2">"We love Ruby!"</span>
</pre></div></div>

<p>デフォルト値はブロックで定義することも可能。<br>
ブロックの引数には、「ハッシュ自身」と「参照されたキー」が渡される。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">has_default</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span> <span class="s2">"I (</span><span class="si">#{</span><span class="nb">hash</span><span class="si">}</span><span class="s2">) don't have </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">!"</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{}</span>
<span class="o">&gt;</span> <span class="n">has_default</span><span class="o">[</span><span class="ss">:Ruby</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="s2">"I ({}) don't have Ruby!"</span>
<span class="o">&gt;</span> <span class="n">has_default</span><span class="o">[</span><span class="ss">:Python</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="s2">"I ({}) don't have Python!"</span>

<span class="o">&gt;</span> <span class="n">has_default</span><span class="o">[</span><span class="ss">:Ruby</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="o">=&gt;</span> <span class="mi">1</span>
<span class="o">&gt;</span> <span class="n">has_default</span><span class="o">[</span><span class="ss">:Python</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="s2">"I ({:Ruby=&gt;1}) don't have Python!"</span>
</pre></div></div>

<h3>
<span id="fetch" class="fragment"></span><a href="#fetch"><i class="fa fa-link"></i></a>fetch</h3>

<p>指定したキーに値が存在しなかった場合の戻り値を指定できる。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">Ruby</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">Python</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:Java</span><span class="p">,</span> <span class="s2">"No key!"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"No key!"</span>
<span class="c1"># 値が存在するキーならば通常通り値を返却。</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:Ruby</span><span class="p">,</span> <span class="s2">"No key!"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">1</span>

<span class="c1"># ブロックによる指定も可能</span>
<span class="o">&gt;</span> <span class="nb">hash</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:Java</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="o">|</span> <span class="s2">"I don't have </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">!"</span><span class="p">}</span>
<span class="o">=&gt;</span> <span class="s2">"I don't have Java!"</span>
</pre></div></div>

<h2>
<span id="ハッシュの変換" class="fragment"></span><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>ハッシュの変換</h2>

<h3>
<span id="ハッシュから配列へ" class="fragment"></span><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%8B%E3%82%89%E9%85%8D%E5%88%97%E3%81%B8"><i class="fa fa-link"></i></a>ハッシュから配列へ</h3>

<p>to_aで二次元配列へ変換する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">Ruby</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">Python</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">to_a</span>
<span class="o">=&gt;</span> <span class="o">[[</span><span class="ss">:Ruby</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:Python</span><span class="p">,</span> <span class="mi">2</span><span class="o">]]</span>

<span class="c1"># 二次元配列にはassocでアクセス可能</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">assoc</span><span class="p">(</span><span class="ss">:Ruby</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:Ruby</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="配列からハッシュへ" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%8B%E3%82%89%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%B8"><i class="fa fa-link"></i></a>配列からハッシュへ</h3>

<p>偶数個の配列をハッシュに渡すパターン</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="no">Hash</span><span class="o">[*</span><span class="n">arr</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="s2">"Ruby"</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">}</span>

<span class="c1"># 奇数個の場合は不可</span>
<span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="no">Hash</span><span class="o">[*</span><span class="n">arr</span><span class="o">]</span>
<span class="ss">ArgumentError</span><span class="p">:</span> <span class="n">odd</span> <span class="n">number</span> <span class="n">of</span> <span class="n">arguments</span> <span class="k">for</span> <span class="no">Hash</span>
</pre></div></div>

<p>二次元配列をハッシュに渡すパターン</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="o">[[</span><span class="ss">:Ruby</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:Python</span><span class="p">,</span> <span class="mi">2</span><span class="o">]]</span>
<span class="o">=&gt;</span> <span class="o">[[</span><span class="ss">:Ruby</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:Python</span><span class="p">,</span> <span class="mi">2</span><span class="o">]]</span>
<span class="o">&gt;</span> <span class="no">Hash</span><span class="o">[</span><span class="n">arr</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:Ruby</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:Python</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />9位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>182</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/055021ce42fe2a49fd66">[Ruby] privateメソッドの本質とそれを理解するメリット</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-24 09:57:20</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<ul>
<li>Rubyのprivateメソッドを支える、2つのルール</li>
<li>ルールを知る事によるメリット</li>
</ul>

<p>※前者は<a href="http://www.amazon.co.jp/gp/product/4048687158/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4048687158&amp;linkCode=as2&amp;tag=kidachi-22" rel="nofollow noopener" target="_blank">メタプログラミングRuby</a>より。</p>

<h2>
<span id="2つのルール" class="fragment"></span><a href="#2%E3%81%A4%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>2つのルール</h2>

<ol>
<li>privateメソッドを呼び出す時は、レシーバは指定できない</li>
<li>自分（self）以外のオブジェクトのメソッドを呼び出すには、レシーバを指定する必要がある</li>
</ol>

<h2>
<span id="ルール1" class="fragment"></span><a href="#%E3%83%AB%E3%83%BC%E3%83%AB1"><i class="fa fa-link"></i></a>ルール1</h2>

<h3>
<span id="privateのついたメソッドを呼び出す時はレシーバは指定できない" class="fragment"></span><a href="#private%E3%81%AE%E3%81%A4%E3%81%84%E3%81%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E6%99%82%E3%81%AF%E3%83%AC%E3%82%B7%E3%83%BC%E3%83%90%E3%81%AF%E6%8C%87%E5%AE%9A%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>privateのついたメソッドを呼び出す時は、レシーバは指定できない</h3>

<p>例として、レシーバ指定しないパターンと、<br>
明示的にレシーバ指定してしまうパターンを試してみます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Sample1</span>

  <span class="k">def</span> <span class="nf">s1_call_private</span>
    <span class="n">s1_private</span>    <span class="c1"># 通常の呼び出し</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">s1_call_private_with_receiver</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">s1_private</span>    <span class="c1"># あえてレシーバ（self）を明示して指定</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">s1_private</span>
      <span class="nb">p</span> <span class="s2">"Welcome to my private room!"</span>
    <span class="k">end</span>

<span class="k">end</span>

<span class="n">s1</span> <span class="o">=</span> <span class="no">Sample1</span><span class="o">.</span><span class="n">new</span>

<span class="n">s1</span><span class="o">.</span><span class="n">s1_call_private</span>
<span class="o">=&gt;</span> <span class="s2">"Welcome to my private room!"</span>

<span class="n">s1</span><span class="o">.</span><span class="n">s1_call_private_with_receiver</span>
<span class="o">=&gt;</span> <span class="ss">NoMethodError</span><span class="p">:</span> <span class="kp">private</span> <span class="nb">method</span> <span class="sb">`s1_private' called for..</span>
</pre></div></div>

<p>ルール通り、レシーバを明示した方（<code>s1_call_private_with_receiver</code>）はNoMethodErrorが出る。</p>

<h2>
<span id="ルール2" class="fragment"></span><a href="#%E3%83%AB%E3%83%BC%E3%83%AB2"><i class="fa fa-link"></i></a>ルール2</h2>

<h3>
<span id="自分self以外のオブジェクトのメソッドを呼び出すにはレシーバを指定する必要がある" class="fragment"></span><a href="#%E8%87%AA%E5%88%86self%E4%BB%A5%E5%A4%96%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E3%81%AB%E3%81%AF%E3%83%AC%E3%82%B7%E3%83%BC%E3%83%90%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>自分（self）以外のオブジェクトのメソッドを呼び出すには、レシーバを指定する必要がある</h3>

<p>※こちらは「privateメソッドのためのルール」という訳ではなく、至極当然の話ですが</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Sample2</span>

  <span class="k">def</span> <span class="nf">s2_call_sample1</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="no">Sample1</span><span class="o">.</span><span class="n">new</span>
    <span class="n">s1</span><span class="o">.</span><span class="n">s1_call_private</span>    <span class="c1"># 通常の呼び出し</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">s2_call_sample1_without_receiver</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="no">Sample1</span><span class="o">.</span><span class="n">new</span>
    <span class="n">s1_call_private</span>    <span class="c1"># レシーバ（s1）なしで呼んでみる</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="n">s2</span> <span class="o">=</span> <span class="no">Sample2</span><span class="o">.</span><span class="n">new</span>
<span class="n">s2</span><span class="o">.</span><span class="n">s2_call_sample1</span>
<span class="o">=&gt;</span> <span class="s2">"Welcome to my private room!"</span>

<span class="n">s2</span><span class="o">.</span><span class="n">s2_call_sample1_without_receiver</span>
<span class="o">=&gt;</span> <span class="ss">NameError</span><span class="p">:</span> <span class="n">undefined</span> <span class="n">local</span> <span class="n">variable</span> <span class="ow">or</span> <span class="nb">method</span> <span class="sb">`s1_call_private' for..</span>
</pre></div></div>

<p>当たり前ながらs2_call_sample1_without_receiverはエラー。</p>

<h4>
<span id="ここでルール1とルール2のコンフリクトが起きる" class="fragment"></span><a href="#%E3%81%93%E3%81%93%E3%81%A7%E3%83%AB%E3%83%BC%E3%83%AB1%E3%81%A8%E3%83%AB%E3%83%BC%E3%83%AB2%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%95%E3%83%AA%E3%82%AF%E3%83%88%E3%81%8C%E8%B5%B7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>ここで、ルール1とルール2のコンフリクトが起きる。</h4>

<p>つまり、<br>
外部（s2）からs1のメソッドを呼び出そうとするなら、<br>
<code>s1.s1_private</code>のようにs1というレシーバをつける必要があるが（ルール2）、<br>
<strong>（s1の）privateメソッドはレシーバを付けて呼び出す事を許してくれない</strong>（ルール1）。</p>

<p>コードに示すと以下になります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>class Sample2

  def s2_call_sample1_private
    s1 = Sample1.new
    s1.s1_private    # 外部s1のメソッドを呼びたいので、レシーバs1は必須（ルール2）。
                     # でもprivateメソッドなのでレシーバは付けられない（ルール1）。
  end

end
</pre></div></div>

<p>結果として、<strong>privateメソッドは外部から呼び出すことが出来ない</strong>。</p>

<p>これがprivateメソッドの内部的な仕組みです。</p>

<h2>
<span id="つまり" class="fragment"></span><a href="#%E3%81%A4%E3%81%BE%E3%82%8A"><i class="fa fa-link"></i></a>つまり</h2>

<p>Rubyのprivateメソッドは、</p>

<ul>
<li>呼び出す際にレシーバを指定できない</li>
</ul>

<p>（し、逆にそれ以外は「ごく普通のメソッド」だと言える）</p>

<h2>
<span id="このことを理解しておくメリット" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E3%81%93%E3%81%A8%E3%82%92%E7%90%86%E8%A7%A3%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>このことを理解しておくメリット</h2>

<p>privateの挙動の混乱を防ぎやすい。</p>

<p>例えば、<br>
JavaやC#の常識が通用しないRubyのprivateメソッド<br>
<a href="http://blog.jnito.com/entry/20120315/1331754912" class="autolink" rel="nofollow noopener" target="_blank">http://blog.jnito.com/entry/20120315/1331754912</a></p>

<p>上記記事にもあるように、JavaやC#と違いRubyは</p>

<h4>
<span id="スーパークラスのprivateメソッドはサブクラスからも呼び出すことが出来る" class="fragment"></span><a href="#%E3%82%B9%E3%83%BC%E3%83%91%E3%83%BC%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AEprivate%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%E3%82%B5%E3%83%96%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8B%E3%82%89%E3%82%82%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E3%81%93%E3%81%A8%E3%81%8C%E5%87%BA%E6%9D%A5%E3%82%8B"><i class="fa fa-link"></i></a>スーパークラスのprivateメソッドはサブクラスからも呼び出すことが出来る。</h4>

<p>これは定義だけ覚えているとすぐに分からなくなりそうですが、</p>

<h4>
<span id="privateメソッドは呼び出す際にレシーバを指定できないだけ" class="fragment"></span><a href="#private%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E9%9A%9B%E3%81%AB%E3%83%AC%E3%82%B7%E3%83%BC%E3%83%90%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%A0%E3%81%91"><i class="fa fa-link"></i></a>privateメソッドは呼び出す際にレシーバを指定できない（だけ）</h4>

<p>という今回学んだルールと、</p>

<h4>
<span id="サブクラスからならスーパークラスのメソッドはレシーバを指定せずに呼び出せる" class="fragment"></span><a href="#%E3%82%B5%E3%83%96%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8B%E3%82%89%E3%81%AA%E3%82%89%E3%82%B9%E3%83%BC%E3%83%91%E3%83%BC%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%E3%83%AC%E3%82%B7%E3%83%BC%E3%83%90%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%9B%E3%81%9A%E3%81%AB%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>サブクラスからなら、スーパークラスのメソッドはレシーバを指定せずに呼び出せる</h4>

<p>という（ごく当たり前の）決まりを掛け合わせて考えれば、</p>

<h4>
<span id="スーパークラスのprivateメソッドはサブクラスからも呼び出すことが出来る-1" class="fragment"></span><a href="#%E3%82%B9%E3%83%BC%E3%83%91%E3%83%BC%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AEprivate%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%E3%82%B5%E3%83%96%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8B%E3%82%89%E3%82%82%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E3%81%93%E3%81%A8%E3%81%8C%E5%87%BA%E6%9D%A5%E3%82%8B-1"><i class="fa fa-link"></i></a>スーパークラスのprivateメソッドはサブクラスからも呼び出すことが出来る</h4>

<p>ことは至極当然なものとして頭に入ってくるのではないでしょうか。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />10位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>177</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/ba365905b2a770c72be1">saharaでVagrantの状態管理</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-12 14:52:30</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[vagrant]</b> <b>[sahara]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="saharaとは" class="fragment"></span><a href="#sahara%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>saharaとは</h2>

<p>OSの途中の状態を記憶しておき、好きな時にそこまでロールバックできる。</p>

<h2>
<span id="注意点" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>注意点</h2>

<p>Vagrant1.1には公式には未対応の様子。<br>
別途対応版を公開してくださっている方がいるので、そちらを利用させて頂く。</p>

<p>Vagrantの必須プラグインSaharaをVagrant 1.1に対応させました | Ryuzee.com<br>
<a href="http://www.ryuzee.com/contents/blog/6555" class="autolink" rel="nofollow noopener" target="_blank">http://www.ryuzee.com/contents/blog/6555</a></p>

<h3>
<span id="インストール" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>インストール</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ git clone https://github.com/ryuzee/sahara.git
$ <span class="nb">cd</span> sahara
$ bundle install
$ vagrant plugin install sahara
</pre></div></div>

<h3>
<span id="確認" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>確認</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ vagrant plugin list
sahara <span class="o">(</span><span class="m">0</span>.0.15<span class="o">)</span>
</pre></div></div>

<h3>
<span id="利用する" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>利用する</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="c1"># sandboxモード開始</span>
$ vagrant sandbox on

<span class="c1"># 変更を決定する</span>
$ vagrant sandbox commit

<span class="c1"># 変更を破棄し、ロールバックする</span>
$ vagrant sandbox rollback

<span class="c1"># sandboxモード終了（commitしていないものは破棄される）</span>
$ vagrant sandbox off

<span class="c1"># 現在sandboxモードかどうかの確認</span>
$ vagrant sandbox status
</pre></div></div>

<p>便利！</p>

<h2>
<span id="追記20131014" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%9820131014"><i class="fa fa-link"></i></a>追記（2013/10/14）</h2>

<p>sandbox on, sandbox commitは非常に時間がかかる。<br>
一度Vagrantを停止してから行うと少しましになる。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ vagrant halt
$ vagrant sandbox commit
</pre></div></div>

<h2>
<span id="vagrantに慣れたら" class="fragment"></span><a href="#vagrant%E3%81%AB%E6%85%A3%E3%82%8C%E3%81%9F%E3%82%89"><i class="fa fa-link"></i></a>Vagrantに慣れたら</h2>

<p>サーバ構成管理ツールのChefで、Vagrantの魅力を最大限に引き出しましょう！</p>

<p>Chefの基本<br>
<a href="http://qiita.com/kidachi_/items/9d569b8673e70ef93f0e" class="autolink" id="reference-5d6d95753bb158888b37">http://qiita.com/kidachi_/items/9d569b8673e70ef93f0e</a></p>

<p>knife-soloによるChefの実行<br>
<a href="http://qiita.com/kidachi_/items/b222fb2892e6108c46d5" class="autolink" id="reference-6f86a326b31e0c0ea397">http://qiita.com/kidachi_/items/b222fb2892e6108c46d5</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />11位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>145</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/43e53811c12351915278">Railsを支える基本概念の整理（RESTfulやリソースなど）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-11 20:47:29</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[RESTful]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>今更ながら本格的にRailsを触る事になったのでメモ。</p>

<p>Ruby on Rails Tutorialがとても良かったので、<br>
そこで学んだエッセンスを自分なりに整理してみる。</p>

<p>Ruby on Rails Tutorial（chapter2）<br>
<a href="http://railstutorial.jp/chapters/a-demo-app?version=4.0#top" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/a-demo-app?version=4.0#top</a></p>

<h2>
<span id="リソースとは" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>リソースとは</h2>

<p>データモデルとwebインターフェイスが組み合わさったもの。</p>

<ul>
<li>データモデルとは
現実世界のあるモノを分類/抽象化して落とし込んだカタマリ
（より具体的にいえば（今回の文脈では）「RDBMSに則って設計されたデータ群」と同義）</li>
</ul>

<p>##### 「User」を表すデータモデルのサンプル</p>

<table>
<thead>
<tr>
<th>column</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>integer</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
</tr>
<tr>
<td>email</td>
<td>string</td>
</tr>
</tbody>
</table>

<ul>
<li><p>webインターフェイスとは<br>
データモデルをwebで取り扱えるようにしたもの</p></li>
<li>
<p>つまりリソースとは</p>

<h4>
<span id="httpプロトコル経由で自由にcurd作成読み出し更新削除できる分類されたデータ群" class="fragment"></span><a href="#http%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E7%B5%8C%E7%94%B1%E3%81%A7%E8%87%AA%E7%94%B1%E3%81%ABcurd%E4%BD%9C%E6%88%90%E8%AA%AD%E3%81%BF%E5%87%BA%E3%81%97%E6%9B%B4%E6%96%B0%E5%89%8A%E9%99%A4%E3%81%A7%E3%81%8D%E3%82%8B%E5%88%86%E9%A1%9E%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E7%BE%A4"><i class="fa fa-link"></i></a>HTTPプロトコル経由で自由にCURD（作成/読み出し/更新/削除）できる（分類された）データ群</h4>

<p>とみなすことができる。</p>
</li>
</ul>

<p>なお、リソースはRESTという概念（後述）に基いている。</p>

<h2>
<span id="リソースを生成するコード" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>リソースを生成するコード</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails generate scaffold User name:string email:string
$ rake db:migrate <span class="c1">#マイグレーションファイルを実行（dbの作成）</span>
</pre></div></div>

<h2>
<span id="リソースに割り当てられるurl" class="fragment"></span><a href="#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AB%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%89%E3%82%8C%E3%82%8Burl"><i class="fa fa-link"></i></a>リソースに割り当てられるURL</h2>

<p>ユーザーのURLをUsersリソースで使用するコントローラアクションに<br>
割り当てる（マッピングする）コード。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">DemoApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<p>このコードは、 URLとアクションの組み合わせ↓を効率的に作成する。</p>

<p>Usersリソースにおける、ページとURLの関係。</p>

<table>
<thead>
<tr>
<th>URL</th>
<th>アクション</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>/users</td>
<td>index</td>
<td>すべてのユーザーを一覧するページ</td>
</tr>
<tr>
<td>/users/1</td>
<td>show</td>
<td>id=1のユーザーを表示するページ</td>
</tr>
<tr>
<td>/users/new</td>
<td>new</td>
<td>新規ユーザーを作成するページ</td>
</tr>
<tr>
<td>/users/1/edit</td>
<td>edit</td>
<td>id=1のユーザーを編集するページ</td>
</tr>
</tbody>
</table>

<h2>
<span id="railsのcontrollerの構成とそれを支えるrest" class="fragment"></span><a href="#rails%E3%81%AEcontroller%E3%81%AE%E6%A7%8B%E6%88%90%E3%81%A8%E3%81%9D%E3%82%8C%E3%82%92%E6%94%AF%E3%81%88%E3%82%8Brest"><i class="fa fa-link"></i></a>RailsのControllerの構成とそれを支えるREST</h2>

<p>Scaffoldで作成されるControllerに含まれるアクションは以下7つ。</p>

<table>
<thead>
<tr>
<th>HTTP Request</th>
<th>アクション</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>index、show、new、edit</td>
</tr>
<tr>
<td>other</td>
<td>create、update、destroy</td>
</tr>
</tbody>
</table>

<p>index、show、new、editアクションはいずれも「ページ」に対応するが、<br>
それ以外にもcreate、update、destroyアクションがある。</p>

<p>通常、これらのアクションは、ページ出力せずにDB上の情報を操作する<br>
（ケースに応じてページを出力することもある）。</p>

<p>これらは全て「REST」に基づく。</p>

<h2>
<span id="restとは" class="fragment"></span><a href="#rest%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>RESTとは</h2>

<p>RESTとは、アプリケーションを構成するコンポーネント（Userなど）を、<br>
・RDBMSのCRUD（Create/Read/Update/Delete）<br>
・HTTPRequestの各メソッド（GET/POST/PUT/DELETE）<br>
に対応させて、自由に作成/読み出し/更新/削除できるもの（リソース）として扱うアーキテクチャ。</p>

<h4>
<span id="usersリソースに含まれるrestfulなルーティング一覧" class="fragment"></span><a href="#users%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AB%E5%90%AB%E3%81%BE%E3%82%8C%E3%82%8Brestful%E3%81%AA%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>Usersリソースに含まれるRESTfulなルーティング一覧</h4>

<table>
<thead>
<tr>
<th>HTTP Request</th>
<th>URL</th>
<th>アクション</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/users</td>
<td>index</td>
<td>すべてのユーザーを表示するページ</td>
</tr>
<tr>
<td>GET</td>
<td>/users/1</td>
<td>show</td>
<td>id=1のユーザーを表示するページ</td>
</tr>
<tr>
<td>GET</td>
<td>/users/new</td>
<td>new</td>
<td>ユーザーを新規作成するページ</td>
</tr>
<tr>
<td>POST</td>
<td>/users</td>
<td>create</td>
<td>ユーザーを作成するアクション</td>
</tr>
<tr>
<td>GET</td>
<td>/users/1/edit</td>
<td>edit</td>
<td>id=1のユーザーを編集するページ</td>
</tr>
<tr>
<td>PATCH</td>
<td>/users/1</td>
<td>update</td>
<td>id=1のユーザーを更新するアクション</td>
</tr>
<tr>
<td>DELETE</td>
<td>/users/1</td>
<td>destroy</td>
<td>id=1のユーザーを削除するアクション</td>
</tr>
</tbody>
</table>

<p>URLには重複しているものが存在する。<br>
たとえば、showアクションと updateアクションは、<br>
どちらも/users/1というURLに対応している。<br>
これらのアクション同士の違いは、それらのアクションに<br>
対応するHTTP requestメソッドの違いでもある。</p>

<h2>
<span id="もう一つリソースを実装してみる" class="fragment"></span><a href="#%E3%82%82%E3%81%86%E4%B8%80%E3%81%A4%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>もう一つリソースを実装してみる</h2>

<h4>
<span id="micropostsを表すデータモデルsample" class="fragment"></span><a href="#microposts%E3%82%92%E8%A1%A8%E3%81%99%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%ABsample"><i class="fa fa-link"></i></a>「Microposts」を表すデータモデルsample</h4>

<table>
<thead>
<tr>
<th>column</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>integer</td>
</tr>
<tr>
<td>content</td>
<td>string</td>
</tr>
<tr>
<td>user_id</td>
<td>integer</td>
</tr>
</tbody>
</table>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails generate scaffold Micropost content:string user_id:integer
$ rake db:migrate #マイグレーションファイルを実行（dbの作成）
</pre></div></div>

<p>microposts用のルーティングルールが追加された。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">DemoApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:microposts</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="バリデーション文字数制限を入れてみる" class="fragment"></span><a href="#%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%96%87%E5%AD%97%E6%95%B0%E5%88%B6%E9%99%90%E3%82%92%E5%85%A5%E3%82%8C%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>バリデーション（文字数制限）を入れてみる</h2>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/micropost.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="リレーションを付ける" class="fragment"></span><a href="#%E3%83%AA%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BB%98%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>リレーションを付ける</h2>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/micropost.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="rails-consoleを使って動作チェック" class="fragment"></span><a href="#rails-console%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E5%8B%95%E4%BD%9C%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>Rails consoleを使って動作チェック</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails console

<span class="c1">#Userモデルから任意のデータ（今回はid=2）を抽出、@testuserに代入</span>
irb<span class="o">(</span>main<span class="o">)</span>:006:0&gt; @testuser <span class="o">=</span> User.find<span class="o">(</span><span class="m">2</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="c1">#&lt;User id: 2, name: "RailsBeginner", email: "rails@test.com", created_at: "2013-11-09 08:30:21", updated_at: "2013-11-09 08:30:21"&gt;</span>

<span class="c1">#@testuserが持っている（＝リレーションのある）micropostsデータを閲覧</span>
irb<span class="o">(</span>main<span class="o">)</span>:007:0&gt; @testuser.microposts
<span class="o">=</span>&gt; <span class="c1">#&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Micropost id: 2, content: "rails post test", user_id: 2, created_at: "2013-11-09 08:30:48", updated_at: "2013-11-09 08:30:48"&gt;]&gt;</span>

irb<span class="o">(</span>main<span class="o">)</span>:008:0&gt; <span class="nb">exit</span>
</pre></div></div>

<p>便利。</p>

<h2>
<span id="ついでにherokuにデプロイ" class="fragment"></span><a href="#%E3%81%A4%E3%81%84%E3%81%A7%E3%81%ABheroku%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4"><i class="fa fa-link"></i></a>ついでにHerokuにデプロイ</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ heroku create
$ git push heroku master
$ heroku run rake db:migrate
</pre></div></div>

<p><a href="http://afternoon-wildwood-5636.herokuapp.com/users" class="autolink" rel="nofollow noopener" target="_blank">http://afternoon-wildwood-5636.herokuapp.com/users</a><br>
<a href="http://afternoon-wildwood-5636.herokuapp.com/microposts" class="autolink" rel="nofollow noopener" target="_blank">http://afternoon-wildwood-5636.herokuapp.com/microposts</a></p>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>[Rails] RSpecによるBDD（振舞駆動開発）の基本 [SporkとGuardも]<br>
<a href="http://qiita.com/kidachi_/items/cb8910eb74e924456df9" class="autolink" id="reference-16d8412c89cf4066b817">http://qiita.com/kidachi_/items/cb8910eb74e924456df9</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />12位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>144</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/ec184deb106e4e5c90c3">[Rails] RSpecのリファクタリング</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 10:59:20</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby on Rails Tutorialのエッセンスを自分なりに整理してみる7</p>

<p>Railsにおけるリンクの記述方法とそのテスト<br>
<a href="http://qiita.com/kidachi_/items/d704e7eb63513c3831ae" class="autolink" id="reference-d63f82519b670850b414">http://qiita.com/kidachi_/items/d704e7eb63513c3831ae</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter5）<br>
<a href="http://railstutorial.jp/chapters/filling-in-the-layout#sec-layout_exercises" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/filling-in-the-layout#sec-layout_exercises</a></p>

<h2>
<span id="rspecのリファクタリング" class="fragment"></span><a href="#rspec%E3%81%AE%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>Rspecのリファクタリング</h2>

<p>指定のページが指定の要素を持っている（もしくはいない）かをチェックするテストコード。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the h1 'Sample App'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Sample App'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the base title"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span>
                        <span class="ss">text</span><span class="p">:</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should not have a custom page title"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'| Home'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the h1 'About'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'About Us'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span>
                    <span class="ss">text</span><span class="p">:</span> <span class="s2">"Ruby on Rails Tutorial Sample App | About Us"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<p>まず内容理解から。</p>

<h3>
<span id="describe" class="fragment"></span><a href="#describe"><i class="fa fa-link"></i></a>describe</h3>

<p>テストの塊を表す。例えば</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>ならば、「Static pages関連のテストの中のひとつである『Home page』のテスト」。</p>

<h3>
<span id="it-hoge-do--end" class="fragment"></span><a href="#it-hoge-do--end"><i class="fa fa-link"></i></a>it "hoge" do ~ end</h3>

<p>「hoge」はあくまでラベル。プログラム的な意味はない。<br>
テスト実行時、失敗箇所を示すものとして表示される。</p>

<p>ブロック（do~end）の中身が実際の各テストのロジックとなる。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">it</span> <span class="s2">"should have the h1 'Sample App'"</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">root_path</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Sample App'</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>上の例では、「root_path(/)にアクセスした際、そのページが<br>
'Sample App'という文字列のh1タグを持っていること」となる。</p>

<h2>
<span id="洗練1" class="fragment"></span><a href="#%E6%B4%97%E7%B7%B41"><i class="fa fa-link"></i></a>洗練1</h2>

<p>visit~、expect(page).to ~など、似たような構文が重複している。<br>
→beforeとsubjectを用いて解決。</p>

<p><a></a> </p>

<h3>
<span id="before-" class="fragment"></span><a href="#before-"><i class="fa fa-link"></i></a>before {}</h3>

<p>各テストが走る前に毎回実行されるメソッド。<br>
→重複部を before に書くことでテストコードの重複を排除出来る。</p>

<h3>
<span id="subject-" class="fragment"></span><a href="#subject-"><i class="fa fa-link"></i></a>subject {}</h3>

<p>ブロック({})内の評価結果が it 内のshouldのレシーバとなる。<br>
本例テストのレシーバ（主語）はどちらもpageになるので、subjectとして括ることが出来る。</p>

<h3>
<span id="page" class="fragment"></span><a href="#page"><i class="fa fa-link"></i></a>※page</h3>

<p>レスポンスがHTMLである場合、その内容を本メソッドで取得できる。<br>
これはCapybaraの機能のひとつ。</p>

<p>これらを用いてリファクタリングしたテスト。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span> 

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Sample App'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span> <span class="s1">'title'</span><span class="p">,</span>
                        <span class="ss">text</span><span class="p">:</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span> <span class="s1">'title'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'| Home'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span> 

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'About) }</span>
<span class="s1">    it { should have_selector '</span><span class="n">title</span><span class="err">'</span><span class="p">,</span>
                        <span class="ss">text</span><span class="p">:</span> <span class="s2">"Ruby on Rails Tutorial Sample App | About Us"</span> <span class="p">}</span>
  <span class="k">end</span>

</pre></div>
</div>

<h2>
<span id="洗練2" class="fragment"></span><a href="#%E6%B4%97%E7%B7%B42"><i class="fa fa-link"></i></a>洗練2</h2>

<p>text: "Ruby on Rails Tutorial Sample App"の部分をまとめるため、<br>
helperを用いる</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/helpers/application_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">ApplicationHelper</span>
  <span class="c1"># ページごとの完全なタイトルを返却</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">base_title</span>
    <span class="k">else</span>
      <span class="s2">"</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>helperメソッドfull_titleを用いて、もう一段簡潔になった。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span>    <span class="ss">text</span><span class="p">:</span> <span class="s1">'Sample App'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">''</span><span class="p">))</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span> <span class="s1">'title'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'| Home'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">about_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span>    <span class="ss">text</span><span class="p">:</span> <span class="s1">'About'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
</pre></div>
</div>

<p>helperに対するテストも忘れずに。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/helpers/application_helper_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">ApplicationHelper</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"full_title"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should include the page title"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">match</span><span class="p">(</span><span class="sr">/foo/</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should include the base title"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">match</span><span class="p">(</span><span class="sr">/^Ruby on Rails Tutorial Sample App/</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should not include a bar for the home page"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s2">""</span><span class="p">))</span><span class="o">.</span><span class="n">not_to</span> <span class="n">match</span><span class="p">(</span><span class="sr">/\|/</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="洗練3" class="fragment"></span><a href="#%E6%B4%97%E7%B7%B43"><i class="fa fa-link"></i></a>洗練3</h2>

<p>it { should have_selector('h1',    text: 'xxx') }<br>
が各describeで重複している。</p>

<p>→RSpecのShared Exampleとlet（変数生成）を使用してテストの冗長性を排除する。</p>

<h3>
<span id="shared-exampleとは" class="fragment"></span><a href="#shared-example%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Shared Exampleとは</h3>

<h4>
<span id="shared_examples_for-fuga-do--end" class="fragment"></span><a href="#shared_examples_for-fuga-do--end"><i class="fa fa-link"></i></a>shared_examples_for "fuga" do ~ end</h4>

<p>で、各describeに共通するテストを記述できる。<br>
その呼び出しは</p>

<h4>
<span id="it_should_behave_like-fuga" class="fragment"></span><a href="#it_should_behave_like-fuga"><i class="fa fa-link"></i></a>it_should_behave_like "fuga"</h4>

<p>で行う。</p>

<p><a></a> </p>

<h3>
<span id="letとは" class="fragment"></span><a href="#let%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>letとは</h3>

<p>テスト内にローカル変数を作成する。<br>
シンボルとブロックを引数に取り、ブロックが返した値を保持するローカル変数となる。<br>
変数の名前はシンボルの値。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">let</span><span class="p">(</span><span class="ss">:variable</span><span class="p">)</span>    <span class="p">{</span> <span class="s1">'hoge'</span> <span class="p">}</span>
<span class="c1"># 値’hoge’を持つ変数variableが使えるようになる。</span>
</pre></div></div>

<p>生成された変数はテスト中すべてのbeforeまたはitブロックで利用できる。</p>

<h3>
<span id="共通箇所の定義" class="fragment"></span><a href="#%E5%85%B1%E9%80%9A%E7%AE%87%E6%89%80%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>共通箇所の定義</h3>

<p>Shared Exampleで共通箇所を定義する。<br>
またローカル変数variable1,2を用いる（実際の定義は各describeで行う）。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">shared_examples_for</span> <span class="s2">"fuga"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">variable1</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="n">variable2</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">~</span>
</pre></div></div>

<p>その上で各describeで呼び出し。</p>

<ul>
<li>ローカル変数variableへの値代入（let(:variable) { value }）</li>
<li>Shared Exampleの呼び出しはit_should_behave_like "fuga"</li>
</ul>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span>  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:variable1</span><span class="p">)</span>    <span class="p">{</span> <span class="s1">'Sample App'</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:variable2</span><span class="p">)</span> <span class="p">{</span> <span class="s1">''</span> <span class="p">}</span>
    <span class="n">it_should_behave_like</span> <span class="s2">"fuga"</span>
  <span class="k">end</span>
</pre></div></div>

<p>→describe "Home page" 内で、</p>

<ul>
<li>   it { should have_content('Sample App') }</li>
<li>   it { should have_title(full_title("")) }</li>
</ul>

<p>が実行される。</p>

<h3>
<span id="だいぶ簡潔になった" class="fragment"></span><a href="#%E3%81%A0%E3%81%84%E3%81%B6%E7%B0%A1%E6%BD%94%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>だいぶ簡潔になった</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">shared_examples_for</span> <span class="s2">"all static pages"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:heading</span><span class="p">)</span>    <span class="p">{</span> <span class="s1">'Sample App'</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:page_title</span><span class="p">)</span> <span class="p">{</span> <span class="s1">''</span> <span class="p">}</span>

    <span class="n">it_should_behave_like</span> <span class="s2">"all static pages"</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">about_path</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:heading</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'About'</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:page_title</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'About'</span> <span class="p">}</span>

    <span class="n">it_should_behave_like</span> <span class="s2">"all static pages"</span>
  <span class="k">end</span>

</pre></div>
</div>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>[Rails] 基本的なユーザ管理用Modelをテスト駆動で実装してみる<br>
<a href="http://qiita.com/kidachi_/items/99f2c90788bd931ea3ee" class="autolink" id="reference-2dec01980d60e07d9ebb">http://qiita.com/kidachi_/items/99f2c90788bd931ea3ee</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />13位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>138</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/9d569b8673e70ef93f0e">Chefの基本</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-14 18:39:01</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[chef]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="chefとは" class="fragment"></span><a href="#chef%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Chefとは</h2>

<p>サーバ設定や更新を自動化するツール。</p>

<p>レポジトリ＞クックブック＞レシピ<br>
という階層で管理する。</p>

<p>一つのシステムにつきレポジトリ一つ、という粒度。</p>

<p>利用形態には以下の二つがある。</p>

<h4>
<span id="chef-server--chef-client" class="fragment"></span><a href="#chef-server--chef-client"><i class="fa fa-link"></i></a>Chef-Server + Chef-Client</h4>

<p>→Chef ClientがChef Serverからhttpで必要な情報をGETし、実行する。ChefServerの管理はちょっと大変。</p>

<h4>
<span id="chef-solo" class="fragment"></span><a href="#chef-solo"><i class="fa fa-link"></i></a>Chef-Solo</h4>

<p>→サーバ管理を必要としないスタンドアロン版。</p>

<h2>
<span id="chefのインストール" class="fragment"></span><a href="#chef%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Chefのインストール</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ curl -L http://www.opscode.com/chef/install.sh <span class="p">|</span> sudo bash
</pre></div></div>

<p>もしくは</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ gem install chef
</pre></div></div>

<h2>
<span id="レポジトリ作成" class="fragment"></span><a href="#%E3%83%AC%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>レポジトリ作成</h2>

<p>OpsCodeがgithubに公開しているレポジトリのひな形<br>
（後述のknife-soloを使えばそちらで肩代わりできる。）</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ git clone git://github.com/opscode/chef-repo.git
</pre></div></div>

<h2>
<span id="クックブック作成" class="fragment"></span><a href="#%E3%82%AF%E3%83%83%E3%82%AF%E3%83%96%E3%83%83%E3%82%AF%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>クックブック作成</h2>

<p>knifeを用いる</p>

<h2>
<span id="knifeとは" class="fragment"></span><a href="#knife%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>knifeとは</h2>

<p>chefレポジトリを操作するためのツール。<br>
クックブックの作成はこれで行う。</p>

<p>chef solo環境で利用するのは主に以下の二つ<br>
・knife cookbook（クックブックの作成）<br>
・knife solo</p>

<h2>
<span id="knifeの初期設定" class="fragment"></span><a href="#knife%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>knifeの初期設定</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ knife configure
</pre></div></div>

<p>諸々の質問事項は全てデフォルトでok。<br>
初期化が完了すると<br>
~/.chef/knife.rbに設定ファイルが保存される。</p>

<h2>
<span id="クックブックの作成" class="fragment"></span><a href="#%E3%82%AF%E3%83%83%E3%82%AF%E3%83%96%E3%83%83%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>クックブックの作成</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ cd chef-repo
$ knife cookbook reate hello -o cookbooks
</pre></div></div>

<p>cookbooksディレクトリ内にhelloというクックブックを作成。</p>

<h2>
<span id="レシピの作成" class="fragment"></span><a href="#%E3%83%AC%E3%82%B7%E3%83%94%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>レシピの作成</h2>

<p>クックブック作成時点でレシピのひな形は作成済となる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ vi cookbooks/hello/recipes/default.rb
</pre></div></div>

<p>"Hello, Chef!"を出力するだけのレシピ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>log "Hello, Chef!"
</pre></div></div>

<h2>
<span id="chef-soloの実行" class="fragment"></span><a href="#chef-solo%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>Chef Soloの実行</h2>

<p>Chef Solo実行時に実行するレシピを記述するJSONファイルを用意する。<br>
chef-repoディレクトリ直下に配置する。</p>

<div class="code-frame" data-lang="json">
<div class="code-lang"><span class="bold">localhost.json</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">"run_list"</span><span class="p">:[</span>
        <span class="s2">"recipe[hello]"</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>

<p>Chefが利用するテンポラリディレクトリやクックブックのパスを指定する設定ファイルも必要。同じくchef-repoディレクトリ直下に配置する。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">solo.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">file_cache_path</span> <span class="s2">"/tmp/chef-solo"</span>
<span class="n">cookbook_path</span> <span class="o">[</span><span class="s2">"/home/ec2-user/chef-repo/cookbooks"</span><span class="o">]</span>
</pre></div>
</div>

<h2>
<span id="実行" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>実行</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo chef-solo -c solo.rb -j ./localhost.json
</pre></div></div>

<h2>
<span id="chef-soloの流れまとめ" class="fragment"></span><a href="#chef-solo%E3%81%AE%E6%B5%81%E3%82%8C%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>chef-soloの流れまとめ</h2>

<p>・レシピを作る<br>
・JSONファイル内で、実行レシピを指定する<br>
・chef-soloコマンドで実行する</p>

<h2>
<span id="レシピサンプル" class="fragment"></span><a href="#%E3%83%AC%E3%82%B7%E3%83%94%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>レシピサンプル</h2>

<h3>
<span id="特定パッケージのインストール" class="fragment"></span><a href="#%E7%89%B9%E5%AE%9A%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>特定パッケージのインストール</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">default.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="s2">"zsh"</span> <span class="k">do</span>
    <span class="n">action</span> <span class="ss">:install</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="複数パッケージをまとめてインストール" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>複数パッケージをまとめてインストール</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">default.rb</span></div>
<div class="highlight"><pre><span></span><span class="sx">%w{zsh gcc make readline-devel}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pkg</span><span class="o">|</span>
    <span class="n">package</span> <span class="n">pkg</span> <span class="k">do</span>
        <span class="n">actoin</span> <span class="ss">:install</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="iptablesをオフに" class="fragment"></span><a href="#iptables%E3%82%92%E3%82%AA%E3%83%95%E3%81%AB"><i class="fa fa-link"></i></a>iptablesをオフに</h2>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">default.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">service</span> <span class="s1">'iptables'</span> <span class="k">do</span>
    <span class="n">action</span> <span class="o">[</span><span class="ss">:disable</span><span class="p">,</span> <span class="ss">:stop</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>
</div>

<p>※chefは何度実行しても、エラー等は発生しない。<br>
→冪等性（何度操作を行っても、結果が同じであること）がある。</p>

<h2>
<span id="resourceとは" class="fragment"></span><a href="#resource%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Resourceとは</h2>

<p>Chefが提供するDSL（Ruby組み込みの文法ではない）。<br>
レシピ内で用いる、「サーバの状態に何らかの影響を与える命令」のこと。<br>
log、packageなど</p>

<h2>
<span id="ノードnodeとは" class="fragment"></span><a href="#%E3%83%8E%E3%83%BC%E3%83%89node%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>ノード（node）とは</h2>

<p>管理対象の各サーバのこと。<br>
※その文脈で言うと、JSONファイルに書くのは特定のノードの「状態」となる。</p>

<p>JSONファイル内のデータ構造をNode Objectと呼び、そのプロパティとして、以下の2つを列挙する。<br>
・そのノードに適用するべきレシピ<br>
・そのノードが持っている変数（Attribute）</p>

<p>Chef Serverを用いる場合にはChef Serverに格納しておくが、<br>
Chef Soloの場合はその格納場所がないので、ローカルにJSONファイルとして書いておく。</p>

<h2>
<span id="knife-soloを用いた実用例はこちら" class="fragment"></span><a href="#knife-solo%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E5%AE%9F%E7%94%A8%E4%BE%8B%E3%81%AF%E3%81%93%E3%81%A1%E3%82%89"><i class="fa fa-link"></i></a>knife-soloを用いた実用例はこちら</h2>

<p>knife-soloによるChefの実行<br>
<a href="http://qiita.com/kidachi_/items/b222fb2892e6108c46d5" class="autolink" id="reference-e356e4f9189458417736">http://qiita.com/kidachi_/items/b222fb2892e6108c46d5</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />14位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>134</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/789c2e7aebbcfbd2583e">[Rails] STI（単一テーブル継承）とメタプログラミングでDRY</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-24 09:57:26</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[メタプログラミング]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>コピペコードが増えがちなサンプルアプリケーションの設計を例にとって、<br>
STI（単一テーブル継承）とメタプログラミングでDRY（重複排除）してみる。</p>

<h2>
<span id="題材" class="fragment"></span><a href="#%E9%A1%8C%E6%9D%90"><i class="fa fa-link"></i></a>題材</h2>

<p>ユーザが保持している楽曲をジャンルごとに管理するようなアプリケーション。<br>
ユーザページでは、ジャンル別に登録曲を一覧（もっと言うとCRUD）できる。</p>

<p>こんなイメージですね。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>kidachi_さん
あなたの登録曲一覧
  Rock
    ほげRock
    ふがRock
  Pops
    未登録です。    
  Jazz
    ふーJazz
    ばーJazz
</pre></div></div>

<p>何も考えないで作ると、rock/pops/jazzそれぞれのモデル、ビュー、コントローラに<br>
似たような記述・コピペが増えそうな予感を感じて頂けたでしょうか。</p>

<p>では、それを防ぐために、まずはSTIから。</p>

<p>（※追記）<br>
実は上記だけの要件であれば<br>
userテーブル、musicテーブル、genreテーブルのみを用意して<br>
<code>user has_many genres through musics</code>のassosiationでも実現可能<br>
（そもそもrock/pops/jazzモデルを用意する必要がない）だったりします。</p>

<p>実際は「今後それぞれのgenreごとに特有な処理を複数追加していきたい」というケースを想定して、<br>
各genre個別のモデルを用意することを前提にしています。<br>
ちょっと要件の例がいまいちだったかもしれず、申し訳ありません。。</p>

<h2>
<span id="stisingle-table-inheritance単一テーブル継承とは" class="fragment"></span><a href="#stisingle-table-inheritance%E5%8D%98%E4%B8%80%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E7%B6%99%E6%89%BF%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>STI（Single Table Inheritance/単一テーブル継承）とは</h2>

<p>「継承」と言えば、各クラスの共通項目が括りだされた<br>
スーパークラスと、非共通項目のサブクラスを用いることで<br>
コードの重複を防ぐ仕組みですが、それを<br>
<strong>db（テーブル）設計にも適用しよう</strong>というのがSTIです。<br>
（単一テーブル継承、という名前そのままですね。）</p>

<h2>
<span id="具体例" class="fragment"></span><a href="#%E5%85%B7%E4%BD%93%E4%BE%8B"><i class="fa fa-link"></i></a>具体例</h2>

<p>先ほどの楽曲管理アプリのテーブルをざっくり設計してみると、<br>
以下のようなイメージになると思います。</p>

<p><a href="https://camo.qiitausercontent.com/ce60b8036187d538773ca3a057bf785695aee89c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f38623162633832362d333566352d316133392d633264392d6563303434653064323865332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ce60b8036187d538773ca3a057bf785695aee89c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f38623162633832362d333566352d316133392d633264392d6563303434653064323865332e706e67" alt="music1.png" title="music1.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/8b1bc826-35f5-1a39-c2d9-ec044e0d28e3.png"></a></p>

<p>悪くはないのですが、モデル/テーブルに重複情報が<br>
増えてしまいそうですね。</p>

<h2>
<span id="そこで単一テーブル継承" class="fragment"></span><a href="#%E3%81%9D%E3%81%93%E3%81%A7%E5%8D%98%E4%B8%80%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E7%B6%99%E6%89%BF"><i class="fa fa-link"></i></a>そこで単一テーブル継承</h2>

<p>こうなります。</p>

<p><a href="https://camo.qiitausercontent.com/b8bbe131127640684cce39bf8c0c7edd229ad060/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f35623165356435342d666164642d363364372d373637652d3636303530316530613432642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b8bbe131127640684cce39bf8c0c7edd229ad060/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f35623165356435342d666164642d363364372d373637652d3636303530316530613432642e706e67" alt="music2.png" title="music2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/5b1e5d54-fadd-63d7-767e-660501e0a42d.png"></a></p>

<p>スーパークラスを用意して継承の仕組みを使うのと概念は全く一緒です。</p>

<p>一見どうということも無い様に見えますが、実は</p>

<ul>
<li><strong>rock、pops、jazz（etc）テーブルは実在しない</strong></li>
<li><strong>全てのデータは、musicテーブルに保管される</strong></li>
</ul>

<p>という特徴を持ちます。</p>

<p>さりげなくmusicテーブルに<strong>「type」</strong>というカラムが追加されていますが、<br>
<strong>ここにrock/pops/jazzといった子の情報が入る</strong>事になります。</p>

<p>また、もしrockテーブルにしか持たないような情報が欲しい場合は、<br>
事前にそれはmusicに定義しておきます。</p>

<h2>
<span id="modelの実装" class="fragment"></span><a href="#model%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Modelの実装</h2>

<p>STIを使っても、モデルは通常の継承の形で実装するだけです。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">music.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Music</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:artist</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">rock.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Rock</span> <span class="o">&lt;</span> <span class="no">Music</span>
<span class="k">end</span>
</pre></div>
</div>

<p>気をつけるのは、<br>
子が継承するのはActiveRecord::Baseでなく親であるMusic<br>
というところくらいでしょうか。</p>

<p>ちなみに、親で設定したリレーションやvalidatesは全て<br>
子クラスにも引き継がれます。</p>

<p>STIについてはここまで。</p>

<p>結論、STIを利用するには、db生成時に</p>

<ul>
<li>親テーブル（今回はmusic）にtypeカラムを持たせる。</li>
<li>子の一つに特有なカラムが必要であれば、それも親に持たせておく</li>
<li>（あとは普通に継承の形でモデルを作る）</li>
</ul>

<p>だけで良いことなります。</p>

<h2>
<span id="cntrollerの実装とメタプログラミング" class="fragment"></span><a href="#cntroller%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%A8%E3%83%A1%E3%82%BF%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>Cntrollerの実装とメタプログラミング</h2>

<p>users/showで該当ユーザの楽曲一覧を表示したい、という仕様でしたね。<br>
つまりshowで@rock/@pops/<a href="/jazz" class="user-mention js-hovercard" title="jazz" data-hovercard-target-type="user" data-hovercard-target-name="jazz">@jazz</a>の3つをセットしておきたいということ。</p>

<p>ここでメタプログラミングを利用してみます。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">users_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="no">GENRE</span> <span class="o">=</span> <span class="o">[</span>
      <span class="s1">'rock'</span><span class="p">,</span>
      <span class="s1">'pops'</span><span class="p">,</span>
      <span class="s1">'jazz'</span>
  <span class="o">]</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">set_music_by_genre</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">set_music_by_genre</span>
      <span class="vi">@music_list</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
      <span class="no">GENRE</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">music</span><span class="o">|</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">music</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">music</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>    <span class="c1"># 1</span>
          <span class="n">music</span> <span class="o">=</span> <span class="n">music</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\b\w/</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">upcase</span> <span class="p">}</span>    <span class="c1"># 2</span>
          <span class="n">value</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">music</span><span class="p">)</span><span class="o">.</span><span class="n">new</span>    <span class="c1"># 3</span>
        <span class="k">else</span>
          <span class="n">value</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">music</span><span class="p">)</span>    <span class="c1"># 4</span>
        <span class="k">end</span>
        <span class="nb">instance_variable_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>    <span class="c1"># 5</span>
        <span class="vi">@music_list</span> <span class="o">&lt;&lt;</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>    <span class="c1"># 6</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="set_music_by_genreの説明" class="fragment"></span><a href="#set_music_by_genre%E3%81%AE%E8%AA%AC%E6%98%8E"><i class="fa fa-link"></i></a>set_music_by_genreの説明</h3>

<h4>
<span id="1-if-usersendmusicnil" class="fragment"></span><a href="#1-if-usersendmusicnil"><i class="fa fa-link"></i></a>1. if @user.send(music).nil?</h4>

<p>sendを用いることで、<a href="/user" class="user-mention js-hovercard" title="user" data-hovercard-target-type="user" data-hovercard-target-name="user">@user</a>に対するメッセージングを動的に行っています。<br>
つまり、@user.rock/@user.pops/@user.jazzを動的に生成しているということ。</p>

<p>ここでは、<a href="/user" class="user-mention js-hovercard" title="user" data-hovercard-target-type="user" data-hovercard-target-name="user">@user</a>がrock/pops/jazzそれぞれのデータを持っているかどうか<br>
を判別し、既存データを保持している場合はそれを呼び出し（#2,3）、<br>
保持していなければ新規オブジェクトを生成（#4）します。</p>

<h4>
<span id="2-musicgsubbw--s-supcase-" class="fragment"></span><a href="#2-musicgsubbw--s-supcase-"><i class="fa fa-link"></i></a>2. music.gsub(/\b\w/) { |s| s.upcase }</h4>

<p>"Rock"/"Pops"/"Jazz"という文字列を動的に生成。<br>
#3で使います。</p>

<h4>
<span id="3-selfclassconst_getmusicnew" class="fragment"></span><a href="#3-selfclassconst_getmusicnew"><i class="fa fa-link"></i></a>3. self.class.const_get(music).new</h4>

<p>self.class.const_get(str)で、文字列(str)から<br>
クラスやモジュールの定数を取得できます。<br>
つまり、#2で生成した"Rock"/"Pops"/"Jazz"を<br>
クラス（Rock/Pops/Jazz）に変換し、それぞれnewしています。</p>

<h4>
<span id="4-usersendmusic" class="fragment"></span><a href="#4-usersendmusic"><i class="fa fa-link"></i></a>4. @user.send(music)</h4>

<p>#1と同様で、<a href="/user" class="user-mention js-hovercard" title="user" data-hovercard-target-type="user" data-hovercard-target-name="user">@user</a>に対して動的にメッセージを送っています。</p>

<h4>
<span id="5-instance_variable_setkey-value" class="fragment"></span><a href="#5-instance_variable_setkey-value"><i class="fa fa-link"></i></a>5. instance_variable_set(key, value)</h4>

<p>動的にインスタンス変数を生成。<br>
@rock/@pops/<a href="/jazz" class="user-mention js-hovercard" title="jazz" data-hovercard-target-type="user" data-hovercard-target-name="jazz">@jazz</a>それぞれに、既存オブジェクトもしくは新規オブジェクトをセットします。</p>

<h4>
<span id="6-media_list--instance_variable_getkey" class="fragment"></span><a href="#6-media_list--instance_variable_getkey"><i class="fa fa-link"></i></a>6. <a href="/media_list" class="user-mention js-hovercard" title="media_list" data-hovercard-target-type="user" data-hovercard-target-name="media_list">@media_list</a> &lt;&lt; instance_variable_get(key)</h4>

<p>viewで用いるために、</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span>
  <span class="c1">#&lt;Rock id: nil, type: "Rock", created_at: nil, updated_at: nil&gt;, </span>
  <span class="c1">#&lt;Pops id: nil, type: "Pops", created_at: nil, updated_at: nil&gt;, </span>
  <span class="c1">#&lt;Jazz id: nil, type: "Jazz", created_at: nil, updated_at: nil&gt;</span>
<span class="o">]</span>
</pre></div></div>

<p>このようなオブジェクトがセットされた配列を用意します。</p>

<h2>
<span id="view" class="fragment"></span><a href="#view"><i class="fa fa-link"></i></a>View</h2>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">views/users/show.html.erb</span></div>
<div class="highlight"><pre><span></span>  <span class="o">&lt;</span><span class="sx">% @music_list.each </span><span class="k">do</span> <span class="o">|</span><span class="n">music</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;% if music.try(:id).nil? %&gt;</span>
      <span class="o">&lt;!--</span> <span class="err">新規登録フォーム</span> <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="sx">% else %&gt;</span>
<span class="sx">       &lt;!-- 登録済み情報の表示 --&gt;</span>
    <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">  &lt;% end %&gt;</span>
</pre></div>
</div>

<p>showでセットした<a href="/music_list" class="user-mention js-hovercard" title="music_list" data-hovercard-target-type="user" data-hovercard-target-name="music_list">@music_list</a>をもとに、instance_variable_get()で<br>
動的にオブジェクトを取得し、それに応じて表示処理を行います。</p>

<h2>
<span id="controller" class="fragment"></span><a href="#controller"><i class="fa fa-link"></i></a>Controller</h2>

<p>新規登録フォームから投げられたデータをもとにcreateする箇所。<br>
ここでもself.class.const_get()でサブクラスに応じた<br>
クラス（Rock/Pops/Jazz）を動的にセットし、保存しています。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">music_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MusicController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_music_info</span>
  <span class="n">before_action</span> <span class="ss">:music_params</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">const_name</span> <span class="o">=</span> <span class="vi">@music_name</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\b\w/</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">upcase</span> <span class="p">}</span>
    <span class="c1"># サブクラスごとのオブジェクトを初期化</span>
    <span class="vi">@music</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">const_name</span><span class="p">)</span>
    <span class="vi">@music</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">music_params</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="k">if</span> <span class="vi">@music</span><span class="o">.</span><span class="n">save!</span>
        <span class="o">~</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="c1"># strong_parameters</span>
    <span class="k">def</span> <span class="nf">music_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="vi">@music_name</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">rock_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RockController</span> <span class="o">&lt;</span> <span class="no">MusicController</span>
  <span class="kp">private</span>
    <span class="n">set_music_info</span>
      <span class="vi">@music_name</span> <span class="o">=</span> <span class="s2">"rock"</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>STIを用いてmusicテーブルが用意されているためか、music_controllerで<br>
各サブクラス（rock/pops/jazz）のsave処理を行うのもごく直感的に行えます。</p>

<p>※個人的には、STIは特別な仕組みというより</p>

<h4>
<span id="継承関係を持たせたいmodelに対して直感的に適合するテーブルのインターフェース" class="fragment"></span><a href="#%E7%B6%99%E6%89%BF%E9%96%A2%E4%BF%82%E3%82%92%E6%8C%81%E3%81%9F%E3%81%9B%E3%81%9F%E3%81%84model%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E7%9B%B4%E6%84%9F%E7%9A%84%E3%81%AB%E9%81%A9%E5%90%88%E3%81%99%E3%82%8B%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>継承関係を持たせたいmodelに対して（直感的に）適合するテーブルのインターフェース</h4>

<p>なんじゃないかな、と思っています。</p>

<h2>
<span id="完成" class="fragment"></span><a href="#%E5%AE%8C%E6%88%90"><i class="fa fa-link"></i></a>完成</h2>

<p>さて、これでshowページでの楽曲一覧と、楽曲新規登録のロジックができました。</p>

<p>このようなメタな骨組みを用意することで、musicのジャンルを増やす際は<br>
hoge_controller.rbとGENREリストに新たなジャンルを追加するだけで良いことになります。<br>
（もちろんcontroller/modelファイルを用意したりroutes.rb追記したり、は別途必要ですが）</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">classic_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ClassicController</span> <span class="o">&lt;</span> <span class="no">MusicController</span>
  <span class="kp">private</span>
    <span class="n">set_music_info</span>
      <span class="vi">@music_name</span> <span class="o">=</span> <span class="s2">"classic"</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">users_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="no">GENRE</span> <span class="o">=</span> <span class="o">[</span>
      <span class="s1">'rock'</span><span class="p">,</span>
      <span class="s1">'pops'</span><span class="p">,</span>
      <span class="s1">'jazz'</span><span class="p">,</span>
      <span class="s1">'classic'</span>
  <span class="o">]</span>
</pre></div>
</div>

<p>※GENRE配列は設定ファイルとして外部化した方が良いですね</p>

<p>こんな感じ。</p>

<p>長くなるのでここまでにしますが、メタプログラミングを使うことで<br>
他のロジック部分も同様にコピペコードを撲滅できそうです。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>Railsで単一テーブル継承（Single Table Inheritance）<br>
<a href="http://blog.matake.jp/archives/railssingle_table_inherit" class="autolink" rel="nofollow noopener" target="_blank">http://blog.matake.jp/archives/railssingle_table_inherit</a></p>

<p>const_get (Module)<br>
<a href="http://ref.xaio.jp/ruby/classes/module/const_get" class="autolink" rel="nofollow noopener" target="_blank">http://ref.xaio.jp/ruby/classes/module/const_get</a></p>

<p>instance_variable_set/get (Object)<br>
<a href="http://ref.xaio.jp/ruby/classes/object/instance_variable_set" class="autolink" rel="nofollow noopener" target="_blank">http://ref.xaio.jp/ruby/classes/object/instance_variable_set</a><br>
<a href="http://ref.xaio.jp/ruby/classes/object/instance_variable_get" class="autolink" rel="nofollow noopener" target="_blank">http://ref.xaio.jp/ruby/classes/object/instance_variable_get</a></p>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<p>もっと効率の良い設計/書き方があれば、ぜひご教示よろしくお願い致します！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />15位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>129</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/cb8910eb74e924456df9">[Rails] RSpecによるBDD（振舞駆動開発）の基本 [SporkとGuardも]</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-11 20:51:23</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[RSpec]</b> <b>[Spork]</b> <b>[Guard]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>Ruby on Rails Tutorialのエッセンスを自分なりに整理してみる2</p>

<p>Railsを支える基本概念の整理（RESTfulやリソースなど）<br>
<a href="http://qiita.com/kidachi_/items/43e53811c12351915278" class="autolink" id="reference-ced34e178db94b9ec67f">http://qiita.com/kidachi_/items/43e53811c12351915278</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter3）<br>
<a href="http://railstutorial.jp/chapters/static-pages?version=4.0#sec-spork" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/static-pages?version=4.0#sec-spork</a></p>

<h2>
<span id="下準備" class="fragment"></span><a href="#%E4%B8%8B%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>下準備</h2>

<h4>
<span id="rails-new" class="fragment"></span><a href="#rails-new"><i class="fa fa-link"></i></a>rails new</h4>

<p>RSpecを用いるため、test-unitは不要。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails new rspec_sample --skip-test-unit
</pre></div></div>

<h4>
<span id="gemfileの設定" class="fragment"></span><a href="#gemfile%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Gemfileの設定</h4>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span><span class="p">,</span> <span class="s1">'2.35.1'</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span><span class="p">,</span> <span class="s1">'2.1.0'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div>
</div>

<ul>
<li>capybara
Web のアクセスをシミュレートするヘルパー。
ブラウザやエミュレータ上で想定される操作をrubyで書き、
テストに含めることが出来る</li>
</ul>

<p>capybara で快適なテスト生活を<br>
<a href="http://www.slideshare.net/tricknotes/capybara-introduction" class="autolink" rel="nofollow noopener" target="_blank">http://www.slideshare.net/tricknotes/capybara-introduction</a></p>

<ul>
<li><p>pg<br>
PostgreSQLを扱うためのgem</p></li>
<li><p>rails_12factor<br>
HerokuをRailsで動作させるためのgem</p></li>
</ul>

<h2>
<span id="アプリケーションの実装" class="fragment"></span><a href="#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>アプリケーションの実装</h2>

<h3>
<span id="controllerの作成" class="fragment"></span><a href="#controller%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>controllerの作成</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails g controller &lt;ClassName&gt; &lt;ActionName<span class="o">(</span>任意個数<span class="o">)</span>&gt;
</pre></div></div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails g controller StaticPages home <span class="nb">help</span> --no-test-framework
</pre></div></div>

<p>※RSpec用にtest-unitは除く</p>

<h3>
<span id="ルーティングの自動生成" class="fragment"></span><a href="#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E8%87%AA%E5%8B%95%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>ルーティングの自動生成</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"static_pages/home"</span>
  <span class="n">get</span> <span class="s2">"static_pages/help"</span>
  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<p>/static_pages/home（と/help）というURLに対するGETリクエストを、<br>
StaticPagesコントローラのhome（とhelp）アクションと結びつけている</p>

<h2>
<span id="おまけ各種ロールバックの方法" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91%E5%90%84%E7%A8%AE%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%81%AE%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>（おまけ）各種ロールバックの方法</h2>

<h4>
<span id="controller" class="fragment"></span><a href="#controller"><i class="fa fa-link"></i></a>controller</h4>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span> $ rails g controller FooBars baz quux
//controller名とaction名
 $ rails destroy  controller FooBars baz quux
</pre></div></div>

<h4>
<span id="model" class="fragment"></span><a href="#model"><i class="fa fa-link"></i></a>model </h4>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails g model Foo bar:string baz:integer
//model名のみでok
$ rails destroy model Foo
</pre></div></div>

<h4>
<span id="db" class="fragment"></span><a href="#db"><i class="fa fa-link"></i></a>db</h4>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rake db:migrate
//1つ前の状態に戻す
$ rake db:rollback
//最初の状態に戻す
$ rake db:migrate <span class="nv">VERSION</span><span class="o">=</span><span class="m">0</span>
</pre></div></div>

<p>※マイグレーションは逐次的に実行され、それぞれのマイグレーションに対してバージョン番号が付与されている。</p>

<h2>
<span id="テスト駆動の開始" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E9%A7%86%E5%8B%95%E3%81%AE%E9%96%8B%E5%A7%8B"><i class="fa fa-link"></i></a>テスト駆動の開始</h2>

<h5>
<span id="結合テスト-request-spec-を生成" class="fragment"></span><a href="#%E7%B5%90%E5%90%88%E3%83%86%E3%82%B9%E3%83%88-request-spec-%E3%82%92%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>結合テスト (request spec) を生成</h5>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails g integration_test static_pages
</pre></div></div>

<h5>
<span id="homeのviewはmicroという文字列アプリ名を持っているべき" class="fragment"></span><a href="#home%E3%81%AEview%E3%81%AFmicro%E3%81%A8%E3%81%84%E3%81%86%E6%96%87%E5%AD%97%E5%88%97%E3%82%A2%E3%83%97%E3%83%AA%E5%90%8D%E3%82%92%E6%8C%81%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%B9%E3%81%8D"><i class="fa fa-link"></i></a>/homeのviewは、'Micro'という文字列（アプリ名）を持っているべき</h5>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"StaticPages"</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should have the content 'Micro'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Micro'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div>
</div>

<h5>
<span id="rspec実行" class="fragment"></span><a href="#rspec%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>RSpec実行</h5>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> rspec spec/requests/static_pages_spec.rb
F

Failures:

  <span class="m">1</span><span class="o">)</span> StaticPages Home page should have the content <span class="s1">'Micro'</span>
     Failure/Error: expect<span class="o">(</span>page<span class="o">)</span>.to have_content<span class="o">(</span><span class="s1">'Micro'</span><span class="o">)</span>
       expected <span class="c1">#has_content?("Micro") to return true, got false</span>
     <span class="c1"># ./spec/requests/static_pages_spec.rb:7:in `block (3 levels) in &lt;top (required)&gt;'</span>

Finished in <span class="m">0</span>.83735 seconds
<span class="m">1</span> example, <span class="m">1</span> failure

Failed examples:

rspec ./spec/requests/static_pages_spec.rb:5 <span class="c1"># StaticPages Home page should have the content 'Micro'</span>

Randomized with seed <span class="m">4199</span>
</pre></div></div>

<p>想定通りRed（失敗）</p>

<p>テストをパスするようにアプリケーションに手を加える。</p>

<div class="code-frame" data-lang="html+erb">
<div class="code-lang"><span class="bold">app/views/static_pages/home.html.erb</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Micro<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
  This is the home page for the
  <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://railstutorial.jp/"</span><span class="p">&gt;</span>Ruby on Rails Tutorial<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  sample application.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>再度実行</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> rspec spec/requests/static_pages_spec.rb
.

Finished in <span class="m">0</span>.07615 seconds
<span class="m">1</span> example, <span class="m">0</span> failures

Randomized with seed <span class="m">11765</span>
</pre></div></div>

<p>Green（成功）。</p>

<h2>
<span id="guardの導入" class="fragment"></span><a href="#guard%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>Guardの導入</h2>

<h5>
<span id="guardとは" class="fragment"></span><a href="#guard%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Guardとは</h5>

<p>あるファイルに変更が加わった時、自動でそれに対するテストを実行する。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="o">~</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
  <span class="n">gem</span> <span class="s1">'guard-rspec'</span><span class="p">,</span> <span class="s1">'2.5.0'</span>
<span class="k">end</span>
<span class="o">~</span>
</pre></div>
</div>

<p>Gemfileに追記の上、bundle install。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle install
<span class="c1">#Guardを初期化し、RSpecと一緒に動作するようにする。</span>
$ bundle <span class="nb">exec</span> guard init rspec
</pre></div></div>

<p>結合テストとビューが更新されたら自動的に適切なテストが実行されるようにGuardfileを修正</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Guardfile</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'active_support/inflector'</span>

<span class="c1">#失敗したテストが後にパスしたとき、他の余分なテストが実行されないようにする</span>
<span class="n">guard</span> <span class="s1">'rspec'</span><span class="p">,</span> <span class="ss">all_after_pass</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
<span class="o">~</span>
  <span class="c1"># Custom Rails Tutorial specs</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/controllers/(.+)_(controller)\.rb$}</span><span class="p">)</span>  <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="o">[</span><span class="s2">"spec/routing/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_routing_spec.rb"</span><span class="p">,</span>
     <span class="s2">"spec/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">s/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span><span class="p">,</span>
     <span class="s2">"spec/acceptance/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span><span class="p">,</span>
     <span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="sr">/_pages/</span><span class="o">]</span> <span class="p">?</span> <span class="s2">"spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span> <span class="p">:</span>
                       <span class="s2">"spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">singularize</span><span class="si">}</span><span class="s2">_pages_spec.rb"</span><span class="p">)</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/views/(.+)/}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="sr">/_pages/</span><span class="o">]</span> <span class="p">?</span> <span class="s2">"spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span> <span class="p">:</span>
                      <span class="s2">"spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">singularize</span><span class="si">}</span><span class="s2">_pages_spec.rb"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/controllers/sessions_controller\.rb$}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="s2">"spec/requests/authentication_pages_spec.rb"</span>
  <span class="k">end</span>
<span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<p>Guardの実行。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> guard
</pre></div></div>

<h2>
<span id="sporkの導入" class="fragment"></span><a href="#spork%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>Sporkの導入</h2>

<h5>
<span id="sporkとは" class="fragment"></span><a href="#spork%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Sporkとは</h5>

<p>Railsにおけるテストの実行時間を短縮してくれるテスト用サーバ。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="o">~</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
  <span class="n">gem</span> <span class="s1">'guard-rspec'</span><span class="p">,</span> <span class="s1">'2.5.0'</span>
  <span class="n">gem</span> <span class="s1">'spork-rails'</span><span class="p">,</span> <span class="s1">'4.0.0'</span>
  <span class="n">gem</span> <span class="s1">'guard-spork'</span><span class="p">,</span> <span class="s1">'1.5.0'</span>
  <span class="n">gem</span> <span class="s1">'childprocess'</span><span class="p">,</span> <span class="s1">'0.3.9'</span>
<span class="k">end</span>
<span class="o">~</span>
</pre></div>
</div>

<p>Gemfileに追記の上、bundle install。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle install
$ bundle <span class="nb">exec</span> spork --bootstrap
</pre></div></div>

<p>--bootstrapを付けた実行により、spec/spec_helper.rbにSpork 実行用のコードが追記される。</p>

<p>RSpec のテストが Spork によって実行されるよう修正。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/spec_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rubygems'</span>
<span class="nb">require</span> <span class="s1">'spork'</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">prefork</span> <span class="k">do</span>
  <span class="no">ENV</span><span class="o">[</span><span class="s2">"RAILS_ENV"</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
  <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">"../../config/environment"</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">'rspec/rails'</span>
  <span class="nb">require</span> <span class="s1">'rspec/autorun'</span>

  <span class="c1"># Requires supporting ruby files with custom matchers and macros, etc,</span>
  <span class="c1"># in spec/support/ and its subdirectories.</span>
  <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"spec/support/**/*.rb"</span><span class="p">)</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span><span class="p">}</span>

  <span class="c1"># Checks for pending migrations before tests are run.</span>
  <span class="c1"># If you are not using ActiveRecord, you can remove this line.</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">.</span><span class="n">check_pending!</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">)</span>

  <span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="c1"># ## Mock Framework</span>
    <span class="c1">#</span>
    <span class="c1"># If you prefer to use mocha, flexmock or RR, uncomment the appropriate line:</span>
    <span class="c1">#</span>
    <span class="c1"># config.mock_with :mocha</span>
    <span class="c1"># config.mock_with :flexmock</span>
    <span class="c1"># config.mock_with :rr</span>

    <span class="c1"># Remove this line if you're not using ActiveRecord or ActiveRecord fixtures</span>
    <span class="n">config</span><span class="o">.</span><span class="n">fixture_path</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="o">::</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/spec/fixtures"</span>

    <span class="c1"># If you're not using ActiveRecord, or you'd prefer not to run each of your</span>
    <span class="c1"># examples within a transaction, remove the following line or assign false</span>
    <span class="c1"># instead of true.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">use_transactional_fixtures</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># If true, the base class of anonymous controllers will be inferred</span>
    <span class="c1"># automatically. This will be the default behavior in future versions of</span>
    <span class="c1"># rspec-rails.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">infer_base_class_for_anonymous_controllers</span> <span class="o">=</span> <span class="kp">false</span>

    <span class="c1"># Run specs in random order to surface order dependencies. If you find an</span>
    <span class="c1"># order dependency and want to debug it, you can fix the order by providing</span>
    <span class="c1"># the seed, which is printed after each run.</span>
    <span class="c1">#     --seed 1234</span>
    <span class="n">config</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="s2">"random"</span>
    <span class="c1"># Include the Capybara DSL so that specs in spec/requests still work.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">DSL</span>
    <span class="c1"># Disable the old-style object.should syntax.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">expect_with</span> <span class="ss">:rspec</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
      <span class="n">c</span><span class="o">.</span><span class="n">syntax</span> <span class="o">=</span> <span class="ss">:expect</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">each_run</span> <span class="k">do</span>
  <span class="c1"># This code will be run each time you run your specs.</span>

<span class="k">end</span>
</pre></div>
</div>

<p>spork実行</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ bundle exec spork
#--drbオプションを付ける
$ time bundle exec rspec spec/requests/static_pages_spec.rb --drb
......

6 examples, 0 failures

real    0m2.649s
user    0m1.259s
sys 0m0.258s```
</pre></div></div>

<p>テスト時間の短縮が分かる。</p>

<p>毎回--drbオプションを付けるのは不便なので、.rspecを修正。</p>

<div class="code-frame" data-lang="rspec"><div class="highlight"><pre><span></span>--colour
--drb
</pre></div></div>

<h2>
<span id="guardとsporkの連携" class="fragment"></span><a href="#guard%E3%81%A8spork%E3%81%AE%E9%80%A3%E6%90%BA"><i class="fa fa-link"></i></a>GuardとSporkの連携</h2>

<p>Guardを初期化し、Sporkと一緒に動作するようにする。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> guard init spork
</pre></div></div>

<p>Guardfileの修正。<br>
guardの変数に <code>:cli =&gt; --drb</code> を追加し、Guardがコマンドラインから常にSporkサーバーを使うようにする。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Guardfile</span></div>
<div class="highlight"><pre><span></span><span class="n">guard</span> <span class="s1">'rspec'</span><span class="p">,</span> <span class="ss">all_after_pass</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
<span class="err">↓</span>
<span class="n">guard</span> <span class="s1">'rspec'</span><span class="p">,</span> <span class="ss">after_all_pass</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">cli</span><span class="p">:</span> <span class="s1">'--drb'</span> <span class="k">do</span>
</pre></div>
</div>

<p> 以下でGuardとSporkを同時に起動。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> guard
</pre></div></div>

<h2>
<span id="追記1-guardが動かなくなったら" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%981-guard%E3%81%8C%E5%8B%95%E3%81%8B%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E3%82%89"><i class="fa fa-link"></i></a>追記1 Guardが動かなくなったら</h2>

<p>たまにGuardが反応しなくなることがある。<br>
（エラーメッセージも出ない。）</p>

<p>こういうケースでは、乱暴だがGuardとSporkのプロセスを殺して再起動する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ kill -9 `pgrep -f 'spork'`
$ kill -9 `pgrep -f 'guard'`
$ bundle exec guard
</pre></div></div>

<p>※根本原因をご存知の方はアドバイス頂けますと幸いです！</p>

<h2>
<span id="追記2-プロジェクトにtestunitが含まれている場合" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%982-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%ABtestunit%E3%81%8C%E5%90%AB%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>追記2 プロジェクトにTest::Unitが含まれている場合</h2>

<p>もしプロジェクトにTest::Unitも含めてしまっていると、（Test::Unit用の設定は行っていないため）以下の様なエラーが出る</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="m">18</span>:43:40 - INFO - Starting Spork <span class="k">for</span> RSpec, Test::Unit
Couldn<span class="s1">'t find a supported test framework that begins with '</span>testunit<span class="err">'</span>

Supported <span class="nb">test</span> frameworks:
<span class="o">(</span> <span class="o">)</span> Cucumber
<span class="o">(</span>*<span class="o">)</span> RSpec

Legend: <span class="o">(</span> <span class="o">)</span> - not detected in project   <span class="o">(</span>*<span class="o">)</span> - detected
Using RSpec, Rails
Preloading Rails environment
Loading Spork.prefork block...
Spork is ready and listening on <span class="m">8989</span>!
<span class="m">18</span>:44:10 - ERROR - Could not start Spork server <span class="k">for</span> RSpec, Test::Unit after <span class="m">30</span> seconds. I will <span class="k">continue</span> waiting <span class="k">for</span> a further <span class="m">60</span> seconds.

<span class="m">18</span>:45:10 - ERROR - Could not start Spork server <span class="k">for</span> RSpec, Test::Unit. Make sure you can use it manually first.
</pre></div></div>

<p>その場合は、Guardfileで以下の設定を加えて解決。</p>

<div class="code-frame" data-lang="Guardfile"><div class="highlight"><pre><span></span>-guard 'spork', :cucumber_env =&gt; { 'RAILS_ENV' =&gt; 'test' }, :rspec_env =&gt; { 'RAILS_ENV' =&gt; 'test' } do
+guard 'spork', :cucumber_env =&gt; { 'RAILS_ENV' =&gt; 'test' }, :rspec_env =&gt; { 'RAILS_ENV' =&gt; 'test' }, :test_unit =&gt; false do
</pre></div></div>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>Railsを触る際知っていると便利なRubyの基礎 [ブロックとかシンボルとか]<br>
<a href="http://qiita.com/kidachi_/items/46a6e49b6306655ccd64" class="autolink" id="reference-a33e429936fe6af77a43">http://qiita.com/kidachi_/items/46a6e49b6306655ccd64</a></p>

<p>[Ruby基礎] ブロックとProcをちゃんと理解する<br>
<a href="http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2" class="autolink" id="reference-619f776e2bdf8a80d67e">http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />16位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>112</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/ce604b70d6cbfa2f7aec">今度こそ快適・王道なTDD生活が始められる良記事10選+α [Rails/RSpec]</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-17 12:54:47</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[TDD]</b> <b>[RSpec]</b> <b>[Guard]</b> <b>[FactoryGirl]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>この記事は<a href="http://qiita.com/advent-calendar/2013/tddadventjp">TDD Advent Calendar 2013</a>の17日目の参加エントリです。</p>

<p>前日は<a href="http://a-suenami.hatenablog.com/about" rel="nofollow noopener" target="_blank">id:a_suenami</a>さんの<a href="http://a-suenami.hatenablog.com/entry/2013/12/17/001446" rel="nofollow noopener" target="_blank">TDDが僕に教えてくれたこと</a>でした。</p>

<h2>
<span id="このエントリが目指すところ" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%81%8C%E7%9B%AE%E6%8C%87%E3%81%99%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>このエントリが目指すところ</h2>

<p>「Railsで開発しつつも実はあまりテストを実践出来ていない」という方を対象に、</p>

<ul>
<li>Rails*RSpecでunit/functional test</li>
<li>Capybaraでブラウザの挙動をシミュレート</li>
<li>FactoryGirlでテストデータを自由に準備</li>
<li>Guardでファイル編集の度にテストを自動実行</li>
<li>Sporkでサイクル高速化</li>
</ul>

<p>を実現するために役立つ記事を紹介します。</p>

<h2>
<span id="rspecの基本" class="fragment"></span><a href="#rspec%E3%81%AE%E5%9F%BA%E6%9C%AC"><i class="fa fa-link"></i></a>RSpecの基本</h2>

<h4>
<span id="改めて学ぶ-rspec" class="fragment"></span><a href="#%E6%94%B9%E3%82%81%E3%81%A6%E5%AD%A6%E3%81%B6-rspec"><i class="fa fa-link"></i></a><a href="http://magazine.rubyist.net/?0035-RSpecInPractice" rel="nofollow noopener" target="_blank">改めて学ぶ RSpec</a>
</h4>

<h4>
<span id="rspec-簡潔に記述する" class="fragment"></span><a href="#rspec-%E7%B0%A1%E6%BD%94%E3%81%AB%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://shinsukekatsuyama.blogspot.jp/2011/07/rspec-1-it.html" rel="nofollow noopener" target="_blank">RSpec 簡潔に記述する</a>
</h4>

<p>「RSpecとは何か」と「基本的な書き方」が身に付く2記事。<br>
describeやcontext、subjectといった「骨組み」をこちらで抑えておきましょう。</p>

<h4>
<span id="rspeccapybara入門" class="fragment"></span><a href="#rspeccapybara%E5%85%A5%E9%96%80"><i class="fa fa-link"></i></a><a href="http://www.oiax.jp/rails/rspec_capybara_primer.html" rel="nofollow noopener" target="_blank">RSpec/Capybara入門</a>
</h4>

<p>Rails上で動かしていくので実践に近い形で学べる。<br>
併せてCapybaraやFactoryGirlがどんなものかも分かります。<br>
<a href="http://www.oiax.jp/rails/rspec_capybara_primer/basic_structure.html" rel="nofollow noopener" target="_blank">should はどこに行ったの？</a>も抑えておきましょう。<br>
まずは第6回の「モデルテストの演習」まで。</p>

<p>※なぜかChromeだとサンプルコードが読みづらいです。Safariなら問題ありませんでした。</p>

<h2>
<span id="rspecもう一歩" class="fragment"></span><a href="#rspec%E3%82%82%E3%81%86%E4%B8%80%E6%AD%A9"><i class="fa fa-link"></i></a>RSpecもう一歩</h2>

<h4>
<span id="railsのコントローラをテストする" class="fragment"></span><a href="#rails%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%82%92%E3%83%86%E3%82%B9%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://www.atmarkit.co.jp/ait/articles/1208/06/news119.html" rel="nofollow noopener" target="_blank">Railsのコントローラをテストする</a>
</h4>

<p>モデルのテスト（unit test）より書きづらいと言われる<br>
コントローラテスト（functional test）ですが、こちらですべきことが分かります。</p>

<h4>
<span id="rspec-でテストを作るのに役立つモックスタブのシンプルな説明" class="fragment"></span><a href="#rspec-%E3%81%A7%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B%E3%81%AE%E3%81%AB%E5%BD%B9%E7%AB%8B%E3%81%A4%E3%83%A2%E3%83%83%E3%82%AF%E3%82%B9%E3%82%BF%E3%83%96%E3%81%AE%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E8%AA%AC%E6%98%8E"><i class="fa fa-link"></i></a><a href="http://morizyun.github.io/blog/rspec-model-controller-ruby-rails/" rel="nofollow noopener" target="_blank">RSpec でテストを作るのに役立つ「モック/スタブ」のシンプルな説明</a>
</h4>

<p>各テストを綺麗に分離していこうすると必要になってきます。</p>

<h2>
<span id="capybara" class="fragment"></span><a href="#capybara"><i class="fa fa-link"></i></a>Capybara</h2>

<p>※概要やセッティングは上記<a href="http://www.oiax.jp/rails/rspec_capybara_primer/basic_structure.html" rel="nofollow noopener" target="_blank">RSpec/Capybara入門-テストの基本構造</a>で掴んでおきましょう。</p>

<h4>
<span id="railsrspec-capybaraでフォーム入力をシミュレートしてテストする" class="fragment"></span><a href="#railsrspec-capybara%E3%81%A7%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E5%85%A5%E5%8A%9B%E3%82%92%E3%82%B7%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%83%86%E3%82%B9%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a><a href="http://qiita.com/kidachi_/items/b0e607c83e9da9380d7e" id="reference-944a9b0f097de045f3ab">[Rails][RSpec] Capybaraでフォーム入力をシミュレートしてテストする</a>
</h4>

<p>Capybaraの便利さを感じる。</p>

<h4>
<span id="capybara-readmemd-ja" class="fragment"></span><a href="#capybara-readmemd-ja"><i class="fa fa-link"></i></a><a href="https://github.com/willnet/capybara-readme-ja#navigating" rel="nofollow noopener" target="_blank">Capybara README.md Ja</a>
</h4>

<p>「何ができるのか」のリファレンスとして、「Navigating」以下の<br>
項目に目を通しておくと良いでしょう。</p>

<h2>
<span id="factorygirl" class="fragment"></span><a href="#factorygirl"><i class="fa fa-link"></i></a>FactoryGirl</h2>

<p>※概要やセッティングは上記<a href="http://www.oiax.jp/rails/rspec_capybara_primer/let_and_factory_girl.html" rel="nofollow noopener" target="_blank">RSpec/Capybara入門-letメソッドとFactory Girl</a>で掴んでおきましょう。</p>

<h4>
<span id="factory_girl-で最低限知っておきたい4つの使い方" class="fragment"></span><a href="#factory_girl-%E3%81%A7%E6%9C%80%E4%BD%8E%E9%99%90%E7%9F%A5%E3%81%A3%E3%81%A6%E3%81%8A%E3%81%8D%E3%81%9F%E3%81%844%E3%81%A4%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a><a href="http://blog.livedoor.jp/sasata299/archives/51931175.html" rel="nofollow noopener" target="_blank">factory_girl で最低限知っておきたい4つの使い方</a>
</h4>

<p>FactoryGirlの概要を理解した後、いざ実践の際に困るのは<br>
「アソシエーションを持つモデルのデータをどう作るか？」ではないでしょうか。<br>
そんな疑問はこちらで解決。</p>

<h4>
<span id="ruby-fixtureからfactorygirlへ" class="fragment"></span><a href="#ruby-fixture%E3%81%8B%E3%82%89factorygirl%E3%81%B8"><i class="fa fa-link"></i></a><a href="http://eblog.drecom.jp/entry/14" rel="nofollow noopener" target="_blank">[Ruby] FixtureからFactoryGirlへ</a>
</h4>

<p>こちらまで理解すればFactoryGirlの普段使いで困ることは無くなると思います。</p>

<h2>
<span id="guardspork" class="fragment"></span><a href="#guardspork"><i class="fa fa-link"></i></a>Guard/Spork</h2>

<h4>
<span id="rails-rspecによるbdd振舞駆動開発の基本-sporkとguardも" class="fragment"></span><a href="#rails-rspec%E3%81%AB%E3%82%88%E3%82%8Bbdd%E6%8C%AF%E8%88%9E%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA%E3%81%AE%E5%9F%BA%E6%9C%AC-spork%E3%81%A8guard%E3%82%82"><i class="fa fa-link"></i></a><a href="http://qiita.com/kidachi_/items/cb8910eb74e924456df9" id="reference-6958a0925323a3fd7d40">[Rails] RSpecによるBDD（振舞駆動開発）の基本 [SporkとGuardも]</a>
</h4>

<p>自動かつ高速な快適テスト環境を作りましょう。</p>

<h2>
<span id="α" class="fragment"></span><a href="#%CE%B1"><i class="fa fa-link"></i></a>＋α</h2>

<h4>
<span id="rails-でつくる-api-のテストの書き方rspec--factorygirl" class="fragment"></span><a href="#rails-%E3%81%A7%E3%81%A4%E3%81%8F%E3%82%8B-api-%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9rspec--factorygirl"><i class="fa fa-link"></i></a><a href="http://blog.inouetakuya.info/entry/2013/10/27/200111" rel="nofollow noopener" target="_blank">Rails でつくる API のテストの書き方（RSpec + FactoryGirl）</a>
</h4>

<p>APIのテストを書きたくなったらこちら。</p>

<h4>
<span id="rubyで標準出力をテストする方法" class="fragment"></span><a href="#ruby%E3%81%A7%E6%A8%99%E6%BA%96%E5%87%BA%E5%8A%9B%E3%82%92%E3%83%86%E3%82%B9%E3%83%88%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a><a href="http://pochi.hatenablog.jp/entries/2010/03/24" rel="nofollow noopener" target="_blank">rubyで標準出力をテストする方法</a>
</h4>

<p>標準出力をテストケースに入れたくなることもありますね。</p>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<p>紹介した記事は必ずしも上から順にクリアしていく必要はなく、<br>
相互に理解を深め合えるような内容です。</p>

<p>よく分からない部分にぶつかっても、どんどん先に進んでみましょう。</p>

<h2>
<span id="バトンタッチ" class="fragment"></span><a href="#%E3%83%90%E3%83%88%E3%83%B3%E3%82%BF%E3%83%83%E3%83%81"><i class="fa fa-link"></i></a>バトンタッチ</h2>

<p>明日のエントリは<a href="https://twitter.com/naghbIQtIqHom" rel="nofollow noopener" target="_blank">@naghbIQtIqHom</a>さんです。<br>
よろしくお願い致します！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />17位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>107</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/e9cb26c4e6cb36b70a1c">[Ruby] 便利な組み込みクラスのメソッド達（Array編）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-06 09:49:09</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p><a href="http://www.amazon.co.jp/gp/product/4774158798/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4774158798&amp;linkCode=as2&amp;tag=kidachi-22" rel="nofollow noopener" target="_blank">パーフェクトRuby</a>を読んでいて便利だと思ったもの一覧です。</p>

<p>Enumerable編<br>
<a href="http://qiita.com/kidachi_/items/a00558cfb0a6a3e23f4b" class="autolink" id="reference-55b90f39d13f80fafd8e">http://qiita.com/kidachi_/items/a00558cfb0a6a3e23f4b</a><br>
Hash編<br>
<a href="http://qiita.com/kidachi_/items/651b5b5580be40ad047e" class="autolink" id="reference-e81e6529716c2cfb3386">http://qiita.com/kidachi_/items/651b5b5580be40ad047e</a><br>
String編<br>
<a href="http://qiita.com/kidachi_/items/7b355eb355b2d1390cf5" class="autolink" id="reference-a573af4860de302a698f">http://qiita.com/kidachi_/items/7b355eb355b2d1390cf5</a></p>

<h2>
<span id="配列の整形" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AE%E6%95%B4%E5%BD%A2"><i class="fa fa-link"></i></a>配列の整形</h2>

<h3>
<span id="compact" class="fragment"></span><a href="#compact"><i class="fa fa-link"></i></a>compact</h3>

<p>配列からnilを除去。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">[</span><span class="kp">false</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="o">[]].</span><span class="n">compact</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="kp">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="o">[]]</span>
</pre></div></div>

<h3>
<span id="uniq" class="fragment"></span><a href="#uniq"><i class="fa fa-link"></i></a>uniq</h3>

<p>配列から重複要素を排除。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java Ruby Python Java)</span><span class="o">.</span><span class="n">uniq</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="flatten" class="fragment"></span><a href="#flatten"><i class="fa fa-link"></i></a>flatten</h3>

<p>多次元配列を一次元にして返却。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="o">[</span><span class="s2">"Python"</span><span class="p">,</span> <span class="o">[</span><span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"C"</span><span class="o">]]]</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">flatten</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"C"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="transpose" class="fragment"></span><a href="#transpose"><i class="fa fa-link"></i></a>transpose</h3>

<p>二次元配列を行列と見立てて、行と列の入れ替えを行う。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]]</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">transpose</span>
<span class="o">=&gt;</span> <span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"Ruby"</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]]</span>
</pre></div></div>

<h3>
<span id="zip" class="fragment"></span><a href="#zip"><i class="fa fa-link"></i></a>zip</h3>

<p>二つの配列を行と列を入れ替えた上で結合する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">arr1</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="n">arr2</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="n">arr1</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"Ruby"</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]]</span>
</pre></div></div>

<h2>
<span id="要素の連結" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E9%80%A3%E7%B5%90"><i class="fa fa-link"></i></a>要素の連結</h2>

<h3>
<span id="join" class="fragment"></span><a href="#join"><i class="fa fa-link"></i></a>join</h3>

<p>要素を連結する。<br>
引数に文字列を与えた場合は、それをセパレータとして連結する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java)</span><span class="o">.</span><span class="n">join</span>
<span class="o">=&gt;</span> <span class="s2">"RubyPythonJava"</span>
<span class="o">&gt;</span> <span class="sx">%w(Ruby Python Java)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby, Python, Java"</span>
</pre></div></div>

<h2>
<span id="要素の取得" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>要素の取得</h2>

<h3>
<span id="sample" class="fragment"></span><a href="#sample"><i class="fa fa-link"></i></a>sample</h3>

<p>与えた引数だけ、ランダムに要素を取り出す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="sx">%w(Ruby Python Java C Smalltalk Brainfuck)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">,</span> <span class="s2">"Smalltalk"</span><span class="p">,</span> <span class="s2">"Brainfuck"</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">sample</span>
<span class="o">=&gt;</span> <span class="s2">"Python"</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">sample</span>
<span class="o">=&gt;</span> <span class="s2">"Brainfuck"</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">sample</span>
<span class="o">=&gt;</span> <span class="s2">"C"</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Smalltalk"</span><span class="o">]</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Smalltalk"</span><span class="p">,</span> <span class="s2">"C"</span><span class="o">]</span>
</pre></div></div>

<h3>
<span id="assoc" class="fragment"></span><a href="#assoc"><i class="fa fa-link"></i></a>assoc</h3>

<p>多次元配列から、キーを指定して要素を取り出す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="o">[[</span><span class="ss">:ruby</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:python</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:java</span><span class="p">,</span> <span class="mi">3</span><span class="o">]]</span>
<span class="o">=&gt;</span> <span class="o">[[</span><span class="ss">:ruby</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:python</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:java</span><span class="p">,</span> <span class="mi">3</span><span class="o">]]</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">assoc</span><span class="p">(</span><span class="ss">:ruby</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:ruby</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>
</pre></div></div>

<h2>
<span id="要素の追加と削除" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E8%BF%BD%E5%8A%A0%E3%81%A8%E5%89%8A%E9%99%A4"><i class="fa fa-link"></i></a>要素の追加と削除</h2>

<h3>
<span id="pop-push-shift-unshift" class="fragment"></span><a href="#pop-push-shift-unshift"><i class="fa fa-link"></i></a>pop, push, shift, unshift</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">arr</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="c1"># 末尾の要素を取り出す</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">pop</span>
<span class="o">=&gt;</span> <span class="s2">"Java"</span>
<span class="c1"># 破壊的</span>
<span class="o">&gt;</span> <span class="n">arr</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="o">]</span>
<span class="c1"># 末尾に要素を追加する</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">"Java"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="c1"># 破壊的</span>
<span class="o">&gt;</span> <span class="n">arr</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>

<span class="c1"># 先頭の要素を取り出す</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">shift</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby"</span>
<span class="c1"># 破壊的</span>
<span class="o">&gt;</span> <span class="n">arr</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="c1"># 先頭に要素を追加する</span>
<span class="o">&gt;</span> <span class="n">arr</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">"Ruby"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>
<span class="c1"># 破壊的</span>
<span class="o">&gt;</span> <span class="n">arr</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>

</pre></div></div>

<p>※ スタック（FirstIn, LastOut/先入れ後出し）は<br>
pop/pushもしくはshift/unshift</p>

<p>※ キュー（FirstIn, FirstOut/先入れ先出し）は<br>
pop/unshiftもしくはpush/shift</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />18位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>97</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/ebdb4b29336955903029">[Rails] セッション管理をベタで実装してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-10 10:24:29</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby on Rails Tutorialのエッセンスを自分なりに整理11</p>

<p>[Rails][RSpec] Capybaraでフォーム入力をシミュレートしてテストする<br>
<a href="http://qiita.com/kidachi_/items/b0e607c83e9da9380d7e" class="autolink" id="reference-f2a7da89c8bd657465bc">http://qiita.com/kidachi_/items/b0e607c83e9da9380d7e</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter8）<br>
<a href="http://railstutorial.jp/chapters/sign-in-sign-out?version=4.0#top" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/sign-in-sign-out?version=4.0#top</a></p>

<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>普通はDeviseなどの便利なgemやライブラリを使うのだろうが、<br>
内部動作を知るためにまとめる。</p>

<p>※ あくまでRails上での「ベタ」です。</p>

<h2>
<span id="セッション管理の流れ" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86%E3%81%AE%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>セッション管理の流れ</h2>

<h4>
<span id="新規登録時" class="fragment"></span><a href="#%E6%96%B0%E8%A6%8F%E7%99%BB%E9%8C%B2%E6%99%82"><i class="fa fa-link"></i></a>新規登録時</h4>

<ol>
<li>ユーザ作成にあわせて、remember_token（セッショントークン）生成</li>
<li>暗号化の上dbに保管</li>
</ol>

<h4>
<span id="ログイン時" class="fragment"></span><a href="#%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E6%99%82"><i class="fa fa-link"></i></a>ログイン時</h4>

<ol>
<li>新たにremember_token生成</li>
<li>cookieにremember_tokenを保管</li>
<li>暗号化の上dbにも保管</li>
<li>コントローラからもビューからもアクセスできる<a href="/current_user" class="user-mention js-hovercard" title="current_user" data-hovercard-target-type="user" data-hovercard-target-name="current_user">@current_user</a>を準備</li>
<li>ユーザアクセスの度、cookieの中身とdbの中身を擦り合わせて照合</li>
<li>サインアウトでセッションを破棄する</li>
</ol>

<p>※ 新規登録時は、連続してログインフローに乗る</p>

<h2>
<span id="セッションリソースの扱い" class="fragment"></span><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E6%89%B1%E3%81%84"><i class="fa fa-link"></i></a>セッションリソースの扱い</h2>

<h4>
<span id="通常usersなどのリソースと同様restfulに管理する" class="fragment"></span><a href="#%E9%80%9A%E5%B8%B8users%E3%81%AA%E3%81%A9%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%A8%E5%90%8C%E6%A7%98restful%E3%81%AB%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>通常（Usersなど）のリソースと同様、RESTfulに管理する</h4>

<table>
<thead>
<tr>
<th>HTTPリクエスト</th>
<th>URL</th>
<th>名前付きルート</th>
<th>アクション</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/signin</td>
<td>signin_path</td>
<td>new</td>
<td>新しいセッション用 (サインイン)</td>
</tr>
<tr>
<td>POST</td>
<td>/sessions</td>
<td>sessions_path</td>
<td>create</td>
<td>新しいセッションを作成する</td>
</tr>
<tr>
<td>DELETE</td>
<td>/signout</td>
<td>signout_path</td>
<td>destroy</td>
<td>セッションを削除する (サインアウト)</td>
</tr>
</tbody>
</table>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">root</span>  <span class="s1">'static_pages#home'</span>
  <span class="n">match</span> <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'users#new'</span><span class="p">,</span>            <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/signin'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#new'</span><span class="p">,</span>         <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/signout'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#destroy'</span><span class="p">,</span>     <span class="ss">via</span><span class="p">:</span> <span class="s1">'delete'</span>
  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<h4>
<span id="ただしストレージはcookie" class="fragment"></span><a href="#%E3%81%9F%E3%81%A0%E3%81%97%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%AFcookie"><i class="fa fa-link"></i></a>ただし、ストレージはCookie</h4>

<p>通常のリソース（Users）などがバックエンドにDBを持つのに対して、<br>
Sessionsリソースはcookiesを利用する。</p>

<h2>
<span id="サインインログイン機能実装" class="fragment"></span><a href="#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E6%A9%9F%E8%83%BD%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>サインイン（ログイン）機能実装</h2>

<ol>
<li>サインインフォーム準備</li>
<li>フォーム値の受け取り（createメソッド）

<ul>
<li>バリデーション</li>
</ul>
</li>
<li>サインイン実行（セッションを張る）

<ul>
<li>sign_in（ほか関連）メソッドの実装</li>
</ul>
</li>
</ol>

<h3>
<span id="サインインフォームの作成" class="fragment"></span><a href="#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>サインインフォームの作成</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">erb</span></div>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="sx">% form_for(:session, </span><span class="ss">url</span><span class="p">:</span> <span class="n">sessions_path</span><span class="p">)</span> <span class="sx">%&gt;</span>
<span class="sx">&lt;% end %&gt;</span>
</pre></div>
</div>

<p>セッションはモデルが存在しないため、リソース名と対応するURLを指定する必要がある。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">erb</span></div>
<div class="highlight"><pre><span></span>    <span class="o">&lt;</span><span class="sx">%= form_for(:session, url: sessions_path) do |f| %&gt;</span>

<span class="sx">      &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="sx">%&gt;</span>
<span class="sx">      &lt;%= f.text_field :email %&gt;</span>

      <span class="o">&lt;</span><span class="sx">%= f.label :password %&gt;</span>
<span class="sx">      &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="sx">%&gt;</span>

<span class="sx">      &lt;%= f.submit "Sign in", class: "btn btn-large btn-primary" %&gt;</span>

    <span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</pre></div>
</div>

<h3>
<span id="フォーム値の受け取りcreateメソッド" class="fragment"></span><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E5%80%A4%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8Acreate%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>フォーム値の受け取り（createメソッド）</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/sessions_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># ユーザーをサインインさせ、ユーザーページ (show) にリダイレクトする。</span>
  <span class="k">else</span>
    <span class="c1"># エラーメッセージを表示し、サインインフォームを再描画する。</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="値のバリデーション" class="fragment"></span><a href="#%E5%80%A4%E3%81%AE%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>値のバリデーション</h3>

<ul>
<li>該当emailのユーザが存在するかどうか</li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
</pre></div></div>

<ul>
<li>パスワードが適切かどうか</li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>

<h3>
<span id="サインイン実行セッションを張る" class="fragment"></span><a href="#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%BC%B5%E3%82%8B"><i class="fa fa-link"></i></a>サインイン実行（セッションを張る）</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/sessions_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>    <span class="c1"># userを解析し、'/users/:id'にリダイレクト</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="sign_inほか関連メソッドの実装" class="fragment"></span><a href="#sign_in%E3%81%BB%E3%81%8B%E9%96%A2%E9%80%A3%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>sign_in（ほか関連）メソッドの実装</h2>

<ul>
<li>サインイン状態を永続化

<ul>
<li>ユーザが明示的にサインアウトしたときのみ破棄</li>
</ul>
</li>
</ul>

<h4>
<span id="流れ" class="fragment"></span><a href="#%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>流れ</h4>

<ol>
<li>新たにremember_token生成</li>
<li>cookieにremember_tokenを保管</li>
<li>暗号化の上dbにも保管</li>
<li>コントローラからもビューからもアクセスできる<a href="/current_user" class="user-mention js-hovercard" title="current_user" data-hovercard-target-type="user" data-hovercard-target-name="current_user">@current_user</a>を準備</li>
<li>ユーザアクセスの度、cookieの中身とdbの中身を擦り合わせて照合</li>
<li>サインアウトでセッションを破棄する</li>
</ol>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/helpers/sessions_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="c1"># signed_in?を経由して、セッションが張られているかどうかを確認する</span>
  <span class="c1"># つまり、（ほとんどの）リクエストの度に呼ぶようにする。</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">remember_token</span><span class="p">:</span> <span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="どこに定義するか" class="fragment"></span><a href="#%E3%81%A9%E3%81%93%E3%81%AB%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>どこに定義するか</h3>

<p>セッション周りのメソッドはコントローラ/ビューのどちらからも使用できるよう、<br>
<strong>SessionsHelper</strong>に定義（モジュール化する）</p>

<h4>
<span id="例えば" class="fragment"></span><a href="#%E4%BE%8B%E3%81%88%E3%81%B0"><i class="fa fa-link"></i></a>例えば</h4>

<p>ビューでsigned_in?でログイン判定し、リンクを出し分けるサンプル</p>

<div class="code-frame" data-lang="html+erb">
<div class="code-lang"><span class="bold">app/views/layouts/_header.html.erb</span></div>
<div class="highlight"><pre><span></span>  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>

<h3>
<span id="コントローラにinclude" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%ABinclude"><i class="fa fa-link"></i></a>コントローラにinclude</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/application_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>
<span class="k">end</span>
</pre></div>
</div>

<p>すべてのヘルパーはビューではデフォルトで使用できる。<br>
コントローラ側で使うには、明示的にapplication_controllerでインクルードしてやる。</p>

<h2>
<span id="remember_token生成ロジックの実装" class="fragment"></span><a href="#remember_token%E7%94%9F%E6%88%90%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>remember_token生成ロジックの実装</h2>

<h3>
<span id="userモデルにremember_token属性を追加" class="fragment"></span><a href="#user%E3%83%A2%E3%83%87%E3%83%AB%E3%81%ABremember_token%E5%B1%9E%E6%80%A7%E3%82%92%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>Userモデルにremember_token属性を追加</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails generate migration add_remember_token_to_users
</pre></div></div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">db/migrate/[ts]_add_remember_token_to_users.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AddRememberTokenToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rake db:migrate
</pre></div></div>

<h3>
<span id="token生成" class="fragment"></span><a href="#token%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>token生成</h3>

<ul>
<li>一意性が担保できる、長くてランダムな文字列を用いる</li>
</ul>

<p>SecureRandomモジュールのurlsafe_base64メソッドを利用</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span>  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_remember_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>
</pre></div></div>

<ul>
<li>万一dbが攻撃されて漏洩された場合に備えて暗号化</li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span>  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div></div>

<h3>
<span id="どこに定義するか-1" class="fragment"></span><a href="#%E3%81%A9%E3%81%93%E3%81%AB%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B%E3%81%8B-1"><i class="fa fa-link"></i></a>どこに定義するか</h3>

<p>remember_tokenの利用シーンは以下ふたつ。</p>

<ul>
<li>サインイン時</li>
<li>新規登録時</li>
</ul>

<p>※新規作成されたユーザは連続してサインインさせるため<br>
サインイン時のみremember_token作成すれば良い様にも思うが、<br>
分離された役割である以上片方に依存すべきではない。<br>
すべてのユーザが必ず最初から有効なremember_tokneを持つ様にすべき。</p>

<p>よって、（新規登録時に生成出来るよう）<strong>Userモデルに定義</strong>する。<br>
→before_create（コールバック）を用いて、User登録のタイミングで生成する。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">~</span>
  <span class="c1"># User生成のタイミングでコールバック</span>
  <span class="n">before_create</span> <span class="ss">:create_remember_token</span>
  <span class="o">~</span>

  <span class="c1"># ログイン時はSessionHelperから呼び出すことになるのでpublic</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_remember_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># 同上</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="c1"># User生成時、before_createコールバックから呼び出す。</span>
    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>

<p>これでサインイン時セッションを張り、サインアウトで破棄する一連のロジックが完成した。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />19位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>85</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/75ae4a29c99a79816384">[Ruby] method_missing()を実用レベルで理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-14 11:15:35</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[メタプログラミング]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p><a href="http://www.amazon.co.jp/gp/product/4048687158/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4048687158&amp;linkCode=as2&amp;tag=kidachi-22" rel="nofollow noopener" target="_blank">メタプログラミングRuby</a>勉強録。</p>

<p>前回は<br>
[Ruby] メタプログラミングの入り口、オープンクラスを理解する<br>
<a href="http://qiita.com/kidachi_/items/b1672f1c16e2d15f2d9c" class="autolink" id="reference-60ddf9e7626a3ef7add3">http://qiita.com/kidachi_/items/b1672f1c16e2d15f2d9c</a></p>

<p>今回のトピックは「Rubyらしいプログラミング」に欠かせない、method_missing()です。</p>

<ul>
<li>method_missing()とは</li>
<li>何に役立つか</li>
<li>危険性と対策</li>
</ul>

<h2>
<span id="method_missingとは" class="fragment"></span><a href="#method_missing%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>method_missing()とは</h2>

<p>メソッド呼び出しの際、継承チェーン（※）を辿った末に呼び出しメソッドが見つからなかった時、<br>
最終的に呼び出されるメソッド。</p>

<p>※継承チェーンはModule#ancestorsで確認できます。<br>
<a href="http://ref.xaio.jp/ruby/classes/module/ancestors" class="autolink" rel="nofollow noopener" target="_blank">http://ref.xaio.jp/ruby/classes/module/ancestors</a></p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Ruby</span>
<span class="k">end</span>

<span class="n">r</span> <span class="o">=</span> <span class="no">Ruby</span><span class="o">.</span><span class="n">new</span>
<span class="n">r</span><span class="o">.</span><span class="n">hello</span>
<span class="o">=&gt;</span> <span class="ss">NoMethodError</span><span class="p">:</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`hello' for #&lt;Ruby:0x007fe4bb9ac7a0&gt;</span>
</pre></div></div>

<p>全てのオブジェクトの継承元であるBasicObjectに定義されているため、<br>
あらゆるオブジェクトからの呼び出しに対応できます。</p>

<p>そして、あくまでこいつも<strong>メソッド</strong>なので、明示的に呼び出すことも可能です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">send</span> <span class="ss">:method_missing</span><span class="p">,</span> <span class="ss">:hello</span>
<span class="o">=&gt;</span> <span class="ss">NoMethodError</span><span class="p">:</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`hello' for #&lt;Ruby:0x007fe4bb9ac7a0&gt;</span>
</pre></div></div>

<p>※Object#sendについてはこちら。<br>
Ruby send メソッド<br>
<a href="http://blog.livedoor.jp/badrequest400/archives/2350825.html" class="autolink" rel="nofollow noopener" target="_blank">http://blog.livedoor.jp/badrequest400/archives/2350825.html</a></p>

<p>method_missing()自体はこれだけですが、<br>
ここでメタプログラマは考えます。</p>

<p>「逆に言えば、method_missing()のタイミングでうまく拾い上げることで、<br>
<strong>未定義メソッドに対しても好きな処理を加えられる</strong>ってことだよね。」</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Ruby</span>
  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="c1"># 好きな処理</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="s2">が呼ばれました。"</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">r</span> <span class="o">=</span> <span class="no">Ruby</span><span class="o">.</span><span class="n">new</span>
<span class="n">r</span><span class="o">.</span><span class="n">hello</span>
<span class="o">=&gt;</span> <span class="s1">'helloが呼ばれました。'</span>
</pre></div></div>

<p>こういうことですね。<br>
'NoMethodError'という、（普通にプログラムを書いている限り）絶対の法則を<br>
ねじ曲げることが出来ました。</p>

<h2>
<span id="何に役立つか" class="fragment"></span><a href="#%E4%BD%95%E3%81%AB%E5%BD%B9%E7%AB%8B%E3%81%A4%E3%81%8B"><i class="fa fa-link"></i></a>何に役立つか</h2>

<p>例えば、外部APIに依存するライブラリ。</p>

<p>サンプルとして、仮にqiitaに関する情報を取得できるAPIがあったとしましょう。<br>
（適当です&amp;実在しませんのであしからず）</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">qiita_api</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">rest</span><span class="o">/</span><span class="p">?</span><span class="nb">method</span><span class="o">=</span><span class="n">qiita</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">findByName</span><span class="o">&amp;</span><span class="n">user_name</span><span class="o">=</span><span class="n">kidachi_</span><span class="o">&amp;</span><span class="n">api_key</span><span class="o">=</span><span class="no">API_KEY</span>
<span class="o">=&gt;</span> 
<span class="p">{</span>
    <span class="s2">"result"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"user"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"id"</span><span class="p">:</span> <span class="mi">8790</span><span class="p">,</span>
            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"kidachi_"</span><span class="p">,</span>
            <span class="s2">"profile_image_url"</span><span class="p">:</span> <span class="s2">"http://img.example.com/kidachi_.png"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>そして、これをRubyで手軽に扱えるようにサポートするgem（ライブラリ）があるとします。<br>
その名もrubiita（同じく実在しません。ネーミングx）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rubiita'</span>

<span class="n">qiita</span> <span class="o">=</span> <span class="no">Rubiita</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">API_KEY</span><span class="p">)</span>
<span class="n">kidachi_</span> <span class="o">=</span> <span class="n">qiita</span><span class="o">.</span><span class="n">user_findByName</span><span class="p">(</span><span class="ss">user_name</span><span class="p">:</span> <span class="s2">"kidachi_"</span><span class="p">)</span>
<span class="n">kidachi_</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile_image_url</span>
<span class="o">=&gt;</span> <span class="s2">"http://img.example.com/kidachi_.png"</span>

<span class="n">qiita_users</span> <span class="o">=</span> <span class="n">qiita</span><span class="o">.</span><span class="n">user_findAll</span>
<span class="n">qiita_users</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">users</span>
<span class="o">=&gt;</span>
<span class="o">[</span>
    <span class="p">{</span>
      <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span>
      <span class="s2">"profile_image_url"</span><span class="p">:</span> <span class="s2">"http://img.example.com/foo.png"</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">,</span>
      <span class="s2">"profile_image_url"</span><span class="p">:</span> <span class="s2">"http://img.example.com/bar.png"</span>
    <span class="p">}</span>   
<span class="o">]</span>
</pre></div></div>

<p>こんな感じですね。<br>
API上での</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>?method<span class="o">=</span>qiita.user.findByName<span class="p">&amp;</span><span class="nv">user_name</span><span class="o">=</span>kidachi_」
</pre></div></div>

<p>というパラメータを</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">qiita</span><span class="o">.</span><span class="n">user_findByName</span><span class="p">(</span><span class="ss">user_name</span><span class="p">:</span> <span class="s2">"kidachi_"</span><span class="p">)</span>
</pre></div></div>

<p>とRubyライクなメソッドとして扱えるようにしています。</p>

<p>さて、もしかするとここで疑問が出るかもしれません。</p>

<p>「このライブラリ、qiitaのAPIがアップデートされて<br>
使えるメソッドが追加・修正される度にあわせて更新しないと<br>
いけないよね？めんどくさいね」と。</p>

<h5>
<span id="実はその必要はありません" class="fragment"></span><a href="#%E5%AE%9F%E3%81%AF%E3%81%9D%E3%81%AE%E5%BF%85%E8%A6%81%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93"><i class="fa fa-link"></i></a>実は、その必要はありません。</h5>

<p>rubiitaの実装を見てみましょう。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Rubiita</span>
  <span class="nb">require</span> <span class="s1">'net/http'</span>
  <span class="nb">require</span> <span class="s1">'uri'</span>
  <span class="nb">require</span> <span class="s1">'json'</span>

  <span class="no">END_POINT</span> <span class="o">=</span> <span class="s1">'https://qiita_api.example.com/services/rest/'</span>
  <span class="no">API_KEY</span> <span class="o">=</span> <span class="s1">'hoge'</span>

  <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">json</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">get_uri</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="n">result</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="n">request</span><span class="p">(</span><span class="nb">method</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/_/</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">get_uri</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">formatted_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span>
      <span class="n">param</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="o">|</span>
        <span class="n">key</span><span class="o">.</span><span class="n">to_s</span><span class="o">+</span><span class="s2">"="</span><span class="o">+</span><span class="n">val</span><span class="o">.</span><span class="n">to_s</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">formatted_params</span> <span class="o">=</span> <span class="n">formatted_params</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"&amp;"</span><span class="p">)</span>
    <span class="nb">method</span> <span class="o">=</span> <span class="s2">"?method="</span><span class="o">+</span><span class="nb">method</span><span class="o">+</span><span class="s2">"&amp;"</span>
    <span class="n">request_uri</span> <span class="o">=</span> <span class="no">END_POINT</span><span class="o">+</span><span class="nb">method</span><span class="o">+</span><span class="n">formatted_params</span><span class="o">+</span><span class="no">API_KEY</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div>

<p>request()はAPIリクエストを飛ばしているだけなのであまり大事ではないです。<br>
ポイントはmethod_missing()とget_uri()ですね。</p>

<p>method_missing()により、<br>
rubiitaから受け取ったメソッド名のアンダースコアをドットに置換し、<br>
パラメータ群はget_uri()に送ります。<br>
そしてget_uri()でGET形式のAPIに適したURIを動的に生成しています。</p>

<p>これにより、qiitaAPIのメソッドが</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>?method<span class="o">=</span>qiita.user.findByName<span class="p">&amp;</span><span class="nv">user_name</span><span class="o">=</span>kidachi_
?method<span class="o">=</span>qiita.user.findAll
?method<span class="o">=</span>qiita.user.newMethodFugaFuga<span class="p">&amp;</span><span class="nv">foo</span><span class="o">=</span>bar
</pre></div></div>

<p>こういったどのようなパターンであっても、<br>
rubiitaユーザに</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">qiita</span><span class="o">.</span><span class="n">SEGMENT</span><span class="o">.</span><span class="n">METHOD_NAME</span><span class="p">(</span><span class="no">PARAMS</span><span class="p">)</span>
</pre></div></div>

<p>というルールに則ってもらいさえすれば、</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">qiita</span><span class="o">.</span><span class="n">user_findByName</span><span class="p">(</span><span class="ss">user_name</span><span class="p">:</span> <span class="s2">"kidachi_"</span><span class="p">)</span>
<span class="n">qiita</span><span class="o">.</span><span class="n">user_findAll</span>
<span class="n">qiita</span><span class="o">.</span><span class="n">new_methodFugaFuga</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="n">bar</span><span class="p">)</span>
</pre></div></div>

<p>全てが適切なメソッドとしてサポートされます。</p>

<p>将来、今は存在しない新しいメソッドが提供されようと、<br>
全て吸収できてしまうのです。</p>

<p>便利ですね！</p>

<h3>
<span id="ゴーストメソッド" class="fragment"></span><a href="#%E3%82%B4%E3%83%BC%E3%82%B9%E3%83%88%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>ゴーストメソッド</h3>

<p>上記例のような、<strong>未定義だがmethod_missing()で拾うことを前提</strong><br>
としたメソッドを<strong>ゴーストメソッド</strong>と呼びます。</p>

<h2>
<span id="method_missingで陥りやすいバグ" class="fragment"></span><a href="#method_missing%E3%81%A7%E9%99%A5%E3%82%8A%E3%82%84%E3%81%99%E3%81%84%E3%83%90%E3%82%B0"><i class="fa fa-link"></i></a>method_missing()で陥りやすいバグ</h2>

<p>最後に、method_missing()の危険性も見ておきます。<br>
※メタプログラミングRubyの例そのままですが。</p>

<p>ぜひ一度どこに問題が潜んでいるか考えてみてください。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Roulette</span>
  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">person</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">capitalize</span>
    <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">number</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">number</span><span class="si">}</span><span class="s2">..."</span>
    <span class="k">end</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">person</span><span class="si">}</span><span class="s2"> got a </span><span class="si">#{</span><span class="n">number</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">number_of</span> <span class="o">=</span> <span class="no">Roulette</span><span class="o">.</span><span class="n">new</span>
<span class="nb">puts</span> <span class="n">number_of</span><span class="o">.</span><span class="n">bob</span>
<span class="nb">puts</span> <span class="n">number_of</span><span class="o">.</span><span class="n">frank</span>
</pre></div></div>

<p>このコード、Rouletteの名前通り、以下のように<br>
人物ごとにランダム値が得られる結果を期待しています。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="mi">5</span><span class="err">…</span>
<span class="mi">6</span><span class="err">…</span>
<span class="mi">10</span><span class="err">…</span>
<span class="no">Bob</span> <span class="n">got</span> <span class="n">a</span> <span class="mi">10</span>
<span class="mi">7</span><span class="err">…</span>
<span class="mi">4</span><span class="err">…</span>
<span class="mi">3</span><span class="err">…</span>
<span class="no">Frank</span> <span class="n">got</span> <span class="n">a</span> <span class="mi">3</span>
</pre></div></div>

<p>ですが、実際には</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="mi">9</span><span class="o">...</span>
<span class="mi">3</span><span class="o">...</span>
<span class="mi">5</span><span class="o">...</span>
<span class="mi">7</span><span class="o">...</span>
<span class="err">…</span>
<span class="err">…</span>
<span class="ss">SystemStackError</span><span class="p">:</span> <span class="n">stack</span> <span class="n">level</span> <span class="n">too</span> <span class="n">deep</span> <span class="n">from</span><span class="o">..</span>
</pre></div></div>

<p>このように無限ループの後StackOverFlowが発生してします。</p>

<p>原因は、ブロックローカル変数であるnumberです。</p>

<ul>
<li>ブロック内で定義したブロックローカル変数は外部から参照できない</li>
<li>そのため、「"#{person} got a #{number}"」のタイミングで
Rubyはそれ（number）を「メソッド」だと認識し、探しにいく</li>
<li>しかし継承チェーン内に見つからないためmethod_missing()が呼ばれる</li>
<li>だが、そもそも今回の問題は（オーバーライドした）method_missing()自体で起きている</li>
<li>よってバグは無限ループし続ける</li>
</ul>

<p>この問題、予期できましたでしょうか？</p>

<h4>
<span id="method_missingにバグが潜んでいると特定しづらい問題に発展しやすい" class="fragment"></span><a href="#method_missing%E3%81%AB%E3%83%90%E3%82%B0%E3%81%8C%E6%BD%9C%E3%82%93%E3%81%A7%E3%81%84%E3%82%8B%E3%81%A8%E7%89%B9%E5%AE%9A%E3%81%97%E3%81%A5%E3%82%89%E3%81%84%E5%95%8F%E9%A1%8C%E3%81%AB%E7%99%BA%E5%B1%95%E3%81%97%E3%82%84%E3%81%99%E3%81%84"><i class="fa fa-link"></i></a>method_missingにバグが潜んでいると、特定しづらい（問題に発展しやすい）</h4>

<p>ということが分かると思います。</p>

<h3>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h3>

<p>シンプルですが、</p>

<h5>
<span id="必要のないゴーストメソッドは導入しない" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AE%E3%81%AA%E3%81%84%E3%82%B4%E3%83%BC%E3%82%B9%E3%83%88%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%E5%B0%8E%E5%85%A5%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>必要のないゴーストメソッドは導入しない</h5>

<p>こと。</p>

<p>つまり、事前に予期されるゴーストメソッド（の名前）以外は受け付けないようにする、ということですね。</p>

<h5>
<span id="対策例" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96%E4%BE%8B"><i class="fa fa-link"></i></a>対策例</h5>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Roulette</span>
  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">person</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">capitalize</span>
    <span class="c1"># 想定される3名以外は通常通りのmethod_missing（super）を呼び出す</span>
    <span class="k">super</span> <span class="k">unless</span> <span class="sx">%w[Bob Frank Bill]</span><span class="o">.</span><span class="n">include?</span> <span class="n">person</span>    
    <span class="c1"># numberをブロック外から参照できるように事前にセット。</span>
    <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">number</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">number</span><span class="si">}</span><span class="s2">..."</span>
    <span class="k">end</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">person</span><span class="si">}</span><span class="s2"> got a </span><span class="si">#{</span><span class="n">number</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">number_of</span> <span class="o">=</span> <span class="no">Roulette</span><span class="o">.</span><span class="n">new</span>

<span class="c1"># 受け付けられない</span>
<span class="nb">puts</span> <span class="n">number_of</span><span class="o">.</span><span class="n">hogehoge</span>
<span class="o">=&gt;</span> <span class="ss">NoMethodError</span><span class="p">:</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`hogehoge' for #&lt;Roulette:0x007fe4bb9ac7a0&gt;</span>

<span class="sb">puts number_of.bob</span>
<span class="sb">=&gt; 3...</span>
<span class="sb">   5...</span>
<span class="sb">   5...</span>
<span class="sb">   Bob got a 5</span>
</pre></div></div>

<h2>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h2>

<p>オープンクラスのエントリの結論と一緒です！<br>
<a href="http://qiita.com/kidachi_/items/b1672f1c16e2d15f2d9c#ps1" class="autolink" id="reference-60ddf9e7626a3ef7add3">http://qiita.com/kidachi_/items/b1672f1c16e2d15f2d9c#ps1</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />20位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>82</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/ee2de96a41672ca64dbb">SSL通信時発生する証明書エラーとその仕組みを理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-29 22:39:29</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Linux]</b> <b>[SSL]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>(2014/1/30追記) <br>
Yahoo!のWebAPIやOpenIDでも同様の事象があったようです。<br>
かなり影響の大きい問題だったのですね。</p>

<p>WebAPIやOpenIDでSSLエラーが起きる現象につきまして<br>
<a href="http://techblog.yahoo.co.jp/maintenance/4/" class="autolink" rel="nofollow noopener" target="_blank">http://techblog.yahoo.co.jp/maintenance/4/</a></p>

<h2>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h2>

<p>curlでとあるhttpsスキームのAPIを叩いたら、こんなエラーが。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>SSL certificate problem, verify that the CA cert is OK. Details:
error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed
</pre></div></div>

<p>後付けで分かりましたが、原因は以下でした。</p>

<p>RHEL5/CentOS5でGlobalSignのルート証明書が有効期限切れで大騒ぎ<br>
<a href="http://heartbeats.jp/hbblog/2014/01/rhel5centos5globalsign.html" class="autolink" rel="nofollow noopener" target="_blank">http://heartbeats.jp/hbblog/2014/01/rhel5centos5globalsign.html</a></p>

<p>記事内にもある通り、取り急ぎの対応は</p>

<h4>
<span id="接続側で証明書検証をしないようにするcurlコマンドなら--k-をつける" class="fragment"></span><a href="#%E6%8E%A5%E7%B6%9A%E5%81%B4%E3%81%A7%E8%A8%BC%E6%98%8E%E6%9B%B8%E6%A4%9C%E8%A8%BC%E3%82%92%E3%81%97%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8Bcurl%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AA%E3%82%89--k-%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>接続側で証明書検証をしないようにする（curlコマンドなら -k をつける）</h4>

<p>だったりするのですが、はじめは</p>

<h4>
<span id="証明書切れた癖に検証スルー出来るってどういうことそもそもそんな証明書意味ないんでは" class="fragment"></span><a href="#%E8%A8%BC%E6%98%8E%E6%9B%B8%E5%88%87%E3%82%8C%E3%81%9F%E7%99%96%E3%81%AB%E6%A4%9C%E8%A8%BC%E3%82%B9%E3%83%AB%E3%83%BC%E5%87%BA%E6%9D%A5%E3%82%8B%E3%81%A3%E3%81%A6%E3%81%A9%E3%81%86%E3%81%84%E3%81%86%E3%81%93%E3%81%A8%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%81%9D%E3%82%93%E3%81%AA%E8%A8%BC%E6%98%8E%E6%9B%B8%E6%84%8F%E5%91%B3%E3%81%AA%E3%81%84%E3%82%93%E3%81%A7%E3%81%AF"><i class="fa fa-link"></i></a>証明書切れた癖に検証スルー出来るってどういうこと？そもそもそんな証明書意味ないんでは</h4>

<p>とか思ってました・・</p>

<p>ということで、恥を忍んでもろもろ整理してみます。</p>

<h2>
<span id="何が起こっていたのか" class="fragment"></span><a href="#%E4%BD%95%E3%81%8C%E8%B5%B7%E3%81%93%E3%81%A3%E3%81%A6%E3%81%84%E3%81%9F%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>何が起こっていたのか</h2>

<p>結論は<strong>クライアント側にインストールされているルート証明書の有効期限切れ</strong>なのですが、順を追ってみます。</p>

<h3>
<span id="そもそものsslの仕組みをざっくりと" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%81%AEssl%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF%E3%82%92%E3%81%96%E3%81%A3%E3%81%8F%E3%82%8A%E3%81%A8"><i class="fa fa-link"></i></a>そもそものSSLの仕組みをざっくりと</h3>

<p>まずSSLの仕組みを把握しておく必要がありました。<br>
ものすごいざっくりですが、大枠は以下の流れになります。</p>

<ul>
<li><p>もともと、各クライアント（※）には、SSL通信に備えて（認証局/CAが発行した）ルート証明書がインストールされている。</p></li>
<li><p>そのルート証明書によって、（接続先のサーバから得られる）サーバ証明書を検証し、認証局によって正当性が担保されているかどうかチェックする。</p></li>
<li><p>サーバが正当と分かれば、クライアントは共通鍵を準備、サーバへ送信し、以降はその共通鍵を用いて通信を行う。</p></li>
</ul>

<p>※ここで言うクライアントとは「あるサーバに対して接続を行う主体/接続元」のこと。<br>
つまりそれは、ブラウザだったり、サーバだったり、何でも有り得ます。</p>

<p>※SSLについての詳細は、以下記事が分かりやすかったです。<br>
イケメンとラブレターで学ぶSSLの仕組み<br>
<a href="http://blog.jnito.com/entry/2013/05/26/064803" class="autolink" rel="nofollow noopener" target="_blank">http://blog.jnito.com/entry/2013/05/26/064803</a></p>

<h3>
<span id="つまりエラーが発生するのは" class="fragment"></span><a href="#%E3%81%A4%E3%81%BE%E3%82%8A%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E3%81%AE%E3%81%AF"><i class="fa fa-link"></i></a>つまり、エラーが発生するのは</h3>

<p>SSLの流れから考えて、基本的に遭遇するのは以下2パターンだと分かります。</p>

<ul>
<li>サーバ側の証明書が不正（有効期限切れorもともと認証局によって正当性が担保されていない、等）</li>
<li>クライアント側にインストールされているルート証明書が不正（有効期限切れ等）</li>
</ul>

<p>前者が特によくあるやつですね。</p>

<p><a href="https://camo.qiitausercontent.com/9e3e3ed0150f672952746cbfc569e1f4a7e4c41b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62653437386466342d393936382d313736632d336532322d3230356230616638373638332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9e3e3ed0150f672952746cbfc569e1f4a7e4c41b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f62653437386466342d393936382d313736632d336532322d3230356230616638373638332e706e67" alt="スクリーンショット_2014_01_29_21_50-2.png" title="スクリーンショット_2014_01_29_21_50-2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/be478df4-9968-176c-3e22-205b0af87683.png"></a></p>

<p>通常のwebユーザーとしてもちょくちょく遭遇するこれです。</p>

<p>ですが、今回の原因は<strong>後者</strong>でした。</p>

<p>RHEL5/CentOS5でGlobalSignのルート証明書が有効期限切れで大騒ぎ<br>
<a href="http://heartbeats.jp/hbblog/2014/01/rhel5centos5globalsign.html" class="autolink" rel="nofollow noopener" target="_blank">http://heartbeats.jp/hbblog/2014/01/rhel5centos5globalsign.html</a></p>

<p>つまり、</p>

<h4>
<span id="接続先サーバの正当性をチェックするためのクライアント側となる接続元サーバcentosredhatのチェック用証明書" class="fragment"></span><a href="#%E6%8E%A5%E7%B6%9A%E5%85%88%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E6%AD%A3%E5%BD%93%E6%80%A7%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%81%A8%E3%81%AA%E3%82%8B%E6%8E%A5%E7%B6%9A%E5%85%83%E3%82%B5%E3%83%BC%E3%83%90centosredhat%E3%81%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E7%94%A8%E8%A8%BC%E6%98%8E%E6%9B%B8"><i class="fa fa-link"></i></a>（接続先サーバの正当性をチェックするための）クライアント側（となる接続元サーバ（CentOS/RedHat））のチェック用証明書</h4>

<p>が期限切れで使えなくなってしまったということ。</p>

<p>こう考えると、</p>

<h4>
<span id="取り急ぎの対応として接続先サーバの正当性チェックを止めることでエラーは回避できる" class="fragment"></span><a href="#%E5%8F%96%E3%82%8A%E6%80%A5%E3%81%8E%E3%81%AE%E5%AF%BE%E5%BF%9C%E3%81%A8%E3%81%97%E3%81%A6%E6%8E%A5%E7%B6%9A%E5%85%88%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E6%AD%A3%E5%BD%93%E6%80%A7%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%82%92%E6%AD%A2%E3%82%81%E3%82%8B%E3%81%93%E3%81%A8%E3%81%A7%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AF%E5%9B%9E%E9%81%BF%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>取り急ぎの対応として、接続先サーバの正当性チェックを止める（ことでエラーは回避できる）</h4>

<p>というのも納得ですね（もちろん、その際は接続先が間違いなく信頼できる、という前提が必要ですが）。</p>

<p>はじめに問題に遭遇した時は</p>

<ul>
<li>クライアント（接続元）としてのサーバ（チェックする側）</li>
<li>接続先としてのサーバ（チェックされる側）</li>
</ul>

<p>という二者を混同していたようです。</p>

<h2>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h2>

<p>概念としては、基本は以下の二つになります。</p>

<ul>
<li>（上記の通り）接続先のチェックを止めてしまう</li>
<li>クライアント側にインストールされているルート証明書を最新にする</li>
</ul>

<p>今回は問題の仕組みの理解/説明を残しておきたかったということで、<br>
対策の詳細は以下記事へのポインタのみで失礼します！</p>

<p>[PHP][cURL] cURLでSSL（https）のCA証明書警告の回避や設定<br>
<a href="http://mio-koduki.blogspot.jp/2012/08/php-curlsslhttpsca.html" class="autolink" rel="nofollow noopener" target="_blank">http://mio-koduki.blogspot.jp/2012/08/php-curlsslhttpsca.html</a></p>

<p>サーバのSSL CA(認証局)証明書が古くてcurl がエラーになる件<br>
<a href="http://d.hatena.ne.jp/hogem/20120705/1340284071" class="autolink" rel="nofollow noopener" target="_blank">http://d.hatena.ne.jp/hogem/20120705/1340284071</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />21位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>69</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/5cebbe4db5e3fbbaaca8">[Objective-C] デリゲート（Delegate）とは</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-04 15:47:42</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Objective-C]</b> <b>[iOS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>あるクラスだけでは処理できない命令を、そのクラスの変わりに行うクラス（に引き渡すこと）。</p>

<ul>
<li>どのクラスもデリゲート（代理人）になることができる。</li>
</ul>

<h2>
<span id="デリゲートの手順" class="fragment"></span><a href="#%E3%83%87%E3%83%AA%E3%82%B2%E3%83%BC%E3%83%88%E3%81%AE%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>デリゲートの手順</h2>

<ol>
<li>UIパーツとデリゲート（先のクラス）を接続する</li>
<li>デリゲート（先のクラス）にプロトコル名を書く</li>
<li>デリゲート（先のクラス）に処理を書く</li>
</ol>

<h2>
<span id="sample" class="fragment"></span><a href="#sample"><i class="fa fa-link"></i></a>Sample</h2>

<p>StoryBoardを使って、検索バー（UISearchBar）の処理をViewControllerにデリゲートしてみる。</p>

<p>※UISearchBarは「ユーザがタップした際にキーボードを表示する機能」や<br>
「入力された文字列を自身の上に表示する機能」が用意されているが、<br>
「入力された文字列をどのように扱うか」などは追加で（デリゲートして）実装する必要がある。</p>

<h2>
<span id="uiパーツとデリゲート先のクラスを接続する" class="fragment"></span><a href="#ui%E3%83%91%E3%83%BC%E3%83%84%E3%81%A8%E3%83%87%E3%83%AA%E3%82%B2%E3%83%BC%E3%83%88%E5%85%88%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>UIパーツとデリゲート（先のクラス）を接続する</h2>

<p>StoryBoard上で、処理をデリゲートに依頼するUIパーツ（今回はUISearchBar）を右クリックし、<br>
delegateプロパティをViewControllerクラスにドラッグし接続する。</p>

<h2>
<span id="デリゲート先のクラスにプロトコル名を書く" class="fragment"></span><a href="#%E3%83%87%E3%83%AA%E3%82%B2%E3%83%BC%E3%83%88%E5%85%88%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E5%90%8D%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>デリゲート（先のクラス）にプロトコル名を書く</h2>

<p>デリゲートされる側のヘッダファイル（今回はViewController.h）上で<br>
「UISearchBarクラスの代理人であること」を宣言する。</p>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span><span class="k">@interface</span> <span class="nc">VIewController</span> : <span class="bp">UIViewController</span> <span class="o">&lt;</span><span class="bp">UISearchBarDelegate</span><span class="o">&gt;</span>
</pre></div></div>

<p>（UISearchBarDelegateというプロトコルを宣言）</p>

<h2>
<span id="デリゲート先のクラスに処理を書く" class="fragment"></span><a href="#%E3%83%87%E3%83%AA%E3%82%B2%E3%83%BC%E3%83%88%E5%85%88%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E5%87%A6%E7%90%86%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>デリゲート（先のクラス）に処理を書く</h2>

<p>処理を書く場所はプロトコルによって定められている。<br>
今回の例のようにSearchBarのデリゲートになった場合は、<br>
searchBarSearchButtonClicked:メソッド内に処理を書く。</p>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">searchBarSearchButtonClicked:</span><span class="p">(</span><span class="bp">UISearchBar</span> <span class="o">*</span><span class="p">)</span><span class="nv">searchBar</span>
<span class="p">{</span>
    <span class="c1">//デリゲート側で行う処理</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>iPhoneアプリ開発超入門<br>
<a href="http://www.sbcr.jp/products/4797369434.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.sbcr.jp/products/4797369434.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />22位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>63</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/b1672f1c16e2d15f2d9c">[Ruby] メタプログラミングの入り口、オープンクラスを理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-14 11:15:27</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[メタプログラミング]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p><a href="http://www.amazon.co.jp/gp/product/4048687158/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4048687158&amp;linkCode=as2&amp;tag=kidachi-22" rel="nofollow noopener" target="_blank">メタプログラミングRuby</a>勉強録。</p>

<p>今回のトピックはメタプログラミングの代名詞の一つ、オープンクラスです。</p>

<h2>
<span id="オープンクラスとは" class="fragment"></span><a href="#%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>オープンクラスとは</h2>

<p>既存するクラスを好きな場所で再オープンし、<br>
メソッド修正・追加など任意の変更を加えられる機能のこと。</p>

<h3>
<span id="例えば" class="fragment"></span><a href="#%E4%BE%8B%E3%81%88%E3%81%B0"><i class="fa fa-link"></i></a>例えば</h3>

<p>以下のような文字列操作メソッドがあったとします。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">love_ruby</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
  <span class="n">str</span> <span class="o">+</span> <span class="s1">' I love Ruby!'</span> 
<span class="k">end</span>

<span class="n">love_ruby</span><span class="p">(</span><span class="s1">'My name is kidachi.'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"My name is kidachi. I love Ruby!"</span>
</pre></div></div>

<p>取りあえずトップレベルに定義しましたが、<br>
オブジェクティブにするため、クラスに所属するようにしましょう。<br>
そこで、<strong>オープンクラスを使ってStringクラス自体を改変</strong>します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">String</span>
  <span class="k">def</span> <span class="nf">love_ruby</span>
    <span class="nb">self</span> <span class="o">+</span> <span class="s1">' I love Ruby!'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="s1">'My name is kidachi.'</span><span class="o">.</span><span class="n">love_ruby</span>
<span class="o">=&gt;</span> <span class="s2">"My name is kidachi. I love Ruby!"</span>
</pre></div></div>

<p>これでStringクラスを改変できました。<br>
以後、あらゆる文字列がlove_rubyメソッドを利用できます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s1">'Foo!'</span><span class="o">.</span><span class="n">love_ruby</span>
<span class="o">=&gt;</span> <span class="s2">"Foo! I love Ruby!"</span>

<span class="s1">'Bar!'</span><span class="o">.</span><span class="n">love_ruby</span>
<span class="o">=&gt;</span> <span class="s2">"Bar! I love Ruby!"</span>

<span class="s1">'I love Ruby!'</span><span class="o">.</span><span class="n">love_ruby</span>
<span class="o">=&gt;</span> <span class="s2">"I love Ruby! I love Ruby!"</span>
</pre></div></div>

<p>これがオープンクラスの力です。</p>

<p>また、新規メソッドを定義するだけでなく、<br>
<strong>既存のメソッドを書き換えてしまう</strong>ことも可能です。</p>

<p>例えば、文字列操作でよく使うupcaseを書き換えてみましょう。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># 本来のupcase</span>
<span class="s1">'I love Ruby!'</span><span class="o">.</span><span class="n">upcase</span>
<span class="o">=&gt;</span> <span class="s2">"I LOVE RUBY!"</span>

<span class="c1"># オープンクラスによりupcase自体を書き換え</span>
<span class="k">class</span> <span class="nc">String</span>
  <span class="k">def</span> <span class="nf">upcase</span>
    <span class="nb">self</span> <span class="o">+</span> <span class="s1">' I love Ruby!'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 改変後のupcase</span>
<span class="s1">'I love Ruby!'</span><span class="o">.</span><span class="n">upcase</span>
<span class="o">=&gt;</span> <span class="s2">"I love Ruby! I love Ruby!"</span>
</pre></div></div>

<p>いかがでしょうか。<br>
ここまでで、その強力さと同時に危険さが伝わったかと思います。</p>

<p>いくらRubyのことが好きでも、大文字変換が期待されるメソッドを<br>
まったく関係のない機能で上書いてしまうのは、ただのテロですよね。</p>

<p>つまり、オープンクラスは、<br>
<strong>その気になればStringやArrayと言ったコアなクラスも<br>
思いのままに破壊できてしまう危険性</strong><br>
を伴っているということ。</p>

<p>よってオープンクラスを使う際は以下のルールを守るべきです。</p>

<ul>
<li>全ての文字列が保持しても問題のない汎用的な機能か見極める</li>
<li>充分にテストする</li>
</ul>

<p>つまり上記例で言うと、upcaseの書き換えはもちろん、<br>
汎用性に欠けるlove_rubyメソッドも本来オープンクラスで<br>
追加するようなものではないということですね。</p>

<h3>
<span id="代替案" class="fragment"></span><a href="#%E4%BB%A3%E6%9B%BF%E6%A1%88"><i class="fa fa-link"></i></a>代替案</h3>

<p>love_rubyメソッドのように、限定的な場面でのみ<br>
使いたい/使われるべき機能の場合は、</p>

<ul>
<li>大人しく拡張Stringクラスを定義する</li>
<li>（Ruby2.0以上の場合は）refinmentsを用いる</li>
</ul>

<p>という選択肢があります。</p>

<p>※refinments<br>
オープンクラスの影響を特定範囲に限定出来る。<br>
ただし、Ruby2.0で実験的実装、2.1で正式採用という<br>
非常に新しい機能なので、利用の際は最新情報キャッチアップの上でどうぞ！</p>

<p>参考）Refinementsとは何だったのか<br>
<a href="http://magazine.rubyist.net/?0041-200Special-refinement" class="autolink" rel="nofollow noopener" target="_blank">http://magazine.rubyist.net/?0041-200Special-refinement</a></p>

<h3>
<span id="モンキーパッチ" class="fragment"></span><a href="#%E3%83%A2%E3%83%B3%E3%82%AD%E3%83%BC%E3%83%91%E3%83%83%E3%83%81"><i class="fa fa-link"></i></a>モンキーパッチ</h3>

<p><strong>オープンクラスにより既存のメソッドを置き換えること</strong>を<strong>モンキーパッチ</strong>と言います。</p>

<p>また、特に、<strong>意図せずに既存メソッドを書き換えてしまった事象のこと</strong>や、<br>
それゆえに<strong>マイナスイメージを伴うもの</strong>を意味する向きもあります。</p>

<p>もちろん普通に便利なものとして使うことも。<br>
明確な定義はなく、細かいところはその場の文脈で変わる様です。</p>

<p>上記のString#upcaseの書き換えは（良くない）モンキーパッチですね。</p>

<p><a></a></p>

<h2>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h2>

<p>オープンクラス（に限らずメタプログラミング全般）は</p>

<ul>
<li>既存クラスをいつでも思いのままに修正出来る利便性</li>
<li>ルールを破壊してしまう危険性</li>
</ul>

<p>を備えています。</p>

<p>メタプログラミングの入り口に立った私たちは、<br>
今後常に<strong>Matzのことば</strong>を頭の片隅に置いておきたいですね。</p>

<p>「Rubyは君を信頼する。Rubyは君を分別のあるプログラマとして扱う。<br>
Rubyはメタプログラミングのような強力な力を与える。<br>
ただし、大いなる力には、大いなる責任が伴うことを忘れてはいけない」</p>

<p>-「メタプログラミングRuby」序文より。</p>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>[Ruby] method_missing()を実用レベルで理解する<br>
<a href="http://qiita.com/kidachi_/items/75ae4a29c99a79816384" class="autolink" id="reference-5537eed934b87a081903">http://qiita.com/kidachi_/items/75ae4a29c99a79816384</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />23位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>58</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/866c7ea6ce7eaf02c35c">Objective-Cの基本</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-22 20:55:04</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Objective-C]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="用語整理" class="fragment"></span><a href="#%E7%94%A8%E8%AA%9E%E6%95%B4%E7%90%86"><i class="fa fa-link"></i></a>用語整理</h2>

<ul>
<li><p>ビルド<br>
コンパイルとリンクを経て実行可能ファイルを生成。</p></li>
<li><p>コンパイル<br>
ソースコードを中間オブジェクトに変換。</p></li>
<li><p>リンク<br>
諸々のライブラリやファイルを結合させて一つにまとめる。</p></li>
<li><p>コンパイラディレクティブ<br>
Objective-Cにおいて、@で始まるものはプログラムでは無くコンパイラへの指示。<br>
これをコンパイラディレクティブと言う。</p></li>
</ul>

<h2>
<span id="変数の利用" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E3%81%AE%E5%88%A9%E7%94%A8"><i class="fa fa-link"></i></a>変数の利用</h2>

<ul>
<li>変数を利用するには
最初に宣言文を記述しておく必要がある。</li>
</ul>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
</pre></div></div>

<ul>
<li>型における演算子の注意点</li>
</ul>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="p">;</span>
</pre></div></div>

<p>この際、float c は1.5でなく1となる（int同士のa/bが先に計算されるため）。</p>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
</pre></div></div>

<p>このように、aもしくはbもしくはab双方をfloat型にキャストしておけば、<br>
intよりもfloatが優先され、計算結果もfloatとなり、cに正しい値が入る。</p>

<h2>
<span id="構造体" class="fragment"></span><a href="#%E6%A7%8B%E9%80%A0%E4%BD%93"><i class="fa fa-link"></i></a>構造体</h2>

<p>複数のメンバを持つデータ</p>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Person</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">height</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">weight</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">birthYear</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Person</span> <span class="c1">//struct PersionにPersionというaliasを切る。</span>

<span class="n">Persion</span> <span class="n">a</span><span class="p">;</span> <span class="c1">//変数宣言</span>
<span class="n">a</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mf">170.5</span><span class="p">;</span>

</pre></div></div>

<h2>
<span id="クラス" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>クラス</h2>

<p>クラスの定義sample</p>

<p>ヘッダファイル（Sample.h）</p>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span><span class="k">@interface</span> <span class="nc">Persion</span> : <span class="nc">Mammal</span>

<span class="k">@protected</span>
    <span class="c1">//メンバ定義</span>
    <span class="kt">int</span> <span class="n">life</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">height</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">weight</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//アクセサ</span>
<span class="k">@property</span> <span class="kt">int</span> <span class="n">life</span><span class="p">;</span>
<span class="k">@property</span> <span class="kt">float</span> <span class="n">height</span><span class="p">,</span> <span class="n">weight</span><span class="p">;</span>

<span class="k">@end</span>

</pre></div></div>

<p>実装ファイル（Sample.m）</p>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span>
<span class="cp">#import "Sample.h"</span>
<span class="k">@implementation</span> <span class="nc">Person</span>

<span class="c1">//インスタンスメソッド定義</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="nf">getLife</span>
<span class="p">{</span>
    <span class="n">hoge</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">-(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">healLife</span> <span class="o">:</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">volume</span>
<span class="p">{</span>
    <span class="n">life</span> <span class="o">+=</span> <span class="n">volume</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//クラスメソッド定義</span>
<span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">exterminate</span>
<span class="p">{</span>
    <span class="c1">//gameover</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@synthesize</span> <span class="n">life</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">weight</span><span class="p">;</span>

<span class="k">@end</span>

</pre></div></div>

<h4>
<span id="インスタンスの生成方法" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>インスタンスの生成方法</h4>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="n">Person</span> <span class="o">*</span><span class="n">tarou</span> <span class="o">=</span> <span class="p">[[</span> <span class="n">Persion</span> <span class="n">alloc</span> <span class="p">]</span> <span class="n">init</span><span class="p">];</span>
<span class="c1">//メンバセット</span>
<span class="n">tarou</span><span class="o">-&gt;</span><span class="n">life</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="c1">//メソッド呼び出し</span>
<span class="p">[</span><span class="n">tarou</span> <span class="n">getLife</span><span class="p">]</span>
<span class="p">[</span><span class="n">tarou</span> <span class="nl">healLife</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="c1">//クラスメソッド呼び出し</span>
<span class="p">[</span><span class="n">Person</span> <span class="n">exterminate</span><span class="p">]</span>

</pre></div></div>

<h2>
<span id="ヘッダファイルと実装ファイル" class="fragment"></span><a href="#%E3%83%98%E3%83%83%E3%83%80%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E5%AE%9F%E8%A3%85%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>ヘッダファイルと実装ファイル</h2>

<p>プログラムを分割して記述するための仕組み</p>

<ul>
<li><p>ヘッダファイル（.h）はクラスの「目次」<br>
→このファイルのみでクラスの全体を俯瞰できる。<br>
→<a href="/interface" class="user-mention js-hovercard" title="interface" data-hovercard-target-type="user" data-hovercard-target-name="interface">@interface</a>〜<a href="/end" class="user-mention js-hovercard" title="end" data-hovercard-target-type="user" data-hovercard-target-name="end">@end</a><br>
　→クラスの目次（宣言）（〜終わり）</p></li>
<li><p>実装ファイル（.m）はクラスの「本体」<br>
→<a href="/implementation" class="user-mention js-hovercard" title="implementation" data-hovercard-target-type="user" data-hovercard-target-name="implementation">@implementation</a>〜<a href="/end" class="user-mention js-hovercard" title="end" data-hovercard-target-type="user" data-hovercard-target-name="end">@end</a><br>
→クラス実装（〜終わり）</p></li>
</ul>

<p>※分割のメリット・・クラスを外部に公開する際、ヘッダファイルだけでもユーザはそのクラスを利用できる。<br>
一方実装の内部は隠蔽することができる。</p>

<h2>
<span id="import文" class="fragment"></span><a href="#import%E6%96%87"><i class="fa fa-link"></i></a>import文</h2>

<p>別ファイルのプログラム、ライブラリを読み込む。<br>
文末にセミコロンが不要。</p>

<ul>
<li>ヘッダファイル（.h）に書く場合</li>
</ul>

<p>importに続くクラス宣言（<a href="/interface" class="user-mention js-hovercard" title="interface" data-hovercard-target-type="user" data-hovercard-target-name="interface">@interface</a>）で指定されている親クラスがある場所を示す。</p>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
<span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="bp">UIViewController</span>
</pre></div></div>

<p>→Apple提供のUIKitフレームワーク内のUIKit.hを読み込む。<br>
　ViewControllerの親クラスであるUIViewControllerはその中に存在する。</p>

<ul>
<li>実装ファイル（.m）に書く場合</li>
</ul>

<p>ヘッダファイルの場所を示す</p>

<h2>
<span id="allocとinitとnew" class="fragment"></span><a href="#alloc%E3%81%A8init%E3%81%A8new"><i class="fa fa-link"></i></a>allocとinitとnew</h2>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="n">Person</span> <span class="o">*</span><span class="n">tarou</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Persion</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</pre></div></div>

<ul>
<li><p>alloc<br>
インスタンスの生成に必要なメモリ容量を確保する。</p></li>
<li><p>init<br>
メモリ上にロードされたインスタンスに対して実行する。<br>
→インスタンスがデータを保存出来る状態にする。コンストラクタを呼ぶ。</p></li>
<li><p>new<br>
alloc + init</p></li>
</ul>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="n">Person</span> <span class="o">*</span><span class="n">tarou</span> <span class="o">=</span> <span class="p">[</span><span class="n">Persion</span> <span class="n">new</span><span class="p">];</span>
</pre></div></div>

<h2>
<span id="id型" class="fragment"></span><a href="#id%E5%9E%8B"><i class="fa fa-link"></i></a>id型</h2>

<p>汎用オブジェクト型。<br>
どのような参照型にも変化することが出来る。<br>
最初に型を決めずに変数を用意し、実際に使うタイミングで型を決定する。<br>
→動的な型付け</p>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="kt">id</span> <span class="err">オブジェクト型</span>
</pre></div></div>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="kt">id</span> <span class="n">obj</span><span class="p">;</span> <span class="c1">//具体的な型は決まっていない。</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span> <span class="c1">//この時点でPersonクラスになる。</span>
</pre></div></div>

<h2>
<span id="propertyとsynthesize" class="fragment"></span><a href="#property%E3%81%A8synthesize"><i class="fa fa-link"></i></a><a href="/property" class="user-mention js-hovercard" title="property" data-hovercard-target-type="user" data-hovercard-target-name="property">@property</a>と<a href="/synthesize" class="user-mention js-hovercard" title="synthesize" data-hovercard-target-type="user" data-hovercard-target-name="synthesize">@synthesize</a>
</h2>

<ul>
<li><p><a href="/property" class="user-mention js-hovercard" title="property" data-hovercard-target-type="user" data-hovercard-target-name="property">@property</a><br>
プロパティを宣言すると、同名のインスタンス変数に対するアクセサ（setter/getter）が自動生成される。</p></li>
<li><p><a href="/synthesize" class="user-mention js-hovercard" title="synthesize" data-hovercard-target-type="user" data-hovercard-target-name="synthesize">@synthesize</a><br>
<a href="/property" class="user-mention js-hovercard" title="property" data-hovercard-target-type="user" data-hovercard-target-name="property">@property</a>で指定した属性に対してアクセサメソッドを定義する。</p></li>
</ul>

<h2>
<span id="コンストラクタ" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF"><i class="fa fa-link"></i></a>コンストラクタ</h2>

<p>init（NSObject）を上書きする。</p>

<div class="code-frame" data-lang="objective-c"><div class="highlight"><pre><span></span><span class="k">@implementation</span> <span class="nc">Person</span>
<span class="p">-(</span><span class="kt">id</span><span class="p">)</span> <span class="nf">init</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">]){</span>
        <span class="n">life</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></div>

<h2>
<span id="メモリ" class="fragment"></span><a href="#%E3%83%A1%E3%83%A2%E3%83%AA"><i class="fa fa-link"></i></a>メモリ</h2>

<p>使わなくなったインスタンスを解放する。</p>

<ul>
<li>
<p>保持カウンタ<br>
インスタンス生成時に値1で初期化される。<br>
NSObjectクラスのretainCountというプロパティが保持している。<br>
保持カウンタの値が0になった時点で、メモリ上から解放される。</p>

<ul>
<li>retain：保持カウンタの値を1増やす</li>
<li>release：保持カウンタの値を1減らす</li>
</ul>
</li>
</ul>

<p>10/17<br>
とりあえずここまで</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />24位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>51</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/99f2c90788bd931ea3ee">[Rails] 基本的なユーザ管理用Modelをテスト駆動で実装してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-26 13:58:04</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby on Rails Tutorialのエッセンスを自分なりに整理8</p>

<p>[Rails] RSpecのリファクタリング<br>
<a href="http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3" class="autolink" id="reference-f5081cee749fecd98bcf">http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter6）<br>
<a href="http://railstutorial.jp/chapters/modeling-users?version=4.0#top" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/modeling-users?version=4.0#top</a></p>

<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>認証機能をもつユーザ管理用のModelをテスト駆動で実装していく。</p>

<p>RSpecの導入方法はこちら<br>
[Rails] RSpecによるBDD（振舞駆動開発）の基本 [SporkとGuardも]<br>
<a href="http://qiita.com/kidachi_/items/cb8910eb74e924456df9" class="autolink" id="reference-a4990dc7a268e1a64552">http://qiita.com/kidachi_/items/cb8910eb74e924456df9</a></p>

<h2>
<span id="データモデルの定義" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>データモデルの定義</h2>

<table>
<thead>
<tr>
<th>column</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>integer</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
</tr>
<tr>
<td>email</td>
<td>string</td>
</tr>
<tr>
<td>cretaed_at</td>
<td>datetime</td>
</tr>
<tr>
<td>updated_at</td>
<td>datetime</td>
</tr>
</tbody>
</table>

<p>モデルの生成とマイグレーション実行。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">rails</span> <span class="n">generate</span> <span class="n">model</span> <span class="no">User</span> <span class="nb">name</span><span class="ss">:string</span> <span class="ss">email</span><span class="p">:</span><span class="n">string</span>
<span class="err">$</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">migrate</span>
</pre></div></div>

<h2>
<span id="データ構造をモデルに示すgemの導入" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E6%A7%8B%E9%80%A0%E3%82%92%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E7%A4%BA%E3%81%99gem%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>データ構造をモデルに示すgemの導入</h2>

<p>annotate（gem）を用いることで、モデルにデータ構造をコメント形式で残すことができる。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'annotate'</span><span class="p">,</span> <span class="s1">'2.5.0'</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle install
$ bundle <span class="nb">exec</span> annotate
Annotated <span class="o">(</span><span class="m">1</span><span class="o">)</span>: User
</pre></div></div>

<p>モデルへデータモデルを表すコメントが追加された。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># == Schema Information</span>
<span class="c1">#</span>
<span class="c1"># Table name: users</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer          not null, primary key</span>
<span class="c1">#  name       :string(255)</span>
<span class="c1">#  email      :string(255)</span>
<span class="c1">#  created_at :datetime</span>
<span class="c1">#  updated_at :datetime</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre></div>
</div>

<p>※dbスキーマに変更がある度にbundle exec annotateする必要がある。</p>

<h2>
<span id="rails40のモデルについて" class="fragment"></span><a href="#rails40%E3%81%AE%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>Rails4.0のモデルについて</h2>

<p>3系まではattr_accessibleを定義するのが普通だが、<br>
4系からはstrong_parametersで行うためattr_accessibleは記述しない。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># attr_accessible :name, :email  # 4系では不要</span>
<span class="k">end</span>
</pre></div>
</div>

<p>strong_parametersについては以下等を参照</p>

<p>[Rails4.0] フォームの基本とStrongParametersを理解する<br>
<a href="http://qiita.com/kidachi_/items/99f2c90788bd931ea3ee" class="autolink">http://qiita.com/kidachi_/items/99f2c90788bd931ea3ee</a></p>

<p>Rails4 の Strong Parameters でリクエストパラメータを検証する<br>
<a href="http://www.techscore.com/blog/2013/01/29/rails4-%E3%81%AE-strong-parameters-%E3%81%A7%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B/" class="autolink" rel="nofollow noopener" target="_blank">http://www.techscore.com/blog/2013/01/29/rails4-%E3%81%AE-strong-parameters-%E3%81%A7%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B/</a></p>

<h2>
<span id="バリデーションの実装" class="fragment"></span><a href="#%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>バリデーションの実装</h2>

<p>各カラムに対するバリデーションをテスト駆動で実装する。</p>

<h3>
<span id="テストの準備" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>テストの準備</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/models/user_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="beforeとsubject" class="fragment"></span><a href="#before%E3%81%A8subject"><i class="fa fa-link"></i></a>before~とsubject~</h3>

<p><a href="/user" class="user-mention js-hovercard" title="user" data-hovercard-target-type="user" data-hovercard-target-name="user">@user</a>をitで表す。</p>

<p>※beforeやsubjectの詳細は以下参照<br>
[Rails] RSpecのリファクタリング<br>
<a href="http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3#refactor1" class="autolink" id="reference-f5081cee749fecd98bcf">http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3#refactor1</a></p>

<h3>
<span id="respond_to" class="fragment"></span><a href="#respond_to"><i class="fa fa-link"></i></a>respond_to?</h3>

<p>シンボルを引数として受け取り、そのメソッド（またはメンバ）を<br>
オブジェクトが保持している場合はtrueを、そうでない場合はfalseを返す。</p>

<p>Rubyで記述した場合</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Ruby</span></div>
<div class="highlight"><pre><span></span><span class="vi">@user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>

<p>RSpecで記述した場合</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">RSpec</span></div>
<div class="highlight"><pre><span></span><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>

<h3>
<span id="真偽値を返すメソッドに関するrubyとrspecの関係" class="fragment"></span><a href="#%E7%9C%9F%E5%81%BD%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8Bruby%E3%81%A8rspec%E3%81%AE%E9%96%A2%E4%BF%82"><i class="fa fa-link"></i></a>真偽値を返すメソッドに関するRubyとRSpecの関係</h3>

<p>Rubyで真偽値を返すfoo?というメソッドに応答するのであれば、<br>
RSpecではそれに対応するbe_fooというテストメソッドが存在する。</p>

<h3>
<span id="red-to-green" class="fragment"></span><a href="#red-to-green"><i class="fa fa-link"></i></a>Red to Green</h3>

<p>現時点ではテスト用dbを準備していないのでRed</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># テスト用DBの準備
$ rake db:test:prepare
</pre></div></div>

<p>これでGreenになる。</p>

<h2>
<span id="オブジェクトと各メンバの存在検証" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A8%E5%90%84%E3%83%A1%E3%83%B3%E3%83%90%E3%81%AE%E5%AD%98%E5%9C%A8%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>オブジェクトと各メンバの存在検証</h2>

<p>オブジェクトが有効かどうか（obj.valid?）を検証する。</p>

<h3>
<span id="テストの準備-1" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E6%BA%96%E5%82%99-1"><i class="fa fa-link"></i></a>テストの準備</h3>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span><span class="s2">"test@example.com"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"when name is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"when email is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="red-to-green-1" class="fragment"></span><a href="#red-to-green-1"><i class="fa fa-link"></i></a>Red to Green</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>

<p>rails console（sandbox）で動作確認<br>
※sandboxにしておくと、console終了時に変更を全てrollbackしてくれる。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">rails</span> <span class="n">c</span> <span class="o">--</span><span class="n">sandbox</span>
<span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="ss">:""</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span><span class="s2">"test@example.com"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;User id: nil, name: "", email: "test@example.com", created_at: nil, updated_at: nil&gt;</span>
<span class="o">&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span>
   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SAVEPOINT</span> <span class="n">active_record_1</span>
   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">ROLLBACK</span> <span class="no">TO</span> <span class="no">SAVEPOINT</span> <span class="n">active_record_1</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
<span class="c1"># name属性が欠けた状態での保存が出来ない事を確認</span>

<span class="c1"># valid?はfalseを返す</span>
<span class="o">&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
<span class="o">&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Name can't be blank"</span><span class="o">]</span>
</pre></div></div>

<h2>
<span id="メールアドレス検証" class="fragment"></span><a href="#%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>メールアドレス検証</h2>

<p>メールアドレスについて、より詳細に正当性を検証する。</p>

<h3>
<span id="テストコードの準備" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>テストコードの準備</h3>

<p>正規表現を用いて、適切なメールアドレスの形式を保っているかチェック。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/models/user_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span><span class="s2">"test@example.com"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">~</span>
  <span class="n">describe</span> <span class="s2">"when email format is invalid"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should be invalid"</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo..com user_at_foo,org example.user@foo.</span>
<span class="sx">                    foo@bar_baz.com foo@bar+baz.com]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invalid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">invalid_address</span>
        <span class="n">should_not</span> <span class="n">be_valid</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"when email format is valid"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.COM A_US-ER@f.b.org frst.lst@foo.jp a+b@baz.cn]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">valid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">valid_address</span>
        <span class="n">should</span> <span class="n">be_valid</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div>
</div>

<h3>
<span id="red-to-green-2" class="fragment"></span><a href="#red-to-green-2"><i class="fa fa-link"></i></a>Red to Green</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/models/user_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="今回用いた正規表現" class="fragment"></span><a href="#%E4%BB%8A%E5%9B%9E%E7%94%A8%E3%81%84%E3%81%9F%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE"><i class="fa fa-link"></i></a>今回用いた正規表現</h3>

<table>
<thead>
<tr>
<th>表現</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>/</td>
<td>正規表現の開始を示す</td>
</tr>
<tr>
<td>\A</td>
<td>文字列の先頭</td>
</tr>
<tr>
<td>[\w+-.]+</td>
<td>英数字、アンダースコア (_)、プラス (+)、ハイフン (-)、<br>ドット (.) のいずれかを少なくとも1文字以上繰り返す</td>
</tr>
<tr>
<td>@</td>
<td>アットマーク</td>
</tr>
<tr>
<td>[a-z\d-.]+</td>
<td>英小文字、数字、ハイフン、ドットのいずれかを<br>少なくとも1文字以上繰り返す</td>
</tr>
<tr>
<td>.</td>
<td>ドット</td>
</tr>
<tr>
<td>[a-z]+</td>
<td>英小文字を少なくとも1文字以上繰り返す</td>
</tr>
<tr>
<td>\z</td>
<td>文字列の末尾</td>
</tr>
<tr>
<td>/</td>
<td>正規表現の終わりを示す</td>
</tr>
<tr>
<td>i</td>
<td>大文字小文字を無視するオプション</td>
</tr>
</tbody>
</table>

<p>Ruby正規表現チェック&amp;リファレンスは以下<br>
<a href="http://www.rubular.com/" class="autolink" rel="nofollow noopener" target="_blank">http://www.rubular.com/</a></p>

<h2>
<span id="一意ユニーク性検証" class="fragment"></span><a href="#%E4%B8%80%E6%84%8F%E3%83%A6%E3%83%8B%E3%83%BC%E3%82%AF%E6%80%A7%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>一意（ユニーク）性検証</h2>

<p>メンバのユニーク性を検証する。</p>

<p>テストコードの準備</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/models/user_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">describe</span> <span class="s2">"when email address is already taken"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="c1">#@userと同一の属性をuser_with_same_emailコピー</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="c1">#メールアドレスでは大文字小文字が区別されないため、upcaseで統一。</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="red-to-green-3" class="fragment"></span><a href="#red-to-green-3"><i class="fa fa-link"></i></a>Red to Green</h3>

<p><code>validates uniqueness: { case_sensitive: false }</code> で<br>
大文字小文字を識別しない形で重複を排除する。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
            <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="validates-uniquenessの問題" class="fragment"></span><a href="#validates-uniqueness%E3%81%AE%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>validates: uniquenessの問題</h3>

<p>高トラフィックのタイミングでリクエストが短時間に連続送信された場合、<br>
それぞれが検証をパスしてしまうことがある。</p>

<p>対策として、データベースレベルでも重複を禁止する。</p>

<h2>
<span id="db側での一意ユニーク性検証" class="fragment"></span><a href="#db%E5%81%B4%E3%81%A7%E3%81%AE%E4%B8%80%E6%84%8F%E3%83%A6%E3%83%8B%E3%83%BC%E3%82%AF%E6%80%A7%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>DB側での一意（ユニーク）性検証</h2>

<h3>
<span id="unique-index-の追加" class="fragment"></span><a href="#unique-index-%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>Unique INDEX の追加</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails g migration add_index_to_users_email
</pre></div></div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">db/migrate/20131124064205_add_index_to_users_email.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AddIndexToUsersEmail</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p><code>rake db:migrate</code>するとエラーが出た。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rake db:migrate
rake aborted!
An error has occurred, this and all later migrations canceled:

SQLite3::BusyException: database is locked: commit transaction
Tasks: <span class="nv">TOP</span> <span class="o">=</span>&gt; db:migrate
<span class="o">(</span>See full trace by running task with --trace<span class="o">)</span>
</pre></div></div>

<p><code>rails console --sandbox</code>のセッションがDBをロックしている様子。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ ps au <span class="p">|</span>grep rails
 <span class="m">68910</span>   <span class="m">0</span>.0  <span class="m">0</span>.0  <span class="m">2512656</span>      <span class="m">4</span> s007  T     <span class="m">9</span>:58PM   <span class="m">0</span>:02.28 /Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/bin/ruby bin/rails c --sandbox
$ <span class="nb">kill</span> -9 <span class="m">68910</span>
</pre></div></div>

<p>プロセスをkillして再度<code>rake db:migrate</code>で通った。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rake db:migrate
<span class="o">==</span>  AddIndexToUsersEmail: <span class="nv">migrating</span> <span class="o">===========================================</span>
-- add_index<span class="o">(</span>:users, :email, <span class="o">{</span>:unique<span class="o">=</span>&gt;true<span class="o">})</span>
   -&gt; <span class="m">0</span>.0011s
<span class="o">==</span>  AddIndexToUsersEmail: migrated <span class="o">(</span><span class="m">0</span>.0012s<span class="o">)</span> <span class="o">==================================</span>
</pre></div></div>

<p>ユニークインデックス追加完了。</p>

<h3>
<span id="小文字変換処理の追加" class="fragment"></span><a href="#%E5%B0%8F%E6%96%87%E5%AD%97%E5%A4%89%E6%8F%9B%E5%87%A6%E7%90%86%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>小文字変換処理の追加</h3>

<p>全てのデータベースが常に大文字小文字を区別するインデックスを<br>
使っているとは限らないため、メールアドレスを保存する前に<br>
すべての文字を小文字に変換する処理を追加する。</p>

<h3>
<span id="テストコードの準備-1" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E6%BA%96%E5%82%99-1"><i class="fa fa-link"></i></a>テストコードの準備</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/models/user_spec.rb</span></div>
<div class="highlight"><pre><span></span>  <span class="n">describe</span> <span class="s2">"email address with mixed case"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:mixed_case_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Foo@ExAMPle.CoM"</span><span class="p">}</span>

    <span class="n">it</span> <span class="s2">"should be saved as all lower-case"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">mixed_case_email</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">mixed_case_email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="red-to-green-4" class="fragment"></span><a href="#red-to-green-4"><i class="fa fa-link"></i></a>Red to Green</h3>

<p>コールバックメソッド（※）<code>before_save</code>を用いる。</p>

<p>※Active Recordオブジェクトが持続している間の任意のタイミングで呼び出される。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>    <span class="c1"># { email.downcase! }でも可</span>
  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<p>これで重複データの保管がリクエストされると、<br>
<code>ActiveRecord::StatementInvalid</code>例外を投げる。</p>

<h2>
<span id="セキュアなパスワードの実装" class="fragment"></span><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%82%A2%E3%81%AA%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>セキュアなパスワードの実装</h2>

<p>ユーザ認証用のパスワードを生成する。</p>

<p>認証の流れは以下。</p>

<ul>
<li>パスワードの送信</li>
<li>暗号化</li>
<li>db内の暗号化された値との比較</li>
</ul>

<p>暗号化を挟むことにより、万が一db内の情報が流出してもパスワードの安全性は保たれる。</p>

<h2>
<span id="password追加データモデルの変更" class="fragment"></span><a href="#password%E8%BF%BD%E5%8A%A0%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fa fa-link"></i></a>password追加（データモデルの変更）</h2>

<h3>
<span id="テストの準備-2" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E6%BA%96%E5%82%99-2"><i class="fa fa-link"></i></a>テストの準備</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/models/user_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">~</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="red-to-green-5" class="fragment"></span><a href="#red-to-green-5"><i class="fa fa-link"></i></a>Red to Green</h3>

<p>password_digestの追加（データモデルを変更する）</p>

<table>
<thead>
<tr>
<th>column</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>integer</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
</tr>
<tr>
<td>email</td>
<td>string</td>
</tr>
<tr>
<td>password_digest</td>
<td>string</td>
</tr>
<tr>
<td>cretaed_at</td>
<td>datetime</td>
</tr>
<tr>
<td>updated_at</td>
<td>datetime</td>
</tr>
</tbody>
</table>

<p>マイグレーションファイルの作成</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails g migrate add_password_digest_to_users password_digest:string
</pre></div></div>

<p>※<code>rails g migrate add_column名_to_table名 追加カラム名:カラムの型</code>という<br>
形式にしたがってgenerateすると、自動で適切なchangeメソッドが出力される。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">db/migrate/20131124073401_add_password_digest_to_users.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AddPasswordDigestToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>マイグレーションの反映（とテストDBの準備）</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rake db:migrate
$ rake test:prepare    <span class="c1"># db:migrateの後に必要になることも。</span>
</pre></div></div>

<h2>
<span id="passwordの入力受付と正当性検証" class="fragment"></span><a href="#password%E3%81%AE%E5%85%A5%E5%8A%9B%E5%8F%97%E4%BB%98%E3%81%A8%E6%AD%A3%E5%BD%93%E6%80%A7%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>passwordの入力受付と、正当性検証</h2>

<h3>
<span id="必要な機能" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>必要な機能</h3>

<ol>
<li>password属性とpassword_confirmation属性の追加</li>
<li>passwordが存在することを要求</li>
<li>passwordが最低限の文字数を保持していることを要求</li>
<li>passwordとpassword_confirmationが一致することを要求</li>
<li>暗号化されたパスワードとpassword_digestを比較、認証するauthenticateメソッドの実装</li>
</ol>

<h3>
<span id="テストコードの準備-2" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E6%BA%96%E5%82%99-2"><i class="fa fa-link"></i></a>テストコードの準備</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/models/user_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span><span class="s2">"test@example.com"</span><span class="p">,</span>
                      <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

<span class="o">~</span>

  <span class="c1"># passwordの長さ検証</span>
  <span class="n">describe</span> <span class="s2">"with a password that's too short"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="c1"># authenticateメソッド検証</span>
  <span class="n">describe</span> <span class="s2">"return value of authenticate method"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

    <span class="c1"># passwordが正しい場合</span>
    <span class="n">describe</span> <span class="s2">"with valid password"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="c1"># passwordが不正である場合</span>
    <span class="n">describe</span> <span class="s2">"with invalid password"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"invalid"</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">eq</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user_for_invalid_password</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="eq" class="fragment"></span><a href="#eq"><i class="fa fa-link"></i></a>eq</h3>

<p>オブジェクト同士が同値であるかを調べる。</p>

<h3>
<span id="specify" class="fragment"></span><a href="#specify"><i class="fa fa-link"></i></a>specify</h3>

<p>itと同義であり、itを使用すると英語として不自然な場合にこれで代用する。<br>
「it should not equal wrong user」(itはユーザーなど) とするのは英語として自然だが、<br>
「user: user with invalid password should be false」は不自然。<br>
「specify: user with invalid password should be false」とすれば自然になる。</p>

<h3>
<span id="let" class="fragment"></span><a href="#let"><i class="fa fa-link"></i></a>let</h3>

<p>以下を参照<br>
[Rails] RSpecのリファクタリング<br>
<a href="http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3#refactor3" class="autolink" id="reference-f5081cee749fecd98bcf">http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3#refactor3</a></p>

<h3>
<span id="パスワードを不可逆に暗号化するための準備" class="fragment"></span><a href="#%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E4%B8%8D%E5%8F%AF%E9%80%86%E3%81%AB%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>パスワードを不可逆に暗号化するための準備</h3>

<p>bcrypt（gem）を利用する。</p>

<div class="code-frame" data-lang="Gemfile"><div class="highlight"><pre><span></span>~
gem 'bcrypt-ruby', '~&gt; 3.1.2'
~
</pre></div></div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle install
</pre></div></div>

<h2>
<span id="red-to-green-6" class="fragment"></span><a href="#red-to-green-6"><i class="fa fa-link"></i></a>Red to Green</h2>

<h3>
<span id="必要な機能-1" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E6%A9%9F%E8%83%BD-1"><i class="fa fa-link"></i></a>必要な機能</h3>

<ol>
<li>password属性とpassword_confirmation属性の追加</li>
<li>passwordが存在することを要求</li>
<li>passwordが最低限の文字数を保持していることを要求</li>
<li>passwordとpassword_confirmationが一致することを要求</li>
<li>暗号化されたパスワードとpassword_digestを比較、認証するauthenticateメソッドの実装</li>
</ol>

<p>実は、このうち3以外は全て<strong>has_secure_password</strong>が自動的に追加してくれる。</p>

<h3>
<span id="has_secure_passwordの追加とpasswordの長さ検証の実装" class="fragment"></span><a href="#has_secure_password%E3%81%AE%E8%BF%BD%E5%8A%A0%E3%81%A8password%E3%81%AE%E9%95%B7%E3%81%95%E6%A4%9C%E8%A8%BC%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>has_secure_passwordの追加と、passwordの長さ検証の実装</h3>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<div class="highlight"><pre><span></span>  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="ユーザが実際に作成できるか検証" class="fragment"></span><a href="#%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%8C%E5%AE%9F%E9%9A%9B%E3%81%AB%E4%BD%9C%E6%88%90%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%8B%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>ユーザが実際に作成できるか検証</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails c

<span class="c1"># ユーザの作成</span>
&gt; User.create<span class="o">(</span>name:<span class="s2">"test"</span>, email:<span class="s2">"test@example.com"</span>, password:<span class="s2">"foobar"</span>, password_confirmation:<span class="s2">"foobar"</span><span class="o">)</span>
   <span class="o">(</span><span class="m">0</span>.1ms<span class="o">)</span>  begin transaction
  User Exists <span class="o">(</span><span class="m">0</span>.3ms<span class="o">)</span>  SELECT <span class="m">1</span> AS one FROM <span class="s2">"users"</span> WHERE LOWER<span class="o">(</span><span class="s2">"users"</span>.<span class="s2">"email"</span><span class="o">)</span> <span class="o">=</span> LOWER<span class="o">(</span><span class="s1">'test@example.com'</span><span class="o">)</span> LIMIT <span class="m">1</span>
Binary data inserted <span class="k">for</span> <span class="sb">`</span>string<span class="sb">`</span> <span class="nb">type</span> on column <span class="sb">`</span>password_digest<span class="sb">`</span>
  SQL <span class="o">(</span><span class="m">4</span>.0ms<span class="o">)</span>  INSERT INTO <span class="s2">"users"</span> <span class="o">(</span><span class="s2">"created_at"</span>, <span class="s2">"email"</span>, <span class="s2">"name"</span>, <span class="s2">"password_digest"</span>, <span class="s2">"updated_at"</span><span class="o">)</span> VALUES <span class="o">(</span>?, ?, ?, ?, ?<span class="o">)</span>  <span class="o">[[</span><span class="s2">"created_at"</span>, Sun, <span class="m">24</span> Nov <span class="m">2013</span> <span class="m">09</span>:59:11 UTC +00:00<span class="o">]</span>, <span class="o">[</span><span class="s2">"email"</span>, <span class="s2">"test@example.com"</span><span class="o">]</span>, <span class="o">[</span><span class="s2">"name"</span>, <span class="s2">"test"</span><span class="o">]</span>, <span class="o">[</span><span class="s2">"password_digest"</span>, <span class="s2">"</span><span class="nv">$2</span><span class="s2">a</span><span class="nv">$10$XJmRT5H6kIAvYA3PsFy1t</span><span class="s2">.UV0HvRsA0V6ei0QzRz.yy.B6FUF8jm2"</span><span class="o">]</span>, <span class="o">[</span><span class="s2">"updated_at"</span>, Sun, <span class="m">24</span> Nov <span class="m">2013</span> <span class="m">09</span>:59:11 UTC +00:00<span class="o">]]</span>
   <span class="o">(</span><span class="m">2</span>.0ms<span class="o">)</span>  commit <span class="nv">transaction</span>
<span class="o">=</span>&gt; <span class="c1">#&lt;User id: 1, name: "test", email: "test@example.com", created_at: "2013-11-24 09:59:11", updated_at: "2013-11-24 09:59:11", password_digest: "$2a$10$XJmRT5H6kIAvYA3PsFy1t.UV0HvRsA0V6ei0QzRz.yy...."&gt;</span>

<span class="c1"># 作成したユーザをdbから取得</span>
&gt; <span class="nv">user</span> <span class="o">=</span> User.find_by<span class="o">(</span>email:<span class="s2">"test@example.com"</span><span class="o">)</span>
  User Load <span class="o">(</span><span class="m">0</span>.2ms<span class="o">)</span>  SELECT <span class="s2">"users"</span>.* FROM <span class="s2">"users"</span> WHERE <span class="s2">"users"</span>.<span class="s2">"email"</span> <span class="o">=</span> <span class="s1">'test@example.com'</span> LIMIT <span class="nv">1</span>
<span class="o">=</span>&gt; <span class="c1">#&lt;User id: 1, name: "test", email: "test@example.com", created_at: "2013-11-24 09:59:11", updated_at: "2013-11-24 09:59:11", password_digest: "$2a$10$XJmRT5H6kIAvYA3PsFy1t.UV0HvRsA0V6ei0QzRz.yy...."&gt;</span>

<span class="c1"># 作成したユーザのpassword_digestを確認</span>
&gt; user.password_digest
<span class="o">=</span>&gt; <span class="s2">"</span><span class="nv">$2</span><span class="s2">a</span><span class="nv">$10$XJmRT5H6kIAvYA3PsFy1t</span><span class="s2">.UV0HvRsA0V6ei0QzRz.yy.B6FUF8jm2"</span>

<span class="c1"># authenticateメソッドの動作確認（不正なパスワードを弾く）</span>
&gt; user.authenticate<span class="o">(</span><span class="s2">"invalid"</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="nb">false</span>

<span class="c1"># authenticateメソッドの動作確認（正当なパスワードを承認する）</span>
&gt; user.authenticate<span class="o">(</span><span class="s2">"foobar"</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="c1">#&lt;User id: 1, name: "test", email: "test@example.com", created_at: "2013-11-24 09:59:11", updated_at: "2013-11-24 09:59:11", password_digest: "$2a$10$XJmRT5H6kIAvYA3PsFy1t.UV0HvRsA0V6ei0QzRz.yy...."&gt;</span>
</pre></div></div>

<p>うまくいった。</p>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>[Rails4.0] フォームの基本とStrongParametersを理解する<br>
<a href="http://qiita.com/kidachi_/items/7c1a9b61dd1853d5a7dc" class="autolink" id="reference-81ef26df5684e143666b">http://qiita.com/kidachi_/items/7c1a9b61dd1853d5a7dc</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />25位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>51</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/9f76a27890d96b9f5838">RailsにDateTimePickerを導入する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-23 11:34:20</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>日付だけならjQuery-uiのDatePickerでokだが、今回は日時まで<br>
取得したかったので以下のDateTimePickerを使う。</p>

<p>bootstrap-datetimepicker-rails<br>
<a href="https://github.com/lubieniebieski/bootstrap-datetimepicker-rails" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/lubieniebieski/bootstrap-datetimepicker-rails</a></p>

<p>※DatePickerなら以下を参照<br>
Rails で jQuery-ui の Date Picker を日本語で表示する場合のメモAdd Star<br>
<a href="http://d.hatena.ne.jp/CortYuming/20130420/p1" class="autolink" rel="nofollow noopener" target="_blank">http://d.hatena.ne.jp/CortYuming/20130420/p1</a></p>

<h2>
<span id="流れ" class="fragment"></span><a href="#%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>流れ</h2>

<p>Gemfileに追記、bundle install。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s1">'bootstrap-datetimepicker-rails'</span>
</pre></div>
</div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>bundle install
</pre></div></div>

<p>application.jsを編集。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">assets/javascripts/application.js</span></div>
<div class="highlight"><pre><span></span><span class="c1">//= require bootstrap-datetimepicker</span>

<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'data-format'</span><span class="o">:</span> <span class="s1">'yyyy-MM-dd hh:mm:ss'</span> <span class="p">};</span>
<span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'.datepicker'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'.datepicker'</span><span class="p">).</span><span class="nx">datetimepicker</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</div>

<p>表示項目オプションとしてdata-format属性が必要なので、動的に追加している。</p>

<p>使いそうな出力形式はこんな感じ。</p>

<table>
<thead>
<tr>
<th>data-format属性（オプション）</th>
<th>出力形式</th>
</tr>
</thead>
<tbody>
<tr>
<td>{'data-format': 'yyyy-MM-dd'}</td>
<td>2013-11-23</td>
</tr>
<tr>
<td>{'data-format': 'yyyy-MM-dd hh<img alt=":flag_mm:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f1f2-1f1f2.png" title=":flag_mm:" width="20">ss'}</td>
<td>2013-11-23 11:16:46</td>
</tr>
<tr>
<td>{'data-format': 'yyyy-MM-dd hh<img alt=":flag_mm:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f1f2-1f1f2.png" title=":flag_mm:" width="20">ss PP'}</td>
<td>2013-11-23 11:16:46 PM</td>
</tr>
</tbody>
</table>

<p>より詳しくは以下。<br>
<a href="http://tarruda.github.io/bootstrap-datetimepicker/" class="autolink" rel="nofollow noopener" target="_blank">http://tarruda.github.io/bootstrap-datetimepicker/</a></p>

<p>application.cssを編集。</p>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">assets/stylesheets/application.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="k">@import</span> <span class="s1">'</span><span class="s2">bootstrap-datetimepicker'</span><span class="p">;</span>
</pre></div>
</div>

<p>任意のviewから呼び出し。</p>

<div class="code-frame" data-lang="html+erb">
<div class="code-lang"><span class="bold">app/views/hoges/_form.html.erb</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="p">:</span><span class="err">日付</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s1">'datepicker'</span> <span class="cp">%&gt;</span>
</pre></div>
</div>

<p>出た。</p>

<p><a href="https://camo.qiitausercontent.com/874596bd49016f507cd91463cf7f94047c188a54/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f35343761656139322d653036392d643766622d306631352d6231666163313933613435372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/874596bd49016f507cd91463cf7f94047c188a54/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f35343761656139322d653036392d643766622d306631352d6231666163313933613435372e706e67" alt="datetimepicker.png" title="datetimepicker.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/547aea92-e069-d7fb-0f15-b1fac193a457.png"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />26位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>50</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/5456589a799e5d787923">jQuery等CDNのダウンに備えたリスクヘッジ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-22 20:25:11</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jQuery]</b> <b>[cdn]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>読み込みが極端に遅い。<br>
でもwebサーバやdbのloadなどチェックしても怪しいところがない。<br>
なんだろうと思っていたらGoogleCDN設置のjQueryにアクセスできなくなっていた。</p>

<p>CDNもあくまで外部管理なので、リスクヘッジはしておくべき、と。</p>

<p>という訳でその方法が以下。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'&lt;script src="js/libs/jquery-1.10.2.min.js"&gt;&lt;\/script&gt;'</span><span class="p">)&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>もしCDNにアクセスできなければ、ローカルのリソースを読む。</p>

<p>※ window.jQueryは、<br>
・jQueryがロードされていれば「function()」を返す<br>
・ロードされていなかったら「undefined」を返す</p>

<h2>
<span id="参考1" class="fragment"></span><a href="#%E5%8F%82%E8%80%831"><i class="fa fa-link"></i></a>参考1</h2>

<p>jQueryをロードする際のナイス！と思った書き方 <br>
<a href="http://dtp.jdash.info/archives/51941752.html" class="autolink" rel="nofollow noopener" target="_blank">http://dtp.jdash.info/archives/51941752.html</a></p>

<h2>
<span id="参考2" class="fragment"></span><a href="#%E5%8F%82%E8%80%832"><i class="fa fa-link"></i></a>参考2</h2>

<p>他にrequire.jsを使う方法などもありそうだが、今回の目的に対しては導入コストが高そうだったので見送り。</p>

<p>JavaScriptをモジュール分割して開発できるRequireJSに入門<br>
<a href="http://www.yoheim.net/blog.php?q=20130103" class="autolink" rel="nofollow noopener" target="_blank">http://www.yoheim.net/blog.php?q=20130103</a><br>
require.jsの使い方のメモ<br>
<a href="http://ezerezetik.com/blog/posts/use-of-requirejs.html" class="autolink" rel="nofollow noopener" target="_blank">http://ezerezetik.com/blog/posts/use-of-requirejs.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />27位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>46</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/40f862181050b78b9cc7">CentOSにyumリポジトリを追加</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-14 16:21:20</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Linux]</b> <b>[Yum]</b> <b>[リポジトリ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>vagrant上のCentOSにphp5.4をインストールしたいが、リポジトリに存在しなかった。<br>
→epelやremiリポジトリを追加して解決する。</p>

<h2>
<span id="インストール可能なパッケージリストを確認" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E5%8F%AF%E8%83%BD%E3%81%AA%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>インストール可能なパッケージリストを確認</h2>

<p>php5.4がインストールしたい。<br>
yum内にあるか確認。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>
[vagrant@localhost ~]$ yum --enablerepo=epel,remi,rpmforge info php
Loaded plugins: fastestmirror
Determining fastest mirrors
 * base: ftp.tsukuba.wide.ad.jp
 * extras: ftp.tsukuba.wide.ad.jp
 * updates: ftp.tsukuba.wide.ad.jp
base                                                                                                               | 3.7 kB     00:00
extras                                                                                                             | 3.4 kB     00:00
updates                                                                                                            | 3.4 kB     00:00
Available Packages
Name        : php
Arch        : x86_64
Version     : 5.3.3
Release     : 23.el6_4
Size        : 1.1 M
Repo        : updates
Summary     : PHP scripting language for creating dynamic web sites
URL         : http://www.php.net/
License     : PHP
Description : PHP is an HTML-embedded scripting language. PHP attempts to make it
            : easy for developers to write dynamically generated webpages. PHP also
            : offers built-in database integration for several commercial and
            : non-commercial database management systems, so writing a
            : database-enabled webpage with PHP is fairly simple. The most common
            : use of PHP coding is probably as a replacement for CGI scripts.
            :
            : The php package contains the module which adds support for the PHP
            : language to Apache HTTP Server.

</pre></div></div>

<p>5.3しかない。<br>
RepoがCentOSデフォルト（updates）になっているので、とりあえずepel/remiリポジトリを追加する。</p>

<h2>
<span id="epel追加" class="fragment"></span><a href="#epel%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>epel追加</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@localhost ~]$ wget http://ftp.riken.jp/Linux/fedora/epel/RPM-GPG-KEY-EPEL-6
--2013-10-14 06:58:52--  http://ftp.riken.jp/Linux/fedora/epel/RPM-GPG-KEY-EPEL-6
ftp.riken.jp をDNSに問いあわせています... 134.160.38.1
ftp.riken.jp|134.160.38.1|:80 に接続しています... 接続しました。
HTTP による接続要求を送信しました、応答を待っています... 200 OK
長さ: 1649 (1.6K) [text/plain]
`RPM-GPG-KEY-EPEL-6' に保存中

100%[================================================================================================&gt;] 1,649       --.-K/s 時間 0s

2013-10-14 06:58:57 (157 MB/s) - `RPM-GPG-KEY-EPEL-6' へ保存完了 [1649/1649]

[vagrant@localhost ~]$ sudo rpm --import RPM-GPG-KEY-EPEL-6
[vagrant@localhost ~]$ sudo touch /etc/yum.repos.d/epel.repo
[vagrant@localhost ~]$ sudo vi /etc/yum.repos.d/epel.repo
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">/etc/yum.repos.d/epel.repo</span></div>
<div class="highlight"><pre><span></span>[epel]
name=EPEL RPM Repository for Red Hat Enterprise Linux
baseurl=http://ftp.riken.jp/Linux/fedora/epel/6/$basearch/
gpgcheck=1
enabled=0
</pre></div>
</div>

<h2>
<span id="remi" class="fragment"></span><a href="#remi"><i class="fa fa-link"></i></a>remi</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@localhost ~]$ wget http://rpms.famillecollet.com/RPM-GPG-KEY-remi
--2013-10-14 06:59:44--  http://rpms.famillecollet.com/RPM-GPG-KEY-remi
rpms.famillecollet.com をDNSに問いあわせています... 195.154.241.117, 2a01:e0b:1000:18:be30:5bff:fed0:614
rpms.famillecollet.com|195.154.241.117|:80 に接続しています... 接続しました。
HTTP による接続要求を送信しました、応答を待っています... 200 OK
長さ: 1340 (1.3K) [text/plain]
`RPM-GPG-KEY-remi' に保存中

100%[================================================================================================&gt;] 1,340       --.-K/s 時間 0s

2013-10-14 06:59:49 (137 MB/s) - `RPM-GPG-KEY-remi' へ保存完了 [1340/1340]

[vagrant@localhost ~]$ sudo rpm --import RPM-GPG-KEY-remi
[vagrant@localhost ~]$ sudo vi /etc/yum.repos.d/remi.repo

</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">/etc/yum.repos.d/remi.repo</span></div>
<div class="highlight"><pre><span></span>[remi]
name=Les RPM de remi pour Enterprise Linux 5 - $basearch
baseurl=http://rpms.famillecollet.com/el5.$basearch/
http://iut-info.univ-reims.fr/remirpms/el5.$basearch/
enabled=0
priority=1
</pre></div>
</div>

<h2>
<span id="再びインストール可能なパッケージリストを確認" class="fragment"></span><a href="#%E5%86%8D%E3%81%B3%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E5%8F%AF%E8%83%BD%E3%81%AA%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>再びインストール可能なパッケージリストを確認</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[vagrant@localhost ~]$ yum --enablerepo=epel,remi,rpmforge info php
Loaded plugins: fastestmirror
Determining fastest mirrors
 * base: www.ftp.ne.jp
 * extras: www.ftp.ne.jp
 * updates: www.ftp.ne.jp
base                                                                                                               | 3.7 kB     00:00
epel                                                                                                               | 3.9 kB     00:00
epel/primary_db                                                                                                    | 5.6 MB     00:00
extras                                                                                                             | 3.4 kB     00:00
remi                                                                                                               | 2.5 kB     00:00
remi/primary_db                                                                                                    | 540 kB     00:02
updates                                                                                                            | 3.4 kB     00:00
Available Packages
Name        : php
Arch        : x86_64
Version     : 5.4.20
Release     : 1.el6.remi
Size        : 3.1 M
Repo        : remi
Summary     : PHP scripting language for creating dynamic web sites
URL         : http://www.php.net/
License     : PHP and Zend and BSD
Description : PHP is an HTML-embedded scripting language. PHP attempts to make it
            : easy for developers to write dynamically generated web pages. PHP also
            : offers built-in database integration for several commercial and
            : non-commercial database management systems, so writing a
            : database-enabled webpage with PHP is fairly simple. The most common
            : use of PHP coding is probably as a replacement for CGI scripts.
            :
            : The php package contains the module (often referred to as mod_php)
            : which adds support for the PHP language to Apache HTTP Server.
</pre></div></div>

<p>5.4が追加された（Repoはremi）。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>外部リポジトリの追加（remi,epel）<br>
<a href="http://qiita.com/ryurock/items/662e41376efa97251575" class="autolink" id="reference-8ea7fe0e28918b38d92b">http://qiita.com/ryurock/items/662e41376efa97251575</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />28位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>42</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/d704e7eb63513c3831ae">Railsにおけるリンクの記述方法とそのテスト</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 09:57:48</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby on Rails Tutorialのエッセンスを自分なりに整理してみる6</p>

<p>[Rails]TwitterBootstrapとSassとAssetPipeline<br>
<a href="http://qiita.com/kidachi_/items/4c47b28b2a74c723d835" class="autolink" id="reference-7e2534737b7052210c0d">http://qiita.com/kidachi_/items/4c47b28b2a74c723d835</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter5）<br>
<a href="http://railstutorial.jp/chapters/filling-in-the-layout#sec-layout_exercises" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/filling-in-the-layout#sec-layout_exercises</a></p>

<h2>
<span id="railsにおけるリンクの記述方法" class="fragment"></span><a href="#rails%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E8%A8%98%E8%BF%B0%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>Railsにおけるリンクの記述方法</h2>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"/static_pages/about"</span><span class="p">&gt;</span>About<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div></div>

<p>というリンクは、ERB中では以下のように記述していく。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">erb</span></div>
<div class="highlight"><pre><span></span><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"About"</span><span class="p">,</span> <span class="n">about_path</span> <span class="o">%&gt;</span>
</pre></div>
</div>

<p>「about_path」を名前付きルートと言う<br>
→各パスに振られた変数のようなもの。</p>

<h4>
<span id="各ページurlに対する名前付きルートの例" class="fragment"></span><a href="#%E5%90%84%E3%83%9A%E3%83%BC%E3%82%B8url%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%83%AB%E3%83%BC%E3%83%88%E3%81%AE%E4%BE%8B"><i class="fa fa-link"></i></a>各ページ、URLに対する名前付きルートの例</h4>

<table>
<thead>
<tr>
<th>ページ</th>
<th>URL</th>
<th>名前付きルート</th>
</tr>
</thead>
<tbody>
<tr>
<td>Home</td>
<td>/</td>
<td>root_path</td>
</tr>
<tr>
<td>About</td>
<td>/about</td>
<td>about_path</td>
</tr>
<tr>
<td>Help</td>
<td>/help</td>
<td>help_path</td>
</tr>
<tr>
<td>Contact</td>
<td>/contact</td>
<td>contact_path</td>
</tr>
<tr>
<td>Sign up</td>
<td>/signup</td>
<td>signup_path</td>
</tr>
<tr>
<td>Sign in</td>
<td>/signin</td>
<td>signin_path</td>
</tr>
</tbody>
</table>

<h3>
<span id="名前付きルートの動作テスト" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%83%AB%E3%83%BC%E3%83%88%E3%81%AE%E5%8B%95%E4%BD%9C%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>名前付きルートの動作テスト</h3>

<p>specファイルを編集。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">visit</span> <span class="s1">'/static_pages/about'</span>
</pre></div>
</div>

<p>　↓visit先を名前付きルートに置き換え</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">visit</span> <span class="n">about_path</span>
</pre></div>
</div>

<p>つまり以下のような形。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="o">~</span>
  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the h1 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | About Us"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<p>当然この時点ではテストはRed。</p>

<h3>
<span id="red-to-greenプロダクトコードの実装" class="fragment"></span><a href="#red-to-green%E3%83%97%E3%83%AD%E3%83%80%E3%82%AF%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Red to Green（プロダクトコードの実装）</h3>

<p>名前付きルートを定義するために、config/routes.rbを以下のように編集する。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">get</span> <span class="s1">'static_pages/about'</span>
</pre></div>
</div>

<p>　↓修正</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">match</span> <span class="s1">'/about'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
</pre></div>
</div>

<p>これで、</p>

<ul>
<li>’/about’（GETリクエスト）がStaticPagesControllerのaboutアクションにマッピングされる</li>
<li>そのマッピング（パス）を返却するabout_pathという名前付きルートが生成される

<ul>
<li>名前付きルートはControllerとViewで利用できる</li>
</ul>
</li>
</ul>

<p>※「match」を「get」にしても同じ名前付きルートになるが、<br>
　 matchを利用する方がより「Railsっぽい」。</p>

<h4>
<span id="定義される名前付きルートの中身" class="fragment"></span><a href="#%E5%AE%9A%E7%BE%A9%E3%81%95%E3%82%8C%E3%82%8B%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%83%AB%E3%83%BC%E3%83%88%E3%81%AE%E4%B8%AD%E8%BA%AB"><i class="fa fa-link"></i></a>定義される名前付きルートの中身</h4>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>about_path -&gt; '/about'
about_url  -&gt; 'http://localhost:3000/about'
</pre></div></div>

<p>→<code>hoge_path</code>と<code>hoge_url</code>の二つが定義される</p>

<ul>
<li>'/hoge’のみを取得する場合はhoge_pathを使う。</li>
<li>リダイレクトの場合のみhoge_url書式を使用する。

<ul>
<li>HTTP標準では技術的にリダイレクト後にフルURLが要求されるため。</li>
<li>（ただし、ほとんどのブラウザではどちらの方法でも動作する。）</li>
</ul>
</li>
</ul>

<h3>
<span id="topページへのルートマッピング" class="fragment"></span><a href="#top%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%B8%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%88%E3%83%9E%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>TOPページへのルートマッピング</h3>

<p>通常通り、以下のようなコードを使用することも一応可能。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">match</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#home'</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
</pre></div>
</div>

<p>しかし、実際にはルート (root) については上のように書く必要はなく、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>root  'controller_name#action_name'
</pre></div></div>

<p>で表す。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>  <span class="s1">'static_pages#home'</span>
  <span class="n">match</span> <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#help'</span><span class="p">,</span>    <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span><span class="p">,</span>   <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#contact'</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="o">~</span>
<span class="k">end</span>
</pre></div>
</div>

<h4>
<span id="root--static_pageshomeで定義される名前付きルートの中身" class="fragment"></span><a href="#root--static_pageshome%E3%81%A7%E5%AE%9A%E7%BE%A9%E3%81%95%E3%82%8C%E3%82%8B%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%83%AB%E3%83%BC%E3%83%88%E3%81%AE%E4%B8%AD%E8%BA%AB"><i class="fa fa-link"></i></a>root  'static_pages#home'で定義される名前付きルートの中身</h4>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>root_path =&gt; '/'
root_url  =&gt; 'http://localhost:3000/'
</pre></div></div>

<h2>
<span id="あるページからあるページへの遷移リンクのテスト" class="fragment"></span><a href="#%E3%81%82%E3%82%8B%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%8B%E3%82%89%E3%81%82%E3%82%8B%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%B8%E3%81%AE%E9%81%B7%E7%A7%BB%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>「あるページからあるページへの遷移（リンク）」のテスト</h2>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">visit</span> <span class="n">foo_path</span>
<span class="n">click_link</span> <span class="s2">"var"</span>
</pre></div></div>

<p>で、「ページfooからリンクvarへの遷移」に対するテストが出来る。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec/requests/static_pages_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="o">~</span>
  <span class="n">it</span> <span class="s2">"should have the right links on the layout"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">click_link</span> <span class="s2">"About"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">))</span>
    <span class="n">click_link</span> <span class="s2">"Help"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Help'</span><span class="p">))</span>
    <span class="n">click_link</span> <span class="s2">"Contact"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Contact'</span><span class="p">))</span>
    <span class="n">click_link</span> <span class="s2">"Home"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">''</span><span class="p">))</span>
    <span class="n">click_link</span> <span class="s2">"Sign up now!"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">))</span>
    <span class="n">click_link</span> <span class="s2">"sample app"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">''</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>[Rails] RSpecのリファクタリング<br>
<a href="http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3" class="autolink" id="reference-4ef39a4cc6467f07068c">http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />29位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>39</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/4c47b28b2a74c723d835">[Rails] TwitterBootstrapとSassとAssetPipeline</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-25 09:57:40</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Sass]</b> <b>[TwitterBootstrap]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby on Rails Tutorialのエッセンスを自分なりに整理してみる5</p>

<p>[Ruby基礎] ブロックとProcをちゃんと理解する<br>
<a href="http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2" class="autolink" id="reference-df55ba43925a106969a1">http://qiita.com/kidachi_/items/15cfee9ec66804c3afd2</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter5）<br>
<a href="http://railstutorial.jp/chapters/filling-in-the-layout#sec-layout_exercises" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/filling-in-the-layout#sec-layout_exercises</a></p>

<h2>
<span id="twitterbootstrapの導入" class="fragment"></span><a href="#twitterbootstrap%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>TwitterBootstrapの導入</h2>

<p>Bootstrapでは、動的なCSS生成のためにLESSを使用している。<br>
一方でRailsのAssetPipeline（詳細後述）はデフォルトではSassをサポートする。<br>
→bootstrap-sass（gem）を導入し、Sassベースで扱えるようにする。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span>
<span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>

</pre></div>
</div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>bundle install
</pre></div></div>

<p>その後rails server再起動。</p>

<p>AssetPipelineがSassを処理できるようにconfig/application.rbを編集。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/application.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1">#Asset Pipeline互換の行を追加</span>
<span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../boot'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
<span class="o">~</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">~</span>
    <span class="c1">#AssetPipelineによるコンパイル対象を増やす</span>
    <span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="sx">%w(*.png *.jpg *.jpeg *.gif)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>app/assets/stylesheets/custom.css.scssを作成&amp;編集</p>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">app/assets/stylesheets/custom.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>
</pre></div>
</div>

<p>画面をリロードすると、cssが反映され、いかにもbootstrapなレイアウトになっている。<br>
（サーバ再起動の必要があるかも）</p>

<p>好みのstyleになるように（まずは普通のCSSとして）編集</p>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">app/assets/stylesheets/custom.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>

<span class="cm">/* universal */</span>

<span class="nt">html</span> <span class="p">{</span>
  <span class="nt">overflow-y</span><span class="nd">:</span> <span class="nt">scroll</span><span class="o">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="nt">padding-top</span><span class="nd">:</span> <span class="nt">60px</span><span class="o">;</span>
<span class="p">}</span>

<span class="nt">section</span> <span class="p">{</span>
  <span class="nt">overflow</span><span class="nd">:</span> <span class="nt">auto</span><span class="o">;</span>
<span class="p">}</span>

<span class="nt">textarea</span> <span class="p">{</span>
  <span class="nt">resize</span><span class="nd">:</span> <span class="nt">vertical</span><span class="o">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="p">{</span>
  <span class="nt">text-align</span><span class="nd">:</span> <span class="nt">center</span><span class="o">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="nt">h1</span> <span class="p">{</span>
  <span class="nt">margin-bottom</span><span class="nd">:</span> <span class="nt">10px</span><span class="o">;</span>
<span class="p">}</span>

<span class="o">~</span>

</pre></div>
</div>

<h2>
<span id="sassとassetpipeline" class="fragment"></span><a href="#sass%E3%81%A8assetpipeline"><i class="fa fa-link"></i></a>SassとAssetPipeline</h2>

<h4>
<span id="assetpipelineとは" class="fragment"></span><a href="#assetpipeline%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>AssetPipelineとは</h4>

<p>jsやcssをそれぞれ単一ファイルに結合してリクエスト数を削減したり、<br>
自動で空白やコメントを削除してファイルサイズを最小化してくれる機能。<br>
その中でも以下3点は抑えておく。</p>

<ul>
<li>アセットディレクトリ</li>
<li>マニフェストファイル</li>
<li>プリプロセッサエンジン</li>
</ul>

<h3>
<span id="アセットディレクトリ" class="fragment"></span><a href="#%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA"><i class="fa fa-link"></i></a>アセットディレクトリ</h3>

<p>静的ファイルを目的別に分類する3つのディレクトリ（Rails3.1以降から）</p>

<p>app/assets: アプリケーション固有のアセット<br>
lib/assets: ライブラリ用のアセット<br>
vendor/assets: サードパーティのアセット</p>

<h3>
<span id="マニフェストファイル" class="fragment"></span><a href="#%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>マニフェストファイル</h3>

<p>アセットディレクトリにあるファイルをどのように結合するのか指定できる。<br>
例えば、app/assets内のCSSのマニフェストはapplication.cssに以下のように記述する。</p>

<div class="code-frame" data-lang="css">
<div class="code-lang"><span class="bold">app/assets/stylesheets/application.css</span></div>
<div class="highlight"><pre><span></span><span class="c">/*</span>
<span class="c"> * This is a manifest file that'll automatically include all the stylesheets</span>
<span class="c"> * available in this directory and any sub-directories. You're free to add</span>
<span class="c"> * application-wide styles to this file and they'll appear at the top of the</span>
<span class="c"> * compiled file, but it's generally better to create a new file per style</span>
<span class="c"> * scope.</span>
<span class="c"> *= require_self</span>
<span class="c"> *= require_tree .</span>
<span class="c">*/</span>
</pre></div>
</div>

<p>重要なのは最後の2行。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>*= require_tree .
</pre></div></div>

<p>→app/assets/stylesheetsディレクトリ (サブディレクトリを含む) の<br>
すべてのCSSファイルをアプリケーションCSSにインクルードすることを指定。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>*= require_self
</pre></div></div>

<p>→application.css自身もインクルードすることを指定。</p>

<h3>
<span id="プリプロセッサエンジン" class="fragment"></span><a href="#%E3%83%97%E3%83%AA%E3%83%97%E3%83%AD%E3%82%BB%E3%83%83%E3%82%B5%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3"><i class="fa fa-link"></i></a>プリプロセッサエンジン</h3>

<p>各アセットを実行し、生のcssやjsを吐き出す。<br>
その際どのプリプロセッサを用いるかは拡張子で判別する。<br>
.scss（Sass）<br>
.coffee（CoffeeScript）<br>
.erb（ERb）<br>
など</p>

<h2>
<span id="sass" class="fragment"></span><a href="#sass"><i class="fa fa-link"></i></a>Sass</h2>

<h3>
<span id="sassとは" class="fragment"></span><a href="#sass%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Sassとは</h3>

<p>CSSをよりプログラマブルに記述するための言語。<br>
ネストや変数といった機能をサポートする。</p>

<h3>
<span id="ネストsample" class="fragment"></span><a href="#%E3%83%8D%E3%82%B9%E3%83%88sample"><i class="fa fa-link"></i></a>ネストsample</h3>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">app/assets/stylesheets/custom.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="nc">.center</span> <span class="p">{</span>
  <span class="nt">text-align</span><span class="nd">:</span> <span class="nt">center</span><span class="o">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="nt">h1</span> <span class="p">{</span>
  <span class="nt">margin-bottom</span><span class="nd">:</span> <span class="nt">10px</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　↓書き換え</p>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">app/assets/stylesheets/custom.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="nc">.center</span> <span class="p">{</span>
  <span class="nt">text-align</span><span class="nd">:</span> <span class="nt">center</span><span class="o">;</span>
  <span class="nt">h1</span> <span class="p">{</span>
    <span class="nt">margin-bottom</span><span class="nd">:</span> <span class="nt">10px</span><span class="o">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="ネストsample2" class="fragment"></span><a href="#%E3%83%8D%E3%82%B9%E3%83%88sample2"><i class="fa fa-link"></i></a>ネストsample2</h3>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">app/assets/stylesheets/custom.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="nn">#logo</span> <span class="p">{</span>
  <span class="nt">float</span><span class="nd">:</span> <span class="nt">left</span><span class="o">;</span>
  <span class="nt">margin-right</span><span class="nd">:</span> <span class="nt">10px</span><span class="o">;</span>
  <span class="o">~</span>
<span class="p">}</span>

<span class="nn">#logo</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="nt">color</span><span class="nd">:</span> <span class="nn">#fff</span><span class="o">;</span>
  <span class="nt">text-decoration</span><span class="nd">:</span> <span class="nt">none</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　↓書き換え</p>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">app/assets/stylesheets/custom.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="nn">#logo</span> <span class="p">{</span>
  <span class="nt">float</span><span class="nd">:</span> <span class="nt">left</span><span class="o">;</span>
  <span class="nt">margin-right</span><span class="nd">:</span> <span class="nt">10px</span><span class="o">;</span>
  <span class="o">~</span>
  <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>    <span class="cm">/* 親属性である#logoは&amp;で表す */</span>
    <span class="nt">color</span><span class="nd">:</span> <span class="nn">#fff</span><span class="o">;</span>
    <span class="nt">text-decoration</span><span class="nd">:</span> <span class="nt">none</span><span class="o">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="変数サンプル" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>変数サンプル</h3>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">app/assets/stylesheets/custom.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="nt">h2</span> <span class="p">{</span>
  <span class="o">~</span>
  <span class="nt">color</span><span class="nd">:</span> <span class="nn">#999</span><span class="o">;</span>
<span class="p">}</span>
<span class="o">~</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="o">~</span>
  <span class="nt">color</span><span class="nd">:</span> <span class="nn">#999</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>　↓書き換え</p>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">app/assets/stylesheets/custom.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="nv">$lightGray</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>

<span class="nt">h2</span> <span class="p">{</span>
  <span class="o">~</span>
  <span class="nt">color</span><span class="nd">:</span> <span class="err">$</span><span class="nt">lightGray</span><span class="o">;</span>
<span class="p">}</span>
<span class="o">~</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="o">~</span>
  <span class="nt">color</span><span class="nd">:</span> <span class="err">$</span><span class="nt">lightGray</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>これでだいぶすっきり書ける。<br>
Tutorial内全体の記述は以下から参照。<br>
<a href="http://railstutorial.jp/chapters/filling-in-the-layout?version=4.0#code-refactored_scss" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/filling-in-the-layout?version=4.0#code-refactored_scss</a></p>

<h2>
<span id="以下に続く" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AB%E7%B6%9A%E3%81%8F"><i class="fa fa-link"></i></a>以下に続く</h2>

<p>Railsにおけるリンクの記述方法とそのテスト<br>
<a href="http://qiita.com/kidachi_/items/d704e7eb63513c3831ae" class="autolink" id="reference-a6fc5390db3ed29e1cd1">http://qiita.com/kidachi_/items/d704e7eb63513c3831ae</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />30位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>38</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/7b355eb355b2d1390cf5">[Ruby] 便利な組み込みクラスのメソッド達（String編）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-06 09:48:59</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p><a href="http://www.amazon.co.jp/gp/product/4774158798/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4774158798&amp;linkCode=as2&amp;tag=kidachi-22" rel="nofollow noopener" target="_blank">パーフェクトRuby</a>を読んでいて便利だと思ったもの一覧です。</p>

<p>Enumerable編<br>
<a href="http://qiita.com/kidachi_/items/a00558cfb0a6a3e23f4b" class="autolink" id="reference-8396968992c5d1c31f80">http://qiita.com/kidachi_/items/a00558cfb0a6a3e23f4b</a><br>
Array編<br>
<a href="http://qiita.com/kidachi_/items/e9cb26c4e6cb36b70a1c" class="autolink" id="reference-58c6a0e58d1d24939821">http://qiita.com/kidachi_/items/e9cb26c4e6cb36b70a1c</a><br>
Hash編<br>
<a href="http://qiita.com/kidachi_/items/651b5b5580be40ad047e" class="autolink" id="reference-4bb3d6d1924a5ad685c2">http://qiita.com/kidachi_/items/651b5b5580be40ad047e</a></p>

<h2>
<span id="文字列の整形" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E6%95%B4%E5%BD%A2"><i class="fa fa-link"></i></a>文字列の整形</h2>

<h3>
<span id="strip" class="fragment"></span><a href="#strip"><i class="fa fa-link"></i></a>strip</h3>

<p>余分な空白を削除。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="s2">"  Ruby </span><span class="se">\n\t</span><span class="s2"> "</span><span class="o">.</span><span class="n">strip</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby"</span>
</pre></div></div>

<h3>
<span id="squeeze" class="fragment"></span><a href="#squeeze"><i class="fa fa-link"></i></a>squeeze</h3>

<p>重複文字列の削除</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="s1">'Ruuuubbbbyyyyy'</span><span class="o">.</span><span class="n">squeeze</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby"</span>

<span class="c1"># 選択した文字のみ重複削除</span>
<span class="o">&gt;</span> <span class="s1">'Ruuuubbbbyyyyy'</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">'ub'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"Rubyyyyy"</span>
</pre></div></div>

<h3>
<span id="sub" class="fragment"></span><a href="#sub"><i class="fa fa-link"></i></a>sub</h3>

<p>あるパターンに最初にマッチした文字列を置換。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="s1">'Ruby is practical programming language!'</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sr">/p.*?\s/</span><span class="p">,</span> <span class="s1">'awesome '</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby is awesome programming language!"</span>
</pre></div></div>

<h3>
<span id="gsub" class="fragment"></span><a href="#gsub"><i class="fa fa-link"></i></a>gsub</h3>

<p>マッチした文字列すべてを置換。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="s1">'Ruby is practical programming language!'</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/p.*?\s/</span><span class="p">,</span> <span class="s1">'awesome '</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby is awesome awesome language!"</span>

<span class="c1"># マッチした文字列はブロックに与えて操作することも出来る。</span>
<span class="o">&gt;</span> <span class="s1">'Ruby is practical programming language!'</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/p.*?\s/</span><span class="p">){</span><span class="o">|</span><span class="n">str</span><span class="o">|</span> <span class="n">str</span><span class="o">.</span><span class="n">upcase</span><span class="p">}</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby is PRACTICAL PROGRAMMING language!"</span>

<span class="c1"># マッチした文字列情報を$&amp;で取得。</span>
<span class="o">&gt;</span> <span class="s1">'Ruby is practical programming language!'</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/p.*?\s/</span><span class="p">){</span> <span class="vg">$&amp;</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">upcase</span><span class="p">}</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby is PRACTICAL PROGRAMMING language!"</span>

</pre></div></div>

<h3>
<span id="split" class="fragment"></span><a href="#split"><i class="fa fa-link"></i></a>split</h3>

<p>特定の文字列をセパレータに指定して分割した要素を、配列として返却。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">str</span> <span class="o">=</span> <span class="s1">'Ruby, Python, Java'</span>
<span class="o">&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>

<span class="c1"># 正規表現も可</span>
<span class="o">&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/,\s/</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python"</span><span class="p">,</span> <span class="s2">"Java"</span><span class="o">]</span>

<span class="c1"># 第2引数を与えると、その数以上は分割しない。</span>
<span class="o">&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/,\s/</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Ruby"</span><span class="p">,</span> <span class="s2">"Python, Java"</span><span class="o">]</span>
</pre></div></div>

<h2>
<span id="部分文字列の取得" class="fragment"></span><a href="#%E9%83%A8%E5%88%86%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>部分文字列の取得</h2>

<h3>
<span id="slice" class="fragment"></span><a href="#slice"><i class="fa fa-link"></i></a>slice</h3>

<p>部分文字列の取得。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># 始点から終点を指定</span>
<span class="o">&gt;</span> <span class="s1">'Ruby is my 1st language!'</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"Ruby"</span>

<span class="c1"># 正規表現での指定も可能</span>
<span class="o">&gt;</span> <span class="s1">'Ruby is my 1st language!'</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="sr">/[0-9]+/</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"1"</span>
</pre></div></div>

<h2>
<span id="繰り返し処理" class="fragment"></span><a href="#%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>繰り返し処理</h2>

<h3>
<span id="each_char" class="fragment"></span><a href="#each_char"><i class="fa fa-link"></i></a>each_char</h3>

<p>文字ごとの繰り返し</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="s1">'Ruby'</span><span class="o">.</span><span class="n">each_char</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">c</span><span class="si">}</span><span class="s2">!"</span><span class="p">}</span>
<span class="o">&gt;</span> <span class="nb">p</span> <span class="n">str</span>
<span class="s2">"R!u!b!y!"</span>
</pre></div></div>

<h3>
<span id="each_line" class="fragment"></span><a href="#each_line"><i class="fa fa-link"></i></a>each_line</h3>

<p>行ごとの繰り返し</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="s2">"Ruby</span><span class="se">\n</span><span class="s2">is</span><span class="se">\n</span><span class="s2">good</span><span class="se">\n</span><span class="s2">language!"</span><span class="o">.</span><span class="n">each_line</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">line</span> <span class="p">}</span>
<span class="no">Ruby</span>
<span class="n">is</span>
<span class="n">good</span>
<span class="n">language!</span>
</pre></div></div>

<h3>
<span id="each_byte" class="fragment"></span><a href="#each_byte"><i class="fa fa-link"></i></a>each_byte</h3>

<p>バイトごとの繰り返し</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="s1">'Ruby'</span><span class="o">.</span><span class="n">each_byte</span> <span class="p">{</span> <span class="o">|</span><span class="n">b</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">b</span><span class="p">}</span>
<span class="mi">82</span>
<span class="mi">117</span>
<span class="mi">98</span>
<span class="mi">121</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />31位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>35</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/0cef215de8ff47221f24">[Rails]「clipboardにコピーする」ボタンを超簡単に設置</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-23 22:55:58</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>Githubでおなじみのアレですね。</p>

<p><a href="https://camo.qiitausercontent.com/782af0a165bb5abc4fc39c39675f694babd58a03/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f30373663346638302d626232372d626132362d613439372d3938636465346436373065322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/782af0a165bb5abc4fc39c39675f694babd58a03/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f383739302f30373663346638302d626232372d626132362d613439372d3938636465346436373065322e706e67" alt="スクリーンショット_2014_01_23_14_11.png" title="スクリーンショット_2014_01_23_14_11.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/8790/076c4f80-bb27-ba26-a497-98cde4d670e2.png"></a></p>

<p>これ。</p>

<p>zeroclipboard-railsというgemを使えば一発です。</p>

<p>zeroclipboard-rails<br>
<a href="https://github.com/zeroclipboard/zeroclipboard-rails" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/zeroclipboard/zeroclipboard-rails</a></p>

<h2>
<span id="導入手順" class="fragment"></span><a href="#%E5%B0%8E%E5%85%A5%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>導入手順</h2>

<p>Gemfileに追記して、</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s1">'zeroclipboard-rails'</span>
</pre></div>
</div>

<p>インストール。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle
</pre></div></div>

<p>application.jsに以下追記。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">assets/javascripts/application.js</span></div>
<div class="highlight"><pre><span></span><span class="c1">//= require zeroclipboard</span>

<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">clip</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZeroClipboard</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">"#d_clip_button"</span><span class="p">))</span>
<span class="p">});</span>

</pre></div>
</div>

<p>あとはコピー領域（textarea）と、コピーボタン（button）を用意するだけ。</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">erb</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">"fe_text"</span> <span class="na">name</span><span class="o">=</span><span class="s">""</span> <span class="na">rows</span><span class="o">=</span><span class="s">"7"</span> <span class="na">cols</span><span class="o">=</span><span class="s">"100"</span><span class="p">&gt;</span>コピー領域<span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">'my_clip_button'</span> <span class="na">data-clipboard-target</span><span class="o">=</span><span class="s">'fe_text'</span> <span class="na">data-clipboard-text</span><span class="o">=</span><span class="s">'Default clipboard text from attribute'</span> <span class="na">id</span><span class="o">=</span><span class="s">'d_clip_button'</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">b</span><span class="p">&gt;</span>コピーする<span class="p">&lt;/</span><span class="nt">b</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>超簡単！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />32位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>35</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/7c1a9b61dd1853d5a7dc">[Rails4.0] フォームの基本とStrongParametersを理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-02 10:30:05</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[StrongParameters]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>Ruby on Rails Tutorialのエッセンスを自分なりに整理9</p>

<p>[Rails] 基本的なユーザ管理用Modelをテスト駆動で実装してみる<br>
<a href="http://qiita.com/kidachi_/items/99f2c90788bd931ea3ee" class="autolink" id="reference-593029de34de24543e24">http://qiita.com/kidachi_/items/99f2c90788bd931ea3ee</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter7）<br>
<a href="http://railstutorial.jp/chapters/sign-up?version=4.0#code-after_save_tests" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/sign-up?version=4.0#code-after_save_tests</a></p>

<h2>
<span id="分かること" class="fragment"></span><a href="#%E5%88%86%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>分かること</h2>

<ul>
<li>フォームの生成方法</li>
<li>フォームを介してやりとりされるデータの形</li>
<li>Strong Parametersとは何か</li>
</ul>

<h2>
<span id="基本的なフォーム" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0"><i class="fa fa-link"></i></a>基本的なフォーム</h2>

<p>まず、ユーザ登録を行うフォームを見てみる。</p>

<h3>
<span id="userscontroller" class="fragment"></span><a href="#userscontroller"><i class="fa fa-link"></i></a>UsersController</h3>

<p>二つのメソッドを準備。</p>

<ul>
<li>new（GET）</li>
</ul>

<p>ユーザ登録ページを生成<br>
- create（POST）</p>

<p>newページで入力された値を受け取って実際にユーザを登録</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>      
      <span class="n">redirect_to</span> <span class="vi">@user</span>    <span class="c1"># @userを解析し、'/users/:id'にリダイレクト</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="viewappviewsusersnewhtmlerb" class="fragment"></span><a href="#viewappviewsusersnewhtmlerb"><i class="fa fa-link"></i></a>View（app/views/users/new.html.erb）</h3>

<ul>
<li>ユーザからの入力を受け取り、createメソッドにPOSTする。</li>
</ul>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">erb</span></div>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"row"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"span6 offset3"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= form_for(@user) do |f| %&gt;</span>

<span class="sx">      &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="sx">%&gt;</span>
<span class="sx">      &lt;%= f.text_field :name %&gt;</span>

      <span class="o">&lt;</span><span class="sx">%= f.label :email %&gt;</span>
<span class="sx">      &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="sx">%&gt;</span>

<span class="sx">      &lt;%= f.label :password %&gt;</span>
      <span class="o">&lt;</span><span class="sx">%= f.password_field :password %&gt;</span>

<span class="sx">      &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="sx">%&gt;</span>
<span class="sx">      &lt;%= f.password_field :password_confirmation %&gt;</span>

      <span class="o">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;% end %&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>
<span class="sr">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>

<h3>
<span id="生成されるhtml" class="fragment"></span><a href="#%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%82%8Bhtml"><i class="fa fa-link"></i></a>生成されるhtml</h3>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">accept-charset</span><span class="o">=</span><span class="s">"UTF-8"</span> <span class="na">action</span><span class="o">=</span><span class="s">"/users"</span> <span class="na">class</span><span class="o">=</span><span class="s">"new_user"</span>
      <span class="na">id</span><span class="o">=</span><span class="s">"new_user"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"user_name"</span><span class="p">&gt;</span>Name<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">"user_name"</span> <span class="na">name</span><span class="o">=</span><span class="s">"user[name]"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="p">/&gt;</span>

  <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"user_email"</span><span class="p">&gt;</span>Email<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">"user_email"</span> <span class="na">name</span><span class="o">=</span><span class="s">"user[email]"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="p">/&gt;</span>

  <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"user_password"</span><span class="p">&gt;</span>Password<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">"user_password"</span> <span class="na">name</span><span class="o">=</span><span class="s">"user[password]"</span> <span class="na">type</span><span class="o">=</span><span class="s">"password"</span> <span class="p">/&gt;</span>

  <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"user_password_confirmation"</span><span class="p">&gt;</span>Confirmation<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">"user_password_confirmation"</span>
         <span class="na">name</span><span class="o">=</span><span class="s">"user[password_confirmation]"</span> <span class="na">type</span><span class="o">=</span><span class="s">"password"</span> <span class="p">/&gt;</span>

  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-large btn-primary"</span> <span class="na">name</span><span class="o">=</span><span class="s">"commit"</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span>
         <span class="na">value</span><span class="o">=</span><span class="s">"Create my account"</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="上記内で用いられている機能" class="fragment"></span><a href="#%E4%B8%8A%E8%A8%98%E5%86%85%E3%81%A7%E7%94%A8%E3%81%84%E3%82%89%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>上記内で用いられている機能</h2>

<h3>
<span id="form_forobj" class="fragment"></span><a href="#form_forobj"><i class="fa fa-link"></i></a>form_for(obj)</h3>

<p>オブジェクトを指定してそれに応じたフォームを作成する。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">erb</span></div>
<div class="highlight"><pre><span></span>    <span class="o">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">      ~</span>
<span class="sx">    &lt;% end %&gt;</span>
</pre></div>
</div>

<p><a href="/user" class="user-mention js-hovercard" title="user" data-hovercard-target-type="user" data-hovercard-target-name="user">@user</a>は中身が空であることから、新規作成のメソッド（create）が必要<br>
→Railsが<code>method="post"</code>のformを自動生成してくれている。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"/users"</span> <span class="na">class</span><span class="o">=</span><span class="s">"new_user"</span> <span class="na">id</span><span class="o">=</span><span class="s">"new_user"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
</pre></div></div>

<h3>
<span id="fformヘルパー" class="fragment"></span><a href="#fform%E3%83%98%E3%83%AB%E3%83%91%E3%83%BC"><i class="fa fa-link"></i></a>f.Formヘルパー</h3>

<p>form_forの中で用いる。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">erb</span></div>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="sx">%= f.label :name %&gt;</span>
<span class="sx">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="o">%&gt;</span>
</pre></div>
</div>

<p>このerbは以下のHTMLを生成する。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"user_name"</span><span class="p">&gt;</span>Name<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">"user_name"</span> <span class="na">name</span><span class="o">=</span><span class="s">"user[name]"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="p">/&gt;</span>
</pre></div></div>

<p>"user[email]"という名前は、userハッシュのemail属性を指す。</p>

<h3>
<span id="createメソッドに渡される値" class="fragment"></span><a href="#create%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E6%B8%A1%E3%81%95%E3%82%8C%E3%82%8B%E5%80%A4"><i class="fa fa-link"></i></a>createメソッドに渡される値</h3>

<p>input属性のname値をもとに、params変数経由で初期化用のハッシュが構成される。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="s2">"user"</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Foo Bar"</span><span class="p">,</span>
            <span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="s2">"foo@example.com"</span><span class="p">,</span>
            <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"[FILTERED]"</span><span class="p">,</span>
            <span class="s2">"password_confirmation"</span> <span class="o">=&gt;</span> <span class="s2">"[FILTERED]"</span>
          <span class="p">}</span>
</pre></div></div>

<p>これらのハッシュはUser.newの引数に必要な属性と一致する。</p>

<p>つまり、以下の二つの記述はほぼ等価であるということ。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo Bar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@example.com"</span><span class="p">,</span>
                 <span class="ss">password</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">)</span>
</pre></div></div>

<p>こうして、（適切な値が渡されていれば）<code>@user.save</code>にて新規レコードが登録される。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span>  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>      
      <span class="n">redirect_to</span> <span class="vi">@user</span>    <span class="c1"># @userを解析し、'/users/:id'にリダイレクト</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div></div>

<h2>
<span id="strong-parameters" class="fragment"></span><a href="#strong-parameters"><i class="fa fa-link"></i></a>Strong Parameters</h2>

<p>上記でformを利用してparamsハッシュを準備したが、<br>
これら全てをそのまま初期化するという行為はセキュリティ上危険。</p>

<h3>
<span id="リスク例" class="fragment"></span><a href="#%E3%83%AA%E3%82%B9%E3%82%AF%E4%BE%8B"><i class="fa fa-link"></i></a>リスク例</h3>

<p>例えば、もしデータモデルの一属性にadmin属性（管理権限）を持たせていた場合、<br>
<code>admin=’1’</code>という値を<code>params[:user]</code>の一部に紛れ込ませれば、<br>
管理権限を奪うことが出来てしまう。</p>

<h3>
<span id="curlによる不正なpostサンプル" class="fragment"></span><a href="#curl%E3%81%AB%E3%82%88%E3%82%8B%E4%B8%8D%E6%AD%A3%E3%81%AApost%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>curlによる不正なPOSTサンプル</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ curl http://localhost:3000/users -X POST \
-d "user[name]=invalid" \
-d "user[email]=invalid@example.com" \
-d "user[password]=foobar" \
-d "user[password_confirmation]=foobar" \
-d "user[admin]=1" 
</pre></div></div>

<p>※実際はこれを通すためには一部手を加える必要有り（Rails4.0の場合）<br>
詳しくは以下等参照。</p>

<p>Rails 4.0だとCSRFトークンでエラーになる<br>
<a href="http://qiita.com/naoty_k/items/b40b13735fd7f06f8cb7" class="autolink" id="reference-4b7e744fc65f68641b9d">http://qiita.com/naoty_k/items/b40b13735fd7f06f8cb7</a></p>

<h3>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h3>

<p>要は<strong>ユーザーが送信したデータをまるごとUser.newに渡してしまうこと</strong>が危ない。</p>

<p>これを防ぐ為に、Rails 4.0ではStrong Parametersを使用する。<br>
（以前のバージョンではattr_accessible。以下参照）</p>

<p>Railsのattr_accessible設定について<br>
<a href="http://yoshifumisato.jeez.jp/wordpress/post/rails/882" class="autolink" rel="nofollow noopener" target="_blank">http://yoshifumisato.jeez.jp/wordpress/post/rails/882</a></p>

<h3>
<span id="記述方法" class="fragment"></span><a href="#%E8%A8%98%E8%BF%B0%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>記述方法</h3>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
</pre></div></div>

<p>今回の例に照らして言うと、これで</p>

<ul>
<li>paramsハッシュは:user属性を必須とする</li>
<li>名前、メールアドレス、パスワード、パスワードの確認の属性のみ許可する</li>
</ul>

<p>ことを実現出来る。</p>

<p>privateメソッドとして定義し、createの中から呼び出す。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>これで、許可した4属性以外がPOSTされた場合はその値を無効化してくれる。</p>

<p>※エラーを吐く訳ではないことに注意。<br>
例えば「許可した4属性＋不正な1属性」がPOSTされた場合、<br>
「許可した4属性」については通常通り更新される。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />33位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>32</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/b0e607c83e9da9380d7e">[Rails][RSpec] Capybaraでフォーム入力をシミュレートしてテストする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-03 09:51:08</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[RSpec]</b> <b>[Capybara]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby on Rails Tutorialのエッセンスを自分なりに整理してみる10</p>

<p>[Rails4.0] フォームの基本とStrongParametersを理解する<br>
<a href="http://qiita.com/kidachi_/items/7c1a9b61dd1853d5a7dc" class="autolink" id="reference-f9515e268619cf99b3df">http://qiita.com/kidachi_/items/7c1a9b61dd1853d5a7dc</a><br>
の続き。</p>

<p>Ruby on Rails Tutorial（chapter7）<br>
<a href="http://railstutorial.jp/chapters/sign-up?version=4.0#code-after_save_tests" class="autolink" rel="nofollow noopener" target="_blank">http://railstutorial.jp/chapters/sign-up?version=4.0#code-after_save_tests</a></p>

<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>ユーザ登録等、よくあるフォーム入力を実装した時、<br>
いちいちブラウザから様々なパターンの値を入力してテストするのは大変。<br>
Capybaraのシミュレート機能を使って解決する。</p>

<h2>
<span id="今回用いるcapybaraのメソッド" class="fragment"></span><a href="#%E4%BB%8A%E5%9B%9E%E7%94%A8%E3%81%84%E3%82%8Bcapybara%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>今回用いるCapybaraのメソッド</h2>

<p>以下の2つ。</p>

<ul>
<li>fill_in</li>
<li>change</li>
</ul>

<h2>
<span id="fill_in" class="fragment"></span><a href="#fill_in"><i class="fa fa-link"></i></a>fill_in</h2>

<p>フォームへの入力をシミュレートする。</p>

<p>例えば、</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
</pre></div></div>

<p>これでフィールド名"Name"のinput属性に"Example User"の入力をシミュレートしたことになる。</p>

<p>より具体的に、以下のようなユーザ情報入力フォームがあるとする。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">erb</span></div>
<div class="highlight"><pre><span></span>    <span class="o">&lt;</span><span class="sx">%= form_for(@user) do |f| %&gt;</span>
<span class="sx">      &lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="sx">%&gt;</span>

<span class="sx">      &lt;%= f.label :name %&gt;</span>
      <span class="o">&lt;</span><span class="sx">%= f.text_field :name %&gt;</span>

<span class="sx">      &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="sx">%&gt;</span>
<span class="sx">      &lt;%= f.text_field :email %&gt;</span>

      <span class="o">&lt;</span><span class="sx">%= f.label :password %&gt;</span>
<span class="sx">      &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="sx">%&gt;</span>

<span class="sx">      &lt;%= f.label :password_confirmation, "Confirmation" %&gt;</span>
      <span class="o">&lt;</span><span class="sx">%= f.password_field :password_confirmation %&gt;</span>
<span class="sx">      &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span> <span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="sx">%&gt;</span>

<span class="sx">    &lt;% end %&gt;</span>
</pre></div>
</div>

<p>この場合、以下のテストコードで各フィールドに対する値の入力が実現できる。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
<span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>        <span class="ss">with</span><span class="p">:</span> <span class="s2">"user@example.com"</span>
<span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>     <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">fill_in</span> <span class="s2">"Confirmation"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
</pre></div></div>

<h2>
<span id="change" class="fragment"></span><a href="#change"><i class="fa fa-link"></i></a>change</h2>

<p>オブジェクトとそのオブジェクトが持つメソッドを指定し、<br>
その実行によって起きる変化を観測する。</p>

<p>click_buttonの後、User.countが1だけ変化する事を期待する例</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">expect</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">"Create my account"</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div></div>

<ul>
<li>オブジェクト（User）とシンボル（:count）を引数に取り、シンボルに該当する名前のメソッドを呼び出す。</li>
<li>
<code>expect do~end.to</code>の後ろについて、ブロック内が実行される前後での変化を比較する。</li>
</ul>

<h2>
<span id="実際のテストコード" class="fragment"></span><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>実際のテストコード</h2>

<p>上記2つのメソッドを用いて、</p>

<ul>
<li>ユーザ登録ページ（signup）に訪れ</li>
<li>フォームに何らかの値を入力し（もしくは入力しないで）、</li>
<li>"Create my account"ボタンを押下</li>
</ul>

<p>したケースをシミュレートするテストコード</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"signup"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:submit</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Create my account"</span> <span class="p">}</span>

    <span class="c1"># 不正な値が入力された（正確には、何も入力されていない）ケース</span>
    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">"should not create a user"</span> <span class="k">do</span>
        <span class="c1">#click_buttonの後、User.countが変化しない事を期待</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># 正しい値が入力されたケース</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>        <span class="ss">with</span><span class="p">:</span> <span class="s2">"user@example.com"</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>     <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
        <span class="n">fill_in</span> <span class="s2">"Confirmation"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
      <span class="k">end</span>
      <span class="n">it</span> <span class="s2">"should create a user"</span> <span class="k">do</span>
        <span class="c1">#click_buttonの後、User.countが1だけ変化する事を期待</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>便利！</p>

<h2>
<span id="関連" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>関連</h2>

<p>RSpecの基本等については以下も参照ください。</p>

<p>[Rails] RSpecによるBDD（振舞駆動開発）の基本 [SporkとGuardも]<br>
<a href="http://qiita.com/kidachi_/items/cb8910eb74e924456df9" class="autolink" id="reference-c7f5a86550c28fa98c7b">http://qiita.com/kidachi_/items/cb8910eb74e924456df9</a></p>

<p>[Rails] RSpecのリファクタリング<br>
<a href="http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3" class="autolink" id="reference-c7a0fd6e0afc841cb304">http://qiita.com/kidachi_/items/ec184deb106e4e5c90c3</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />34位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>31</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/1a3d66abb80bb67e0d64">DNSリバインディング対策</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-28 20:32:51</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[セキュリティ]</b> <b>[DNSリバインディング]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="dnsリバインディング攻撃とは" class="fragment"></span><a href="#dns%E3%83%AA%E3%83%90%E3%82%A4%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E6%94%BB%E6%92%83%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>DNSリバインディング攻撃とは</h2>

<h3>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h3>

<p>罠サイトと罠DNSサーバを運営する攻撃者が、<br>
短期間にドメイン（FQDN）に対応するIPアドレスを変更することで<br>
SameOriginPolicyの範囲内で脆弱性サイトへjsによる攻撃を行う。</p>

<h3>
<span id="ステークホルダー" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%BC%E3%82%AF%E3%83%9B%E3%83%AB%E3%83%80%E3%83%BC"><i class="fa fa-link"></i></a>ステークホルダー</h3>

<ul>
<li>攻撃者</li>
<li>攻撃者運営のDNS（TTL/キャッシュ生存期間を5秒程度に設定）</li>
<li>攻撃者運営の罠サイト（<strong>evil.example.com</strong>）（<strong>192.0.2.1</strong>）</li>
<li>脆弱性サイト（<strong>weak.example.jp</strong>）（<strong>198.51.100.1</strong>）</li>
<li>被害者</li>
</ul>

<h3>
<span id="攻撃の流れ" class="fragment"></span><a href="#%E6%94%BB%E6%92%83%E3%81%AE%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>攻撃の流れ</h3>

<ol>
<li><p>被害者が罠サイト（<strong>evil.example.com</strong>）を閲覧</p></li>
<li><p>攻撃用JavaScript（※）が被害者に送信される<br>
※例えば「<strong>evil.example.com</strong>」上の特定コンテンツにアクセスし、得られた情報を<strong>192.0.2.1(evil)</strong>に返す、など。</p></li>
<li><p>攻撃者がDNSのAレコードを操作し、<strong>evil.example.com</strong>が<strong>198.51.100.1(weak)</strong>を指すように変更する。</p></li>
<li><p>この時点で、<strong>evil.example.com</strong>上で実行できるJavaScriptは、脆弱性サイト<strong>198.51.100.1(weak)</strong>に対する操作ができる状態となる。</p></li>
<li><p>そのタイミングに沿って罠スクリプトが発火すれば、<strong>198.51.100.1(weak)</strong>上の個人情報の取得など、攻撃が成立する。</p></li>
</ol>

<h2>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h2>

<p>特性上、攻撃は必ず罠サイトのホスト（<strong>evil.example.com</strong>）から行われるのが肝。</p>

<p>apacheのVirtualHostは、未定義のホスト（SeverName）に対するリクエストが来た場合、<br>
最初の定義がデフォルトとして適用される。</p>

<p>これを利用して、最初にdummyのVirtualHostを定義しておくことで、<br>
罠サイト（<strong>evil.example.com</strong>）からのアクセスに対しては404を返すことが出来る。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="c1"># ダミーVirtualHost</span>
&lt;VirtualHost *:80&gt;
ServerName dummy.example.jp <span class="c1"># 正規のホスト名以外ならなんでもok</span>
DocumentRoot /var/www/dummy
ErrorDocument <span class="m">404</span> /index.html
&lt;/VirtualHost&gt;

<span class="c1"># 正規のVirtualHost</span>
&lt;VirtualHost *:80&gt;
ServerName weak.example.jp
DocumentRoot /var/www/html
&lt;/VirtualHost&gt;
</pre></div></div>

<h2>
<span id="tips" class="fragment"></span><a href="#tips"><i class="fa fa-link"></i></a>tips</h2>

<p>weak.example.jpに対して、ホストを偽装（evil.example.com）してアクセス可能かどうか、<br>
つまりDNSリバインディング可能かどうかチェックできる。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>curl -v -H <span class="s1">'Host: evil.example.com'</span> http://<span class="k">$(</span>dig weak.example.jp <span class="p">|</span> grep -v <span class="s1">'^;'</span> <span class="p">|</span> grep <span class="s1">'A'</span> <span class="p">|</span> awk <span class="s1">'{print $5}'</span><span class="k">)</span>
</pre></div></div>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>DNSリバインディング<br>
<a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20130218/456766/?ST=security&amp;P=1" class="autolink" rel="nofollow noopener" target="_blank">http://itpro.nikkeibp.co.jp/article/COLUMN/20130218/456766/?ST=security&amp;P=1</a></p>

<p>間違いだらけの「かんたんログイン」実装法 (3/3)<br>
<a href="http://www.atmarkit.co.jp/ait/articles/1103/01/news125_3.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.atmarkit.co.jp/ait/articles/1103/01/news125_3.html</a></p>

<p>DNSのTTL設定とは?<br>
<a href="http://kazamidori.net/kaoru/2007/03/ttl1.html" class="autolink" rel="nofollow noopener" target="_blank">http://kazamidori.net/kaoru/2007/03/ttl1.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />35位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>26</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/1060e094a0b0f9b9eaaa">[MySQL] 外部キー制約作成時、ERROR 1005 (HY000): Can&apos;t create table </a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-01 19:26:26</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[MySQL]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>外部キー制約を付けたテーブル作成時、以下のエラーが発生した</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ERROR 1005 (HY000): Can't create table 'table_name' (errno: 150)
</pre></div></div>

<p>このメッセージがあまり親切でなく、原因には色々な可能性が考えられる。</p>

<h2>
<span id="あり得る原因たち" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E5%BE%97%E3%82%8B%E5%8E%9F%E5%9B%A0%E3%81%9F%E3%81%A1"><i class="fa fa-link"></i></a>あり得る原因たち</h2>

<ol>
<li><p>対象カラムにINDEXが張られていない（対象がPRIMARY KEYでない場合）</p></li>
<li><p>参照先、参照元のどちらかがInnoDBでない</p></li>
<li><p>参照元のカラムと参照先のカラムの型が異なる</p></li>
<li><p>参照先カラムにデフォルト値をセットしている</p></li>
<li><p>ON DELETE SET NULLを指定しているが参照先がNOT NULL</p></li>
<li><p>その他何らかの構文エラーがある<br>
（なぜかSyntax Errorではなく、Can’t create tableが出る）</p></li>
</ol>

<p>今回は3、片方のみにunsignedを指定していたためのエラーでした。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>MySQLでCan’t create table(errno: 150)<br>
<a href="http://fizsoft.net/archives/300" class="autolink" rel="nofollow noopener" target="_blank">http://fizsoft.net/archives/300</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />36位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/c5b3ceffa6148bc46dba">AjaxにおけるCSRF対策</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-05 18:32:43</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ajax]</b> <b>[セキュリティ]</b> <b>[CSRF対策]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="手法" class="fragment"></span><a href="#%E6%89%8B%E6%B3%95"><i class="fa fa-link"></i></a>手法</h2>

<p>・HTTPヘッダのX-requested-withの値をチェックし、ajaxであることを担保する。</p>

<div class="code-frame" data-lang="php">
<div class="code-lang"><span class="bold">validate_sample.php</span></div>
<div class="highlight"><pre><span></span>    <span class="k">private</span> <span class="k">function</span> <span class="nf">validateCSRF</span><span class="p">()</span> 
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_X_REQUESTED_WITH'</span><span class="p">])</span>
            <span class="o">&amp;&amp;</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_X_REQUESTED_WITH'</span><span class="p">])</span><span class="o">===</span><span class="s1">'xmlhttprequest'</span>
        <span class="p">){</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// not csrf</span>
        <span class="p">}</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span> <span class="c1">// invalid request</span>
    <span class="p">}</span>

</pre></div>
</div>

<h2>
<span id="理論的背景" class="fragment"></span><a href="#%E7%90%86%E8%AB%96%E7%9A%84%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>理論的背景</h2>

<p>SameOriginPolicyより、Ajaxであることはすなわり不正な外部ドメインからのアクセスではない。</p>

<p>上記から、X-requested-withの確認のみでCSRF対策が可能となる。</p>

<h2>
<span id="考慮事項" class="fragment"></span><a href="#%E8%80%83%E6%85%AE%E4%BA%8B%E9%A0%85"><i class="fa fa-link"></i></a>考慮事項</h2>

<p>・X-requested-withは操作することも可能<br>
・Ajax level2ではクロスドメイン間の通信が可能であるためこの対策は無効</p>

<p>→定石通りワンタイムトークンを用いるのがベターか。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p><a href="http://madaolog.blogspot.jp/2012/12/ajaxwebcsrf.html" class="autolink" rel="nofollow noopener" target="_blank">http://madaolog.blogspot.jp/2012/12/ajaxwebcsrf.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />37位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/21527a54e977aeb1c3ad">WebViewネイティブアプリのアクセストラッキング</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-16 21:38:19</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[GoogleAnalytics]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="方法" class="fragment"></span><a href="#%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>方法</h2>

<p>webかネイティブかUAで判別し、該当のプロパティに対してsendする。</p>

<h2>
<span id="複数プロパティでの管理" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%81%A7%E3%81%AE%E7%AE%A1%E7%90%86"><i class="fa fa-link"></i></a>複数プロパティでの管理</h2>

<p>ga('create', ..)の第三引数にnameを持たせることで、複数アカウントを管理できる（UniversalAnalyticsのみ）</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>var strUA = "";
strUA = navigator.userAgent.toLowerCase();

if(strUA.indexOf("native-ios") != -1){

  #ネイティブiOSの場合
  ga('create', 'UA-XXXX-Y', {'name':'ios'} );
  ga('ios.send', 'pageview');

} else if(strUA.indexOf("native-android") != -1) {

  #ネイティブAndroidの場合
  ga('create', 'UA-XXXX-Y', {'name':'android'} );
  ga('android.send', 'pageview');

} else{

  #webの場合
  ga('create', 'UA-XXXX-X', {'name':'web'} );
  ga('web.send', 'pageview');

}
</pre></div></div>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<p>【最新版】Google Analyticsチートシート完全マニュアル（日本語解説付）<br>
<a href="http://www.find-job.net/startup/analytics_cheatsheet" class="autolink" rel="nofollow noopener" target="_blank">http://www.find-job.net/startup/analytics_cheatsheet</a></p>

<h2>
<span id="注意事項" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85"><i class="fa fa-link"></i></a>注意事項</h2>

<p> ※当然、正しくUA判定出来るように、nativeのios/androidを判別出来る必要がある。<br>
webviewアプリなら、大抵はクライアント側でその準備をしてあるはず・・という想定。</p>

<p>UIWebViewを用いる際にUserAgentを独自に設定する方法<br>
<a href="http://www.yoheim.net/blog.php?q=20121001" class="autolink" rel="nofollow noopener" target="_blank">http://www.yoheim.net/blog.php?q=20121001</a></p>

<h2>
<span id="他の手段" class="fragment"></span><a href="#%E4%BB%96%E3%81%AE%E6%89%8B%E6%AE%B5"><i class="fa fa-link"></i></a>他の手段</h2>

<p>Google Analytics SDKを使う。<br>
（というか、ネイティブの場合の正攻法はこちら）</p>

<p>Google Analytics SDK を使ったスマホアプリのトラッキング<br>
<a href="http://www.ayudante.jp/column/2012-08-24/13-10/" class="autolink" rel="nofollow noopener" target="_blank">http://www.ayudante.jp/column/2012-08-24/13-10/</a></p>

<p>ネイティブのイベントも取得できる。</p>

<p>が、アップデートが必要なので、今回は本題のサーバ側のみの方法で手軽に対応。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />38位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/6f2e89ab8ea1c065c944">[Rails] 各helperが全てのviewから読み込めてしまうのを禁止する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-23 22:55:00</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="rails-31以上" class="fragment"></span><a href="#rails-31%E4%BB%A5%E4%B8%8A"><i class="fa fa-link"></i></a>Rails 3.1以上</h3>

<p>1行追加するだけ。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/application.rb</span></div>
<div class="highlight"><pre><span></span>
<span class="k">module</span> <span class="nn">FooApp</span>
  <span class="o">~</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">include_all_helpers</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="o">~</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div>
</div>

<h3>
<span id="rails-31未満" class="fragment"></span><a href="#rails-31%E6%9C%AA%E6%BA%80"><i class="fa fa-link"></i></a>Rails 3.1未満</h3>

<p>1行削除するだけ。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/application_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">helper</span> <span class="ss">:all</span>   <span class="c1"># 削除する</span>
</pre></div>
</div>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>Why are all Rails helpers available to all views, all the time? Is there a way to disable this?<br>
<a href="http://stackoverflow.com/questions/1179865/why-are-all-rails-helpers-available-to-all-views-all-the-time-is-there-a-way-t" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/1179865/why-are-all-rails-helpers-available-to-all-views-all-the-time-is-there-a-way-t</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />39位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/4bea2a4e390130719826">[Rails] SporkでAddress already in use - bind(2)エラーが出た場合の対処</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-11 09:48:06</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[Spork]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>Sporkを実行したら以下のエラーがでた。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>
$  bundle <span class="nb">exec</span> spork
Using RSpec, Rails
Preloading Rails environment
Loading Spork.prefork block...
Address already in use - bind<span class="o">(</span><span class="m">2</span><span class="o">)</span> <span class="o">(</span>Errno::EADDRINUSE<span class="o">)</span>
/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:879:in <span class="sb">`</span>initialize<span class="s1">'</span>
<span class="s1">/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:879:in `open'</span>
/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:879:in <span class="sb">`</span>open_server<span class="s1">'</span>
<span class="s1">/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:764:in `block in open_server'</span>
/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:762:in <span class="sb">`</span>each<span class="s1">'</span>
<span class="s1">/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:762:in `open_server'</span>
/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:1373:in <span class="sb">`</span>initialize<span class="s1">'</span>
<span class="s1">/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:1664:in `new'</span>
/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/2.0.0/drb/drb.rb:1664:in <span class="sb">`</span>start_service<span class="s1">'</span>
<span class="s1">/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/gems/2.0.0/gems/spork-1.0.0rc4/lib/spork/server.rb:30:in `listen'</span>
/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/gems/2.0.0/gems/spork-1.0.0rc4/lib/spork/server.rb:21:in <span class="sb">`</span>run<span class="s1">'</span>
<span class="s1">/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/gems/2.0.0/gems/spork-1.0.0rc4/lib/spork/runner.rb:76:in `run'</span>
/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/gems/2.0.0/gems/spork-1.0.0rc4/lib/spork/runner.rb:10:in <span class="sb">`</span>run<span class="s1">'</span>
<span class="s1">/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/lib/ruby/gems/2.0.0/gems/spork-1.0.0rc4/bin/spork:10:in `&lt;top (required)&gt;'</span>
/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/bin/spork:23:in <span class="sb">`</span>load<span class="s1">'</span>
<span class="s1">/Users/taniguchidaiki/.rbenv/versions/2.0.0-p195/bin/spork:23:in `&lt;main&gt;'</span>
No examples found.


Finished in <span class="m">0</span>.00013 seconds
<span class="m">0</span> examples, <span class="m">0</span> failures

Randomized with seed <span class="m">11942</span>

</pre></div></div>

<h2>
<span id="対応" class="fragment"></span><a href="#%E5%AF%BE%E5%BF%9C"><i class="fa fa-link"></i></a>対応</h2>

<p>Address already in useとのことなので、とりあえずプロセスを確認。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ ps ax<span class="p">|</span>grep spork
<span class="m">85664</span> s006  T      <span class="m">0</span>:04.00 ruby /Users/hoge/.rbenv/versions/2.0.0-p195/bin/spork
<span class="m">87228</span> s007  S+     <span class="m">0</span>:00.00 grep spork
</pre></div></div>

<p>いた。<br>
一度終了した時のプロセスが残っていた？<br>
killする。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ <span class="nb">kill</span> -9 <span class="m">85664</span>
$ ps ax<span class="p">|</span>grep spork
<span class="m">87233</span> s007  R+     <span class="m">0</span>:00.00 grep spork
</pre></div></div>

<p>もう一度起動してみる。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$  bundle <span class="nb">exec</span> spork
Using RSpec, Rails
Preloading Rails environment
Loading Spork.prefork block...
Spork is ready and listening on <span class="m">8989</span>!
</pre></div></div>

<p>成功。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />40位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/8c2d28b1ee98478b50ca">herokuのdbを操作する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-10 12:55:11</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>dbへアクセス</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ heroku pg:psql
</pre></div></div>

<p>SHOW DATABASES</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>=&gt; \d
</pre></div></div>

<p>SELECT * FROM foos</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>=&gt; SELECT * FROM foos;
 # (MySQLと一緒)
</pre></div></div>

<p>実際にログインしたところ</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ heroku pg:psql
---&gt; Connecting to HEROKU_POSTGRESQL_CRIMSON_URL (DATABASE_URL)
psql (9.1.5, server 9.3.2)
WARNING: psql version 9.1, server version 9.3.
         Some psql features might not work.
SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)
Type "help" for help.


da41a3g4hv191h=&gt; \d

                   List of relations
 Schema |       Name        |   Type   |     Owner
--------+-------------------+----------+----------------
 public | calls             | table    | iqpuweabqkjiie
 public | calls_id_seq      | sequence | iqpuweabqkjiie
 public | schema_migrations | table    | iqpuweabqkjiie
(3 rows)

da41a3g4hv191h=&gt; select * from calls;

 id |                                                                                          message                                                                                           |    to     |         created_at         |         updated_at
----+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+----------------------------+----------------------------
  1 | oh                                                                                                                                                                     |           | 2013-12-09 15:34:05.42589  | 2013-12-09 15:34:05.42589
  2 | yeah                                                                                                                                                         |           | 2013-12-09 15:36:23.067689 | 2013-12-09 15:36:23.067689
  3 | fugafuga                                                                                                                                                         |           | 2013-12-09 15:36:47.679216 | 2013-12-09 15:36:47.679216

</pre></div></div>

<p>とりあえずこれだけ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />41位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/d3a10837f13afba79def">iOS7でのデバイストークン発行ルール変更対応</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-05 18:41:59</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Push通知]</b> <b>[ios7]</b> <b>[デバイストークン]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>iOS7より、これまでデバイスユニークだったデバイストークンが流動的に。<br>
参考）<br>
<a href="http://blog.katty.in/4162" class="autolink" rel="nofollow noopener" target="_blank">http://blog.katty.in/4162</a></p>

<p>つまり、<br>
・アプリごとに変化する<br>
・同一アプリでもOSアップデートのタイミングで更新される</p>

<h2>
<span id="想定される問題" class="fragment"></span><a href="#%E6%83%B3%E5%AE%9A%E3%81%95%E3%82%8C%E3%82%8B%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>想定される問題</h2>

<p>デバイストークンとユーザの紐付けをログインのタイミングで実施していたりすると、紐付けが切れてしまうタイミングが発生する。</p>

<p>その際はユーザがOSアップデートした場合は再度ログインしなおす必要があるが、それをユーザに期待するのは難しい。</p>

<h2>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h2>

<p>デバイストークンが変化したタイミングでそれを判定し、最新のものを紐付け直す実装を追加する。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />42位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/7d3de78944edaef5f097">便利なgitエイリアス</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-05 18:40:11</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> <b>[alias]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>.bash_rcか.bash_profileに以下設定。</p>

<div class="code-frame" data-lang="alias_sample"><div class="highlight"><pre><span></span>alias gck="git checkout"
alias gst="git status"
alias gcm="git commit -m"
alias gdi="git diff"
alias gbr="git branch"
alias gad="git add"
alias gmg="git merge"
alias gps="git push"
alias gpl="git pull"
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />43位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/55b0ae9980d1debdd2ba">lsで表示するファイル数を制限する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-10 15:54:36</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Linux]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ファイル数が肥大しているディレクトリを覗く際に。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>ls /file_path <span class="p">|</span> head -50
</pre></div></div>

<p>もしくは</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>ls /file_path <span class="p">|</span> more
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />44位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/f97b2eadeb46ca24a26f">クリックジャッキング対策</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-05 18:38:45</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[セキュリティ]</b> <b>[クリックジャッキング]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>iframeにて攻撃対象ページを透過で呼び出すことで、<br>
ユーザの意図しない行動を誘導する。</p>

<h2>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h2>

<p>X-Frame-Options HTTPレスポンスヘッダをDENYに設定することで、iframeでの呼び出しを拒否することが可能。</p>

<p>apacheのconfに以下を設定する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Header always append X-Frame-Options DENY
</pre></div></div>

<p>なお、本対策を取ってもネイティブアプリのwebviewからの<br>
呼び出しに影響はない。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p><a href="http://www.websec-room.com/2013/02/20/98" class="autolink" rel="nofollow noopener" target="_blank">http://www.websec-room.com/2013/02/20/98</a><br>
<a href="http://buzzwordjp.blogspot.jp/2011/09/iframe-x-frame-options-http.html" class="autolink" rel="nofollow noopener" target="_blank">http://buzzwordjp.blogspot.jp/2011/09/iframe-x-frame-options-http.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />45位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/d8fc79863562533789bc">[Rails4.0] DEPRECATION WARNING への対応</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-24 09:40:14</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[rails4.0]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="activerecord関連で" class="fragment"></span><a href="#activerecord%E9%96%A2%E9%80%A3%E3%81%A7"><i class="fa fa-link"></i></a>ActiveRecord関連で</h2>

<p>Rails4で3系の書き方をしていたら、以下のようなwarningが発生した。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>DEPRECATION WARNING: Relation#calculate with finder options is deprecated. Please build a scope and <span class="k">then</span> call calculate on it instead. <span class="o">(</span>called from hoge_check at /work/Fuga/app/models/tag.rb:103<span class="o">)</span>

DEPRECATION WARNING: The :distinct option <span class="k">for</span> <span class="sb">`</span>Relation#count<span class="sb">`</span> is deprecated. Please use <span class="sb">`</span>Relation#distinct<span class="sb">`</span> instead. <span class="o">(</span>eg. <span class="sb">`</span>relation.distinct.count<span class="sb">`</span><span class="o">)</span>. <span class="o">(</span>called from hoge_check at /work/Fuga/app/models/tag.rb:103<span class="o">)</span>
</pre></div></div>

<h2>
<span id="対処" class="fragment"></span><a href="#%E5%AF%BE%E5%87%A6"><i class="fa fa-link"></i></a>対処</h2>

<p>countの中に条件（condition）を書くのではなく、<br>
条件はwhere、カウントはcount、と分離して書けばok。</p>

<h5>
<span id="改善前" class="fragment"></span><a href="#%E6%94%B9%E5%96%84%E5%89%8D"><i class="fa fa-link"></i></a>改善前</h5>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">TagHistory</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:action_id</span> <span class="o">=&gt;</span> <span class="vi">@params</span><span class="o">.</span><span class="n">aid</span><span class="p">})</span>
</pre></div></div>

<h5>
<span id="改善後" class="fragment"></span><a href="#%E6%94%B9%E5%96%84%E5%BE%8C"><i class="fa fa-link"></i></a>改善後</h5>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">TagHistory</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">action_id</span><span class="p">:</span> <span class="vi">@params</span><span class="o">.</span><span class="n">aid</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div></div>

<h5>
<span id="改善前-1" class="fragment"></span><a href="#%E6%94%B9%E5%96%84%E5%89%8D-1"><i class="fa fa-link"></i></a>改善前</h5>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">TagHistory</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:tag_id</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
</pre></div></div>

<h5>
<span id="改善後-1" class="fragment"></span><a href="#%E6%94%B9%E5%96%84%E5%BE%8C-1"><i class="fa fa-link"></i></a>改善後</h5>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">TagHistory</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">tag_id</span><span class="p">:</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div></div>

<p>解決。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />46位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/22240371ecf4c6c0a642">[iOS][Objective-C] StoryBoardを使ったUI実装</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-04 15:56:48</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Objective-C]</b> <b>[iOS]</b> <b>[Storyboard]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="流れ" class="fragment"></span><a href="#%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>流れ</h2>

<ol>
<li><p>MainStoryboard.storyboardに右下ペインから任意のUIパーツを選択、ドラッグで設置。</p></li>
<li><p>UIパーツをViewController.hの<a href="/interface" class="user-mention js-hovercard" title="interface" data-hovercard-target-type="user" data-hovercard-target-name="interface">@interface</a>~<a href="/end" class="user-mention js-hovercard" title="end" data-hovercard-target-type="user" data-hovercard-target-name="end">@end</a>の間にドラッグ。<br>
　→設定ダイアログがポップアップされるので、任意値を設定。</p></li>
<li><p>この時点で、ViewController.mに設置したActionの定義が自動追記されているので、<br>
メソッドの中身を追記していく。</p></li>
</ol>

<h2>
<span id="sample" class="fragment"></span><a href="#sample"><i class="fa fa-link"></i></a>Sample</h2>

<p>以下機能を持つサンプルをつくる。<br>
・ボタンを押すとアラートダイアログが表示される<br>
・ダイアログ内での選択に応じて表示文字列を変化させる。</p>

<ol>
<li><p>MainStoryboard.storyboardにLabelとRoundRectButtonを設置</p></li>
<li><p>LabelとRoundRectButtonをViewController.hの<a href="/interface" class="user-mention js-hovercard" title="interface" data-hovercard-target-type="user" data-hovercard-target-name="interface">@interface</a>~<a href="/end" class="user-mention js-hovercard" title="end" data-hovercard-target-type="user" data-hovercard-target-name="end">@end</a>の間にドラッグ。<br>
設定ダイアログ内での値は</p></li>
</ol>

<div class="code-frame" data-lang="Label"><div class="highlight"><pre><span></span>Connection:Outlet
Object:ViewController
Name:labelForAlertView
Type:UILabel
Storage:Weak
</pre></div></div>

<div class="code-frame" data-lang="RoundRectButton"><div class="highlight"><pre><span></span>Connection:Action
Object:ViewController
Name:showAlertView
Type:id
Event:TouchUpInside
Arguments:None
</pre></div></div>

<p>※Connection<br>
　Buttonなどイベントを設置するものはAction<br>
　　→メソッドとしてViewControllerに定義が自動追記される。<br>
　特にイベント発火しないlabelなどのリソースはOutlet<br>
　　→propertyとしてViewControllerに定義が自動追記される。</p>

<p>するとViewController.h上に</p>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span><span class="k">@property</span> <span class="p">(</span><span class="k">weak</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="bp">UILabel</span> <span class="o">*</span><span class="n">labelForAlertView</span>

 <span class="o">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="n">showAlertView</span><span class="p">;</span>
</pre></div></div>

<p>の二つが自動生成される</p>

<ol>
<li>ViewController.mに以下メソッドが自動追記されているので、</li>
</ol>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span> <span class="o">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="n">showAlertView</span> <span class="p">{</span>   
<span class="p">}</span>
</pre></div></div>

<p>メソッドの中身を実装。</p>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span> <span class="o">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="n">showAlertView</span> <span class="p">{</span>

        <span class="bp">UIAlertView</span> <span class="o">*</span><span class="n">alertView</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="bp">UIAlertView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTitle</span><span class="p">:</span><span class="s">@"たいとる"</span> 
            <span class="nl">message</span><span class="p">:</span><span class="s">@"本文"</span> 
            <span class="nl">delegate</span><span class="p">:</span><span class="nb">nil</span> 
            <span class="nl">cancelButtonTitle</span><span class="p">:</span><span class="nb">nil</span> 
            <span class="nl">otherButtonTitles</span><span class="p">:</span><span class="s">@"OK"</span><span class="p">,</span> <span class="nb">nil</span>
        <span class="p">];</span>
        <span class="p">[</span><span class="n">alertView</span> <span class="n">show</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div>

<p>これで、RoundRectButtonをタップすると、alertViewが表示される。</p>

<p>さらに、alertView内でのアクションを拾うメソッドを追記する。</p>

<div class="code-frame" data-lang="obj-c"><div class="highlight"><pre><span></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">alertView:</span><span class="p">(</span><span class="bp">UIAlertView</span> <span class="o">*</span><span class="p">)</span><span class="nv">alertView</span>
        <span class="nf">clickedButtonAtIndex:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">buttonIndex</span>
<span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">buttonIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nb">self</span><span class="p">.</span><span class="n">labelForAlertView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@"canceled"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buttonIndex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">self</span><span class="p">.</span><span class="n">labelForAlertView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@"ok is pushed"</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>buttonIndexは、alertView内でキャンセル選択で0、OK選択で1を返す。<br>
ここではそれにあわせてlabelForAlertViewの値を書き換えている。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>iPhoneアプリ開発超入門<br>
<a href="http://www.sbcr.jp/products/4797369434.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.sbcr.jp/products/4797369434.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />47位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/82c08fdee3bc2ab2d62b">RubyMineが行末を認識してくれない</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-27 13:11:46</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[RubyMine]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="困った" class="fragment"></span><a href="#%E5%9B%B0%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>困った</h2>

<p>RubyMineが、行末を認識せずどこまででも右方向へカーソルを動かせてしまう。<br>
つまり、行末/行頭に来たら次の行/前の行にカーソルが移動してほしいのに、それができない。</p>

<h2>
<span id="対策" class="fragment"></span><a href="#%E5%AF%BE%E7%AD%96"><i class="fa fa-link"></i></a>対策</h2>

<p>Preferences &gt; Editor &gt; Allow Placement of carret after end of line<br>
（一覧右側の上から4つ目のチェックボックス）をはずせばok。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>Rubymineでカーソル位置が実際の行の末尾を超えて移動できるのが気に入らない。<br>
<a href="http://saifis.net/?p=295" class="autolink" rel="nofollow noopener" target="_blank">http://saifis.net/?p=295</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />48位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/ae968be3ea03976baa59">cron関連ファイルをgitで管理したい</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-13 20:51:35</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[cron]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>/var/spool/cronの中のファイルをgitで管理するには。</p>

<h2>
<span id="前提etccrontab-と-crontab--e-の違い" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90etccrontab-%E3%81%A8-crontab--e-%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>前提：'/etc/crontab' と 'crontab -e' の違い</h2>

<p><strong>/etc/crontab</strong><br>
→os用cron。一般ユーザが編集するのはあまり好ましくない。</p>

<p><strong>crontab -e</strong><br>
→/var/spool/cron 配下が編集される。<br>
基本はこちらを触るのが作法。</p>

<p>よって、git管理していない場合、触るのは後者になる。</p>

<h2>
<span id="git管理する" class="fragment"></span><a href="#git%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>git管理する</h2>

<p>git配下の#{release_path}/cron/hogeを、実際のcronファイルである<br>
/var/spool/cronにコピーする。</p>

<h5>
<span id="capistrano-recipe" class="fragment"></span><a href="#capistrano-recipe"><i class="fa fa-link"></i></a>capistrano recipe：</h5>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">sample.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">namespace</span> <span class="ss">:www_hoge_com</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"install crontab"</span>
    <span class="n">task</span> <span class="ss">:cron_install</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>
      <span class="n">sudo</span> <span class="s2">"/usr/bin/crontab -u hoge </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/cron/hoge"</span>
  <span class="k">end</span>
  <span class="n">after</span> <span class="s2">"deploy:create_symlink"</span><span class="p">,</span> <span class="s2">"www_hoge_com:cron_install"</span>
<span class="k">end</span>
</pre></div>
</div>

<p>※「/usr/bin/crontab」は実行可能ファイル。<br>
このコマンドは、/var/spool/cron/配下のファイルを参照する。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p><a href="http://blog.mizoshiri.com/archives/215" class="autolink" rel="nofollow noopener" target="_blank">http://blog.mizoshiri.com/archives/215</a><br>
<a href="https://users.miraclelinux.com/technet/document/linux/training/2_3_5.html" class="autolink" rel="nofollow noopener" target="_blank">https://users.miraclelinux.com/technet/document/linux/training/2_3_5.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />49位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/a6626ccd2971f8c40132">特定プロセスを殺すワンライナー</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-09 15:20:52</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[sh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="nb">kill</span> -9 <span class="sb">`</span>pgrep -f <span class="s1">'rails s'</span> <span class="sb">`</span>
</pre></div></div>

<p>意外と↓は面倒なので。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>ps ax <span class="p">|</span>grep hoge
<span class="c1">#（hogeのpid探してコピペして）</span>
<span class="nb">kill</span> -9 hoge_pid
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />50位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/3dbfcea5c917a6bf7b0c">ローカル環境用に本番dbのスキーマとデータをdumpする。</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-22 20:08:05</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[MySQL]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>ローカルには本番のデータ全てが必要な訳ではないため、<br>
・全テーブルのschema<br>
・一部テーブルのデータ<br>
が必要になる。</p>

<h2>
<span id="全テーブルのschemaをdump" class="fragment"></span><a href="#%E5%85%A8%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AEschema%E3%82%92dump"><i class="fa fa-link"></i></a>全テーブルのschemaをdump</h2>

<p>-dでschemaをdumpできる。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>mysqldump -u user_name -pxxxx -h host_num -d db_name &gt; schema_dump.sql
</pre></div></div>

<h2>
<span id="一部テーブルのデータをdump" class="fragment"></span><a href="#%E4%B8%80%E9%83%A8%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92dump"><i class="fa fa-link"></i></a>一部テーブルのデータをdump</h2>

<p>db_nameのあとにtable_nameを続けるだけ。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>mysqldump -u user_name -pxxxx -h host_num db_name <span class="se">\</span>
tableA  <span class="se">\</span>
tableB  <span class="se">\</span>
tableC  <span class="se">\</span>
&gt; data_dump.sql

</pre></div></div>

<p>あとはローカルdbにschema.dumpとdata.dumpを流せばok。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>kidach1さんの<br />51位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/kidach1/items/e9e4eb2123ad3ce4a22b">MySQLのscheme変更時テストにおけるデータdumpとリストア手順</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-05 18:31:40</center>
	</td>
	<td style="width:200px;">
		@kidach1<br />(Akatsuki Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/48274/profile-images/1473691291">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[MySQL]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<p>MySQLのScheme変更時、本番dbと同一環境を用意してテスト実施〜リストアまでの手順</p>

<h2>
<span id="流れ" class="fragment"></span><a href="#%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>流れ</h2>

<h4>
<span id="データdump" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BFdump"><i class="fa fa-link"></i></a>データdump</h4>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>mysqldump -u user_name -p***** -h hostname db_name &gt; dbname.dump
</pre></div></div>

<h4>
<span id="dbクリア" class="fragment"></span><a href="#db%E3%82%AF%E3%83%AA%E3%82%A2"><i class="fa fa-link"></i></a>dbクリア</h4>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>mysql -u user_name -p***** -h hostname
DROP DATABASE db_name
CREATE DATABASE db_name CHARACTER SET utf8
</pre></div></div>

<h4>
<span id="データリストア" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%AA%E3%82%B9%E3%83%88%E3%82%A2"><i class="fa fa-link"></i></a>データリストア</h4>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>mysql -u user_name -p***** -h hostname db_name &lt; db_name.dump
</pre></div></div>

<p>リストアデータサイズによって</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>--max_allowed_packet=1G 
</pre></div></div>

<p>オプションをつける</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>mysql -u user_name -p***** -h hostname --max_allowed_packet=1G db_name &lt; db_name.dump
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
