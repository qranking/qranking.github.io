<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (t_nakayama0714)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (t_nakayama0714 さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>t_nakayama0714さんの<br />1位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>291</kbd>
		<a target="_blank" href="https://qiita.com/t_nakayama0714/items/c0eb5e298524c127bccd">無料で整える趣味チームの開発環境</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-19 14:05:08</center>
	</td>
	<td style="width:200px;">
		@t_nakayama0714<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/45253/profile-images/1473690211">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[開発環境]</b> <b>[ChatOps]</b> <b>[チーム]</b> <b>[無料]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="趣味チーム" class="fragment"></span><a href="#%E8%B6%A3%E5%91%B3%E3%83%81%E3%83%BC%E3%83%A0"><i class="fa fa-link"></i></a><strong>趣味チーム？</strong>
</h1>

<p>趣味チームに所属している方はいらっしゃるでしょうか。<br>
お仕事関係なしに友人たちと趣味で開発するような人たちです。<br>
趣味と言えどもチームですから、チームで使える開発環境を整えたくなります。</p>

<p>「 <strong>趣味チームの開発環境を整えたい</strong> 」</p>

<p>そう思った時に課題になるのが <strong>お金</strong> です。<br>
もちろん投資だと思ってお金を出せればいいのですが、基本線は趣味ですから中々そうもいきません。<br>
ここはひとつ趣味の一環として、 <strong>無料縛り</strong> という制約を貸した上で、趣味チームの開発環境をどこまで整えられるのかを考えてみたいと思います。</p>

<h2>
<span id="環境イメージ" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>環境イメージ</h2>

<p>先にネタばらしをしておくと、以下のような感じに落ち着きました。利用量の制限はありますが <strong>無料</strong> です。</p>

<p><em><a href="https://camo.qiitausercontent.com/684e113d5c0aa3dfcbe6f84262fba7e73abf6e36/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63663961626534362d393265392d646539382d346134392d6330316236663464396533362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/684e113d5c0aa3dfcbe6f84262fba7e73abf6e36/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63663961626534362d393265392d646539382d346134392d6330316236663464396533362e706e67" width="800" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/cf9abe46-92e9-de98-4a49-c01b6f4d9e36.png"></a><br>
<div>Icons made by <a href="https://www.flaticon.com/authors/prosymbols" title="Prosymbols" rel="nofollow noopener" target="_blank">Prosymbols</a> from <a href="https://www.flaticon.com/" title="Flaticon" rel="nofollow noopener" target="_blank"></a><a href="http://www.flaticon.com" rel="nofollow noopener" target="_blank">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" rel="nofollow noopener" target="_blank">CC 3.0 BY</a>
</div></em></p>

<p>簡単に言うと以下のようなことができます。</p>

<ul>
<li>メンバ数 <strong>制限なし</strong>
</li>
<li>
<strong>プライベートリポジトリ</strong> 作成可</li>
<li>任意のデバイスからのチャット(～1万メッセージ)、ファイル共有(～15GB)</li>
<li>
<strong>毎月2000分</strong> までのCI</li>
<li><strong>24時間稼働のChatbot</strong></li>
<li>
<strong>24時間稼働のVM</strong> (1vCPU, 0.6GB) × 1</li>
</ul>

<h3>
<span id="chatops" class="fragment"></span><a href="#chatops"><i class="fa fa-link"></i></a>ChatOps</h3>

<p>イメージ図から大体想像つくかと思いますが、Blumix上のHubotでSlackからChatOps的なこともやってます。</p>

<ul>
<li>VMの <strong>起動 / 停止</strong>
</li>
<li>
<strong>定期ジョブの実行</strong>

<ul>
<li>起動中VMの通知</li>
<li>課金額の通知</li>
</ul>
</li>
<li>VMでのコマンド実行</li>
</ul>

<p>地味にありがたいのは「 <strong>起動中VMの通知</strong> 」「 <strong>VMの停止</strong> 」あたりですかね。<br>
無料枠だけではどうしてもリソースが足りないときは当然有料のVMを借りるんですが、なんとなく止め忘れちゃったりすることもあるので、 <strong>気づくことと停止がSlackだけでサクッとできる</strong> のは非常に重宝します。</p>

<p>あとは「課金額の通知」なんかも <strong>無料縛り</strong> の実現のためには重要なbot機能でしょうか。</p>

<h2>
<span id="サービスカテゴリ" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA"><i class="fa fa-link"></i></a>サービスカテゴリ</h2>

<p>今回は下記のカテゴリについて、全体的なバランスをみながら考えました。</p>

<ul>
<li><strong>Chat</strong></li>
<li><strong>Git Repository</strong></li>
<li><strong>CI</strong></li>
<li><strong>Infra/App Platform</strong></li>
<li><strong>Filestorage</strong></li>
<li><strong>その他</strong></li>
</ul>

<p>それぞれの中には「なんとなく決めた」ものも当然入っていますので、厳密な評価でないことはご容赦ください。<br>
各カテゴリについて、</p>

<ul>
<li>
<strong>Point</strong>

<ul>
<li>サービスを選定する上で外せなかったポイント。いわゆる要件。</li>
</ul>
</li>
<li>
<strong>Pros</strong>

<ul>
<li>そのサービスのよいところ、イケてるところ。</li>
</ul>
</li>
<li>
<strong>Cons</strong>

<ul>
<li>そのサービスのわるいところ、イマイチなところ。</li>
</ul>
</li>
</ul>

<p>の観点で簡単に評価していきたいと思います。</p>

<h1>
<span id="chat" class="fragment"></span><a href="#chat"><i class="fa fa-link"></i></a><strong>Chat</strong>
</h1>

<p>まずはコミュニケーションの要、チャットツールを考えましょう。</p>

<ul>
<li><strong><a href="https://slack.com/" rel="nofollow noopener" target="_blank">Slack</a></strong></li>
<li><a href="https://gitter.im/" rel="nofollow noopener" target="_blank">Gitter</a></li>
<li><a href="https://ja.atlassian.com/software/hipchat" rel="nofollow noopener" target="_blank">HipChat</a></li>
<li><a href="http://www.chatwork.com/ja/" rel="nofollow noopener" target="_blank">ChatWork</a></li>
<li><a href="https://line.me/ja/" rel="nofollow noopener" target="_blank">LINE</a></li>
<li><a href="https://www.skype.com/ja/" rel="nofollow noopener" target="_blank">Skype</a></li>
</ul>

<p>無料で使えるものだけでも結構な数があります。  </p>

<h2>
<span id="point" class="fragment"></span><a href="#point"><i class="fa fa-link"></i></a>Point</h2>

<p>基本的にはPCに向かって開発をやるわけではありますが、コミュニケーション自体は色々なところでやりますので、 <strong>マルチデバイス対応</strong> が重要です。<br>
PC版(Windows/Mac/Linux)、モバイル版(Android/iOS)への対応が必須です。<br>
また、色んなことをして遊びたいので <strong>bot連携</strong> 、 <strong>外部サービス連携</strong> のしやすさも重視したポイントです。</p>

<p>以上を踏まえ、チャットサービスには <strong>Slack</strong> を選択しました。</p>

<h2>
<span id="slack" class="fragment"></span><a href="#slack"><i class="fa fa-link"></i></a><strong>Slack</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/b18345f7c5b5c45746a70632162594197b39b21a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f31623739616638362d366461392d316234612d393963372d3734366237613135663634632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b18345f7c5b5c45746a70632162594197b39b21a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f31623739616638362d366461392d316234612d393963372d3734366237613135663634632e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/1b79af86-6da9-1b4a-99c7-746b7a15f64c.png"></a></p>

<h3>
<span id="pros" class="fragment"></span><a href="#pros"><i class="fa fa-link"></i></a>Pros</h3>

<ul>
<li>マルチデバイス対応</li>
<li>豊富な外部連携</li>
</ul>

<p>何と言っても外部連携に寛容でIT技術者向けなところが最大の長所といえます。</p>

<p>他サービスに比べれば標準で持っている機能に乏しい面があったりしますが、ターゲットがIT技術者であるがゆえにAPIやら何やらで利用者自身がその不足を補えるようになっています。 <strong>楽しい</strong> 。<br>
IT界隈でのチャットサービスとしてはデファクトスタンダードとなっているので、情報量豊富なのも遊ぶアイデアに困ることなく嬉しいポイントです。</p>

<h3>
<span id="cons" class="fragment"></span><a href="#cons"><i class="fa fa-link"></i></a>Cons</h3>

<p>今回の例で言えば特段気になる点はなかったのですが、一般的な比較においてはタスク管理などのチャット以外の機能について言及されることが多いようですね。<br>
また、「アカウントを持たない社外メンバとも気軽にやりとりしたい」というケースにも対応できないため、コミュニティクローズドな部分が場合によっては短所になるようです。<sup id="fnref1"><a href="#fn1" rel="footnote" title="Shared Channelという機能が今後登場するようなので、この部分は短所としては弱くなっていくかもしれません。">1</a></sup></p>

<ul>
<li><a href="https://boxil.jp/mag/a110/" rel="nofollow noopener" target="_blank">チャットワークとSlackどちらを採用すべき？2大チャットツールを徹底比較！</a></li>
</ul>

<h1>
<span id="git-repository" class="fragment"></span><a href="#git-repository"><i class="fa fa-link"></i></a><strong>Git Repository</strong>
</h1>

<p>おそらく何かしらを開発することになると思うので、成果物を共有するための場所が必要です。<br>
ソースコードといえばバージョン管理システムが必須になるでしょうから、Gitのサービスを選んでみます。</p>

<ul>
<li><strong><a href="https://gitlab.com" rel="nofollow noopener" target="_blank">GitLab</a></strong></li>
<li><a href="https://github.com" rel="nofollow noopener" target="_blank">GitHub</a></li>
<li><a href="https://bitbucket.org" rel="nofollow noopener" target="_blank">BitBucket</a></li>
</ul>

<h2>
<span id="point-1" class="fragment"></span><a href="#point-1"><i class="fa fa-link"></i></a>Point</h2>

<p>作るものにもよりけりですが、今回はチームで内々に作っていきたいものだったため、 <strong>プライベートリポジトリ</strong> が要件としてありました。<br>
この点では業界のデファクトスタンダードである GitHub は少し弱いため、他の機能の豊富さと相まって <strong>GitLab</strong> を選ぶに至りました。</p>

<h2>
<span id="gitlab" class="fragment"></span><a href="#gitlab"><i class="fa fa-link"></i></a><strong>GitLab</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/99d740e89de0ecb9b50f2b9d6b5dddd810009277/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35633962343035612d326233342d333865342d346137652d3364386664313262373535662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/99d740e89de0ecb9b50f2b9d6b5dddd810009277/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35633962343035612d326233342d333865342d346137652d3364386664313262373535662e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/5c9b405a-2b34-38e4-4a7e-3d8fd12b755f.png"></a></p>

<h3>
<span id="pros-1" class="fragment"></span><a href="#pros-1"><i class="fa fa-link"></i></a>Pros</h3>

<p>ポイントでも述べた通り、 <strong>プライベートリポジトリが無料</strong> で使えるのが魅力です。<br>
プライベートリポジトリという点ではBitBucketも無料で使えるのですが、無料のプライベートリポジトリは <strong>所属ユーザが5名まで</strong> という制限があります。<br>
その他、GitLabは競合するサービスと同等の各種機能を備え、後述する <strong>CI機能</strong> すら備わっています。</p>

<h3>
<span id="cons-1" class="fragment"></span><a href="#cons-1"><i class="fa fa-link"></i></a>Cons</h3>

<p>仮にチームの成果物をクローズドではなくオープンに見せたい場合は <strong>圧倒的にGitHubが優位</strong> になると言えます。<br>
ここに至っては機能よりサービスとしての <strong>知名度</strong> がモノを言いますので、GitLab最大の弱点と言えるでしょう。<br>
また、個人的には好きですがGitLabはガンガン最新版へのアップデートをかけていくため、気づいたらUIがずいぶん変わっていたなんとことも起こったりします。</p>

<p>あとはチームの大きさにもよりますが、「1 Issue, 1 Asignee」ってのも場合によっては問題になるかもしれません。</p>

<h1>
<span id="ci" class="fragment"></span><a href="#ci"><i class="fa fa-link"></i></a><strong>CI</strong>
</h1>

<p>さて、ソースコードの管理に続いてCI機能もほしいところです。<br>
リポジトリへのpushに反応してビルドなどを自動で行ってくれるCIサービスは一度使い始めるとやめられない魅力があります。</p>

<ul>
<li><strong><a href="https://about.gitlab.com/features/gitlab-ci-cd/" rel="nofollow noopener" target="_blank">GitLab CI</a></strong></li>
<li><a href="https://circleci.com/" rel="nofollow noopener" target="_blank">Circle CI</a></li>
<li><a href="https://travis-ci.org/" rel="nofollow noopener" target="_blank">Travis CI</a></li>
<li><a href="https://concourse.ci/" rel="nofollow noopener" target="_blank">Concourse CI</a></li>
<li><a href="https://www.appveyor.com/" rel="nofollow noopener" target="_blank">Appveyor</a></li>
<li><a href="https://semaphoreci.com/" rel="nofollow noopener" target="_blank">Semaphore</a></li>
</ul>

<h2>
<span id="point-2" class="fragment"></span><a href="#point-2"><i class="fa fa-link"></i></a>Point</h2>

<p>基本的にはソースコードと密接に関連があるもののため、Gitサービスとの連携性が重要なポイントになります。<br>
とはいえ、基本的なところは「Git連携機能」として各サービス共通ですし、サービス固有ということであればGitHubとそれ以外っていうくくりになります。<br>
今回はGitリポジトリにGitLabを選んでいるため、連携性での優位性はGitLab CIを含めて特段関係がないと思われます。</p>

<ul>
<li><a href="http://srz-zumix.blogspot.jp/2016/01/ci.html" rel="nofollow noopener" target="_blank">無料で使える CI サービス比較</a></li>
</ul>

<p>あとは上記ページでもまとめられていますが、 <strong>ビルド時間の制限</strong> はサービスごとにちょっとばらつきがあるようです。<br>
選定時点で特にこだわりはなかったのでGitリポジトリとの親和性をイメージして <strong>GitLab CI</strong> を選択しています。</p>

<h2>
<span id="gitlab-ci" class="fragment"></span><a href="#gitlab-ci"><i class="fa fa-link"></i></a><strong>GitLab CI</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/99d740e89de0ecb9b50f2b9d6b5dddd810009277/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35633962343035612d326233342d333865342d346137652d3364386664313262373535662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/99d740e89de0ecb9b50f2b9d6b5dddd810009277/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35633962343035612d326233342d333865342d346137652d3364386664313262373535662e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/5c9b405a-2b34-38e4-4a7e-3d8fd12b755f.png"></a></p>

<h3>
<span id="pros-2" class="fragment"></span><a href="#pros-2"><i class="fa fa-link"></i></a>Pros</h3>

<p>GitLabとの連携という点では印象的には優れている感があります。<br>
SlackインテグレーションなんかでもGitLab連携ひとつで済むので、趣味チームとして利用サービスが少ないのはそこそこ嬉しくはあります。</p>

<p>また、今回悩まなかったのですが、この記事のため調べていて「 <strong>プライベートリポジトリに対するCI</strong> 」って意外とできないところが多いんだなと感じました。もちろんGitLabとGitLab CIの組み合わせなら気にする必要はありません。</p>

<h3>
<span id="cons-2" class="fragment"></span><a href="#cons-2"><i class="fa fa-link"></i></a>Cons</h3>

<p>機能的なところでいくと、GitLab CIは「時間トリガー」で処理を実行することができません。<br>
時間トリガーってところであれば、 <strong>Appveyor</strong> とか <strong>Semaphore</strong> あたりを使うことになると思います。</p>

<ul>
<li><a href="http://srz-zumix.blogspot.jp/2016/10/ci.html" rel="nofollow noopener" target="_blank">無料で使える CI サービス比較（定期実行編）</a></li>
</ul>

<p>ちなみに今回は時間トリガー処理はCIサービスに頼らずbotで動く <a href="https://www.npmjs.com/package/cron" rel="nofollow noopener" target="_blank">cron</a> 機能に任せています。</p>

<h1>
<span id="infraapp-platform" class="fragment"></span><a href="#infraapp-platform"><i class="fa fa-link"></i></a><strong>Infra/App Platform</strong>
</h1>

<p>チームで成果物を作ったら、おそらくどこかで動したくなるものでしょう。<br>
そういった場合にいわゆるIaaSやPaaSといったサービスを利用したくなります。</p>

<ul>
<li>
<strong><a href="https://www.ibm.com/cloud-computing/bluemix/" rel="nofollow noopener" target="_blank">Bluemix</a></strong>

<ul>
<li><a href="https://www.ibm.com/cloud-computing/bluemix/ja/pricing" rel="nofollow noopener" target="_blank">Bluemix Pricing</a></li>
</ul>
</li>
<li>
<strong><a href="https://cloud.google.com/?hl=ja" rel="nofollow noopener" target="_blank">GCP</a></strong>

<ul>
<li><a href="https://cloud.google.com/free/?hl=ja" rel="nofollow noopener" target="_blank">Google Cloud Platform Free Tier</a></li>
</ul>
</li>
<li>
<a href="https://www.heroku.com/home" rel="nofollow noopener" target="_blank">Heroku</a>

<ul>
<li><a href="https://www.heroku.com/pricing" rel="nofollow noopener" target="_blank">Simple, flexible pricing</a></li>
</ul>
</li>
<li>
<a href="https://aws.amazon.com/jp/" rel="nofollow noopener" target="_blank">AWS</a>

<ul>
<li><a href="https://aws.amazon.com/jp/free/" rel="nofollow noopener" target="_blank">AWS Free Tier</a></li>
</ul>
</li>
<li>
<a href="https://azure.microsoft.com/ja-jp/" rel="nofollow noopener" target="_blank">Azure</a>

<ul>
<li><a href="https://azure.microsoft.com/ja-jp/free/pricing-offers/" rel="nofollow noopener" target="_blank">free pricing offers</a></li>
</ul>
</li>
</ul>

<h2>
<span id="point-3" class="fragment"></span><a href="#point-3"><i class="fa fa-link"></i></a>Point</h2>

<p>ここに並んだサービスのシェアだけで言えば圧倒的に <strong>AWS</strong> なのですが、意外とAWSの無料枠はしょっぱかったりするのでお金のない趣味チームには向きません。<br>
そこで出てくるのが <strong>Bluemix</strong> と <strong>GCP</strong> です。<br>
サービスが多岐にわたることからぱっと理解するのが難しいのですが <strong><a href="https://www.ibm.com/cloud-computing/bluemix/ja/pricing" rel="nofollow noopener" target="_blank">Bluemix Pricing</a></strong> や <strong><a href="https://cloud.google.com/free/?hl=ja" rel="nofollow noopener" target="_blank">Google Cloud Platform Free Tier</a></strong> を見ると、結構色々なものに無料枠が備わっていることがわかります。<br>
今回特に注目したのが、「仮想マシン」「アプリエンジン」でした。</p>

<h2>
<span id="bluemix--gcp" class="fragment"></span><a href="#bluemix--gcp"><i class="fa fa-link"></i></a><strong>Bluemix &amp; GCP</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/37b5e121fbe5d8a0caabf99c890ccbc8abd6d7ae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f33333530303132302d376236322d323932302d393566362d3637303233366334636664642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/37b5e121fbe5d8a0caabf99c890ccbc8abd6d7ae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f33333530303132302d376236322d323932302d393566362d3637303233366334636664642e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/33500120-7b62-2920-95f6-670236c4cfdd.png"></a><a href="https://camo.qiitausercontent.com/565fb00f000c661d7da5c75673aaf73fef06ee5b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35333966306266632d313963382d653032662d393661362d3163373036396262353262622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/565fb00f000c661d7da5c75673aaf73fef06ee5b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35333966306266632d313963382d653032662d393661362d3163373036396262353262622e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/539f0bfc-19c8-e02f-96a6-1c7069bb52bb.png"></a></p>

<h3>
<span id="pros-3" class="fragment"></span><a href="#pros-3"><i class="fa fa-link"></i></a>Pros</h3>

<ul>
<li>
<strong>仮想マシン</strong>

<ul>
<li>
<a href="https://cloud.google.com/compute/?hl=ja" rel="nofollow noopener" target="_blank">GCP: Google Compute Engine</a>

<ul>
<li>1ヶ月あたりf1-micro(1vCPU, 0.60GB)相当分が無料</li>
<li>米国リージョンのみ</li>
<li>ネットワークトラフィックの課金に注意

<ul>
<li><a href="http://qiita.com/hnw/items/a4e395d047b382e7dc5f" id="reference-2a953805342f8673fc65">GCEのf1-microインスタンスを真にタダで使う方法</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<strong>アプリエンジン</strong>

<ul>
<li>
<a href="https://www.ibm.com/cloud-computing/bluemix/runtimes" rel="nofollow noopener" target="_blank">Bluemix: Bluemix Cloud Foundry app runtimes</a>

<ul>
<li>1ヶ月あたり512MB・月が無料</li>
<li><a href="http://qiita.com/akameco/items/39a55635ceb0ba185b7f" id="reference-697e5aa6998acd23ede2">参考: Herokuでbotを運用する時代は終わった。これからはIBM Bluemixを使って無料で運用する</a></li>
</ul>
</li>
<li>
<a href="https://cloud.google.com/appengine/?hl=ja" rel="nofollow noopener" target="_blank">GCP: Google App Engine</a>

<ul>
<li>1日あたり28時間・インスタンスが無料</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>参考にもあるように、Bluemixを使ってbotを24時間運用しています。簡単な処理をこいつにさせることも出来るので意外と重宝しています。<br>
ちなみに少し前まではBluemixでdashDBというRDBがデータ量1GBまで無料だったのですが、いつの間にかなくなっていました。残念です。<br>
dashDBの無料枠がなくなってしまった今では <a href="https://www.ibm.com/analytics/jp/ja/technology/cloud-data-services/cloudant/" rel="nofollow noopener" target="_blank">IBM Cloudant</a> というNoSQLが1ヶ月あたり1GB分無料となっています。</p>

<h3>
<span id="cons-3" class="fragment"></span><a href="#cons-3"><i class="fa fa-link"></i></a>Cons</h3>

<p>無料枠が強気なところがまさにそのためだと思うのですが、BluemixとGCPはAWSやAzureに比べて情報が少ないです。<br>
実際には、AWSに関する情報量とAzureを含めたその他全ての情報量を比べてもまだAWSに勝てないというような構図だと思いますが、無料でがんばろうとするのであれば、こうした情報収集で音を上げるわけにはいかないところです。</p>

<p>Bluemixは元々SoftLayerっていうIaaSとBluemixっていうPaasに分かれていたこともあり、サービスとしての全体像が掴みにくいのですが、IBMならではのWatsonサービスを使って <a href="http://qiita.com/tsota/items/497513585f069386626f" id="reference-25903567adb81490ca41">会話エンジンにWatson Conversationを使ったSlack botを作ってみた</a> みたいなことができたりもします。</p>

<p>一方GCPはどうかというと、 <strong><a href="https://cloud.google.com/bigquery/?hl=ja" rel="nofollow noopener" target="_blank">BigQuery</a></strong> が1ヶ月あたり1TBスキャンまで無料だたり、画像認識の <strong><a href="https://cloud.google.com/vision/?hl=ja" rel="nofollow noopener" target="_blank">Google Cloud Vision API</a></strong> が1ヶ月あたり1000ユニットまで無料で使えたりします。</p>

<h3>
<span id="注意" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>注意</h3>

<p>ただし、これらの無料枠を使用するためにはアカウントに対して <strong>クレジットカードの紐付け</strong> が必要になります。<br>
無料枠を超えた分は自動的に課金されることになるため、各サービスの課金体系を理解し、使用量を正しくモニタリングできない場合は安易に手を出さないほうがよいでしょう。戒めのため以下の記事を紹介します。</p>

<ul>
<li><a href="http://qiita.com/itkr/items/745d54c781badc148bb9" id="reference-2657d944d1a4c6562a07">BigQueryで150万円溶かした人の顔</a></li>
<li><a href="http://blog.hde.co.jp/entry/2015/01/30/154101" rel="nofollow noopener" target="_blank">Amazon Glacierでクラウド破産しないために</a></li>
</ul>

<p>また、ありがちな話ですが各種リソースをコントロール可能な <strong>APIキーの公開は絶対にやめましょう &amp; 注意しましょう</strong> 。</p>

<ul>
<li><a href="http://qiita.com/mochizukikotaro/items/a0e98ff0063a77e7b694" id="reference-dbe4e7065208cbc4ac1b">初心者がAWSでミスって不正利用されて$6,000請求、泣きそうになったお話。</a></li>
<li><a href="http://qiita.com/pottava/items/4c602c97aacf10c058f1" id="reference-97f754c0ad1b7aba4a81">クラウド破産しないように git-secrets を使う</a></li>
</ul>

<h1>
<span id="filestorage" class="fragment"></span><a href="#filestorage"><i class="fa fa-link"></i></a><strong>Filestorage</strong>
</h1>

<p>ソースコードはGitで管理、共有すればいいのですが、バイナリファイルをGitに置くのは心が痛みます。<br>
そのため、ファイルストレージサービスを探しましょう。</p>

<ul>
<li><strong><a href="https://www.google.com/intl/ja_jp/drive/" rel="nofollow noopener" target="_blank">Google Drive</a></strong></li>
<li><a href="https://www.dropbox.com" rel="nofollow noopener" target="_blank">Dropbox</a></li>
<li><a href="https://www.box.com/ja-jp" rel="nofollow noopener" target="_blank">BOX</a></li>
<li><a href="https://mega.co.nz/" rel="nofollow noopener" target="_blank">MEGA</a></li>
<li><a href="http://www.chatwork.com/ja/" rel="nofollow noopener" target="_blank">ChatWork</a></li>
</ul>

<h2>
<span id="point-4" class="fragment"></span><a href="#point-4"><i class="fa fa-link"></i></a>Point</h2>

<p>基本的にはバイナリファイルの受け渡し場所として機能すればよいため、正直なところあまりポイントはありません。<br>
データをまるっと渡したりすることがあるかもと考えると、最低でも10GBくらいはあると安心かもしれません。</p>

<ul>
<li><a href="https://ferret-plus.com/2377" rel="nofollow noopener" target="_blank">【比較表有】容量だけで選んでいいの？無料オンラインファイルストレージ17選</a></li>
</ul>

<p>また、すでにチャットカテゴリでも登場している ChatWork ですが、チーム機能の一環でファイルストレージ機能ももっています。<br>
利用サービスを極力少なくしたいということであれば、 ChatWork に寄せてしまうのもアリでしょう。</p>

<h2>
<span id="google-drive" class="fragment"></span><a href="#google-drive"><i class="fa fa-link"></i></a><strong>Google Drive</strong>
</h2>

<p><a href="https://camo.qiitausercontent.com/f075cd0030ca5f3aefbcd24fb138a13b2b4e37c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f34353235613231632d376562382d333935342d623163372d3439316433616164653837312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f075cd0030ca5f3aefbcd24fb138a13b2b4e37c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f34353235613231632d376562382d333935342d623163372d3439316433616164653837312e706e67" width="400" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/4525a21c-7eb8-3954-b1c7-491d3aade871.png"></a></p>

<h3>
<span id="pros-4" class="fragment"></span><a href="#pros-4"><i class="fa fa-link"></i></a>Pros</h3>

<p>15GBと比較的容量が多いことと、 <strong><a href="https://get.slack.help/hc/ja/articles/205875058-Slack-%E3%81%A7-Google-%E3%83%89%E3%83%A9%E3%82%A4%E3%83%96%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B" rel="nofollow noopener" target="_blank">Slackとの親和性</a></strong> が高いところでしょうか。<br>
Excelみたいなものを共有する場合、Googleスプレッドシートなどでブラウザ上でそのまま開けるのも便利です。</p>

<p>あとは多分チームのみんなGoogleアカウントは持っているでしょうから、アカウント増やさなくて済むのも割と大きな魅力です。</p>

<h3>
<span id="cons-4" class="fragment"></span><a href="#cons-4"><i class="fa fa-link"></i></a>Cons</h3>

<p>先に挙げた比較ページを見てわかると思いますが、15GBという容量は比較的多いのですが、トップではありません。<br>
トップのMEGAは無料で50GB使えるらしいので、 <strong>容量重視であればMEGA一択</strong> でしょう。</p>

<p>また、Google Driveの容量15GBというのはアカウントあたりであるため、誰かのアカウントの領域を他メンバに共有するという形態になります。<br>
そのため、個人が元々Googleドライブを利用していた場合、チーム開発用途と個人用途で15GBとなってしまうのも難点の1つと言えるでしょう。</p>

<h1>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a><strong>その他</strong>
</h1>

<p>ここからはオマケです。今のところ使っていませんが、ニーズは感じているため使おうかな―と考えているようなものです。</p>

<h2>
<span id="task-management" class="fragment"></span><a href="#task-management"><i class="fa fa-link"></i></a>Task Management</h2>

<p>GitリポジトリにはIssue機能がありますから、ソースコードに関連するタスクをIssueとして記録しておくことができます。<br>
一方で、ソースコードに直接紐付かない微妙なタスクや全体のナレッジはどこにも残せなかったりするのでチームに紐づくタスクやナレッジの管理ができると便利です。</p>

<ul>
<li><a href="https://www.wrike.com/ja/" rel="nofollow noopener" target="_blank">Wrike</a></li>
<li><a href="https://trello.com/" rel="nofollow noopener" target="_blank">Trello</a></li>
<li><a href="https://asana.com/" rel="nofollow noopener" target="_blank">Asana</a></li>
</ul>

<p>他にも無料プランがあるものはいくつかあるようです。</p>

<h3>
<span id="point-5" class="fragment"></span><a href="#point-5"><i class="fa fa-link"></i></a>Point</h3>

<p>タスク管理ツール自体は結構使ってみないと良し悪しがわからなかったりするので、これといった要件を出すことが難しかったりします。</p>

<ul>
<li><a href="http://mfl.revee.jp/blog/project-management-tool-2015/" rel="nofollow noopener" target="_blank">長く使えるプロジェクト管理ツール厳選レポート2017</a></li>
</ul>

<p>タスク進捗はチャットから見たいと思いますので、 <strong><a href="https://slack.com/apps" rel="nofollow noopener" target="_blank">Slack Apps</a></strong> にあるものを優先的に選んでみるのでもいいかもしれません。</p>

<h2>
<span id="monitoring" class="fragment"></span><a href="#monitoring"><i class="fa fa-link"></i></a>Monitoring</h2>

<p>趣味チームとはいえクオリティを気にしていきたい場合、何かしらのモニタリングが必要です。</p>

<ul>
<li><a href="https://www.datadoghq.com/" rel="nofollow noopener" target="_blank">Datadog</a></li>
<li><a href="https://mackerel.io/ja/" rel="nofollow noopener" target="_blank">Mackerel</a></li>
<li><a href="https://newrelic.com/" rel="nofollow noopener" target="_blank">New-Relic</a></li>
</ul>

<h3>
<span id="point-6" class="fragment"></span><a href="#point-6"><i class="fa fa-link"></i></a>Point</h3>

<p>一言にモニタリングといってもサーバレイヤとアプリレイヤがありますので、それによってもポイントが異なります。<br>
GCEで無料仮想マシンを使っている場合には Datadog をとりあえず入れておくのがよいでしょうし、作ったアプリの挙動を見たいってことであれば New-Relic だったり他のものを使うことになると思います。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a><strong>おわりに</strong>
</h1>

<p><strong>無料縛り</strong> での開発環境整備、いかがだったでしょうか。<br>
もちろんお金を少しでも払えばまた全然違った結果になるのですが、無料でもかなり便利に &amp; 遊べるようになるかと思います。<br>
使ってみると便利なものばかりですので、色々なものを試してみるのはとてもよいなと思いました。</p>

<p>この記事で挙げたカテゴリや、ここにないカテゴリでも趣味チームに向いているサービスなんかがあったらぜひ共有いただきたいです！<br>
それでは <strong>よい趣味チームライフ</strong> を！</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><a href="https://slackhq.com/introducing-shared-channels-where-you-can-work-with-anyone-in-slack-8c5d2a943f57" rel="nofollow noopener" target="_blank">Shared Channel</a>という機能が今後登場するようなので、この部分は短所としては弱くなっていくかもしれません。 <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>t_nakayama0714さんの<br />2位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>64</kbd>
		<a target="_blank" href="https://qiita.com/t_nakayama0714/items/80b4c94de43643f4be51">【シェル芸人への道】Bashの変数展開と真摯に向き合う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-18 06:21:52</center>
	</td>
	<td style="width:200px;">
		@t_nakayama0714<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/45253/profile-images/1473690211">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ShellScript]</b> <b>[Bash]</b> <b>[シェル芸]</b> <b>[シェルスクリプト]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a><strong>はじめに</strong>
</h1>

<p>個人的なシェル(スクリプト)あるあるなんですが、Bashの <strong>変数展開</strong> って思った以上に色んなことができるってことに気がつきます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>「なんかいい感じの書き方ないかなー」
「cut, tr, sed, awk, ...、まぁできるのは間違いないんだけど」
「うーん」ｸﾞｸﾞﾘ―

(10分後)

「えっ、変数展開...？(怪訝)」ﾎﾟﾁﾎﾟﾁ
「...」ｶﾀｶﾀ

「いけるやん！！！」
</pre></div></div>

<p>ってことが結構あります(当社比)。<br>
毎回調べるのも感動があっていいと思うんですが、もはや衝動を押さえきれないので <strong>全部調べたい</strong> と思います。</p>

<p>Bashのバージョンは <strong>4.3.48(1)</strong> でした。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">バージョン</span></div>
<div class="highlight"><pre><span></span>$ bash --version
GNU bash, version <span class="m">4</span>.3.48<span class="o">(</span><span class="m">1</span><span class="o">)</span>-release <span class="o">(</span>x86_64-pc-linux-gnu<span class="o">)</span>
Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2013</span> Free Software Foundation, Inc.
License GPLv3+: GNU GPL version <span class="m">3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;

This is free software<span class="p">;</span> you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
</pre></div>
</div>

<h1>
<span id="どうやって" class="fragment"></span><a href="#%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6"><i class="fa fa-link"></i></a><strong>どうやって？</strong>
</h1>

<p>あまり馴染みがない人もいるかもしれませんが、みんな大好き <code>man</code> を見ます。<br>
<code>bash</code> って身近すぎてmanで見るイメージがないかもしれませんが、見れます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ man bash
BASH(1)                                   General Commands Manual                                   BASH(1)

NAME
       bash - GNU Bourne-Again SHell

SYNOPSIS
       bash [options] [command_string | file]

COPYRIGHT
       Bash is Copyright (C) 1989-2013 by the Free Software Foundation, Inc.
(略)
</pre></div></div>

<p><strong>そう、Bashの使い方のすべてはここにあるのです。</strong></p>

<p>ちなみにWebでググっても大体すぐ見つかります。<br>
以降は <strong><a href="http://man7.org/linux/man-pages/man1/bash.1.html" rel="nofollow noopener" target="_blank">bash(1) - Linux manual page</a></strong> のページをベースに話します。</p>

<h1>
<span id="どこなの" class="fragment"></span><a href="#%E3%81%A9%E3%81%93%E3%81%AA%E3%81%AE"><i class="fa fa-link"></i></a><strong>どこなの？</strong>
</h1>

<p>変数展開の話は章立てでいくと、</p>

<p><strong><code>Basic Shell Features -&gt; Shell Expansions -&gt; Shell Parameter Expansion</code></strong></p>

<p>にあります。どうやらBasicな話らしい。</p>

<h1>
<span id="変数展開" class="fragment"></span><a href="#%E5%A4%89%E6%95%B0%E5%B1%95%E9%96%8B"><i class="fa fa-link"></i></a><strong>変数展開</strong>
</h1>

<p>さしあたって、展開方法の一覧を出してみましょう。<br>
実際に <code>man bash</code> を見てみると、</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">manの抜粋</span></div>
<div class="highlight"><pre><span></span>       <span class="si">${</span><span class="nv">parameter</span><span class="k">:-</span><span class="nv">word</span><span class="si">}</span>
              Use Default Values.  If parameter is <span class="nb">unset</span> or null, the expansion  of  word  is  substituted.
              Otherwise, the value of parameter is substituted.
       <span class="si">${</span><span class="nv">parameter</span><span class="p">:=word</span><span class="si">}</span>
              Assign  Default  Values.  If parameter is <span class="nb">unset</span> or null, the expansion of word is assigned to
              parameter.  The value of parameter is <span class="k">then</span> substituted.  Positional  parameters  and  special
              parameters may not be assigned to in this way.
</pre></div>
</div>

<p>というような感じになっています。<br>
したがって...</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">変数展開一覧</span></div>
<div class="highlight"><pre><span></span>$ man bash <span class="p">|</span> grep <span class="s2">"^\s*\${.*}</span>$<span class="s2">"</span> <span class="p">|</span> tr -d <span class="s2">" "</span>
<span class="si">${</span><span class="nv">parameter</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="k">:-</span><span class="nv">word</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">:=word</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">:?word</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">:+word</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">:</span><span class="nv">offset</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">:</span><span class="nv">offset</span><span class="p">:</span><span class="nv">length</span><span class="si">}</span>
<span class="si">${</span><span class="p">!prefix*</span><span class="si">}</span>
<span class="si">${</span><span class="p">!prefix@</span><span class="si">}</span>
<span class="si">${</span><span class="p">!name[@]</span><span class="si">}</span>
<span class="si">${</span><span class="p">!name[*]</span><span class="si">}</span>
<span class="si">${#</span><span class="nv">parameter</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">#word</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">##word</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">%word</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">%%word</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">/pattern/string</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">^pattern</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">^^pattern</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">,pattern</span><span class="si">}</span>
<span class="si">${</span><span class="nv">parameter</span><span class="p">,,pattern</span><span class="si">}</span>
</pre></div>
</div>

<p>というのが一覧です。 <strong>合計21個</strong> ありますが、これだけではさっぱりですね。<br>
それでは順に見ていきましょう。</p>

<h2>
<span id="parameter-参照" class="fragment"></span><a href="#parameter-%E5%8F%82%E7%85%A7"><i class="fa fa-link"></i></a><strong>${parameter}: 参照</strong>
</h2>

<p>最も普通なやつです。単純な参照の場合は <code>{}</code> で囲む必要はありませんが、ぱっと見たときの可読性もよく、いろいろ繋げた際に <strong>変数名を取り違える</strong> こともないです。<br>
シェル芸人か何かの持病で、コマンド文字数を少なくしたいとかいうことでなければ囲むのをオススメします。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">参照</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 代入</span>
$ <span class="nv">hoge</span><span class="o">=</span><span class="s2">"hoge-value"</span>

<span class="c1"># 確認</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value

$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">HOGE</span><span class="si">}</span>

</pre></div>
</div>

<p>おわかりのように、Bashでは変数名の大文字小文字を区別します。</p>

<h2>
<span id="parameter-word-デフォルト値代入なし" class="fragment"></span><a href="#parameter-word-%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4%E4%BB%A3%E5%85%A5%E3%81%AA%E3%81%97"><i class="fa fa-link"></i></a><strong>${parameter:-word}: デフォルト値(代入なし)</strong>
</h2>

<p>変数名の後ろに <code>:-</code> をつけたパターンです。<br>
この場合、参照した変数に値が入っていないときは後ろにくっつけた値が <strong>デフォルト値</strong> として使われます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">デフォルト値(代入なし)</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 値が入っている場合は特に変わらない</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="k">:-</span><span class="s2">"hoge-default"</span><span class="si">}</span>
hoge-value

<span class="c1"># 値をリセットしてみる</span>
$ <span class="nb">unset</span> hoge

<span class="c1"># 値が入っていないと、デフォルト値が出る</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>

$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="k">:-</span><span class="s2">"hoge-default"</span><span class="si">}</span>
hoge-default

<span class="c1"># 元の変数は無事</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>

</pre></div>
</div>

<h2>
<span id="parameterword-デフォルト値代入あり" class="fragment"></span><a href="#parameterword-%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4%E4%BB%A3%E5%85%A5%E3%81%82%E3%82%8A"><i class="fa fa-link"></i></a><strong>${parameter:=word}: デフォルト値(代入あり)</strong>
</h2>

<p>先ほどと似ていますが、変数名の後ろに <code>:=</code> をつけたパターンです。<br>
<code>:-</code> と同様に、デフォルト値が出る挙動は同じなのですが、こちらの場合 <strong>元の変数にもデフォルト値が代入</strong> されます。<br>
これを知らないと <code>if [ -z ${parameter} ] ; then parameter=word ; fi</code> みたいに長々と書くことになります。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">デフォルト値(代入あり)</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 値が入っているとき</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:=</span><span class="s2">"hoge-default"</span><span class="si">}</span>
hoge-value

<span class="c1"># 値をリセットする</span>
$ <span class="nb">unset</span> hoge

<span class="c1"># デフォルトの挙動をする</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>

$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:=</span><span class="s2">"hoge-default"</span><span class="si">}</span>
hoge-default

<span class="c1"># デフォルト値が参照されたタイミングで、変数本体にも代入される</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-default
</pre></div>
</div>

<h2>
<span id="parameterword-未定義時のエラー出力" class="fragment"></span><a href="#parameterword-%E6%9C%AA%E5%AE%9A%E7%BE%A9%E6%99%82%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E5%87%BA%E5%8A%9B"><i class="fa fa-link"></i></a><strong>${parameter:?word}: 未定義時のエラー出力</strong>
</h2>

<p>未定義のとき値を入れて素通りしてくれる心優しい輩がいる一方で、そうもいかないやつもいます。<br>
<code>:?</code> とすると、参照した変数が未定義だったり <strong>値が入っていない場合にエラー</strong> が出るようになります。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">未定義時のエラー出力</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 指定メッセージでエラーが出る</span>
$ <span class="nb">unset</span> hoge
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:?</span><span class="s2">"hoge-undefined"</span><span class="si">}</span>
-bash: hoge: hoge-undefined

<span class="c1"># エラー扱いにもなる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="p">?</span><span class="si">}</span>
<span class="m">1</span>

<span class="c1"># メッセージ指定がないとこうなる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:?</span><span class="si">}</span>
-bash: hoge: parameter null or not <span class="nb">set</span>
</pre></div>
</div>

<h2>
<span id="parameterword-定義時の代用" class="fragment"></span><a href="#parameterword-%E5%AE%9A%E7%BE%A9%E6%99%82%E3%81%AE%E4%BB%A3%E7%94%A8"><i class="fa fa-link"></i></a><strong>${parameter:+word}: 定義時の代用</strong>
</h2>

<p>変数が入っていない時に入れてくれる優しいやつがいる一方で、 <strong>値が入っているときにだけ割り込んでくる</strong> やつもいます。<br>
<code>:+</code> とすると変数定義時に指定の値が代用されるようになります。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">定義時の代用</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 値が入っていると指定の値で代用される</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:+</span><span class="s2">"other-hoge-value"</span><span class="si">}</span>
other-hoge-value

<span class="c1"># 逆に値が入っていないと何も出ない</span>
$ <span class="nb">unset</span> hoge
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:+</span><span class="s2">"other-hoge-value"</span><span class="si">}</span>

</pre></div>
</div>

<p>いつ使うんでしょうね。</p>

<h2>
<span id="parameteroffset-部分展開文字数指定なし" class="fragment"></span><a href="#parameteroffset-%E9%83%A8%E5%88%86%E5%B1%95%E9%96%8B%E6%96%87%E5%AD%97%E6%95%B0%E6%8C%87%E5%AE%9A%E3%81%AA%E3%81%97"><i class="fa fa-link"></i></a><strong>${parameter:offset}: 部分展開(文字数指定なし)</strong>
</h2>

<p>manの参照例に出ていますが、オフセットとは「基準からの相対的な距離」みたいな意味を表す言葉です。<br>
<code>:</code> で区切って後ろに数字をくっつけると、 <strong>指定位置までの文字列を除いて抜き出す</strong> 参照になります。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">部分展開(文字数指定なし)</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 10文字セット</span>
$ <span class="nv">hoge</span><span class="o">=</span><span class="s2">"hoge-value"</span>

<span class="c1"># 6文字目以降を参照することになる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:</span><span class="nv">5</span><span class="si">}</span>
value
</pre></div>
</div>

<p>これを他のコマンドでやるなら <code>echo ${hoge} | cut -c 6-</code> みたいになると思います。</p>

<h2>
<span id="parameteroffsetlength-部分展開文字数指定あり" class="fragment"></span><a href="#parameteroffsetlength-%E9%83%A8%E5%88%86%E5%B1%95%E9%96%8B%E6%96%87%E5%AD%97%E6%95%B0%E6%8C%87%E5%AE%9A%E3%81%82%E3%82%8A"><i class="fa fa-link"></i></a><strong>${parameter:offset:length}: 部分展開(文字数指定あり)</strong>
</h2>

<p>先ほどの部分展開から、さらに <code>:</code> で数字を続けると、指定位置までの分を除いた <strong>指定文字数分を抜き出す</strong> 参照になります。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">部分展開(文字数指定なし)</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 6文字目から全て</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:</span><span class="nv">5</span><span class="si">}</span>
value

<span class="c1"># 6文字目から3文字分</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:</span><span class="nv">5</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span>
val

<span class="c1"># 6文字目から-1文字分</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">:</span><span class="nv">5</span><span class="k">:-</span><span class="nv">1</span><span class="si">}</span>
valu
</pre></div>
</div>

<p>文字数指定部分には実は <strong>負の値も使えます</strong> 。<br>
その場合は、残った文字数から指定数を引いた分(負の数なので正確には足した分ですが...)の文字数を抜き出します。<br>
上の例でいけば、 <code>${hoge:5}</code> で展開される残り5文字(value)から <code>-1</code> を引いた残り4文字が展開されてvaluが出てきます。</p>

<h2>
<span id="prefix-変数名一覧" class="fragment"></span><a href="#prefix-%E5%A4%89%E6%95%B0%E5%90%8D%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a><strong>${!prefix*}: 変数名一覧</strong>
</h2>

<p>なんとも不思議な感じですが、定義されている変数名を探すことができます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">変数名一覧</span></div>
<div class="highlight"><pre><span></span><span class="c1"># BASH_ で始まる変数名一覧</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="p">!BASH_*</span><span class="si">}</span>
BASH_ALIASES BASH_ARGC BASH_ARGV BASH_CMDS BASH_COMMAND BASH_COMPLETION_COMPAT_DIR BASH_LINENO BASH_SOURCE BASH_SUBSHELL BASH_VERSINFO BASH_VERSION

<span class="c1"># @ を使っても同じ動きになる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="p">!BASH_@</span><span class="si">}</span>
BASH_ALIASES BASH_ARGC BASH_ARGV BASH_CMDS BASH_COMMAND BASH_COMPLETION_COMPAT_DIR BASH_LINENO BASH_SOURCE BASH_SUBSHELL BASH_VERSINFO BASH_VERSION

</pre></div>
</div>

<h2>
<span id="name-連想配列キー名一覧" class="fragment"></span><a href="#name-%E9%80%A3%E6%83%B3%E9%85%8D%E5%88%97%E3%82%AD%E3%83%BC%E5%90%8D%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a><strong>${!name[*]}: 連想配列キー名一覧</strong>
</h2>

<p>連想配列のキー名もとれます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">連想配列のキー名一覧</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 連想配列を定義</span>
$ <span class="nb">declare</span> -A <span class="nb">hash</span>
$ hash<span class="o">[</span><span class="s2">"hoge"</span><span class="o">]=</span><span class="s2">"hoge-value"</span>
$ hash<span class="o">[</span><span class="s2">"fuga"</span><span class="o">]=</span><span class="s2">"fuga-value"</span>

<span class="c1"># キー名一覧が取れる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="p">!hash[*]</span><span class="si">}</span>
fuga hoge

<span class="c1"># やはり @ でも同じ動き</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="p">!hash[@]</span><span class="si">}</span>
fuga hoge
</pre></div>
</div>

<p>ちなみに <code>!</code> を取れば、キー名ではなく中身が見えます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">連想配列のバリュー一覧</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hash</span><span class="p">[*]</span><span class="si">}</span>
fuga-value hoge-value

$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hash</span><span class="p">[@]</span><span class="si">}</span>
fuga-value hoge-value
</pre></div>
</div>

<h2>
<span id="parameter-文字数カウント" class="fragment"></span><a href="#parameter-%E6%96%87%E5%AD%97%E6%95%B0%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a><strong>${#parameter}: 文字数カウント</strong>
</h2>

<p><strong>変数の値が何文字か</strong> をカウントしたくなったことはありませんか？<br>
そう、展開だけでできてしまうんです。恐ろしい。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">文字数カウント</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 普通の変数</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value

<span class="c1"># カウントできる</span>
$ <span class="nb">echo</span> <span class="si">${#</span><span class="nv">hoge</span><span class="si">}</span>
<span class="m">10</span>

<span class="c1"># 空白入りはどうか</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">fuga</span><span class="si">}</span>
fuga space

<span class="c1"># 空白も1文字カウント</span>
$ <span class="nb">echo</span> <span class="si">${#</span><span class="nv">fuga</span><span class="si">}</span>
<span class="m">10</span>
</pre></div>
</div>

<p>他のコマンドでやろうとすると <code>wc -c</code> が該当するかと思いますが、改行コードもカウントする都合でこの用途では元々使われない印象があります。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">他の文字数カウント</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 10文字になるはずが</span>
$ <span class="nb">echo</span> <span class="si">${#</span><span class="nv">hoge</span><span class="si">}</span>
<span class="m">10</span>

<span class="c1"># 末尾の改行コードを含めて11文字に</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span> <span class="p">|</span> wc -c
<span class="m">11</span>

<span class="c1"># 改行コードを除去してやると一応一致はする(面倒)</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span> <span class="p">|</span> tr -d <span class="s2">"\n"</span> <span class="p">|</span> wc -c
<span class="m">10</span>
</pre></div>
</div>

<p>やっぱりBashがナンバーワン！！！</p>

<h2>
<span id="name-配列の要素数カウント" class="fragment"></span><a href="#name-%E9%85%8D%E5%88%97%E3%81%AE%E8%A6%81%E7%B4%A0%E6%95%B0%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a><strong>${#name[*]}: 配列の要素数カウント</strong>
</h2>

<p>変数の値もそうですが、 <strong>配列の要素数</strong> を数えたくなることもあると思います。 <code>list.size()</code> みたいな。<br>
やはり変数展開でできます。恐ろしい。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">配列の要素数カウント</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 2個入れる</span>
$ <span class="nv">list</span><span class="o">=(</span><span class="s2">"hoge-value"</span> <span class="s2">"fuga-value"</span><span class="o">)</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">list</span><span class="p">[*]</span><span class="si">}</span>
hoge-value fuga-value
$ <span class="nb">echo</span> <span class="si">${#</span><span class="nv">list</span><span class="p">[*]</span><span class="si">}</span>
<span class="m">2</span>

<span class="c1"># 増やしてみる</span>
$ <span class="nv">list</span><span class="o">+=(</span><span class="s2">"piyo-value"</span><span class="o">)</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">list</span><span class="p">[*]</span><span class="si">}</span>
hoge-value fuga-value piyo-value
$ <span class="nb">echo</span> <span class="si">${#</span><span class="nv">list</span><span class="p">[*]</span><span class="si">}</span>
<span class="m">3</span>

<span class="c1"># やはり @ でも同じ動き</span>
$ <span class="nb">echo</span> <span class="si">${#</span><span class="nv">list</span><span class="p">[@]</span><span class="si">}</span>
<span class="m">3</span>
</pre></div>
</div>

<p>連想配列の場合でも同様に要素数を取得することが可能です。<br>
<code>${hash[*]}</code> でバリューの一覧が出ますから、 <code>${#hash[*]}</code> バリューの数をカウントしている感じになります。</p>

<h2>
<span id="parameterword-前方一致除去最短一致" class="fragment"></span><a href="#parameterword-%E5%89%8D%E6%96%B9%E4%B8%80%E8%87%B4%E9%99%A4%E5%8E%BB%E6%9C%80%E7%9F%AD%E4%B8%80%E8%87%B4"><i class="fa fa-link"></i></a><strong>${parameter#word}: 前方一致除去(最短一致)</strong>
</h2>

<p><code>${parameter:offset:length}</code> のように、文字数指定で部分除去するのも便利ですが、「 <strong>特定の記号まで除去</strong> 」みたいなこともできたら便利ですね。<br>
そう、展開だけでできてしまうんです。便利。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">前方一致除去(最短一致)</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value

<span class="c1"># パターンに一致する部分が除去される</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">#hoge-</span><span class="si">}</span>
value

<span class="c1"># * で任意のパターンにマッチする</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">#*-</span><span class="si">}</span>
value
</pre></div>
</div>

<p>他の方法でやるなら <code>sed</code> でしょうか。条件の複雑さにもよりますが、この展開でなんとかなるパターンも多いかと思います。</p>

<h2>
<span id="parameterword-前方一致除去最長一致" class="fragment"></span><a href="#parameterword-%E5%89%8D%E6%96%B9%E4%B8%80%E8%87%B4%E9%99%A4%E5%8E%BB%E6%9C%80%E9%95%B7%E4%B8%80%E8%87%B4"><i class="fa fa-link"></i></a><strong>${parameter##word}: 前方一致除去(最長一致)</strong>
</h2>

<p>最短一致があれば当然最長一致もあります。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">前方一致除去(最長一致)</span></div>
<div class="highlight"><pre><span></span><span class="c1"># ちょっと長くしてみる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-hoge-value

<span class="c1"># 最短一致だとこうなる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">#*hoge-</span><span class="si">}</span>
hoge-value

<span class="c1"># 最長一致だとこうなる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">##*hoge-</span><span class="si">}</span>
value
</pre></div>
</div>

<h2>
<span id="parameterword-後方一致除去最短一致" class="fragment"></span><a href="#parameterword-%E5%BE%8C%E6%96%B9%E4%B8%80%E8%87%B4%E9%99%A4%E5%8E%BB%E6%9C%80%E7%9F%AD%E4%B8%80%E8%87%B4"><i class="fa fa-link"></i></a><strong>${parameter%word}: 後方一致除去(最短一致)</strong>
</h2>

<p>前方一致があれば後方一致もある。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">後方一致除去(最短一致)</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value

<span class="c1"># 後方が除去される</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">%-value</span><span class="si">}</span>
hoge
</pre></div>
</div>

<h2>
<span id="parameterword-後方一致除去最長一致" class="fragment"></span><a href="#parameterword-%E5%BE%8C%E6%96%B9%E4%B8%80%E8%87%B4%E9%99%A4%E5%8E%BB%E6%9C%80%E9%95%B7%E4%B8%80%E8%87%B4"><i class="fa fa-link"></i></a><strong>${parameter%%word}: 後方一致除去(最長一致)</strong>
</h2>

<p>後方一致の最短一致があれば後方一致の最長一致もある。なんでもある。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">後方一致除去(最長一致)</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value-value

<span class="c1"># 後方が除去される</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">%-value*</span><span class="si">}</span>
hoge-value

$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">%%-value*</span><span class="si">}</span>
hoge
</pre></div>
</div>

<p>ちなみにこのシリーズは配列に対して一括に効きます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">配列に対する一致</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 配列に値を入れる</span>
$ <span class="nv">list</span><span class="o">=(</span><span class="s2">"hoge-value"</span> <span class="s2">"fuga-value"</span><span class="o">)</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">list</span><span class="p">[@]</span><span class="si">}</span>
hoge-value fuga-value

<span class="c1"># 後方一致</span>
ubuntu@ubuntu16:~$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">list</span><span class="p">[@]%-value</span><span class="si">}</span>
hoge fuga

<span class="c1"># 前方一致</span>
ubuntu@ubuntu16:~$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">list</span><span class="p">[@]#hoge-</span><span class="si">}</span>
value fuga-value
</pre></div>
</div>

<p>連想配列の場合は、バリューには効くけどキーには効かないという絶妙な感じでした。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">効くor効かない</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 連想配列のキーとバリュー</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="p">!hash[@]</span><span class="si">}</span>
fuga hoge
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hash</span><span class="p">[@]</span><span class="si">}</span>
fuga-value hoge-value

<span class="c1"># バリューに対して前方一致</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hash</span><span class="p">[@]#ho</span><span class="si">}</span>
fuga-value ge-value

<span class="c1"># キーに対して前方一致</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="p">!hash[@]#ho</span><span class="si">}</span>

</pre></div>
</div>

<h2>
<span id="parameterpatternstring-文字列置換" class="fragment"></span><a href="#parameterpatternstring-%E6%96%87%E5%AD%97%E5%88%97%E7%BD%AE%E6%8F%9B"><i class="fa fa-link"></i></a><strong>${parameter/pattern/string}: 文字列置換</strong>
</h2>

<p><strong>文字列置換</strong> もできちゃいます。 <code>tr</code> とかやってる場合じゃない。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">文字列置換</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value

<span class="c1"># valueをfugaに置換する</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">/value/fuga</span><span class="si">}</span>
hoge-fuga

<span class="c1"># 置換文字列を省くと空白置換扱い(削除)になる</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">/value</span><span class="si">}</span>
hoge-

<span class="c1"># 配列とか連想配列のバリューにも効く</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hash</span><span class="p">[@]/hoge/fuga</span><span class="si">}</span>
fuga-value fuga-value
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">list</span><span class="p">[@]/hoge/fuga</span><span class="si">}</span>
fuga-value fuga-value
</pre></div>
</div>

<p>あとは <code>#</code> とか <code>%</code> を使うと置換パターンの位置を制限できます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">置換パターンの制限</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value

<span class="c1"># 先頭からのマッチ</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">/#hoge/***</span><span class="si">}</span>
***-value

<span class="c1"># 先頭じゃないからマッチしない</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">/#value/***</span><span class="si">}</span>
hoge-value

<span class="c1"># 末尾なのでマッチする</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">/%value/***</span><span class="si">}</span>
hoge-***
</pre></div>
</div>

<h2>
<span id="parameterpattern-大文字化" class="fragment"></span><a href="#parameterpattern-%E5%A4%A7%E6%96%87%E5%AD%97%E5%8C%96"><i class="fa fa-link"></i></a><strong>${parameter^pattern}: 大文字化</strong>
</h2>

<p>小文字の大文字化だってできます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">大文字化</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span>
hoge-value

$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">^</span><span class="si">}</span>
Hoge-value
</pre></div>
</div>

<p><code>^^</code> にすると全部大文字になります。決して読み手を煽っているわけではありません^^</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">全大文字化</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="p">^^</span><span class="si">}</span>
HOGE-VALUE

<span class="c1"># 他の方法だとこんな感じ</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">hoge</span><span class="si">}</span> <span class="p">|</span> tr <span class="o">[</span>:lower:<span class="o">]</span> <span class="o">[</span>:upper:<span class="o">]</span>
HOGE-VALUE
</pre></div>
</div>

<h2>
<span id="parameterpattern-小文字化" class="fragment"></span><a href="#parameterpattern-%E5%B0%8F%E6%96%87%E5%AD%97%E5%8C%96"><i class="fa fa-link"></i></a><strong>${parameter,pattern}: 小文字化</strong>
</h2>

<p>大文字にできるんなら当然小文字にもできます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">小文字化</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">HOGE</span><span class="si">}</span>
HOGE-VALUE

<span class="c1"># 先頭を小文字化</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">HOGE</span><span class="p">,</span><span class="si">}</span>
hOGE-VALUE

<span class="c1"># 全てを小文字化</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">HOGE</span><span class="p">,,</span><span class="si">}</span>
hoge-value
</pre></div>
</div>

<h2>
<span id="parameterpattern-大小文字反転" class="fragment"></span><a href="#parameterpattern-%E5%A4%A7%E5%B0%8F%E6%96%87%E5%AD%97%E5%8F%8D%E8%BB%A2"><i class="fa fa-link"></i></a><strong>${parameter~pattern}: 大小文字反転</strong>
</h2>

<p>さらに大小文字の反転までできます。なぜかマニュアルには記述が見当たらない...。<br>
便利...？</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">大小文字反転</span></div>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">Hoge</span><span class="si">}</span>
Hoge-Value

<span class="c1"># 先頭を反転</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">Hoge</span><span class="p">~</span><span class="si">}</span>
hoge-Value

<span class="c1"># 全てを反転</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">Hoge</span><span class="p">~~</span><span class="si">}</span>
hOGE-vALUE
</pre></div>
</div>

<p>よくわからない。</p>

<h1>
<span id="さいごに" class="fragment"></span><a href="#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB"><i class="fa fa-link"></i></a><strong>さいごに</strong>
</h1>

<p>奥深い変数展開の世界を味わってしまいました。<br>
今日学んだことをふんだんに使ってワンライナーをひとつ。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">頭文字別定義済みシェル変数一覧</span></div>
<div class="highlight"><pre><span></span><span class="k">for</span> char in <span class="o">{</span>A..Z<span class="o">}</span> <span class="p">;</span> <span class="k">do</span> <span class="nv">vars</span><span class="o">=(</span><span class="k">$(</span><span class="nb">eval</span> <span class="nb">echo</span> <span class="se">\$\{\!</span><span class="si">${</span><span class="nv">char</span><span class="si">}</span>*<span class="se">\}</span><span class="k">)</span><span class="o">)</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="si">${</span><span class="nv">char</span><span class="si">}</span><span class="s2">: (</span><span class="si">${#</span><span class="nv">vars</span><span class="p">[*]</span><span class="si">}</span><span class="s2">) </span><span class="si">${</span><span class="nv">vars</span><span class="p">[*]</span><span class="si">}</span><span class="s2">"</span> <span class="p">;</span> <span class="k">done</span>
A: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
B: <span class="o">(</span><span class="m">15</span><span class="o">)</span> BASH BASHOPTS BASHPID BASH_ALIASES BASH_ARGC BASH_ARGV BASH_CMDS BASH_COMMAND BASH_COMPLETION_COMPAT_DIR BASH_LINENO BASH_REMATCH BASH_SOURCE BASH_SUBSHELL BASH_VERSINFO BASH_VERSION
C: <span class="o">(</span><span class="m">2</span><span class="o">)</span> COLUMNS COMP_WORDBREAKS
D: <span class="o">(</span><span class="m">1</span><span class="o">)</span> DIRSTACK
E: <span class="o">(</span><span class="m">1</span><span class="o">)</span> EUID
F: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
G: <span class="o">(</span><span class="m">1</span><span class="o">)</span> GROUPS
H: <span class="o">(</span><span class="m">8</span><span class="o">)</span> HISTCMD HISTCONTROL HISTFILE HISTFILESIZE HISTSIZE HOME HOSTNAME HOSTTYPE
I: <span class="o">(</span><span class="m">1</span><span class="o">)</span> IFS
J: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
K: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
L: <span class="o">(</span><span class="m">7</span><span class="o">)</span> LANG LESSCLOSE LESSOPEN LINENO LINES LOGNAME LS_COLORS
M: <span class="o">(</span><span class="m">3</span><span class="o">)</span> MACHTYPE MAIL MAILCHECK
N: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
O: <span class="o">(</span><span class="m">3</span><span class="o">)</span> OPTERR OPTIND OSTYPE
P: <span class="o">(</span><span class="m">7</span><span class="o">)</span> PATH PIPESTATUS PPID PS1 PS2 PS4 PWD
Q: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
R: <span class="o">(</span><span class="m">1</span><span class="o">)</span> RANDOM
S: <span class="o">(</span><span class="m">7</span><span class="o">)</span> SECONDS SHELL SHELLOPTS SHLVL SSH_CLIENT SSH_CONNECTION SSH_TTY
T: <span class="o">(</span><span class="m">1</span><span class="o">)</span> TERM
U: <span class="o">(</span><span class="m">2</span><span class="o">)</span> UID USER
V: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
W: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
X: <span class="o">(</span><span class="m">2</span><span class="o">)</span> XDG_RUNTIME_DIR XDG_SESSION_ID
Y: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
Z: <span class="o">(</span><span class="m">0</span><span class="o">)</span>
</pre></div>
</div>

<p>うーん、奥深い。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>t_nakayama0714さんの<br />3位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>37</kbd>
		<a target="_blank" href="https://qiita.com/t_nakayama0714/items/01a74172223eba2e04be">【シェル芸人への道】grepを訪ねて</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-01 08:51:44</center>
	</td>
	<td style="width:200px;">
		@t_nakayama0714<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/45253/profile-images/1473690211">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[grep]</b> <b>[シェル]</b> <b>[シェル芸]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="そのコマンドgrep" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89grep"><i class="fa fa-link"></i></a><strong>そのコマンド、grep</strong>
</h1>

<p>Linuxのお勉強、CUIの使い方を勉強する際、かなり初期に出てくるであろう <code>grep</code> 。<br>
私は <code>ls</code>, <code>cd</code> に次いで3番目のコマンドとして <code>grep</code> を学んだ記憶があります。</p>

<p>日頃からお世話になっている <code>grep</code> ですが、今日は改めてこのコマンドの奥深さを学んでみたいと思います。<br>
環境はUbuntu 16.04にくっついてた <code>GNU grep 2.25</code> です。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">バージョン</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# cat /etc/lsb-release
<span class="nv">DISTRIB_ID</span><span class="o">=</span>Ubuntu
<span class="nv">DISTRIB_RELEASE</span><span class="o">=</span><span class="m">16</span>.04
<span class="nv">DISTRIB_CODENAME</span><span class="o">=</span>xenial
<span class="nv">DISTRIB_DESCRIPTION</span><span class="o">=</span><span class="s2">"Ubuntu 16.04.2 LTS"</span>

root@ubuntu16:~# grep --version
grep <span class="o">(</span>GNU grep<span class="o">)</span> <span class="m">2</span>.25
Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2016</span> Free Software Foundation, Inc.
License GPLv3+: GNU GPL version <span class="m">3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Written by Mike Haertel and others, see &lt;http://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS&gt;.
</pre></div>
</div>

<h1>
<span id="grepとは" class="fragment"></span><a href="#grep%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a><strong>grepとは</strong>
</h1>

<p>さて、まずは <code>grep</code> とは一体何かを改めて調べてみます。<br>
Wikipediaによれば、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>grep 【名詞】
UNIXおよびUnixオペレーティングシステムにおけるコマンド。テキストファイル中から、正規表現に一致する行を検索して出力する。
</pre></div></div>

<p>と、まぁそうだよねというようなことが書いてありますが、その少し後に</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>grep の名の由来は、ラインエディタedのコマンド g/re/p であり、その意味するところは「ファイル全体から/正規表現に一致する行を/表示する」である。
</pre></div></div>

<p>ということが書いてあります。<br>
「ググる」と同じように「 <code>grep</code> する」なんて言葉が普通に通じてしまいますが、元々の由来はこういうことだったようです。<br>
UNIX界隈では置換などの際に <code>g (global)</code> やら <code>p (print)</code> やら、また一緒に正規表現 <code>re(regular expression)</code> を使ったりしますが、その所作をまさしく表したコマンド名と言えます。<br>
たいへん理にかなったコマンド名ですね。</p>

<h1>
<span id="grepの一族" class="fragment"></span><a href="#grep%E3%81%AE%E4%B8%80%E6%97%8F"><i class="fa fa-link"></i></a><strong>grepの一族</strong>
</h1>

<p>さて、人間生きていると <code>grep</code> そのものの他に <code>egrep</code> やら <code>fgrep</code> など、よく似た名前のコマンドを見たり、聞いたりすることがあります。<br>
一体どんなものがあるのでしょうか。調べてみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# <span class="nb">compgen</span> -c <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> grep <span class="s1">'grep'</span>
bzegrep
bzfgrep
bzgrep
egrep
fgrep
grep
lzegrep
lzfgrep
lzgrep
pgrep
ptargrep
rgrep
xzegrep
xzfgrep
xzgrep
zegrep
zfgrep
zgrep

root@ubuntu16:~# <span class="nb">compgen</span> -c <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> grep <span class="s1">'grep'</span> <span class="p">|</span> wc -l
<span class="m">18</span>
</pre></div></div>

<p>なんということでしょう、18個も <code>grep</code> を名乗るコマンドがあるではありませんか。<br>
しかし大変なのはそこではありません。</p>

<p>「 <strong><code>grep</code></strong> を調べるために <strong><code>grep</code></strong> を使ってしまっている」</p>

<p>そう、これです。なんて罪深いのでしょう。<br>
シェル芸人たるもの別解を探さねばなりません。やってみましょう。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">awkでgrep(awkrep)</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# <span class="nb">compgen</span> -c <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> awk <span class="s1">'/grep/{print}'</span> <span class="p">|</span> wc -l
<span class="m">18</span>
</pre></div>
</div>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">sedでgrep(sedrep)</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# <span class="nb">compgen</span> -c <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> sed -n <span class="s1">'/grep/p'</span> <span class="p">|</span> wc -l
<span class="m">18</span>
</pre></div>
</div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>:powerでgrep<span class="o">(</span>powerep<span class="o">)</span>
root@ubuntu16:~# <span class="nb">compgen</span> -c <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> LINE <span class="p">;</span> <span class="k">do</span> <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="si">${</span><span class="nv">LINE</span><span class="si">}</span><span class="s2">"</span> <span class="o">=</span>~ grep <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span> <span class="nb">echo</span> <span class="si">${</span><span class="nv">LINE</span><span class="si">}</span> <span class="p">;</span> <span class="k">fi</span> <span class="p">;</span> <span class="k">done</span> <span class="p">|</span> wc -l
<span class="m">18</span>
</pre></div></div>

<p>とりあえず3つあれば大丈夫(根拠不明)でしょう...。</p>

<h2>
<span id="一族を並べてみる" class="fragment"></span><a href="#%E4%B8%80%E6%97%8F%E3%82%92%E4%B8%A6%E3%81%B9%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a><strong>一族を並べてみる</strong>
</h2>

<p>いっぱいあるので並べかえてみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# <span class="nb">compgen</span> -c <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> grep <span class="s1">'grep'</span>
bzegrep
bzfgrep
bzgrep
egrep
fgrep
grep
lzegrep
lzfgrep
lzgrep
pgrep
ptargrep
rgrep
xzegrep
xzfgrep
xzgrep
zegrep
zfgrep
zgrep
</pre></div></div>

<p>たしかに並んではいるのですが、文字数が色々なのでイマイチよくわかりません。<br>
ですので、「文字数」を「辞書式」に優先して並べてみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# <span class="k">for</span> CMD in <span class="k">$(</span><span class="nb">compgen</span> -c <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> grep <span class="s1">'grep'</span><span class="k">)</span> <span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="si">${#</span><span class="nv">CMD</span><span class="si">}</span>: <span class="si">${</span><span class="nv">CMD</span><span class="si">}</span> <span class="p">;</span> <span class="k">done</span> <span class="p">|</span> sort
<span class="m">4</span>: grep
<span class="m">5</span>: egrep
<span class="m">5</span>: fgrep
<span class="m">5</span>: pgrep
<span class="m">5</span>: rgrep
<span class="m">5</span>: zgrep
<span class="m">6</span>: bzgrep
<span class="m">6</span>: lzgrep
<span class="m">6</span>: xzgrep
<span class="m">6</span>: zegrep
<span class="m">6</span>: zfgrep
<span class="m">7</span>: bzegrep
<span class="m">7</span>: bzfgrep
<span class="m">7</span>: lzegrep
<span class="m">7</span>: lzfgrep
<span class="m">7</span>: xzegrep
<span class="m">7</span>: xzfgrep
<span class="m">8</span>: ptargrep
</pre></div></div>

<p><code>${#変数名}</code> で変数に入っている <strong>文字数のカウント</strong> ができる。たいへんに便利ですね。</p>

<h3>
<span id="基本形" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E5%BD%A2"><i class="fa fa-link"></i></a><strong>基本形</strong>
</h3>

<p>さて、こいつらをよく見てみると基本的には「 <strong>○○のgrep</strong> 」みたいなネーミングになっています。<br>
まずは基本となる <code>grep</code> に一文字を加えたものを見てみましょう。</p>

<table>
<thead>
<tr>
<th style="text-align: right">コマンド名</th>
<th style="text-align: left">由来</th>
<th style="text-align: left">意味</th>
<th style="text-align: center">grepでの相当オプション</th>
<th style="text-align: left">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">grep</td>
<td style="text-align: left">-</td>
<td style="text-align: left">grep</td>
<td style="text-align: center">-</td>
<td style="text-align: left">基本形。</td>
</tr>
<tr>
<td style="text-align: right">egrep</td>
<td style="text-align: left">
<strong>e</strong>xtended-regexp <strong>grep</strong>
</td>
<td style="text-align: left">拡張正規表現に対応したgrep</td>
<td style="text-align: center">-E</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">fgrep</td>
<td style="text-align: left">
<strong>f</strong>ixed-strings <strong>grep</strong>
</td>
<td style="text-align: left">固定文字列のみに対応したgrep</td>
<td style="text-align: center">-F</td>
<td style="text-align: left">faster grepかと思っていた時期が私にもありました。</td>
</tr>
<tr>
<td style="text-align: right">pgrep</td>
<td style="text-align: left">
<strong>p</strong>rocess <strong>grep</strong>
</td>
<td style="text-align: left">プロセス一覧に対するgrep</td>
<td style="text-align: center">-</td>
<td style="text-align: left">
<code>grep -P</code> と同じだと思った？別物だよ。</td>
</tr>
<tr>
<td style="text-align: right">rgrep</td>
<td style="text-align: left">
<strong>r</strong>ecursive <strong>grep</strong>
</td>
<td style="text-align: left">再帰的なgrep</td>
<td style="text-align: center">-r</td>
<td style="text-align: left">
<code>grep -R</code> はまたちょっと違う。</td>
</tr>
</tbody>
</table>

<h3>
<span id="派生形" class="fragment"></span><a href="#%E6%B4%BE%E7%94%9F%E5%BD%A2"><i class="fa fa-link"></i></a><strong>派生形</strong>
</h3>

<p>上記のもの、特に <code>grep</code>, <code>egrep</code>, <code>fgrep</code> の派生形となっているのが以下です。<br>
基本的には圧縮ファイルのままにgrepできるというものですね。</p>

<table>
<thead>
<tr>
<th style="text-align: right">接頭辞</th>
<th style="text-align: left">由来</th>
<th style="text-align: left">意味</th>
<th style="text-align: center">対象</th>
<th style="text-align: left">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">z</td>
<td style="text-align: left">g<strong>z</strong>ip</td>
<td style="text-align: left">gzip圧縮ファイルに対するgrep</td>
<td style="text-align: center">zgrep, zegrep, zfgrep</td>
<td style="text-align: left">
<code>grep -z</code> はまた別物。ごくまれに使う。</td>
</tr>
<tr>
<td style="text-align: right">bz</td>
<td style="text-align: left">
<strong>bz</strong>ip2</td>
<td style="text-align: left">bzip2圧縮ファイルに対するgrep</td>
<td style="text-align: center">bzgrep, bzegrep, bzfgrep</td>
<td style="text-align: left">使ったことがない。</td>
</tr>
<tr>
<td style="text-align: right">lz</td>
<td style="text-align: left">
<strong>lz</strong>ma</td>
<td style="text-align: left">lzma圧縮ファイルに対するgrep</td>
<td style="text-align: center">lzgrep, lzegrep, lzfgrep</td>
<td style="text-align: left">使ったことがない。</td>
</tr>
<tr>
<td style="text-align: right">xz</td>
<td style="text-align: left"><strong>xz</strong></td>
<td style="text-align: left">xz圧縮ファイルに対するgrep</td>
<td style="text-align: center">xzgrep, xzegrep, xzfgrep</td>
<td style="text-align: left">使ったことがない。</td>
</tr>
<tr>
<td style="text-align: right">ptar</td>
<td style="text-align: left">
<strong>p</strong>erl-regexp <strong>tar</strong>
</td>
<td style="text-align: left">tar圧縮ファイルに対するperl正規表現でのgrep</td>
<td style="text-align: center">ptargrep</td>
<td style="text-align: left">
<code>pgrep</code> は他人です。</td>
</tr>
</tbody>
</table>

<h1>
<span id="実践grep" class="fragment"></span><a href="#%E5%AE%9F%E8%B7%B5grep"><i class="fa fa-link"></i></a><strong>実践grep</strong>
</h1>

<p>それでは実践です。<br>
実践にあたっては適当なテキストファイル、そう、教材が必要です。<br>
以下のサイトに敬礼しつつ、日本語と英語で好きな教材を探しましょう。</p>

<ul>
<li>
<strong><a href="http://www.aozora.gr.jp/" rel="nofollow noopener" target="_blank">青空文庫</a></strong>

<ul>
<li>1997年設立の電子図書館</li>
<li>運営は <strong><a href="http://www.aozora.gr.jp/aozora_bunkono_shikumi.html" rel="nofollow noopener" target="_blank">ボランティア</a></strong> であり、 <strong><a href="http://aozorahack.org/" rel="nofollow noopener" target="_blank">aozorahack</a></strong> というサーバ運用改善活動もある

<ul>
<li><strong><a href="https://www.slideshare.net/takahashim/aozorahack-hackathon-1" rel="nofollow noopener" target="_blank">aozorahackのこれまでとサーバ移転について</a></strong></li>
</ul>
</li>
</ul>
</li>
<li>
<strong><a href="http://www.gutenberg.org/" rel="nofollow noopener" target="_blank">Project Gutenberg</a></strong>

<ul>
<li>1971年設立の電子図書館</li>
</ul>
</li>
</ul>

<h2>
<span id="教材の準備" class="fragment"></span><a href="#%E6%95%99%E6%9D%90%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a><strong>教材の準備</strong>
</h2>

<p>今回は「 <strong><a href="http://www.aozora.gr.jp/cards/000148/card773.html" rel="nofollow noopener" target="_blank">こころ(夏目漱石)</a></strong> 」と「 <strong><a href="http://www.gutenberg.org/ebooks/35688" rel="nofollow noopener" target="_blank">不思議の国のアリス(ルイス・キャロル)</a></strong> 」を教材に選んでみます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# curl -s -o kokoro.zip http://www.aozora.gr.jp/cards/000148/files/773_ruby_5968.zip
root@ubuntu16:~# curl -s -o alice.zip http://www.gutenberg.org/files/35688/35688.zip
root@ubuntu16:~# ls -lh
total 196K
-rw-r--r--  <span class="m">1</span> root root  39K Jul  <span class="m">9</span> <span class="m">16</span>:00 alice.zip
-rw-r--r--  <span class="m">1</span> root root 151K Jul  <span class="m">9</span> <span class="m">15</span>:59 kokoro.zip
</pre></div></div>

<p>それでは解凍しましょう。 <code>unzip</code> がなかったら <code>apt-get install unzip</code> でもしてください。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# unzip kokoro.zip
Archive:  kokoro.zip
Made with MacWinZipper?
  inflating: kokoro.txt

root@ubuntu16:~# unzip alice.zip
Archive:  alice.zip
  inflating: <span class="m">35688</span>.txt

<span class="c1"># ファイル名を変えておく</span>
root@ubuntu16:~# mv <span class="m">35688</span>.txt alice.txt
</pre></div></div>

<p>この時点でこころのファイルに一抹の不安が頭をよぎります。<br>
おそるおそるファイルの中身を確認してみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# head kokoro.txt
ｱｱ・
        ??

-------------------------------------------------------
yeLXg?ｻ・
??｢ﾄz    L

stF
   r
i疔s?ｭｵtﾍ

bF
  r?tｭｶn?頏R?・
                L

root@ubuntu16:~# head alice.txt
The Project Gutenberg EBook of Alice in Wonderland, by Alice Gerstenberg

This eBook is <span class="k">for</span> the use of anyone anywhere at no cost and with
almost no restrictions whatsoever.  You may copy it, give it away or
re-use it under the terms of the Project Gutenberg License included
with this eBook or online at www.gutenberg.net


Title: Alice in Wonderland
       A Dramatization of Lewis Carroll<span class="s1">'s "Alice'</span>s Adventures in
</pre></div></div>

<p>ふぅ、奴が出たようですね。念のため確認してみましょう。たすけて <code>nkf</code> えもん。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# apt-get install nkf

root@ubuntu16:~# nkf -g kokoro.txt
Shift_JIS
</pre></div></div>

<p>予想通りですね。彼には生まれ変わってもらいましょう。<br>
<code>nkf -w</code> で <strong>w</strong>orld-wide なUTF-8への変換ができます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# nkf -w --overwrite kokoro.txt

root@ubuntu16:~# head kokoro.txt
こころ
夏目漱石

-------------------------------------------------------
【テキスト中に現れる記号について】

《》：ルビ
（例）私《わたくし》は

｜：ルビの付く文字列の始まりを特定する記号

root@ubuntu16:~# nkf -g kokoro.txt
UTF-8
</pre></div></div>

<p>これで教材の準備が整いました。<br>
あとは順にオプションを調べていってみましょう。</p>

<p>どれくらいくらいあるのかというと...</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep --help <span class="p">|</span> head
Usage: grep <span class="o">[</span>OPTION<span class="o">]</span>... PATTERN <span class="o">[</span>FILE<span class="o">]</span>...
Search <span class="k">for</span> PATTERN in each FILE or standard input.
PATTERN is, by default, a basic regular expression <span class="o">(</span>BRE<span class="o">)</span>.
Example: grep -i <span class="s1">'hello world'</span> menu.h main.c

Regexp selection and interpretation:
  -E, --extended-regexp     PATTERN is an extended regular expression <span class="o">(</span>ERE<span class="o">)</span>
  -F, --fixed-strings       PATTERN is a <span class="nb">set</span> of newline-separated strings
  -G, --basic-regexp        PATTERN is a basic regular expression <span class="o">(</span>BRE<span class="o">)</span>
  -P, --perl-regexp         PATTERN is a Perl regular expression

root@ubuntu16:~# grep --help <span class="p">|</span> grep -E <span class="s2">"^ +-[a-Z][, ]"</span> <span class="p">|</span> wc -l
<span class="m">36</span>
</pre></div></div>

<p>中々手強いですね。まずは不思議の国のアリスを題材に、各オプションで素直に遊んでみましょう。</p>

<h2>
<span id="普通の使い方" class="fragment"></span><a href="#%E6%99%AE%E9%80%9A%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a><strong>普通の使い方</strong>
</h2>

<p>まずはひねりもなく普通に使ってみましょう。 <code>play</code> に関連する部分をひたすら探してみます。</p>

<h3>
<span id="基本マッチ" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E3%83%9E%E3%83%83%E3%83%81"><i class="fa fa-link"></i></a><strong>基本マッチ</strong>
</h3>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">普通のgrep</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# grep <span class="s2">"play"</span> alice.txt
  Rights to produce this play in all countries of the world
The illustrations of the characters of the play in this book were drawn by
W. H. Gilmore staged the play with the following cast:
<span class="o">(</span>略<span class="o">)</span>
</pre></div>
</div>

<h3>
<span id="マッチ行番号表示-n-number" class="fragment"></span><a href="#%E3%83%9E%E3%83%83%E3%83%81%E8%A1%8C%E7%95%AA%E5%8F%B7%E8%A1%A8%E7%A4%BA-n-number"><i class="fa fa-link"></i></a><strong>マッチ行番号表示(-n, number)</strong>
</h3>

<p>それぞれ何行目に出てきているのか気になりますね。 <code>-n</code> を使ってみましょう。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">行数の表示(-n)</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n <span class="s2">"play"</span> alice.txt
<span class="m">72</span>:  Rights to produce this play in all countries of the world
<span class="m">99</span>:The illustrations of the characters of the play in this book were drawn by
<span class="m">102</span>:W. H. Gilmore staged the play with the following cast:
<span class="o">(</span>略<span class="o">)</span>
</pre></div>
</div>

<h3>
<span id="表示個数制限-m-max" class="fragment"></span><a href="#%E8%A1%A8%E7%A4%BA%E5%80%8B%E6%95%B0%E5%88%B6%E9%99%90-m-max"><i class="fa fa-link"></i></a><strong>表示個数制限(-m, max)</strong>
</h3>

<p>ちょっと数が多いので最初の5個だけを見たくなりました。 <code>-m</code> の出番です。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">表示個数の制限(-m)</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n -m <span class="m">5</span> <span class="s2">"play"</span> alice.txt
<span class="m">72</span>:  Rights to produce this play in all countries of the world
<span class="m">99</span>:The illustrations of the characters of the play in this book were drawn by
<span class="m">102</span>:W. H. Gilmore staged the play with the following cast:
<span class="m">173</span>:_ALICE<span class="err">'</span>S home. LEWIS CARROLL is discovered, playing chess. Golden-haired
<span class="m">256</span>:Why <span class="k">do</span> people always play with kings and queens? Mother has them in her
</pre></div>
</div>

<h3>
<span id="個数カウント-c-count" class="fragment"></span><a href="#%E5%80%8B%E6%95%B0%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88-c-count"><i class="fa fa-link"></i></a><strong>個数カウント(-c, count)</strong>
</h3>

<p>結局何個ヒットしているのでしょうか。 <code>-c</code> の出番です。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">個数の表示(-c)</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# grep -c <span class="s2">"play"</span> alice.txt
<span class="m">29</span>
</pre></div>
</div>

<p>先頭が大文字の "Play" はどうでしょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep -c <span class="s2">"Play"</span> alice.txt
<span class="m">1</span>
</pre></div></div>

<h3>
<span id="大小文字の無視-i-ignore" class="fragment"></span><a href="#%E5%A4%A7%E5%B0%8F%E6%96%87%E5%AD%97%E3%81%AE%E7%84%A1%E8%A6%96-i-ignore"><i class="fa fa-link"></i></a><strong>大小文字の無視(-i, ignore)</strong>
</h3>

<p>とにかく "play" 的なものをカウントしたいです。大文字小文字を無視しましょう。 <code>-i</code> の出番です。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">大小文字のマッチ(-i)</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 87行目の "Players" が一緒にヒットするようになった</span>
root@ubuntu16:~# grep -n -i <span class="s2">"play"</span> alice.txt
<span class="m">72</span>:  Rights to produce this play in all countries of the world
<span class="m">87</span>:Chicago, was produced by The Players Producing Company of Chicago <span class="o">(</span>Aline
<span class="m">99</span>:The illustrations of the characters of the play in this book were drawn by
<span class="m">102</span>:W. H. Gilmore staged the play with the following cast:

root@ubuntu16:~# grep -c -i <span class="s2">"play"</span> alice.txt
<span class="m">30</span>
</pre></div>
</div>

<h3>
<span id="単語マッチ-w-word" class="fragment"></span><a href="#%E5%8D%98%E8%AA%9E%E3%83%9E%E3%83%83%E3%83%81-w-word"><i class="fa fa-link"></i></a><strong>単語マッチ(-w, word)</strong>
</h3>

<p>よく見ると「 dis <strong>play</strong> 」なんてのもヒットしているようです。純粋な "play" をカウントしたいので <code>-w</code> の出番です。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">単語単位でのマッチ(-w)</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n -i -w <span class="s2">"play"</span> alice.txt
<span class="m">72</span>:  Rights to produce this play in all countries of the world
<span class="m">99</span>:The illustrations of the characters of the play in this book were drawn by
<span class="m">102</span>:W. H. Gilmore staged the play with the following cast:

root@ubuntu16:~# grep -n -i -w -c <span class="s2">"play"</span> alice.txt
<span class="m">12</span>
</pre></div>
</div>

<h3>
<span id="除外-v-invert" class="fragment"></span><a href="#%E9%99%A4%E5%A4%96-v-invert"><i class="fa fa-link"></i></a><strong>除外(-v, invert)</strong>
</h3>

<p>結構減りました。ヒットしなくなった18行を探しましょう。 <code>-v</code> の出番です。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">除外(-v)</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# grep -i -w -v <span class="s2">"play"</span> alice.txt <span class="p">|</span> grep -i <span class="s2">"play"</span>
Chicago, was produced by The Players Producing Company of Chicago <span class="o">(</span>Aline
_ALICE<span class="s1">'S home. LEWIS CARROLL is discovered, playing chess. Golden-haired</span>
<span class="s1">playing cards too. Look!</span>
<span class="s1">[_ALICE goes to the mantel and takes a pack of playing cards from the</span>
<span class="s1">You'</span>re playing against yourself, aren<span class="err">'</span>t you?
<span class="o">(</span>略<span class="o">)</span>

root@ubuntu16:~# grep -i -w -v <span class="s2">"play"</span> alice.txt <span class="p">|</span> grep -c -i <span class="s2">"play"</span>
<span class="m">18</span>
</pre></div>
</div>

<h2>
<span id="日本語でgrep" class="fragment"></span><a href="#%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%81%A7grep"><i class="fa fa-link"></i></a><strong>日本語でgrep</strong>
</h2>

<p>さて、続いては日本語の「こころ」を使ってgrepの練習をしてみましょう。<br>
ふしぎの国のアリスではそのままやっていましたが、本文のほかにヘッダーとフッターがついているのでファイルを少し加工してみます。</p>

<h3>
<span id="前準備" class="fragment"></span><a href="#%E5%89%8D%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a><strong>前準備</strong>
</h3>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">ヘッダー</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# cat -n kokoro.txt <span class="p">|</span> head -n <span class="m">30</span>
     <span class="m">1</span>  こころ
     <span class="m">2</span>  夏目漱石
     <span class="m">3</span>
     <span class="m">4</span>  -------------------------------------------------------
     <span class="m">5</span>  【テキスト中に現れる記号について】
<span class="o">(</span>略<span class="o">)</span>
    <span class="m">23</span>  　私《わたくし》はその人を常に先生と呼んでいた。だからここでもただ先生と書くだけで本名は打ち明けない。これは世間を憚《はば》かる遠慮というよりも、その方が私にとって自然だからである。私はその人の記憶を呼び起すごとに、すぐ「先生」といいたくなる。筆を執《と》っても心持は同じ事である。よそよそしい頭文字《かしらもじ》などはとても使う気にならない。
<span class="o">(</span>略<span class="o">)</span>
</pre></div>
</div>

<p>このように、ヘッダがあるため本文は23行目から始まっているようです。<br>
一方でフッターはどうでしょう。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">フッター</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# cat -n kokoro.txt <span class="p">|</span> tail -n <span class="m">20</span>
<span class="o">(</span>略<span class="o">)</span>
  <span class="m">1579</span>  　私は私の過去を善悪ともに他《ひと》の参考に供するつもりです。しかし妻だけはたった一人の例外だと承知して下さい。私は妻には何にも知らせたくないのです。妻が己《おの》れの過去に対してもつ記憶を、なるべく純白に保存しておいてやりたいのが私の唯一《ゆいいつ》の希望なのですから、私が死んだ後《あと》でも、妻が生きている以上は、あなた限りに打ち明けられた私の秘密として、すべてを腹の中にしまっておいて下さい。」
<span class="o">(</span>略<span class="o">)</span>
  <span class="m">1594</span>  青空文庫作成ファイル：
  <span class="m">1595</span>  このファイルは、インターネットの図書館、青空文庫（http://www.aozora.gr.jp/）で作られました。入力、校正、制作にあたったのは、ボランティアの皆さんです。
</pre></div>
</div>

<p>本文の終わりは1579行のようですね。それではこの範囲を抜き出してみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# sed -n <span class="m">23</span>,1579p kokoro.txt &gt; kokoro_main.txt
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# head -n <span class="m">1</span> kokoro_main.txt <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"#####"</span> <span class="p">;</span> tail -n <span class="m">1</span> kokoro_main.txt
　私《わたくし》はその人を常に先生と呼んでいた。だからここでもただ先生と書くだけで本名は打ち明けない。これは世間を憚《はば》かる遠慮というよりも、その方が私にとって自然だからである。私はその人の記憶を呼び起すごとに、すぐ「先生」といいたくなる。筆を執《と》っても心持は同じ事である。よそよそしい頭文字《かしらもじ》などはとても使う気にならない。
<span class="c1">#####</span>
　私は私の過去を善悪ともに他《ひと》の参考に供するつもりです。しかし妻だけはたった一人の例外だと承知して下さい。私は妻には何にも知らせたくないのです。妻が己《おの》れの過去に対してもつ記憶を、なるべく純白に保存しておいてやりたいのが私の唯一《ゆいいつ》の希望なのですから、私が死んだ後《あと》でも、妻が生きている以上は、あなた限りに打ち明けられた私の秘密として、すべてを腹の中にしまっておいて下さい。」
</pre></div></div>

<p>よさそうですね。<br>
あともうひとつ、読む文には大変助かるのですが《》で書かれているルビを除去しましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# sed <span class="s1">'s/《.*》//g'</span> kokoro_main.txt <span class="p">|</span> head
　私などはとても使う気にならない。
　私が先生と知り合いになったのは鎌倉より帰るべきはずであった。それで彼はとうとう帰る事になった。せっかく来た私は一人取り残された。
　学校の授業が始まるにはまだ大分な宿を探す面倒ももたなかったのである。
　宿は鎌倉でも辺鄙を一つ越さなければ手が届かなかった。車で行っても二十銭は取られた。けれども個人の別荘はそこここにいくつでも建てられていた。それに海へはごく近いので海水浴をやるには至極便利な地位を占めていた。
　私は毎日海へはいりに出掛けた。古い燻るのは愉快であった。
　私は実に先生をこの雑沓てる事にしていた。

［＃５字下げ］二［＃「二」は中見出し］

　私れていたからである。
</pre></div></div>

<p>んんん？どうもおかしいですね。<br>
よく見てみると以下のような除去が起こっているようです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>　私《わたくし》はその人を常に先生と呼んでいた。だからここでもただ先生と書くだけで本名は打ち明けない。これは世間を憚《はば》かる遠慮というよりも、その方が私にとって自然だからである。私はその人の記憶を呼び起すごとに、すぐ「先生」といいたくなる。筆を執《と》っても心持は同じ事である。よそよそしい頭文字《かしらもじ》などはとても使う気にならない。

　↓

　私などはとても使う気にならない。
</pre></div></div>

<p>確かにsedでは「《～》までを除去する」と指定したものの、ちょっと意図とはずれてしまいました。<br>
このようにマッチしすぎることがあるので、 <strong>最長一致</strong> には注意しておきましょう。</p>

<p>気を取り直して、以下のようにすれば最長一致に惑わされることなく、望みの除去を行うことができます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# cat kokoro_main.txt <span class="p">|</span> sed <span class="s1">'s/《[^》]*》//g'</span> <span class="p">|</span> head
　私はその人を常に先生と呼んでいた。だからここでもただ先生と書くだけで本名は打ち明けない。これは世間を憚かる遠慮というよりも、その方が私にとって自然だからである。私はその人の記憶を呼び起すごとに、すぐ「先生」といいたくなる。筆を執っても心持は同じ事である。よそよそしい頭文字などはとても使う気にならない。
<span class="o">(</span>略<span class="o">)</span>
</pre></div></div>

<p>二重括弧の中について「 <strong>任意の1文字</strong> ( <code>.</code> )」でマッチングさせていたところを「 <strong>》以外</strong> ( <code>[^》]</code> )」でマッチングしているのがポイントです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# sed -n <span class="m">23</span>,1579p kokoro.txt <span class="p">|</span> sed <span class="s1">'s/《[^》]*》//g'</span> &gt; kokoro_main.txt
</pre></div></div>

<h3>
<span id="基本マッチ-1" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E3%83%9E%E3%83%83%E3%83%81-1"><i class="fa fa-link"></i></a><strong>基本マッチ</strong>
</h3>

<p>それではあの有名なフレーズを探すべく「 <strong>罪悪</strong> 」でgrepしてみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n <span class="s2">"罪悪"</span> kokoro_main.txt
<span class="m">202</span>:「聞こえました。恋の満足を味わっている人はもっと暖かい声を出すものです。しかし……しかし君、恋は罪悪ですよ。解っていますか」
<span class="o">(</span>略<span class="o">)</span>
</pre></div></div>

<p>出ました。こんなところにあったんですね。もっと後ろのイメージがありました。</p>

<h3>
<span id="前後行の表示-ba-beforeafter" class="fragment"></span><a href="#%E5%89%8D%E5%BE%8C%E8%A1%8C%E3%81%AE%E8%A1%A8%E7%A4%BA-ba-beforeafter"><i class="fa fa-link"></i></a><strong>前後行の表示(-B/A, Before/After)</strong>
</h3>

<p>ちょっと前後の文脈が気になりますね。前後3行ずつ見てみましょう。 <code>-B</code> と <code>-A</code> の出番です。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">マッチ前後を確認(-A/B)</span></div>
<div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n -B <span class="m">3</span> -A <span class="m">3</span> <span class="s2">"しかし君、恋は罪悪ですよ"</span> kokoro_main.txt
<span class="m">199</span>-「ええ」
<span class="m">200</span>-「君は今あの男と女を見て、冷評しましたね。あの冷評のうちには君が恋を求めながら相手を得られないという不快の声が交っていましょう」
<span class="m">201</span>-「そんな風に聞こえましたか」
<span class="m">202</span>:「聞こえました。恋の満足を味わっている人はもっと暖かい声を出すものです。しかし……しかし君、恋は罪悪です  。解っていますか」
<span class="m">203</span>-　私は急に驚かされた。何とも返事をしなかった。
<span class="m">204</span>-
<span class="m">205</span>-［＃５字下げ］十三［＃「十三」は中見出し］
</pre></div>
</div>

<p>残念ながらシチュエーションはさっぱりわかりませんね。そういうこともあるでしょう。(楽観的)</p>

<h3>
<span id="漢字クラス-のマッチ" class="fragment"></span><a href="#%E6%BC%A2%E5%AD%97%E3%82%AF%E3%83%A9%E3%82%B9-%E3%81%AE%E3%83%9E%E3%83%83%E3%83%81"><i class="fa fa-link"></i></a><strong>"漢字クラス" のマッチ</strong>
</h3>

<p>ついでなので「楽観的」を調べてみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n <span class="s2">"楽観的"</span> kokoro_main.txt
<span class="m">970</span>:　兄と前後して着いた妹の夫の意見は、我々よりもよほど楽観的であった。父は彼に向かって妹の事をあれこれと尋ねていた。「身体が身体だからむやみに汽車になんぞ乗って揺れない方が好い。無理をして見舞に来られたりすると、かえってこっちが心配だから」といっていた。「なに今に治ったら赤ん坊の顔でも見に、久しぶりにこっちから出掛けるから差支えない」ともいっていた。
</pre></div></div>

<p>ありますね。他に <strong>○○的</strong> はあるんでしょうか。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep -c -E <span class="s2">"..的"</span> kokoro_main.txt
<span class="m">76</span>
</pre></div></div>

<p>結構ありますね。具体的に見てみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n -m <span class="m">3</span> -E <span class="s2">"..的"</span> kokoro_main.txt
<span class="m">13</span>:　私は単に好奇心のために、並んで浜辺を下りて行く二人の後姿を見守っていた。すると彼らは真直に波の中に足を踏 み込んだ。そうして遠浅の磯近くにわいわい騒いでいる多人数の間を通り抜けて、比較的広々した所へ来ると、二人とも泳ぎ出した。彼らの頭が小さく見えるまで沖の方へ向いて行った。それから引き返してまた一直線に浜辺まで戻って来た。掛茶屋へ帰ると、井戸の水も浴びずに、すぐ身体を拭いて着物を着て、さっさとどこへか行ってしまった。
<span class="m">15</span>:　その時の私は屈托がないというよりむしろ無聊に苦しんでいた。それで翌日もまた先生に会った時刻を見計らって、 わざわざ掛茶屋まで出かけてみた。すると西洋人は来ないで先生一人｜麦藁帽を被ってやって来た。先生は眼鏡をとって台の上に置いて、すぐ手拭で頭を包んで、すたすた浜を下りて行った。先生が昨日のように騒がしい浴客の中を通り抜けて、一人で泳ぎ出した時、私は急にその後が追い掛けたくなった。私は浅い水を頭の上まで跳かして相当の深さの所まで来て、そこから先生を目標に抜手を切った。すると先生は昨日と違って、一種の弧線を描いて、妙な方向から岸の方へ帰り始めた。それで私の目的はついに達せられなかった。私が陸へ上がって雫の垂れる手を振りながら掛茶屋に入ると、先生はもうちゃんと着物を着て入れ違いに外へ出て行った。
<span class="m">19</span>:　私は次の日も同じ時刻に浜へ行って先生の顔を見た。その次の日にもまた同じ事を繰り返した。けれども物をいい掛 ける機会も、挨拶をする場合も、二人の間には起らなかった。その上先生の態度はむしろ非社交的であった。一定の時刻に超然として来て、また超然と帰って行った。周囲がいくら賑やかでも、それにはほとんど注意を払う様子が見えなかった。最初いっしょに来た西洋人はその後まるで姿を見せなかった。先生はいつでも一人であった。
</pre></div></div>

<p>これはいけません。15行のマッチを見てみると、 <strong>の目的</strong> というところでヒットしています。<br>
確かに横着してピリオドでマッチさせたのがよくなかったようです。漢字でマッチさせましょう、漢字で。</p>

<p>...はて、漢字の文字クラスなんてあったでしょうか。</p>

<ul>
<li><a href="http://d.hatena.ne.jp/seuzo/20090309/1236525090" rel="nofollow noopener" target="_blank">[InDesign][CS4][regex]正規表現の文字クラスまとめ</a></li>
<li><a href="http://tama-san.com/kanji-regex/" rel="nofollow noopener" target="_blank">Unicodeで「漢字」の正規表現</a></li>
</ul>

<p>ありました。 <strong>細かな点を抜きにすれば</strong>  <code>[一-龠]</code> を漢字の文字クラスとして使えるようです。早速使ってみます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n -E <span class="s2">"[一-龠]{2}的"</span> kokoro_main.txt <span class="p">|</span> wc -l
<span class="m">56</span>

root@ubuntu16:~# grep -n -m <span class="m">3</span> -E <span class="s2">"[一-龠]{2}的"</span> kokoro_main.txt
<span class="m">13</span>:　私は単に好奇心のために、並んで浜辺を下りて行く二人の後姿を見守っていた。すると彼らは真直に波の中に足を踏 み込んだ。そうして遠浅の磯近くにわいわい騒いでいる多人数の間を通り抜けて、比較的広々した所へ来ると、二人とも泳ぎ出した。彼らの頭が小さく見えるまで沖の方へ向いて行った。それから引き返してまた一直線に浜辺まで戻って来た。掛茶屋へ帰ると、井戸の水も浴びずに、すぐ身体を拭いて着物を着て、さっさとどこへか行ってしまった。
<span class="m">19</span>:　私は次の日も同じ時刻に浜へ行って先生の顔を見た。その次の日にもまた同じ事を繰り返した。けれども物をいい掛 ける機会も、挨拶をする場合も、二人の間には起らなかった。その上先生の態度はむしろ非社交的であった。一定の時刻に超然として来て、また超然と帰って行った。周囲がいくら賑やかでも、それにはほとんど注意を払う様子が見えなかった。最初いっしょに来た西洋人はその後まるで姿を見せなかった。先生はいつでも一人であった。
<span class="m">22</span>:　しばらくして海の中で起き上がるように姿勢を改めた先生は、「もう帰りませんか」といって私を促した。比較的強 い体質をもった私は、もっと海の中で遊んでいたかった。しかし先生から誘われた時、私はすぐ「ええ帰りましょう」と快く答えた。そうして二人でまた元の路を浜辺へ引き返した。
</pre></div></div>

<p>これで望みのマッチができました。多分。</p>

<h3>
<span id="日本語の単語マッチmecab---w" class="fragment"></span><a href="#%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%81%AE%E5%8D%98%E8%AA%9E%E3%83%9E%E3%83%83%E3%83%81mecab---w"><i class="fa fa-link"></i></a><strong>日本語の単語マッチ(mecab &amp; -w)</strong>
</h3>

<p>さて、では最後に単語単位のマッチを日本語でもやってみたいと思います。「比較」と「比較的」を区別してみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n -w <span class="s2">"比較"</span> kokoro_main.txt
<span class="o">(</span>出力なし<span class="o">)</span>
</pre></div></div>

<p>あれ？何も出ませんね。「比較」ってないんでしょうか。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# grep -n <span class="s2">"比較"</span> kokoro_main.txt
<span class="o">(</span>略<span class="o">)</span>
<span class="m">433</span>:　私は心のうちで、父と先生とを比較して見た。両方とも世間から見れば、生きているか死んでいるか分らないほど大人しい男であった。他に認められるという点からいえばどっちも零であった。それでいて、この将碁を差したがる父は、単なる娯楽の相手としても私には物足りなかった。かつて遊興のために往来をした覚えのない先生は、歓楽の交際から出る親しみ以上に、いつか私の頭に影響を与えていた。ただ頭というのはあまりに冷やか過ぎるから、私は胸といい直したい。肉のなかに先生の力が喰い込んでいるといっても、血のなかに先生の命が流れているといっても、その時の私には少しも誇張でないように思われた。私は父が私の本当の父であり、先生はまたいうまでもなく、あかの他人であるという明白な事実を、ことさらに眼の前に並べてみて、始めて大きな真理でも発見したかのごとくに驚いた。
<span class="o">(</span>略<span class="o">)</span>
</pre></div></div>

<p>ありました。ではなぜこれがマッチしなかったんでしょうか。<br>
単語単位のマッチを行う <code>-w</code> オプションでは、単語の認識をスペースで行っています。アルファベット言語だと単語の区切りにスペースが入りますから、単語認識のルールとしてはぴったりです。<br>
一方日本語ではどうでしょう。スペースは入りませんね。<br>
そのため、句点や読点を挟んだとしても、改行やスペースが入らなければ <strong>行全体が1つの単語</strong> とみなされてしまいます。<br>
grep自体は英語圏で生まれたものですから、このあたりは致し方ない部分であると言えます。</p>

<p>しかし、そうは言っても単語マッチがやりたいので頑張りましょう。<br>
日本語解析の強い味方、 <code>mecab</code> を使います。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# apt-get install mecab
</pre></div></div>

<p>インストールはこれだけです。すばらしい。試してみましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# <span class="nb">echo</span> <span class="s2">"シェル芸人"</span> <span class="p">|</span> mecab
� ﾆﾃｼ�,ｵｭｹ�,*,*,*,*,*
ｷ�  ?ｻ�,ｿﾍﾌｾ,*,*,*,*,*
ｧ罩�
ｸ ﾆﾃｼ�,ｵｭｹ�,*,*,*,*,*
莠 ?ｻ�,ｿﾍﾌｾ,*,*,*,*,*
ｺ ﾆﾃｼ�,ｵｭｹ�,*,*,*,*,*
EOS
</pre></div></div>

<p>洗礼がひどいですね。調べてみるとUTF-8用の辞書がないのがダメらしいです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# apt-get install mecab-ipadic-utf8

root@ubuntu16:~# <span class="nb">echo</span> <span class="s2">"シェル芸人"</span> <span class="p">|</span> mecab 
シェル   名詞,一般,*,*,*,*,シェル,シェル,シェル
芸人  名詞,一般,*,*,*,*,芸人,ゲイニン,ゲイニン
EOS
</pre></div></div>

<p>すばらしいですね。ではこいつをどうやって日本語の単語マッチに使うかというと <code>-O wakati</code> オプションを使います。<br>
分かち書きといって、元の行を形態素に分割した状態で出力するものです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# <span class="nb">echo</span> <span class="s2">"本日はシェル芸人なり"</span> <span class="p">|</span> mecab -O wakati
本日 は シェル 芸人 なり
</pre></div></div>

<p>こんな感じ。あとはこいつを通したあとにgrepをかけてやると...。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# mecab -O wakati kokoro_main.txt <span class="p">|</span> grep -n -m <span class="m">3</span> -w <span class="s2">"比較"</span>
<span class="m">433</span>:　 私 は 心 の うち で 、 父 と 先生 と を 比較 し て 見 た 。 両方 とも 世間 から 見れ ば 、 生き て いる か 死ん で いる か 分ら ない ほど 大人しい 男 で あっ た 。 他 に 認め られる という 点 から いえ ば どっち も 零 で あっ た 。 それでいて 、 この 将 碁 を 差し た がる 父 は 、 単なる 娯楽 の 相手 として も 私 に は 物足りなかっ た 。 かつて 遊興 の ため に 往来 を し た 覚え の ない 先生 は 、 歓楽 の 交際 から 出る 親しみ 以上 に 、 いつ か 私 の 頭 に 影響 を 与え て い た 。 ただ 頭 という の は あまりに 冷やか 過ぎる から 、 私 は 胸 と いい 直し たい 。 肉 の なか に 先生 の 力 が 喰い 込ん で いる と いっ て も 、 血 の なか に 先生 の 命 が 流れ て いる  と いっ て も 、 その 時 の 私 に は 少し も 誇張 で ない よう に 思わ れ た 。 私 は 父 が 私 の 本当 の 父 で あり 、 先生 は また いう まで も なく 、 あか の 他人 で ある という 明白 な 事実 を 、 ことさら に 眼 の 前 に 並   て み て 、 始めて 大きな 真理 で も 発見 し た か の ご とく に 驚い た 。
<span class="m">750</span>:　 父 は この 言葉 を 何 遍 も 繰り返し た 。 私 は 心 の うち で この 父 の 喜び と 、 卒業 式 の あっ た 晩 先生 の 家 の 食卓 で 、 「 お 目 出 とう 」 と いわ れ た 時 の 先生 の 顔 付 と を 比較 し た 。 私 に は 口 で 祝っ て くれ ながら 、 腹 の 底 で けなし て いる 先生 の 方 が 、 それほど に も ない もの を 珍し そう に 嬉し がる 父 より も 、 かえって 高尚 に 見え た 。 私 は しまいに 父 の 無知 から 出る 田舎 臭い ところ に 不快 を 感   出し た 。
<span class="m">896</span>:　 私 の 哀愁 は この 夏 帰省 し た 以後 次第に 情調 を 変え て 来 た 。 油蝉 の 声 が つくつく法師 の 声 に 変る ごとく に 、 私 を 取り巻く 人 の 運命 が 、 大きな 輪廻 の うち に 、 そろそろ 動い て いる よう に 思わ れ た 。 私 は 淋し そう な 父 の 態度 と 言葉 を 繰り返し ながら 、 手紙 を 出し て も 返事 を 寄こさ ない 先生 の 事 を また 憶 い 浮べ た 。 先生 と 父 と は 、 まるで 反対 の 印象 を 私 に 与える 点 において 、 比較 の 上 に も 、 連想 の 上 に も 、 いっしょ に 私 の 頭 に 上り やすかっ た 。
</pre></div></div>

<p>完成です。</p>

<p>ちなみにこんなのもあるようです。</p>

<ul>
<li><a href="http://blog.amedama.jp/entry/2015/12/10/211406" rel="nofollow noopener" target="_blank">日本語の文章から文字列を検索するコマンド jpgrep をつくってみた</a></li>
</ul>

<p>ただオリジナルのgrepを拡張したものでないため、 <code>-v</code> 以外のオプションが使えません。<br>
全体的な使い勝手に難があるため、オリジナルのgrepが使える形で進めました。</p>

<h1>
<span id="grepの速さを知る" class="fragment"></span><a href="#grep%E3%81%AE%E9%80%9F%E3%81%95%E3%82%92%E7%9F%A5%E3%82%8B"><i class="fa fa-link"></i></a><strong>grepの速さを知る</strong>
</h1>

<p>grepって速いらしいです。<br>
冒頭に使ったなんちゃってgrepとオリジナルのgrepで速度比較をしてみましょう。</p>

<ul>
<li>grep</li>
<li>sedrep</li>
<li>awkrep</li>
<li>powerep</li>
</ul>

<p>出来る限り大きなテキストファイルが欲しいのですが、そうそうデカイテキストファイルなんか見つからないのでアリスをひたすら連結してみます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>root@ubuntu16:~# <span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..1000<span class="o">}</span> <span class="p">;</span> <span class="k">do</span>  cat alice.txt &gt;&gt; big_alice.txt <span class="p">;</span> <span class="k">done</span>
root@ubuntu16:~# <span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..10000<span class="o">}</span> <span class="p">;</span> <span class="k">do</span>  cat alice.txt &gt;&gt; huge_alice.txt <span class="p">;</span> <span class="k">done</span>

root@ubuntu16:~# ls -lh *alice.txt
-rw-r--r-- <span class="m">1</span> root root 108K Mar <span class="m">26</span>  <span class="m">2011</span> alice.txt
-rw-r--r-- <span class="m">1</span> root root 105M Oct  <span class="m">1</span> <span class="m">06</span>:38 big_alice.txt
-rw-r--r-- <span class="m">1</span> root root <span class="m">1</span>.1G Oct  <span class="m">1</span> <span class="m">06</span>:40 huge_alice.txt
</pre></div></div>

<p>ひたすら "play" をカウントさせるだけの簡単なお仕事です。まずは100MB程度の <code>big_alice.txt</code> から。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># grep氏</span>
root@ubuntu16:~# <span class="nb">time</span> cat big_alice.txt <span class="p">|</span> grep <span class="s2">"play"</span> <span class="p">|</span> wc -l
<span class="m">29000</span>

real    0m0.106s
user    0m0.060s
sys     0m0.048s

<span class="c1"># sedrep氏</span>
root@ubuntu16:~# <span class="nb">time</span> cat big_alice.txt <span class="p">|</span> sed -n <span class="s1">'/play/p'</span> <span class="p">|</span> wc -l
<span class="m">29000</span>

real    0m1.066s
user    0m0.996s
sys     0m0.068s

<span class="c1"># awkrep氏</span>
root@ubuntu16:~# <span class="nb">time</span> cat big_alice.txt <span class="p">|</span> awk <span class="s1">'/play/{print}'</span> <span class="p">|</span> wc -l
<span class="m">29000</span>

real    0m1.267s
user    0m0.628s
sys     0m0.192s

<span class="c1"># powerep氏</span>
root@ubuntu16:~# <span class="nb">time</span> cat big_alice.txt <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> LINE <span class="p">;</span> <span class="k">do</span> <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="si">${</span><span class="nv">LINE</span><span class="si">}</span><span class="s2">"</span> <span class="o">=</span>~ play <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span> <span class="nb">echo</span> <span class="si">${</span><span class="nv">LINE</span><span class="si">}</span> <span class="p">;</span> <span class="k">fi</span> <span class="p">;</span> <span class="k">done</span> <span class="p">|</span> wc -l
<span class="m">29000</span>

real    0m55.960s
user    0m39.788s
sys     0m16.144s
</pre></div></div>

<p>結果はすべて正しく出ているようですが、すでに圧倒的な戦力差を見せつけるgrep氏。<br>
予想通りではありますが、powerep氏はここでリタイアですね。</p>

<p>実力を見るために複数回まわしてみましょう。ワンライナーawkで平均、最大、最小を出します。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># grep氏</span>
root@ubuntu16:~# <span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..10<span class="o">}</span> <span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">time</span> cat big_alice.txt <span class="p">|</span> grep <span class="s2">"play"</span> <span class="p">|</span> wc -l<span class="o">)</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep real <span class="p">|</span> awk <span class="s1">'{print $2}'</span> <span class="p">|</span> sed -E <span class="s1">'s/^([0-9]+)m([0-9\.]+)s$/\1 \2/g'</span> <span class="p">|</span> awk <span class="s1">'{print $1*60+$2}'</span> <span class="p">;</span> <span class="k">done</span> <span class="p">|</span> awk <span class="s1">'BEGIN{TOTAL=0;MAX=0;MIN=9999}{TOTAL+=$1;if(MAX&lt;$1)MAX=$1;if(MIN&gt;$1)MIN=$1}END{print "avg: "TOTAL/NR", max: "MAX", min: "MIN}'</span>
avg: <span class="m">0</span>.0848, max: <span class="m">0</span>.103, min: <span class="m">0</span>.08

<span class="c1"># sedrep氏</span>
root@ubuntu16:~# <span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..10<span class="o">}</span> <span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">time</span> cat big_alice.txt <span class="p">|</span> sed -n <span class="s1">'/play/p'</span> <span class="p">|</span> wc -l<span class="o">)</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep real <span class="p">|</span> awk <span class="s1">'{print $2}'</span> <span class="p">|</span> sed -E <span class="s1">'s/^([0-9]+)m([0-9\.]+)s$/\1 \2/g'</span> <span class="p">|</span> awk <span class="s1">'{print $1*60+$2}'</span> <span class="p">;</span> <span class="k">done</span> <span class="p">|</span> awk <span class="s1">'BEGIN{TOTAL</span>
<span class="s1">=0;MAX=0;MIN=9999}{TOTAL+=$1;if(MAX&lt;$1)MAX=$1;if(MIN&gt;$1)MIN=$1}END{print "avg: "TOTAL/NR", max: "MAX", min: "MIN}'</span>
avg: <span class="m">1</span>.0689, max: <span class="m">1</span>.086, min: <span class="m">1</span>.06

<span class="c1"># awkrep氏</span>
root@ubuntu16:~# <span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..10<span class="o">}</span> <span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">time</span> cat big_alice.txt <span class="p">|</span> awk <span class="s1">'/play/{print}'</span> <span class="p">|</span> wc -l<span class="o">)</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep real <span class="p">|</span> awk <span class="s1">'{print $2}'</span> <span class="p">|</span> sed -E <span class="s1">'s/^([0-9]+)m([0-9\.]+)s$/\1 \2/g'</span> <span class="p">|</span> awk <span class="s1">'{print $1*60+$2}'</span> <span class="p">;</span> <span class="k">done</span> <span class="p">|</span> awk <span class="s1">'BEGIN{TO</span>
<span class="s1">TAL=0;MAX=0;MIN=9999}{TOTAL+=$1;if(MAX&lt;$1)MAX=$1;if(MIN&gt;$1)MIN=$1}END{print "avg: "TOTAL/NR", max: "MAX", min: "MIN}'</span>
avg: <span class="m">0</span>.8092, max: <span class="m">0</span>.817, min: <span class="m">0</span>.803
</pre></div></div>

<p>どうやら2番手はawkrep氏の模様。<br>
では最後に1GBの <code>huge_alice.txt</code> を食わせてみましょう。やってることを同じなのでまとめて結果だけ。<br>
あとついでに単純文字列のgrepならそのままより速いという <strong>fgrep</strong> も試してみます。</p>

<table>
<thead>
<tr>
<th style="text-align: right">rank</th>
<th style="text-align: center">type</th>
<th style="text-align: center">file</th>
<th style="text-align: right">avg</th>
<th style="text-align: right">max</th>
<th style="text-align: right">min</th>
<th style="text-align: right">avg ratio</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">1</td>
<td style="text-align: center">grep</td>
<td style="text-align: center">big_alice.txt</td>
<td style="text-align: right"><strong>0.0848</strong></td>
<td style="text-align: right"><strong>0.103</strong></td>
<td style="text-align: right"><strong>0.08</strong></td>
<td style="text-align: right">x1.00</td>
</tr>
<tr>
<td style="text-align: right">2</td>
<td style="text-align: center">fgrep</td>
<td style="text-align: center">big_alice.txt</td>
<td style="text-align: right">0.0948</td>
<td style="text-align: right">0.104</td>
<td style="text-align: right">0.01</td>
<td style="text-align: right">x1.11</td>
</tr>
<tr>
<td style="text-align: right">4</td>
<td style="text-align: center">sed</td>
<td style="text-align: center">big_alice.txt</td>
<td style="text-align: right">1.0689</td>
<td style="text-align: right">1.086</td>
<td style="text-align: right">1.06</td>
<td style="text-align: right">x12.60</td>
</tr>
<tr>
<td style="text-align: right">3</td>
<td style="text-align: center">awk</td>
<td style="text-align: center">big_alice.txt</td>
<td style="text-align: right">0.9092</td>
<td style="text-align: right">0.817</td>
<td style="text-align: right">0.803</td>
<td style="text-align: right">x10.72</td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td style="text-align: right">1</td>
<td style="text-align: center">grep</td>
<td style="text-align: center">huge_alice.txt</td>
<td style="text-align: right"><strong>14.5974</strong></td>
<td style="text-align: right"><strong>16.098</strong></td>
<td style="text-align: right"><strong>13.735</strong></td>
<td style="text-align: right">x1.00</td>
</tr>
<tr>
<td style="text-align: right">2</td>
<td style="text-align: center">fgrep</td>
<td style="text-align: center">huge_alice.txt</td>
<td style="text-align: right">15.5718</td>
<td style="text-align: right">16.519</td>
<td style="text-align: right">14.608</td>
<td style="text-align: right">x1.06</td>
</tr>
<tr>
<td style="text-align: right">4</td>
<td style="text-align: center">sed</td>
<td style="text-align: center">huge_alice.txt</td>
<td style="text-align: right">16.414</td>
<td style="text-align: right">17.42</td>
<td style="text-align: right">15.559</td>
<td style="text-align: right">x1.12</td>
</tr>
<tr>
<td style="text-align: right">3</td>
<td style="text-align: center">awk</td>
<td style="text-align: center">huge_alice.txt</td>
<td style="text-align: right">16.1243</td>
<td style="text-align: right">17.372</td>
<td style="text-align: right">15.33</td>
<td style="text-align: right">x1.10</td>
</tr>
</tbody>
</table>

<p>結果は <strong>grep &gt; fgrep &gt; awk &gt; sed</strong> の順となりました。<br>
しかし <code>big_alice.txt</code> のときは他より10倍以上速かったgrepですが、 <code>huge_alice.txt</code> になると大差ないようになっています。<br>
このあたりにはどんな理由があるんでしょうか。テストのやり方を含め、何か秘密がありそうです。<br>
あと、fgrep君、君にはがっかりだよ。これも何か秘密が...。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a><strong>おわりに</strong>
</h1>

<p>grepの全オプションを網羅しようと思ったんですがある程度ストーリー仕立てにすると思った以上に大変なのでやめました。</p>

<p><strong>grepの奥は深い。</strong></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>t_nakayama0714さんの<br />4位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/t_nakayama0714/items/62c8405211633e42b012">hubotとSlackで株取引をちょっと助ける</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-06 04:04:40</center>
	</td>
	<td style="width:200px;">
		@t_nakayama0714<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/45253/profile-images/1473690211">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Hubot]</b> <b>[PhantomJS]</b> <b>[bot]</b> <b>[Slack]</b> <b>[株価]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a><strong>はじめに</strong>
</h1>

<p>株をやっていて、ある程度自分の見方が決まってくると株のチェック行為が <strong>ルーチン化</strong> してくるわけですが、そんなことがあると途端に湧いてくる <strong>自動化 / 省力化</strong> の欲求。</p>

<p><a href="https://camo.qiitausercontent.com/fbc24ef2a8cc22c08a5cddce6d2a1e2566e85c77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63623665356230652d636564322d333465322d626336642d6537303764666338303137312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fbc24ef2a8cc22c08a5cddce6d2a1e2566e85c77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63623665356230652d636564322d333465322d626336642d6537303764666338303137312e706e67" alt="hubot_icon.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/cb6e5b0e-ced2-34e2-bc6d-e707dfc80171.png"></a></p>

<p>今回はそんなモチベーションから生まれた、ウチのSlackに生息する <strong>money-botくん</strong> の</p>

<ul>
<li><strong>株価サマリ表示機能</strong></li>
<li><strong>株価チャート表示機能</strong></li>
<li><strong>(おまけ) 株取引格言アドバイス機能</strong></li>
</ul>

<p>について紹介します。<br>
自分と親しい友人用に作っているだけなので全然綺麗ではないんですが、 <strong>新たなbot機能のアイデア</strong> や <strong>汚く作ってしまったところの改善アイデア</strong> なんかをもらえたら嬉しいなぁなんて気持ちで書いてます。</p>

<h1>
<span id="機能イメージ" class="fragment"></span><a href="#%E6%A9%9F%E8%83%BD%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a><strong>機能イメージ</strong>
</h1>

<p>株のことを調べる際には有名どころでいけば <strong><a href="https://finance.yahoo.co.jp/" rel="nofollow noopener" target="_blank">Yahoo!ファイナンス</a></strong> だったり <strong><a href="https://www.morningstar.co.jp/" rel="nofollow noopener" target="_blank">モーニングスター</a></strong> だったりするかと思いますが、日頃のルーチンを通じて僕は <strong><a href="https://kabutan.jp/" rel="nofollow noopener" target="_blank">株探</a></strong> を日常的に使うようになりました。<br>
割と各株についてコンパクトにまとまっているところが好きで愛用(?)しています。</p>

<p>とはいえ、そうやって愛用しているサイトであっても、自然と自分の動線は決まっていくものなので、その動線の部分だけをサマれないかなと思ったりしたわけです。</p>

<p>こういうのは見たほうが早いので、先に実際のやりとり画像で説明します。</p>

<h2>
<span id="株価サマリ表示機能" class="fragment"></span><a href="#%E6%A0%AA%E4%BE%A1%E3%82%B5%E3%83%9E%E3%83%AA%E8%A1%A8%E7%A4%BA%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a><strong>株価サマリ表示機能</strong>
</h2>

<p>チャット中で <strong>4桁の数字</strong> をつぶやくと、それを銘柄コードとして <strong>該当する銘柄のサマリ</strong> を表示します。当然タイトルは株探ページへのリンクになっています。</p>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/b9e4cb72c3f542711e726742f3f982e972e84d94/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f66643731656662382d373432312d643539332d616265622d3230336639656435366536632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b9e4cb72c3f542711e726742f3f982e972e84d94/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f66643731656662382d373432312d643539332d616265622d3230336639656435366536632e706e67" alt="WS000127.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/fd71efb8-7421-d593-abeb-203f9ed56e6c.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>正確には、通常の文脈で喋った4桁数字(株価とか)も銘柄コードとして拾われると困るので前後空白の場合に反応するよう調整しています。</p>

<p>サマリの内容としては基本的に株探の数値をそのまま表示していますが、唯一 <strong>Q成長率</strong> というやつだけ自分で導入しています。<br>
自分の取引はテクニカル寄りなのでチャートの形をよく見るんですが、チャートの高さが値動きによらず1画面へ <strong>いい感じ</strong> に表示される都合で、 <strong>一見同じように見える</strong> チャートであっても、実際の成長度合いって結構違っていたりします。</p>

<p>例えば以下のグラフそれぞれで、左端の終値と右端の終値を比較すると上昇率に2倍以上の開きがあったりします。</p>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/9fc9c34a47a89dfd6d3ae42b0e0ed0b4c2712c7f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63303362623061362d643331332d343338342d363734612d6430653365633565656538642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9fc9c34a47a89dfd6d3ae42b0e0ed0b4c2712c7f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63303362623061362d643331332d343338342d363734612d6430653365633565656538642e706e67" alt="WS000137.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/c03bb0a6-d313-4384-674a-d0e3ec5eee8d.png"></a></th>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/6c645ec5f017ba85f4c6d4bdbe5331d35fce22c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f37353733643031652d653162392d363736392d376266392d6364333364306331363831662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6c645ec5f017ba85f4c6d4bdbe5331d35fce22c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f37353733643031652d653162392d363736392d376266392d6364333364306331363831662e706e67" alt="WS000138.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/7573d01e-e1b9-6769-7bf9-cd33d0c1681f.png"></a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><strong>+77%</strong></td>
<td style="text-align: center"><strong>+29%</strong></td>
</tr>
</tbody>
</table>

<p>そうした意味で、サマリを作る過程で <strong>60営業日前</strong> の株価と現在株価を比較して、その成長率を <strong>Q成長率</strong> として出しています。QはQuaterのつもりです。</p>

<p>あと、株探ってその企業の業績が上向きか下向きかっていうのをページに出してくれますが、それをAttachmentsの色に翻訳して表示したりしています。</p>

<table>
<thead>
<tr>
<th style="text-align: center">未定</th>
<th style="text-align: center">急上昇</th>
<th style="text-align: center">上昇</th>
<th style="text-align: center">停滞</th>
<th style="text-align: center">下降</th>
<th style="text-align: center">急下降</th>
<th style="text-align: center">情報なし</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><a href="https://camo.qiitausercontent.com/41a560e50bb50ca6cff6ec965ef4b2ee05f7ab83/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f302e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/41a560e50bb50ca6cff6ec965ef4b2ee05f7ab83/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f302e676966" alt="未定" data-canonical-src="https://kabutan.jp/images/cmn/gyouseki_0.gif"></a></td>
<td style="text-align: center"><a href="https://camo.qiitausercontent.com/10419a655c995db52af32fe264cc9fdf5a3a749b/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f312e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/10419a655c995db52af32fe264cc9fdf5a3a749b/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f312e676966" alt="急上昇" data-canonical-src="https://kabutan.jp/images/cmn/gyouseki_1.gif"></a></td>
<td style="text-align: center"><a href="https://camo.qiitausercontent.com/4339aa45d29c666af47a28943b5f0d86d091fda1/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f322e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4339aa45d29c666af47a28943b5f0d86d091fda1/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f322e676966" alt="上昇" data-canonical-src="https://kabutan.jp/images/cmn/gyouseki_2.gif"></a></td>
<td style="text-align: center"><a href="https://camo.qiitausercontent.com/fc0ef0e00b077116405f672db000081f4f64b9fc/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f332e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fc0ef0e00b077116405f672db000081f4f64b9fc/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f332e676966" alt="停滞" data-canonical-src="https://kabutan.jp/images/cmn/gyouseki_3.gif"></a></td>
<td style="text-align: center"><a href="https://camo.qiitausercontent.com/2ea719e39d003da8fb24e1e03f6e36464450b2e0/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f342e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2ea719e39d003da8fb24e1e03f6e36464450b2e0/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f342e676966" alt="下落" data-canonical-src="https://kabutan.jp/images/cmn/gyouseki_4.gif"></a></td>
<td style="text-align: center"><a href="https://camo.qiitausercontent.com/777f64d134424e66a89bf82fdc5d997b12fe8d44/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f352e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/777f64d134424e66a89bf82fdc5d997b12fe8d44/68747470733a2f2f6b61627574616e2e6a702f696d616765732f636d6e2f67796f7573656b695f352e676966" alt="急下降" data-canonical-src="https://kabutan.jp/images/cmn/gyouseki_5.gif"></a></td>
<td style="text-align: center">―</td>
</tr>
<tr>
<td style="text-align: center"><font color="#BDBDBD">■</font></td>
<td style="text-align: center"><font color="#FF0000">■</font></td>
<td style="text-align: center"><font color="#FE9A2E">■</font></td>
<td style="text-align: center"><font color="#01DF01">■</font></td>
<td style="text-align: center"><font color="#0000FF">■</font></td>
<td style="text-align: center"><font color="#8904B1">■</font></td>
<td style="text-align: center"><font color="#FFFFFF">■</font></td>
</tr>
</tbody>
</table>

<p>なので先ほどのソニーは <strong>業績急上昇(株探調べ)</strong> ということが一目でわかります。</p>

<p>他には地味に大事な機能として <strong>決算日表示機能</strong> があります。<br>
株探は決算日が近づくと決算予定日をページに書いてくれるんですが、ある場合はメッセージ本文として拾ってきてくれます。<br>
基本的に決算ギャンブルしない人なので、これで気付けるのは非常にありがたい。</p>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/62fb58aa1f66013cee82263b8d594d2661608d3b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f66346236623061632d663866352d363238332d616538372d6463643162633137303335352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/62fb58aa1f66013cee82263b8d594d2661608d3b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f66346236623061632d663866352d363238332d616538372d6463643162633137303335352e706e67" alt="WS000131.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/f4b6b0ac-f8f5-6283-ae87-dcd1bc170355.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>というのがサマリ機能でした。</p>

<p>ちなみに複数銘柄の一括表示にも対応してます。中では非同期なのでつぶやいた順序にはならない仕様。</p>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/1e3ed80f2d971e667ad0759bd12e8e90fea86c96/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63653264366463332d623437392d633937612d363332332d6436363930313435643131332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1e3ed80f2d971e667ad0759bd12e8e90fea86c96/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f63653264366463332d623437392d633937612d363332332d6436363930313435643131332e706e67" alt="WS000129.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/ce2d6dc3-b479-c97a-6323-d6690145d113.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>家電業界並べてみましたけど、どこも業績よくて業績ラベルの例にもならん...。まぁいいか。</p>

<h2>
<span id="株価チャート表示機能" class="fragment"></span><a href="#%E6%A0%AA%E4%BE%A1%E3%83%81%E3%83%A3%E3%83%BC%E3%83%88%E8%A1%A8%E7%A4%BA%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a><strong>株価チャート表示機能</strong>
</h2>

<p>サマリ機能があるだけで大分よくなったんですが、同じく株やってて情報交換する友人と銘柄の話をする際、当然 <strong>チャートのスクショ</strong> を貼ったりするわけです。何度も。<br>
というわけで作りました。</p>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/086747afce4ae30e4cc49b1c10c7759b5495725e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35313532386139662d343239342d346635632d373563622d6635626466663132373730612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/086747afce4ae30e4cc49b1c10c7759b5495725e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35313532386139662d343239342d346635632d373563622d6635626466663132373730612e706e67" alt="WS000132.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/51528a9f-4294-4f5c-75cb-f5bdff12770a.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>銘柄コードのみをつぶやいた場合は、サマリに加え <strong>日足のチャート</strong> も出してくれます。<br>
このチャートは株探で日足チャートを表示させた場合のものを <strong><a href="https://www.npmjs.com/package/phantomjs-prebuilt" rel="nofollow noopener" target="_blank">PhantomJS</a></strong> で切り取ってSlackへアップロードさせています。</p>

<h2>
<span id="おまけ-格言アドバイス機能" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91-%E6%A0%BC%E8%A8%80%E3%82%A2%E3%83%89%E3%83%90%E3%82%A4%E3%82%B9%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a><strong>(おまけ) 格言アドバイス機能</strong>
</h2>

<p>あとは個人的にお気に入りの機能です。<br>
株って戦略それ自体もそうですが、本人の精神性もすごく大事だと思うので、先人の格言みたいなものをちょいちょい取り込んでいきたいなと思ったわけです。そこでこれ。<br>
「悩」という文字に反応して <strong>株の格言</strong> をもたらす機能。</p>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/dda6425497c2f53c1cf8fd545a9e0ba895d7dfad/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35646364643334322d386134322d663039372d356432312d6136636635663433633133652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/dda6425497c2f53c1cf8fd545a9e0ba895d7dfad/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f35646364643334322d386134322d663039372d356432312d6136636635663433633133652e706e67" alt="WS000133.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/5dcdd342-8a42-f097-5d21-a6cf5f43c13e.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/46a867d80e0c6fcdb45dde1d9e733f1de2956d19/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f34333966356261362d396632352d616130362d626337652d3037616332376535623364322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/46a867d80e0c6fcdb45dde1d9e733f1de2956d19/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f34333966356261362d396632352d616130362d626337652d3037616332376535623364322e706e67" alt="WS000134.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/439f5ba6-9f25-aa06-bc7e-07ac27e5b3d2.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>これらの格言は <strong><a href="https://www.mo-ney.net/about/proverb/" rel="nofollow noopener" target="_blank">相場格言集 | FX比較マネー</a></strong> からランダムで選んでくるようになっています。<br>
botがちょっとだけ喋ってるのはただの遊び心です。これも決まった単語リストからランダムです。</p>

<p>「悩」一文字にしか反応してないので、支離滅裂もない返しではあるんですが、含蓄の深い言葉が返ってくるので大体「 <strong>なるほど...</strong> 」ってなったりするのが面白いところ。</p>

<h1>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a><strong>実装</strong>
</h1>

<p>それでは実装の話をします。コード自体は全然美しくないので処理上のポイントだけを解説します。<br>
綺麗な実装PRをお待ちしております...！</p>

<p><strong><a href="https://github.com/t-nakayama0714/money-bot" rel="nofollow noopener" target="_blank">GitHub: t-nakayama0714/money-bot</a></strong></p>

<h2>
<span id="実行環境" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a><strong>実行環境</strong>
</h2>

<p>Bluemix上のコンテナで動いてます。以前の記事で</p>

<p><strong><a href="https://qiita.com/t_nakayama0714/items/c0eb5e298524c127bccd" id="reference-48c9f4bd8ac7b2199ce4">無料で整える趣味チームの開発環境</a></strong></p>

<p>なんてのを書きましたが、ここのhubotがだいたいこいつです。記事でも触れている通り、他にはAWS系機能があります。<br>
この記事用にスクリプトを分離する際、なんのミスもなければ多分そのまま動くはず...。</p>

<h2>
<span id="株価サマリ表示機能-1" class="fragment"></span><a href="#%E6%A0%AA%E4%BE%A1%E3%82%B5%E3%83%9E%E3%83%AA%E8%A1%A8%E7%A4%BA%E6%A9%9F%E8%83%BD-1"><i class="fa fa-link"></i></a><strong>株価サマリ表示機能</strong>
</h2>

<p>コード的にはダラダラ書かれていますが、やってること自体はそんなに難しくないです。</p>

<p><strong>1. hearで銘柄コードを捕まえる</strong><br>
<strong>2. 銘柄コードたちをforでまわす</strong><br>
<strong>3. 各銘柄コードごとに対応する株探ページのURLから情報をひたすら抜き出す</strong><br>
<strong>4. 抜き出した情報をAttachmentsにまとめて送る</strong></p>

<p>って感じでしょうか。</p>

<p>初っ端の銘柄コードを捕まえるところで、割と意味不明なことになっています。<br>
これはメッセージをShareしたとき、暗黙に含まれる</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[November 5th, 2017 5:53 PM] nakayama.takahiro: hoge message
</pre></div></div>

<p>というタイムスタンプが厄介なためでした。<br>
ここの記述は前後空白になっているため <code>2017</code> を銘柄コードとしてとらえてしまい、それを避けるべく非常にまわりくどい格好で銘柄コードを捕まえています。</p>

<p>あとはHTTPリクエストで帰ってくるbody全体から、 <strong>正規表現</strong> でほしい値をひたすら抜いてきます。<br>
当然ガチガチのフォーマットで引き抜いてるので、株探が少しでもサイトリニューアルしたら値が取れなくなる可能性が高いです。<br>
が、今のところは「その時は直せばいいや」くらいの感覚です。</p>

<p>で、最後にAttachmentsにして色付けなんかをしながらメッセージを送っています。</p>

<div class="code-frame" data-lang="coffeescript">
<div class="code-lang"><span class="bold">scripts/trade-util.coffee</span></div>
<div class="highlight"><pre><span></span><span class="c1"># Attachmentsの構成</span>
<span class="nv">data =</span>
  <span class="nv">attachments: </span><span class="p">[</span>
    <span class="nv">color: </span><span class="nx">perf_color</span><span class="p">[</span><span class="nx">perf_index</span><span class="p">]</span>
    <span class="nv">title: </span><span class="s">"</span><span class="si">#{</span><span class="nx">title</span><span class="si">}</span><span class="s"> : </span><span class="si">#{</span><span class="nx">price</span><span class="si">}</span><span class="s"> (</span><span class="si">#{</span><span class="nx">priceup</span><span class="si">}</span><span class="s">, </span><span class="si">#{</span><span class="nx">pctup</span><span class="si">}</span><span class="s">%)"</span>
    <span class="nv">title_link: </span><span class="s">"https://kabutan.jp</span><span class="si">#{</span><span class="nx">fullpath</span><span class="si">}</span><span class="s">"</span>
    <span class="nv">pretext: </span><span class="nx">settle</span>
    <span class="nv">text: </span><span class="nx">msg_body</span>
    <span class="nv">mrkdwn_in: </span><span class="p">[</span>
      <span class="s">"text"</span><span class="p">,</span>
      <span class="s">"pretext"</span>
    <span class="p">]</span>
  <span class="p">]</span>

<span class="c1"># レスポンス</span>
<span class="c1"># hubot-slack4系からこの送り方でよくなった</span>
<span class="nx">msg</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data</span>
</pre></div>
</div>

<p>コメントにも書いてありますが、 hubot-slack4系と3系でAttachmentsの添え方が違うことに注意してください。<br>
<strong><a href="https://www.slideshare.net/knjcode/hubotslack-v4-hubotchatops" rel="nofollow noopener" target="_blank">hubot-slack v4移行時のハマりどころ(p.11)</a></strong></p>

<h2>
<span id="株価チャート表示機能-1" class="fragment"></span><a href="#%E6%A0%AA%E4%BE%A1%E3%83%81%E3%83%A3%E3%83%BC%E3%83%88%E8%A1%A8%E7%A4%BA%E6%A9%9F%E8%83%BD-1"><i class="fa fa-link"></i></a><strong>株価チャート表示機能</strong>
</h2>

<p>こちらも動かすまでは難儀しましたが、できてしえば処理は簡単です。</p>

<p><strong>1. hearで銘柄コードを捕まえる</strong><br>
<strong>2. 銘柄コードに対応する株探ページから日足チャートをPhantomJSで抜き出す</strong><br>
<strong>3. 取得した画像をSlackの添付ファイルとして送る</strong></p>

<p>PhantomJSをドキュメント通りに使おうとしてなんだかよくわからなくなって挫折した結果、</p>

<p><strong><a href="https://qiita.com/k-ysd/items/c7580a5febba82e7a802" id="reference-9dbc0cc3c23baf07a328">家庭用にHubotスクリプトを書いてみた話</a></strong></p>

<p>の該当部分をほぼ丸パクするに至りましたm(_ _)m</p>

<p>スクショ用JSのところには、株探の日足チャートをぴったり抜き出すべく座標情報を驚くほど <strong>ハードコード</strong> しています。<br>
こちらもやはり株探のリニューアルで即死すると思われます。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">scripts/lib/kabutan_chart.js</span></div>
<div class="highlight"><pre><span></span><span class="c1">// 切り抜き位置(株探チャート用)</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">clipRect</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">top</span><span class="o">:</span> <span class="mi">643</span><span class="p">,</span>
  <span class="nx">left</span><span class="o">:</span> <span class="mi">475</span><span class="p">,</span>
  <span class="nx">width</span><span class="o">:</span> <span class="mi">640</span><span class="p">,</span>
  <span class="nx">height</span><span class="o">:</span> <span class="mi">402</span>
<span class="p">};</span>
</pre></div>
</div>

<p>あとは取得した画像をどうやって見せるかなんですが、サマリ同様にAttachmentsの <code>image_url</code> を使う手があります。<br>
が、これはSlackから見てReachableな画像でないといけないので、コンテナ内に生成した画像をどうにかするのは大変です。多分同一コンテナにWebサーバ立てるとかやS3なんかにファイルを置くとかすればいいんでしょうけど、中々面倒なのが素直な印象です。</p>

<p>そこで素直にファイルをアップロードすることにしています。<br>
アップロードはお馴染み <code>curl</code> でできてしまうので、</p>

<div class="code-frame" data-lang="coffeescript">
<div class="code-lang"><span class="bold">scripts/trade-util.coffee</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 画像をアップロードする</span>
<span class="nv">cmd = </span><span class="s">"curl -F filename=</span><span class="si">#{</span><span class="nx">filetitle</span><span class="si">}</span><span class="s"> -F file=@stock_image/</span><span class="si">#{</span><span class="nx">code</span><span class="si">}</span><span class="s">.png -F channels=</span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> -F token=</span><span class="si">#{</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HUBOT_SLACK_TOKEN</span><span class="si">}</span><span class="s"> https://slack.com/api/files.upload"</span>
<span class="nx">childProcess</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">cmd</span><span class="p">,</span> <span class="nf">(err, stdout, stderr) -&gt;</span>
</pre></div>
</div>

<p>という感じになりました。</p>

<h3>
<span id="残課題" class="fragment"></span><a href="#%E6%AE%8B%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a><strong>残課題</strong>
</h3>

<p>よーく見るとわかるのですが、こうして取得できた画像には日本語が表示できていなかったりします。</p>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/ad7177e2e8de0c55e77d214b96599127ce25d04e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f30356638333334332d343165632d333636332d646536612d3761633135343736313233652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ad7177e2e8de0c55e77d214b96599127ce25d04e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f30356638333334332d343165632d333636332d646536612d3761633135343736313233652e706e67" alt="original.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/05f83343-41ec-3663-de6a-7ac15476123e.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p>↑　株探の元チャート<br>
↓　PhantomJSで生成したチャート</p>

<table>
<thead>
<tr>
<th style="text-align: center"><a href="https://camo.qiitausercontent.com/73741fbd276f4cd1cf19e5e94542f3a84f5097c3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f64343335373539632d666663662d656466312d633537392d6139616166643738313162632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/73741fbd276f4cd1cf19e5e94542f3a84f5097c3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34353235332f64343335373539632d666663662d656466312d633537392d6139616166643738313162632e706e67" alt="phantomjs.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/45253/d435759c-ffcf-edf1-c579-a9aafd7811bc.png"></a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<p><strong><a href="http://t-cyrill.hatenablog.jp/entry/2014/10/05/123803" rel="nofollow noopener" target="_blank">PhantomJSで日本語が文字化けして辛い</a></strong> をやったら直るのはわかっているんですが、今のままでも困ってないので別にいいかなと思って放置しています。</p>

<h2>
<span id="おまけ-株取引格言アドバイス機能" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91-%E6%A0%AA%E5%8F%96%E5%BC%95%E6%A0%BC%E8%A8%80%E3%82%A2%E3%83%89%E3%83%90%E3%82%A4%E3%82%B9%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a><strong>(おまけ) 株取引格言アドバイス機能</strong>
</h2>

<p>これ自体に特段の技術トピックはありません。<br>
既にサマリを出すためにやった内容で大体できています。配列からランダムに値を取り出すくらいのところでしょうか。</p>

<p>格言を選ぶまでがまどろっこしいのは取得元のソースがそんな感じになっていたからでした。一度見てみてください。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a><strong>おわりに</strong>
</h1>

<p>日々のルーチンワークにhubotは絶大な力を発揮しますね。<br>
このbotを作るにあたり、AttachmentsやPhantomJSなど、それまで触ったことのない要素に触れられたため、さらにbotの自由度が上がりそうです。</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
