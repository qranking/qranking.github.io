<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (marty-suzuki)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (marty-suzuki さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>marty-suzukiさんの<br />1位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>197</kbd>
		<a target="_blank" href="https://qiita.com/marty-suzuki/items/5a4f680b10bb82501aa3">【iOSDC2017】MVC→MVP→MVVM→Fluxの実装の違いを比較してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-22 17:35:49</center>
	</td>
	<td style="width:200px;">
		@marty-suzuki<br />(CyberAgent, Inc. AbemaTV 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/60325/profile-images/1473695196">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[flux]</b> <b>[mvc]</b> <b>[MVVM]</b> <b>[Swift]</b> <b>[MVP]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>iOSDC2017にて<a href="https://iosdc.jp/2017/node/1396" rel="nofollow noopener" target="_blank">MVC→MVP→MVVM→Fluxの実装の違いを比較してみる</a>という内容で、Githubのユーザー検索のデモアプリをベースにした発表資料で登壇させていただきました。<br>
登壇枠が15分だったため、ViewControllerを跨いだ（FavoriteViewController &lt;-&gt; RepositoryViewController）4つのデザインパターンの実装の違いにフォーカスした内容となっているので、画面遷移やテストの書き方などについても補足説明を書いていきます。<br>
※MVP、MVVM、Fluxでの補足説明という形で書いていきます。<br>
登壇資料は下記になります。</p>

<blockquote class="twitter-tweet">
<p>本日のプレゼン資料、アップしました。<a href="https://t.co/TIecyULVp4" rel="nofollow noopener" target="_blank">https://t.co/TIecyULVp4</a><a href="https://twitter.com/hashtag/iosdc?src=hash" rel="nofollow noopener" target="_blank">#iosdc</a></p>— marty-suzuki (@marty_suzuki) <a href="https://twitter.com/marty_suzuki/status/909316660372291584" rel="nofollow noopener" target="_blank">September 17, 2017</a>
</blockquote>



<p>また登壇時に利用したサンプルソースは、こちらのリポジトリで公開されています。<br>
<a href="https://github.com/marty-suzuki/iOSDesignPatternSamples" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/marty-suzuki/iOSDesignPatternSamples</a></p>

<p>デモアプリのアプリの動きはこのようになります。</p>

<p><a href="https://camo.qiitausercontent.com/cd7d0490535676fad44c976517d37ed25b1a9d68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f65313762383236312d316635622d313861632d636630632d3835333264636339343534312e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cd7d0490535676fad44c976517d37ed25b1a9d68/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f65313762383236312d316635622d313861632d636630632d3835333264636339343534312e676966" alt="app.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/e17b8261-1f5b-18ac-cf0c-8532dcc94541.gif"></a></p>

<ul>
<li>SearchViewController... 文字列検索でGithub上のユーザーのリストを取得し、表示します。</li>
<li>UserRepositoryViewController... SearchViewControllerで選択されたユーザーのリポジトリ一覧を取得し、表示します。</li>
<li>RepositoryViewController... UserRepositoryViewControllerまたはFavoriteViewControllerで選択されたリポジトリをSafariViewで表示します。また、右上のお気に入りボタンから、レポジトリをFavoriteViewControllerに追加・削除ができます。</li>
<li>FavoriteViewController... お気に入りされたリポジトリの一覧が表示されます。</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/4b7938cae1b7d28f77de233ef1b29439c2e53161/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f65353931356139392d326531342d323261612d393030662d3633383033353139363166652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4b7938cae1b7d28f77de233ef1b29439c2e53161/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f65353931356139392d326531342d323261612d393030662d3633383033353139363166652e706e67" alt="structure.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/e5915a99-2e14-22aa-900f-6380351961fe.png"></a></p>

<h2>
<span id="mvp" class="fragment"></span><a href="#mvp"><i class="fa fa-link"></i></a>MVP</h2>

<p>それでは、まずMVPによる実装について書いていきます。</p>

<p><a href="https://camo.qiitausercontent.com/6adff52e2d812f0a8cabfda593917a531e8738be/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f66626236346439662d313136372d663063302d616137322d3565313766366262316661332e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6adff52e2d812f0a8cabfda593917a531e8738be/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f66626236346439662d313136372d663063302d616137322d3565313766366262316661332e6a706567" width="50%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/fbb64d9f-1167-f0c0-aa72-5e17f6bb1fa3.jpeg"></a></p>

<p>ViewControllerに実装されるプレゼンテーション層に関するロジックをPresenterに実装することで、責務を明確にすることができます。<br>
流れとしては、Viewはユーザーからのアクションを受け取ってPresenterに渡します。<br>
そして、そのアクションによってPresenterはModelの取得や更新を行います。<br>
Presenterは更新された情報をもとにViewの反映メソッドを呼び、Viewに更新結果を反映させます。</p>

<h3>
<span id="画面遷移" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB"><i class="fa fa-link"></i></a>画面遷移</h3>

<p><code>UITableViewDataSource</code>や<code>UITableViewDelegate</code>の実装を、<code>FavoriteViewController</code>の場合は<code>FavoriteViewDataSource</code>に移しています。<br>
<code>FavoriteViewDataSource</code>内の<code>tableView(_:didSelectRowAt:)</code>では、<code>FavoritePresenter</code>の<code>showFavoriteRepository(at:)</code>が呼び出されています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewDataSource</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewDataSource</span><span class="p">:</span> <span class="bp">NSObject</span><span class="p">,</span> <span class="bp">UITableViewDelegate</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">presenter</span> <span class="p">=</span> <span class="n">presenter</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">presenter</span><span class="p">.</span><span class="n">showFavoriteRepository</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoritePresenter</code>はprotocolとなっていて、実装がされてるのは<code>FavoriteViewPresenter</code>になります。<br>
<code>showFavoriteRepository(at:)</code>が呼び出されると、presenter内で保持している<code>GithubKit.Repository</code>の配列から該当の<code>GithubKit.Repository</code>を取得し、<code>FavoriteView</code>の<code>showRepository(with:)</code>を呼び出しています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoritePresenter</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">FavoritePresenter</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">FavoriteView</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">showFavoriteRepository</span><span class="p">(</span><span class="n">at</span> <span class="n">index</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewPresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="n">FavoriteView</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">favorites</span><span class="p">:</span> <span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span> <span class="p">{</span>
        <span class="kr">didSet</span> <span class="p">{</span>
            <span class="n">view</span><span class="p">?.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">FavoriteView</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="n">view</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">showFavoriteRepository</span><span class="p">(</span><span class="n">at</span> <span class="n">index</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">favorites</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">view</span><span class="p">?.</span><span class="n">showRepository</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">repository</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteView</code>はprotocolとなっていて、実装がされてるのは<code>FavoriteViewController</code>になります。<br>
<code>showRepository(with:)</code>が呼び出されると<code>RepositoryViewController</code>を初期化し、navigationControllerでpushすることで遷移させます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteView</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">FavoriteView</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">showRepository</span><span class="p">(</span><span class="n">with</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">FavoriteView</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>

    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span> <span class="p">=</span> <span class="n">FavoriteViewPresenter</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">dataSource</span><span class="p">:</span> <span class="n">FavoriteViewDataSource</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">presenter</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">presenter</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">showRepository</span><span class="p">(</span><span class="n">with</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">vc</span> <span class="p">=</span> <span class="n">RepositoryViewController</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span> <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">presenter</span><span class="p">)</span>
        <span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p>上記のTableViewのCellが選択されてから、次のViewControllerに遷移するまでの流れは下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/c9475f06a7aca6de0f3b8b98410ae5500bcf0f8e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f33383636323230622d343766322d323132632d383563652d3866666433393061343035662e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c9475f06a7aca6de0f3b8b98410ae5500bcf0f8e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f33383636323230622d343766322d323132632d383563652d3866666433393061343035662e6a706567" alt="MVP.002.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/3866220b-47f2-212c-85ce-8ffd390a405f.jpeg"></a></p>

<h3>
<span id="お気に入りに追加" class="fragment"></span><a href="#%E3%81%8A%E6%B0%97%E3%81%AB%E5%85%A5%E3%82%8A%E3%81%AB%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>お気に入りに追加</h3>

<p>favoriteButtonItemがタップされると<code>favoriteButtonTap(_:)</code>が呼び出されるので、<code>RepositoryPresenter</code>の<code>favoriteButtonTap()</code>を呼び出します。<br>
また、presenterのviewがinitializerの引数に含まれていない理由としては、repositoryとfavoritePresenterをViewControllerで保持せずに済むようにするためです。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryView</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">RepositoryView</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">favoriteButtonItem</span><span class="p">:</span> <span class="bp">UIBarButtonItem</span> <span class="p">=</span> <span class="p">{...}()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">RepositoryPresenter</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">,</span>
         <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">presenter</span> <span class="p">=</span> <span class="n">RepositoryViewPresenter</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
                                                 <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">favoritePresenter</span><span class="p">)</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">presenter</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="kc">self</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kr">@objc</span> <span class="kd">private</span> <span class="kd">func</span> <span class="nf">favoriteButtonTap</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="bp">UIBarButtonItem</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">presenter</span><span class="p">.</span><span class="n">favoriteButtonTap</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryPresenter</code>の初期化時にViewも引数として含めたい場合は、下記のようにLazy Initializationを利用することで実現可能です。<br>
しかしこの場合に、<code>RepositoryPresenter</code>内でrepositoryとfavoritePresenterを保持するにも関わらず、ViewControllerでも保持してしまうという問題もあるかと思います。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">RepositoryPresenter</span> <span class="p">=</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">RepositoryViewPresenter</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">repository</span><span class="p">,</span>
                                       <span class="n">favoritePresenter</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">favoritePresenter</span><span class="p">,</span>
                                       <span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="n">Repository</span>                           
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">,</span>
         <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">,</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoritePresenter</span> <span class="p">=</span> <span class="n">favoritePresenter</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryPresenter</code>はprotocolとなっていて、実装がされてるのは<code>RepositoryViewPresenter</code>になります。<br>
<code>favoriteButtonTap()</code>が呼ばれると、<code>RepositoryViewPresenter</code>で保持している<code>Repository</code>が<code>FavoritePresenter</code>内に含まれているかを確認し、その結果によってお気に入りの一覧に追加または削除をしています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryPresenter</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">RepositoryPresenter</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">,</span> <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span>
    <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="n">RepositoryView</span><span class="p">?</span> <span class="p">{</span> <span class="kr">get</span> <span class="kr">set</span> <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">favoriteButtonTap</span><span class="p">()</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewPresenter</span><span class="p">:</span> <span class="n">RepositoryPresenter</span> <span class="p">{</span>
    <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="n">RepositoryView</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">,</span> <span class="n">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoritePresenter</span> <span class="p">=</span> <span class="n">favoritePresenter</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">favoriteButtonTap</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">favoritePresenter</span><span class="p">.</span><span class="bp">contains</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">removeFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
            <span class="p">...</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoritePresenter</code>はprotocolとなっていて、実装がされてるのは<code>FavoriteViewPresenter</code>になります。<br>
お気に入りの一覧を保持している<code>favorites: [GithubKit.Repository]</code>が更新されると、<code>FavoriteView</code>の<code>reloadData()</code>を呼び出します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoritePresenter</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">FavoritePresenter</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">addFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">removeFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">contains</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewPresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="n">FavoriteView</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">favorites</span><span class="p">:</span> <span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span> <span class="p">{</span>
        <span class="kr">didSet</span> <span class="p">{</span>
            <span class="n">view</span><span class="p">?.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">addFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">favorites</span><span class="p">.</span><span class="kr">lazy</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span> <span class="p">})</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">favorites</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">removeFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">index</span> <span class="p">=</span> <span class="n">favorites</span><span class="p">.</span><span class="kr">lazy</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span> <span class="p">})</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">favorites</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">contains</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">favorites</span><span class="p">.</span><span class="kr">lazy</span><span class="p">.</span><span class="n">index</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span> <span class="p">}</span> <span class="o">!=</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>reloadData()</code>の中では<code>tableView?.reloadData()</code>が実行され、お気に入り一覧の画面が更新されます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteView</span></div>
<div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">FavoriteView</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">reloadData</span><span class="p">()</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">FavoriteView</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>

    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span> <span class="p">=</span> <span class="n">FavoriteViewPresenter</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">reloadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">tableView</span><span class="p">?.</span><span class="n">reloadData</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>お気に入りに追加/削除される流れは下記のようになります。</p>

<p><code>FavoritePresenter</code>を所有しているのは<code>FavoriteViewController</code>ですが、ViewControllerが遷移する際に<code>FavoritePresenter</code>の参照が渡されていきます。<br>
<code>RepositoryViewController</code>でお気に入りにボタンがタップされた際に、<code>FavoritePresenter</code>内で保持している<code>GithubKit.Repository</code>の配列の状態によって<code>RepositoryViewController</code>の<code>Repository</code>が追加または削除されます。<br>
<code>Repository</code>の配列に変更があると<code>view?.reloadData()</code>が実行されるので、<code>FavoriteViewController</code>上でリストが更新されます。</p>

<p><a href="https://camo.qiitausercontent.com/8705bbda999bc6546e71e60ddbe92ffdc7ea6248/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f37346265613635332d303839372d646231622d636539332d6137323738346464326566392e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8705bbda999bc6546e71e60ddbe92ffdc7ea6248/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f37346265613635332d303839372d646231622d636539332d6137323738346464326566392e6a706567" alt="MVP.003.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/74bea653-0897-db1b-ce93-a72784dd2ef9.jpeg"></a></p>

<h3>
<span id="テスト" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>テスト</h3>

<p><code>FavoriteView</code>はprotocolなので、モック化にすることで<code>FavoritePresenter</code>のテストを行うことができます。<br>
<code>FavoriteViewMock</code>は下記のようになります。<br>
該当するメソッドが呼び出されたとき用のclosureをpropertyで定義し、それぞれのメソッドが呼び出された際に実行します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewMock</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FavoriteViewMock</span><span class="p">:</span> <span class="n">FavoriteView</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">presenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">?</span>

    <span class="kd">var</span> <span class="nv">didCallReloadData</span><span class="p">:</span> <span class="p">(()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)?</span>
    <span class="kd">var</span> <span class="nv">didCallShowRepository</span><span class="p">:</span> <span class="p">((</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)?</span>

    <span class="kd">func</span> <span class="nf">reloadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">didCallReloadData</span><span class="p">?()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">showRepository</span><span class="p">(</span><span class="n">with</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">didCallShowRepository</span><span class="p">?(</span><span class="n">repository</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>XCTestなどでテストを実行する際の実装は、下記のようになります。</p>

<p><code>FavoriteViewPresenter</code>のinitializerの引数であるviewは<code>FavoriteView</code>となっているので、<code>FavoriteView</code>を採用している<code>FavoriteViewMock</code>を引数として渡すことが可能です。<br>
テストメソッド内では該当するclosureに対して期待する結果を記述し、その後に紐づくpresenterのメソッドを呼び出しています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewTests</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FavoritePresenterTests</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">favoriteView</span><span class="p">:</span> <span class="n">FavoriteViewMock</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">favoritePresenter</span><span class="p">:</span> <span class="n">FavoritePresenter</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">favoriteView</span> <span class="p">=</span> <span class="n">FavoriteViewMock</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoritePresenter</span> <span class="p">=</span> <span class="n">FavoriteViewPresenter</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">favoriteView</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoriteView</span><span class="p">.</span><span class="n">presenter</span> <span class="p">=</span> <span class="n">favoritePresenter</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testReloadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testReloadData expectation"</span><span class="p">)</span>

        <span class="n">favoriteView</span><span class="p">.</span><span class="n">didCallReloadData</span> <span class="p">=</span> <span class="p">{</span>
            <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testShowRepository</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testShowRepository expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>

        <span class="n">favoriteView</span><span class="p">.</span><span class="n">didCallShowRepository</span> <span class="p">=</span> <span class="p">{</span> <span class="n">repo</span> <span class="k">in</span>
            <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
            <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">favoritePresenter</span><span class="p">.</span><span class="n">showFavoriteRepository</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="考察" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F"><i class="fa fa-link"></i></a>考察</h3>

<p>ViewとPresenterはお互いの参照も持ち合うので、依存し合う形になります。<br>
しかし、PresenterとViewを抽象化しておくことでMock化が容易になります。<br>
よって、PresenterにViewのMockを渡すことプレゼンテーション層に関するロジックのテストが可能になります。</p>

<h2>
<span id="mvvm" class="fragment"></span><a href="#mvvm"><i class="fa fa-link"></i></a>MVVM</h2>

<p>続いてMVVMによる実装について書いていきます。</p>

<p><a href="https://camo.qiitausercontent.com/98d926a982d17547fc814f3f5682f8a0cb008d74/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f32346136336264342d633034372d383230382d323239362d3761366462333866643639302e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/98d926a982d17547fc814f3f5682f8a0cb008d74/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f32346136336264342d633034372d383230382d323239362d3761366462333866643639302e6a706567" width="50%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/24a63bd4-c047-8208-2296-7a6db38fd690.jpeg"></a></p>

<p>ViewControllerに実装されるプレゼンテーション層に関するロジックをViewModelに実装することで、責務を明確にすることができます。<br>
流れとしては、Viewはユーザーからのアクションを受け取って、そのイベントをViewModelにbindします。<br>
そして、そのbindされたイベントによってViewModelはModelの取得や更新を行います。<br>
ViewModelは更新された情報をイベントとしてViewにbindし、Viewはbindされたイベントをもとに結果を反映させます。</p>

<p>※Data bindingを実現するために、<a href="https://github.com/ReactiveX/RxSwift" rel="nofollow noopener" target="_blank">RxSwift</a>を利用しています。</p>

<h3>
<span id="画面遷移-1" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB-1"><i class="fa fa-link"></i></a>画面遷移</h3>

<p><code>UITableViewDataSource</code>や<code>UITableViewDelegate</code>の実装を、<code>FavoriteViewController</code>の場合は<code>FavoriteViewDataSource</code>に移しています。<br>
<code>FavoriteViewDataSource</code>内の<code>tableView(_:didSelectRowAt:)</code>では、<code>_selectedIndexPath: PublishSubject&lt;IndexPath&gt;</code>が呼び出されています。<br>
そして、<code>selectedIndexPath: Observable&lt;IndexPath&gt;</code>によって外部に公開されています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewDataSource</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewDataSource</span><span class="p">:</span> <span class="bp">NSObject</span><span class="p">,</span> <span class="bp">UITableViewDelegate</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">selectedIndexPath</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_selectedIndexPath</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span> <span class="p">=</span> <span class="n">viewModel</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">selectedIndexPath</span> <span class="p">=</span> <span class="n">_selectedIndexPath</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_selectedIndexPath</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="n">indexPath</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>selectedIndexPath: Observable&lt;IndexPath&gt;</code>を<code>FavoriteViewModel</code>内のinputとして、initializerの引数として受け取ります。<br>
そのselectedIndexPathからイベントが渡ってくると、ViewModel内で保持している<code>_favorites: Variable&lt;[GithubKit.Repository]&gt;</code>の最新の状態をwithLatestFromで取得し、配列内で該当するrowのRepositoryを返します。<br>
そのイベントを<code>selectedRepository: Observable&lt;GithubKit.Repository&gt;</code>として外部に公開します。<br>
また<code>favorites: Observable&lt;[GithubKit.Repository]&gt;</code>は<code>_favorites</code>のイベントを外部に公開するために利用しています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModel</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewModel</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">favorites</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span>
    <span class="kd">let</span> <span class="nv">selectedRepository</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">&gt;</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_favorites</span> <span class="p">=</span> <span class="n">Variable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">([])</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(...,</span> <span class="n">selectedIndexPath</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favorites</span> <span class="p">=</span> <span class="n">_favorites</span><span class="p">.</span><span class="n">asObservable</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">selectedRepository</span> <span class="p">=</span> <span class="n">selectedIndexPath</span>
            <span class="p">.</span><span class="n">withLatestFrom</span><span class="p">(</span><span class="n">_favorites</span><span class="p">.</span><span class="n">asObservable</span><span class="p">())</span> <span class="p">{</span> <span class="nv">$1</span><span class="p">[</span><span class="nv">$0</span><span class="p">.</span><span class="n">row</span><span class="p">]</span> <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewDataSource</code>でも<code>FavoriteViewModel</code>を利用しているので、<code>FavoriteViewModel</code>のinitializerの引数でdataSource.selectedIndexPathを渡すことができません。<br>
そのため、<code>FavoriteViewController</code>でも<code>selectedIndexPath: PublishSubject&lt;IndexPath&gt;</code>定義し、そのselectedIndexPathを<code>FavoriteViewModel</code>のinitializerに渡します。<br>
dataSource.selectedIndexPathをself.selectedIndexPathにbindすることで、dataSourceからのイベントをviewModelに流すことができます。<br>
また、<code>FavoriteViewModel</code>で公開されているselectedRepositoryを<code>showRepository: AnyObserver&lt;GithubKit.Repository&gt;</code>にbindすることで、<code>RepositoryViewController</code>に遷移させることができます。<br>
また、self.favoritesを<code>favoritesInput: AnyObserver&lt;[GithubKit.Repository]&gt;</code>として外部に公開し、viewModel.favoritesを<code>favoritesOutput: Observable&lt;[GithubKit.Repository]&gt;</code>として外部に公開します。<br>
これらが遷移する際に、それぞれのViewControllerのinitializerの引数として渡されていきます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>

    <span class="kd">var</span> <span class="nv">favoritesInput</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="n">favorites</span><span class="p">.</span><span class="n">asObserver</span><span class="p">()</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">favoritesOutput</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">favorites</span> <span class="p">}</span>

    <span class="kd">private</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">dataSource</span><span class="p">:</span> <span class="n">FavoriteViewDataSource</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span> <span class="p">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="kd">init</span><span class="p">(...,</span> <span class="n">selectedIndexPath</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">selectedIndexPath</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">selectedIndexPath</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe dataSource</span>
        <span class="n">dataSource</span><span class="p">.</span><span class="n">selectedIndexPath</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">selectedIndexPath</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

        <span class="c1">// observe viewModel</span>
        <span class="n">viewModel</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">showRepository</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">showRepository</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="n">repository</span> <span class="k">in</span>
            <span class="kd">let</span> <span class="nv">vc</span> <span class="p">=</span> <span class="n">RepositoryViewController</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
                                              <span class="n">favoritesOutput</span><span class="p">:</span> <span class="n">me</span><span class="p">.</span><span class="n">favoritesOutput</span><span class="p">,</span>
                                              <span class="n">favoritesInput</span><span class="p">:</span> <span class="n">me</span><span class="p">.</span><span class="n">favoritesInput</span><span class="p">)</span>
            <span class="n">me</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p>上記のTableViewのCellが選択されてから、次のViewControllerに遷移するまでの流れは下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/27ae9c4441adb7f7ed975abb624d21dcb4ed7b4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f34323564663332642d643236392d393939622d343635652d3734633939373966633739642e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/27ae9c4441adb7f7ed975abb624d21dcb4ed7b4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f34323564663332642d643236392d393939622d343635652d3734633939373966633739642e6a706567" alt="MVVM.002.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/425df32d-d269-999b-465e-74c9979fc79d.jpeg"></a></p>

<h3>
<span id="お気に入りに追加-1" class="fragment"></span><a href="#%E3%81%8A%E6%B0%97%E3%81%AB%E5%85%A5%E3%82%8A%E3%81%AB%E8%BF%BD%E5%8A%A0-1"><i class="fa fa-link"></i></a>お気に入りに追加</h3>

<p><code>favoriteButtonItem</code>のタップイベントを<code>favoriteButtonItem.rx.tap</code>として、<code>RepositoryViewModel</code>のinitializerに渡します。<br>
そうすることによって、テスト時にPublishSubjectを利用することでタップを再現することができるようになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoriteButtonItem</span><span class="p">:</span> <span class="bp">UIBarButtonItem</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">RepositoryViewModel</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">,</span>
         <span class="n">favoritesOutput</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
         <span class="n">favoritesInput</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">favoriteButtonItem</span> <span class="p">=</span> <span class="bp">UIBarButtonItem</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favoriteButtonItem</span> <span class="p">=</span> <span class="n">favoriteButtonItem</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span> <span class="p">=</span> <span class="n">RepositoryViewModel</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
                                             <span class="n">favoritesOutput</span><span class="p">:</span> <span class="n">favoritesOutput</span><span class="p">,</span>
                                             <span class="n">favoritesInput</span><span class="p">:</span> <span class="n">favoritesInput</span><span class="p">,</span>
                                             <span class="n">favoriteButtonTap</span><span class="p">:</span> <span class="n">favoriteButtonItem</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">tap</span><span class="p">)</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryViewModel</code>では、initializerの引数である<code>favoritesOutput: Observable&lt;[GithubKit.Repository]&gt;</code>からお気に入り一覧の配列の更新イベントを受け取ります。<br>
その際に、ViewModelで保持している<code>GithubKit.Repository</code>が渡ってきた配列に含まれている場合は<strong>配列と該当するindex</strong>を返し、含まれていなかった場合は<strong>配列とnil</strong>を返します。<br>
<code>favoriteButtonTap: ControlEvent&lt;Void&gt;</code>のイベントを受け取った際に上記の最新状態をwithLatestFromで受け取り、indexが存在した場合は<strong>該当のindexを削除した状態の配列</strong>返し、indexが存在しない場合は<strong>ViewModelが保持している<code>GithubKit.Repository</code>を追加した配列</strong>を返します。<br>
そして、<code>favoritesInput: AnyObserver&lt;[GithubKit.Repository]&gt;</code>にその配列を流します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewModel</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">,</span>
         <span class="n">favoritesOutput</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
         <span class="n">favoritesInput</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
         <span class="n">favoriteButtonTap</span><span class="p">:</span> <span class="n">ControlEvent</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">favoritesAndIndex</span> <span class="p">=</span> <span class="n">favoritesOutput</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="p">[</span><span class="n">repository</span><span class="p">]</span> <span class="n">favorites</span> <span class="k">in</span>
                <span class="p">(</span><span class="n">favorites</span><span class="p">,</span> <span class="n">favorites</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span> <span class="p">}))</span>
            <span class="p">}</span>
        <span class="p">...</span>
        <span class="n">favoriteButtonTap</span>
            <span class="p">.</span><span class="n">withLatestFrom</span><span class="p">(</span><span class="n">favoritesAndIndex</span><span class="p">)</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="p">[</span><span class="n">repository</span><span class="p">]</span> <span class="n">favorites</span><span class="p">,</span> <span class="n">index</span> <span class="k">in</span>
                <span class="kd">var</span> <span class="nv">favorites</span> <span class="p">=</span> <span class="n">favorites</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">index</span> <span class="p">=</span> <span class="n">index</span> <span class="p">{</span>
                    <span class="n">favorites</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">favorites</span>
                <span class="p">}</span>
                <span class="n">favorites</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">favorites</span>
            <span class="p">}</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">favoritesInput</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewModel</code>では、initializerの引数として受け取った<code>favoritesObservable: Observable&lt;[GithubKit.Repository]&gt;</code>を利用して外部からのイベントを受け取ります。<br>
favoritesObservableを_favoritesにbindして、保持している配列を更新します。<br>
_favoritesが更新されたイベントを<code>Observable&lt;Void&gt;</code>に変換して、<code>relaodData: Observable&lt;Void&gt;</code>として外部に公開します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModel</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">let</span> <span class="nv">relaodData</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_favorites</span> <span class="p">=</span> <span class="n">Variable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">([])</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">favoritesObservable</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">relaodData</span> <span class="p">=</span> <span class="n">_favorites</span><span class="p">.</span><span class="n">asObservable</span><span class="p">().</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
        <span class="p">...</span>
        <span class="n">favoritesObservable</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">_favorites</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewModel</code>で公開されているreloadDataを<code>FavoriteViewController</code>の<code>reloadData: AnyObserver&lt;Void&gt;</code>にbindすると<code>tableView.reloadData()</code>が実行されるので、<code>FavoriteViewController</code>上でリストが更新されます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span> <span class="p">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">favoritesObservable</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">favorites</span><span class="p">,</span> <span class="p">...)</span>
    <span class="p">}()</span>

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favorites</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe viewModel</span>
        <span class="n">viewModel</span><span class="p">.</span><span class="n">relaodData</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">reloadData</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">reloadData</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="n">me</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>お気に入りに追加/削除される流れは下記のようになります。</p>

<p><code>FavoriteViewController</code>の<code>favoriteInput: Obsservable&lt;[GithubKit.Repository]&gt;</code>と<code>favoriteOutput: Observable&lt;[GithubKit.Repository]&gt;</code>は画面遷移時に、他のViewControllerのinitializerの引数として渡されていきます。<br>
<code>RepositoryViewController</code>ではfavoriteOutputから受け取った配列をもとに、保持している<code>GithubKit.Repository</code>が含まれているかを確認し、追加または削除を行った配列をfavoriteOutputに対して流します。<br>
favoriteInputは<code>FavoriteViewModel</code>内で保持されている<code>_favorites: Variable&lt;[GithubKit.Repository]&gt;</code>にbindし、その更新イベントをfavoriteOutputによって外部に公開されます。<br>
また、_favoritesの更新イベントを<code>Observable&lt;Void&gt;</code>に変換し<code>reloadData</code>として公開することで、<code>FavoriteViewController</code>側でreloadData: AnyObserver<code>にbindされ、</code>tableView.reloadData()<code>が実行されるので</code>FavoriteViewController`上でリストが更新されます。</p>

<p><a href="https://camo.qiitausercontent.com/e1151c4a8f64c2b32877f1824c953b7205b1bcb3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f39663362343962352d366466312d323034362d346138642d6662656231323137303839632e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e1151c4a8f64c2b32877f1824c953b7205b1bcb3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f39663362343962352d366466312d323034362d346138642d6662656231323137303839632e6a706567" alt="MVVM.003.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/9f3b49b5-6df1-2046-4a8d-fbeb1217089c.jpeg"></a></p>

<h3>
<span id="テスト-1" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88-1"><i class="fa fa-link"></i></a>テスト</h3>

<p><code>FavoriteViewModel</code>はinitializerの引数として、<code>favoritesObservable: Observable&lt;[GithubKit.Repository]&gt;</code>と<code>selectedIndexPath: Observable&lt;IndexPath&gt;</code>を受け取っています。<br>
XCTestなどでテストを行う際に、それらを外部から注入してイベントを送ることで、ViewModelのプレゼンテーション層に関するロジックのテストが可能になります。<br>
テストメソッド内では該当するsubscribeのclosureに対して期待する結果を記述し、その後に紐づくPublishSubjectからイベントを送っています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModelTests</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FavoriteViewModelTests</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">favorites</span><span class="p">:</span> <span class="n">PublishSubject</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;!</span>
    <span class="kd">var</span> <span class="nv">selectedIndexPath</span><span class="p">:</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="n">IndexPath</span><span class="p">&gt;</span><span class="o">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span> <span class="p">=</span> <span class="n">FavoriteViewModel</span><span class="p">(</span><span class="n">favoritesObservable</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">favorites</span><span class="p">,</span>
                                           <span class="n">selectedIndexPath</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">selectedIndexPath</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testRelaodData</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testReloadData expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">relaodData</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
            <span class="p">})</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="n">favorites</span><span class="p">.</span><span class="n">onNext</span><span class="p">([</span><span class="n">repository</span><span class="p">])</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testSelectedRepository</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testSelectedRepository expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">repo</span> <span class="k">in</span>
                <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
                <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
            <span class="p">})</span>

        <span class="n">favorites</span><span class="p">.</span><span class="n">onNext</span><span class="p">([</span><span class="n">repository</span><span class="p">])</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h3>
<span id="考察-1" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F-1"><i class="fa fa-link"></i></a>考察</h3>

<p>ViewとViewModelはData bindingによってやり取りが行われるため、ViewはViewModelの参照を持ちますがViewModelは直接的にViewに依存はしません。<br>
また、ViewModelのinputに対して擬似的にユーザーのアクションをイベントとして送り、ViewModelのoutputのイベントを確認することでプレゼンテーション層に関するロジックのテストが可能です。<br>
そういった利点がある一方で、標準フレームワークだけでData bindingを実現することは容易ではありません。<br>
NotificationCenterやKVOを利用することで近しいものは実装できますが、取得できる値の型がAnyになってしまうという問題があります。<br>
また、propertyのdidSetでdelegateのメソッドを呼ぶことで近しい実装もできますが、delegateのオブジェクトは基本的に1つなので複数にしたい場合はforwardInvocationを利用する必要があったりしてしまいます。</p>

<h2>
<span id="flux" class="fragment"></span><a href="#flux"><i class="fa fa-link"></i></a>Flux</h2>

<p>最後に、Fluxによる実装について書いていきます。</p>

<p><a href="https://camo.qiitausercontent.com/66bcf84aea21aa00d294c3e20b5192753b26a2ec/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38303265616335642d386563372d353937642d656539322d6537333730643037343233392e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/66bcf84aea21aa00d294c3e20b5192753b26a2ec/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38303265616335642d386563372d353937642d656539322d6537333730643037343233392e6a706567" width="50%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/802eac5d-8ec7-597d-ee92-e7370d074239.jpeg"></a></p>

<p>Fluxのパーツとして</p>

<ul>
<li>
<strong>Action</strong>...Viewからイベントを処理し、Dispatcherに値を流します。</li>
<li>
<strong>Dispatcher</strong>...Actionから受け取った値を、Storeに流します。</li>
<li>
<strong>Store</strong>...Dispatcherから受け取った値を保持し、値の変更を通知します。</li>
<li>
<strong>View</strong>...ユーザーかの操作によってActionを実行し、Storeの変更を反映します。</li>
</ul>

<p>があります。<br>
それらは、<strong>View → Action → Dispather → Store → View</strong>という形で単一方向のデータフローになっています。<br>
ActionはどのViewからでも実行ができ、StoreはどのViewから参照されたとしても値を取得することができます。</p>

<p>このサンプルの場合、Fluxのパーツの構成は</p>

<ul>
<li>1つのDispatcher</li>
<li>ActionとStoreが一対一の組み合わせが複数</li>
</ul>

<p>となっています。</p>

<p>また、ViewControllerごとにActionやStoreがあるわけではなく</p>

<ul>
<li><code>GithubのRepositoryに関するActionとStore</code></li>
<li><code>GithubのUserに関するActionとStore</code></li>
</ul>

<p>という作りになっています。</p>

<p>※Action、Dispatcher、Storeの実装を簡易化するために、<a href="https://github.com/marty-suzuki/FluxCapacitor" rel="nofollow noopener" target="_blank">FluxCapacitor</a>を利用しています。</p>

<h3>
<span id="画面遷移-2" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB-2"><i class="fa fa-link"></i></a>画面遷移</h3>

<p><code>UITableViewDataSource</code>や<code>UITableViewDelegate</code>の実装を、<code>FavoriteViewController</code>の場合は<code>FavoriteViewDataSource</code>に移しています。<br>
<code>FavoriteViewDataSource</code>内の<code>tableView(_:didSelectRowAt:)</code>では、<code>RepositoryStore</code>から該当の<code>GithubKit.Repository</code>を取得し、<code>RepositoryAction</code>の<code>selectRepository(_:)</code>に渡されています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewDataSource</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewDataSource</span><span class="p">:</span> <span class="bp">NSObject</span><span class="p">,</span> <span class="bp">UITableViewDelegate</span><span class="p">,</span> <span class="p">...</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">(),</span>
         <span class="n">action</span><span class="p">:</span> <span class="n">RepositoryAction</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">())</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">action</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">favoritesValue</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]</span>
        <span class="n">action</span><span class="p">.</span><span class="n">selectRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryAction</code>は受け取った<code>GithubKit.Repository</code>を<code>Dispatcher</code>に渡し、<code>RepositoryStore</code>は<code>Dispatcher</code>から<code>GithubKit.Repository</code>を受け取ります。<br>
受け取った<code>GithubKit.Repository</code>は<code>_selectedRepository: Variable&lt;GithubKit.Repository?&gt;</code>に保持されます。<br>
<code>selectedRepository: Observable&lt;GithubKit.Repository?&gt;</code>が外部に公開されているので、値が更新された際にイベントが流れます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryFluxFlow</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryAction</span><span class="p">:</span> <span class="n">Actionable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">selectRepository</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">invoke</span><span class="p">(.</span><span class="n">selectedRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">Dispatcher</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">Repository</span><span class="p">:</span> <span class="n">DispatchValue</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">case</span> <span class="n">selectedRepository</span><span class="p">(</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">?)</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryStore</span><span class="p">:</span> <span class="n">Storable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">let</span> <span class="nv">selectedRepository</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">?</span><span class="o">&gt;</span>
    <span class="kd">var</span> <span class="nv">selectedRepositoryValue</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_selectedRepository</span><span class="p">.</span><span class="n">value</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_selectedRepository</span> <span class="p">=</span> <span class="n">Variable</span><span class="p">&lt;</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">?</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">:</span> <span class="n">Dispatcher</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">selectedRepository</span> <span class="p">=</span> <span class="n">_selectedRepository</span><span class="p">.</span><span class="n">asObservable</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="n">register</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="nv">$0</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">selectedRepository</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
                <span class="kc">self</span><span class="p">?.</span><span class="n">_selectedRepository</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">value</span>
            <span class="p">...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewController</code>では、<code>RepositoryStore</code>の<code>selectedRepository: Observable&lt;GithubKit.Repository?&gt;</code>から流れてきたイベントを受け取り、そのイベントの値をVoidに変換して、<code>showRepository: AnyObserver&lt;Void&gt;</code>にbindします。<br>
ViewControllerの遷移時、他のデザインパターンと異なる部分になるのですが、<code>RepositoryViewController</code>のinitializerは引数として<code>GithubKit.Repository</code>を渡していません。</p>

<p>※store.selectedRepositoryはviewDidAppear時にsubscribeされ、viewDidDisappear時にdisposeされる実装がされています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span>

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">dataSource</span> <span class="p">=</span> <span class="n">FavoriteViewDataSource</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe store</span>
        <span class="n">rx</span><span class="p">.</span><span class="n">methodInvoked</span><span class="p">(</span><span class="k">#selector</span><span class="p">(</span><span class="n">FavoriteViewController</span><span class="p">.</span><span class="n">viewDidAppear</span><span class="p">(</span><span class="kc">_</span><span class="p">:)))</span>
            <span class="p">.</span><span class="n">flatMapLatest</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="kc">_</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="k">in</span>
                <span class="k">guard</span> <span class="kd">let</span> <span class="nv">me</span> <span class="p">=</span> <span class="kc">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">}</span>
                <span class="kd">let</span> <span class="nv">viewWillDisappear</span> <span class="p">=</span> <span class="n">me</span><span class="p">.</span><span class="n">rx</span>
                    <span class="p">.</span><span class="n">sentMessage</span><span class="p">(</span><span class="k">#selector</span><span class="p">(</span><span class="n">FavoriteViewController</span><span class="p">.</span><span class="n">viewDidDisappear</span><span class="p">(</span><span class="kc">_</span><span class="p">:)))</span>
                <span class="k">return</span> <span class="n">me</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">selectedRepository</span>
                    <span class="p">.</span><span class="n">takeUntil</span><span class="p">(</span><span class="n">viewWillDisappear</span><span class="p">)</span>
                    <span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">}</span>
                    <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">showRepository</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">showRepository</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">vc</span> <span class="p">=</span> <span class="n">RepositoryViewController</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="n">me</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>GithubKit.Repository</code>を引数として渡す必要がない理由として、<code>FavoriteViewDataSource</code>内の<code>tableView(_:didSelectRowAt:)</code>で<code>RepositoryStore</code>の<code>_selectedRepository: Variable&lt;GithubKit.Repository?&gt;</code>に保持されています。<br>
そのため、<code>store.selectedRepositoryValue</code>として値を取り出すことで、該当の<code>GithubKit.Repository</code>を受け取ることができます。<br>
ViewController内で実際に利用する場合、<code>store.selectedRepository</code>を<code>Observable&lt;GithubKit.Repository&gt;</code>に変換して利用します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoriteButtonItem</span> <span class="p">=</span> <span class="bp">UIBarButtonItem</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span>

    <span class="kd">init</span><span class="p">?()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">store</span> <span class="p">=</span> <span class="n">RepositoryStore</span><span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepositoryValue</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe store</span>
        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">}</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">!</span> <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>上記のTableViewのCellが選択されてから、次のViewControllerに遷移するまでの流れは下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/39c2e0e012b1047ee48940014e73d0c4200563ca/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f37343863383833622d633732312d396439632d646363342d3565653065613964623632612e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/39c2e0e012b1047ee48940014e73d0c4200563ca/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f37343863383833622d633732312d396439632d646363342d3565653065613964623632612e6a706567" alt="Flux.002.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/748c883b-c721-9d9c-dcc4-5ee0ea9db62a.jpeg"></a></p>

<h3>
<span id="お気に入りに追加-2" class="fragment"></span><a href="#%E3%81%8A%E6%B0%97%E3%81%AB%E5%85%A5%E3%82%8A%E3%81%AB%E8%BF%BD%E5%8A%A0-2"><i class="fa fa-link"></i></a>お気に入りに追加</h3>

<p><code>store.selectedRepository</code>を<code>Observable&lt;GithubKit.Repository&gt;</code>に変換した<code>noNilRepository</code>を利用します。<br>
<code>noNilRepository</code>と<code>store.favorites</code>をcombineLatestし、<strong>favoritesに<code>GithubKit.Repository</code>が含まれているか</strong>と<strong><code>GithubKit.Repository</code></strong>に変換したものを<code>containsRepository: Observable&lt;(Bool, Repository)&gt;</code>とします。<br>
<code>favoriteButtonItem.rx.tap</code>のイベントが渡ってきたら、withLatestFromで<code>containsRepository</code>の最新状態を取得します。<br>
そのイベントをsubscribeし、<code>GithubKit.Repository</code>が含まれていたら<code>action.removeFavorite(:_)</code>、含まれていなかったら<code>action.addFavorite(_:)</code>を実行します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryViewController</span><span class="p">:</span> <span class="n">SFSafariViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">favoriteButtonItem</span> <span class="p">=</span> <span class="bp">UIBarButtonItem</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span>

    <span class="kd">init</span><span class="p">?(</span><span class="n">action</span><span class="p">:</span> <span class="n">RepositoryAction</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">(),</span>
         <span class="n">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepositoryValue</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">action</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">entersReaderIfAvailable</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="c1">// observe store</span>
        <span class="kd">let</span> <span class="nv">noNilRepository</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">}</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">!</span> <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">containsRepository</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">.</span><span class="n">combineLatest</span><span class="p">(</span><span class="n">noNilRepository</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">favorites</span><span class="p">)</span>
            <span class="p">{</span> <span class="n">repo</span><span class="p">,</span> <span class="n">favs</span> <span class="k">in</span> <span class="p">(</span><span class="n">favs</span><span class="p">.</span><span class="bp">contains</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">repo</span><span class="p">.</span><span class="n">url</span> <span class="p">},</span> <span class="n">repo</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">favoriteButtonItem</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">tap</span>
            <span class="p">.</span><span class="n">withLatestFrom</span><span class="p">(</span><span class="n">containsRepository</span><span class="p">)</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="bp">contains</span><span class="p">,</span> <span class="n">repository</span> <span class="k">in</span>
                <span class="k">if</span> <span class="bp">contains</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">?.</span><span class="n">action</span><span class="p">.</span><span class="n">removeFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">?.</span><span class="n">action</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>RepositoryAction</code>の<code>addFavorite(_:)</code>または<code>removeFavorite(_:)</code>が呼ばれるとDispatcherを介し、<code>GithubKit.Repository</code>を<code>RepositoryStore</code>で受け取ります。<br>
<code>RepositoryStore</code>では、<code>addFavorite</code>の場合はfavoritesに追加をし、<code>reomveFavorite</code>の場合はfavoritesから削除をします。<br>
それらの更新イベントを、外部に公開されている<code>favorites: Observable&lt;[GithubKit.Repository]&gt;</code>に流します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RepositoryFluxFlow</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryAction</span><span class="p">:</span> <span class="n">Actionable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">addFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">invoke</span><span class="p">(.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">removeFavorite</span><span class="p">(</span><span class="kc">_</span> <span class="n">repository</span><span class="p">:</span> <span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">invoke</span><span class="p">(.</span><span class="n">removeFavorite</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">Dispatcher</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">Repository</span><span class="p">:</span> <span class="n">DispatchValue</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">case</span> <span class="n">addFavorite</span><span class="p">(</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">removeFavorite</span><span class="p">(</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryStore</span><span class="p">:</span> <span class="n">Storable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>
    <span class="p">...</span>
    <span class="kd">let</span> <span class="nv">favorites</span><span class="p">:</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span>
    <span class="kd">var</span> <span class="nv">favoritesValue</span><span class="p">:</span> <span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_favorites</span><span class="p">.</span><span class="n">value</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_favorites</span> <span class="p">=</span> <span class="n">Variable</span><span class="o">&lt;</span><span class="p">[</span><span class="n">GithubKit</span><span class="p">.</span><span class="n">Repository</span><span class="p">]</span><span class="o">&gt;</span><span class="p">([])</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">:</span> <span class="n">Dispatcher</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">favorites</span> <span class="p">=</span> <span class="n">_favorites</span><span class="p">.</span><span class="n">asObservable</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">selectedRepository</span> <span class="p">=</span> <span class="n">_selectedRepository</span><span class="p">.</span><span class="n">asObservable</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="n">register</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="nv">$0</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="kc">self</span><span class="p">?.</span><span class="n">_favorites</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">value</span><span class="p">.</span><span class="n">url</span> <span class="p">})</span> <span class="p">==</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">?.</span><span class="n">_favorites</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">removeFavorite</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">index</span> <span class="p">=</span> <span class="kc">self</span><span class="p">?.</span><span class="n">_favorites</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">url</span> <span class="p">==</span> <span class="n">value</span><span class="p">.</span><span class="n">url</span> <span class="p">})</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">?.</span><span class="n">_favorites</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewController</code>では<code>RepositoryStore</code>の<code>favorites</code>のイベントを受け取ると、Voidに変換し<code>reloadData: AnyObserver&lt;Void&gt;</code>にbindします。<br>
すると<code>tableView.reloadData()</code>を実行され、<code>FavoriteViewController</code>上でリストが更新されます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">!</span> 

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">dataSource</span> <span class="p">=</span> <span class="n">FavoriteViewDataSource</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="n">store</span><span class="p">.</span><span class="n">favorites</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">reloadData</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">reloadData</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="n">me</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>お気に入りに追加/削除される流れは下図のようになります。</p>

<p><code>RepositoryStore</code>はどこからでも参照が可能なので、<code>FavoriteViewController</code>からの遷移時に<code>RepositoryViewController</code>のinitializerの引数として渡す必要がありません。<br>
<code>RepositoryViewController</code>では、<code>RepositoryStore</code>の<code>favorites</code>に<code>RepositoryStore</code>の<code>selectedRepository</code>が含まれているかを確認し、<code>RepositoryAction</code>から追加または削除を実行します。<br>
その結果が<code>RepositoryStore</code>に反映され、公開している<code>favorites: Observable&lt;[GithubKit.Repositor]&gt;</code>にイベントが流れます。<br>
favoritesの更新イベントを<code>FavoriteViewController</code>内で<code>Observable&lt;Void&gt;</code>に変換し<code>reloadData: AnyObserver&lt;Void&gt;</code>にbindされ、<code>tableView.reloadData()</code>が実行されるので<code>FavoriteViewController</code>上でリストが更新されます。</p>

<p><a href="https://camo.qiitausercontent.com/9d106455cc47d4dd544e76ed9f3306c2c5905291/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38633033323163362d303431342d643066342d643961632d3166313862663964666431622e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/9d106455cc47d4dd544e76ed9f3306c2c5905291/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38633033323163362d303431342d643066342d643961632d3166313862663964666431622e6a706567" alt="Flux.003.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/8c0321c6-0414-d0f4-d9ac-1f18bf9dfd1b.jpeg"></a></p>

<h3>
<span id="テスト-2" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88-2"><i class="fa fa-link"></i></a>テスト</h3>

<p>下記のようにXCTestなどで、<code>RepositoryAction</code>で渡した値が<code>RepositorStore</code>に反映されるのかのテストを実行することができます。<br>
テストメソッド内では該当するStore内のObservableをsubscribeし、closureに対して期待する結果を記述します。<br>
その後に紐づくActionのメソットを実行しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">RepositoryFluxFlowTestCase</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">RepositoryStore</span><span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testSelectedRepository</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testSelectedRepository expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">selectedRepository</span>
            <span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="kd">let</span> <span class="nv">selectedRepository</span> <span class="p">=</span> <span class="nv">$0</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">XCTFail</span><span class="p">()</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">selectedRepository</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
                <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
            <span class="p">})</span>

        <span class="n">action</span><span class="p">.</span><span class="n">invoke</span><span class="p">(.</span><span class="n">selectedRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div>

<p>またActionではメソッドの引数として受け取った値をdispatchするだけではなく、通信を行ってその結果をdispatchする場合もあります。<br>
その場合、Actionのinitializerで通信用のモジュールをprotocolとして抽象化したものを引数として受け取ることで、通信結果の値がStoreに反映されるかのテストをすることができるようになります。<br>
下記の例の場合は、<code>ApiSessionType</code>として通信用のモジュールを抽象化し、<code>func send&lt;T: Request&gt;(_ request: T) -&gt; Observable&lt;Response&lt;T.ResponseType&gt;&gt;</code>を宣言しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">protocol</span> <span class="nc">ApiSessionType</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Request</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">request</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Response</span><span class="p">&lt;</span><span class="n">T</span><span class="p">.</span><span class="n">ResponseType</span><span class="p">&gt;</span><span class="o">&gt;</span> 
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">RepositoryAction</span><span class="p">:</span> <span class="n">Actionable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">DispatchValueType</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">Repository</span>

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">session</span><span class="p">:</span> <span class="n">ApiSessionType</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">ApiSessionType</span> <span class="p">=</span> <span class="n">ApiSession</span><span class="p">.</span><span class="n">shared</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">session</span> <span class="p">=</span> <span class="n">session</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">func</span> <span class="nf">fetchRepositories</span><span class="p">(</span><span class="n">withUserId</span> <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="nb">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="n">UserNodeRequest</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="n">after</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
                <span class="kc">self</span><span class="p">?.</span><span class="n">invoke</span><span class="p">(.</span><span class="n">lastPageInfo</span><span class="p">(</span><span class="nv">$0</span><span class="p">.</span><span class="n">pageInfo</span><span class="p">))</span>
                <span class="kc">self</span><span class="p">?.</span><span class="n">invoke</span><span class="p">(.</span><span class="n">addRepositories</span><span class="p">(</span><span class="nv">$0</span><span class="p">.</span><span class="n">nodes</span><span class="p">))</span>
                <span class="kc">self</span><span class="p">?.</span><span class="n">invoke</span><span class="p">(.</span><span class="n">repositoryTotalCount</span><span class="p">(</span><span class="nv">$0</span><span class="p">.</span><span class="n">totalCount</span><span class="p">))</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div>

<p><code>ApiSessionType</code>を採用している<code>ApiSessionMock</code>では、<code>result: ApiSession.Result&lt;Any&gt;?</code>として通信の擬似的な結果を外部から設定できるようになっています。<br>
<code>ApiSessionMock</code>で<code>func send&lt;T: Request&gt;(_ request: T) -&gt; Observable&lt;Response&lt;T.ResponseType&gt;&gt;</code>を実装する際に、resultのAssociated ValueをObservableにラップして返しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ApiSessionMock</span><span class="p">:</span> <span class="n">ApiSessionType</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">Error</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">Error</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">requestFailed</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nv">result</span><span class="p">:</span> <span class="n">ApiSession</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="nb">Any</span><span class="p">&gt;?</span>

    <span class="kd">func</span> <span class="nf">send</span><span class="p">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Request</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">request</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Response</span><span class="p">&lt;</span><span class="n">T</span><span class="p">.</span><span class="n">ResponseType</span><span class="p">&gt;</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span> <span class="k">as</span> <span class="n">Response</span><span class="p">&lt;</span><span class="n">T</span><span class="p">.</span><span class="n">ResponseType</span><span class="p">&gt;)?:</span>
            <span class="k">return</span> <span class="p">.</span><span class="n">just</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">Error</span><span class="p">.</span><span class="n">requestFailed</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p><code>RepositoryFluxFlowTestCase</code>で<code>RepositoryAction</code>を初期化する際に、引数として<code>ApiSessionMock</code>のインスタンスを渡します。<br>
<code>testFetchRepositories()</code>では、まず通信の擬似的な結果をsession.resultに設定します。<br>
そして、storeで保持している値から更新イベントを受け取った際に期待する結果をsubscribe内に記述します。<br>
最後に、<code>action.fetchRepositories(withUserId:, after:)</code>を呼んでテストを行います。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">RepositoryFluxFlowTestCase</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">session</span><span class="p">:</span> <span class="n">ApiSessionMock</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">session</span> <span class="p">=</span> <span class="n">ApiSessionMock</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">session</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">RepositoryStore</span><span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testFetchRepositories</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testFetchRepositories expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">pageInfo</span> <span class="p">=</span> <span class="n">PageInfo</span><span class="p">.</span><span class="n">mock</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">totalCount</span> <span class="p">=</span> <span class="mi">10</span>
        <span class="kd">let</span> <span class="nv">response</span> <span class="p">=</span> <span class="n">Response</span><span class="p">&lt;</span><span class="n">Repository</span><span class="p">&gt;(</span><span class="n">nodes</span><span class="p">:</span> <span class="p">[</span><span class="n">repository</span><span class="p">],</span> <span class="n">pageInfo</span><span class="p">:</span> <span class="n">pageInfo</span><span class="p">,</span> <span class="n">totalCount</span><span class="p">:</span> <span class="n">totalCount</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="n">result</span> <span class="p">=</span> <span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span>
            <span class="n">Observable</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">repositories</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                           <span class="n">store</span><span class="p">.</span><span class="n">lastPageInfo</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                           <span class="n">store</span><span class="p">.</span><span class="n">repositoryTotalCount</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">repositories</span><span class="p">,</span> <span class="n">lastPageInfo</span><span class="p">,</span> <span class="n">repositoryTotalCount</span> <span class="k">in</span>
                    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">firstRepository</span> <span class="p">=</span> <span class="n">repositories</span><span class="p">.</span><span class="bp">first</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">lastPageInfo</span> <span class="p">=</span> <span class="n">lastPageInfo</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">XCTFail</span><span class="p">()</span>
                        <span class="k">return</span>
                    <span class="p">}</span>
                    <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">firstRepository</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
                    <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">lastPageInfo</span><span class="p">.</span><span class="n">hasNextPage</span><span class="p">,</span> <span class="n">pageInfo</span><span class="p">.</span><span class="n">hasNextPage</span><span class="p">)</span>
                    <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">repositoryTotalCount</span><span class="p">,</span> <span class="n">totalCount</span><span class="p">)</span>
                    <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
                <span class="p">})</span>

        <span class="n">action</span><span class="p">.</span><span class="n">fetchRepositories</span><span class="p">(</span><span class="n">withUserId</span><span class="p">:</span> <span class="s">"marty-suzuki"</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="考察-2" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F-2"><i class="fa fa-link"></i></a>考察</h3>

<p>Fluxではデータフローが単一方向になるので</p>

<ul>
<li>Actionではメソットの呼び出し</li>
<li>Storeから値を参照</li>
</ul>

<p>という形で責務を明確にすることができます。<br>
そういった良い部分もある中で</p>

<ul>
<li>プレゼンテーション層に関するロジックがViewControllerに実装されがち</li>
<li>Dispatcherはシングルトンで実装される（場合によってはStoreも）</li>
</ul>

<p>という懸念点もあります。</p>

<h1>
<span id="to-be-continued" class="fragment"></span><a href="#to-be-continued"><i class="fa fa-link"></i></a>To Be Continued</h1>

<p>番外編としてFluxとMVVMを組み合わせた実装に関しての資料を紹介だけさせていただいていました。<br>
9/7に開催されたBrooklyn Swift Developersというmeetupでの登壇資料です。</p>

<blockquote class="twitter-tweet">
<p>Thank you for giving me a great opportunity to talk in an international meetup! <br>This is my talk slide! <a href="https://twitter.com/BKLNSwift" rel="nofollow noopener" target="_blank">@BKLNSwift</a><a href="https://t.co/NFDWMBgbwT" rel="nofollow noopener" target="_blank">https://t.co/NFDWMBgbwT</a></p>— marty-suzuki (@marty_suzuki) <a href="https://twitter.com/marty_suzuki/status/906011781050449921" rel="nofollow noopener" target="_blank">September 8, 2017</a>
</blockquote>



<p>またFluxとMVVMを組み合わせた実装のサンプルは下記のURLからご覧いただけます。<br>
<a href="https://github.com/marty-suzuki/FluxCapacitor/tree/master/Examples/Flux%2BMVVM" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/marty-suzuki/FluxCapacitor/tree/master/Examples/Flux%2BMVVM</a></p>

<h2>
<span id="flux--mvvm" class="fragment"></span><a href="#flux--mvvm"><i class="fa fa-link"></i></a>Flux &amp; MVVM</h2>

<p>Fluxではプレゼンテーション層に関するロジックがViewControllerに実装されがちですが、そこにViewModelを挟むことによって改善されます。<br>
まず、<code>FavoriteViewController</code>でのFlux単体でのデータフローは下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/85d95d85b34efdfac49fa99453b2ff1317c22278/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38383235316462302d653530642d303762632d303835342d3430616336623734316464612e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/85d95d85b34efdfac49fa99453b2ff1317c22278/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f38383235316462302d653530642d303762632d303835342d3430616336623734316464612e6a706567" alt="flux_mvvm.001.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/88251db0-e50d-07bc-0854-40ac6b741dda.jpeg"></a></p>

<p>そこにViewModelを挟むと下図のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/b5a4e8b50aaba7bcf88423685d5073921dd660e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f63323139643130302d313862372d626561302d626239612d3563613038363939633563382e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b5a4e8b50aaba7bcf88423685d5073921dd660e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f63323139643130302d313862372d626561302d626239612d3563613038363939633563382e6a706567" alt="flux_mvvm.002.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/c219d100-18b7-bea0-bb9a-5ca08699c5c8.jpeg"></a></p>

<p><code>FavoriteViewModel</code>では<code>RepositoryStore</code>で公開されているObservableを変換して、<code>reloadData: Observable&lt;Void&gt;</code>として外部に公開します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModel</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>

    <span class="kd">let</span> <span class="nv">reloadData</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_reloadData</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">showRepository</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_showRepository</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;()</span>
    <span class="p">...</span>
    <span class="kd">init</span><span class="p">(...,</span>
         <span class="n">store</span><span class="p">:</span> <span class="n">RepositoryStore</span> <span class="p">=</span> <span class="p">.</span><span class="n">instantiate</span><span class="p">(),</span>
         <span class="p">...)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">reloadData</span> <span class="p">=</span> <span class="n">_reloadData</span>
        <span class="p">...</span>
        <span class="n">store</span><span class="p">.</span><span class="n">favorites</span>
            <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">_reloadData</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p><code>FavoriteViewController</code>では<code>FavoriteViewModel</code>で公開されているreloadDataを<code>reloadData: AnyObserver&lt;Void&gt;</code>にbindし、<code>tableView.reloadData()</code>を実行します。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewController</span></div>
<div class="highlight"><pre><span></span><span class="kr">final</span> <span class="kd">class</span> <span class="nc">FavoriteViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">disposeBag</span> <span class="p">=</span> <span class="n">DisposeBag</span><span class="p">()</span>
    <span class="p">...</span>
    <span class="kd">private</span><span class="p">(</span><span class="kr">set</span><span class="p">)</span> <span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span> <span class="p">=</span> <span class="p">{</span>
       <span class="p">...</span>
    <span class="p">}()</span>
    <span class="p">...</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="n">viewModel</span><span class="p">.</span><span class="n">reloadData</span>
            <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">reloadData</span><span class="p">)</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">reloadData</span><span class="p">:</span> <span class="n">AnyObserver</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UIBindingObserver</span><span class="p">(</span><span class="n">UIElement</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">me</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="n">me</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}.</span><span class="n">asObserver</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>

<p>プレゼンテーション層のロジックがViewModelに実装されているため、ViewControllerではViewModelの公開されているObservableが該当のViewにbindされる実装になります。<br>
そのため、ViewControllerをTestCaseに置き換えることで、容易にテストするとこが可能になります。</p>

<p><a href="https://camo.qiitausercontent.com/c53278ada6187ed36f9dc8d7ea0db2b36e089582/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f62653130613038652d343339362d376531612d313537382d6362306364353531366536632e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c53278ada6187ed36f9dc8d7ea0db2b36e089582/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f62653130613038652d343339362d376531612d313537382d6362306364353531366536632e6a706567" alt="flux_mvvm.003.jpeg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/be10a08e-4396-7e1a-1578-cb0cd5516e6c.jpeg"></a></p>

<p><code>FavoriteViewModelTestCase</code>では、<code>FavoriteViewModel</code>のinitializerで<code>RepositoryAction</code>と<code>RepositoryStore</code>を渡しています。<br>
<code>testReloadData()</code>では、<code>RepositoryAction</code>の<code>addFavorite(_:)</code>に<code>Repository</code>を渡すと<code>viewModel.reloadData</code>が実行されるかのテストを行っています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">FavoriteViewModelTestCase</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FavoriteViewModelTestCase</span><span class="p">:</span> <span class="n">XCTestCase</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nv">action</span><span class="p">:</span> <span class="n">RepositoryAction</span><span class="p">!</span>
    <span class="kd">var</span> <span class="nv">store</span><span class="p">:</span> <span class="n">RepositoryStore</span><span class="p">!</span>
    <span class="p">...</span>
    <span class="kd">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="n">FavoriteViewModel</span><span class="p">!</span>
    <span class="p">...</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="p">...</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">RepositoryAction</span><span class="p">(...)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">store</span> <span class="p">=</span> <span class="n">RepositoryStore</span><span class="p">.</span><span class="n">instantiate</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span> <span class="p">=</span> <span class="n">FavoriteViewModel</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">store</span><span class="p">,</span> <span class="p">...)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">testReloadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">expectation</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="s">"testReloadData expectation"</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">disposable</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">reloadData</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">expectation</span><span class="p">.</span><span class="n">fulfill</span><span class="p">()</span>
            <span class="p">})</span>

        <span class="n">action</span><span class="p">.</span><span class="n">addFavorite</span><span class="p">(</span><span class="n">Repository</span><span class="p">.</span><span class="n">mock</span><span class="p">())</span>

        <span class="n">waitForExpectations</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h1>

<p>MVC、MVP、MVVM、Fluxを比較してきましたがどのデザインパターンが良いというわけではなく、<strong>"開発しているサービスにとってどのデザインパターンが必要十分なのか"</strong>が重要だと考えています。<br>
その要因はとして、アプリの規模だったり、アプリの性質だったり、開発している人数だったりと様々あるかと思います。<br>
また実際にプロジェクトに導入する際には、それぞれのデザインパターンの簡単なサンプルを実装してみないと良し悪しはわからず机上の空論にしかならなので、是非サンプルを作ってみてください。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>marty-suzukiさんの<br />2位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/marty-suzuki/items/e1fca887c1df961c8617">【Swift】APIのアクセストークンの処理でPhantomTypeを利用してみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-07 11:28:07</center>
	</td>
	<td style="width:200px;">
		@marty-suzuki<br />(CyberAgent, Inc. AbemaTV 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/60325/profile-images/1473695196">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[iOS]</b> <b>[Swift]</b> <b>[phantomtype]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>APIの通信周りの処理をframeworkとして別プロジェクトで管理したりする中で、APIリクエスト時のアクセストークンをアプリ側からタイプセーフに注入するとこができないかなと考えていました。<br>
そんな中で、<strong>PhantomType</strong>を活用すればうまくいくかもしれないと思い立ったので実践してみました。<br>
PhantomTypeやSwiftでの利用法については、「<a href="https://qiita.com/taketo1024/items/71e3272211f08d7e0cde" id="reference-b36a18fcfb22c0cc649b">Swift で Phantom Type (幽霊型)</a>」をご覧いただけると幸いです。</p>

<h1>
<span id="phantomtypeを利用したtokenを保持するオブジェクトの実装" class="fragment"></span><a href="#phantomtype%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9Ftoken%E3%82%92%E4%BF%9D%E6%8C%81%E3%81%99%E3%82%8B%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>PhantomTypeを利用したTokenを保持するオブジェクトの実装</h1>

<p>この投稿では、<a href="https://github.com/ishkawa/APIKit" rel="nofollow noopener" target="_blank">APIKit</a>を利用していきます。<br>
外部からtokenを注入する実装にすると、簡易的な利用例は下記のようになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">利用例</span></div>
<div class="highlight"><pre><span></span><span class="kd">enum</span> <span class="nc">UserRequest</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="nc">GetByID</span><span class="p">:</span> <span class="n">NetworkRequest</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="kd">let</span> <span class="nv">id</span><span class="p">:</span> <span class="nb">String</span>
        <span class="kd">let</span> <span class="nv">requiresAuthorization</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="kd">struct</span> <span class="nc">GetByIDs</span><span class="p">:</span> <span class="n">NetworkRequest</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="kd">let</span> <span class="nv">ids</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span>
        <span class="kd">let</span> <span class="nv">requiresAuthorization</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 初期化時の引数にInjectableTokenを返すクロージャーを渡す</span>
<span class="kd">let</span> <span class="nv">client</span> <span class="p">=</span> <span class="n">NetworkClient</span><span class="p">(</span><span class="n">injectToken</span><span class="p">:</span> <span class="p">{</span> <span class="n">InjectableToken</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="s">"Any Token"</span><span class="p">)</span> <span class="p">})</span>

<span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="n">UserRequest</span><span class="p">.</span><span class="n">GetByID</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="s">"1234ABCD"</span><span class="p">)</span>
<span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="c1">// do something</span>
<span class="p">}</span>
</pre></div>
</div>

<p>この例だけでは、NetworkClientの引数のinjectTokenで、tokenを引数にした<code>InjectableToken</code>を返しているだけの実装にしか見えないと思うので、内部でどのようにPhantomTypeが利用されているかを記述していこうと思います。</p>

<h2>
<span id="networkrequest" class="fragment"></span><a href="#networkrequest"><i class="fa fa-link"></i></a>NetworkRequest</h2>

<p>まずは、<code>APIKit.Request</code>を採用している<code>NetworkRequest</code> protocolを定義します。<br>
<code>NetworkRequest</code>では、APIにアクセスする際に認証情報が必要かどうかのpropertyが宣言されています。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">NetworkRequest.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">NetworkRequest</span><span class="p">:</span> <span class="n">Request</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">requiresAuthorization</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="injectabletoken" class="fragment"></span><a href="#injectabletoken"><i class="fa fa-link"></i></a>InjectableToken</h2>

<p>次に、トークンを注入するための<code>InjectableToken</code>を実装します。<br>
ここでPhantomTypeを利用していきます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">InjectableToken.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Status</span> <span class="p">{}</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">Ready</span><span class="p">:</span> <span class="n">Status</span> <span class="p">{}</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">NotReady</span><span class="p">:</span> <span class="n">Status</span> <span class="p">{}</span>

<span class="kd">public</span> <span class="kd">typealias</span> <span class="n">InjectableToken</span> <span class="p">=</span> <span class="n">InjectableToken_</span><span class="p">&lt;</span><span class="n">NotReady</span><span class="p">&gt;</span>

<span class="kd">enum</span> <span class="nc">InjectError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">emptyToken</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="nc">InjectableToken_</span><span class="p">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Status</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">_token</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">InjectableToken_</span> <span class="k">where</span> <span class="n">T</span> <span class="p">==</span> <span class="n">NotReady</span> <span class="p">{</span>
    <span class="c1">// structなので`public convenience init(token: String?)`と記載できない</span>
    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">_token</span><span class="p">:</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">readify</span><span class="p">&lt;</span><span class="n">U</span><span class="p">:</span> <span class="n">NetworkRequest</span><span class="p">&gt;(</span><span class="n">with</span> <span class="n">request</span><span class="p">:</span> <span class="n">U</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">InjectableToken_</span><span class="p">&lt;</span><span class="n">Ready</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">token</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">requiresAuthorization</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">_token</span> <span class="p">=</span> <span class="n">_token</span><span class="p">,</span> <span class="o">!</span><span class="n">_token</span><span class="p">.</span><span class="bp">isEmpty</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="n">InjectError</span><span class="p">.</span><span class="n">emptyToken</span>
            <span class="p">}</span>
            <span class="n">token</span> <span class="p">=</span> <span class="n">_token</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">token</span> <span class="p">=</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">_token</span><span class="p">:</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">InjectableToken_</span> <span class="k">where</span> <span class="n">T</span> <span class="p">==</span> <span class="n">Ready</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">token</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_token</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div>
</div>

<p>まず始めに<code>Status</code> protocolを宣言し、それらを採用している<code>Ready</code>と<code>NotReady</code>のenumを定義します。これらがトークンの状態を示す型になります。<br>
次にGenericType <code>T</code>を持つ<code>InjectableToken_</code>を定義します。TはStatusに準拠させます。InjectableToken_はprivateな<code>_token: String?</code>を持っています。<br>
そして、typealiasで<code>InjectableToken_</code>を<strong>InjectableToken = InjectableToken_&lt;NotReady&gt;</strong>とし、InjectableTokenを返すstatic functionを定義します。このよう実装することで、<code>InjectableToken(token: "Any Token")</code>のように初期化ができるようになります。<br>
function内では、InjectableToken_のMemberwise Initializerを利用して、_tokenを初期化しています。<br>
この時点で返されるのは、<strong>InjectableToken_&lt;NotReady&gt;</strong>なので、外部から<strong>_token</strong>にアクセスすることはできません。<br>
次に<strong>InjectableToken_&lt;Ready&gt;</strong>にするために <code>func readify(with:_) -&gt; InjectableToken_&lt;Ready&gt;</code>を定義します。<br>
上記を定義する際はTがNotReadyである場合にのみ利用したいので、InjectableToken_のextensionに定義します。<br>
readifyの中では、引数でNetworkRequestに準拠したオブジェクトが渡ってるので、<code>requiresAuthorization</code>がtrueの場合は_tokenが存在し空文字列でないことを確認し、<strong>InjectableToken_&lt;Ready&gt;</strong>として初期化してから返します。<code>requiresAuthorization</code>がfalseの場合はトークンが不要なので、_tokenをnilで初期化した<strong>InjectableToken_&lt;Ready&gt;</strong>を返します。<br>
そして、TがReadyの場合にのみアクセスできる<code>token: String?</code>をInjectableToken_のextensionに定義することで、リクエストに対する認証情報をタイプセーフな状態で保持したオブジェクトを実現することができるようになります。</p>

<p>実際に利用する際は下記のようになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">利用例</span></div>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="n">UserRequest</span><span class="p">.</span><span class="n">GetByID</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="s">"1234ABCD"</span><span class="p">)</span>

<span class="kd">let</span> <span class="nv">notReadyToken</span> <span class="p">=</span> <span class="n">InjectableToken</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="s">"Any Token"</span><span class="p">)</span>
<span class="bp">print</span><span class="p">(</span><span class="n">notReadyToken</span><span class="p">.</span><span class="n">token</span><span class="p">)</span> <span class="c1">// TがNotReadyなのでエラーになる</span>

<span class="k">do</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">readyToken</span> <span class="p">=</span> <span class="k">try</span> <span class="n">notReadyToken</span><span class="p">.</span><span class="n">readify</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="n">readyToken</span><span class="p">.</span><span class="n">token</span><span class="p">)</span> <span class="c1">// TがReadyなのでtokenにアクセスできる</span>
<span class="p">}</span> <span class="k">catch</span> <span class="kd">let</span> <span class="nv">error</span> <span class="p">{</span>
    <span class="c1">// requiresAuthorizationに対してtokenの状態が正しくなかった場合にエラーとなる</span>
<span class="p">}</span>
</pre></div>
</div>

<p>このような実装にすることによって、下記のようなことが実現できます。</p>

<ul>
<li>tokenの状態確認がリクエスト生成時ではなくリクエストを送る直前に行うことができるので、リクエスト自体にtokenの状態に関するエラーハンドリングをする必要がなくなる</li>
<li>InjectableToken_&lt;Ready&gt;はprivateなinitializerしか持っていないので、外部からtokenを注入させるためにはInjectableToken_&lt;NotReady&gt;からreadifyをしてInjectableToken_&lt;Ready&gt;を取得するという経路をたどらなければいけないという実装にできるので、InjectableToken_&lt;Ready&gt;に直接することはできずtokenの状態が保証される</li>
<li>InjectableToken_&lt;Ready&gt;でありtokenがnilでない場合はAPIアクセスに必要なトークンが存在していることを明確にでき、逆にInjectableToken_&lt;Ready&gt;でありtokenがnilである場合はAPIアクセスにトークンがそもそも必要でないことも明確にできる</li>
</ul>

<h1>
<span id="tokenを注入可能にするための実装" class="fragment"></span><a href="#token%E3%82%92%E6%B3%A8%E5%85%A5%E5%8F%AF%E8%83%BD%E3%81%AB%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Tokenを注入可能にするための実装</h1>

<h2>
<span id="requestproxy" class="fragment"></span><a href="#requestproxy"><i class="fa fa-link"></i></a>RequestProxy</h2>

<p>tokenを外部から注入できるようにするために、<code>RequestProxy</code>を実装していきます。<br>
RequestProxyを定義することで、NetworkRequestに準拠した各Requestでtokenを持たせる必要がなくなるので、tokenに関する処理を1つにまとめることができます。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">RequestProxy.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">struct</span> <span class="nc">RequestProxy</span><span class="p">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">NetworkRequest</span><span class="p">&gt;:</span> <span class="n">Request</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">request</span><span class="p">:</span> <span class="n">T</span>
    <span class="kd">let</span> <span class="nv">token</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>

    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">headerFields</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span> <span class="p">:</span> <span class="nb">String</span><span class="p">]</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">headerFields</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headerFields</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">token</span> <span class="p">=</span> <span class="n">token</span> <span class="p">{</span>
            <span class="n">headerFields</span><span class="p">[</span><span class="s">"Authorization"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"bearer </span><span class="si">\(</span><span class="n">token</span><span class="si">)</span><span class="s">"</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">headerFields</span>
    <span class="p">}</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">injectableToken</span><span class="p">:</span> <span class="n">InjectableToken_</span><span class="p">&lt;</span><span class="n">Ready</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">request</span> <span class="p">=</span> <span class="n">request</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">token</span> <span class="p">=</span> <span class="n">injectableToken</span><span class="p">.</span><span class="n">token</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">RequestProxy</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">Response</span> <span class="p">=</span> <span class="n">T</span><span class="p">.</span><span class="n">Response</span>
    <span class="p">...</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">method</span><span class="p">:</span> <span class="n">HTTPMethod</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">response</span><span class="p">(</span><span class="n">from</span> <span class="n">object</span><span class="p">:</span> <span class="nb">Any</span><span class="p">,</span> <span class="n">urlResponse</span><span class="p">:</span> <span class="n">HTTPURLResponse</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Response</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">object</span><span class="p">,</span> <span class="n">urlResponse</span><span class="p">:</span> <span class="n">urlResponse</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>RequestProxyはNetworkRequestに準拠したTをGenericTypeとし、RequestProxy自体はAPIKit.Requestに準拠しています。<br>
initializerの引数は<code>request: T</code>と<code>injectableToken: InjectableToken_&lt;Ready&gt;</code>で、requestはNetworkRequestをProxyし、injectableTokenは内部のtokenを利用しています。<br>
RequestProxyのtokenをAPIKit.Requestの必須propertyである<code>headerFields: [String : String]</code>を定義し、<code>request.headerFields</code>に対して<code>["Authorization" : "bearer \(token)"]</code>を追加しています。<br>
ここで利用しているtokenは<code>InjectableToken_&lt;Ready&gt;</code>から取得しているのものなので、nil・非nilに関わらず認証情報が必要かどうかとtokenが正しいかどうかをチェック済みのものになっています。<br>
そして、RequestProxyのextensionでAPIKit.Requestで定義されているものを一通りRequestProxyのrequestからProxyしていきます。</p>

<h2>
<span id="networkclient" class="fragment"></span><a href="#networkclient"><i class="fa fa-link"></i></a>NetworkClient</h2>

<p>APIにアクセスするためのクライアントの実装は下記のようになります。</p>

<div class="code-frame" data-lang="swift">
<div class="code-lang"><span class="bold">NetworkClient.swift</span></div>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kr">final</span> <span class="kd">class</span> <span class="nc">NetworkClient</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">struct</span> <span class="nc">Error</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">Error</span> <span class="p">{</span>
        <span class="kd">public</span> <span class="kd">let</span> <span class="nv">value</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">Error</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">injectToken</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">InjectableToken</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">session</span><span class="p">:</span> <span class="n">Session</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">injectToken</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">InjectableToken</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">URLSessionConfiguration</span> <span class="p">=</span> <span class="p">.</span><span class="k">default</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">adapter</span> <span class="p">=</span> <span class="n">URLSessionAdapter</span><span class="p">(</span><span class="n">configuration</span><span class="p">:</span> <span class="p">.</span><span class="k">default</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">session</span> <span class="p">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">adapter</span><span class="p">:</span> <span class="n">adapter</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">injectToken</span> <span class="p">=</span> <span class="n">injectToken</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">send</span><span class="p">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">NetworkRequest</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">request</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">.</span><span class="n">Response</span><span class="p">,</span> <span class="n">Error</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="p">())</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">injectableToken</span><span class="p">:</span> <span class="n">InjectableToken_</span><span class="p">&lt;</span><span class="n">Ready</span><span class="p">&gt;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">injectableToken</span> <span class="p">=</span> <span class="k">try</span> <span class="n">injectToken</span><span class="p">().</span><span class="n">readify</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="kd">let</span> <span class="nv">error</span> <span class="p">{</span>
            <span class="n">completion</span><span class="p">(.</span><span class="n">failure</span><span class="p">(</span><span class="n">Error</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">error</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">proxy</span> <span class="p">=</span> <span class="n">RequestProxy</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span> <span class="n">injectableToken</span><span class="p">:</span> <span class="n">injectableToken</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
                <span class="n">completion</span><span class="p">(.</span><span class="n">success</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">failure</span><span class="p">(</span><span class="kd">let</span> <span class="nv">error</span><span class="p">):</span>
                <span class="n">completion</span><span class="p">(.</span><span class="n">failure</span><span class="p">(</span><span class="n">Error</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">error</span><span class="p">)))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>initializerの引数である<code>injectToken: @escaping () -&gt; InjectableToken</code>は、InjectableTokenが<code>InjectableToken_&lt;NotReady&gt;</code>としてtypealiasされているものになります。<br>
このクロージャーをリクエストを送信する直前に<code>let injectableToken = try injectToken().readify(with: request)</code>として、アプリ側からtokenを取得し、readifyでrequestをもとに認証情報が必要なリクエストなのかとtokenが正しいものなのかをチェックし、InjectableToken_&lt;Ready&gt;なinjectableTokenを取得します。<br>
そして、injectableTokenとrequestをもとにRequestProxyを初期化し、tokenを注入してリクエストを行います。</p>

<h1>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h1>

<p>ふと思い立って実践してみたので不備がある箇所があるかもしれませんが、このようにしてアクセストークンをPhantomTypeを利用してタイプセーフに注入することができます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>marty-suzukiさんの<br />3位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/marty-suzuki/items/f3dcab7624c9079d74ab">safeAreaInsetsの変更を感知する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-16 12:18:09</center>
	</td>
	<td style="width:200px;">
		@marty-suzuki<br />(CyberAgent, Inc. AbemaTV 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/60325/profile-images/1473695196">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[iOS]</b> <b>[ios11]</b> <b>[Xcode9]</b> <b>[iPhoneX]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>iPhone Xの登場により、Xcode 9から<a href="https://developer.apple.com/documentation/uikit/uiview/positioning_content_relative_to_the_safe_area" rel="nofollow noopener" target="_blank">Safe Area</a>の概念が登場しました。<br>
safeAreaInsets自体は<code>view.safeAreaInsets</code>で取得可能ですが、画面回転やStatusBarの表示/非表示時などにsafeAreaInsetsに変更があった場合、どのようして感知すればの良いのかをメモ程度に書いていきます。</p>

<h1>
<span id="safeareainsetsの変更を感知する方法" class="fragment"></span><a href="#safeareainsets%E3%81%AE%E5%A4%89%E6%9B%B4%E3%82%92%E6%84%9F%E7%9F%A5%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>safeAreaInsetsの変更を感知する方法</h1>

<p>この投稿では3つの方法を紹介しようと思います。</p>

<h2>
<span id="uiviewのsubclass" class="fragment"></span><a href="#uiview%E3%81%AEsubclass"><i class="fa fa-link"></i></a>UIViewのsubclass</h2>

<p>下記のようにUIViewのsubclassで、safeAreaInsetsの変更を感知できるようにしようと思います。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>    
        <span class="p">(</span><span class="n">view</span> <span class="k">as</span><span class="p">?</span> <span class="n">SafeAreaView</span><span class="p">)?.</span><span class="n">didChangeSafeAreaInsets</span> <span class="p">=</span> <span class="p">{</span> <span class="n">insets</span> <span class="k">in</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">"view.safeAreaInsets = </span><span class="si">\(</span><span class="n">insets</span><span class="si">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h3>

<p>下記のようにUIViewのsubclassを作成し、<code>func safeAreaInsetsDidChange()</code>をoverrideして、変更を感知できるようにしています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">SafeAreaView</span><span class="p">:</span> <span class="bp">UIView</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">didChangeSafeAreaInsets</span><span class="p">:</span> <span class="p">((</span><span class="bp">UIEdgeInsets</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())?</span>

    <span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">safeAreaInsetsDidChange</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">safeAreaInsetsDidChange</span><span class="p">()</span>
        <span class="n">didChangeSafeAreaInsets</span><span class="p">?(</span><span class="n">safeAreaInsets</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>StoryboardのIdentity Inspectorから、ViewControllerのviewをUIViewからSafeAreaViewに変更します。</p>

<p><a href="https://camo.qiitausercontent.com/e6e14b3726054fea923e289cc3eaa678df5d41f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f39323739316565392d346165302d356161372d646364352d6163363935336666333139342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e6e14b3726054fea923e289cc3eaa678df5d41f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f36303332352f39323739316565392d346165302d356161372d646364352d6163363935336666333139342e706e67" alt="スクリーンショット 2017-10-14 12.16.58.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/60325/92791ee9-4ae0-5aa7-dcd5-ac6953ff3194.png"></a></p>

<p>この方法を利用する場合、UIScrollView、UITableView...などそれぞれでsubclassを実装する必要があります。</p>

<h2>
<span id="uiviewを拡張" class="fragment"></span><a href="#uiview%E3%82%92%E6%8B%A1%E5%BC%B5"><i class="fa fa-link"></i></a>UIViewを拡張</h2>

<p>下記のようにUIViewのextensionで、safeAreaInsetsの変更を感知できるようにしようと思います。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>    
        <span class="n">view</span><span class="p">.</span><span class="n">safeArea</span><span class="p">.</span><span class="n">insetsDidChange</span> <span class="p">=</span> <span class="p">{</span> <span class="n">insets</span> <span class="k">in</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">"view.safeAreaInsets = </span><span class="si">\(</span><span class="n">insets</span><span class="si">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="実装-1" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85-1"><i class="fa fa-link"></i></a>実装</h3>

<p>まずは、Safe Areaに関するextensionをName Speceで区別できるよう、<code>SafeAreaExtension</code>を作成します。<br>
実際に利用するものは、<code>var insetsDidChange: ((UIEdgeInsets) -&gt; ())? { get set }</code>になります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="c1">// </span><span class="cs">MARK:</span><span class="c1"> - extension</span>
<span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SafeAreaExtension</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">insetsDidChange</span><span class="p">:</span> <span class="p">((</span><span class="bp">UIEdgeInsets</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">())?</span>
    <span class="kd">private</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">view</span><span class="p">:</span> <span class="bp">UIView</span><span class="p">?</span>
    <span class="n">fileprivate</span> <span class="kd">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="n">view</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>UIViewのextensionとして、<code>SafeAreaExtension</code>のpropertyを追加します。<br>
insetsDidChangeを保持させたいので、<code>SafeAreaExtension</code>をAssociatedObjectとしています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">extension</span> <span class="bp">UIView</span> <span class="p">{</span>
    <span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">struct</span> <span class="nc">AssociatedKey</span> <span class="p">{</span>
        <span class="kd">static</span> <span class="kd">var</span> <span class="nv">safeArea</span><span class="p">:</span> <span class="nb">UInt8</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">safeArea</span><span class="p">:</span> <span class="n">SafeAreaExtension</span> <span class="p">{</span>
        <span class="kc">_</span> <span class="p">=</span> <span class="bp">UIView</span><span class="p">.</span><span class="n">swizzleSafeAreaInsetsDidChange</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">safeArea</span> <span class="p">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">AssociatedKey</span><span class="p">.</span><span class="n">safeArea</span><span class="p">)</span> <span class="k">as</span><span class="p">?</span> <span class="n">SafeAreaExtension</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">safeArea</span> <span class="p">=</span> <span class="n">SafeAreaExtension</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
            <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">AssociatedKey</span><span class="p">.</span><span class="n">safeArea</span><span class="p">,</span> <span class="n">safeArea</span><span class="p">,</span> <span class="p">.</span><span class="n">OBJC_ASSOCIATION_RETAIN</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">safeArea</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">safeArea</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p><code>UIView.safeAreaInsetsDidChange()</code>をハンドリングできるよう、Method Swizzlingをします。<br>
<code>safeAreaInsetsDidChange</code>を<code>sa_safeAreaInsetsDidChange</code>に置き換え元のメソッドを呼んだあとに、先程拡張した<code>safeArea.insetsDidChange</code>を呼び出し、現在のsafeAreaInsetsを渡します。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">extension</span> <span class="bp">UIView</span> <span class="p">{</span>
    <span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fileprivate</span> <span class="kd">static</span> <span class="kd">var</span> <span class="nv">swizzleSafeAreaInsetsDidChange</span><span class="p">:</span> <span class="p">()</span> <span class="p">=</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">originalSelector</span> <span class="p">=</span> <span class="k">#selector</span><span class="p">(</span><span class="bp">UIView</span><span class="p">.</span><span class="n">safeAreaInsetsDidChange</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">swizzledSelector</span> <span class="p">=</span> <span class="k">#selector</span><span class="p">(</span><span class="bp">UIView</span><span class="p">.</span><span class="n">sa_safeAreaInsetsDidChange</span><span class="p">)</span>
        <span class="k">guard</span>
            <span class="kd">let</span> <span class="nv">originalMethod</span> <span class="p">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="bp">UIView</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">originalSelector</span><span class="p">),</span>
            <span class="kd">let</span> <span class="nv">swizzledMethod</span> <span class="p">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="bp">UIView</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">swizzledSelector</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">flag</span> <span class="p">=</span> <span class="n">class_addMethod</span><span class="p">(</span><span class="bp">UIView</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span>
                                   <span class="n">originalSelector</span><span class="p">,</span>
                                   <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">swizzledMethod</span><span class="p">),</span>
                                   <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">swizzledMethod</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="p">{</span>
            <span class="n">class_replaceMethod</span><span class="p">(</span><span class="bp">UIView</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span>
                                <span class="n">swizzledSelector</span><span class="p">,</span>
                                <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">originalMethod</span><span class="p">),</span>
                                <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">originalMethod</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">originalMethod</span><span class="p">,</span> <span class="n">swizzledMethod</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="kr">@objc</span> <span class="kd">private</span> <span class="kd">func</span> <span class="nf">sa_safeAreaInsetsDidChange</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">sa_safeAreaInsetsDidChange</span><span class="p">()</span>
        <span class="n">safeArea</span><span class="p">.</span><span class="n">insetsDidChange</span><span class="p">?(</span><span class="n">safeAreaInsets</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>黒魔術と呼ばれているAssociatedObjectやMethod Swizzlingを利用しているので、好みがわかれる部分かと思います。<br>
こちらの実装は<a href="https://github.com/marty-suzuki/SafeAreaExtension" rel="nofollow noopener" target="_blank">SafeAreaExtension</a>としてGithubで公開しています。</p>

<h2>
<span id="rxswiftを利用" class="fragment"></span><a href="#rxswift%E3%82%92%E5%88%A9%E7%94%A8"><i class="fa fa-link"></i></a>RxSwiftを利用</h2>

<p>下記のようにRxSwiftでUIViewを拡張して、safeAreaInsetsの変更を感知できるようにしようと思います。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="p">...</span>    
        <span class="n">view</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">safeAreaInsetsDidChange</span><span class="p">()</span>
            <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">insets</span> <span class="k">in</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">"view.safeAreaInsets = </span><span class="si">\(</span><span class="n">insets</span><span class="si">)</span><span class="s">"</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="実装-2" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85-2"><i class="fa fa-link"></i></a>実装</h3>

<p>Reactiveを拡張し、methodInvokedを利用して<code>safeAreaInsetsDidChange</code>の呼び出しを監視しています。<br>
メソッドが呼び出されたら、base.safeAreaInsetsを<code>Observable&lt;UIEdgeInsets&gt;.just()</code>しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">extension</span> <span class="nc">Reactive</span> <span class="k">where</span> <span class="n">Base</span><span class="p">:</span> <span class="bp">UIView</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">safeAreaInsetsDidChange</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="bp">UIEdgeInsets</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="cp">#available</span> <span class="p">(</span><span class="cp">iOS</span> <span class="mi">11</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">.</span><span class="cp">empty</span><span class="p">()</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">base</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">methodInvoked</span><span class="p">(</span><span class="k">#selector</span><span class="p">(</span><span class="n">Base</span><span class="p">.</span><span class="n">safeAreaInsetsDidChange</span><span class="p">))</span>
            <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="n">base</span><span class="p">]</span> <span class="kc">_</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="bp">UIEdgeInsets</span><span class="p">&gt;</span> <span class="k">in</span>
                <span class="k">guard</span> <span class="kd">let</span> <span class="nv">base</span> <span class="p">=</span> <span class="n">base</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">}</span>
                <span class="k">return</span> <span class="p">.</span><span class="n">just</span><span class="p">(</span><span class="n">base</span><span class="p">.</span><span class="n">safeAreaInsets</span><span class="p">)</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h1>

<p>コード上でAutoLayoutを利用して、Safe Areaに対応することもできます。<br>
例として、任意のviewをsuperviewの上下左右に対してsafeAreaを考慮してaddSubviewする実装をしていきます。</p>

<p>NSLayoutConstraintを利用する場合は、<code>view.safeAreaLayoutGuide</code>をitemまたはtoItemに渡して制約を実装することができます。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">aView</span> <span class="p">=</span> <span class="bp">UIView</span><span class="p">()</span>
<span class="n">aView</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="p">=</span> <span class="kc">false</span>

<span class="kd">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="n">NSLayoutAttribute</span><span class="p">]</span> <span class="p">=</span> <span class="p">[.</span><span class="n">top</span><span class="p">,</span> <span class="p">.</span><span class="kr">right</span><span class="p">,</span> <span class="p">.</span><span class="kr">left</span><span class="p">,</span> <span class="p">.</span><span class="n">bottom</span><span class="p">]</span>
<span class="kd">let</span> <span class="nv">constraints</span> <span class="p">=</span> <span class="n">attributes</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span>
    <span class="bp">NSLayoutConstraint</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">view</span><span class="p">.</span><span class="n">safeAreaLayoutGuide</span><span class="p">,</span>
                       <span class="n">attribute</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span>
                       <span class="n">relatedBy</span><span class="p">:</span> <span class="p">.</span><span class="bp">equal</span><span class="p">,</span>
                       <span class="n">toItem</span><span class="p">:</span> <span class="n">aView</span><span class="p">,</span>
                       <span class="n">attribute</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span>
                       <span class="n">multiplier</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">constant</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">view</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">aView</span><span class="p">)</span>
<span class="n">view</span><span class="p">.</span><span class="n">addConstraints</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
</pre></div></div>

<p>上記と同様の実装をNSLayoutAnchorを利用する場合は、下記のような実装になります。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">aView</span> <span class="p">=</span> <span class="bp">UIView</span><span class="p">()</span>
<span class="n">aView</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="p">=</span> <span class="kc">false</span>

<span class="n">view</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">aView</span><span class="p">)</span>
<span class="bp">NSLayoutConstraint</span><span class="p">.</span><span class="n">activate</span><span class="p">([</span>
    <span class="n">view</span><span class="p">.</span><span class="n">safeAreaLayoutGuide</span><span class="p">.</span><span class="n">topAnchor</span><span class="p">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">equalTo</span><span class="p">:</span> <span class="n">aView</span><span class="p">.</span><span class="n">topAnchor</span><span class="p">),</span>
    <span class="n">view</span><span class="p">.</span><span class="n">safeAreaLayoutGuide</span><span class="p">.</span><span class="n">leftAnchor</span><span class="p">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">equalTo</span><span class="p">:</span> <span class="n">aView</span><span class="p">.</span><span class="n">leftAnchor</span><span class="p">),</span>
    <span class="n">view</span><span class="p">.</span><span class="n">safeAreaLayoutGuide</span><span class="p">.</span><span class="n">rightAnchor</span><span class="p">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">equalTo</span><span class="p">:</span> <span class="n">aView</span><span class="p">.</span><span class="n">rightAnchor</span><span class="p">),</span>
    <span class="n">view</span><span class="p">.</span><span class="n">safeAreaLayoutGuide</span><span class="p">.</span><span class="n">bottomAnchor</span><span class="p">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">equalTo</span><span class="p">:</span> <span class="n">aView</span><span class="p">.</span><span class="n">bottomAnchor</span><span class="p">)</span>
<span class="p">])</span>
</pre></div></div>

<p><a href="https://github.com/marty-suzuki/MisterFusion" rel="nofollow noopener" target="_blank">MisterFusion</a>というAutoLayoutのDSLでもSafe Areaに対応しています。</p>

<div class="code-frame" data-lang="swift"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">aView</span> <span class="p">=</span> <span class="bp">UIView</span><span class="p">()</span>
<span class="n">view</span><span class="p">.</span><span class="n">mf</span><span class="p">.</span><span class="n">addSubView</span><span class="p">(</span><span class="n">aView</span><span class="p">,</span> <span class="n">andConstraints</span><span class="p">:</span> <span class="n">view</span><span class="p">.</span><span class="n">safeArea</span><span class="p">.</span><span class="n">top</span>    <span class="o">|==|</span> <span class="n">aView</span><span class="p">.</span><span class="n">top</span><span class="p">,</span>
                                          <span class="n">view</span><span class="p">.</span><span class="n">safeArea</span><span class="p">.</span><span class="kr">right</span>  <span class="o">|==|</span> <span class="n">aView</span><span class="p">.</span><span class="kr">right</span><span class="p">,</span>
                                          <span class="n">view</span><span class="p">.</span><span class="n">safeArea</span><span class="p">.</span><span class="kr">left</span>   <span class="o">|==|</span> <span class="n">aView</span><span class="p">.</span><span class="kr">left</span><span class="p">,</span>
                                          <span class="n">view</span><span class="p">.</span><span class="n">safeArea</span><span class="p">.</span><span class="n">bottom</span> <span class="o">|==|</span> <span class="n">aView</span><span class="p">.</span><span class="n">bottom</span><span class="p">)</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
