<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (mopemope)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (mopemope さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>mopemopeさんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>709</kbd>
		<a target="_blank" href="https://qiita.com/mopemope/items/495ab1f74bcbef0f88bb">Docker で開発環境も使い捨てにしよう！</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-14 13:16:09</center>
	</td>
	<td style="width:200px;">
		@mopemope<br />(Abby 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/2526/profile-images/1473681654">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[docker]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="docker-で開発環境を作る話" class="fragment"></span><a href="#docker-%E3%81%A7%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B%E8%A9%B1"><i class="fa fa-link"></i></a>Docker で開発環境を作る話</h1>

<p>こんにちは、Docker 0.9 が出ましたね。<br>
ちょっと Docker を触っていて幾つかアレな点があったので共有しておこうと思います。</p>

<p>その他も合わせてまとめてます。<br>
<a href="http://qiita.com/mopemope/items/181cb6c6c6f7cf9bbaa9" id="reference-f0115c0ab32fc645cc88">私の Docker TIPS </a></p>

<h1>
<span id="docker-を使って開発環境および開発環境の土台を作る" class="fragment"></span><a href="#docker-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%8A%E3%82%88%E3%81%B3%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%AE%E5%9C%9F%E5%8F%B0%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>Docker を使って開発環境、および開発環境の土台を作る</h1>

<p>まあよくある Docker の使い方って nginx だの redis だのいろんなサーバーを構築する感じだと思いますが。<br>
今回は開発環境を構築する話をしたいと思います。</p>

<p>よく dotfiles なんかを github においてーなんてことやってる方多いと思います。<br>
もうここは思い切って Docker のイメージにしてしまいましょう。</p>

<h3>
<span id="利点" class="fragment"></span><a href="#%E5%88%A9%E7%82%B9"><i class="fa fa-link"></i></a>利点</h3>

<ul>
<li>モテる</li>
<li>なんかイケてる感じがする</li>
<li>案件、プロジェクト毎に個別環境をクリーンなまま維持できる</li>
<li>みんな同じ環境で作業することができる（ライブラリのバージョンなどが揃う）</li>
<li>ぶっ壊れても巻き戻し可能(commitしなければ）</li>
<li>docker さえあればどこでも仕事ができる</li>
<li>image を作ってる間に一休みできる</li>
</ul>

<h3>
<span id="欠点" class="fragment"></span><a href="#%E6%AC%A0%E7%82%B9"><i class="fa fa-link"></i></a>欠点</h3>

<ul>
<li>docker である</li>
<li>docker である</li>
<li>docker である</li>
</ul>

<p>ということでよくプロジェクトをまたがったり、いろんな対応していると環境がごちゃごちゃになりがちなので<br>
思い切って分けちゃおう！使い捨てちゃおうってのが今回の話です。<br>
また環境をメンバーで揃えてしまえば「オメーの環境でしか起きねーから！それ！」といった事を防げるかも知れません。</p>

<p>では実際の私が使ってる Dockerfile の一部と共にハマりそうなとこを回避するTIPSを書いていこうと思います。<br>
前提として ubuntu を土台にしてるケースです。</p>

<h2>
<span id="09-での-ssh-server-でトラブル" class="fragment"></span><a href="#09-%E3%81%A7%E3%81%AE-ssh-server-%E3%81%A7%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB"><i class="fa fa-link"></i></a>0.9 での ssh server でトラブル</h2>

<p>みんなが踏むとこですね。現在は解消されているようです。<br>
<a href="https://github.com/dotcloud/docker/issues/4605" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/dotcloud/docker/issues/4605</a></p>

<p>開発環境のため、基本 ssh server を立ち上げてそこから作業を行うのですが、ログイン後、pty がねえよとか言われる奴です。<br>
ログインするとプロンプトが出てこず壊したくなりますね。<br>
workaround でも書かれてますが run する際にオプションをつけましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo docker run -t -p 40000:22 mopemope/base
</pre></div></div>

<h2>
<span id="ubuntu-1310-の-sshd-の設定で即死" class="fragment"></span><a href="#ubuntu-1310-%E3%81%AE-sshd-%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A7%E5%8D%B3%E6%AD%BB"><i class="fa fa-link"></i></a>ubuntu 13.10 の sshd の設定で即死</h2>

<p>これも踏むやつでしょうか。<br>
開発環境なので、新しいライブラリなども使いたい！そのため ubuntu 13.10を土台にーなんて方も多いんじゃ<br>
ないでしょうか？<br>
とりあえず sshd を普通にたて起動はできた！が！<br>
って事が起こります。<br>
ログイン後、即切断されるってやつですね。<br>
13.10 では pam を見るのでこの設定を書き換えておく必要があります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>RUN sed -i 's/.*session.*required.*pam_loginuid.so.*/session optional pam_loginuid.so/g' /etc/pam.d/sshd
</pre></div></div>

<h2>
<span id="fuse-で即死" class="fragment"></span><a href="#fuse-%E3%81%A7%E5%8D%B3%E6%AD%BB"><i class="fa fa-link"></i></a>fuse で即死</h2>

<p>これもみんな踏むとこでしょうか。<br>
apt でいろいろ入れてると fuse 関連にひかかって死ぬパターンですね。<br>
一応以下で回避できますがきっともっといい方法があるでしょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>RUN chmod go+w,u+s /tmp
RUN apt-get install libfuse2
RUN mkdir /tmp/fuse &amp;&amp; \
    cd /tmp/fuse &amp;&amp; \
    apt-get download fuse &amp;&amp; \
    dpkg-deb -x fuse_* . &amp;&amp; \
    dpkg-deb -e fuse_* &amp;&amp; \
    rm fuse_*.deb &amp;&amp; \
    echo -en '#!/bin/bash\nexit 0\n' &gt; DEBIAN/postinst &amp;&amp; \
    dpkg-deb -b . /fuse.deb &amp;&amp; \
    dpkg -i /fuse.deb &amp;&amp; \
    cd / &amp;&amp; \
    rm -rf /tmp/fuse /fuse.deb
</pre></div></div>

<h2>
<span id="git-clone-時のknown_hosts" class="fragment"></span><a href="#git-clone-%E6%99%82%E3%81%AEknown_hosts"><i class="fa fa-link"></i></a>git clone 時のknown_hosts</h2>

<p>dotfiles や ソースなど git clone してくる際に死ぬパターンです。<br>
known_hosts がまっさらなので確認してくるのですがそこで止まってしまいます。<br>
ssh/config などで確認が入らないようにしておきましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Host github.com
  StrictHostKeyChecking no

Host bitbucket.org
  StrictHostKeyChecking no
</pre></div></div>

<h2>
<span id="dockerfile" class="fragment"></span><a href="#dockerfile"><i class="fa fa-link"></i></a>Dockerfile</h2>

<p>とまあいろいろあるのですが、使っている Dockerfile をサンプルとして書いておきます。<br>
土台になるとこなので tag は xxxx/base としておきます。<br>
個別環境は別途作成し、FROM xxxx/base として 先ほどの tag を使えばよいでしょう。</p>

<p>このコンテナに</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>
ssh -XC ma2@xxxxx -p xxxx

</pre></div></div>

<p>でログインして開発すればよいでしょう。</p>

<p>基本、ソースなどの類は VCS などで管理すると思いますが、作業内容の永続化が必要であれば<br>
run する際に -v をつけてマウントしておきましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>
FROM ubuntu:13.10

MAINTAINER mopemope yutaka.matsubara@gmail.com

RUN apt-get -yq update &amp;&amp; apt-get -yq upgrade
RUN chmod go+w,u+s /tmp
RUN apt-get install libfuse2
RUN mkdir /tmp/fuse &amp;&amp; \
    cd /tmp/fuse &amp;&amp; \
    apt-get download fuse &amp;&amp; \
    dpkg-deb -x fuse_* . &amp;&amp; \
    dpkg-deb -e fuse_* &amp;&amp; \
    rm fuse_*.deb &amp;&amp; \
    echo -en '#!/bin/bash\nexit 0\n' &gt; DEBIAN/postinst &amp;&amp; \
    dpkg-deb -b . /fuse.deb &amp;&amp; \
    dpkg -i /fuse.deb &amp;&amp; \
    cd / &amp;&amp; \
    rm -rf /tmp/fuse /fuse.deb

RUN dpkg-divert --local --rename --add /sbin/initctl &amp;&amp; rm -f /sbin/initctl &amp;&amp; ln -s /bin/true /sbin/initctl

# install
RUN apt-get install -y openssh-server language-pack-ja zsh tmux git mercurial subversion build-essential python-setuptools python-software-properties
RUN apt-get install -y wget unzip curl p7zip-full mosh xterm tree grep 
RUN apt-get install -y emacs24 vim zsh emacs-mozc-bin fonts-inconsolata fonts-ipafont fonts-ipaexfont rlwrap
RUN apt-get install -y sqlite3 libsqlite3-0 libsqlite3-dev
RUN apt-get install -y firefox gimp mozc-server libreoffice libreoffice-l10n-ja

RUN mkdir /var/run/sshd
RUN echo 'root:root' |chpasswd
RUN locale-gen en_US en_US.UTF-8 &amp;&amp; dpkg-reconfigure locales
RUN locale-gen ja_JP ja_JP.UTF-8 &amp;&amp; dpkg-reconfigure locales

# sshd config
RUN sed -i 's/.*session.*required.*pam_loginuid.so.*/session optional pam_loginuid.so/g' /etc/pam.d/sshd
RUN /bin/echo -e "LANG=\"ja_JP.UTF-8\"" &gt; /etc/default/local

# Add User
RUN adduser --disabled-password --gecos "" ma2 \
  &amp;&amp; echo "ma2 ALL=(ALL) NOPASSWD:ALL" &gt;&gt; /etc/sudoers \
  &amp;&amp; echo 'ma2:ma2' | chpasswd

RUN chsh -s /bin/zsh ma2

# Setup
USER ma2
WORKDIR /home/ma2
ENV HOME /home/ma2

RUN mkdir .ssh
RUN chmod 700 .ssh
ADD id_rsa /home/ma2/.ssh/id_rsa
ADD id_dsa /home/ma2/.ssh/id_dsa
ADD config /home/ma2/.ssh/config

RUN git clone git@bitbucket.org:mopemope/dotfiles.git
RUN zsh dotfiles/setup.sh

# emacs
RUN mkdir .emacs.d
RUN cp dotfiles/init.el .emacs.d
RUN cp dotfiles/mozc.el .emacs.d
RUN cp -R dotfiles/malabar .emacs.d/
RUN cp -R dotfiles/malabar-lib .emacs.d/
RUN cp -R dotfiles/snippets/java-mode .emacs.d/snippets/

# vim
RUN mkdir -p .vim/bundle
RUN git clone https://github.com/Shougo/neobundle.vim ~/.vim/bundle/neobundle.vim
RUN cd ~/.vim/bundle/neobundle.vim/bin &amp;&amp; ./neoinstall

# codebox
RUN hg clone ssh://hg@bitbucket.org/mopemope/codebox

EXPOSE 22
CMD    /usr/sbin/sshd -D

</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mopemopeさんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>609</kbd>
		<a target="_blank" href="https://qiita.com/mopemope/items/b05ff7f603a5ad74bf55">Docker でデータのポータビリティをあげ永続化しよう</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-27 10:28:03</center>
	</td>
	<td style="width:200px;">
		@mopemope<br />(Abby 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/2526/profile-images/1473681654">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[docker]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="docker-でデータのポータビリティをあげ永続化しよう" class="fragment"></span><a href="#docker-%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%9D%E3%83%BC%E3%82%BF%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E3%82%92%E3%81%82%E3%81%92%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>Docker でデータのポータビリティをあげ永続化しよう</h1>

<p>こんにちは、Docker 0.91 が出ましたね。<br>
CoreOS でのデータの置き場所をどうすべきか考えていた時に、CoreOS-devで出ていた話です。<br>
なので知っている人は知ってるかも知れません。</p>

<p>全てにおいて使えるパターンではないのですが、運用形態のひとつとして紹介します。<br>
（もちろん、Dockerはどんどん進化しているのでこのパターンは陳腐化する可能性もあります）</p>

<h2>
<span id="データの永続化の問題" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%81%AE%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>データの永続化の問題</h2>

<p>Docker で悩ましいのはデータの永続化をどうするか？というとこでしょうか.<br>
例：mysql のコンテナを立ち上げる</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo docker run -d -v /var/host_lib/mysql:/var/lib/mysql me/mysql_5_5
</pre></div></div>

<p><code>-v</code> オプションをつけて <code>mysql</code> のデータを永続化していますね。<br>
さてこれはこれでよいのですが、Docker の旨みを活かせていませんね。<br>
Docker の特徴はコンテナであり、コンテナにするとポータビリティがあげられるわけです。<br>
上記の方法だと Volume でホストにべったり実データが張り付いてしまい、データ自体のポータビリティが下がっ<br>
てしまいます。<br>
また、Docker 内で閉じていない場合、うっかり誰かがデータを削除してしまうかも知れません。</p>

<h2>
<span id="data-only-container-pattern" class="fragment"></span><a href="#data-only-container-pattern"><i class="fa fa-link"></i></a>Data-only Container Pattern</h2>

<p>そこで、データのみを格納するコンテナを作成し、データ部のポータビリティをあげてみましょう。<br>
では早速、Dockerfile を書いていきます。<br>
今回はざっくりと動作の確認をするため、シンプルなもので試しています。</p>

<p>データ格納コンテナのDockerfile</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>FROM busybox
VOLUME /opt
CMD /bin/sh
</pre></div></div>

<p>build.</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo docker build -t me/storage .
</pre></div></div>

<p>run.</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo docker run -i -t --name my_data me/storage
</pre></div></div>

<p>あるいは 以下一行でもよいでしょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo docker run -i -t -v /opt --name my_data busybox /bin/sh
</pre></div></div>

<p>今回は<code>--name</code>オプションで任意の名前をつけています。<br>
<code>--name</code>はユニークである必要があるので気をつけましょう。<br>
VOLUME で /opt を指定しています。なので/opt以下を格納するコンテナになります。<br>
ではデータ格納コンテナを使ってみます。<br>
別ターミナルなどから以下のコマンドで使ってみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo docker run -t -i --volumes-from my_data ubuntu /bin/bash
</pre></div></div>

<p><code>--volumes-from</code> で先ほどのコンテナを指定しています。<br>
これで先ほどのデータ格納コンテナとつながりました。<br>
/opt が接続されているので確認してみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>root@f2c68ec76ba3:/# touch /opt/test
root@f2c68ec76ba3:/# ls -al /opt/
total 8
drwx------  2 root root 4096 Mar 27 00:34 .
drwxr-xr-x 33 root root 4096 Mar 27 00:34 ..
-rw-r--r--  1 root root    0 Mar 27 00:34 test
root@f2c68ec76ba3:/# touch /opt/testa
root@f2c68ec76ba3:/# ls -al /opt/
total 8
drwx------  2 root root 4096 Mar 27 00:35 .
drwxr-xr-x 33 root root 4096 Mar 27 00:34 ..
-rw-r--r--  1 root root    0 Mar 27 00:34 test
-rw-r--r--  1 root root    0 Mar 27 00:35 testa
root@f2c68ec76ba3:/#
</pre></div></div>

<p>データ格納コンテナ側からも見てみます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>/ # ls -al /opt
total 8
drwx------    2 root     root          4096 Mar 27 00:35 .
drwxr-xr-x   30 root     root          4096 Mar 27 00:34 ..
-rw-r--r--    1 root     root             0 Mar 27 00:34 test
-rw-r--r--    1 root     root             0 Mar 27 00:35 testa
/ # 
</pre></div></div>

<p>できてますね。<br>
データ格納コンテナを<code>Ctrl+D</code>などで落としてみましょう。<br>
使用している側のコンテナに戻って以下を実行してみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>root@f2c68ec76ba3:/# touch /opt/hoge-
root@f2c68ec76ba3:/# ls -al /opt/
total 8
drwx------  2 root root 4096 Mar 27 00:38 .
drwxr-xr-x 33 root root 4096 Mar 27 00:34 ..
-rw-r--r--  1 root root    0 Mar 27 00:38 hoge-
-rw-r--r--  1 root root    0 Mar 27 00:34 test
-rw-r--r--  1 root root    0 Mar 27 00:35 testa
</pre></div></div>

<p>そうです。当たり前ですがデータ格納コンテナは<code>run</code>で走らせてなくてもよいのです。<br>
落としたコンテナを<code>start</code>で再度起こして中身を見てみましょう。<br>
<code>docker ps -a</code>で確認して起動します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>sudo docker start &lt;CONTAINER_ID&gt;
sudo docker attach &lt;CONTAINER_ID&gt;

/ # ls -al /opt/
total 8
drwx------    2 root     root          4096 Mar 27 00:38 .
drwxr-xr-x   30 root     root          4096 Mar 27 01:02 ..
-rw-r--r--    1 root     root             0 Mar 27 00:38 hoge-
-rw-r--r--    1 root     root             0 Mar 27 00:34 test
-rw-r--r--    1 root     root             0 Mar 27 00:35 testa
/ #
</pre></div></div>

<p>問題ありませんね。<br>
これでポータビリティを確保しつつ、データの永続化を実現出来ました。<br>
データ格納コンテナのデータのバックアップや確認は<code>docker cp</code>を使ってホスト側にもってくることで可能です。<br>
また<code>export</code>してアーカイブ化してしまうのも手でしょう。<br>
アーカイブしたものを別ホストで展開すれば別ホストでも使用できます。</p>

<p>これを応用すればmysqlのコンテナと複数のデータ格納コンテナを使用してmysql環境をバンバン立ち上げること<br>
ができます。<br>
またnameを変えるだけでデータを切り替えることができるのでテストなどでも使えるかも知れません。<br>
必要に応じて<code>commit</code>してregistryにpushして配布するなども場合によってはいいかも知れませんね。</p>

<p>先日書いた以下の記事の開発するプロジェクトデータ部をコンテナに追い出すのもよいでしょう。<br>
<a href="http://qiita.com/mopemope/items/495ab1f74bcbef0f88bb" id="reference-f88390522d99103d901b">Docker で開発環境も使い捨てにしよう！ </a></p>

<p>データ格納コンテナは走らせてなくてもよいのですが、うっかり削除する可能性もあるので走らせておくとよい<br>
でしょう。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mopemopeさんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>437</kbd>
		<a target="_blank" href="https://qiita.com/mopemope/items/181cb6c6c6f7cf9bbaa9">私の Docker TIPS </a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-20 13:47:51</center>
	</td>
	<td style="width:200px;">
		@mopemope<br />(Abby 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/2526/profile-images/1473681654">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[docker]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="docker-tips-あれこれ" class="fragment"></span><a href="#docker-tips-%E3%81%82%E3%82%8C%E3%81%93%E3%82%8C"><i class="fa fa-link"></i></a>Docker TIPS あれこれ</h1>

<p>Docker を使っているとアレどーすんだっけ？って探しまわることが多いのでここにまとめておこうと思います。<br>
随時更新予定です。<br>
先日のまとめの分も再度記載しておきます。<br>
基本、ホストは ubuntu-server 12.04、コンテナ側は普段使いしている13.10前提で記述しています。</p>

<h2>
<span id="docker-のイメージ格納先を変更したい" class="fragment"></span><a href="#docker-%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E6%A0%BC%E7%B4%8D%E5%85%88%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>docker のイメージ格納先を変更したい</h2>

<p>apt で docker をインストールしている人がほとんどだと思います。<br>
デフォルトでは <code>/var/lib/docker</code> になります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>/etc/default/docker
</pre></div></div>

<p>ここに設定があるのでそこで変更できます。<br>
DNSの設定もここでできます。</p>

<p>格納先は <code>-g</code> オプションで設定できます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># Docker Upstart and SysVinit configuration file

# Customize location of Docker binary (especially for development testing).
#DOCKER="/usr/local/bin/docker"

# Use DOCKER_OPTS to modify the daemon startup options.
DOCKER_OPTS="-dns 8.8.8.8 -dns 8.8.4.4 -g /opt/docker"

# If you need Docker to use an HTTP proxy, it can also be specified here.
#export http_proxy="http://127.0.0.1:3128/"

# This is also a handy place to tweak where Docker's temporary files go.
#export TMPDIR="/mnt/bigdrive/docker-tmp"

</pre></div></div>

<h2>
<span id="コンテナを一気に削除したい" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%B8%80%E6%B0%97%E3%81%AB%E5%89%8A%E9%99%A4%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>コンテナを一気に削除したい</h2>

<p>Dockerfile を書いているとゴミコンテナが大量にできてしまいます。<br>
以下で使用していないコンテナを一度に削除してしまいましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo docker rm $(sudo docker ps -a -q)
</pre></div></div>

<p>起動中のコンテナは削除されません。<br>
強制的に削除する場合には<code>-f</code>オプションを使って下さい。</p>

<h2>
<span id="イメージを一気に削除したい" class="fragment"></span><a href="#%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E4%B8%80%E6%B0%97%E3%81%AB%E5%89%8A%E9%99%A4%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>イメージを一気に削除したい</h2>

<p>同様にイメージも一気に削除できます。<br>
本当にまっさらになってしまうので注意しましょう。<br>
依存関係によってはうまく消えないので依存しているコンテナを削除してから実行しましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo docker rmi $(sudo docker images -q)
</pre></div></div>

<p>依存関係などは<code>docker images</code> の <code>--tree</code>オプションを使うとわかりやすくてよいでしょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo docker images --tree
</pre></div></div>

<h2>
<span id="aufs-のリミット" class="fragment"></span><a href="#aufs-%E3%81%AE%E3%83%AA%E3%83%9F%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>aufs のリミット</h2>

<p>Docker での aufs layer の制限は 0.7 移行、42から127に引き上げられていますが、それでも足りない場合には<br>
export -&gt; import することでまとめることができます。<br>
土台になるbaseイメージなどでごっそり必要な設定、インストールを済ませ、export -&gt; importすることで<br>
layer 数を稼ぐことができます。<br>
export する際にはコンテナIDが必要になるので注意して下さい。</p>

<p>まずコンテナIDを取得してから作業しましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ container_id=$(sudo docker run -d &lt;REPOS:TAG&gt; /bin/bash -c "")
$ sudo docker export $container_id &gt; tmp.tar
$ cat tmp.tar | sudo docker import - &lt;REPOS:TAG&gt;
</pre></div></div>

<p>import 時に TAG を貼り直してしまっているのですが、心配な方は指定せずに最新のコンテナに TAG を振りなおしましょう。</p>

<h2>
<span id="private-repository-でイメージを共有バックアップする" class="fragment"></span><a href="#private-repository-%E3%81%A7%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E5%85%B1%E6%9C%89%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>private-repository でイメージを共有、バックアップする</h2>

<p>private-repository を立てることでイメージの共有を行うことができます。<br>
S3 へのアップロードはそのうち試しますが、今回は push したイメージをファイルシステムに落とし込む方法<br>
です。<br>
private-repository は registry という名前で提供されています。<br>
そのため即試すことができます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo docker run -d -p 5000:5000 -v /opt/registry:/tmp/registry:rw registry
</pre></div></div>

<p>Docker のイメージで提供されているのでそのままだと registry が落ちると push した内容も吹き飛んでしま<br>
います。<br>
そのため、ホストの/opt/registry をマウントして push したイメージを永続化しています。<br>
（デフォルトで/tmp/registryへ保存されるので）<br>
registry は github にあるので興味のある方は見てみるといいです。<br>
構成は <code>gunicorn + gevent + flask</code> です。<br>
そのうち詳しく書くかも知れません。</p>

<h1>
<span id="dockerfile" class="fragment"></span><a href="#dockerfile"><i class="fa fa-link"></i></a>Dockerfile</h1>

<h2>
<span id="apt-get-が遅いんだけど" class="fragment"></span><a href="#apt-get-%E3%81%8C%E9%81%85%E3%81%84%E3%82%93%E3%81%A0%E3%81%91%E3%81%A9"><i class="fa fa-link"></i></a>apt-get が遅いんだけど</h2>

<p>apt の参照先が本家なので国内からだと遅めです。<br>
ミラーを設定しましょう。<br>
たまにミラーの設定のことをちらっと書いてる人がいますが、フルで書いておいた方がよいと思います。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>RUN echo "deb http://jp.archive.ubuntu.com/ubuntu/ saucy main restricted\n\
deb-src http://jp.archive.ubuntu.com/ubuntu/ saucy main restricted\n\
deb http://jp.archive.ubuntu.com/ubuntu/ saucy-updates main restricted\n\
deb-src http://jp.archive.ubuntu.com/ubuntu/ saucy-updates main restricted\n\
deb http://jp.archive.ubuntu.com/ubuntu/ saucy universe\n\
deb-src http://jp.archive.ubuntu.com/ubuntu/ saucy universe\n\
deb http://jp.archive.ubuntu.com/ubuntu/ saucy-updates universe\n\
deb-src http://jp.archive.ubuntu.com/ubuntu/ saucy-updates universe\n\
deb http://jp.archive.ubuntu.com/ubuntu/ saucy multiverse\n\
deb-src http://jp.archive.ubuntu.com/ubuntu/ saucy multiverse\n\
deb http://jp.archive.ubuntu.com/ubuntu/ saucy-updates multiverse\n\
deb-src http://jp.archive.ubuntu.com/ubuntu/ saucy-updates multiverse\n\
deb http://jp.archive.ubuntu.com/ubuntu/ saucy-backports main restricted universe multiverse\n\
deb-src http://jp.archive.ubuntu.com/ubuntu/ saucy-backports main restricted universe multiverse\n\
deb http://security.ubuntu.com/ubuntu saucy-security main restricted\n\
deb-src http://security.ubuntu.com/ubuntu saucy-security main restricted\n\
deb http://security.ubuntu.com/ubuntu saucy-security universe\n\
deb-src http://security.ubuntu.com/ubuntu saucy-security universe\n\
deb http://security.ubuntu.com/ubuntu saucy-security multiverse\n\
deb-src http://security.ubuntu.com/ubuntu saucy-security multiverse\n"&gt; /etc/apt/sources.list
</pre></div></div>

<h2>
<span id="apt-でインストール中ダイアログの選択で落ちる" class="fragment"></span><a href="#apt-%E3%81%A7%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E4%B8%AD%E3%83%80%E3%82%A4%E3%82%A2%E3%83%AD%E3%82%B0%E3%81%AE%E9%81%B8%E6%8A%9E%E3%81%A7%E8%90%BD%E3%81%A1%E3%82%8B"><i class="fa fa-link"></i></a>apt でインストール中、ダイアログの選択で落ちる</h2>

<p>apt でインストールするものの中にはユーザーと対話をしてくるものがいます。<br>
（選択したものを設定に反映したり、パスワードを入れたりするもの）<br>
Docker だと選択肢に答えようがないので以下をセットしてから<code>apt-get install</code>しましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ENV DEBIAN_FRONTEND noninteractive
</pre></div></div>

<p>またその後使う場合、対話に戻しておきたいことがあるかも知れません。<br>
その場合には一連の操作終了後、以下をセットしておきましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ENV DEBIAN_FRONTEND dialog
</pre></div></div>

<h2>
<span id="upstart-への登録upstart-関連で落ちる" class="fragment"></span><a href="#upstart-%E3%81%B8%E3%81%AE%E7%99%BB%E9%8C%B2upstart-%E9%96%A2%E9%80%A3%E3%81%A7%E8%90%BD%E3%81%A1%E3%82%8B"><i class="fa fa-link"></i></a>upstart への登録、upstart 関連で落ちる</h2>

<p>有名な workaround なのであまり書かれてないのかも知れません。<br>
インストールするものの中にはデーモン（サービス）で動作するものもあります。<br>
ubuntu の性質上デーモンは upstart にひっかけて OS 起動時に起動するような設定を行います。<br>
ですが、Docker では /sbin/init が書き換わっており upstart がうまく動きません。<br>
インストール時の設定の時点で失敗、落ちてしまう事が有ります。<br>
（upstartを動かす方法もありますが…）<br>
その場合の対処法として以下のように設定してから <code>apt-get install</code> しましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>RUN dpkg-divert --local --rename --add /sbin/initctl &amp;&amp; rm -f /sbin/initctl &amp;&amp; ln -s /bin/true /sbin/initctl
</pre></div></div>

<h2>
<span id="fuse-のインストール" class="fragment"></span><a href="#fuse-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>fuse のインストール</h2>

<p>apt でいろいろ入れてると fuse 関連が上手く入らず落ちてしまう事があります。<br>
一応以下で回避できますがきっともっといい方法があるでしょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>RUN chmod go+w,u+s /tmp
RUN apt-get install libfuse2
RUN mkdir /tmp/fuse &amp;&amp; \
    cd /tmp/fuse &amp;&amp; \
    apt-get download fuse &amp;&amp; \
    dpkg-deb -x fuse_* . &amp;&amp; \
    dpkg-deb -e fuse_* &amp;&amp; \
    rm fuse_*.deb &amp;&amp; \
    echo -en '#!/bin/bash\nexit 0\n' &gt; DEBIAN/postinst &amp;&amp; \
    dpkg-deb -b . /fuse.deb &amp;&amp; \
    dpkg -i /fuse.deb &amp;&amp; \
    cd / &amp;&amp; \
    rm -rf /tmp/fuse /fuse.deb
</pre></div></div>

<h2>
<span id="容量を少しでも減らす" class="fragment"></span><a href="#%E5%AE%B9%E9%87%8F%E3%82%92%E5%B0%91%E3%81%97%E3%81%A7%E3%82%82%E6%B8%9B%E3%82%89%E3%81%99"><i class="fa fa-link"></i></a>容量を少しでも減らす</h2>

<p><code>apt-get install</code> 時に <code>--no-install-recommends</code> をつけましょう。<br>
一連のインストールが終わったら<code>apt-get clean</code> を実行しましょう。</p>

<h2>
<span id="git-clone-時の-known_hosts" class="fragment"></span><a href="#git-clone-%E6%99%82%E3%81%AE-known_hosts"><i class="fa fa-link"></i></a>git clone 時の known_hosts</h2>

<p>dotfiles や ソースなど git clone してくる際に落ちてるしまうことがあります。<br>
known_hosts がまっさらなので確認してくるのですがそこで止まってしまいます。<br>
ssh/config などで確認が入らないようにしておきましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Host github.com
  StrictHostKeyChecking no

Host bitbucket.org
  StrictHostKeyChecking no
</pre></div></div>

<h1>
<span id="ソフトウェアのインストール個別設定" class="fragment"></span><a href="#%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E5%80%8B%E5%88%A5%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>ソフトウェアのインストール、個別設定</h1>

<h2>
<span id="supervisor-で複数のデーモンを立ち上げる" class="fragment"></span><a href="#supervisor-%E3%81%A7%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%87%E3%83%BC%E3%83%A2%E3%83%B3%E3%82%92%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E3%82%8B"><i class="fa fa-link"></i></a>supervisor で複数のデーモンを立ち上げる</h2>

<p>公式にもあるので書きませんが、sshd があるとコンテナ内のファイルを救い出す事ができたりするので設定しておくといいでしょう。<br>
もちろん、起動時に<code>-v</code>でマウントしておくともっと楽かも知れません。</p>

<h2>
<span id="docker-09-での-tty" class="fragment"></span><a href="#docker-09-%E3%81%A7%E3%81%AE-tty"><i class="fa fa-link"></i></a>Docker 0.9 での tty</h2>

<p>現在は解消されているようです。<br>
<a href="https://github.com/dotcloud/docker/issues/4605" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/dotcloud/docker/issues/4605</a></p>

<p>SSH server を立ち上げてログイン後、pty がねえよとか言われる奴です。<br>
ログインするとプロンプトが出てこず壊したくなる<br>
workaround でも書かれてますが run する際に<code>-t</code>オプションをつけましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo docker run -t -p 40000:22 xxxxxx /usr/sbin/sshd -D
</pre></div></div>

<h2>
<span id="saucy-の-sshd-の設定" class="fragment"></span><a href="#saucy-%E3%81%AE-sshd-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>saucy の sshd の設定</h2>

<p>ssh でログイン後、即切断される場合の対処法です。<br>
13.10 では pam を見るのでこの設定を書き換えておく必要があります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>RUN sed -i 's/.*session.*required.*pam_loginuid.so.*/session optional pam_loginuid.so/g' /etc/pam.d/sshd
</pre></div></div>

<h2>
<span id="nvm-による-node-のインストール" class="fragment"></span><a href="#nvm-%E3%81%AB%E3%82%88%E3%82%8B-node-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>nvm による node のインストール</h2>

<p>RUN コマンドは <code>/bin/sh -c</code> として実行されるので source を叩く場合の例。<br>
virtualenv なども同様にすればできるはず。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>RUN git clone git://github.com/creationix/nvm.git /home/ma2/.nvm
RUN /bin/bash -c 'source ~/.nvm/nvm.sh &amp;&amp; nvm install 0.10.26 &amp;&amp; nvm alias default v0.10.26 &amp;&amp; npm install -g grunt grunt-cli bower gulp'
</pre></div></div>

<h2>
<span id="oracle-jdk-のインストール" class="fragment"></span><a href="#oracle-jdk-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Oracle JDK のインストール</h2>

<p>奇特な方が Java 8 使いたいとかいうことがあるのでその人向け。<br>
定番の<code>webupd8team/java</code>を使います。<br>
途中でライセンスに同意しないといけないタイプなので注意です。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>RUN echo oracle-java7-installer shared/accepted-oracle-license-v1-1 select true | /usr/bin/debconf-set-selections

RUN apt-get install -y software-properties-common 
RUN add-apt-repository ppa:webupd8team/java -y \
  &amp;&amp; apt-get update \
  &amp;&amp; apt-get install -y oracle-java7-installer oracle-java6-installer oracle-java8-installer oracle-java8-set-default
</pre></div></div>

<p>また jdk8 ですがすこぶる落ちてくるのが遅かったり、落ちてこなかったりするのでその場合は再度トライして<br>
下さい。<br>
キャッシュが効いているのですぐやり直しできるはずです。</p>

<h1>
<span id="心霊怪奇現象" class="fragment"></span><a href="#%E5%BF%83%E9%9C%8A%E6%80%AA%E5%A5%87%E7%8F%BE%E8%B1%A1"><i class="fa fa-link"></i></a>心霊・怪奇現象</h1>

<h2>
<span id="permission-denied-の話" class="fragment"></span><a href="#permission-denied-%E3%81%AE%E8%A9%B1"><i class="fa fa-link"></i></a>Permission Denied の話</h2>

<h3>
<span id="レア度-" class="fragment"></span><a href="#%E3%83%AC%E3%82%A2%E5%BA%A6-"><i class="fa fa-link"></i></a>レア度 ☆☆☆</h3>

<p>ユーザーを変更して作業する Dockerfile を書いていると build 時に稀に起きます。<br>
明らかに問題がない場合でもおきます。<br>
霊の仕業でしょうか？</p>

<ul>
<li>再度 build し直す</li>
<li>--no-cache で build し直す</li>
</ul>

<p>で <strong>Dokerfile未編集</strong> でうまく行ったりします。<br>
それでもダメな場合は本当に Dockerfile が間違っている可能性があるので見なおしてみましょう。</p>

<h2>
<span id="消せないコンテナの話" class="fragment"></span><a href="#%E6%B6%88%E3%81%9B%E3%81%AA%E3%81%84%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E8%A9%B1"><i class="fa fa-link"></i></a>消せないコンテナの話</h2>

<h3>
<span id="レア度--1" class="fragment"></span><a href="#%E3%83%AC%E3%82%A2%E5%BA%A6--1"><i class="fa fa-link"></i></a>レア度 ☆☆☆☆</h3>

<p>ファイルが消せなくなります。<br>
Stale NFS file handle ってやつですね。<br>
適当にファイルを消すと発生します。<br>
霊の仕業でしょうか？</p>

<p><a href="https://github.com/dotcloud/docker/issues/643" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/dotcloud/docker/issues/643</a><br>
まだ直ってない様子、原因がイマイチ不明な感じがします。<br>
勇気を持ってOSを再起動しましょう。それしか解決方法はありません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>mopemopeさんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>26</kbd>
		<a target="_blank" href="https://qiita.com/mopemope/items/d164b8a892987bd2a9b3">実用的なプログラムの話をする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-10 10:11:00</center>
	</td>
	<td style="width:200px;">
		@mopemope<br />(Abby 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/2526/profile-images/1473681654">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Clojure]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="clojure-で実用的なプログラムを書く" class="fragment"></span><a href="#clojure-%E3%81%A7%E5%AE%9F%E7%94%A8%E7%9A%84%E3%81%AA%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>Clojure で実用的なプログラムを書く</h1>

<p>こんにちわ、wozozoです。<br>
最近、netty 4ベースのフレームワークを書いてるのですが、速度問題でほぼJavaで書いてしまい、書くことがなくなったので過去に作った実用的なプログラムの話をします。<br>
<code>algo.monads</code> の話でも良かったのですが、他に書かれる方がいるでしょう。<br>
たぶんこんなんを書かれると思います。</p>

<div class="code-frame" data-lang="clj"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">ns </span><span class="nv">cljinja.lexer</span>
  <span class="p">(</span><span class="ss">:use</span>
    <span class="p">[</span><span class="nv">clojure.algo.monads</span><span class="p">])</span>
  <span class="p">(</span><span class="ss">:require</span> 
    <span class="p">[</span><span class="nv">clojure.string</span> <span class="ss">:as</span> <span class="nv">str</span><span class="p">])</span>
  <span class="p">(</span><span class="ss">:import</span> 
    <span class="p">[</span><span class="nv">java.util.regex</span> <span class="nv">Pattern</span><span class="p">]))</span>

<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*block-begin*</span> <span class="s">"{%"</span><span class="p">)</span>
<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*block-end*</span> <span class="s">"%}"</span><span class="p">)</span>
<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*variable-begin*</span> <span class="s">"{{"</span><span class="p">)</span>
<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*variable-end*</span> <span class="s">"}}"</span><span class="p">)</span>
<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*comment-begin*</span> <span class="s">"{#"</span><span class="p">)</span>
<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*comment-end*</span> <span class="s">"#}"</span><span class="p">)</span>

<span class="c1">;;</span>
<span class="c1">;; Parsec</span>
<span class="c1">;;</span>

<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">parser-m</span> <span class="p">(</span><span class="nf">state-t</span> <span class="nv">maybe-m</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">return</span> <span class="p">[</span><span class="nv">v</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">with-monad</span> <span class="nv">parser-m</span>
    <span class="p">(</span><span class="nf">m-result</span> <span class="nv">v</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">&gt;&gt;=</span> <span class="p">[</span><span class="nv">p</span> <span class="nv">f</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">with-monad</span> <span class="nv">parser-m</span>
    <span class="p">(</span><span class="nf">m-bind</span> <span class="nv">p</span> <span class="nv">f</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">&gt;&gt;==</span> <span class="p">[</span><span class="nv">p</span> <span class="nv">f</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">p</span> <span class="o">#</span><span class="p">(</span><span class="nf">return</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">%</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">&lt;$&gt;</span> <span class="p">[</span><span class="nv">f</span> <span class="nv">p</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">p</span> <span class="o">#</span><span class="p">(</span><span class="nf">return</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">%</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">&gt;&gt;</span> <span class="p">[</span><span class="nv">p1</span> <span class="nv">p2</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">p1</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">_</span><span class="p">]</span> <span class="nv">p2</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">either</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">parsers</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">apply </span><span class="p">(</span><span class="ss">:m-plus</span> <span class="nv">parser-m</span><span class="p">)</span> <span class="nv">parsers</span><span class="p">))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">&lt;</span><span class="err">|</span><span class="nb">&gt; </span><span class="nv">either</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defmacro </span><span class="nv">let-bind</span>
  <span class="s">"Wraps body in `domonad' boilerplate"</span>
  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">body</span><span class="p">]</span>
  <span class="o">`</span><span class="p">(</span><span class="nf">domonad</span> <span class="nv">parser-m</span>
            <span class="o">~@</span><span class="nv">body</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">state</span> <span class="p">[</span><span class="nv">data</span> <span class="nv">pos</span> <span class="nv">line</span><span class="p">]</span>
  <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> 
   <span class="ss">:pos</span> <span class="nv">pos</span>
   <span class="ss">:line</span> <span class="nv">line</span><span class="p">})</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">inc-newline</span> <span class="p">[</span><span class="nv">line</span> <span class="nv">text</span><span class="p">]</span>
       <span class="p">(</span><span class="nb">+ </span><span class="nv">line</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nb">count </span><span class="p">(</span><span class="nf">str/split</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">char?</span> <span class="nv">text</span><span class="p">)</span> <span class="p">(</span><span class="nb">str </span><span class="nv">text</span><span class="p">)</span> <span class="nv">text</span><span class="p">)</span> <span class="o">#</span><span class="s">"\n"</span><span class="p">)))))</span> 

<span class="p">(</span><span class="kd">defn- </span><span class="nv">any-token</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span> 
  <span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn</span> <span class="ss">:data</span> <span class="nv">pos</span> <span class="ss">:pos</span> <span class="nv">line</span> <span class="ss">:line</span><span class="p">}]</span>
      <span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nb">= </span><span class="s">""</span> <span class="nv">strn</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">data</span> <span class="p">(</span><span class="nb">subs </span><span class="nv">strn</span> <span class="mi">0</span> <span class="nv">n</span><span class="p">)</span>
              <span class="nv">nline</span> <span class="p">(</span><span class="nf">inc-newline</span> <span class="nv">line</span> <span class="nv">data</span><span class="p">)]</span>
          <span class="p">[(</span><span class="nf">state</span> <span class="nv">data</span> <span class="nv">pos</span> <span class="nv">line</span> <span class="p">)</span>
           <span class="p">(</span><span class="nf">state</span> <span class="p">(</span><span class="nb">subs </span><span class="nv">strn</span> <span class="nv">n</span><span class="p">)</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">pos</span> <span class="nv">n</span><span class="p">)</span> <span class="nv">nline</span> <span class="p">)]))))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">eof</span> <span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn</span> <span class="ss">:data</span> <span class="nv">pos</span> <span class="ss">:pos</span> <span class="nv">line</span> <span class="ss">:line</span> <span class="p">}]</span>
  <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">= </span><span class="s">""</span> <span class="nv">strn</span><span class="p">)</span>
    <span class="p">[(</span><span class="nf">state</span> <span class="nv">strn</span> <span class="nv">pos</span> <span class="nv">line</span> <span class="p">)</span>
     <span class="p">(</span><span class="nf">state</span> <span class="nv">strn</span> <span class="nv">pos</span> <span class="nv">line</span> <span class="p">)]))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">nothing</span> <span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn</span> <span class="ss">:data</span> <span class="nv">pos</span> <span class="ss">:pos</span> <span class="nv">line</span> <span class="ss">:line</span> <span class="p">}]</span>
  <span class="p">[(</span><span class="nf">state</span> <span class="s">""</span> <span class="nv">pos</span> <span class="nv">line</span><span class="p">)</span> 
   <span class="p">(</span><span class="nf">state</span> <span class="nv">strn</span> <span class="nv">pos</span> <span class="nv">line</span><span class="p">)])</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">merge-state</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="nv">d1</span> <span class="ss">:data</span> <span class="ss">:as</span> <span class="nv">m</span><span class="p">}</span> <span class="p">{</span><span class="nv">d2</span> <span class="ss">:data</span> <span class="ss">:as</span> <span class="nv">n</span><span class="p">}]</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">m</span> <span class="ss">:data</span> <span class="p">(</span><span class="nb">str </span><span class="nv">d1</span> <span class="nv">d2</span><span class="p">)))</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">stringify</span> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">p</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span> 
             <span class="p">(</span><span class="nf">return</span> 
               <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">vector? </span><span class="nv">x</span><span class="p">)</span>
                 <span class="p">(</span><span class="nf">merge-state</span> <span class="p">(</span><span class="nb">first </span><span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">next </span><span class="nv">x</span><span class="p">))</span>
                 <span class="nv">x</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">satisfy</span> <span class="p">[</span><span class="nv">pred</span> <span class="nv">n</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">domonad</span> <span class="nv">parser-m</span>
           <span class="p">[</span><span class="nv">c</span> <span class="p">(</span><span class="nf">any-token</span> <span class="nv">n</span><span class="p">)</span> <span class="ss">:when</span> <span class="p">(</span><span class="nf">pred</span> <span class="p">(</span><span class="ss">:data</span> <span class="nv">c</span><span class="p">))]</span>
      <span class="nv">c</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">is-char</span> <span class="p">[</span><span class="nv">c</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">satisfy</span> <span class="p">(</span><span class="nb">partial = </span><span class="nv">c</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">not-char</span> <span class="p">[</span><span class="nv">c</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">satisfy</span> <span class="p">(</span><span class="nb">partial </span><span class="p">(</span><span class="nb">comp not </span><span class="nv">=</span><span class="p">)</span> <span class="nv">c</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">is-str</span> <span class="p">[</span><span class="nv">st</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">satisfy</span> <span class="p">(</span><span class="nb">partial = </span><span class="nv">st</span><span class="p">)</span> <span class="p">(</span><span class="nb">count </span><span class="nv">st</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">not-str</span> <span class="p">[</span><span class="nv">st</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">satisfy</span> <span class="p">(</span><span class="nb">partial </span><span class="p">(</span><span class="nb">comp not </span><span class="nv">=</span><span class="p">)</span> <span class="nv">st</span><span class="p">)</span> <span class="p">(</span><span class="nb">count </span><span class="nv">st</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">optional</span> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">either</span> <span class="nv">p</span> <span class="nv">nothing</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">option</span> <span class="p">[</span><span class="nv">default</span> <span class="nv">p</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">either</span> <span class="nv">p</span> <span class="nv">default</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defprotocol </span><span class="nv">RegexParser</span>
  <span class="p">(</span><span class="nf">regex</span> <span class="p">[</span><span class="nv">this</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">extend-protocol</span> <span class="nv">RegexParser</span>
  <span class="nv">java.lang.String</span>
  <span class="p">(</span><span class="nf">regex</span> <span class="p">[</span><span class="nv">this</span><span class="p">]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">re</span> <span class="p">(</span><span class="nb">re-pattern </span><span class="p">(</span><span class="nb">str </span><span class="s">"^(?:"</span> <span class="nv">this</span> <span class="s">")"</span><span class="p">))]</span>
      <span class="p">(</span><span class="nf">regex</span> <span class="nv">re</span><span class="p">)))</span>

  <span class="nv">java.util.regex.Pattern</span>
  <span class="p">(</span><span class="nf">regex</span> <span class="p">[</span><span class="nv">re</span><span class="p">]</span>
    <span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn</span> <span class="ss">:data</span> <span class="nv">pos</span> <span class="ss">:pos</span> <span class="nv">line</span> <span class="ss">:line</span><span class="p">}]</span>
      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">m</span> <span class="p">(</span><span class="nb">re-find </span><span class="nv">re</span> <span class="nv">strn</span><span class="p">)</span>
            <span class="nv">v</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">vector? </span><span class="nv">m</span><span class="p">)</span> <span class="p">(</span><span class="nb">first </span><span class="nv">m</span><span class="p">)</span> <span class="nv">m</span><span class="p">)]</span>
        <span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">v</span><span class="p">))</span>
          <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">len</span> <span class="p">(</span><span class="nb">count </span><span class="nv">v</span><span class="p">)</span>
                <span class="nv">nstr</span> <span class="p">(</span><span class="nb">subs </span><span class="nv">strn</span> <span class="nv">len</span><span class="p">)]</span>
              <span class="c1">; (println (format "'%s'  '%s'  '%s'" re strn nstr))</span>
              <span class="p">[(</span><span class="nf">state</span> <span class="nv">v</span> <span class="nv">pos</span> <span class="nv">line</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">state</span> <span class="nv">nstr</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">pos</span> <span class="nv">len</span><span class="p">)</span> <span class="p">(</span><span class="nf">inc-newline</span> <span class="nv">line</span> <span class="nv">v</span><span class="p">))]))))))</span>

<span class="p">(</span><span class="kd">defmacro </span><span class="nv">string-p</span> <span class="p">[</span><span class="o">^</span><span class="nv">String</span> <span class="nv">target</span><span class="p">]</span>
  <span class="o">`</span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn#</span> <span class="ss">:data</span> <span class="nv">pos#</span> <span class="ss">:pos</span> <span class="nv">line#</span> <span class="ss">:line</span><span class="p">}]</span>
     <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nf">.startsWith</span> <span class="nv">strn#</span> <span class="o">~</span><span class="nv">target</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">len#</span> <span class="p">(</span><span class="nb">count </span><span class="o">~</span><span class="nv">target</span><span class="p">)</span>
             <span class="nv">nstr#</span> <span class="p">(</span><span class="nb">subs </span><span class="nv">strn#</span> <span class="nv">len#</span><span class="p">)]</span>
           <span class="p">[(</span><span class="nf">state</span> <span class="o">~</span><span class="nv">target</span> <span class="nv">pos#</span> <span class="nv">line#</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">state</span> <span class="nv">nstr#</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">pos#</span> <span class="nv">len#</span><span class="p">)</span> <span class="p">(</span><span class="nf">inc-newline</span> <span class="nv">line#</span> <span class="o">~</span><span class="nv">target</span><span class="p">))]))))</span>

<span class="p">(</span><span class="kd">defmacro </span><span class="nv">not-string-p</span> <span class="p">[</span><span class="o">^</span><span class="nv">String</span> <span class="nv">target</span><span class="p">]</span>
  <span class="o">`</span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn#</span> <span class="ss">:data</span> <span class="nv">pos#</span> <span class="ss">:pos</span> <span class="nv">line#</span> <span class="ss">:line</span><span class="p">}]</span>
     <span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nf">.startsWith</span> <span class="nv">strn#</span> <span class="o">~</span><span class="nv">target</span><span class="p">)</span>
       <span class="p">[(</span><span class="nf">state</span> <span class="nv">strn#</span> <span class="nv">pos#</span> <span class="nv">line#</span><span class="p">)</span> <span class="p">(</span><span class="nf">state</span> <span class="nv">strn#</span> <span class="nv">pos#</span> <span class="nv">line#</span><span class="p">)])))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">concat%</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">xs</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">coll</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">vector? </span><span class="nv">x</span><span class="p">)</span> <span class="nv">x</span> <span class="p">[</span><span class="nv">x</span><span class="p">])</span>
        <span class="nv">coll?</span> <span class="p">(</span><span class="nb">vector? </span><span class="nv">xs</span><span class="p">)]</span>
    <span class="p">(</span><span class="k">if </span><span class="nv">coll?</span>
      <span class="p">(</span><span class="nb">into </span><span class="nv">coll</span> <span class="nv">xs</span><span class="p">)</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="s">""</span> <span class="p">(</span><span class="ss">:data</span> <span class="nv">xs</span><span class="p">))</span>
        <span class="nv">x</span> 
        <span class="p">(</span><span class="nb">conj </span><span class="nv">coll</span> <span class="nv">xs</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">declare </span><span class="nv">many1</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">many</span> <span class="p">[</span><span class="nv">parser</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">optional</span> <span class="p">(</span><span class="nf">many1</span> <span class="nv">parser</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">many1</span> <span class="p">[</span><span class="nv">parser</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">let-bind</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">parser</span>
             <span class="nv">as</span> <span class="p">(</span><span class="nf">many</span> <span class="nv">parser</span><span class="p">)]</span>
             <span class="p">(</span><span class="nf">concat%</span> <span class="nv">a</span> <span class="nv">as</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">aspace</span> <span class="p">(</span><span class="nf">regex</span> <span class="o">#</span><span class="s">"[\s\r\n]"</span><span class="p">))</span>
<span class="p">(</span><span class="k">def </span><span class="nv">spaces</span> <span class="p">(</span><span class="nf">regex</span> <span class="o">#</span><span class="s">"[\s\r\n]+"</span><span class="p">))</span>
<span class="p">(</span><span class="k">def </span><span class="nv">spaces*</span> <span class="p">(</span><span class="nf">regex</span> <span class="o">#</span><span class="s">"[\s\r\n]*"</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">white-space</span> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">&gt;&gt;</span> <span class="nv">spaces</span> <span class="nv">p</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">lexeme</span> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">let-bind</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">p</span> <span class="nv">_</span> <span class="nv">spaces</span><span class="p">]</span> <span class="nv">a</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">lexeme*</span> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">let-bind</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">p</span> <span class="nv">_</span> <span class="nv">spaces*</span><span class="p">]</span> <span class="nv">a</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">between</span> <span class="p">[</span><span class="nv">open</span> <span class="nv">close</span> <span class="nv">p</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">let-bind</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">open</span>
             <span class="nv">x</span> <span class="nv">p</span>
             <span class="nv">_</span> <span class="nv">close</span><span class="p">]</span>
            <span class="nv">x</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">sep-by-1</span> <span class="p">[</span><span class="nv">p</span> <span class="nv">sep</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">let-bind</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">p</span>
             <span class="nv">xs</span> <span class="p">(</span><span class="nf">many</span> <span class="p">(</span><span class="nf">&gt;&gt;</span> <span class="nv">sep</span> <span class="nv">p</span><span class="p">))]</span>
            <span class="p">(</span><span class="nf">concat%</span> <span class="nv">x</span> <span class="nv">xs</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defmacro </span><span class="nv">surround</span> <span class="p">[</span><span class="nv">st#</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">stringify</span>
    <span class="p">(</span><span class="nf">between</span> 
      <span class="p">(</span><span class="nf">is-char</span> <span class="nv">st#</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">is-char</span> <span class="nv">st#</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">many</span> <span class="p">(</span><span class="nf">not-str</span> <span class="nv">st#</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nb">parse </span><span class="p">[</span><span class="nv">parser</span> <span class="nv">input</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">parser</span> <span class="p">(</span><span class="nf">state</span> <span class="nv">input</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">)))</span>

<span class="c1">;; </span>
<span class="c1">;; Rule </span>
<span class="c1">;; </span>

<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:private</span> <span class="nv">sp-chars</span> <span class="o">#</span><span class="s">"([\\\\*+\\[\\](){}\\$.?\\^|])"</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">escape-regex</span> <span class="p">[</span><span class="nv">in</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">str/replace</span> <span class="nv">in</span> <span class="nv">sp-chars</span> <span class="s">"\\\\$1"</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">build-regex</span> <span class="p">[</span><span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">str/join</span> <span class="s">"|"</span> <span class="p">(</span><span class="nb">map </span><span class="nv">escape-regex</span> <span class="nv">args</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">create-regex</span> <span class="p">[</span><span class="nv">tags</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">Pattern/compile</span> <span class="p">(</span><span class="nb">str </span><span class="s">"^(.*?)("</span> <span class="p">(</span><span class="nf">build-regex</span> <span class="nv">tags</span><span class="p">)</span> <span class="s">")"</span><span class="p">)</span> <span class="nv">Pattern/DOTALL</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">text-data-p</span> <span class="p">[</span><span class="nv">regex</span><span class="p">]</span>
  <span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn</span> <span class="ss">:data</span> <span class="nv">pos</span> <span class="ss">:pos</span> <span class="nv">line</span> <span class="ss">:line</span> <span class="p">}]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">found</span> <span class="p">(</span><span class="nb">re-find </span><span class="p">(</span><span class="nb">re-matcher </span><span class="p">(</span><span class="nf">create-regex</span> <span class="nv">regex</span><span class="p">)</span> <span class="nv">strn</span><span class="p">))</span>
          <span class="p">[</span><span class="nv">pair</span> <span class="nv">text</span> <span class="nv">token</span><span class="p">]</span> <span class="p">(</span><span class="nb">or </span><span class="nv">found</span> <span class="p">[</span><span class="nv">nil</span> <span class="nv">nil</span> <span class="nv">nil</span><span class="p">])]</span>
      <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">and </span><span class="nv">token</span> <span class="p">(</span><span class="nb">not= </span><span class="nv">token</span> <span class="nv">pair</span><span class="p">))</span>
        <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">len</span> <span class="p">(</span><span class="nb">count </span><span class="nv">text</span><span class="p">)</span>
              <span class="nv">nstr</span> <span class="p">(</span><span class="nf">.substring</span> <span class="nv">strn</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">.length</span> <span class="nv">pair</span><span class="p">)</span> <span class="p">(</span><span class="nf">.length</span> <span class="nv">token</span><span class="p">)))]</span>
          <span class="p">[(</span><span class="nf">state</span> <span class="nv">text</span> <span class="nv">pos</span> <span class="nv">line</span><span class="p">)</span>
           <span class="p">(</span><span class="nf">state</span> <span class="nv">nstr</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">pos</span> <span class="nv">len</span><span class="p">)</span> <span class="p">(</span><span class="nf">inc-newline</span> <span class="nv">line</span> <span class="nv">text</span><span class="p">)</span> <span class="p">)])))))</span> 

<span class="p">(</span><span class="kd">defmacro </span><span class="nv">token</span> <span class="p">[</span><span class="nv">nm</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">nm#</span> <span class="nv">nm</span><span class="p">]</span>
    <span class="o">`</span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn#</span> <span class="ss">:data</span> <span class="nv">pos#</span> <span class="ss">:pos</span> <span class="nv">line#</span> <span class="ss">:line</span> <span class="p">}]</span>
       <span class="p">{</span><span class="ss">:data</span> <span class="nv">strn#</span>
       <span class="ss">:pos</span> <span class="nv">pos#</span>
       <span class="ss">:line</span> <span class="nv">line#</span>
       <span class="ss">:type</span> <span class="o">~</span><span class="nv">nm#</span><span class="p">})))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">op-array</span> <span class="p">[</span>
               <span class="s">"+"</span> <span class="ss">:add</span>
               <span class="s">"-"</span> <span class="ss">:sub</span>
               <span class="s">"/"</span> <span class="ss">:div</span>
               <span class="s">"//"</span> <span class="ss">:floordiv</span>
               <span class="s">"*"</span> <span class="ss">:mul</span>
               <span class="s">"%"</span> <span class="ss">:mod</span>
               <span class="s">"**"</span> <span class="ss">:pow</span>
               <span class="s">"~"</span> <span class="ss">:tilde</span>
               <span class="c1">; "[" :lbracket</span>
               <span class="c1">; "]" :rbracket</span>
               <span class="c1">; "(" :lparen</span>
               <span class="c1">; ")" :rparen</span>
               <span class="c1">; "{" :lbrace</span>
               <span class="c1">; "}" :rbrace</span>
               <span class="s">"=="</span> <span class="ss">:eq</span>
               <span class="s">"!="</span> <span class="ss">:ne</span>
               <span class="s">"&gt;"</span> <span class="ss">:gt</span>
               <span class="s">"&gt;="</span> <span class="ss">:gtEQ</span>
               <span class="s">"&lt;"</span> <span class="ss">:lt</span>
               <span class="s">"&lt;="</span> <span class="ss">:ltEQ</span>
               <span class="s">"="</span> <span class="ss">:assign</span>
               <span class="s">"."</span> <span class="ss">:dot</span>
               <span class="s">":"</span> <span class="ss">:colon</span>
               <span class="s">"|"</span> <span class="ss">:pipe</span>
               <span class="s">","</span> <span class="ss">:comma</span>
               <span class="s">";"</span> <span class="ss">:semicolon</span><span class="p">])</span>

<span class="p">(</span><span class="k">def </span><span class="nv">operators</span> <span class="p">(</span><span class="nb">apply array-map </span><span class="nv">op-array</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defmacro </span><span class="nv">operators-p</span> <span class="p">[]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">re</span> <span class="p">(</span><span class="nf">build-regex</span> <span class="p">(</span><span class="nb">keys </span><span class="nv">operators</span><span class="p">))]</span>
    <span class="o">`</span><span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn#</span> <span class="ss">:data</span> <span class="nv">pos#</span> <span class="ss">:pos</span> <span class="nv">line#</span> <span class="ss">:line</span> <span class="p">}]</span>
              <span class="p">{</span><span class="ss">:data</span> <span class="nv">strn#</span>
              <span class="ss">:pos</span> <span class="nv">pos#</span>
              <span class="ss">:line</span> <span class="nv">line#</span>
              <span class="ss">:type</span> <span class="p">(</span><span class="nb">get </span><span class="nv">operators</span> <span class="nv">strn#</span><span class="p">)})</span>
        <span class="p">(</span><span class="nf">regex</span> <span class="p">(</span><span class="nb">str </span><span class="s">"("</span> <span class="o">~</span><span class="nv">re</span> <span class="s">")"</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">string-literal</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:string</span><span class="p">)</span>
     <span class="p">(</span><span class="nf">&lt;</span><span class="err">|</span><span class="nb">&gt; </span><span class="p">(</span><span class="nf">surround</span> <span class="s">"'"</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">surround</span> <span class="s">"\""</span><span class="p">))))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">name-p</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:name</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">regex</span> <span class="s">"[a-zA-Z_][a-zA-Z0-9_-]*"</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">integer-p</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:integer</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">regex</span> <span class="s">"\\d+"</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">float-p</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:float</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">regex</span> <span class="s">"\\d+\\.\\d+"</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">ident</span> 
   <span class="p">(</span><span class="nf">&lt;</span><span class="err">|</span><span class="nb">&gt; </span><span class="nv">string-literal</span> <span class="nv">name-p</span> <span class="nv">float-p</span> <span class="nv">integer-p</span> <span class="p">(</span><span class="nf">operators-p</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">text-block</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:data</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">text-data-p</span> <span class="p">[</span><span class="nv">*variable-begin*</span> <span class="nv">*block-begin*</span> <span class="nv">*comment-begin*</span> <span class="nv">*variable-end*</span> <span class="nv">*block-end*</span> <span class="nv">*comment-end*</span><span class="p">])))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">rest-text</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:data</span><span class="p">)</span> 
       <span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn</span> <span class="ss">:data</span> <span class="nv">pos</span> <span class="ss">:pos</span> <span class="nv">line</span> <span class="ss">:line</span> <span class="p">}]</span>
           <span class="p">[(</span><span class="nf">state</span> <span class="nv">strn</span> <span class="nv">pos</span> <span class="nv">line</span> <span class="p">)</span>
            <span class="p">(</span><span class="nf">state</span> <span class="s">""</span> <span class="nv">pos</span> <span class="nv">line</span> <span class="p">)])))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">block-begin-p</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:block-begin</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">lexeme*</span> <span class="p">(</span><span class="nf">is-str</span> <span class="nv">*block-begin*</span><span class="p">))))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">block-end-p</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:block-end</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">&gt;&gt;</span> <span class="nv">spaces*</span> <span class="p">(</span><span class="nf">is-str</span> <span class="nv">*block-end*</span><span class="p">))))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">variable-begin-p</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:v-begin</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">lexeme*</span> <span class="p">(</span><span class="nf">is-str</span> <span class="nv">*variable-begin*</span><span class="p">))))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">variable-end-p</span>
  <span class="p">(</span><span class="nf">&lt;$&gt;</span> <span class="p">(</span><span class="nf">token</span> <span class="ss">:v-end</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">&gt;&gt;</span> <span class="nv">spaces*</span> <span class="p">(</span><span class="nf">is-str</span> <span class="nv">*variable-end*</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">fail-state</span> <span class="p">[{</span><span class="o">^</span><span class="nv">String</span> <span class="nv">strn</span> <span class="ss">:data</span> <span class="nv">pos</span> <span class="ss">:pos</span> <span class="nv">line</span> <span class="ss">:line</span> <span class="p">}]</span>
  <span class="p">[{</span><span class="ss">:state</span> <span class="ss">:fail</span> <span class="ss">:data</span> <span class="nv">strn</span> <span class="ss">:pos</span> <span class="nv">pos</span> <span class="ss">:line</span> <span class="nv">line</span><span class="p">}</span>
   <span class="p">(</span><span class="nf">state</span> <span class="nv">strn</span> <span class="nv">pos</span> <span class="nv">line</span><span class="p">)])</span>

<span class="p">(</span><span class="kd">defmacro </span><span class="nv">make-block</span> <span class="p">[</span><span class="nv">begin</span> <span class="nv">end</span> <span class="nv">gurad</span><span class="p">]</span>
  <span class="o">`</span><span class="p">(</span><span class="nf">let-bind</span> <span class="p">[</span><span class="nv">b#</span> <span class="o">~</span><span class="nv">begin</span> 
              <span class="nv">x#</span> <span class="p">(</span><span class="nf">sep-by-1</span> <span class="p">(</span><span class="nf">&gt;&gt;</span> <span class="o">~</span><span class="nv">gurad</span> <span class="nv">ident</span><span class="p">)</span> <span class="nv">spaces</span><span class="p">)</span>
              <span class="nv">e#</span> <span class="p">(</span><span class="nf">option</span> <span class="nv">fail-state</span> <span class="o">~</span><span class="nv">end</span><span class="p">)]</span>
             <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="ss">:fail</span> <span class="p">(</span><span class="ss">:state</span> <span class="nv">e#</span><span class="p">))</span>
               <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">Exception.</span> <span class="p">(</span><span class="nf">format</span> <span class="s">"Template Syntax Error:%s"</span> <span class="nv">e#</span><span class="p">)))</span>
               <span class="p">(</span><span class="nf">concat%</span> <span class="p">(</span><span class="nf">concat%</span> <span class="nv">b#</span> <span class="nv">x#</span><span class="p">)</span> <span class="nv">e#</span><span class="p">))))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">block-block</span> 
     <span class="p">(</span><span class="nf">make-block</span> 
       <span class="nv">block-begin-p</span> <span class="nv">block-end-p</span> <span class="p">(</span><span class="nf">not-string-p</span> <span class="nv">*block-end*</span> <span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">variable-block</span> 
     <span class="p">(</span><span class="nf">make-block</span> 
       <span class="nv">variable-begin-p</span> <span class="nv">variable-end-p</span> <span class="p">(</span><span class="nf">not-string-p</span> <span class="nv">*variable-end*</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">blocks</span> 
     <span class="p">(</span><span class="nf">many1</span> <span class="p">(</span><span class="nf">&lt;</span><span class="err">|</span><span class="nb">&gt; </span><span class="nv">block-block</span>  <span class="nv">variable-block</span> <span class="nv">text-block</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">rule</span>
  <span class="p">(</span><span class="nf">let-bind</span> <span class="p">[</span><span class="nv">c</span> <span class="nv">blocks</span> 
             <span class="nv">cs</span> <span class="nv">rest-text</span><span class="p">]</span>
            <span class="p">(</span><span class="nf">concat%</span> <span class="nv">c</span> <span class="nv">cs</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">lex-</span> <span class="p">[</span><span class="nv">rule</span> <span class="nv">input</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">parse </span><span class="nv">rule</span> <span class="nv">input</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">lex</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">lex-</span> <span class="nv">rule</span> <span class="nv">input</span><span class="p">))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">input</span> <span class="s">"{% extends 'hoge.html' %}</span>
<span class="s">            test</span>
<span class="s">            {% for item in items %}</span>
<span class="s">            {{ item }}</span>
<span class="s">            {% endfor %}</span>
<span class="s">            "</span><span class="p">)</span>
<span class="p">(</span><span class="nf">lex-</span> <span class="nv">rule</span> <span class="nv">input</span><span class="p">)</span>
</pre></div></div>

<h1>
<span id="本題" class="fragment"></span><a href="#%E6%9C%AC%E9%A1%8C"><i class="fa fa-link"></i></a>本題</h1>

<p>というわけで本題</p>

<h2>
<span id="実用的なプログラムクローラーだろ" class="fragment"></span><a href="#%E5%AE%9F%E7%94%A8%E7%9A%84%E3%81%AA%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC%E3%81%A0%E3%82%8D"><i class="fa fa-link"></i></a>実用的なプログラム？クローラーだろ！</h2>

<p>というわけで Clojure でクローラーを書いてみたのを公開しています。<br>
<a href="https://github.com/mopemope/clj-crawler" title="clj-crawler" rel="nofollow noopener" target="_blank">2ch クローラー</a></p>

<p>元々、PostgreSQLの全文検索の評価を行うために、日本語データをかき集めるために書いたものです。<br>
基本的にキャッシュサーバーからの取得です。</p>

<p>普通に書いてるとバーボンハウス行きになるため並列数を制限する工夫が入っています。<br>
ClojureのfutureマクロはExecutors.newCachedThreadPoolで作られたExecutorServiceを使います。<br>
そのためfutureを使うとバンバンThreadが作られ、並列数は制御できません。<br>
そこでキューに貯めて、必要な数だけワーカーを走らせるようになっています。</p>

<div class="code-frame" data-lang="clj"><div class="highlight"><pre><span></span>
<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*sleep-time*</span> <span class="mi">5000</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">dequeue!</span> <span class="p">[</span><span class="nv">queue</span><span class="p">]</span>
  <span class="p">(</span><span class="k">loop </span><span class="p">[]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">q</span> <span class="o">@</span><span class="nv">queue</span>
          <span class="nv">value</span> <span class="p">(</span><span class="nb">first </span><span class="nv">q</span><span class="p">)</span>
          <span class="nv">nq</span> <span class="p">(</span><span class="nb">next </span><span class="nv">q</span><span class="p">)]</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">compare-and-set!</span> <span class="nv">queue</span> <span class="nv">q</span> <span class="nv">nq</span><span class="p">)</span>
        <span class="nv">value</span>
        <span class="p">(</span><span class="nf">recur</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">make-worker</span> <span class="p">[</span><span class="nv">f</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">worker-fn</span> <span class="nv">f</span><span class="p">]</span>
   <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">q</span><span class="p">]</span> 
      <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nb">val </span><span class="p">(</span><span class="nf">dequeue!</span> <span class="nv">q</span><span class="p">)]</span>
        <span class="p">(</span><span class="nf">try</span>
          <span class="p">(</span><span class="nf">debug</span> <span class="p">(</span><span class="nf">format</span> <span class="s">"start call worker val:%s"</span> <span class="nv">val</span><span class="p">))</span>
          <span class="p">(</span><span class="nf">worker-fn</span> <span class="nv">val</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">debug</span> <span class="p">(</span><span class="nf">format</span> <span class="s">"end call worker val:%s remain:%s"</span> <span class="nb">val </span><span class="p">(</span><span class="nb">count </span><span class="o">@</span><span class="nv">q</span><span class="p">)))</span>
          <span class="p">(</span><span class="nf">catch</span> <span class="nv">Exception</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">error</span> <span class="nv">e</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">debug</span> <span class="p">(</span><span class="nf">format</span> <span class="s">"wait:%s ... "</span> <span class="nv">*sleep-time*</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">Thread/sleep</span> <span class="nv">*sleep-time*</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">recur</span> <span class="nv">q</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">start-worker</span> <span class="p">[</span><span class="nv">q</span> <span class="nv">f</span> <span class="nv">nthread</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">p</span> <span class="p">(</span><span class="nf">promise</span><span class="p">)</span>
        <span class="nv">cnt</span> <span class="p">(</span><span class="nf">atom</span> <span class="nv">nthread</span><span class="p">)]</span>
    <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">i</span> <span class="nv">nthread</span><span class="p">]</span>
      <span class="p">(</span><span class="nf">future</span> 
        <span class="p">((</span><span class="nf">make-worker</span> <span class="nv">f</span><span class="p">)</span> <span class="nv">q</span><span class="p">)</span>
        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="p">(</span><span class="nf">swap!</span> <span class="nv">cnt</span> <span class="nv">dec</span><span class="p">))</span>
          <span class="p">(</span><span class="nf">deliver</span> <span class="nv">p</span> <span class="s">"OK"</span><span class="p">))))</span>
    <span class="nv">p</span><span class="p">))</span>

</pre></div></div>

<p>問題は並列にキューに値を突っ込んだり、出したりするわけでそこをどう実装するかってとこです。<br>
あまり使われてるのを見たことがないのですが<code>compare-and-set!</code>で値を比較、問題なければ値を返しています。失敗（この間に別 Thread によって値が変わった）場合にはリトライしています。<br>
いわゆるCASですね。<br>
スクレイピング、データベースアクセス、スレッドなど定番処理が入ってるので良いサンプルだと思います。</p>

<h2>
<span id="実用的なプログラムやっぱクローラーだろ" class="fragment"></span><a href="#%E5%AE%9F%E7%94%A8%E7%9A%84%E3%81%AA%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%84%E3%81%A3%E3%81%B1%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC%E3%81%A0%E3%82%8D"><i class="fa fa-link"></i></a>実用的なプログラム？やっぱクローラーだろ！</h2>

<p>はい、次もやはりクローラーでしょうか。<br>
元々は<code>core.async</code>が出たばっかの頃に試してみたくて書いたものです。<br>
全部は言いませんが、要は小さな図書館を作るクローラーです。<br>
<a href="https://bitbucket.org/hentai/clj-hentai" title="clj-hentai" rel="nofollow noopener" target="_blank">hentai</a></p>

<p><code>core.async</code>のサンプルとしてはなかなか良いサンプルだと思います。<br>
他に<code>clojure.tools.logging</code>,コマンドラインのオプションを処理する <code>clojure.tools.cli</code>も使っています。<br>
他にも書かれている方もいるかと思いますが <code>go</code>マクロはCPU数 + 2 のスレッドプールで処理を行います。そのため、ガンガン <code>go</code>マクロを使っても並列数は一定になります。<br>
並列数を制限したくない場合には <code>thread</code> マクロを使うと良いでしょう。<br>
また<code>go</code>マクロ内で例外が発生しても握りつぶされてしまうので必ずキャッチしてchannelなどを使って知らせるようにするべきです。</p>

<p>というわけで特にネタがないので過去のネタを使いまわしたという話でした。</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
