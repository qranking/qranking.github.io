<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (zoetro)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (zoetro さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>698</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/a45dbc18bb2b22e944b2">AngularJSのMVWパターンを理解する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-25 22:21:49</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[AngularJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>12/4の記事（<a href="http://qiita.com/zoetro/items/46d2a8b57f2645bb5033" id="reference-2baed62704762784783d">AngularJSを使ったWebアプリのアーキテクチャ設計</a>）で書くと言ったまま放置していたので、AngularJSのMVCパターンについて書いてみたいと思います。</p>

<p>AngularJSのMVCについては、12/19の<a href="http://qiita.com/icoxfog417/items/2ac773c33a8b34288551" id="reference-b385afb31d2cebb1f75d">お前のAngular.jsはもうMVCではない。と言われないためのTutorial</a>というすばらしい記事がありますが、本記事ではもう少し抽象的な内容を扱ってみようかと思います。</p>

<h1>
<span id="mvwmodel-view-whateverパターンとは" class="fragment"></span><a href="#mvwmodel-view-whatever%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>MVW（Model-View-Whatever）パターンとは</h1>

<p>MVCパターンには、MVC2、MVP、MVVMなど数多くの派生パターンがあります。<br>
目的は同じなのに派生パターンがたくさんあるのは、それぞれのプラットフォーム固有の問題（フレームワークの違いや、サーバサイドかクライアントサイドかの違いなど）によってMV*の*の役割が異なるからです。</p>

<p>AngularJSは公式ページで"Superheroic JavaScript MVW Framework"と名乗っているので、またMVWなんていう新しいパターンが出てくるのかとゲンナリするかもしれません。<br>
でもこれ、MVWという新しいパターンが提唱されているわけではないようです。</p>

<p>AngularJSの開発者はこんなことを言っていました。（<a href="https://plus.google.com/+AngularJS/posts/aZNVhj355G2" rel="nofollow noopener" target="_blank">引用元</a>）</p>

<blockquote>
<p>Having said, I'd rather see developers build kick-ass apps that are well-designed and follow separation of concerns, than see them waste time arguing about MV* nonsense. And for this reason, I hereby declare AngularJS to be MVW framework - Model-View-Whatever. Where Whatever stands for "whatever works for you".</p>
</blockquote>

<p>「MV*について議論するのは時間の無駄だから、そんな暇があったらコードを書け。MV*の*の部分なんて"Whatever"でいいんだ。」という主張のようです。</p>

<p>言いたいことは分かりますが、だからといってWhateverなんて名前をつけたらControllerに何でもかんでも詰め込んでFat Controllerになってしまいそうです。<br>
というわけで、時間の無駄だと言われてしまうのかもしれませんが、AngularJSのMVWパターンについて解説したいと思います。</p>

<h1>
<span id="modelviewwhateverの役割分担" class="fragment"></span><a href="#modelviewwhatever%E3%81%AE%E5%BD%B9%E5%89%B2%E5%88%86%E6%8B%85"><i class="fa fa-link"></i></a>Model・View・Whateverの役割分担</h1>

<p>MV*パターン適用の目的は<a href="http://capsctrl.que.jp/kdmsnr/wiki/bliki/?PresentationDomainSeparation" rel="nofollow noopener" target="_blank">プレゼンテーションとドメインの分離</a>です。<br>
そこで、プレゼンテーション層とドメイン層に大きく分けた上で、それぞれの関係を図示してみました。</p>

<p><a href="https://camo.qiitausercontent.com/3d652c193fde4c8e435c39030dd52e55d99f5924/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f65333832323963312d323464302d336564332d343862302d6132643537303264666463322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3d652c193fde4c8e435c39030dd52e55d99f5924/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f65333832323963312d323464302d336564332d343862302d6132643537303264666463322e706e67" alt="AngularJSMVC.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3489/e38229c1-24d0-3ed3-48b0-a2d5702dfdc2.png"></a></p>

<p>以降で各役割について解説します。</p>

<h2>
<span id="model" class="fragment"></span><a href="#model"><i class="fa fa-link"></i></a>Model</h2>

<p>Modelは他のMV*パターンと違いはありません。つまり、プレゼンテーションに関わらない部分すべてがModelになります。<br>
アプリケーションにもよりますが、次のような役割を持つことが多いでしょう。</p>

<ul>
<li>ビジネスロジック</li>
<li>データの入れ物</li>
<li>サーバーサイドとの通信</li>
<li>ローカルストレージ</li>
<li>etc.</li>
</ul>

<p>他のフレームワークとの違いがあるとすれば、基本的にイベント通知の処理を実装する必要がない（例外はありますが）ところでしょうか。PureなJavaScriptのオブジェクトが使えるので実装が楽になりますね。</p>

<p>また、AngularJSのDI機能を利用してControllerとModelの関係を疎結合にすることができます。可能なところはどんどんService化するのがよさそうです。</p>

<h2>
<span id="view" class="fragment"></span><a href="#view"><i class="fa fa-link"></i></a>View</h2>

<p>Viewの役割は、レイアウトとプレゼンテーションロジックに分けることができます。</p>

<p>レイアウトを独自のDSLで記述したり、コードで記述するようなフレームワークもありますが、AngularJSはHTMLでレイアウトを記述します。<br>
ただしAngularJSでは、Directiveという機能で新しいタグや要素を自由に追加することができるので、HTMLの形をしたDSLと言ってしまってもよいかもしれません。</p>

<p>DOMを操作するような複雑なプレゼンテーションロジックは、Directiveの中に閉じ込めてしまうので、HTMLのレイアウトは宣言的に記述することができ、可読性も高くなります。</p>

<h2>
<span id="controller--scope" class="fragment"></span><a href="#controller--scope"><i class="fa fa-link"></i></a>Controller &amp; Scope</h2>

<h3>
<span id="scopeの役割" class="fragment"></span><a href="#scope%E3%81%AE%E5%BD%B9%E5%89%B2"><i class="fa fa-link"></i></a>Scopeの役割</h3>

<p>Scopeは画面を描画するために必要な状態をストアする役割です。<br>
MVVMパターンを知っている人にとっては、ViewModelと同じような役割を担っていると言えば分かりやすいでしょう。</p>

<p>クライアントMVCフレームワークを使わなかった場合、画面への描画内容と、描画するための状態（プレゼンテーションステート）は区別せず、DOMに両方の役割を持たせるのが一般的だと思います。<br>
しかし、その方法では状態を管理することが難しく、ソースコードの可読性も低くなってしまいます。<br>
そこで、AngularJSでは、DOMは画面の描画のためだけに使い、状態の保持はScopeで行うように役割分担をしています。<br>
これにより、データの操作方法は明確になり、同一のデータを複数の場所に描画したり、異なる方法で描画するといったことが行い易くなっています。</p>

<h3>
<span id="controllerの役割" class="fragment"></span><a href="#controller%E3%81%AE%E5%BD%B9%E5%89%B2"><i class="fa fa-link"></i></a>Controllerの役割</h3>

<p>ControllerはScopeをセットアップするための役割で、次のような仕事をします。</p>

<ul>
<li>Scopeにサービスの呼び出しを結びつける</li>
<li>Scopeの保持するデータを初期化する</li>
<li>Modelのイベント通知をScopeに結びつける</li>
</ul>

<p>Controllerにはビジネスロジックもプレゼンテーションロジックも書けるし、何かと太りがちな存在です。<br>
ビジネスロジックはModelへ、プレゼンテーションロジックはDirectiveやFilterへ移譲し、できるだけControllerが太らないように気をつけなければなりません。</p>

<h3>
<span id="controllerの分割" class="fragment"></span><a href="#controller%E3%81%AE%E5%88%86%E5%89%B2"><i class="fa fa-link"></i></a>Controllerの分割</h3>

<p>画面に要素を追加していくと、Scopeのメンバが増え、Controllerに渡すServiceの数も増えていきます。<br>
もしそれが多すぎるのだとしたら、1つのControllerに役割を持たせすぎている可能性があります。</p>

<p>1画面につき1 Controllerにする必要はないので、画面内の要素ごとに分割したり、階層構造を作ったり、ng-repeat内の1要素ずつにControllerを割り当てたり、必要に応じて分割しましょう。</p>

<p>例えば、次のようにサイドバーと入力フォームと一覧表示部分と全体の親をそれぞれ別のControllerに分割したりします。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-controller</span><span class="o">=</span><span class="s">"MainController"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-controller</span><span class="o">=</span><span class="s">"SideBarController"</span><span class="p">&gt;</span>
    サイドバー
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-controller</span><span class="o">=</span><span class="s">"InputAreaController"</span><span class="p">&gt;</span>
    入力フォーム
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-controller</span><span class="o">=</span><span class="s">"ListControlelr"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-repeat</span><span class="o">=</span><span class="s">"item in items"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">my-directive</span> <span class="na">data</span><span class="o">=</span><span class="s">"item"</span> <span class="p">&gt;&lt;/</span><span class="nt">my-directive</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>コントローラを分離するとコントローラ間でデータ共有をする必要がでてきますが、手段はいくつか用意されています。</p>

<ul>
<li><a href="http://qiita.com/sunny4381/items/aeae1e154346b5cf6009" id="reference-9868df8bbd24683a7f79">Angular JS で複数のコントローラ間でモデル（状態や値）を共有する方法 3 種類</a></li>
</ul>

<p>Controllerを再利用しないのであれば親子関係を作ってやりとりし、そうでなければイベントでやりとりするのがおすすめです。<br>
共通のサービスを使ったり<code>$rootScope</code>を使ったりするのはグローバル変数と変わりないので、最終手段にするのがよいかと思います。</p>

<h1>
<span id="参考情報" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1"><i class="fa fa-link"></i></a>参考情報</h1>

<p>本記事の内容は下記のスライドの考え方を参考にさせてもらっています。<br>
XAML系プラットフォームの知識がなくても理解できる内容ですので、ぜひともあわせて読んでみてください。</p>

<ul>
<li><a href="https://www.slideboom.com/presentations/591514/GUI%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E5%9F%BA%E7%A4%8E%E3%81%8B%E3%82%89MVVM%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%B8" rel="nofollow noopener" target="_blank">GUIアーキテクチャパターンの基礎からMVVMパターンへ</a></li>
</ul>

<h1>
<span id="おしまい" class="fragment"></span><a href="#%E3%81%8A%E3%81%97%E3%81%BE%E3%81%84"><i class="fa fa-link"></i></a>おしまい</h1>

<p>AngularJS Startup Advent Calendar 2013みごと完走ですね。<br>
参加された皆様、特に発起人で13本もの記事を書かれた<a href="/matsuzan" class="user-mention js-hovercard" title="matsuzan" data-hovercard-target-type="user" data-hovercard-target-name="matsuzan">@matsuzan</a>さん、お疲れ様でした！<br>
読んでくれた皆様もありがとうございました！</p>

<p>始まる前は登録者も少なくて完走できるかどうか心配だったのですが杞憂でしたね。</p>

<p>この調子でAngularJSが盛り上がっていって欲しいものです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>567</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/46d2a8b57f2645bb5033">AngularJSを使ったWebアプリのアーキテクチャ設計</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-04 00:37:24</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[AngularJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>AngularJSは公式で分かりやすいチュートリアルが用意されているし、日本語の記事も増えてきたし、けっこう簡単に使い始めることができるんじゃないかと思います。</p>

<p>でも、チュートリアルやサンプルはクライアントサイドオンリーなことが多くて、サーバーサイドも含めたWebアプリを作ろうと思うと、どういう構成にすればいいのか迷うのではないでしょうか？（僕がそうでした）</p>

<p>最初は試行錯誤していたのですが、書籍やネットの記事を読んだりGitHubで見つけたアプリを真似たりしているうちに、どういう構成にすればいいのかだんだん見えてきたので、解説してみたいと思います。</p>

<h1>
<span id="spa" class="fragment"></span><a href="#spa"><i class="fa fa-link"></i></a>SPA</h1>

<p>最近、SPA（Single Page Applicationまたは Single Page Web Application）という言葉をよく耳にするようになりました。</p>

<p>SPAとは、最初のページだけ通常のWebアプリと同じようにサーバーからHTMLを取得して表示し、それ以降は、AJAXを利用してデータやテンプレートを取得しつつ、クライアントサイドで画面を書き換えたりページ遷移を行うような構成のWebアプリケーションのことです。</p>

<p>AngularJSを始めとするクライアントMVCのフレームワークを使ってアプリケーションを作る場合、SPAの構成にするのが一般的なようです。（もちろん、AngularJSを使ってSPAじゃない構成にすることも可能です）</p>

<p>では、なぜSPAを採用するのでしょうか？<br>
それは、よりネイティブアプリケーションに近いUIを提供するためです。<br>
ユーザーが操作するたびにサーバーに問い合わせてHTMLを生成するよりも、クライアントサイドでできることはできるだけクライアントサイドで行ったほうが早いですし、より細かなインタラクションが実現できます。</p>

<p>一方、静的コンテンツが多くて動きの少ないアプリケーションの場合、SPAにするメリットは少ないです。<br>
また、クローラー対策が面倒だったりするので、SEOを重視する場合は向いていないかもしれません。</p>

<h1>
<span id="サーバーサイドとクライアントサイドの役割" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%B5%E3%82%A4%E3%83%89%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%B5%E3%82%A4%E3%83%89%E3%81%AE%E5%BD%B9%E5%89%B2"><i class="fa fa-link"></i></a>サーバーサイドとクライアントサイドの役割</h1>

<p>さて、SPAにすることが決まったら、サーバーサイドとクライアントサイドの役割分担は明確になります。</p>

<p>SPAの構成では、今までサーバーサイドで行っていた処理の多くをクライアントサイドに移譲することになります。<br>
よって、サーバーサイドは以下のようにシンプルになります。</p>

<ul>
<li>MVCパターンのViewにあたるものが不要となる</li>
<li>主な役割はJSONを返すRESTfulなAPI</li>
<li>基本的にステートレス。状態を持つとしても認証情報などの限られたものだけ</li>
</ul>

<p>一方のクライアントサイドは複雑で規模も大きくなります。</p>

<ul>
<li>保守性向上のためMVCパターンを適用し、プレゼンテーション層とドメイン層を分離する</li>
<li>ユーザーの操作に応じてインタラクティブに動くリッチクライアント</li>
<li>ステートフル</li>
</ul>

<p>クライアントMVCについて説明するとちょっと長くなりそうなので、詳細については次回の記事で解説したいと思います。</p>

<h1>
<span id="ビルドツール" class="fragment"></span><a href="#%E3%83%93%E3%83%AB%E3%83%89%E3%83%84%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>ビルドツール</h1>

<p>Play FrameworkやRuby on Railsのようなサーバーサイドのフレームワークには、JavaScriptやCSSを結合・圧縮してくれたり、altJSをコンパイルしてくれたりするような仕組みがあります。<br>
僕も最初はこの機能を使ってAngularJSアプリの開発を行なっていました。<br>
だけど、サーバーサイドのフレームワークに付属するこれらの機能はあくまでもオマケであって、ちょっと込み入ったことをしようとすると機能不足を感じてしまいます。</p>

<p>そこで、餅は餅屋、クライアントサイドにはクライアントサイド用のツールを使うのがよいと判断しました。<br>
ビルドプロセスはGruntで記述し、パッケージ管理はBower、ひな形の自動生成はYeoman、テストランナーはKarmaなどなど、便利なツールがたくさんあります。最初は覚えるのが大変ですが、使いこなせば捗ります。<br>
最近よく使われるツールについては、下記のスライドがまとまっていて分かりやすいです。</p>

<ul>
<li><a href="https://speakerdeck.com/naoya/javascripthurontoendokai-fa-falsezuo-jin" rel="nofollow noopener" target="_blank">JavaScriptフロントエンド開発の昨今</a></li>
</ul>

<h1>
<span id="ディレクトリ構成" class="fragment"></span><a href="#%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>ディレクトリ構成</h1>

<p>Play FrameworkやRuby on Railsでは、サーバーサイドのソースコードを<code>app</code>に、クライアントサイドのソースコードを<code>app/assets</code>格納し、静的コンテンツを<code>public</code>に格納する構成となっています。<br>
しかし、今回はGruntなどクライアントサイドのツールを使うことにしたので、<code>app/assets</code>ディレクトリは使いません。<br>
代わりに<code>ui</code>ディレクトリ（名前は何でもよいです）を追加し、クライアント用のソースコードやGruntfileなどをこの中に配置します。<br>
そして、<code>ui</code>ディレクトリ内でGruntを実行すると、コンパイル結果のJavaScriptやCSSを<code>public</code>ディレクトリに配置するようにします。</p>

<p>ディレクトリ構成例を以下に示します。（説明に不要なディレクトリは省略しています）</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Project
 ├ app      サーバーサイドのソースコード
 ├ public   静的コンテンツ
 └ ui       クライアントサイドのソースコード
</pre></div></div>

<p>サーバーサイドにPlay Frameworkを使っている場合は下記のソースコードが参考になります。</p>

<ul>
<li><a href="https://github.com/leon/play-grunt-angular-prototype" rel="nofollow noopener" target="_blank">Play Grunt / Angular Prototype</a></li>
</ul>

<p>Ruby on Railsを使っている場合は下記の記事が分かりやすいです。</p>

<ul>
<li><a href="http://bokukoko.hatenablog.com/entry/20130825/1377415299" rel="nofollow noopener" target="_blank">理想的な Rails, AngularJS 環境の構築</a></li>
</ul>

<h1>
<span id="ルーティング" class="fragment"></span><a href="#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>ルーティング</h1>

<p>"シングルページ"と言われると、ページごとにURLが振られないから個別にブックマークもできないし、戻るボタンや進むボタンも使えなくて不便じゃないの？と思われるかもしれませんがそんなことはありません。<br>
AngularJSでは、HTML5のpushState/popStateを利用することにより、クライアントサイドでページの切り替えを行いつつ、それに合わせてURLの変更を行うことができます。（HTML5モードを有効にした場合。参考：<a href="http://qiita.com/shogogg/items/542bd6d18f777bcc24bc" id="reference-035408190516350da7bd">AngularJS の $locationProvider.html5Mode について</a>）</p>

<p>僕は最初このあたりの仕組みをちゃんと理解できていなかったので、サーバーサイドとクライアントサイドのルーティングをどう使い分ければいいのか少し悩みました。<br>
分かってしまえば全然難しくないんですけどね。<br>
というわけで、<a href="https://github.com/leon/play-grunt-angular-prototype" rel="nofollow noopener" target="_blank">先ほどで紹介したPlay+AngularJSのサンプル</a>のルーティング設定を図示してみました。</p>

<p><a href="https://camo.qiitausercontent.com/45e52abffdedaf10ff1868450abeaeaae625e3e6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f36623961323339612d373830652d636133362d663062652d3934373831313938373038662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/45e52abffdedaf10ff1868450abeaeaae625e3e6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f36623961323339612d373830652d636133362d663062652d3934373831313938373038662e706e67" alt="routing.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3489/6b9a239a-780e-ca36-f0be-94781198708f.png"></a></p>

<p>初回のページ取得はサーバーに問い合わせ、それ以降のユーザー操作はクライアントサイドで捌き、裏でAJAXを使ってサーバーからデータやテンプレートを取得する構成となっています。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>アーキテクチャ設計は、システムの特性に応じて考えなければならないものなので、今回解説した内容がどんなアプリにでも適用できるというわけではありませんが、少しでも考え方の参考になればうれしいです。</p>

<h1>
<span id="参考情報" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1"><i class="fa fa-link"></i></a>参考情報</h1>

<ul>
<li><a href="http://singlepageappbook.com/" rel="nofollow noopener" target="_blank">Single page apps in depth</a></li>
<li><a href="http://www.amazon.co.jp/Mastering-Web-Application-Development-AngularJS-ebook/dp/B00EQ67J30" rel="nofollow noopener" target="_blank">Mastering Web Application Development with AngularJS</a></li>
<li><a href="https://www.slideboom.com/presentations/591514/GUI%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E5%9F%BA%E7%A4%8E%E3%81%8B%E3%82%89MVVM%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%B8" rel="nofollow noopener" target="_blank">GUIアーキテクチャパターンの基礎からMVVMパターンへ</a></li>
<li><a href="http://wazanova.jp/post/64057743910/mvc-gogaruco-2013" rel="nofollow noopener" target="_blank">ダブルMVCの意味するところ</a></li>
<li><a href="http://www.amazon.co.jp/dp/4798105538" rel="nofollow noopener" target="_blank">エンタープライズ アプリケーションアーキテクチャパターン</a></li>
<li><a href="http://www.amazon.co.jp/dp/4048865366" rel="nofollow noopener" target="_blank">サービスデザインパターン</a></li>
<li><a href="http://d.hatena.ne.jp/kazuk_i/20110407/1302130947" rel="nofollow noopener" target="_blank">Backbone.jsを利用したクライアントサイドMVCの導入についてそろそろ書いておくか</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>303</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/5156aef51222e81dd022">AngularJSのパフォーマンス改善入門</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-11 00:22:56</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[AngularJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>これまでAngularJSでアプリを作ってきた中で、いくつかパフォーマンスの問題に遭遇しました。<br>
それらの問題は、AngularJSの仕組みを十分に理解できていないために、よくないコードを書いてしまって発生しているものでした。</p>

<p>というわけで、AngularJSの内部構造を解説しつつ、パフォーマンスを改善するコードの書き方を紹介したいと思います。</p>

<h1>
<span id="計測できないものは改善できない" class="fragment"></span><a href="#%E8%A8%88%E6%B8%AC%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%82%82%E3%81%AE%E3%81%AF%E6%94%B9%E5%96%84%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>計測できないものは改善できない</h1>

<p>パフォーマンス問題に取り組むには、ソースコード修正の前後でパフォーマンスを計測し、改善の効果を計測することが重要になります。<br>
というわけでまずはツールの紹介です。</p>

<p>AngularJSでは、Batarangという便利なツール（Chrome Developer Toolsの拡張機能）が用意されています。<br>
利用方法はとても簡単で、下記のChromeウェブストアからインストールして、Chrome Developer Toolsを起動し、AngularJSタブのEnableにチェックを入れるだけです。</p>

<ul>
<li><a href="https://chrome.google.com/webstore/detail/angularjs-batarang/ighdmehidhipcmcojjgiloacoafjmpfk" class="autolink" rel="nofollow noopener" target="_blank">https://chrome.google.com/webstore/detail/angularjs-batarang/ighdmehidhipcmcojjgiloacoafjmpfk</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/4caa6e69b89050dd4a9bb52fc6fda16a45e0f775/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f66393433333431312d616231302d636361362d613435662d6366306238636135653532352e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4caa6e69b89050dd4a9bb52fc6fda16a45e0f775/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f66393433333431312d616231302d636361362d613435662d6366306238636135653532352e706e67" alt="batarang1_withlabel.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3489/f9433411-ab10-cca6-a45f-cf0b8ca5e525.png"></a></p>

<p>このツールで、<code>$scope</code>のツリー構造を見ることができたり、パフォーマンスの計測ができたり、モジュールの依存関係グラフが表示できたりします。<br>
パフォーマンスのタブでは、処理時間のかかっている箇所が一目で分かるようになっています。</p>

<p><a href="https://camo.qiitausercontent.com/ee0496354f6c055f2c431f43c4c4656257804086/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f36343338386333382d353665352d623436302d623566352d3561633264613262656439382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ee0496354f6c055f2c431f43c4c4656257804086/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f36343338386333382d353665352d623436302d623566352d3561633264613262656439382e706e67" alt="batarang3_withlabel.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3489/64388c38-56e5-b460-b5f5-5ac2da2bed98.png"></a></p>

<p>このツールはすごく簡単に使えますが結果がざっくりとしているので、より詳しく解析したければChrome Developer Toolsのプロファイリング機能などを使いましょう。</p>

<h1>
<span id="仕組みを知る" class="fragment"></span><a href="#%E4%BB%95%E7%B5%84%E3%81%BF%E3%82%92%E7%9F%A5%E3%82%8B"><i class="fa fa-link"></i></a>仕組みを知る</h1>

<p>パフォーマンス改善を行うためには、フレームワークの仕組みを知り、何がボトルネックになるのかを理解しておくことが重要です。<br>
AngularJSでは双方向のデータバインディングの仕組みがとても便利ですが、パフォーマンスの影響が出やすい機能でもあるので、その仕組みを見てみましょう。</p>

<p>データバインディングの仕組みの実現方法はいくつかあります。<br>
例えばKnockout.jsでは、データの値が変化した時にイベントリスナでViewに通知する方式をとっています。</p>

<p>一方、AngularJSでは、dirty-checkingと呼ばれる方式で実装されています。<br>
これは、バインドしているすべての変数について、特定のタイミングで前回の値と今回の値を比較し、値に変化があればDOMを書き換えるという仕組みです。</p>

<p>ざっくりと以下のような流れで動いています。</p>

<ol>
<li>HTMLを解析してディレクティブをコンパイルする際に、バインドされている変数を<code>$scope.$watch()</code>で登録します。</li>
<li>
<code>$rootScope</code>から子のscopeを順にたどり、watchで登録されたすべての変数の変更チェックを行います。この処理のことを<code>$digest</code>ループと呼び、下記のようなタイミングで実行されます。（定期的なポーリングはしていません）

<ul>
<li>
<code>$scope.$apply()</code>を呼んだ時</li>
<li>DOMイベント（テキストボックスのonChange、ボタンのonClickなど）が発生した後</li>
<li>
<code>$http</code>や<code>$resource</code>でレスポンスが返ってきた後</li>
<li>
<code>$timeout</code>のイベントが発生した後</li>
<li>
<code>$location</code>でURLを変更した後</li>
</ul>
</li>
<li>変更チェックが完了したら、変更があった部分のDOM書き換えを行います。</li>
</ol>

<p>dirty-checking方式は、このように多くのオブジェクトの比較処理を行う仕組みなので、イベントリスナ方式に比べるとパフォーマンスの問題が起こりやすそうですね。<br>
でもこの実装方法を採用することで、PureなJavaScriptオブジェクトをModelとして利用できたり、監視対象のオブジェクト間の依存関係を難しく考える必要がないというメリットもあります。</p>

<p>ちなみに、将来的にはdirty-checking方式から<code>Object.observe</code>に置き変えることも考えられているようです。（<a href="http://blog.angularjs.org/2012/07/angularjs-10-12-roadmap.html" rel="nofollow noopener" target="_blank">参考</a>←ちょっと古い情報ですが）</p>

<h1>
<span id="改善する" class="fragment"></span><a href="#%E6%94%B9%E5%96%84%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>改善する</h1>

<h2>
<span id="digestループ内の処理はできるだけ少なく軽量に" class="fragment"></span><a href="#digest%E3%83%AB%E3%83%BC%E3%83%97%E5%86%85%E3%81%AE%E5%87%A6%E7%90%86%E3%81%AF%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%A0%E3%81%91%E5%B0%91%E3%81%AA%E3%81%8F%E8%BB%BD%E9%87%8F%E3%81%AB"><i class="fa fa-link"></i></a><code>$digest</code>ループ内の処理はできるだけ少なく軽量に</h2>

<p><code>$digest</code>ループでは、watchしている変数の数とその変数の比較処理時間がパフォーマンスに大きく影響します。<br>
なので、watchする変数の数はできるだけ少なく、オブジェクトの比較処理はできるだけ軽くするのが基本です。</p>

<p>watchする変数の数の目安は2000個以下、比較処理時間の目安は25μsecだと言われています。（<a href="http://stackoverflow.com/questions/9682092/databinding-in-angularjs" rel="nofollow noopener" target="_blank">参考</a>）<br>
25μsec×2000回であれば50msec以内に処理を完了できるので、ユーザーの体感としては十分に速いと感じられるからだそうです。</p>

<p>Batarangを使うと<code>$scope</code>のツリー構造が視覚化されるので、watchしている変数の数の目安になります。</p>

<p><a href="https://camo.qiitausercontent.com/e273e628fc68cf7b702b67f168bfd8cfab05256d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f64336239656535372d393264392d326666352d363665362d3362626462326264383566372e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e273e628fc68cf7b702b67f168bfd8cfab05256d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f64336239656535372d393264392d326666352d363665362d3362626462326264383566372e706e67" alt="batarang2_withlabel.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3489/d3b9ee57-92d9-2ff5-66e6-3bbdb2bd85f7.png"></a></p>

<p>オブジェクトの比較処理については通常はそれほど意識しなくても大丈夫です。<br>
<code>$scope.$watch()</code>の第1引数には監視対象のプロパティ名を文字列で渡すことが多いですが、監視対象の値を返すfunctionを指定することもできます。この場合、functionの中では重たい処理を書かないようにしましょう。</p>

<p>また、<code>$scope.$apply()</code>は<code>$rootScope</code>からすべての子要素に対して変更チェックを行いますが、<code>$scope.$digest()</code>は現在のスコープからの子要素に対して変更チェックを行います。<br>
手動で<code>$scope.$apply()</code>を呼び出すときは、<code>$scope.$digest()</code>で置き換えられないかどうか検討してみましょう。</p>

<h2>
<span id="フィルタでは重たい処理をしない" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%A7%E3%81%AF%E9%87%8D%E3%81%9F%E3%81%84%E5%87%A6%E7%90%86%E3%82%92%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>フィルタでは重たい処理をしない</h2>

<p>以前、markdownフォーマットの文字列をレンダリング用のHTMLに変換するようなフィルタを作成し、<code>ngRepeat</code>の中でそのフィルタを使うコードを書きました。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-controller</span><span class="o">=</span><span class="s">"MyController"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">ng-model</span><span class="o">=</span><span class="s">"content"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">ng-click</span><span class="o">=</span><span class="s">"addItem()"</span><span class="p">&gt;</span>add<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-repeat</span><span class="o">=</span><span class="s">"item in items"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-html-bind</span><span class="o">=</span><span class="s">"item.content | markdown"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'MyApp'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">'MyController'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">addItem</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">content</span><span class="o">:</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">content</span><span class="p">});</span>
    <span class="p">};</span>
  <span class="p">});</span>

<span class="cm">/* markdown変換用のフィルタ */</span>
<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'MyApp'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s1">'markdown'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">marked</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">});</span>
</pre></div></div>

<p>しかしこの実装では、テキストボックスに1文字入力するたびに、<code>items</code>リストの要素数分だけmarkdownフィルタが実行されてしまい、非常に重たくて使い物になりませんでした。</p>

<p>実はフィルタはレンダリングの時にだけ使うのではなく、<code>$digest</code>ループで比較処理を行う際にも呼び出されています。（値が変化した時には比較用とレンダリング用の2回フィルタが呼ばれます。）<br>
よってフィルタの処理はできるだけ軽くしなければなりません。</p>

<p>markdownをHTMLに変換するような重たい処理はフィルタで実装するのではなく、変換結果を<code>$scope</code>に持たせておくのがよいのでしょうね。</p>

<h2>
<span id="ngshownghideとngifの使い分け" class="fragment"></span><a href="#ngshownghide%E3%81%A8ngif%E3%81%AE%E4%BD%BF%E3%81%84%E5%88%86%E3%81%91"><i class="fa fa-link"></i></a>ngShow/ngHideとngIfの使い分け</h2>

<p>AngularJSでは、HTML要素の表示・非表示を切り替えるためのディレクティブとして、<code>ngShow</code> / <code>ngHide</code>と<code>ngIf</code>が用意されています。<br>
これらはほぼ同じ機能なんですが、実装方法が異なります。<br>
<code>ngShow</code> / <code>ngHide</code>はCSSで表示を切り替えていて、<code>ngIf</code>はDOMの追加と削除を行うようになっています。（<a href="http://angularjsninja.com/blog/2013/08/27/ngshow-nghide-ngswitch/" rel="nofollow noopener" target="_blank">参考</a>）</p>

<p>例えば、以下のようにタイトルだけが一覧で表示されていて、タイトルをクリックすると詳細が開くようなUIを考えてみましょう。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-repeat</span><span class="o">=</span><span class="s">"item in items"</span> <span class="na">ng-controller</span><span class="o">=</span><span class="s">"MyController"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">""</span> <span class="na">ng-click</span><span class="o">=</span><span class="s">"item.isOpen = !item.isOpen"</span><span class="p">&gt;</span>
        {{item.title}}
    <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-show</span><span class="o">=</span><span class="s">"item.isOpen"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
           /* 生成するのが重たい要素 */
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p><code>ngShow</code>を利用すると、リストの要素が多いときに最初の読み込みが遅くなりますが、表示・非表示の切り替えは軽快になります。<br>
逆に<code>ngShow</code>の代わりに<code>ngIf</code>を利用すると、最初の読み込みは軽快になりますが、表示・非表示の切り替えは少し遅くなります。</p>

<p>このような特性を理解して、状況に応じて使い分けるのがよいですね。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>AngularJSの内部構造を解説し、アプリを開発する際にパフォーマンス周りで気をつける点を紹介してみました。</p>

<p>僕もそれほど複雑なアプリを開発したわけじゃありませんが、上記の項目を気をつけていればパフォーマンスの問題で悩むこともほとんどありませんでした。自作のアプリをスマートフォンで動かしてみても、思っていた以上にサクサク動きましたし。</p>

<p>より詳しくパフォーマンス対策やAngularJSの内部構造を知りたい場合は、下記の書籍が参考になります。（今回の記事の内容もこの書籍を参考にしている箇所が多いです）</p>

<ul>
<li><a href="http://www.amazon.co.jp/Mastering-Web-Application-Development-AngularJS-ebook/dp/B00EQ67J30" rel="nofollow noopener" target="_blank">Mastering Web Application Development with AngularJS</a></li>
</ul>

<p>さらにチューニングしたい場合の一例として、下記のコードは面白いです。<br>
<code>$digest</code>ループの一部を上書きしてしまっているので、若干黒魔術ではありますが。</p>

<ul>
<li>
<a href="http://wazanova.jp/post/66084016704/angularjs" rel="nofollow noopener" target="_blank">AngularJSのチューニング</a>

<ul>
<li><a href="https://github.com/scalyr/angular/tree/master/src/js/directives" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/scalyr/angular/tree/master/src/js/directives</a></li>
</ul>
</li>
</ul>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<ul>
<li><a href="http://stackoverflow.com/questions/9682092/databinding-in-angularjs" rel="nofollow noopener" target="_blank">Databinding in angularjs</a></li>
<li><a href="http://www.amazon.co.jp/Mastering-Web-Application-Development-AngularJS-ebook/dp/B00EQ67J30" rel="nofollow noopener" target="_blank">Mastering Web Application Development with AngularJS</a></li>
<li><a href="http://d.hatena.ne.jp/jovi0608/20121206/1354762082" rel="nofollow noopener" target="_blank">次世代JavaScriptでデータバインディング： Object.observe() を試す</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>225</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/b72130960c39055b8474">Protractor: AngularJSの次世代E2Eテストフレームワーク</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-23 00:02:50</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[AngularJS]</b> <b>[Protractor]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>AngularJSはテストを重視しているフレームワークだと言われています。<br>
それは、DIが標準搭載されているのでサーバーとの通信などのテストしにくい部分を簡単にモックに差し替えることが出来たり、ユニットテストやEnd to End（E2E）テストのためのフレームワークを持っていたりするからでしょう。</p>

<p>そして、現在標準で含まれているE2Eテストのための機能は、今後ProtractorというSelenium WebDriverJSベースのフレームワークに移行すると発表されています。（<a href="https://docs.google.com/presentation/d/1WHCcp3G3HxoE7b_ut_ERKJF4zQK_P4qFlESjE2E9AUQ/preview?sle=true#slide=id.p" rel="nofollow noopener" target="_blank">AngularJS 1.2 &amp; Beyond</a>）</p>

<p>これまでのE2Eテストフレームワークを捨てて新しいものに乗り替えるのには理由があります。<br>
それは、Seleniumをベースにすることで次のような恩恵を受けられるからです。</p>

<ul>
<li>ブラウザを操作するためのAPIが充実</li>
<li>複数ブラウザでの実行が可能</li>
<li>リモートページのテストが可能</li>
</ul>

<h1>
<span id="インストール" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>インストール</h1>

<p>Protractorはnpmでインストールすることができます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>npm install protractor
</pre></div></div>

<p>npmでインストールされたディレクトリにwebdriver-managerという実行ファイルがあるので、それを使ってSelenium ServerやWebDriverをローカル環境にインストールします。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>node_modules/protractor/bin/webdriver-manager update
</pre></div></div>

<h1>
<span id="grunt" class="fragment"></span><a href="#grunt"><i class="fa fa-link"></i></a>Grunt</h1>

<p>GruntでProtractorを扱うために、次のプラグインを使います。<br>
これらのプラグインは必須というわけではないので、自分のお気に入りのものを使うといいと思います。<br>
（<a href="https://npmjs.org/package/grunt-start-webdriver" rel="nofollow noopener" target="_blank">grunt-start-webdriver</a>というプラグインもあります）</p>

<ul>
<li>grunt-protractor-runner

<ul>
<li>protractorのテストを実行するプラグイン。</li>
</ul>
</li>
<li>grunt-contrib-connect

<ul>
<li>Grunt内で起動するWebサーバープラグイン。protractorでテストするにはWebサーバが必要なので。</li>
</ul>
</li>
<li>grunt-shell/grunt-shell-spawn

<ul>
<li>シェルを実行するためのプラグイン。Selenium Serverのインストールやバックグラウンド起動のために利用する。</li>
</ul>
</li>
</ul>

<p>Gruntfileはこんな感じに記述します。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Gruntfile.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">grunt</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span><span class="p">({</span>

        <span class="c1">// dist配下のファイルをhttp://localhost:9000/で公開する</span>
        <span class="nx">connect</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">port</span><span class="o">:</span> <span class="mi">9000</span><span class="p">,</span>
                <span class="nx">hostname</span><span class="o">:</span> <span class="s1">'localhost'</span>
            <span class="p">},</span>
            <span class="nx">my_target</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">base</span><span class="o">:</span> <span class="s1">'dist'</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>

        <span class="c1">// test/conf.jsの設定に従ってテストを実行</span>
        <span class="nx">protractor</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">keepAlive</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">noColor</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
            <span class="nx">my_target</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">configFile</span><span class="o">:</span> <span class="s2">"test/conf.js"</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">shell</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">stdout</span><span class="o">:</span> <span class="kc">true</span>
            <span class="p">},</span>

            <span class="c1">// Selenium Serverをバックグラウンドで実行</span>
            <span class="nx">selenium</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">command</span><span class="o">:</span> <span class="s2">"node_modules/protractor/bin/webdriver-manager start"</span><span class="p">,</span>
                <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">stdout</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">async</span><span class="o">:</span> <span class="kc">true</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="c1">// Selenium Serverのインストールおよび更新</span>
            <span class="nx">protractor_install</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">command</span><span class="o">:</span> <span class="s2">"node_modules/protractor/bin/webdriver-manager update"</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">'matchdep'</span><span class="p">).</span><span class="nx">filterDev</span><span class="p">(</span><span class="s1">'grunt-*'</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>

<h1>
<span id="confjs" class="fragment"></span><a href="#confjs"><i class="fa fa-link"></i></a>conf.js</h1>

<p>続いてProtractorの設定ファイルを作成します。<br>
node_modules/protractor/referenceConf.js にベースになるファイルがあるので参考にしましょう。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">conf.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">exports</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Seleniumサーバーのアドレス</span>
    <span class="nx">seleniumAddress</span><span class="o">:</span> <span class="s2">"http://localhost:4444/wd/hub"</span><span class="p">,</span>
    <span class="c1">// テストで利用するブラウザなどの条件を設定することができます。</span>
    <span class="c1">// 詳細は https://code.google.com/p/selenium/wiki/DesiredCapabilities</span>
    <span class="nx">capabilities</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">browserName</span><span class="o">:</span> <span class="s2">"chrome"</span>
    <span class="p">},</span>
    <span class="c1">// テスト対象のspecファイルのパス</span>
    <span class="nx">specs</span><span class="o">:</span> <span class="p">[</span><span class="s2">"spec.js"</span><span class="p">],</span>
    <span class="c1">// テスト対象のアプリケーションのベースURL</span>
    <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'http://localhost:9000/'</span><span class="p">,</span>
    <span class="c1">// 利用するテストフレームワーク</span>
    <span class="nx">framework</span><span class="o">:</span> <span class="s2">"jasmine"</span><span class="p">,</span>
    <span class="c1">// jasmine用の設定</span>
    <span class="c1">// 詳細は https://github.com/juliemr/minijasminenode</span>
    <span class="nx">jasmineNodeOpts</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">showColors</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>なお、テストフレームワークはデフォルトでjasmineを使うようになっていますが、mochaを使うことも可能です。</p>

<ul>
<li><a href="https://github.com/angular/protractor/blob/master/docs/using-mocha.md" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/angular/protractor/blob/master/docs/using-mocha.md</a></li>
</ul>

<h1>
<span id="api" class="fragment"></span><a href="#api"><i class="fa fa-link"></i></a>API</h1>

<p>Protractorでは、WebDriverJSのAPIに加えてAnuglarJSアプリのテストがしやすくなるようなAPIが用意されています。</p>

<p>以降では、Protractor特有のAPIを中心に解説します。</p>

<p>詳細はAPIリファレンスを参照してください。</p>

<ul>
<li><a href="https://github.com/angular/protractor/blob/master/docs/api.md" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/angular/protractor/blob/master/docs/api.md</a></li>
</ul>

<h2>
<span id="グローバル変数" class="fragment"></span><a href="#%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E5%A4%89%E6%95%B0"><i class="fa fa-link"></i></a>グローバル変数</h2>

<p>用意されてるAPIのうち、よく利用するものはグローバル変数に登録されています。</p>

<ul>
<li>
<code>by</code>, <code>By</code>

<ul>
<li>protractor.Byのエイリアス。</li>
</ul>
</li>
<li>
<code>element</code>

<ul>
<li>protractor.elementのエイリアス。</li>
<li>protractor.findElementなどを駆使してうまい具合に探してくれる。</li>
<li>内部でbrowser.waitForAngularを呼んでいるので、レンダリングのタイミングが早すぎて要素が取れないということがない。</li>
</ul>
</li>
<li>
<code>browser</code>

<ul>
<li>protractor.getInstance()と同じ。WebDriverのインスタンスをラップしたもの。</li>
</ul>
</li>
<li>
<code>$</code>

<ul>
<li>protractor.findElement(protractor.By.css("・・・"))のエイリアス。</li>
</ul>
</li>
<li>
<code>$$</code>

<ul>
<li>protractor.findElements(protractor.By.css("・・・"))のエイリアス。</li>
</ul>
</li>
</ul>

<h2>
<span id="ブラウザ操作" class="fragment"></span><a href="#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E6%93%8D%E4%BD%9C"><i class="fa fa-link"></i></a>ブラウザ操作</h2>

<p>browserというインスタンスを使って、様々なブラウザ操作を行うことができます。<br>
browser.get()でページを開いたり、browser.actions()でマウスイベントを発行したり、browser.wait()で処理が完了するまで待ったり、などなど。</p>

<p>WebDriverJSの基本的なAPIに、Protractorでは以下の機能が追加されています。</p>

<ul>
<li>waitForAngular

<ul>
<li>AngularJSのレンダリングと<code>$http</code>の呼び出しが完了するまで待つ。</li>
</ul>
</li>
<li>addMockModule/clearMockModules

<ul>
<li>モックの登録と解除を行う。</li>
</ul>
</li>
<li>debugger

<ul>
<li>アプリケーションの動作を止めてデバッガを起動する。</li>
</ul>
</li>
</ul>

<h2>
<span id="ロケーター" class="fragment"></span><a href="#%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%BF%E3%83%BC"><i class="fa fa-link"></i></a>ロケーター</h2>

<p>HTMLの要素を指定するためのDSLです。<br>
WebDriverJSでは、idやタグ名やcssセレクタで要素を指定するAPIが用意されていますが、Protractorでは以下のようなAPIが追加されています。</p>

<ul>
<li>by.binding

<ul>
<li>
<code>by.binding('status')</code>で<code>&lt;span&gt;{{status}}&lt;/span&gt;</code>が取得できます。適当なタグで囲ってあげないと外側の要素が取れます。</li>
</ul>
</li>
<li>by.repeater

<ul>
<li>
<code>by.repeater('item in items')</code>とすると<code>&lt;div ng-repeat="item in items"&gt;</code>の要素が取得できます。指定した行や列の要素だけを取る手段も用意されています。</li>
</ul>
</li>
<li>by.model

<ul>
<li>
<code>ng-model</code>の名前で指定して、selectタグやinputタグの要素を取得できます。</li>
</ul>
</li>
</ul>

<h2>
<span id="要素の操作" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E6%93%8D%E4%BD%9C"><i class="fa fa-link"></i></a>要素の操作</h2>

<p>element(by.binding("xxxx"))などで取得した要素に対して行う操作です。<br>
getText()やgetAttribute()に加えて、Protractorでは以下のようなAPIが追加されています。</p>

<ul>
<li>all

<ul>
<li>ng-repeatの全要素を取得できる</li>
</ul>
</li>
<li>$

<ul>
<li>protractor.findElement(by.css(・・・))のエイリアス</li>
</ul>
</li>
<li>$$

<ul>
<li>protractor.findElements(by.css(・・・))のエイリアス</li>
</ul>
</li>
<li>evaluate

<ul>
<li>現在の要素のscopeに対してスクリプトを実行することができます。</li>
<li>element(by.id("something")).evaluate("value")ってやると、<code>id='something'</code>要素の<code>$scope.value</code>の値がとれたりします。</li>
</ul>
</li>
</ul>

<p>結果は全てPromiseで返ってくるようになっているので、値を使いたい場合はthenでつなげて書きます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>// inputタグの値を取得
var input = element(by.model("status"));
input.getAttribute('value').then(function(attr) {
  ・・・
});

// バインドされた値の取得
var output = element(by.binding("output"));
output.getText().then(function (text) {
  ・・・
});

// ng-repeatの全値を取得
var collection = element.all(by.repeater("item in items"));
collection.then(function (rows) {
  ・・・
});

// ng-disabledの値を取得。有効なときはnullになる。
var button = element(by.id("myButton"));
button.getAttribute("disabled").then(function(disabled) {
  ・・・
});
</pre></div></div>

<h2>
<span id="テストのためのapi" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AEapi"><i class="fa fa-link"></i></a>テストのためのAPI</h2>

<p>ProtractorではJasmineに改良を加えており、expectの引数にPromiseを渡し、普通の値と同じように結果を比較することが可能になっています。</p>

<p>例えば、上記のgetText()やgetAttribute()などは全部Promiseを返すようになっていますが、<code>expect(element(by.binding("xxx")).getText()).toEqual("yyy")</code>のように書くことができます。</p>

<h1>
<span id="テストの例" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E4%BE%8B"><i class="fa fa-link"></i></a>テストの例</h1>

<p>テスト対象として以下のようなHTMLを考えてみます。<br>
inputTextに値を入れてボタンを押すと、入力した文字が大文字に変換されてdisplayTextに表示されるものと思ってください。</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">sample.html</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-controller</span><span class="o">=</span><span class="s">"SampleCtrl"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">ng-model</span><span class="o">=</span><span class="s">"inputText"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>{{displayText}}<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">ng-click</span><span class="o">=</span><span class="s">"toUpper()"</span><span class="p">&gt;</span>push<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>テストは次のように書きます。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">spec.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">describe</span><span class="p">(</span><span class="s1">'basics'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">input</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">display</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">button</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// http://localhost:9000/sample.html を開く</span>
        <span class="nx">browser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/sample.html'</span><span class="p">);</span>
        <span class="c1">// 各要素を取得</span>
        <span class="nx">input</span> <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">by</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"inputText"</span><span class="p">));</span>
        <span class="nx">display</span> <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">by</span><span class="p">.</span><span class="nx">binding</span><span class="p">(</span><span class="s2">"displayText"</span><span class="p">));</span>
        <span class="nx">button</span> <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">by</span><span class="p">.</span><span class="nx">tagName</span><span class="p">(</span><span class="s2">"button"</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">'should be to upper value'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// input要素に文字列を入力</span>
        <span class="nx">input</span><span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span>
        <span class="c1">// ボタンをクリック</span>
        <span class="nx">button</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
        <span class="c1">// displayTextに"TEST"と表示されていることを確認</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">getText</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s2">"TEST"</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>

<h1>
<span id="テストの実行" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>テストの実行</h1>

<p>Selenium Serverを起動します。テストの実行前に必ず立ち上げておく必要があります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>grunt shell:selenium
</pre></div></div>

<p>アプリケーションを起動します。Gruntでテスト実行と同時に立ち上げるようにしておくのがおすすめです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>grunt connect:my_target:keepalive
</pre></div></div>

<p>そしてテストを実行します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>grunt protractor:my_target
</pre></div></div>

<p>ブラウザが起動してテストが実行され、次のように結果が表示されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Running "protractor:my_target" (protractor) task
Using the selenium server at http://localhost:4444/wd/hub
.

Finished in 7.281 seconds
1 tests, 1 assertions, 0 failures


Done, without errors.
</pre></div></div>

<h2>
<span id="デバッグモード" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%83%A2%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>デバッグモード</h2>

<p>テストが思ったとおりに動かないと思ったらデバッグモードを使いましょう。<br>
Gruntfileのprotractorのoptions.debugをtrueにします。<br>
（protractorの実行ファイルを直接実行している場合は、オプションに<code>debug</code>を指定します）</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Gruntfile.js</span></div>
<div class="highlight"><pre><span></span>        <span class="nx">protractor</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">keepAlive</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">noColor</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">debug</span><span class="o">:</span> <span class="kc">true</span>
            <span class="p">},</span>
            <span class="nx">my_target</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">configFile</span><span class="o">:</span> <span class="s2">"test/conf.js"</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
</pre></div>
</div>

<p><code>grunt protractor:my_target</code>を実行するとコンソールに下記のように出てきます。<br>
<code>c</code>や<code>r</code>を入力するとテストの実行が開始されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&lt; debugger listening on port 5858
connecting... ok
break in node_modules/protractor/lib/cli.js:8
  6  */
  7 
  8 var util = require('util');
  9 var path = require('path')
 10 var fs = require('fs');
debug&gt; 
</pre></div></div>

<p>テストコード中に<code>browser.debugger();</code>と書いておくと、テストを実行した時にそこで止まってくれます。</p>

<p>replを起動すると、JavaScriptのコードを書いて変数の中身を確認できたり、とても便利です。<br>
その他ステップ実行などいくつかのコマンドが用意されています。デバッガの中で<code>help</code>と打ってみましょう。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>個人的には、小さいプロダクトを書く時はユニットテストはあまり効果を感じられなくて、書くのも面倒に感じてしまいます。<br>
でもE2Eテストなら手間もそんなにかからないし、ドキュメント代わりにもなるのでおすすめです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />5位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>213</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/1aefa189cb54169f2cee">AngularJSをTypeScriptで書くときのあれこれ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-20 01:04:11</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[TypeScript]</b> <b>[AngularJS]</b> <b>[grunt.js]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>AngularJSのようなクライアントMVCフレームワークを採用すると、クライアントサイドの規模が大きくなってくるので、できればJavaScriptじゃなくて型のあるプログラミング言語で開発したいですよね。</p>

<p>AngularJSは独自のクラスシステムを持っていないし、モデルやコントローラを実装するためにベースクラスを継承したりする必要もないので、altJSとの相性がよくて組み合わせやすいです。<br>
altJSと言ってもたくさん種類がありますが、今回はTypeScriptを使ってAngularJSアプリを書くときのTipsやコツなどを紹介したいと思います。</p>

<h1>
<span id="ベースとなるプロジェクトを作る" class="fragment"></span><a href="#%E3%83%99%E3%83%BC%E3%82%B9%E3%81%A8%E3%81%AA%E3%82%8B%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>ベースとなるプロジェクトを作る</h1>

<p>AngularJSのコードを書くとき、JavaScriptであればおもむろに書き始めることも可能ですが、altJSを使う場合はコンパイルなどの手順が必要になるので、Gruntを使ったプロジェクトを作る必要があります。<br>
Gruntfileを1から書いてファイルの配置などを考えるのはちょっと面倒なので、yeomanを使うか、どこかからひな形を持ってくるのが楽です。</p>

<h2>
<span id="yeomanを使う" class="fragment"></span><a href="#yeoman%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>yeomanを使う</h2>

<p>yeomanを使うならangular-generator-typescriptというのがあります。</p>

<ul>
<li><a href="http://qiita.com/tenntenn/items/06bbb9971e8a6c3ccc95" id="reference-5cd724d2d287d1679302">AngularJS + Typescript用のyeomanのgenerator</a></li>
</ul>

<p>でもこれ9ヶ月間もメンテされてないので、TypeScriptのコンパイル通らないし、fork元で新しく追加されたテンプレートに追随できていないんですよね。</p>

<p>じゃあこれをforkして修正するか、もしくはfork元のgenerator-angularにTypeScript用のオプションを追加すればいいんじゃないか？とも思ったのですが、すでにそんなpull requestがありました。</p>

<ul>
<li><a href="https://github.com/yeoman/generator-angular/pull/313" rel="nofollow noopener" target="_blank">Typescript support for generator-angular</a></li>
</ul>

<p>開発者が忙しくて放置されていたようですが、近いうちに取り込まれそうな雰囲気なので待つのがよさそう。</p>

<h2>
<span id="ひな形を使う" class="fragment"></span><a href="#%E3%81%B2%E3%81%AA%E5%BD%A2%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>ひな形を使う</h2>

<p>ひな形を持ってくるならこちらがおすすめ。いろいろと参考にさせてもらいました。</p>

<ul>
<li><a href="https://github.com/vvakame/angularjs-typescript" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/vvakame/angularjs-typescript</a></li>
</ul>

<p>この記事の内容をまとめたプロジェクトも用意しました。テストの設定がなかったりしてちょっと物足りないかもしれませんが、よければ参考にしてください。</p>

<ul>
<li><a href="https://github.com/zoetrope/angular-typescript-sample" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/zoetrope/angular-typescript-sample</a></li>
</ul>

<h1>
<span id="ideを使う" class="fragment"></span><a href="#ide%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>IDEを使う</h1>

<p>TypeScriptでの開発のメリットを存分に享受したいのであれば、Visual Studioや、IntelliJ IDEA/WebStormなどのIDEの利用は必須と言ってもいいでしょう。</p>

<p>IntelliJ IDEAから使う場合は、メニューから[File] -&gt; [New Project...]を開き、プロジェクトのタイプにWebを選んで、前述したプロジェクトの含まれるディレクトリを指定するだけです。</p>

<p>これだけで、AngularJSのAPIもこんなふうに補完されます。</p>

<p><a href="https://camo.qiitausercontent.com/690b80869b549b3806207a22309e7dee4e35801e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f32306430633835342d646434372d643731332d613866392d3138633539393733613262392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/690b80869b549b3806207a22309e7dee4e35801e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f32306430633835342d646434372d643731332d613866392d3138633539393733613262392e706e67" alt="idea.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3489/20d0c854-dd47-d713-a8f9-18c59973a2b9.png"></a></p>

<p>IntelliJ IDEAには、AngularJS用のプラグインも用意されていて（WebStormには標準搭載）、HTMLの編集中にdirectiveの補完が効くので便利です。（<code>$scope</code>のメンバも補完してくれるともっと便利なんですけどね）</p>

<p>なお、IntelliJ IDEA 12はTypeScriptのGenericsに対応していない（ver.0.8相当）ので、IntelliJ IDEA 13の利用をおすすめします。</p>

<h1>
<span id="gruntfileをカスタマイズする" class="fragment"></span><a href="#gruntfile%E3%82%92%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Gruntfileをカスタマイズする</h1>

<p>yeomanで生成したりひな形に含まれているGruntfileはそのまま使ってもいいんですが、カスタマイズすることでさらに便利になります。</p>

<h2>
<span id="型定義ファイル" class="fragment"></span><a href="#%E5%9E%8B%E5%AE%9A%E7%BE%A9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>型定義ファイル</h2>

<p>TypeScriptでは、既存のJavaScriptライブラリを利用するために型定義ファイル（拡張子が.d.tsのファイル）を用意する必要があります。<br>
型定義ファイルを扱うリポジトリはDefinitelyTypedがメジャーです。AngularJSの型定義ファイルももちろん用意されています。</p>

<ul>
<li><a href="https://github.com/borisyankov/DefinitelyTyped" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/borisyankov/DefinitelyTyped</a></li>
</ul>

<p>angular-generatorで生成したプロジェクトではDefinitelyTypedを丸ごと落としてきているのですが、これはちょっとおおげさな気がします。<br>
そこで、型定義ファイルを取得するためのツールとしてtsdを使います。<br>
（最近までtsdでangular-route.d.tsが取れなかったので、pull requestして取れるようにしてもらいました。）</p>

<ul>
<li><a href="http://qiita.com/grapswiz@github/items/72012f283de23385553a" id="reference-18c931c4df47d7725d56">TypeScriptの型定義ファイル管理ツールtsdを使ってみた</a></li>
</ul>

<p>Gruntからtsdを呼び出すには、将来的には<a href="https://github.com/DefinitelyTyped/grunt-tsd" rel="nofollow noopener" target="_blank">grunt-tsd</a>ってのが提供されるようですが、現状ではgrunt-execを使います。</p>

<p>grunt-execをインストールします。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>npm install grunt-exec --save-dev
</pre></div></div>

<p>あとは、Gruntfileでこんなタスクを用意するだけです。ファイルの置き場所はtsd-config.jsonで制御します。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Gruntfile.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">exec</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">tsd</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">cmd</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s2">"tsd install jquery angular angular-resource angular-route"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="typescriptコンパイル" class="fragment"></span><a href="#typescript%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>TypeScriptコンパイル</h2>

<p>GruntでTypeScriptのコンパイルをするにはgrunt-typescriptを使い、Gruntfileに次のようなタスクを用意します。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Gruntfile.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">typescript</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">main</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">src</span><span class="o">:</span> <span class="p">[</span><span class="s1">'dist/scripts/**/*.ts'</span><span class="p">],</span>
        <span class="nx">dest</span><span class="o">:</span> <span class="s1">'dist/scripts/App.js'</span><span class="p">,</span>
        <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">target</span><span class="o">:</span> <span class="s1">'es5'</span><span class="p">,</span>
            <span class="nx">sourcemap</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">declaration</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>ここで、srcとdestの指定方法に少しコツがあります。<br>
まず、srcを指定するには次のような2つの方法があります。</p>

<ul>
<li>1ファイルだけ指定して、そのファイル内に他のファイルへの参照（<code>/// &lt;reference path="xxx.ts" /&gt;</code>）を書く。</li>
<li>配列で全ファイルを列挙する、またはワイルドカードで全ファイルを指定する。</li>
</ul>

<p>これはどちらでも好みで選んでいいと思います。</p>

<p>destの指定方法も2種類あります。</p>

<ul>
<li>ディレクトリを指定すると、TypeScriptのソースと同じツリー構造でJavaScriptとmapファイルが生成される。</li>
<li>ファイルを指定すると、すべてのTypeScriptのコンパイル結果が1つのJavaScriptとmapファイルにまとめられる。</li>
</ul>

<p>次のsourcemapのところで説明しますが、destは1つのファイルにまとめておくのがおすすめです。</p>

<h2>
<span id="sourcemap" class="fragment"></span><a href="#sourcemap"><i class="fa fa-link"></i></a>sourcemap</h2>

<p>TypeScriptでデバッグするときには、やっぱりsourcemapを使いたい。</p>

<p>TypeScriptのコンパイル結果をそのままHTMLから参照するのであれば特に問題ないのですが、TypeScriptでコンパイルした結果をminifyする場合は、2段階のsourcemapの解決が必要になるのでちょっとややこしくなります。</p>

<p>Gruntfileの設定例はこんなかんじになります。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Gruntfile.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">copy</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">scripts</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">files</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nx">expand</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">flatten</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">cwd</span><span class="o">:</span> <span class="s1">'app/scripts'</span><span class="p">,</span>
                <span class="nx">src</span><span class="o">:</span> <span class="p">[</span><span class="s1">'**/*.ts'</span><span class="p">],</span>
                <span class="nx">dest</span><span class="o">:</span> <span class="s1">'dist/scripts'</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nx">expand</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> 
                <span class="nx">flatten</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> 
                <span class="nx">cwd</span><span class="o">:</span> <span class="s1">'app/d.ts'</span><span class="p">,</span> 
                <span class="nx">src</span><span class="o">:</span> <span class="p">[</span><span class="s1">'**/*.d.ts'</span><span class="p">],</span>
                <span class="nx">dest</span><span class="o">:</span> <span class="s1">'dist/d.ts'</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">},</span>
<span class="nx">typescript</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">main</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">src</span><span class="o">:</span> <span class="p">[</span><span class="s1">'dist/scripts/**/*.ts'</span><span class="p">],</span>
        <span class="nx">dest</span><span class="o">:</span> <span class="s1">'dist/scripts/App.js'</span><span class="p">,</span>
        <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">target</span><span class="o">:</span> <span class="s1">'es5'</span><span class="p">,</span>
            <span class="nx">sourcemap</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">declaration</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">},</span>
<span class="nx">uglify</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">dev</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">report</span><span class="o">:</span> <span class="s1">'min'</span><span class="p">,</span>
            <span class="nx">beautify</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span>
            <span class="nx">mangle</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">preserveComments</span><span class="o">:</span> <span class="s1">'some'</span><span class="p">,</span>

            <span class="nx">sourceMap</span><span class="o">:</span> <span class="s1">'dist/scripts/App.min.js.map'</span><span class="p">,</span>
            <span class="nx">sourceMapRoot</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">sourceMappingURL</span><span class="o">:</span> <span class="s1">'App.min.js.map'</span><span class="p">,</span>
            <span class="nx">sourceMapIn</span><span class="o">:</span> <span class="s1">'dist/scripts/App.js.map'</span><span class="p">,</span>
            <span class="nx">sourceMapPrefix</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="nx">files</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'dist/scripts/App.min.js'</span><span class="o">:</span> <span class="p">[</span>
                <span class="s1">'dist/scripts/libs/angular/*.js'</span><span class="p">,</span>
                <span class="s1">'dist/scripts/libs/angular-route/*.js'</span><span class="p">,</span>
                <span class="s1">'dist/scripts/libs/angular-resource/*.js'</span><span class="p">,</span>
                <span class="s1">'dist/scripts/App.js'</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>それぞれのタスクの説明をします。</p>

<ul>
<li>copy:scripts

<ul>
<li>TypeScriptのファイルをWebサーバから見える場所に置きます。（sourcemapで解決するときに使うので）</li>
</ul>
</li>
<li>typescript:main

<ul>
<li>TypeScriptのコンパイルをして、App.jsとApp.js.mapを生成します。</li>
</ul>
</li>
<li>uglify:dev

<ul>
<li>App.jsとAngularJSやその他ライブラリのファイルを結合して、App.min.jsを生成します。</li>
<li>sourceMapInオプションでApp.js.mapを指定し、App.min.jsからTypeScriptへのマッピングを解決するためのApp.min.js.mapを生成します。</li>
</ul>
</li>
</ul>

<p>uglifyのsourceMapInオプションは1ファイルしか指定できない（functionを指定すれば指定できる？）ようなので、TypeScriptのコンパイル結果は1つにまとめておくのがよいです。</p>

<p>これでChromeやIDEを使って、TypeScriptのソースにブレイクポイントを張ったりできるようになりました！</p>

<p><a href="https://camo.qiitausercontent.com/2e4b0087a0049feb41da9e7d58c62be24d6ceee4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f31316638656631352d366663312d373365612d633262312d6138303438323737663034392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2e4b0087a0049feb41da9e7d58c62be24d6ceee4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333438392f31316638656631352d366663312d373365612d633262312d6138303438323737663034392e706e67" alt="chrome_breakpoint.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3489/11f8ef15-6fc1-73ea-c2b1-a8048277f049.png"></a></p>

<h1>
<span id="コードの書き方" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9"><i class="fa fa-link"></i></a>コードの書き方</h1>

<p>TypeScriptでAngularJSの基本的なコードの書き方は、generator-angularで生成されるコードが参考になります。<br>
生成コードのテンプレートはこちら。</p>

<ul>
<li><a href="https://github.com/anchann/generator-angular/tree/typescript/templates/typescript" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/anchann/generator-angular/tree/typescript/templates/typescript</a></li>
</ul>

<p>基本は上記のコードを見れば分かると思うので、ここでは応用的な書き方について紹介したいと思います。</p>

<h2>
<span id="scopeとcontroller" class="fragment"></span><a href="#scope%E3%81%A8controller"><i class="fa fa-link"></i></a>ScopeとController</h2>

<p>まずは、ScopeとControllerの書き方を3種類紹介したいと思います。<br>
なお、説明のためにController内にビジネスロジック的なものを書いていますが、ちゃんとしたコードを書くときはビジネスロジックはModelに書くようにしてください。</p>

<h3>
<span id="基本的な書き方" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E6%9B%B8%E3%81%8D%E6%96%B9"><i class="fa fa-link"></i></a>基本的な書き方</h3>

<p>IScopeを継承した新しいinterfaceと、Controllerクラスを定義します。<br>
JavaScriptと比べるとScopeの定義を書くのが面倒に感じるかもしれませんが、型チェックで得られるメリットは大きいので我慢して書きます。</p>

<div class="code-frame" data-lang="ts">
<div class="code-lang"><span class="bold">MainController.ts</span></div>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">MainScope</span> <span class="kr">extends</span> <span class="nx">ng</span><span class="p">.</span><span class="nx">IScope</span> <span class="p">{</span>
    <span class="nx">content</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">items</span>: <span class="kt">app.models.Item</span><span class="p">[];</span>
    <span class="nx">add</span><span class="p">(</span><span class="nx">item</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">MainController</span> <span class="p">{</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">$scope</span>:<span class="kt">MainScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="p">(</span><span class="nx">item</span>:<span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">$scope</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Item</span><span class="p">(</span><span class="nx">item</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>Viewに公開するメンバ関数はコンストラクタの中で定義するので、コンストラクタは長くなりがちです。<br>
なお、Viewに公開したくないメンバ変数やメンバ関数は、Controllerクラスのprivateメンバとして用意します。</p>

<h3>
<span id="angularbindを使う" class="fragment"></span><a href="#angularbind%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>angular.bindを使う</h3>

<p>Controllerのメンバ関数をangular.bindを使ってScopeにバインドする方法です。</p>

<div class="code-frame" data-lang="ts">
<div class="code-lang"><span class="bold">MainController.ts</span></div>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">MainScope</span> <span class="kr">extends</span> <span class="nx">ng</span><span class="p">.</span><span class="nx">IScope</span> <span class="p">{</span>
    <span class="nx">content</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">items</span>: <span class="kt">app.models.Item</span><span class="p">[];</span>
    <span class="nx">add</span>: <span class="kt">Function</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">MainController</span> <span class="p">{</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">$scope</span>:<span class="kt">MainScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">add</span><span class="p">(</span><span class="nx">item</span>:<span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Item</span><span class="p">(</span><span class="nx">item</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>bindを書く手間はありますが、コンストラクタがだらだらと長くなることはなくなりました。</p>

<h3>
<span id="controller-as-を使う" class="fragment"></span><a href="#controller-as-%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>Controller As を使う</h3>

<p>最後に<a href="http://qiita.com/soundTricker/items/9a2a27281246ca7ce0b7" id="reference-46cd9c906398cddf3aa6">AngularJS 1.2.0の"Controller As" Syntax</a>を使った方法です。</p>

<div class="code-frame" data-lang="ts">
<div class="code-lang"><span class="bold">MainController.ts</span></div>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">class</span> <span class="nx">MainController</span> <span class="p">{</span>
    <span class="nx">content</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">items</span>: <span class="kt">app.models.Item</span><span class="p">[];</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">$scope</span>:<span class="kt">ng.IScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">}</span>
    <span class="nx">add</span><span class="p">(</span><span class="nx">item</span>:<span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Item</span><span class="p">(</span><span class="nx">item</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>

<p>ScopeとControllerがまとまって、すっきりと書くことができました。ただし、HTML側の書き方が少し変わるので注意が必要です。</p>

<p>この書き方は、ScopeとControllerの役割分担ができないとか、ViewからControllerの中がすべて見えてしまう（privateつけても呼び出せる）とか、問題点を指摘されたりもしているので、採用する際には少し検討したほうがよさそうです。</p>

<h2>
<span id="directive" class="fragment"></span><a href="#directive"><i class="fa fa-link"></i></a>Directive</h2>

<p>Directiveの実装は、JavaScriptの場合と同じように連想配列を返す書き方もできますが、IDirective interfaceを実装することもできます。<br>
interfaceを使ったほうが型のサポートがあるので安心ですね。<br>
なお、IDirectiveのメンバ関数やメンバ変数には<code>?</code>がついているので、必要のないメンバ関数・メンバ変数は実装しなくても大丈夫です。</p>

<div class="code-frame" data-lang="ts">
<div class="code-lang"><span class="bold">MyDirective.ts</span></div>
<div class="highlight"><pre><span></span><span class="kr">module</span> <span class="nx">app.directive</span> <span class="p">{</span>
    <span class="kr">export</span> <span class="kr">class</span> <span class="nx">MyDirective</span> <span class="kr">implements</span> <span class="nx">ng</span><span class="p">.</span><span class="nx">IDirective</span> <span class="p">{</span>
        <span class="nx">restrict</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s2">"E"</span><span class="p">;</span>
        <span class="nx">templateUrl</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s2">"/views/xxx.html"</span><span class="p">;</span>
        <span class="nx">transclude</span>: <span class="kt">any</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">replace</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">scope</span>: <span class="kt">any</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">link</span><span class="p">(</span><span class="nx">scope</span>: <span class="kt">ng.IScope</span><span class="p">,</span> <span class="nx">elem</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">attrs</span>: <span class="kt">ng.IAttributes</span><span class="p">,</span> <span class="nx">ctrl</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
          <span class="cm">/* 処理を書く */</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">"app.directive"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">'myDirective'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">.</span><span class="nx">MyDirective</span><span class="p">());</span>
</pre></div>
</div>

<h2>
<span id="resourceへのメンバ関数の追加" class="fragment"></span><a href="#resource%E3%81%B8%E3%81%AE%E3%83%A1%E3%83%B3%E3%83%90%E9%96%A2%E6%95%B0%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a><code>$resource</code>へのメンバ関数の追加</h2>

<p>サーバーサイドと通信するための<code>$resource</code>サービスは、標準でGET、POST、DELETEのHTTPメソッドが使えるようになっています。<br>
それ以外のHTTPメソッド（PUTなど）を利用したい時は、自分で新しいメンバ関数を追加することになります。<br>
しかし、TypeScriptでは新しいメンバ関数を追加しても、呼びだそうとすると「そんな関数知らないよ」とコンパイル時に怒られてしまいます。</p>

<p>そこでまず、IResourceClassを継承して、新しいメンバ関数を追加したinterfaceを用意します。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="kr">module</span> <span class="nx">app.service</span> <span class="p">{</span>
    <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">IUpdatableResourceClass</span> <span class="kr">extends</span> <span class="nx">ng</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">IResourceClass</span>  <span class="p">{</span>
        <span class="nx">update</span><span class="p">(</span><span class="nx">params</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">data</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">success?</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">error?</span>: <span class="kt">Function</span><span class="p">)</span><span class="o">:</span> <span class="nx">ng</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">IResource</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>続いて、PUTメソッドを追加した<code>$resource</code>を返すサービスを用意します。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'app.service'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'ngResource'</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">'Items'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$resource</span>: <span class="kt">ng.resource.IResourceService</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/api/items/:itemId"</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="nx">update</span><span class="o">:</span> <span class="p">{</span><span class="nx">method</span><span class="o">:</span> <span class="s1">'PUT'</span><span class="p">}});</span>
    <span class="p">});</span>
</pre></div></div>

<p>コントローラにそのサービスを渡してあげます。</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span></span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'app.controller'</span><span class="p">).</span><span class="nx">controller</span><span class="p">(</span><span class="s2">"MainController"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"$scope"</span><span class="p">,</span> <span class="s2">"Items"</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">$scope</span>: <span class="kt">ng.IScope</span><span class="p">,</span> <span class="nx">Items</span>: <span class="kt">app.service.IUpdatableResourceClass</span><span class="p">)</span><span class="o">:</span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">MainController</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">MainController</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">Items</span><span class="p">)</span>
    <span class="p">}]);</span>
</pre></div></div>

<p>これで、PUTメソッドを追加した<code>$resource</code>を、Controllerから使えるようになりました。</p>

<p>でも<code>$resource</code>のメンバ関数はany型の引数を渡せるようになっているのでちょっと頼りないですね。<br>
より厳密に型チェックをしたいのであれば、ちゃんと引数や戻り値の型を定義したクラスを別途用意して<code>$resource</code>をラップしてしまいましょう。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>一度TypeScriptで書き始めると、もう生JavaScriptは書きたくなくなります。ぜひお試しあれ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />6位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>134</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/eb3a44e4baa8c367b4aa">AngularJSとTwitter Bootstrapを組み合わせて使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-08 01:01:04</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[bootstrap]</b> <b>[AngularJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Twitter Bootstrapを使うと、それっぽいデザインを実現することができて便利ですよね。<br>
今回はAngularJSとBootstrapを組み合わせて使う方法について解説したいと思います。</p>

<h1>
<span id="bootstrap" class="fragment"></span><a href="#bootstrap"><i class="fa fa-link"></i></a>Bootstrap</h1>

<p>まず、AnuglarJSとBootstrapを組み合わせて使う最も簡単な方法は、yeomanでプロジェクトのひな形を生成することです。</p>

<ul>
<li><a href="http://blog.kinzal.net/post/68979324453/yeoman-angularjs-qiita-advend-calendar" rel="nofollow noopener" target="_blank">yeomanを使ったAngularJSプロジェクトの始め方</a></li>
</ul>

<p>yoコマンドを実行した時に、以下のように質問されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[?] Would you like to include Twitter Bootstrap? (Y/n) 
[?] Would you like to use the SCSS version of Twitter Bootstrap with the Compass CSS Authoring Framework? (Y/n) 
</pre></div></div>

<p>1つ目の質問にYesと答えるとひな形にBootstrapが組み込まれます。<br>
2つ目の質問にYesと答えるとsass-bootstrapというフレームワークがbowerでインストールされ、scssファイルからcssにコンパイルされるようになります。Noだとbootstrap.cssとアイコン用のフォントがダウンロードされます。</p>

<p>この方法でもいいんですが、2つ目の質問にNoで答えた場合、Bootstrapがbowerで管理されてないのでバージョンアップ時の対応が面倒だったり、bootstrap-theme.css（フラットデザインじゃないテーマ）が含まれてなかったりします。<br>
なので、bowerでBootstrapを入れるのもよいと思います。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>bower install bootstrap --save
</pre></div></div>

<h1>
<span id="ui-bootstrap" class="fragment"></span><a href="#ui-bootstrap"><i class="fa fa-link"></i></a>UI Bootstrap</h1>

<p>Bootstrapには多くのコンポーネントが用意されていますが、それらのコンポーネントで何らかの動きを起こすときにはJavaScriptでコードを書くことになります。<br>
例えばpopoverを表示するには<code>$('#element').popover('show')</code>とかやったりします。</p>

<p>しかし、このようにjQueryでDOM操作するのは、AngularJSのポリシーに反しています。<br>
そこで、BootstrapのコンポーネントをDirective化し、AngularJSのバインディングで扱えるようにしたのがAngular UIのUI Bootstrapです。</p>

<ul>
<li><a href="http://angular-ui.github.io/bootstrap/" class="autolink" rel="nofollow noopener" target="_blank">http://angular-ui.github.io/bootstrap/</a></li>
</ul>

<p>似たものとして<a href="http://mgcrea.github.io/angular-strap/" rel="nofollow noopener" target="_blank">AngularStrap</a>というのもありますが、UI Bootstrapのほうが若干対応コンポーネントが多いのと、Angular UIチームが作っているという安心感があります。</p>

<p>早速bowerでインストールして使いましょう。<br>
bower上にはangular-ui-bootstrapとangular-ui-bootstrap-bowerという3つのパッケージがあるようです。angular-ui-bootstrapはソースコードのみなので、angular-ui-bootstrap-bowerをインストールします。<br>
yeomanで生成したプロジェクトのルートディレクトリで以下のコマンドを実行します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>bower install angular-ui-bootstrap-bower --save
</pre></div></div>

<p>以下のように4つのjsファイルがありますが、tplsが付いているのはjsファイル内にテンプレートが含まれているもの、minが付いているのはminifyされたものになります。通常はtpls付きのものでよいと思います。</p>

<ul>
<li>ui-bootstrap.js</li>
<li>ui-bootstrap-tpls.js</li>
<li>ui-bootstrap.min.js</li>
<li>ui-bootstrap-tpls.min.js</li>
</ul>

<p>UI Bootstrapを使うには、HTMLから以下のようにjsファイルをインクルードします。</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">app/index.html</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"bower_components/angular-ui-bootstrap/dist/ui-bootstrap-tpls.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>最後に依存関係に<code>ui.bootstrap</code>を追加します。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">app/scripts/app.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myapp'</span><span class="p">,</span> <span class="p">[</span>
  <span class="s1">'ngCookies'</span><span class="p">,</span>
  <span class="s1">'ngResource'</span><span class="p">,</span>
  <span class="s1">'ngSanitize'</span><span class="p">,</span>
  <span class="s1">'ngRoute'</span><span class="p">,</span>
  <span class="s1">'ui.bootstrap'</span>
<span class="p">])</span>
</pre></div>
</div>

<p>これで、UI Bootstrapが使えるようになりました。</p>

<p>例えばratingを使いたいのであれば、以下のように書きます。<br>
<code>rate</code>が双方向バインディングされてるので、テキストボックスの値とratingの星の数が連動しますね。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">ng-model</span><span class="o">=</span><span class="s">"rate"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">rating</span> <span class="na">value</span><span class="o">=</span><span class="s">"rate"</span><span class="p">&gt;&lt;/</span><span class="nt">rating</span><span class="p">&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />7位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>83</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/bee9567349577620860a">JavaScriptの非同期処理には何を使うべきか</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-25 02:07:07</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Node.js]</b> <b>[async]</b> <b>[RxJS]</b> <b>[co]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="javascriptの非同期処理" class="fragment"></span><a href="#javascript%E3%81%AE%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>JavaScriptの非同期処理</h2>

<p>JavaScriptにおける非同期処理のライブラリは非常にたくさん乱立していて、一体どれを使えばいいのか判断がつきません。<br>
（本記事はその答えを明確に示すものではないので、もしそういうのを期待してたらごめんなさい）</p>

<p>ライブラリはたくさんありますが、いくつかの方式にカテゴライズすることができそうです。（ここに挙げてない方式もきっとあるでしょう）</p>

<ul>
<li><p><strong>いつか値を返すのでとりあえずプレースホルダを受け取っておいてよ方式</strong> ：<a href="http://wiki.commonjs.org/wiki/Promises" rel="nofollow noopener" target="_blank">promise</a>, <a href="http://api.jquery.com/category/deferred-object/" rel="nofollow noopener" target="_blank">jQuery.Deferred</a>, <a href="http://docs.closure-library.googlecode.com/git/namespace_goog_result.html" rel="nofollow noopener" target="_blank">goog.result</a> など</p></li>
<li><p><strong>generator(yield)を使って同期処理みたいに非同期処理が書けるよ方式</strong> ：<a href="https://github.com/visionmedia/co" rel="nofollow noopener" target="_blank">co</a>, <a href="http://taskjs.org/" rel="nofollow noopener" target="_blank">task.js</a> など</p></li>
<li><p><strong>そんなことよりFunctional Reactive Programmingだ！方式</strong> ：<a href="https://github.com/Reactive-Extensions/RxJS" rel="nofollow noopener" target="_blank">RxJS</a>, <a href="https://github.com/baconjs/bacon.js" rel="nofollow noopener" target="_blank">Bacon.js</a> など</p></li>
</ul>

<p>はて、こんな対立構造をどこかで見たことあるなあと思ったら、C#でも以前同じような議論がありました。</p>

<ul>
<li><a href="http://www.slideshare.net/neuecc/asynchronous-rx-andtask" rel="nofollow noopener" target="_blank">C#次世代非同期処理概観 - Task vs Reactive Extensions</a></li>
</ul>

<p>それぞれ対応付けてみるとこんな感じですね。</p>

<table>
<thead>
<tr>
<th style="text-align: left">C#</th>
<th style="text-align: left">JavaScript</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">Task</td>
<td style="text-align: left">promiseなど</td>
</tr>
<tr>
<td style="text-align: left">async/await</td>
<td style="text-align: left">coなど</td>
</tr>
<tr>
<td style="text-align: left">Reactive Extensions</td>
<td style="text-align: left">RxJSなど</td>
</tr>
</tbody>
</table>

<h2>
<span id="各方式は対立するのか" class="fragment"></span><a href="#%E5%90%84%E6%96%B9%E5%BC%8F%E3%81%AF%E5%AF%BE%E7%AB%8B%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>各方式は対立するのか？</h2>

<p>ところでこれらの方式って、必ずしも対立するってわけじゃないんですよね。</p>

<p>JavaScriptのgeneratorはまだ使えるところが限られるけど、コールバックが不要で同期処理のように簡単に書けるのはやはり魅力的です。</p>

<p>一方で、ちょっとした非同期処理をReactive Programmingで処理するのはおおげさですが、ストリーム的に流れてくる複数のイベントを合成したり、時間的な操作をしたりする場合には圧倒的に便利です。</p>

<p>なので、適材適所で使い分けるのがよさそうです。（なんの解決にもなってない！）</p>

<h2>
<span id="promise-co-rxjs" class="fragment"></span><a href="#promise-co-rxjs"><i class="fa fa-link"></i></a>promise, co, RxJS</h2>

<p>さて、使い分けると言っても、方式が異なるものを混ぜて使うことは可能でしょうか？<br>
実は、それぞれの方式は対立しないどころか、連携することも可能です。</p>

<p>各方式の代表的な実装であるpromise, co, RxJSを例にみてみましょう。</p>

<p>まず、promiseとRxJSですが、RxJSにObservable.fromPromise(),Observable.toPromise()というAPIが用意されているので、それを呼ぶだけで相互に変換が可能です。</p>

<p>次に、coはyieldableなオブジェクトを扱うことができるそうです。（参考：<a href="http://havelog.ayumusato.com/develop/javascript/e583-yield_co_thunkify.html" rel="nofollow noopener" target="_blank">いぇーい yield と co と koa</a>）</p>

<p>なのでpromiseはそのままcoで扱うことができるし、次のような変換関数を用意しておけば、RxJSのObservableをcoで扱うことも可能になります。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">observableToThunk</span><span class="p">(</span><span class="nx">observable</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">observable</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">d</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
                <span class="nx">fn</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">d</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
                <span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>これをcoの中で呼ぶようにしてあげます。</p>

<ul>
<li><a href="https://github.com/zoetrope/co/blob/master/index.js#L123" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/zoetrope/co/blob/master/index.js#L123</a></li>
</ul>

<p>そうすると、RxJSのObservableが同期処理のように書けます。エラーもtry/catchで処理できます。<br>
ただしストリーミング的な非同期処理はできなくなるので注意です。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">co</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="k">return</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"date: "</span> <span class="o">+</span> <span class="nx">ret</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div></div>

<p>※coをchromeで動作させるためには、chrome://flagsの#enable-javascript-harmonyを有効にする必要があります。</p>

<h2>
<span id="連携例" class="fragment"></span><a href="#%E9%80%A3%E6%90%BA%E4%BE%8B"><i class="fa fa-link"></i></a>連携例</h2>

<p>promise, co, RxJSの全部を組み合わせると、こんなことができたりします。</p>

<ul>
<li>http通信の結果をpromiseで取得する（AngularJSの$httpサービスを想定）</li>
<li>1つめのhttp通信の結果を使って2つめのhttp通信を行う</li>
<li>RxJSを使ってイベント合成など複雑な処理を行う</li>
<li>coを使うことで最終結果の取得とエラー処理を同期処理のように書く</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">co</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/getid"</span><span class="p">);</span> 
    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/items/"</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">obs</span> <span class="o">=</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">zip</span><span class="p">(</span><span class="nx">mouseEvent</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">received</span><span class="p">,</span> <span class="nx">ev</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">received</span><span class="p">;</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">throttle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">obs</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"error: "</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">})();</span>
</pre></div></div>

<p>うまく連携できてますね！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />8位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>70</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/0b01fda20f8000e485cf">AngularJSのStrict Contextual Escapingって何だ？</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-28 01:58:34</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[AngularJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>AngularJSを1.0系から1.2系にアップグレードした時にハマりがちなのがSCE(Strict Contextual Escaping)ではないでしょうか。<br>
AngularJS 1.2ではSCEがデフォルトで有効になったため、アップグレードしたによりこれまで動いていたアプリが動かなくなる可能性があります。</p>

<p>例えば、「ng-bind-htmlにバインドしているHTMLが表示されなくなった」とか「iframeの内容が表示されなくなった」なんてことが起きたら、まずはconsole.logを見てみましょう。</p>

<p>下記のようなログが出力されていれば、SCEが有効になったことが原因で要素が表示されていないと考えられます。<br>
<code>Attempting to use an unsafe value in a safe context.</code><br>
<code>Blocked loading resource from url not allowed by $sceDelegate policy.</code></p>

<p>よく分からないからとりあえず無効にしてしまえっと、以下のようにするのは簡単ですが、これではセキュアじゃありませんね。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myApp'</span><span class="p">,</span> <span class="p">[]).</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$sceProvider</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$sceProvider</span><span class="p">.</span><span class="nx">enabled</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="p">});</span>
</pre></div></div>

<p>というわけで、セキュアなアプリを作るためにも、まずはSCEが何者なのかを見ていきましょう。</p>

<h1>
<span id="scestrict-contextual-escapingとは" class="fragment"></span><a href="#scestrict-contextual-escaping%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>SCE(Strict Contextual Escaping)とは</h1>

<p>Strict Contextual Escapingって言われても、よい日本語訳が思いつきませんね・・・<br>
要は、セキュリティ対策として、サニタイズされていないHTML要素や、信頼されていないページの要素を表示するのを防止するための機能です。</p>

<p>SCEのような機能がない場合は、安全な要素の変数名に<code>safe_</code>や<code>esc_</code>みたいなプレフィックスをつけて、プレフィックスがついていない変数が表示されていないかどうかをgrepで調べる方法を使ったりします。<br>
しかし、それではサニタイズのうっかり忘れなどを防ぐことができません。</p>

<p>そこで、信頼されている安全なHTMLやURLに信頼済みのマークをつけるようにして、マークのついていない要素を表示できないようにしたり、ブラックリストに含まれているページの内容を表示できないようにしたりするのがSCEの主な機能です。</p>

<p>AngularJS内の実装を見てみると、それほど特別な処理をしているわけではなく、信頼済みコードは<code>TrustedValueHolderType</code>でラップされていて、バインドするときはそれをアンラップしてるだけです。<br>
あくまでも、SCEがサニタイズやエスケープを自動でやってくれるわけではないので、開発者が何らかのライブラリを使ってサニタイズしたり、信頼できるサイトのURLかどうかをチェックする必要があります。</p>

<h1>
<span id="開発者はどうすればいいの" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E8%80%85%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>開発者はどうすればいいの？</h1>

<p>実際のところ、信頼済みマークをつけなければいけない箇所はそれほど多くありません。<br>
AngularJSでは、<code>{{ }}</code>で文字列を出力した場合は自動的にエスケープされますし、aタグのhref/ngHrefやimgタグのsrc/ngSrcも自動的にサニタイズしてくれます。</p>

<p>主に対応が必要なのは、ngBindHtmlディレクティブとimgタグ以外(video, iframe, objectなど)のsrc/ngSrcです。<br>
それぞれ対応方法を見てみましょう。</p>

<h2>
<span id="ngbindhtml" class="fragment"></span><a href="#ngbindhtml"><i class="fa fa-link"></i></a>ngBindHtml</h2>

<p>ngBindHtmlでHTML要素をバインドするには、下記のように<code>$sce.trustAsHtml</code>を使って信頼済みのマークをつけます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">"myApp.controllers"</span><span class="p">,</span> <span class="p">[])</span>
  <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s2">"MyCtrl"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$sce</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sanitizedHtml</span> <span class="o">=</span> <span class="cm">/* サニタイズ済みのHTML要素 */</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">userHtml</span> <span class="o">=</span> <span class="nx">$sce</span><span class="p">.</span><span class="nx">trustAsHtml</span><span class="p">(</span><span class="nx">sanitaizedHtml</span><span class="p">);</span>
  <span class="p">});</span>
</pre></div></div>

<p>これで、以下のようにHTML要素をバインドすることができます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-bind-html</span><span class="o">=</span><span class="s">"userHtml"</span><span class="p">&gt;</span>
</pre></div></div>

<p>なお、AngularJS 1.0では、HTML要素をバインドするためにngBindHtmlとngBindHtmlUnsafeという2種類のディレクティブが用意されていましたが、AngularJS 1.2からはngBindHtmlに1本化され、ngSanitizeを依存モジュールに加える必要もなくなりました。</p>

<h2>
<span id="srcngsrc" class="fragment"></span><a href="#srcngsrc"><i class="fa fa-link"></i></a>src/ngSrc</h2>

<p>続いて、img以外のタグ(iframe, object, videoなど)のsrc/ngSrcに指定するURLです。</p>

<p>さて、aタグのhrefやimgタグのsrcは自動でサニタイズしてくれるのに、それ以外のタグではなぜ信頼済みマークをつける必要があるのでしょうか？<br>
それは、例えばiframeを使うとクロスサイトリクエストフォージェリなどの危険性があるため、URLをサニタイズするだけでは不十分だからです。<br>
なので、アプリケーションの中に埋め込んでも問題ないサイトのURLかどうかを確認する必要があります。</p>

<p>対応方法は2通りあります。<br>
1つ目の方法はngBindHtmlと同じように、<code>$sce.trustAsResourceUrl</code>を使ってマークする方法です。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">"myApp.controllers"</span><span class="p">,</span> <span class="p">[])</span>
  <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s2">"MyCtrl"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$sce</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">trustedUrl</span> <span class="o">=</span> <span class="cm">/* 信頼できるサイトのURL */</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">$sce</span><span class="p">.</span><span class="nx">trustAsResourceUrl</span><span class="p">(</span><span class="nx">trustedUrl</span><span class="p">);</span>
  <span class="p">});</span>
</pre></div></div>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">src</span><span class="o">=</span><span class="s">"{{url}}"</span><span class="p">&gt;</span>
</pre></div></div>

<p>もう1つの方法は、ホワイトリストとブラックリストを使う方法です。<br>
下記のようにホワイトリストにURLを登録すれば、<code>$sce.trustAsResourceUrl</code>を呼び出す必要はなく、src/ngSrcにバインドすることができます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myApp'</span><span class="p">,</span> <span class="p">[])</span>
  <span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$sceDelegateProvider</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$sceDelegateProvider</span><span class="p">.</span><span class="nx">resourceUrlWhitelist</span><span class="p">([</span>
      <span class="s1">'self'</span><span class="p">,</span>
      <span class="s1">'http://example.com/**'</span>
    <span class="p">]);</span>
  <span class="p">});</span>
</pre></div></div>

<h2>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h2>

<p>ngIncludeやtemplateUrlで指定するURLは、通常アプリをホストしているドメインと同じになると思いますが、もし外部のサイトのURLを指定する場合は、ホワイトリストに追加するようにします。</p>

<p>自作ディレクティブで信頼済みのHTMLバインドしている場合は、そのHTMLをDOMにパースするために<code>$parse</code>の代わりに<code>$sce.parseAsHtml</code>を使います。</p>

<p>より詳しく知りたい場合は公式ページを確認してください。</p>

<ul>
<li><a href="http://docs.angularjs.org/api/ng.%24sce" class="autolink" rel="nofollow noopener" target="_blank">http://docs.angularjs.org/api/ng.$sce</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />9位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>27</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/49b8904304570019e857">rx.angular.jsでインクリメンタルサーチ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-05 21:25:16</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[ReactiveExtensions]</b> <b>[AngularJS]</b> <b>[RxJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>先日、<a href="http://qiita.com/zoetro/items/6d69585b8e90e6e56198" id="reference-68855e78b036461fd963">AngularJSの非同期処理をRxJSにつなげてみる</a>という記事を書いたのですが、その数日後にReactive Extensionsの公式リポジトリにこんなのが作られてました。</p>

<ul>
<li><a href="https://github.com/Reactive-Extensions/rx.angular.js" rel="nofollow noopener" target="_blank">rx.angular.js - Reactive Extensions Bindings for AngularJS</a></li>
</ul>

<p>AngularJSとRxJSを連携させるためのライブラリのようです。<br>
ソースコードを覗いてみましたが、現状では下記の2つの関数が用意されていました。</p>

<ul>
<li><code>$toObservable</code></li>
<li><code>observeOnScope</code></li>
</ul>

<p>どちらも<code>$scope</code>の保持している変数の変更通知（すなわち<code>$scope.$watch</code>）をRxのObservableに変換するための機能です。<br>
<code>$scope.$toObservable('xxx')</code>のように<code>$scope</code>のメソッドとして呼び出すか、<code>observeOnScope($scope, 'xxx')</code>のように関数の引数に<code>$scope</code>を渡すかが違うようですね。</p>

<p>さて、その<a href="https://github.com/Reactive-Extensions/rx.angular.js/blob/master/examples/%24toObservable" rel="nofollow noopener" target="_blank">サンプルコード</a>が面白かったのでご紹介。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">app.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">$scope</span><span class="p">.</span><span class="nx">search</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nx">$scope</span><span class="p">.</span><span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">var</span> <span class="nx">search</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$http</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s2">"http://en.wikipedia.org/w/api.php?&amp;callback=JSON_CALLBACK"</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s2">"jsonp"</span><span class="p">,</span>
    <span class="nx">params</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">action</span><span class="o">:</span> <span class="s2">"opensearch"</span><span class="p">,</span>
      <span class="nx">search</span><span class="o">:</span> <span class="nx">term</span><span class="p">,</span>
      <span class="nx">format</span><span class="o">:</span> <span class="s2">"json"</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span>
    <span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">deferred</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">$scope</span>
    <span class="p">.</span><span class="nx">$toObservable</span><span class="p">(</span><span class="s1">'search'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">throttle</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">newValue</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">distinctUntilChanged</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">search</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">switchLatest</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">){</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">results</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="p">});</span>
</pre></div>
</div>

<p>これは、サーバーに問い合わせるタイプのインクリメンタルサーチのサンプルです。<br>
<code>$scope.search</code>がテキストボックスにバインドされていて、入力した文字列をWikipediaで調べて、その結果を<code>$scope.results</code>に出力するようになっています。</p>

<p>前半の処理は、<code>$http</code>でWikipediaに問い合わせをして、その結果のpromiseをRxJSで扱えるように変換しています。<br>
面白いのは後半の処理なので、1行ずつ解説します。</p>

<ul>
<li>
<code>$scope.$toObservable('search')</code>

<ul>
<li>
<code>$scope.search</code>の変更通知をRxJSで扱えるように変換します。</li>
</ul>
</li>
<li>
<code>throttle(300)</code>

<ul>
<li>指定した時間（300msec）、新たな変更通知が発生しなかったら最後に発生した値を後続に流します。</li>
<li>テキストボックスに連続で文字を入力するときに、1文字入力するたびにサーバーに問い合わせるのはうれしくないですからね。</li>
</ul>
</li>
<li>
<code>map(・・・)</code>

<ul>
<li>dataはnewValueとoldValueを持っているので、newValueだけ後続に流します。</li>
</ul>
</li>
<li>
<code>distinctUntilChanged()</code>

<ul>
<li>前回と値が同じだったら後続に流しません。</li>
</ul>
</li>
<li>
<code>select(search)</code>

<ul>
<li>
<code>$http</code>を使ってWikipediaに問い合わせを行います。</li>
</ul>
</li>
<li>
<code>switchLatest()</code>

<ul>
<li>同じタイミングでサーバーへの問い合わせが複数発生した場合、最後の問い合わせの結果だけを後続に流します。</li>
<li>
<code>throttle()</code>は時間的に最後に発生した値を後続に流すものでしたが、こちらは最後の問い合わせの結果を後続に流します。最後に問い合わせたものが、時間的には先に返ってくることもありますからね。</li>
</ul>
</li>
<li>
<code>subscribe(・・・)</code>

<ul>
<li>
<code>$scope.results</code>に結果を入れます。</li>
</ul>
</li>
</ul>

<p>リアクティブプログラミングは最初はなかなか取っ付きづらいですが、慣れてくると複雑な処理がこんなにすっきり書けます。便利ですね！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />10位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>20</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/62ec3a0bbe85ed275703">RxJSでWebSocketクライアント</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-15 12:46:43</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[websocket]</b> <b>[RxJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>RxJSでWebSocketクライアントを扱うコードです。<br>
探してもよさそうなものが見つからなかったので自分で書いてみました。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">observablewebsocket.js</span></div>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * WebSocketクライアントをRxJSで扱える形に変換して返す関数</span>
<span class="cm"> * @param {string} WebSocketの接続URL</span>
<span class="cm"> * @returns {Rx.Observable&lt;Rx.Observable&lt;any&gt;&gt;} データ受信用Observableを返すObservable</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">webSocketAsObservable</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">connector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">AsyncSubject</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">Socket</span> <span class="o">=</span> <span class="nx">WebSocket</span> <span class="o">||</span> <span class="nx">MozWebSocket</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Socket</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>

    <span class="nx">socket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ee</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connector</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">ee</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ce</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connector</span><span class="p">.</span><span class="nx">onCompleted</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="c1">// 接続に成功したら、データ受信用Observable（receiver）を作って通知する</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">receiver</span> <span class="o">=</span>
            <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">createWithDisposable</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">observer</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">observer</span><span class="p">.</span><span class="nx">onNext</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
                <span class="p">};</span>
                <span class="nx">socket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ee</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">observer</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">ee</span><span class="p">);</span>
                <span class="p">};</span>
                <span class="nx">socket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ce</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">observer</span><span class="p">.</span><span class="nx">onCompleted</span><span class="p">();</span>
                <span class="p">};</span>
                <span class="k">return</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Disposable</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="nx">connector</span><span class="p">.</span><span class="nx">onNext</span><span class="p">(</span><span class="nx">receiver</span><span class="p">);</span>
        <span class="nx">connector</span><span class="p">.</span><span class="nx">onCompleted</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">connector</span><span class="p">.</span><span class="nx">asObservable</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>

<p>利用するにはrx.jsが必要になるので、下記からダウンロードするかbowerなどでインストールしてください。</p>

<ul>
<li><a href="https://github.com/Reactive-Extensions/RxJS" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Reactive-Extensions/RxJS</a></li>
</ul>

<h2>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h2>

<p>webSocketAsObservableを呼ぶと、接続に成功した時に「データ受信用Observable」を返すObservableが得られます。<br>
Observableが入れ子になっているのでちょっとややこしいですね。</p>

<p>入れ子になっているときはRxJSのselectManyを使います。<br>
すると「データ受信用Observable」を取り出して、受信したデータを後続に流すことができます。</p>

<p>エラー処理などを考えなければこんな感じで使えます。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">sample1.js</span></div>
<div class="highlight"><pre><span></span><span class="nx">observableWebSocket</span><span class="p">(</span><span class="s2">"ws://localhost:9090/"</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">selectMany</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">receiver</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 接続に成功したので、データ受信用のObservableを取り出して、後続に受信データを流す</span>
    <span class="k">return</span> <span class="nx">receiver</span><span class="p">;</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// WebSocketで受け取ったデータを使う処理</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
  <span class="p">});</span>
</pre></div>
</div>

<p>エラー処理も含めるとこんな感じで書けます。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">sample2.js</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">sock</span> <span class="o">=</span> <span class="nx">observableWebSocket</span><span class="p">(</span><span class="s2">"ws://localhost:9090/"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">disposable</span> <span class="o">=</span> <span class="nx">sock</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 接続に失敗した時の処理</span>
    <span class="k">return</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">selectMany</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">receiver</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 接続に成功した時の処理</span>
    <span class="k">return</span> <span class="nx">receiver</span><span class="p">;</span>
<span class="p">}).</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 通信中にエラーが発生したり、接続が切れたりした後の処理</span>
<span class="p">}).</span><span class="nx">subscribe</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// WebSocketで受け取ったデータを使う処理</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 切断したい場合はdisposeを呼ぶ</span>
<span class="nx">disposable</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />11位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>19</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/e7f591227c2bc285f63f">AngularJSの$resourceの仕組み</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-22 21:29:49</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[AngularJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ここでちょっと勘違いなコメントをしてしまいました。</p>

<ul>
<li><a href="http://qiita.com/toruta39/items/2de08b73fddb72270ffb" id="reference-884e2bdb5310e73ab631">AngularJSで同期のように非同期関数を書く</a></li>
</ul>

<p>AngularJSの$resourceサービスを使うと、以下のように非同期な処理なのに同期呼び出しのように書けるということなんですが、僕はこれをPromiseを返して実現してるものだと思っていました。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s1">'/api/user/:username'</span><span class="p">);</span>
<span class="nx">$scope</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">User</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span><span class="nx">username</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">});</span>
</pre></div></div>

<p>でも違うんですね。<br>
公式ドキュメントを読むとちゃんと書いてあります。</p>

<ul>
<li><a href="http://docs.angularjs.org/api/ngResource.%24resource" rel="nofollow noopener" target="_blank">AngularJS: ngResource.$resource</a></li>
</ul>

<p>$resourceオブジェクトのメソッドを呼び出すとすぐに空の参照を返し、サーバーから結果が返ってくるとその結果を参照に追加すると。</p>

<p>確かに実装を見てもそうなってました。<br>
戻り値が配列でない場合(getとか)は、まずResource型のインスタンスを作って参照を返し、サーバーから結果を受け取ったら参照の中身を置き換える。<br>
戻り値が配列の場合(queryとか)は、まず空の配列を返し、サーバーから結果を受け取ったらそれを配列にpushする。</p>

<p>なるほど。よくできてますね！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>zoetroさんの<br />12位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>19</kbd>
		<a target="_blank" href="https://qiita.com/zoetro/items/6d69585b8e90e6e56198">AngularJSの非同期処理をRxJSにつなげてみる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-19 21:52:08</center>
	</td>
	<td style="width:200px;">
		@zoetro<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/3489/profile-images/1473683235">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[ReactiveExtensions]</b> <b>[AngularJS]</b> <b>[RxJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>AngularJSでは非同期処理のAPIとしてPromise API（$q Service）が用意されています。</p>

<p>このPromise APIですがAngularJS v1.2でPromise/A+に準拠した形になりました。<br>
Promise/A+の詳細については下記を参照してください。</p>

<ul>
<li><a href="https://gist.github.com/OrgaChem/5903697" rel="nofollow noopener" target="_blank">Promise/A+</a></li>
</ul>

<p>AngularJSのPromise APIは非同期処理としては最小限の機能しか用意されておらず、複雑な非同期処理を書く場合は何かしらのライブラリが利用したくなります。</p>

<p>非同期処理のライブラリとしてはJSDeferredやjQuery.Deferredなどが有名ですが、今回はRxJSを使ってみます。</p>

<ul>
<li><a href="http://reactive-extensions.github.io/RxJS/" rel="nofollow noopener" target="_blank">Reactive Extensions for JavaScript (RxJS)</a></li>
</ul>

<p>RxJSもv2.2でPromise/A+に準拠したObservable.fromPromiseが追加されたので、AngularJSのPromiseとRxJSを連携させて使うことが簡単にできるようになりました。</p>

<p>というわけで、AngularJSで用意されている$resource (Web APIを呼び出すためのサービス) を例にして、RxJSと連携させる方法を紹介したいと思います。<br>
それぞれの基本的な使い方は省略するので、各種ドキュメントを参考にしてください。</p>

<h2>
<span id="単純な処理の比較" class="fragment"></span><a href="#%E5%8D%98%E7%B4%94%E3%81%AA%E5%87%A6%E7%90%86%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>単純な処理の比較</h2>

<p>まずAngularJSのPromiseを使った場合と、RxJSを使った場合の単純な処理の書き方を比較してみます。</p>

<p>リクエストを投げて成功した場合と失敗した場合のコールバックをセットするには以下のように書きます。<br>
これだと、Promiseを使ったほうが簡単ですね。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Promise</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/hoge"</span><span class="p">);</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">$promise</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"success: "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span> <span class="p">},</span> 
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"failure: "</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">RxJS</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/hoge"</span><span class="p">);</span>
<span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">$promise</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"success: "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span> <span class="p">},</span> 
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"failure: "</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">);</span>
</pre></div>
</div>

<p>1つ目のリクエストが完了したら、その結果を使って次のリクエストを呼び出す場合は以下のように。<br>
これも、Promiseのほうがthenをつなげて書くだけなので分かりやすいですね・・・</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Promise</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">res1</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/hoge"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">res2</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/fuga/:id"</span><span class="p">);</span>
<span class="nx">res1</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">$promise</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">res2</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">}).</span><span class="nx">$promise</span><span class="p">;</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"success: "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span> <span class="p">},</span> 
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"failure: "</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">);</span>
</pre></div>
</div>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">RxJS</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">res1</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/hoge"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">res2</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/fuga/:id"</span><span class="p">);</span>
<span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">res1</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">$promise</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">selectMany</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">res2</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">}).</span><span class="nx">$promise</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"success: "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span> <span class="p">},</span> 
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"failure: "</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="rxjsの便利なメソッド" class="fragment"></span><a href="#rxjs%E3%81%AE%E4%BE%BF%E5%88%A9%E3%81%AA%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>RxJSの便利なメソッド</h2>

<p>ここからは、Promiseだけで実装しようとすると複雑になるような処理を、RxJSで書いてみたいと思います。</p>

<p>まず、リクエストに成功するまで最大3回リトライする処理はこんな感じで書けます。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">リトライ(RxJS)</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/hoge"</span><span class="p">)</span>
<span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">$promise</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">retry</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"success: "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span> <span class="p">},</span> 
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"failure: "</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">);</span>
</pre></div>
</div>

<p>複数のリクエストを投げて、その結果が揃うまで待ってから次の処理をするというのも簡単に書けます。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">待ち合わせ(RxJS)</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">res1</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/hoge"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">res2</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">"/fuga"</span><span class="p">);</span>
<span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">res1</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">$promise</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">zip</span><span class="p">(</span><span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">res2</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">$promise</span><span class="p">),</span> 
    <span class="kd">function</span><span class="p">(</span><span class="nx">data1</span><span class="p">,</span> <span class="nx">data2</span><span class="p">){</span> <span class="k">return</span> <span class="p">[</span><span class="nx">data1</span><span class="p">,</span> <span class="nx">data2</span><span class="p">];</span> <span class="p">}</span>
  <span class="p">)</span>
  <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"success: "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">},</span> 
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"failure: "</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">);</span>
</pre></div>
</div>

<p>今回は簡単な例ばかりを示しましたが、RxJSには非常に便利なAPIがたくさん用意されているのでぜひ使ってみてください。</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
