<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (joker1007)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (joker1007 さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1086</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/2a03500017766bdb0234">てめえらのRailsはオブジェクト指向じゃねえ！まずはCallbackクラス、Validatorクラスを活用しろ！</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-04 14:02:44</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ちょっと煽り気味のタイトルにしてみましたが、Railsで開発する時は意識的にOOPに寄せないとオブジェクトの力が活かせなくなるよってことと、Railsが提供しているクラスの責務を分割することを支援してくれる機能について話をします。</p>

<h2>
<span id="activerecordの性質" class="fragment"></span><a href="#activerecord%E3%81%AE%E6%80%A7%E8%B3%AA"><i class="fa fa-link"></i></a>ActiveRecordの性質</h2>

<p>Rails開発においては、モデル層にロジックを書いてコントローラーは薄くしろ、というのはしつこく言われているので、概ね浸透してきていると思います。</p>

<p>それに加えて、最近私が結構しつこく主張しておきたいのが、モデル = ActiveRecordでは無いよ、ということです。</p>

<p>ActiveRecordは成り立ちから言うと、ロジックとDBへの永続化をまとめてカプセル化するアーキテクチャパターンから来ています。(詳しくはエンタープライズアプリケーションアーキテクチャパターンという書籍を読むと良いです)<br>
この方法はロジックが複雑でない場合、つまりCRUD+αぐらいの時には非常に上手くいきます。<br>
RailsのActiveRecordは非常に便利なのでそこそこの規模ぐらいのものを作ってる時には余り問題になりません。</p>

<p>しかし、規模が大きくなってくるとActiveRecordだけでは色々と辛い側面が出てきます。<br>
テーブルと1:1という形でクラス構造が縛られる事により構造化に限界が発生し、一つのクラスに何でもかんでもロジックを記述していくことになります。<br>
これによって生じる問題がファットモデルです。<br>
モデル層をActiveRecordだけに頼っていると、いずれこの問題にぶち当たることになります。</p>

<p>これを解決するには地道にオブジェクト指向の基本に立ち返ること、上手くアクティブレコードから責任を分離する事が必要です。<br>
ActiveRecordは開発の初期には非常に便利で問題も余り顕在化しないため、そこに囚われていると気付いた時にはえらくファットになってるという事が十分にあり得ます。</p>

<h2>
<span id="rails謹製-ダイエット食品" class="fragment"></span><a href="#rails%E8%AC%B9%E8%A3%BD-%E3%83%80%E3%82%A4%E3%82%A8%E3%83%83%E3%83%88%E9%A3%9F%E5%93%81"><i class="fa fa-link"></i></a>Rails謹製 ダイエット食品</h2>

<p>Railsは良く考えられたフレームワークなので、もちろんそれ自体の中にもちゃんと責務を細かく分けるための仕組みを準備してくれています。<br>
Railsが提供してくれる機能を理解し、モデルの責任を分割することでより良いモデルを作っていくことができます。その中でも代表的な機能が以下の4つです。</p>

<ul>
<li>Callbackクラス</li>
<li>Validatorクラス</li>
<li>ActiveModelモジュール</li>
<li>値オブジェクト (composed_of)</li>
</ul>

<p>今回は、その中で忘れられがちな印象を受ける上の2つについて解説します。</p>

<h2>
<span id="callbackクラス" class="fragment"></span><a href="#callback%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>Callbackクラス</h2>

<p><a href="http://api.rubyonrails.org/classes/ActiveRecord/Callbacks.html" title="ActiveRecord::Callbacks" rel="nofollow noopener" target="_blank">ActiveRecord::Callbacks</a>からActiveRecordオブジェクトのコールバック機能の使い方を参照してみます。</p>

<p>ActiveRecordオブジェクトのコールバックはこんな感じで記述するのが簡単な方法です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Subscription</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_create</span> <span class="ss">:record_signup</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">record_signup</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">signed_up_on</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>この様に自分のオブジェクトのパラメーター調整等であればこのクラスの責任と言えるし、簡単なのでシンプルにprivateメソッドにしておけば他から変な形で利用されることもなくなります。</p>

<p>しかし、もしある程度複雑な処理が関係してくる場合は、もう少し分割したくなってきます。<br>
例えば、RailsのAPIリファレンスにあるような特定カラムを透過的に暗号化したい場合や、コールバックの動作に条件がいくつかある場合等です。<br>
こうなってくると、コールバック処理自体にもテストコードを書きたくもなりますね。</p>

<p>その場合は、機能名を表現するクラスを用意してそちらに処理を記述します。<br>
Railsではクラスに特定のメソッドを定義しておくだけで、任意のクラスをコールバック処理に組み込むことができます。</p>

<p>APIリファレンスのサンプルを見てみましょう。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BankAccount</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span>      <span class="no">EncryptionWrapper</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"credit_card_number"</span><span class="p">)</span>
  <span class="n">after_save</span>       <span class="no">EncryptionWrapper</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"credit_card_number"</span><span class="p">)</span>
  <span class="n">after_initialize</span> <span class="no">EncryptionWrapper</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"credit_card_number"</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">EncryptionWrapper</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
    <span class="vi">@attribute</span> <span class="o">=</span> <span class="n">attribute</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">before_save</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="n">record</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="vi">@attribute</span><span class="si">}</span><span class="s2">="</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="vi">@attribute</span><span class="si">}</span><span class="s2">"</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">after_save</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="n">record</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="vi">@attribute</span><span class="si">}</span><span class="s2">="</span><span class="p">,</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="vi">@attribute</span><span class="si">}</span><span class="s2">"</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="n">alias_method</span> <span class="ss">:after_initialize</span><span class="p">,</span> <span class="ss">:after_save</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="c1"># Secrecy is committed</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="c1"># Secrecy is unveiled</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>このように<code>before_save</code>や<code>after_save</code>等のコールバックに対応するメソッドをパブリックメソッドとして定義しておけばOKです。引数にはコールバックを呼び出す切っ掛けになったオブジェクトが渡されます。</p>

<p>一つのモデルから分離することで、汎用的な処理を複数のクラスで再利用できるようになります。</p>

<p>こういった記述をする利点は他にもいくつかあります。</p>

<p>まず、機能に明確な名前と境界が付くことです。<br>
一つのモデルにまとめて記述されていると、色々なものの中に埋もれてしまい、どういう時に利用されるメソッドなのかはっきりせず後から変更する時に悩む要因になります。<br>
境界が明確になっている事で、後から見ても用途を把握しやすくなります。</p>

<p>また、テストが容易になるのも利点の一つです。<br>
コールバックの起動を単なるpublicメソッドの呼び出しとして行えるため、テストコードで検証する際に無駄なトリックを使う必要が無くなります。<br>
また、このクラスはActiveRecordのオブジェクトに縛られずにテストする事ができます。<br>
このクラスをテストするのに必要なものは、適切なインターフェースを供えたオブジェクトであれば何でも良いのです。RSpecの<code>double</code>や<code>mock_model</code>等で、ダミーのオブジェクトは簡単に高速に準備することができます。<br>
もし、最初のサンプルコードのようにモデル内のprivateメソッドとして定義していたり、直接ブロックを渡すような記述をしていた場合、ActiveRecordのオブジェクトを実際に保存して、状態の変化を確かめる、という面倒なテストが必要になってしまいます。そうなってくると他のバリデーションやコールバックが影響する可能性もあって非常に面倒です。(もしくはprivateメソッドを無理やり呼び出すとか)</p>

<p>このように、コールバックに別のクラスを利用するのは単なるクラス定義だけで良いので非常にお手軽で、上手く分類できるとモデルがかなりすっきりします。</p>

<h2>
<span id="validatorクラス" class="fragment"></span><a href="#validator%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>Validatorクラス</h2>

<p>コールバックとバリデーションは非常に似た記述方法を取ります。<br>
そしてバリデーションにもコールバック同様、クラスを分割する仕組みがあります。</p>

<p>Validatorクラスを利用するには<code>validates_with</code>メソッドと<code>ActiveModel::Validator</code>クラスを利用します。</p>

<p>例えば、会議室の利用予約機能を作るとして、予定が他の予定と重なったらバリデーションエラーになる、という仕組みを考えてみます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># started_at: timestamp</span>
<span class="c1"># finished_at: timestamp</span>
<span class="k">class</span> <span class="nc">Schedule</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:room</span>
  <span class="n">validates_with</span> <span class="no">MustNotOverlapValidator</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MustNotOverlapValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="n">overlapped_schedules</span> <span class="o">=</span> <span class="no">Schedule</span>
      <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">room_id</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">room_id</span><span class="p">)</span>
      <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"finished_at &gt; ?"</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">started_at</span><span class="p">)</span>
      <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"started_at &lt; ?"</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">finished_at</span><span class="p">)</span>
      <span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">overlapped_schedules</span><span class="o">.</span><span class="n">exists?</span>
      <span class="n">record</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span> <span class="ss">:base</span><span class="p">,</span> <span class="s2">"Schedule must not overlap on other schedules"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>こんな感じで、<code>ActiveModel::Validator</code>を継承したクラスを作り<code>validate</code>メソッドをオーバーライドします。<br>
利用するモデル側からは、<code>validate_with</code>の引数としてValidatorクラスのクラス名を指定します。</p>

<p>Validatorクラスには一つ注意点があります。Validatorクラスは通常一度しかインスタンス化されず、そのオブジェクトをずっと使い回すことになります。変にインスタンス変数とかを利用するとずっと残ってしまうので利用する場合は、意図せず変更されないように注意しましょう。</p>

<p>ValidatorクラスもCallbackクラス同様、テストが容易になり責務がはっきりする利点があります。<br>
Validatorクラスは<code>ActiveModel</code>の仕組みに依存しているので、バリデーション対象のオブジェクトがテスト時に必要になりますが、特定の検証ロジックを単体で呼び出してテストすることが簡単になりますし、境界がはっきりするのでモックを利用しやすくなります。</p>

<p>ちなみにテスト時にValidatorクラスのインスタンスを作る時には、コンストラクタに引数としてハッシュを渡しておく必要があります。これは<code>ActiveModel::Validator</code>クラスのコンストラクタが引数としてオプションの設定値を取るためです。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>こんな感じで、Railsが提供している機能を活用すれば、モデルの責務をより細かく分割することができます。<br>
利用するカラム値や関連等を上手く抽象化すれば再利用性も高まっていい感じです。<br>
ただ、何でもかんでも分割すれば良いというものじゃないのが難しい所です。<br>
ロジックがに無軌道にあちこちに散らばってしまうと、それはそれで全体像を把握することが難しくなります。<br>
大事なのは名前がちゃんと付けられるか考えるということです。(ネームスペースどうする、suffixどうする、とか大分悩ましいですが)<br>
一つのクラスとして独立してテストコードを書きたいかどうか、というのも私の中では指標の一つとして活用しています。</p>

<p>サンプルコードだと良い使い所を上手く表現できないのですが、継ぎ足し継ぎ足し開発していると結構色々あるものなんですよ。<br>
なので、覚えておいて損は無いんじゃないでしょうか。</p>

<p>他にもモデル層を整理する考え方やテクニックは色々あります。<br>
この記事で紹介したようなコールバックという体裁を取るよりも、トランザクションを一つにまとめるサービスクラスという形を取って明示的に呼び出した方が柔軟で扱いやすくなる場合もあります。<br>
Advent Calendarの予告コメントを見ると、そういった記事も出てきそうなので引き続きのAdvent Calendarに期待してます。</p>

<h2>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h2>

<p>今までRailsにpull reqがマージされたこと無かったんですが、この記事書いてたらCallbackのサンプルコードのバグに気付いたので修正してpull reqを送った所、速攻でマージされて初コントリビュートが出来ました。<br>
Advent Calendarに感謝です。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>515</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/be5dc3f3b1e93132a4f7">俺がGitHubでスターを付けたリポジトリ一覧</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-11 00:48:24</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[JavaScript]</b> <b>[GitHub]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>GitHubを彷徨っていてよくあるのが、ググったりRuby Toolboxとかで見つけて「これイイじゃんよ！」と思ったら既にスター済み、という奴。<br>
一回、自分がどんなリポジトリにスター付けたのか整理しつつ、更新止まってたり古くなったやつを削除していこうと思う。</p>

<p>それぞれの説明は超適当。基本的にいつか使おう的な感じでスターを付けているので、あんまり使ったことあるのが無い。<br>
そもそも良く使うものにはスター付けてないこと多いし…。</p>

<p>大体rubygemsで一部JSのライブラリ、少しvimとScalaって感じ。</p>

<p>思い返したようにスター付けてたので、時期がバラバラだけど、基本的に下に行く程付けた時期が新しい。</p>

<table>
<thead>
<tr>
<th>リポジトリ</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/norman/friendly_id" title="norman/friendly_id" rel="nofollow noopener" target="_blank">norman/friendly_id</a></td>
<td>数字以外のIDでActiveRecordを検索したい時に便利にしてくれるgem</td>
</tr>
<tr>
<td><a href="https://github.com/thoughtbot/factory_girl" title="thoughtbot/factory_girl" rel="nofollow noopener" target="_blank">thoughtbot/factory_girl</a></td>
<td>テストデータを簡単に準備するfixture replacementの定番gem</td>
</tr>
<tr>
<td><a href="https://github.com/jpmobile/jpmobile" title="jpmobile/jpmobile" rel="nofollow noopener" target="_blank">jpmobile/jpmobile</a></td>
<td>日本の携帯向けの機能を追加するRails拡張</td>
</tr>
<tr>
<td><a href="https://github.com/apotonick/cells" title="apotonick/cells" rel="nofollow noopener" target="_blank">apotonick/cells</a></td>
<td>ビューのパーツごとにコンポーネント化して1セットにできるRails拡張</td>
</tr>
<tr>
<td><a href="https://github.com/tuupola/jquery_lazyload" title="tuupola/jquery_lazyload" rel="nofollow noopener" target="_blank">tuupola/jquery_lazyload</a></td>
<td>画像の遅延表示を行うjQueryプラグイン</td>
</tr>
<tr>
<td><a href="https://github.com/matthuhiggins/foreigner" title="matthuhiggins/foreigner" rel="nofollow noopener" target="_blank">matthuhiggins/foreigner</a></td>
<td>Railsのマイグレーションにforeign key制約を定義するDSLを追加する</td>
</tr>
<tr>
<td><a href="https://github.com/igrigorik/em-proxy" title="igrigorik/em-proxy" rel="nofollow noopener" target="_blank">igrigorik/em-proxy</a></td>
<td>EventMachineを利用したプロキシサーバ。RubyのDSLでTCPのパケットをスパイしたり転送したり</td>
</tr>
<tr>
<td><a href="https://github.com/plataformatec/devise" title="plataformatec/devise" rel="nofollow noopener" target="_blank">plataformatec/devise</a></td>
<td>Railsに認証機能を追加するgemの定番。便利だけど頻繁に悩まされる</td>
</tr>
<tr>
<td><a href="https://github.com/jboesch/Gritter" title="jboesch/Gritter" rel="nofollow noopener" target="_blank">jboesch/Gritter</a></td>
<td>Growlっぽい通知を出すためのjQueryプラグイン</td>
</tr>
<tr>
<td><a href="https://github.com/tpope/vim-pathogen" title="tpope/vim-pathogen" rel="nofollow noopener" target="_blank">tpope/vim-pathogen</a></td>
<td>Vimのプラグイン管理を助けてくれるプラグイン。最近NeoBundleを使ってるので使わない</td>
</tr>
<tr>
<td><a href="https://github.com/tyru/skk.vim" title="tyru/skk.vim" rel="nofollow noopener" target="_blank">tyru/skk.vim</a></td>
<td>VimでSKK入力をするプラグイン</td>
</tr>
<tr>
<td><a href="https://github.com/intridea/grape" title="intridea/grape" rel="nofollow noopener" target="_blank">intridea/grape</a></td>
<td>RESTfulなDSLでAPIサーバーを構築できるシンプルなフレームワーク</td>
</tr>
<tr>
<td><a href="https://github.com/presidentbeef/brakeman" title="presidentbeef/brakeman" rel="nofollow noopener" target="_blank">presidentbeef/brakeman</a></td>
<td>Railsの脆弱性を診断するgem。Jenkinsに組み込んだり</td>
</tr>
<tr>
<td><a href="https://github.com/fnichol/chef-rvm" title="fnichol/chef-rvm" rel="nofollow noopener" target="_blank">fnichol/chef-rvm</a></td>
<td>chefでrvmを入れるレシピ。</td>
</tr>
<tr>
<td><a href="https://github.com/mozilla/doctorjs" title="mozilla/doctorjs" rel="nofollow noopener" target="_blank">mozilla/doctorjs</a></td>
<td>JSの静的解析ツール詰め合わせ。jsctags以外が良く分からない</td>
</tr>
<tr>
<td><a href="https://github.com/vimpr/vimperator-plugins" title="vimpr/vimperator-plugins" rel="nofollow noopener" target="_blank">vimpr/vimperator-plugins</a></td>
<td>vimperator向けのプラグインがまとまってるリポジトリ</td>
</tr>
<tr>
<td><a href="https://github.com/nathanaelkane/vim-indent-guides" title="nathanaelkane/vim-indent-guides" rel="nofollow noopener" target="_blank">nathanaelkane/vim-indent-guides</a></td>
<td>Vimのインデント表示を見易くしてくれるプラグイン</td>
</tr>
<tr>
<td><a href="https://github.com/mapbox/node-zipfile" title="mapbox/node-zipfile" rel="nofollow noopener" target="_blank">mapbox/node-zipfile</a></td>
<td>node.js向けのzipfile解凍ライブラリ。libzipを使うらしい</td>
</tr>
<tr>
<td><a href="https://github.com/github/gitignore" title="github/gitignore" rel="nofollow noopener" target="_blank">github/gitignore</a></td>
<td>GitHubが提供してる.gitignoreのサンプル集</td>
</tr>
<tr>
<td><a href="https://github.com/samsonjs/strftime" title="samsonjs/strftime" rel="nofollow noopener" target="_blank">samsonjs/strftime</a></td>
<td>JSにstrftimeを追加する。最近だとmoment.js使った方が良さそう</td>
</tr>
<tr>
<td><a href="https://github.com/codebrew/backbone-rails" title="codebrew/backbone-rails" rel="nofollow noopener" target="_blank">codebrew/backbone-rails</a></td>
<td>Railsにbackbone.jsを追加するgem。generatorとかも追加してくれる。最近使ってない</td>
</tr>
<tr>
<td><a href="https://github.com/cgriego/active_attr" title="cgriego/active_attr" rel="nofollow noopener" target="_blank">cgriego/active_attr</a></td>
<td>簡単な定義でActiveModelっぽいオブジェクトを定義できるgem。最近ActiveModel::Modelあるからそんなに要らない気もする</td>
</tr>
<tr>
<td><a href="https://github.com/sosedoff/capistrano-unicorn" title="sosedoff/capistrano-unicorn" rel="nofollow noopener" target="_blank">sosedoff/capistrano-unicorn</a></td>
<td>Unicorn向けのcapistranoタスクを定義してくれるgem</td>
</tr>
<tr>
<td><a href="https://github.com/faye/faye-websocket-ruby" title="faye/faye-websocket-ruby" rel="nofollow noopener" target="_blank">faye/faye-websocket-ruby</a></td>
<td>FayeというWebSocketライブラリのRuby実装</td>
</tr>
<tr>
<td><a href="https://github.com/amatsuda/active_decorator" title="amatsuda/active_decorator" rel="nofollow noopener" target="_blank">amatsuda/active_decorator</a></td>
<td>Railsにデコレーター層を追加する。オブジェクト指向なビューヘルパーが使える</td>
</tr>
<tr>
<td><a href="https://github.com/bploetz/versionist" title="bploetz/versionist" rel="nofollow noopener" target="_blank">bploetz/versionist</a></td>
<td>サーバーでAPIを提供する時のバージョニングを支援するgem。こんな複雑なバージョニングしない方が良いような気もする。</td>
</tr>
<tr>
<td><a href="https://github.com/brainspec/enumerize" title="brainspec/enumerize" rel="nofollow noopener" target="_blank">brainspec/enumerize</a></td>
<td>ActiveRecordに列挙型っぽい感じでデータを保存する。ActiveRecord::Enumがかなり微妙なのでこっちの方が便利じゃないかなあ。</td>
</tr>
<tr>
<td><a href="https://github.com/pry/pry-stack_explorer" title="pry/pry-stack_explorer" rel="nofollow noopener" target="_blank">pry/pry-stack_explorer</a></td>
<td>Pryにスタックを移動したり一覧したりする機能を追加するgem</td>
</tr>
<tr>
<td><a href="https://github.com/k-tsj/pattern-match" title="k-tsj/pattern-match" rel="nofollow noopener" target="_blank">k-tsj/pattern-match</a></td>
<td>Rubyでパターンマッチをするためのgem。確かSapporo RubyKaigiで聞いたものだったと思う</td>
</tr>
<tr>
<td><a href="https://github.com/cldwalker/debugger" title="cldwalker/debugger" rel="nofollow noopener" target="_blank">cldwalker/debugger</a></td>
<td>Ruby1.9以下向けのデバッガ。最近は、めっきり用が無くなってしまった</td>
</tr>
<tr>
<td><a href="https://github.com/jenseng/immigrant" title="jenseng/immigrant" rel="nofollow noopener" target="_blank">jenseng/immigrant</a></td>
<td>foreignerを利用するマイグレーションファイルを生成するジェネレーター</td>
</tr>
<tr>
<td><a href="https://github.com/shugo/immutable" title="shugo/immutable" rel="nofollow noopener" target="_blank">shugo/immutable</a></td>
<td>immutableなデータ構造をRubyで実装したライブラリ。これもSapporo RubyKaigiで聞いたと思う</td>
</tr>
<tr>
<td><a href="https://github.com/cookpad/arproxy" title="cookpad/arproxy" rel="nofollow noopener" target="_blank">cookpad/arproxy</a></td>
<td>ActiveRecordとDBの間に噛ませるプロキシ。ActiveRecordが発行するSQLを加工したりログ取ったりできる</td>
</tr>
<tr>
<td><a href="https://github.com/tomykaira/rspec-parameterized" title="tomykaira/rspec-parameterized" rel="nofollow noopener" target="_blank">tomykaira/rspec-parameterized</a></td>
<td>RSpecにパラメータライズドテストをやり易くするDSLを追加する</td>
</tr>
<tr>
<td><a href="https://github.com/burke/zeus" title="burke/zeus" rel="nofollow noopener" target="_blank">burke/zeus</a></td>
<td>Railsのコマンド類を高速化するやつ。最近はSpringに移行したので使ってない</td>
</tr>
<tr>
<td><a href="https://github.com/r7kamura/webtail" title="r7kamura/webtail" rel="nofollow noopener" target="_blank">r7kamura/webtail</a></td>
<td>ブラウザでログのtailができるgem</td>
</tr>
<tr>
<td><a href="https://github.com/jschr/bootstrap-modal" title="jschr/bootstrap-modal" rel="nofollow noopener" target="_blank">jschr/bootstrap-modal</a></td>
<td>Bootstrapのモーダル機能を拡張する</td>
</tr>
<tr>
<td><a href="https://github.com/backbone-paginator/backbone-pageable" title="backbone-paginator/backbone-pageable" rel="nofollow noopener" target="_blank">backbone-paginator/backbone-pageable</a></td>
<td>Backbone.jsのページネーションプラグイン</td>
</tr>
<tr>
<td><a href="https://github.com/charliesome/better_errors" title="charliesome/better_errors" rel="nofollow noopener" target="_blank">charliesome/better_errors</a></td>
<td>RailsとかRackアプリのエラー画面をリッチにするgem</td>
</tr>
<tr>
<td><a href="https://github.com/discourse/discourse" title="discourse/discourse" rel="nofollow noopener" target="_blank">discourse/discourse</a></td>
<td>Rails製のコミュニケーションプラットフォーム。規模の大きいRailsアプリケーションの例</td>
</tr>
<tr>
<td><a href="https://github.com/bradphelan/jasminerice" title="bradphelan/jasminerice" rel="nofollow noopener" target="_blank">bradphelan/jasminerice</a></td>
<td>RailsでJasmineを利用したJSのテストを実行するのを支援するgem。あんま更新されてないっぽいので使ってない</td>
</tr>
<tr>
<td><a href="https://github.com/ymattw/cdiff" title="ymattw/cdiff" rel="nofollow noopener" target="_blank">ymattw/cdiff</a></td>
<td>Python製のdiffの強化版 side-by-side出力とかできる</td>
</tr>
<tr>
<td><a href="https://github.com/troessner/reek" title="troessner/reek" rel="nofollow noopener" target="_blank">troessner/reek</a></td>
<td>Rubyのコードのバッドスメルな部分を検出する解析ツール</td>
</tr>
<tr>
<td><a href="https://github.com/seattlerb/flay" title="seattlerb/flay" rel="nofollow noopener" target="_blank">seattlerb/flay</a></td>
<td>Rubyのコードの中で似ている部分を検出してくれる</td>
</tr>
<tr>
<td><a href="https://github.com/acrmp/foodcritic" title="acrmp/foodcritic" rel="nofollow noopener" target="_blank">acrmp/foodcritic</a></td>
<td>ChefのクックブックのLINTツール</td>
</tr>
<tr>
<td><a href="https://github.com/yyuu/capistrano-rbenv" title="yyuu/capistrano-rbenv" rel="nofollow noopener" target="_blank">yyuu/capistrano-rbenv</a></td>
<td>capistranoにrbenvを利用してコマンドを実行する機能を追加する</td>
</tr>
<tr>
<td><a href="https://github.com/thoughtbot/appraisal" title="thoughtbot/appraisal" rel="nofollow noopener" target="_blank">thoughtbot/appraisal</a></td>
<td>複数のGemfileを切り替えてテストを実行するためのgem</td>
</tr>
<tr>
<td><a href="https://github.com/lomba/schema_plus" title="lomba/schema_plus" rel="nofollow noopener" target="_blank">lomba/schema_plus</a></td>
<td>Railsのマイグレーションに色々なDSLを追加する。foreign keyとかviewとか</td>
</tr>
<tr>
<td><a href="https://github.com/ahoward/systemu" title="ahoward/systemu" rel="nofollow noopener" target="_blank">ahoward/systemu</a></td>
<td>Rubyのsystemメソッドをちょっと便利にしたもの。</td>
</tr>
<tr>
<td><a href="https://github.com/comfy/comfortable-mexican-sofa" title="comfy/comfortable-mexican-sofa" rel="nofollow noopener" target="_blank">comfy/comfortable-mexican-sofa</a></td>
<td>Rails4製のCMSエンジン。Rails Engineを利用したアプリケーションの例</td>
</tr>
<tr>
<td><a href="https://github.com/nebhale/git-pivotal-tracker-integration" title="nebhale/git-pivotal-tracker-integration" rel="nofollow noopener" target="_blank">nebhale/git-pivotal-tracker-integration</a></td>
<td>gitにpivotal trackerと連携できるサブコマンドを追加する</td>
</tr>
<tr>
<td><a href="https://github.com/yuroyoro/git-issue" title="yuroyoro/git-issue" rel="nofollow noopener" target="_blank">yuroyoro/git-issue</a></td>
<td>gitにGitHubのissueを操作するサブコマンドを追加する</td>
</tr>
<tr>
<td><a href="https://github.com/markbates/coffee-rails-source-maps" title="markbates/coffee-rails-source-maps" rel="nofollow noopener" target="_blank">markbates/coffee-rails-source-maps</a></td>
<td>coffee-railsでコンパイルされるJSに対応するsource mapを出力してくれるgem</td>
</tr>
<tr>
<td><a href="https://github.com/cldwalker/boson" title="cldwalker/boson" rel="nofollow noopener" target="_blank">cldwalker/boson</a></td>
<td>thorに似た簡単にコマンドラインツールを開発するためのフレームワーク</td>
</tr>
<tr>
<td><a href="https://github.com/jpignata/temping" title="jpignata/temping" rel="nofollow noopener" target="_blank">jpignata/temping</a></td>
<td>ActiveRecordで利用できる一時的なクラスとテーブルを作成してくれるgem。モジュールのテストなんかに使えるらしい</td>
</tr>
<tr>
<td><a href="https://github.com/tomykaira/qspec" title="tomykaira/qspec" rel="nofollow noopener" target="_blank">tomykaira/qspec</a></td>
<td>複数プロセスでRSpecを並列実行するgem。redisを使ってspecのキューイングを行う</td>
</tr>
<tr>
<td><a href="https://github.com/amatsuda/kawaii_validation" title="amatsuda/kawaii_validation" rel="nofollow noopener" target="_blank">amatsuda/kawaii_validation</a></td>
<td>Railsのバリデーション定義にクールなシンタックスを追加する</td>
</tr>
<tr>
<td><a href="https://github.com/agoragames/stache" title="agoragames/stache" rel="nofollow noopener" target="_blank">agoragames/stache</a></td>
<td>Railsのビューテンプレートとしてmustacheかhandlebarsを利用する</td>
</tr>
<tr>
<td><a href="https://github.com/ebryn/backburner.js" title="ebryn/backburner.js" rel="nofollow noopener" target="_blank">ebryn/backburner.js</a></td>
<td>Ember.jsから切り出されたイベントループのためのライブラリ。backboneに組み込んだりできるらしい</td>
</tr>
<tr>
<td><a href="https://github.com/ConradIrwin/jist" title="ConradIrwin/jist" rel="nofollow noopener" target="_blank">ConradIrwin/jist</a></td>
<td>gistにコードをアップロードするコマンドを追加するgem</td>
</tr>
<tr>
<td><a href="https://github.com/glebm/i18n-tasks" title="glebm/i18n-tasks" rel="nofollow noopener" target="_blank">glebm/i18n-tasks</a></td>
<td>Rubyのi18nで使われていないキーを探したり、定義されてないキーを探してくれるgem</td>
</tr>
<tr>
<td><a href="https://github.com/xdite/bootstrap-helper" title="xdite/bootstrap-helper" rel="nofollow noopener" target="_blank">xdite/bootstrap-helper</a></td>
<td>Bootstrapフレンドリーなヘルパーメソッドを定義してくれるgem。でもこれbootstrapのバージョン何に対応してるんだろう</td>
</tr>
<tr>
<td><a href="https://github.com/nathanl/authority" title="nathanl/authority" rel="nofollow noopener" target="_blank">nathanl/authority</a></td>
<td>cancanっぽい権限管理のためのgem。比較的新しい</td>
</tr>
<tr>
<td><a href="https://github.com/deivid-rodriguez/byebug" title="deivid-rodriguez/byebug" rel="nofollow noopener" target="_blank">deivid-rodriguez/byebug</a></td>
<td>Ruby2.0以降のデバッガの定番</td>
</tr>
<tr>
<td><a href="https://github.com/solnic/virtus" title="solnic/virtus" rel="nofollow noopener" target="_blank">solnic/virtus</a></td>
<td>active_attrに似たプレーンなRubyオブジェクトを使ってモデル定義をするためのgem</td>
</tr>
<tr>
<td><a href="https://github.com/wycats/rack-offline" title="wycats/rack-offline" rel="nofollow noopener" target="_blank">wycats/rack-offline</a></td>
<td>HTML5のアプリケーションキャッシュのためのmanifestファイルを出力してくれるgem</td>
</tr>
<tr>
<td><a href="https://github.com/plataformatec/simple_form" title="plataformatec/simple_form" rel="nofollow noopener" target="_blank">plataformatec/simple_form</a></td>
<td>Railsでフォームを表示する時に使える便利なヘルパーを提供するgem</td>
</tr>
<tr>
<td><a href="https://github.com/hayeah/rantly" title="hayeah/rantly" rel="nofollow noopener" target="_blank">hayeah/rantly</a></td>
<td>いくつかの型のランダムなデータを生成してくれるgem。QuickCheck的なテストコードも書けるらしい</td>
</tr>
<tr>
<td><a href="https://github.com/mariusGundersen/Overload" title="mariusGundersen/Overload" rel="nofollow noopener" target="_blank">mariusGundersen/Overload</a></td>
<td>JSでメソッドオーバーロードできる関数を定義できるライブラリ</td>
</tr>
<tr>
<td><a href="https://github.com/guilleiguaran/fakeredis" title="guilleiguaran/fakeredis" rel="nofollow noopener" target="_blank">guilleiguaran/fakeredis</a></td>
<td>インメモリで動作するredis-rb向けのドライバ。テスト時に利用できる</td>
</tr>
<tr>
<td><a href="https://github.com/causes/mock_redis" title="causes/mock_redis" rel="nofollow noopener" target="_blank">causes/mock_redis</a></td>
<td>redis-rbと同じインターフェースを提供するモックオブジェクト。fakeredisと用途は一緒だが動作するレイヤーが違う</td>
</tr>
<tr>
<td><a href="https://github.com/mozilla/brick" title="mozilla/brick" rel="nofollow noopener" target="_blank">mozilla/brick</a></td>
<td>Mozilla製のWebアプリ向けコンポーネント集。タブバーとかスライドするパネルとかカレンダーとかスライダーとか</td>
</tr>
<tr>
<td><a href="https://github.com/mperham/connection_pool" title="mperham/connection_pool" rel="nofollow noopener" target="_blank">mperham/connection_pool</a></td>
<td>簡単にコネクションプールを定義するためのライブラリ。RedisとかDalliとかで便利</td>
</tr>
<tr>
<td><a href="https://github.com/utgarda/sidekiq-status" title="utgarda/sidekiq-status" rel="nofollow noopener" target="_blank">utgarda/sidekiq-status</a></td>
<td>sidekiqのジョブ実行状況をjob_idを元の問い合わせることができるgem</td>
</tr>
<tr>
<td><a href="https://github.com/nateware/redis-objects" title="nateware/redis-objects" rel="nofollow noopener" target="_blank">nateware/redis-objects</a></td>
<td>Redisを利用したORMを提供するgem。</td>
</tr>
<tr>
<td><a href="https://github.com/amatsuda/database_rewinder" title="amatsuda/database_rewinder" rel="nofollow noopener" target="_blank">amatsuda/database_rewinder</a></td>
<td>シンプルで高速なdatabaseクリーンアップgem</td>
</tr>
<tr>
<td><a href="https://github.com/schisamo/vagrant-omnibus" title="schisamo/vagrant-omnibus" rel="nofollow noopener" target="_blank">schisamo/vagrant-omnibus</a></td>
<td>omnibus-installerを利用してchefをインストールするvagrantプラグイン</td>
</tr>
<tr>
<td><a href="https://github.com/amatsuda/rfd" title="amatsuda/rfd" rel="nofollow noopener" target="_blank">amatsuda/rfd</a></td>
<td>Ruby製のターミナル用ファイラー</td>
</tr>
<tr>
<td><a href="https://github.com/zilkey/active_hash" title="zilkey/active_hash" rel="nofollow noopener" target="_blank">zilkey/active_hash</a></td>
<td>HashをデータストアにしたActiveRecordっぽいオブジェクトが定義できるgem</td>
</tr>
<tr>
<td><a href="https://github.com/brentd/xray-rails" title="brentd/xray-rails" rel="nofollow noopener" target="_blank">brentd/xray-rails</a></td>
<td>RailsのテンプレートやBackboneのviewで描画したものが画面上でどこに対応しているかを視覚的に表示してくれる</td>
</tr>
<tr>
<td><a href="https://github.com/emadurandal/emberjs-guides-japanese-translation" title="emadurandal/emberjs-guides-japanese-translation" rel="nofollow noopener" target="_blank">emadurandal/emberjs-guides-japanese-translation</a></td>
<td>Emberjs Guidesの日本語訳</td>
</tr>
<tr>
<td><a href="https://github.com/modeset/teaspoon" title="modeset/teaspoon" rel="nofollow noopener" target="_blank">modeset/teaspoon</a></td>
<td>Railsのアセットパイプラインに対応したJSのテストドライバー</td>
</tr>
<tr>
<td><a href="https://github.com/willnet/takarabako" title="willnet/takarabako" rel="nofollow noopener" target="_blank">willnet/takarabako</a></td>
<td>ゲームに使えそうなランダム名称ジェネレーター。厨二病を発揮したい時などにも</td>
</tr>
<tr>
<td><a href="https://github.com/leshill/hogan_assets" title="leshill/hogan_assets" rel="nofollow noopener" target="_blank">leshill/hogan_assets</a></td>
<td>hogan.jsを使ってmustache/hamstacheでJSTを書けるようになる</td>
</tr>
<tr>
<td><a href="https://github.com/grosser/parallel" title="grosser/parallel" rel="nofollow noopener" target="_blank">grosser/parallel</a></td>
<td>parallel_testsなんかの裏側で利用されてるgem</td>
</tr>
<tr>
<td><a href="https://github.com/srawlins/allocation_stats" title="srawlins/allocation_stats" rel="nofollow noopener" target="_blank">srawlins/allocation_stats</a></td>
<td>Ruby2.1から追加されたObjectSpaceからオブジェクトアロケーションをトレースするAPIを使い易くしてくれるgem</td>
</tr>
<tr>
<td><a href="https://github.com/kostya/eye" title="kostya/eye" rel="nofollow noopener" target="_blank">kostya/eye</a></td>
<td>プロセスを立ち上げて、状態を監視するツール。godみたいな感じ</td>
</tr>
<tr>
<td><a href="https://github.com/r7kamura/sitespec" title="r7kamura/sitespec" rel="nofollow noopener" target="_blank">r7kamura/sitespec</a></td>
<td>RackアプリケーションとRspecの定義から静的なサイトを生成してくれる</td>
</tr>
<tr>
<td><a href="https://github.com/meganemura/ruby-dmm" title="meganemura/ruby-dmm" rel="nofollow noopener" target="_blank">meganemura/ruby-dmm</a></td>
<td>RubyからDMMのAPIを叩くためのライブラリ</td>
</tr>
<tr>
<td><a href="https://github.com/mirakui/activerecord-mysql-index-hint" title="mirakui/activerecord-mysql-index-hint" rel="nofollow noopener" target="_blank">mirakui/activerecord-mysql-index-hint</a></td>
<td>ActiveRecordの発行するSQLにFORCE INDEXを追加できるようになる</td>
</tr>
<tr>
<td><a href="https://github.com/udzura/rack-spyup" title="udzura/rack-spyup" rel="nofollow noopener" target="_blank">udzura/rack-spyup</a></td>
<td>HTTPのヘッダやボディをインターセプトして表示してくれるRackミドルウェア</td>
</tr>
<tr>
<td><a href="https://github.com/json4s/json4s" title="json4s/json4s" rel="nofollow noopener" target="_blank">json4s/json4s</a></td>
<td>ScalaのJSONパーサーライブラリ</td>
</tr>
<tr>
<td><a href="https://github.com/pokonski/public_activity" title="pokonski/public_activity" rel="nofollow noopener" target="_blank">pokonski/public_activity</a></td>
<td>ユーザーの行動をActiveRecordとかMongoMapperを使ってトラッキングするgem</td>
</tr>
<tr>
<td><a href="https://github.com/lodash/lodash" title="lodash/lodash" rel="nofollow noopener" target="_blank">lodash/lodash</a></td>
<td>underscore.jsの代替ライブラリ。高速で多機能化されてる</td>
</tr>
<tr>
<td><a href="https://github.com/RailsApps/rails_layout" title="RailsApps/rails_layout" rel="nofollow noopener" target="_blank">RailsApps/rails_layout</a></td>
<td>bootstrap等のフレームワークに合わせたレイアウトテンプレートを生成してくれるジェネレーター</td>
</tr>
<tr>
<td><a href="https://github.com/ianyh/Amethyst" title="ianyh/Amethyst" rel="nofollow noopener" target="_blank">ianyh/Amethyst</a></td>
<td>Mac向けのタイル型ウインドウマネージャー</td>
</tr>
<tr>
<td><a href="https://github.com/dtao/lazy.js" title="dtao/lazy.js" rel="nofollow noopener" target="_blank">dtao/lazy.js</a></td>
<td>underscore.jsに似たライブラリだが、処理が遅延評価される</td>
</tr>
<tr>
<td><a href="https://github.com/vvo/lazyload" title="vvo/lazyload" rel="nofollow noopener" target="_blank">vvo/lazyload</a></td>
<td>JSのスタンドアローンな遅延読み込みライブラリ</td>
</tr>
<tr>
<td><a href="https://github.com/skinny-framework/skinny-framework" title="skinny-framework/skinny-framework" rel="nofollow noopener" target="_blank">skinny-framework/skinny-framework</a></td>
<td>Scalaで書かれたWebフレームワーク。Railsっぽい雰囲気がある</td>
</tr>
<tr>
<td><a href="https://github.com/polygonplanet/tombloo" title="polygonplanet/tombloo" rel="nofollow noopener" target="_blank">polygonplanet/tombloo</a></td>
<td>tombloo/tombfixで利用できる追加機能パッチがまとまっている</td>
</tr>
<tr>
<td><a href="https://github.com/idobata/hubot-idobata" title="idobata/hubot-idobata" rel="nofollow noopener" target="_blank">idobata/hubot-idobata</a></td>
<td>idobataでhubotを利用する時に</td>
</tr>
<tr>
<td><a href="https://github.com/es-shims/es5-shim" title="es-shims/es5-shim" rel="nofollow noopener" target="_blank">es-shims/es5-shim</a></td>
<td>レガシーなJSエンジンでECMA5のメソッドをエミュレートする</td>
</tr>
<tr>
<td><a href="https://github.com/moment/moment" title="moment/moment" rel="nofollow noopener" target="_blank">moment/moment</a></td>
<td>JSで時間を扱う時の便利機能をまとめたライブラリ</td>
</tr>
<tr>
<td><a href="https://github.com/sciactive/pnotify" title="sciactive/pnotify" rel="nofollow noopener" target="_blank">sciactive/pnotify</a></td>
<td>BootstrapかjQuery UIのスタイルを利用して通知を表示するjQueryプラグイン</td>
</tr>
<tr>
<td><a href="https://github.com/daiksy/dmm4s" title="daiksy/dmm4s" rel="nofollow noopener" target="_blank">daiksy/dmm4s</a></td>
<td>ScalaでDMMのAPIを叩くためのライブラリ</td>
</tr>
<tr>
<td><a href="https://github.com/scalaj/scalaj-http" title="scalaj/scalaj-http" rel="nofollow noopener" target="_blank">scalaj/scalaj-http</a></td>
<td>ScalaのシンプルなHTTPクライアントライブラリ</td>
</tr>
<tr>
<td><a href="https://github.com/dockyard/destroyed_at" title="dockyard/destroyed_at" rel="nofollow noopener" target="_blank">dockyard/destroyed_at</a></td>
<td>ActiveRecordの論理削除プラグイン</td>
</tr>
<tr>
<td><a href="https://github.com/cookpad/rrrspec" title="cookpad/rrrspec" rel="nofollow noopener" target="_blank">cookpad/rrrspec</a></td>
<td>分散RSpecを実現する</td>
</tr>
<tr>
<td><a href="https://github.com/jimbojsb/launchrocket" title="jimbojsb/launchrocket" rel="nofollow noopener" target="_blank">jimbojsb/launchrocket</a></td>
<td>homebrewで入れたソフトのplistを読んで、launchctlで起動する操作を簡単にしてくれる</td>
</tr>
<tr>
<td><a href="https://github.com/whitequark/parser" title="whitequark/parser" rel="nofollow noopener" target="_blank">whitequark/parser</a></td>
<td>Rubyのパーサー</td>
</tr>
<tr>
<td><a href="https://github.com/zimbatm/direnv" title="zimbatm/direnv" rel="nofollow noopener" target="_blank">zimbatm/direnv</a></td>
<td>ディレクトリごとに環境変数を自動でセットできるようになる。binstubsとか利用してる時に便利</td>
</tr>
<tr>
<td><a href="https://github.com/rodreegez/powder" title="rodreegez/powder" rel="nofollow noopener" target="_blank">rodreegez/powder</a></td>
<td>powで動作させるアプリケーションを簡単に追加できる</td>
</tr>
<tr>
<td><a href="https://github.com/neovim/neovim" title="neovim/neovim" rel="nofollow noopener" target="_blank">neovim/neovim</a></td>
<td>ネオなヴィム</td>
</tr>
<tr>
<td><a href="https://github.com/evrone/quiet_assets" title="evrone/quiet_assets" rel="nofollow noopener" target="_blank">evrone/quiet_assets</a></td>
<td>アセットパイプラインに対するアクセスログを黙らせる</td>
</tr>
<tr>
<td><a href="https://github.com/Mange/roadie" title="Mange/roadie" rel="nofollow noopener" target="_blank">Mange/roadie</a></td>
<td>RailsからHTMLメールを送る時に役立つ便利機能を提供するgem</td>
</tr>
<tr>
<td><a href="https://github.com/smartinez87/exception_notification" title="smartinez87/exception_notification" rel="nofollow noopener" target="_blank">smartinez87/exception_notification</a></td>
<td>Rails/Rackアプリで例外が発生した時に、色々な方法で通知を投げるgem</td>
</tr>
<tr>
<td><a href="https://github.com/sevenwire/forgery" title="sevenwire/forgery" rel="nofollow noopener" target="_blank">sevenwire/forgery</a></td>
<td>ランダムデータジェネレーター。あんまりちゃんとメンテしてないから気を付けろ、らしい</td>
</tr>
<tr>
<td><a href="https://github.com/netzpirat/haml_coffee_assets" title="netzpirat/haml_coffee_assets" rel="nofollow noopener" target="_blank">netzpirat/haml_coffee_assets</a></td>
<td>hamlとcoffeeでJSTを記述できるgem</td>
</tr>
<tr>
<td><a href="https://github.com/chjj/marked" title="chjj/marked" rel="nofollow noopener" target="_blank">chjj/marked</a></td>
<td>JSのmarkdownパーサー/コンパイラー</td>
</tr>
<tr>
<td><a href="https://github.com/uglide/RedisDesktopManager" title="uglide/RedisDesktopManager" rel="nofollow noopener" target="_blank">uglide/RedisDesktopManager</a></td>
<td>Qt5で書かれたRedisのGUI管理ツール</td>
</tr>
<tr>
<td><a href="https://github.com/cookpad/styleguide" title="cookpad/styleguide" rel="nofollow noopener" target="_blank">cookpad/styleguide</a></td>
<td>クッ社のコーディング規約</td>
</tr>
<tr>
<td><a href="https://github.com/errbit/errbit" title="errbit/errbit" rel="nofollow noopener" target="_blank">errbit/errbit</a></td>
<td>Airbrakeコンパチのエラー管理ツール</td>
</tr>
<tr>
<td><a href="https://github.com/jpillora/notifyjs" title="jpillora/notifyjs" rel="nofollow noopener" target="_blank">jpillora/notifyjs</a></td>
<td>JSの通知ライブラリ。ボタンの横にちょこっと出したりする時に使えそう</td>
</tr>
<tr>
<td><a href="https://github.com/wavded/humane-js" title="wavded/humane-js" rel="nofollow noopener" target="_blank">wavded/humane-js</a></td>
<td>JSの通知ライブラリ。でかめの通知が出せる</td>
</tr>
<tr>
<td><a href="https://github.com/joeferner/redis-commander" title="joeferner/redis-commander" rel="nofollow noopener" target="_blank">joeferner/redis-commander</a></td>
<td>node.js製のRedis管理ツール。Webから操作するタイプ</td>
</tr>
<tr>
<td><a href="https://github.com/BBC-News/wraith" title="BBC-News/wraith" rel="nofollow noopener" target="_blank">BBC-News/wraith</a></td>
<td>PhantomJSを使ってWebサイトのスクリーンショットを取り、比較して差分を検出するツール。PhantomCSSみたいな感じ</td>
</tr>
<tr>
<td><a href="https://github.com/bblimke/webmock" title="bblimke/webmock" rel="nofollow noopener" target="_blank">bblimke/webmock</a></td>
<td>Rubyから外部のネットワークにHTTPでアクセスする処理をモックしてテストできるようにしてくれる</td>
</tr>
<tr>
<td><a href="https://github.com/vcr/vcr" title="vcr/vcr" rel="nofollow noopener" target="_blank">vcr/vcr</a></td>
<td>実際に一度外部にアクセスしたレスポンスを記録しておき、モックのレスポンスとしてそれを返すことができる。webmockと組み合わせると便利</td>
</tr>
<tr>
<td><a href="https://github.com/resque/redis-namespace" title="resque/redis-namespace" rel="nofollow noopener" target="_blank">resque/redis-namespace</a></td>
<td>Redisにアクセスする時にnamespaceを作ってくれる</td>
</tr>
<tr>
<td><a href="https://github.com/karmi/retire" title="karmi/retire" rel="nofollow noopener" target="_blank">karmi/retire</a></td>
<td>ElasticSearchにRubyからアクセスするためのAPIとDSLを提供する</td>
</tr>
<tr>
<td><a href="https://github.com/ankane/searchkick" title="ankane/searchkick" rel="nofollow noopener" target="_blank">ankane/searchkick</a></td>
<td>同上。ActiveRecordに対応してる</td>
</tr>
<tr>
<td><a href="https://github.com/sunspot/sunspot" title="sunspot/sunspot" rel="nofollow noopener" target="_blank">sunspot/sunspot</a></td>
<td>Apache SolrにRubyからアクセスするためのDSLを提供する</td>
</tr>
<tr>
<td><a href="https://github.com/CanCanCommunity/cancancan" title="CanCanCommunity/cancancan" rel="nofollow noopener" target="_blank">CanCanCommunity/cancancan</a></td>
<td>CanCanの後継として開発されてる権限管理のgem</td>
</tr>
<tr>
<td><a href="https://github.com/seejohnrun/ice_cube" title="seejohnrun/ice_cube" rel="nofollow noopener" target="_blank">seejohnrun/ice_cube</a></td>
<td>Rubyで繰り返し日付を表現するライブラリ</td>
</tr>
<tr>
<td><a href="https://github.com/hpoydar/chronic_duration" title="hpoydar/chronic_duration" rel="nofollow noopener" target="_blank">hpoydar/chronic_duration</a></td>
<td>自然言語とか1:01:02とかを時間の長さとしてパースして数値として返したり、逆に自然言語っぽく表示したりできる(でも英語</td>
</tr>
<tr>
<td><a href="https://github.com/julianlloyd/scrollReveal.js" title="julianlloyd/scrollReveal.js" rel="nofollow noopener" target="_blank">julianlloyd/scrollReveal.js</a></td>
<td>なんか妙にかっちょいい感じでWebページの要素を表示できるライブラリ。でもこんなお洒落なサイトに縁が無い</td>
</tr>
<tr>
<td><a href="https://github.com/thoughtbot/formulaic" title="thoughtbot/formulaic" rel="nofollow noopener" target="_blank">thoughtbot/formulaic</a></td>
<td>capybaraでRailsのフォームビルダーで描画したフォームに値を入れるのを楽にしてくれるヘルパーメソッドを追加する</td>
</tr>
<tr>
<td><a href="https://github.com/peter-murach/finite_machine" title="peter-murach/finite_machine" rel="nofollow noopener" target="_blank">peter-murach/finite_machine</a></td>
<td>Rubyのミニマルなステートマシーンライブラリ。この手のタイプ色々あるんだけど、あんまり上手くハマった経験が無い</td>
</tr>
<tr>
<td><a href="https://github.com/toptal/chewy" title="toptal/chewy" rel="nofollow noopener" target="_blank">toptal/chewy</a></td>
<td>RubyのElasticSearchクライアント。まだElasticSearch使ったことないからどれが良いかは分からない</td>
</tr>
<tr>
<td><a href="https://github.com/nulldb/nulldb" title="nulldb/nulldb" rel="nofollow noopener" target="_blank">nulldb/nulldb</a></td>
<td>実際にはDBに接続しないActiveRecordのDBアダプター。テストで上手く活用できると、IO発生しなくなるからすげー早くなるらしい</td>
</tr>
<tr>
<td><a href="https://github.com/defunkt/fakefs" title="defunkt/fakefs" rel="nofollow noopener" target="_blank">defunkt/fakefs</a></td>
<td>ファイルシステムを操作する処理をテストするためにフェイクのファイルシステムを提供する。レポートを出力するようなgemのテストコード書く時に便利そう</td>
</tr>
<tr>
<td><a href="https://github.com/thoughtbot/bourbon" title="thoughtbot/bourbon" rel="nofollow noopener" target="_blank">thoughtbot/bourbon</a></td>
<td>シンプルなSassのmixin集。compassの軽量版みたいな感じだと思う</td>
</tr>
<tr>
<td><a href="https://github.com/bwillis/versioncake" title="bwillis/versioncake" rel="nofollow noopener" target="_blank">bwillis/versioncake</a></td>
<td>APIのバージョニングをjbuilderのテンプレートを分けることで実現するgem</td>
</tr>
<tr>
<td><a href="https://github.com/avdi/naught" title="avdi/naught" rel="nofollow noopener" target="_blank">avdi/naught</a></td>
<td>RubyでNull Objectパターンを書くのを支援してくれるgem</td>
</tr>
<tr>
<td><a href="https://github.com/sdsykes/fastimage" title="sdsykes/fastimage" rel="nofollow noopener" target="_blank">sdsykes/fastimage</a></td>
<td>URLやファイルパスを渡して、画像のサイズやフォーマットを取得できるgem</td>
</tr>
<tr>
<td><a href="https://github.com/metricfu/metric_fu" title="metricfu/metric_fu" rel="nofollow noopener" target="_blank">metricfu/metric_fu</a></td>
<td>Rubyの静的解析ツールがまとまったもの。Ruby2.1でも結構使える</td>
</tr>
</tbody>
</table>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>397</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/2c277cca5bd50e4cce5e">Railsと周辺のTimeZone設定を整理する (active_record.default_timezoneの罠)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-05 13:56:38</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今更感があるというか、自分も分かってるつもりでRails以外でも触るMySQL DBの扱いで少し困ったので再整理しておく。<br>
ちなみにバージョンは以下の場合である。</p>

<ul>
<li>Rails 4以降</li>
<li>MySQL 5.1以降</li>
</ul>

<p>RailsにおけるTimeZone関連の設定は以下のとおり。</p>

<ul>
<li>config.time_zone (各地の都市名等を指定する)</li>
<li>config.active_record.default_timezone (:utc or :local)</li>
</ul>

<p>考えなければいけない時間は概ね以下のとおり。</p>

<ul>
<li>システムのタイムゾーンと、システム時間</li>
<li>Railsのタイムゾーンと、Time.nowとTime.zone.now(Time.current)</li>
<li>データベースのタイムゾーンとデータベースに記録されている時間。</li>
</ul>

<p>おさらい、Time.zone.nowはActiveSupport::TimeWithZoneクラスのインスタンス。ActiveRecordでdatetime型のカラムにアクセスした場合もこれになる。</p>

<p>ActiveRecordのdefault_timezoneのデフォルト値は:utc。</p>

<p>既に良く分からなくなってきた……。</p>

<p>ややこしいので、とりあえずデータベースは自分が良く使っているMySQLのみを考える。基本的にはMySQLに関する話だと思って欲しい。</p>

<h2>
<span id="時間の対応関係" class="fragment"></span><a href="#%E6%99%82%E9%96%93%E3%81%AE%E5%AF%BE%E5%BF%9C%E9%96%A2%E4%BF%82"><i class="fa fa-link"></i></a>時間の対応関係</h2>

<p>JSTは<code>+9:00</code>、CSTは<code>-6:00</code></p>

<table>
<thead>
<tr>
<th>概要</th>
<th>System TZ</th>
<th>System Time</th>
<th>Rails TZ</th>
<th>ActiveRecord TZ</th>
<th>Time.now</th>
<th>Time.current</th>
<th>DB TZ</th>
<th>DB Time</th>
<th>AR Instance Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>何も考えずにRailsを使う場合のデフォルト</td>
<td>JST</td>
<td>2:00</td>
<td>UTC</td>
<td>:utc</td>
<td>2:00 JST</td>
<td>17:00 UTC (TWZ)</td>
<td>SYSTEM(JST)</td>
<td>17:00</td>
<td>17:00 UTC (TWZ)</td>
</tr>
<tr>
<td>time_zone Tokyo</td>
<td>JST</td>
<td>2:00</td>
<td>Tokyo(JST)</td>
<td>:utc</td>
<td>2:00 JST</td>
<td>2:00 JST (TWZ)</td>
<td>SYSTEM(JST)</td>
<td>17:00</td>
<td>2:00 JST (TWZ)</td>
</tr>
<tr>
<td>active_record.default_timezone :local</td>
<td>JST</td>
<td>2:00</td>
<td>Tokyo(JST)</td>
<td>:local</td>
<td>2:00 JST</td>
<td>2:00 JST (TWZ)</td>
<td>SYSTEM(JST)</td>
<td>2:00</td>
<td>2:00 JST (TWZ)</td>
</tr>
<tr>
<td>time_zone なし, active_record.default_timezone :local</td>
<td>JST</td>
<td>2:00</td>
<td>UTC</td>
<td>:local</td>
<td>2:00 JST</td>
<td>17:00 UTC (TWZ)</td>
<td>SYSTEM(JST)</td>
<td>2:00</td>
<td>17:00 UTC (TWZ)</td>
</tr>
<tr>
<td>time_zone Central Time</td>
<td>JST</td>
<td>2:00</td>
<td>CST</td>
<td>:utc</td>
<td>2:00 JST</td>
<td>11:00 CST (TWZ)</td>
<td>SYSTEM(JST)</td>
<td>17:00</td>
<td>11:00 CST (TWZ)</td>
</tr>
<tr>
<td>time_zone Central Time, active_record.default_timezone :local</td>
<td>JST</td>
<td>2:00</td>
<td>CST</td>
<td>:local</td>
<td>2:00 JST</td>
<td>11:00 CST (TWZ)</td>
<td>SYSTEM(JST)</td>
<td>2:00</td>
<td>11:00 CST (TWZ)</td>
</tr>
</tbody>
</table>

<h2>
<span id="整理" class="fragment"></span><a href="#%E6%95%B4%E7%90%86"><i class="fa fa-link"></i></a>整理</h2>

<p>まず、ここまでで一旦整理する。</p>

<p>Time.nowはRubyの組み込みなのでシステムのタイムゾーンしか見ない。OSの時間と常に一致する。Time.localの出力結果もOSのタイムゾーンと一致する。</p>

<p>TimeWithZoneクラスは<code>config.time_zone</code>に左右される。<br>
Ruby組み込みのメソッドで取得したUTCの時間を基準に、設定されているタイムゾーンの時間に変換する。<br>
ActiveRecordのインスタンスに対してアクセサを利用して時間をやり取りする場合はTimeWithZoneで行われる。<br>
仮にTimeクラスを渡しても代入時にTimeWithZoneに変換される。</p>

<p><code>config.active_record.default_timezone</code>の設定はDBを読み書きする際に、DBに記録されている時間を<code>Time.utc</code>で読むか<code>Time.local</code>で読むかを設定する。<br>
<code>:utc</code>の場合DBに記録されている時間はUTC扱いで、この時DBサーバのタイムゾーン設定は考慮しない。<br>
ActiveRecordのインスタンスが持っているTimeWithZoneの値をUTCに変換し、その時刻をDBに書き込む。<br>
<code>:local</code>の場合は、DBに記録されている時間はシステムのタイムゾーンとして扱う。<br>
ActiveRecordのインスタンスが持っているTimeWithZoneの値をシステムのタイムゾーンに変換し、その時刻をDBに書き込む。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p><code>config.time_zone</code>は、Railsのアプリケーション上で表示したい時間の基準となるタイムゾーンでOSとは独立している。しかし基本的にはOSのタイムゾーンと合わせておくのが安全だと思う。<br>
もし、マシンが海外にあってOSの時計はUTCだが、メインターゲットが日本だったりする場合は、日本のタイムゾーンにしたくなるかもしれない。<br>
そうすると、ActiveRecordやActiveSupportに関する時間は、デフォルトで日本時間で表示される。<br>
しかし、Time.now等を混在させると<code>strftime</code>等で整形した場合に時間がズレてしまう。<br>
徹底してTimeWithZoneを使うなら大丈夫かもしれないが、OSのタイムゾーンに合わせておいて、適宜タイムゾーンを変換する方が分かりやすいように思う。<br>
まあ、シリコンバレーに行って、特定の国向けのサービスを作るとかでない限りは、あんまり考えることは無いかもしれない。</p>

<p><code>config.active_record.default_timezone</code>は、DBのタイムゾーンと一致させておくべきだ。<br>
DBのタイムゾーンがUTCなら<code>:utc</code>にDBのタイムゾーンがSYSTEMなら<code>:local</code>にしておく。</p>

<h2>
<span id="問題点" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E7%82%B9"><i class="fa fa-link"></i></a>問題点</h2>

<p>表を見れば分かるのだが、初っ端のデフォルトからDBに記録される値がズレている。<br>
これは、普通日本で使うマシンの時計はJSTで、MySQLのタイムゾーンのデフォルトがSYSTEMでJSTになるからだ。<br>
しかも、MySQLのDATETIME型はタイムゾーン情報を持てないし、ActiveRecordはMySQLのタイムゾーン設定を考慮しない。<br>
そのため、UTCじゃないマシンで何も考えずにデフォルトの設定でRailsを利用するとDBに記録される時間がズレることになる。<br>
JSTになっているDBのタイムゾーンに合わせて正しい時間で書き込むためには、<code>config.active_record.default_timezone</code>を<code>:local</code>にしておく必要がある。</p>

<p>しかし、残念なことに<code>config.active_record.default_timezone</code>の設定はかなり地味だったりする。<br>
デフォルトで生成されるコンフィグファイルの雛形には影も形も出てこない。<br>
Rails Guidesにはちゃんと説明があるのだが、ちゃんと読んでないと知らないままだったりする。<br>
自分も知ってはいたものの、設定するの忘れてたり、どっちが正しかったんだっけ？となることがしばしばある。<br>
これは、Railsから出ない限りは余り問題にならないから、なおのこと気付きにくい。</p>

<p>なので、これが<code>:utc</code>でMySQLがSYSTEMになったまま運用されているRailsアプリが一杯あると思う。<br>
Railsから出ないでDBに触っていればOKなのだが、Rails外で時間を触るとこれはバグの温床になる。</p>

<p>まず、MySQLの内部で時間を取得する場合。例えばMySQLの<code>NOW()</code>関数を使うとOSの時間と一緒の時間が取れるのだが、カラムに記録されている時間は9時間前の時間になっている。もしこの値を使おうとすると時間が噛み合わなくなる。しかも、MySQLが取得する時間そのものにはタイムゾーン情報は無い。なので、これを使って比較すると日付の境目当たりでバグって死ぬことが良くある。<br>
RailsでTime.currentを取得して、ActiveRecordのクエリ経由で時間を渡せばちゃんと変換されてクエリに渡るので、正しく比較できる。</p>

<p>更に、MySQLのタイムゾーンを考慮する別システムからDBにアクセスする場合。特にJDBCからMySQLに接続する場合等、オプションがカオスで訳が分からないことになっていて、デフォルトでどういう挙動をするか良く分からない。もしMySQLサーバのタイムゾーンを考慮して時間を変換してクエリを実行する動作をする場合、やはり記録されている時間から9時間ズレてしまう。</p>

<p>というわけで、新しくRailsのシステムを開発する場合は、DBのタイムゾーン設定と<code>config.active_record.default_timezone</code>を合わせるように注意した方が良い。<br>
もし、その設定に気付かず(忘れて)運用を開始してしまった場合は、MySQLのタイムゾーンの設定をUTCにした方が良いかもしれない。<br>
他のシステムで触っていなければ、これでカラムの値とタイムゾーンが一致する。</p>

<p>しかし、ここにもまだ問題があって、もしTIMESTAMP型が混在してたらタイムゾーンを変えると困ったことになる。<br>
TIMESTAMP型は書き込む時にサーバのタイムゾーン設定を確認してUTCに変換してからデータを保存する。取得する時はUTCからサーバのタイムゾーンに変換してから表示する。<br>
なので、記録時と異なるタイムゾーンに変更すると取得した時の時間がズレてしまう。<br>
(ALTER TABLEで型を変えたらどうなるかまでは調べてません……。)</p>

<p>既に時間がごっちゃに記録されていたら、まあ諦めてどっちかに合わせるしか無いかな……。</p>

<p>そもそも、こんなことで色々悩むのも、Railsのデフォルト設定値とMySQLのデフォルト設定値が噛み合ってない上にMySQLの時間カラムはタイムゾーン情報持ってないし、RailsはMySQLのタイムゾーンを無視するし、JDBCはタイムゾーン考慮して勝手に時間変換するしで、何が何の設定で何から何に時間を変換してるのかがさっぱり分からんからだ。<br>
もう時差とかタイムゾーンの無い世界に行きたい……。</p>

<p>Postgresとかはカラム自体にタイムゾーン込みでデータ保持できるのかな。とすると、MySQLが無駄にややこしいだけ、という話にもなるが……。orz</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>269</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/9c114a37560d6a29fe81">Rubyのコードを読むのが捗る技 (Vim)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-18 14:11:49</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rubyでソースコードを読む時の小技について書いてみようと思う。</p>

<p>この投稿も参考になる。<br>
Rubyでメソッドの定義場所を見つける方法 #Ruby - Qiita <a href="http://qiita.com/items/fc8a61b421d026a23ffe" class="autolink">http://qiita.com/items/fc8a61b421d026a23ffe</a></p>

<p>ちなみに、私はVimmerなので、Vimに寄った話です。<br>
emacsについては身近にemacsユーザーに聞きましょう。</p>

<h2>
<span id="ctagsを活用する" class="fragment"></span><a href="#ctags%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ctagsを活用する</h2>

<p>ctagsでtagsファイルを出力しておけば、メソッドの定義元に飛ぶのが非常に楽になります。<br>
Railsで開発しているなら、Railsのプロジェクトルートで以下のようなコマンドを打ちます。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>ctags --langmap<span class="o">=</span>RUBY:.rb --exclude<span class="o">=</span><span class="s2">"*.js"</span>  --exclude<span class="o">=</span><span class="s2">".git*"</span> -R .
</pre></div></div>

<p>(bundlerでプロジェクト内にGemがある場合を想定)</p>

<p>langmapとかは別に無くても大丈夫だと思いますが。<br>
--excludeを付けずにctagsを実行するとjavascriptのライブラリもタグ付けされて、<br>
ノイズが多くなるので除外しておきます。</p>

<p>VimでRubyのコードを開きます。<br>
この時、カレントディレクトリはtagsのあるディレクトリに揃えておきます。</p>

<p>定義元を知りたいメソッドにカーソルを合わせて、<code>&lt;CTRL-]&gt;</code>をタイプすると、<br>
定義元にジャンプできます。<br>
戻りたい時は、<code>&lt;CTRL-T&gt;</code>をタイプします。スタックを辿って戻っていけます。</p>

<p>マッチ対象が複数ある場合は、最初にヒットした箇所へ飛ぶので、<br>
選択して飛び先を決定したい場合は、tjumpコマンドを使います。<br>
CTRL-Tで飛んでから場所が違うなと思ったら、そのままtjumpコマンドで、<br>
今飛んできたタグで飛べるリストが出てきます。</p>

<p>また、unite-tagを使うことで、uniteのインターフェースからtagsを検索できます。<br>
ただし、最初に検索する時にtagsを読み込んでキャッシュするため、<br>
tagsのファイルサイズが大きいと初回の読み込みにかなり時間がかかります。</p>

<h2>
<span id="vim-refを活用する" class="fragment"></span><a href="#vim-ref%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>vim-refを活用する</h2>

<p>vim-refというvimでリファレンスマニュアルを参照するためのプラグインがあります。<br>
vim-refには、デフォルトでrefeを見るための定義があるのですが、<br>
refeを入れてPATH通すのが若干面倒なので、最近はmyruremaを使ってます。<br>
ただ、myruremaはrefeと出力が一緒なので、実はvim-refで普通に使うことができます。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" ref.vim</span>
<span class="k">let</span> <span class="k">g</span>:ref_open <span class="p">=</span> <span class="s1">'vsplit'</span>
<span class="k">let</span> <span class="k">g</span>:ref_refe_cmd <span class="p">=</span> <span class="s2">"rurema"</span>
<span class="k">let</span> <span class="k">g</span>:ref_refe_version <span class="p">=</span> <span class="m">2</span>

<span class="nb">nnoremap</span> <span class="p">,</span>rr :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>Ref refe<span class="p">&lt;</span>Space<span class="p">&gt;</span>
</pre></div></div>

<p>こんな感じで設定しておけば、Rubyのリファレンスをvimからすぐに確認できます。<br>
しばしば出力の形式の問題か、上手く表示できないメソッドがあったりしますが。</p>

<p>vim-refの画面では、Enterで関連するrefにジャンプしたり、<br>
CTRL-Tで前のrefに戻ったりすることが可能です。</p>

<p>また、uniteのソースにも対応しているので、uniteインターフェースからクラス名を検索して、<br>
メソッドの一覧を出したりできます。</p>

<p>vim-ref-riというプラグインもあり、インストールされているriドキュメントをvimから検索して読むことができます。<br>
ref-refeよりもこっちの方がいいかもしれません。こちらもuniteに対応してます。</p>

<h2>
<span id="pryやdebuggerを活用する" class="fragment"></span><a href="#pry%E3%82%84debugger%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>pryやdebuggerを活用する</h2>

<p>ctags等で定義元のgemを調べている時に動作がいまいち良く分からんということがあれば、<br>
gemを直接いじって確認用のコードを埋めこんでしまいます。<br>
<code>pry</code>の<code>binding.pry</code>メソッドや<code>ruby-debug</code>の<code>debugger</code>メソッド、後は<code>tapp</code>や<code>awesome_print</code>等のgemが便利です。<br>
変に触って戻せなくなっても、bundlerなら入れ直すのは簡単ですし、<br>
システムに入ってるgemも、<code>gem pristine</code>というコマンドでレストアできます。<br>
なので、調査中のgemはガンガンいじっても大丈夫です。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>taka84u9/vim-ref-ri <a href="https://github.com/taka84u9/vim-ref-ri" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/taka84u9/vim-ref-ri</a><br>
thinca/vim-ref <a href="https://github.com/thinca/vim-ref" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/thinca/vim-ref</a><br>
tsukkee/unite-tag <a href="https://github.com/tsukkee/unite-tag" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/tsukkee/unite-tag</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />5位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>233</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/9dc7f2a92cfb245ad502">Rubyist向けのvimrcを晒す</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-18 00:31:53</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>最近、vimの設定をやり直すスイッチが入って大分更新されたので改めて久々にvimrcを晒す。<br>
ファイル自体は<a href="https://github.com/joker1007/dotfiles" title="joker1007/dotfiles" rel="nofollow noopener" target="_blank">joker1007/dotfiles</a>にある。</p>

<p>もし参考にされる方が居たら、丸々コピーすると色々問題あるかもしれないんで、適当に一部を抜粋するのが良いと思います。<br>
特にキーマッピングは慣れがあるので、自分で決めた方が良いです。</p>

<p>実際には必要無いけど、環境に依って使うかもしれない設定とか混じってます。</p>

<p>文字コード周りは正直微妙。もうちょっと良い設定があったら知りたい。</p>

<p>macvim-kaoriya向けのlibrubyのローディングはファイル名調整しないと駄目かも。<br>
最近は自分でコンパイルオプション弄ってrbenvで入れたrubyとリンクさせてるので、自分自身は使っていない設定。</p>

<p>vimrcの下にsnippet定義も書いてあります。</p>

<h2>
<span id="vimrc" class="fragment"></span><a href="#vimrc"><i class="fa fa-link"></i></a>vimrc</h2>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">vimrc</span></div>
<div class="highlight"><pre><span></span><span class="k">set</span> <span class="nb">nocompatible</span>

<span class="c">" 文字コード, 改行コード {{{</span>
<span class="k">set</span> <span class="nb">encoding</span><span class="p">=</span>utf<span class="m">-8</span>
<span class="k">set</span> <span class="nb">fileencodings</span><span class="p">=</span>ucs_bom<span class="p">,</span>utf8<span class="p">,</span>ucs<span class="m">-2</span>le<span class="p">,</span>ucs<span class="m">-2</span>
<span class="k">set</span> <span class="nb">fileformats</span><span class="p">=</span>unix<span class="p">,</span>dos<span class="p">,</span>mac

<span class="c">" from ずんWiki http://www.kawaz.jp/pukiwiki/?vim#content_1_7</span>
<span class="c">" 文字コードの自動認識</span>
<span class="k">if</span> &amp;<span class="nb">encoding</span> <span class="p">!=</span># <span class="s1">'utf-8'</span>
  <span class="k">set</span> <span class="nb">encoding</span><span class="p">=</span>japan
  <span class="k">set</span> <span class="nb">fileencoding</span><span class="p">=</span>japan
<span class="k">endif</span>
<span class="k">if</span> has<span class="p">(</span><span class="s1">'iconv'</span><span class="p">)</span>
  <span class="k">let</span> s:enc_euc <span class="p">=</span> <span class="s1">'euc-jp'</span>
  <span class="k">let</span> s:enc_jis <span class="p">=</span> <span class="s1">'iso-2022-jp'</span>
<span class="c">  " iconvがeucJP-msに対応しているかをチェック</span>
  <span class="k">if</span> iconv<span class="p">(</span><span class="s2">"\x87\x64\x87\x6a"</span><span class="p">,</span> <span class="s1">'cp932'</span><span class="p">,</span> <span class="s1">'eucjp-ms'</span><span class="p">)</span> <span class="p">==</span># <span class="s2">"\xad\xc5\xad\xcb"</span>
    <span class="k">let</span> s:enc_euc <span class="p">=</span> <span class="s1">'eucjp-ms'</span>
    <span class="k">let</span> s:enc_jis <span class="p">=</span> <span class="s1">'iso-2022-jp-3'</span>
<span class="c">  " iconvがJISX0213に対応しているかをチェック</span>
  <span class="k">elseif</span> iconv<span class="p">(</span><span class="s2">"\x87\x64\x87\x6a"</span><span class="p">,</span> <span class="s1">'cp932'</span><span class="p">,</span> <span class="s1">'euc-jisx0213'</span><span class="p">)</span> <span class="p">==</span># <span class="s2">"\xad\xc5\xad\xcb"</span>
    <span class="k">let</span> s:enc_euc <span class="p">=</span> <span class="s1">'euc-jisx0213'</span>
    <span class="k">let</span> s:enc_jis <span class="p">=</span> <span class="s1">'iso-2022-jp-3'</span>
  <span class="k">endif</span>
<span class="c">  " fileencodingsを構築</span>
  <span class="k">if</span> &amp;<span class="nb">encoding</span> <span class="p">==</span># <span class="s1">'utf-8'</span>
    <span class="k">let</span> s:fileencodings_default <span class="p">=</span> &amp;<span class="nb">fileencodings</span>
    <span class="k">let</span> &amp;<span class="nb">fileencodings</span> <span class="p">=</span> s:enc_jis .<span class="s1">','</span>. s:enc_euc .<span class="s1">',cp932'</span>
    <span class="k">let</span> &amp;<span class="nb">fileencodings</span> <span class="p">=</span> s:fileencodings_default .<span class="s1">','</span>. &amp;<span class="nb">fileencodings</span>
    unlet s:fileencodings_default
  <span class="k">else</span>
    <span class="k">let</span> &amp;<span class="nb">fileencodings</span> <span class="p">=</span> &amp;<span class="nb">fileencodings</span> .<span class="s1">','</span>. s:enc_jis
    <span class="k">set</span> <span class="nb">fileencodings</span><span class="p">+=</span>utf<span class="m">-8</span><span class="p">,</span>ucs<span class="m">-2</span>le<span class="p">,</span>ucs<span class="m">-2</span>
    <span class="k">if</span> &amp;<span class="nb">encoding</span> <span class="p">=~</span># <span class="s1">'^\(euc-jp\|euc-jisx0213\|eucjp-ms\)$'</span>
      <span class="k">set</span> <span class="nb">fileencodings</span><span class="p">+=</span>cp932
      <span class="k">set</span> <span class="nb">fileencodings</span><span class="p">-=</span>euc<span class="p">-</span>jp
      <span class="k">set</span> <span class="nb">fileencodings</span><span class="p">-=</span>euc<span class="p">-</span>jisx0213
      <span class="k">set</span> <span class="nb">fileencodings</span><span class="p">-=</span>eucjp<span class="p">-</span>ms
      <span class="k">let</span> &amp;<span class="nb">encoding</span> <span class="p">=</span> s:enc_euc
      <span class="k">let</span> &amp;<span class="nb">fileencoding</span> <span class="p">=</span> s:enc_euc
    <span class="k">else</span>
      <span class="k">let</span> &amp;<span class="nb">fileencodings</span> <span class="p">=</span> &amp;<span class="nb">fileencodings</span> .<span class="s1">','</span>. s:enc_euc
    <span class="k">endif</span>
  <span class="k">endif</span>
<span class="c">  " 定数を処分</span>
  unlet s:enc_euc
  unlet s:enc_jis
<span class="k">endif</span>
<span class="c">" }}}</span>

<span class="k">if</span> has<span class="p">(</span><span class="s1">'vim_starting'</span><span class="p">)</span>
  <span class="k">set</span> <span class="nb">runtimepath</span><span class="p">+=~</span><span class="sr">/.vim/</span>bundle<span class="sr">/neobundle.vim/</span>
<span class="k">endif</span>

<span class="k">call</span> neobundle#rc<span class="p">(</span>expand<span class="p">(</span><span class="s1">'~/.vim/bundle/'</span><span class="p">))</span>

<span class="c">" NeoBundle {{{</span>
<span class="c">" Let NeoBundle manage NeoBundle</span>
NeoBundleFetch <span class="s1">'Shougo/neobundle.vim'</span>

NeoBundle <span class="s1">'Shougo/vimproc'</span><span class="p">,</span> {
  \ <span class="s1">'build'</span> : {
  \     <span class="s1">'windows'</span> : <span class="s1">'make -f make_mingw32.mak'</span><span class="p">,</span>
  \     <span class="s1">'cygwin'</span> : <span class="s1">'make -f make_cygwin.mak'</span><span class="p">,</span>
  \     <span class="s1">'mac'</span> : <span class="s1">'make -f make_mac.mak'</span><span class="p">,</span>
  \     <span class="s1">'unix'</span> : <span class="s1">'make -f make_unix.mak'</span><span class="p">,</span>
  \    }<span class="p">,</span>
  \ }
NeoBundle <span class="s1">'tyru/eskk.vim'</span>
NeoBundle <span class="s1">'tyru/skkdict.vim'</span>

<span class="c">" colorschemes</span>
NeoBundle <span class="s1">'altercation/vim-colors-solarized'</span>
NeoBundle <span class="s1">'baskerville/bubblegum'</span>
NeoBundle <span class="s1">'nanotech/jellybeans.vim'</span>
NeoBundle <span class="s1">'w0ng/vim-hybrid'</span>
NeoBundle <span class="s1">'vim-scripts/twilight'</span>
NeoBundle <span class="s1">'jonathanfilip/vim-lucius'</span>
NeoBundle <span class="s1">'jpo/vim-railscasts-theme'</span>

NeoBundle <span class="s1">'tpope/vim-rails'</span>
NeoBundle <span class="s1">'vim-ruby/vim-ruby'</span>
NeoBundle <span class="s1">'tpope/vim-cucumber'</span>
NeoBundle <span class="s1">'thinca/vim-quickrun'</span>
NeoBundle <span class="s1">'scrooloose/nerdcommenter'</span>

NeoBundle <span class="s1">'thinca/vim-ref'</span>
NeoBundle <span class="s1">'taka84u9/vim-ref-ri'</span>
NeoBundle <span class="s1">'ujihisa/ref-hoogle'</span>

NeoBundle <span class="s1">'vim-scripts/surround.vim'</span>
NeoBundle <span class="s1">'vim-scripts/L9'</span>
NeoBundle <span class="s1">'vim-scripts/YankRing.vim'</span>
NeoBundle <span class="s1">'vim-scripts/grep.vim'</span>
NeoBundle <span class="s1">'vim-scripts/sudo.vim'</span>
NeoBundle <span class="s1">'vim-scripts/errormarker.vim'</span>
NeoBundle <span class="s1">'vim-scripts/AnsiEsc.vim'</span>

NeoBundle <span class="s1">'kana/vim-smartchr'</span>
NeoBundle <span class="s1">'kana/vim-textobj-user'</span>
NeoBundle <span class="s1">'nelstrom/vim-textobj-rubyblock'</span>
NeoBundle <span class="s1">'motemen/hatena-vim'</span>
NeoBundle <span class="s1">'kchmck/vim-coffee-script'</span>
NeoBundle <span class="s1">'carlosvillu/coffeScript-VIM-Snippets'</span>

NeoBundle <span class="s1">'mattn/emmet-vim'</span>
NeoBundle <span class="s1">'claco/jasmine.vim'</span>
NeoBundle <span class="s1">'digitaltoad/vim-jade'</span>
NeoBundle <span class="s1">'tpope/vim-haml'</span>
NeoBundle <span class="s1">'nono/vim-handlebars'</span>
NeoBundle <span class="s1">'juvenn/mustache.vim'</span>

NeoBundle <span class="s1">'nathanaelkane/vim-indent-guides'</span>
NeoBundle <span class="s1">'kana/vim-submode'</span>
NeoBundle <span class="s1">'thinca/vim-poslist'</span>
NeoBundle <span class="s1">'thinca/vim-visualstar'</span>
NeoBundle <span class="s1">'Lokaltog/vim-easymotion'</span>
NeoBundle <span class="s1">'taku-o/vim-toggle'</span>
NeoBundle <span class="s1">'majutsushi/tagbar'</span>
NeoBundle <span class="s1">'thinca/vim-qfreplace'</span>
NeoBundle <span class="s1">'mattn/webapi-vim'</span>

NeoBundle <span class="s1">'eagletmt/ghcmod-vim'</span>
NeoBundle <span class="s1">'ujihisa/neco-ghc'</span>
NeoBundle <span class="s1">'dag/vim2hs'</span>
NeoBundle <span class="s1">'pbrisbin/html-template-syntax'</span>

NeoBundle <span class="s1">'tyru/open-browser.vim'</span>
NeoBundle <span class="s1">'kana/vim-textobj-indent'</span>
NeoBundle <span class="s1">'godlygeek/tabular'</span>
NeoBundle <span class="s1">'scrooloose/syntastic'</span>
NeoBundle <span class="s1">'rking/ag.vim'</span>
NeoBundle <span class="s1">'moro/vim-review'</span>
NeoBundle <span class="s1">'bling/vim-airline'</span>
NeoBundle <span class="s1">'basyura/bitly.vim'</span>
NeoBundle <span class="s1">'mattn/favstar-vim'</span>
NeoBundleLazy <span class="s1">'basyura/twibill.vim'</span>
NeoBundleLazy <span class="s1">'basyura/TweetVim'</span><span class="p">,</span> <span class="s1">'dev'</span><span class="p">,</span> {
\   <span class="s1">'depends'</span> : [<span class="s1">'basyura/twibill.vim'</span><span class="p">,</span> <span class="s1">'tyru/open-browser.vim'</span> ]<span class="p">,</span>
\   <span class="s1">'autoload'</span> : {
\       <span class="s1">'commands'</span> : [ <span class="s2">"TweetVimHomeTimeline"</span><span class="p">,</span> <span class="s2">"TweetVimSay"</span><span class="p">,</span> <span class="s2">"TweetVimUserStream"</span><span class="p">,</span> <span class="s2">"TweetVimUserTimeline"</span> ]
\   }
\}

NeoBundle <span class="s1">'tpope/vim-fugitive'</span>

NeoBundle <span class="s1">'tsukkee/unite-help'</span>
NeoBundle <span class="s1">'ujihisa/unite-gem'</span>
NeoBundle <span class="s1">'thinca/vim-unite-history'</span>
NeoBundle <span class="s1">'h1mesuke/unite-outline'</span>
NeoBundle <span class="s1">'eagletmt/unite-haddock'</span>
NeoBundle <span class="s1">'tsukkee/unite-tag'</span>
NeoBundle <span class="s1">'rhysd/unite-ruby-require.vim'</span>

NeoBundleLazy <span class="s1">'Shougo/unite.vim'</span><span class="p">,</span> {
\   <span class="s1">'autoload'</span> : {
\       <span class="s1">'commands'</span> : [ <span class="s2">"Unite"</span><span class="p">,</span> <span class="s2">"UniteWithBufferDir"</span><span class="p">,</span> <span class="s2">"UniteWithCurrentDir"</span> ]
\   }
\}

NeoBundleLazy <span class="s1">'Shougo/neosnippet'</span>
NeoBundle <span class="s1">'Rip-Rip/clang_complete'</span>

<span class="k">if</span> has<span class="p">(</span><span class="s1">'lua'</span><span class="p">)</span>
  NeoBundleLazy <span class="s1">'Shougo/neocomplete'</span><span class="p">,</span> {
  \   <span class="s1">'depends'</span> : [<span class="s1">'Shougo/neosnippet'</span><span class="p">,</span> <span class="s1">'Shougo/context_filetype.vim'</span>]<span class="p">,</span>
  \   <span class="s1">'vim_version'</span> : <span class="s1">'7.3.885'</span><span class="p">,</span>
  \   <span class="s1">'autoload'</span> : {
  \       <span class="s1">'insert'</span> : <span class="m">1</span><span class="p">,</span>
  \   }
  \}
<span class="k">else</span>
  NeoBundleLazy <span class="s1">'Shougo/neocomplcache'</span><span class="p">,</span> {
  \   <span class="s1">'depends'</span> : [<span class="s2">"Shougo/neosnippet"</span>]<span class="p">,</span>
  \   <span class="s1">'autoload'</span> : {
  \       <span class="s1">'insert'</span> : <span class="m">1</span><span class="p">,</span>
  \   }
  \}
<span class="k">endif</span>

NeoBundleLazy <span class="s1">'Shougo/vimfiler'</span><span class="p">,</span> {
\   <span class="s1">'depends'</span> : [<span class="s2">"Shougo/unite.vim"</span>]<span class="p">,</span>
\   <span class="s1">'autoload'</span> : {
\       <span class="s1">'commands'</span> : [ <span class="s2">"VimFilerTab"</span><span class="p">,</span> <span class="s2">"VimFiler"</span><span class="p">,</span> <span class="s2">"VimFilerExplorer"</span><span class="p">,</span> <span class="s2">"VimFilerBufferDir"</span> ]<span class="p">,</span>
\       <span class="s1">'mappings'</span> : [<span class="s1">'&lt;Plug&gt;(vimfiler_switch)'</span>]<span class="p">,</span>
\       <span class="s1">'explorer'</span> : <span class="m">1</span><span class="p">,</span>
\   }
\}

NeoBundleLazy <span class="s1">'Shougo/vimshell'</span><span class="p">,</span> {
      \ <span class="s1">'depends'</span> : <span class="s1">'Shougo/vimproc'</span><span class="p">,</span>
      \ <span class="s1">'autoload'</span> : {
      \   <span class="s1">'commands'</span> : [{ <span class="s1">'name'</span> : <span class="s1">'VimShell'</span><span class="p">,</span>
      \                   <span class="s1">'complete'</span> : <span class="s1">'customlist,vimshell#complete'</span>}<span class="p">,</span>
      \                 <span class="s1">'VimShellExecute'</span><span class="p">,</span> <span class="s1">'VimShellInteractive'</span><span class="p">,</span>
      \                 <span class="s1">'VimShellTerminal'</span><span class="p">,</span> <span class="s1">'VimShellPop'</span>]<span class="p">,</span>
      \   <span class="s1">'mappings'</span> : [<span class="s1">'&lt;Plug&gt;(vimshell_switch)'</span>]
      \ }}

NeoBundleLazy <span class="s1">'mattn/gist-vim'</span><span class="p">,</span> {
\   <span class="s1">'autoload'</span> : {
\       <span class="s1">'commands'</span> : [ <span class="s2">"Gist"</span> ]
\   }
\}

NeoBundleLazy <span class="s1">'sjl/gundo.vim'</span><span class="p">,</span> {
\   <span class="s1">'autoload'</span> : {
\       <span class="s1">'commands'</span> : [ <span class="s2">"GundoShow"</span><span class="p">,</span> <span class="s2">"GundoToggle"</span> ]
\   }
\}

NeoBundleLazy <span class="s1">'kana/vim-altr'</span><span class="p">,</span> {
\   <span class="s1">'autoload'</span> : {
\       <span class="s1">'mappings'</span> : [<span class="s1">'&lt;Plug&gt;(altr-forward)'</span><span class="p">,</span> <span class="s1">'&lt;Plug&gt;(altr-back)'</span>]<span class="p">,</span>
\   }
\}

NeoBundle <span class="s1">'joker1007/vim-ruby-heredoc-syntax'</span>
NeoBundle <span class="s1">'joker1007/vim-markdown-quote-syntax'</span>
<span class="c">" }}}</span>


<span class="nb">syntax</span> enable
<span class="k">filetype</span> plugin indent <span class="k">on</span>

NeoBundleCheck

<span class="k">if</span> filereadable<span class="p">(</span>expand<span class="p">(</span><span class="s1">'~/.vimrc.local'</span><span class="p">))</span>
  execute <span class="s1">'source'</span> expand<span class="p">(</span><span class="s1">'~/.vimrc.local'</span><span class="p">)</span>
<span class="k">endif</span>

<span class="c">" augroup init (from tyru's vimrc)</span>
augroup vimrc
  autocmd<span class="p">!</span>
augroup END

command<span class="p">!</span>
\ <span class="p">-</span>bang <span class="p">-</span>nargs<span class="p">=</span>*
\ MyAutocmd
\ autocmd<span class="p">&lt;</span>bang<span class="p">&gt;</span> vimrc <span class="p">&lt;</span>args<span class="p">&gt;</span>

<span class="c">" Basic Setting {{{</span>
<span class="k">set</span> <span class="nb">bs</span><span class="p">=</span>indent<span class="p">,</span><span class="nb">eol</span><span class="p">,</span><span class="k">start</span>     <span class="c">" allow backspacing over everything in insert mode</span>
<span class="k">set</span> <span class="nb">ai</span>                      <span class="c">" always set autoindenting on</span>
<span class="k">set</span> <span class="nb">nobackup</span>
<span class="k">set</span> <span class="nb">noswapfile</span>              <span class="c">" No Swap</span>
<span class="k">set</span> <span class="nb">viminfo</span><span class="p">=</span>%<span class="p">,</span>'<span class="m">100</span><span class="p">,&lt;</span><span class="m">500</span><span class="p">,</span><span class="k">h</span>
<span class="k">set</span> <span class="k">history</span><span class="p">=</span><span class="m">100</span>             <span class="c">" keep 100 lines of command line history</span>
<span class="k">set</span> <span class="nb">ruler</span>                   <span class="c">" show the cursor position all the time</span>
<span class="k">set</span> <span class="k">nu</span>                      <span class="c">" show line number</span>
<span class="k">set</span> <span class="nb">ambiwidth</span><span class="p">=</span>double
<span class="k">set</span> <span class="nb">display</span><span class="p">=</span>uhex            <span class="c">" 表示できない文字を16進数で表示</span>
<span class="k">set</span> <span class="nb">scrolloff</span><span class="p">=</span><span class="m">5</span>             <span class="c">" 常にカーソル位置から5行余裕を取る</span>
<span class="k">set</span> <span class="nb">virtualedit</span><span class="p">=</span>block       <span class="c">" 矩形選択でカーソル位置の制限を解除</span>
<span class="k">set</span> <span class="nb">autoread</span>                <span class="c">" 他でファイルが編集された時に自動で読み込む</span>
<span class="k">set</span> <span class="nb">background</span><span class="p">=</span><span class="nb">dark</span>

<span class="c">" Space prefix</span>
<span class="nb">nnoremap</span> [space] <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
nmap     <span class="p">&lt;</span>Space<span class="p">&gt;</span> [space]
xmap     <span class="p">&lt;</span>Space<span class="p">&gt;</span> [space]

<span class="c">" Edit vimrc</span>
nmap [space]<span class="k">v</span> :edit $MYVIMRC<span class="p">&lt;</span>CR<span class="p">&gt;</span>
nmap [space]<span class="k">g</span> :edit $MYGVIMRC<span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="nb">nnoremap</span> <span class="p">&lt;</span>C<span class="p">-</span>H<span class="p">&gt;</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>help<span class="p">&lt;</span>Space<span class="p">&gt;</span>

<span class="c">" 編集中の行に下線を引く</span>
MyAutocmd <span class="nb">InsertLeave</span> * <span class="k">setlocal</span> <span class="nb">nocursorline</span>
MyAutocmd <span class="nb">InsertEnter</span> * <span class="k">setlocal</span> <span class="nb">cursorline</span>
MyAutocmd <span class="nb">InsertLeave</span> * <span class="nb">highlight</span> StatusLine ctermfg<span class="p">=</span><span class="m">145</span> guifg<span class="p">=</span><span class="mh">#c2bfa5</span> guibg<span class="p">=</span><span class="mh">#000000</span>
MyAutocmd <span class="nb">InsertEnter</span> * <span class="nb">highlight</span> StatusLine ctermfg<span class="p">=</span><span class="m">12</span> guifg<span class="p">=</span>#<span class="m">1</span>E<span class="m">90</span>FF


<span class="c">" タブストップ設定</span>
<span class="k">set</span> <span class="nb">tabstop</span><span class="p">=</span><span class="m">2</span>
<span class="k">set</span> <span class="nb">shiftwidth</span><span class="p">=</span><span class="m">2</span>
<span class="k">set</span> <span class="nb">softtabstop</span><span class="p">=</span><span class="m">0</span>
<span class="k">set</span> <span class="nb">expandtab</span>

<span class="c">" 折り畳み設定</span>
<span class="k">set</span> <span class="nb">foldmethod</span><span class="p">=</span>marker
nmap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">,</span>fc :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>%<span class="k">foldclose</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
nmap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">,</span><span class="k">fo</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>%<span class="k">foldopen</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="c">" 検索設定</span>
<span class="k">set</span> <span class="nb">incsearch</span>
<span class="k">set</span> <span class="nb">hlsearch</span>
<span class="k">set</span> <span class="nb">ignorecase</span>
<span class="k">set</span> <span class="nb">smartcase</span>
<span class="k">set</span> <span class="nb">wrapscan</span>
<span class="k">nohlsearch</span> <span class="c">"reset highlight</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [space]/ :<span class="k">noh</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
map * <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>visualstar<span class="p">-</span>*<span class="p">)</span>N
map # <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>visualstar<span class="p">-</span>#<span class="p">)</span>N

<span class="c">" ステータスライン表示</span>
<span class="k">set</span> <span class="nb">laststatus</span><span class="p">=</span><span class="m">2</span>
<span class="k">set</span> <span class="nb">statusline</span><span class="p">=</span>%<span class="p">&lt;</span>%<span class="k">f</span>\ %<span class="k">m</span>%<span class="k">r</span>%<span class="k">h</span>%<span class="k">w</span>%{<span class="s1">'['</span>.<span class="p">(</span>&amp;<span class="nb">fenc</span><span class="p">!=</span><span class="s1">''</span>?&amp;<span class="nb">fenc</span>:&amp;<span class="nb">enc</span><span class="p">)</span>.<span class="s1">']['</span>.&amp;<span class="nb">ff</span>.<span class="s1">']'</span>}%<span class="k">y</span>%{tagbar#currenttag<span class="p">(</span><span class="s1">'[%s]'</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span>}%{fugitive#<span class="nb">statusline</span><span class="p">()</span>}%{SyntasticStatuslineFlag<span class="p">()</span>}%{exists<span class="p">(</span><span class="s1">'*SkkGetModeStr'</span><span class="p">)</span>?SkkGetModeStr<span class="p">()</span>:<span class="s1">''</span>}%<span class="p">=</span>%<span class="k">l</span>/%L<span class="p">,</span>%<span class="k">c</span>%V%<span class="m">8</span>P\ 
<span class="k">set</span> <span class="nb">noshowmode</span>
<span class="k">set</span> <span class="nb">wildmenu</span>
<span class="k">set</span> <span class="nb">cmdheight</span><span class="p">=</span><span class="m">2</span>
<span class="k">set</span> <span class="nb">wildmode</span><span class="p">=</span><span class="nb">list</span>:full
<span class="k">set</span> <span class="nb">showcmd</span>

<span class="c">" tabline</span>
<span class="k">set</span> <span class="nb">showtabline</span><span class="p">=</span><span class="m">2</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>S<span class="p">-</span>Right<span class="p">&gt;</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>tabnext<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>S<span class="p">-</span>Left<span class="p">&gt;</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span><span class="k">tabprevious</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> L :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>tabnext<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> H :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span><span class="k">tabprevious</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="c">" completion</span>
<span class="k">set</span> <span class="nb">complete</span><span class="p">=</span>.<span class="p">,</span><span class="k">w</span><span class="p">,</span><span class="k">b</span><span class="p">,</span><span class="k">u</span><span class="p">,</span><span class="k">t</span><span class="p">,</span><span class="k">i</span><span class="p">,</span><span class="k">d</span><span class="p">,</span><span class="k">k</span>

<span class="c">" クリップボード設定</span>
<span class="k">set</span> <span class="nb">clipboard</span><span class="p">=</span>unnamed

<span class="c">" バッファ切り替え</span>
<span class="k">set</span> <span class="nb">hidden</span>

<span class="c">" Tab表示</span>
<span class="k">set</span> <span class="nb">list</span>
<span class="k">set</span> <span class="nb">listchars</span><span class="p">=</span><span class="k">tab</span>:<span class="p">&gt;-,</span>trail:<span class="p">&lt;</span>

<span class="c">" タイトルを表示</span>
<span class="k">set</span> <span class="nb">title</span>

<span class="c">" 対応括弧を表示</span>
<span class="k">set</span> <span class="nb">showmatch</span>

<span class="c">" 自動折り返しを日本語に対応させるスクリプト用の設定</span>
<span class="k">set</span> <span class="nb">formatoptions</span><span class="p">+=</span>mM

<span class="c">" matchitスクリプトの読み込み</span>
source $VIMRUNTIME<span class="sr">/macros/</span>matchit.<span class="k">vim</span>

<span class="c">" jkを直感的に</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="k">j</span> gj
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> gj <span class="k">j</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="k">k</span> gk
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> gk <span class="k">k</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> $ <span class="k">g</span>$
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="k">g</span>$ $
<span class="nb">vnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="k">j</span> gj
<span class="nb">vnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> gj <span class="k">j</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="k">k</span> gk
<span class="nb">vnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> gk <span class="k">k</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> $ <span class="k">g</span>$
<span class="nb">vnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="k">g</span>$ $

<span class="c">" JとDで半ページ移動</span>
<span class="nb">nnoremap</span> J <span class="p">&lt;</span>C<span class="p">-</span>D<span class="p">&gt;</span>
<span class="nb">nnoremap</span> K <span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>

<span class="c">" &lt;Space&gt;h or &lt;Space&gt;lで行頭か行末に移動する</span>
<span class="nb">noremap</span> [space]<span class="k">h</span>  ^
<span class="nb">noremap</span> [space]<span class="k">l</span>  $

<span class="c">" 編集中のファイルのディレクトリに移動</span>
<span class="nb">nnoremap</span> <span class="p">,</span><span class="k">d</span> :execute <span class="s2">":lcd"</span> . expand<span class="p">(</span><span class="s2">"%:p:h"</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>

<span class="c">" 最後に編集した場所にカーソルを移動する</span>
MyAutocmd <span class="nb">BufReadPost</span> * <span class="k">if</span> line<span class="p">(</span><span class="s2">"'\""</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">1</span> &amp;&amp; line<span class="p">(</span><span class="s2">"'\""</span><span class="p">)</span> <span class="p">&lt;=</span> line<span class="p">(</span><span class="s2">"$"</span><span class="p">)</span> <span class="p">|</span> exe <span class="s2">"normal! g`\""</span> <span class="p">|</span> <span class="k">endif</span>

<span class="c">" colorscheme</span>
<span class="c">" 全角スペースをハイライト</span>
MyAutocmd <span class="nb">ColorScheme</span> * <span class="nb">highlight</span> ZenkakuSpace ctermbg<span class="p">=</span><span class="m">239</span> guibg<span class="p">=</span><span class="mh">#405060</span>
MyAutocmd <span class="nb">VimEnter</span><span class="p">,</span><span class="nb">WinEnter</span> * <span class="k">call</span> matchadd<span class="p">(</span><span class="s1">'ZenkakuSpace'</span><span class="p">,</span> <span class="s1">'　'</span><span class="p">)</span>

<span class="k">if</span> stridx<span class="p">(</span>$TERM<span class="p">,</span> <span class="s2">"xterm-256color"</span><span class="p">)</span> <span class="p">&gt;=</span> <span class="m">0</span>
  <span class="k">let</span> <span class="k">g</span>:solarized_termcolors<span class="p">=</span> <span class="m">256</span>
  <span class="k">let</span> <span class="k">g</span>:solarized_contrast <span class="p">=</span> <span class="s2">"high"</span>
  <span class="k">let</span> <span class="k">g</span>:solarized_termtrans <span class="p">=</span> <span class="m">1</span>
  <span class="k">colorscheme</span> solarized
<span class="k">else</span>
  <span class="k">colorscheme</span> solarized
<span class="k">endif</span>

<span class="c">" 256色モード</span>
<span class="k">if</span> stridx<span class="p">(</span>$TERM<span class="p">,</span> <span class="s2">"xterm-256color"</span><span class="p">)</span> <span class="p">&gt;=</span> <span class="m">0</span>
  <span class="k">set</span> <span class="nb">t_Co</span><span class="p">=</span><span class="m">256</span>
<span class="k">else</span>
  <span class="k">set</span> <span class="nb">t_Co</span><span class="p">=</span><span class="m">16</span>
<span class="k">endif</span>

<span class="c">" mark, register確認</span>
<span class="c">" nnoremap ,m  :&lt;C-u&gt;marks&lt;CR&gt;</span>
<span class="nb">nnoremap</span> <span class="p">,</span><span class="k">r</span>  :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span><span class="k">registers</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="c">"---------------------------------------------------------}}}</span>

<span class="c">" vim-airline</span>
<span class="k">let</span> <span class="k">g</span>:airline_powerline_fonts <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:airline_theme <span class="p">=</span> <span class="s2">"wombat"</span>

<span class="c">" surround.vim {{{</span>
nmap <span class="p">,(</span> csw<span class="p">(</span>
nmap <span class="p">,)</span> csw<span class="p">)</span>
nmap <span class="p">,</span>{ csw{
nmap <span class="p">,</span>} csw}
nmap <span class="p">,</span>[ csw[
nmap <span class="p">,</span>] csw]
nmap <span class="p">,</span><span class="s1">' csw'</span>
nmap <span class="p">,</span><span class="s2">" csw"</span>
<span class="c">"}}}</span>

<span class="c">" Insert Mode Mapping {{{</span>
<span class="nb">inoremap</span> <span class="p">&lt;</span>C<span class="p">-</span>K<span class="p">&gt;</span> <span class="p">&lt;</span>ESC<span class="p">&gt;</span>"*<span class="nb">pa</span>
imap <span class="p">&lt;</span>C<span class="p">-</span>E<span class="p">&gt;</span> <span class="p">&lt;</span>END<span class="p">&gt;</span>
imap <span class="p">&lt;</span>C<span class="p">-</span>A<span class="p">&gt;</span> <span class="p">&lt;</span>HOME<span class="p">&gt;</span>

<span class="c">" }}}</span>

<span class="c">" from http://vim-users.jp/2011/04/hack214/ {{{</span>
<span class="nb">vnoremap</span> <span class="p">(</span> <span class="k">t</span><span class="p">(</span>
<span class="nb">vnoremap</span> <span class="p">)</span> <span class="k">t</span><span class="p">)</span>
<span class="nb">vnoremap</span> ] <span class="k">t</span>]
<span class="nb">vnoremap</span> [ <span class="k">t</span>[
onoremap <span class="p">(</span> <span class="k">t</span><span class="p">(</span>
onoremap <span class="p">)</span> <span class="k">t</span><span class="p">)</span>
onoremap ] <span class="k">t</span>]
onoremap [ <span class="k">t</span>[
<span class="c">" }}}</span>

<span class="c">" set paste</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">,</span><span class="k">p</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span><span class="k">set</span> <span class="nb">paste</span><span class="p">!&lt;</span>CR<span class="p">&gt;</span>:<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>echo<span class="p">(</span><span class="s2">"Toggle PasteMode =&gt; "</span> . <span class="p">(</span>&amp;<span class="nb">paste</span> <span class="p">==</span> <span class="m">0</span> ? <span class="s2">"Off"</span> : <span class="s2">"On"</span><span class="p">))&lt;</span>CR<span class="p">&gt;</span>

<span class="c">" eskk {{{</span>
<span class="k">let</span> <span class="k">g</span>:eskk#large_dictionary <span class="p">=</span> {
      \ <span class="s1">'path'</span>: $HOME . <span class="s2">"/.vim/dict/skk/SKK-JISYO.L"</span><span class="p">,</span>
      \ <span class="s1">'sorted'</span>: <span class="m">1</span><span class="p">,</span>
      \ <span class="s1">'encoding'</span>: <span class="s1">'euc-jp'</span><span class="p">,</span>
      \}
<span class="c">" }}}</span>

<span class="c">" wq alias</span>
command<span class="p">!</span> <span class="p">-</span>nargs<span class="p">=</span><span class="m">0</span> Wq <span class="k">wq</span>

<span class="c">" UTF8、SJIS(CP932)、EUCJPで開き直す {{{</span>
command<span class="p">!</span> <span class="p">-</span>bang <span class="p">-</span>nargs<span class="p">=</span>? Utf8
    \ edit<span class="p">&lt;</span>bang<span class="p">&gt;</span> <span class="p">++</span><span class="nb">enc</span><span class="p">=</span>utf<span class="m">-8</span> <span class="p">&lt;</span>args<span class="p">&gt;</span>
command<span class="p">!</span> <span class="p">-</span>bang <span class="p">-</span>nargs<span class="p">=</span>? Sjis
    \ edit<span class="p">&lt;</span>bang<span class="p">&gt;</span> <span class="p">++</span><span class="nb">enc</span><span class="p">=</span>cp932 <span class="p">&lt;</span>args<span class="p">&gt;</span>
command<span class="p">!</span> <span class="p">-</span>bang <span class="p">-</span>nargs<span class="p">=</span>? Euc
    \ edit<span class="p">&lt;</span>bang<span class="p">&gt;</span> <span class="p">++</span><span class="nb">enc</span><span class="p">=</span>eucjp <span class="p">&lt;</span>args<span class="p">&gt;</span>
<span class="c">" }}}</span>

<span class="c">" YAMLファイル用タブストップ設定</span>
<span class="k">au</span> <span class="nb">FileType</span> yaml <span class="k">setlocal</span> <span class="nb">expandtab</span> <span class="k">ts</span><span class="p">=</span><span class="m">2</span> <span class="k">sw</span><span class="p">=</span><span class="m">2</span> <span class="nb">fenc</span><span class="p">=</span>utf<span class="m">-8</span>

<span class="c">" actionscript mxml用のファイルタイプ設定</span>
MyAutocmd <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> *.<span class="k">as</span> <span class="k">set</span> <span class="k">filetype</span><span class="p">=</span>actionscript
MyAutocmd <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> *.mxml <span class="k">set</span> <span class="k">filetype</span><span class="p">=</span>mxml

<span class="c">" バッファ切り替え {{{</span>
nmap [space]<span class="k">n</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span><span class="k">bnext</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
nmap [space]<span class="k">p</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span><span class="k">bprevious</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">1</span>   :<span class="k">e</span> #<span class="m">1</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">2</span>   :<span class="k">e</span> #<span class="m">2</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">3</span>   :<span class="k">e</span> #<span class="m">3</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">4</span>   :<span class="k">e</span> #<span class="m">4</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">5</span>   :<span class="k">e</span> #<span class="m">5</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">6</span>   :<span class="k">e</span> #<span class="m">6</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">7</span>   :<span class="k">e</span> #<span class="m">7</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">8</span>   :<span class="k">e</span> #<span class="m">8</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="m">9</span>   :<span class="k">e</span> #<span class="m">9</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="c">" バッファ一覧</span>
nmap <span class="p">,</span><span class="k">b</span> :<span class="k">buffers</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="c">" }}}</span>

<span class="c">" NERDCommenter</span>
<span class="k">let</span> NERDSpaceDelims <span class="p">=</span> <span class="m">1</span>

<span class="c">" smartchr {{{</span>
<span class="k">function</span><span class="p">!</span> s:EnableSmartchrBasic<span class="p">()</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="p">+</span> smartchr#one_of<span class="p">(</span><span class="s1">' + '</span><span class="p">,</span> <span class="s1">'+'</span><span class="p">,</span> <span class="s1">'++'</span><span class="p">)</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> &amp; smartchr#one_of<span class="p">(</span><span class="s1">' &amp; '</span><span class="p">,</span> <span class="s1">' &amp;&amp; '</span><span class="p">,</span> <span class="s1">'&amp;'</span><span class="p">)</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="p">,</span> smartchr#one_of<span class="p">(</span><span class="s1">', '</span><span class="p">,</span> <span class="s1">','</span><span class="p">)</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="p">&lt;</span>Bar<span class="p">&gt;</span> smartchr#one_of<span class="p">(</span><span class="s1">'&lt;Bar&gt;'</span><span class="p">,</span> <span class="s1">' &lt;Bar&gt;&lt;Bar&gt; '</span><span class="p">,</span> <span class="s1">'&lt;Bar&gt;&lt;Bar&gt;'</span><span class="p">)</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="p">=</span> search<span class="p">(</span><span class="s1">'\(&amp;\&lt;bar&gt;&lt;bar&gt;\&lt;bar&gt;+\&lt;bar&gt;-\&lt;bar&gt;/\&lt;bar&gt;&gt;\&lt;bar&gt;&lt;\) \%#'</span><span class="p">,</span> <span class="s1">'bcn'</span><span class="p">)</span>? <span class="s1">'&lt;bs&gt;= '</span> : search<span class="p">(</span><span class="s1">'\(\*\&lt;bar&gt;!\)\%#'</span><span class="p">)</span>? <span class="s1">'= '</span> : smartchr#one_of<span class="p">(</span><span class="s1">' = '</span><span class="p">,</span> <span class="s1">' == '</span><span class="p">,</span> <span class="s1">'='</span><span class="p">)</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> s:EnableSmartchrRegExp<span class="p">()</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="p">~</span> search<span class="p">(</span><span class="s1">'\(!\&lt;bar&gt;=\) \%#'</span><span class="p">,</span> <span class="s1">'bcn'</span><span class="p">)</span>? <span class="s1">'&lt;bs&gt;~ '</span> : <span class="s1">'~'</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> s:EnableSmartchrRubyHash<span class="p">()</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="p">&gt;</span> smartchr#one_of<span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">' =&gt; '</span><span class="p">)</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> s:EnableSmartchrHaml<span class="p">()</span>
  <span class="k">call</span> s:EnableSmartchrRubyHash<span class="p">()</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> [ []<span class="p">&lt;</span>Esc<span class="p">&gt;</span><span class="k">i</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> { {}<span class="p">&lt;</span>Esc<span class="p">&gt;</span><span class="k">i</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> s:EnableSmartchrCoffeeFunction<span class="p">()</span>
  <span class="nb">inoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="p">&gt;</span> smartchr#one_of<span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">' -&gt;'</span><span class="p">)</span>
<span class="k">endfunction</span>

MyAutocmd <span class="nb">FileType</span> <span class="k">c</span><span class="p">,</span>cpp<span class="p">,</span>php<span class="p">,</span>python<span class="p">,</span>javascript<span class="p">,</span><span class="k">ruby</span><span class="p">,</span>coffee<span class="p">,</span><span class="k">vim</span> <span class="k">call</span> s:EnableSmartchrBasic<span class="p">()</span>
MyAutocmd <span class="nb">FileType</span> python<span class="p">,</span><span class="k">ruby</span><span class="p">,</span>coffee<span class="p">,</span><span class="k">vim</span> <span class="k">call</span> s:EnableSmartchrRegExp<span class="p">()</span>
MyAutocmd <span class="nb">FileType</span> <span class="k">ruby</span> <span class="k">call</span> s:EnableSmartchrRubyHash<span class="p">()</span>
MyAutocmd <span class="nb">FileType</span> <span class="k">ruby</span><span class="p">,</span>eruby <span class="k">setlocal</span> <span class="k">tags</span><span class="p">+=~</span>/rtags
MyAutocmd <span class="nb">FileType</span> haml <span class="k">call</span> s:EnableSmartchrHaml<span class="p">()</span>
MyAutocmd <span class="nb">FileType</span> coffee <span class="k">call</span> s:EnableSmartchrCoffeeFunction<span class="p">()</span>
<span class="c">" }}}</span>

<span class="c">" hatena.vim</span>
<span class="k">let</span> <span class="k">g</span>:hatena_user <span class="p">=</span> <span class="s1">'joker1007'</span>

<span class="c">" shファイルの保存時にはファイルのパーミッションを755にする {{{</span>
<span class="k">function</span><span class="p">!</span> s:ChangeShellScriptPermission<span class="p">()</span>
  <span class="k">if</span> <span class="p">!</span>has<span class="p">(</span><span class="s2">"win32"</span><span class="p">)</span>
    <span class="k">if</span> &amp;<span class="nb">ft</span> <span class="p">=~</span> <span class="s2">"\\(z\\|c\\|ba\\)\\?sh$"</span> &amp;&amp; expand<span class="p">(</span><span class="s1">'%:t'</span><span class="p">)</span> <span class="p">!~</span> <span class="s2">"\\(zshrc\\|zshenv\\)$"</span>
      <span class="k">call</span> system<span class="p">(</span><span class="s2">"chmod 755 "</span> . shellescape<span class="p">(</span>expand<span class="p">(</span><span class="s1">'%:p'</span><span class="p">)))</span>
      echo <span class="s2">"Set permission 755"</span>
    <span class="k">endif</span>
  <span class="k">endif</span>
<span class="k">endfunction</span>
MyAutocmd <span class="nb">BufWritePost</span> * <span class="k">call</span> s:ChangeShellScriptPermission<span class="p">()</span>
<span class="c">" }}}</span>

<span class="c">" QFixHowm用設定======================================================{{{</span>
<span class="k">set</span> <span class="nb">runtimepath</span><span class="p">+=~</span>/qfixapp

<span class="c">" ファイル拡張子をmkdにする</span>
<span class="k">let</span> howm_filename <span class="p">=</span> <span class="s1">'%Y-%m-%d-%H%M%S.mkd'</span>
<span class="c">" ファイルタイプをmarkdownにする</span>
<span class="k">let</span> QFixHowm_FileType <span class="p">=</span> <span class="s1">'markdown'</span>
<span class="c">" 折り畳み正規表現</span>
<span class="k">let</span> QFixHowm_FoldingPattern <span class="p">=</span> <span class="s1">'^[=.*#]'</span>

<span class="c">" タイトル記号</span>
<span class="k">let</span> QFixHowm_Title <span class="p">=</span> <span class="s1">'#'</span>

<span class="c">"キーマップリーダー</span>
<span class="k">let</span> QFixHowm_Key <span class="p">=</span> <span class="s1">'g'</span>

<span class="c">"howm_dirはファイルを保存したいディレクトリを設定。</span>
<span class="k">let</span> howm_dir          <span class="p">=</span> <span class="s1">'~/Dropbox/howm'</span>
<span class="k">let</span> howm_fileencoding <span class="p">=</span> <span class="s1">'utf-8'</span>
<span class="k">let</span> howm_fileformat   <span class="p">=</span> <span class="s1">'unix'</span>

<span class="k">if</span> has<span class="p">(</span><span class="s1">'win32'</span><span class="p">)</span>
  <span class="k">let</span> mygrepprg <span class="p">=</span> <span class="s1">'yagrep'</span>
<span class="k">elseif</span> has<span class="p">(</span><span class="s1">'unix'</span><span class="p">)</span>
  <span class="k">let</span> mygrepprg <span class="p">=</span> <span class="s1">'grep'</span>
<span class="k">endif</span>

<span class="k">let</span> QFixHowm_MruFileMax <span class="p">=</span> <span class="m">30</span>

<span class="k">let</span> QFixHowm_RecentMode <span class="p">=</span> <span class="m">2</span>

<span class="c">" リネーム後のファイル名制限</span>
<span class="k">let</span> QFixHowm_FilenameLen <span class="p">=</span> <span class="m">80</span>


<span class="c">"ブラウザの指定</span>
<span class="k">if</span> has<span class="p">(</span><span class="s1">'win32'</span><span class="p">)</span>
  <span class="k">let</span> QFixHowm_OpenURIcmd <span class="p">=</span> <span class="s1">'!start "C:\firefox\firefox.exe" %s'</span>
<span class="k">elseif</span> has<span class="p">(</span><span class="s1">'mac'</span><span class="p">)</span>
  <span class="k">let</span> QFixHowm_OpenURIcmd <span class="p">=</span> <span class="s2">"call system('/usr/bin/open -a /Applications/Firefox.app/Contents/MacOS/firefox-bin %s')"</span>
<span class="k">elseif</span> has<span class="p">(</span><span class="s1">'unix'</span><span class="p">)</span>
  <span class="k">let</span> QFixHowm_OpenURIcmd <span class="p">=</span> <span class="s2">"call system('xdg-open %s')"</span>
<span class="k">endif</span>
<span class="c">" }}}</span>


<span class="c">" ポップアップメニューのカラーを設定</span>
MyAutocmd <span class="nb">Syntax</span> * <span class="k">hi</span> Pmenu ctermfg<span class="p">=</span><span class="m">15</span> ctermbg<span class="p">=</span><span class="m">18</span> guibg<span class="p">=</span><span class="mh">#666666</span>
MyAutocmd <span class="nb">Syntax</span> * <span class="k">hi</span> PmenuSel ctermbg<span class="p">=</span><span class="m">39</span> ctermfg<span class="p">=</span><span class="m">0</span> guibg<span class="p">=</span><span class="mh">#8cd0d3</span> guifg<span class="p">=</span><span class="mh">#666666</span>
MyAutocmd <span class="nb">Syntax</span> * <span class="k">hi</span> PmenuSbar guibg<span class="p">=</span><span class="mh">#333333</span>

<span class="c">" TOhtml</span>
<span class="k">let</span> <span class="k">g</span>:html_number_lines <span class="p">=</span> <span class="m">0</span>
<span class="k">let</span> <span class="k">g</span>:html_use_css <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:use_xhtml <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:html_use_encoding <span class="p">=</span> <span class="s1">'utf-8'</span>

<span class="c">" grep.vim</span>
<span class="k">let</span> Grep_Default_Options <span class="p">=</span> <span class="s1">'-i'</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>C<span class="p">-</span>G<span class="p">&gt;&lt;</span>C<span class="p">-</span>G<span class="p">&gt;</span> :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>GrepBuffer<span class="p">&lt;</span>Space<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>C<span class="p">-</span>G<span class="p">&gt;&lt;</span>C<span class="p">-</span>W<span class="p">&gt;</span> :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>GrepBuffer<span class="p">&lt;</span>Space<span class="p">&gt;&lt;</span>C<span class="p">-</span><span class="k">r</span><span class="p">&gt;=</span> expand<span class="p">(</span><span class="s1">'&lt;cword&gt;'</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>

<span class="c">" quickrun{{{</span>

<span class="c">" エスケープカラーを表示する。</span>
MyAutocmd <span class="nb">FileType</span> quickrun AnsiEsc
<span class="c">" ヤンクを取りやすいようにconcealcursorを無効にする。</span>
MyAutocmd <span class="nb">FileType</span> quickrun <span class="k">setlocal</span> <span class="nb">concealcursor</span><span class="p">=</span><span class="s2">""</span>

<span class="nb">vnoremap</span> <span class="p">&lt;</span>leader<span class="p">&gt;</span><span class="k">q</span> :QuickRun <span class="p">&gt;&gt;</span>buffer <span class="p">-</span><span class="k">mode</span> <span class="k">v</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="k">let</span> <span class="k">g</span>:quickrun_config <span class="p">=</span> {}
<span class="k">let</span> <span class="k">g</span>:quickrun_config._ <span class="p">=</span> {<span class="s1">'runner'</span> : <span class="s1">'vimproc'</span>}
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'rspec/bundle'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'rspec/bundle'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'rspec'</span><span class="p">,</span>
  \ <span class="s1">'outputter/buffer/split'</span>: <span class="s1">'botright'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'bundle exec %c %o --color --tty %s'</span>
  \}
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'rspec/normal'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'rspec/normal'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'rspec'</span><span class="p">,</span>
  \ <span class="s1">'outputter/buffer/split'</span>: <span class="s1">'botright'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'%c %o --color --tty %s'</span>
  \}
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'rspec/zeus'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'rspec/zeus'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'rspec'</span><span class="p">,</span>
  \ <span class="s1">'outputter/buffer/split'</span>: <span class="s1">'botright'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'zeus test %o --color --tty %s'</span>
  \}
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'rspec/spring'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'rspec/spring'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'rspec'</span><span class="p">,</span>
  \ <span class="s1">'outputter/buffer/split'</span>: <span class="s1">'botright'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'spring rspec %o --color --tty %s'</span>
  \}
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'cucumber/bundle'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'cucumber/zeus'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'cucumber'</span><span class="p">,</span>
  \ <span class="s1">'outputter/buffer/split'</span>: <span class="s1">'botright'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'bundle exec %c %o --color %s'</span>
  \}
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'cucumber/zeus'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'cucumber/zeus'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'cucumber'</span><span class="p">,</span>
  \ <span class="s1">'outputter/buffer/split'</span>: <span class="s1">'botright'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'zeus cucumber %o --color %s'</span>
  \}
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'cucumber/spring'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'cucumber/spring'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'cucumber'</span><span class="p">,</span>
  \ <span class="s1">'outputter/buffer/split'</span>: <span class="s1">'botright'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'spring cucumber %o --color %s'</span>
  \}

<span class="k">function</span><span class="p">!</span> s:RSpecQuickrun<span class="p">()</span>
  <span class="k">if</span> exists<span class="p">(</span><span class="s1">'g:use_spring_rspec'</span><span class="p">)</span> &amp;&amp; <span class="k">g</span>:use_spring_rspec <span class="p">==</span> <span class="m">1</span>
    <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'rspec/spring'</span>}
  <span class="k">elseif</span> exists<span class="p">(</span><span class="s1">'g:use_zeus_rspec'</span><span class="p">)</span> &amp;&amp; <span class="k">g</span>:use_zeus_rspec <span class="p">==</span> <span class="m">1</span>
    <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'rspec/zeus'</span>}
  <span class="k">else</span>
    <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'rspec/bundle'</span>}
  <span class="k">endif</span>

  <span class="nb">nnoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">lr</span> <span class="s2">"&lt;Esc&gt;:QuickRun -cmdopt \"-l "</span> . line<span class="p">(</span><span class="s2">"."</span><span class="p">)</span> . <span class="s2">"\"&lt;CR&gt;"</span>
<span class="k">endfunction</span>
MyAutocmd <span class="nb">BufReadPost</span> *_spec.rb <span class="k">call</span> s:RSpecQuickrun<span class="p">()</span>

<span class="k">function</span><span class="p">!</span> s:CucumberQuickrun<span class="p">()</span>
  <span class="k">if</span> exists<span class="p">(</span><span class="s1">'g:use_spring_cucumber'</span><span class="p">)</span> &amp;&amp; <span class="k">g</span>:use_spring_cucumber <span class="p">==</span> <span class="m">1</span>
    <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'cucumber/spring'</span>}
  <span class="k">elseif</span> exists<span class="p">(</span><span class="s1">'g:use_zeus_cucumber'</span><span class="p">)</span> &amp;&amp; <span class="k">g</span>:use_zeus_cucumber <span class="p">==</span> <span class="m">1</span>
    <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'cucumber/zeus'</span>}
  <span class="k">else</span>
    <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'cucumber/bundle'</span>}
  <span class="k">endif</span>

  <span class="nb">nnoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">lr</span> <span class="s2">"&lt;Esc&gt;:QuickRun -cmdopt \"-l "</span> . line<span class="p">(</span><span class="s2">"."</span><span class="p">)</span> . <span class="s2">"\"&lt;CR&gt;"</span>
<span class="k">endfunction</span>
MyAutocmd <span class="nb">BufReadPost</span> *.feature <span class="k">call</span> s:CucumberQuickrun<span class="p">()</span>

<span class="k">function</span><span class="p">!</span> s:SetUseSpring<span class="p">()</span>
  <span class="k">let</span> <span class="k">g</span>:use_spring_rspec <span class="p">=</span> <span class="m">1</span>
  <span class="k">let</span> <span class="k">g</span>:use_zeus_rspec <span class="p">=</span> <span class="m">0</span>
  <span class="k">let</span> <span class="k">g</span>:use_spring_cucumber <span class="p">=</span> <span class="m">1</span>
  <span class="k">let</span> <span class="k">g</span>:use_zeus_cucumber <span class="p">=</span> <span class="m">0</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> s:SetUseZeus<span class="p">()</span>
  <span class="k">let</span> <span class="k">g</span>:use_zeus_rspec <span class="p">=</span> <span class="m">1</span>
  <span class="k">let</span> <span class="k">g</span>:use_spring_rspec <span class="p">=</span> <span class="m">0</span>
  <span class="k">let</span> <span class="k">g</span>:use_zeus_cucumber <span class="p">=</span> <span class="m">1</span>
  <span class="k">let</span> <span class="k">g</span>:use_spring_cucumber <span class="p">=</span> <span class="m">0</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> s:SetUseBundle<span class="p">()</span>
  <span class="k">let</span> <span class="k">g</span>:use_zeus_rspec <span class="p">=</span> <span class="m">0</span>
  <span class="k">let</span> <span class="k">g</span>:use_spring_rspec <span class="p">=</span> <span class="m">0</span>
  <span class="k">let</span> <span class="k">g</span>:use_zeus_cucumber <span class="p">=</span> <span class="m">0</span>
  <span class="k">let</span> <span class="k">g</span>:use_spring_cucumber <span class="p">=</span> <span class="m">0</span>
<span class="k">endfunction</span>

command<span class="p">!</span> <span class="p">-</span>nargs<span class="p">=</span><span class="m">0</span> UseSpringRSpec <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'rspec/spring'</span>} <span class="p">|</span> <span class="k">call</span> s:SetUseSpring<span class="p">()</span>
command<span class="p">!</span> <span class="p">-</span>nargs<span class="p">=</span><span class="m">0</span> UseZeusRSpec   <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'rspec/zeus'</span>}   <span class="p">|</span> <span class="k">call</span> s:SetUseZeus<span class="p">()</span>
command<span class="p">!</span> <span class="p">-</span>nargs<span class="p">=</span><span class="m">0</span> UseBundleRSpec <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'rspec/bundle'</span>} <span class="p">|</span> <span class="k">call</span> s:SetUseBundle<span class="p">()</span>
command<span class="p">!</span> <span class="p">-</span>nargs<span class="p">=</span><span class="m">0</span> UseSpringCucumber <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'cucumber/spring'</span>} <span class="p">|</span> <span class="k">call</span> s:SetUseSpring<span class="p">()</span>
command<span class="p">!</span> <span class="p">-</span>nargs<span class="p">=</span><span class="m">0</span> UseZeusCucumber   <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'cucumber/zeus'</span>}   <span class="p">|</span> <span class="k">call</span> s:SetUseZeus<span class="p">()</span>
command<span class="p">!</span> <span class="p">-</span>nargs<span class="p">=</span><span class="m">0</span> UseBundleCucumber <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'cucumber/bundle'</span>} <span class="p">|</span> <span class="k">call</span> s:SetUseBundle<span class="p">()</span>
<span class="c">" }}}</span>

<span class="c">" libruby load</span>
<span class="k">if</span> has<span class="p">(</span><span class="s1">'gui_macvim'</span><span class="p">)</span> &amp;&amp; has<span class="p">(</span><span class="s1">'kaoriya'</span><span class="p">)</span>
  <span class="k">let</span> s:ruby_libdir <span class="p">=</span> system<span class="p">(</span><span class="s2">"ruby -rrbconfig -e 'print RbConfig::CONFIG[\"libdir\"]'"</span><span class="p">)</span>
  <span class="k">let</span> s:ruby_libruby <span class="p">=</span> s:ruby_libdir . <span class="s1">'/libruby.dylib'</span>
  <span class="k">if</span> filereadable<span class="p">(</span>s:ruby_libruby<span class="p">)</span>
    <span class="k">let</span> $RUBY_DLL <span class="p">=</span> s:ruby_libruby
  <span class="k">endif</span>
<span class="k">endif</span>

<span class="c">" poslist</span>
nmap <span class="p">&lt;</span>C<span class="p">-</span>O<span class="p">&gt;</span> <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>poslist<span class="p">-</span><span class="k">prev</span><span class="p">-</span>pos<span class="p">)</span>
nmap <span class="p">&lt;</span>C<span class="p">-</span>I<span class="p">&gt;</span> <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>poslist<span class="p">-</span>next<span class="p">-</span>pos<span class="p">)</span>
<span class="k">let</span> <span class="k">g</span>:poslist_histsize <span class="p">=</span> <span class="m">2000</span>


<span class="c">" Unite.vim {{{</span>
<span class="nb">nnoremap</span> [unite] <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
nmap     <span class="p">,</span><span class="k">u</span> [unite]
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="nb">ff</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> buffer <span class="k">file</span> <span class="k">file</span>/<span class="k">new</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]fr   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> file_mru<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]fa   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> file_rec/async<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">d</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> directory_mru<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]vff  :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span><span class="k">vertical</span> <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> buffer <span class="k">file</span> <span class="k">file</span>/<span class="k">new</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]vfr  :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span><span class="k">vertical</span> <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> file_mru <span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]vp  :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span><span class="k">vertical</span> <span class="p">-</span><span class="nb">winwidth</span><span class="p">=</span><span class="m">45</span> <span class="p">-</span>no<span class="p">-</span>quit <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> buffer <span class="k">file</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]F   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>UniteWithBufferDir <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> buffer <span class="k">file</span> <span class="k">file</span>/<span class="k">new</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]vF  :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>UniteWithBufferDir <span class="p">-</span><span class="k">vertical</span> <span class="p">-</span><span class="nb">winwidth</span><span class="p">=</span><span class="m">45</span> <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">files</span> buffer <span class="k">file</span> <span class="k">file</span>/<span class="k">new</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">b</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">buffers</span> <span class="p">-</span><span class="nb">prompt</span><span class="p">=</span>Buffer<span class="p">&gt;</span>\  buffer<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="nb">vb</span>  :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span><span class="k">vertical</span> <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">buffers</span> <span class="p">-</span><span class="nb">prompt</span><span class="p">=</span>Buffer<span class="p">&gt;</span>\  buffer<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]vB  :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span><span class="k">vertical</span> <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">buffers</span> <span class="p">-</span><span class="nb">prompt</span><span class="p">=</span>Buffer<span class="p">&gt;</span>\  <span class="p">-</span><span class="nb">winwidth</span><span class="p">=</span><span class="m">45</span> <span class="p">-</span>no<span class="p">-</span>quit buffer<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">o</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span><span class="k">vertical</span> <span class="p">-</span><span class="nb">winwidth</span><span class="p">=</span><span class="m">45</span> <span class="p">-</span><span class="nb">wrap</span> <span class="p">-</span>no<span class="p">-</span>quit <span class="p">-</span>toggle <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span>outline outline<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="s2">"   :&lt;C-u&gt;Unite -buffer-name=register -prompt="</span><span class="p">&gt;</span>\  <span class="k">register</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">c</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span>commands <span class="k">history</span>/command<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]C   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span>commands command<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]s   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span>snippets snippet<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">u</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite source<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">l</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="nb">lines</span> line<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">m</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span>bookmark <span class="p">-</span><span class="nb">prompt</span><span class="p">=</span>bookmark<span class="p">&gt;</span> bookmark<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]rm   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span>ref <span class="p">-</span><span class="nb">prompt</span><span class="p">=</span>ref<span class="p">&gt;</span> ref/man<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">g</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite <span class="p">-</span>buffer<span class="p">-</span>name<span class="p">=</span><span class="k">grep</span> <span class="k">grep</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]hd   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite haddock <span class="p">-</span><span class="k">start</span><span class="p">-</span>insert<span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s2">"unite.vim"</span><span class="p">)</span>
<span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
  <span class="k">let</span> <span class="k">g</span>:unite_enable_start_insert <span class="p">=</span> <span class="m">1</span>

  <span class="k">let</span> <span class="k">g</span>:unite_winheight <span class="p">=</span> <span class="m">15</span>
  <span class="k">let</span> <span class="k">g</span>:unite_winwidth <span class="p">=</span> <span class="m">45</span>
  <span class="k">let</span> <span class="k">g</span>:unite_source_grep_max_candidates <span class="p">=</span> <span class="m">500</span>

<span class="c">  " unite-ruby-require</span>
  <span class="k">let</span> <span class="k">g</span>:unite_source_ruby_require_ruby_command <span class="p">=</span> expand<span class="p">(</span><span class="s2">"~/.rbenv/shims/ruby"</span><span class="p">)</span>

<span class="c">  " ディレクトリに対するブックマークはvimfilerをデフォルトアクションにする</span>
  <span class="k">call</span> unite#custom_default_action<span class="p">(</span><span class="s1">'source/bookmark/directory'</span><span class="p">,</span> <span class="s1">'vimfiler'</span><span class="p">)</span>

  <span class="k">call</span> unite#custom#source<span class="p">(</span><span class="s1">'buffer,file,file_mru'</span><span class="p">,</span> <span class="s1">'sorters'</span><span class="p">,</span> <span class="s1">'sorter_rank'</span><span class="p">)</span>

  <span class="k">call</span> unite#custom#source<span class="p">(</span><span class="s1">'file_rec,file_rec/async'</span><span class="p">,</span> <span class="s1">'filters'</span><span class="p">,</span>
        \ [<span class="s1">'converter_relative_word'</span><span class="p">,</span> <span class="s1">'matcher_default'</span><span class="p">,</span>
        \  <span class="s1">'sorter_rank'</span><span class="p">,</span> <span class="s1">'converter_relative_abbr'</span><span class="p">,</span> <span class="s1">'converter_file_directory'</span>]<span class="p">)</span>

  <span class="k">call</span> unite#custom#source<span class="p">(</span>
        \ <span class="s1">'file_mru'</span><span class="p">,</span> <span class="s1">'converters'</span><span class="p">,</span>
        \ [<span class="s1">'converter_file_directory'</span>]<span class="p">)</span>


  <span class="k">function</span><span class="p">!</span> s:unite_my_settings<span class="p">()</span>
<span class="c">    " Overwrite settings.</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">l</span>     <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>unite_choose_action<span class="p">)</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>C<span class="p">-</span><span class="k">c</span><span class="p">&gt;</span>     <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>unite_choose_action<span class="p">)</span>

    imap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>TAB<span class="p">&gt;</span>   <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>unite_select_next_line<span class="p">)</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>C<span class="p">-</span>z<span class="p">&gt;</span>     <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>unite_toggle_transpose_window<span class="p">)</span>
    imap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>C<span class="p">-</span>z<span class="p">&gt;</span>     <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>unite_toggle_transpose_window<span class="p">)</span>
    imap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>C<span class="p">-</span><span class="k">y</span><span class="p">&gt;</span>     <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>unite_narrowing_path<span class="p">)</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>C<span class="p">-</span><span class="k">y</span><span class="p">&gt;</span>     <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>unite_narrowing_path<span class="p">)</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>C<span class="p">-</span><span class="k">j</span><span class="p">&gt;</span>     <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>unite_toggle_auto_preview<span class="p">)</span>

    nmap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="k">f</span> unite#do_action<span class="p">(</span><span class="s1">'vimfiler'</span><span class="p">)</span>

<span class="c">    " grep bufferの時はrをreplaceアクションにマップする</span>
    <span class="k">let</span> unite <span class="p">=</span> unite#get_current_unite<span class="p">()</span>
    <span class="k">if</span> unite.buffer_name <span class="p">=~</span># <span class="s1">'^grep'</span>
      <span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="k">r</span>     unite#do_action<span class="p">(</span><span class="s1">'replace'</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="k">r</span>     unite#do_action<span class="p">(</span><span class="s1">'rename'</span><span class="p">)</span>
    <span class="k">endif</span>

    <span class="nb">nnoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> S      unite#mappings#set_current_filters<span class="p">(</span>
            \ empty<span class="p">(</span>unite#mappings#get_current_filters<span class="p">())</span> ? [<span class="s1">'sorter_reverse'</span>] : []<span class="p">)</span>
  <span class="k">endfunction</span>
  MyAutocmd <span class="nb">FileType</span> unite <span class="k">call</span> s:unite_my_settings<span class="p">()</span>
<span class="k">endfunction</span>
unlet s:bundle
<span class="c">" }}}</span>


<span class="c">" Gist.vim {{{</span>
<span class="nb">nnoremap</span> [gist] <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
nmap <span class="p">,</span>s [gist]
<span class="nb">nnoremap</span> [gist]<span class="k">g</span> :Gist<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [gist]<span class="k">p</span> :Gist <span class="p">-</span><span class="k">p</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [gist]<span class="k">e</span> :Gist <span class="p">-</span><span class="k">e</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [gist]<span class="k">d</span> :Gist <span class="p">-</span><span class="k">d</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [gist]<span class="k">l</span> :Gist <span class="p">-</span><span class="k">l</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s2">"gist-vim"</span><span class="p">)</span>
<span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
  <span class="k">if</span> has<span class="p">(</span><span class="s2">"mac"</span><span class="p">)</span>
    <span class="k">let</span> <span class="k">g</span>:gist_clip_command <span class="p">=</span> <span class="s1">'pbcopy'</span>
  <span class="k">elseif</span> has<span class="p">(</span><span class="s2">"unix"</span><span class="p">)</span>
    <span class="k">let</span> <span class="k">g</span>:gist_clip_command <span class="p">=</span> <span class="s1">'xclip -selection clipboard'</span>
  <span class="k">endif</span>

  <span class="k">let</span> <span class="k">g</span>:gist_detect_filetype <span class="p">=</span> <span class="m">1</span>
  <span class="k">let</span> <span class="k">g</span>:gist_open_browser_after_post <span class="p">=</span> <span class="m">1</span>
  <span class="k">let</span> <span class="k">g</span>:gist_show_privates <span class="p">=</span> <span class="m">1</span>
<span class="k">endfunction</span>
unlet s:bundle
<span class="c">" }}}</span>

<span class="c">" Fugitive {{{</span>
<span class="nb">nnoremap</span> [git] <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
nmap <span class="p">,</span><span class="k">g</span> [git]
<span class="nb">nnoremap</span> [git]<span class="k">d</span> :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Gdiff HEAD<span class="p">&lt;</span>Enter<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [git]s :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Gstatus<span class="p">&lt;</span>Enter<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [git]<span class="k">l</span> :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Glog<span class="p">&lt;</span>Enter<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [git]<span class="k">a</span> :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Gwrite<span class="p">&lt;</span>Enter<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [git]<span class="k">c</span> :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Gcommit<span class="p">&lt;</span>Enter<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [git]C :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Git commit <span class="p">--</span>amend<span class="p">&lt;</span>Enter<span class="p">&gt;</span>
<span class="nb">nnoremap</span> [git]<span class="k">b</span> :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Gblame<span class="p">&lt;</span>Enter<span class="p">&gt;</span>

<span class="c">" ftdetect is often failed</span>
MyAutocmd <span class="nb">BufEnter</span> * <span class="k">if</span> expand<span class="p">(</span><span class="s2">"%"</span><span class="p">)</span> <span class="p">=~</span> <span class="s2">".git/COMMIT_EDITMSG"</span> <span class="p">|</span> <span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>gitcommit <span class="p">|</span> <span class="k">endif</span>
MyAutocmd <span class="nb">BufEnter</span> * <span class="k">if</span> expand<span class="p">(</span><span class="s2">"%"</span><span class="p">)</span> <span class="p">=~</span> <span class="s2">".git/rebase-merge"</span> <span class="p">|</span> <span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>gitrebase <span class="p">|</span> <span class="k">endif</span>
<span class="c">" }}}</span>

<span class="c">" project.vim</span>
<span class="k">let</span> <span class="k">g</span>:proj_window_width <span class="p">=</span> <span class="m">48</span>

<span class="c">" vimfiler {{{</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">,</span>vf :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>VimFiler<span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s1">'vimfiler'</span><span class="p">)</span>
<span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
  <span class="k">let</span> <span class="k">g</span>:vimfiler_as_default_explorer <span class="p">=</span> <span class="m">1</span>
  <span class="k">let</span> <span class="k">g</span>:vimfiler_max_directory_histories <span class="p">=</span> <span class="m">100</span>
  <span class="k">function</span> s:ChangeVimfilerKeymap<span class="p">()</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">a</span> <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>vimfiler_toggle_mark_all_lines<span class="p">)</span>

<span class="c">    " j k 移動でループしないように</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">j</span> <span class="k">j</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">k</span> <span class="k">k</span>

    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> s <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>vimfiler_select_sort_type<span class="p">)</span>
    nmap <span class="p">&lt;</span>End<span class="p">&gt;</span> <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>vimfiler_clear_mark_all_lines<span class="p">)</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> @ <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>vimfiler_set_current_mask<span class="p">)</span>
    nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> V <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>vimfiler_quick_look<span class="p">)</span>
  <span class="k">endfunction</span>
  MyAutocmd <span class="nb">FileType</span> vimfiler <span class="k">call</span> s:ChangeVimfilerKeymap<span class="p">()</span>

  <span class="k">if</span> filereadable<span class="p">(</span>expand<span class="p">(</span><span class="s1">'~/.vimfiler.local'</span><span class="p">))</span>
    execute <span class="s1">'source'</span> expand<span class="p">(</span><span class="s1">'~/.vimfiler.local'</span><span class="p">)</span>
  <span class="k">endif</span>
<span class="k">endfunction</span>
unlet s:bundle
<span class="c">" }}}</span>

<span class="c">" vimshell {{{</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">,</span><span class="k">vs</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>VimShell<span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="k">function</span><span class="p">!</span> <span class="k">g</span>:my_chpwd<span class="p">(</span>args<span class="p">,</span> context<span class="p">)</span>
  <span class="k">call</span> vimshell#execute<span class="p">(</span><span class="s1">'ls'</span><span class="p">)</span>
<span class="k">endfunction</span>

<span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s2">"vimshell"</span><span class="p">)</span>
<span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
  <span class="k">if</span> has<span class="p">(</span><span class="s1">'win32'</span><span class="p">)</span> <span class="p">||</span> has<span class="p">(</span><span class="s1">'win64'</span><span class="p">)</span>
<span class="c">    " Display user name on Windows.</span>
    <span class="k">let</span> <span class="k">g</span>:vimshell_prompt <span class="p">=</span> $USERNAME.<span class="s2">"% "</span>
  <span class="k">else</span>
    <span class="k">let</span> <span class="k">g</span>:vimshell_prompt <span class="p">=</span> $USER . <span class="s2">"@"</span> . hostname<span class="p">()</span> . <span class="s2">"% "</span>
    <span class="k">if</span> has<span class="p">(</span><span class="s1">'mac'</span><span class="p">)</span>
      <span class="k">call</span> vimshell#set_execute_file<span class="p">(</span><span class="s1">'html'</span><span class="p">,</span> <span class="s1">'gexe open -a /Applications/Firefox.app/Contents/MacOS/firefox'</span><span class="p">)</span>
      <span class="k">call</span> vimshell#set_execute_file<span class="p">(</span><span class="s1">'avi,mp4,mpg,ogm,mkv,wmv,mov'</span><span class="p">,</span> <span class="s1">'gexe open -a /Applications/MPlayerX.app/Contents/MacOS/MPlayerX'</span><span class="p">)</span>
    <span class="k">endif</span>
  <span class="k">endif</span>
<span class="c">  "let g:vimshell_right_prompt = 'vimshell#vcs#info("(%s)-[%b] ", "(%s)-[%b|%a] ") . "[" . getcwd() . "]"'</span>
  <span class="k">let</span> <span class="k">g</span>:vimshell_right_prompt <span class="p">=</span> <span class="s1">'"[" . getcwd() . "]"'</span>
  <span class="k">let</span> <span class="k">g</span>:vimshell_max_command_history <span class="p">=</span> <span class="m">3000</span>

  MyAutocmd <span class="nb">FileType</span> vimshell
    \ <span class="k">call</span> vimshell#altercmd#<span class="nb">define</span><span class="p">(</span><span class="s1">'g'</span><span class="p">,</span> <span class="s1">'git'</span><span class="p">)</span>
    \<span class="p">|</span> <span class="k">call</span> vimshell#altercmd#<span class="nb">define</span><span class="p">(</span><span class="s1">'l'</span><span class="p">,</span> <span class="s1">'ll'</span><span class="p">)</span>
    \<span class="p">|</span> <span class="k">call</span> vimshell#altercmd#<span class="nb">define</span><span class="p">(</span><span class="s1">'ll'</span><span class="p">,</span> <span class="s1">'ls -l'</span><span class="p">)</span>
    \<span class="p">|</span> <span class="k">call</span> vimshell#altercmd#<span class="nb">define</span><span class="p">(</span><span class="s1">'be'</span><span class="p">,</span> <span class="s1">'bundle exec'</span><span class="p">)</span>
    \<span class="p">|</span> <span class="k">call</span> vimshell#altercmd#<span class="nb">define</span><span class="p">(</span><span class="s1">'ra'</span><span class="p">,</span> <span class="s1">'rails'</span><span class="p">)</span>
    \<span class="p">|</span> <span class="k">call</span> vimshell#hook#add<span class="p">(</span><span class="s1">'chpwd'</span><span class="p">,</span> <span class="s1">'my_chpwd'</span><span class="p">,</span> <span class="s1">'g:my_chpwd'</span><span class="p">)</span>

  <span class="k">function</span><span class="p">!</span> s:EarthquakeKeyMap<span class="p">()</span>
    <span class="nb">nnoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;&lt;</span>expr<span class="p">&gt;</span> <span class="k">o</span> OpenBrowserLine<span class="p">()</span>
  <span class="k">endfunction</span>
  MyAutocmd <span class="nb">FileType</span> int<span class="p">-</span>earthquake <span class="k">call</span> s:EarthquakeKeyMap<span class="p">()</span>
<span class="k">endfunction</span>
unlet s:bundle
<span class="c">" }}}</span>

<span class="c">" rubycomplete.vim {{{</span>
MyAutocmd <span class="nb">FileType</span> <span class="k">ruby</span><span class="p">,</span>eruby <span class="k">setlocal</span> <span class="nb">omnifunc</span><span class="p">=</span>rubycomplete#Complete
<span class="k">let</span> <span class="k">g</span>:rubycomplete_rails <span class="p">=</span> <span class="m">0</span>
<span class="k">let</span> <span class="k">g</span>:rubycomplete_buffer_loading <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:rubycomplete_classes_in_global <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:rubycomplete_include_object <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:rubycomplete_include_object_space <span class="p">=</span> <span class="m">1</span>
<span class="c">" let ruby_operators = 1</span>
<span class="c">" }}}</span>

<span class="c">" For snippet_complete marker.</span>
<span class="k">if</span> has<span class="p">(</span><span class="s1">'conceal'</span><span class="p">)</span>
  <span class="k">set</span> <span class="nb">conceallevel</span><span class="p">=</span><span class="m">2</span> <span class="nb">concealcursor</span><span class="p">=</span><span class="k">i</span>
<span class="k">endif</span>

<span class="c">" neosnippet {{{</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Space<span class="p">&gt;</span><span class="k">se</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>NeoSnippetEdit<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s1">'neosnippet'</span><span class="p">)</span>
<span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
  <span class="k">let</span> <span class="k">g</span>:neosnippet#snippets_directory <span class="p">=</span> $HOME . <span class="s1">'/.vim/snippets'</span>

<span class="c">  " enable ruby &amp; rails snippet only rails file</span>
  <span class="k">function</span><span class="p">!</span> s:RailsSnippet<span class="p">()</span>
    <span class="k">if</span> exists<span class="p">(</span><span class="s2">"b:rails_root"</span><span class="p">)</span> &amp;&amp; <span class="p">(</span>&amp;<span class="k">filetype</span> <span class="p">==</span> <span class="s2">"ruby"</span><span class="p">)</span>
      NeoSnippetSource <span class="p">~</span><span class="sr">/.vim/</span>snippets/rails.snip
    <span class="k">endif</span>
  <span class="k">endfunction</span>

  <span class="k">function</span><span class="p">!</span> s:RSpecSnippet<span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span>expand<span class="p">(</span><span class="s2">"%"</span><span class="p">)</span> <span class="p">=~</span> <span class="s2">"_spec\.rb$"</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span>expand<span class="p">(</span><span class="s2">"%"</span><span class="p">)</span> <span class="p">=~</span> <span class="s2">"^spec.*\.rb$"</span><span class="p">)</span>
      NeoSnippetSource <span class="p">~</span><span class="sr">/.vim/</span>snippets/rspec.snip
    <span class="k">endif</span>
  <span class="k">endfunction</span>

  MyAutocmd <span class="nb">BufEnter</span> * <span class="k">call</span> s:RailsSnippet<span class="p">()</span>
  MyAutocmd <span class="nb">BufEnter</span> * <span class="k">call</span> s:RSpecSnippet<span class="p">()</span>
<span class="k">endfunction</span>
unlet s:bundle
<span class="c">" }}}</span>

<span class="c">" neocomplcache or neocomplete {{{</span>

<span class="c">" Enable omni completion.</span>
MyAutocmd <span class="nb">FileType</span> css<span class="p">,</span>scss <span class="k">setlocal</span> <span class="nb">omnifunc</span><span class="p">=</span>csscomplete#CompleteCSS
MyAutocmd <span class="nb">FileType</span> html<span class="p">,</span>markdown <span class="k">setlocal</span> <span class="nb">omnifunc</span><span class="p">=</span>htmlcomplete#CompleteTags
MyAutocmd <span class="nb">FileType</span> javascript <span class="k">setlocal</span> <span class="nb">omnifunc</span><span class="p">=</span>javascriptcomplete#CompleteJS
MyAutocmd <span class="nb">FileType</span> python <span class="k">setlocal</span> <span class="nb">omnifunc</span><span class="p">=</span>pythoncomplete#Complete
MyAutocmd <span class="nb">FileType</span> xml <span class="k">setlocal</span> <span class="nb">omnifunc</span><span class="p">=</span>xmlcomplete#CompleteTags
MyAutocmd <span class="nb">FileType</span> sql <span class="k">setlocal</span> <span class="nb">omnifunc</span><span class="p">=</span>sqlcomplete#Complete

<span class="k">if</span> has<span class="p">(</span><span class="s1">'lua'</span><span class="p">)</span>
  <span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s1">'neocomplete'</span><span class="p">)</span>
  <span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
<span class="c">    " Disable AutoComplPop.</span>
    <span class="k">let</span> <span class="k">g</span>:acp_enableAtStartup <span class="p">=</span> <span class="m">0</span>
<span class="c">    " Use neocomplete.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#enable_at_startup <span class="p">=</span> <span class="m">1</span>
<span class="c">    " Use smartcase.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#enable_smart_case <span class="p">=</span> <span class="m">1</span>

<span class="c">    " Set minimum syntax keyword length.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#auto_completion_start_length <span class="p">=</span> <span class="m">2</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#manual_completion_start_length <span class="p">=</span> <span class="m">0</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#<span class="nb">syntax</span>#min_keyword_length <span class="p">=</span> <span class="m">3</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#min_keyword_length <span class="p">=</span> <span class="m">2</span>

    <span class="k">let</span> <span class="k">g</span>:neocomplete#enable_prefetch <span class="p">=</span> <span class="m">1</span>

<span class="c">    " Define dictionary.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#<span class="nb">dictionary</span>#dictionaries <span class="p">=</span> {
    \ <span class="s1">'default'</span> : <span class="s1">''</span><span class="p">,</span>
    \ <span class="s1">'vimshell'</span> : $HOME . <span class="s1">'/.vimshell/command-history'</span><span class="p">,</span>
    \ }

<span class="c">    " キャッシュしないファイル名</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#buffer#disabled_pattern <span class="p">=</span> <span class="s1">'\.log\|\.log\.\|\.jax'</span>
<span class="c">    " 自動補完を行わないバッファ名</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#lock_buffer_name_pattern <span class="p">=</span> <span class="s1">'\.log\|\.log\.\|.*quickrun.*\|.jax'</span>

<span class="c">    " Define keyword.</span>
    <span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">'g:neocomplete#keyword_patterns'</span><span class="p">)</span>
        <span class="k">let</span> <span class="k">g</span>:neocomplete#keyword_patterns <span class="p">=</span> {}
    <span class="k">endif</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#keyword_patterns[<span class="s1">'default'</span>] <span class="p">=</span> <span class="s1">'\h\w*'</span>


<span class="c">    " Plugin key-mappings.</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>C<span class="p">-</span><span class="k">l</span><span class="p">&gt;</span> neocomplete#complete_common_string<span class="p">()</span>

<span class="c">    " SuperTab like snippets behavior.</span>
    imap <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>TAB<span class="p">&gt;</span> neosnippet#expandable_or_jumpable<span class="p">()</span> ? <span class="s2">"\&lt;Plug&gt;(neosnippet_expand_or_jump)"</span> : pumvisible<span class="p">()</span> ? <span class="s2">"\&lt;C-n&gt;"</span> : <span class="s2">"\&lt;TAB&gt;"</span>
    <span class="k">smap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>TAB<span class="p">&gt;</span> neosnippet#expandable_or_jumpable<span class="p">()</span> ? <span class="s2">"\&lt;Plug&gt;(neosnippet_expand_or_jump)"</span> : <span class="s2">"\&lt;TAB&gt;"</span>

<span class="c">    " Recommended key-mappings.</span>
<span class="c">    " &lt;CR&gt;: close popup and save indent.</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>CR<span class="p">&gt;</span> neocomplete#smart_close_popup<span class="p">()</span> . <span class="s2">"\&lt;CR&gt;"</span>

<span class="c">    " &lt;C-h&gt;, &lt;BS&gt;: close popup and delete backword char.</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>C<span class="p">-</span><span class="k">h</span><span class="p">&gt;</span> neocomplete#smart_close_popup<span class="p">()</span>.<span class="s2">"\&lt;C-h&gt;"</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>BS<span class="p">&gt;</span>  neocomplete#smart_close_popup<span class="p">()</span>.<span class="s2">"\&lt;C-h&gt;"</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>C<span class="p">-</span><span class="k">y</span><span class="p">&gt;</span> neocomplete#close_popup<span class="p">()</span>

<span class="c">    " AutoComplPop like behavior.</span>
<span class="c">    "let g:neocomplete#enable_auto_select = 1</span>

<span class="c">    " Enable heavy omni completion.</span>
    <span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">'g:neocomplete#sources#omni#input_patterns'</span><span class="p">)</span>
      <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#omni#input_patterns <span class="p">=</span> {}
    <span class="k">endif</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#omni#input_patterns.<span class="k">ruby</span> <span class="p">=</span> <span class="s1">'[^. *\t]\.\h\w*\|\h\w*::'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#omni#input_patterns.php <span class="p">=</span> <span class="s1">'[^. \t]-&gt;\h\w*\|\h\w*::'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#omni#input_patterns.<span class="k">c</span> <span class="p">=</span> <span class="s1">'\%(\.\|-&gt;\)\h\w*'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#omni#input_patterns.cpp <span class="p">=</span> <span class="s1">'\h\w*\%(\.\|-&gt;\)\h\w*\|\h\w*::'</span>

<span class="c">    " for TweetVim スクリーン名のキャッシュを利用して、neocomplcache で補完する</span>
    <span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">'g:neocomplete#sources#dictionary#dictionaries'</span><span class="p">)</span>
      <span class="k">let</span> <span class="k">g</span>:neocomplete#sources#<span class="nb">dictionary</span>#dictionaries <span class="p">=</span> {}
    <span class="k">endif</span>
    <span class="k">let</span> neco_dic <span class="p">=</span> <span class="k">g</span>:neocomplete#sources#<span class="nb">dictionary</span>#dictionaries
    <span class="k">let</span> neco_dic.tweetvim_say <span class="p">=</span> $HOME . <span class="s1">'/.tweetvim/screen_name'</span>

<span class="c">    " use clang_complete</span>
    <span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">'g:neocomplete#force_omni_input_patterns'</span><span class="p">)</span>
      <span class="k">let</span> <span class="k">g</span>:neocomplete#force_omni_input_patterns <span class="p">=</span> {}
    <span class="k">endif</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#force_overwrite_completefunc <span class="p">=</span> <span class="m">1</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#force_omni_input_patterns.<span class="k">c</span> <span class="p">=</span>
          \ <span class="s1">'[^.[:digit:] *\t]\%(\.\|-&gt;\)\w*'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#force_omni_input_patterns.cpp <span class="p">=</span>
          \ <span class="s1">'[^.[:digit:] *\t]\%(\.\|-&gt;\)\w*\|\h\w*::\w*'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#force_omni_input_patterns.objc <span class="p">=</span>
          \ <span class="s1">'[^.[:digit:] *\t]\%(\.\|-&gt;\)\w*'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplete#force_omni_input_patterns.objcpp <span class="p">=</span>
          \ <span class="s1">'[^.[:digit:] *\t]\%(\.\|-&gt;\)\w*\|\h\w*::\w*'</span>

<span class="c">    " clang_complete</span>
    <span class="k">let</span> <span class="k">g</span>:clang_complete_auto <span class="p">=</span> <span class="m">0</span>
    <span class="k">let</span> <span class="k">g</span>:clang_auto_select <span class="p">=</span> <span class="m">0</span>
<span class="c">    "let g:clang_use_library = 1</span>
  <span class="k">endfunction</span>
  unlet s:bundle
<span class="k">else</span>
  <span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s1">'neocomplcache'</span><span class="p">)</span>
  <span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
<span class="c">    " Disable AutoComplPop.</span>
    <span class="k">let</span> <span class="k">g</span>:acp_enableAtStartup <span class="p">=</span> <span class="m">0</span>
<span class="c">    " Use neocomplcache.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_enable_at_startup <span class="p">=</span> <span class="m">1</span>
<span class="c">    " Use smartcase.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_enable_smart_case <span class="p">=</span> <span class="m">1</span>
<span class="c">    " Use camel case completion.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_enable_camel_case_completion <span class="p">=</span> <span class="m">1</span>
<span class="c">    " Use underbar completion.</span>
<span class="c">    "let g:neocomplcache_enable_underbar_completion = 1</span>
<span class="c">    " Use fuzzy completion.</span>
<span class="c">    " let g:neocomplcache_enable_fuzzy_completion = 1</span>
<span class="c">    " filename width</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_max_menu_width <span class="p">=</span> <span class="m">40</span>
<span class="c">    " Set minimum syntax keyword length.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_auto_completion_start_length <span class="p">=</span> <span class="m">2</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_manual_completion_start_length <span class="p">=</span> <span class="m">0</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_min_syntax_length <span class="p">=</span> <span class="m">3</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_min_keyword_length <span class="p">=</span> <span class="m">2</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_plugin_completion_length <span class="p">=</span> {
    \ <span class="s1">'snippets_complete'</span> : <span class="m">1</span><span class="p">,</span>
    \ }
<span class="c">    " let g:neocomplcache_lock_buffer_name_pattern = '\*ku\*'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_enable_prefetch <span class="p">=</span> <span class="m">1</span>

<span class="c">    " Define dictionary.</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_dictionary_filetype_lists <span class="p">=</span> {
    \ <span class="s1">'default'</span> : <span class="s1">''</span><span class="p">,</span>
    \ <span class="s1">'vimshell'</span> : $HOME . <span class="s1">'/.vimshell/command-history'</span><span class="p">,</span>
    \ }

<span class="c">    " キャッシュしないファイル名</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_disable_caching_file_path_pattern <span class="p">=</span> <span class="s1">'\.log\|\.log\.\|\.jax'</span>
<span class="c">    " 自動補完を行わないバッファ名</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_lock_buffer_name_pattern <span class="p">=</span> <span class="s1">'\.log\|\.log\.\|.*quickrun.*\|.jax'</span>

<span class="c">    " Define keyword.</span>
    <span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">'g:neocomplcache_keyword_patterns'</span><span class="p">)</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_keyword_patterns <span class="p">=</span> {}
    <span class="k">endif</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_keyword_patterns[<span class="s1">'default'</span>] <span class="p">=</span> <span class="s1">'\h\w*'</span>

<span class="c">    " Plugin key-mappings.</span>
<span class="c">    "imap &lt;C-k&gt; &lt;Plug&gt;(neosnippet_expand_or_jump)</span>
<span class="c">    "smap &lt;C-k&gt; &lt;Plug&gt;(neosnippet_expand_or_jump)</span>
<span class="c">    "inoremap &lt;expr&gt;&lt;C-g&gt; neocomplcache#undo_completion()</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>C<span class="p">-</span><span class="k">l</span><span class="p">&gt;</span> neocomplcache#complete_common_string<span class="p">()</span>

<span class="c">    " SuperTab like snippets behavior.</span>
    imap <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>TAB<span class="p">&gt;</span> neosnippet#expandable_or_jumpable<span class="p">()</span> ? <span class="s2">"\&lt;Plug&gt;(neosnippet_expand_or_jump)"</span> : pumvisible<span class="p">()</span> ? <span class="s2">"\&lt;C-n&gt;"</span> : <span class="s2">"\&lt;TAB&gt;"</span>
    <span class="k">smap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>TAB<span class="p">&gt;</span> neosnippet#expandable_or_jumpable<span class="p">()</span> ? <span class="s2">"\&lt;Plug&gt;(neosnippet_expand_or_jump)"</span> : <span class="s2">"\&lt;TAB&gt;"</span>

<span class="c">    " Recommended key-mappings.</span>
<span class="c">    " &lt;CR&gt;: close popup and save indent.</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>CR<span class="p">&gt;</span> neocomplcache#smart_close_popup<span class="p">()</span> . <span class="s2">"\&lt;CR&gt;"</span>
<span class="c">    " &lt;TAB&gt;: completion.</span>
<span class="c">    "inoremap &lt;expr&gt;&lt;TAB&gt; pumvisible() ? "\&lt;C-n&gt;" : "\&lt;TAB&gt;"</span>
<span class="c">    " &lt;C-h&gt;, &lt;BS&gt;: close popup and delete backword char.</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>C<span class="p">-</span><span class="k">h</span><span class="p">&gt;</span> neocomplcache#smart_close_popup<span class="p">()</span>.<span class="s2">"\&lt;C-h&gt;"</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>BS<span class="p">&gt;</span> neocomplcache#smart_close_popup<span class="p">()</span>.<span class="s2">"\&lt;C-h&gt;"</span>
    <span class="nb">inoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>C<span class="p">-</span><span class="k">y</span><span class="p">&gt;</span> neocomplcache#close_popup<span class="p">()</span>
<span class="c">    "inoremap &lt;expr&gt;&lt;C-e&gt; neocomplcache#cancel_popup()</span>

<span class="c">    " AutoComplPop like behavior.</span>
<span class="c">    "let g:neocomplcache_enable_auto_select = 1</span>

<span class="c">    " Shell like behavior(not recommended).</span>
<span class="c">    "setlocal completeopt+=longest</span>
<span class="c">    "let g:neocomplcache_enable_auto_select = 1</span>
<span class="c">    "let g:neocomplcache_disable_auto_complete = 1</span>
<span class="c">    "inoremap &lt;expr&gt;&lt;TAB&gt; pumvisible() ? "\&lt;Down&gt;" : "\&lt;TAB&gt;"</span>
<span class="c">    "inoremap &lt;expr&gt;&lt;CR&gt; neocomplcache#smart_close_popup() . "\&lt;CR&gt;"</span>

<span class="c">    " Enable heavy omni completion.</span>
    <span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">'g:neocomplcache_omni_patterns'</span><span class="p">)</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_omni_patterns <span class="p">=</span> {}
    <span class="k">endif</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_omni_patterns.<span class="k">ruby</span> <span class="p">=</span> <span class="s1">'[^. *\t]\.\h\w*\|\h\w*::'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_omni_patterns.php <span class="p">=</span> <span class="s1">'[^. \t]-&gt;\h\w*\|\h\w*::'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_omni_patterns.<span class="k">c</span> <span class="p">=</span> <span class="s1">'\%(\.\|-&gt;\)\h\w*'</span>
    <span class="k">let</span> <span class="k">g</span>:neocomplcache_omni_patterns.cpp <span class="p">=</span> <span class="s1">'\h\w*\%(\.\|-&gt;\)\h\w*\|\h\w*::'</span>

<span class="c">    " for TweetVim スクリーン名のキャッシュを利用して、neocomplcache で補完する</span>
    <span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">'g:neocomplcache_dictionary_filetype_lists'</span><span class="p">)</span>
      <span class="k">let</span> <span class="k">g</span>:neocomplcache_dictionary_filetype_lists <span class="p">=</span> {}
    <span class="k">endif</span>
    <span class="k">let</span> neco_dic <span class="p">=</span> <span class="k">g</span>:neocomplcache_dictionary_filetype_lists
    <span class="k">let</span> neco_dic.tweetvim_say <span class="p">=</span> $HOME . <span class="s1">'/.tweetvim/screen_name'</span>
  <span class="k">endfunction</span>
  unlet s:bundle
<span class="k">endif</span>
<span class="c">" }}}</span>

<span class="c">" ref.vim</span>
<span class="k">let</span> <span class="k">g</span>:ref_open <span class="p">=</span> <span class="s1">'vsplit'</span>
<span class="k">let</span> <span class="k">g</span>:ref_refe_cmd <span class="p">=</span> <span class="s2">"rurema"</span>
<span class="k">let</span> <span class="k">g</span>:ref_refe_version <span class="p">=</span> <span class="m">2</span>

<span class="k">let</span> <span class="k">g</span>:ref_source_webdict_sites <span class="p">=</span> {
\   <span class="s1">'wikipedia:ja'</span>: <span class="s1">'http://ja.wikipedia.org/wiki/%s'</span><span class="p">,</span>
\   <span class="s1">'weblio'</span>: <span class="s1">'http://ejje.weblio.jp/content/%s'</span><span class="p">,</span>
\ }

nmap <span class="p">,</span>rr :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>Ref refe<span class="p">&lt;</span>Space<span class="p">&gt;</span>

<span class="c">" indent-guides {{{</span>
<span class="k">let</span> <span class="k">g</span>:indent_guides_enable_on_vim_startup <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:indent_guides_guide_size <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:indent_guides_auto_colors <span class="p">=</span> <span class="m">0</span>
autocmd <span class="nb">VimEnter</span><span class="p">,</span>Colorscheme * :<span class="k">hi</span> IndentGuidesOdd  guibg<span class="p">=</span>DarkGrey   ctermbg<span class="p">=</span>darkgrey
autocmd <span class="nb">VimEnter</span><span class="p">,</span>Colorscheme * :<span class="k">hi</span> IndentGuidesEven guibg<span class="p">=</span>DarkCyan ctermbg<span class="p">=</span><span class="m">12</span>
<span class="c">" }}}</span>

<span class="c">" submode.vim {{{</span>
<span class="k">let</span> <span class="k">g</span>:submode_timeout <span class="p">=</span> <span class="m">0</span>
<span class="k">call</span> submode#enter_with<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&lt;Leader&gt;w'</span><span class="p">)</span>
<span class="k">call</span> submode#enter_with<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;-'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;-'</span><span class="p">)</span>
<span class="k">call</span> submode#enter_with<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;+'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;+'</span><span class="p">)</span>
<span class="k">call</span> submode#enter_with<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;&gt;'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;&gt;'</span><span class="p">)</span>
<span class="k">call</span> submode#enter_with<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;&lt;'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;&lt;'</span><span class="p">)</span>
<span class="k">call</span> submode#leave_with<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&lt;Esc&gt;'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;-'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'+'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;+'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&lt;'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;&lt;'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;&gt;'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;='</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;r'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;R'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;x'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'j'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;j'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'k'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;k'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'l'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;l'</span><span class="p">)</span>
<span class="k">call</span> submode#map<span class="p">(</span><span class="s1">'window/manip'</span><span class="p">,</span> <span class="s1">'n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'h'</span><span class="p">,</span> <span class="s1">'&lt;C-W&gt;h'</span><span class="p">)</span>
<span class="c">" }}}</span>

<span class="c">" vim-altr {{{</span>
nmap <span class="p">&lt;</span>F3<span class="p">&gt;</span> <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>altr<span class="p">-</span>forward<span class="p">)</span>
nmap <span class="p">&lt;</span>F2<span class="p">&gt;</span> <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>altr<span class="p">-</span>back<span class="p">)</span>

<span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s2">"vim-altr"</span><span class="p">)</span>
<span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
<span class="c">  " For ruby tdd</span>
  <span class="k">call</span> altr#<span class="nb">define</span><span class="p">(</span><span class="s1">'%.rb'</span><span class="p">,</span> <span class="s1">'spec/%_spec.rb'</span><span class="p">)</span>
<span class="c">  " For ruby tdd</span>
  <span class="k">call</span> altr#<span class="nb">define</span><span class="p">(</span><span class="s1">'lib/%.rb'</span><span class="p">,</span> <span class="s1">'spec/lib/%_spec.rb'</span><span class="p">,</span> <span class="s1">'spec/%_spec.rb'</span><span class="p">)</span>
<span class="c">  " For rails tdd</span>
  <span class="k">call</span> altr#<span class="nb">define</span><span class="p">(</span><span class="s1">'app/models/%.rb'</span><span class="p">,</span> <span class="s1">'spec/models/%_spec.rb'</span><span class="p">,</span> <span class="s1">'spec/factories/%s.rb'</span><span class="p">)</span>
  <span class="k">call</span> altr#<span class="nb">define</span><span class="p">(</span><span class="s1">'app/controllers/%.rb'</span><span class="p">,</span> <span class="s1">'spec/controllers/%_spec.rb'</span><span class="p">)</span>
  <span class="k">call</span> altr#<span class="nb">define</span><span class="p">(</span><span class="s1">'app/helpers/%.rb'</span><span class="p">,</span> <span class="s1">'spec/helpers/%_spec.rb'</span><span class="p">)</span>
<span class="k">endfunction</span>
unlet s:bundle
<span class="c">" }}}</span>

<span class="c">" toggle.vim {{{</span>
imap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;&lt;</span>C<span class="p">-</span>C<span class="p">&gt;</span> <span class="p">&lt;</span>Plug<span class="p">&gt;</span>ToggleI
nmap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;&lt;</span>C<span class="p">-</span>C<span class="p">&gt;</span> <span class="p">&lt;</span>Plug<span class="p">&gt;</span>ToggleN
vmap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;&lt;</span>C<span class="p">-</span>C<span class="p">&gt;</span> <span class="p">&lt;</span>Plug<span class="p">&gt;</span>ToggleV

<span class="k">let</span> <span class="k">g</span>:toggle_pairs <span class="p">=</span> {
  \<span class="s1">'and'</span>:<span class="s1">'or'</span><span class="p">,</span>
  \<span class="s1">'or'</span>:<span class="s1">'and'</span><span class="p">,</span>
  \<span class="s1">'if'</span>:<span class="s1">'unless'</span><span class="p">,</span>
  \<span class="s1">'unless'</span>:<span class="s1">'if'</span><span class="p">,</span>
  \<span class="s1">'elsif'</span>:<span class="s1">'else'</span><span class="p">,</span>
  \<span class="s1">'else'</span>:<span class="s1">'elsif'</span><span class="p">,</span>
  \<span class="s1">'it'</span>:<span class="s1">'specify'</span><span class="p">,</span>
  \<span class="s1">'specify'</span>:<span class="s1">'it'</span><span class="p">,</span>
  \<span class="s1">'describe'</span>:<span class="s2">"context"</span><span class="p">,</span>
  \<span class="s1">'context'</span>:<span class="s2">"describe"</span><span class="p">,</span>
  \<span class="s1">'true'</span>:<span class="s1">'false'</span><span class="p">,</span>
  \<span class="s1">'false'</span>:<span class="s1">'true'</span><span class="p">,</span>
  \<span class="s1">'yes'</span>:<span class="s1">'no'</span><span class="p">,</span>
  \<span class="s1">'no'</span>:<span class="s1">'yes'</span><span class="p">,</span>
  \<span class="s1">'on'</span>:<span class="s1">'off'</span><span class="p">,</span>
  \<span class="s1">'off'</span>:<span class="s1">'on'</span><span class="p">,</span>
  \<span class="s1">'public'</span>:<span class="s1">'protected'</span><span class="p">,</span>
  \<span class="s1">'protected'</span>:<span class="s1">'private'</span><span class="p">,</span>
  \<span class="s1">'private'</span>:<span class="s1">'public'</span><span class="p">,</span>
  \<span class="s1">'&amp;&amp;'</span>:<span class="s1">'||'</span><span class="p">,</span>
  \<span class="s1">'||'</span>:<span class="s1">'&amp;&amp;'</span>
\}
<span class="c">" }}}</span>

<span class="c">" RSpec syntax {{{</span>
<span class="k">function</span><span class="p">!</span> RSpecSyntax<span class="p">()</span>
  <span class="k">hi</span> <span class="nb">def</span> link rubyRailsTestMethod             Function
  <span class="k">syn</span> keyword rubyRailsTestMethod describe context it its specify shared_examples_for shared_examples shared_context it_should_behave_like it_behaves_like before after around subject fixtures controller_name helper_name include_context include_examples
  <span class="k">syn</span> <span class="k">match</span> rubyRailsTestMethod <span class="s1">'\&lt;let\&gt;!\='</span>
  <span class="k">syn</span> keyword rubyRailsTestMethod violated pending expect double mock mock_model stub_model an_instance_of hash_including
  <span class="k">syn</span> <span class="k">match</span> rubyRailsTestMethod <span class="s1">'\.\@&lt;!\&lt;stub\&gt;!\@!'</span>
<span class="k">endfunction</span>
MyAutocmd <span class="nb">Syntax</span> <span class="k">ruby</span> <span class="k">if</span> <span class="p">(</span>expand<span class="p">(</span><span class="s2">"%"</span><span class="p">)</span> <span class="p">=~</span> <span class="s2">"_spec\.rb$"</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span>expand<span class="p">(</span><span class="s2">"%"</span><span class="p">)</span> <span class="p">=~</span> <span class="s2">"^spec.*\.rb$"</span><span class="p">)</span> <span class="p">|</span> <span class="k">call</span> RSpecSyntax<span class="p">()</span> <span class="p">|</span> <span class="k">endif</span>
<span class="c">" }}}</span>

<span class="c">" Quickfix</span>
augroup quickfixopen
  autocmd<span class="p">!</span>
  autocmd QuickfixCmdPost <span class="k">make</span> <span class="k">cw</span>
augroup END

<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">,</span><span class="k">q</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span><span class="k">copen</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> ]<span class="k">q</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>cnext<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [<span class="k">q</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>cprev<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> ]Q :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span><span class="k">clast</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [Q :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span><span class="k">cfirst</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="c">" errormarker.vim</span>
<span class="k">let</span> errormarker_disablemappings <span class="p">=</span> <span class="m">1</span>

<span class="c">" Merge Setting</span>
<span class="k">if</span> &amp;<span class="nb">diff</span>
  nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>leader<span class="p">&gt;</span><span class="m">1</span> :<span class="k">diffget</span> LOCAL<span class="p">&lt;</span>CR<span class="p">&gt;</span>
  nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>leader<span class="p">&gt;</span><span class="m">2</span> :<span class="k">diffget</span> BASE<span class="p">&lt;</span>CR<span class="p">&gt;</span>
  nmap <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>leader<span class="p">&gt;</span><span class="m">3</span> :<span class="k">diffget</span> REMOTE<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="k">endif</span>

<span class="c">" TagBar</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">,</span><span class="k">t</span> :TagbarToggle<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="k">let</span> <span class="k">g</span>:tagbar_left <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:tagbar_width <span class="p">=</span> <span class="m">30</span>
<span class="k">let</span> <span class="k">g</span>:tagbar_updateonsave_maxlines <span class="p">=</span> <span class="m">10000</span>
<span class="k">let</span> <span class="k">g</span>:tagbar_sort <span class="p">=</span> <span class="m">0</span>

<span class="c">" Tabular</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span><span class="p">,</span> :Tabularize /<span class="p">,&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span><span class="p">,</span> :Tabularize /<span class="p">,&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span><span class="p">=</span> :Tabularize /<span class="p">=&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span><span class="p">=</span> :Tabularize /<span class="p">=&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span><span class="p">&gt;</span> :Tabularize /<span class="p">=&gt;&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span><span class="p">&gt;</span> :Tabularize /<span class="p">=&gt;&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span>: :Tabularize /:\zs<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span>: :Tabularize /:\zs<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span><span class="p">&lt;</span>Bar<span class="p">&gt;</span> :Tabularize /<span class="p">&lt;</span>Bar<span class="p">&gt;&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">a</span><span class="p">&lt;</span>Bar<span class="p">&gt;</span> :Tabularize /<span class="p">&lt;</span>Bar<span class="p">&gt;&lt;</span>CR<span class="p">&gt;</span>

<span class="c">" テーブルっぽく打つと自動的に位置調整を行う</span>
<span class="nb">inoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>Bar<span class="p">&gt;</span>   <span class="p">&lt;</span>Bar<span class="p">&gt;&lt;</span>Esc<span class="p">&gt;</span>:<span class="k">call</span> <span class="p">&lt;</span>SID<span class="p">&gt;</span>align<span class="p">()&lt;</span>CR<span class="p">&gt;</span><span class="k">a</span>

<span class="k">function</span><span class="p">!</span> s:align<span class="p">()</span>
  <span class="k">let</span> <span class="k">p</span> <span class="p">=</span> <span class="s1">'^\s*|\s.*\s|\s*$'</span>
  <span class="k">if</span> exists<span class="p">(</span><span class="s1">':Tabularize'</span><span class="p">)</span> &amp;&amp; getline<span class="p">(</span><span class="s1">'.'</span><span class="p">)</span> <span class="p">=~</span># <span class="s1">'^\s*|'</span> &amp;&amp; <span class="p">(</span>getline<span class="p">(</span>line<span class="p">(</span><span class="s1">'.'</span><span class="p">)</span><span class="m">-1</span><span class="p">)</span> <span class="p">=~</span># <span class="k">p</span> <span class="p">||</span> getline<span class="p">(</span>line<span class="p">(</span><span class="s1">'.'</span><span class="p">)+</span><span class="m">1</span><span class="p">)</span> <span class="p">=~</span># <span class="k">p</span><span class="p">)</span>
    <span class="k">let</span> column <span class="p">=</span> strlen<span class="p">(</span>substitute<span class="p">(</span>getline<span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>[<span class="m">0</span>:<span class="k">col</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>]<span class="p">,</span><span class="s1">'[^|]'</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span><span class="s1">'g'</span><span class="p">))</span>
    <span class="k">let</span> position <span class="p">=</span> strlen<span class="p">(</span>matchstr<span class="p">(</span>getline<span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>[<span class="m">0</span>:<span class="k">col</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>]<span class="p">,</span><span class="s1">'.*|\s*\zs.*'</span><span class="p">))</span>
    Tabularize<span class="sr">/|/</span>l1
    normal<span class="p">!</span> <span class="m">0</span>
    <span class="k">call</span> search<span class="p">(</span>repeat<span class="p">(</span><span class="s1">'[^|]*|'</span><span class="p">,</span>column<span class="p">)</span>.<span class="s1">'\s\{-\}'</span>.repeat<span class="p">(</span><span class="s1">'.'</span><span class="p">,</span>position<span class="p">),</span><span class="s1">'ce'</span><span class="p">,</span>line<span class="p">(</span><span class="s1">'.'</span><span class="p">))</span>
  <span class="k">endif</span>
<span class="k">endfunction</span>

<span class="c">" gundo</span>
<span class="nb">nnoremap</span> U :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>GundoToggle<span class="p">&lt;</span>CR<span class="p">&gt;</span>

<span class="c">" open-browser</span>
<span class="k">let</span> <span class="k">g</span>:netrw_nogx <span class="p">=</span> <span class="m">1</span> <span class="c">" disable netrw's gx mapping.</span>
<span class="nb">nnoremap</span> gx <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>openbrowser<span class="p">-</span>smart<span class="p">-</span>search<span class="p">)</span>
<span class="nb">vnoremap</span> gx <span class="p">&lt;</span>Plug<span class="p">&gt;(</span>openbrowser<span class="p">-</span>smart<span class="p">-</span>search<span class="p">)</span>
<span class="k">function</span><span class="p">!</span> OpenBrowserLine<span class="p">()</span>
  <span class="k">let</span> matched <span class="p">=</span> matchlist<span class="p">(</span>getline<span class="p">(</span><span class="s2">"."</span><span class="p">),</span> <span class="s1">'https\?://[0-9A-Za-z_#?~=\-+%\.\/:]\+'</span><span class="p">)</span>
  <span class="k">if</span> len<span class="p">(</span>matched<span class="p">)</span> <span class="p">==</span> <span class="m">0</span>
    <span class="k">break</span>
  <span class="k">endif</span>
  execute <span class="s2">"OpenBrowser "</span> . matched[<span class="m">0</span>]
<span class="k">endfunction</span>

<span class="c">" syntastic</span>
<span class="k">let</span> <span class="k">g</span>:syntastic_auto_loc_list <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="k">g</span>:syntastic_mode_map <span class="p">=</span> { <span class="s1">'mode'</span>: <span class="s1">'active'</span><span class="p">,</span>
                           \ <span class="s1">'active_filetypes'</span>: []<span class="p">,</span>
                           \ <span class="s1">'passive_filetypes'</span>: [<span class="s1">'haskell'</span>] }

<span class="c">" ft hamstache</span>
MyAutocmd <span class="nb">BufReadPost</span> *.hamstache <span class="k">set</span> <span class="k">filetype</span><span class="p">=</span>haml

<span class="c">" ag.vim</span>
<span class="k">let</span> <span class="k">g</span>:agprg<span class="p">=</span><span class="s2">"ag --nocolor --nogroup --column"</span>

<span class="c">" ruby buffer</span>
<span class="k">if</span> has<span class="p">(</span><span class="s1">'ruby'</span><span class="p">)</span>
    <span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [space]<span class="k">r</span> :<span class="k">set</span> <span class="nb">operatorfunc</span><span class="p">=</span>Ruby<span class="p">&lt;</span>CR<span class="p">&gt;</span><span class="k">g</span>@
    <span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [space]rr :<span class="k">call</span> RubyLines<span class="p">()&lt;</span>CR<span class="p">&gt;</span>
    nmap [space]R [space]<span class="k">r</span>$
    <span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [space]rp :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span><span class="k">call</span> RubyPaste<span class="p">()&lt;</span>CR<span class="p">&gt;</span>

    xnoremap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [space]<span class="k">r</span> :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span><span class="k">call</span> Ruby<span class="p">(</span>visualmode<span class="p">(),</span> <span class="m">1</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>
    xnoremap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [space]R :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span><span class="k">call</span> Ruby<span class="p">(</span><span class="s1">'V'</span><span class="p">,</span> <span class="m">1</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>

    command<span class="p">!</span> <span class="p">-</span>range Ruby :<span class="p">&lt;</span>line1<span class="p">&gt;,&lt;</span>line2<span class="p">&gt;</span><span class="k">call</span> RubyLines<span class="p">()</span>
    command<span class="p">!</span> <span class="p">-</span>range RubyPaste :<span class="p">&lt;</span>line1<span class="p">&gt;,&lt;</span>line2<span class="p">&gt;</span><span class="k">call</span> RubyPaste<span class="p">()</span>

    <span class="k">let</span> s:ruby_buffer <span class="p">=</span> <span class="s2">""</span>

    <span class="k">ruby</span> <span class="p">&lt;&lt;</span>RUBY
class VimRuby
    @@binding <span class="p">=</span> binding

    <span class="nb">def</span> VimRuby.evaluate<span class="p">(</span>code<span class="p">)</span>
        result <span class="p">=</span> eval<span class="p">(</span>code<span class="p">,</span> @@binding<span class="p">)</span>

        <span class="k">if</span> result.instance_of?<span class="p">(</span>String<span class="p">)</span>
            str <span class="p">=</span> result.gsub<span class="p">(</span><span class="sr">/"/</span><span class="p">,</span> <span class="s1">'\\"'</span><span class="p">)</span>
            VIM.command<span class="p">(</span>%<span class="p">(</span><span class="k">let</span> s:ruby_buffer <span class="p">=</span> <span class="s2">"#{str}"</span> . <span class="s2">"\n"</span><span class="p">))</span>
        <span class="k">else</span>
            str <span class="p">=</span> result.inspect.gsub<span class="p">(</span><span class="sr">/"/</span><span class="p">,</span> <span class="s1">'\\"'</span><span class="p">)</span>
            VIM.command<span class="p">(</span>%<span class="p">(</span><span class="k">let</span> s:ruby_buffer <span class="p">=</span> <span class="s1">'#{str}'</span> . <span class="s2">"\n"</span><span class="p">))</span>
        <span class="k">end</span>

        <span class="k">return</span> result
    <span class="k">end</span>
<span class="k">end</span>
RUBY

    <span class="k">function</span><span class="p">!</span> RubyEval<span class="p">(</span>code<span class="p">)</span>
        <span class="k">ruby</span> <span class="k">p</span> VimRuby.evaluate<span class="p">(</span>VIM.evaluate<span class="p">(</span><span class="s2">"a:code"</span><span class="p">))</span>
    <span class="k">endfunction</span>

    <span class="k">function</span><span class="p">!</span> Ruby<span class="p">(</span>type<span class="p">,</span> ...<span class="p">)</span>
        <span class="k">let</span> saved_sel <span class="p">=</span> &amp;<span class="nb">selection</span>
        <span class="k">let</span> &amp;<span class="nb">selection</span> <span class="p">=</span> <span class="s2">"inclusive"</span>
        <span class="k">let</span> saved_reg <span class="p">=</span> @*

        <span class="k">if</span> <span class="k">a</span>:<span class="m">0</span>
            <span class="k">silent</span> exe <span class="s2">"normal! `&lt;"</span> . <span class="k">a</span>:type . <span class="s2">"`&gt;y"</span>
        <span class="k">elseif</span> <span class="k">a</span>:type <span class="p">==</span> <span class="s1">'line'</span>
            <span class="k">silent</span> exe <span class="s2">"normal! '[V']y"</span>
        <span class="k">elseif</span> <span class="k">a</span>:type <span class="p">==</span> <span class="s1">'block'</span>
            <span class="k">silent</span> exe <span class="s2">"normal! `[\&lt;C-v&gt;`]y"</span>
        <span class="k">else</span>
            <span class="k">silent</span> exe <span class="s2">"normal! `[v`]y"</span>
        <span class="k">endif</span>

        <span class="k">call</span> RubyEval<span class="p">(</span>@*<span class="p">)</span>

        <span class="k">let</span> &amp;<span class="nb">selection</span> <span class="p">=</span> saved_sel
        <span class="k">let</span> @* <span class="p">=</span> saved_reg
    <span class="k">endfunction</span>

    <span class="k">function</span><span class="p">!</span> RubyLines<span class="p">()</span> range
        <span class="k">let</span> <span class="nb">lines</span> <span class="p">=</span> getline<span class="p">(</span><span class="k">a</span>:firstline<span class="p">,</span> <span class="k">a</span>:lastline<span class="p">)</span>
        <span class="k">let</span> code <span class="p">=</span> <span class="k">join</span><span class="p">(</span><span class="nb">lines</span><span class="p">,</span> <span class="s2">"\n"</span><span class="p">)</span>
        <span class="k">call</span> RubyEval<span class="p">(</span>code<span class="p">)</span>
    <span class="k">endfunction</span>

    <span class="k">function</span><span class="p">!</span> RubyPaste<span class="p">()</span>
        <span class="k">let</span> saved_reg <span class="p">=</span> @*
        <span class="k">let</span> @* <span class="p">=</span> s:ruby_buffer
        normal<span class="p">!</span> <span class="k">p</span>
        <span class="k">let</span> @* <span class="p">=</span> saved_reg
    <span class="k">endfunction</span>
<span class="k">endif</span>

<span class="c">" TweetVim {{{</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> S :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>TweetVimSay<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [unite]<span class="k">t</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Unite tweetvim<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [space]<span class="k">ts</span>   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>TweetVimUserStream<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> [space]tt   :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>TweetVimHomeTimeline<span class="p">&lt;</span>CR<span class="p">&gt;</span>
<span class="k">let</span> s:bundle <span class="p">=</span> neobundle#get<span class="p">(</span><span class="s2">"TweetVim"</span><span class="p">)</span>
<span class="k">function</span><span class="p">!</span> s:bundle.hooks.on_source<span class="p">(</span>bundle<span class="p">)</span>
  <span class="k">let</span> <span class="k">g</span>:tweetvim_include_rts <span class="p">=</span> <span class="m">1</span>
  <span class="k">if</span> has<span class="p">(</span><span class="s1">'mac'</span><span class="p">)</span>
    <span class="k">let</span> <span class="k">g</span>:tweetvim_display_icon <span class="p">=</span> <span class="m">0</span>
  <span class="k">else</span>
    <span class="k">let</span> <span class="k">g</span>:tweetvim_display_icon <span class="p">=</span> <span class="m">1</span>
  <span class="k">end</span>
<span class="k">endfunction</span>
unlet s:bundle
<span class="c">" }}}</span>

<span class="c">" code snippet highlight {{{</span>
<span class="k">let</span> <span class="k">g</span>:markdown_quote_syntax_filetypes <span class="p">=</span> {
        \ <span class="s2">"coffee"</span> : {
        \   <span class="s2">"start"</span> : <span class="s2">"coffee"</span><span class="p">,</span>
        \}<span class="p">,</span>
        \ <span class="s2">"mustache"</span> : {
        \   <span class="s2">"start"</span> : <span class="s2">"mustache"</span><span class="p">,</span>
        \}<span class="p">,</span>
        \ <span class="s2">"haml"</span> : {
        \   <span class="s2">"start"</span> : <span class="s2">"haml"</span><span class="p">,</span>
        \}<span class="p">,</span>
  \}
<span class="c">" }}}</span>


<span class="c">" to 1.9 hash</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>C<span class="p">-</span><span class="k">h</span><span class="p">&gt;</span> :s<span class="sr">/:\([a-z0-9_]\+\)\s*=&gt;/</span>\<span class="m">1</span>:/<span class="k">g</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>


<span class="k">if</span> filereadable<span class="p">(</span>expand<span class="p">(</span><span class="s1">'~/.vimrc.local.after'</span><span class="p">))</span>
  execute <span class="s1">'source'</span> expand<span class="p">(</span><span class="s1">'~/.vimrc.local.after'</span><span class="p">)</span>
<span class="k">endif</span>
</pre></div>
</div>

<h2>
<span id="rspecsnip" class="fragment"></span><a href="#rspecsnip"><i class="fa fa-link"></i></a>rspec.snip</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># describe
snippet desc
abbr    describe end
prev_word '^'
    describe "${1:name}" do
        ${2}
    end

snippet desch
abbr    spec_helper describe
prev_word '^'
    require 'spec_helper'

    describe ${1:`Snippet_RubySpecNameFromFilename()`} do
        ${2}
    end

snippet desccon
abbr    describe for controller
prev_word '^'
    describe "${1:GET|POST|PUT|DELETE} ${2:/some/path}${3}" do
        ${4}
    end

snippet bef
prev_word '^'
    before do
        ${1}
    end

alias bef before

snippet befa
prev_word '^'
    before(:all) do
        ${1}
    end

alias befa beforeall

snippet aft
prev_word '^'
    after do
        ${1}
    end

alias aft after

snippet afta
prev_word '^'
    after(:all) do
        ${1}
    end

alias afta afterall

snippet con
prev_word '^'
    context "${1}" do
        ${2}
    end

alias con context

snippet cona
prev_word '^'
abbr context after callback
    context "after #${1:save!}" do
        before do
            subject.$1
        end
        ${2}
    end

snippet subjc
prev_word '^'
    subject { ${1:FactoryGirl.create(:${2:name\})} }

alias subjc subject

snippet subjb
prev_word '^'
    subject { ${1:FactoryGirl.build(:${2:name\})} }

# it
snippet it
prev_word '^'
    it "${1}" do
        ${2}
    end

snippet itb
prev_word '^'
abbr        it {}
        it { ${1} }

snippet its
prev_word '^'
    it "should ${1:work correctly}" do
        ${2}
    end

snippet is
prev_word '^'
    it { should ${1} }

snippet isn
prev_word '^'
    it { should_not ${1} }

# should
snippet sh
    should == ${1:value}
    ${2}

snippet shn
    should_not == ${1:value}
    ${2}

snippet shs
    should satisfy { |${1:obj}| ${2} }
    ${3}

snippet shp
    should be_${1:predicate}

alias shp shbe

snippet shh
    should have(${1:num}).${2:things}
    ${3}

snippet she
    should eq(${1:value})
    ${3}

snippet shne
    should_not eq(${1:value})
    ${2}

snippet shnredt
    response.should_not redirect_to(${1:url})
    ${2}

snippet shbw
    should be_within(${1:tolerance}).of(${2:result})
    ${3}

snippet shnbw
    should_not be_within(${1:tolerance}).of(${2:result})
    ${4}

snippet shhal
    should have_at_least(${1:num}).${2:things}
    ${3}

snippet shhi
    should have(${1:n}).records
    ${2}

snippet shns
    should_not satisfy { |${1:obj}| ${2} }
    ${3}

snippet shbko
    should be_a_kind_of(${1:class})
    ${2}

snippet shnbko
    should_not be_a_kind_of(${1:klass})
    ${2}

snippet shnbe
    should_not be_${1:predicate}

snippet shre
    should raise_error(${1:error})
    ${2}

snippet shnre
    should_not raise_error(${1:error})
    ${2}

alias shre shraise

snippet shc
    expect {
        ${1}
    }.should change(${2:described_class}, :${3:count}).by(${4:1})

alias shc exshc

snippet shnc
    expect {
        ${1}
    }.should_not change(${2:target}, :${3:method})

snippet shrt
    should respond_to(:${1:sym})
    ${2}

snippet shnrt
    should_not respond_to(:${1:sym})
    ${2}

snippet shr
    should_receive(:${1:message})${2}
    ${3}

snippet shnr
    should_not_receive(:${1:message})${2}
    ${3}

snippet wia
    with(${1:args})
    ${2}

snippet shm
    should match(/${1:regexp}/)
    ${2}

snippet shnm
    should_not match(/${1:regexp}/)
    ${2}

snippet shredt
    response.should redirect_to(${1:url})
    ${2}

snippet shbr
    response.should be_redirect
    ${1}

snippet shnbr
    response.should_not be_redirect
    ${1}

snippet shbs
    response.should be_success
    ${1}

snippet shnbs
    response.should_not be_success
    ${1}

snippet shtemp
    response.should render_template(:${1:template})
    ${2}

snippet shbio
    should be_instance_of(${1:class})
    ${2}

snippet shnbio
    should_not be_instance_of(${1:klass})
    ${2}

# shared_context
snippet sc
prev_word '^'
abbr shared_context do end
    shared_context "${1:condition}" do
        ${2}
    end

alias sc shared_context

snippet scm
prev_word '^'
abbr shared_context with metadata
    shared_context "${1:condition}", :${2:key} =&gt; ${3:value} do
        ${4}
    end

snippet inc
prev_word '^'
abbr include_context
    include_context "${1}"

alias inc include_context

# shared_example
snippet se
prev_word '^'
abbr shared_examples do end
    shared_examples "${1:do something}" do
        ${2}
    end

alias se shared_examples

snippet sed
prev_word '^'
    shared_examples "${1:}" do
        describe "as $1" do
            ${2}
        end
    end

snippet ibl
prev_word '^'
abbr it_behaves_like
    it_behaves_like '${1}'

alias ibl it_behaves

snippet ine
prev_word '^'
abbr include_examples
    include_examples "${1}"

alias ine include_examples

# let
snippet let
prev_word '^'
abbr let {}
    let(:${1}) { ${2} }

snippet let!
prev_word '^'
abbr let! {}
    let!(:${1}) { ${2} }

snippet letf
prev_word '^'
    let(:${1:model}) do 
        FactoryGirl.create(:${2:$1})
    end

# matcher
snippet atl
    at_least(${1:n}).times

snippet atm
    at_most(${1:n}).times

snippet on
    once

snippet tw
    twice

snippet ber
    be_redirect

snippet ex
    exactly(${1:n}).times

alias ex exact

snippet annot
    any_number_of_times

snippet shham
    ${1:target}.should have_at_most(${2:num}).${3:things}
    ${4}

snippet ant
    and_throw(${1:sym})

snippet any
    and_yield(${1:values})

snippet mat
    RSpec::Matchers.define :${1:matcher_name} do
        match do |model|
            # return Boolean
            ${2}
        end

        failure_message_for_should do
          # Failure message for should
        end

        failure_message_for_should_not do
          # Failure message for should
        end
    end

alias mat matcher


# stub
snippet anr
    and_return(${1:value})

snippet anrb
    and_return { ${1} }

snippet anra
    and_raise(${1:exception})

snippet st
    stub(:${1:method}).and_returns(${2:return})

alias st stub

snippet sm
    stub_model(${1:model}, {${2}})
snippet mm
    mock_model(${1:model})${2}

snippet moc
    ${1:var} = mock("${2:mock_name}"${3:, :null_object =&gt; true})
    ${4}

# FactoryGirl
snippet facb
    FactoryGirl.build(:${1})

snippet fac
    FactoryGirl(:${1}, ${2})

snippet facc
    FactoryGirl.create(:${1})

snippet facs
    sequence(:${1}) {|n| "${2}#{n}"}

snippet facn
    FactoryGirl.next(:${1:sequence-name})

snippet faca
    f.${1:model} {|a| a.association(:${2:$1})}

snippet facd
    FactoryGirl.define do
        ${1}
    end

snippet facf
    factory ${1:name} do
        ${2}
    end

</pre></div></div>

<h2>
<span id="railssnip" class="fragment"></span><a href="#railssnip"><i class="fa fa-link"></i></a>rails.snip</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>snippet sc
abbr    scope :method, lambda
prev_word   '^'
    scope :${1}, lambda { ${2} }

snippet dsc
abbr    default_scope lambda
prev_word   '^'
    default_scope lambda { ${1} }

snippet bff
abbr    before_filter
prev_word   '^'
    before_filter :${1:method}

delete      hm
snippet     hm
abbr        has_many :objects
prev_word   '^'
    has_many :${1:objects}

alias hm has_m

snippet     hmo
abbr        has_many with options
prev_word   '^'
    has_many :${1:objects}${2:, class_name: "${3\}", foreign_key: "${4:reference\}_id"}

snippet     hmt
abbr        has_many :objects, :through
prev_word   '^'
    has_many :${1:objects}, through: ${2:relation}

delete      ho
snippet     ho
abbr        has_one :object
prev_word   '^'
    has_one :${1:object}

alias ho has_o

delete      bt
snippet     bt
abbr        belongs_to :object
prev_word   '^'
    belongs_to :${1:object}

alias bt bel

snippet bto
abbr        belongs_to with options
prev_word   '^'
    belongs_to :${1:object}${2:, class_name: "${3\}", foreign_key: "${4:reference\}_id"}

delete      logd
snippet     logd
abbr        logger.debug
    logger.debug(${1})

delete      logi
snippet     logi
abbr        logger.info
    logger.info(${1})

delete      logw
snippet     logw
abbr        logger.warn
    logger.warn(${1})

delete      loge
snippet     loge
abbr        logger.error
    logger.error(${1})

delete      logf
snippet     logf
abbr        logger.fatal
    logger.fatal(${1})

snippet     fla
abbr        flash[...]
prev_word   '^'
    flash[:${1:notice}] = "${2:Successfully created...}"

alias fla flash

snippet rep
abbr redirect_to (path)
    redirect_to ${1:model}_path${2:(${3:params\})}

delete      va
snippet     va
abbr        validates_associated
    validates_associated :${1:attr}

delete      vb
snippet     vb
abbr        validates_acceptance_of
    validates_acceptance_of :${1:attr}

delete      vc
snippet     vc
abbr        validates_confirmation_of
    validates_confirmation_of :${1:attr}

delete      ve
snippet     ve
abbr        validates_exclusion_of
    validates_exclusion_of :${1:attr}, in: ${2:%w( ${3:mov avi\} )}

delete      vf
snippet     vf
abbr        validates_format_of
    validates_format_of :${1:attr}, with: /${2:regexp}/

delete      vi
snippet     vi
abbr        validates_inclusion_of
    validates_inclusion_of :${1:attr}, in: ${2:%w( ${3:mov avi\} )}

delete      vl
snippet     vl
abbr        validates_length_of
    validates_length_of :${1:attr}, within: ${2:3..20}

delete      vn
snippet     vn
abbr        validates_numericality_of
    validates_numericality_of :${1:attr}

snippet     vng
abbr        validates_numericality_of greater_than: n
    validates_numericality_of :${1:attr}, greater_than: ${2:num}

snippet     vnl
abbr        validates_numericality_of less_than: n
    validates_numericality_of :${1:attr}, less_than: ${2:num}

delete      vp
snippet     vp
abbr        validates_presence_of
    validates_presence_of :${1:attr}

delete      vu
snippet     vu
abbr        validates_uniqueness_of
    validates_uniqueness_of :${1:attr}

snippet     aln
abbr        allow_nil
    allow_nil: ${1:true}

delete      ra
snippet     ra
abbr        render :action
    render action: ${1}

delete      rc
snippet     rc
abbr        render :controller
    render controller: ${1}

delete      rf
snippet     rf
abbr        render :file
    render file: ${1}

delete      ri
snippet     ri
abbr        render :inline
    render inline: ${1}

delete      rj
snippet     rj
abbr        render :json
    render json: ${1}

delete      rl
snippet     rl
abbr        render :layout
    render layout: ${1}

delete      rp
snippet     rp
abbr        render :partial
    render partial: ${1}

delete      rt
snippet     rt
abbr        render :text
    render text: ${1}

delete      rx
snippet     rx
abbr        render :xml
    render xml: ${1}

delete id

delete object

delete partial

delete      action
snippet     action
abbr        action: name
    action: ${1}

snippet     tzn
abbr        Time.zone.now
  Time.zone.now

snippet     res
abbr        resources
prev_word   '^'
    resources :${1:resources}

alias res resources

delete      rst
snippet     rst
abbr        respond_to
prev_word   '^'
    respond_to do |format|
        format.html${1: { ${2\} \}}
        format.json { render json: ${3} }
    end

snippet     befs
abbr        before_save
prev_word   '^'
    before_save :${1:method}

snippet     befc
abbr        before_create
prev_word   '^'
    before_create :${1:method}

snippet     befu
abbr        before_update
prev_word   '^'
    before_update :${1:method}

snippet     befv
abbr        before_validation
prev_word   '^'
    before_validation :${1:method}

snippet     befvc
abbr        before_validation_on_create
prev_word   '^'
    before_validation_on_create :${1:method}

snippet     befvu
abbr        before_validation_on_update
prev_word   '^'
    before_validation_on_update :${1:method}

snippet     befd
abbr        before_destroy
prev_word   '^'
    before_destroy :${1:method}

snippet     afts
abbr        after_save
prev_word   '^'
    after_save :${1:method}

snippet     aftc
abbr        after_create
prev_word   '^'
    after_create :${1:method}

snippet     aftu
abbr        after_update
prev_word   '^'
    after_update :${1:method}

snippet     aftv
abbr        after_validation
prev_word   '^'
    after_validation :${1:method}

snippet     aftvc
abbr        after_validation_on_create
prev_word   '^'
    after_validation_on_create :${1:method}

snippet     aftvu
abbr        after_validation_on_update
prev_word   '^'
    after_validation_on_update :${1:method}

snippet     aftd
abbr        after_destroy
prev_word   '^'
    after_destroy :${1:method}

snippet     try
abbr        try(:method)
    try(:${1:method})

</pre></div></div>

<h2>
<span id="coffeesnip" class="fragment"></span><a href="#coffeesnip"><i class="fa fa-link"></i></a>coffee.snip</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>snippet fun
abbr Function
  ${1:name} = (${2:args}) -&gt;
    ${3:# body...}

snippet funb
abbr Function bind
  ${1:(${2:args\}) }=&gt;
    ${3:# body...}

snippet if
  if ${1:condition}
    ${2:# body...}

snippet ife
  if ${1:condition}
    ${2:# body...}
  else
    ${3:# body...}

snippet elif
  else if ${1:condition}
    ${0:# body...}

snippet ifte
abbr if...then...else
  if ${1:condition} then ${2:value} else ${3:other}

snippet unl
  ${1:action} unless ${2:condition}

snippet fora
abbr Array Comprehension
  for ${1:name} in ${2:array}
    ${3:# body...}

snippet foro
abbr Object Comprehension
  for ${1:key}, ${2:value} of ${3:Object}
    ${4:# body...}

snippet forr
abbr Range Comprehension (inclusive)
  for ${1:name} in [${2:start}..${3:finish}]${4: by ${5:step}}
    ${6:# body...}

snippet forrex
Range Comprehension (exclusive)
  for ${1:name} in [${2:start}...${3:finish}]${4: by ${5:step}}
    ${6:# body...}

snippet swi
abbr Switch
  switch ${1:object}
    when ${2:value}
      ${3:# body...}

alias swi switch

snippet cla
abbr Class
  class ${1:ClassName}${2: extends ${3:Ancestor}}

    ${4:constructor: (${5:args}) -&gt;
      ${6:# body...}}
    $7

alias cla class

snippet try
abbr Try .. Catch
  try
    ${1}
  catch ${2:error}
    ${3}

snippet req
abbr Require
  ${3} = require(${1:'${2:sys\}'})

snippet log
abbr Console.log
  console.log ${1:"${2:msg\}"}


</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />6位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>188</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/e951d0cf98309dba90db">Rails4へのアップデート時に引っかかったポイントいくつか</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-08 15:40:02</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rails 4.0.0がリリースされたので今参加しているプロジェクトのアプリのアップデートが出来るかを試してみました。</p>

<p>やってみた結果としては、2.3 -&gt; 3.0や、3.0 -&gt; 3.1に比べると大分楽にバージョンアップできる感じです。</p>

<p>たまたま今のプロジェクトで引っかかった問題について、メモがてらまとめておきます。</p>

<h2>
<span id="rake-railsupdate" class="fragment"></span><a href="#rake-railsupdate"><i class="fa fa-link"></i></a>rake rails:update</h2>

<p>diffを見ながらconfigファイルを書き換える。<br>
そんなに大きな変更は無い。<br>
rails4からはinitializerに色々移せって感じで、application.rbが軽量化されてるけど、元のままでも別に問題無い。<br>
設定項目の重複だけ注意。</p>

<h2>
<span id="strong_parameters" class="fragment"></span><a href="#strong_parameters"><i class="fa fa-link"></i></a>strong_parameters</h2>

<p>元々、gemで先行導入して取り入れていたので概ね問題無く移行できました。</p>

<p>attr_accesibleを利用したセキュリティ対策は、外部のgemに分離されているため、<br>
<code>config.active_record.whitelist_attributes = false</code>が残っていると警告されます。<br>
attr_accesibleを使いたい場合は、protected_attributesというgemで対応できますが、素直にstrong_parametersに移行する方が良いんじゃないでしょうか。</p>

<p>気を付けておきたいのはdeviseです。<br>
deviseのカスタムコントローラー等を利用していると、strong_parametersの対応を忘れてしまって、いきなりログインできなくなったり、ユーザー登録出来なくなったりします。<br>
というか私は、いきなりテストが落ちてしばらく悩みましたw</p>

<p>後、rails_adminはとりあえず大丈夫でした。</p>

<h2>
<span id="activerecordの関連の記述方法" class="fragment"></span><a href="#activerecord%E3%81%AE%E9%96%A2%E9%80%A3%E3%81%AE%E8%A8%98%E8%BF%B0%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>ActiveRecordの関連の記述方法</h2>

<p>has_many等の関連は、conditionsというオプションでベースとなるレコードの情報を利用して条件指定を追加できる機能がありましたが、deprecatedになっています。</p>

<p>こんな感じで書けって事らしい。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># before</span>
<span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">conditions</span><span class="p">:</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span> <span class="o">[</span><span class="s2">"comments.writer_id = ?"</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">owner_id</span><span class="o">]</span> <span class="p">}</span>

<span class="c1"># after</span>
<span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">writer_id</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>

<h2>
<span id="activerecordのfinderメソッドとsunspot" class="fragment"></span><a href="#activerecord%E3%81%AEfinder%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8sunspot"><i class="fa fa-link"></i></a>ActiveRecordのfinderメソッドとSunspot</h2>

<p>SunspotというSolrから検索した結果とActiveRecordを連携させるgemを利用しています。<br>
Rails4で動作こそしますが、内部で<code>scoped</code>を利用しているため、deprecatedがガンガン出ます。<br>
Rails4からは<code>all</code>を使うのが正しいですね。</p>

<p>現時点(2013/7/8)でpull requestは既に上がっていますが、まだマージされていないので、ちゃんと直るのはもうちょっと先じゃないかな。<br>
わざわざフォークするのも面倒だし、様子見中です。</p>

<h2>
<span id="activerecordのincludesで読み込んだ関連の値を利用するためのreferencesメソッド" class="fragment"></span><a href="#activerecord%E3%81%AEincludes%E3%81%A7%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A0%E9%96%A2%E9%80%A3%E3%81%AE%E5%80%A4%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AEreferences%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>ActiveRecordのincludesで読み込んだ関連の値を利用するためのreferencesメソッド</h2>

<p>今まで以下のような感じでincludesでeager loadingした関連レコードの値をメソッドチェインで利用して、検索条件に含める事ができました。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="no">Comment</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:post</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"posts.published = ?"</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</pre></div></div>

<p>4.0.0ではこの記述はdeprecatedとなり、includesで読み込んだレコードの値を利用したい時は明示的にreferencesを呼ぶようになりました。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="no">Comment</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:post</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"posts.published = ?"</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</pre></div></div>

<p>以前のままだとSQLのパーサー書くのが大変になるかららしいです。<br>
ちょっと面倒な気がする。</p>

<p>これの影響で、Sunspotでまたdeprecatedが出ます。</p>

<p><del>## find_by_xxxメソッド無くなった</del> (ぐあっと書いたら嘘書いてたので修正)<br>
<del>これは、一切使ってなかったので問題無し。<del></del></del></p>

<h2>
<span id="find_all_by_xxxとかがdeprecatedになった" class="fragment"></span><a href="#find_all_by_xxx%E3%81%A8%E3%81%8B%E3%81%8Cdeprecated%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>find_all_by_xxxとかがdeprecatedになった。</h2>

<p>これは、一切使ってなかったので問題無し。<br>
<code>find_by</code>を使うようにする。</p>

<h2>
<span id="rspecでトランザクションが上手く動かない" class="fragment"></span><a href="#rspec%E3%81%A7%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8C%E4%B8%8A%E6%89%8B%E3%81%8F%E5%8B%95%E3%81%8B%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>rspecでトランザクションが上手く動かない</h2>

<p>rspecとdatabase_cleanerを利用しているのですが、トランザクションのロールバックを期待して記述していたテストケースが急に落ちるようになりました。<br>
どうもfixtureの読み込み処理が修正されたのが原因らしいです。</p>

<p>rspec v2.14<br>
database_cleaner githubのmaster<br>
を利用していますが、詳細まで追っかけてないので詳しくは不明です。<br>
どなたかご存知でしたら解決策を教えてください…。</p>

<p>追記 (2013/7/9)<br>
<a href="/yuki24" class="user-mention js-hovercard" title="yuki24" data-hovercard-target-type="user" data-hovercard-target-name="yuki24">@yuki24</a> さんのコメントを受けて、再現するテストケースとログを用意してみました。<br>
データベースはmysql2です。</p>

<p>v4.0.0: <a href="https://github.com/joker1007/transaction_test" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/joker1007/transaction_test</a><br>
v3.2.13: <a href="https://github.com/joker1007/transaction_test3" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/joker1007/transaction_test3</a></p>

<p>4.0.0 のtest.log<br>
<code><br>
[1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m [1mSELECT `schema_migrations`.* FROM `schema_migrations`[0m<br>
  [1m[35m (0.2ms)[0m SELECT @@FOREIGN_KEY_CHECKS<br>
  [1m[36m (0.1ms)[0m [1mSET FOREIGN_KEY_CHECKS = 0[0m<br>
  [1m[35m (0.1ms)[0m SELECT DATABASE() as db<br>
  [1m[36m (0.3ms)[0m [1mselect table_name from information_schema.views where table_schema = 'transaction_test_test'[0m<br>
  [1m[35m (5.2ms)[0m TRUNCATE TABLE `posts`;<br>
  [1m[36m (0.1ms)[0m [1mSET FOREIGN_KEY_CHECKS = 1[0m<br>
  [1m[35m (0.1ms)[0m BEGIN<br>
  [1m[36m (0.1ms)[0m [1mCOMMIT[0m<br>
  [1m[35m (0.0ms)[0m BEGIN<br>
  [1m[36m (0.2ms)[0m [1mSELECT COUNT(*) FROM `posts`[0m<br>
  [1m[35mSQL (0.2ms)[0m INSERT INTO `posts` (`created_at`, `title`, `updated_at`) VALUES ('2013-07-09 05:08:29', 'title0', '2013-07-09 05:08:29')<br>
  [1m[36mSQL (0.1ms)[0m [1mINSERT INTO `posts` (`created_at`, `title`, `updated_at`) VALUES ('2013-07-09 05:08:29', 'title1', '2013-07-09 05:08:29')[0m<br>
  [1m[35mSQL (0.1ms)[0m INSERT INTO `posts` (`created_at`, `title`, `updated_at`) VALUES ('2013-07-09 05:08:29', 'title2', '2013-07-09 05:08:29')<br>
  [1m[36m (0.1ms)[0m [1mSELECT COUNT(*) FROM `posts`[0m<br>
  [1m[35m (0.8ms)[0m ROLLBACK<br>
</code></p>

<p>3.2.13 のtest.log<br>
<code><br>
Connecting to database specified by database.yml<br>
  [1m[36m (0.1ms)[0m [1mSELECT @@FOREIGN_KEY_CHECKS[0m<br>
  [1m[35m (0.1ms)[0m SET FOREIGN_KEY_CHECKS = 0<br>
  [1m[36m (0.1ms)[0m [1mSELECT DATABASE() as db[0m<br>
  [1m[35m (0.2ms)[0m select table_name from information_schema.views where table_schema = 'transaction_test3_test'<br>
  [1m[36m (5.7ms)[0m [1mTRUNCATE TABLE `posts`;[0m<br>
  [1m[35m (0.1ms)[0m SET FOREIGN_KEY_CHECKS = 1<br>
  [1m[36m (0.1ms)[0m [1mBEGIN[0m<br>
  [1m[35m (0.1ms)[0m SAVEPOINT active_record_1<br>
  [1m[36m (0.1ms)[0m [1mRELEASE SAVEPOINT active_record_1[0m<br>
  [1m[35m (0.0ms)[0m BEGIN<br>
  [1m[36m (0.1ms)[0m [1mSELECT COUNT(*) FROM `posts` [0m<br>
  [1m[35m (0.1ms)[0m SAVEPOINT active_record_2<br>
  [1m[36mSQL (0.1ms)[0m [1mINSERT INTO `posts` (`created_at`, `title`, `updated_at`) VALUES ('2013-07-09 05:07:08', 'title0', '2013-07-09 05:07:08')[0m<br>
  [1m[35mSQL (0.2ms)[0m INSERT INTO `posts` (`created_at`, `title`, `updated_at`) VALUES ('2013-07-09 05:07:08', 'title1', '2013-07-09 05:07:08')<br>
  [1m[36mSQL (0.1ms)[0m [1mINSERT INTO `posts` (`created_at`, `title`, `updated_at`) VALUES ('2013-07-09 05:07:08', 'title2', '2013-07-09 05:07:08')[0m<br>
  [1m[35m (0.1ms)[0m ROLLBACK TO SAVEPOINT active_record_2<br>
  [1m[36m (0.1ms)[0m [1mSELECT COUNT(*) FROM `posts` [0m<br>
  [1m[35m (0.7ms)[0m ROLLBACK<br>
  [1m[36m (0.1ms)[0m [1mROLLBACK[0m<br>
</code></p>

<p>色々試してみた所、<code>DatabaseCleaner.strategy</code>が<code>:truncation</code>だと4.0.0でも正常に終了するようです。<br>
<code>:trunsaction</code>時はsavepointを利用する事でARのtransactionを実現していた部分が、4.0.0で呼ばれなくなってる事が、期待通りの結果にならない理由のようです。</p>

<p>引っかかった点といえば、こんな所です。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />7位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>186</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/f9e006445a1c5a440f0c">チーム内にRuby製のツールを広める時にはGemにしておくべき</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-05-17 13:59:25</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>もしかしたら、Rubyに慣れてない人には気付いていない人も居るかと思ったので、<br>
カジュアルにRubyGemsを活用する事のメリットについて書いておきます。</p>

<p>普通、Rubyのgemパッケージは、<code>gem install</code>でインストールできるようにrubygems.orgにホスティングしておくのが基本です。</p>

<p>とは言え、世界的に公開されるものなので、ちゃんとgemとしての体裁を整えておかないと何か恥ずかしいし、説明とかも英語でちゃんと書いとかないと、って考えると面倒なレベルのツールとかあると思います。<br>
API叩くための簡易コマンドとか、社内ツールの処理自動化とか。</p>

<p>しかし、Bundlerとgitのおかげで、現在はそういった事を余り気にする必要が無くなっています。</p>

<p>Bundlerは、gitリポジトリから直接コードをクローンして、パッケージ化されたgemと同様に扱う事ができます。</p>

<p>参考: <a href="http://gembundler.com/v1.3/git.html" title="Bundler: The best way to manage a Ruby application's gems" rel="nofollow noopener" target="_blank">Bundler: The best way to manage a Ruby application's gems</a></p>

<p>そのためrubygems.orgにホスティングする必要はありません。<br>
公開しても問題ないものならGitHubに、クローズドな情報が入っているものは社内のgitlabやGitHubのプライベートリポジトリに配置しておけばOKです。<br>
後は、Gemfileに書けば、gemとして利用できます。</p>

<p>gitリポジトリから参照しているgemは<code>Gemfile.lock</code>でこんな感じで管理されています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>GIT
  remote: git://github.com/joker1007/ghost_writer.git
  revision: bdee7051d5555d8be92045c1d45cd4ac0dee40b1
  specs:
    ghost_writer (0.2.0)
      activesupport (&gt;= 3.0.0)
      rspec-rails (~&gt; 2.11)
      trollop
</pre></div></div>

<p>この方法には以下のようなメリットがあります。</p>

<ul>
<li>READMEにGemfileの書き方さえ書いておけば簡単にチームメンバーがインストールできる事。</li>
<li>更新したい時は、gitリポジトリにpushして、bundle updateを実行するだけ</li>
<li>Bundlerはコミットハッシュでgemを特定しているので、バージョン番号を更新する必要もない</li>
<li>Jenkins等で利用するのが楽になる</li>
<li>他の人の改善案もpull request等で容易に取り込める</li>
</ul>

<p>というわけで、ツールの更新と配布をほとんどgitの機能に任せる事ができます。</p>

<p>gem化するのにも大した手間はかかりません。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% bundle gem mytool -b
      create  mytool/Gemfile
      create  mytool/Rakefile
      create  mytool/LICENSE.txt
      create  mytool/README.md
      create  mytool/.gitignore
      create  mytool/mytool.gemspec
      create  mytool/lib/mytool.rb
      create  mytool/lib/mytool/version.rb
      create  mytool/bin/mytool
Initializating git repo in /home/joker/mytool
</pre></div></div>

<p>後は、bin/mytoolを編集して、コマンドラインツールを簡単に作れる<a href="https://github.com/wycats/thor" title="wycats/thor · GitHub" rel="nofollow noopener" target="_blank">wycats/thor</a>などを利用すれば、お手軽コマンドツールが作れます。<br>
後は、このディレクトリをgitリポジトリに上げてしまうだけです。</p>

<p>こんな感じで、カジュアルにGem化してツールを広めていくと、色々楽になるんで良いんじゃないかなと思っています。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />8位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>174</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/4ac31f081c44634a5e90">rails_adminをカスタマイズする方法まとめ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-26 19:55:08</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[rails_admin]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>本当はrails_adminをカスタマイズするより、自前で実装した方が最終的には幸せになれると思うんですが、そうもいかない事情もしばしばあったりして(主にスケジュール的な理由で)、後から泥臭い場当たり的な対処に奔走しなければならないこともあります。</p>

<p>そういう時のためのノウハウが貯まったので書いておきたいと思います。</p>

<h2>
<span id="deviseと連携させる" class="fragment"></span><a href="#devise%E3%81%A8%E9%80%A3%E6%90%BA%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>deviseと連携させる</h2>

<p>これは公式にもちゃんと書いてて、超簡単。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/initializers/rails_admin.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 略</span>

<span class="n">config</span><span class="o">.</span><span class="n">current_user_method</span> <span class="p">{</span> <span class="n">current_administrator</span> <span class="p">}</span>

<span class="c1"># 略</span>
</pre></div>
</div>

<h2>
<span id="テーブルごとにアクセス権限を限定する" class="fragment"></span><a href="#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%94%E3%81%A8%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E6%A8%A9%E9%99%90%E3%82%92%E9%99%90%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>テーブルごとにアクセス権限を限定する</h2>

<p><a href="https://github.com/ryanb/cancan" title="ryanb/cancan" rel="nofollow noopener" target="_blank">cancan</a>と連携できます。まだまだ楽勝。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/initializers/rails_admin.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 略</span>

<span class="n">config</span><span class="o">.</span><span class="n">authorize_with</span> <span class="ss">:cancan</span>

<span class="c1"># or</span>

<span class="n">config</span><span class="o">.</span><span class="n">authorize_with</span> <span class="ss">:cancan</span><span class="p">,</span> <span class="no">AdminAbility</span>

<span class="c1"># 略</span>
</pre></div>
</div>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/models/ability.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Ability</span>
  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">super_admin?</span>
      <span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="ss">:all</span>
    <span class="k">else</span>
      <span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="o">[</span><span class="no">NormalModel</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>権限カラムを用意するなりRoleクラスを作って関連付けるなりして権限設定。</p>

<h2>
<span id="cssを上書きする" class="fragment"></span><a href="#css%E3%82%92%E4%B8%8A%E6%9B%B8%E3%81%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>cssを上書きする</h2>

<p>Rails Engineなので、探索パスの前の方にscssを置いてやればそっちを読みにいく。<br>
一番簡単なのは、<code>app/assets/stylesheets/rails_admin/custom/theming.css.scss</code>を作成して、そこに記述する。<br>
既存の設定に影響を与えず、rails_adminの一番後ろに追加されるので上書きしやすい。<br>
がっつり書き換えたい時は、公式のwiki見てテーマを作ることになる。</p>

<h2>
<span id="既存のdashboardを潰して独自のトップ画面を表示する" class="fragment"></span><a href="#%E6%97%A2%E5%AD%98%E3%81%AEdashboard%E3%82%92%E6%BD%B0%E3%81%97%E3%81%A6%E7%8B%AC%E8%87%AA%E3%81%AE%E3%83%88%E3%83%83%E3%83%97%E7%94%BB%E9%9D%A2%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>既存のdashboardを潰して、独自のトップ画面を表示する</h2>

<p>同じく探索パスの前の方に配置すれば、テンプレートの差し替えが可能。<br>
kaminariと同じ感じでカスタマイズが出来る。<br>
<code>app/views/rails_admin/dashboard.html.haml</code>を作成して、そこに記述する。</p>

<h2>
<span id="フィールドレベルでアクセス権限を限定する" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%83%AC%E3%83%99%E3%83%AB%E3%81%A7%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E6%A8%A9%E9%99%90%E3%82%92%E9%99%90%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>フィールドレベルでアクセス権限を限定する</h2>

<p>この辺りから辛さが増してきますw<br>
とりあえず、表示だけでも隠す方法</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/initializers/rails_admin.rb</span></div>
<div class="highlight"><pre><span></span>  <span class="n">config</span><span class="o">.</span><span class="n">model</span> <span class="s1">'SampleModel'</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:super_admin_only_column</span> <span class="k">do</span>
      <span class="n">visible</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">bindings</span><span class="o">[</span><span class="ss">:controller</span><span class="o">].</span><span class="n">try</span><span class="p">(</span><span class="ss">:current_administrator</span><span class="p">)</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:super_admin?</span><span class="p">)</span>
          <span class="kp">true</span>
        <span class="k">else</span>
          <span class="kp">false</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div>

<p>同種の設定が増えてきたら、<code>visible</code>のブロックを全部lambdaで囲んでしまって、フィールドの設定で<code>instance_eval</code>すれば多少すっきりします。</p>

<h2>
<span id="入力フォームの下に出てる必須とかオプションとかの注意書きを変更する" class="fragment"></span><a href="#%E5%85%A5%E5%8A%9B%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E4%B8%8B%E3%81%AB%E5%87%BA%E3%81%A6%E3%82%8B%E5%BF%85%E9%A0%88%E3%81%A8%E3%81%8B%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E3%81%8B%E3%81%AE%E6%B3%A8%E6%84%8F%E6%9B%B8%E3%81%8D%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>入力フォームの下に出てる「必須」とか「オプション」とかの注意書きを変更する</h2>

<p>簡単だけど、何弄れば変わるのか調べづらい。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/initializers/rails_admin.rb</span></div>
<div class="highlight"><pre><span></span>  <span class="n">config</span><span class="o">.</span><span class="n">model</span> <span class="s1">'SampleModel'</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:name</span> <span class="k">do</span>
      <span class="n">help</span> <span class="s2">"必須, 名前を入れてください"</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="サイドバーのナビゲーションメニューの並べ替え" class="fragment"></span><a href="#%E3%82%B5%E3%82%A4%E3%83%89%E3%83%90%E3%83%BC%E3%81%AE%E3%83%8A%E3%83%93%E3%82%B2%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%81%AE%E4%B8%A6%E3%81%B9%E6%9B%BF%E3%81%88"><i class="fa fa-link"></i></a>サイドバーのナビゲーションメニューの並べ替え</h2>

<p>weightというパラメーターの小さい順に上から並ぶ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>  config.model 'SampleModelFirst' do
    weight 1
  end

  config.model 'SampleModelSecond' do
    weight 2
  end
</pre></div></div>

<p>これもモデル数が増えてくると面倒なので、<code>lambda</code>と<code>instance_eval</code>で工夫する。</p>

<h2>
<span id="カスタムアクションを定義する" class="fragment"></span><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>カスタムアクションを定義する</h2>

<p>公式ではgem作れ、みたいに書いてあるけど、別に普通にlib以下に書けば問題ありません。<br>
そんな再利用性のあるカスタマイズしないしw</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">lib/custom_action.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"rails_admin/config/actions"</span>
<span class="nb">require</span> <span class="s2">"rails_admin/config/actions/base"</span>

<span class="k">module</span> <span class="nn">RailsAdmin</span>
  <span class="k">module</span> <span class="nn">Config</span>
    <span class="k">module</span> <span class="nn">Actions</span>
      <span class="k">class</span> <span class="nc">CustomAction</span> <span class="o">&lt;</span> <span class="no">RailsAdmin</span><span class="o">::</span><span class="no">Config</span><span class="o">::</span><span class="no">Actions</span><span class="o">::</span><span class="no">Base</span>
        <span class="c1"># アクションの登録</span>
        <span class="no">RailsAdmin</span><span class="o">::</span><span class="no">Config</span><span class="o">::</span><span class="no">Actions</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

        <span class="c1"># 編集とか削除とかのリンクと同じ箇所に追加する</span>
        <span class="n">register_instance_option</span> <span class="ss">:member?</span> <span class="k">do</span>
          <span class="kp">true</span>
        <span class="k">end</span>

        <span class="c1"># 表示するかどうかの設定。特定のクラスだけ出すように設定する等。</span>
        <span class="n">register_instance_option</span> <span class="ss">:visible?</span> <span class="k">do</span>
          <span class="k">if</span> <span class="n">bindings</span><span class="o">[</span><span class="ss">:abstract_model</span><span class="o">].</span><span class="n">model</span> <span class="o">==</span> <span class="no">TargetModel</span>
            <span class="kp">true</span>
          <span class="k">else</span>
            <span class="kp">false</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="c1"># font_awesomeのアイコン名。ここで指定したアイコンが勝手に表示される。</span>
        <span class="n">register_instance_option</span> <span class="ss">:link_icon</span> <span class="k">do</span>
          <span class="s2">"icon-eye-open "</span>
        <span class="k">end</span>

        <span class="c1"># pjaxを利用して画面遷移をするかどうか</span>
        <span class="n">register_instance_option</span> <span class="ss">:pjax?</span> <span class="k">do</span>
          <span class="kp">false</span>
        <span class="k">end</span>

        <span class="c1"># controllerの実際の処理</span>
        <span class="c1"># 実際には`(rails_adminのgemディレクトリ)/app/controllers/rails_admin/main_controller.rb`でclass_evalによって定義されたメソッドの中で、instance_evalされる事によって実行される</span>
        <span class="n">register_instance_option</span> <span class="ss">:controller</span> <span class="k">do</span>
          <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
            <span class="k">case</span> <span class="vi">@object</span>
            <span class="k">when</span> <span class="no">Targetmodel</span>
              <span class="n">redirect_to</span> <span class="n">main_app</span><span class="o">.</span><span class="n">root_path</span>
            <span class="k">else</span>
              <span class="k">raise</span> <span class="s2">"object is not a TargetModel"</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>rails_adminの設定ファイルにも追加が必要</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/initializers/rails_admin.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'lib/custom_action'</span>

<span class="c1"># 略</span>

  <span class="n">config</span><span class="o">.</span><span class="n">actions</span> <span class="k">do</span>
    <span class="c1"># root actions</span>
    <span class="n">dashboard</span> <span class="k">do</span>
      <span class="n">statistics</span> <span class="kp">false</span>
    <span class="k">end</span>
    <span class="c1"># collection actions </span>
    <span class="n">index</span>
    <span class="kp">new</span>
    <span class="n">export</span>
    <span class="n">bulk_delete</span>
    <span class="c1"># member actions</span>
    <span class="n">show</span>
    <span class="n">edit</span>
    <span class="n">delete</span>
    <span class="n">show_in_app</span>

    <span class="n">custom_action</span> <span class="c1"># クラス名をアンダースコア形式で追加する</span>
  <span class="k">end</span>

<span class="c1"># 略</span>
</pre></div>
</div>

<p>実際にコントローラー内でどういう値が利用できるか、利用できるオプション設定は、ソースを読んで確認した方が良い。<br>
以下のコードが参考になる。</p>

<ul>
<li>rails_admin/app/controllers/rails_admin/main_controller.rb</li>
<li>rails_admin/app/controllers/rails_admin/application_controller.rb</li>
<li>rails_admin/lib/rails_admin/config/actions/base.rb</li>
<li>rails_admin/lib/rails_admin/config/actions/show.rb</li>
<li>rails_admin/app/views/rails_admin/main/show.html.haml</li>
</ul>

<h2>
<span id="belongs_to関連のselectフォームのカスタマイズ-簡易版" class="fragment"></span><a href="#belongs_to%E9%96%A2%E9%80%A3%E3%81%AEselect%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA-%E7%B0%A1%E6%98%93%E7%89%88"><i class="fa fa-link"></i></a>belongs_to関連のselectフォームのカスタマイズ (簡易版)</h2>

<p>段々辛くなってきたぜ。</p>

<p>fieldの設定で、ある程度スコープを弄ることができます。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/initializers/rails_admin.rb</span></div>
<div class="highlight"><pre><span></span>  <span class="n">config</span><span class="o">.</span><span class="n">model</span> <span class="s1">'SampleModel'</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:parent_model</span> <span class="k">do</span>
      <span class="n">associated_collection_cache_all</span> <span class="kp">false</span> <span class="c1"># 事前にモデルを読み込まなくなる</span>
      <span class="n">associated_collection_scope</span> <span class="k">do</span>
        <span class="n">sample_model</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">[</span><span class="ss">:object</span><span class="o">]</span>
        <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">scope</span><span class="o">|</span>
          <span class="c1"># scoping all ParentModel</span>
          <span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># 上限を増やす</span>
        <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div>

<p>実際、これは何をしているかというと、ParentModelに対するrails_adminのindexアクションを呼び出しています。<br>
その結果を元にselectフィールドを更新しています。</p>

<p>indexアクションでは、main_controllerに定義されている<code>list_entries</code>を呼び出してモデルを取得しています。<br>
<code>list_entries</code>は基本的なスコープを構築します。<br>
この時、さっき指定したassociated_collection_scopeを構築するためのProcがinstance_evalされてスコープが追加されます。</p>

<p>ただ、厄介な事にこの後に実際のデータを取得する<code>get_collection</code>という処理が入ります。<br>
ここで入力パラメーターを元にソートするスコープが追加されるので、上記の設定でorder指定しても上手く動作してくれなかったりします。<br>
面倒だったので、私はこの問題はスルーしました。</p>

<p>ここでは以下のコードが参考になります。</p>

<ul>
<li>rails_admin/app/controllers/rails_admin/main_controller.rb</li>
<li>rails_admin/app/controllers/rails_admin/application_controller.rb</li>
<li>rails_admin/lib/rails_admin/config/actions/index.rb</li>
<li>rails_admin/lib/rails_admin/config/fields/association.rb</li>
<li>rails_admin/lib/rails_admin/config/fields/types/belongs_to_association.rb</li>
</ul>

<p>この辺のコード読んでると、MVCとは何だったのか、みたいな気分になりますが仕方ないので諦めます。</p>

<h2>
<span id="belongs_to関連のselectフォームのカスタマイズ-カスタムフィールド版" class="fragment"></span><a href="#belongs_to%E9%96%A2%E9%80%A3%E3%81%AEselect%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA-%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E7%89%88"><i class="fa fa-link"></i></a>belongs_to関連のselectフォームのカスタマイズ (カスタムフィールド版)</h2>

<p>カスタムフィールドと自前のコントローラーを組み合わせれば結構自由にカスタマイズが聞きます。<br>
例えば、二つのモデルをまとめて検索して一つのセレクトボックスで表示するとか。</p>

<p>belongs_toの検索は<code>rails_admin/app/assets/javascripts/rails_admin/ra.filterling-select.js</code>によって実現されています。<br>
実際の利用方法は<code>rails_admin/app/views/rails_admin/main/_form_filtering_select.html.haml</code>が参考になります。</p>

<p>このテンプレートロジック入りまくってるんですが、仕方ないですよねー(棒<br>
読んでると辛くなってきます。</p>

<p>どうもrails_adminを拡張するポイントとしては、viewから色々キックするのが楽っぽいです。非常に不幸になりそうなんですが…。</p>

<p>このfilterling-selectを丸々自前で書いても良いのですが、流石に面倒なのでこれを活用します。<br>
大エリアと中エリアがあってそれをまとめて設定するみたいなフォームを作る例で説明していきます。</p>

<p>まずは、フォームのビューを書きます。<br>
メイン部分は<code>rails_admin/app/views/rails_admin/main/_form_filtering_select.html.haml</code>からパクってきます。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/views/rails_admin/main/_form_area_select.html.haml</span></div>
<div class="highlight"><pre><span></span><span class="ss">:ruby</span>
  <span class="n">selected_id</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">new_record?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">area_ids</span>
  <span class="k">if</span> <span class="n">selected_id</span>
    <span class="n">large_and_middle_area</span> <span class="o">=</span> <span class="no">LargeAndMiddleArea</span><span class="o">.</span><span class="n">find_by_ids</span><span class="p">(</span><span class="n">selected_id</span><span class="p">)</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">large_and_middle_area</span> <span class="p">?</span> <span class="o">[[</span><span class="n">large_and_middle_area</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">large_and_middle_area</span><span class="o">.</span><span class="n">id</span><span class="o">]]</span> <span class="p">:</span> <span class="o">[]</span>
  <span class="k">else</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="k">end</span>
  <span class="n">current_action</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:action</span><span class="o">].</span><span class="n">in?</span><span class="p">(</span><span class="o">[</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'new'</span><span class="o">]</span><span class="p">)</span> <span class="p">?</span> <span class="s1">'create'</span> <span class="p">:</span> <span class="s1">'update'</span>

  <span class="n">js_option</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">xhr</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
    <span class="ss">remote_source</span><span class="p">:</span> <span class="n">main_app</span><span class="o">.</span><span class="n">admin_large_and_middle_areas_path</span><span class="p">,</span>
    <span class="ss">current_action</span><span class="p">:</span> <span class="n">current_action</span><span class="p">,</span>
  <span class="p">}</span>

<span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">select</span> <span class="n">field</span><span class="o">.</span><span class="n">method_name</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="p">{</span> <span class="ss">selected</span><span class="p">:</span> <span class="n">selected_id</span><span class="p">,</span> <span class="ss">include_blank</span><span class="p">:</span> <span class="kp">true</span> <span class="p">},</span> <span class="n">field</span><span class="o">.</span><span class="n">html_attributes</span><span class="o">.</span><span class="n">reverse_merge</span><span class="p">({</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">filteringselect</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span> <span class="n">js_option</span><span class="o">.</span><span class="n">to_json</span> <span class="p">},</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">'admin.misc.search'</span><span class="p">)</span> <span class="p">})</span>
</pre></div>
</div>

<p>ビューから思いっきりモデルのfindとか走ってますがスルーしてください。<br>
他に良いやり方が思いつかないので、泣きながらやるしかありませんでした。<br>
rails_adminに限っては、MVCなんてものは存在しません。</p>

<p>js_optionのremote_sourceに自前で用意するコントローラーへのパスを書いておきます。<br>
rails_adminから呼ばれるので、<code>main_app</code>を忘れないように。<br>
後は、rails_admin本体のコードを参考にフォームヘルパーを書けばオッケーです。</p>

<p>続いて、カスタムフィールドの定義が必要です。<br>
ここのpartialオプションが非常に重要です。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">lib/rails_admin_area_select.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">RailsAdmin</span>
  <span class="k">module</span> <span class="nn">Config</span>
    <span class="k">module</span> <span class="nn">Fields</span>
      <span class="k">class</span> <span class="nc">AreaSelect</span> <span class="o">&lt;</span> <span class="no">Base</span>
        <span class="c1"># フィールドタイプの登録</span>
        <span class="no">RailsAdmin</span><span class="o">::</span><span class="no">Config</span><span class="o">::</span><span class="no">Fields</span><span class="o">::</span><span class="no">Types</span><span class="o">::</span><span class="n">register</span><span class="p">(</span><span class="ss">:area_select</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>

        <span class="c1"># モデルに登録されている値から、表示用に整形した値を返す</span>
        <span class="c1"># 一覧画面に表示される</span>
        <span class="n">register_instance_option</span> <span class="ss">:pretty_value</span> <span class="k">do</span>
          <span class="no">LargeAndMiddleArea</span><span class="o">.</span><span class="n">find_by_ids</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:label</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="c1"># パラメーターによってソートできるかどうか</span>
        <span class="n">register_instance_option</span> <span class="ss">:sortable</span> <span class="k">do</span>
          <span class="kp">false</span>
        <span class="k">end</span>

        <span class="c1"># テキスト入力によって関連モデルを検索できるかどうか</span>
        <span class="n">register_instance_option</span> <span class="ss">:searchable</span> <span class="k">do</span>
          <span class="kp">true</span>
        <span class="k">end</span>

        <span class="c1"># このフィールドが表示するテンプレート</span>
        <span class="c1"># さっき作成した自前のテンプレートを指定する</span>
        <span class="n">register_instance_option</span> <span class="ss">:partial</span> <span class="k">do</span>
          <span class="ss">:form_area_select</span>
        <span class="k">end</span>

        <span class="n">register_instance_option</span> <span class="ss">:inline_add</span> <span class="k">do</span>
          <span class="kp">false</span>
        <span class="k">end</span>

        <span class="n">register_instance_option</span> <span class="ss">:inline_edit</span> <span class="k">do</span>
          <span class="kp">false</span>
        <span class="k">end</span>

        <span class="c1"># ビューから参照するために自分で定義したメソッド</span>
        <span class="k">def</span> <span class="nf">selected_id</span>
          <span class="n">bindings</span><span class="o">[</span><span class="ss">:object</span><span class="o">].</span><span class="n">send</span><span class="p">(</span><span class="ss">:area_ids</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="c1"># ビューから参照するために自分で定義したメソッド</span>
        <span class="k">def</span> <span class="nf">method_name</span>
          <span class="ss">:area_ids</span>
        <span class="k">end</span>

        <span class="c1"># ビューから参照するために自分で定義したメソッド</span>
        <span class="k">def</span> <span class="nf">multiple?</span>
          <span class="kp">false</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>fieldのタイプが定義できたので、rails_adminの設定を書き換えます。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/initializers/rails_admin.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'lib/rails_admin_area_select'</span>

<span class="c1"># 略</span>

  <span class="n">config</span><span class="o">.</span><span class="n">model</span> <span class="no">SampleModel</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:area_ids</span><span class="p">,</span> <span class="ss">:area_select</span>
  <span class="k">end</span>

<span class="c1"># 略</span>
</pre></div>
</div>

<p>最後に、jsonを返すコントローラーを書きます。<br>
ra.filterling-select.jsは、idとlabelという属性を持ったjsonの配列を返す事で動作します。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/controllers/admin/large_and_middle_areas_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">LargeAndMiddleAreasController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@large_and_middle_areas</span> <span class="o">=</span> <span class="no">LargeAndMiddleArea</span><span class="o">.</span><span class="n">find_all_by_name</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:query</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/views/admin/large_and_middle_areas/index.json.jbuilder</span></div>
<div class="highlight"><pre><span></span><span class="n">json</span><span class="o">.</span><span class="n">array!</span> <span class="vi">@large_and_middle_areas</span> <span class="k">do</span> <span class="o">|</span><span class="n">large_and_middle_area</span><span class="o">|</span>
  <span class="n">json</span><span class="o">.</span><span class="n">extract!</span> <span class="n">large_and_middle_area</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:label</span>
<span class="k">end</span>
</pre></div>
</div>

<p>これで、自前のコントローラーに対して検索処理をかけて関連モデルを選択し設定する事ができます。<br>
今回の例に限らず、裏側でsolrで検索させる事も可能です。<br>
かなり辛いので、こんなことする羽目になる前に、自前の管理画面をちゃんと実装した方が良いと思います。<br>
今あるコードを捨てる勇気が欲しい…。</p>

<p>というわけで、ちょっとしたカスタマイズからカスタムアクション、カスタムフィールドの定義方法まで書きました。<br>
なんかもう色々辛いし不毛なので必要にならない方が良いのですが…。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />9位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>165</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/def9d58ddb00fafc936d">HTML5のvideoタグで利用するmp4の動画を作る時のTips</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-22 15:50:31</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML5]</b> <b>[ffmpeg]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>最近、スマホやタブレットを使う機会も多いですが、その辺りの端末に動画コンテンツを提供する時に楽なのがmp4形式の動画をvideoタグで貼り付ける事です。<br>
ただ、ちょっとした注意点があって、どういう状況で再生するかによって細かい調整をしておかないと、再生開始までにえらく時間がかかるようになって、非常に不便になります。</p>

<h2>
<span id="既に作成済みの動画を再生する場合" class="fragment"></span><a href="#%E6%97%A2%E3%81%AB%E4%BD%9C%E6%88%90%E6%B8%88%E3%81%BF%E3%81%AE%E5%8B%95%E7%94%BB%E3%82%92%E5%86%8D%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>既に作成済みの動画を再生する場合</h2>

<p>mp4形式の動画を再生するためにはメタデータ情報が必要です。メタデータは通常ファイルの末尾に付与されます。ファイルサイズが小さい時は気付かないのですが、10分、20分ぐらいあるような動画を再生しようとすると末尾まで読んでから再生できるかどうかを判別するので、再生が開始できるようになるまでに異様に時間がかかるようになります。</p>

<p>そこで動画作成時にメタデータをファイルの先頭に移動させておきます。<br>
こうする事で、ファイルサイズが大きい動画でも一瞬で再生開始が可能になります。<br>
PCのブラウザだと、その辺上手いことやってくれるのか末尾にメタデータがあってもすぐに再生できたりするんですが…。</p>

<p>ffmpegで動画を作成している場合には、<code>-movflags faststart</code>オプションを利用することでエンコード後にメタデータを先頭に移動させる事ができます。</p>

<p>例としてはこんな感じ。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ffmpeg -i inputfile -f mp4 -vcodec libx264 -b:v 800k -acodec libfaac -b:a 128k -movflags faststart -o output.mp4
</pre></div></div>

<p>既に存在しているmp4を変換したい場合は<a href="https://github.com/danielgtaylor/qtfaststart" rel="nofollow noopener" target="_blank">qt-faststart</a>というツールが利用できます。</p>

<h2>
<span id="エンコードしながら追っ掛けて再生する場合" class="fragment"></span><a href="#%E3%82%A8%E3%83%B3%E3%82%B3%E3%83%BC%E3%83%89%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E8%BF%BD%E3%81%A3%E6%8E%9B%E3%81%91%E3%81%A6%E5%86%8D%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>エンコードしながら追っ掛けて再生する場合</h2>

<p>バックグラウンドでエンコードしつつ動画の再生を開始したい場合、PC向けかモバイル向けかで状況が変わります。</p>

<h3>
<span id="モバイル向けの場合" class="fragment"></span><a href="#%E3%83%A2%E3%83%90%E3%82%A4%E3%83%AB%E5%90%91%E3%81%91%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>モバイル向けの場合</h3>

<p>モバイル端末で追っ掛けながら再生する場合はHTTP Live Streaming(HLS)を使うのが良い方法です。<br>
HLSは動画ファイルを約10秒程度の短時間に分割しMPEG-TSコンテナに入れたものをひたすら生成しつつm3u8形式のリストファイルにそのファイルを逐次追加していくことで、HTTPのみで擬似的にLive Streamingを実現する方法です。<br>
Appleが提唱したらしく、iOSが最も安定して再生できるのですが一応Androidでも対応します。<br>
(手元のNexus7で試した所、Androidだとシークが出来なくなる)</p>

<p>HLSを利用することで、Webカメラ等で録画しつつHTML5のvideoタグで配信する、といった事も可能になりますし、オンデマンドで動画ファイルを変換しながら再生するということもWebブラウザだけで実現可能です。</p>

<p>以前は動画の分割がかなり面倒だったのですが、新しめのffmpegであればsegment分割の機能が組込まれているので、簡単に作成することができるようになりました。<br>
ffmpegでHLSを作成するには以下のように設定します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ffmpeg -i inputfile -vcodec libx264 -b:v 800k -acodec libfaac -b:a 128k -flags +loop-global_header -map 0 -bsf h264_mp4toannexb -f segment -segment_format mpegts -segment_time 10 -segment_list output.m3u8 stream%04d.ts
</pre></div></div>

<p>自分が試した時には、何故か<code>-flags +loop-global_header</code>と<code>-map 0</code>と<code>-bsf h264_mp4toannexb</code>のオプションが必要になりましたが、詳しい理由は不明です。<br>
重要なのは以下のオプションです。</p>

<ul>
<li>
<code>-f</code> で出力形式を<code>segment</code>に指定する</li>
<li>
<code>-segment_format</code> で分割されたストリームのフォーマットを<code>mpegts</code>に指定する</li>
<li>
<code>-segment_time</code> で分割単位時間を指定する。大体10秒くらいが目安らしい</li>
<li>
<code>-segment_list</code> で出力するリストファイル名を指定する</li>
<li>出力名に連番が振られるように<code>%04d</code>等を含めておく。この場合4桁の連番になる。</li>
</ul>

<p>videoタグには出力されたm3u8ファイルを指定しておきましょう。</p>

<p>HLSでwebカメラの映像等を配信している場合、そのままだとガンガンファイルが溜まっていってストレージを圧迫するので、不要になったデータを定期的に削除する仕組みが必要になるかもしれません。</p>

<h3>
<span id="pc向けの場合" class="fragment"></span><a href="#pc%E5%90%91%E3%81%91%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>PC向けの場合</h3>

<p>PC向けのブラウザでは今のところSafariを除いてHLS形式の再生は不可能です。<br>
ちゃんとストリーミングサーバーを用意してrtpなりrtspなりのプロトコルを利用すれば再生できそうですが、中々面倒そうなのでこちらは試していません。一応videoタグでも利用できそうですが未検証です。</p>

<p>インチキな解決策として、fragmented mp4を作成するという方法があります。<br>
通常mp4のメタデータは一箇所にまとめて配置されますが、それをキーフレームごとに分散して配置する方法です。<br>
こうしておくとエンコードが全て終わっていなくても、現在エンコードが進んでいる所までは再生できるようになります。ただ一回読み込んだ時点で動画の長さが認識されるので、途中で止まってしまった場合続きを再生できるようにするには再読み込みが必要です。<br>
一瞬停止しても良いならJSを組み合わせてゴリ押すことも可能かもしれませんが、中々面倒です。</p>

<p>fragmented mp4を作成するのもffmpegでオプションを追加するだけでOKです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ffmpeg -i inputfile -f mp4 -vcodec libx264 -b:v 800k -acodec libfaac -b:a 128k -movflags frag_keyframe -o output.mp4
</pre></div></div>

<p>というわけで、html5のvideoタグを利用した動画の配信はiOS系が一番進んでいるような気がします。AirPlayも利用できるので、Apple TVがあれば普通にテレビに転送して再生できたりします。</p>

<p>自宅にカメラ置いてモニタするWebシステムを作りたい時とか、自宅のストレージにある動画をどこでも見れるようにしたい時に使えると思います。<br>
まあ、そういう既存のアプリもあるので普通そっち使うのが良いと思いますが、細かい部分を自分に便利な形にしようとすると自分で色々用意するのが結局楽だったりします。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />10位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>124</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/8d2fa9960f3d53b8cb57">bowerパッケージをbundlerで管理するRails Assetsを使ってみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-17 19:13:20</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>最近、<a href="https://rails-assets.org/" title="Rails Assets" rel="nofollow noopener" target="_blank">Rails Assets</a>というサイトが話題になりました。</p>

<p>Rails Assetsは、Gemfileに<code>source 'https://rails-assets.org'</code>を追記することで、bowerで管理しているパッケージをgemにラップしたものをbundlerでインストールできるサービスです。しかもbower.jsonの依存関係をパースして解釈してくれます。</p>

<p>Railsで利用するJSのライブラリをどうやって管理して更新していくのか、という悩ましい問題に対する一つの解決策になるかもしれません。</p>

<p>RailsでJSのライブラリを扱う方法として、今まで以下のようなやり方を試したことがあります。</p>

<ul>
<li>vendor/assets/javascripts以下にそのまま配置する</li>
<li>vendor/assets/javascripts以下にsubmoduleをcloneしてくる</li>
<li>gem化されている<code>rails-backbone</code>のようなものを利用する</li>
<li>bowerでインストールしてassets_pathを設定する</li>
</ul>

<p>概ね、これらの組み合わせでなんとかしてる、というのがほとんどではないかと思います。</p>

<p>vendor以下に直接配置するのは、バージョンアップが非常に面倒臭くなるので、gistレベルのちょっとしたスニペットぐらいならアリかなと思います。</p>

<p>submoduleはgithubで管理されているものなら行けそうな感じですが、依存関係の自動解決ができないこと、submodule自体が若干運用し辛いことが少し難点です。</p>

<p>gem化されているものはassetsのパスも面倒見てくれるので、利用はしやすいのですがgemのメンテに縛られて、JSライブラリ自体のバージョンに追い付いていない場合があります。<br>
forkして何とかすると、それはそれで追従が面倒です。</p>

<p>bowerはnode.js製のJSパッケージ管理システムです。これでプロジェクトで利用するJavaScriptをまとめてインストールする方法は、JSのライブラリ自体の管理はやりやすくなるのですが、Railsで使う際のパス設定が煩雑になることと、余計なファイルが混じるのが難点です。後、nodeの環境が無い場合、困ります。<br>
gruntと組み合わせるとかすれば、いい感じにやれそうな気はするけど、あんま分からない…。</p>

<p>という感じで、私は中々良い方法が見つかってません。</p>

<p>そこにやってきたrails-assets.orgです</p>

<p>今、現在bowerでインストールしているJSのライブラリがいくつかあるので、それを利用できるか試してみました。</p>

<p>手順としては、<code>source</code>の定義を追加して、サイトの説明通りに<code>gem</code>の定義を書けば良いだけです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s1">'rails-assets-backbone.collectionView'</span>
</pre></div></div>

<p>ただ、今現在はこれだけでは上手くいかない時があります。<br>
サイトの説明によると、Gemfileに書かれたものを自動でgemにコンバートするのは無理のようです。<br>
またbowerで検索できるパッケージ全てを網羅しているわけではありません。</p>

<p>そこでどうするかというと、手動で変換処理を依頼することができるようになっています。</p>

<p>サイトに右上にある<a href="https://rails-assets.org/components" title="Rails Assets" rel="nofollow noopener" target="_blank">Component list</a>という所から、rails-assets.orgが提供しているbowerパッケージのリストが検索できます。<br>
ここで検索して存在しないbowerパッケージはフォーム下部にある<code>Convert</code>ボタンをクリックする事で変換処理を依頼できます。<br>
変換にはしばらくかかりますが、数分ぐらいで反映されました。</p>

<p>反映された後は、説明書き通りにgemとしてインストールできます。</p>

<p>読み込みの際の注意点としては、一部JSライブラリ側のパッケージ定義が古いままだったり充分でない場合、サイトの案内通りのパスではrequireできない事があります。<br>
もし、上手くrequireできない時は、インストールされたgemのディレクトリを開いてどういう配置になっているか確認してみましょう。</p>

<p>使ってみた感想としては、bowerを使った半手動より大分良さそうだし、<code>rails-なんたら</code>というgemに縛られなくて済むので、結構良い感じです。しかも、node.jsの実行環境が必要無い。<br>
まあ、そもそもbowerパッケージだけで全部完結するような世界にはなってないのが多少残念ですがw</p>

<p>とりあえず、しばらくrails-assets.orgを利用して運用してみたいと思います。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />11位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>118</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/59ac3fa162df7c9cc952">VimでHaskellを書く時に入れておきたいプラグイン5つ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-13 12:27:08</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[Haskell]</b> <b>[開発環境]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="vim2hs" class="fragment"></span><a href="#vim2hs"><i class="fa fa-link"></i></a>vim2hs</h2>

<p><a href="https://github.com/dag/vim2hs" rel="nofollow noopener" target="_blank">vim2hs</a>はHaskellのハイライト表示を強力にしてくれます。<br>
vimのデフォルトのハイライト表示では、トップレベルに記述した関数名がハイライトされなかったり、<br>
QuasiQuoteがハイライトされなかったりと、若干貧弱です。<br>
vim2hsを入れておけば、全体的に色分けが細かくなるし、<br>
メジャーなQuasiQuoteはハイライト表示してくれます。<br>
他にもgfでimport先に飛んだりとか、\x -&gt; というラムダの表示を<br>
λx -&gt; に置き換えてくれるという、良く分からん機能もあります。</p>

<p>導入前<br>
<a href="https://camo.qiitausercontent.com/6b22a613673b502966542eae993bf8a6ad64ef5a/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303132303931332f32303132303931333034333332302e706e673f31333437343738353033" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/6b22a613673b502966542eae993bf8a6ad64ef5a/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303132303931332f32303132303931333034333332302e706e673f31333437343738353033" alt="導入前" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20120913/20120913043320.png?1347478503"></a></p>

<p>導入後<br>
<a href="https://camo.qiitausercontent.com/35c53eae11f9c18f5fa32b7e3f974493ac0da6b5/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303132303931332f32303132303931333034333332312e706e673f31333437343738353938" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/35c53eae11f9c18f5fa32b7e3f974493ac0da6b5/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303132303931332f32303132303931333034333332312e706e673f31333437343738353938" alt="導入後" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20120913/20120913043321.png?1347478598"></a></p>

<h2>
<span id="ghcmod-vim" class="fragment"></span><a href="#ghcmod-vim"><i class="fa fa-link"></i></a>ghcmod-vim</h2>

<p><a href="https://github.com/eagletmt/ghcmod-vim" rel="nofollow noopener" target="_blank">ghcmod-vim</a>はhaskellの静的解析をやってくれるghcmodを<br>
vimと連携させて使うためのプラグインです。<br>
以下の設定をしておくことで、ファイルを保存した際にコンパイラがエラーをチェックし、<br>
エラー箇所をQuickfixに表示することが出来ます。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vim/after/ftplugin/haskell.vim</span></div>
<div class="highlight"><pre><span></span>augroup ghcmodcheck
  autocmd<span class="p">!</span> <span class="nb">BufWritePost</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> GhcModCheckAsync
augroup END

<span class="c">" $VIMRUNTIME/after/ftplugin/haskell.vimに保存しておく</span>
</pre></div>
</div>

<p>Haskellではこまめにコンパイルして型のエラーをチェックするのが重要なので、<br>
自動でチェックできるとかなり捗ります。<br>
また、型推論によって、カーソルが示している関数がどういう型なのかを表示する機能があります。<br>
ソースコードの状態によるので、常に動作するわけでは無いですが、<br>
あれ、これ今どういう型になってんだろう、って時に非常に役に立ちます。<br>
モナドのdo記法の中とか、型がイメージしづらい時などにも使えます。</p>

<p>GhcModType<br>
<a href="https://camo.qiitausercontent.com/1389626ac43dca8032cc80314453b95175475029/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303132303931332f32303132303931333034333332322e706e673f31333437343738363734" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/1389626ac43dca8032cc80314453b95175475029/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303132303931332f32303132303931333034333332322e706e673f31333437343738363734" alt="GhcModType" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20120913/20120913043322.png?1347478674"></a></p>

<h2>
<span id="html-template-syntax" class="fragment"></span><a href="#html-template-syntax"><i class="fa fa-link"></i></a>html-template-syntax</h2>

<p>HaskellのWebフレームワークYesodでは、hamletやjulius等、<br>
Haskell独自のテンプレートエンジンを使っています。<br>
<a href="https://github.com/pbrisbin/html-template-syntax/tree/master/syntax" rel="nofollow noopener" target="_blank">html-template-syntax</a>はそれらをハイライト表示してくれます。</p>

<h2>
<span id="neco-ghc" class="fragment"></span><a href="#neco-ghc"><i class="fa fa-link"></i></a>neco-ghc</h2>

<p><a href="https://github.com/ujihisa/neco-ghc" rel="nofollow noopener" target="_blank">neco-ghc</a>はneocomplecacheでHaskellの関数を補完できるようにします。<br>
import宣言時のモジュール名を補完したり、import済みの関数名を補完してくれます。<br>
また、GHCの言語拡張機能の利用宣言も補完してくれます。</p>

<h2>
<span id="unite-haddock" class="fragment"></span><a href="#unite-haddock"><i class="fa fa-link"></i></a>unite-haddock</h2>

<p><a href="https://github.com/eagletmt/unite-haddock" rel="nofollow noopener" target="_blank">unite-haddock</a>はuniteのインターフェースからhaddockを検索して開くことができます。<br>
デフォルトではローカルにインストールされているhaddockを開きますが、<br>
tabキーでアクションを指定すれば、hackageのサイトを開くこともできます。<br>
~/.cabal/configの設定が<code>documentation: True</code>になっていれば、ローカルにhaddockがインストールされるので、<br>
ネットが無い環境でも開きたい場合は、ローカルにhaddockごとインストールしておきましょう。</p>

<p>以上、Haskellを勉強中のVimmerによる、Haskellを書く時に役に立つVimプラグイン5つでした。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />12位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>104</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/42f00b12c65bbec0e50a">pry-docでカジュアルにRubyのソースコードを読む</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-13 16:58:53</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>RubyのREPL環境として一般的なpryというgemがあります。<br>
pryの非常に便利な機能としてshow-sourceというコマンドがあり、指定したクラスやメソッドのソースコードをpry上で表示してくれます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[15] pry(main)&gt; require 'tsort'
true
[16] pry(main)&gt; show-source TSort#tsort

From: /Users/joker/.rbenv/versions/2.0.0-p247/lib/ruby/2.0.0/tsort.rb @ line 133:
Owner: TSort
Visibility: public
Number of lines: 5

def tsort
  result = []
  tsort_each {|element| result &lt;&lt; element}
  result
end
</pre></div></div>

<p>デフォルトのままのpryはCで書かれたRuby組み込みのクラスやメソッドのソースを表示することが出来ません。<br>
そこでpry-docをインストールすると、Cで書かれたRubyのソースコードを表示することができるようになります。<br>
pry-docはgem内部にCのソースコードとメソッドの対応関係を示したYARDを持っていて、それを利用してソースコードを表示しています。</p>

<p>pry-docを利用するとこんな感じでソースコードが読めます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[34] pry(main)&gt; show-source Array#&lt;&lt;

From: array.c (C Method):
Owner: Array
Visibility: public
Number of lines: 10

VALUE
rb_ary_push(VALUE ary, VALUE item)
{
    long idx = RARRAY_LEN(ary);

    ary_ensure_room_for_push(ary, 1);
    RARRAY_PTR(ary)[idx] = item;
    ARY_SET_LEN(ary, idx + 1);
    return ary;
}
</pre></div></div>

<p>なるほど<code>Array#&lt;&lt;</code>は配列の長さを取得して、push出来る領域を確保し、末尾のインデックスに直接itemを挿入して配列の長さを+1しているのか、ということが分かります。</p>

<p>一方で<code>Array#&lt;&lt;</code>と良く似ているけど複数引数を受け取れる<code>Array#push</code>を見てみるとこんな感じです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[39] pry(main)&gt; show-source Array#push

From: array.c (C Method):
Owner: Array
Visibility: public
Number of lines: 5

static VALUE
rb_ary_push_m(int argc, VALUE *argv, VALUE ary)
{
    return rb_ary_cat(ary, argv, argc);
}
</pre></div></div>

<p>流石にこれだけじゃ分かりませんね。でもエンドポイントとなっている関数名と実装があるファイル名が分かってるので、Rubyソースコードのどこを読めば良いかはすぐに分かります。</p>

<p>Rubyのソースは必要になったら落としてくれば良いですが、それだと若干面倒くさいのでrbenvを上手く活用すると捗ります。<br>
rbenvでRubyをインストールしているなら<code>--keep (-k)</code>オプションを付けてインストールしておくとRubyのソースコードをrbenvのディレクトリに保存しておいてくれます。</p>

<p>array.cを開いて<code>rb_ary_cat</code>とは何なのかを調べてみましょう。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="n">rb_ary_cat</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">ary</span><span class="p">,</span> <span class="k">const</span> <span class="n">VALUE</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">oldlen</span> <span class="o">=</span> <span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">ary</span><span class="p">);</span>

    <span class="n">ary_ensure_room_for_push</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">ary_memcpy</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">oldlen</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
    <span class="n">ARY_SET_LEN</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">oldlen</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ary</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p><code>Array#push</code>は<code>ary_memcpy</code>という関数で配列の末尾から追加の長さ分コピーすることによって配列を変更しているんだな、という事が分かりますね。</p>

<p>ついでに<code>ary_memcpy</code>も見てみましょう。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre><span></span><span class="n">ary_memcpy</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">ary</span><span class="p">,</span> <span class="kt">long</span> <span class="n">beg</span><span class="p">,</span> <span class="kt">long</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="n">VALUE</span> <span class="o">*</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">OBJ_PROMOTED</span><span class="p">(</span><span class="n">ary</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">128</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VALUE</span><span class="p">))</span> <span class="cm">/* is magic number (cache line size) */</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rb_gc_writebarrier_remember_promoted</span><span class="p">(</span><span class="n">ary</span><span class="p">);</span>
        <span class="n">RARRAY_PTR_USE</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">MEMCPY</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="n">beg</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">VALUE</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">RARRAY_PTR_USE</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">OBJ_WRITE</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">beg</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    <span class="n">RARRAY_PTR_USE</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">MEMCPY</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="n">beg</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">VALUE</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="p">}</span>
<span class="cp">#else</span>
    <span class="cm">/* use shady (traditional way) */</span>
    <span class="n">MEMCPY</span><span class="p">(</span><span class="n">RARRAY_PTR</span><span class="p">(</span><span class="n">ary</span><span class="p">)</span><span class="o">+</span><span class="n">beg</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">VALUE</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
</pre></div></div>

<p><code>MEMCPY</code>というマクロでポインタの内容をコピーしていて、コピー対象の数が少ない時にはforループで<code>OBJ_WRITE</code>を呼んで配列に追加していってるようですね。</p>

<p>私はCをちゃんとやったことがないのですが、pry-docで取っ掛かりを掴む事で、何とか読み進めていくことが出来ます。<br>
コア部分をいきなり読むのは難しいですが、外周部分のメソッドの呼び出しから読んでいくと、何を目的にした関数なのかはっきりしているのでかなり読み易いと思います。</p>

<p>Cのソースコードを読んでおくことで、呼び出した結果どれぐらいの計算が走ってるのかとか、内部でオブジェクトがコピーされている、ということがちゃんと把握できるようになります。それにCでgemを書くための参考にもなります。</p>

<p>pry-docから始めるRubyのソースコードリーディング、興味があれば是非やってみてください。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />13位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>94</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/6352b81fc9222e9c23ec">Githubのpull requestページに、テスト結果を表示するJenkinsの設定</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-02-03 17:50:09</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[GitHub]</b> <b>[Jenkins]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="commit-status-apiについて" class="fragment"></span><a href="#commit-status-api%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>Commit Status APIについて</h1>

<p>Githubにはcommit statusを操作するためのAPIがあります。<br>
commit statusとは、特定のコミットがどういう状態にあるのかを示すものです。<br>
successとかfailureとかpendingとか。</p>

<p>参考: <a href="https://github.com/blog/1227-commit-status-apis" rel="nofollow noopener" target="_blank">Commit Status API · GitHub Blog</a></p>

<p>commit statusが登録されているコミットをpull requestすると、commit statusの状況を確認して、マージしても問題無いかを自動で表示してくれます。</p>

<p>こんな感じ。<br>
<a href="https://camo.qiitausercontent.com/d3aeed0ebe6646e9269c2bdadb59c9504f10f8a3/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f4243416e61726943494141793579312e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d3aeed0ebe6646e9269c2bdadb59c9504f10f8a3/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f4243416e61726943494141793579312e706e67" alt="https://pbs.twimg.com/media/BCAnariCIAAy5y1.png" data-canonical-src="https://pbs.twimg.com/media/BCAnariCIAAy5y1.png"></a></p>

<p>travis-ciを使ってると上手いことやってくれるんですが、今の所、Jenkinsだと多少工夫が必要です。</p>

<p>いくつかやり方はありますが、私が採用したのは<a href="https://wiki.jenkins-ci.org/display/JENKINS/Parameterized+Trigger+Plugin" rel="nofollow noopener" target="_blank">parameterized trigger plugin</a>を使う方法です。</p>

<h1>
<span id="設定内容" class="fragment"></span><a href="#%E8%A8%AD%E5%AE%9A%E5%86%85%E5%AE%B9"><i class="fa fa-link"></i></a>設定内容</h1>

<h3>
<span id="1-masterやrelease等のマーカーとして使っているブランチ以外にpushされたらbranch用のテストジョブを走らせる" class="fragment"></span><a href="#1-master%E3%82%84release%E7%AD%89%E3%81%AE%E3%83%9E%E3%83%BC%E3%82%AB%E3%83%BC%E3%81%A8%E3%81%97%E3%81%A6%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E4%BB%A5%E5%A4%96%E3%81%ABpush%E3%81%95%E3%82%8C%E3%81%9F%E3%82%89branch%E7%94%A8%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%82%B8%E3%83%A7%E3%83%96%E3%82%92%E8%B5%B0%E3%82%89%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>1. masterや、release等のマーカーとして使っているブランチ以外にpushされたら、branch用のテストジョブを走らせる</h3>

<p>Branches to Buildにmasterとreleaseを指定。<br>
<a href="https://camo.qiitausercontent.com/2de41a4f9d9f49cf48711516512554346366f6d3/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137313631385f6f726967696e616c2e706e673f31333539383739343430" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2de41a4f9d9f49cf48711516512554346366f6d3/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137313631385f6f726967696e616c2e706e673f31333539383739343430" alt="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203171618_original.png?1359879440" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203171618_original.png?1359879440"></a></p>

<p>高度な設定のChoosing starategyで、inverseを選びターゲットのブランチを逆転させる。<br>
<a href="https://camo.qiitausercontent.com/53c0128c88507db6d93cf6bb684adb9a89e1c7d2/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137313631395f6f726967696e616c2e706e673f31333539383739343737" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/53c0128c88507db6d93cf6bb684adb9a89e1c7d2/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137313631395f6f726967696e616c2e706e673f31333539383739343737" alt="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203171619_original.png?1359879477" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203171619_original.png?1359879477"></a></p>

<h3>
<span id="2-parameterized-buildでcommit-statusをアップデートする子ジョブを作る" class="fragment"></span><a href="#2-parameterized-build%E3%81%A7commit-status%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E5%AD%90%E3%82%B8%E3%83%A7%E3%83%96%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>2. parameterized buildで、commit statusをアップデートする子ジョブを作る</h3>

<p>commit_statusというパラメーターを受け付ける。<br>
<a href="https://camo.qiitausercontent.com/d2b23f00dd2ea5f926b181f168a6878ee4075360/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137323630325f6f726967696e616c2e706e673f31333539383739393733" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d2b23f00dd2ea5f926b181f168a6878ee4075360/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137323630325f6f726967696e616c2e706e673f31333539383739393733" alt="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203172602_original.png?1359879973" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203172602_original.png?1359879973"></a></p>

<p>commit_statusパラメーターを使ってgithubのAPIを叩く。<br>
ここではCLIで実行できる簡単なGemを作って、APIにアクセスしやすくしています。<br>
<a href="https://camo.qiitausercontent.com/4ec2a63953408c8ab52751eb410151c3955217b0/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137323630335f6f726967696e616c2e706e673f31333539383830303739" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4ec2a63953408c8ab52751eb410151c3955217b0/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137323630335f6f726967696e616c2e706e673f31333539383830303739" alt="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203172603_original.png?1359880079" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203172603_original.png?1359880079"></a></p>

<h3>
<span id="3-テスト実行ジョブからparameterized-triggerで成功状況を子ジョブに伝える" class="fragment"></span><a href="#3-%E3%83%86%E3%82%B9%E3%83%88%E5%AE%9F%E8%A1%8C%E3%82%B8%E3%83%A7%E3%83%96%E3%81%8B%E3%82%89parameterized-trigger%E3%81%A7%E6%88%90%E5%8A%9F%E7%8A%B6%E6%B3%81%E3%82%92%E5%AD%90%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AB%E4%BC%9D%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>3. テスト実行ジョブからparameterized triggerで成功状況を子ジョブに伝える</h3>

<p>成功した時はcommit_statusにsuccessを渡す。<br>
また、同一のコミットで子ジョブを流せるように、pass-through Git commitの設定も行う。<br>
<a href="https://camo.qiitausercontent.com/305dac0594d5b50516f08151ca86073e6f25574f/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137313632315f6f726967696e616c2e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/305dac0594d5b50516f08151ca86073e6f25574f/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137313632315f6f726967696e616c2e706e67" alt="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203171621_original.png" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203171621_original.png"></a></p>

<p>失敗した時はcommit_statusにfailureを渡す。<br>
<a href="https://camo.qiitausercontent.com/782c5abcc3d2f034d63fadc908e22957be8f503c/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137313632305f6f726967696e616c2e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/782c5abcc3d2f034d63fadc908e22957be8f503c/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303133303230332f32303133303230333137313632305f6f726967696e616c2e706e67" alt="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203171620_original.png" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20130203/20130203171620_original.png"></a></p>

<h3>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h3>

<p>これで、何かしらのトピックブランチがpushされた時にはブランチ用のテストジョブが実行され、実行結果から判断したcommit statusがパラメーターとして子ジョブに渡され、そこからAPIにアクセスする事で、pushされたコミットのテスト結果を毎回commit statusに記録できるようになります。<br>
後は、適当なタイミングでpull requestすれば、そのpull requestがテストを通っているかどうかが、一目で判断できるようになります。</p>

<p>実は<a href="https://wiki.jenkins-ci.org/display/JENKINS/GitHub+pull+request+builder+plugin" rel="nofollow noopener" target="_blank">GitHub pull request builder plugin</a>というプラグインがあり、そのプラグインで、同じような事が可能なのですが、pull requestをポーリングしていたり、ある程度ワークフローが決まっているようなので、多少使い辛かったので、自前で構築しました。</p>

<h3>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h3>

<p>私はRailsがメインなので、Railsからcommit statusを更新しやすくするために、非常にシンプルなGemを作りました。</p>

<p><a href="https://github.com/joker1007/github-commit-status-updater" rel="nofollow noopener" target="_blank">joker1007/github-commit-status-updater · GitHub</a></p>

<p>ただのCLIツールをGemにラップしただけなので、rubygemsにはリリースしていません。<br>
こんな感じでCLIのツールをGemとしてラップしておくと、Gemfileに書いておけば、更新したり各環境にデプロイする時に一緒に配置できるので、slaveがあちこちにあっても楽チンです。<br>
暇があったら、CLIのツールもGem化してgithubに上げておくのは、結構オススメだと思います。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />14位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>85</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/1b62e3a36b4f435c53a2">最近の(2013/8/28時点の)vagrantとberkshelfの書き方</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-28 01:42:00</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[開発環境]</b> <b>[chef]</b> <b>[vagrant]</b> <b>[Berkshelf]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>vagrantとberkshelfで超捗る、みたいな記事は一杯あるんですが、その先のちょっと弄りたいってなった時に一瞬悩む。</p>

<p>コミュニティcookbookのattributesとかカスタムしたい。<br>
自分で作ったcookbookのレシピも追加したい。</p>

<p>で、色々調べてみたんですが、run_listで呼ぶよりも、そのプロヴィジョニングしたい環境の名前のcookbookを新しく作って、依存対象となるコミュニティcookbookをmetadataに書き、include_recipeする方が良いんじゃないかと思いました。</p>

<p>既に、BerksfileとVagrantfileがあるものとします。<br>
<code>vagrant plugin install vagrant-berkshelf</code>も完了済みと想定。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>bundle <span class="nb">exec</span> berks cookbook ENV_NAME     <span class="c1"># ENV_NAMEは各自読み替え</span>
</pre></div></div>

<p>でcookbookを作ります。</p>

<p>BerksfileとVagrantfileはこんな感じに。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Berksfile</span></div>
<div class="highlight"><pre><span></span><span class="n">site</span> <span class="ss">:opscode</span>

<span class="n">cookbook</span> <span class="s1">'ENV_NAME'</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s1">'ENV_NAME'</span>
</pre></div>
</div>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Vagrantfile</span></div>
<div class="highlight"><pre><span></span>  <span class="n">config</span><span class="o">.</span><span class="n">berkshelf</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:chef_solo</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">run_list</span> <span class="o">=</span> <span class="o">[</span>
      <span class="s2">"recipe[ENV_NAME]"</span><span class="p">,</span>
    <span class="o">]</span>
  <span class="k">end</span>
</pre></div>
</div>

<p>で、<code>ENV_NAME</code>のcookbookのmetadata.rbに依存するcookbookを書く。<br>
場合によってはcookbookのバージョンも指定する。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">metadata.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">name</span>             <span class="s1">'ENV_NAME'</span>
<span class="n">maintainer</span>       <span class="s1">'YOUR_NAME'</span>
<span class="n">maintainer_email</span> <span class="s1">'YOUR_EMAIL'</span>
<span class="n">license</span>          <span class="s1">'All rights reserved'</span>
<span class="n">description</span>      <span class="s1">'Installs/Configures createdb'</span>
<span class="n">long_description</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">'README.md'</span><span class="p">))</span>
<span class="n">version</span>          <span class="s1">'0.1.0'</span>

<span class="n">depends</span>          <span class="s1">'mysql'</span>
<span class="n">depends</span>          <span class="s1">'database'</span>
<span class="n">depends</span>          <span class="s1">'redisio'</span>
<span class="n">depends</span>          <span class="s1">'imagemagick'</span>
</pre></div>
</div>

<p>そして、<code>ENV_NAME</code>のレシピを書く。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">recipe/default.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">include_recipe</span> <span class="s1">'mysql::server'</span>
<span class="n">include_recipe</span> <span class="s1">'redisio::install'</span>
<span class="n">include_recipe</span> <span class="s1">'redisio::enable'</span>
<span class="n">include_recipe</span> <span class="s1">'imagemagick::devel'</span>
<span class="n">include_recipe</span> <span class="s1">'database::mysql'</span>

<span class="n">mysql_connection_info</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">host</span><span class="p">:</span> <span class="s1">'localhost'</span><span class="p">,</span>
  <span class="ss">username</span><span class="p">:</span> <span class="s1">'root'</span><span class="p">,</span>
  <span class="ss">password</span><span class="p">:</span> <span class="n">node</span><span class="o">[</span><span class="s1">'mysql'</span><span class="o">][</span><span class="s1">'server_root_password'</span><span class="o">]</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">mysql_database</span> <span class="s1">'development_db'</span> <span class="k">do</span>
  <span class="n">connection</span> <span class="n">mysql_connection_info</span>
  <span class="n">action</span> <span class="ss">:create</span>
<span class="k">end</span>
</pre></div>
</div>

<p>こんな感じ。<br>
こうしておけば、コミュニティcookbookの値を使って、追加のレシピ作るのが楽になる。<br>
この例だとattributesを書けば、ちゃんとmysql関連のパスワード設定も上書きできる。</p>

<p>実際、コミュニティcookbookを半端に使って中身を弄ると後からハイパー面倒になるので、<br>
それはそのまま使って、必要な追加処理だけこうやって書くのが分かりやすいし管理もしやすいかなーと思いました。</p>

<p>そもそも、本当に本番環境のインフラとして使う場合は、コミュニティcookbookは余りお呼びでない事もあって、そういう場合は一部を除いてスクラッチで書いた方が良い気がします。</p>

<p>私のように開発者向けのテスト環境をVMでサクっと立てたい、という目的でとりあえずアプリが動く構成を作る場合には便利です。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />15位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>83</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/19632542492f6d6395d6">vimでmarkdownのクォート内をシンタックスハイライトする方法とプラグイン</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-02 00:15:43</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>以下の記事に触発されて、vimでmarkdownのクォートの中を上手くシンタックスハイライトさせる方法は無いか調べてみました。</p>

<ul>
<li><a href="http://sue445.hatenablog.com/entry/2013/05/25/223623" title="RubyMineのシンタックスハイライトがすごかった件について - くりにっき" rel="nofollow noopener" target="_blank">RubyMineのシンタックスハイライトがすごかった件について - くりにっき</a></li>
<li><a href="http://d.hatena.ne.jp/osyo-manga/20130612/1371046408" title="Vim でコンテキストによって filetype を自動的に切り換えるプラグインをつくっている - C++でゲームプログラミング" rel="nofollow noopener" target="_blank">Vim でコンテキストによって filetype を自動的に切り換えるプラグインをつくっている - C++でゲームプログラミング</a></li>
</ul>

<p>vim-preciousでも良さそうなのですが、最初からハイライトされてる方が自分好みだったので。<br>
Vim Advent Calendarとして書けば良かったかもしれない。</p>

<h2>
<span id="別言語のシンタックス設定を読み込む" class="fragment"></span><a href="#%E5%88%A5%E8%A8%80%E8%AA%9E%E3%81%AE%E3%82%B7%E3%83%B3%E3%82%BF%E3%83%83%E3%82%AF%E3%82%B9%E8%A8%AD%E5%AE%9A%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>別言語のシンタックス設定を読み込む</h2>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="k">function</span><span class="p">!</span> MarkdownQuoteSyntaxGroup<span class="p">(</span><span class="k">filetype</span><span class="p">)</span>
  <span class="k">let</span> <span class="nb">ft</span> <span class="p">=</span> toupper<span class="p">(</span><span class="k">a</span>:<span class="k">filetype</span><span class="p">)</span>
  <span class="k">return</span> <span class="s1">'markdownCodeGroup'</span>.<span class="nb">ft</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> IncludeOtherSyntax<span class="p">(</span><span class="k">filetype</span><span class="p">)</span>
  <span class="k">let</span> group <span class="p">=</span> MarkdownQuoteSyntaxGroup<span class="p">(</span><span class="k">a</span>:<span class="k">filetype</span><span class="p">)</span>

<span class="c">  " syntax save</span>
  <span class="k">if</span> exists<span class="p">(</span><span class="s1">'b:current_syntax'</span><span class="p">)</span>
    <span class="k">let</span> s:current_syntax <span class="p">=</span> <span class="k">b</span>:current_syntax
    unlet <span class="k">b</span>:current_syntax
  <span class="k">endif</span>

  execute <span class="s1">'syntax include @'</span>.group.<span class="s1">' syntax/'</span>.<span class="k">a</span>:<span class="k">filetype</span>.<span class="s1">'.vim'</span>

<span class="c">  " syntax restore</span>
  <span class="k">if</span> exists<span class="p">(</span><span class="s1">'s:current_syntax'</span><span class="p">)</span>
    <span class="k">let</span> <span class="k">b</span>:current_syntax<span class="p">=</span>s:current_syntax
  <span class="k">else</span>
    unlet <span class="k">b</span>:current_syntax
  <span class="k">endif</span>

  <span class="k">return</span> group
<span class="k">endfunction</span>
</pre></div></div>

<p><code>syntax include @groupName syntax/javascript.vim</code>で他のシンタックスファイルを読み込み名前付ける事ができる。<br>
ただし、シンタックスファイルは<code>b:current_syntax</code>が存在すると読み込みをストップするようになってます。<br>
なので、一時的に<code>b:current_syntax</code>を無効化してからシンタックスを読み込みます。</p>

<h2>
<span id="シンタックス設定を利用するパターンを指定する" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%82%BF%E3%83%83%E3%82%AF%E3%82%B9%E8%A8%AD%E5%AE%9A%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>シンタックス設定を利用するパターンを指定する</h2>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="k">function</span><span class="p">!</span> MarkdownQuoteSyntaxRegion<span class="p">(</span><span class="k">filetype</span><span class="p">)</span>
  <span class="k">let</span> <span class="nb">ft</span> <span class="p">=</span> toupper<span class="p">(</span><span class="k">a</span>:<span class="k">filetype</span><span class="p">)</span>
  <span class="k">return</span> <span class="s1">'markdownCodeRegion'</span>.<span class="nb">ft</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> EnableMarkdownQuoteSyntax<span class="p">(</span><span class="k">filetype</span><span class="p">,</span> <span class="k">start</span><span class="p">)</span>
  <span class="k">let</span> group <span class="p">=</span> MarkdownQuoteSyntaxGroup<span class="p">(</span><span class="k">a</span>:<span class="k">filetype</span><span class="p">)</span>
  <span class="k">let</span> region <span class="p">=</span> MarkdownQuoteSyntaxRegion<span class="p">(</span><span class="k">a</span>:<span class="k">filetype</span><span class="p">)</span>

  <span class="k">let</span> regexp_start <span class="p">=</span> <span class="s2">"^\\s*```"</span>.<span class="k">a</span>:<span class="k">start</span>.<span class="s2">"$"</span>
  <span class="k">let</span> regexp_end <span class="p">=</span> <span class="s2">"^\\s*```\\ze\\s*$"</span>

  execute <span class="s1">'syntax region '</span>.region.'
  \ matchgroup<span class="p">=</span>markdownCodeDelimiter
  \ <span class="k">start</span><span class="p">=</span><span class="s2">"'.regexp_start.'"</span> <span class="k">end</span><span class="p">=</span><span class="s2">"'.regexp_end.'"</span>
  \ keepend contains<span class="p">=</span>@'.group
<span class="k">endfunction</span>
</pre></div></div>

<p><code>syntax region</code>を使うと指定のパターンに囲まれた部分に対してシンタックス設定を適用できる。<br>
それと合わせて<code>contains</code>オプションを指定する事でregionの内側で使うシンタックス設定を設定できる。<br>
さっき読み込んで名前を付けたシンタックス設定をcontainsに指定する事で、特定の領域内だけ他言語のシンタックスハイライトを適用できる。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="k">call</span> IncludeOtherSyntax<span class="p">(</span><span class="s2">"javascript"</span><span class="p">)</span>
<span class="k">call</span> EnableMarkdownQuoteSyntax<span class="p">(</span><span class="s2">"javascript"</span><span class="p">,</span> <span class="s2">"\\%(javascript\\|js\\)"</span><span class="p">)</span>
</pre></div></div>

<p>で、せっかくなのでプラギンにしてみました。</p>

<p><a href="https://github.com/joker1007/vim-markdown-quote-syntax" title="joker1007/vim-markdown-quote-syntax" rel="nofollow noopener" target="_blank">joker1007/vim-markdown-quote-syntax</a><br>
<a href="https://camo.qiitausercontent.com/5de780bb2c7044e662467783b534c212cf9d92e7/68747470733a2f2f6769746875622e636f6d2f6a6f6b6572313030372f76696d2d6d61726b646f776e2d71756f74652d73796e7461782f7261772f6d61737465722f73637265656e73686f742e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5de780bb2c7044e662467783b534c212cf9d92e7/68747470733a2f2f6769746875622e636f6d2f6a6f6b6572313030372f76696d2d6d61726b646f776e2d71756f74652d73796e7461782f7261772f6d61737465722f73637265656e73686f742e706e67" alt="screenshot.png" data-canonical-src="https://github.com/joker1007/vim-markdown-quote-syntax/raw/master/screenshot.png"></a></p>

<p><a href="https://github.com/joker1007/vim-ruby-heredoc-syntax" title="joker1007/vim-ruby-heredoc-syntax" rel="nofollow noopener" target="_blank">joker1007/vim-ruby-heredoc-syntax</a></p>

<p><a href="https://camo.qiitausercontent.com/995b0c00d0871a14d8a0f72bc2d4dcec4e962da0/68747470733a2f2f6769746875622e636f6d2f6a6f6b6572313030372f76696d2d727562792d68657265646f632d73796e7461782f7261772f6d61737465722f73637265656e73686f742e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/995b0c00d0871a14d8a0f72bc2d4dcec4e962da0/68747470733a2f2f6769746875622e636f6d2f6a6f6b6572313030372f76696d2d727562792d68657265646f632d73796e7461782f7261772f6d61737465722f73637265656e73686f742e706e67" alt="screenshot.png" data-canonical-src="https://github.com/joker1007/vim-ruby-heredoc-syntax/raw/master/screenshot.png"></a></p>

<p>これでvimのシンタックスハイライトは大したことないとか言わせねえ！</p>

<p>まだドキュメントとか全然書いてないので対応言語が分かりづらいですが、現在デフォルトで対応しているのは以下の通りです。</p>

<ul>
<li>
<p>vim-markdown-quote-syntax</p>

<ul>
<li>vim</li>
<li>diff</li>
<li>c</li>
<li>cpp</li>
<li>java</li>
<li>ruby</li>
<li>haskell</li>
<li>python</li>
<li>perl</li>
<li>javascript</li>
<li>html</li>
<li>sh</li>
<li>sql</li>
<li>ocaml</li>
<li>erlang</li>
</ul>
</li>
<li>
<p>vim-ruby-heredoc-syntax</p>

<ul>
<li>javascript</li>
<li>coffeescript</li>
<li>sql</li>
<li>html</li>
</ul>
</li>
</ul>

<p>デフォルトの設定は適当に目についた言語とrubyのヒアドキュメントで書く事の多そうな言語です。</p>

<p>Rubyのヒアドキュメントのシンタックス定義を解読するの辛かった…。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="k">let</span> regexp1 <span class="p">=</span> <span class="s2">"\\%(\\%(class\\s*\\|\\%([]})\"'.]\\|::\\)\\)\\_s*\\|\\w\\)\\@&lt;!&lt;&lt;-\\=\\zs"</span>.<span class="k">a</span>:<span class="k">start</span>

<span class="k">let</span> regexp2 <span class="p">=</span> <span class="s2">"\\%(\\%(class\\|::\\)\\_s*\\|\\%([]}).]\\)\\s\\|\\w\\)\\@&lt;!&lt;&lt;-\\=\\z("</span>.<span class="k">a</span>:<span class="k">start</span>.<span class="s2">"\\)\\ze\\%(.*&lt;&lt;-\\=['`\"]\\=\\h\\)\\@!"</span>
</pre></div></div>

<p>書いたプラグインのコードの一部ですが、もう意味分かりませんw</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />16位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>75</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/f132db1b4a5e3f9278e9">Ruby 2.0 向けのデバッガー byebugについて</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-10 16:33:57</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby 2.0系でのみ動作する<a href="https://github.com/deivid-rodriguez/byebug" title="deivid-rodriguez/byebug" rel="nofollow noopener" target="_blank">deivid-rodriguez/byebug</a>というデバッガーが存在する事を知りました。</p>

<p>少し触ってみた所、2.0系とdebuggerではどうにも動作が不安定だったステップ実行がちゃんと実行できるし、動作も軽快で良い感じでした。</p>

<p>debuggerとの違いは以下のようになってます。</p>

<ul>
<li>1.9系では動かない。2.0系のみ対応</li>
<li>2.0で追加されたデバッガ向けのC APIを利用しているため、MRIのソースに依存しないクリーンな実装。(debugger2みたいな感じ)</li>
<li>debuggerで現在も残っているissueをいくつか解決している

<ul>
<li>特に正しいバックトレースを返してくれる点が良い</li>
</ul>
</li>
<li>外部エディターサポートは組み込んでいない</li>
<li>スレッドはまだサポートされていない。まだ新しいAPIでサポートされてないかららしい</li>
<li>アクティブにメンテしてる</li>
<li>pryコマンドを組込んでいるので、byebugとpry入れてればそれだけでpry呼び出せる。</li>
</ul>

<p>デバッガに関しては、いまいち選択に悩む所が多くて安定しているとは言い難い状態だったのですが、使ってみた感触としては、今のところかなりイチオシのデバッガでは無いかと思います。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />17位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>66</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/8d90a0b965e310a5ca40">本番機などで外部と余計な通信をしたくない時にbundlerを使う場合</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-18 14:20:23</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>privateなgithubリポジトリのgemを参照していたのだが、本番機に余計な秘密鍵を置きたくなかったので、<br>
スマートにローカルから参照する方法を調べてみたところ、<br>
bundlerの1.2.0からbundle package --allというものが使えるようになっていて、<br>
gitのリポジトリやpathで参照しているgemもまとめてvendor/cacheにパッケージングしてくれるようになった。</p>

<p>つまり、こんな感じ。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="c1"># CIサーバー等</span>
bundle package --all

<span class="c1">## capistranoのcopy方式等で本番機側にアプリケーションをデプロイする。</span>
<span class="c1">## capistranoのレシピ上で、以下の形でbundlerを実行させるようにする。</span>
bundle install --deployment
</pre></div></div>

<p>これで、vendor/cacheに入ってるgemを参照して、そこからインストールを行うため、<br>
外部と全く通信する必要が無くなる。</p>

<p>bundlerの基本コマンドをちゃんと追っかけていれば、自明のことだったが、<br>
普段あんまり考えずに使っていたので、調べなきゃ気付かなかった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />18位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>65</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/fe84ec923ea6f863803b">Quickfixを知ってからfugitiveを使うと捗る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-12 14:49:05</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>vimgrepとQuickfix知らないVimmerはちょっとこっち来い - <a href="http://qiita.com/items/0c1aff03949cb1b8fe6b" class="autolink">http://qiita.com/items/0c1aff03949cb1b8fe6b</a></p>

<p>こんな記事が上がっていたので、勝手に応用編を書いてみる。<br>
まあ、以前LT等で話したことをQiitaに書き移してるだけですが。</p>

<h2>
<span id="quickfixの拡張" class="fragment"></span><a href="#quickfix%E3%81%AE%E6%8B%A1%E5%BC%B5"><i class="fa fa-link"></i></a>QuickFixの拡張</h2>

<p><a href="https://sites.google.com/site/fudist/Home/grep" rel="nofollow noopener" target="_blank">QFixGrep</a>というプラグインがあります。<br>
これを入れていると、以下のような事が出来ます。</p>

<ul>
<li>QuickFixバッファで選択した検索対象をプレビューして確認できる</li>
<li>QuickFixの表示を更に絞り込んで検索</li>
<li>QuickFixの表示をファイル名、更新時間、内容でソートする</li>
</ul>

<p>他にもいくつか機能がありますし、Windowsで利用するのに便利な解説などもあります。</p>

<p>また、以前自分のブログなどで書きましたが、<a href="https://github.com/thinca/vim-qfreplace" rel="nofollow noopener" target="_blank">qfreplace</a>というプラグインがあります。<br>
QuickFixで出力されている各行をまとめて置換することが出来ます。<br>
メソッド名の変更のお供に。</p>

<h2>
<span id="fugitiveの真価" class="fragment"></span><a href="#fugitive%E3%81%AE%E7%9C%9F%E4%BE%A1"><i class="fa fa-link"></i></a>fugitiveの真価</h2>

<p><a href="https://github.com/tpope/vim-fugitive" rel="nofollow noopener" target="_blank">fugitive</a>というvimからgitを操作するためのプラグインがあります。<br>
導入した後で、以下のようなコマンドを打ってみましょう。</p>

<ul>
<li>:Glog | copen (現在開いているファイルの過去の編集履歴をQuickFixで参照)

<ul>
<li>選択するとその時点でのファイルの断面を開く</li>
</ul>
</li>
<li>:Glog -- | copen (gitリポジトリのコミットログの一覧をQuickFixで参照)

<ul>
<li>選択するとログとdiffの内容を表示するバッファが開く</li>
</ul>
</li>
<li>:Glog master..HEAD -- | copen (masterから現在のブランチまでのコミットログの一覧をQuickFixで参照)

<ul>
<li>選択するとログとdiffの内容を表示するバッファが開く</li>
</ul>
</li>
<li>:Ggrep hoge | copen (hogeでgit grepした結果をQuickFixで参照)

<ul>
<li>選択するとヒットした箇所に移動する</li>
<li>qfreplaceでまとめて置換可能</li>
</ul>
</li>
</ul>

<p>(GlogのQuickFix機能はQfixGrepのプレビューとは余り相性が良くない)</p>

<p>gitのコミットをvimから直接扱えるので、過去の編集履歴から削除したコードを持ってきたりできるわけです。<br>
過去の編集履歴を参照している状態でGdiffコマンドを使えば、即座に現在の状態との差分を確認する事も可能です。</p>

<p>これで、gitのコミットの活用が捗りますね。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />19位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>60</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/1d38dfceba03c717bf21">Ruby(Railsじゃない環境)でTDDで開発をするための環境構築 2012/8月版</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-08-23 00:19:55</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[開発環境]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>2012/9/1のTDDBC横浜に向けて書いたものです。<br>
間違ってるとか、古い、とかありましたら突っ込みください。</p>

<h2>
<span id="rubyのインストール" class="fragment"></span><a href="#ruby%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Rubyのインストール</h2>

<h3>
<span id="ubuntuの場合-下にmacの場合を書いてます" class="fragment"></span><a href="#ubuntu%E3%81%AE%E5%A0%B4%E5%90%88-%E4%B8%8B%E3%81%ABmac%E3%81%AE%E5%A0%B4%E5%90%88%E3%82%92%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%BE%E3%81%99"><i class="fa fa-link"></i></a>Ubuntuの場合 (下にMacの場合を書いてます)</h3>

<p>その他のディストリの場合は、頑張って読み替えてください。</p>

<h4>
<span id="関係するライブラリ開発に必須なバージョン管理システムなどをインストールする" class="fragment"></span><a href="#%E9%96%A2%E4%BF%82%E3%81%99%E3%82%8B%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%8B%E7%99%BA%E3%81%AB%E5%BF%85%E9%A0%88%E3%81%AA%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AA%E3%81%A9%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>関係するライブラリ、開発に必須なバージョン管理システムなどをインストールする</h4>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>sudo apt-get install build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison subversion
</pre></div></div>

<p>元々結構入ってるかもしれないけど、大体こんなもん。</p>

<h4>
<span id="rbenvとruby-buildをインストールする" class="fragment"></span><a href="#rbenv%E3%81%A8ruby-build%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>rbenvとruby-buildをインストールする</h4>

<p>rvmはオワコンという噂が流れてますので、rbenvを使います。<br>
rvmはシェルを色々いじり過ぎって感じがちょっとマイナスポイントですね。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="c1"># 一般ユーザーで実行</span>
$ <span class="nb">cd</span>
$ git clone git://github.com/sstephenson/rbenv.git .rbenv
</pre></div></div>

<p>ホームディレクトリに.rbenvが出来る。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="c1"># 一般ユーザーで実行</span>
$ mkdir -p ~/.rbenv/plugins
$ <span class="nb">cd</span> ~/.rbenv/plugins
$ git clone git://github.com/sstephenson/ruby-build.git
</pre></div></div>

<p>.rbenv/plugins/ruby-buildが出来る。</p>

<p>.profile or .zshrcに以下の設定を記述する</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.rbenv/bin
<span class="nb">eval</span> <span class="s2">"</span><span class="k">$(</span>rbenv init -<span class="k">)</span><span class="s2">"</span>
</pre></div></div>

<p>ここは使っているシェルやディストリによって多少変わる。<br>
私自身は、.zshenvに記述していて、あちこち共通で使えるように多少工夫している。</p>

<p>この後、ターミナルを再起動して、シェルを読み込み直しておく。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rbenv <span class="nb">help</span>
</pre></div></div>

<p>を実行して、rbenvの使い方が出てきたらオッケー。</p>

<h4>
<span id="rubyの最新安定版をインストールする" class="fragment"></span><a href="#ruby%E3%81%AE%E6%9C%80%E6%96%B0%E5%AE%89%E5%AE%9A%E7%89%88%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Rubyの最新安定版をインストールする。</h4>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ <span class="nv">CONFIGURE_OPTS</span><span class="o">=</span><span class="s2">"--enable-shared"</span> rbenv install <span class="m">1</span>.9.3-p194
</pre></div></div>

<p>configureにオプションを渡したい場合は、CONFIGURE_OPTSに文字列を渡しておくと処理してくれる。</p>

<h4>
<span id="利用するrubyの切り替え" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8Bruby%E3%81%AE%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88"><i class="fa fa-link"></i></a>利用するRubyの切り替え</h4>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rbenv global <span class="m">1</span>.9.3-p194
$ ruby -v <span class="c1"># -&gt; ruby 1.9.3p194</span>
</pre></div></div>

<h4>
<span id="bundlerのインストール" class="fragment"></span><a href="#bundler%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Bundlerのインストール</h4>

<p>Gem管理のためにbundlerをインストールする。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ gem install bundler
$ rbenv rehash
$ rehash <span class="c1"># zshを使ってる場合</span>
</pre></div></div>

<p>rbenvでは、.rbenv/shims以下にある実行ファイルを呼び出して、<br>
間接的に各バージョンのディレクトリにインストールされているコマンドを呼び出す仕組みになっている。<br>
gem installによってコマンドが追加されても、.rbenv/shims以下にはコマンド呼び出しのための実行ファイルは自動で作成されない。<br>
なので、コマンドが追加される類のgemをインストールした際は、都度rbenv rehashを実行する。</p>

<h4>
<span id="プロジェクトのディレクトリでbundlerを使う" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%81%A7bundler%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>プロジェクトのディレクトリでBundlerを使う</h4>

<p>これからコードを書くつもりのディレクトリに移動したら、以下のコマンドを実行する。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle init
</pre></div></div>

<p>カレントディレクトリにGemfileの雛形が作成される。<br>
作成されたGemfileを以下のように編集する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="s2">"https://rubygems.org"</span>

<span class="n">gem</span> <span class="s2">"rspec"</span>
<span class="n">gem</span> <span class="s2">"guard-rspec"</span>
<span class="n">gem</span> <span class="s2">"libnotify"</span> <span class="c1"># 通知が欲しい場合</span>
</pre></div></div>

<p>その他、必要なGemがあれば適宜追記。<br>
編集が終わったら以下のコマンドを実行する。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle install --path .bundle
</pre></div></div>

<p>環境全体に色々入れないように、path指定をしてそのディレクトリ内での利用に限定する。<br>
特に環境全体へのインストールに抵抗が無ければ、bundle installのみでもOK。</p>

<h4>
<span id="自動テストの設定例" class="fragment"></span><a href="#%E8%87%AA%E5%8B%95%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B"><i class="fa fa-link"></i></a>自動テストの設定例</h4>

<p>bundlerでディレクトリ内にGemをインストールしている前提。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> guard init rspec
</pre></div></div>

<p>カレントディレクトリにGuardfileが作成される。<br>
細かい説明は省略しますが、watch対象のファイルが更新された時に、rspecを実行してくれます。<br>
開発環境のディレクトリ構成によって変わりますが、<br>
シンプルにそのディレクトリのルートで書く時は、以下の設定を頭に足しておくといいかなと思います。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">watch</span><span class="p">(</span><span class="sr">%r{^([^/]+).rb$}</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="s2">"spec/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span> <span class="p">}</span>
</pre></div></div>

<p>hoge.rbを編集したら、spec/hoge_spec.rbが実行されるはずです。<br>
手動で実行したい時は、以下のようにする。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> rspec spec/hoge_spec.rb
</pre></div></div>

<p>このあたりはディレクトリ構成や命名規則と関係するので、<br>
慣れてきたらカスタマイズするのもいいかと思います。</p>

<p>参考: <a href="https://github.com/guard/guard" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/guard/guard</a></p>

<h3>
<span id="macの場合" class="fragment"></span><a href="#mac%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Macの場合</h3>

<p>Xcodeとhomebrewのインストールが完了していることを前提。</p>

<h4>
<span id="homebrewでrbenv-ruby-build-readlineをインストールする" class="fragment"></span><a href="#homebrew%E3%81%A7rbenv-ruby-build-readline%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>homebrewでrbenv, ruby-build, readlineをインストールする</h4>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ brew install rbenv ruby-build readline
$ brew link readline
</pre></div></div>

<p>git-nowもbrewで入るので、ついでに入れておくのもいいかもしれない。</p>

<h4>
<span id="rubyの最新安定版をインストールする-1" class="fragment"></span><a href="#ruby%E3%81%AE%E6%9C%80%E6%96%B0%E5%AE%89%E5%AE%9A%E7%89%88%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B-1"><i class="fa fa-link"></i></a>Rubyの最新安定版をインストールする。</h4>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ <span class="nv">CONFIGURE_OPTS</span><span class="o">=</span><span class="s2">"--enable-shared --with-readline-dir=/usr/local"</span> rbenv install <span class="m">1</span>.9.3-p194
</pre></div></div>

<p>Macのreadlineはシステムデフォルトのライブラリを使ってしまうと、<br>
irbやpryで日本語が打てなくなるので、brewで入れたものを使うように指定しておく方がいい。</p>

<p>後の構築作業はほぼ共通だが、Gemfileは少し違う。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="s2">"https://rubygems.org"</span>

<span class="n">gem</span> <span class="s2">"rspec"</span>
<span class="n">gem</span> <span class="s2">"guard-rspec"</span>
<span class="n">gem</span> <span class="s2">"ruby_gntp"</span> <span class="c1"># 通知が欲しい場合</span>
</pre></div></div>

<h3>
<span id="windowsの場合" class="fragment"></span><a href="#windows%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Windowsの場合</h3>

<p>良く分かりませんw<br>
RubyInstallerで1.9.3-p194が入るらしいので、後は運が良ければGemがインストール出来ると思います。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />20位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>54</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/71d333341dca457b9b2e">rails, rspecでVimのsnippetを使うためのベストプラクティス (自己流)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-24 21:55:29</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Vim]</b> <b>[Rails]</b> <b>[RSpec]</b> <b>[開発環境]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Vimにはtextmateちっくなsnippet補完を実現するためのプラグインがいくつかあります。<br>
<a href="https://github.com/Shougo/neocomplcache-snippets-complete" rel="nofollow noopener" target="_blank">neocomplcache-snippets-complete</a>, <a href="https://github.com/garbas/vim-snipmate" rel="nofollow noopener" target="_blank">snipMate</a>, <a href="https://github.com/guns/ultisnips" rel="nofollow noopener" target="_blank">UltiSnip</a>などなど。</p>

<p>私が利用しているのは、neocomplcache-snippets-completeなので、それを利用する時の流れについての話です。<br>
neocomplecacheを使っていると、補完が統合されるので、neocomplecacheユーザーは大体これに落ち着くと思います。<br>
ちょっと調べたところだと、UltiSnipはかなり高機能っぽいのですが、pythonインターフェースが必要で、ちょっと複雑過ぎるかもしれません。</p>

<h2>
<span id="読み込みのルール" class="fragment"></span><a href="#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>読み込みのルール</h2>

<p>現在のneocomplecacheは、内部でvimのバッファが持っているファイルタイプとは別に、<br>
独自のファイルタイプ情報を持っています。<br>
最近になって(8月後半ぐらい)、NeoComplCacheSetFileTypeというコマンドが追加され、<br>
neocomplecacheがどのfiletypeで補完を行うかを、vim本体のfiletypeとは独立して設定できるようになりました。</p>

<p>また、neocomplecacheでは複合ファイルタイプに対応しているので、<br>
ruby.railsというファイルタイプを指定すれば、rubyというファイルタイプについての補完設定と、<br>
railsというファイルタイプについての補完設定が動作するようになります。</p>

<p>一方で、railsで開発をしているとvim-railsというプラグインを使っていることが多いと思いますが、<br>
そのプラグインがrailsで宣言的に記述するようなメソッド名をハイライトしてくれます。<br>
しかし、vimのfiletypeをruby.railsにすると、そのハイライトが消えてしまいます。<br>
ソースを読んだところ、filetypeがrubyじゃないと駄目みたいで、そういう仕様のようです。</p>

<p>なので、railsで書いている場合は出来れば複合ファイルタイプは使いたくない。<br>
で、以前ならば、snippetを全部、ruby用のファイルに書くという手段が取れたのですが、<br>
rails外でコード書いてる時にrailsのsnippetは必要無いわけで、どうもスマートではない。</p>

<p>そこで、NeoComplCacheSetFileTypeが活用できます。</p>

<h2>
<span id="設定例" class="fragment"></span><a href="#%E8%A8%AD%E5%AE%9A%E4%BE%8B"><i class="fa fa-link"></i></a>設定例</h2>

<p>vim-railsは、railsっぽいファイルを開くとb:rails_rootというバッファ変数を定義します。<br>
この変数の有無でrailsかどうかを容易に判別できるので、これを利用します。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span>autocmd <span class="nb">BufEnter</span> * <span class="k">if</span> exists<span class="p">(</span><span class="s2">"b:rails_root"</span><span class="p">)</span> <span class="p">|</span> NeoComplCacheSetFileType <span class="k">ruby</span>.rails <span class="p">|</span> <span class="k">endif</span>
autocmd <span class="nb">BufEnter</span> * <span class="k">if</span> <span class="p">(</span>expand<span class="p">(</span><span class="s2">"%"</span><span class="p">)</span> <span class="p">=~</span> <span class="s2">"_spec\.rb$"</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span>expand<span class="p">(</span><span class="s2">"%"</span><span class="p">)</span> <span class="p">=~</span> <span class="s2">"^spec.*\.rb$"</span><span class="p">)</span> <span class="p">|</span> NeoComplCacheSetFileType <span class="k">ruby</span>.rspec <span class="p">|</span> <span class="k">endif</span>
</pre></div></div>

<p>こんな感じで書いておけば、railsの時だけ、neocomplecacheのみrubyとrailsの両方の補完設定を活用できます。<br>
下のrspec向けの設定は、ファイルパスでrspecかどうかを判断しています。<br>
これで、ruby.snipに定義してあるsnippetも、rails.snipに定義してあるsnippetも、<br>
望む通りの環境で利用することができます。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="k">g</span>:neocomplcache_snippets_dir <span class="p">=</span> $HOME . <span class="s1">'/.vim/snippets'</span>
<span class="nb">nnoremap</span> <span class="p">&lt;</span>Space<span class="p">&gt;</span><span class="k">se</span> :<span class="p">&lt;</span>C<span class="p">-</span>U<span class="p">&gt;</span>NeoComplCacheEditSnippets<span class="p">&lt;</span>CR<span class="p">&gt;</span>
</pre></div></div>

<p>後はこんな感じで、snippetの格納場所を設定し、snippet編集用のコマンドをさっと呼べるようにしておけば、確認するのも楽です。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" SuperTab like snippets behavior.</span>
imap <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span>TAB<span class="p">&gt;</span> neocomplcache#sources#snippets_complete#expandable<span class="p">()</span> ? <span class="s2">"\&lt;Plug&gt;(neocomplcache_snippets_expand)"</span> : pumvisible<span class="p">()</span> ? <span class="s2">"\&lt;C-n&gt;"</span> : <span class="s2">"\&lt;TAB&gt;"</span>
</pre></div></div>

<p>今のところ、snippetの展開については、neocomplecacheの設定例にあるようにこんな感じにしてます。</p>

<p>後は、私のsnippetについて張っておきます。<br>
書式についてはマニュアルを参照してください。<br>
railsのsnipはデフォルトで定義されているものがあるのですが、<br>
どうも貧弱な感じなので、一旦削除して書き換えているものがあります。</p>

<p>一部、snipMateやUltiSnipを参考にパクってきてるものもあります。<br>
rspec周りはコピペベースで、まだちょっと適当なのでご了承ください。</p>

<div class="code-frame" data-lang="snippet">
<div class="code-lang"><span class="bold">ruby.snip</span></div>
<div class="highlight"><pre><span></span>snippet encutf
abbr # coding: utf-8
    # coding: utf-8

alias encutf magic

snippet class
abbr    class end
    class ${1:name}
      ${2}
    end

snippet mod
abbr    module end
    module ${1:name}
      ${2}
    end

snippet defi
abbr    def initialize(...
    def initialize${1:(${2:args\})}
        ${3}
    end

snippet unless
abbr    unless end
    unless ${1:condition}
        ${2}
    end

snippet ife
abbr    if else end
    if ${1:condition}
        ${2}
    else
        ${3}
    end

snippet ifei
abbr    if elsif end
    if ${1:condition}
        ${2}
    elsif ${3:condition}
        ${4}
    end

snippet case
abbr    case when end
    case ${1:var}
    when ${2:expr}
      ${3}
    end

alias case sw

snippet inj
abbr    inject(n) do end
    inject(${1:initial}) do |${2:acc}, ${3:val}|
        ${4}
    end

snippet injp
abbr    inject(n, &amp;:method)
    inject(${1:initial}, &amp;:${2:method})

snippet eacho
abbr    each_with_object(obj) do end
    each_with_object(${1:memoobj}) do |${2:val}, ${3:memoobj}|
        ${4}
    end

snippet map
abbr    map do end
    map do |${1:var}|
        ${2}
    end

snippet mapp
abbr    map(&amp;:method)
    map(&amp;:${1:method})

snippet sortby
abbr    sort_by(&amp;:method)
    sort_by(&amp;:${1:method})

alias sortby sort_by

snippet sortbydo
abbr    sort_by do end
    sort_by do |${1:var}|
        ${2}
    end

snippet begin
abbr    begin rescue end
    begin
        ${1:# TODO}
    rescue
        ${2:# TODO}
    end
</pre></div>
</div>

<div class="code-frame" data-lang="snippet">
<div class="code-lang"><span class="bold">rails.snip</span></div>
<div class="highlight"><pre><span></span>snippet sc
abbr    scope :method, lambda
prev_word   '^'
    scope :${1}, lambda { ${2} }

snippet dsc
abbr    default_scope lambda
prev_word   '^'
    default_scope lambda { ${1} }

snippet bff
abbr    before_filter
prev_word   '^'
    before_filter :${1:method}

delete      hm
snippet     hm
abbr        has_many :objects
prev_word   '^'
    has_many :${1:objects}

alias hm has_m

snippet     hmo
abbr        has_many with options
prev_word   '^'
    has_many :${1:objects}${2:, class_name: "${3\}", foreign_key: "${4:reference\}_id"}

snippet     hmt
abbr        has_many :objects, :through
prev_word   '^'
    has_many :${1:objects}, through: ${2:relation}

delete      ho
snippet     ho
abbr        has_one :object
prev_word   '^'
    has_one :${1:object}

alias ho has_o

delete      bt
snippet     bt
abbr        belongs_to :object
prev_word   '^'
    belongs_to :${1:object}

alias bt bel

snippet bto
abbr        belongs_to with options
prev_word   '^'
    belongs_to :${1:object}${2:, class_name: "${3\}", foreign_key: "${4:reference\}_id"}

delete      logd
snippet     logd
abbr        logger.debug
    logger.debug(${1})

delete      logi
snippet     logi
abbr        logger.info
    logger.info(${1})

delete      logw
snippet     logw
abbr        logger.warn
    logger.warn(${1})

delete      loge
snippet     loge
abbr        logger.error
    logger.error(${1})

delete      logf
snippet     logf
abbr        logger.fatal
    logger.fatal(${1})

snippet     fla
abbr        flash[...]
prev_word   '^'
    flash[:${1:notice}] = "${2:Successfully created...}"

alias fla flash

snippet rep
abbr redirect_to (path)
    redirect_to ${1:model}_path${2:(${3:params\})}

delete      va
snippet     va
abbr        validates_associated
    validates_associated :${1:attr}

delete      vb
snippet     vb
abbr        validates_acceptance_of
    validates_acceptance_of :${1:attr}

delete      vc
snippet     vc
abbr        validates_confirmation_of
    validates_confirmation_of :${1:attr}

delete      ve
snippet     ve
abbr        validates_exclusion_of
    validates_exclusion_of :${1:attr}, in: ${2:%w( ${3:mov avi\} )}

delete      vf
snippet     vf
abbr        validates_format_of
    validates_format_of :${1:attr}, with: /${2:regexp}/

delete      vi
snippet     vi
abbr        validates_inclusion_of
    validates_inclusion_of :${1:attr}, in: ${2:%w( ${3:mov avi\} )}

delete      vl
snippet     vl
abbr        validates_length_of
    validates_length_of :${1:attr}, within: ${2:3..20}

delete      vn
snippet     vn
abbr        validates_numericality_of
    validates_numericality_of :${1:attr}

snippet     vng
abbr        validates_numericality_of greater_than: n
    validates_numericality_of :${1:attr}, greater_than: ${2:num}

snippet     vnl
abbr        validates_numericality_of less_than: n
    validates_numericality_of :${1:attr}, less_than: ${2:num}

delete      vp
snippet     vp
abbr        validates_presence_of
    validates_presence_of :${1:attr}

delete      vu
snippet     vu
abbr        validates_uniqueness_of
    validates_uniqueness_of :${1:attr}

snippet     aln
abbr        allow_nil
    allow_nil: ${1:true}

delete      ra
snippet     ra
abbr        render :action
    render action: ${1}

delete      rc
snippet     rc
abbr        render :controller
    render controller: ${1}

delete      rf
snippet     rf
abbr        render :file
    render file: ${1}

delete      ri
snippet     ri
abbr        render :inline
    render inline: ${1}

delete      rj
snippet     rj
abbr        render :json
    render json: ${1}

delete      rl
snippet     rl
abbr        render :layout
    render layout: ${1}

delete      rp
snippet     rp
abbr        render :partial
    render partial: ${1}

delete      rt
snippet     rt
abbr        render :text
    render text: ${1}

delete      rx
snippet     rx
abbr        render :xml
    render xml: ${1}

delete id

delete object

delete partial

delete      action
snippet     action
abbr        action: name
    action: ${1}

snippet     tzn
abbr        Time.zone.now
  Time.zone.now

snippet     res
abbr        resources
prev_word   '^'
    resources :${1:resources}

alias res resources

delete      rst
snippet     rst
abbr        respond_to
prev_word   '^'
    respond_to do |format|
        format.html${1: { ${2\} \}}
        format.json { render json: ${3} }
    end

snippet     befs
abbr        before_save
prev_word   '^'
    before_save :${1:method}

snippet     befc
abbr        before_create
prev_word   '^'
    before_create :${1:method}

snippet     befu
abbr        before_update
prev_word   '^'
    before_update :${1:method}

snippet     befv
abbr        before_validation
prev_word   '^'
    before_validation :${1:method}

snippet     befvc
abbr        before_validation_on_create
prev_word   '^'
    before_validation_on_create :${1:method}

snippet     befvu
abbr        before_validation_on_update
prev_word   '^'
    before_validation_on_update :${1:method}

snippet     befd
abbr        before_destroy
prev_word   '^'
    before_destroy :${1:method}

snippet     afts
abbr        after_save
prev_word   '^'
    after_save :${1:method}

snippet     aftc
abbr        after_create
prev_word   '^'
    after_create :${1:method}

snippet     aftu
abbr        after_update
prev_word   '^'
    after_update :${1:method}

snippet     aftv
abbr        after_validation
prev_word   '^'
    after_validation :${1:method}

snippet     aftvc
abbr        after_validation_on_create
prev_word   '^'
    after_validation_on_create :${1:method}

snippet     aftvu
abbr        after_validation_on_update
prev_word   '^'
    after_validation_on_update :${1:method}

snippet     aftd
abbr        after_destroy
prev_word   '^'
    after_destroy :${1:method}

snippet     try
abbr        try(:method)
    try(:${1:method})
</pre></div>
</div>

<div class="code-frame" data-lang="snippet">
<div class="code-lang"><span class="bold">rspec.snip</span></div>
<div class="highlight"><pre><span></span>snippet desc
abbr    describe end
prev_word '^'
    describe "${1:name}" do
        ${2}
    end

snippet desch
abbr    spec_helper describe
    require 'spec_helper'

    describe ${1:`Snippet_RubySpecNameFromFilename()`} do
        ${2}
    end

snippet desccon
    describe "${1:GET|POST|PUT|DELETE} ${2:/some/path}${3}" do
        ${4}
    end

snippet bef
    before do
        ${1}
    end

alias bef before

snippet befa
    before(:all) do
        ${1}
    end

alias befa beforeall

snippet aft
    after do
        ${1}
    end

alias aft after

snippet afta
    after(:all) do
        ${1}
    end

alias afta afterall

snippet con
    context "${1}" do
        ${2}
    end

alias con context

snippet cona
abbr context after callback
    context "after #${1:save!}" do
        before do
            subject.$1
        end
        ${2}
    end

snippet subjc
    subject { ${1:FactoryGirl.create(:${2:name\})} }

snippet subjb
    subject { ${1:FactoryGirl.build(:${2:name\})} }

snippet it
    it "${1}" do
        ${2}
    end

snippet itb
abbr        it {}
        it { ${1} }

snippet its
    it "should ${1:work correctly}" do
        ${2}
    end

snippet is
    it { should ${1} }

snippet isn
    it { should_not ${1} }

snippet sh
    should == ${1:value}
    ${2}

snippet shn
    should_not == ${1:value}
    ${2}

snippet shs
    should satisfy { |${1:obj}| ${2} }
    ${3}

snippet shp
    should be_${1:predicate}

alias shp shbe

snippet shh
    should have(${1:num}).${2:things}
    ${3}

snippet she
    should eq(${1:value})
    ${3}

snippet shne
    should_not eq(${1:value})
    ${2}

snippet shnredt
    response.should_not redirect_to(${1:url})
    ${2}

snippet shbw
    should be_within(${1:tolerance}).of(${2:result})
    ${3}

snippet shnbw
    should_not be_within(${1:tolerance}).of(${2:result})
    ${4}

snippet shhal
    should have_at_least(${1:num}).${2:things}
    ${3}

snippet shhi
    should have(${1:n}).records
    ${2}

snippet shns
    should_not satisfy { |${1:obj}| ${2} }
    ${3}

snippet shbko
    should be_a_kind_of(${1:class})
    ${2}

snippet shnbko
    should_not be_a_kind_of(${1:klass})
    ${2}

snippet shnbe
    .should_not be_${1:predicate}

snippet shre
    should raise_error(${1:error})
    ${2}

snippet shnre
    should_not raise_error(${1:error})
    ${2}

alias shre shraise

snippet shc
    expect {
        ${1}
    }.should change(${2:described_class}, :${3:count}).by(${4:1})

alias shc exshc

snippet shnc
    expect {
        ${1}
    }.should_not change(${2:target}, :${3:method})

snippet shrt
    should respond_to(:${1:sym})
    ${2}

snippet shnrt
    should_not respond_to(:${1:sym})
    ${2}

snippet shr
    should_receive(:${1:message})${2}
    ${3}

snippet shnr
    should_not_receive(:${1:message})${2}
    ${3}

snippet wia
    with(${1:args})
    ${2}

snippet shm
    should match(/${1:regexp}/)
    ${2}

snippet shnm
    should_not match(/${1:regexp}/)
    ${2}

snippet shredt
    response.should redirect_to(${1:url})
    ${2}

snippet shbr
    response.should be_redirect
    ${1}

snippet shnbr
    response.should_not be_redirect
    ${1}

snippet shbs
    response.should be_success
    ${1}

snippet shnbs
    response.should_not be_success
    ${1}

snippet shtemp
    response.should render_template(:${1:template})
    ${2}

snippet shbio
    should be_instance_of(${1:class})
    ${2}

snippet shnbio
    should_not be_instance_of(${1:klass})
    ${2}

snippet sc
abbr shared_context do end
    shared_context "${1:condition}" do
        ${2}
    end

alias sc shared_context

snippet scm
abbr shared_context with metadata
    shared_context "${1:condition}", :${2:key} =&gt; ${3:value} do
        ${4}
    end

snippet inc
abbr include_context
    include_context "${1}"

alias inc include_context

snippet se
abbr shared_examples do end
    shared_examples "${1:do something}" do
        ${2}
    end

alias se shared_examples

snippet sed
    shared_examples "${1:}" do
        describe "as $1" do
            ${2}
        end
    end

snippet ibl
abbr it_behaves_like
    it_behaves_like '${1}'

alias ibl it_behaves

snippet ine
abbr include_examples
    include_examples "${1}"

alias ine include_examples

snippet let
abbr let {}
    let(:${1}) { ${2} }

snippet let!
abbr let! {}
    let!(:${1}) { ${2} }

snippet letf
    let(:${1:model}) do 
        FactoryGirl.create(:${2:$1})
    end

snippet atl
    at_least(${1:n}).times

snippet atm
    at_most(${1:n}).times

snippet on
    once

snippet tw
    twice

snippet ber
    be_redirect

snippet ex
    exactly(${1:n}).times

alias ex exact

snippet annot
    any_number_of_times

snippet shham
    ${1:target}.should have_at_most(${2:num}).${3:things}
    ${4}

snippet ant
    and_throw(${1:sym})

snippet any
    and_yield(${1:values})

snippet mat
    RSpec::Matchers.define :${1:matcher_name} do
        match do |model|
            # return Boolean
            ${2}
        end
    end

alias mat matcher


snippet anr
    and_return(${1:value})

snippet anrb
    and_return { ${1} }

snippet anra
    and_raise(${1:exception})

snippet st
    stub(:${1:method}).and_returns(${2:return})

alias st stub

snippet sm
    stub_model(${1:model}, {${2}})
snippet mm
    mock_model(${1:model})${2}

snippet moc
    ${1:var} = mock("${2:mock_name}"${3:, :null_object =&gt; true})
    ${4}

snippet facb
    FactoryGirl.build(:${1})

snippet fac
    FactoryGirl(:${1}, ${2})

snippet facc
    FactoryGirl.create(:${1})

snippet facs
    sequence(:${1}) {|n| "${2}#{n}"}

snippet facn
    FactoryGirl.next(:${1:sequence-name})

snippet faca
    f.${1:model} {|a| a.association(:${2:$1})}

snippet facd
    FactoryGirl.define do
        ${1}
    end

snippet facf
    factory ${1:name} do
        ${2}
    end
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />21位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>48</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/0d13b6e96084adf8f864">poltergeistとfeature specで簡単なパフォーマンステストを実現する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-25 00:50:16</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[RSpec]</b> <b>[PhantomJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>最近、JSも交えた総合テストを実施するのにRails界隈で良く使われている(と思う)<a href="https://github.com/jonleighton/poltergeist" title="jonleighton/poltergeist" rel="nofollow noopener" target="_blank">jonleighton/poltergeist</a>。<br>
poltergeistはWebブラウザ操作DSLであるcapybaraのドライバとして動作します。<br>
実際はphantomJSがバックエンドとして動いています。<br>
phantomJSとRubyがどうやってやり取りしてるかは気が向いたら書くとして、<br>
今回はpoltergeistを使って行う簡単なパフォーマンステストについて書きます。</p>

<p>ちなみに複数のクライアントから同時にアクセスするタイプのものではなく、<br>
一つのクライアントでアクセスした時のレスポンスが来るまでの時間を測る感じです。<br>
ラッシュかけたい場合には使えないので他の方法を考えましょう。</p>

<p>RSpecとcapybaraでfeature spec、つまり総合的なシナリオテストを書く時は以下のようになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">feature</span> <span class="s2">"ユーザーを検索して一覧できる"</span><span class="p">,</span> <span class="ss">js</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span>
  <span class="n">scenario</span> <span class="s2">"ユーザー検索ページを開き、ユーザーを検索して一覧する"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">users_path</span>
    <span class="n">find</span><span class="p">(</span><span class="s2">"#search_user_field"</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">"username"</span><span class="p">)</span>
    <span class="n">click_button</span><span class="p">(</span><span class="s1">'Search'</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">".user"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>ページ開いてフォームに値入れて検索ボタンを押して結果確認、って感じです。<br>
実際は、こんな簡単では無いですが…。</p>

<p>で、この検索結果のレスポンスが平均200ms以下で帰ってきて欲しいとします。</p>

<p>ここで、<a href="https://github.com/rack/rack-contrib" title="rack/rack-contrib" rel="nofollow noopener" target="_blank">rack/rack-contrib</a>を利用します。<br>
rack-contribには<code>Rack::Runtime</code>というミドルウェアが含まれてます。<br>
これは<code>Rack::Runtime</code>以下の処理に入って戻ってくるまでの処理時間を<code>X-Runtime</code>というキーでレスポンスヘッダに追加してくれるミドルウェアです。</p>

<p>これを利用することで、実際にコントローラーがリクエストを受け取って、レンダリングして処理を返すまでの時間が簡単に測れます。<br>
後はこれをrspec側で取得して集計できればオッケーです。</p>

<p>レスポンスヘッダの情報を取得する時にpoltergeistで使える機能は二つあります。<br>
それが<code>response_headers</code>と<code>network_traffic</code>です。</p>

<p><code>response_headers</code>は、最後にvisitで移動した際のレスポンスヘッダをハッシュの配列として返してくれます。<br>
単純なハッシュじゃないので微妙にアクセスしづらいですが。</p>

<p><code>network_traffic</code>は、今までに発生したアクセス全てのリクエストとそれに対応する結果の記録を返してくれます。<br>
これはブラウザ内のJSの動作で発生したAjaxのリクエストや画像の取得等も含みます。<br>
これは地味に結構便利な機能です。</p>

<p>この例だと<code>response_headers</code>で取得するだけで充分ですが、もしAjaxでフォームの送信が行われるような場合は<code>network_traffic</code>を使うと良いでしょう。<br>
ちなみに<code>network_traffic</code>は<code>clear_network_traffic</code>で消去できます。</p>

<p>これでヘッダの情報が取れるので<code>X-Runtime</code>の情報を集めて集計しましょう。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">feature</span> <span class="s2">"ユーザーを検索して一覧できる"</span><span class="p">,</span> <span class="ss">js</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span>
  <span class="n">scenario</span> <span class="s2">"ユーザーを検索して結果が返るまでの平均時間が200ms以下であること"</span> <span class="k">do</span>
    <span class="n">response_times</span> <span class="o">=</span> <span class="n">collect_response_time</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="sr">%r(/users/search$)</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">users_path</span>
      <span class="n">find</span><span class="p">(</span><span class="s2">"#search_user_field"</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">"username"</span><span class="p">)</span>

      <span class="n">click_button</span><span class="p">(</span><span class="s1">'Search'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">response_times</span><span class="o">.</span><span class="n">sum</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">2</span> <span class="c1"># Enumerable#sumはActiveSupport</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">collect_response_time</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">http_method</span><span class="p">,</span> <span class="n">url_pattern</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="n">response_times</span> <span class="o">=</span> <span class="o">[]</span>

  <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
    <span class="n">page</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">clear_network_traffic</span> <span class="c1"># 前ループの履歴を消す</span>

    <span class="n">block</span><span class="o">.</span><span class="n">call</span>

    <span class="n">response_times</span> <span class="o">&lt;&lt;</span> <span class="n">page</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">network_traffic</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">http_method</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">.</span><span class="n">url</span> <span class="o">=~</span> <span class="n">url_pattern</span> <span class="c1"># アクセス対象を特定する</span>
    <span class="p">}</span><span class="o">.</span><span class="n">response_parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span><span class="o">|</span><span class="n">h</span><span class="o">|</span>
      <span class="n">h</span><span class="o">[</span><span class="s2">"name"</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"X-Runtime"</span>
    <span class="p">}</span><span class="o">[</span><span class="s2">"value"</span><span class="o">]</span><span class="p">,</span><span class="n">to_f</span> <span class="c1"># nameがX-Runtimeのヘッダのvalueを取得する</span>
  <span class="k">end</span>

  <span class="n">response_times</span>
<span class="k">end</span>
</pre></div></div>

<p>並列化とか考えてないのでそれなりに時間かかりますが、メタデータで上手く分けておいてJenkinsに日次で流すなどしてもらうのが良いかと思います。</p>

<p>そこまで正確ではないし1リクエストごとのレスポンスですが、メイン機能や重い計算が走る処理などに対して、手慣れたRSpecでざっくりとレスポンスが計測出来ると結構便利です。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />22位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>47</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/0eba515dad2b2f6d0192">最近(2013/11/18)のspring(Railsのコマンドを高速化する方)について</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-18 21:46:12</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><em>DEPRECATED:既に古いので<a href="http://qiita.com/joker1007/items/82e88f88bd10aff2baf9" id="reference-394fd9cbc71b1aa75ce8">こっち</a>を見てください</em></p>

<hr>

<p>springについてとだけ書くと誤解を招きそうなので、説明的なタイトルにした。</p>

<p>Railsのコマンドを高速化するgemとして最近流行ってる<a href="https://github.com/jonleighton/spring" title="jonleighton/spring" rel="nofollow noopener" target="_blank">spring</a>というgemがあります。</p>

<p>ちょっと前にバージョンが上がって、rspecとかcucumberを呼び出すためのコマンドが別のgemに切り出されました。<br>
そのため微妙に使いづらくなった気がします。</p>

<p>rspecとcucumberのためのサブコマンドは以下のgemで提供されています。</p>

<ul>
<li><a href="https://github.com/jonleighton/spring-commands-rspec" title="jonleighton/spring-commands-rspec" rel="nofollow noopener" target="_blank">jonleighton/spring-commands-rspec</a></li>
<li><a href="https://github.com/jonleighton/spring-commands-cucumber" title="jonleighton/spring-commands-cucumber" rel="nofollow noopener" target="_blank">jonleighton/spring-commands-cucumber</a></li>
</ul>

<p>READMEを読むとGemfileに書け、って書いてあるんですが、書くとspringもインストールされます。<br>
ところが、spring本体のREADMEを読むと、<code>bundle exec</code>無しで利用するように作ってると書かれています。<br>
別に<code>bundle exec</code>しても動かない事は無いのですが、若干起動が遅くなります。</p>

<p>なんか微妙に矛盾してる気がしてモヤっとするので、自分なりの方法考えました。</p>

<p>まずサブコマンドも含めて<code>gem install</code>で入れます。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% gem install spring spring-commands-rspec spring-commands-cucumber
</pre></div></div>

<p>それから<code>~/.spring.rb</code>を書きます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spring-commands-rspec'</span>
<span class="nb">require</span> <span class="s1">'spring-commands-cucumber'</span>
</pre></div></div>

<p>とりあえずこれで、どこからspringを呼び出しても、rspecとcucumberのためのサブコマンドが使えます。</p>

<p>他にもプロジェクトディレクトリの<code>config/spring.rb</code>に書くとか、Gemfileに書いておいてBundlerでインストールされる<code>spring</code>本体はスルーするとか、やり方はあります。好きな方法を選んでください。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />23位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>34</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/56686dea09154dfec3e8">GithubのWeb Hookを受け取るプロキシサーバー 「Octogate」</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-03 12:20:28</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[GitHub]</b> <b>[Jenkins]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>JenkinsのGithubフックの受け口がどうにも不安定でしかも設定に柔軟性が無い。<br>
せっかくGithubのフックが送ってくれるデータには色々な情報が含まれているのにイマイチ活用し切れない。</p>

<p>というわけで、間に噛ませるプロキシサーバーを作ってみた。</p>

<p><a href="https://github.com/joker1007/octogate" title="joker1007/octogate" rel="nofollow noopener" target="_blank">joker1007/octogate</a></p>

<p>特徴は以下のとおり。</p>

<ul>
<li>Sinatra製でHerokuで簡単に動かせる</li>
<li>gemになっていて、コマンド一発で起動できる</li>
<li>どこに転送するかの定義をRubyのDSLで記述する</li>
</ul>

<p>現在は、PushとPullRequestで発生するイベントにのみ対応してます。</p>

<p>フックの情報を元に送ったり送らなかったり、パラメーターにリポジトリやコミットの情報を利用したかったので、<br>
設定ファイルの書式を柔軟にした方が良いだろう、ということでRubyで設定のためのDSLを定義しました。<br>
一応、YAMLも考えたんですが、正規表現でリポジトリ名とマッチさせたりとか考えると無理がありそうなので止めました。</p>

<h2>
<span id="利用方法" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>利用方法</h2>

<p>起動時にコンフィグファイルやポートを指定して起動します。</p>

<p>設定ファイルの内容はこんな感じで書きます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">token</span> <span class="s2">"token_string"</span>

<span class="n">target</span> <span class="s2">"jenkins"</span> <span class="k">do</span>
  <span class="n">hook_type</span> <span class="o">[</span><span class="ss">:push</span><span class="o">]</span>
  <span class="n">url</span> <span class="s2">"http://targethost.dev/job/JobName"</span>
  <span class="n">http_method</span> <span class="ss">:post</span>

  <span class="n">parameter_type</span> <span class="ss">:query</span>
  <span class="n">params</span> <span class="ss">key1</span><span class="p">:</span> <span class="s2">"value1"</span><span class="p">,</span> <span class="ss">key2</span><span class="p">:</span> <span class="s2">"value2"</span>

  <span class="n">match</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">event</span><span class="o">.</span><span class="n">ref</span> <span class="o">=~</span> <span class="sr">/master/</span>
  <span class="p">}</span>
<span class="k">end</span>
<span class="c1"># if event type is push and event.ref contains "master",</span>
<span class="c1"># octogate requests "http://targethost.dev/job/JobName" via POST method, request body is {key1: "value1, key2: "value2"} params</span>

<span class="n">target</span> <span class="s2">"json_params"</span> <span class="k">do</span>
  <span class="n">hook_type</span> <span class="o">[</span><span class="ss">:push</span><span class="p">,</span> <span class="ss">:pull_request</span><span class="o">]</span>
  <span class="n">url</span> <span class="s2">"http://targethost.dev/job/JobName"</span>
  <span class="n">http_method</span> <span class="ss">:post</span>

  <span class="n">parameter_type</span> <span class="ss">:json</span>
  <span class="n">params</span> <span class="ss">key1</span><span class="p">:</span> <span class="s2">"value1"</span><span class="p">,</span> <span class="ss">key2</span><span class="p">:</span> <span class="s2">"value2"</span>

  <span class="n">match</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">event</span>
    <span class="k">when</span> <span class="no">Octogate</span><span class="o">::</span><span class="no">Event</span><span class="o">::</span><span class="no">PullRequest</span>
      <span class="n">event</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:pull_request</span><span class="p">)</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:head</span><span class="p">)</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:ref</span><span class="p">)</span> <span class="o">=~</span> <span class="sr">/json_params/</span>
    <span class="k">when</span> <span class="no">Octogate</span><span class="o">::</span><span class="no">Event</span><span class="o">::</span><span class="no">Push</span>
      <span class="n">event</span><span class="o">.</span><span class="n">ref</span> <span class="o">=~</span> <span class="sr">/json_params/</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>
<span class="c1"># if event type is push or pull_request, and ref name contains "json_params",</span>
<span class="c1"># octogate requests "http://targethost.dev/job/JobName" via POST method, body is {key1: "value1, key2: "value2"} as JSON FORMAT</span>


</pre></div></div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% bundle <span class="nb">exec</span> octogate -h
Usage: octogate <span class="o">[</span>options<span class="o">]</span>
    -c config                        Set config file <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> ./config.rb<span class="o">)</span>
    -p port                          Set port number <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> <span class="m">4567</span><span class="o">)</span>
    -o address                       Set address to <span class="nb">bind</span> <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> <span class="m">0</span>.0.0.0<span class="o">)</span>

% bundle <span class="nb">exec</span> octogate -c config.rb
  <span class="c1"># =&gt; Endpoint is http://hostname:4567/token_string</span>
</pre></div></div>

<p>適当にアクセスされると少し困るので、エンドポイントには設定ファイルのトークン文字列を利用します。<br>
充分に長いランダムな文字列を設定しておきます。</p>

<p>リポジトリにはもう少し設定例があります。<br>
<a href="https://github.com/joker1007/octogate/blob/master/spec/config_sample.rb" title="octogate/spec/config_sample.rb" rel="nofollow noopener" target="_blank">octogate/spec/config_sample.rb</a></p>

<h2>
<span id="herokuでホストする時" class="fragment"></span><a href="#heroku%E3%81%A7%E3%83%9B%E3%82%B9%E3%83%88%E3%81%99%E3%82%8B%E6%99%82"><i class="fa fa-link"></i></a>Herokuでホストする時</h2>

<p>適当にディレクトリを作りGemfileを用意します。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% bundle init
</pre></div></div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s2">"octogate"</span>
<span class="n">gem</span> <span class="s2">"thin"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>bundle install --path .bundle
</pre></div></div>

<p>Procfileを書きます。</p>

<div class="code-frame" data-lang="yaml">
<div class="code-lang"><span class="bold">Procfile</span></div>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bundle exec octogate -c ./config.rb -p $PORT</span>
</pre></div>
</div>

<p>上記の例を参考にコンフィグファイルを書き、gitリポジトリを作ります。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% git init .
% <span class="nb">echo</span> <span class="s2">".bundle"</span> &gt; .gitignore
% git commit -am <span class="s2">"init"</span>
</pre></div></div>

<p>Herokuにアプリを作ってpushします。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% heroku create your-app-name
% git push heroku master
</pre></div></div>

<p>後は、githubのhookポイントにエンドポイントを設定すればOKです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />24位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>33</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/16d2827519a152b514cd">CentOS 6.3で、シェルスクリプト一発でchefまでインストールする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-11-27 19:13:05</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[chef]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>そもそも、そういうVM作っておくのが一番早いんですが、直でやる場合のシェルスクリプトを作ってみた。<br>
でも、エラー処理も無く、逐次実行してるだけの超簡易なので、ネットワーク環境やその時のRubyの配布状況などを確認して利用してください。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="c1"># root executes this script</span>

<span class="c1"># Install Libraries for build</span>
yum -y install gcc-c++ patch readline readline-devel zlib zlib-devel libyaml-devel libffi-devel openssl-devel make bzip2 autoconf automake libtool bison wget unzip git 

<span class="c1"># Download Ruby</span>
wget ftp://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.3-p327.tar.gz
tar xvzf ruby-1.9.3-p327.tar.gz

<span class="c1"># Create Install Directory</span>
mkdir /opt/ruby

<span class="c1"># Configure and Compile</span>
<span class="nb">cd</span> ruby-1.9.3-p327
./configure --prefix /opt/ruby
make
make install

<span class="nb">cd</span>

<span class="c1"># Chef Install</span>
/opt/ruby/bin/gem install chef

<span class="c1"># Clone Cookbooks</span>
git clone git://github.com/opscode/cookbooks.git chef-cookbooks

<span class="c1"># Create Chef Directories</span>
mkdir /etc/chef
mkdir /var/chef-solo

<span class="c1"># Initial Setting</span>
<span class="nb">echo</span> -e <span class="s2">"file_cache_path \"/var/chef-solo\"\njson_attribs \"/etc/chef/node.json\"\ncookbook_path \"/root/chef-cookbooks\""</span> &gt; /etc/chef/solo.rb

<span class="nb">echo</span> <span class="s1">'{ "run_list": [] }'</span> &gt; /etc/chef/node.json

<span class="c1"># Write run_list</span>
<span class="c1"># /opt/bin/chef-solo</span>
</pre></div></div>

<p>/opt/rubyに入れているのは、後から削除したりちゃんと入れ直す時のためで、一時的な利用なのでPATHも通してません。</p>

<p>実際には上のスクリプトの中に、privateなリポジトリからのcookbooksのclone等も含んでいますが、公開のため削除してあります。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />25位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>32</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/69035c454de416849b8a">RubyとvimでQuick JUnit風にテスト実行</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-10 00:28:31</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[AdventCalendar]</b> <b>[開発環境]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Java &amp; Eclipseの開発環境には、Quick JUnitというテストを迅速に実行するプラグインがあります。<br>
Ruby &amp; vimの開発環境においても、ほぼ同等の事が実施可能です。</p>

<p>以前、私のブログで、プロダクションコードとテストコードを素早く切り替えるテクニック、<br>
vimから即座にRSpecを実行し、結果をバッファに表示するテクニックを紹介しました。<br>
詳細は、以下を参照してみてください。</p>

<p><a href="http://d.hatena.ne.jp/joker1007/20111107/1320671775" rel="nofollow noopener" target="_blank">RubyでTDDをやる際に、ちょっと便利になるVimの設定 - joker1007の日記</a><br>
<a href="http://d.hatena.ne.jp/joker1007/20111208/1323324569" rel="nofollow noopener" target="_blank">rspecをvim-quickrunから非同期で実行する - joker1007の日記</a></p>

<p>今回は、そこから一歩進めて、特定のテストケースだけをvim-quickrunから実行する設定を紹介します。</p>

<p>そもそもrspecには <code>-l</code> オプションを付けることで、特定の行だけテストを実施してくれる機能があります。<br>
指定した行が、<code>it/specify</code>ブロックの中ならそのケースのみ、<code>describe/context</code>ブロックなら、そのテストケースグループのみを実行してくれます。<br>
つまり、vimのカーソル行を取得してrspecのオプションに渡せばオッケーです。</p>

<h2>
<span id="設定例" class="fragment"></span><a href="#%E8%A8%AD%E5%AE%9A%E4%BE%8B"><i class="fa fa-link"></i></a>設定例</h2>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vimrc</span></div>
<div class="highlight"><pre><span></span><span class="c">" quickrunの出力結果にAnsiEscを実行して色付けする</span>
autocmd <span class="nb">FileType</span> quickrun AnsiEsc

<span class="c">" quickrunの実行モジュールをvimprocに設定する</span>
<span class="k">let</span> <span class="k">g</span>:quickrun_config <span class="p">=</span> {}
<span class="k">let</span> <span class="k">g</span>:quickrun_config._ <span class="p">=</span> {<span class="s1">'runner'</span> : <span class="s1">'vimproc'</span>}

<span class="c">" rspecを実行するための設定を定義する</span>
<span class="c">" %cはcommandに設定した値に置換される</span>
<span class="c">" %oはcmdoptに設定した値に置換される</span>
<span class="c">" %sはソースファイル名に置換される</span>
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'rspec/bundle'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'rspec/bundle'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'rspec'</span><span class="p">,</span>
  \ <span class="s1">'outputter'</span>: <span class="s1">'buffered:target=buffer'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'bundle exec %c %o --color --drb --tty %s'</span>
  \}
<span class="k">let</span> <span class="k">g</span>:quickrun_config[<span class="s1">'rspec/normal'</span>] <span class="p">=</span> {
  \ <span class="s1">'type'</span>: <span class="s1">'rspec/normal'</span><span class="p">,</span>
  \ <span class="s1">'command'</span>: <span class="s1">'rspec'</span><span class="p">,</span>
  \ <span class="s1">'outputter'</span>: <span class="s1">'buffered:target=buffer'</span><span class="p">,</span>
  \ <span class="s1">'exec'</span>: <span class="s1">'%c %o --color --drb --tty %s'</span>
  \}

<span class="c">" :QuickRunで実行されるコマンドをrspec用の定義に設定する</span>
<span class="c">" &lt;Leader&gt;lrをタイプした時に、:QuickRun -cmdopt "-l (カーソル行)"を実行するキーマップを定義する ← これがポイント</span>
<span class="k">function</span><span class="p">!</span> RSpecQuickrun<span class="p">()</span>
  <span class="k">let</span> <span class="k">b</span>:quickrun_config <span class="p">=</span> {<span class="s1">'type'</span> : <span class="s1">'rspec/bundle'</span>}
  <span class="nb">nnoremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>Leader<span class="p">&gt;</span><span class="k">lr</span> <span class="s2">"&lt;Esc&gt;:QuickRun -cmdopt \"-l "</span> . line<span class="p">(</span><span class="s2">"."</span><span class="p">)</span> . <span class="s2">"\"&lt;CR&gt;"</span>
<span class="k">endfunction</span>

<span class="c">" ファイル名が_spec.rbで終わるファイルを読み込んだ時に上記の設定を自動で読み込む</span>
autocmd <span class="nb">BufReadPost</span> *_spec.rb <span class="k">call</span> RSpecQuickrun<span class="p">()</span>
</pre></div>
</div>

<h2>
<span id="実行結果" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>実行結果</h2>

<p><a href="https://camo.qiitausercontent.com/a8642576cdef5b222af6427e6633e43465fea86c/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303132303730382f32303132303730383137313735365f6f726967696e616c2e706e673f31333431373335353239" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a8642576cdef5b222af6427e6633e43465fea86c/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f6a2f6a6f6b6572313030372f32303132303730382f32303132303730383137313735365f6f726967696e616c2e706e673f31333431373335353239" alt="出力結果" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/j/joker1007/20120708/20120708171756_original.png?1341735529"></a></p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>特定のケースだけ素早くテストを実行することで、<br>
今フォーカスしていないテストの終了を待つ必要がなくなり、<br>
よりスピーディにTDDが行えると思います。</p>

<p>Rubyのテスト環境については、okitanさんによる <a href="http://qiita.com/items/25238a9b836c14d52cbd">テストの自動実行あれこれ #Ruby #開発環境 #AdventCalendar - Qiita</a> も参照してみてください。</p>

<h2>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h2>

<p>Rubyに限りませんが、dotfiles(設定ファイル)はある程度まとめて、githubで管理しておくと便利です。<br>
私のdotfilesはこんな感じです。<br>
(一部放置されてますが・・・)</p>

<p><a href="https://github.com/joker1007/dotfiles" rel="nofollow noopener" target="_blank">joker1007/dotfiles - Github</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />26位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>27</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/82e88f88bd10aff2baf9">springのbinstubオプションとparallel_testsを同時に使うと死ぬ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-24 21:45:00</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>この記事は以下のバージョンにおいて再現する問題です</p>

<ul>
<li>spring v1.1.1</li>
<li>parallel_tests v0.16.10</li>
</ul>

<p>しばらく前に、Railsのコマンドを高速化するgemの<a href="https://github.com/rails/spring" title="rails/spring" rel="nofollow noopener" target="_blank">spring</a>の推奨インストール方法が変わった。<br>
多分、Rails 4.1.0から標準になるからだと思うが。</p>

<p>で、今の公式のインストール方法によるとこんな感じ。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s2">"spring"</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
<span class="n">gem</span> <span class="s2">"spring-commands-rspec"</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
<span class="n">gem</span> <span class="s2">"spring-commands-cucumber"</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</pre></div></div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ bundle install
$ bundle <span class="nb">exec</span> spring binstub --all
</pre></div></div>

<p>binstubを作ってWrapしておけば、透過的に早くなって楽だよねって感じです。<br>
で、rspecとかcucumberにspringを対応させるgemを入れておけば、この二つもbinstubを作ってくれるのですが、これが問題です。</p>

<p>parallel_testsでrspecの実行コマンドを探すコードがこうなってます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">determine_executable</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="k">case</span>
  <span class="k">when</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">"bin/rspec"</span><span class="p">)</span>
    <span class="s2">"bin/rspec"</span>
  <span class="k">when</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="s2">"script/spec"</span><span class="p">)</span>
    <span class="s2">"script/spec"</span>
  <span class="k">when</span> <span class="no">ParallelTests</span><span class="o">.</span><span class="n">bundler_enabled?</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">run</span><span class="p">(</span><span class="s2">"bundle show rspec-core"</span><span class="p">)</span> <span class="o">=~</span> <span class="sr">%r{Could not find gem.*}</span> <span class="p">?</span> <span class="s2">"spec"</span> <span class="p">:</span> <span class="s2">"rspec"</span><span class="p">)</span>
    <span class="s2">"bundle exec </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">else</span>
    <span class="sx">%w[spec rspec]</span><span class="o">.</span><span class="n">detect</span><span class="p">{</span><span class="o">|</span><span class="n">cmd</span><span class="o">|</span> <span class="nb">system</span> <span class="s2">"</span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --version &gt; /dev/null 2&gt;&amp;1"</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">cmd</span> <span class="ow">or</span> <span class="k">raise</span><span class="p">(</span><span class="s2">"Can't find executables rspec or spec"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>つまり、binstubで作られたコマンドが最初に引っ掛かります。<br>
そうすると、勝手にspring経由でrspecが実行されて環境変数が切り替わらなくなります。<br>
結果、データベースをプロセスごとに切り替えられなくなって、DB競合で死にます。</p>

<p>というわけで、binstubを使う場合は、rspecとかcucumberは外しておいた方が良さそうです。<br>
parallel_testsを使わない場合は便利なんですけどね…。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />27位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>27</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/76e28ebb88cb08bb8b09">parallel_testsとsimplecovを同時に使うとcoverageが正しく計算されない問題を解決する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-03 14:48:54</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>parallel_testsを使うと、プロセスが複数立ち上がるため、<br>
設定無しでsimplecovと併用すると、coverageが上書きされてしまって、一つのプロセス分しか結果が残らない。<br>
なので、多少ハックが要る。<br>
実は、githubのissueにちゃんと解決策が書いてあるんで、使い込んでる人には既知だと思うけど、<br>
英語なので日本語化プラス自分が使ってる方法ということで書いておく。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">spec_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">Spork</span><span class="o">.</span><span class="n">prefork</span> <span class="k">do</span>
  <span class="no">ENV</span><span class="o">[</span><span class="s2">"RAILS_ENV"</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>

  <span class="c1"># for SimpleCov</span>
  <span class="k">unless</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'DRB'</span><span class="o">]</span>
    <span class="nb">require</span> <span class="s1">'simplecov'</span>
    <span class="no">SimpleCov</span><span class="o">.</span><span class="n">merge_timeout</span> <span class="mi">3600</span>
    <span class="no">SimpleCov</span><span class="o">.</span><span class="n">command_name</span> <span class="s2">"rspec_</span><span class="si">#{</span><span class="no">Process</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span><span class="n">to_s</span><span class="si">}#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">'TEST_ENV_NUMBER'</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="no">SimpleCov</span><span class="o">.</span><span class="n">start</span> <span class="s1">'rails'</span>
  <span class="k">end</span>

  <span class="c1"># ... 以下、ライブラリの読み込みとか、RSpec.configureとか</span>
  <span class="c1"># ... 中略</span>
<span class="k">end</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">each_run</span> <span class="k">do</span>
  <span class="k">if</span> <span class="no">Spork</span><span class="o">.</span><span class="n">using_spork?</span>
    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="o">.</span><span class="n">clear</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">instantiate_observers</span>
    <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">reload</span>
  <span class="k">end</span>

  <span class="c1"># This code will be run each time you run your specs.</span>

  <span class="c1"># for SimpleCov</span>
  <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'DRB'</span><span class="o">]</span>
    <span class="nb">require</span> <span class="s1">'simplecov'</span>
    <span class="no">SimpleCov</span><span class="o">.</span><span class="n">merge_timeout</span> <span class="mi">3600</span>
    <span class="no">SimpleCov</span><span class="o">.</span><span class="n">command_name</span> <span class="s1">'rspec'</span>
    <span class="no">SimpleCov</span><span class="o">.</span><span class="n">start</span> <span class="s1">'rails'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>sporkを使ってない場合は、最初の<code>require 'simplecov'</code>以下をspec_helperの頭に書いておけばいいと思う。<br>
要は、以下の設定が必要。</p>

<ul>
<li>カバレッジの結合時間のタイムアウトを指定して、その時間以内のテスト実行ならマージされるようにする。</li>
<li>プロセスIDやテスト実行番号を使ってカバレッジ結果が別々のコマンドで実行されたように見せる。</li>
<li>bundlerで勝手にrequireしないように、<code>:require =&gt; false</code>を渡しておく</li>
</ul>

<p>cucumberでもsuppot/env.rbに同様の設定をすれば、parallel_testsに対応できる。</p>

<p>しかし、guard-sporkでテスト回してる時はカバレッジ出たり出なかったりする。<br>
cucumberでは出るのにrspecでは出ないとか、よくわからない・・・。<br>
まあ、parallelで回す時はspork使えないから別にいいかと細かい所は諦めている。<br>
もうちょっといいやり方をご存知の方は、是非御教授をお願いします。</p>

<p>参考:<br>
<a href="https://github.com/colszowka/simplecov/issues/64" rel="nofollow noopener" target="_blank">Automatically detect the usage of parallel tests and modify setup · Issue #64 · colszowka/simplecov</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />28位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>24</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/38ec69ac7d6d809dce3b">vim-metarw-qiitaを作ってみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-13 16:13:25</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> <b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://github.com/kana/vim-metarw" title="kana/vim-metarw" rel="nofollow noopener" target="_blank">kana/vim-metarw</a>というプラグインがあります。<br>
一覧の取得とバッファの読み書きを抽象化して、何でも読み書きできるようなフレームワークを作ってくれるものです。</p>

<p><a href="http://mattn.kaoriya.net/software/vim/20121204090702.htm" title="Big Sky :: モテる Vim 使いに読み書き出来ないファイルなどなかったんだよ！" rel="nofollow noopener" target="_blank">この記事</a>が参考になりました。</p>

<p>これを利用して、Qiitaの記事を読み書きできるプラグインを作ってみました。<br>
<a href="https://github.com/joker1007/vim-metarw-qiita" title="joker1007/vim-metarw-qiita" rel="nofollow noopener" target="_blank">joker1007/vim-metarw-qiita</a></p>

<p>vim-metarw凄い楽ですね。<br>
webapi-vimと組み合わせれば、API提供されてるものはかなりサクっと読み書きできるようになります。<br>
それでもvimscript書くのに慣れてないので2日ぐらいかかりましたが。</p>

<p>現在、以下の機能があります。</p>

<h3>
<span id="vimrcでの設定" class="fragment"></span><a href="#vimrc%E3%81%A7%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>vimrcでの設定</h3>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="k">g</span>:qiita_user<span class="p">=</span><span class="s1">'joker1007'</span>
<span class="k">let</span> <span class="k">g</span>:qiita_token<span class="p">=</span><span class="s1">'xxxxxx'</span> <span class="c">" API経由で取得しておく</span>

<span class="c">" Optional</span>
<span class="k">let</span> <span class="k">g</span>:qiita_per_page<span class="p">=</span><span class="m">50</span> <span class="c">" Max 100</span>
</pre></div></div>

<p>cf. <a href="https://qiita.com/docs#18" title="Qiita APIドキュメント - Qiita:Developer">Qiita APIドキュメント - Qiita:Developer</a></p>

<h3>
<span id="format" class="fragment"></span><a href="#format"><i class="fa fa-link"></i></a>Format</h3>

<p>1行目がタイトル。<br>
2行目がタグ。書式はスペース区切りでタグを分ける。タグ名に続けて<code>:</code>を書いてバージョン番号を記述可能。<br>
1行空けて4行目から本文。</p>

<h3>
<span id="post-current-buffer-as-new-item" class="fragment"></span><a href="#post-current-buffer-as-new-item"><i class="fa fa-link"></i></a>Post current buffer as new item</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write qiita:
</pre></div></div>

<p>private post</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write qiita:?private=1
</pre></div></div>

<p>post and tweet</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write qiita:?tweet=1
</pre></div></div>

<p>post and gist it</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write qiita:?tweet=1
</pre></div></div>

<p>multi parameter</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write qiita:?private=1&amp;tweet=1&amp;gist=1
</pre></div></div>

<h3>
<span id="get-my-item-list" class="fragment"></span><a href="#get-my-item-list"><i class="fa fa-link"></i></a>Get my item list</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:edit qiita:users/&lt;my_username&gt;
</pre></div></div>

<p>or</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:QiitaMine
</pre></div></div>

<h3>
<span id="update-current-open-item" class="fragment"></span><a href="#update-current-open-item"><i class="fa fa-link"></i></a>Update current open item</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write
</pre></div></div>

<h3>
<span id="get-user-item-list" class="fragment"></span><a href="#get-user-item-list"><i class="fa fa-link"></i></a>Get user item list</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:edit qiita:users/&lt;username&gt;
</pre></div></div>

<p>or</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:QiitaUserItems &lt;username&gt;
</pre></div></div>

<h3>
<span id="get-tag-item-list" class="fragment"></span><a href="#get-tag-item-list"><i class="fa fa-link"></i></a>Get tag item list</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:edit qiita:tags/&lt;tagname&gt;
</pre></div></div>

<p>or</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:QiitaTagItems &lt;tagname&gt;
</pre></div></div>

<h3>
<span id="stock-current-open-item" class="fragment"></span><a href="#stock-current-open-item"><i class="fa fa-link"></i></a>Stock current open item</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:QiitaStock
</pre></div></div>

<h3>
<span id="open-by-browser" class="fragment"></span><a href="#open-by-browser"><i class="fa fa-link"></i></a>Open by browser</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:QiitaBrowse
</pre></div></div>

<h3>
<span id="screencast" class="fragment"></span><a href="#screencast"><i class="fa fa-link"></i></a>ScreenCast</h3>

<p><a href="https://camo.qiitausercontent.com/32c13100a9c60184a497fef64dba6f61b8392b3e/687474703a2f2f6769667a6f2e6e65742f704d6c546234684e56572e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/32c13100a9c60184a497fef64dba6f61b8392b3e/687474703a2f2f6769667a6f2e6e65742f704d6c546234684e56572e676966" alt="screencast" data-canonical-src="http://gifzo.net/pMlTb4hNVW.gif"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />29位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>21</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/c8962f9325a5433dc50d">unite-grepのバックエンドをagに切り替える</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-01 11:59:18</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="k">g</span>:unite_source_grep_command <span class="p">=</span> <span class="s1">'ag'</span>
<span class="k">let</span> <span class="k">g</span>:unite_source_grep_default_opts <span class="p">=</span> <span class="s1">'--nocolor --nogroup'</span>
<span class="k">let</span> <span class="k">g</span>:unite_source_grep_recursive_opt <span class="p">=</span> <span class="s1">''</span>
<span class="k">let</span> <span class="k">g</span>:unite_source_grep_max_candidates <span class="p">=</span> <span class="m">200</span>
</pre></div></div>

<p>これをvimrcに書く。</p>

<p>追記: 最初からrecursiveだからオプション要らなかった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />30位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>19</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/965b63912512be94afa3">Ruby 1.8のハッシュロケットを使ってしまって斧を投げられないように、一発で1.9形式に変換するvimの設定</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-23 16:24:10</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>現実逃避のための小ネタ。<br>
Inspired by <a href="http://qiita.com/kwappa/items/367ce6fe65fed922ae02" title="Ruby - Hash Rocketを1.9記法に置換するelisp - Qiita [キータ]" id="reference-acb08232a7ef083a5ac2">Ruby - Hash Rocketを1.9記法に置換するelisp - Qiita [キータ]</a></p>

<p>elispがあるんだからvimも書いておこう。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" to 1.9 hash</span>
<span class="nb">vnoremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>C<span class="p">-</span><span class="k">h</span><span class="p">&gt;</span> :s<span class="sr">/:\([a-zA-Z0-9_]\+\)\s*=&gt;/</span>\<span class="m">1</span>:/<span class="k">g</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>
</pre></div></div>

<p>Shift-Vとかで複数行選択してやれば、特定範囲でサクっと。<br>
自分は手頃なキーマップが空いてなかったのでビジュアルモードにだけ割り当ててるけど、その他でも使いたかったらvnoremapをnnoremapに変えれば、ノーマルモードでもそのまま利用できる。<br>
その時はカーソルのある行だけ。</p>

<p>逆方向の変換? 不要ですよね。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />31位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/4c5cd9dc02340c117426">続・Jenkinsのテスト結果をGithubのPull Requestに表示する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-13 15:10:08</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[GitHub]</b> <b>[Jenkins]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://qiita.com/joker1007/items/6352b81fc9222e9c23ec" title="Ruby - Githubのpull requestページに、テスト結果を表示するJenkisの設定 - Qiita [キータ]" id="reference-a4ea998a6cdf5b99b7d9">Ruby - Githubのpull requestページに、テスト結果を表示するJenkisの設定 - Qiita [キータ]</a>の続きです。</p>

<p>拙作の<a href="https://github.com/joker1007/github-commit-status-updater" title="joker1007/github-commit-status-updater" rel="nofollow noopener" target="_blank">joker1007/github-commit-status-updater</a>というgemがあったのですが、何度かPull Requestを頂きまして、更に便利になりました。<br>
元々はコマンドラインからコミットハッシュを指定してステータスの更新するだけのツールだったのですが、関連URLの設定、descriptionの設定、エンドポイント変更によりGithub Enterpriseでも利用可能、という感じになってます。<br>
自分は何もやってないのに、すげー便利になってgithubすげーって感じです。<br>
本当にありがとうございます。</p>

<p>それに伴って、Jenkinsの設定も進化したので共有しておきたいと思います。<br>
具体的には、よりパラメータ化する事で汎用化しました。<br>
Parameterized Triggerを使ってテスト結果をパラメーターに仕込んで更新用のジョブをキックするやり方は基本的に変わっていません。</p>

<h2>
<span id="commit-status-更新ジョブの設定内容" class="fragment"></span><a href="#commit-status-%E6%9B%B4%E6%96%B0%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%86%85%E5%AE%B9"><i class="fa fa-link"></i></a>commit status 更新ジョブの設定内容</h2>

<p>まず適当な名前でJobを作ります。<br>
今回はCommitStatusUpdateという名前とします。</p>

<ol>
<li>ビルドのパラメーター化にチェック</li>
<li>以下のパラメーターを定義する

<ul>
<li>COMMIT_STATUS - 文字列</li>
<li>UPDATE_COMMIT - 文字列</li>
<li>TARGET_URL - 文字列</li>
<li>REPOSITORY_NAME - 文字列</li>
</ul>
</li>
<li>gitリポジトリのURLをgit://github.com/joker1007/github-commit-status-updater.gitにセット</li>
<li>(オプション) rbenvの設定を行う</li>
</ol>

<p>以下、ビルド設定</p>

<ol>
<li>ENV inject PluginでPATH=${WORKSPACE}/bin:${PATH}と環境変数を追加する</li>
<li>シェルの実行で以下のコマンドを実行する</li>
</ol>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>bundle install --path .bundle
github-commit-status-updater <span class="si">${</span><span class="nv">COMMIT_STATUS</span><span class="si">}</span> -r <span class="si">${</span><span class="nv">REPOSITORY_NAME</span><span class="si">}</span> -s <span class="si">${</span><span class="nv">UPDATE_COMMIT</span><span class="si">}</span> --oauth-token TOKEN --target_url <span class="si">${</span><span class="nv">TARGET_URL</span><span class="si">}</span>
</pre></div></div>

<p>TOKENは各自書き換え。</p>

<p>最終的にコミット対象のハッシュとリポジトリ名さえ分かれば問題無いので、参照するリポジトリはgemのリポジトリでオッケーです。<br>
もしOAuthのトークンがプロジェクト毎に異なるなら、ここもパラメーター化しておきます。</p>

<h2>
<span id="メインのテスト実行ジョブの設定内容" class="fragment"></span><a href="#%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E5%AE%9F%E8%A1%8C%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%86%85%E5%AE%B9"><i class="fa fa-link"></i></a>メインのテスト実行ジョブの設定内容</h2>

<h3>
<span id="成功時のトリガー設定" class="fragment"></span><a href="#%E6%88%90%E5%8A%9F%E6%99%82%E3%81%AE%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>成功時のトリガー設定</h3>

<ol>
<li>ビルド後の処理にParameterized Triggerを追加。(要 Parameterized Trigger Plugin)</li>
<li>CommitStatusUpdateをキックする</li>
<li>Trigger when build isを<code>Stable or unstable but not failed</code>に設定</li>
<li>パラメーターを追加し、predefined parameterに以下の内容を追加する</li>
</ol>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>commit_status=success
UPDATE_COMMIT=${GIT_COMMIT}
REPOSITORY_NAME=github_organization_name/repository_name
TARGET_URL=${JENKINS_URL}job/${JOB_NAME}/${BUILD_NUMBER}
</pre></div></div>

<h3>
<span id="失敗時のトリガー設定" class="fragment"></span><a href="#%E5%A4%B1%E6%95%97%E6%99%82%E3%81%AE%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>失敗時のトリガー設定</h3>

<ol>
<li>ビルド後の処理にParameterized Triggerを追加。(要 Parameterized Trigger Plugin)</li>
<li>CommitStatusUpdateをキックする</li>
<li>Trigger when build isを<code>Failed</code>に設定</li>
<li>パラメーターを追加し、predefined parameterに以下の内容を追加する</li>
</ol>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>commit_status=failure
UPDATE_COMMIT=${GIT_COMMIT}
REPOSITORY_NAME=github_organization_name/repository_name
TARGET_URL=${JENKINS_URL}job/${JOB_NAME}/${BUILD_NUMBER}
</pre></div></div>

<p>build pipelineを工夫して、一回コミットを受けた後でジョブを分岐すれば、テスト開始前にpendingステータスに設定しておく事も可能です。</p>

<p>pull requestでテスト結果を見て落ちてれば、すぐにJenkinsのビルドページに飛べる。<br>
ジョブも複数ジョブで使い回せる感じになって、より良い感じになりました。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />32位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/f51f447733a1cd0fd647">poltergeist (PhantomJS) でFacebookのJavascript SDKによるログインをテストする方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-24 21:57:50</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[Facebook]</b> <b>[Capybara]</b> <b>[PhantomJS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://github.com/jonleighton/poltergeist" title="jonleighton/poltergeist" rel="nofollow noopener" target="_blank">jonleighton/poltergeist</a>というgemを使えば、capybaraのバックエンドとしてPhantomJSが使えます。</p>

<p>最近のpoltergeistにはポップアップのウインドウを扱うためのAPIが追加されてまして、これを上手く使えば、今までかなり難問だったJS SDK経由のFacebookログインがcapybaraとPhantomJS経由で実現できるようになります。</p>

<p>(注: 2013/7/24時点で、まだ正式リリースされていない機能を利用しているため、poltergeistはgithubのmasterブランチを利用する必要があります)</p>

<p>まずspec_helperを少し弄ります。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"capybara/poltergeist"</span>

<span class="no">Capybara</span><span class="o">.</span><span class="n">register_driver</span> <span class="ss">:poltergeist</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
  <span class="no">Capybara</span><span class="o">::</span><span class="no">Poltergeist</span><span class="o">::</span><span class="no">Driver</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="ss">phantomjs_options</span><span class="p">:</span> <span class="o">[</span><span class="s2">"--web-security=false"</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">find_available_port_for_test</span>
  <span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">server</span><span class="o">.</span><span class="n">addr</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="k">ensure</span>
  <span class="n">server</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">server</span>
<span class="k">end</span>

<span class="n">port</span> <span class="o">=</span> <span class="n">find_available_port_for_test</span>
<span class="no">Capybara</span><span class="o">.</span><span class="n">app_host</span> <span class="o">=</span> <span class="s2">"http://local.facebookapp.jp:</span><span class="si">#{</span><span class="n">port</span><span class="si">}</span><span class="s2">"</span> <span class="c1"># Facebookアプリに登録したドメインにしておく</span>
<span class="no">Capybara</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="n">port</span>
<span class="no">Capybara</span><span class="o">.</span><span class="n">javascript_driver</span> <span class="o">=</span> <span class="ss">:poltergeist</span>
</pre></div>
</div>

<p>app_hostを書き換える事で、capybaraが接続しに行くURLのホスト部分を書き換える事ができます。<br>
Facebookに登録したドメインでアクセスしないとセキュリティによってログインが弾かれます。<br>
app_hostは接続先のURLを書き換えるだけなので、このホスト名でアクセス出来るようにhostsを設定してローカルホストに解決されるようにしておかないと、テストサーバーまでアクセスがこなくなってしまいます。<br>
また、PhantomJSのオプションとしてweb-securityをオフにしておかないと、外部ドメインへのアクセスが弾かれてログインできなくなります。</p>

<p>続いてspecのコードです。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">facebook_login_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">visit</span> <span class="n">root_path</span>
<span class="no">Timeout</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">do</span> <span class="c1"># Facebook SDKの初期化待ち</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="k">break</span> <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">evaluate_script</span><span class="p">(</span><span class="s2">"window.fbApiInit"</span><span class="p">)</span>
    <span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">find_link</span><span class="p">(</span><span class="s2">"Login with Facebook"</span><span class="p">)</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">"click"</span><span class="p">)</span>

<span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fb_popup</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">window_handles</span><span class="o">.</span><span class="n">last</span>
<span class="n">page</span><span class="o">.</span><span class="n">within_window</span> <span class="n">fb_popup</span> <span class="k">do</span>
  <span class="n">fill_in</span> <span class="s2">"email"</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">"facebook_email@email.tst"</span> <span class="c1"># Facebookアプリ テストユーザーのメールアドレス</span>
  <span class="n">fill_in</span> <span class="s2">"pass"</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">"my_pass"</span> <span class="c1"># Facebookアプリ テストユーザーのパスワード</span>
  <span class="n">click_button</span> <span class="s2">"ログイン"</span>
<span class="k">end</span>
</pre></div>
</div>

<p>Facebook SDKの読み込み</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"fb-root"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="c1">// Additional JS functions here</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">fbAsyncInit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">FB</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
    <span class="nx">appId</span>      <span class="o">:</span> <span class="s1">'#{::Settings.facebook_app_id}'</span><span class="p">,</span> <span class="c1">// App ID</span>
    <span class="nx">channelUrl</span> <span class="o">:</span> <span class="s1">'//#{request.host_with_port}/channel.html'</span><span class="p">,</span> <span class="c1">// Channel File</span>
    <span class="nx">status</span>     <span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// check login status</span>
    <span class="nx">cookie</span>     <span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// enable cookies to allow the server to access the session</span>
    <span class="nx">xfbml</span>      <span class="o">:</span> <span class="kc">true</span>  <span class="c1">// parse XFBML</span>
  <span class="p">});</span>

  <span class="c1">// Additional init code here</span>
  <span class="nx">FB</span><span class="p">.</span><span class="nx">getLoginStatus</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">fbApiInit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="c1">// Load the SDK Asynchronously</span>
<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
   <span class="kd">var</span> <span class="nx">js</span><span class="p">,</span> <span class="nx">id</span> <span class="o">=</span> <span class="s1">'facebook-jssdk'</span><span class="p">,</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">'script'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span><span class="k">return</span><span class="p">;}</span>
   <span class="nx">js</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">);</span> <span class="nx">js</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span> <span class="nx">js</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
   <span class="nx">js</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">"//connect.facebook.net/ja_JP/all"</span> <span class="o">+</span> <span class="s2">".js"</span><span class="p">;</span>
   <span class="nx">ref</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">js</span><span class="p">,</span> <span class="nx">ref</span><span class="p">);</span>
 <span class="p">}(</span><span class="nb">document</span><span class="p">));</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>Facebook SDKは非同期読み込みなので、読み込み完了後に<code>window.fApiInitl</code>をtrueにしてpoltergeist側から初期化状況をチェックできるようにしておきます。<br>
ここでちゃんと待ちを入れないと、初期化完了前に処理が進んで画面遷移が上手くいきません。</p>

<p>その後、肝になるのが<code>page.driver.window_handles</code>です。<br>
ウインドウがポップアップするとここにウインドウハンドラが追加され、within_windowメソッドにハンドラを渡す事で、ポップアップウインドウにスコープを移す事が出来ます。<br>
このAPIを利用してFacebook SDKが開いたログインウインドウにパラメーターを入力します。</p>

<p>この時、Facebookのアプリケーション設定からテストユーザーを作成してパスワードを設定しておくと、そのユーザーでちゃんとログインする事が出来ます。<br>
なので、実際にFacebookにアクセスして正しいログインシーケンスを踏んだ結果をコールバックする事が出来ます。</p>

<p>一つ、注意点があって要求パーミッション次第ではログインボタンを押しても、権限要求画面に遷移する場合があります。その場合はOKを押して先に進む必要があります。<br>
ただ、これ同じユーザーを使い回す場合、次回以降は必要無くなるので、初回は手動でログインしてパーミッションの承認を済ませてから実行するのが良いと思います。</p>

<p>もしおかしいなと思ったら、<code>binding.pry</code>で一旦止めてpry上で対話的に操作するのがオススメです。<br>
pry上で<code>save_screenshot</code>メソッド等を活用すると、PhantomJSの状況を逐次確認しながら、対話的にブラウザを制御する事ができます。</p>

<p>実際にFacebookにアクセスできる環境が無いと実行できないため、頻繁に実行するには問題ありそうですが、スモークテストや、重要なシナリオテストなんかをcapybaraで実行する際には活用できそうです。</p>

<p>ただ、どうもJSのSDKとphantomJSが余り相性が良くないようで、読み込みの際のブラウザの状態次第でphantomJSがクラッシュしたりします。<br>
ここさえ何とかなればいいんだけど…。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />33位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>13</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/c3056f158438554d6cfe">ハッシュの配列にアクセスしやすくする簡単gemを作った</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-02 20:51:17</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>夜中の暇潰しにちょっと作ってみた。</p>

<p>例えばこういうデータ構造があったとする。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">hash_array</span> <span class="o">=</span> <span class="o">[</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"name_c"</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)},</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"name_a"</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)},</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"name_z"</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)},</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"name_b"</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)},</span>
<span class="o">]</span>
</pre></div></div>

<p>この中で最も最近作られたものの作成時間が知りたいとする。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">hash_array</span><span class="o">.</span><span class="n">max_by</span> <span class="p">{</span><span class="o">|</span><span class="n">h</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="ss">:created_at</span><span class="o">]</span><span class="p">}</span><span class="o">[</span><span class="ss">:created_at</span><span class="o">]</span> <span class="c1"># =&gt;  Time.local(2013, 10, 3, 0, 0, 0)</span>
</pre></div></div>

<p>何か超ダセェ。何か良い書き方は無いものか。<br>
ActiveRecordであれば、<code>maximum(:created_at)</code>って感じで書ける。<br>
で、ちょっと考えたのだが思い付かなかったのでメソッドを生やす作戦を取って、最終的にこう書けるようにした。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">hash_array</span><span class="o">.</span><span class="n">max_value</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span> <span class="c1"># =&gt; Time.local(2013, 10, 3, 0, 0, 0)</span>
</pre></div></div>

<p>他にもこんな感じで書ける</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># 最も前に作られたデータの名前を得る</span>
<span class="n">hash_array</span><span class="o">.</span><span class="n">min_value</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="o">&amp;</span><span class="ss">:created_at</span><span class="p">)</span> <span class="c1"># =&gt; "name_c"</span>

<span class="c1"># idが大きい順に名前をソートした配列を得る</span>
<span class="n">hash_array</span><span class="o">.</span><span class="n">sort_value</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">h</span><span class="o">|</span> <span class="o">-</span><span class="p">(</span><span class="n">h</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)}</span> <span class="c1"># =&gt; ["name_b", "name_z", "name_a", "name_c"] </span>
</pre></div></div>

<p>絶対、こういうの作ってる人居ると思うのだが、とりあえず自分のやりたいようにしてみた。<br>
作ったはいいが、自分でも使うのか分からんけど、とりあえず最初の書き方は何か嫌だ。</p>

<p><a href="https://github.com/joker1007/max_value" title="joker1007/max_value" rel="nofollow noopener" target="_blank">joker1007/max_value</a></p>

<p>本当の所、この名前を使いたかったのでわざわざgemにしただけなのだが。<br>
とりあえずgithubに置いてあるだけ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />34位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>11</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/3ac46959285039aa3966">Vimでpull requestの差分を見るためのunite-pull-request作った(まだ途中)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-09 13:58:07</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[GitHub]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="ぼくのはじめてのゆないとそーす" class="fragment"></span><a href="#%E3%81%BC%E3%81%8F%E3%81%AE%E3%81%AF%E3%81%98%E3%82%81%E3%81%A6%E3%81%AE%E3%82%86%E3%81%AA%E3%81%84%E3%81%A8%E3%81%9D%E3%83%BC%E3%81%99"><i class="fa fa-link"></i></a>ぼくのはじめてのゆないとそーす。</h2>

<p>githubの特定リポジトリのpull requestを一覧してファイルのdiffを開くuniteソース<br>
<a href="https://github.com/joker1007/unite-pull-request" title="joker1007/unite-pull-request" rel="nofollow noopener" target="_blank">unite-pull-request</a></p>

<p>GitHubのpull requestっていうのは、ゴイスーにベンリですよね。<br>
コードレビューライフが変わったり、こんなぼくでもおーぷんそーすにぱっちを送っていいんだ！って気持ちになる。</p>

<p>でも、diffは若干見辛いと思うこともある。<br>
WebページUIの限界みたいなのがあると思うけども。<br>
やっぱり手元のVimで見れた方が見易い。vimdiff結構好きだし。</p>

<p>というわけで、作ってみたのが<a href="https://github.com/joker1007/unite-pull-request" title="joker1007/unite-pull-request" rel="nofollow noopener" target="_blank">unite-pull-request</a>。</p>

<p>既に誰か作ってるのでは？感が凄いあったのだが、unite-pull-requestとunite-pullrequestは検索しても何も出なかったので、多分無いと思う。</p>

<p>とりあえずある程度使える所まで持っていくのを第一にしていたので、まだ今の所見る専用。<br>
rawデータの取得にめちゃめちゃハマってしまって、何故かプライベートリポジトリのデータが取れなくて泣きそうになった。<br>
なんだよ406 Not Acceptableって。情報が何もねえよ…。Acceptヘッダ弄っても効かねえし…。<br>
色々試行錯誤した結果、x-oauth-basic認証とraw.github.comのURLなら何故か取得できることを発見したので、そちら側に取得方法を揃えたが、そもそもこれは取得方法として正しいのだろうか。</p>

<h2>
<span id="現在の機能" class="fragment"></span><a href="#%E7%8F%BE%E5%9C%A8%E3%81%AE%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>現在の機能</h2>

<ul>
<li>特定のリポジトリのpull requestを一覧する</li>
<li>pull requestを選択すると、そのpull requestに含まれる変更されたファイルの一覧が出る</li>
<li>ファイルの一覧は、バイナリっぽい拡張子をフィルターできる</li>
<li>ファイルの追加、変更、削除に合わせて色を変える</li>
<li>変更ファイルを選択すると、baseとheadのファイルを取得してdiffを表示する</li>
<li>pull requestを選択した状態で、actionメニューからbrowseを選択すると、ブラウザでpull requestが開ける</li>
</ul>

<h2>
<span id="近々やりたいこと" class="fragment"></span><a href="#%E8%BF%91%E3%80%85%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>近々やりたいこと</h2>

<p>カーソル当ててる行にレビューコメントを付けるのは、やればなんとかなりそうな気はする。</p>

<p>問題はその他のレビューコメントの取得と表示。これはちょっと良いUIが思い付かない。<br>
まあ、そこはブラウザで見るのでも良いか…。</p>

<p>後、github APIを叩くvimプラグイン二つ目なんだけど、認証の扱いがベタ書きでダサいので何とかしたい。</p>

<h2>
<span id="スクリーンショット" class="fragment"></span><a href="#%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>スクリーンショット<a href="https://camo.qiitausercontent.com/62ef8da1d89bd5348c5a43ba1e6784d461538897/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f37382f61346364643632332d353734662d646537302d663931322d6465363737343830646433342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/62ef8da1d89bd5348c5a43ba1e6784d461538897/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f37382f61346364643632332d353734662d646537302d663931322d6465363737343830646433342e706e67" alt="スクリーンショット 2013-11-09 5.50.35.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/78/a4cdd623-574f-de70-f912-de677480dd34.png"></a>
</h2>

<p><a href="https://camo.qiitausercontent.com/c285f38a9fbda0f76a3ca81824751dc2938508e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f37382f66363531373162612d626463382d316364612d636238302d6233346133366165386133662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c285f38a9fbda0f76a3ca81824751dc2938508e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f37382f66363531373162612d626463382d316364612d636238302d6233346133366165386133662e706e67" alt="スクリーンショット 2013-11-09 5.51.03.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/78/f65171ba-bdc8-1cda-cb80-b34a36ae8a3f.png"></a><br>
<a href="https://camo.qiitausercontent.com/168c496ef10c1eafa59546b93ab13a361b158175/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f37382f31386632306638362d626237302d326664662d363733652d6338303931303265313838652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/168c496ef10c1eafa59546b93ab13a361b158175/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f37382f31386632306638362d626237302d326664662d363733652d6338303931303265313838652e706e67" alt="スクリーンショット 2013-11-09 5.51.22.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/78/18f20f86-bb70-2fdf-673e-c809102e188e.png"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />35位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/a464124787f6ada9ef22">Vimでgithub issuesを読み書きできるように、vim-metarw-github-issuesを作った</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-20 16:07:15</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[GitHub]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>vim-metarwシリーズ第二弾。<br>
自分のために作ってるので、他の人が使いやすいかどうかは良く分かりませんが、vim-metarwを使ってGithubのissueを読み書きできるようにしました。</p>

<p><a href="https://github.com/joker1007/vim-metarw-github-issues" title="joker1007/vim-metarw-github-issues" rel="nofollow noopener" target="_blank">joker1007/vim-metarw-github-issues</a></p>

<p>大枠は前回作ったvim-metarw-qiitaと余り変化ありません。</p>

<p>特定のリポジトリのissueだけでなく、organization単位でもissueを一覧できるようにしています。</p>

<p>またissueの編集、コメントの書き込みと表示もサポートしましたが、表示の都合上、変に編集すると誤爆する危険性があるので、もし利用される方が居たら自己責任で利用をお願いします。</p>

<p>vimにもうちょっと詳しくなれば、色々回避できるのかもしれない。</p>

<p>セーフモードとか用意した方が良いのかなー。でも面倒さが増えるし…。</p>

<h2>
<span id="usage" class="fragment"></span><a href="#usage"><i class="fa fa-link"></i></a>Usage</h2>

<h3>
<span id="write-vimrc" class="fragment"></span><a href="#write-vimrc"><i class="fa fa-link"></i></a>Write vimrc</h3>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="k">g</span>:github_user<span class="p">=</span><span class="s1">'joker1007'</span>
<span class="k">let</span> <span class="k">g</span>:github_token<span class="p">=</span><span class="s1">'xxxxxx'</span> <span class="c">" API経由で取得しておく</span>

<span class="c">" Optional</span>
<span class="k">let</span> <span class="k">g</span>:github_per_page<span class="p">=</span><span class="m">50</span> <span class="c">" Max 100</span>
</pre></div></div>

<h3>
<span id="post-current-buffer-as-new-item" class="fragment"></span><a href="#post-current-buffer-as-new-item"><i class="fa fa-link"></i></a>Post current buffer as new item</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write issues:repos/:owner/:repo
</pre></div></div>

<p>Caution: Not modify comment separator, otherwise post issue body with comments</p>

<h3>
<span id="open-a-issue" class="fragment"></span><a href="#open-a-issue"><i class="fa fa-link"></i></a>Open a issue</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:edit issues:repos/:owner/:repo/issues/:number
</pre></div></div>

<h3>
<span id="update-current-open-issue" class="fragment"></span><a href="#update-current-open-issue"><i class="fa fa-link"></i></a>Update current open issue</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write
</pre></div></div>

<p>Caution: Not modify comment separator, otherwise post issue body with comments</p>

<h3>
<span id="post-new-comment-to-current-open-issue" class="fragment"></span><a href="#post-new-comment-to-current-open-issue"><i class="fa fa-link"></i></a>Post new comment to current open issue</h3>

<p>Open comment buffer</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:IssueCommentPost
</pre></div></div>

<p>and save</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:write
</pre></div></div>

<p>Caution: Existing issue buffer is not refreshed. Refresh Manually.</p>

<h3>
<span id="get-issues-for-repository" class="fragment"></span><a href="#get-issues-for-repository"><i class="fa fa-link"></i></a>Get issues for repository</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:edit issues:repos/:owner/:repo
</pre></div></div>

<h3>
<span id="get-issues-for-organization" class="fragment"></span><a href="#get-issues-for-organization"><i class="fa fa-link"></i></a>Get issues for organization</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:edit issues:orgs/:org?filter=all
</pre></div></div>

<h3>
<span id="open-by-browser" class="fragment"></span><a href="#open-by-browser"><i class="fa fa-link"></i></a>Open by browser</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:IssueBrowse
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />36位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/9334348e45dd3f59830f">UnboundMethodを使って他のモジュールからメソッドを借りる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-21 16:05:48</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ふと思い付いて、以下のようなコードを書いてみた。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Module</span>
  <span class="k">def</span> <span class="nf">rental</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="ss">from</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">unbound</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="n">instance_method</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>

    <span class="n">define_method</span><span class="p">(</span><span class="n">as</span> <span class="o">||</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">unbound</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">SampleMethods</span>
  <span class="k">def</span> <span class="nf">method1</span>
    <span class="nb">puts</span> <span class="nb">name</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">SampleMethods2</span>
  <span class="k">def</span> <span class="nf">method2</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="nb">p</span> <span class="n">a</span>
    <span class="nb">p</span> <span class="n">b</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">HasName</span>
  <span class="n">rental</span> <span class="ss">:method1</span><span class="p">,</span> <span class="ss">from</span><span class="p">:</span> <span class="no">SampleMethods</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span>  <span class="ss">:puts_name</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">SampleClass</span>
  <span class="kp">include</span> <span class="no">HasName</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span>

  <span class="n">rental</span> <span class="ss">:method2</span><span class="p">,</span> <span class="ss">from</span><span class="p">:</span> <span class="no">SampleMethods2</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:p_objects</span>
<span class="k">end</span>

<span class="n">sample</span> <span class="o">=</span> <span class="no">SampleClass</span><span class="o">.</span><span class="n">new</span>
<span class="n">sample</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"MyName"</span>
<span class="n">sample</span><span class="o">.</span><span class="n">puts_name</span>
<span class="n">sample</span><span class="o">.</span><span class="n">p_objects</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>

<p>モジュールはインスタンスを持たないけど、インスタンスの振舞いは持ってるのでちゃんと<code>instance_method</code>が取れる。<br>
<code>instance_method</code>の戻り値は<code>UnboundMethod</code>。<br>
<code>Module#define_method</code>は<code>UnboundMethod</code>を引数に取れるらしい。</p>

<p>Moduleクラスを拡張すれば宣言的に他のモジュールのメソッドの定義を借りてくるって事ができる。</p>

<p>うーん何か意味あるかな。Concernスタイルなモジュール書く時に役に立つかもしれないが…。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />37位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/b878ef310170d3181b06">英字キーボードでVimを使っている時に、:wqを高速で入力してエラーが出てウオアアア!!とならないための設定</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-02-08 15:04:51</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" wq alias</span>
command<span class="p">!</span> <span class="p">-</span>nargs<span class="p">=</span><span class="m">0</span> Wq <span class="k">wq</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />38位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/e7cfd2c7674db6de8d24">モジュールとrefinementを組み合わせて使おうとして、依存関係でハマった話</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-04-10 11:34:19</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>最近、モジュールとrefinementsを組み合わせて使ってみようとして、requireがループしてハマったため回避策を書いておく。</p>

<p>Railsでこんなファイル構成を取っていた。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/post.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">Commentable</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/concern/commentable.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">using</span> <span class="no">CommentableRefinement</span>

<span class="k">module</span> <span class="nn">Commentable</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:commentable</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">thread_author</span>
    <span class="n">author</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/concern/commentable_refinement.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">CommentableRefinement</span>
  <span class="n">refine</span> <span class="no">Post</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">author</span>
      <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>(これはサンプルで適当に書いたので、正確ではない)</p>

<p>こうやっていれば、commentable.rbでのみrefinementで拡張したメソッドを元々持っていたかのように振舞える。</p>

<p>とは言え、こういう書き方をすると、usingもrefineもincludeもファイルを読み込んだ時点で評価されてしまう。</p>

<p>なので、Postを定義している途中で、Commentableが必要になり、Commentableを読みにいくと冒頭でCommentableRefinementが必要になり、CommentableRefinementでrefineを定義しようとするとPostが必要になって読み込みがループして、Post::Commentableが見つからねえよ、と言われて死ぬ。</p>

<p>仕方が無いので、includeの評価をCommentable読み込み後まで遅延させるように工夫した。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/post.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">klass</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="no">ActiveSupport</span><span class="o">.</span><span class="n">on_load</span> <span class="ss">:commentable</span> <span class="k">do</span> <span class="o">|</span><span class="n">mod</span><span class="o">|</span>
    <span class="n">klass</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="nb">require</span> <span class="s2">"commentable"</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/concern/commentable.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">using</span> <span class="no">CommentableRefinement</span>

<span class="k">module</span> <span class="nn">Commentable</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:commentable</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">thread_author</span>
    <span class="n">author</span>
  <span class="k">end</span>

  <span class="no">ActiveSupport</span><span class="o">.</span><span class="n">run_load_hooks</span><span class="p">(</span><span class="ss">:commentable</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>

<p>これで、とりあえず依存関係のループは切れるのだが、なんかダサいw</p>

<p>ちなみに、refinementはAsakusa.rbでmoroさんからざっくり話を聞いて、自分なりにこんな感じか？と書いてみたもので、用途としてアリかどうかについてはまだ分かってない。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />39位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/214a99063b696a458013">git rebase -i &quot;HEAD~N&quot;を打ちやすくする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-08-08 17:23:37</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> <b>[開発環境]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今のブランチの頭から、N個のコミットを圧縮したり改変したり、ということを多様するので、<br>
zshで簡単に打てるように関数化した。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="k">function</span> grbi<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> -gt <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    git rebase -i <span class="s2">"HEAD~</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">"Using: grbi n\n  (n is number greater then 0)"</span>
  <span class="k">fi</span>
<span class="o">}</span>
</pre></div></div>

<p><code>grbi 3</code>で現在のブランチの最新コミットから3つ過去までのコミットを改変する。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />40位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/82c93667872043fe75b2">Time.nowとDate.todayをキーワード引数に対応させるgemを作った</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-10 16:27:32</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>多分、どっかにあるはずなのだが、探すより作るのが早いシリーズ。</p>

<p>現在時刻とか、既に存在しているTimeクラスのオブジェクトの時間だけを変えたものとか、秒以下を切り捨てたものを生成する時に、キーワード引数でスマートに書きたくなったので、gemにしてみた。<br>
こういう事ばっかやってるから、Rubyのgemは玉石混交だとか言われてしまうのだが…。</p>

<p><a href="https://github.com/joker1007/keyword_arg_time" title="joker1007/keyword_arg_time" rel="nofollow noopener" target="_blank">joker1007/keyword_arg_time</a></p>

<h2>
<span id="usage" class="fragment"></span><a href="#usage"><i class="fa fa-link"></i></a>Usage</h2>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'keyword_arg_time'</span>

<span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="ss">hour</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="ss">min</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="ss">sec</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># =&gt; 2014-01-10 10:15:00 +0900</span>

<span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>      <span class="c1"># =&gt; 2014-01-10 00:00:00 +0900</span>
<span class="n">time</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="ss">hour</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="ss">min</span><span class="p">:</span> <span class="mi">15</span><span class="p">)</span>        <span class="c1"># =&gt; 2014-01-10 10:15:00 +0900</span>

<span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">(</span><span class="ss">mon</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>                  <span class="c1"># =&gt; &lt;Date: 2014-03-10 ((2456727j,0s,0n),+0s,2299161j)&gt;</span>

<span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>        <span class="c1"># =&gt; &lt;Date: 2014-01-10 ((2456668j,0s,0n),+0s,2299161j)&gt;</span>
<span class="n">date</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="ss">day</span><span class="p">:</span> <span class="mi">25</span><span class="p">)</span>                  <span class="c1"># =&gt; &lt;Date: 2014-01-25 ((2456683j,0s,0n),+0s,2299161j)&gt;</span>
</pre></div></div>

<p>これ、ActiveSupportとかに入らんかなー。<br>
もしくは、もっと良い名前で組込みメソッドとかにならんかなー。</p>

<p>追記:<br>
<code>copy</code>の動作をする<code>change</code>というメソッドはちゃんとあった。流石ActiveSupport。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>joker1007さんの<br />41位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/joker1007/items/a5ddcb86f0ab50cdc00e">Cucumberで、Helperのメソッドを使う方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-09 18:29:38</center>
	</td>
	<td style="width:200px;">
		@joker1007<br />(フリーランス 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/78/profile-images/1473683785">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[Cucumber]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>cucumberのstep_definitionで、dom_id(model)とか使いたかったので調べてみた。<br>
結構簡単だった。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">features/support/env.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">World</span><span class="p">(</span><span class="no">ActionController</span><span class="o">::</span><span class="no">RecordIdentifier</span><span class="p">)</span>
</pre></div>
</div>

<p>末尾にこんな感じで書いておけば、Worldにincludeしてくれるので、<br>
step_definitionで普通に呼べるようになる。<br>
カンマ区切りで複数同時に書ける。<br>
メソッド名の衝突には注意かな。</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
