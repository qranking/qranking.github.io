<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (labocho)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (labocho さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>684</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/5fbaa0491b67221419b4">JavaScript の Date は罠が多すぎる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-06 17:01:35</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>JavaScript で日付・時間を扱っていて、次から次へと罠にはまったので、あとから来る人のために書き留めておく。</p>

<h2>
<span id="dateparse-が返すのは-date-でなく整数" class="fragment"></span><a href="#dateparse-%E3%81%8C%E8%BF%94%E3%81%99%E3%81%AE%E3%81%AF-date-%E3%81%A7%E3%81%AA%E3%81%8F%E6%95%B4%E6%95%B0"><i class="fa fa-link"></i></a>Date.parse が返すのは Date でなく整数</h2>

<p><code>Date.parse</code> は、世界協定時 1970 年 1 月 1 日 00:00:00 からのミリ秒を返す。<br>
Date を得るには <code>new Date</code> に渡す。<br>
new Date に直接文字列渡しても同じ挙動なので、こちらのが簡潔。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">msec</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">);</span> <span class="c1">// 1346857200000</span>
<span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">msec</span><span class="p">);</span> <span class="c1">// Date</span>
<span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">);</span> <span class="c1">// Date</span>
</pre></div></div>

<h2>
<span id="年を得るのに-getyear-は使わない" class="fragment"></span><a href="#%E5%B9%B4%E3%82%92%E5%BE%97%E3%82%8B%E3%81%AE%E3%81%AB-getyear-%E3%81%AF%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>年を得るのに getYear は使わない</h2>

<p><code>Date.prototype.getYear</code> は 1900 年からの年数で非推奨。<br>
<code>Date.prototype.getFullYear</code> を使う。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">)</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">getYear</span><span class="p">();</span> <span class="c1">// 112 (2012 - 1900)</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">();</span> <span class="c1">// 2012</span>
</pre></div></div>

<h2>
<span id="月は-0-から始まる" class="fragment"></span><a href="#%E6%9C%88%E3%81%AF-0-%E3%81%8B%E3%82%89%E5%A7%8B%E3%81%BE%E3%82%8B"><i class="fa fa-link"></i></a>月は 0 から始まる</h2>

<p><code>new Date</code> の第 2 引数でも、<code>Date.prototype.getMonth</code> でも、月は 0-11で表す。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// Thu, Sep 06 2012 00:00:00 GMT+0900 (JST)</span>
<span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">).</span><span class="nx">getMonth</span><span class="p">();</span>  <span class="c1">// 8</span>
</pre></div></div>

<h2>
<span id="日を得るのは-getday-ではない" class="fragment"></span><a href="#%E6%97%A5%E3%82%92%E5%BE%97%E3%82%8B%E3%81%AE%E3%81%AF-getday-%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>日を得るのは getDay ではない</h2>

<p><code>Date.prototype.getDay</code> は 0 を日曜とする曜日を返す。<br>
日にちは <code>Date.prototype.getDate</code>。<br>
月とは違いこちらは 1-31。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">);</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">getDay</span><span class="p">();</span> <span class="c1">// 4 (木曜日)</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">();</span> <span class="c1">// 6 (6日)</span>
</pre></div></div>

<h2>
<span id="gettimezoneoffset-の符号は普通の表記と逆" class="fragment"></span><a href="#gettimezoneoffset-%E3%81%AE%E7%AC%A6%E5%8F%B7%E3%81%AF%E6%99%AE%E9%80%9A%E3%81%AE%E8%A1%A8%E8%A8%98%E3%81%A8%E9%80%86"><i class="fa fa-link"></i></a>getTimezoneOffset の符号は普通の表記と逆</h2>

<p><code>Date.prototype.getTimezoneOffset</code> は UTC からの時差を分で返すが、通常タイムゾーンを示す文字列表現とは符号が逆。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">);</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">();</span> <span class="c1">// -540 (540分=9時間で +0900 のこと)</span>
</pre></div></div>

<h2>
<span id="比較するときは-gettime-使う" class="fragment"></span><a href="#%E6%AF%94%E8%BC%83%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AF-gettime-%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>比較するときは getTime 使う</h2>

<p>同じ日時を示す Date でもオブジェクトが異なれば == や === は false になる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">s</span> <span class="o">=</span> <span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span>
<span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">==</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="c1">// false</span>
<span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">===</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="c1">// false</span>
</pre></div></div>

<p><code>Date.prototype.getTime</code> で 世界協定時 1970 年 1 月 1 日 00:00:00 からの経過ミリ秒が得られるのでこれで比較する。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">s</span> <span class="o">=</span> <span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span>
<span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span> <span class="c1">// 1346857200000</span>
<span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">==</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span> <span class="c1">// true</span>
<span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">===</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">s</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span> <span class="c1">// true</span>
</pre></div></div>

<p>ちなみに Date 同士の比較でも <code>&lt;</code> や <code>&gt;</code> は期待通りに動作するが、ややこしいのでおすすめしない。</p>

<p>(減算したり単項演算子 + を使って数値にキャストして比較する方法もあるが、意図がわかりにくい上に<a href="http://jsperf.com/comparing-date-objects" rel="nofollow noopener" target="_blank">遅い</a>ので使う理由はない)</p>

<h2>
<span id="文字列表現は-toisostring-か-tojson-で取得する" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E8%A1%A8%E7%8F%BE%E3%81%AF-toisostring-%E3%81%8B-tojson-%E3%81%A7%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>文字列表現は toISOString か toJSON で取得する</h2>

<p>ECMAScript 3 で定義されている、文字列表現を得るメソッドには、下記のものがある (括弧内は <a href="http://www.ecma-international.org/publications/files/ECMA-ST-ARCH/ECMA-262,%203rd%20edition,%20December%201999.pdf" rel="nofollow noopener" target="_blank">EMCAScript 3 仕様書 (PDF)</a> の項番号)。</p>

<ul>
<li>toString (15.9.5.2)</li>
<li>toDateString (15.9.5.3)</li>
<li>toTimeString (15.9.5.4)</li>
<li>toLocaleString (15.9.5.5)</li>
<li>toLocaleDateString (15.9.5.6)</li>
<li>toLocaleTimeString (15.9.5.7)</li>
</ul>

<p>が、いずれも "The contents of the string are implementation-dependent" と書かれており、形式は実装依存。</p>

<p>試してみたら違うのは IE だけだったけど、規格がないので責めてはいけない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">);</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="c1">// Chrome21:  "Thu Sep 06 2012 00:00:00 GMT+0900 (JST)"</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="c1">// Firefox14: "Thu Sep 06 2012 00:00:00 GMT+0900 (JST)"</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="c1">// Safari:    "Thu Sep 06 2012 00:00:00 GMT+0900 (JST)"</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="c1">// IE8:       "Thu Sep 6 00:00:00 UTC+0900 2012"</span>
</pre></div></div>

<p>ECMAScript 5 では文字列表現を<a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.1.15" rel="nofollow noopener" target="_blank">ISO8601 のサブセットに規定</a>しており <a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.5.43" rel="nofollow noopener" target="_blank">toISOString</a> で得られる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">);</span>
<span class="nx">date</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">();</span> <span class="c1">// "2012-09-05T15:00:00.000Z"</span>
</pre></div></div>

<p><code>JSON.stringify</code> から呼ばれる <a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.5.44" rel="nofollow noopener" target="_blank">toJSON</a> も toISOString を使うので、JSON.stringify したときも ISO8601 になる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"Thu, 06 Sep 2012 00:00:00 +0900"</span><span class="p">);</span>
<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">date</span><span class="p">);</span> <span class="c1">// ""2012-09-05T15:00:00.000Z""</span>
</pre></div></div>

<p>また、<a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.4.2" rel="nofollow noopener" target="_blank">Date.parse</a> や <a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.3.2" rel="nofollow noopener" target="_blank">new Date</a> でも、ISO8601 (のサブセット) をパースできることを定めている。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"2012-09-05T15:00:00.000Z"</span><span class="p">)</span> <span class="c1">// Thu Sep 06 2012 00:00:00 GMT+0900 (JST)</span>
</pre></div></div>

<h2>
<span id="json-にすると日付が変わることがある" class="fragment"></span><a href="#json-%E3%81%AB%E3%81%99%E3%82%8B%E3%81%A8%E6%97%A5%E4%BB%98%E3%81%8C%E5%A4%89%E3%82%8F%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>JSON にすると日付が変わることがある</h2>

<p>上で述べたように JSON.stringify したときの文字列表現は ISO8601 になるが、タイムゾーンを無視して<a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.5.43" rel="nofollow noopener" target="_blank">常に UTC になってしまう</a>。</p>

<p>これにより、タイムゾーンと時刻によっては日付が変わる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="c1">// 日本時間で 6 日 0 時は UTC では 5 日 15 時</span>
<span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"2012-09-06T00:00:00+0900"</span><span class="p">);</span>
<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="c1">// "2012-09-05T15:00:00.000Z"</span>
</pre></div></div>

<p>Date.prototype.toJSON を自分で書き換えてタイムゾーンを含む文字列を返すようにすれば回避可能だが、規格から外れてしまうため、JSON.stringify する前に文字列にしてしまうほうが安全。</p>

<h2>
<span id="日付をパースした場合と数値で指定した場合で時刻が一致しない" class="fragment"></span><a href="#%E6%97%A5%E4%BB%98%E3%82%92%E3%83%91%E3%83%BC%E3%82%B9%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%A8%E6%95%B0%E5%80%A4%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%A7%E6%99%82%E5%88%BB%E3%81%8C%E4%B8%80%E8%87%B4%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>日付をパースした場合と数値で指定した場合で時刻が一致しない</h2>

<p>new Date や Date.parse で時刻を含まない日付文字列をパースすると、UTC 00:00:00 になる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="c1">// UTC 0 時 = JST 午前 9 時</span>
<span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s2">"2014-11-10"</span><span class="p">)</span> <span class="c1">// Mon Nov 10 2014 09:00:00 GMT+0900 (JST)</span>
</pre></div></div>

<p>一方で <code>new Date(2014, 10, 10)</code> などとしたときは地方時 00:00:00 となり、これと時刻が一致しない。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1">// Mon Nov 10 2014 00:00:00 GMT+0900 (JST)</span>
</pre></div></div>

<p>前者の挙動は、日付文字列でタイムゾーン文字列がない場合、UTC として扱うという ECMAScript 5 の仕様に基づく。</p>

<blockquote>
<p>The value of an absent time zone offset is “Z”.<br>
<a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.1.15" rel="nofollow noopener" target="_blank">15.9.1.15 Date Time String Format</a></p>
</blockquote>

<p>ただし、ECMAScript 6 draft (October 14, 2014) では、これを地方時にするとの記述がある。</p>

<blockquote>
<p>If the time zone offset is absent, the date-time is interpreted as a local time.<br>
<a href="http://people.mozilla.org/%7Ejorendorff/es6-draft.html#sec-date-time-string-format" rel="nofollow noopener" target="_blank">20.3.1.15 Date Time String Format</a></p>
</blockquote>

<h2>
<span id="iso8601-は-ie8-ではパースできない" class="fragment"></span><a href="#iso8601-%E3%81%AF-ie8-%E3%81%A7%E3%81%AF%E3%83%91%E3%83%BC%E3%82%B9%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>ISO8601 は IE8 ではパースできない</h2>

<p>Date.parse がパースできる形式は ECMAScript 3 では定められていないため実装依存。</p>

<p>試してみたら、主要ブラウザでは RFC2822 なら OK、ISO8601 は IE8 ではだめ (IE9 は OK)。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s2">"2012-01-01 00:00:00"</span><span class="p">);</span> <span class="c1">// IE8 だと NaN</span>
</pre></div></div>

<p>上で述べたように ECMAScript 5 では ISO8601 (のサブセット) をパースできるよう定めている。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>144</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/54fd70c73ced35c8ba49">HTML5 で省略できるタグ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-01 18:37:34</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML5]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://html.spec.whatwg.org/multipage/syntax.html#optional-tags" class="autolink" rel="nofollow noopener" target="_blank">https://html.spec.whatwg.org/multipage/syntax.html#optional-tags</a></p>

<p>の和訳</p>

<ol>
<li>
<code>&lt;html&gt;</code> はその最初の内容がコメントでなければ省略できる</li>
<li>
<code>&lt;/html&gt;</code> は直後にコメントが続かなければ省略できる</li>
<li>
<code>&lt;head&gt;</code> は内容が空か、最初の内容が要素なら省略できる</li>
<li>
<code>&lt;/head&gt;</code> は直後に空白文字かコメントがなければ省略できる</li>
<li>
<code>&lt;body&gt;</code> は内容が空か、最初の内容が空白文字かコメントでなければ省略できるが、最初の要素が meta, link, script, style, template なら省略できない</li>
<li>
<code>&lt;/body&gt;</code> は直後にコメントが続かなければ省略できる</li>
<li>
<code>&lt;/li&gt;</code> は直後に li 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/dt&gt;</code> は直後に dt, dd 要素が続けば省略できる</li>
<li>
<code>&lt;/dd&gt;</code> は直後に dt, dd 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/p&gt;</code> は直後に address, article, aside, blockquote, details, div, dl, fieldset, figcaption, figure, footer, form, h1, h2, h3, h4, h5, h6, header, hgroup, hr, main, menu, nav, ol, p, pre, section, table, ul 要素が続くか、親要素が a, audio, del, ins, map, noscript, video 以外で親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/rt&gt;</code> は直後に rt, rp 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/rp&gt;</code> は直後に rt, rp 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/optgroup&gt;</code> は直後に別の optgroup 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/option&gt;</code> は直後に option, optgroup 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;colgroup&gt;</code> はその最初の内容が col 要素で、直前に終了タグを省略した colgroup 要素がなければ省略できる (ただし空要素の場合省略できない)</li>
<li>
<code>&lt;/colgroup&gt;</code> は直後に空白文字かコメントがなければ省略できる</li>
<li>
<code>&lt;/caption&gt;</code> は直後に空白文字かコメントがなければ省略できる</li>
<li>
<code>&lt;/thead&gt;</code> は直後に tbody, tfoot 要素が続けば省略できる</li>
<li>
<code>&lt;tbody&gt;</code> はその最初の内容が tr で、直前に終了タグを省略した tbody, thead, tfoot 要素がなければ省略できる</li>
<li>
<code>&lt;/tbody&gt;</code> は直後に tbody, tfoot 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/tfoot&gt;</code> は親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/tr&gt;</code> は直後に tr 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/td&gt;</code> は直後に td, th 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
<li>
<code>&lt;/th&gt;</code> は直後に td, th 要素が続くか、親要素にそれ以上内容がなければ省略できる</li>
</ol>

<p>いずれの場合にも属性を持つ場合、開始タグは省略できない。</p>

<p>下記で valid かチェックできる<br>
<a href="http://validator.w3.org/" class="autolink" rel="nofollow noopener" target="_blank">http://validator.w3.org/</a></p>

<p>valid な例</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>タイトル<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>段落

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>A
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>B
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>HTML
  <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>Hyper Text Markup Language
<span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ruby</span><span class="p">&gt;</span>
  Ruby
  <span class="p">&lt;</span><span class="nt">rp</span><span class="p">&gt;</span>(<span class="p">&lt;</span><span class="nt">rt</span><span class="p">&gt;</span>ルビー<span class="p">&lt;</span><span class="nt">rp</span><span class="p">&gt;</span>)
<span class="p">&lt;/</span><span class="nt">ruby</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">select</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">optgroup</span> <span class="na">label</span><span class="o">=</span><span class="s">"one2two"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">option</span><span class="p">&gt;</span>1
    <span class="p">&lt;</span><span class="nt">option</span><span class="p">&gt;</span>2
  <span class="p">&lt;</span><span class="nt">optgroup</span> <span class="na">label</span><span class="o">=</span><span class="s">"three"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">option</span><span class="p">&gt;</span>3
<span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">colgroup</span> <span class="na">span</span><span class="o">=</span><span class="s">"2"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>セル1
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>セル2
<span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>114</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/8559576b71642b79df67">CSV を文字コード変換しつつロード</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-03-23 13:42:45</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">CSV</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="ss">encoding</span><span class="p">:</span> <span class="s2">"Shift_JIS:UTF-8"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
  <span class="c1"># …</span>
<span class="k">end</span>
</pre></div></div>

<p>だが、未定義文字があるとエラーに。</p>

<p><code>Kernel#open</code> だと</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb:Shift_JIS:UTF-8"</span><span class="p">,</span> <span class="k">undef</span><span class="p">:</span> <span class="ss">:replace</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="c1"># …</span>
<span class="k">end</span>
</pre></div></div>

<p>のように、<code>String#encode</code> と同じオプションが渡せるが、CSV ではここにオプションを渡すすべはない。</p>

<p>よって <code>Kernel#open</code> と併用する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb:Shift_JIS:UTF-8"</span><span class="p">,</span> <span class="k">undef</span><span class="p">:</span> <span class="ss">:replace</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="no">CSV</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>79</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/32efc5b7c73aba3500ff">Rails で (Rack の) セッション情報を Cookie に保存する仕組み</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-23 21:00:19</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[rack]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rails では特に (config/initializers/session_store.rb などで) 設定しない場合、セッションの情報をクライアントの Cookie に直接、(事実上) 平文で保存する。</p>

<p>実際に見てみよう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ rails new todo
$ <span class="nb">cd</span> todo
$ rails g scaffold tasks name
$ rake db:migrate
$ rails s
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># app/controllers/application_controller.rb</span>
<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span>
  <span class="n">before_filter</span> <span class="k">do</span>
    <span class="c1"># アクセスした日時を session に保存</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:last_accessed_at</span><span class="o">]</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ curl localhost:3000/tasks -i -s <span class="p">|</span> grep Set-Cookie
Set-Cookie: <span class="nv">_todo_session</span><span class="o">=</span>BAh7CEkiD3Nlc3Npb25faWQGOgZFRkkiJTE0YTYyZmNlYmVhODVmNjU5NGZmNjlhN2M0MTM1ZjQ0BjsAVEkiFWxhc3RfYWNjZXNzZWRfYXQGOwBGSXU6CVRpbWUNREscgLb0JXIHOgtAX3pvbmVJIghKU1QGOwBUOgtvZmZzZXRpApB%2BSSIQX2NzcmZfdG9rZW4GOwBGSSIxU1llVWZyclBzVU9oUG0rclRMQ1hkUzNpYUU1RlpRWGI0QUU2alJ5UDJEYz0GOwBG--b7446faf0dcddf99f358ce40525f7eade939d1be<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"uri"</span>
<span class="nb">require</span> <span class="s2">"base64"</span>
<span class="nb">require</span> <span class="s2">"pp"</span>

<span class="c1"># 上で Set-Cookie ヘッダに書かれてる文字列</span>
<span class="n">session_in_cookie</span> <span class="o">=</span> <span class="s2">"BAh7CEkiD3Nlc3Npb25faWQGOgZFRkkiJTYxMzE4MDQ5ZDA2ZjM1NjlhNGJmM2I2ZDMwYjJmMDA4BjsAVEkiFWxhc3RfYWNjZXNzZWRfYXQGOwBGSXU6CVRpbWUNREscgJmmKHsHOgtAX3pvbmVJIghKU1QGOwBUOgtvZmZzZXRpApB%2BSSIQX2NzcmZfdG9rZW4GOwBGSSIxOHcrUGlocmJIRDhpR01QZVRVMkVzZ0xsOVVJQnk4eEU0bzlpa3RoYVNvbz0GOwBG--394e1c8682803d5109d2bfbffe4254430e41098e"</span>

<span class="c1"># URI デコード、-- の前を取り出し</span>
<span class="n">session_base64</span><span class="p">,</span> <span class="n">digest</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">session_in_cookie</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"--"</span><span class="p">)</span>

<span class="c1"># Base64 デコードして Marshal.load でオブジェクト復元</span>
<span class="n">pp</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">Base64</span><span class="o">.</span><span class="n">decode64</span><span class="p">(</span><span class="n">session_base64</span><span class="p">))</span>
<span class="c1"># {"session_id"=&gt;"61318049d06f3569a4bf3b6d30b2f008",</span>
<span class="c1">#  "last_accessed_at"=&gt;2013-03-26 13:30:50 +0900,</span>
<span class="c1">#  "_csrf_token"=&gt;"8w+PihrbHD8iGMPeTU2EsgLl9UIBy8xE4o9ikthaSoo="}</span>
</pre></div></div>

<p>このように Base64 のデコードと Marshal.load で簡単に復元できてしまう。これだといっけんユーザがセッションの内容書き換え放題にみえるが、実際にはそんなことはない。</p>

<p>上のコードでさらっと split しているが、Cookie に格納される情報は Marshal.dump -&gt; Base64 エンコードした文字列のあと -- に続いて、ハッシュ値が書かれている。これは -- より前の文字列と秘密鍵を使って OpenSSL::HMAC.hexdigest で作成したもので、Cookie 生成時に付与され、受け取ったときに一致するか検証される。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># rack-1.4.1/lib/session/cookie.rb より</span>
<span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">module</span> <span class="nn">Session</span>
    <span class="k">class</span> <span class="nc">Cookie</span>
      <span class="k">def</span> <span class="nf">generate_hmac</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
        <span class="no">OpenSSL</span><span class="o">::</span><span class="no">HMAC</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>このため、セッションの中身を書き換えたところで、秘密鍵を知らない限り、適切なハッシュ値を付与することができず、改ざんを防げるわけだ。</p>

<p>この秘密鍵は Rails アプリケーション作成時にランダムに生成されるもので、下記のように設定されている。長い。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># config/initializers/secret_token.rb</span>
<span class="no">Todo</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">secret_token</span> <span class="o">=</span> <span class="s1">'aeb84aaf07fb5b4f8ebbfcbd8e524b64e595a436fffe0b64a54d4367c99c02bf9bef939755af13a49117fa3e526502fc297948f936e33984b9503afbeb1b359c'</span>
</pre></div></div>

<p>素人目には充分なように安全にみえる (詳しい方のつっこみ歓迎)。</p>

<p>なお、最初に見たように session の内容は、リクエストした人本人には丸見えなので、秘密にしておくべき情報をセットしないよう注意。</p>

<p>また、CookieStore 以外の方式、たとえば DB にセッションの情報を記録する場合では、Cookie には session_id のみを持たせる一般的な実装になる。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />5位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>65</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/adb89ede814b86e9c04a">Rails で捕捉されない例外が発生したらメールを送る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-12 20:47:46</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[AdventCalendar]</b> <b>[rack]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rails Advent Calendar 12 日目です。</p>

<p>特になにもしていないと、運用中の Rails アプリケーションで例外が起こっても、気づくのは困難です。</p>

<p>New Relic とか使うとそのあたりは解決しそうな気もしますが (あんまり使ってないので知らない)、簡単に導入できるものとして exception_notification を紹介します。</p>

<h1>
<span id="exception_notification" class="fragment"></span><a href="#exception_notification"><i class="fa fa-link"></i></a>exception_notification</h1>

<p><a href="https://github.com/smartinez87/exception_notification" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/smartinez87/exception_notification</a></p>

<p>exception_notification は Rack ミドルウェアで、捕捉されない例外が起こったときに、あらかじめ設定したメールアドレスにメールを送信します。</p>

<p>メール送信後は同じ例外をもう一度 raise するので、そのあとの処理に影響を及ぼすことはありません。</p>

<h1>
<span id="導入" class="fragment"></span><a href="#%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>導入</h1>

<p>歴史的経緯により notifi_<em>cation</em>_ の箇所と notifi_<em>er</em>_ の箇所があるので注意。</p>

<p>gem 入れて...</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"exception_notification"</span>
</pre></div></div>

<p>config/initializers 下に設定ファイルをつくります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># config/initializers/exception_notification.rb</span>
<span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span><span class="p">(</span>
  <span class="no">ExceptionNotifier</span><span class="p">,</span>
  <span class="ss">:email_prefix</span> <span class="o">=&gt;</span> <span class="s2">"[アプリケーション名] "</span><span class="p">,</span>
  <span class="ss">:sender_address</span> <span class="o">=&gt;</span> <span class="sx">%{"送信者名" &lt;送信元メールアドレス&gt;}</span><span class="p">,</span>
  <span class="ss">:exception_recipients</span> <span class="o">=&gt;</span> <span class="sx">%w{送信先メールアドレス}</span>
<span class="p">)</span>
</pre></div></div>

<p>メールサーバの設定は ActionMailer のものをそのまま使うので、ActionMailer が設定されていれば、これで完了です。</p>

<p>ほかにもいろいろ設定できるようですが、そのへんは README.md 参照してください。</p>

<h1>
<span id="サンプル" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>サンプル</h1>

<p>実際に例外が起きると下記のようなメールが送られてきます。</p>

<p>例外の種類とメッセージ、リクエスト、セッション、Rack の env、バックトレースが含まれています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Date: Wed, 12 Sep 2012 20:24:33 +0900
From: Exception Notifier &lt;exception@example.com&gt;
To: admin@example.com
Message-ID: &lt;505070f19a852_55923fc4508c93b8729f@Foobar.local.mail&gt;
Subject: [Todo app] home#show (RuntimeError) "Unexpected Error"
Mime-Version: 1.0
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

A RuntimeError occurred in home#show:

  Unexpected Error
  app/controllers/home_controller.rb:3:in `show'

-------------------------------
Request:
-------------------------------

  * URL       : http://localhost:3000/
  * IP address: 127.0.0.1
  * Parameters: {"controller"=&gt;"home", "action"=&gt;"show"}
  * Rails root: /Users/foo/todo

-------------------------------
Session:
-------------------------------

  * session id: "f59bf3b7aa7c9ace32c939766e32d656"
  * data: {"session_id"=&gt;"f59bf3b7aa7c9ace32c939766e32d656",
   "_csrf_token"=&gt;"no97EC4mADf02hVV3OfR+XqBl73Fk4Tp8jBegWnlwWY="}

-------------------------------
Environment:
-------------------------------

  * GATEWAY_INTERFACE                              : CGI/1.1
  * HTTP_ACCEPT                                    : text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
  * HTTP_ACCEPT_CHARSET                            : Shift_JIS,utf-8;q=0.7,*;q=0.3
  * HTTP_ACCEPT_ENCODING                           : gzip,deflate,sdch
  * HTTP_ACCEPT_LANGUAGE                           : ja,en-US;q=0.8,en;q=0.6
  * HTTP_CACHE_CONTROL                             : max-age=0
  * HTTP_CONNECTION                                : keep-alive
  * HTTP_COOKIE                                    : _todo_session=BAh7B0kiD3Nlc3Npb25faWQGOgZFRkkiJWY1OWJmM2I3YWE3YzlhY2UzMmM5Mzk3NjZlMzJkNjU2BjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMW5vOTdFQzRtQURmMDJoVlYzT2ZSK1hxQmw3M0ZrNFRwOGpCZWdXbmx3V1k9BjsARg%3D%3D--c34c5fc6de928cde391cccd2b710547c7aab1d06
  * HTTP_HOST                                      : localhost:3000
  * HTTP_IF_NONE_MATCH                             : "132bbc1cdcfdacc705ba8346e527d0bb"
  * HTTP_USER_AGENT                                : Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_1) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1
  * HTTP_VERSION                                   : HTTP/1.1
  * ORIGINAL_FULLPATH                              : /
  * PATH_INFO                                      : /
  * QUERY_STRING                                   : 
  * REMOTE_ADDR                                    : 127.0.0.1
  * REMOTE_HOST                                    : localhost
  * REQUEST_METHOD                                 : GET
  * REQUEST_PATH                                   : /
  * REQUEST_URI                                    : http://localhost:3000/
  * SCRIPT_NAME                                    : 
  * SERVER_NAME                                    : localhost
  * SERVER_PORT                                    : 3000
  * SERVER_PROTOCOL                                : HTTP/1.1
  * SERVER_SOFTWARE                                : WEBrick/1.3.1 (Ruby/1.9.2/2012-04-20)
  * action_controller.instance                     : home#show
  * action_dispatch.backtrace_cleaner              : #&lt;Rails::BacktraceCleaner:0x007f88a48a3d40&gt;
  * action_dispatch.cookies                        : #&lt;ActionDispatch::Cookies::CookieJar:0x007f88a1171430&gt;
  * action_dispatch.logger                         : #&lt;ActiveSupport::TaggedLogging:0x007f88a2da9508&gt;
  * action_dispatch.parameter_filter               : [:password, /RAW_POST_DATA/]
  * action_dispatch.remote_ip                      : 127.0.0.1
  * action_dispatch.request.content_type           : 
  * action_dispatch.request.formats                : [text/html]
  * action_dispatch.request.parameters             : {"controller"=&gt;"home", "action"=&gt;"show"}
  * action_dispatch.request.path_parameters        : {:controller=&gt;"home", :action=&gt;"show"}
  * action_dispatch.request.query_parameters       : {}
  * action_dispatch.request.request_parameters     : {}
  * action_dispatch.request.unsigned_session_cookie: {"session_id"=&gt;"f59bf3b7aa7c9ace32c939766e32d656", "_csrf_token"=&gt;"no97EC4mADf02hVV3OfR+XqBl73Fk4Tp8jBegWnlwWY="}
  * action_dispatch.request_id                     : aae2c8b270a34ce9323289f38e1ff41e
  * action_dispatch.routes                         : #&lt;ActionDispatch::Routing::RouteSet:0x007f88a15a50d8&gt;
  * action_dispatch.secret_token                   : 609b10fdec535f80b97fed445f930500b43d5e5a6b5212f731e09e4b5c6fbfe99c7350f64875e004706e318cc5fe032258af1596d33f303b7b3cb9ea0958c127
  * action_dispatch.show_detailed_exceptions       : true
  * action_dispatch.show_exceptions                : true
  * exception_notifier.options                     : {:sender_address=&gt;"\"Exception Notifier\" &lt;exception@example.com&gt;", :exception_recipients=&gt;["admin@example.com"], :email_prefix=&gt;"[Todo app] ", :sections=&gt;["request", "session", "environment", "backtrace"], :ignore_exceptions=&gt;[AbstractController::ActionNotFound, ActionController::RoutingError]}
  * rack.errors                                    : #&lt;IO:0x007f88a08718a8&gt;
  * rack.input                                     : #&lt;StringIO:0x007f88a1183798&gt;
  * rack.multiprocess                              : false
  * rack.multithread                               : false
  * rack.request.cookie_hash                       : {"_todo_session"=&gt;"BAh7B0kiD3Nlc3Npb25faWQGOgZFRkkiJWY1OWJmM2I3YWE3YzlhY2UzMmM5Mzk3NjZlMzJkNjU2BjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMW5vOTdFQzRtQURmMDJoVlYzT2ZSK1hxQmw3M0ZrNFRwOGpCZWdXbmx3V1k9BjsARg==--c34c5fc6de928cde391cccd2b710547c7aab1d06"}
  * rack.request.cookie_string                     : _todo_session=BAh7B0kiD3Nlc3Npb25faWQGOgZFRkkiJWY1OWJmM2I3YWE3YzlhY2UzMmM5Mzk3NjZlMzJkNjU2BjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMW5vOTdFQzRtQURmMDJoVlYzT2ZSK1hxQmw3M0ZrNFRwOGpCZWdXbmx3V1k9BjsARg%3D%3D--c34c5fc6de928cde391cccd2b710547c7aab1d06
  * rack.request.query_hash                        : {}
  * rack.request.query_string                      : 
  * rack.run_once                                  : false
  * rack.session                                   : {"session_id"=&gt;"f59bf3b7aa7c9ace32c939766e32d656", "_csrf_token"=&gt;"no97EC4mADf02hVV3OfR+XqBl73Fk4Tp8jBegWnlwWY="}
  * rack.session.options                           : {:path=&gt;"/", :domain=&gt;nil, :expire_after=&gt;nil, :secure=&gt;false, :httponly=&gt;true, :defer=&gt;false, :renew=&gt;false, :coder=&gt;#&lt;Rack::Session::Cookie::Base64::Marshal:0x007f88a3c54df0&gt;, :id=&gt;"f59bf3b7aa7c9ace32c939766e32d656"}
  * rack.url_scheme                                : http
  * rack.version                                   : [1, 1]

  * Process: 21906
  * Server : Foobar

-------------------------------
Backtrace:
-------------------------------

  app/controllers/home_controller.rb:3:in `show'
  actionpack (3.2.8) lib/action_controller/metal/implicit_render.rb:4:in `send_action'
  actionpack (3.2.8) lib/abstract_controller/base.rb:167:in `process_action'
  actionpack (3.2.8) lib/action_controller/metal/rendering.rb:10:in `process_action'
  actionpack (3.2.8) lib/abstract_controller/callbacks.rb:18:in `block in process_action'
  activesupport (3.2.8) lib/active_support/callbacks.rb:414:in `_run__1225659172420690068__process_action__357961545621717090__callbacks'
  activesupport (3.2.8) lib/active_support/callbacks.rb:405:in `__run_callback'
  activesupport (3.2.8) lib/active_support/callbacks.rb:385:in `_run_process_action_callbacks'
  activesupport (3.2.8) lib/active_support/callbacks.rb:81:in `run_callbacks'
  actionpack (3.2.8) lib/abstract_controller/callbacks.rb:17:in `process_action'
  actionpack (3.2.8) lib/action_controller/metal/rescue.rb:29:in `process_action'
  actionpack (3.2.8) lib/action_controller/metal/instrumentation.rb:30:in `block in process_action'
  activesupport (3.2.8) lib/active_support/notifications.rb:123:in `block in instrument'
  activesupport (3.2.8) lib/active_support/notifications/instrumenter.rb:20:in `instrument'
  activesupport (3.2.8) lib/active_support/notifications.rb:123:in `instrument'
  actionpack (3.2.8) lib/action_controller/metal/instrumentation.rb:29:in `process_action'
  actionpack (3.2.8) lib/action_controller/metal/params_wrapper.rb:207:in `process_action'
  activerecord (3.2.8) lib/active_record/railties/controller_runtime.rb:18:in `process_action'
  actionpack (3.2.8) lib/abstract_controller/base.rb:121:in `process'
  actionpack (3.2.8) lib/abstract_controller/rendering.rb:45:in `process'
  actionpack (3.2.8) lib/action_controller/metal.rb:203:in `dispatch'
  actionpack (3.2.8) lib/action_controller/metal/rack_delegation.rb:14:in `dispatch'
  actionpack (3.2.8) lib/action_controller/metal.rb:246:in `block in action'
  actionpack (3.2.8) lib/action_dispatch/routing/route_set.rb:73:in `call'
  actionpack (3.2.8) lib/action_dispatch/routing/route_set.rb:73:in `dispatch'
  actionpack (3.2.8) lib/action_dispatch/routing/route_set.rb:36:in `call'
  journey (1.0.4) lib/journey/router.rb:68:in `block in call'
  journey (1.0.4) lib/journey/router.rb:56:in `each'
  journey (1.0.4) lib/journey/router.rb:56:in `call'
  actionpack (3.2.8) lib/action_dispatch/routing/route_set.rb:600:in `call'
  exception_notification (2.5.2) lib/exception_notifier.rb:25:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/best_standards_support.rb:17:in `call'
  rack (1.4.1) lib/rack/etag.rb:23:in `call'
  rack (1.4.1) lib/rack/conditionalget.rb:25:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/head.rb:14:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/params_parser.rb:21:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/flash.rb:242:in `call'
  rack (1.4.1) lib/rack/session/abstract/id.rb:205:in `context'
  rack (1.4.1) lib/rack/session/abstract/id.rb:200:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/cookies.rb:339:in `call'
  activerecord (3.2.8) lib/active_record/query_cache.rb:64:in `call'
  activerecord (3.2.8) lib/active_record/connection_adapters/abstract/connection_pool.rb:473:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/callbacks.rb:28:in `block in call'
  activesupport (3.2.8) lib/active_support/callbacks.rb:405:in `_run__3608295848955106148__call__1508032645417640755__callbacks'
  activesupport (3.2.8) lib/active_support/callbacks.rb:405:in `__run_callback'
  activesupport (3.2.8) lib/active_support/callbacks.rb:385:in `_run_call_callbacks'
  activesupport (3.2.8) lib/active_support/callbacks.rb:81:in `run_callbacks'
  actionpack (3.2.8) lib/action_dispatch/middleware/callbacks.rb:27:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/reloader.rb:65:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/remote_ip.rb:31:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/debug_exceptions.rb:16:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/show_exceptions.rb:56:in `call'
  railties (3.2.8) lib/rails/rack/logger.rb:26:in `call_app'
  railties (3.2.8) lib/rails/rack/logger.rb:16:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/request_id.rb:22:in `call'
  rack (1.4.1) lib/rack/methodoverride.rb:21:in `call'
  rack (1.4.1) lib/rack/runtime.rb:17:in `call'
  activesupport (3.2.8) lib/active_support/cache/strategy/local_cache.rb:72:in `call'
  rack (1.4.1) lib/rack/lock.rb:15:in `call'
  actionpack (3.2.8) lib/action_dispatch/middleware/static.rb:62:in `call'
  railties (3.2.8) lib/rails/engine.rb:479:in `call'
  railties (3.2.8) lib/rails/rack/log_tailer.rb:17:in `call'
  rack (1.4.1) lib/rack/handler/webrick.rb:59:in `service'
  /Users/foo/.rbenv/versions/1.9.2-p320/lib/ruby/1.9.1/webrick/httpserver.rb
:111:in `service'
  /Users/foo/.rbenv/versions/1.9.2-p320/lib/ruby/1.9.1/webrick/httpserver.rb:70:in `run'
  /Users/foo/.rbenv/versions/1.9.2-p320/lib/ruby/1.9.1/webrick/server.rb:183:in `block in start_thread'
</pre></div></div>

<h1>
<span id="既知の問題" class="fragment"></span><a href="#%E6%97%A2%E7%9F%A5%E3%81%AE%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>既知の問題</h1>

<p>exception_notification がメールを送るときにさらに例外が起こると、元の例外は raise されず、それがどんなものだったかわからなくなってしまいます (実は、この問題を修正するパッチを書いてたんですが、まだ pull request 送れてません...)。</p>

<p>運用時は、実際に例外を起こしてみて、ちゃんとメールが送られてくるか、必ず確認しておきましょう。</p>

<h1>
<span id="追記-rails-4-対応" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98-rails-4-%E5%AF%BE%E5%BF%9C"><i class="fa fa-link"></i></a>追記: Rails 4 対応</h1>

<p>Rails 4 では config/initializers 下の設定ファイルの書き方が変わっています。</p>

<p>参考: <a href="https://github.com/smartinez87/exception_notification" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/smartinez87/exception_notification</a></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># config/initializers/exception_notification.rb
Rails.application.config.middleware.use(
  ExceptionNotification::Rack,
  :email =&gt; {
    :email_prefix =&gt; "[アプリケーション名] ",
    :sender_address =&gt; %{"送信者名" &lt;送信元メールアドレス&gt;},
    :exception_recipients =&gt; %w{送信先メールアドレス}
  }
)
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />6位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>49</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/45d79fc16c78bc95e1d8">AWS::S3 で endpoint を指定しろと言われたら</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-12 17:06:42</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[AWS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby で aws-sdk gem を使って、次のようなコードを書いたら例外が起きた。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"aws"</span>
<span class="n">s3</span> <span class="o">=</span> <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">access_key_id</span><span class="p">:</span> <span class="s2">"FOO"</span><span class="p">,</span>
  <span class="ss">secret_access_key</span><span class="p">:</span> <span class="s2">"XXX"</span>
<span class="p">)</span>
<span class="n">s3</span><span class="o">.</span><span class="n">buckets</span><span class="o">[</span><span class="s2">"bar"</span><span class="o">].</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span> 
<span class="c1"># AWS::S3::Errors::PermanentRedirect: The bucket you are attempting to access must be addressed using the specified endpoint. Please send all future requests to this endpoint.</span>
</pre></div></div>

<p><a href="http://docs.amazonwebservices.com/general/latest/gr/rande.html" class="autolink" rel="nofollow noopener" target="_blank">http://docs.amazonwebservices.com/general/latest/gr/rande.html</a> をみると S3 の Asia Pacific (Tokyo) の endpoint は <code>s3-ap-northeast-1.amazonaws.com</code> らしい。</p>

<p>指定の仕方は、ドキュメントでは見つけられなかったけど、次のように s3_endpoint オプションで渡してやれば動作した。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">s3</span> <span class="o">=</span> <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">access_key_id</span><span class="p">:</span> <span class="s2">"FOO"</span><span class="p">,</span>
  <span class="ss">secret_access_key</span><span class="p">:</span> <span class="s2">"XXX"</span><span class="p">,</span>
  <span class="ss">s3_endpoint</span><span class="p">:</span> <span class="s2">"s3-ap-northeast-1.amazonaws.com"</span>
<span class="p">)</span>
</pre></div></div>

<p>ググると <code>AWS::S3::DEFAULT_HOST.replace("s3-ap-northeast-1.amazonaws.com")</code> とせよ、という記述がたくさん見つかるけど aws-sdk v1.6.8 では AWS::S3::DEFAULT_HOST がなく、使えない。</p>

<p>参考: <a href="http://subtech.g.hatena.ne.jp/secondlife/20120116/1326715826" class="autolink" rel="nofollow noopener" target="_blank">http://subtech.g.hatena.ne.jp/secondlife/20120116/1326715826</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />7位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>45</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/8870df3f660977e44315">rack_after_reply でレスポンス後に処理を行う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-10 04:35:37</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[AdventCalendar]</b> <b>[rack]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rails Advent Calendar 10 日目です。</p>

<p>Rails で、S3 へのアップロードや画像処理、メール送信など、時間のかかる処理をする際に、レスポンスをすぐに返し、処理自体はレスポンス後に行いたい場合があります。</p>

<p>rack_after_reply (<a href="https://github.com/oggy/rack_after_reply" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/oggy/rack_after_reply</a>) は rack サーバを拡張する gem で、<code>env["rack_after_reply.callbacks"]</code> に Proc オブジェクトを追加することで、レスポンス後に実行してくれます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"rack_after_reply"</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># app/controllers/photos_controller.rb</span>
<span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:photo</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="vi">@photo</span><span class="o">.</span><span class="n">valid?</span>
    <span class="n">env</span><span class="o">[</span><span class="s2">"rack_after_reply.callbacks"</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="nb">lambda</span> <span class="p">{</span>
      <span class="c1"># 時間のかかる処理</span>
      <span class="nb">sleep</span> <span class="mi">10</span>
      <span class="vi">@photo</span><span class="o">.</span><span class="n">save!</span>
    <span class="p">}</span>
    <span class="c1"># 202 Accepted を返す</span>
    <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:accepted</span> <span class="p">}</span>
  <span class="k">else</span>
    <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:new</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>上の例では、即座にレスポンスが返り、(およそ) 10 秒後にレコードが追加されます。</p>

<p>ちなみに、この例では HTTP ステータスコードとして、201 や 302 ではなく、202 (Accepted) を返していて、これは「リクエストは受理したけど、まだ処理が完了していない」ことを示すステータスコードです。</p>

<p>本来、202 を返すときは「リソースの現在の状態」と、「最新の状態をモニタできる URL、またはリソースの作成にかかる見込み時間」を付与すべきですが、ここではなにもしてません。</p>

<h1>
<span id="他のライブラリとの比較" class="fragment"></span><a href="#%E4%BB%96%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A8%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>他のライブラリとの比較</h1>

<p>こういった用途では resque や delayed_job が有名ですが、これらはいづれも、データストアにジョブ登録 -&gt; 別プロセスで処理という方法をとるため、ジョブ実行に必要なすべての情報をデータストアにシリアライズして保存しなければなりません。</p>

<p>この処理は、特にファイルのアップロード (Rails では一時ファイルになる) が絡むと面倒で、carrierwave などのライブラリを利用しているとさらに複雑になります。</p>

<p>rack_after_reply は、だいたい下記のような特徴をもつので、実装の容易さ・簡潔さなら rack_after_reply、分散のしやすさ・汎用性・疎結合性なら resque / delayed_job といった感じでしょうか。</p>

<h2>
<span id="メリット" class="fragment"></span><a href="#%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>メリット</h2>

<ul>
<li>遅延処理しない場合に比べ、ほとんどコードを変える必要が無い</li>
<li>別のプロセスやデータストアが必要ないため構成がシンプル</li>
<li>メモリ上のオブジェクトや一時ファイルをそのまま処理できる</li>
</ul>

<h2>
<span id="デメリット" class="fragment"></span><a href="#%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>デメリット</h2>

<ul>
<li>時間のかかる処理をフロントエンドと同じプロセスが行うので分散しにくい</li>
<li>処理の途中で失敗した場合のリトライがしにくい</li>
</ul>

<h1>
<span id="仕組み" class="fragment"></span><a href="#%E4%BB%95%E7%B5%84%E3%81%BF"><i class="fa fa-link"></i></a>仕組み</h1>

<p>最初 Rack ミドルウェアかなと思ったけど、Rack ミドルウェアではレスポンス後に処理を行うことはできない。中身をみてみると、代表的な Rack サーバが各リクエストを処理するメソッドをフックして、コールバックを実行しているようです。</p>

<p>対応している Rack サーバは README 参照。<br>
いま見たところ Mongrel, Passenger, Thin, Unicorn, WEBrick が挙がっています。</p>

<h1>
<span id="テスト" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>テスト</h1>

<p>「仕組み」でも書いたとおり、Rack サーバの拡張なので、普通にテスト書いてもうまくいきません。というか、そもそも <code>env["rack_after_replay.callbacks"]</code> が <code>nil</code> になって例外が起きます。</p>

<p>ひとまず、遅延処理を行う部分を下記のようにすれば、テスト時は rack_after_reply を使わないようになります。運用時と実行されるタイミングが変わってしまうので、あまりよい方法ではないですが...。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">slow_proc</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span>
  <span class="c1"># 時間のかかる処理</span>
  <span class="vi">@photo</span><span class="o">.</span><span class="n">save!</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">env</span><span class="o">[</span><span class="s2">"rack_after_reply.callbacks"</span><span class="o">]</span>
  <span class="n">env</span><span class="o">[</span><span class="s2">"rack_after_reply.callbacks"</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="n">slow_proc</span>
<span class="k">else</span> <span class="c1"># テスト時</span>
  <span class="n">slow_proc</span><span class="o">.</span><span class="n">call</span>
<span class="k">end</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />8位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>45</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/ace811bf00d6d201635d">Rails 3.2 のプロジェクトに jasmine 導入して CoffeeScript でテスト書くまで</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-19 15:33:50</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[CoffeeScript]</b> <b>[Rails]</b> <b>[jasmine]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>(evergreen gem を使ったより簡単な方法を <a href="http://qiita.com/items/077d4bbe12adb22c7637" class="autolink">http://qiita.com/items/077d4bbe12adb22c7637</a> に書いています)</p>

<p>Rails プロジェクトで使用する JavaScript / CoffeeScript をテストするため、jasmine を導入する。</p>

<h1>
<span id="jasmine-gem-導入" class="fragment"></span><a href="#jasmine-gem-%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>jasmine gem 導入</h1>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"jasmine"</span>
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>bundle
rails g jasmine:install
rails g jasmine:examples
rake jasmine
<span class="c1"># Open browser</span>
open http://localhost:8888/
</pre></div></div>

<p>rails g jasmine:examples で生成したスクリプトは削除してよい。</p>

<h2>
<span id="spec-の書き方" class="fragment"></span><a href="#spec-%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9"><i class="fa fa-link"></i></a>spec の書き方</h2>

<p>ここでは coffeescript で書いてるので後述の「spec を coffeescript で書く」参照。</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nx">describe</span> <span class="s">"true"</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="nx">it</span> <span class="s">"should be truthy"</span><span class="p">,</span> <span class="nf">-&gt;</span>
    <span class="c1"># shouldBeTruthy はメソッドなので最後の () は省略不可</span>
    <span class="nx">expect</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
</pre></div></div>

<h2>
<span id="matcher-の一覧" class="fragment"></span><a href="#matcher-%E3%81%AE%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>matcher の一覧</h2>

<p><a href="https://github.com/pivotal/jasmine/wiki/Matchers" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/pivotal/jasmine/wiki/Matchers</a></p>

<h1>
<span id="jasmine-jquery-導入" class="fragment"></span><a href="#jasmine-jquery-%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>jasmine-jquery 導入</h1>

<p>jasmine のみだと dom の絡む機能のテストを書く際に、createElement などでせっせと dom ツリーを作らないといけないし、関連するマッチャも用意しないといけない。</p>

<p>そのへんを省力化するためのツールが jasmine-jquery。</p>

<p><a href="https://github.com/velesin/jasmine-jquery/downloads" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/velesin/jasmine-jquery/downloads</a> から jasmine-jquery-1.3.1.js をダウンロード、spec/javascripts/helpers へコピー。</p>

<h2>
<span id="追加される-matcher" class="fragment"></span><a href="#%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%82%8B-matcher"><i class="fa fa-link"></i></a>追加される matcher</h2>

<p><a href="https://github.com/velesin/jasmine-jquery#jquery-matchers" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/velesin/jasmine-jquery#jquery-matchers</a></p>

<h2>
<span id="fixture" class="fragment"></span><a href="#fixture"><i class="fa fa-link"></i></a>fixture</h2>

<p>spec/javascripts/fixtures 下に html ファイルを作成する (内容は HTML フラグメント)。</p>

<p>test 中では <code>loadFixtures(ファイル名);</code> でページ中のフィクスチャ用コンテナ内にロードされる (ので fixture の要素には id つけとくべき)。</p>

<p>フィクスチャ用コンテナはテストごとに再作成される。</p>

<h3>
<span id="その他の関数" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>その他の関数</h3>

<ul>
<li>appendLoadFixtures(ファイル名, …): フィクスチャコンテナに追加</li>
<li>readFixtures(ファイル名, …): フィクスチャの内容を文字列で返す</li>
<li>setFixtures(html): 文字列か jQuery エレメントでフィクスチャコンテナの内容を置き換え</li>
<li>appendSetFixtures(html): 文字列か jQuery エレメントでフィクスチャコンテナの内容を追加</li>
<li>sandbox({attributeName: value, …}): div エレメントの作成、id がなければ sandbox になる。</li>
</ul>

<h1>
<span id="spec-を-coffeescript-で書く" class="fragment"></span><a href="#spec-%E3%82%92-coffeescript-%E3%81%A7%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>spec を coffeescript で書く</h1>

<p>app/assets 下などは rails がコンパイルしてくれるので気にしなくてよいが、spec は自前でコンパイルする必要がある。</p>

<p><a href="http://pivotallabs.com/users/mgehard/blog/articles/1683-using-jasmine-to-test-coffeescript-in-a-rails-3-1-app" class="autolink" rel="nofollow noopener" target="_blank">http://pivotallabs.com/users/mgehard/blog/articles/1683-using-jasmine-to-test-coffeescript-in-a-rails-3-1-app</a></p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"guard-coffeescript"</span>
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>bundle
<span class="c1"># Guardfile なければ</span>
guard init
<span class="c1"># guard init coffeescript してもいいけどどうせすぐ書き換える</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Guardfile</span>
<span class="n">guard</span> <span class="s2">"coffeescript"</span><span class="p">,</span> <span class="ss">output</span><span class="p">:</span> <span class="s2">"spec/javascripts/compiled"</span> <span class="k">do</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^spec/javascripts/(.*).coffee}</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h1>
<span id="livereload" class="fragment"></span><a href="#livereload"><i class="fa fa-link"></i></a>livereload</h1>

<p>テスト書き換えるたび手動でブラウザリロードするのはめんどくさいので guard-livereload で自動化する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"guard-livereload"</span>
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>bundle
guard init livereload
</pre></div></div>

<p>.coffee はチェックせず .js のみチェックすることで、コンパイル後のタイミングでリロードする。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Guardfile</span>
<span class="n">guard</span> <span class="s1">'livereload'</span> <span class="k">do</span>
  <span class="c1"># 下記の 1 行を追加</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{spec/javascripts/.+\.js}</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>ブラウザの extension は <a href="https://github.com/mockko/livereload/blob/master/README-old.md" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/mockko/livereload/blob/master/README-old.md</a> から。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />9位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>43</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/387e7592b8e388fd9ca5">rails g scaffold のカスタマイズ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-21 14:12:23</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>参考: <a href="http://guides.rubyonrails.org/generators.html" class="autolink" rel="nofollow noopener" target="_blank">http://guides.rubyonrails.org/generators.html</a></p>

<h1>
<span id="テンプレートのカスタマイズ" class="fragment"></span><a href="#%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA"><i class="fa fa-link"></i></a>テンプレートのカスタマイズ</h1>

<p><code>rake -T</code> では出てこないけど、下記のタスクを使う</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">rake</span> <span class="ss">rails</span><span class="p">:</span><span class="ss">templates</span><span class="p">:</span><span class="n">copy</span>
</pre></div></div>

<p>すると下記のファイルが生成される。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>lib
└── templates
    ├── erb
    │   ├── controller
    │   │   └── view.html.erb # rails g controlle で使われる
    │   ├── mailer
    │   │   └── view.text.erb # rails g mailer で使われる
    │   └── scaffold
    │       ├── _form.html.erb
    │       ├── edit.html.erb
    │       ├── index.html.erb
    │       ├── new.html.erb
    │       └── show.html.erb
    └── rails
        ├── assets
        │   ├── javascript.js
        │   └── stylesheet.css
        ├── controller
        │   └── controller.rb # rails g controller で使われる
        ├── helper
        │   └── helper.rb
        └── scaffold_controller
            └── controller.rb
</pre></div></div>

<p>上でコメントしたもの以外は <code>rails g scaffold</code> で使用される。<br>
ここでたとえば <code>lib/templates/scaffold/show.html.erb</code> を変更すれば次に <code>rails g scaffold</code> した際に反映される。</p>

<h1>
<span id="haml-を生成" class="fragment"></span><a href="#haml-%E3%82%92%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>Haml を生成</h1>

<p>scaffold で Haml を生成する場合 generator をつくる必要がある (<code>rake rails:templates:copy</code> は必要ない)。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>rails g generator haml/scaffold
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>lib
└── generators
    └── haml
        └── scaffold
            ├── USAGE
            ├── scaffold_generator.rb
            └── templates
</pre></div></div>

<p>scaffold_generator.rb を下記のように修正する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"rails/generators/erb/scaffold/scaffold_generator"</span>
<span class="c1"># erb 用の generator を継承する</span>
<span class="k">class</span> <span class="nc">Haml</span><span class="o">::</span><span class="no">ScaffoldGenerator</span> <span class="o">&lt;</span> <span class="no">Erb</span><span class="o">::</span><span class="no">Generators</span><span class="o">::</span><span class="no">ScaffoldGenerator</span>
  <span class="n">source_root</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../templates'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>

  <span class="kp">protected</span>
  <span class="k">def</span> <span class="nf">handler</span>
    <span class="ss">:haml</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p><code>lib/generators/haml/scaffold/templates</code> 下に _form.haml, edit.haml, index.haml, new.haml, show.haml を用意する。</p>

<p>これらは erb として評価される。<code>rake rails:templates:copy</code> で生成される <code>lib/templates/erb/scaffold/*.html.erb</code> を参考に。</p>

<p>config/application.rb で、使用する generator を指定する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># config/application.rb</span>
<span class="k">module</span> <span class="nn">Foo</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="o">.</span><span class="n">generators</span> <span class="k">do</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span>
      <span class="n">g</span><span class="o">.</span><span class="n">template_engine</span> <span class="ss">:haml</span>
      <span class="c1"># 下記も指定しておくと無駄な helper / js / css が生成されない</span>
      <span class="c1"># g.helper false</span>
      <span class="c1"># g.stylesheets false</span>
      <span class="c1"># g.javascripts false</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />10位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>39</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/77125e3d321ae14efbbf">Chef Solo + Knife Solo で暗号化データバッグを使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-10 14:41:12</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[chef]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>参考: <a href="http://ed.victavision.co.uk/blog/post/4-8-2012-chef-solo-encrypted-data-bags" class="autolink" rel="nofollow noopener" target="_blank">http://ed.victavision.co.uk/blog/post/4-8-2012-chef-solo-encrypted-data-bags</a></p>

<h1>
<span id="鍵を作る" class="fragment"></span><a href="#%E9%8D%B5%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>鍵を作る</h1>

<p>Chef リポジトリのルートに data_bag_key という名前で鍵をつくる。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>openssl rand -base64 <span class="m">512</span> <span class="p">|</span> tr -d <span class="s1">'\r\n'</span> &gt; data_bag_key
</pre></div></div>

<p>Git リポジトリに入れてしまうとせっかく暗号化する意味が無いので .gitignore に追加しておく。</p>

<div class="code-frame" data-lang="gitignore"><div class="highlight"><pre><span></span>/data_bag_key
</pre></div></div>

<p><code>knife solo cook</code> を使う場合、Chef Solo を実行するサーバには rsync でコピーされるので Git リポジトリに入ってなくとも問題ない。<br>
そのかわり、この鍵は紛失しないよう注意。</p>

<h1>
<span id="暗号化データバッグ-encrypted-data-bag-作成" class="fragment"></span><a href="#%E6%9A%97%E5%8F%B7%E5%8C%96%E3%83%87%E3%83%BC%E3%82%BF%E3%83%90%E3%83%83%E3%82%B0-encrypted-data-bag-%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>暗号化データバッグ (Encrypted data bag) 作成</h1>

<p>Chef Server なら下記コマンドでいいんだけど、Chef Solo ではうまくいかない。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>knife data bag create --secret-file data_bag_key <span class="o">[</span>data-bag-name<span class="o">]</span> <span class="o">[</span>entry-name<span class="o">]</span>
</pre></div></div>

<p>下記のように Chef のライブラリを使って作成する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'chef/encrypted_data_bag_item'</span>
<span class="nb">require</span> <span class="s2">"fileutils"</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"id"</span> <span class="o">=&gt;</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"foobar"</span><span class="p">}</span>

<span class="n">secret</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load_secret</span><span class="p">(</span><span class="s1">'data_bag_key'</span><span class="p">)</span>
<span class="n">encrypted_data</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">encrypt_data_bag_item</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>

<span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s1">'data_bags/passwords'</span><span class="p">)</span>
<span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'data_bags/passwords/mysql.json'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="n">f</span><span class="o">.</span><span class="n">print</span> <span class="n">encrypted_data</span><span class="o">.</span><span class="n">to_json</span>
<span class="k">end</span>
</pre></div></div>

<p>私はこれをもとに JSON または YAML からデータバッグを作成するスクリプトを作成して使っている。</p>

<p>このへんをうまくやってくれそうなツールもある (試してない)。<br>
<a href="https://github.com/thbishop/knife-solo_data_bag" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/thbishop/knife-solo_data_bag</a></p>

<h1>
<span id="使いかた" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E3%81%8B%E3%81%9F"><i class="fa fa-link"></i></a>使いかた</h1>

<p>レシピ内で <code>Chef::EncryptedDataBagItem.load</code> を使う。<code>data_bags(データバッグ名)</code> で entry name の配列が取得できるのは通常の data bag と同じ。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"passwords"</span><span class="p">,</span> <span class="s2">"mysql"</span><span class="p">)</span>
</pre></div></div>

<h1>
<span id="追記-2013-11-18" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98-2013-11-18"><i class="fa fa-link"></i></a>追記 (2013-11-18)</h1>

<p>いつからかは詳しく見てないけど、新しく Chef リポジトリ作って上記手順を実行したら <code>knife solo cook</code> 時に下記のようなエラーが出た。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>Errno::ENOENT
-------------
No such file or directory - file not found '/home/chef/chef-solo/data_bag_key'
</pre></div></div>

<p><a href="https://github.com/matschaffer/knife-solo/blob/master/README.rdoc#cook-command" rel="nofollow noopener" target="_blank">最新の knife-solo の README.rdoc</a> をみると、<code>.chef/knife.rb</code> で鍵のパスを示せとの記述が。みてみるとコメントアウトされてる。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># .chef/knife.rb</span>
<span class="n">cookbook_path</span> <span class="o">[</span><span class="s2">"cookbooks"</span><span class="p">,</span> <span class="s2">"site-cookbooks"</span><span class="o">]</span>
<span class="n">node_path</span>     <span class="s2">"nodes"</span>
<span class="n">role_path</span>     <span class="s2">"roles"</span>
<span class="n">data_bag_path</span> <span class="s2">"data_bags"</span>
<span class="c1">#encrypted_data_bag_secret "data_bag_key"</span>

<span class="n">knife</span><span class="o">[</span><span class="ss">:berkshelf_path</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"cookbooks"</span>
</pre></div></div>

<p>このコメントを外したら、data_bag_key がアップロードされ、問題なく動作するようになった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />11位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>33</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/c8316e26aff8ace1baa1">each を遅延評価しながら複数スレッドで並行処理</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-17 16:00:33</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="目的" class="fragment"></span><a href="#%E7%9B%AE%E7%9A%84"><i class="fa fa-link"></i></a>目的</h1>

<p>to_a できないが each できるリストについて、複数スレッドで処理したい。</p>

<p>具体的なユースケースは AWS::S3::ObjectCollection の処理で、これは each すると 1000 回ごとに AWS の API を呼び出す。to_a すると、いちどきに連続して API を呼び出し、巨大な配列をつくってしまうので避けたい。</p>

<h1>
<span id="だめだった方法" class="fragment"></span><a href="#%E3%81%A0%E3%82%81%E3%81%A0%E3%81%A3%E3%81%9F%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>だめだった方法</h1>

<ul>
<li>parallel gem : 内部で最初に to_a しているため、each は遅延処理されず、すべてのオブジェクトを入れる配列 (+結果を入れる配列) が必要になる。</li>
<li>Enumerator / Fiber : スレッドをまたいで使えない</li>
</ul>

<h1>
<span id="解決方法" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>解決方法</h1>

<p>標準ライブラリ thread で追加される SizedQueue をつかう。これは固定サイズのキューで、複数スレッドから扱うことができ、また値の追加時にキューがいっぱいなら待ってくれる。</p>

<p>これを利用し、サブスレッドはキューから次に処理するオブジェクトを取得して処理、メインスレッドは each で得たオブジェクトを (サブスレッドの処理を待ちつつ) キューに追加、というようにする。</p>

<h1>
<span id="実装例" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E4%BE%8B"><i class="fa fa-link"></i></a>実装例</h1>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"thread"</span>

<span class="no">TERMINATOR</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">new</span> <span class="c1"># キューの終わりを示すオブジェクト</span>
<span class="no">COUNT</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># 処理するスレッド数</span>

<span class="k">def</span> <span class="nf">each_in_multi_threads</span><span class="p">(</span><span class="n">enumerable</span><span class="p">)</span>
  <span class="n">queue</span> <span class="o">=</span> <span class="no">SizedQueue</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">COUNT</span><span class="p">)</span>
  <span class="n">threads</span> <span class="o">=</span> <span class="no">COUNT</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span><span class="p">{</span>
    <span class="no">Thread</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span>
      <span class="k">while</span> <span class="kp">true</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">shift</span>
        <span class="k">break</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">equal?</span><span class="p">(</span><span class="no">TERMINATOR</span><span class="p">)</span> <span class="c1"># TERMINATOR だったらこのスレッドの仕事は終わり</span>
        <span class="k">yield</span> <span class="n">v</span>
      <span class="k">end</span>
    <span class="p">}</span>  
  <span class="p">}</span>
  <span class="n">enumerable</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">queue</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="p">}</span>
  <span class="no">COUNT</span><span class="o">.</span><span class="n">times</span><span class="p">{</span> <span class="n">queue</span> <span class="o">&lt;&lt;</span> <span class="no">TERMINATOR</span> <span class="p">}</span> <span class="c1"># キューの最後にすべてのスレッド分 TERMINATOR を追加</span>
  <span class="n">threads</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:join</span><span class="p">)</span>
  <span class="n">enumerable</span>
<span class="k">end</span>

<span class="n">enumerable</span> <span class="o">=</span> <span class="mi">1</span><span class="o">..</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># 無限リスト</span>
<span class="n">each_in_multi_threads</span><span class="p">(</span><span class="n">enumerable</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">v</span>
  <span class="nb">sleep</span> <span class="mi">1</span> <span class="c1"># 時間のかかる処理</span>
<span class="k">end</span>
</pre></div></div>

<p>同じ仕組みで each_with_index や map も可能 (map はどうしても結果の配列を作ることになるけど)。</p>

<p>parallel のように fork 使って複数プロセスで処理できるといいんだけど、Marshal.dump して子プロセスに渡す必要があるから、ちょっと用途が限られてしまう。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />12位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>32</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/9e374de17675cb6114af">YAML や JSON のような構造のオブジェクトに対して再帰的に処理を加えるイディオム</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-02-07 16:52:16</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>YAML や JSON で表現されるような、スカラー値、Array、Hash で構成されたオブジェクトについて、再帰的に処理をする際、下記のようなイディオムが使える。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">obj</span>
  <span class="k">when</span> <span class="nb">Array</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">foo</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span> <span class="c1"># Array の要素を再帰的に処理</span>
  <span class="k">when</span> <span class="no">Hash</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">|</span>
      <span class="nb">hash</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="c1"># Hash の値を再帰的に処理</span>
      <span class="nb">hash</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">obj</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h1>
<span id="例-hash-のキーを-to_s-する" class="fragment"></span><a href="#%E4%BE%8B-hash-%E3%81%AE%E3%82%AD%E3%83%BC%E3%82%92-to_s-%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>例. Hash のキーを to_s する</h1>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stringify_keys</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">obj</span>
  <span class="k">when</span> <span class="nb">Array</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">stringify_keys</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
  <span class="k">when</span> <span class="no">Hash</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">|</span>
      <span class="c1"># ここが変わる</span>
      <span class="nb">hash</span><span class="o">[</span><span class="n">k</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span> <span class="o">=</span> <span class="n">stringify_keys</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="nb">hash</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">obj</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">stringify_keys</span><span class="p">({</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="p">{</span><span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">]</span><span class="p">})</span> <span class="c1">#=&gt; {"a"=&gt;1, "b"=&gt;[{"c"=&gt;3}]}</span>
</pre></div></div>

<h1>
<span id="例-スカラー値を-to_s-する" class="fragment"></span><a href="#%E4%BE%8B-%E3%82%B9%E3%82%AB%E3%83%A9%E3%83%BC%E5%80%A4%E3%82%92-to_s-%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>例. スカラー値を to_s する</h1>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stringify_values</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">obj</span>
  <span class="k">when</span> <span class="nb">Array</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">stringify_values</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
  <span class="k">when</span> <span class="no">Hash</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">|</span>
      <span class="nb">hash</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">stringify_values</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="nb">hash</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="c1"># ここが変わる</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">stringify_values</span><span class="p">({</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="p">{</span><span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">]</span><span class="p">})</span> <span class="c1">#=&gt; {:a=&gt;"1", :b=&gt;[{:c=&gt;"3"}]}</span>
</pre></div></div>

<h1>
<span id="例-array-をインデックスをキーとする-hash-に置き換える" class="fragment"></span><a href="#%E4%BE%8B-array-%E3%82%92%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E3%82%AD%E3%83%BC%E3%81%A8%E3%81%99%E3%82%8B-hash-%E3%81%AB%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>例. Array を、インデックスをキーとする Hash に置き換える</h1>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">hash_arrays</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">obj</span>
  <span class="k">when</span> <span class="nb">Array</span>
    <span class="c1"># ここが変わる</span>
    <span class="no">Hash</span><span class="o">[</span>
      <span class="n">obj</span><span class="o">.</span><span class="n">each_with_index</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
        <span class="o">[</span><span class="n">i</span><span class="p">,</span> <span class="n">hash_arrays</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="o">]</span>
  <span class="k">when</span> <span class="no">Hash</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">|</span>
      <span class="nb">hash</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">hash_arrays</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="nb">hash</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">obj</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">hash_arrays</span><span class="p">({</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="p">{</span><span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">]</span><span class="p">})</span> <span class="c1">#=&gt; {:a=&gt;1, :b=&gt;{0=&gt;{:c=&gt;3}}}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />13位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>24</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/f98cdf29b0cf24f69b83">Sublime Text 2 のプラグイン (コマンド) をつくる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-10 01:08:57</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[SublimeText2]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<ul>
<li>Python で書く必要がある</li>
<li>実体は sublime_plugin.TextCommand のサブクラスで、このクラス 1 つが 1 コマンドに対応</li>
<li>実行時はこのクラスのインスタンスが作られ run メソッドが呼ばれるので、処理をここに書く</li>
<li>コマンド名はクラス名から Command をのぞき snake case にしたもの、FooBarCommand なら foo_bar になる</li>
<li>Command Palette に表示する方法は後述</li>
<li>Snippet はまた全然別の仕組み</li>
</ul>

<h1>
<span id="作り方" class="fragment"></span><a href="#%E4%BD%9C%E3%82%8A%E6%96%B9"><i class="fa fa-link"></i></a>作り方</h1>

<p>[Tools]-[New Plugin...] とするとひな形ができるので、Packages/User 下 (など) に保存する。拡張子は py でよい。</p>

<h1>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h1>

<ol>
<li>Console を開いて ([View]-[Show Console]) <code>view.run_command("コマンド名")</code>
</li>
<li>キーバインドする ([Sublime Text 2]-[Preferences]-[Key Binding (User)])</li>
<li>Command Palette から使う (後述の方法で登録して [Tools]-[Command Palette...]) </li>
</ol>

<h1>
<span id="ドキュメント" class="fragment"></span><a href="#%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>ドキュメント</h1>

<p><a href="http://www.sublimetext.com/docs/2/api_reference.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.sublimetext.com/docs/2/api_reference.html</a></p>

<p>ここにも書いてあるけど、Packages/Default 内にサンプルがいくつかある。</p>

<h1>
<span id="イディオム" class="fragment"></span><a href="#%E3%82%A4%E3%83%87%E3%82%A3%E3%82%AA%E3%83%A0"><i class="fa fa-link"></i></a>イディオム</h1>

<p>self.view に対して処理することが多い。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="c1"># 開いてる view を取得</span>
<span class="bp">self</span><span class="o">.</span><span class="n">view</span>

<span class="c1"># OK / キャンセルダイアログ</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">sublime</span><span class="o">.</span><span class="n">ok_cancel_diag</span><span class="p">(</span><span class="sa">u</span><span class="s1">'処理を続行しますか?'</span><span class="p">)</span>
  <span class="k">return</span>

<span class="c1"># 開いてるファイルのパスを取得</span>
<span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">file_name</span><span class="p">()</span>

<span class="c1"># 開いてるプロジェクトのパスを取得</span>
<span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">window</span><span class="p">()</span><span class="o">.</span><span class="n">folders</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># ファイルを開く</span>
<span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">window</span><span class="p">()</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="s2">"foo.rb"</span><span class="p">)</span>

<span class="c1"># ファイルの内容をすべて取得</span>
<span class="n">region_all</span> <span class="o">=</span> <span class="n">sublime</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">substr</span><span class="p">(</span><span class="n">region_all</span><span class="p">)</span>

<span class="c1"># ファイルの内容をすべて置き換え</span>
<span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">edit</span><span class="p">,</span> <span class="n">region_all</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">)</span>

<span class="c1"># ファイルの存在チェックとかは普通に Python のライブラリを呼べば良い</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">"foo.rb"</span><span class="p">)</span>

<span class="c1"># シェルなんかも Python のライブラリで</span>
<span class="c1"># rbenv で ruby 呼ぶ場合、環境変数渡すかフルパスにしないといけない</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">"ruby"</span><span class="p">,</span> <span class="s2">"-v"</span><span class="p">],</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</pre></div></div>

<h1>
<span id="command-palette-に表示する" class="fragment"></span><a href="#command-palette-%E3%81%AB%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Command Palette に表示する</h1>

<p>コマンドを作っただけでは、Command Palette には表示されない (run_command やキーバインドで使うことはできる)。</p>

<p>下記の様なファイルを Packages/User/User.sublime-commands という名前 (拡張子重要) で保存すれば、Command Palette に表示されるようになる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="c1">// caption は Command Palette に表示される文字列</span>
  <span class="c1">// command はコマンド名</span>
  <span class="p">{</span> <span class="s2">"caption"</span><span class="o">:</span> <span class="s2">"Foo Bar"</span><span class="p">,</span> <span class="s2">"command"</span><span class="o">:</span> <span class="s2">"foo_bar"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s2">"caption"</span><span class="o">:</span> <span class="s2">"Baz"</span><span class="p">,</span> <span class="s2">"command"</span><span class="o">:</span> <span class="s2">"baz"</span> <span class="p">}</span>
<span class="p">]</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />14位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>23</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/077d4bbe12adb22c7637">Rails 3.2 のプロジェクトに jasmine 導入して CoffeeScript でテスト書くまで - evergreen 編</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-08-04 15:02:31</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[CoffeeScript]</b> <b>[Rails]</b> <b>[jasmine]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>先日 "Rails 3.2 のプロジェクトに jasmine 導入して CoffeeScript でテスト書くまで (<a href="http://qiita.com/items/ace811bf00d6d201635d)" class="autolink">http://qiita.com/items/ace811bf00d6d201635d)</a>" という記事を書いたが、evergreen gem を使えばもっと簡単にできた。</p>

<h1>
<span id="evergreen-gem-の導入" class="fragment"></span><a href="#evergreen-gem-%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>evergreen gem の導入</h1>

<p><a href="https://github.com/jnicklas/evergreen/" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/jnicklas/evergreen/</a></p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s2">"evergreen"</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="s2">"evergreen/rails"</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>bundle
rails s
<span class="c1"># テストは /evergreen にブラウザでアクセスすることで実行</span>
open http://localhost:3000/evergreen
</pre></div></div>

<h1>
<span id="テストを書く" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>テストを書く</h1>

<p><code>spec/javascripts/**/*_spec.(js|coffee)</code> にテストを書く。特に設定などなしに CoffeeScript で書ける。</p>

<p>テスト中ではテストに必要なスクリプトを <code>require</code> で指定する。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">require</span> <span class="s2">"/assets/application.js"</span>
</pre></div></div>

<p>毎回書くのも面倒なので、<code>spec/javascripts/spec_helper.(js|coffee)</code> を作って書いておく。</p>

<h1>
<span id="テンプレート" class="fragment"></span><a href="#%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>テンプレート</h1>

<p>DOM を扱うスクリプトのテストのために HTML 断片を読み込む仕組みが用意されている。</p>

<p><code>spec/javascripts/templates/*.html</code> に HTML を置き、describe 内で template("foo.html") のようにロードする。</p>

<div class="code-frame" data-lang="coffee"><div class="highlight"><pre><span></span><span class="nx">describe</span> <span class="s">"dom"</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="nx">template</span> <span class="s">"foo.html"</span>
  <span class="nx">it</span> <span class="s">"should find foo"</span><span class="p">,</span> <span class="nf">-&gt;</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s">"foo"</span><span class="p">)).</span><span class="o">not</span><span class="p">.</span><span class="nx">toBeNull</span><span class="p">()</span>
</pre></div></div>

<p>matcher は特に追加されないので、必要なら jasmine-jquery などを別途導入する。</p>

<h1>
<span id="livereload" class="fragment"></span><a href="#livereload"><i class="fa fa-link"></i></a>livereload</h1>

<p>guard-livereload による自動ブラウザリロードを導入。これは evergreen 使わない場合とほとんど変わらない。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"guard-livereload"</span>
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>bundle
guard init livereload
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Guardfile</span>
<span class="n">guard</span> <span class="s1">'livereload'</span> <span class="k">do</span>
  <span class="c1"># 下記の 1 行を追加</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{spec/javascripts/.+\.(js|coffee)}</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>ブラウザの extension は <a href="https://github.com/mockko/livereload/blob/master/README-old.md" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/mockko/livereload/blob/master/README-old.md</a> から。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />15位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>21</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/8b6b2547c58d98c48733">Rake タスクがどこで定義されているか調べる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-25 12:06:31</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[rake]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rails の <code>rake assets:precompile</code> のソースが見たかったので、調べてみた。</p>

<p>irb (pry でも可) 起動。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ irb
</pre></div></div>

<p>load で Rakefile を読み込む。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"rake"</span>
<span class="nb">load</span> <span class="s2">"Rakefile"</span>
</pre></div></div>

<p>あとは、</p>

<ol>
<li>Rake::Task.[] でタスク名からタスクを探して</li>
<li>actions メソッドで実行される Proc の配列を取得し</li>
<li>source_location で定義した場所を得る</li>
</ol>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">"assets:precompile"</span><span class="o">].</span><span class="n">actions</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:source_location</span><span class="p">)</span>
</pre></div></div>

<p>これは Rails アプリケーションの例だが、もちろんそれ以外でも使える。</p>

<p>ちなみに <code>Rake::Task.tasks</code> で、定義されたタスクの一覧を確認することができる。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />16位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>21</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/8384dd3c454ebb39c707">bundle exec を省略する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-05 21:45:07</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[bundle]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://github.com/mpapis/rubygems-bundler" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/mpapis/rubygems-bundler</a></p>

<p>README.md の記述は古いものが混じっててよくわからない。noexec gem も入れる必要がありそう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>gem install noexec
gem install rubygems-bundler
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># ~/.gemrc
custom_shebang: $env ruby_noexec_wrapper
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>gem regenerate_binstubs
</pre></div></div>

<p>↑これにより、gem でインストールされたコマンドの shebang が書き換えられる。</p>

<p>アンインストール時は</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># ~/.gemrc
custom_shebang: $env ruby
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>gem regenerate_binstubs
</pre></div></div>

<p>で OK。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />17位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/d5b55d3ddf606c77df44">Rails 3.2.13 にあわせて mail をアップデートしたらメールが送信できなくなった問題</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-26 02:24:34</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[mail]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rails 3.2.13 にあわせて mail を 2.5.3 にアップデートしたら、メールが送信できなくなってしまった (OpenSSL のエラーが出てサーバへの接続に失敗する)。</p>

<p>詳しく調べると、</p>

<ul>
<li>SMTPS に対応してないが TLS 必須の SMTP サーバを使用している</li>
<li>openssl_verify_mode を指定している</li>
<li>mail 2.5.0..2.5.3 を使用している</li>
</ul>

<p>場合にメールが送信できなくなるようです。</p>

<h1>
<span id="原因" class="fragment"></span><a href="#%E5%8E%9F%E5%9B%A0"><i class="fa fa-link"></i></a>原因</h1>

<p>下記のコミットで、それまで enable_starttls_auto だったところが enable_tls になっています (ちょうどノートついてますね)。</p>

<p><a href="https://github.com/mikel/mail/commit/9890b197c51f1d340fa7275aa4bc17103746657b" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/mikel/mail/commit/9890b197c51f1d340fa7275aa4bc17103746657b</a></p>

<p>これにより openssl_verify_mode を指定していると、enable_starttls_auto が true でも STARTTLS を使わず SMTPS で接続しようとします。</p>

<p>ここで SMTP サーバが SMTPS に対応してないが TLS 必須だと、どう設定しても接続できず、詰みます。</p>

<h1>
<span id="現状" class="fragment"></span><a href="#%E7%8F%BE%E7%8A%B6"><i class="fa fa-link"></i></a>現状</h1>

<p>現時点 (2013-03-26) で mail のリポジトリをみると、下記のコミットで、リファクタリングと同時にこの箇所は修正されています。</p>

<p><a href="https://github.com/mikel/mail/commit/d6e25e5e37e6d591f94cc04a2a52c1128fde81db" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/mikel/mail/commit/d6e25e5e37e6d591f94cc04a2a52c1128fde81db</a></p>

<p>ただこの修正を含む gem はまだリリースされていないようです。</p>

<h1>
<span id="actionmailer" class="fragment"></span><a href="#actionmailer"><i class="fa fa-link"></i></a>actionmailer</h1>

<p>問題が mail だけなら、関係しそうなプロジェクトでは mail 2.4.4 を使いつつ、新しいバージョンを待つ、でいいんだけど、actionmailer 3.2.13 は mail ~&gt; 2.5.3 を要求するので Rails 3.2.13 も使えなくなってしまう。</p>

<p>ちなみに actionmailer 3.2.12 までは mail ~&gt; 2.4.4 だったんだけどね。</p>

<h1>
<span id="解決方法" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>解決方法</h1>

<p>いくつか考えられる。</p>

<p>A. SMTP サーバで SMTPS 対応する、TLS 必須じゃなくする<br>
B. openssl_verify_mode を指定しない<br>
C. 新しい mail gem が出るまで待つ<br>
D. mail の未リリースのコード使う<br>
E. mail 2.5.3 にパッチあてる</p>

<p>E は fork するか、クラス再オープンしてメソッド上書き。<br>
下記の様に書き換えれば良いと思う。</p>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre><span></span><span class="gh">diff --git a/lib/mail/network/delivery_methods/smtp.rb b/lib/mail/network/delive</span>
<span class="gh">index 53c1330..79ceab0 100644</span>
<span class="gd">--- a/lib/mail/network/delivery_methods/smtp.rb</span>
<span class="gi">+++ b/lib/mail/network/delivery_methods/smtp.rb</span>
<span class="gu">@@ -124,9 +124,9 @@ module Mail</span>
             if RUBY_VERSION &gt;= '1.9.0'
               context = Net::SMTP.default_ssl_context
               context.verify_mode = openssl_verify_mode
<span class="gd">-              smtp.enable_tls(context)</span>
<span class="gi">+              smtp.enable_starttls_auto(context)</span>
             else
<span class="gd">-              smtp.enable_tls(openssl_verify_mode)</span>
<span class="gi">+              smtp.enable_starttls_auto(openssl_verify_mode)</span>
             end
           end
         end
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />18位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/ed6e8b87c2526304a6da">Windows に Rails の開発環境を構築する (DB は MySQL)</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-23 22:22:00</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Windows]</b> <b>[MySQL]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Windows で Rails 動かす必要があったのでやってみた。<br>
大変かと思ってたら意外とインストーラとか充実してて、それほど詰まるとこはなかった。</p>

<p>バージョンは下記の通り。環境変数 PATH の追加の仕方はググってください。</p>

<ul>
<li>Windows 8 Pro with Media Center 32bit</li>
<li>Ruby 1.9.3p392</li>
<li>MySQL 5.6.10</li>
<li>Rails 3.2.13</li>
<li>mysql2 0.3.11-x86-mingw32</li>
<li>node.js 0.10.1</li>
</ul>

<h1>
<span id="ruby" class="fragment"></span><a href="#ruby"><i class="fa fa-link"></i></a>Ruby</h1>

<p><a href="http://rubyinstaller.org/downloads/" class="autolink" rel="nofollow noopener" target="_blank">http://rubyinstaller.org/downloads/</a> から Ruby 1.9.3-p392 のインストーラをダウンロードして、インストール。インストールオプションはほぼデフォルトでいいけど PATH に追加するオプションだけチェックしとく (忘れたら C:\Ruby193\bin を PATH に追加する)。</p>

<h1>
<span id="devkit" class="fragment"></span><a href="#devkit"><i class="fa fa-link"></i></a>DevKit</h1>

<p>C 拡張付きの gem をビルドするには DevKit が必要になる。</p>

<p><a href="http://rubyinstaller.org/downloads/" class="autolink" rel="nofollow noopener" target="_blank">http://rubyinstaller.org/downloads/</a> から DevKit-tdm-32-4.5.2-20111229-1559-sfx.exe をダウンロード、こちらは適当なディレクトリを作ってその中で起動、extract ボタンで展開する。その後、コマンドプロンプトでこのディレクトリに移動して下記コマンドを実行する。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>ruby dk.rb init
ruby dk.rb install
</pre></div></div>

<p>参考: <a href="https://github.com/oneclick/rubyinstaller/wiki/Development-Kit" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/oneclick/rubyinstaller/wiki/Development-Kit</a></p>

<h1>
<span id="mysql" class="fragment"></span><a href="#mysql"><i class="fa fa-link"></i></a>MySQL</h1>

<p><a href="http://dev.mysql.com/downloads/installer/" class="autolink" rel="nofollow noopener" target="_blank">http://dev.mysql.com/downloads/installer/</a> から Windows 用のインストーラをダウンロードして、インストール。デフォルトでいろいろ入るようになってるけど、面倒なのでそのままで。root のパスワードを設定する必要がある。</p>

<p>インストール終了すると MySQL Workbench が起動する。起動画面の左のほうのリストボックスにある Local Instance MySQL56 というのをダブルクリックし、インストール時に設定した root のパスワードを入力して、エラーなく接続できることを確認しておくとよい。</p>

<h1>
<span id="mysql2" class="fragment"></span><a href="#mysql2"><i class="fa fa-link"></i></a>mysql2</h1>

<p>Windows で gem install mysql2 するとコンパイル済みのバイナリを取得するが、このままでは使用できない。</p>

<p>gem install mysql2 で表示されるメッセージに従って、<a href="http://dev.mysql.com/get/Downloads/Connector-C/mysql-connector-c-noinstall-6.0.2-win32.zip/from/pick" class="autolink" rel="nofollow noopener" target="_blank">http://dev.mysql.com/get/Downloads/Connector-C/mysql-connector-c-noinstall-6.0.2-win32.zip/from/pick</a> をダウンロードして展開。そのなかにある lib\libmysql.dll　を C:\Ruby193\bin にコピーしておく。</p>

<h1>
<span id="nodejs" class="fragment"></span><a href="#nodejs"><i class="fa fa-link"></i></a>Node.js</h1>

<p>Rails のアプリケーション作って試してみたら ExecJS::RuntimeError が出た。</p>

<p>ExecJS はデフォルトで Windows Script Host を利用してくれるはずだが、うまくいかなかったので Node.js を入れる。</p>

<p><a href="http://nodejs.org/" class="autolink" rel="nofollow noopener" target="_blank">http://nodejs.org/</a> からインストーラをダウンロードしてインストール。</p>

<p>PATH に C:\Program Files\nodejs を追加。</p>

<h1>
<span id="rails" class="fragment"></span><a href="#rails"><i class="fa fa-link"></i></a>Rails</h1>

<p>ここまできたら gem instal rails で Rails をインストール。動くとよいですね。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />19位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/344b762a30f01aa81759">Mac でコマンドラインからアプリケーション起動</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-09 17:36:52</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>open -a [アプリケーション名] でよい。<br>
アプリケーション名は /Application 下の .app の拡張子を除いたもの。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># Kobito 起動</span>
open -a Kobito

<span class="c1"># .profile を TextEdit で開く</span>
open -a TextEdit ~/.profile

<span class="c1"># サブディレクトリにあるものもアプリケーション名だけで OK。</span>
open -a Microsoft<span class="se">\ </span>Excel
</pre></div></div>

<p>よく使うものは alias を作っておくと楽。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># ~/.profile</span>
<span class="nb">alias</span> <span class="nv">kobito</span><span class="o">=</span><span class="s2">"open -a Kobito"</span>
</pre></div></div>

<p>.app をフルパスで渡してもよい (/Application 下にない場合など)。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># 下記のどちらでも OK</span>
open /Applications/Kobito.app
open -a /Applications/Kobito.app
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />20位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>14</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/c3ff46711721dce8c2bc">rails g scaffold で生成される model や migration のコードをカスタマイズ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-25 15:30:00</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>前に <a href="http://qiita.com/labocho/items/387e7592b8e388fd9ca5" id="reference-1d288dce666508de21ef">rails g scaffold のカスタマイズ</a>という記事を書いたんだけど、model や migration のテンプレートがなかったので調べた。</p>

<p>参考: <a href="http://stackoverflow.com/questions/19404133/custom-scaffolding-rails-add-a-method-in-every-model-class" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/19404133/custom-scaffolding-rails-add-a-method-in-every-model-class</a></p>

<h1>
<span id="デフォルトで使われるテンプレート" class="fragment"></span><a href="#%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%A7%E4%BD%BF%E3%82%8F%E3%82%8C%E3%82%8B%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>デフォルトで使われるテンプレート</h1>

<p>activerecord のソースに含まれている。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>activerecord-3.2.12
└── lib
    └── rails
        └── generators
            ├── active_record
            │   ├── migration
            │   │   ├── migration_generator.rb
            │   │   └── templates # rails g migration 用テンプレート
            │   │       └── migration.rb 
            │   ├── migration.rb
            │   ├── model
            │   │   ├── model_generator.rb
            │   │   └── templates # rails g model 用テンプレート
            │   │       ├── migration.rb
            │   │       ├── model.rb
            │   │       └── module.rb
            │   ├── observer
            │   │   ├── observer_generator.rb
            │   │   └── templates # rails g observer 用テンプレート
            │   │       └── observer.rb
            │   └── session_migration
            │       ├── session_migration_generator.rb
            │       └── templates # rails g session_migration 用テンプレート
            │           └── migration.rb
            └── active_record.rb
</pre></div></div>

<p><code>rails g scaffold</code> 時には <code>rails g model</code> と同じテンプレートが利用される模様。</p>

<h1>
<span id="カスタマイズ" class="fragment"></span><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA"><i class="fa fa-link"></i></a>カスタマイズ</h1>

<p>Rails アプリケーションの <code>lib/templates/active_record/ジェネレータ名/テンプレート名.rb</code> にテンプレートのファイルを置くと優先的に利用される。</p>

<p>たとえば <code>rails g scaffold</code> や <code>rails g model</code> で生成される migration のテンプレートを変更したいなら、<code>activerecord-3.2.12/lib/rails/generators/active_record/model/templates/migration.rb</code> を、<code>lib/templates/active_record/model/migration.rb</code> にコピーして変更を加えればよい。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> my_rails_app
$ mkdir -p lib/templates/active_record/model
$ cp <span class="sb">`</span>bundle show activerecord<span class="sb">`</span>/lib/rails/generators/active_record/model/templates/migration.rb lib/templates/active_record/model/migration.rb

</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />21位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>14</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/8ed63b4e0a1060170df4">Dir.glob と Find の違い</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-06-18 14:38:57</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby には find という標準ライブラリがあるんだけど、Dir.glob と違ってパターン指定できないし、どこで使うの? と思っていた。</p>

<p>が、調べてみると下記のような違いがあるようだ。</p>

<ul>
<li>
<code>Dir.glob</code> は対象となるファイルをすべてリストアップしてから処理を開始する</li>
<li>
<code>Find.find</code> は見つかったファイルをその都度処理する</li>
</ul>

<p>大量のファイルがあるディレクトリで、最初のファイルを処理しはじめるまでの時間を計ってみた。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># time ruby -e 'Dir.glob("**/*"){ exit 1 }'</span>
<span class="m">0</span>.46s user <span class="m">5</span>.34s system <span class="m">94</span>% cpu <span class="m">6</span>.125 total
<span class="m">0</span>.47s user <span class="m">5</span>.45s system <span class="m">96</span>% cpu <span class="m">6</span>.136 total
<span class="m">0</span>.48s user <span class="m">5</span>.49s system <span class="m">89</span>% cpu <span class="m">6</span>.634 total

<span class="c1"># time ruby -rfind -e 'Find.find("."){ exit 1 }'</span>
<span class="m">0</span>.04s user <span class="m">0</span>.03s system <span class="m">94</span>% cpu <span class="m">0</span>.070 total
<span class="m">0</span>.03s user <span class="m">0</span>.03s system <span class="m">95</span>% cpu <span class="m">0</span>.060 total
<span class="m">0</span>.03s user <span class="m">0</span>.03s system <span class="m">94</span>% cpu <span class="m">0</span>.069 total
</pre></div></div>

<p><code>Dir.glob</code> はパターンマッチングしてるのでフェアな比較ではないが、オーダーが違うことがわかる。</p>

<p>すべてのファイルを処理する時間はあまり変わらない (find が若干分が悪い)。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># time ruby -e 'Dir.glob("**/*").to_a'</span>
<span class="m">0</span>.47s user <span class="m">5</span>.41s system <span class="m">96</span>% cpu <span class="m">6</span>.107 total
<span class="m">0</span>.46s user <span class="m">5</span>.39s system <span class="m">95</span>% cpu <span class="m">6</span>.119 total
<span class="m">0</span>.46s user <span class="m">5</span>.33s system <span class="m">93</span>% cpu <span class="m">6</span>.211 total

<span class="c1"># time ruby -rfind -e 'Find.find(".").to_a'</span>
<span class="m">1</span>.25s user <span class="m">5</span>.52s system <span class="m">94</span>% cpu <span class="m">7</span>.185 total
<span class="m">1</span>.22s user <span class="m">5</span>.39s system <span class="m">96</span>% cpu <span class="m">6</span>.879 total
<span class="m">1</span>.26s user <span class="m">5</span>.46s system <span class="m">96</span>% cpu <span class="m">7</span>.000 total
</pre></div></div>

<p>使い勝手と総処理時間では Dir.glob のが有利だが、Find は処理を始めるまでの時間が短い (O1) ので、ユーザにすばやいレスポンスを提供することができる。CUI で大量のファイルを処理する場合などはこちらを使ったほうがよいだろう。</p>

<p>ちなみに、<code>Dir.glob</code> に似たパターンマッチが <code>File.fnmatch</code> で行えるが <code>{}</code> や <code>**</code> が使えず、若干不便なので、正規表現で処理するのが楽。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />22位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>13</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/38a9e6b9626f64aa0f4d">Rails でプリコンパイルされてない Asset を参照していないかテストする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-25 12:13:40</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>(明記しない限り Rails 3.2.13、config/environments/* はデフォルトのままとする)</p>

<p>特に古い Rails アプリケーションをアップデートする場合に問題になるのだけど、</p>

<ul>
<li>config.assets.precompile への追加を忘れていた</li>
<li>typo などで存在しない画像を image_tag で参照していた</li>
</ul>

<p>などが原因で、プリコンパイルされていない Asset を参照している場合に、production 環境でページ表示時に例外が起きてしまう。</p>

<p>development 環境では問題が起きなかったり、少なくともページ表示時点では例外が起きないので気付きにくい。test でも同様。</p>

<p>ここでは、このようなケースでテストが失敗するようにしてみる。</p>

<h1>
<span id="テスト環境の設定" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E7%92%B0%E5%A2%83%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>テスト環境の設定</h1>

<p>まず <code>config/environments/test.rb</code> に下記の記述を追加する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Asset が precompile されていないときにエラー</span>
<span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="kp">false</span>
<span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">digest</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div></div>

<p>これで production 環境と同様に digest つきの URL を生成し、プリコンパイルされていない asset を参照したときに自動でコンパイルしないようになる。</p>

<h1>
<span id="テスト時に-asset-をプリコンパイルする" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E6%99%82%E3%81%AB-asset-%E3%82%92%E3%83%97%E3%83%AA%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>テスト時に Asset をプリコンパイルする</h1>

<p>このままではテストの前に毎回 <code>assets:precompile</code> を手動で実行しなければならないので、自動化する。</p>

<p><code>lib/tasks/rspec.rake</code> を作成し、下記のコードを記述する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">task</span> <span class="s2">"spec"</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"assets:clean"</span><span class="p">,</span> <span class="s2">"assets:precompile"</span><span class="o">]</span> <span class="k">do</span>
  <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">"assets:clean"</span><span class="o">].</span><span class="n">execute</span>
<span class="k">end</span>
</pre></div></div>

<p>これで <code>rake spec</code> の前にプリコンパイルし、終わったら削除するようになる。</p>

<p>test-unit などを使っている場合は、適宜書き換えてください。</p>

<h1>
<span id="既知の問題" class="fragment"></span><a href="#%E6%97%A2%E7%9F%A5%E3%81%AE%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>既知の問題</h1>

<p>遅い。assets 関係の task がとにかく遅い。</p>

<p>普段のテストとは分けて、リリース直前の回帰テストでだけチェックするとか考えた方がよい。</p>

<p>私の場合は <code>unless defined?(Spork) &amp;&amp; Spork.using_spork?</code> で囲って、Spork 使ってないときだけチェックするようにした。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />23位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/2f08cc3d249303122917">Chef で Amazon VPC 内に配置したインスタンスの node[&quot;ec2&quot;] が nil になってしまう場合</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-04-11 17:26:17</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[AWS]</b> <b>[chef]</b> <b>[ohai]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="解決方法" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>解決方法</h1>

<p>参考: <a href="http://www.opscode.com/blog/2012/05/30/ohai-6-14-0-released/" class="autolink" rel="nofollow noopener" target="_blank">http://www.opscode.com/blog/2012/05/30/ohai-6-14-0-released/</a></p>

<p><code>/etc/chef/ohai/hints/ec2.json</code> があれば期待通り動作する。中身は valid な JSON であれば何でも良い。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>mkdir -p /etc/chef/ohai/hints
<span class="nb">echo</span> <span class="o">{}</span> &gt; /etc/chef/ohai/hints/ec2.json
</pre></div></div>

<p>で OK。</p>

<h1>
<span id="原因" class="fragment"></span><a href="#%E5%8E%9F%E5%9B%A0"><i class="fa fa-link"></i></a>原因</h1>

<p>サーバの情報を収集する Ohai で、EC2 か判定する処理で下記のメソッドが使用される。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># ohai-6.16.0/lib/ohai/plugins/ec2.rb</span>
<span class="k">def</span> <span class="nf">has_ec2_mac?</span>
  <span class="n">network</span><span class="o">[</span><span class="ss">:interfaces</span><span class="o">].</span><span class="n">values</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">iface</span><span class="o">|</span>
    <span class="k">unless</span> <span class="n">iface</span><span class="o">[</span><span class="ss">:arp</span><span class="o">].</span><span class="n">nil?</span>
      <span class="k">if</span> <span class="n">iface</span><span class="o">[</span><span class="ss">:arp</span><span class="o">].</span><span class="n">value?</span><span class="p">(</span><span class="s2">"fe:ff:ff:ff:ff:ff"</span><span class="p">)</span>
        <span class="no">Ohai</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"has_ec2_mac? == true"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="no">Ohai</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"has_ec2_mac? == false"</span><span class="p">)</span>
  <span class="kp">false</span>
<span class="k">end</span>
</pre></div></div>

<p>しかし、VPC 内ではこのメソッドは false を返すため、EC2 であると判定されない。<code>/etc/chef/ohai/hints/ec2.json</code> があれば、このメソッドを使うことなく、EC2 であると判定するようになる </p>

<p>ちなみに <code>/etc/chef/ohai/hints/rackspace.json</code> なら rackspace だと判定したりする。冒頭の参考 URL 参照。</p>

<h1>
<span id="chef-でこのファイルを作成すると" class="fragment"></span><a href="#chef-%E3%81%A7%E3%81%93%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E3%81%A8"><i class="fa fa-link"></i></a>Chef でこのファイルを作成すると...</h1>

<p>Cookbook の template で作成してみたけど、node の情報は Cookbook のロードより前に収集してるのか、初回の cook ではうまくいかない。次からは期待通りに動作するのだけど。うーむ。</p>

<h1>
<span id="別のパスにするのは難しそう" class="fragment"></span><a href="#%E5%88%A5%E3%81%AE%E3%83%91%E3%82%B9%E3%81%AB%E3%81%99%E3%82%8B%E3%81%AE%E3%81%AF%E9%9B%A3%E3%81%97%E3%81%9D%E3%81%86"><i class="fa fa-link"></i></a>別のパスにする...のは難しそう</h1>

<p><code>/etc/chef/ohai/hints</code> というパスは <code>Ohai::Config.hints_path</code> で (1 要素の Array で) 指定されているので、ここに任意のパスを追加すればよい...のだけど、Chef 使用時にどのタイミングで指定すればいいのかわからなかった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />24位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/11985fa376b867b8e9ff">zbar で画像からバーコードを読み取る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-20 01:35:40</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> <b>[zbar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ZBar (<a href="http://zbar.sourceforge.net/" class="autolink" rel="nofollow noopener" target="_blank">http://zbar.sourceforge.net/</a>) という、すばらしい OSS でバーコードを読み取るまで。<br>
OSX 10.8.2 + Homebrew で。</p>

<p><code>brew install zbar</code> でエラーでたので、formula 編集。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>brew edit zbar
</pre></div></div>

<p>args に --without-xshm --without-xv 追加</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span>  <span class="k">def</span> <span class="nf">install</span>
    <span class="n">args</span> <span class="o">=</span> <span class="sx">%W[</span>
<span class="sx">      --disable-dependency-tracking</span>
<span class="sx">      --prefix=</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="sx"></span>
<span class="sx">      --without-python</span>
<span class="sx">      --without-qt</span>
<span class="sx">      --disable-video</span>
<span class="sx">      --without-gtk</span>
<span class="sx">+     --without-xshm</span>
<span class="sx">+     --without-xv</span>
<span class="sx">    ]</span>
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>brew install zbar
</pre></div></div>

<p><code>zbarimg</code> 実行すると <code>/usr/local/lib/libltdl.7.dylib</code> がないといわれるので ln -s。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>ln -s /usr/local/Cellar/libtool/2.4.2/lib/libltdl.7.dylib /usr/local/lib/libltdl.7.dylib
</pre></div></div>

<p>iPhone で撮った本の裏表紙↓を読んでみる。</p>

<p><a href="https://camo.qiitausercontent.com/df2bd6bed5947960008c752e1d28e9eae77d7c2b/687474703a2f2f692e696d6775722e636f6d2f304e654c4871496c2e6a70673f31" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/df2bd6bed5947960008c752e1d28e9eae77d7c2b/687474703a2f2f692e696d6775722e636f6d2f304e654c4871496c2e6a70673f31" alt="barcode.jpg" data-canonical-src="http://i.imgur.com/0NeLHqIl.jpg?1"></a></p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>zbarimg barcode.jpg
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>EAN-13:1920290007000
EAN-13:9784004314097
scanned <span class="m">2</span> barcode symbols from <span class="m">1</span> images in <span class="m">3</span>.5 seconds
</pre></div></div>

<p>おおー。</p>

<p>JPEG だけならこれでいいんだけど TIFF を読む必要があったためため imagemagick を --with-libtiff つきでビルドしなおした。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>brew uninstall imagemagick
brew install imagemagick --with-libtiff
</pre></div></div>

<p>ちなみに zbar にはカメラから読み取る zbarcam コマンド、各言語用のバインディングもある。</p>

<p>また Windows 向けのバイナリはインストーラ付きで依存ライブラリも同梱してて、いたれりつくせり。TIFF 読めなかったけど。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />25位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>11</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/a7afb80269b5c7556fa2">Rails でテキストエリアのデフォルトの行数・列数を変更する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-30 18:08:05</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">=</span> <span class="n">form_for</span> <span class="vi">@post</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:body</span>
</pre></div></div>

<p>みたいなコードで生成される textarea の cols, rows はデフォルトでは 40, 20 になる。個人的には rows 多すぎ。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">rows</span><span class="p">:</span> <span class="mi">10</span>
</pre></div></div>

<p>と書けば上書きできるけど、デフォルトを変えたい。</p>

<p><code>actionpack-3.2.8/lib/action_view/helpers/form_helper.rb</code> をみると下記の定数があり、これを使用している。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">DEFAULT_TEXT_AREA_OPTIONS</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"cols"</span> <span class="o">=&gt;</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">"rows"</span> <span class="o">=&gt;</span> <span class="mi">20</span> <span class="p">}</span>
</pre></div></div>

<p>なので <code>config/initializers/form_helper.rb</code> あたりにファイルを作って、下記のコードを書けばよい。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">ActionView</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">InstanceTag</span><span class="o">::</span><span class="no">DEFAULT_TEXT_AREA_OPTIONS</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="s2">"rows"</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span> 
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />26位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>9</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/b07b4ca821b257bfaa64">iPhone の VoiceOver を使ってみよう!</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-24 13:57:52</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[iOS]</b> <b>[voiceover]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>現在の Web 製作者でアクセシビリティにまったく無頓着という人はほとんどいないだろうけど、実際にスクリーンリーダーで Web を見たことがある人は少ないかもしれない。</p>

<p>アクセシビリティを向上させるノウハウや、自動テストの方法はよく知られているけど、やっぱり実際に使い勝手を試してみるのは大事だと思う。</p>

<p>かつては専用のソフトウェアを購入する必要があり、敷居が高かったが、最近の OSX や iOS には VoiceOver というスクリーンリーダー (およびジェスチャによるコントロール) が標準で付属している。</p>

<p>ここでは iPhone の VoiceOver の使い方を見てみよう。</p>

<h1>
<span id="voiceover-を有効にする" class="fragment"></span><a href="#voiceover-%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>VoiceOver を有効にする</h1>

<p>1.「設定」を開く<br>
2. 一般 -&gt; アクセシビリティ -&gt; VoiceOver -&gt; VoiceOver を「オン」にする</p>

<p>VoiceOver を有効にすると、スワイプ、タップなどの操作が全面的に置き換えられる。次項以降を参照。</p>

<h1>
<span id="基本操作" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><i class="fa fa-link"></i></a>基本操作</h1>

<p>VoiceOver ではほとんどの操作を「項目の選択」-&gt;「項目の実行」という順序で行う。</p>

<ul>
<li>
<code>右スワイプ</code> <code>左スワイプ</code> で項目間を移動する。移動すると項目名が読み上げられる (画面では黒枠で囲まれる)。</li>
<li>
<code>タップ</code> でタップしたところの項目を選択。<code>タップしながら指を動かす</code> と指のあるところの項目を選択。</li>
<li>
<code>ダブルタップ</code> で項目の決定。非 VoiceOver でのタップとほぼ同様。</li>
</ul>

<h1>
<span id="ローター" class="fragment"></span><a href="#%E3%83%AD%E3%83%BC%E3%82%BF%E3%83%BC"><i class="fa fa-link"></i></a>ローター</h1>

<ul>
<li>
<code>上スワイプ</code> <code>下スワイプ</code> は状況に応じて挙動が変化する。</li>
<li>その挙動は <code>二本指を右回転</code> <code>二本指を左回転</code> で切り替えられる (これをローターと呼ぶ)</li>
</ul>

<p><code>二本指を(右|左)回転</code> は地図を回転させるときのジェスチャ。親指と人差し指を使って、それぞれを左右方向に逆行させるとやりやすい。</p>

<h1>
<span id="自動で項目移動" class="fragment"></span><a href="#%E8%87%AA%E5%8B%95%E3%81%A7%E9%A0%85%E7%9B%AE%E7%A7%BB%E5%8B%95"><i class="fa fa-link"></i></a>自動で項目移動</h1>

<ul>
<li>
<code>二本指で上スワイプ</code> で最初の項目に戻り、自動で項目を移動する。迷子になったときに最初の項目に戻りたいときによく使う。</li>
<li>
<code>二本指で下スワイプ</code> で現在の項目から自動で移動。Safari や iBooks などで文章を読み上げたいときによく使う。</li>
<li>
<code>二本指でタップ</code> で、自動項目移動の中止・再開。</li>
</ul>

<p>Safari で検索フィールドに移動したいときに <code>二本指で上スワイプ</code> -&gt; <code>左スワイプ</code> とか。</p>

<h1>
<span id="目次--索引" class="fragment"></span><a href="#%E7%9B%AE%E6%AC%A1--%E7%B4%A2%E5%BC%95"><i class="fa fa-link"></i></a>目次 / 索引</h1>

<p>連絡先、ミュージックなど、右側に頭文字の書かれた目次 / 索引が表示されている場合、これを操作できる。</p>

<ul>
<li>右の目次 / 索引をタップして <code>上スワイプ</code> <code>下スワイプ</code> で移動</li>
</ul>

<h1>
<span id="文字入力" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%85%A5%E5%8A%9B"><i class="fa fa-link"></i></a>文字入力</h1>

<p>文字入力の方法は「標準」と「タッチ」がある。<br>
「ローター」で「入力モード」を選択し <code>上スワイプ</code> <code>下スワイプ</code> で切り替える。タッチのほうが素早く入力できる。</p>

<ul>
<li>「標準」入力モードではキーを選んで <code>ダブルタップ</code> で文字入力。</li>
<li>「タッチ」入力モードではキーをタップで文字入力。通常は <code>タップしながら指を動かし</code> て離すようにすると思う。</li>
<li>漢字変換は「次候補」がまともに使えないので、項目移動で候補を選択して <code>ダブルタップ</code>。</li>
</ul>

<h1>
<span id="そのほか" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E3%81%BB%E3%81%8B"><i class="fa fa-link"></i></a>そのほか</h1>

<ul>
<li>
<code>三本指でダブルタップ</code> で読み上げオン / オフ。</li>
<li>
<code>三本指でトリプルタップ</code> でスクリーンを非表示にする。省電力で見た目もかっこいい!</li>
<li>ロックの解除は「ロックの解除」まで項目移動して <code>ダブルタップ</code>
</li>
</ul>

<p>ほかにも多数のジェスチャがあるが、ここでは省略する。とりあえず上記のものさえ覚えていれば操作できると思う。</p>

<p>より詳しい情報は iPhone / iPad のユーザーガイドを参照してください。</p>

<p><a href="http://support.apple.com/ja_JP/manuals/" class="autolink" rel="nofollow noopener" target="_blank">http://support.apple.com/ja_JP/manuals/</a></p>

<h1>
<span id="数時間使ってみた所感" class="fragment"></span><a href="#%E6%95%B0%E6%99%82%E9%96%93%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%E6%89%80%E6%84%9F"><i class="fa fa-link"></i></a>数時間使ってみた所感</h1>

<p>Web ページは HTML / CSS をちゃんと使っていれば、かなり読める。<br>
ただ、見出しの使い方や alt 属性が不適切だとずいぶん読みにくくなる。</p>

<p>アプリも結構使えるが、無駄に項目が多かったり、文字での検索が必須のものはちょっと使いづらい。<br>
VoiceOver に最適化した UI を持ったアプリを作れば、需要はあるんじゃないかと思う。</p>

<p>参考文献:<br>
Katie Cunningham 著「アクセシビリティハンドブック」<br>
<a href="http://www.oreilly.co.jp/books/9784873115993/" class="autolink" rel="nofollow noopener" target="_blank">http://www.oreilly.co.jp/books/9784873115993/</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />27位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/dfd68bc4084b76a28b5c">表示範囲 (CropBox) を考慮して PDF のサムネイルをつくる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-13 14:14:03</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[PDF]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Automator や ImageMagick でも PDF を画像に変換することはできるが、表示範囲 (CropBox) が考慮されず、トンボや余白が画像に含まれてしまう場合がある。</p>

<p><a href="http://poppler.freedesktop.org/" rel="nofollow noopener" target="_blank">Poppler</a> という PDF レンダリングライブラリに含まれる <code>pdftoppm</code> コマンドなら <code>-cropbox</code> オプションで表示範囲のみを画像にすることができる。</p>

<h1>
<span id="poppler-のインストール" class="fragment"></span><a href="#poppler-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Poppler のインストール</h1>

<p>Homebrew を使っているなら、下記コマンドで完了。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ brew install poppler
</pre></div></div>

<p>XQuartz のインストールを要求されたら、下記からダウンロード、インストールする。</p>

<p><a href="https://xquartz.macosforge.org/landing/" class="autolink" rel="nofollow noopener" target="_blank">https://xquartz.macosforge.org/landing/</a></p>

<h1>
<span id="pdftoppm-の使い方" class="fragment"></span><a href="#pdftoppm-%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>pdftoppm の使い方</h1>

<p>ヘルプは <code>-h</code> オプションで。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ pdftoppm -h
</pre></div></div>

<p>下記コマンドで foo.pdf の 1 ページ目の表示範囲が foo.jpg に保存される。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># -cropsize  表示範囲を考慮</span>
<span class="c1"># -f 1       1 ページ目</span>
<span class="c1"># -jpeg      jpeg で出力</span>
$ pdftoppm -cropbox -f <span class="m">1</span> -jpeg foo.pdf &gt; foo.jpg
</pre></div></div>

<h1>
<span id="サムネイルに" class="fragment"></span><a href="#%E3%82%B5%E3%83%A0%E3%83%8D%E3%82%A4%E3%83%AB%E3%81%AB"><i class="fa fa-link"></i></a>サムネイルに</h1>

<p><code>pdftoppm</code> の <code>-scale-to</code> オプションでもサイズの変更は可能だが、あまり綺麗でなかったので ImageMagick の <code>convert</code> でリサイズする。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># jpeg:-         標準入力のデータを JPEG として読み込む</span>
<span class="c1"># -resize 96x96  96x96px に収まるサイズに縦横比を変えずリサイズ</span>
$ pdftoppm -cropbox -f <span class="m">1</span> -jpeg foo.pdf <span class="p">|</span> convert jpeg:- -resize 96x96 foo.jpg
</pre></div></div>

<h1>
<span id="例" class="fragment"></span><a href="#%E4%BE%8B"><i class="fa fa-link"></i></a>例</h1>

<p>下記は、pdf ディレクトリにある PDF のサムネイルを作成し、thumbnail ディレクトリに保存する Ruby スクリプト。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"shellwords"</span>
<span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"pdf/*.pdf"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">pdf</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">pdf</span>
  <span class="n">dest</span> <span class="o">=</span> <span class="s2">"thumbnail/"</span> <span class="o">+</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\.pdf$/</span><span class="p">,</span> <span class="s2">".jpg"</span><span class="p">)</span>
  <span class="sb">`pdftoppm -cropbox -f 1 -jpeg </span><span class="si">#{</span><span class="n">pdf</span><span class="o">.</span><span class="n">shellescape</span><span class="si">}</span><span class="sb"> | convert jpeg:- -resize 96x96 </span><span class="si">#{</span><span class="n">dest</span><span class="o">.</span><span class="n">shellescape</span><span class="si">}</span><span class="sb">`</span>
<span class="k">end</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />28位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/eb030f62122cddc2b65a">Dropbox を使って Kobito を複数デバイスで使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-09 19:57:24</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Kobito]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>~/Library/Kobito/Kobito.db を Dropbox に移動してシンボリックリンク貼る。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>mv ~/Library/Kobito/Kobito.db ~/Dropbox/Document
ln -s ~/Dropbox/Document/Kobito.db ~/Library/Kobito
</pre></div></div>

<p>すでに複数デバイスで使っていた場合、データのマージが必要。</p>

<p>Kobito.db は SQLite データベースなので、なんらかの方法でこの db にアクセスして ZITEM テーブルの該当行を手作業で移行する。<br>
Qiita で共有していない場合は Markdown をコピペするほうが楽。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />29位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/ef0a7c9346d8acf2b795">heroku db:pull したら gem がないっていわれた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-01 16:27:22</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><ul>
<li>heroku-toolbelt/2.39.5 (x86_64-darwin10.8.0) ruby/1.9.3</li>
<li>OSX 10.8.4</li>
<li>rbenv, homebrew 使用</li>
</ul>

<p><code>gem install heroku</code> したらこんなこと言われた。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ gem install heroku
...
Fetching: heroku-2.39.5.gem <span class="o">(</span><span class="m">100</span>%<span class="o">)</span>
 !    The <span class="sb">`</span>heroku<span class="sb">`</span> gem has been deprecated and replaced with the Heroku Toolbelt.
 !    Download and install from: https://toolbelt.heroku.com
 !    For API access, see: https://github.com/heroku/heroku.rb
...
</pre></div></div>

<p>これに従って <a href="https://toolbelt.heroku.com" class="autolink" rel="nofollow noopener" target="_blank">https://toolbelt.heroku.com</a> から Heroku Toolbelt をインストール。<br>
<code>heroku db:pull</code> したら下記メッセージ。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ heroku db:pull
 !    Taps Load Error: cannot load such file -- taps/operation
 !    You may need to install or update the taps gem to use db commands.
 !    On most systems this will be:
 !
 !    sudo gem install taps
</pre></div></div>

<p><code>gem install taps</code> してもだめ。rbenv 使ってるからかな。<br>
<code>heroku</code> コマンドの shebang を調べてみる。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ head -n <span class="m">1</span> <span class="sb">`</span>which heroku<span class="sb">`</span>
<span class="c1">#!/usr/local/heroku/ruby/bin/ruby</span>
</pre></div></div>

<p><code>/usr/local/heroku/ruby</code> に自前で ruby 持ってるらしい。<br>
たぶん gem コマンドもあるだろうと思ったらやっぱりあったので、改めて <code>taps</code> をインストール。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ /usr/local/heroku/ruby/bin/gem install taps
</pre></div></div>

<p>その後 <code>heroku db:pull</code> すると今度は <code>sqlite3</code> がないというのでインストール。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ /usr/local/heroku/ruby/bin/gem install sqlite3
</pre></div></div>

<p>もっかい試すと <code>pg</code> がないと言うのでインストール。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ /usr/local/heroku/ruby/bin/gem install pg
</pre></div></div>

<p>これで <code>heroku db:pull</code> できるようになった。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />30位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/d102ef42ebbfc33ccbd8">変換先の Encoding に無い文字を任意の文字列に置き換える</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-05-13 14:44:09</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby 1.9.3 以降では <code>String#encode</code> の <code>fallback</code> オプションに Proc が指定できるようになっている。</p>

<p><a href="http://ruby-doc.org/core-2.0/String.html#method-i-encode" class="autolink" rel="nofollow noopener" target="_blank">http://ruby-doc.org/core-2.0/String.html#method-i-encode</a></p>

<p>未定義文字がある場合、これを引数として、fallback に指定した Proc が呼び出され、返り値の文字列に置き換えられる。</p>

<p>下記では Windows-31J に無い文字を HTML の数値文字参照に置き換える例を示す。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">replace_with_charref</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="n">char</span> <span class="p">{</span>
  <span class="n">char</span><span class="o">.</span><span class="n">codepoints</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">cp</span><span class="o">|</span> <span class="s2">"#</span><span class="si">#{</span><span class="n">cp</span><span class="si">}</span><span class="s2">;"</span><span class="p">}</span><span class="o">.</span><span class="n">join</span>
<span class="p">}</span>

<span class="s2">"\u{00ae} is registered sign."</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"windows-31j"</span><span class="p">,</span> <span class="ss">fallback</span><span class="p">:</span> <span class="n">replace_with_charref</span><span class="p">)</span>
<span class="c1">#=&gt; "#174; is registered sign."</span>
</pre></div></div>

<p>1.9.2 では Hash しか指定できず、下記のようにしてみてもうまくいかなかった (同じコードは 1.9.3, 2.0.0 では期待通り動作する)。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># キーがない場合、キーに対応する数値文字参照を返す Hash</span>
<span class="n">replace_with_charref</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">char</span><span class="o">|</span>
  <span class="n">char</span><span class="o">.</span><span class="n">codepoints</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">cp</span><span class="o">|</span> <span class="s2">"#</span><span class="si">#{</span><span class="n">cp</span><span class="si">}</span><span class="s2">;"</span><span class="p">}</span><span class="o">.</span><span class="n">join</span>
<span class="p">}</span>

<span class="s2">"\u{00ae} is registered sign."</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"windows-31j"</span><span class="p">,</span> <span class="ss">fallback</span><span class="p">:</span> <span class="n">replace_with_charref</span><span class="p">)</span>
<span class="c1">#=&gt; Encoding::UndefinedConversionError: U+00AE from UTF-8 to Windows-31J</span>
</pre></div></div>

<p>1.9.2 で同等のことを実現するためには <code>Encoding::Converter#primitive_convert</code> を用いる必要がある。</p>

<p><a href="http://doc.ruby-lang.org/ja/1.9.3/method/Encoding=3a=3aConverter/i/primitive_convert.html" class="autolink" rel="nofollow noopener" target="_blank">http://doc.ruby-lang.org/ja/1.9.3/method/Encoding=3a=3aConverter/i/primitive_convert.html</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />31位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/f7cb8eb85780b545c3aa">Jam で Rails のクライアントサイド JS を管理する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-21 15:38:54</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Jam (<a href="http://jamjs.org/" class="autolink" rel="nofollow noopener" target="_blank">http://jamjs.org/</a>) は クライアントサイド JavaScript のパッケージマネージャ。Ruby でいう gem / bundler のようなことができる。</p>

<p>これを使って Rails のクライアントサイド JS を管理する方法を検討した。</p>

<h1>
<span id="インストール" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>インストール</h1>

<p>要 npm。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>npm install --global jamjs
</pre></div></div>

<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p><code>jam install</code> を実行すると...</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>jam install backbone
</pre></div></div>

<p>カレントディレクトリに jam ディレクトリができる。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ tree jam
jam
├── backbone
│   ├── backbone.js
│   └── package.json
├── jquery
│   ├── dist
│   │   └── jquery.js
│   ├── package.json
│   ├── src
│   │   └── sizzle
│   │       ├── package.json
│   │       └── speed
│   │           └── benchmark.js
│   │               └── package.json
│   └── <span class="nb">test</span>
│       └── qunit
│           └── package.json
├── require.config.js
├── require.js
└── underscore
    ├── package.json
    └── underscore.js
</pre></div></div>

<p>Backbone が依存している jQuery と Underscore のファイルがあるのがわかる (正確には jQuery 依存してないけど)。</p>

<p><code>package.json</code> は gemspec みたいなもので、バージョンや依存するパッケージが記述されている。</p>

<p><code>require.js</code> は RequireJS ( <a href="http://requirejs.org/" class="autolink" rel="nofollow noopener" target="_blank">http://requirejs.org/</a> )。</p>

<p><code>require.config.js</code> は RequireJS の設定ファイル。</p>

<h1>
<span id="asset-pipeline-を使わない場合" class="fragment"></span><a href="#asset-pipeline-%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Asset Pipeline を使わない場合</h1>

<p><code>cd public</code> してから <code>jam install</code>。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>rails new jam_test
<span class="nb">cd</span> jam_test
<span class="nb">cd</span> public
jam install backbone
</pre></div></div>

<p>HTML では <code>/jam/require.js</code> だけ読み込み、<code>require([パッケージ名], ロード後に実行する関数)</code> と書けば、指定したライブラリと依存するライブラリをロードして、第 2 引数の関数を実行してくれる。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"/jam/require.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="nx">require</span><span class="p">([</span><span class="s2">"backbone"</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">VERSION</span><span class="p">);</span> <span class="p">});</span> <span class="c1">// 0.9.9</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<h1>
<span id="asset-pipeline-を使う場合-1" class="fragment"></span><a href="#asset-pipeline-%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88-1"><i class="fa fa-link"></i></a>Asset Pipeline を使う場合 (1)</h1>

<p><code>Rails.root</code> で <code>jam install</code>。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>rails new jam_test
<span class="nb">cd</span> jam_test
jam install backbone
</pre></div></div>

<p>assets path に <code>jam</code> ディレクトリを追加して...</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">paths</span> <span class="o">&lt;&lt;</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"jam"</span><span class="p">)</span>
</pre></div></div>

<p><code>application.js</code> などで自前でロードする。ロード順については <code>jam/require.config.js</code> を参考にする。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="c1">// app/assets/javascripts/application.js</span>
<span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require underscore/underscore</span>
<span class="c1">//= require backbone/backbone</span>
<span class="c1">//= require_tree .</span>
</pre></div></div>

<p>application.js に書かなきゃいけないのは面倒だけど、jam 使わないのに比べるとだいぶ楽。</p>

<h1>
<span id="asset-pipeline-を使う場合-2" class="fragment"></span><a href="#asset-pipeline-%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88-2"><i class="fa fa-link"></i></a>Asset Pipeline を使う場合 (2)</h1>

<p>Sprockets に手を入れて <code>jam/require.config.js</code> をロードする。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># config/initializers/sprockets.rb</span>
<span class="nb">require</span> <span class="s2">"sprockets/directive_processor"</span>
<span class="k">module</span> <span class="nn">Sprockets</span>
  <span class="k">class</span> <span class="nc">DirectiveProcessor</span>
    <span class="k">def</span> <span class="nf">process_require_jam_directive</span>
      <span class="c1"># read jam/require.config.js</span>
      <span class="n">config</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/jam/require.config.js"</span>
      <span class="n">jam</span> <span class="o">=</span> <span class="no">ExecJS</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">"jam"</span><span class="p">)</span>

      <span class="n">packages</span> <span class="o">=</span> <span class="n">jam</span><span class="o">[</span><span class="s2">"packages"</span><span class="o">]</span>
      <span class="n">shim</span> <span class="o">=</span> <span class="n">jam</span><span class="o">[</span><span class="s2">"shim"</span><span class="o">]</span>

      <span class="c1"># Resolving dependencies</span>
      <span class="n">resolved</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">unresolved</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">dup</span>

      <span class="k">until</span> <span class="n">unresolved</span><span class="o">.</span><span class="n">empty?</span>
        <span class="n">resolved_names</span> <span class="o">=</span> <span class="n">resolved</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">package</span><span class="o">|</span> <span class="n">package</span><span class="o">[</span><span class="s2">"name"</span><span class="o">]</span><span class="p">}</span>

        <span class="n">just_resolved</span> <span class="o">=</span> <span class="n">unresolved</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">package</span><span class="o">|</span>
          <span class="n">deps</span> <span class="o">=</span> <span class="p">(</span><span class="n">shim</span><span class="o">[</span><span class="n">package</span><span class="o">[</span><span class="s2">"name"</span><span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="n">shim</span><span class="o">[</span><span class="n">package</span><span class="o">[</span><span class="s2">"name"</span><span class="o">]][</span><span class="s2">"deps"</span><span class="o">]</span><span class="p">)</span> <span class="o">||</span> <span class="o">[]</span>
          <span class="p">(</span><span class="n">deps</span> <span class="o">-</span> <span class="n">resolved_names</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
        <span class="p">}</span>

        <span class="n">resolved</span> <span class="o">+=</span> <span class="n">just_resolved</span>
        <span class="n">unresolved</span> <span class="o">-=</span> <span class="n">just_resolved</span>
        <span class="k">if</span> <span class="n">just_resolved</span><span class="o">.</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unresolved</span><span class="o">.</span><span class="n">empty?</span>
          <span class="k">raise</span> <span class="s2">"Cannot resolve </span><span class="si">#{</span><span class="n">unresolved</span><span class="o">.</span><span class="n">map</span><span class="si">{</span><span class="o">|</span><span class="n">package</span><span class="o">|</span> <span class="n">package</span><span class="o">[</span><span class="s2">"name"</span><span class="o">]</span><span class="si">}}</span><span class="s2">"</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># Load libraries</span>
      <span class="n">resolved</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">package</span><span class="o">|</span>
        <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package</span><span class="o">[</span><span class="s2">"location"</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="sr">%r{^jam/}</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span> <span class="n">package</span><span class="o">[</span><span class="s2">"main"</span><span class="o">]</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">require_asset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>asset path を追加して...</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">paths</span> <span class="o">&lt;&lt;</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"jam"</span><span class="p">)</span>
</pre></div></div>

<p>application.js に <code>require_jam</code> と書く。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// app/assets/javascripts/appplication.js</span>
<span class="c1">//= require_jam</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require_tree .</span>
</pre></div></div>

<p>これで、依存関係を気にせず、jam install でインストールしたライブラリをすべてロードできる。</p>

<p>なお、この方法では、新たに <code>jam install</code> しても application.js 自体に変化がないので、cache が効いてしまう模様。<code>rm -rf tmp/cache/assets</code> か <code>rake tmp:cache:clear</code> でとりあえず cache 削除できる。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />32位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/ef796401c8e2d06529df">Chrome でブラウザバック時に異なる Content-Type のキャッシュが表示される</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-07 13:56:57</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Chrome]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Chrome 21 は (おそらく) キャッシュを URL 単位で行っており、Content-Type を考慮していない。これが原因で、意図しないキャッシュが使用されることがある。</p>

<p>下記がテスト用の Sinatra アプリケーション。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env ruby</span>

<span class="c1"># # Gemfile</span>
<span class="c1"># source :rubygems</span>
<span class="c1"># gem "sinatra"</span>
<span class="c1"># gem "rack-conneg"</span>

<span class="nb">require</span> <span class="s2">"sinatra"</span>
<span class="nb">require</span> <span class="s2">"rack/conneg"</span>

<span class="n">use</span><span class="p">(</span><span class="no">Rack</span><span class="o">::</span><span class="no">Conneg</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">conneg</span><span class="o">|</span> <span class="n">conneg</span><span class="o">.</span><span class="n">provide</span><span class="p">(</span><span class="o">[</span><span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span><span class="o">]</span><span class="p">)</span> <span class="p">}</span>

<span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="n">content_type</span> <span class="n">negotiated_type</span>
    <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span>
      <span class="o">&lt;&lt;-</span><span class="dl">HTML</span>
<span class="sh">        &lt;!DOCTYPE html&gt;</span>
<span class="sh">        &lt;script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"&gt;&lt;/script&gt;</span>
<span class="sh">        &lt;script&gt;</span>
<span class="sh">          $.getJSON("/"); // 同じ URL を JSON で取得</span>
<span class="sh">        &lt;/script&gt;</span>
<span class="sh">        &lt;a href="/foo"&gt;Click me&lt;/a&gt;</span>
<span class="dl">      HTML</span>
    <span class="p">}</span>
    <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="sx">%("JSON response")</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/foo"</span> <span class="k">do</span>
  <span class="s2">"Please back"</span>
<span class="k">end</span>
</pre></div></div>

<p>これを起動して localhost:4567 へアクセスし、リンクをクリック -&gt; ブラウザバックすると、最初に表示された HTML ではなく JSON が表示されてしまう。</p>

<p>流れはこうなっている。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># 1. 最初のアクセス
GET / HTTP/1.1
Accept: text/html

# 1 のレスポンス
# これを / のコンテンツとしてキャッシュ
200 OK
Content-Type: text/html;charset=utf8

&lt;!DOCTYPE html&gt;
...

# 2. 非同期通信
GET / HTTP/1.1
Accept: application/json

# 2 のレスポンス
# これを / のコンテンツとしてキャッシュを上書き!
200 OK
Content-Type: application/json;charset=utf8

"JSON Response"

# この後、リンクをクリックしてページ遷移後、ブラウザバックすると、
# 2 のレスポンスをキャッシュとして表示してしまう。
</pre></div></div>

<p>同様に下記の問題も起こる。</p>

<ol>
<li>非同期通信で JSON を取得</li>
<li>1 と同じ URL へページ遷移 (HTML レスポンスを取得)</li>
<li>ブラウザバック</li>
<li>1 と同様に JSON を取得しようとしても 2 のキャッシュ (HTML) を取得してしまう</li>
</ol>

<p>なお、Safari 6, Firefox 15 では問題は発生しなかった。<br>
HTTP の仕様がどうなっているかは未確認。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />33位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/4dbd7afb039d8f682777">Sublime Text 2 で ` を &apos; などと同様に扱う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-08-29 16:21:54</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[SublimeText2]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ST2 では <code>'</code> や <code>(</code> などを入力すると、対応する記号を自動で補完したり、選択文字列を囲んだりするが、<code>`</code> (バッククォート) ではそのような動作はしない。</p>

<p>下記の記述を keymap に追加すれば、<code>`</code> でも同様の動作をする。</p>

<p>なお、これは Packages/Default/Default (OSX).sublime-keymap で定義されている、<code>'</code> のための記述 (Auto-pair single quotes) をコピーして、<code>'</code> を <code>`</code> に置き換えただけである。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span>  <span class="c1">// Auto-pair back quotes</span>
  <span class="p">{</span> <span class="s2">"keys"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"`"</span><span class="p">],</span> <span class="s2">"command"</span><span class="o">:</span> <span class="s2">"insert_snippet"</span><span class="p">,</span> <span class="s2">"args"</span><span class="o">:</span> <span class="p">{</span><span class="s2">"contents"</span><span class="o">:</span> <span class="s2">"`$0`"</span><span class="p">},</span> <span class="s2">"context"</span><span class="o">:</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"setting.auto_match_enabled"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"selection_empty"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"following_text"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"regex_contains"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="s2">"^(?:\t| |\\)|]|\\}|&gt;|$)"</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"preceding_text"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"not_regex_contains"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="s2">"[`a-zA-Z0-9_]$"</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"eol_selector"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"not_equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="s2">"string.quoted.single"</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="s2">"keys"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"`"</span><span class="p">],</span> <span class="s2">"command"</span><span class="o">:</span> <span class="s2">"insert_snippet"</span><span class="p">,</span> <span class="s2">"args"</span><span class="o">:</span> <span class="p">{</span><span class="s2">"contents"</span><span class="o">:</span> <span class="s2">"`${0:$SELECTION}`"</span><span class="p">},</span> <span class="s2">"context"</span><span class="o">:</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"setting.auto_match_enabled"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"selection_empty"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="s2">"keys"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"`"</span><span class="p">],</span> <span class="s2">"command"</span><span class="o">:</span> <span class="s2">"move"</span><span class="p">,</span> <span class="s2">"args"</span><span class="o">:</span> <span class="p">{</span><span class="s2">"by"</span><span class="o">:</span> <span class="s2">"characters"</span><span class="p">,</span> <span class="s2">"forward"</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="s2">"context"</span><span class="o">:</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"setting.auto_match_enabled"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"selection_empty"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"following_text"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"regex_contains"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="s2">"^`"</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="s2">"keys"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"backspace"</span><span class="p">],</span> <span class="s2">"command"</span><span class="o">:</span> <span class="s2">"run_macro_file"</span><span class="p">,</span> <span class="s2">"args"</span><span class="o">:</span> <span class="p">{</span><span class="s2">"file"</span><span class="o">:</span> <span class="s2">"Packages/Default/Delete Left Right.sublime-macro"</span><span class="p">},</span> <span class="s2">"context"</span><span class="o">:</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"setting.auto_match_enabled"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"selection_empty"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"equal"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"preceding_text"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"regex_contains"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="s2">"`$"</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">"key"</span><span class="o">:</span> <span class="s2">"following_text"</span><span class="p">,</span> <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"regex_contains"</span><span class="p">,</span> <span class="s2">"operand"</span><span class="o">:</span> <span class="s2">"^`"</span><span class="p">,</span> <span class="s2">"match_all"</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />34位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/0f766874f907e5a67aaf">String.prototype.match の返り値が IE8 だけ異なる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-11-29 15:57:40</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[IE]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>JavaScript の String.prototype.match で、マッチしなかった <code>()</code> の値が IE だけ異なる。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="c1">// foo または数字にマッチし、数字だったら後方参照したい</span>
<span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/foo|(\d+)/</span><span class="p">;</span>

<span class="c1">// () にマッチする場合は期待通り</span>
<span class="nx">number</span> <span class="o">=</span> <span class="s2">"123"</span><span class="p">;</span>
<span class="nx">number</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span> <span class="c1">// ["123", "123"]</span>

<span class="c1">// () にマッチしない場合は IE だけ異なる</span>
<span class="nx">text</span> <span class="o">=</span> <span class="s2">"foo"</span><span class="p">;</span>
<span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span>
<span class="c1">// ["foo", undefined] (Chrome 23, Safari 6, Firefox 17, Opera 12, IE9)</span>
<span class="c1">// ["foo", ""] (IE8)</span>
</pre></div></div>

<p>IE10 は環境が手元にないので未検証。<br>
ECMAScript 3 / 5 では undefined になるのが正しい挙動 (コメント参照) で、IE8 の挙動がおかしい。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />35位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/37d187d27bf640503545">form_for のようなメソッドをつくる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-05-24 12:22:01</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ポイントは、次の 2 点。</p>

<ol>
<li>
<code>capture</code> にビルダークラスのインスタンスを渡す</li>
<li>ビルダークラスには View のインスタンス (ヘルパーメソッド内なら <code>self</code>) を渡しておく</li>
</ol>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># ビルダークラスの定義</span>
<span class="c1"># これのインスタンスがブロックの引数に渡される</span>
<span class="c1"># initialize で view を受け取っているので、</span>
<span class="c1"># ヘルパーメソッドを view 経由で呼び出せる</span>
<span class="k">class</span> <span class="nc">MyFormBuilder</span>
  <span class="kp">attr_reader</span> <span class="ss">:view</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@view</span> <span class="o">=</span> <span class="n">view</span>
  <span class="k">end</span>

  <span class="c1"># HTML 文字列を返すようにする</span>
  <span class="k">def</span> <span class="nf">text_field_with_label</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">html_safe</span>
    <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">view</span><span class="o">.</span><span class="n">label_tag</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">view</span><span class="o">.</span><span class="n">text_field_tag</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="n">buffer</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># ヘルパに form_for のようなメソッド追加</span>
<span class="c1"># ほんとは別のモジュールにわけて include したほうがいいと思う</span>
<span class="k">module</span> <span class="nn">ApplicationHelper</span>
  <span class="k">def</span> <span class="nf">my_form_for</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="c1"># self (View) を渡してビルダークラスのインスタンス作成</span>
    <span class="n">m</span> <span class="o">=</span> <span class="no">MyFormBuilder</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="c1"># ビルダークラスのインスタンスを渡して、</span>
    <span class="c1"># ブロックを評価し、結果を form で囲んで返す。</span>
    <span class="c1"># ややこしい構造の場合、capture した結果を、</span>
    <span class="c1"># partial template に渡して render するという手も。</span>
    <span class="n">form_tag</span><span class="p">(</span><span class="s2">"#"</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">capture</span> <span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>下記のように使える。</p>

<div class="code-frame" data-lang="html+erb">
<div class="code-lang"><span class="bold">html.erb</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;%=</span> <span class="n">my_form_for</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">m</span><span class="o">.</span><span class="n">text_field_with_label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="haml"><div class="highlight"><pre><span></span><span class="p">=</span> <span class="n">my_form_for</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
  <span class="p">=</span> <span class="n">m</span><span class="o">.</span><span class="n">text_field_with_label</span> <span class="ss">:name</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />36位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/fe132c58da7b11c8e555">jqGrid で動的に列幅を変更する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-19 18:54:05</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>API はなさそう。</p>

<blockquote>
<p>Below are options which can not be changed dynamically when the grid is constructed (If changed they do not have effect or will cause the grid errors). For some of these options there are methods available to change the value.<br>
* name<br>
* width<br>
* resizable<br>
* label (method avail.)</p>

<p>"wiki:colmodel_options - jqGrid Wiki"<br>
<a href="http://www.trirand.com/jqgridwiki/doku.php?id=wiki:colmodel_options" class="autolink" rel="nofollow noopener" target="_blank">http://www.trirand.com/jqgridwiki/doku.php?id=wiki:colmodel_options</a></p>

<p>Yes it is not implemented. Currently not possible.</p>

<p>"jQuery Grid Plugin – jqGridChange column width | Help | » Forum"<br>
<a href="http://www.trirand.com/blog/?page_id=393/help/change-column-width/" class="autolink" rel="nofollow noopener" target="_blank">http://www.trirand.com/blog/?page_id=393/help/change-column-width/</a></p>
</blockquote>

<p>実装を見てみるとドラッグ &amp; ドロップのイベントらしきものに直接列幅変更のロジックが書かれているので、これを呼ぶ。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s2">"#grid"</span><span class="p">).</span><span class="nx">jqGrid</span><span class="p">(</span><span class="err">…</span><span class="p">);</span>
<span class="c1">// i は 0 から始まる列の index</span>
<span class="c1">// new_width は新しい列幅 (pixel)</span>
<span class="c1">// マウスイベントを模すため clientX を持つオブジェクトを渡す</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#grid"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">grid</span><span class="p">.</span><span class="nx">dragStart</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="p">{</span><span class="nx">clientX</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#grid"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">grid</span><span class="p">.</span><span class="nx">dragMove</span><span class="p">({</span><span class="nx">clientX</span><span class="o">:</span> <span class="nx">new_width</span><span class="p">});</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#grid"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">grid</span><span class="p">.</span><span class="nx">dragEnd</span><span class="p">();</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />37位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/bb2eea9283e4b4ec8997">Nokogiri で inner_html の XHTML を生成</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-24 16:49:35</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Node 自体を XHTML にしたいときは <code>to_xhtml</code> でいいんだけど、<code>inner_xhtml</code> のようなメソッドはない。</p>

<p><code>inner_html</code> の XHTML を生成したいときは、<code>:save_with</code> オプションに <code>Nokogiri::XML::Node::SaveOptions::AS_XHTML</code> を指定すればよい。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">node</span><span class="o">.</span><span class="n">inner_html</span><span class="p">(</span><span class="ss">save_with</span><span class="p">:</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">Node</span><span class="o">::</span><span class="no">SaveOptions</span><span class="o">::</span><span class="no">AS_XHTML</span><span class="p">)</span>
</pre></div></div>

<p><code>Node#inner_html</code> の引数は最終的に <code>Node#write_to</code> の第 2 引数に渡される。<br>
<code>Node#write_to</code> のドキュメントを見ると下記のような記述がある。</p>

<blockquote>
<p>:save_with` a combination of SaveOptions constants.</p>
</blockquote>

<p>あとは <code>Node::SaveOptions</code> のドキュメントを見れば、<code>AS_XHTML</code> に関する記述が見つかる。</p>

<p>あるいは、<code>inner_html</code> の実装を参考に、<code>to_xhtml</code> を使って下記のように書いてもよい。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_xhtml</span><span class="p">)</span><span class="o">.</span><span class="n">join</span>
</pre></div></div>

<p>参考</p>

<ul>
<li><a href="http://rubydoc.info/gems/nokogiri/Nokogiri/XML/Node:inner_html" rel="nofollow noopener" target="_blank">Nokogiri::XML::Node#inner_html</a></li>
<li><a href="http://rubydoc.info/gems/nokogiri/Nokogiri/XML/Node:to_html" rel="nofollow noopener" target="_blank">Nokogiri::XML::Node#to_html</a></li>
<li><a href="http://rubydoc.info/gems/nokogiri/Nokogiri/XML/Node:write_to" rel="nofollow noopener" target="_blank">Nokogiri::XML::Node#write_to</a></li>
<li><a href="http://rubydoc.info/gems/nokogiri/Nokogiri/XML/Node/SaveOptions" rel="nofollow noopener" target="_blank">Nokogiri::XML::Node::SaveOptions</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />38位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/69443e1923da77cdb5a5">debugger (ruby-debug) から Sublime Text 2 を開く</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-11-26 17:33:51</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[SublimeText2]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>debugger / ruby-debug では、下記のコマンドで、実行中のコードをエディタで開くことができる。</p>

<ul>
<li>
<code>tmate</code> - TextMateで開く</li>
<li>
<code>edit</code> - 環境変数 <code>EDITOR</code> に設定されたエディタで開く</li>
</ul>

<p><code>tmate</code> は TextMate 専用な感じだし、<code>EDITOR</code> に <code>subl</code> を指定してもうまくいかない。</p>

<p>調べてみると、<code>edit</code> コマンドを実行したときは、下記のようにエディタが起動される。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nv">$EDITOR</span> +行番号 ファイル名
</pre></div></div>

<p>vi や emacs はこのような行番号指定に対応しているが、Sublime Text 2 の場合、下記の様に指定する必要がある。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>subl ファイル名:行番号
</pre></div></div>

<p>そこで、下記の様なスクリプトを作成し、パスの通ったところに <code>sublvi</code> という名前で保存、実行権限をつけておく。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env ruby</span>
<span class="c1"># Usage: sublvi +lineno filename</span>
<span class="nb">require</span> <span class="s2">"shellwords"</span>
<span class="n">lineno</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">=</span> <span class="no">ARGV</span>
<span class="nb">exec</span> <span class="no">Shellwords</span><span class="o">.</span><span class="n">shelljoin</span><span class="p">(</span><span class="o">[</span><span class="s2">"subl"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">lineno</span><span class="o">.</span><span class="n">to_i</span><span class="si">}</span><span class="s2">"</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>

<p>あとは <code>.zshrc</code> などに下記の記述を追加しておけば OK。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">EDITOR</span><span class="o">=</span>sublvi
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />39位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/ab664dede75ce040fa15">Rails のテスト関連タスクでスキーマをロードしないようにする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-06-26 14:59:03</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[rake]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Migration で直接 SQL 文を発行してデータベースを構築している場合、View や Trigger などが schema.rb / structure.sql にダンプされない場合がある。</p>

<p>開発・運用時は Migration を使っていれば問題ないのだが、テストに関わる rake タスクでは、自動的にスキーマをロードするため、データベース構造が意図したものにならない。</p>

<p>スキーマをロードするタスクを、何も行わないタスクに置き換えることでこれを回避する。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># lib/tasks/db.rake</span>
<span class="c1"># 単に重複してタスク定義すると、</span>
<span class="c1"># 順番に実行されるので clear で既存のタスクを削除する</span>
<span class="no">Rake</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s2">"db:test:load_schema"</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span>
<span class="no">Rake</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s2">"db:test:load_structure"</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span>
<span class="c1"># メッセージを表示するだけのタスクを定義</span>
<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:test</span> <span class="k">do</span>
    <span class="n">task</span> <span class="ss">:load_schema</span> <span class="k">do</span>
      <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">"Ignore 'db:test:load_schema'"</span>
    <span class="k">end</span>
    <span class="n">task</span> <span class="ss">:load_structure</span> <span class="k">do</span>
      <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">"Ignore 'db:test:load_structure'"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div></div>

<p>そのかわりテスト時には自分で db:migrate RAILS_ENV=test などを実行する必要がある。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />40位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/3e984f7ccc8331e3e7da">params に含まれる配列のようなハッシュを配列に</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-05-24 13:33:04</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>fields_for</code> を使うと、<code>params</code> が下記のような形になる。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="ss">tags_attributes</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"0"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"ruby"</span><span class="p">},</span>
    <span class="s2">"1"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"rails"</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p><code>accept_nested_attributes_for</code> 使うだけならいいんだけど、自前で処理する場合、配列にしたい。つまり下記のような配列が得たい。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"ruby"</span><span class="p">},</span>
  <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"rails"</span><span class="p">}</span>
<span class="o">]</span>
</pre></div></div>

<p><code>params[:tags_attributes].values</code> でもよいが、モデルのメソッドで使うなら、配列で受け取っても同じように扱えるほうが便利。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">params</span><span class="o">[</span><span class="ss">:tags_attributes</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|*</span><span class="p">,</span> <span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">}</span>
</pre></div></div>

<p>で、もとが上記のようなハッシュでも配列でも同じ形になる。<br>
これは <code>*, a = k, v</code> でも <code>*, a = v</code> でも <code>a == v</code> となることを利用している。 </p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />41位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/7e93962f28bb422bc65f">tmux で新しいウィンドウを開いてコマンド実行</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-05-14 15:05:03</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[tmux]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>screen 風に使える。要 Ruby 1.9。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env ruby</span>
<span class="nb">require</span> <span class="s2">"shellwords"</span>
<span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">first</span>
<span class="nb">exec</span> <span class="sx">%{tmux new-window}</span> <span class="k">unless</span> <span class="n">command</span>
<span class="k">raise</span> <span class="s2">"No such file or directory: </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">"</span> <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">"which </span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">shellescape</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">out</span><span class="p">:</span> <span class="s2">"/dev/null"</span><span class="p">)</span>
<span class="nb">exec</span> <span class="sx">%{tmux new-window -n </span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">shellescape</span><span class="si">}</span><span class="sx"> </span><span class="si">#{</span><span class="no">ARGV</span><span class="o">.</span><span class="n">shelljoin</span><span class="o">.</span><span class="n">shellescape</span><span class="si">}</span><span class="sx">}</span>
</pre></div></div>

<p>パスの通ったところに t という名前で保存。<code>chmod a+x</code> しておく</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>tmux
<span class="c1"># 引数がなければ新しいウインドウを開くだけ</span>
t
<span class="c1"># コマンド (+引数) を渡せば新しいウィンドウで実行</span>
<span class="c1"># ウィンドウの名称はコマンド名になる</span>
t sleep <span class="m">5</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />42位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/83e4829766aced75b5b5">TextMate で Ruby のヒアドキュメントをシンタックスハイライト</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-27 01:53:59</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Mac]</b> <b>[textmate]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>TextMate の Ruby Bundle では、ヒアドキュメントの開始・終了文字列に応じてシンタックスハイライトされる。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="dl">SQL</span>
<span class="sh">  -- ここが SQL としてシンタックスハイライトされる</span>
<span class="sh">  SELECT * FROM users;</span>
<span class="dl">SQL</span>
</pre></div></div>

<p>Ruby Bundle の言語設定 (アイコンが L のやつ) の中で下記のように設定されている。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>{   name = 'string.unquoted.embedded.js.ruby';
    contentName = 'text.js.embedded.ruby';
    comment = 'heredoc with embedded javascript and intented terminator';
    begin = '(?&gt;&lt;&lt;-("?)((?:[_\w]+_|)(?:JS|JAVASCRIPT))\b\1)';
    end = '\s*\2$';
    beginCaptures = { 0 = { name = 'punctuation.definition.string.begin.ruby'; }; };
    endCaptures = { 0 = { name = 'punctuation.definition.string.end.ruby'; }; };
    patterns = (
        {   include = '#heredoc'; },
        {   include = 'source.js'; },
        {   include = '#interpolated_ruby'; },
        {   include = '#escaped_char'; },
    );
},
</pre></div></div>

<p>begin の正規表現で言語を判別、patterns の 2 つめの include で言語を指定している。</p>

<p>include には、Bundle の言語設定の最初に現れる、scopeName の値を指定してやればいいみたい。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />43位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/88652efb4cbcf1d66830">debugger で常に autoeval を有効に</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-31 17:08:20</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"debugger"</span>
<span class="no">Debugger</span><span class="o">.</span><span class="n">settings</span><span class="o">[</span><span class="ss">:autoeval</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div></div>

<p>ってずっと書いてたんだけど、<code>~/.rdebugrc</code> つくって</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>set autoeval
</pre></div></div>

<p>と書けばよかった。ruby-debug19 でも同様。</p>

<p>参考: <a href="http://github.com/cldwalker/debugger" class="autolink" rel="nofollow noopener" target="_blank">http://github.com/cldwalker/debugger</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />44位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/849b875075d4c8c26cd8">長い String で inspect を省略</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-11 11:51:25</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>irb や rails console でちょっと大きなファイルを読んでしまったときに、inspect が延々表示されて後悔したので、長い String の場合は、最初の 1000 文字と文字数が表示されるようにした。</p>

<p><code>~/.irbrc</code> に書いておくと便利。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">String</span>
  <span class="k">def</span> <span class="nf">inspect_with_truncate</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="k">return</span> <span class="n">inspect_without_truncate</span> <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">limit</span>
    <span class="nb">self</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">].</span><span class="n">inspect</span> <span class="o">+</span> <span class="s2">"... (</span><span class="si">#{</span><span class="n">length</span><span class="si">}</span><span class="s2">chars)"</span>
  <span class="k">end</span>
  <span class="n">alias_method</span> <span class="ss">:inspect_without_truncate</span><span class="p">,</span> <span class="ss">:inspect</span>
  <span class="n">alias_method</span> <span class="ss">:inspect</span><span class="p">,</span> <span class="ss">:inspect_with_truncate</span>
<span class="k">end</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>labochoさんの<br />45位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1</kbd>
		<a target="_blank" href="https://qiita.com/labocho/items/c998791ab37e93ccb924">MacPorts から Homebrew に移行後、Ruby の Native Extension のコンパイルに失敗する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-12 18:06:52</center>
	</td>
	<td style="width:200px;">
		@labocho<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/4191/profile-images/1483500668">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ひとことで言うと、MacPorts から Homebrew へ移行したときは Ruby 再インストールしましょう、ということです。</p>

<ol>
<li>MacPorts から Homebrew に移行後、json gem をインストールしようとしたら <code>No such file or directory: /opt/local/bin/gmkdir</code> などと言われて失敗。</li>
<li>
<code>/opt/local</code> は MacPorts がいろいろインストールするとこなので、いまの環境には存在してない。なんでそんなとこ見てるの?</li>
<li>json gem の <code>json-1.7.3/ext/json/ext/parser/Makefile</code> をみると <code>MAKEDIRS = /opt/local/bin/gmkdir -p</code> と記述されてる。</li>
<li>この Makefile は同じディレクトリの extconf.rb で生成されたもの。生成には mkmf ライブラリによって追加される <code>Kernel#create_makefile</code> を使用している。</li>
<li>mkmf のソースをみてみると <code>create_makefile -&gt; configuration -&gt; config_string</code> と呼ばれ、結局 <code>RbConfig::CONFIG["MAKEDIRS"]</code> をみていることがわかる。</li>
<li>RbConfig は rbconfig ライブラリで追加される。このソースを見てみると <code>CONFIG["MAKEDIRS"] = "/opt/local/gmkdir -p"</code> とハードコードされてる!</li>
<li>これはたぶん Ruby のインストール時に環境に応じて生成するんだろうと思って Ruby 再インストール。</li>
<li>再度 rbconfig.rb 見てみると <code>CONFIG["MAKEDIRS"] = "mkdir -p"</code> になってる!</li>
<li>gem install json 再実行したら成功!</li>
</ol>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
