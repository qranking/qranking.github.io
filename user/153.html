<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (yuku_t)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (yuku_t さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>1152</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/1b8ce6bba133a7eaeb23">結局jQuery.Deferredの何が嬉しいのか分からない、という人向けの小話</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-15 11:16:55</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>結局jQuery.Deferredの何が嬉しいのか分からない、という人向けの小話<br>
一年ほど前に <a href="http://qiita.com/yuku_t/items/3d1cf51d7ae91305eaaa" id="reference-a8822254d810bc038513">JavaScript - jQuery.Deferredを使って楽しい非同期生活を送る方法 - Qiita [キータ]</a> という記事を書きました。<br>
で、一年経って、ふと、「もっと分かりやすくjQuery.Deferredの便利さを説明できるんじゃないか」と思い立ってざざざっと書いてみました。</p>

<p>小話と言うにはちょっと長いけど。</p>

<p>--</p>

<p>jQuery.Deferredを使うと嬉しいのは、jQuery.Deferredの仕様を満たす部品同士を簡単に組み合わせることが可能だからです。中には処理を書き下すことができるとかコールバックのネストを防げるのがいいとか言う人もいますが、個人的にこっちのほうがよっぽど重要だと感じます。</p>

<p>例えるならレゴブロックです。レゴブロックはあの凸と凹を持ってるブロックを自由に組み合わせて、実に様々な物を表現することができますよね。まさにあんな感じです。</p>

<p>と言ってもなかなかピンとこないと思うので、具体例を使って説明しましょう。</p>

<h1>
<span id="jquerydeferredを使わない場合" class="fragment"></span><a href="#jquerydeferred%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>jQuery.Deferredを使わない場合</h1>

<p><em>注：これから書くのはダメなJavaScriptコードなので真似しないでください。</em></p>

<p>ここに一つのリンクがあります。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"/path"</span> <span class="na">id</span><span class="o">=</span><span class="s">"link"</span><span class="p">&gt;</span>リンク<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div></div>

<p>このボタンがどれくらいクリックされているのか計測したくなりました。そこであなたはサーバにリンククリックを計測するためのAPIを作成し、こんな風にJavaScriptのコードを書きました。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'#link'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span> <span class="c1">// リンク遷移を一旦中止</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="err">…</span><span class="p">,</span>  <span class="c1">// 自前の計測APIを叩く</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// XHRが終わったら改めて遷移させる</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div></div>

<p>ある日、会社の上司に突然「Mixpanelってのが便利らしいからそっちも使ってみて」と言われました。曰く「Mixpanelと自前の両方で計測して、あとで比較したい」らしいです。</p>

<p>とりあえずこんな感じに実装しました。（ <code>$('#link')</code> とかは冗長なので省略します）</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
  <span class="err">…</span><span class="p">,</span>  <span class="c1">// 自前の計測APIを叩く</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// mixpanelにデータを送る</span>
    <span class="nx">mixpanel</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// 自前APIとmixpanelへの送信が終わったら遷移させる</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>        
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p>しばらくすると今度は「Google Analyticsも（ry」と言われました。</p>

<p>やれやれ、コードをこう修正しました。</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
  <span class="err">…</span><span class="p">,</span>  <span class="c1">// 自前の計測APIを叩く</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Mixpanelにデータを送る</span>
    <span class="nx">mixpanel</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Google Analyticsへデータを送る</span>
      <span class="nx">ga</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'event'</span><span class="p">,</span> <span class="s1">'link'</span><span class="p">,</span> <span class="s1">'click'</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">hitCallback</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="c1">// 自前APIとmixpanelとgaへの送信が終わったら遷移させる</span>
          <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p>するとユーザから「リンクをクリックしたときの反応が悪い」と苦情が出ました。それもそのはず、リンククリックしたら「自前API」→「Mixpanel」→「Google Analytics」と順番に通信を行なって、初めてリンク遷移を実行するからです。</p>

<p>次なる課題は、この3つの通信を並列実行させることですが、さてさてどうしようかなーと考えているあなたのもとに驚くべき情報がもたらされました。「特定のAdblock系プラグインを入れている環境ではmixpanelなどへの通信が行われずコールバックも実行されない」。つまり3つのうちどれかが通信に失敗しても大丈夫なようにしなければなりません。</p>

<p>うわーーーもうやってられん！！！</p>

<h1>
<span id="jquerydeferredを使う場合" class="fragment"></span><a href="#jquerydeferred%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>jQuery.Deferredを使う場合</h1>

<p>先ほどの事例をjQuery.Deferredを使うとどのようにうまい具合に実装できるか見て行きましょう。</p>

<p>最初に「レゴブロックを組み合わせるみたいに書ける」と書きました。とりあえず「jQuery.Deferredを使った自前APIにデータを送る関数」、「jQuery.Deferredを使ったMixpanelにデータを送る関数」、「jQuery.Deferredを使ったGoogle Analyticsにデータを送る関数」を用意することから始めましょう。</p>

<p>ところで、Javaとかを使っている人には馴染み深いと思いますが、このようなある振る舞いを実装しているオブジェクトを、インタフェースを備えているとか、実装していると言います。なので、以後「jQuery.Deferredを使っ」ていることを「Deferredインタフェースを備えている」と表現することにします。</p>

<h2>
<span id="復習deferredインタフェースの実装方法" class="fragment"></span><a href="#%E5%BE%A9%E7%BF%92deferred%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%81%AE%E5%AE%9F%E8%A3%85%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>復習：Deferredインタフェースの実装方法</h2>

<p>Deferredインタフェースを備えた関数を実装するのは極めて簡単です。守らなければならないのはたった1つだけ。それは <strong>jQuery.Deferred#promise を返すこと</strong> それだけです。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Deferredインタフェースを備えた最も単純な関数</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">dfdFunc</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</div>

<p><code>promise</code> は状態を持っていてこのままでは初期状態である「実行中」状態になります。普通は <code>resolve</code> か <code>reject</code> で状態を確定させます。resolveは正常に終了した状態、rejectは失敗した状態を表します。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">引数に応じて状態が変化するDeferredインタフェースを持った関数</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">dfdFunc</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cond</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
  <span class="nx">cond</span> <span class="o">?</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()</span> <span class="o">:</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</div>

<p>jQuery.Deferredというと非同期処理に使うものだという認識が一般的だと思いますが、これだって立派なDeferredインタフェースを備えた関数なのです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">dfdFunc</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Resolved!'</span><span class="p">);</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Rejected!'</span><span class="p">);</span> <span class="p">});</span>
<span class="c1">// =&gt; Resolved!</span>
</pre></div></div>

<p><code>promise#done</code> と <code>promise#fail</code> はそれぞれ <code>resolved</code> か <code>rejected</code> な <code>promise</code> に対して実行されるコールバックを設定するメソッドです。</p>

<h3>
<span id="非同期関数を含む場合" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%82%92%E5%90%AB%E3%82%80%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>非同期関数を含む場合</h3>

<p>非同期関数の場合は <code>promise</code> の状態を確定するのが非同期関数のコールバックの中になります。</p>

<p>例えばMixpanelへのデータ送信をDeferred化するとこうなります。 <code>mixpanel.track</code> の第１引数と第２引数は気にしないでください。ここで重要なのは、データを送信が完了したら第３引数の関数を実行する、ということだけです。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Deferredインタフェースを備えたmixpanel関数</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">dfdMixpanel</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
  <span class="nx">mixpanel</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</div>

<p>簡単ですね。</p>

<h2>
<span id="さきほどの事例をjquerydeferredを使って実装してみる" class="fragment"></span><a href="#%E3%81%95%E3%81%8D%E3%81%BB%E3%81%A9%E3%81%AE%E4%BA%8B%E4%BE%8B%E3%82%92jquerydeferred%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>さきほどの事例をjQuery.Deferredを使って実装してみる</h2>

<p>「jQuery.Deferredを使わない場合」で取り上げた事例をjQuery.Deferredを使うとどう解決できるか見て行きましょう。</p>

<p>まずは「自前APIだけにデータを送っている」頃のコードです。実は <code>jQuery.ajax</code> はDeferredインタフェースを備えています。なので、以下のように書けます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="err">…</span> <span class="p">})</span> <span class="c1">// 自前APIにデータを送る</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// XHRが終わったら改めて遷移させる</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
  <span class="p">});</span>
</pre></div></div>

<p>さて次にMixpanelにもデータを送ります。先ほど作った <code>dfdMixpanel</code> を使うとこのように書けますね。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="err">…</span> <span class="p">})</span> <span class="c1">// 自前APIにデータを送る</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">dfdMixpanel</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">{})</span> <span class="c1">// mixpanelにデータを送る</span>
      <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 自前APIとmixpanelへの送信が終わったら遷移させる</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
      <span class="p">});</span>
  <span class="p">});</span>
</pre></div></div>

<p>しかしこれだと結局どんどん階層が深くなっていってしまっています。このように <code>done</code> の中で <code>done</code> を実行するような場合は、代わりに <code>then</code> を使うといいでしょう。 <code>then</code> を使うと先ほどのコードは次のように書き換えられます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="err">…</span> <span class="p">})</span> <span class="c1">// 自前APIにデータを送る</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dfdMixpanel</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">{})</span> <span class="c1">// return を忘れないように</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 自前APIとmixpanelへの送信が終わったら遷移させる</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
  <span class="p">});</span>
</pre></div></div>

<p>次はGoogle Analyticsです。 <code>dfdGa</code> という関数を作ってあるとします。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="err">…</span> <span class="p">})</span>  <span class="c1">// 自前APIにデータを送る</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dfdMixpanel</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">{});</span> <span class="c1">// mixpanelにデータを送る</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dfdGa</span><span class="p">(</span><span class="s1">'link'</span><span class="p">,</span> <span class="s1">'click'</span><span class="p">);</span> <span class="c1">// Google Analyticsにデータを送る</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 自前APIとmixpanelとGoogle Analyticsへの送信が終わったら遷移させる</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
  <span class="p">});</span>
</pre></div></div>

<p>さて、ここまではjQuery.Deferredを使わない場合でもなんとか書くことができました。この時点で既に元々のコードより読みやすいという利点はあると思うのですが、Deferredの真価が発揮されるのはここからです。</p>

<h3>
<span id="並列化" class="fragment"></span><a href="#%E4%B8%A6%E5%88%97%E5%8C%96"><i class="fa fa-link"></i></a>並列化</h3>

<p>まずは自前APIとMixpanelとGoogle Analyticsへのデータ送信を並列化しましょう。</p>

<p>Deferredインタフェースを備えた関数を並列実行するのは実に簡単です。 <code>jQuery.when</code> を使うだけです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="err">…</span> <span class="p">}),</span>            <span class="c1">// 自前APIにデータを送る</span>
  <span class="nx">dfdMixpanel</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">{}),</span> <span class="c1">// mixpanelにデータを送る</span>
  <span class="nx">dfdGa</span><span class="p">(</span><span class="s1">'link'</span><span class="p">,</span> <span class="s1">'click'</span><span class="p">)</span>    <span class="c1">// Google Analyticsにデータを送る</span>
<span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 自前APIとmixpanelとGoogle Analyticsへの送信が終わったら遷移させる</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
<span class="p">});</span>
</pre></div></div>

<p>そしてよくよくみてみると <code>jQuery.when</code> の返り値に <code>done</code> を実行していますね？つまり <code>jQuery.when</code> もDeferredインタフェースを備えていることが分かります。</p>

<h3>
<span id="エラー処理" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>エラー処理</h3>

<p>続いて特定条件下でMixpanelにデータが送れない問題を解決しましょう。やるべきことはデータ送信に失敗した場合は <code>dfdMixpanel</code> や <code>dfdGa</code> が返した <code>promise</code> を <code>reject</code> する、それだけです。</p>

<p>実装方法は色々考えられると思いますが、ここでは1秒間待って、データ送信が完了しなかった場合は <code>reject</code> することにします。 <code>dfdMixpanel</code> を次のように書き換えます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">dfdMixpanel</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
  <span class="nx">mixpanel</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span> <span class="p">});</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span> <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
<span class="p">};</span>
</pre></div></div>

<p>「これだと <code>resolve</code> した後に <code>reject</code> も実行されるんじゃない？」と思った方もいると思いますが、 <code>promise</code> は一旦 <code>resolve</code> か <code>reject</code> されたらそれ以降状態が変化しなくなるので、これで問題ありません。</p>

<p>こんな感じのタイムアウト処理を自前APIとGoogle Analytics送信にも実装したら、<code>done</code> の代わりに <code>always</code> を使うようにして完了です。 <code>always</code> は resolve でも reject どちらの場合も実行される関数を登録するためのものです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span>
  <span class="nx">dfdAjax</span><span class="p">(),</span>                <span class="c1">// 自前APIにデータを送る</span>
  <span class="nx">dfdMixpanel</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">{}),</span> <span class="c1">// mixpanelにデータを送る</span>
  <span class="nx">dfdGa</span><span class="p">(</span><span class="s1">'link'</span><span class="p">,</span> <span class="s1">'click'</span><span class="p">)</span>    <span class="c1">// Google Analyticsにデータを送る</span>
<span class="p">).</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>  <span class="c1">// doneの代わりにalwaysを使う</span>
  <span class="c1">// 自前APIとmixpanelとGoogle Analyticsへの送信が終わったら遷移させる</span>
  <span class="c1">// ただし、どれか1つでも送信に失敗したら即座に遷移する</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
<span class="p">});</span>
</pre></div></div>

<h2>
<span id="jquerydeferredの便利さを言葉にする" class="fragment"></span><a href="#jquerydeferred%E3%81%AE%E4%BE%BF%E5%88%A9%E3%81%95%E3%82%92%E8%A8%80%E8%91%89%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>jQuery.Deferredの便利さを言葉にする</h2>

<p>さてjQuery.Deferredを使うと、一見複雑な処理を、簡単に書けることがなんとなく分かったと思います。この「なんとなく分かった」jQuery.Deferredの便利さを、きちんと言葉にしてみます。</p>

<h3>
<span id="処理が関数の中に隠蔽される" class="fragment"></span><a href="#%E5%87%A6%E7%90%86%E3%81%8C%E9%96%A2%E6%95%B0%E3%81%AE%E4%B8%AD%E3%81%AB%E9%9A%A0%E8%94%BD%E3%81%95%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>処理が関数の中に隠蔽される</h3>

<p>jQuery.Deferredだから、という訳ではないですが、意識しなくても関数の中に処理がひとまとめにされるので、メンテナンス性が高まると言えます。</p>

<h3>
<span id="インタフェースが統一される" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%81%8C%E7%B5%B1%E4%B8%80%E3%81%95%E3%82%8C%E3%82%8B"><i class="fa fa-link"></i></a>インタフェースが統一される</h3>

<p>ここまで読んだ人なら分かると思いますが、jQuery.Deferredは「成功」と「失敗」になりうる関数のための統一されたインタフェースを提供してくれます。もちろん非同期処理に使うのが特に便利なわけですが、非同期関数・同期関数問わず同じように扱えることが便利です。</p>

<p>また、いちいちインタフェースを考える手間が省けるので開発速度も向上します。</p>

<h3>
<span id="非同期処理のエラー処理が容易" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E5%87%A6%E7%90%86%E3%81%8C%E5%AE%B9%E6%98%93"><i class="fa fa-link"></i></a>非同期処理のエラー処理が容易</h3>

<p>JavaScriptには <code>try〜catch</code> 文がありますが、非同期処理では非常に扱いにくいです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">asyncError</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s2">"Error"</span><span class="p">;</span>
  <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="nx">asyncError</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// キャッチされない</span>
<span class="p">}</span>
<span class="c1">//=&gt; Uncount Error</span>
</pre></div></div>

<p>非同期関数の中でエラー処理をしようと思ってエラーを <code>throw</code> しても、その非同期関数を <code>try〜catch</code> してもエラーを補足できないのです。仮に正常系と異常系の2つのコールバックを受け付けるようにしたとしても、例えば <code>finally</code> のような機能をもたせるのはなかなか難しいです。</p>

<p>このような場合もDeferredインタフェースなら単に <code>reject</code> すればよく、呼び出し側で <code>finally</code> 的なことをやりたければ <code>always</code> で実現できます。</p>

<h3>
<span id="再利用性が高まる" class="fragment"></span><a href="#%E5%86%8D%E5%88%A9%E7%94%A8%E6%80%A7%E3%81%8C%E9%AB%98%E3%81%BE%E3%82%8B"><i class="fa fa-link"></i></a>再利用性が高まる</h3>

<p>「処理が関数の中に隠蔽」され、「インタフェースが統一」されると再利用性が高まります。</p>

<h2>
<span id="jquerydeferredを使わない方がいい場面" class="fragment"></span><a href="#jquerydeferred%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E6%96%B9%E3%81%8C%E3%81%84%E3%81%84%E5%A0%B4%E9%9D%A2"><i class="fa fa-link"></i></a>jQuery.Deferredを使わない方がいい場面</h2>

<p>ここまでベタ褒めしてきたjQuery.Deferredですが、なんでもかんでもDeferred化すればいいというものではないです。非同期関数はとりあえずDeferred化してしまえばいいですが、同期関数は場合によりけり。</p>

<p>じゃあどういう同期関数をDeferred化すべきかといえば、それはDeferred化された非同期関数と同じように扱いたい関数です。具体的には、キャッシュが無ければ非同期にサーバからデータを取ってきて、キャッシュがあったらそれを使う、というような場合、キャッシュからデータを取ってくる処理をDeferred化するとよいでしょう。実装については <a href="http://qiita.com/yuku_t/items/3d1cf51d7ae91305eaaa">JavaScript - jQuery.Deferredを使って楽しい非同期生活を送る方法 - Qiita [キータ]</a> にちょろっと書いてあるので、そちらを参照してください。</p>

<h1>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h1>

<p>また上司がやってきました。</p>

<p>「MixpanelとGoogle Analyticsは並列でいいが、自前APIは直列にしたい」</p>

<p>Deferred化された今、恐れることは何もありません。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">dfdAjax</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">dfdMixpanel</span><span class="p">(</span><span class="err">…</span><span class="p">),</span> <span class="nx">dfdGa</span><span class="p">(</span><span class="err">…</span><span class="p">));</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
  <span class="p">});</span>
</pre></div></div>

<p>「あー順番が逆だ、MixpanelとGoogle Analyticsが先で、自前APIが後。」</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">dfdMixpanel</span><span class="p">(</span><span class="err">…</span><span class="p">),</span> <span class="nx">dfdGa</span><span class="p">(</span><span class="err">…</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">dfdAjax</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
  <span class="p">});</span>
</pre></div></div>

<p>「ぐぬぬ…!!」</p>

<p>歯ぎしりする上司を尻目に、今日も華麗に定時退社を決めたのでした。</p>

<p>おわり</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>942</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/2f5341e4aa635800a0a1">アプリエンジニア向け：「サーバがなんか重い」時にすること</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-02-03 01:42:00</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Linux]</b> <b>[server]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>アプリケーションエンジニアの人には「なんか重い」という状況に遭遇したらインフラの人にタスクを投げる、という人もいるかも知れません。けど、その重さのどこに原因があるのか。CPUか、ネットワークか、IOかくらいの診断はできた方がアプリ開発においても有益です。</p>

<p>「せっかくつくったシステムがなんか重い」</p>

<p>そんな時にアプリケーションエンジニアとしてできることを書きます。</p>

<p>本職のインフラの人にはぬるい内容だと思います。何を隠そう僕自身がアプリ寄りの人間なので、突っ込んだ話はできないのです。あしからずご了承ください。</p>

<h1>
<span id="なんかサーバが重いなー" class="fragment"></span><a href="#%E3%81%AA%E3%82%93%E3%81%8B%E3%82%B5%E3%83%BC%E3%83%90%E3%81%8C%E9%87%8D%E3%81%84%E3%81%AA%E3%83%BC"><i class="fa fa-link"></i></a>なんかサーバが重いなー</h1>

<h2>
<span id="まずはロードアベレージを調べる" class="fragment"></span><a href="#%E3%81%BE%E3%81%9A%E3%81%AF%E3%83%AD%E3%83%BC%E3%83%89%E3%82%A2%E3%83%99%E3%83%AC%E3%83%BC%E3%82%B8%E3%82%92%E8%AA%BF%E3%81%B9%E3%82%8B"><i class="fa fa-link"></i></a>まずはロードアベレージを調べる</h2>

<p>サーバが重いと思ったら、まず真っ先にすべきことは対象ホストにSSH接続してロードアベレージを調べることでしょう。ロードアベレージとは <strong>実行されずに待たされているプロセスの数</strong> のことで、多すぎるとやばいと認識しておきましょう。ロードアベレージだけでは何が原因で重くなっているのか判断することはできないけれど、検査のとっかかりとして行います。</p>

<p>ロードアベレージがどれくらいの数値がヤバいのかは、CPUのコアの数とかに依存する（らしい）もので、一概に「Xを超えていたらまずい」と言い切ることができません。なので、日頃からロードアベレージをちょくちょく確認し「あれ、いつもよりロードアベレージ高いな」と言えるようになることが重要なのだろうと思います。</p>

<ul>
<li>使うコマンド: top、uptime</li>
</ul>

<p>topはロードアベレージの他にも今走ってるプロセスを占有してるメモリ量とかでソートしたり色々できる便利コマンドです。uptimeはほぼロードアベレージだけを表示してくれるコマンドです。</p>

<p>topの方やれることが多いので普段はこちらを使えばいいですが、本当に切迫しているサーバ上だと、topの実行すらままならないという状況もあり得るので、uptimeの存在も頭の片隅においておくべきでしょう。</p>

<p>top使うと右上にload averageに続いて小数が3つ表示されます。これがロードアベレージで、左から過去１分５分１５分の間の数値を表しています。強いていうなら <strong>1分と5分のやつだけ高かったら、最近始めたプロセスが原因だと推測できる</strong> というくらい。</p>

<h3>
<span id="ロードアベレージが低かった場合" class="fragment"></span><a href="#%E3%83%AD%E3%83%BC%E3%83%89%E3%82%A2%E3%83%99%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%8C%E4%BD%8E%E3%81%8B%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>ロードアベレージが低かった場合</h3>

<p>ロードアベレージが低いのに重い、ということは原因は外部にあうことが疑われます。ネットワークの問題や、リモートホスト（例えばWebサーバとDBサーバが別ホストにあって、Webサーバのロードアベレージが低いなら、DBサーバを疑ってみるみたいな）に原因がある可能性があります。なのでサーバのネットワークIOの様子を見てみるといいでしょう。</p>

<ul>
<li>使うコマンド: dstat、netstat</li>
</ul>

<p>dstatとnetstatは両方statで終わってますが、実は他にもvmstat、iostat、ifstatなんかもあります。このdstatというのは、これら乱立したXXXstatコマンドをひとまとめにし、かつ、使いやすくしよう、という目的で作られた後発ツールです。なので、使うならdstatがいいと思います。</p>

<p>例えば <code>dstat --tcp</code> とやるとTCPコネクションの様子を見たり <code>dstat --net</code> とやるとネットワークの様子を見ることができますが、、、はっきり言ってアプリの人間には意味不明だと思いますので、調べても分からない場合は素直にインフラに強い人に尋ねましょう。</p>

<h3>
<span id="ロードアベレージが高かった場合" class="fragment"></span><a href="#%E3%83%AD%E3%83%BC%E3%83%89%E3%82%A2%E3%83%99%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%8C%E9%AB%98%E3%81%8B%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>ロードアベレージが高かった場合</h3>

<p>この場合はホストの中に問題があると想像できます。続いてCPUとIOのどちらに原因があるか探ります。</p>

<h2>
<span id="cpu使用率とio待ち状態を調べる" class="fragment"></span><a href="#cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%A8io%E5%BE%85%E3%81%A1%E7%8A%B6%E6%85%8B%E3%82%92%E8%AA%BF%E3%81%B9%E3%82%8B"><i class="fa fa-link"></i></a>CPU使用率とIO待ち状態を調べる</h2>

<ul>
<li>使うコマンド: sar、dstat、vmstat</li>
</ul>

<p><code>sar -u</code> や <code>dstat -a</code> などを実行します。sarの場合で話をすると、見るべきは <code>%user</code> <code>%system</code> <code>%iowait</code> の項目です。</p>

<h3>
<span id="userが高い場合" class="fragment"></span><a href="#user%E3%81%8C%E9%AB%98%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>%userが高い場合</h3>

<p>ユーザプログラムがボトルネックになっていると考えられます。どのプログラムに原因があるか調べましょう。</p>

<ul>
<li>使うコマンド: top、dstat、pidstat</li>
</ul>

<p><code>top</code> はプロセスの一覧をCPU使用率やメモリ占有率などでソートする機能があります。例えば<code>top</code>を実行してからおもむろに <code>m</code> と打つとメモリ順でソートしてくれます。<code>dstat --top-cpu</code> とすることで最もCPUを使っているプロセスを表示することもできます。</p>

<p><code>pidstat</code> は特定のプロセスの統計情報を調べるのに使います。問題のプロセスがある程度しぼれたら <code>pidstat -u -p PID,PID,PID</code> をします。PIDには怪しいプロセスのPIDを入れます。-u はCPU使用率を表示するオプションです。</p>

<p>ここで、CPUに負荷がかかっているのは、ディスクI/Oやメモリなどが適切に働いているか、プログラムが暴走しているかのどちらかです。後者の場合は完全にアプリケーションエンジニアのデバッグの仕事です。前者かつスループットが上がらない、という場合は、アプリケーションエンジニアとしてはアルゴリズムの改善などで対処できますが、インフラの人とサーバの増設などを検討することも必要かも知れません。前者でかつスループットが高い状態というのは、リソースを余すことなく使えているということなので、むしろ理想的な状態であるといえますが、将来的にリソースが足りなくなる可能性が高いので、早めにリソース増強の算段を建てたほうがいいかも知れません。</p>

<h3>
<span id="systemが高い場合" class="fragment"></span><a href="#system%E3%81%8C%E9%AB%98%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>%systemが高い場合</h3>

<p>これはカーネル空間の処理に時間を取られていることを意味します。この場合に考えられるのは、I/O待ちでCPU時間を消費しているか、大きいプロセスをforkしまくっている等（らしい）です。なので %system が高い場合 %iowait が高い場合も多いようです。</p>

<p>この場合はI/O待ち状態のプロセスを探します</p>

<ul>
<li>使うコマンド: top、dstat</li>
</ul>

<p><code>dstat --top-bio</code> で最もブロックI/Oをしているプロセスが、<code>dstat --top-io</code>で最もI/Oをしているプロセスが表示されます。</p>

<h3>
<span id="user-も-system-も低いのに-iowait-が高い場合" class="fragment"></span><a href="#user-%E3%82%82-system-%E3%82%82%E4%BD%8E%E3%81%84%E3%81%AE%E3%81%AB-iowait-%E3%81%8C%E9%AB%98%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>%user も %system も低いのに %iowait が高い場合</h3>

<p>何かのプロセスでスワップが発生している可能性があります。</p>

<ul>
<li>使うコマンド: top、free、sar、dstat、vmstat</li>
</ul>

<p><code>sar -W</code> や <code>dstat --swap</code> はスワップインとスワップアウトの状況、<code>free</code> はシステム全体のメモリ使用状況が調べらることができます。<code>top</code> でメモリ使用量でソートすればメモリを沢山使っているプロセスを発見することができます。</p>

<p>スワップが確認された場合、アプリケーションエンジニアとしてはメモリリークがないか調べ、問題箇所を修正することで対処できます。そうでない場合は、純粋に搭載メモリが足りていないのでメモリの増設などを検討しましょう。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<ul>
<li>問題があったらまずはロードアベレージを調べましょう</li>
<li>ロードアベレージが低い場合は、外部に問題がある可能性があります。</li>
<li>ロードアベレージが高い場合は、内部に問題がある可能性があります。CPU、IOのどこに問題があるのか調べましょう。</li>
<li>
<code>dstat</code> 便利です</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>930</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/0c1aff03949cb1b8fe6b">vimgrepとQuickfix知らないVimmerはちょっとこっち来い</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-11 10:52:41</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>「vim入門」系記事で解説されないためか、意外と使い方が知られていないvimgrep。</p>

<ul>
<li>ファイルを開いては検索、開いては検索ってしてる？</li>
<li>grepするためにvimから出てる？</li>
<li>grep結果を見て改めてvimで開き直してる？</li>
</ul>

<p>それ、vimgrep使えば256倍早くなる（かも）よ。</p>

<h1>
<span id="簡単なまとめ" class="fragment"></span><a href="#%E7%B0%A1%E5%8D%98%E3%81%AA%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>簡単なまとめ</h1>

<p>vimgrepは…</p>

<ul>
<li>ファイルをまたいで検索できる</li>
<li>grepやgit-grepよりは遅いので巨大プロジェクトでは検索対象を絞ったほうがいい

<ul>
<li>ワイルドカード使うと簡単に絞り込める</li>
<li>繰り返し同じ対象から検索する場合はargument listを使うと捗る</li>
<li>gitリポジトリではgit-ls-filesと組み合わせる</li>
</ul>
</li>
<li>該当箇所に素早く移動＆編集できる

<ul>
<li>quickfix-windowと組み合わせると更に捗る</li>
</ul>
</li>
</ul>

<h2>
<span id="この記事読むと分かること" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E8%AA%AD%E3%82%80%E3%81%A8%E5%88%86%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事読むと分かること</h2>

<ul>
<li>
<code>:vimgrep</code>コマンドの使い方</li>
<li>
<code>:cwindow</code>コマンドの使い方</li>
<li>
<code>:args</code>コマンドの使い方</li>
<li>gitリポジトリで便利に使う方法</li>
</ul>

<h2>
<span id="この記事読んでも分からないこと" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E8%AA%AD%E3%82%93%E3%81%A7%E3%82%82%E5%88%86%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事読んでも分からないこと</h2>

<ul>
<li>vimの正規表現</li>
<li>Quickfixの詳細</li>
<li>
<code>:grep</code>コマンドの使い方</li>
</ul>

<h2>
<span id="関連するvim-help" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3%E3%81%99%E3%82%8Bvim-help"><i class="fa fa-link"></i></a>関連するvim-help</h2>

<p>より詳しいことは以下のヘルプを読むこと。</p>

<ul>
<li>quickfix.txt

<ul>
<li>:vimgrep</li>
<li>:cwindow</li>
</ul>
</li>
<li>:args</li>
<li>cmdline-special</li>
<li>pattern-overview</li>
<li>wildcards</li>
</ul>

<h1>
<span id="vimgrepの使い方" class="fragment"></span><a href="#vimgrep%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>vimgrepの使い方</h1>

<p>vimgrepは名前に <em>grep</em> が含まれていることからも分かるように、パターンに一致する箇所をファイルから検索するためのコマンドだ。書式は以下のとおり。（蛇足だと思うが<code>:vim[grep]</code>は<code>[grep]</code>が省略可能である、つまり<code>:vim</code>でもよいという意味。）</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="p">:</span><span class="k">vim</span>[<span class="k">grep</span>] {pattern} {<span class="k">file</span>} ...
</pre></div></div>

<p>要するに<code>{file} ...</code>で指定したファイルの中から<code>{pattern}</code>で一致する箇所を検索する 。</p>

<p><code>{pattern}</code>には正規表現も使える。vimの正規表現については<code>:help pattern-overview</code>参照。</p>

<p><code>{file}</code>にはいくつかの特殊文字があり、ひとつひとつ指定しなくてもワイルドカードで特定のディレクトリ以下のファイル全て、のように指定することなどもできる。いくつか後述するが、より詳しくは<code>:help cmdline-special</code>参照。</p>

<p>このとき検索にヒットした箇所をQuickfixのerror listという形式で管理する。これがどういう風に使えるかは後述する「Quickfixと組み合わせる」を参照。</p>

<p>ちなみにvimには<code>:grep</code>もある。こちらはシステムのgrepコマンドをvimから呼び出すためのもの。詳細は<code>:help :grep</code>を参照。</p>

<h2>
<span id="vimgrepとの違い" class="fragment"></span><a href="#vimgrep%E3%81%A8%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>vimgrepと/の違い</h2>

<p>ところでvimで検索と言えば<code>/</code>（スラッシュ）もあるが一体何が違うのか。</p>

<table>
<thead>
<tr>
<th>　</th>
<th>/</th>
<th>vimgrep</th>
</tr>
</thead>
<tbody>
<tr>
<td>正規表現使える</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>検索対象</td>
<td>カレントバッファ</td>
<td>引数で指定する</td>
</tr>
<tr>
<td>ヒット件数</td>
<td>分からない</td>
<td>分かる</td>
</tr>
<tr>
<td>次の検索結果へ移動する</td>
<td><code>n</code></td>
<td><code>:cn[ext]</code></td>
</tr>
<tr>
<td>前の検索結果へ移動する</td>
<td><code>N</code></td>
<td>
<code>:cN[ext]</code> <code>:cp[revious]</code>
</td>
</tr>
<tr>
<td>Quickfix使える</td>
<td>no</td>
<td>yes</td>
</tr>
</tbody>
</table>

<p><code>/</code>（スラッシュ）を使うと現在開いているファイルの中で検索できることは、vimmerなら当然知っているだろう。この現在開いているファイルをvimではカレントバッファ（current buffer）と呼ぶ。</p>

<p><code>/</code>ではヒット件数は分からないが、vimgrepを使うと<code>(1 of 5)</code>のように表示されるので何件ヒットしたのかが一目で分かる。この場合は5ヶ所ヒットした内で1つ目の結果を表示していることを意味する。<br>
<code>:cnext</code>を実行すればカーソルが次の位置に移動し<code>(2 of 5)</code>と表示される。</p>

<p>私はいちいち<code>:cnext</code>とか打つのがだるいので次のように設定している。qはQuickfixのqのつもり。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vimrc</span></div>
<div class="highlight"><pre><span></span><span class="nb">nnoremap</span> [<span class="k">q</span> :cprevious<span class="p">&lt;</span>CR<span class="p">&gt;</span>   <span class="c">" 前へ</span>
<span class="nb">nnoremap</span> ]<span class="k">q</span> :cnext<span class="p">&lt;</span>CR<span class="p">&gt;</span>       <span class="c">" 次へ</span>
<span class="nb">nnoremap</span> [Q :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span><span class="k">cfirst</span><span class="p">&lt;</span>CR<span class="p">&gt;</span> <span class="c">" 最初へ</span>
<span class="nb">nnoremap</span> ]Q :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span><span class="k">clast</span><span class="p">&lt;</span>CR<span class="p">&gt;</span>  <span class="c">" 最後へ</span>
</pre></div>
</div>

<h2>
<span id="カレントバッファに対してvimgrepする" class="fragment"></span><a href="#%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%88%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6vimgrep%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>カレントバッファに対してvimgrepする</h2>

<p>vimgrepはファイルを横断して検索できるのが便利だが、カレントバッファを検索するために<code>/</code>の代わりに使うのも有りだ。カレントバッファを対象にするには<code>{file}</code>に<code>%</code>と指定する。<br>
つまり<code>/hoge</code>の代わりに<code>:vim hoge %</code>を実行すれば、現在開いているファイルを対象にしたvimgrepになる。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" カレントバッファを対象にする</span>
<span class="p">:</span><span class="k">vim</span> {pattern} %
</pre></div></div>

<h2>
<span id="ワイルドカードで複数指定する" class="fragment"></span><a href="#%E3%83%AF%E3%82%A4%E3%83%AB%E3%83%89%E3%82%AB%E3%83%BC%E3%83%89%E3%81%A7%E8%A4%87%E6%95%B0%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ワイルドカードで複数指定する</h2>

<p><code>{file} ...</code>で複数のファイルを指定できるとは言っても、一つ一つ列挙するなんてやっていられないだろう。それに特定のディレクトリ以下のファイルを対象に検索したい、ということが大半だ。</p>

<p>こういうときはワイルドカードを使う。以下の例を見ればだいたい雰囲気はつかめるだろう。より詳しくは<code>:help wildcards</code>参照。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" カレントディレクトリ以下のあらゆるファイルを対象にする</span>
<span class="p">:</span><span class="k">vim</span> {pattern} **
<span class="c">" app/views以下のあらゆるファイルを対象にする（ディレクトリを再帰的に検索）</span>
<span class="p">:</span><span class="k">vim</span> {pattern} app<span class="sr">/views/</span>**
<span class="c">" app/views/users内のファイルを対象にする</span>
<span class="p">:</span><span class="k">vim</span> {pattern} app<span class="sr">/views/</span>users/*
<span class="c">" app/views以下のerbファイルを対象にする</span>
<span class="p">:</span><span class="k">vim</span> {pattern} app<span class="sr">/views/</span>**/*.erb
<span class="c">" app/views以下で_で始まるerbファイルを対象にする</span>
<span class="p">:</span><span class="k">vim</span> {pattern} app<span class="sr">/views/</span>**/_*.erb
</pre></div></div>

<p>また<code>{file}</code>はカレントディレクトリからの相対パスで指定する。カレントディレクトリは<code>:pwd</code>で確認可能。また<code>:cd</code>でvim起動後に変更することも可能。</p>

<p>ワイルドカードで出来る限り絞り込むのはパフォーマンス的に重要だ。vimgrepで対象となったファイルは全て一旦vimによってメモリに載せられたのちに検索が実行される。不要なファイルを外しておくことでメモリ消費を抑えることができる。またvimgrepは通常のgrepコマンドやgit-grepよりは遅い。</p>

<h2>
<span id="何度も同じ検索対象を使う場合" class="fragment"></span><a href="#%E4%BD%95%E5%BA%A6%E3%82%82%E5%90%8C%E3%81%98%E6%A4%9C%E7%B4%A2%E5%AF%BE%E8%B1%A1%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>何度も同じ検索対象を使う場合</h2>

<p>同じ<code>{file}</code>に対して<code>{pattern}</code>を変えながら何度も検索する、という場合を考えてみる。例えば特定のディレクトリ内にアプリケーションコードが格納されており、その中のファイルだけを対象に検索したい、というような感じだ。愚直にやるなら次のような感じでコマンドを実行することになる。vimが多少は補完してくれるとは言っても、何度も何度もpath/to/search/dir/**と入力するのはつらすぎる。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="p">:</span><span class="k">vim</span> foo <span class="nb">path</span><span class="sr">/to/</span>search<span class="sr">/dir/</span>**
<span class="p">:</span><span class="k">vim</span> bar <span class="nb">path</span><span class="sr">/to/</span>search<span class="sr">/dir/</span>**
<span class="p">:</span><span class="k">vim</span> baz <span class="nb">path</span><span class="sr">/to/</span>search<span class="sr">/dir/</span>**
<span class="p">:</span><span class="k">vim</span> hoge <span class="nb">path</span><span class="sr">/to/</span>search<span class="sr">/dir/</span>**
<span class="p">:</span><span class="k">vim</span> piyo <span class="nb">path</span><span class="sr">/to/</span>search<span class="sr">/dir/</span>**
</pre></div></div>

<p>こういう場合は<code>:ar[gs]</code>コマンドを使う。さきほどの例は次のように置き換えられる。つまるところ<code>:args</code>で入力された値を<code>##</code>で指定できるわけだ。ちなみに<code>:args</code>はvimが内部で管理しているargument listを置き換えるためのコマンドで、argument listは最初vim起動時に<code>vim</code>コマンドに引数で渡されたファイルが入っている。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="p">:</span><span class="k">ar</span> <span class="nb">path</span><span class="sr">/to/</span>search<span class="sr">/dir/</span>**
<span class="p">:</span><span class="k">vim</span> foo ##
<span class="p">:</span><span class="k">vim</span> bar ##
<span class="p">:</span><span class="k">vim</span> baz ##
<span class="p">:</span><span class="k">vim</span> hoge ##
<span class="p">:</span><span class="k">vim</span> piyo ##
</pre></div></div>

<p>この例を見れば分かるように<code>:args</code>にはワイルドカードを指定できる。これはこれで極めて便利だが、シェルコマンドを指定してその標準出力を受け取ることも可能だ。これを利用するには`を使う。これは工夫次第で更に便利になる。後述する「Gitリポジトリで使う場合」などはその典型だ。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="p">:</span><span class="k">ar</span> `find . <span class="p">-</span>name \\*.rb`
</pre></div></div>

<h2>
<span id="gitリポジトリで使う場合" class="fragment"></span><a href="#git%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%A7%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Gitリポジトリで使う場合</h2>

<p>Gitプロジェクトで下記を実行するとインデックスされていないファイルも含めて全て検索される。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" gitリポジトリのルートでこれを実行してはいけない</span>
<span class="p">:</span><span class="k">vim</span> {pattern} **
</pre></div></div>

<p>Gitで管理しているプロジェクトではインデックスされているファイルだけを対象にしたいことが大半だ。<br>
そういうときはgit-ls-filesと<code>:args</code>を組み合わせる。git-ls-filesについて詳しくは<code>man git-ls-files</code>を参照してほしいが、簡単な話がGitでインデックスされているファイルの一覧を標準出力する。パスを指定することで絞り込むこともできることも合わせて言っておく。こうすれば以後そのvimプロセス内では <code>##</code> で必要なファイルに対して検索ができる。</p>

<p>標準出力を使ったファイルの指定は <code>:vimgrep</code>の<code>{file}</code>にも指定できるので、一回だけならわざわざ<code>:args</code>を使う必要はない。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" インデックスされている全てのファイルを対象にする</span>
<span class="p">:</span><span class="k">vim</span> {pattern} `git <span class="k">ls</span><span class="p">-</span><span class="k">files</span>`

<span class="c">" appディレクトリ内でインデックスされているファイルを対象にする</span>
<span class="p">:</span><span class="k">vim</span> {pattern} `git <span class="k">ls</span><span class="p">-</span><span class="k">files</span> app`

<span class="c">" appディレクトリ内でインデックスされている.htmlファイルを対象にする</span>
<span class="p">:</span><span class="k">vim</span> {pattern} `git <span class="k">ls</span><span class="p">-</span><span class="k">files</span> app<span class="sr">/**/</span>*.html`
</pre></div></div>

<p>こうすればgit-grepするためにいちいちvimから出て行く必要はなくなる。</p>

<h2>
<span id="バッファされている全てのファイルに対して検索する" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E5%85%A8%E3%81%A6%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E6%A4%9C%E7%B4%A2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>バッファされている全てのファイルに対して検索する</h2>

<p>現在バッファに乗っているファイルを対象に検索したいという場合もあるだろう。そういうときは<code>:bufdo</code>と<code>:vimgrepa[dd]</code>を組み合わせる。<code>:bufdo</code>は開いているバッファに対して後続のコマンドを実行して回るコマンド。<code>:vimgrepadd</code>は新しいQuickfixのリストを作るのでなく追加する。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="p">:</span><span class="k">bufdo</span> <span class="k">vimgrepa</span> {pattern} %
</pre></div></div>

<p>複数ウィンドウを開いていて、それらを対象にしたいなら<code>:bufdo</code>の代わりに<code>:windo</code>を使う。また<code>:vimgrepadd</code>は追加するものであることから、連続実行すると前の検索結果が残ってしまう。一旦Quickfixをリセットするには<code>:cex[pr]</code>コマンドに<code>””</code>を渡す。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="p">:</span><span class="k">cex</span> <span class="s2">""</span>
</pre></div></div>

<h1>
<span id="quickfixと組み合わせる" class="fragment"></span><a href="#quickfix%E3%81%A8%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>Quickfixと組み合わせる</h1>

<p>vimgrepの基本的な使い方は掌握されたことだろう。</p>

<p>ところでvimgrepは検索結果を一覧表示できたら嬉しいとは思わないだろうか？<code>:cnext</code>を連打して一つ一つ見て回るのは、見たいのが検索結果の一部だった場合は特に、不毛だ。</p>

<p>ここで使うのが<code>:cw[indow]</code>コマンドだ。実行すると新しいウィンドウが作られ、そこにvimgrepの検索結果の一覧が表示される。一行が一件の検索結果に対応し、それぞれファイルのパス、ヒットした箇所のそのファイル内での位置、その行全体が表示される。<br>
このウィンドウ上で特定の行へ移動しEnterを押すとその検索位置が表示されてカーソルがそこに移動する。このとき作られたウィンドウは消えずに残っているので、Ctrl-wを使って移動して改めて他の検索結果を選択することもできる。</p>

<p>vimgrepしてから<code>:cwindow</code>したのでは二回コマンドを実行しなければならず若干面倒くさい。次のように一回で書いてしまうのがよい。以下を実行するといきなり検索結果一覧のウィンドウが表示され、カーソルがそのウィンドウの最初の行に移動する。</p>

<div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="p">:</span><span class="k">vim</span> {pattern} {<span class="k">file</span>} <span class="p">|</span> <span class="k">cw</span>
</pre></div></div>

<p>ちなみにここで作られたウィンドウはvim用語ではquickfix-windowと呼ばれる。<br>
QuickfixというのはとあるCコンパイラが出力するコンパイルエラー形式のこと（らしく）、それをファイルに保存してvimから読み込んでエラー箇所を簡単に飛べると嬉しいよね、という動機で作られた機能の総称。vimgrepの検索結果は自動的にこの形式で読み込まれるため、Quickfixの結果を一覧表示するquickfix-windowで一覧表示できる、というわけだ。<br>
詳しくは<code>:help quickfix</code>を参照。あと<code>:help 30.1</code>なんかも読むとよい。</p>

<p>それとQuickfixは<code>+quickfix</code>なvimでないと使えないので注意。</p>

<h2>
<span id="自動的にquickfix-windowを開く" class="fragment"></span><a href="#%E8%87%AA%E5%8B%95%E7%9A%84%E3%81%ABquickfix-window%E3%82%92%E9%96%8B%E3%81%8F"><i class="fa fa-link"></i></a>自動的にquickfix-windowを開く</h2>

<p><code>| cw</code> を書くのが面倒くさい場合はvimがQuickfixにフックするためのイベントを用意しているので、それを使うとよい。<br>
下記設定の場合<code>:vimgrep</code>に加えて<code>:grep</code>、<code>:Ggrep</code>でも自動的にquickfix-windowを開くようになる。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vimrc</span></div>
<div class="highlight"><pre><span></span>autocmd <span class="nb">QuickFixCmdPost</span> *<span class="k">grep</span>* <span class="k">cwindow</span>
</pre></div>
</div>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>vimgrepを使えばvimから出ること無くファイルを横断して検索することができる。もうCtrl-Zで抜けてfgで戻るなどという人生の浪費をしなくてよいのだ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>866</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/6844aac6008911401b19">A/Bテストよりすごい？バンディットアルゴリズムとは一体何者か</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-24 14:55:43</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[ABtesting]</b> <b>[BanditAlgorithms]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>オバマ大統領の再選に大きく寄与したことで大きな注目を集めているA/Bテスト。A/Bテストを導入した、することを検討している、という開発現場も多いのではないだろうか。</p>

<p>そんな中、Web上で次のような議論を見つけた。</p>

<ul>
<li><a href="http://stevehanov.ca/blog/index.php?id=132" rel="nofollow noopener" target="_blank">20 lines of code that will beat A/B testing every time</a></li>
<li><a href="http://visualwebsiteoptimizer.com/split-testing-blog/multi-armed-bandit-algorithm/" rel="nofollow noopener" target="_blank">Why multi-armed bandit algorithm is not “better” than A/B testing</a></li>
</ul>

<p>一言でまとめると「A/Bテストよりバンディットアルゴリズムの方がすごいよ」「いやいやA/Bテストの方がすごいし」ということだ。</p>

<p>で、バンディットアルゴリズムとは一体何者なのか？</p>

<p>そこで<a href="http://www.amazon.co.jp/gp/product/B00AM86Y0K/ref=as_li_ss_tl?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=B00AM86Y0K&amp;linkCode=as2&amp;tag=qiita-taka84u9-22" rel="nofollow noopener" target="_blank">Bandit Algorithms for Website Optimization (O'REILLY)</a>を読んでみた。その結果分かったことを踏まえてざっくりと解説する。（O'REILLYのサイトに行けば日本語版も売っている）</p>

<p><a href="https://camo.qiitausercontent.com/b177e208db23a7287bfbb23402110ba4d25a1c8f/687474703a2f2f77732e6173736f632d616d617a6f6e2e6a702f776964676574732f713f5f656e636f64696e673d55544638264153494e3d3134343933343133333026466f726d61743d5f534c3136305f2649443d4173696e496d616765264d61726b6574506c6163653d4a50265365727669636556657273696f6e3d32303037303832322657533d31267461673d6b6d67752d3232" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b177e208db23a7287bfbb23402110ba4d25a1c8f/687474703a2f2f77732e6173736f632d616d617a6f6e2e6a702f776964676574732f713f5f656e636f64696e673d55544638264153494e3d3134343933343133333026466f726d61743d5f534c3136305f2649443d4173696e496d616765264d61726b6574506c6163653d4a50265365727669636556657273696f6e3d32303037303832322657533d31267461673d6b6d67752d3232" alt="Bandit Algorithms for Website Optimization" data-canonical-src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&amp;ASIN=1449341330&amp;Format=_SL160_&amp;ID=AsinImage&amp;MarketPlace=JP&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=kmgu-22"></a> </p>

<h1>
<span id="要約" class="fragment"></span><a href="#%E8%A6%81%E7%B4%84"><i class="fa fa-link"></i></a>要約</h1>

<p>バンディットアルゴリズムとは…</p>

<ul>
<li>実データに基いてWebサイトなどの改善を行う手法の総称</li>
<li>活用（exploit）と探索（explore）の2つから成る</li>
<li>さまざまなアルゴリズムが考案されている</li>
</ul>

<h2>
<span id="この記事を読むと分かること" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%80%E3%81%A8%E5%88%86%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事を読むと分かること</h2>

<ul>
<li>A/Bテストの概要</li>
<li>バンディットアルゴリズムの概要

<ul>
<li>Epsilon-Greedy Algorithm</li>
<li>狭義のA/BテストはEpsilon-Greedy Algorithmにおいて<code>ε = 1</code>の場合に等しい</li>
</ul>
</li>
</ul>

<h2>
<span id="この記事を読んでも分からないこと" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A7%E3%82%82%E5%88%86%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事を読んでも分からないこと</h2>

<ul>
<li>Epsilon-Greedy Algorithmより洗練された手法の詳細

<ul>
<li>Softmax Algorithm</li>
<li>UCB Algorithm</li>
</ul>
</li>
<li>バンディットアルゴリズムを実世界で利用する方法</li>
</ul>

<h1>
<span id="そもそもabテストとは何か" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82ab%E3%83%86%E3%82%B9%E3%83%88%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>そもそもA/Bテストとは何か</h1>

<p>オバマ大統領の選挙キャンペーンで用いられ、再選に大きく寄与したことで一躍有名になったA/Bテストは、これまで人間の主観に依存していた様々な事柄の改善に対する意思決定方法を置きかえる、データに基づいた工学的なアプローチだ。</p>

<p>と、説明するとなんだか仰々しい感じがするが、その中身は気が抜けるほど単純である。</p>

<p>N種類のデザインを作ってユーザをランダムに振り分け、一番良い結果を導き出した法を採用する、という手法のことだ。A/Bテストという言葉はAとBという2種類のデザインを用いたために付けられた名前だが、別にNは2である必要は無い。ここでいう良い結果、というのは例えばコンバージョン率であったり、サイト滞在時間のような数値として計測できるものを用いる。オバマ大統領の選挙戦では選挙資金の寄付額などを用いたことが知られている。</p>

<p>大事なことは人の主観ではなくデータに基いて最適なデザインを模索するという点だ。データではなく主観に頼った場合、得てして発言力のある人の意見（CEOとかプロデューサーとか）が反映されることから、このような意思決定方法をHIPPO（Highest Paid Person's Opinion - 高給取りの意見）と呼ぶ。</p>

<p>しかしながら、A/Bテストという言葉は「人の意見ではなくデータに基いて判断する方法の総称」として扱われていることも多い。特に非学術的ニュースメディアではその傾向が強いように思う。下記に挙げる記事はその一例だ。</p>

<ul>
<li><a href="http://wired.jp/2012/12/29/abtest_vol5-2/" rel="nofollow noopener" target="_blank">A/Bテストがビジネスルールを変えていく（あるいは、ぼくらの人生すらも？）&lt;&lt; WIRED.jp</a></li>
<li><a href="http://matome.naver.jp/odai/2130457591894883201" rel="nofollow noopener" target="_blank">【WEBマーケター必見】ABテスト最新事例19選 - NAVER まとめ</a></li>
</ul>

<p>どちらが正しくて、どちらが間違っている、という話はここではしない。ここで言いたいのは、「A/Bテスト」という単語を見たときそれが広義の意味で使われているのか、狭義の意味で使われているのか、読者が文脈に応じて読み分ける必要がある、ということだ。</p>

<p>本稿は狭義の意味で用いている。</p>

<h1>
<span id="バンディットアルゴリズムとは" class="fragment"></span><a href="#%E3%83%90%E3%83%B3%E3%83%87%E3%82%A3%E3%83%83%E3%83%88%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>バンディットアルゴリズムとは</h1>

<p>そんなA/Bテストと同じ文脈で語られる言葉に <strong>バンディットアルゴリズム</strong> （Bandit Algorithms）がある。これもA/Bテスト同様にデータに基づいた意思決定手法である。</p>

<p>これもA/Bテスト同様に複数のデザインを用意し、ユーザを振り分けて実際にテストして、その結果から最適なデザインを探すのだが、この個々のデザインを歴史的な経緯から <strong>腕</strong> （arm）と呼ぶ。</p>

<p>バンディットアルゴリズムは、もともとギャンブルに対する最適な戦略を考えることから始まった。</p>

<p>目の前に5つのスロットマシーンがある。それぞれのマシーンの当たる確率とその時の報酬は異なる。さて、手元に1000枚のコインがあるとき、そのコインをどのように配分すれば得られる報酬を最大化できるだろうか？</p>

<p>一般的なスロットマシーンには腕と呼ばれる棒がついており、コインを投入してその棒を引くとドラムが回転し始める。つまりここでやっていることは最も効率的な腕の引き方を考えていることと同じだ。</p>

<p>そういった訳で、バンディットアルゴリズムでは一つ一つのデザインを腕と呼ぶ。実際、Wikipediaでは <em><a href="http://en.wikipedia.org/wiki/Multi-armed_bandit" rel="nofollow noopener" target="_blank">Multi-armed bandit</a></em> という名前の項目でバンディットアルゴリズムは説明されている。</p>

<p>そして、今の喩え話をWebアプリケーション開発の文脈に置きかえると、5つのデザインと1000人のユーザがいるとき、どのようにユーザを分配すれば最も効果的かを考える、ということになる。</p>

<h2>
<span id="バンディットアルゴリズムとabテストは何が違うのか" class="fragment"></span><a href="#%E3%83%90%E3%83%B3%E3%83%87%E3%82%A3%E3%83%83%E3%83%88%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%A8ab%E3%83%86%E3%82%B9%E3%83%88%E3%81%AF%E4%BD%95%E3%81%8C%E9%81%95%E3%81%86%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>バンディットアルゴリズムとA/Bテストは何が違うのか</h2>

<p>それは既知の知識を活用するかどうかだ、と説明されることが多いようだ。</p>

<p>重要な要素として、バンディットアルゴリズムは <strong>活用</strong> （exploitation）と <strong>探求</strong> （exploration）の２つから構成される。活用は現時点で最もよいとされている腕を使うことであり、探求は候補の腕の中でどれが最も優れているかをテストすることだ。A/Bテストは全てのユーザを探求に割り振り、活用は行わない。</p>

<p>この立場からすれば「ユーザのX％でA/Bテストを実施する」というのは間違った表現だ、ということになるだろう。</p>

<h2>
<span id="何故バンディットアルゴリズムは活用を行うのか" class="fragment"></span><a href="#%E4%BD%95%E6%95%85%E3%83%90%E3%83%B3%E3%83%87%E3%82%A3%E3%83%83%E3%83%88%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%AF%E6%B4%BB%E7%94%A8%E3%82%92%E8%A1%8C%E3%81%86%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>何故バンディットアルゴリズムは"活用"を行うのか</h2>

<p>何故バンディットアルゴリズムで活用を行うのか。</p>

<p>その理由を一言で言うなら <strong>リスクマネジメントの為</strong> である。</p>

<p>バンディットアルゴリズムの目的は最良の腕を見つけることであることは間違い無いのだが、別に我々は研究目的でWebサイトを運営しているのではない。本質的には <strong>収益を最大化すること</strong> が目的なのだ。その意味でこれまでに一定の結果を残してきた腕と、どんな結果をもたらすか分からない腕を同列に扱うことは、短期的な収益減のリスクを伴う。そこで、ある程度のユーザには現時点でもっともよいと思われるものを提示し、残りのユーザに対してテストを行うのだ。</p>

<h2>
<span id="abテスト支持派の主張" class="fragment"></span><a href="#ab%E3%83%86%E3%82%B9%E3%83%88%E6%94%AF%E6%8C%81%E6%B4%BE%E3%81%AE%E4%B8%BB%E5%BC%B5"><i class="fa fa-link"></i></a>A/Bテスト支持派の主張</h2>

<p>多くの場合この"活用を行なう"という点においてバンディットアルゴリズムの方が優れていると説明されることが多いのだが、面白いことに、全く同じ理由でA/Bテストの方が優れていると主張する意見もある。つまり"活用が無い"からA/Bテストは優れている、というのだ。</p>

<p>何故A/Bテスト支持者が活用は不要だと考えるかというと、それは、スピードが損なわれるためだ。</p>

<p>ユーザを活用に回すとその分探求が遅れる。A/Bテスト支持派の意見は、多少の犠牲を払ってでも素早く最適な腕を見つけることが大切だ、というところに集約されるように思う。また、探求が早いということは直ぐに腕の良し悪しの区別がつくので、悪い腕を引き続けて損失が膨らむような愚は犯さない、ということでもある。</p>

<p>だが果たして本当にそうなのだろうか？例えば自動的に探求と活用の割合を調整するようなバンディットアルゴリズムであれば、ここでA/Bテスト支持派が行なっている指摘は意味を成さなくなるだろう。</p>

<p>バンディットアルゴリズムを評価する上でどのような評価軸があるのだろうか。</p>

<h2>
<span id="バンディットアルゴリズムを評価するための6つの指標" class="fragment"></span><a href="#%E3%83%90%E3%83%B3%E3%83%87%E3%82%A3%E3%83%83%E3%83%88%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%82%92%E8%A9%95%E4%BE%A1%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE6%E3%81%A4%E3%81%AE%E6%8C%87%E6%A8%99"><i class="fa fa-link"></i></a>バンディットアルゴリズムを評価するための6つの指標</h2>

<p><a href="http://www.amazon.co.jp/gp/product/B00AM86Y0K/ref=as_li_ss_tl?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=B00AM86Y0K&amp;linkCode=as2&amp;tag=qiita-taka84u9-22" rel="nofollow noopener" target="_blank">Bandit Algorithms for Website Optimization</a>ではバンディットアルゴリズムを評価する6つの指標として下記のものが列挙されている。</p>

<table>
<thead>
<tr>
<th>指標</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>Curiosity</td>
<td>探求から得られた知見を利用するか。一つ一つのテストは独立しているか否か。</td>
</tr>
<tr>
<td>Increased Exploitation over Time</td>
<td>自動的に探求の割合が減っていくか。</td>
</tr>
<tr>
<td>Strategic Exploration</td>
<td>何を最大化するか。利益か、得られる知見か、それともその両方か。</td>
</tr>
<tr>
<td>Number of Tunable Parameters</td>
<td>何個のパラメータを調整しなければならないか。（少ないほど良い）</td>
</tr>
<tr>
<td>Initialization Strategy</td>
<td>各腕に対する初期値の割り当て方</td>
</tr>
<tr>
<td>Context-Aware</td>
<td>ユーザと腕の相性などを考慮するか。例えば男性、女性を区別できるか、など。</td>
</tr>
</tbody>
</table>

<h2>
<span id="epsilon-greedyアルゴリズム" class="fragment"></span><a href="#epsilon-greedy%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0"><i class="fa fa-link"></i></a>Epsilon-Greedyアルゴリズム</h2>

<p>バンディットアルゴリズムは活用と探求を行う、と言われてもピンとこないかも知れない。そこで最も単純なバンディットアルゴリズムである <strong>Epsilon-Greedyアルゴリズム</strong> を紹介する。</p>

<p>Epsilon-Greedyアルゴリズムの考え方は極めてシンプルで、<code>0 ≦ ε ≦ 1</code>を満たす<code>ε</code>に対して、全てのユーザの内<code>1 - ε</code>は活用、<code>ε</code>は探求を行う。そして探求に割り当てられたユーザをテストしたい腕に改めて割り振る。この<code>ε</code>の値を調整することで、活用と探求の割合を増減させることができるわけだ。</p>

<ul>
<li>
<code>ε = 0</code>の場合探求は一切行われないのでこれはバンディットアルゴリズムを使っていないのと同じ状況だ。</li>
<li>
<code>ε</code>を少しずつ増やしていくと、次第に探求の割合が増えていく。</li>
<li>
<code>ε = 1</code>の時、活用は一切行われず全てのユーザが探求に回される。</li>
</ul>

<p>そんなEpsilon-Greedyアルゴリズムだが、先ほど紹介した6つの評価指標に照らしてみると、いくつもの欠点があることが分かる。</p>

<table>
<thead>
<tr>
<th>指標</th>
<th>Epsilon-Greedyアルゴリズムの評価</th>
</tr>
</thead>
<tbody>
<tr>
<td>Curiosity</td>
<td>常に全ての腕が選ばれる確率が等しい。</td>
</tr>
<tr>
<td>Increased Exploitation over Time</td>
<td>
<code>ε</code>の値は一定なので、探求の割合は減少しない。</td>
</tr>
<tr>
<td>Strategic Exploration</td>
<td>何を最大化するか。利益か、得られる知見か、それともその両方か。</td>
</tr>
<tr>
<td>Number of Tunable Parameters</td>
<td>調整するパラメータは<code>ε</code>の1つ</td>
</tr>
<tr>
<td>Initialization Strategy</td>
<td>全ての腕が同じ評価</td>
</tr>
<tr>
<td>Context-Aware</td>
<td>コンテキストは一切考慮しない</td>
</tr>
</tbody>
</table>

<h1>
<span id="epsilon-greedyアルゴリズムを改良する" class="fragment"></span><a href="#epsilon-greedy%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%82%92%E6%94%B9%E8%89%AF%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Epsilon-Greedyアルゴリズムを改良する</h1>

<p>Epsilon-Greedyアルゴリズムより優れたアルゴリズムは勿論存在する。<a href="http://www.amazon.co.jp/gp/product/B00AM86Y0K/ref=as_li_ss_tl?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=B00AM86Y0K&amp;linkCode=as2&amp;tag=qiita-taka84u9-22" rel="nofollow noopener" target="_blank">Bandit Algorithms for Website Optimization</a>で紹介されているのは下記のものだ。（残念ながら各アルゴリズムの詳細を説明するだけの気力がないので、詳しく知りたい人は本書を実際に読んで欲しい。）</p>

<h2>
<span id="softmaxアルゴリズム" class="fragment"></span><a href="#softmax%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0"><i class="fa fa-link"></i></a>Softmaxアルゴリズム</h2>

<p>Epsilon-Greedyアルゴリズムの大きな問題点の1つがCuriosity性が無いことだ。つまり、既にダメだと分かっている腕も等確率で選択されてしまい、損失が膨らむのだ。</p>

<p>Softmaxアルゴリズムは特にこの点においてEpsilon-Greedyアルゴリズムを改良したものになっている。探求が進む内に得られた期待値に応じて腕を重み付けし、それに基いて腕を選択する。また<code>ε</code>の値を探求が進むに連れて自動的に増加させる、より発展的なアルゴリズムも紹介されている。これによってSoftmaxアルゴリズムは放置しておくだけで勝手に一番いい腕だけを使うようになるわけだ。</p>

<h2>
<span id="ucbアルゴリズム" class="fragment"></span><a href="#ucb%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0"><i class="fa fa-link"></i></a>UCBアルゴリズム</h2>

<p>Softmaxアルゴリズムは、各腕を引くことでどれだけ報酬が得られるか、という情報は使っているが、 <strong>各腕についてどれだけ知っているか</strong> は考慮されていない。つまり、本当は悪いのに良いと勘違いされた腕は、そのうち勘違いが是正されるが、本当は良いのに悪いと勘違いされた腕は無視されるのでいつまでも勘違いされたままになる可能性があるのだ。</p>

<p>UCBアルゴリズム（Upper Confidence Bound Algorithm）は名前からも分かるように、得られた評価値の信頼性を自動的に高めようとする。つまり、あまり良くわかっていない腕は積極的に試していくのだ。そのため本の中でも、Softmaxアルゴリズムに評価実験で劣るという結果が出た。だが、重要な点としてUCBはSoftmaxアルゴリズムと違って「Initialization Strategy」が自動化されるという強みがある。</p>

<p>また「Context-Aware」性を持ったUCBとしてLinUCBとGLMUCBという2つの改良版が紹介されている。LinUCBは線形回帰、GLMUCBは一般化線形回帰を用いて腕の価値を再評価する。（これらについては本書の中でも名前が紹介されている程度なので、詳しくは引用されている論文を当たらなければならない。）</p>

<h1>
<span id="現実的にバンディットアルゴリズムは使えるのか" class="fragment"></span><a href="#%E7%8F%BE%E5%AE%9F%E7%9A%84%E3%81%AB%E3%83%90%E3%83%B3%E3%83%87%E3%82%A3%E3%83%83%E3%83%88%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%AF%E4%BD%BF%E3%81%88%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>現実的にバンディットアルゴリズムは使えるのか</h1>

<p>最後に、このような理論を考えるときに重要なことは、その理論を現実の問題に応用出来るのか、ということだ。<br>
が、この点についても7章で詳しく論じられているので詳しくはそちらを参照して欲しい。</p>

<h1>
<span id="結局バンディットアルゴリズムはabテストより優れているのか" class="fragment"></span><a href="#%E7%B5%90%E5%B1%80%E3%83%90%E3%83%B3%E3%83%87%E3%82%A3%E3%83%83%E3%83%88%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%AFab%E3%83%86%E3%82%B9%E3%83%88%E3%82%88%E3%82%8A%E5%84%AA%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>結局バンディットアルゴリズムはA/Bテストより優れているのか</h1>

<p>まず前提として、ここでいうA/Bテストとは「全てのユーザをランダムに振り分けてテストする」ものである、ということをご確認いただきたい。</p>

<p>この場合のA/Bテストは<code>ε = 1</code>なEpsilon-Greedyアルゴリズムと等しい。故に「A/Bテストとバンディットアルゴリズムを比較すること」は「ゴールデンリトリバーと犬を比較すること」のようなもので、特に意味が無い。</p>

<p>A/BテストとEpsilon-Greedyアルゴリズムの比較という意味では、一長一短な面があると言えるだろう。Epsilon-Greedyアルゴリズムは非常にナイーブな実装であり、いくつもの問題を抱えているためだ。</p>

<p>その一方でEpsilon-Greedyアルゴリズムの問題点を改善した手法がいくつも提案されている。本稿とりあげたSoftmaxアルゴリズムやUCBアルゴリズムなどがその一例だ。これらとA/Bテストを比較するなら、バンディットアルゴリズムに軍配が上がると言えるのではないだろうか。</p>

<p>だが現実問題としてどれだけ実際のシステムの改善に応用出来るか、という話になると、実装コストなどさまざまな点も考慮しなければならなくなり、それらを勘案すると一概に「A/Bテストよりバンディットアルゴリズムの方が優れている」と言い切れないのではないだろうか。</p>

<h1>
<span id="合わせて読みたい" class="fragment"></span><a href="#%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>合わせて読みたい</h1>

<ul>
<li><a href="http://stevehanov.ca/blog/index.php?id=132" rel="nofollow noopener" target="_blank">20 lines of code that will beat A/B testing every time</a></li>
</ul>

<p>バンディットアルゴリズムの方が優れているよ、という趣旨のブログ記事。</p>

<ul>
<li><a href="http://visualwebsiteoptimizer.com/split-testing-blog/multi-armed-bandit-algorithm/" rel="nofollow noopener" target="_blank">Why multi-armed bandit algorithm is not “better” than A/B testing</a></li>
</ul>

<p>上の記事に対する反論という形でA/Bテストの優位性を主張しているブログ記事。実際にA/Bテストとバンディットアルゴリズムの比較を行なっているが、ここで用いているのはEpsilon-Greedyアルゴリズムであることに注意。</p>

<ul>
<li><a href="http://www.amazon.co.jp/gp/product/B00AM86Y0K/ref=as_li_ss_tl?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=B00AM86Y0K&amp;linkCode=as2&amp;tag=qiita-taka84u9-22" rel="nofollow noopener" target="_blank">Bandit Algorithms for Website Optimization (O'REILLY)</a></li>
</ul>

<p>バンディットアルゴリズムについての入門書籍。おそらくここまでしっかりまとまった本は他に無いのではないだろうか。洋書だが英文は簡単で比較的読みやすかった印象。古くからある知見に加えて、最近発表された学術論文の内容も取り扱われており、今後より深く勉強したくなった人のための文献紹介という面でも有用だと感じた。</p>

<ul>
<li><a href="http://www.amazon.co.jp/dp/4627826613" rel="nofollow noopener" target="_blank">強化学習 (森北出版)</a></li>
</ul>

<p>翻訳和書。第2章の29ページ分がバンディット問題に関する、様々なアルゴリズムの効果と解説。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />5位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>670</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/c6f20de0e4f4c352046c">Boxen使わなくても許されるのは2012年までだよね</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-02-27 10:28:12</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> <b>[GitHub]</b> <b>[Boxen]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>続編を書きました - <a href="http://qiita.com/yuku_t/items/50b2b376604c2fefd8cd" id="reference-5704953018a628221ee9">Boxen使ってて許されるのは2013年だけだった</a></p>

<p>すごいすごいと話題な割に誰も使っていないと話題の<a href="http://boxen.github.com/" rel="nofollow noopener" target="_blank">Boxen</a>を使ってみた。</p>

<h2>
<span id="3行で分かる結論" class="fragment"></span><a href="#3%E8%A1%8C%E3%81%A7%E5%88%86%E3%81%8B%E3%82%8B%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>3行で分かる結論</h2>

<p>Boxenは...</p>

<ul>
<li>Macのセットアップを自動化してくれる</li>
<li>個人用途でも十分便利だが真価を発揮するのは大人数で使うとき</li>
<li>Puppet知らなくても案外使える</li>
</ul>

<h3>
<span id="この記事で分かるもの" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E5%88%86%E3%81%8B%E3%82%8B%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>この記事で分かるもの</h3>

<ul>
<li>Boxenの個人用途での使い方</li>
<li>Boxenのチーム用途での使い方</li>
<li>Puppetのmanifestの簡単な書き方</li>
</ul>

<h3>
<span id="この記事を読んでも分からないもの" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A7%E3%82%82%E5%88%86%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>この記事を読んでも分からないもの</h3>

<ul>
<li>Puppetの詳しい使い方</li>
</ul>

<h2>
<span id="boxenを使うと何ができるのか" class="fragment"></span><a href="#boxen%E3%82%92%E4%BD%BF%E3%81%86%E3%81%A8%E4%BD%95%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>Boxenを使うと何ができるのか</h2>

<p>BoxenはGitHub社が開発しているシステムで、Macのセットアップを簡単にできるようにしてくれる。新しくMacを購入したら開発環境や各種アプリケーションをインストールすることから始めるが、これをコマンド一発で全てやってくれるようになる。</p>

<h2>
<span id="boxenにまつわる各種の誤解" class="fragment"></span><a href="#boxen%E3%81%AB%E3%81%BE%E3%81%A4%E3%82%8F%E3%82%8B%E5%90%84%E7%A8%AE%E3%81%AE%E8%AA%A4%E8%A7%A3"><i class="fa fa-link"></i></a>Boxenにまつわる各種の誤解</h2>

<h3>
<span id="puppetを知らないと使えない" class="fragment"></span><a href="#puppet%E3%82%92%E7%9F%A5%E3%82%89%E3%81%AA%E3%81%84%E3%81%A8%E4%BD%BF%E3%81%88%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>Puppetを知らないと使えない</h3>

<p>PuppetとはBoxenが内部で使っているセットアップツール。似たものにChefなどがある。<br>
BoxenではGitHub社が公開している各種resourceを組み合わせるだけでだいたいのことができる。個人用途ならこれで十分。<br>
細かい制御をするにはPuppetについて学習する必要があるが、GitHub社が公開しているresourceのmanifestを見れば雰囲気でなんとかなる。実際私は今回Puppetを初めて使ったがなんとかなった。<br>
（「nginxをインストールする」という設定があった場合、nginxはresourceで、resourceをインストールする手順が書いてあるのがmanifest。ここらへんはPuppet用語だから間違っているかも）</p>

<h3>
<span id="個人で使うには向かない" class="fragment"></span><a href="#%E5%80%8B%E4%BA%BA%E3%81%A7%E4%BD%BF%E3%81%86%E3%81%AB%E3%81%AF%E5%90%91%E3%81%8B%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>個人で使うには向かない</h3>

<p>Boxenはチームで使った方が便利だが、個人用途としても十分に使える。チーム用のBoxenリポジトリに各個人の設定も書ける。<br>
ただ個人だとそう何度もマシンを一からセットアップする機会がある訳ではないので、やはり大人数で設定を共有した方が真価を発揮する。ハマりどころはだいたいいつも同じだからそこら辺を回避する設定を入れておくと捗ること間違いなし。</p>

<h3>
<span id="github社に特化しているので使えない" class="fragment"></span><a href="#github%E7%A4%BE%E3%81%AB%E7%89%B9%E5%8C%96%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%A7%E4%BD%BF%E3%81%88%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>GitHub社に特化しているので使えない</h3>

<p>確かにGitHub社が使っている環境を構築するのに便利なmanifestが充実しているが、自分の環境に流用できるものも多い。またmanifestは自作することも簡単に可能。</p>

<h2>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h2>

<ol>
<li>事前準備</li>
<li>boxen/our-boxenのコピーを作成</li>
<li>設定を書く

<ol>
<li>Puppetfile</li>
<li>個人設定</li>
<li>プロジェクト設定</li>
<li>チーム設定</li>
</ol>
</li>
<li>Boxenを実行</li>
</ol>

<h3>
<span id="事前準備" class="fragment"></span><a href="#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>事前準備</h3>

<ul>
<li>Xcodeをインストール（CLI、GUIどちらでもOK）</li>
<li>GitHubアカウントを持っていないなら作る</li>
</ul>

<p>最近のMacにはgitがプリインストールされている。何かしらの理由でgitが無い場合はそれもインストールする。<br>
あと以下を実行する。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span>sudo mkdir -p /opt/boxen
sudo chown <span class="nv">$USER</span>:admin /opt/boxen
</pre></div>
</div>

<h3>
<span id="boxenour-boxenのコピーを作成" class="fragment"></span><a href="#boxenour-boxen%E3%81%AE%E3%82%B3%E3%83%94%E3%83%BC%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>boxen/our-boxenのコピーを作成</h3>

<p><a href="https://github.com/boxen/our-boxen" rel="nofollow noopener" target="_blank">boxen/our-boxen</a>はBoxenを使うためのひな形プロジェクト。まずはこれのコピーを作って、そこに設定を書いていく。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span>mkdir -p ~/src/my-boxen <span class="c1">#名前は好きにする</span>
<span class="nb">cd</span> ~/src/my-boxen
git init
git remote add upstream https://github.com/boxen/our-boxen
git pull upstream master
</pre></div>
</div>

<p>これで~/src/my-boxenディレクトリにour-boxenのコピーが作られた。</p>

<h3>
<span id="設定を書く" class="fragment"></span><a href="#%E8%A8%AD%E5%AE%9A%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>設定を書く</h3>

<p>Boxenの設定する手順は大雑把にいって2段階踏む</p>

<ol>
<li>GitHub（やその他公開リポジトリ）上で公開されているresourceを指定</li>
<li>設定ファイルで1で指定したものをincludeする</li>
</ol>

<h4>
<span id="puppetfile" class="fragment"></span><a href="#puppetfile"><i class="fa fa-link"></i></a>Puppetfile</h4>

<p>外部のresourceを使う場合はここで指定する。現在主に仕えるのは<a href="https://github.com/boxen" rel="nofollow noopener" target="_blank">boxen</a>にある <em>puppet-*</em> という名前のリポジトリに入っているもの。設定自体は~/src/my-boxenにあるPuppetfileに書く。<br>
Puppetfileには初期状態で何個か設定がある。こいつらはBoxen自体が使ったりするので消さないこと。<br>
<em>puppet-*</em> の中で今回は以下のものを追記した。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Puppetfile</span></div>
<div class="highlight"><pre><span></span><span class="c1"># Puppetfileの末尾に追記</span>

<span class="c1"># これはGitHub上にあるboxen/puppet-dropboxリポジトリの1.0.0</span>
<span class="c1"># を使うという意味。バージョン名はGitHub上で確認する必要がある。</span>
<span class="n">github</span> <span class="s2">"dropbox"</span><span class="p">,</span>     <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"mysql"</span><span class="p">,</span>       <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"iterm2"</span><span class="p">,</span>      <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"chrome"</span><span class="p">,</span>      <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"skype"</span><span class="p">,</span>       <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"redis"</span><span class="p">,</span>       <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"icu4c"</span><span class="p">,</span>       <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"imagemagick"</span><span class="p">,</span> <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"xquartz"</span><span class="p">,</span>     <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"libtool"</span><span class="p">,</span>     <span class="s2">"1.0.0"</span>
<span class="n">github</span> <span class="s2">"osx"</span><span class="p">,</span>     <span class="s2">"1.0.0"</span>
</pre></div>
</div>

<p>例えばdropbox、skype、iterm2、chromeというのがあることからも分かるように、Boxenでアプリケーションのインストールもできる。</p>

<p>ここで指定したresourceをインストールするには~/src/my-boxen/manifests/site.pp内で <code>include</code> する。しかしsite.ppは全てのマシンに適応される設定を書く場所なので、基本的にはここには書かず、後述する個人設定やプロジェクト設定に書く。</p>

<p>もしhomebrew上に存在するがそれをインストールする <em>puppet-*</em> resourceが提供されていない、という場合、自前でresourceを用意してもいいが、 <strong>homebrewでインストールできる場合に限って</strong> 簡単に書く方法をBoxenが用意しているのでそれを使ってもいい。この方法については「プロジェクト設定」で触れる。</p>

<p>デフォルトではNodejsとRubyがそれぞれnvmとrbenvを使って古いバージョンもインストールされるようになっているが、最新のものだけで十分なのでコメントアウトした。<br>
<code>include</code> コマンドに渡されている <code>nodejs</code> や <code>ruby</code> は確かにPuppetfileの中に現れている。</p>

<div class="code-frame" data-lang="puppet">
<div class="code-lang"><span class="bold">manifests/site.pp</span></div>
<div class="highlight"><pre><span></span><span class="c c-Singleline"># site.ppの下の方にある</span>
<span class="kd">node</span> <span class="s">default</span> <span class="p">{</span><span class="c c-Singleline"></span>
<span class="c c-Singleline">  # すべてのマシンで実行される設定</span>

<span class="c c-Singleline">  # node version</span>
<span class="c c-Singleline">  #include nodejs::0-4</span>
<span class="c c-Singleline">  #include nodejs::0-6</span>
  <span class="kn">include</span> <span class="nc">nodejs::0-8</span><span class="c c-Singleline">  </span>

<span class="c c-Singleline">  # default ruby versions</span>
<span class="c c-Singleline">  #include ruby::1-8-7</span>
<span class="c c-Singleline">  #include ruby::1-9-2</span>
  <span class="nc">include</span> <span class="nc">ruby::1-9-3</span>
}
</pre></div>
</div>

<h4>
<span id="個人設定" class="fragment"></span><a href="#%E5%80%8B%E4%BA%BA%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>個人設定</h4>

<p>事前準備に「GitHubアカウントを持っていないなら作る」があったことを思い出してほしい。Boxenではmodules/people/manifestsディレクトリ内に &lt;GitHubアカウント名&gt;.pp というmanifestがあったらそれを自動的に実行するようになっている。個人用途で使う場合は、ここにもりもり書く感じになる。</p>

<p>例えば私（<a href="https://github.com/taka84u9/" rel="nofollow noopener" target="_blank">taka84u9</a>）の場合はmodules/people/manifests/taka84u9.ppに以下のように書いた。</p>

<div class="code-frame" data-lang="puppet">
<div class="code-lang"><span class="bold">modules/people/manifests/taka84u9.pp</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">people::taka84u9</span> <span class="p">{</span><span class="c c-Singleline"></span>
<span class="c c-Singleline">  # 自分の環境で欲しいresourceをincludeする</span>
  <span class="kn">include</span> <span class="nc">dropbox</span>
  <span class="kn">include</span> <span class="nc">skype</span>
  <span class="kn">include</span> <span class="nc">iterm2::stable</span><span class="c c-Singleline"> #::devもある</span>
  <span class="nc">include</span> <span class="nc">chrome</span>

<span class="c c-Singleline">  # homebrewでインストール</span>
  <span class="nc">package</span> <span class="p">{</span>
    <span class="p">[</span>
      <span class="s1">'tmux'</span><span class="p">,</span>
      <span class="s1">'reattach-to-user-namespace'</span><span class="p">,</span>
      <span class="s1">'tig'</span><span class="p">,</span>
    <span class="p">]:</span>
  <span class="p">}</span>

  <span class="nv">$home</span>     <span class="o">=</span> <span class="s2">"/Users/</span><span class="si">${::luser}</span><span class="s2">"</span>
  <span class="nv">$src</span>      <span class="o">=</span> <span class="s2">"</span><span class="si">${home}</span><span class="s2">/src"</span>
  <span class="nv">$dotfiles</span> <span class="o">=</span> <span class="s2">"</span><span class="si">${src}</span><span class="s2">/dotfiles"</span><span class="c c-Singleline"></span>

<span class="c c-Singleline">  # ~/src/dotfilesにGitHub上のtaka84u9/dotfilesリポジトリを</span>
<span class="c c-Singleline">  # git-cloneする。そのとき~/srcディレクトリがなければいけない。</span>
  <span class="nc">repository</span> <span class="p">{</span> <span class="nv">$dotfiles</span><span class="p">:</span>
    <span class="nt">source</span>  <span class="p">=&gt;</span> <span class="s2">"taka84u9/dotfiles"</span><span class="p">,</span>
    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">File</span><span class="p">[</span><span class="nv">$src</span><span class="p">]</span>
  <span class="p">}</span><span class="c c-Singleline"></span>
<span class="c c-Singleline">  # git-cloneしたらインストールする</span>
  <span class="nc">exec</span> <span class="p">{</span> <span class="s2">"sh </span><span class="si">${dotfiles}</span><span class="s2">/install.sh"</span><span class="p">:</span>
    <span class="nt">cwd</span> <span class="p">=&gt;</span> <span class="nv">$dotfiles</span><span class="p">,</span>
    <span class="nt">creates</span> <span class="p">=&gt;</span> <span class="s2">"</span><span class="si">${home}</span><span class="s2">/.zshrc"</span><span class="p">,</span>
    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Repository</span><span class="p">[</span><span class="nv">$dotfiles</span><span class="p">],</span>
  <span class="p">}</span>
}
</pre></div>
</div>

<p>だいたい雰囲気で何をしているかは分かると思う。 <code>File</code> というのはfileタイプのresourceを指定するのに使う。詳しい説明はしないが、resourceの定義には全て小文字、指定するには先頭大文字になる。 <code>$src</code> のfile定義が無い、と思うかも知れないが~/srcはBoxenが使うために事前に定義しているので今回は場合は必要ない（特殊事例）。普通は以下のように書かねばならない（~/codeディレクトリの場合）。</p>

<div class="code-frame" data-lang="puppet">
<div class="code-lang"><span class="bold">modules/people/manifests/taka84u9.pp</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">people::taka84u9</span> <span class="p">{</span>
  <span class="nv">$code</span>     <span class="o">=</span> <span class="s2">"/Users/</span><span class="si">${::luser}</span><span class="s2">/code"</span>
  <span class="nc">file</span> <span class="p">{</span> <span class="nv">$code</span><span class="p">:</span>
    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">derectory</span><span class="c c-Singleline"> #これはディレクトリです</span>
  <span class="p">}</span>
  <span class="nc">repository</span> <span class="p">{</span> <span class="s2">"</span><span class="si">${code}</span><span class="s2">/dotfiles"</span><span class="p">:</span> <span class="c c-Singleline">#こういう書き方もできる</span>
    <span class="nt">source</span>  <span class="p">=&gt;</span> <span class="s2">"taka84u9/dotfiles"</span><span class="p">,</span>
    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">File</span><span class="p">[</span><span class="nv">$code</span><span class="p">]</span>
  <span class="p">}</span>
}
</pre></div>
</div>

<p>詳しくはPuppetのドキュメントを読むべし。</p>

<h5>
<span id="package-を使いこなす" class="fragment"></span><a href="#package-%E3%82%92%E4%BD%BF%E3%81%84%E3%81%93%E3%81%AA%E3%81%99"><i class="fa fa-link"></i></a>package を使いこなす</h5>

<p>Macアプリをインストールしたい場合は次のように書く。 <code>source</code> でダウンロードURLを指定して、 <code>provider</code> は .zip なら<code>compressed_app</code>  .dmg なら <code>pkgdmg</code> にする。これを書いておくだけで<a href="http://kobito.qiita.com/" rel="nofollow noopener" target="_blank">Kobito</a>と<a href="http://www.trankynam.com/xtrafinder/" rel="nofollow noopener" target="_blank">XtraFinder</a>がインストールされる。</p>

<div class="code-frame" data-lang="puppet"><div class="highlight"><pre><span></span><span class="nc">package</span> <span class="p">{</span>
  <span class="s1">'Kobito'</span><span class="p">:</span>
    <span class="nt">source</span>   <span class="p">=&gt;</span> <span class="s2">"http://kobito.qiita.com/download/Kobito_v1.2.0.zip"</span><span class="p">,</span>
    <span class="nt">provider</span> <span class="p">=&gt;</span> <span class="ss">compressed_app</span><span class="p">;</span>
  <span class="s1">'XtraFinder'</span><span class="p">:</span>
    <span class="nt">source</span>   <span class="p">=&gt;</span> <span class="s2">"http://www.trankynam.com/xtrafinder/downloads/XtraFinder.dmg"</span><span class="p">,</span>
    <span class="nt">provider</span> <span class="p">=&gt;</span> <span class="ss">pkgdmg</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>Homebrew経由でインストールするには同じく <code>package</code> コマンドを使うが、インストール時のオプションを指定するには <code>install_options</code> を指定する。ここではzshを <code>--disable-etcdir</code> オプションでインストールしている。（<code>--disable-etcdir</code> については <code>brew info zsh</code> 参照）<br>
ついでに説明すると file_line はファイルに行を追加する。新しくインストールしたzshをログインシェルとして指定できるように/etc/shellsに追記する。依存関係としてはzshのインストールが済んだあとにしている。<br>
osx_chsh は <code>include osx</code> をすることで使えるようになる便利コマンドで自分のログインシェルを変更する。file_lineがbeforeで指定しているので、osx_chshが実行される時点では既にログインシェルとして新しいzshは登録可能な状態にある。<br>
<a href="https://github.com/boxen/puppet-osx" rel="nofollow noopener" target="_blank">boxen/puppet-osx</a> にはこれ以外にもosx_login_itemなど便利なのが定義されているので使いこなせると一気に幸せになれそう。</p>

<div class="code-frame" data-lang="puppet"><div class="highlight"><pre><span></span><span class="kn">include</span> <span class="nc">osx</span>
<span class="nc">package</span> <span class="p">{</span>
  <span class="s1">'zsh'</span><span class="p">:</span>
    <span class="nt">install_options</span> <span class="p">=&gt;</span> <span class="p">[</span>
      <span class="s1">'--disable-etcdir'</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="nc">file_line</span> <span class="p">{</span> <span class="s1">'add zsh to /etc/shells'</span><span class="p">:</span>
  <span class="nt">path</span>    <span class="p">=&gt;</span> <span class="s1">'/etc/shells'</span><span class="p">,</span>
  <span class="nt">line</span>    <span class="p">=&gt;</span> <span class="s2">"</span><span class="si">${boxen::config::homebrewdir}</span><span class="s2">/bin/zsh"</span><span class="p">,</span>
  <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Package</span><span class="p">[</span><span class="s1">'zsh'</span><span class="p">],</span>
  <span class="nt">before</span>  <span class="p">=&gt;</span> <span class="nc">Osx_chsh</span><span class="p">[</span><span class="nv">$::luser</span><span class="p">];</span>
<span class="p">}</span>
<span class="nc">osx_chsh</span> <span class="p">{</span> <span class="nv">$::luser</span><span class="p">:</span>
  <span class="nt">shell</span>   <span class="p">=&gt;</span> <span class="s2">"</span><span class="si">${boxen::config::homebrewdir}</span><span class="s2">/bin/zsh"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h4>
<span id="プロジェクト設定" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>プロジェクト設定</h4>

<p>個人用途だったらここから先の内容は不要。</p>

<p>Boxenの本来の目的は新しく会社に来た人や、マシンを新しくした人がさっさと開発に取り掛かれるようにすることだ。会社なら複数のプロジェクトがあり、それぞれにセットアップ方法が異なるのが普通だろう。Boxenではそれをmodules/projects/manifestsディレクトリに &lt;プロジェクト名&gt;.pp で定義する。</p>

<p>仮にawesomeprojectというプロジェクトがあるとする。このプロジェクトの設定ファイルはmodules/projects/manifests/awesomeproject.ppになる。</p>

<p>このプロジェクトではRMagickというgemを使っているのでimagemagickとlibtoolを <code>include</code> した。それに加えてRMagickをビルドするにはxzというのも必要なのだが <em>puppet-*</em> を探してみてもそれらしきものが存在しない。だがxzはhomebrewを使ってインストールできる。</p>

<p>実際にインストールしてみて発覚したのだが、imagemagickをインストールして作られるdylibファイルは名前がおかしくてエラーになる。 <a href="http://qiita.com/items/b6c7b56e060849c7509f">この記事</a> を参考にシンボリックリンクを貼って回避することにした。またhomebrewによってlittle-cmsというパッケージもインストールされている（imagemagickかlibtoolかxzが依存していてhomebrewによって自動的にインストールされた）のだが、こちらも同様の理由からシンボリックリンクを作成している。</p>

<p>最後にリポジトリの用意をする。Gitリポジトリを用意するには <code>repository</code> コマンドを使うが、 <code>boxen::project</code> コマンドという便利なものも用意されている。詳しい使い方は <a href="https://github.com/boxen/puppet-boxen/blob/master/manifests/project.pp#L1-L46" rel="nofollow noopener" target="_blank">ここを読む</a></p>

<div class="code-frame" data-lang="puppet">
<div class="code-lang"><span class="bold">modules/projects/manifests/awesomeproject.pp</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">projects::awesomeproject</span> <span class="p">{</span><span class="c c-Singleline"></span>
<span class="c c-Singleline">  # awesomeprojectで必要なものをincludeする</span>

  <span class="kn">include</span> <span class="nc">imagemagick</span>
  <span class="kn">include</span> <span class="nc">libtool</span>
  <span class="nc">package</span> <span class="p">{</span> <span class="s1">'xz'</span><span class="p">:</span> <span class="p">}</span><span class="c c-Singleline"> # homebrewでインストール</span>

  <span class="nv">$lib</span> <span class="o">=</span> <span class="s2">"/opt/boxen/homebrew/lib"</span>
  <span class="nc">file</span> <span class="p">{</span>
    <span class="s2">"</span><span class="si">${lib}</span><span class="s2">/libMagickCore.dylib"</span><span class="p">:</span>
      <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">link</span><span class="p">,</span>  <span class="c c-Singleline"># シンボリックリンク</span>
      <span class="nt">target</span> <span class="p">=&gt;</span> <span class="s2">"./libMagickCore-Q16.7.dylib"</span><span class="p">;</span>
    <span class="s2">"</span><span class="si">${lib}</span><span class="s2">/liblcms2.2.dylib"</span><span class="p">:</span>
      <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">link</span><span class="p">,</span>
      <span class="nt">target</span> <span class="p">=&gt;</span> <span class="s2">"./liblcms.dylb"</span>
  <span class="p">}</span>

  <span class="nc">boxen::project</span> <span class="p">{</span> <span class="s1">'awesomeproject'</span><span class="p">:</span>
    <span class="nt">ruby</span>   <span class="p">=&gt;</span> <span class="s1">'1.9.3'</span><span class="p">,</span>
    <span class="nt">mysql</span>  <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
    <span class="nt">redis</span>  <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
    <span class="c c-Singleline"># GitHub上のtaka84u9/awesomeprojectをgit-cloneする</span>
    <span class="c c-Singleline"># クローン先はデフォルトで~/src/awesomeproject</span>
    <span class="nt">source</span> <span class="p">=&gt;</span> <span class="s1">'taka84u9/awesomeproject'</span>
  <span class="p">}</span>
}
</pre></div>
</div>

<p>プロジェクト設定はこのままでは適応されない。これをインストールするには個人設定でプロジェクトを <code>include</code> する。</p>

<div class="code-frame" data-lang="puppet">
<div class="code-lang"><span class="bold">modules/people/manifests/taka84u9.pp</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">people::taka84u9</span> <span class="p">{</span><span class="c c-Singleline"></span>
<span class="c c-Singleline">  # owsomeprojectがインストールされる</span>
  <span class="kn">include</span> <span class="nc">projects::owsomeproject</span>

<span class="c c-Singleline">  # allプロジェクトは全てのプロジェクトという意味</span>
<span class="c c-Singleline">  # modules/projects/manifests/all.pp参照</span>
  <span class="kn">include</span> <span class="nc">projects::all</span>
}
</pre></div>
</div>

<h4>
<span id="チーム設定" class="fragment"></span><a href="#%E3%83%81%E3%83%BC%E3%83%A0%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>チーム設定</h4>

<p>個人のプロジェクトが所属しているチームに応じて決まる、という場合はチーム設定を使うと便利。</p>

<p>modulesディレクトリにはpeopleとprojectsというディレクトリがあるが好きに追加できる。<br>
例えばmiraclecompanyという会社にamazingteamというチームがいるとする。そしてこのチームはawesomeprojectとsuperprojectプロジェクトを担当しているならmodules/miraclecompany/manifests/amazingteam.ppは次のようになる。</p>

<div class="code-frame" data-lang="puppet">
<div class="code-lang"><span class="bold">modules/miraclecompany/manifests/amazingteam.pp</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">miraclecompany::amazingteam</span> <span class="p">{</span>
  <span class="kn">include</span> <span class="nc">projects::awesomeproject</span>
  <span class="kn">include</span> <span class="nc">projects::superproject</span>
}
</pre></div>
</div>

<p>そしてこのamazingteamに所属するgeniushuckerの個人設定でチームを <code>include</code> する。これでGitHubアカウントがgeniushuckerの人がBoxenを実行するとamazingteam用の環境がサクッと作られる。</p>

<div class="code-frame" data-lang="puppet">
<div class="code-lang"><span class="bold">modules/people/geniushucker.pp</span></div>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">people::geniushucker</span> <span class="p">{</span>
  <span class="kn">include</span> <span class="nc">miraclecompany::amazingteam</span>
}
</pre></div>
</div>

<p>すべての人に共通する内容を記述するには、例えばmiraclecompany::environmentsを作ってmanifests/site.ppで <code>include</code> すればいい。（site.ppは全員で実行されることを思い出してほしい）</p>

<h3>
<span id="boxenを実行" class="fragment"></span><a href="#boxen%E3%82%92%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>Boxenを実行</h3>

<p>Boxenはデフォルトでディスクの暗号化を要求する。企業で使っているのであれば基本的に行った方がいいだろうと思う。ただMacはデフォルトで暗号化を行わない設定になっているので、システム設定を開いて暗号化を許可しなければならない。英語インタフェースなら"System Preferences"→"Security &amp; Privacy"→"FileVault"にある。</p>

<p>以上を行ってから下記実行。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>cd ~/src/my-boxen
script/boxen
# 暗号化を行わない場合は
# script/boxen --no-fde
</pre></div></div>

<p>実行すると、Gitリポジトリに変更がある状態だといろいろ言ってくるが気にしなくてもOK。しばらくすると完了する。<br>
それができたら.zshrcや.bashrcに以下を追記する。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">.zshrc</span></div>
<div class="highlight"><pre><span></span><span class="o">[</span> -f /opt/boxen/env.sh <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> /opt/boxen/env.sh
<span class="o">[</span> -f /opt/boxen/nvm/nvm.sh <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> /opt/boxen/nvm/nvm.sh
</pre></div>
</div>

<p>あと自分のリポジトリに <code>git-push</code> する。プライベートリポジトリ推奨。<br>
リポジトリの場所はGitHubじゃなきゃいけない訳ではない。GitHubのプライベートリポジトリが有料なので<a href="https://bitbucket.org/" rel="nofollow noopener" target="_blank">Bitbucket</a>に無料でプライベートリポジトリを作った。会社なら、会社のプライベートリポジトリに <code>git-push</code> する。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span>ssh-keygen
pbcopy &lt; ~/.ssh/id_rsa.pub
<span class="c1"># Bitbucketに公開鍵を追加</span>
git remote add origin git@bitbucket.org:taka84u9/my-boxen.git
git push origin master
</pre></div>
</div>

<p>これで完了</p>

<h3>
<span id="作ったboxenリポジトリを使う" class="fragment"></span><a href="#%E4%BD%9C%E3%81%A3%E3%81%9Fboxen%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>作ったBoxenリポジトリを使う</h3>

<p>他のマシンで実行するには最初の方で書いた <em>事前準備</em> をして、リポジトリを <code>git-clone</code> して、Boxenを実行して、.zshrcに追記するだけ。<br>
このとき必要なら個人設定も書く。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span>sudo mkdir -p /opt/boxen
sudo chown <span class="nv">$USER</span>:admin /opt/boxen
mkdir ~/src
git clone git@bitbucket.org:taka84u9/my-boxen.git ~/src/my-boxen
<span class="nb">cd</span> ~/src/my-boxen
script/boxen
<span class="c1"># 暗号化を行わない場合は</span>
<span class="c1"># script/boxen --no-fde</span>
</pre></div>
</div>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">.zshrc</span></div>
<div class="highlight"><pre><span></span><span class="o">[</span> -f /opt/boxen/env.sh <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> /opt/boxen/env.sh
<span class="o">[</span> -f /opt/boxen/nvm/nvm.sh <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> /opt/boxen/nvm/nvm.sh
</pre></div>
</div>

<h2>
<span id="合わせて読みたい" class="fragment"></span><a href="#%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>合わせて読みたい</h2>

<ul>
<li><a href="http://qiita.com/items/2f7935f924b6e6c0732d">大人数でBoxen使うならboxen-webが断然便利 #Boxen #Mac - Qiita</a></li>
<li><a href="http://qiita.com/yuku_t/items/9312fd82a0fd291b683f" id="reference-1e596410b6eb69e7d89d">Boxenをアップデートする方法 - Qiita</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2013/02/22/152133" rel="nofollow noopener" target="_blank">Boxenを実行すると何が起こるのか - ✘╹◡╹✘</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />6位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>516</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/3d1cf51d7ae91305eaaa">jQuery.Deferredを使って楽しい非同期生活を送る方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-01-31 19:36:57</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><ul>
<li>続編も書きました : <a href="http://qiita.com/yuku_t/items/1b8ce6bba133a7eaeb23" id="reference-cbc8c8c3e99d3f508ed2">
結局jQuery.Deferredの何が嬉しいのか分からない、という人向けの小話</a>
</li>
</ul>

<p>jQuery version1.5で導入された<code>jQuery.Deferred</code>は、無くてもコードを書けるけど、使えば少しコードが綺麗かつ見通しが良くなる、という機能。<br>
無くても書けるという機能がなかなか使われないというのは世の常なので、jQueryクックブック(O'REILLY)の中でも言及されていない、なんとも寂しい状況だ。<br>
ちょっとここらで一肌脱いでやるか、という趣旨で書き始めたら無駄に長くなった。<br>
とりあえず使ってみたい、という人は下の方の「jQuery.Deferred自体の使い方」までジャンプするとよい。</p>

<h2>
<span id="jquerydeferredとはどういう場面で使うものなのか" class="fragment"></span><a href="#jquerydeferred%E3%81%A8%E3%81%AF%E3%81%A9%E3%81%86%E3%81%84%E3%81%86%E5%A0%B4%E9%9D%A2%E3%81%A7%E4%BD%BF%E3%81%86%E3%82%82%E3%81%AE%E3%81%AA%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>jQuery.Deferredとはどういう場面で使うものなのか</h2>

<p>コールバックを渡して非同期処理完了時にそれを呼び出してもらうような場面。<br>
具体的には</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">hogeからGETで取ってきて、取ってきた結果を第一引数(data)にいれて実行される関数</span>
<span class="cm">*/</span>
<span class="p">});</span>
</pre></div></div>

<p>知ってる人が多いとは思うが、以下のように書くのは間違い</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">hoge</span><span class="p">;</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">hoge</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">hoge</span><span class="p">);</span>  <span class="c1">// =&gt; undefined</span>
</pre></div></div>

<p><code>undefined</code>とアラートされる理由は<code>$.get</code>のコールバック関数が実行される前に<code>alert</code>が呼ばれるため。<br>
これくらいはJavaScriptを少し聞きかじった人でもだいたい知っているだろう。<br>
この程度なら大した問題にならないと思うし、<code>jQuery.Deferred</code>をわざわざ使わなくてもなんとかなる。</p>

<p>しかしながら、上記の例はhoge一つだけだったのが、もう少し話を進めてhigeとhomuまで必要になったとしたらどうなるだろう？<br>
以下のようにコールバックの雨あられとなってしまう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hoge</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'hige'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hige</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'homu'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">homu</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// hoge, hige, homu を使った処理</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div></div>

<p>僕的には既にアウトだが、百歩譲ってこれがぎりぎりセーフだとしても、ここから更に歩を進めて、必要なデータの数が任意個だったらどうすればよいのか。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 任意回のコールバックのネスト？？？？</span>
<span class="p">});</span>
</pre></div></div>

<p>加えて、これらの間に依存関係がないとしたら、順番順番に取得するのは時間のムダだ。並列的にに取ってきたいだろう。つまり、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>-(get hoge)-&gt;|-(get hige)-&gt;|-(get homu)-&gt;|-(hoge hige homuを使った処理)-&gt;
</pre></div></div>

<p>じゃなく</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>-(get hoge)-&gt;|
-(get hige)-&gt;|-(hoge hige homuを使った処理)-&gt;
-(get homu)-&gt;|
</pre></div></div>

<p>という感じだ。</p>

<p>ここでさっそうと現れるのが<code>jQuery.Deferred</code>。<br>
具体的には次のように書く。<br>
まずは小手調べとして、hoge, hige, homuが必要な場合。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'hige'</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'homu'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">hoge</span><span class="p">,</span> <span class="nx">hige</span><span class="p">,</span> <span class="nx">homu</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// hoge, hige, homu を使った処理</span>
  <span class="p">});</span>
</pre></div></div>

<p>そして、任意個のデータが必要な場合。<code>names</code>という配列に必要なのが入っているとする。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">deferredObjects</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">deferredObjects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
<span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">deferredObjects</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// arguments を使って必要な処理を書く</span>
  <span class="p">});</span>
</pre></div></div>

<p>一つでもエラーがあった場合は他の処理をしたい時は次のようになる。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">deferredObjects</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* arguments を使う */</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* エラー処理 */</span> <span class="p">});</span>
</pre></div></div>

<h2>
<span id="具体的な利用シーン" class="fragment"></span><a href="#%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AA%E5%88%A9%E7%94%A8%E3%82%B7%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a>具体的な利用シーン</h2>

<p>キャッシュがあればそちらを使い、無かったらリモートから取ってきてキャッシュに入れて、其の後、値を使って処理をしたい、という場合は次のような感じに書く。(stack over flowにあった例を拝借)</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">var</span> <span class="nx">getData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>  <span class="p">{</span>
  <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">getData</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">),</span> <span class="nx">getData</span><span class="p">(</span><span class="s1">'hige'</span><span class="p">),</span> <span class="nx">getData</span><span class="p">(</span><span class="s1">'homu'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">hoge</span><span class="p">,</span> <span class="nx">hige</span><span class="p">,</span> <span class="nx">homu</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*  */</span> <span class="p">});</span>
</pre></div></div>

<p>このサンプルの味噌は<code>getData</code>が返すのが<code>$.ajax()</code>だったら遅延が生じ、単なるオブジェクト(ここでは<code>cache[name]</code>)だったら、遅延が生じないということだ。<br>
つまり、hogeとhigeとhomuのうち、キャッシュに乗っていないものだけ取ってきて、全部がそろった段階で<code>done</code>に渡されたコールバックが実行される。</p>

<h1>
<span id="jquerydeferred自体の使い方" class="fragment"></span><a href="#jquerydeferred%E8%87%AA%E4%BD%93%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>jQuery.Deferred自体の使い方</h1>

<ul>
<li>参考： <a href="http://hamalog.tumblr.com/post/5159447047/jquery-deferred" rel="nofollow noopener" target="_blank">jQuery.Deferredって何</a>
</li>
</ul>

<p>上記のページがいろいろ書いてある。ここでは中身には踏み込まず、ぶっちゃけどうすれば使えるかだけ書く。</p>

<h2>
<span id="0-非同期処理を含んだ関数を用意する" class="fragment"></span><a href="#0-%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86%E3%82%92%E5%90%AB%E3%82%93%E3%81%A0%E9%96%A2%E6%95%B0%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>0 非同期処理を含んだ関数を用意する</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">async</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 非同期関数 async に渡されるコールバック関数</span>
  <span class="p">});</span>
<span class="p">};</span>
</pre></div></div>

<h2>
<span id="1-jquerydeferredpromiseを返すようにする" class="fragment"></span><a href="#1-jquerydeferredpromise%E3%82%92%E8%BF%94%E3%81%99%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1 jQuery.Deferred#promise()を返すようにする</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span> <span class="c1">// new はあってもなくても同じ</span>
  <span class="nx">async</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* callback */</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
<span class="p">};</span>
</pre></div></div>

<p><code>func</code>を実行すると、内部の<code>async</code>の結果を待たずに<code>dfd.promise()</code>が返される。<br>
返される値がこれ以外だった場合は、自動的に <code>resolve(返されたデータ)</code> 相当として処理される。(<code>resolve</code>については後述)</p>

<h2>
<span id="2-コールバックの中でresolveもしくはrejectを呼ぶ" class="fragment"></span><a href="#2-%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%81%AE%E4%B8%AD%E3%81%A7resolve%E3%82%82%E3%81%97%E3%81%8F%E3%81%AFreject%E3%82%92%E5%91%BC%E3%81%B6"><i class="fa fa-link"></i></a>2 コールバックの中でresolveもしくはrejectを呼ぶ</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
  <span class="nx">async</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 何かの処理</span>
    <span class="nx">success</span> <span class="o">?</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="cm">/* 渡したいオブジェクト */</span><span class="p">)</span> <span class="o">:</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
<span class="p">};</span>
</pre></div></div>

<p>終わり。簡単簡単。<br>
勘の良い人なら分かると思うが、<code>jQuery.ajax</code>は上記の仕様を満たすように設計されているため、<code>jQuery.when</code>に渡すことができる。</p>

<h2>
<span id="3-実行する" class="fragment"></span><a href="#3-%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3 実行する</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">func</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// resolveが実行された場合</span>
    <span class="c1">// data には上のdfd.resolveに渡したオブジェクトが入っている</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// rejectが実行された場合</span>
  <span class="p">});</span>
</pre></div></div>

<p>上の方で書いたように<code>when</code>には複数渡せば並列実行できる。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">func</span><span class="p">(),</span> <span class="nx">func</span><span class="p">(),</span> <span class="nx">func</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data1</span><span class="p">,</span> <span class="nx">data2</span><span class="p">,</span> <span class="nx">data3</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 全部 resolve だった場合 */</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* 一つでも reject だった場合 */</span> <span class="p">});</span>
</pre></div></div>

<p>ざっとこんな感じ。</p>

<p>jQuery.Deferredを使って非同期コーディングを楽しみましょう。</p>

<p>続編 <a href="http://qiita.com/yuku_t/items/1b8ce6bba133a7eaeb23"><br>
結局jQuery.Deferredの何が嬉しいのか分からない、という人向けの小話</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />7位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>421</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/5df06d50c4c349cc0c1b">curlを捨ててhttpieを使おう</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-06-08 23:24:45</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[HTTP]</b> <b>[cli]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><ul>
<li>
<a href="https://github.com/jkbr/httpie" rel="nofollow noopener" target="_blank">jkbr/httpie : Github</a> : HTTPie is a CLI, cURL-like tool for humans</li>
</ul>

<p>curl（<del>see urlと発音するらしい</del><a href="http://curl.haxx.se/docs/faq.html#What_is_cURL" rel="nofollow noopener" target="_blank">本家のFAQ</a>によると開発陣は <em>kurl</em> と発音してるらしいです）はプログラムから使うには便利だけど、オプションがわかりにくい。</p>

<p>httpieはより直感的なcurl代替コマンド。よほどcurlに思い入れがない限りhttpieをおすすめする。</p>

<h2>
<span id="インストール" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>インストール</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>easy_install httpie
<span class="c1"># OR</span>
pip install -U httpie
</pre></div></div>

<h2>
<span id="使用例" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>使用例</h2>

<p><a href="https://camo.qiitausercontent.com/efeca3dbb569efca76c74d83d94298c5032a5c98/68747470733a2f2f6769746875622e636f6d2f6a6b62722f6874747069652f7261772f6d61737465722f6874747069652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/efeca3dbb569efca76c74d83d94298c5032a5c98/68747470733a2f2f6769746875622e636f6d2f6a6b62722f6874747069652f7261772f6d61737465722f6874747069652e706e67" alt="httpie" data-canonical-src="https://github.com/jkbr/httpie/raw/master/httpie.png"></a></p>

<p>奥がcurlで、手前がhttpieを使った場合。見れば分かるようにhttpieは自動で色付けをしてくれるし、コマンドもかなり直感的だ。内部的にはPythonのrequestsというモジュールを使っている。Python組み込みのHTTPクライアントに辟易している人はそちらも調べてみるととても幸せになれる。</p>

<ul>
<li>
<a href="https://github.com/kennethreitz/requests" rel="nofollow noopener" target="_blank">kennethreitz/requests : Github</a> : Python HTTP Requests for Humans™</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />8位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>377</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/078eebf02bbbb45adc93">なぜGoogleはJSONの先頭に while(1); をつけるのか</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-02-05 23:08:05</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML]</b> <b>[JavaScript]</b> <b>[Ajax]</b> <b>[StackOverflow]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Stack Overflowに面白い質問があったので紹介する</p>

<ul>
<li><a href="http://stackoverflow.com/questions/2669690/why-does-google-prepend-while1-to-their-json-responses" rel="nofollow noopener" target="_blank">javascript - Why does Google prepend while(1); to their JSON responses? - Stack Overflow</a></li>
</ul>

<h2>
<span id="質問" class="fragment"></span><a href="#%E8%B3%AA%E5%95%8F"><i class="fa fa-link"></i></a>質問</h2>

<p>Googleのサービス内で使われるJSONの先頭に <code>while(1);</code> てついているのは何故？<br>
例えばGoogle Calendarではカレンダーを切り替えるときに以下のような内容のデータがサーバから返される。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">json</span></div>
<div class="highlight"><pre><span></span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);[[</span><span class="s1">'u'</span><span class="p">,[[</span><span class="s1">'smsSentFlag'</span><span class="p">,</span><span class="s1">'false'</span><span class="p">],[</span><span class="s1">'hideInvitations'</span><span class="p">,</span><span class="s1">'false'</span><span class="p">],[</span><span class="s1">'remindOnRespondedEventsOnly'</span><span class="p">,</span><span class="s1">'true'</span><span class="p">],[</span><span class="s1">'hideInvitations_remindOnRespondedEventsOnly'</span><span class="p">,</span><span class="s1">'false_true'</span><span class="p">],[</span><span class="s1">'Calendar ID stripped for privacy'</span><span class="p">,</span><span class="s1">'false'</span><span class="p">],[</span><span class="s1">'smsVerifiedFlag'</span><span class="p">,</span><span class="s1">'true'</span><span class="p">]]]]</span>
</pre></div>
</div>

<p>これ以外にもGoogleのサービスでは <code>&amp;&amp;&amp;START&amp;&amp;&amp;</code> とか <code>while(1); &amp;&amp;&amp;START&amp;&amp;&amp;</code> てのが先頭に入ってたりするんだけど、これは一体何？</p>

<h2>
<span id="解答" class="fragment"></span><a href="#%E8%A7%A3%E7%AD%94"><i class="fa fa-link"></i></a>解答</h2>

<p>これはクロスサイト・リクエスト・フォージェリ対策。<br>
例えばGoogleが <code>gmail.com/json?action=inbox</code> というURLを持ってて、そこにユーザのCOOKIEでアクセスすると最新50件のメールが取れるとする。悪意のあるサイトからはsame-origin policyでAjaxではアクセスできないが、scriptタグのsrc属性に直接入れることでJSONを取得することはできてしまう。そして <a href="http://ejohn.org/blog/re-securing-json/" rel="nofollow noopener" target="_blank">ArrayコンストラクタやそのアクセッサメソッドをオーバライドすることでJSONの値にアクセスできてしまう。</a><br>
先頭に <code>while(1);</code> とかシンタックスエラーになる文字列があればこれを抑制できる。Ajaxではレスポンスを文字列として扱うことができるけれどscriptタグでは即実行されるため、これら余分な箇所を取り除くことができないからだ。</p>

<h3>
<span id="余談" class="fragment"></span><a href="#%E4%BD%99%E8%AB%87"><i class="fa fa-link"></i></a>余談</h3>

<ul>
<li>最近のWebブラウザでは組み込み型のコンストラクタの再定義はできないようになっている。</li>
<li>FacebookのJSONの先頭には <code>for(;;);</code> がついているらしい。こっちの方が1文字短い。</li>
<li>古いブラウザのセキュリティホールに対応するためのバッドノウハウなので、相当セキュリティに気を使わなければならないようなページでなければ必要ない。</li>
<li>「CSRF対策」というよりは「JSON hijacking対策」という方が適切。</li>
<li>より正確に言うならAjaxでアクセスできないのはSame-Origin Policyと<a href="http://www.w3.org/TR/cors/" rel="nofollow noopener" target="_blank">Cross-Origin Resource Sharing</a>が設定されていないため。</li>
</ul>

<h3>
<span id="合わせて読みたい" class="fragment"></span><a href="#%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>合わせて読みたい</h3>

<ul>
<li><a href="http://d.hatena.ne.jp/hasegawayosuke/20130206/p1" rel="nofollow noopener" target="_blank"> GoogleのJSON(モドキ)の先頭にwhile(1); がつく理由 - 葉っぱ日記</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />9位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>368</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/01c0ec4389db143e27f5">Capistrano3のデプロイフレームワークの使い方</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-02 19:52:05</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[capistrano]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://www.capistranorb.com/" rel="nofollow noopener" target="_blank">Capistrano</a>はバージョン3から汎用的なデプロイフレームワークになりました。タスクのフックを利用することで簡単に自分のアプリケーション環境に特化したデプロイプロセスを記述することができます。</p>

<p>本稿では、この汎用化されたデプロイ機能の使い方に焦点を絞って解説したいと思います。より基本的なCapistrano3の解説は</p>

<ul>
<li><a href="http://labs.gree.jp/blog/2013/12/10084/" rel="nofollow noopener" target="_blank">入門 Capistrano 3 ~ 全ての手作業を生まれる前に消し去りたい | GREE Engineers' Blog</a></li>
</ul>

<p>がよくまとまっているので、そちらを参考にしてください。この参考記事では "5. Capistranoデフォルトタスクの消去" でCapistranoの新規導入時のコストを下げる目的で、このフレームワーク機能を消去しています。本稿はこのフレームワーク機能の使い方を解説するものです。</p>

<h2>
<span id="deployとframeworkの2つの抽象度が用意されている" class="fragment"></span><a href="#deploy%E3%81%A8framework%E3%81%AE2%E3%81%A4%E3%81%AE%E6%8A%BD%E8%B1%A1%E5%BA%A6%E3%81%8C%E7%94%A8%E6%84%8F%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>deployとframeworkの2つの抽象度が用意されている</h2>

<p>Capistrano3をインストールするといきなりこんな感じのCapfileが作られます</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Capfile</span></div>
<div class="highlight"><pre><span></span><span class="c1"># Capistranoの設定を読み込む。おまじない</span>
<span class="nb">require</span> <span class="s1">'capistrano/setup'</span>

<span class="c1"># デプロイフレームワークを読み込み</span>
<span class="nb">require</span> <span class="s1">'capistrano/deploy'</span>

<span class="c1"># `lib/capistrano/tasks' に定義されたタスクを読み込む</span>
<span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'lib/capistrano/tasks/*.cap'</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">import</span> <span class="n">r</span> <span class="p">}</span>
</pre></div>
</div>

<p>この<a href="https://github.com/capistrano/capistrano/blob/master/lib/capistrano/deploy.rb" rel="nofollow noopener" target="_blank">capistrano/deploy</a>が内部で<a href="https://github.com/capistrano/capistrano/blob/master/lib/capistrano/framework.rb" rel="nofollow noopener" target="_blank">capistrano/framework</a>を読み込みます。つまり、Capistrano3のデプロイ機能には2つのレベルが存在しています。</p>

<ol>
<li>
<p>capistrano/framework</p>

<p>もっとも汎用的なデプロイフレームワーク。デプロイの開始、コードのアップデート、システムの公開、デプロイの完了、という流れを定義しているだけで具体的な処理は一切含まない。フックを提供するだけ</p>
</li>
<li>
<p>capistrano/deploy</p>

<p>より具体的なタスクが追加されたもの。デプロイ可能かのチェック、デプロイ先ディレクトリの存在確認などなど、ほとんどのデプロイ時に必須になるデプロイ環境の準備系のタスクが定義されている。</p>
</li>
</ol>

<p>Capistrano3のデプロイフレームワークを利用する場合は、capistrano/frameworkのタスクにRake由来の <code>before</code> や <code>after</code> を使って自アプリケーションに固有の処理を埋め込んでいくことで実装します。</p>

<h2>
<span id="capistranoframeworkが提供するデプロイの流れ" class="fragment"></span><a href="#capistranoframework%E3%81%8C%E6%8F%90%E4%BE%9B%E3%81%99%E3%82%8B%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>capistrano/frameworkが提供するデプロイの流れ</h2>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% cat Capfile
require <span class="s1">'capistrano/setup'</span>
require <span class="s1">'capistrano/framework'</span>
% cap -T
cap deploy                     <span class="c1"># Deploy a new release</span>
cap deploy:finished            <span class="c1"># Finished</span>
cap deploy:finishing           <span class="c1"># Finish the deployment, clean up server(s)</span>
cap deploy:finishing_rollback  <span class="c1"># Finish the rollback, clean up server(s)</span>
cap deploy:published           <span class="c1"># Published</span>
cap deploy:publishing          <span class="c1"># Publish the release</span>
cap deploy:reverted            <span class="c1"># Reverted</span>
cap deploy:reverting           <span class="c1"># Revert server(s) to previous release</span>
cap deploy:rollback            <span class="c1"># Rollback to previous release</span>
cap deploy:started             <span class="c1"># Started</span>
cap deploy:starting            <span class="c1"># Start a deployment, make sure server(s) ready</span>
cap deploy:updated             <span class="c1"># Updated</span>
cap deploy:updating            <span class="c1"># Update server(s) by setting up a new release</span>
cap install                    <span class="c1"># Install Capistrano, cap install STAGES=staging,production</span>
</pre></div></div>

<p>だいたい分かると思いますが <code>cap staging deploy</code> を実行すると下記の順序で空のタスクが実行されます。</p>

<ol>
<li> deploy:starting</li>
<li> deploy:started</li>
<li> deploy:updating</li>
<li> deploy:updated</li>
<li> deploy:publishing</li>
<li> deploy:published</li>
<li> deploy:finishing</li>
<li> deploy:finished</li>
</ol>

<p>そして <code>cap staging deploy:rollback</code> を実行すると下記の順序で実行します。</p>

<ol>
<li> deploy:starting</li>
<li> deploy:started</li>
<li> deploy:reverting</li>
<li> deploy:reverted</li>
<li> deploy:publishing</li>
<li> deploy:published</li>
<li> deploy:finishing_rollback</li>
<li> deploy:finished</li>
</ol>

<p>これらは全て中身の無い、空のタスクです。これらの前後にタスクを埋め込んでいくことでデプロイプロセスを記述していきます。</p>

<h2>
<span id="capistranodeployが提供するデプロイの流れ" class="fragment"></span><a href="#capistranodeploy%E3%81%8C%E6%8F%90%E4%BE%9B%E3%81%99%E3%82%8B%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>capistrano/deployが提供するデプロイの流れ</h2>

<p>capistrano/frameworkよりもう一歩踏み込んでデプロイフローを提供するのがcapistrano/deployです。</p>

<p><code>cap staging deploy</code> すると下記のような順序でタスクが実行されるようになります。</p>

<ol>
<li> deploy:starting

<ol>
<li> deploy:check

<ol>
<li> git:check</li>
<li> deploy:check:directories</li>
<li> deploy:check:linked_dirs</li>
<li> deploy:check:make_linked_dirs</li>
<li> deploy:check:linked_files</li>
</ol>
</li>
</ol>
</li>
<li> deploy:started</li>
<li> deploy:updating

<ol>
<li> git:create_release</li>
<li> deploy:symlink:shared

<ol>
<li> deploy:symlink:linked_files</li>
<li> deploy:symlink:linked_dirs</li>
</ol>
</li>
</ol>
</li>
<li> deploy:updated</li>
<li> deploy:publishing

<ol>
<li> deploy:symlink:release</li>
</ol>
</li>
<li> deploy:published</li>
<li> deploy:finishing

<ol>
<li> deploy:cleanup</li>
</ol>
</li>
<li> deploy:finished</li>
</ol>

<p>個々のタスクの内容について詳しくは説明しませんが、名前から判断するにcapistrano/deployがcapistrano/frameworkが提供するデプロイフローのセマンティックにあうように、タスクを追加していることが分かります。</p>

<p>例えば、deploy:startingでデプロイ先のディレクトリの準備などは全てcapistrano/deployがやってくれるので、deploy:startedに紐付けるタスクはディレクトリが存在する前提で記述してOKな訳です。</p>

<p>ちなみにここでgit:checkなどのようにGitをVCSとして利用しているのはあくまでもデフォルト値であって、hgを使ったり、他のツールを指定することもできます（その場合はそのツールに対してVCS:checkなどのタスクを用意する必要があります）</p>

<h2>
<span id="具体例-hipchat通知する" class="fragment"></span><a href="#%E5%85%B7%E4%BD%93%E4%BE%8B-hipchat%E9%80%9A%E7%9F%A5%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>具体例: HipChat通知する</h2>

<p>例えばデプロイ開始時と終了時ににHipChatのDevルームに通知したい、という場合は</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">lib/capistrano/tasks/hipchat_notification.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'hipchat'</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">HipChat</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">HIPCHAT_TOKEN</span><span class="p">)</span><span class="o">[</span><span class="s1">'Dev'</span><span class="o">]</span>

<span class="n">namespace</span> <span class="ss">:hipchat</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:update</span> <span class="k">do</span>
    <span class="n">task</span> <span class="ss">:start</span> <span class="k">do</span>
      <span class="n">run_locally</span> <span class="k">do</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'Deploy'</span><span class="p">,</span> <span class="s1">'デプロイ開始'</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:finish</span> <span class="k">do</span>
      <span class="c1"># ..</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">namespace</span> <span class="ss">:rollback</span> <span class="k">do</span>
    <span class="c1"># ..</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">before</span> <span class="s1">'deploy:updating'</span><span class="p">,</span> <span class="s1">'hipchat:update:start'</span>
<span class="n">after</span> <span class="s1">'deploy:finishing'</span><span class="p">,</span> <span class="s1">'hipchat:update:finish'</span>
<span class="n">before</span> <span class="s1">'deploy:reverting'</span><span class="p">,</span> <span class="s1">'hipchat:rollback:start'</span>
<span class="n">after</span> <span class="s1">'deploy:finishing_rollback'</span><span class="p">,</span> <span class="s1">'hipchat:rollback:finish'</span>
</pre></div>
</div>

<p>のように書けばよい訳です。capistrano/frameworkを骨格にして、各々のタスクが肉付けをしていくことで、それぞれのタスクを疎に保ちながらデプロイプロセスを記述することができます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />10位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>352</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/40b7daf018d3dab48974">Qiitaの画像アップロード機能も簡単に実装できる。そう、S3ならね。</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-05-27 13:49:49</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> <b>[JavaScript]</b> <b>[AWS]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>QiitaとKobitoで画像アップロードができるようになりました。<br>
その後ろ側をちょっぴり公開します。<br>
件名からも分かるように、背後ではAWSのS3を画像ストレージに採用しています。</p>

<ul>
<li><a href="http://blog.qiita.com/post/50993800271/qiita-image-uploading" rel="nofollow noopener" target="_blank">画像アップロード機能をリリースしました - The Official Qiita Blog</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/99e372b5abe8ac62bc0bc2b6dc4195f8021d9b0f/687474703a2f2f6d656469612e74756d626c722e636f6d2f34623431336134616464663265653064393463333733616332636638663832642f74756d626c725f696e6c696e655f6d6e356370724748795a31717a347267702e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/99e372b5abe8ac62bc0bc2b6dc4195f8021d9b0f/687474703a2f2f6d656469612e74756d626c722e636f6d2f34623431336134616464663265653064393463333733616332636638663832642f74756d626c725f696e6c696e655f6d6e356370724748795a31717a347267702e676966" alt="" data-canonical-src="http://media.tumblr.com/4b413a4addf2ee0d94c373ac2cf8f82d/tumblr_inline_mn5cprGHyZ1qz4rgp.gif"></a></p>

<ul>
<li><a href="http://blog.qiita.com/post/51270885648/kobito-v1-6-1-image-uploading" rel="nofollow noopener" target="_blank">Kobito v1.6.1リリース: ドラッグ&amp;ドロップやスクリーンショット撮影で簡単に画像を添付できるようになりました! - The Official Qiita Blog</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/d941dff96b4b4616182174f3b22bba0955696200/687474703a2f2f6769667a6f2e6e65742f636333373339313635313538623933646133373235393531643035633439326463386365313463322e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d941dff96b4b4616182174f3b22bba0955696200/687474703a2f2f6769667a6f2e6e65742f636333373339313635313538623933646133373235393531643035633439326463386365313463322e676966" alt="" data-canonical-src="http://gifzo.net/cc3739165158b93da3725951d05c492dc8ce14c2.gif"></a></p>

<h4>
<span id="用語統一" class="fragment"></span><a href="#%E7%94%A8%E8%AA%9E%E7%B5%B1%E4%B8%80"><i class="fa fa-link"></i></a>用語統一</h4>

<p><strong>サーバ</strong> はQiitaのサーバのことを指すことにします。（つまり、S3ではない、ということ）<br>
また <strong>クライアント</strong> は各ユーザのブラウザのことを指します。</p>

<h1>
<span id="要件" class="fragment"></span><a href="#%E8%A6%81%E4%BB%B6"><i class="fa fa-link"></i></a>要件</h1>

<p>画像アップロード機能を実装するにあたっていくつかの要求がありました。</p>

<ol>
<li>成りすましを防げる</li>
<li>アップロードされたファイルを管理できる</li>
<li>自分達のサーバに負荷をかけたくない</li>
<li>変な画像のアップロードを阻止したい</li>
</ol>

<p>QiitaユーザがQiitaないしQiita:Teamへ記事を投稿するために提供する機能なので、例えば他のサービスからのアップロードなど、意図しない用途での使用を防げなければなりません。<br>
またコスト的な問題から容量無制限で機能を提供することはできません。画像以外のファイルや大き過ぎるファイル、過剰なアップロードを排除する仕組みが必要です。<br>
画像をアップロードする際に自前のサーバに中継させることもできますがサーバに負荷がかかるので、クライアントが直接S3へアップロードしたいです。</p>

<p>画像アップロード機能を実装するなら、だいたいどこでも同じような要求になるのではないでしょうか？</p>

<h2>
<span id="s3で解決できた要求" class="fragment"></span><a href="#s3%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%A7%E3%81%8D%E3%81%9F%E8%A6%81%E6%B1%82"><i class="fa fa-link"></i></a>S3で解決できた要求</h2>

<h3>
<span id="成りすましを防げる" class="fragment"></span><a href="#%E6%88%90%E3%82%8A%E3%81%99%E3%81%BE%E3%81%97%E3%82%92%E9%98%B2%E3%81%92%E3%82%8B"><i class="fa fa-link"></i></a>成りすましを防げる</h3>

<p>S3にファイルをアップロードするにはサーバが発行するポリシーとシグニチャが必要です。そしてこれを適切に発行するにはAWSのシークレットキーが必須なので、（シークレットキーが外部に流出しない限りは）サーバを経由せずに画像をアップロードすることは実質的に不可能です。</p>

<p>サーバではユーザの認証やファイルの簡単なチェックを行うことができます。ポリシーを厳格に定めることでユーザによるファイル偽装も（ある程度は）弾くこともできます。</p>

<h3>
<span id="アップロードされたファイルを管理できる" class="fragment"></span><a href="#%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E3%81%95%E3%82%8C%E3%81%9F%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%AE%A1%E7%90%86%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>アップロードされたファイルを管理できる</h3>

<p>画像アップロードするにはサーバを経由しなければならないので、サーバ側でアップロードを許可したユーザとそのパスを紐付けて覚えておけば、S3上にアップロードされたファイルが何時誰によってアップロードされたのかを管理することができます。</p>

<h3>
<span id="自分達のサーバに負荷をかけたくない" class="fragment"></span><a href="#%E8%87%AA%E5%88%86%E9%81%94%E3%81%AE%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E8%B2%A0%E8%8D%B7%E3%82%92%E3%81%8B%E3%81%91%E3%81%9F%E3%81%8F%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>自分達のサーバに負荷をかけたくない</h3>

<p>ブラウザからS3へ直接ファイルをアップロードすることが可能です。    </p>

<h2>
<span id="s3で解決できない要求" class="fragment"></span><a href="#s3%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E8%A6%81%E6%B1%82"><i class="fa fa-link"></i></a>S3で解決できない要求</h2>

<h3>
<span id="変な画像のアップロードを阻止したい" class="fragment"></span><a href="#%E5%A4%89%E3%81%AA%E7%94%BB%E5%83%8F%E3%81%AE%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E3%82%92%E9%98%BB%E6%AD%A2%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>変な画像のアップロードを阻止したい</h3>

<p>残念ながら今回の構成では画像の中身までチェックすることはできません。<br>
取れる対策としては定期的にクローラを走らせて中身を見るなどですがコスト的に見合わないので、</p>

<ul>
<li>規約で縛る（もともとQiitaは技術情報とは無関係の投稿は禁止されてます）</li>
<li>万が一変な画像をアップロードされても直ぐに削除できて誰が投稿したかが分かるようにしておく</li>
</ul>

<p>つまり運用でカバーする、という感じです。（他のメジャーなサービスもだいたい同じですね）</p>

<h1>
<span id="概略図" class="fragment"></span><a href="#%E6%A6%82%E7%95%A5%E5%9B%B3"><i class="fa fa-link"></i></a>概略図</h1>

<p>Qiitaの画像アップロード機能の概略は次の画像のような感じになっています。</p>

<p><a href="https://camo.qiitausercontent.com/77a8f75fde50aad341016e62bf364b361c0b17b1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f30353864363630392d386239652d613438352d366366342d6231633030323661363062642e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/77a8f75fde50aad341016e62bf364b361c0b17b1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f30353864363630392d386239652d613438352d366366342d6231633030323661363062642e6a706567" alt="写真 May 23, 6 59 32 PM.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/058d6609-8b9e-a485-6cf4-b1c0026a60bd.jpeg"></a></p>

<ol>
<li>
<p>選択されたファイルの情報をサーバに送る</p>

<p>このときサーバには画像の種類と大きさだけを送るので、負荷はかからない。</p>
</li>
<li>
<p>サーバがクライアントの認証及びS3へアクセスするためのトークンを発行する</p>

<p>アップロードに必要な、複製不可能な情報（ポリシーとシグニチャ）をその場で作ってクライアントに返す。</p>
</li>
<li>
<p>サーバからもらったポリシーとシグニチャと一緒に選択された画像ファイルをS3に送る</p>

<p>サーバから返された情報を元に画像をS3に直接アップロード。その際S3はユーザのポリシーが有効なものであるか確かめて、ポリシーに違反していなければ画像を受け取る。</p>
</li>
<li><p>アップロードされたファイルのURLを挿入する。</p></li>
</ol>

<h1>
<span id="コード" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>コード</h1>

<h2>
<span id="サーバ" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%90"><i class="fa fa-link"></i></a>サーバ</h2>

<p>上の画像でいうところの (2) のRubyでのサンプル実装です。<br>
<code>policy_document</code>がポリシーの実態で、ここで色々な条件を指定することができます。ここでは画像形式と画像サイズの改ざんをチェックする設定だけを抜き出しています。その他に設定可能な項目は色々あります。詳しくは公式ドキュメントを参照してください。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">S3_BUCKET</span> <span class="o">=</span> <span class="s1">'xxx'</span>
<span class="no">AWS_SECRET_KEY</span> <span class="o">=</span> <span class="s1">'xxx'</span>
<span class="no">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="s1">'xxx'</span>

<span class="c1"># アクセスしてきたクライアントにS3へアップロードするためのpolicyと</span>
<span class="c1"># それをハッシュ化したsignatureを返す。</span>
<span class="k">def</span> <span class="nf">policies</span>
  <span class="c1"># 0. セッションの確認など</span>

  <span class="c1"># 1. 画像情報をバリデーションする</span>
  <span class="c1"># ファイルサイズは大き過ぎないか、種類は適切か、など。</span>

  <span class="c1"># 2. policyを作る</span>
  <span class="c1"># policyで許可した内容しかクライアントはアップロードできなくなる。</span>
  <span class="n">key</span> <span class="o">=</span> <span class="s1">'/path/to/file'</span> <span class="c1"># アップロード先のパス</span>
  <span class="n">policy_document</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">expiration</span><span class="p">:</span> <span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">1</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span><span class="o">.</span><span class="n">utc</span><span class="p">,</span>  <span class="c1"># このポリシーは1分間のみ有効</span>
    <span class="ss">conditions</span><span class="p">:</span> <span class="o">[</span>
      <span class="c1"># アップロード先のS3バケットを指定する</span>
      <span class="p">{</span> <span class="ss">bucket</span><span class="p">:</span> <span class="no">S3_BUCKET</span> <span class="p">},</span>
      <span class="c1"># ファイルのS3上でのパスを指定する。</span>
      <span class="c1"># ワイルドカードも指定できるが、完全一致させておく。</span>
      <span class="p">{</span> <span class="ss">key</span><span class="p">:</span> <span class="n">key</span> <span class="p">},</span>
      <span class="c1"># オプション。クライアントから送られてきたものそのままにする。</span>
      <span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:content_type</span><span class="o">]</span> <span class="p">},</span>
      <span class="c1"># オプション。アップロード可能なファイルのサイズを範囲で指定できる。</span>
      <span class="c1"># クライアントから送られてきたファイルサイズをそのまま指定することで</span>
      <span class="c1"># 1バイトでも大きさの異なるファイルは拒否できる。</span>
      <span class="o">[</span><span class="s1">'content-length-range'</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:size</span><span class="o">]]</span>
    <span class="o">]</span>
  <span class="p">}</span><span class="o">.</span><span class="n">to_json</span>
  <span class="n">policy</span> <span class="o">=</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="n">policy_document</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>

  <span class="c1"># 3. signatureを作る</span>
  <span class="c1"># AWSのシークレットキーとpolicyからsignatureを作る。</span>
  <span class="c1"># signatureはシークレットキーを知っている人しか計算できないので</span>
  <span class="c1"># クライアントがpolicyを改ざんしてもAmazon側がそれを検知できる。</span>
  <span class="n">signature</span> <span class="o">=</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span>
      <span class="no">OpenSSL</span><span class="o">::</span><span class="no">HMAC</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span>
          <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">Digest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">),</span>
          <span class="no">AWS_SECRET_KEY</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>

  <span class="c1"># 4. アップロードに必要な情報をクライアントに返す</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="ss">url</span><span class="p">:</span> <span class="s2">"https://</span><span class="si">#{</span><span class="no">S3_BUCKET</span><span class="si">}</span><span class="s2">.s3.amazonaws.com/"</span><span class="p">,</span>
    <span class="ss">form</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">'AWSAccessKeyId'</span> <span class="o">=&gt;</span> <span class="no">AWS_ACCESS_KEY_ID</span><span class="p">,</span>
      <span class="ss">signature</span><span class="p">:</span> <span class="n">signature</span><span class="p">,</span>
      <span class="ss">policy</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span>
      <span class="ss">key</span><span class="p">:</span> <span class="n">key</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>

<p><code>content-length-range</code>を範囲指定しないことで、例えばサーバには10KBとして申請しておいて、実際は1MBの画像をS3にアップロードするなどの偽装を行えないようにしています。Qiitaではアップロード制限をかけているので、このような実装にしました。</p>

<h2>
<span id="クライアント" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>クライアント</h2>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">fileInput</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'input[type="file"]'</span><span class="p">);</span>
<span class="nx">fileInput</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="c1">// 0. 事前にファイルの大きさや種類をチェックする</span>

  <span class="c1">// 1. サーバからpolicyとsignatureをもらう</span>
  <span class="c1">// 上図でいう(1)に対応</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s1">'/policies'</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">'POST'</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
      <span class="c1">// サーバにこれからアップロードするファイルの情報を渡す。</span>
      <span class="nx">size</span><span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>  <span class="c1">// ファイルの大きさ</span>
      <span class="nx">content_type</span><span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">type</span>  <span class="c1">// ファイルの形式</span>
    <span class="p">}</span>
  <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 2. サーバが返した情報をそのまま使ってFormDataを作る</span>
    <span class="kd">var</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">data</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">form</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'file'</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span> <span class="c1">// ファイルも忘れずに添付する</span>

    <span class="c1">// 送信</span>
   <span class="c1">// 上図でいう(3)に対応</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fd</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">});</span>
</pre></div></div>

<p>ここで味噌なのはサーバから返したデータをそのままコピペしている点です。画像アップロードはKobitoからも行えるようになっていますが、Webサービスとして提供しているQiitaとは異なり、デスクトップアプリケーションであるKobitoは何か問題があっても直ぐにはコードを変更できません。ここでやっているようにすることで、将来的にS3の仕様が万が一変更になっても、サーバ側で対応するだけで仕様変更に対応することができて嬉しいですね。</p>

<h2>
<span id="参考サイト" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%82%B5%E3%82%A4%E3%83%88"><i class="fa fa-link"></i></a>参考サイト</h2>

<ul>
<li><a href="http://aws.amazon.com/articles/1434/" rel="nofollow noopener" target="_blank">Browser Uploads to S3 using HTML POST Forms</a></li>
<li><a href="http://qiita.com/ms2sato/items/f73a02f2ac14361247c3" id="reference-4a981096f4fb7875b2d6">S3へ直接ファイルをアップロードする。Node.js版 - Qiita</a></li>
<li><a href="http://qiita.com/supertaihei02/items/a4f663d837e51f2f72b0" id="reference-a006591a1ca41c4e8982">S3に直接ファイルアップロード（jquery+PHP版） - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />11位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>322</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/726a67d8ae74eea2540a">HTMLのアウトライン意識してますか？ - QiitaのSEO事情（前編）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-17 17:13:22</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> <b>[HTML5]</b> <b>[SEO]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>「最近Qiitaを検索結果でよく見るようになったなぁ」と感じる人はいませんか？</p>

<p>SEOを頑張ってるWebサービスは数多存在しますが、Qiitaもその中の1つです。</p>

<p>SEOっていうとやれキーワードがどうだこうだ、サイト内リンクがどうだこうだ、という話になってしまいがちですが（そういうのが不要と言っているわけではないですよ）、今回はQiitaがSEOの一環として行なっている数多の取り組みの中で、比較的Web上での言及数の少ない印象のある、HTMLのマークアップについて、外に出せる範囲で、前編と後編に分けて解説したいと思います。</p>

<p><a href="http://qiita.com/yuku_t/items/3740cc9a5f8503693bd2" id="reference-e91eef873e2c5e43ecb1">後編はこちら</a></p>

<h2>
<span id="免責事項的な" class="fragment"></span><a href="#%E5%85%8D%E8%B2%AC%E4%BA%8B%E9%A0%85%E7%9A%84%E3%81%AA"><i class="fa fa-link"></i></a>免責事項的な</h2>

<p>SEOというのは完全に結果論でしか語ることのできないものです。また時と共に効果的とされるテクニックは変わっていきます。この記事はQiitaの中の人が「効果あるんちゃうか」と試行錯誤しながらあれこれ行なっていることの一部を紹介するものであって、その効果を保証するものではありません。「ふーんそんなことやってるんだ」程度の気分で読んでください。</p>

<h1>
<span id="アウトラインとは何か" class="fragment"></span><a href="#%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>アウトラインとは何か</h1>

<p>アウトラインは（大雑把に言えば）機械から見たあなたのページの構造です。</p>

<p>つまりアウトラインが美しいページは、検索エンジンにより正しく解釈してもらいやすい、と言えそうです。適切に解釈してもらえれば、より適切なユーザに提示してもらえるようになりますね。</p>

<p>もし、なんでもかんでも検索ページに載りさえすればいい、と考えているのだとしたら、恐らくそれは間違いです。少なくともGoogleはユーザが検索結果をクリックしてから検索ページへ戻ってくる時間を計測してるはずです。不適当な相手に表示さると、それがまわりまわって検索順位の低下という形で帰ってくる可能性があるわけです。</p>

<h1>
<span id="何はともあれアウトラインを確認してみる" class="fragment"></span><a href="#%E4%BD%95%E3%81%AF%E3%81%A8%E3%82%82%E3%81%82%E3%82%8C%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>何はともあれアウトラインを確認してみる</h1>

<ul>
<li><a href="http://gsnedders.html5.org/outliner/" rel="nofollow noopener" target="_blank">HTML5 Outliner</a></li>
</ul>

<p>アウトラインを解析できるサイトです。HTML直接渡すだけでなく、URLを指定して解析させることもできます。</p>

<p>試しに気になるサイトのアウトラインを確認してみましょう。例えばナナピはアウトラインが綺麗です。</p>

<h2>
<span id="アウトラインの決まり方" class="fragment"></span><a href="#%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AE%E6%B1%BA%E3%81%BE%E3%82%8A%E6%96%B9"><i class="fa fa-link"></i></a>アウトラインの決まり方</h2>

<p>解説しているサイトはたくさんあるので、適当にググってください。大雑把に言えば <code>section</code> や <code>h1</code> 要素が存在すると新しくアウトラインが作られます。</p>

<p>詳しい仕様は下記で読めます。</p>

<ul>
<li><a href="http://www.html5.jp/tag/elements/headings-and-sections.html#outlines" rel="nofollow noopener" target="_blank">見出しとセクション - セクション - HTML要素 - HTML5 タグリファレンス - HTML5.JP</a></li>
</ul>

<h1>
<span id="アウトラインが綺麗なhtmlを書くコツ" class="fragment"></span><a href="#%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%8C%E7%B6%BA%E9%BA%97%E3%81%AAhtml%E3%82%92%E6%9B%B8%E3%81%8F%E3%82%B3%E3%83%84"><i class="fa fa-link"></i></a>アウトラインが綺麗なHTMLを書くコツ</h1>

<p>アウトラインを意識しようにもデザインの関係もあってなかなか綺麗にできないかも知れません。<br>
そういう場合は先にアウトラインを決めてしまってから、デザイン用の <code>div</code> や <code>span</code> 要素を付け足していく、という手順を踏むといいです。</p>

<h2>
<span id="まず最初に綺麗なアウトラインを作ってしまう" class="fragment"></span><a href="#%E3%81%BE%E3%81%9A%E6%9C%80%E5%88%9D%E3%81%AB%E7%B6%BA%E9%BA%97%E3%81%AA%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%97%E3%81%BE%E3%81%86"><i class="fa fa-link"></i></a>まず最初に綺麗なアウトラインを作ってしまう</h2>

<p>HTML5にしろ、それ以前にしろ、アウトラインに影響を与えるタグと与えないタグというのは明確です。なので、まず先にアウトラインに影響を与える要素だけを並べて、理想的なアウトラインを書いてみましょう。</p>

<p>例えばこんな感じに書いたとします。（便宜上 <code>body</code> タグとかは省略してます）</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>サイト名<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>タイトル<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>見出し<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>見出し2<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>コメント<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- コメント --&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>投稿者情報<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</pre></div></div>

<p>できあがったHTMLのアウトラインを確認してみます。先ほどのサイトを開いて作ったHTMLをコピペして解析してみます。上記のHTMLの場合は次のように返されます</p>

<blockquote>
<ol>
<li>サイト名

<ol>
<li>タイトル

<ol>
<li>見出し

<ol>
<li>見出し2</li>
</ol>
</li>
</ol>
</li>
<li>コメント

<ol>
<li><em>Untitled Section</em></li>
</ol>
</li>
<li>投稿者情報</li>
</ol>
</li>
</ol>
</blockquote>

<p>おかしいなと思う箇所があったら試行錯誤をして綺麗に整えましょう。もちろんこのあとのデザインのことも考えて、要素の順番を入れ替えるとかはしても良いと思います。</p>

<h2>
<span id="schemaorg" class="fragment"></span><a href="#schemaorg"><i class="fa fa-link"></i></a>schema.org</h2>

<p>そうしたら次は（余裕があれば）schema.orgに従ったマークアップを行なっていきます。これも細々したデザインの調整を行う前にやってしまう方がいいと感じています。</p>

<p>schema.orgについて詳しくは次回の <a href="http://qiita.com/yuku_t/items/3740cc9a5f8503693bd2">schema.orgに準拠してクローラと会話しよう</a> を参照してください。</p>

<h2>
<span id="アウトラインに影響しないタグを書いていく" class="fragment"></span><a href="#%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AB%E5%BD%B1%E9%9F%BF%E3%81%97%E3%81%AA%E3%81%84%E3%82%BF%E3%82%B0%E3%82%92%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%84%E3%81%8F"><i class="fa fa-link"></i></a>アウトラインに影響しないタグを書いていく</h2>

<p>そうしたらコンテンツに肉をつけて行きましょう。ここから先で書いていくのは全てアウトラインに影響しない要素なので、先ほど作ったアウトラインは綺麗なまま保たれるはずです。</p>

<p>アウトラインが綺麗になっていると <code>section</code> タグなどにそのままCSSを当てれば、わざわざ <code>div</code> とかいれなくても大丈夫、という場合もあるかと思います。<br>
しかし、そういう場合でも <code>section</code> にCSSを当てずに、それをラップする <code>div</code> を作ってそれにclassやidを振って、CSSのルールを書いた方がいいでしょう。</p>

<p>何故かというと、アウトラインに比べてデザインの方が寿命が短いからです。</p>

<p><code>section</code> にCSSを書いていると、アウトラインと実際の見た目の結合度が高くなります。その結果として、ちょっとしたデザイン変更のときについでにアウトラインが崩れる、みたいなことが起こったりします。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<ul>
<li>アウトラインは機械からどう見えるかを示すものです。検索エンジンに正しく理解してもらうためにも、余裕があるなら綺麗にしましょう。</li>
<li>アウトラインは一番最初に整えましょう。</li>
</ul>

<h1>
<span id="qiitaのseo事情" class="fragment"></span><a href="#qiita%E3%81%AEseo%E4%BA%8B%E6%83%85"><i class="fa fa-link"></i></a>QiitaのSEO事情</h1>

<ol>
<li>HTMLのアウトライン意識してますか？</li>
<li><a href="http://qiita.com/yuku_t/items/3740cc9a5f8503693bd2">schema.orgに準拠してクローラと会話しよう</a></li>
</ol>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />12位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>312</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/3740cc9a5f8503693bd2">schema.orgに準拠してクローラと会話しよう - QiitaのSEO事情（後編）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-17 17:13:35</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> <b>[HTML5]</b> <b>[SEO]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://qiita.com/yuku_t/items/726a67d8ae74eea2540a" id="reference-3319283d9052e6a40926">前編</a>ではHTML5のアウトラインを綺麗にする、というお話でした。アウトラインを綺麗にすれば、検索エンジンにコンテンツの階層構造がどうなっているのか、正しく教えることができます。</p>

<p>けどそれだけでは1つ1つのまとまりが一体何を表しているのかが不明です。</p>

<p>schema.orgに準拠することで、そこに何が書かれているのか、を検索エンジンに教えることができます。</p>

<h1>
<span id="schemaorgとは" class="fragment"></span><a href="#schemaorg%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>schema.orgとは</h1>

<p><a href="http://schema.org" rel="nofollow noopener" target="_blank">schema.org</a> はGoogle, Microsoft, Yahoo!などの検索エンジンベンダーが集まってマークアップ方式を標準化している組織とその標準化された仕様を文書化しているサイトです。</p>

<p>例えば「ここは著者のことを書いています」「これは著者の名前です」「この記事が公開されたのはこの日時です」などなど、HTMLの機能だけでは伝えきれない詳細な情報をクローラに伝えるための手段が色々定義されています。</p>

<p>ちなみにschema.orgで定義されている語彙は全てmicrodataという方式が使われています。microdataという書き方に、Googleなどがルールを与えたものがschema.orgなわけです。</p>

<h2>
<span id="なぜqiitaはschemaorgに準拠したか" class="fragment"></span><a href="#%E3%81%AA%E3%81%9Cqiita%E3%81%AFschemaorg%E3%81%AB%E6%BA%96%E6%8B%A0%E3%81%97%E3%81%9F%E3%81%8B"><i class="fa fa-link"></i></a>なぜQiitaはschema.orgに準拠したか</h2>

<p>やるからには効果が無きゃ困る訳ですが、Googleが提供しているツールを観察してみる限り、少なくともGoogleはschema.orgに準拠したマークアップを理解していることが分かります。</p>

<p>前回の<a href="http://qiita.com/yuku_t/items/726a67d8ae74eea2540a">QiitaのSEO事情 - HTMLのアウトライン意識してますか？</a>でも言及したように、正しく検索エンジンに解釈されることがまわりまわって検索順位の向上に寄与すると考えているため、schema.orgに準拠することにしました。</p>

<p>また、検索順位というのは相対評価で決まるものです。他のサイトがやっていないことをすることに価値があるんじゃないか、と考えたというのもあります。</p>

<h1>
<span id="マークアップする" class="fragment"></span><a href="#%E3%83%9E%E3%83%BC%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>マークアップする</h1>

<p>では実際にschema.orgに準拠したマークアップを行なってましょう。</p>

<h2>
<span id="itemscopeとitemtype" class="fragment"></span><a href="#itemscope%E3%81%A8itemtype"><i class="fa fa-link"></i></a>itemscopeとitemtype</h2>

<p>例えばQiitaの記事には著者情報を表した箇所があります。ここには著者名と自己紹介が書かれています。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>著者情報<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>yuku_t<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>自己紹介<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</pre></div></div>

<p>ここが著者に関することを書いていると明示するために、まず <code>itemscope</code> 属性をその情報を囲っている要素に加えます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">section</span> <span class="na">itemscope</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>著者情報<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>yuku_t<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>自己紹介<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</pre></div></div>

<p><code>itemscope</code> を加えることで <code>&lt;section&gt;…&lt;/section&gt;</code> が何かしらの項目についてのものであることが表明されます。</p>

<p>これでは何に関する情報化が分かりません。これが何について表しているのか <code>itemtype</code> 属性を <code>itemscope</code> 属性の直後に置くことで表明できます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">section</span> <span class="na">itemscope</span> <span class="na">itemtype</span><span class="o">=</span><span class="s">"http://schema.org/Person"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>著者情報<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>yuku_t<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>自己紹介<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</pre></div></div>

<p>これでこれがschema.orgで定義されている <code>Person</code> について記述している箇所だということが表現できました。タイプはURLを使って指定します。今回の場合だと <code>http://schema.org/Person</code> です。</p>

<h2>
<span id="itemprop" class="fragment"></span><a href="#itemprop"><i class="fa fa-link"></i></a>itemprop</h2>

<p><code>Person</code> には名前や詳細などのプロパティを持ちます。これを指定するには <code>itemprop="name"</code> を名前をマークアップしている要素に加えます。（指定できるプロパティは <code>itemtype</code> で指定したURLで知ることができます。今回の場合なら <a href="http://schema.org/Person" class="autolink" rel="nofollow noopener" target="_blank">http://schema.org/Person</a> です。）</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">section</span> <span class="na">itemscope</span> <span class="na">itemtype</span><span class="o">=</span><span class="s">"http://schema.org/Person"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>著者情報<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"name"</span><span class="p">&gt;</span>yuku_t<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"description"</span><span class="p">&gt;</span>自己紹介<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="入れ子にする" class="fragment"></span><a href="#%E5%85%A5%E3%82%8C%E5%AD%90%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>入れ子にする</h2>

<p>プロパティの中にはそれ自体が一つの項目になれるものがあります。</p>

<p>QiitaではユーザはOrganizationに所属することができます。ある要素が他の項目を表すことを表明するには <code>itemscope</code> を <code>itemprop</code> の直後に置きます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">section</span> <span class="na">itemscope</span> <span class="na">itemtype</span><span class="o">=</span><span class="s">"http://schema.org/Person"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>著者情報<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"name"</span><span class="p">&gt;</span>yuku_t<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"description"</span><span class="p">&gt;</span>自己紹介<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"memberOf"</span> <span class="na">itemscope</span> <span class="na">itemtype</span><span class="o">=</span><span class="s">"http://schema.org/Organization"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"name"</span><span class="p">&gt;</span>Increments.inc<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
</pre></div></div>

<p>ここでは <code>Person</code> の <code>memberOf</code> プロパティに <code>Organization</code> が指定されています。これでyuku_tという <code>name</code> の <code>Person</code> がIncrements.incという <code>name</code> の <code>Organization</code> の <code>memberOf</code> である、という情報を表すとができました。</p>

<p><code>memberOf</code> に <code>Organization</code> を指定できることは <a href="http://schema.org/Person" class="autolink" rel="nofollow noopener" target="_blank">http://schema.org/Person</a> の <code>memberOf</code> のExpected Typeで知ることができます。</p>

<h1>
<span id="itemtypeの種類" class="fragment"></span><a href="#itemtype%E3%81%AE%E7%A8%AE%E9%A1%9E"><i class="fa fa-link"></i></a>itemtypeの種類</h1>

<ul>
<li><a href="http://schema.org/docs/full.html" rel="nofollow noopener" target="_blank">Full Hierarchy - schema.org</a></li>
</ul>

<p><code>itemtype</code> に指定できるタイプはクラス継承のように、階層構造になっています。一番上が <code>Thing</code> です。</p>

<p>先ほど <code>memberOf</code> には <code>Organization</code> を指定できると言いましたが、 <code>Organization</code> を継承したタイプ、例えば <code>Corporation</code> や <code>Hospital</code> など、も指定することが可能です。</p>

<p>実に様々なタイプが定義されているので、必要に応じて選択しましょう。</p>

<h1>
<span id="プロパティが画面に現れない場合" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%81%8C%E7%94%BB%E9%9D%A2%E3%81%AB%E7%8F%BE%E3%82%8C%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>プロパティが画面に現れない場合</h1>

<p>デザインの関係上、必ずしもプロパティが画面に現れるとは限りません。例えばユーザアイコンは表示するけど、名前は表示しないような場合です。こういう場合は <code>meta</code> か <code>link</code> 要素を使います。値がURLなら <code>link</code> 単なる文字列なら <code>meta</code> になります。</p>

<div class="code-frame" data-lang="html+erb"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"url"</span> <span class="na">href</span><span class="o">=</span><span class="s">"/yuku_t"</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"name"</span> <span class="na">content</span><span class="o">=</span><span class="s">"yuku_t"</span> <span class="p">/&gt;</span>
</pre></div></div>

<h1>
<span id="マークアップ時に意識すること" class="fragment"></span><a href="#%E3%83%9E%E3%83%BC%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E6%99%82%E3%81%AB%E6%84%8F%E8%AD%98%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>マークアップ時に意識すること</h1>

<p>schema.orgの「<a href="http://schema.org/docs/gs.html" rel="nofollow noopener" target="_blank">Get started with schema.org</a>」というドキュメントに、<a href="http://schema.org/docs/gs.html#schemaorg_expected" rel="nofollow noopener" target="_blank">schema.orgに準拠してマークアップするときに注意すること</a>が書かれているので、軽く紹介します。</p>

<h2>
<span id="hiddenな文書をマークアップしない" class="fragment"></span><a href="#hidden%E3%81%AA%E6%96%87%E6%9B%B8%E3%82%92%E3%83%9E%E3%83%BC%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>hiddenな文書をマークアップしない</h2>

<p>一般的に適切にマークアップしているなら、多いければ多いほどよいと言えますが、それは見える要素のみです。言明はされていませんが、schema.orgはhiddenな文書にマークアップするとペナルティが課されると暗にほのめかしています。</p>

<h2>
<span id="expected-typeの代わりにテキストでも問題ない" class="fragment"></span><a href="#expected-type%E3%81%AE%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%AB%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%81%A7%E3%82%82%E5%95%8F%E9%A1%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>Expected Typeの代わりにテキストでも問題ない</h2>

<p><code>memberOf</code> のExpected Typeは <code>Organization</code> ですが、これは別に必須というわけではありません。 <code>itemscope</code> にせず、単なるテキストやURLでも問題ありません。</p>

<h2>
<span id="urlプロパティを使う" class="fragment"></span><a href="#url%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>urlプロパティを使う</h2>

<p>他のページへのリンクがあって、そのリンク先が1つの項目を表しているなら、そのリンクには <code>itemprop="url"</code> をつけましょう。勿論そのリンク自体が <code>itemscope</code> に包含されていなければなりません。</p>

<h1>
<span id="マークアップを確認してみる" class="fragment"></span><a href="#%E3%83%9E%E3%83%BC%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>マークアップを確認してみる</h1>

<p>schema.orgに対応したマークアップをしてみたら、Googleが専用のツールを提供してくれているので、それが正しく書けているのか確かめましょう。</p>

<ul>
<li><a href="http://www.google.com/webmasters/tools/richsnippets" rel="nofollow noopener" target="_blank">Google Structured Data Testing Tool</a></li>
</ul>

<p>確認したいページのURLを指定するか、HTMLを貼り付けてるか、の２通りの検査方法があります。</p>

<ul>
<li>サンプル：<a href="http://www.google.com/webmasters/tools/richsnippets?q=http%3A%2F%2Fqiita.com%2Fyuku_t%2Fitems%2F3740cc9a5f8503693bd2" rel="nofollow noopener" target="_blank">このページの解析結果</a>
</li>
</ul>

<p>上記のリンク先をみると、検索スニペットのサンプルに続いて、Personがどうたらこうたら、Articleがどうたらこうたらと出てくると思います。このような記述が意図した通りに出現していればOKです。</p>

<p>ちなみに、開発時はHTMLを貼り付けて確認することになると思いますが、なぜかHTML貼り付けだと後述するパンくずが検索スニペットのサンプルで適切に反映されないです。訝しみつつそのままデプロイしてみたらパンくずとして認識するようになったので、パンくずを設定するときは注意してください。（単なる勘違いの可能性もあります）</p>

<h1>
<span id="おまけ存在しないパンくずを認識させる" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91%E5%AD%98%E5%9C%A8%E3%81%97%E3%81%AA%E3%81%84%E3%83%91%E3%83%B3%E3%81%8F%E3%81%9A%E3%82%92%E8%AA%8D%E8%AD%98%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>おまけ：存在しないパンくずを認識させる</h1>

<p>Qiitaの投稿ページがGoogle検索にひっかかるとこんな感じになってますよね。</p>

<p><a href="https://camo.qiitausercontent.com/a181b31dea4352e1e7c84baf358c9166c8d693a8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f66323436363266332d306636612d373331632d313339612d6239373434346663656338642e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a181b31dea4352e1e7c84baf358c9166c8d693a8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f66323436363266332d306636612d373331632d313339612d6239373434346663656338642e706e67" alt="Screen_Shot_2013-07-17_at_12.28.24_AM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/f24662f3-0f6a-731c-139a-b97444fcec8d.png"></a></p>

<p>SEOに効果があるのか分かりませんが、検索結果にパンくずを表示させることができます。パンくずとは何か、というのは適当にググってください。あと、これを表示する方法は公式ドキュメント（<a href="https://support.google.com/webmasters/answer/185417?hl=ja" rel="nofollow noopener" target="_blank">リッチ スニペット - パンくずリスト - ウェブマスター ツール ヘルプ</a>）を参照してください。</p>

<p>QiitaはURL構造が階層構造になっているので、ページにはパンくずが表示されていませんが、検索結果にはそれを反映させるようにしています。同様にデザインにはパンくずがないけど検索結果には表示させたい、という場合は、前述の「プロパティが画面に現れない場合」と組み合わせて次のように書きます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">span</span> <span class="na">itemscope</span> <span class="na">itemtype</span><span class="o">=</span><span class="s">"http://data-vocabulary.org/Breadcrumb"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"url"</span> <span class="na">href</span><span class="o">=</span><span class="s">"/yuku_t"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"title"</span> <span class="na">content</span><span class="o">=</span><span class="s">"yuku_t"</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">span</span> <span class="na">itemscope</span> <span class="na">itemtype</span><span class="o">=</span><span class="s">"http://data-vocabulary.org/Breadcrumb"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"url"</span> <span class="na">href</span><span class="o">=</span><span class="s">"/yuku_t/items"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">itemprop</span><span class="o">=</span><span class="s">"title"</span> <span class="na">content</span><span class="o">=</span><span class="s">"items"</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</pre></div></div>

<p>ここで使っているのがschema.orgではなくdata-vocabulary.orgであることに注意が必要です。</p>

<p>data-vocabulary.orgはschema.orgの前身となった（？）サイトで、現在ではそのほとんどがschema.orgに引き継がれていますが、少なくともこの <code>Breadcrumb</code> typeに関しては、Googleの公式ドキュメントでもそうしているように、data-vocabulary.orgで定義されているものを使わなければなりません。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<ul>
<li>結構面倒なので、検索流入が重要なページだけやれば十分だし、余裕が無いならやらなくてもいい。</li>
<li>でもやったら何かいいことがありそうな予感する。とりあえず無駄にはならないはず。</li>
</ul>

<h1>
<span id="qiitaのseo事情" class="fragment"></span><a href="#qiita%E3%81%AEseo%E4%BA%8B%E6%83%85"><i class="fa fa-link"></i></a>QiitaのSEO事情</h1>

<ol>
<li><a href="http://qiita.com/yuku_t/items/726a67d8ae74eea2540a">HTMLのアウトライン意識してますか？</a></li>
<li>schema.orgに準拠してクローラと会話しよう</li>
</ol>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />13位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>311</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/fb92e173120d7b2e49ed">GitHubのようなtextareaの補完機能を実装する - カーソル位置の取得</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-04-15 15:39:34</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> <b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://camo.qiitausercontent.com/af2bd0d5de2a6ace7fca3b986ed51d914501f229/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303431352f32303133303431353132353432312e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/af2bd0d5de2a6ace7fca3b986ed51d914501f229/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303431352f32303133303431353132353432312e676966" alt="mention autocomplete" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20130415/20130415125421.gif"></a></p>

<p>続編 <a href="http://qiita.com/yuku_t/items/7ddcc842d3d8f6a9fcd5" id="reference-a6ea91a91515110db57c">JavaScript - Qiitaのtextarea自動補完がOSSになりました</a></p>

<p>GitHubのコメントでは@と入力するとカーソルの下に入力補完が出現する。さらっとやっているが、実はこれが結構難しい。なぜ難しいのかというと、JavaScriptではカーソルが何文字目にいるかは分かるが、 <strong>カーソルのXY座標を取得するAPIが存在しない</strong> からだ。カーソル位置が分からなければ、適切な位置に補完候補を表示することができない。では一体どうすればいいのか？</p>

<p><a href="http://blog.qiita.com/post/48026202087/mention-autocomplete" rel="nofollow noopener" target="_blank">今回Qiitaではコメント欄でのメンションの補完機能を実装した。</a>本稿では前述の問題を解決するために用いたテクニックを解説する。</p>

<p>ちなみにこのメンション補完機能はチーム用プライベートQiitaである「<a href="https://teams.qiita.com/" rel="nofollow noopener" target="_blank">Qiita:Team</a>」でも勿論使える。現在絶賛無料トライアル実施中なので、興味を持たれた方はそちらも使ってみて欲しい。</p>

<h1>
<span id="要約" class="fragment"></span><a href="#%E8%A6%81%E7%B4%84"><i class="fa fa-link"></i></a>要約</h1>

<p>textarea内でのカーソル位置を計算するには...</p>

<ul>
<li>ダミーのdiv要素を画面外に作り、textarea要素のスタイルを模倣する</li>
<li>先頭からカーソルまでの文字列をコピーし、div要素に挿入する</li>
<li>末尾にspan要素を追加し、そのspan要素のdiv要素内での相対位置を計算する</li>
</ul>

<p>ただしこれはカーソル位置を計算する唯一の方法ではなく、他にも方法は考えられる。</p>

<h2>
<span id="この記事を読むと分かること" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%80%E3%81%A8%E5%88%86%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事を読むと分かること</h2>

<ul>
<li>textarea内でのカーソルの相対位置を計算する方法</li>
</ul>

<h2>
<span id="この記事を読んでも分からないこと" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A7%E3%82%82%E5%88%86%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事を読んでも分からないこと</h2>

<ul>
<li>補完メニューを良い感じの場所に設置する方法</li>
<li>補完メニューの実装方法</li>
</ul>

<h1>
<span id="カーソルのxy座標を計算する" class="fragment"></span><a href="#%E3%82%AB%E3%83%BC%E3%82%BD%E3%83%AB%E3%81%AExy%E5%BA%A7%E6%A8%99%E3%82%92%E8%A8%88%E7%AE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>カーソルのXY座標を計算する</h1>

<p>カーソルの下に補完メニューを表示するには、カーソルのXY座標が分からなければならない。だが、冒頭でも述べたようにJavaScriptにはカーソルのXY座標を取得するAPIが存在しない。そのため、何かしらの方法を用いて自ら計算方法を実装しなければならない。</p>

<p>結論から言えば、カーソル位置はtextareaのスタイルと、カーソルの前にどのような文字列が存在するかによって決定される。つまり、これらを完全に模倣してやればいいわけだ。</p>

<h2>
<span id="カーソルが何文字目にいるか取得する" class="fragment"></span><a href="#%E3%82%AB%E3%83%BC%E3%82%BD%E3%83%AB%E3%81%8C%E4%BD%95%E6%96%87%E5%AD%97%E7%9B%AE%E3%81%AB%E3%81%84%E3%82%8B%E3%81%8B%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>カーソルが何文字目にいるか取得する</h2>

<p>カーソルが何文字目にいるかを取得するAPIは、モダンなブラウザであればtextareaの<code>selectionStart</code>もしくは<code>selectionEnd</code>で取得できる。これらは基本的に同じ値が格納されており、ドラッグして範囲を選択した場合のみ値が変わる。名前からも分かるように<code>selectionStart</code>から<code>selectionEnd</code>までがドラッグされているわけだ。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">textarea内でカーソルが何文字目にいるか</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">textarea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">'textarea'</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">start</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">selectionStart</span><span class="p">;</span>
</pre></div>
</div>

<p><code>selectionEnd</code>が実装されていないようなブラウザもサポートするには、もっと込み入った処理が必要になる。この点については<a href="http://stackoverflow.com/a/263796" rel="nofollow noopener" target="_blank">StackOverflowのこの解答</a>が詳しい。</p>

<h2>
<span id="先頭からカーソル位置までの文字列を取得する" class="fragment"></span><a href="#%E5%85%88%E9%A0%AD%E3%81%8B%E3%82%89%E3%82%AB%E3%83%BC%E3%82%BD%E3%83%AB%E4%BD%8D%E7%BD%AE%E3%81%BE%E3%81%A7%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>先頭からカーソル位置までの文字列を取得する</h2>

<p>カーソルが何文字目にいるかを取得する<code>getCaret</code>関数が実装できたとする。先頭からカーソル位置までの文字列を取得するコードは次のようになる。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">textareaの先頭からカーソル位置までの文字列を取得する</span></div>
<div class="highlight"><pre><span></span><span class="c1">// 先頭からカーソル位置までを取得する</span>
<span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">getCaret</span><span class="p">(</span><span class="nx">textarea</span><span class="p">));</span>
</pre></div>
</div>

<p>これでカーソル位置の計算に必要なtextarea要素内の文字列を取り出すことができるようになった。</p>

<h2>
<span id="textareaを模倣したdiv要素を用意する" class="fragment"></span><a href="#textarea%E3%82%92%E6%A8%A1%E5%80%A3%E3%81%97%E3%81%9Fdiv%E8%A6%81%E7%B4%A0%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>textareaを模倣したdiv要素を用意する</h2>

<p>次に先ほど取得した文字列を入れるための容れ物になるdiv要素を準備する。このとき、この要素がtextareaと同様のスタイルになっていなければ正しくカーソル位置を計算できないことは言うまでもない。</p>

<p>textarea要素からコピーするスタイルは次のものだ（抜けがある可能性もある）。逆に言えば、これらの値が一致していれば中身の文字列の大きさや間隔などが一致することを意味する。</p>

<ul>
<li>border-bottom-width</li>
<li>border-left-width</li>
<li>border-right-width</li>
<li>border-top-width</li>
<li>font-family</li>
<li>font-size</li>
<li>font-style</li>
<li>font-variant</li>
<li>font-weight</li>
<li>height</li>
<li>letter-spacing</li>
<li>word-spacing</li>
<li>line-height</li>
<li>padding-bottom</li>
<li>padding-left</li>
<li>padding-right</li>
<li>padding-top</li>
<li>text-decoration</li>
<li>width</li>
</ul>

<p>加えてdiv要素を画面外に描画しなければならない。これらを実装すると次のようになる。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">textareaのスタイルを模倣したdiv要素を作る</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">i</span><span class="p">,</span>
    <span class="nx">div</span>   <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">),</span>
    <span class="nx">list</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">'border-bottom-width'</span><span class="p">,</span> <span class="s1">'border-left-width'</span><span class="p">,</span> <span class="s1">'border-right-width'</span><span class="p">,</span>
             <span class="s1">'border-top-width'</span><span class="p">,</span> <span class="s1">'font-family'</span><span class="p">,</span> <span class="s1">'font-size'</span><span class="p">,</span> <span class="s1">'font-style'</span><span class="p">,</span>
             <span class="s1">'font-variant'</span><span class="p">,</span> <span class="s1">'font-weight'</span><span class="p">,</span> <span class="s1">'height'</span><span class="p">,</span> <span class="s1">'letter-spacing'</span><span class="p">,</span>
             <span class="s1">'word-spacing'</span><span class="p">,</span> <span class="s1">'line-height'</span><span class="p">,</span> <span class="s1">'padding-bottom'</span><span class="p">,</span> <span class="s1">'padding-left'</span><span class="p">,</span>
             <span class="s1">'padding-right'</span><span class="p">,</span> <span class="s1">'padding-top'</span><span class="p">,</span> <span class="s1">'text-decoration'</span><span class="p">,</span> <span class="s1">'width'</span><span class="p">];</span>

<span class="c1">// 画面外に配置する</span>
<span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">'absolute'</span><span class="p">;</span>
<span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span>     <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">;</span>

<span class="c1">// textareaのスタイルをコピーする</span>
<span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
<span class="p">}</span>

<span class="c1">// divを画面に挿入する</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
</pre></div>
</div>

<h2>
<span id="カーソルまでの文字列とspanを末尾に入れてspanの位置を計算する" class="fragment"></span><a href="#%E3%82%AB%E3%83%BC%E3%82%BD%E3%83%AB%E3%81%BE%E3%81%A7%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97%E3%81%A8span%E3%82%92%E6%9C%AB%E5%B0%BE%E3%81%AB%E5%85%A5%E3%82%8C%E3%81%A6span%E3%81%AE%E4%BD%8D%E7%BD%AE%E3%82%92%E8%A8%88%E7%AE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>カーソルまでの文字列とspanを末尾に入れてspanの位置を計算する</h2>

<p>textareaと同じスタイルのdivが用意できた。あとはカーソルまでの文字列をその中に入れ、それに続くかたちでspanを入れて、その位置を取得するだけだ。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">カーソルの位置を計算する</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'span'</span><span class="p">);</span>
<span class="c1">// spanに大きさをもたせるために適当な文字列を挿入</span>
<span class="nx">span</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'&amp;nbsp;'</span><span class="p">;</span>

<span class="c1">// 文字列を挿入</span>
<span class="nx">div</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
<span class="c1">// スクロール位置を調整</span>
<span class="nx">div</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">div</span><span class="p">.</span><span class="nx">scrollHeight</span><span class="p">;</span>
<span class="c1">// spanを挿入</span>
<span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">span</span><span class="p">);</span>

<span class="c1">// spanの位置を取得。簡単のためにjQueryを使っている</span>
<span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">span</span><span class="p">).</span><span class="nx">position</span><span class="p">();</span>

<span class="c1">// divの左上から見たときの相対位置</span>
<span class="nx">position</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
<span class="nx">position</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
</pre></div>
</div>

<p>ここで得られた<code>position</code>はspanの親要素であるdivからの相対的な位置になっている。そしてこの値はtextareaの左上から見たカーソルの相対位置と等しい。</p>

<h1>
<span id="textareaの補完メニューを実装するには" class="fragment"></span><a href="#textarea%E3%81%AE%E8%A3%9C%E5%AE%8C%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF"><i class="fa fa-link"></i></a>textareaの補完メニューを実装するには</h1>

<p>これでカーソルの位置は取得できるようになった。だが道はまだ半ばだ。実際に動作する補完メニューを実装するにはこのあとさらに次のようなステップを踏むことになる。</p>

<ol>
<li>textareaの内容から検索文字列を検出する</li>
<li>それに対して検索を実行する</li>
<li>補完メニューをカーソルの下に表示する</li>
<li>検索結果を補完メニューに表示する</li>
<li>補完メニューをクリック可能にする</li>
<li>選択された値を用いてtextareaを更新する</li>
</ol>

<p>Qiitaの場合はこれらに加えてさらに</p>

<ul>
<li>コードの中だったら補完メニューを表示しない</li>
<li>キーボードでメニューを選択可能</li>
<li>再利用性を高めるためにBackboneのViewのためのMixinとして実装</li>
</ul>

<p>などを行なっている。</p>

<p>これら残りの工程についてここでは時間の関係上解説しないが、本稿の反響が良ければ書くかも知れない。「残りについても解説記事希望！」という場合は是非ともその旨を、このページの下にあるコメント欄で私にメンションを飛ばして知らせて欲しい。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />14位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>290</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/d69d3a2c7dafa7d04e87">Node書くならEventEmitterについて知っとくべし</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-03-08 10:52:03</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Node.js]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Nodeの組み込みモジュール・サードパーティモジュール問わず広く使われるのが <code>EventEmitter</code> オブジェクト。<br>
これはNodeで使われるデザインパターンの筆頭みたいなものなので、知っておかねばならない。</p>

<p>ドキュメント: <a href="http://nodejs.org/api/events.html" rel="nofollow noopener" target="_blank">Events</a></p>

<p>ブラウザ上のJavaScriptで <code>addEventListener</code> を使ってイベントドリブンの開発を行うが、Node上でそれを行うのための機能を提供するのが <code>EventEmitter</code>。<br>
例えば次のように使う</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'events'</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">asyncFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ev</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'in asyncFunc'</span><span class="p">);</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'done'</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">);</span>
  <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">ev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">asyncFunc</span><span class="p">();</span>
<span class="nx">async</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'done'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">);</span>
<span class="p">})</span>
</pre></div></div>

<p>これを実行すると <code>in asyncFunc</code> と表示された1秒後に <code>foo bar</code> と表示される。</p>

<p>Nodeを使うと非同期処理が多くなるが、コールバックを受け取る設計では、複数の関数を実行したい時面倒くさい。<br>
そこでコールバックを受け取る代わりに <code>EventEmitter</code> を返すようにする。一回だけしか実行されないなら <code>once</code> を使うといい。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">ev</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">;</span>

<span class="nx">ev</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'on'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);});</span>
<span class="nx">ev</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'once'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);});</span>

<span class="nx">ev</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="c1">// =&gt; on 1</span>
<span class="c1">// =&gt; once 1</span>
<span class="nx">ev</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="c1">// =&gt; on 2</span>
<span class="c1">// once は実行されない</span>
</pre></div></div>

<p>組み込みモジュールで <code>EventEmitter</code> を使っているものは非常に多い。非同期処理がからむモジュールは基本的にみな使っていると言って過言でない。<br>
サードパーティだと例えば <a href="http://socket.io" rel="nofollow noopener" target="_blank">Socket.IO</a> が同様のインタフェースを用いている。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />15位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>267</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/7ddcc842d3d8f6a9fcd5">Qiitaのtextarea自動補完がOSSになりました</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-02 10:06:21</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://github.com/yuku-t/jquery-textcomplete" rel="nofollow noopener" target="_blank">jQuery.textcomplete</a>（<a href="http://yuku-t.com/jquery-textcomplete" rel="nofollow noopener" target="_blank">デモ</a>）</p>

<p><a href="https://camo.qiitausercontent.com/a651a973aef814a006c3f2bd1fcd28646f056cfa/68747470733a2f2f6769746875622e636f6d2f79756b752d742f6a71756572792d74657874636f6d706c6574652f7261772f67682d70616765732f2f6d656469612f696d616765732f64656d6f2e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a651a973aef814a006c3f2bd1fcd28646f056cfa/68747470733a2f2f6769746875622e636f6d2f79756b752d742f6a71756572792d74657874636f6d706c6574652f7261772f67682d70616765732f2f6d656469612f696d616765732f64656d6f2e676966" alt="demo" data-canonical-src="https://github.com/yuku-t/jquery-textcomplete/raw/gh-pages//media/images/demo.gif"></a></p>

<p><a href="http://qiita.com/yuku_t/items/fb92e173120d7b2e49ed" id="reference-c2f2b74b4006531a13d5">GitHubのようなtextareaの補完機能を実装する - カーソル位置の取得</a> を書いたのも今は昔、いつか続きを書こう書こうと思いながら気がつけば5ヶ月が過ぎました <img alt=":bow:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png" title=":bow:" width="20"></p>

<p>なんか続きを書くのが面倒くさくなったのと、某日本最大レシピ共有サイトの技術部長の人から「OSSにして欲しい」という要請を人伝に受け取ったこともあって、OSS化した次第です。</p>

<h1>
<span id="ライセンス" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>ライセンス</h1>

<p>MITライセンス</p>

<h1>
<span id="簡単な使い方" class="fragment"></span><a href="#%E7%B0%A1%E5%8D%98%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>簡単な使い方</h1>

<p>簡単に説明します。詳しくは <a href="https://github.com/yuku-t/jquery-textcomplete/blob/gh-pages/README.md" rel="nofollow noopener" target="_blank">README</a> を読んでください。</p>

<p>まず jQuery.textcomplete は名前からも分かるように jQuery プラグインになっているので、別途 jQuery が必要です。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"path/to/jquery.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"path/to/jquery.textcomplete.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>TEXTAREA 要素の jQuery オブジェクトに対して <code>textcomplete</code> メソッドを実行します。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'textarea'</span><span class="p">).</span><span class="nx">textcomplete</span><span class="p">({</span>
    <span class="c1">// mentionは単なる名前で意味はありません。</span>
    <span class="c1">// 分かりやすい名前をつけてください。</span>
    <span class="nx">mention</span><span class="o">:</span> <span class="p">{</span>
        <span class="c1">// 必須設定</span>
        <span class="nx">match</span><span class="o">:</span> <span class="sr">/(^|\s)@(\w*)$/</span><span class="p">,</span>
        <span class="nx">search</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">term</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// callback には文字列の配列を渡す</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">'/search'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">q</span><span class="o">:</span> <span class="nx">term</span> <span class="p">})</span>
                <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span> <span class="p">})</span>
                <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span>     <span class="p">{</span> <span class="nx">callback</span><span class="p">([]);</span>   <span class="p">});</span>
        <span class="p">},</span>
        <span class="nx">replace</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">'$1@'</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="s1">' '</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="c1">// 任意設定（下記はいずれもデフォルト値）</span>
        <span class="nx">index</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">maxCount</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="nx">template</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="c1">// 複数設定することもできます</span>
    <span class="nx">emoji</span><span class="o">:</span> <span class="p">{</span> <span class="err">…</span> <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p><code>match</code> は各 Keyup イベントで TEXTAREA の先頭からカーソル位置までの文字列に対して適応される正規表現を指定します。この正規表現がマッチした場合、 <code>index</code> 番目のグループが <code>search</code> の第一引数 <code>term</code> として渡されます。<br>
<code>search</code> では与えられた <code>term</code> に対応する文字列の配列を作って <code>callback</code> を実行します。この例では <code>jQuery.getJSON</code> を使ってリモートからデータを取ってきています。今回の例のように <code>search</code> の中に非同期処理が入っていたとしても、 <code>search</code> は同時に1回しか実行されないことが保証されます。また配列に100個の要素が入っていたとしても先頭から <code>maxCount</code> 個だけが表示されます。<br>
<code>callback</code> が実行されると与えられた配列の個々の要素に対して <code>template</code> が実行されます。この関数の返り値が補完の各要素になります。上の方に貼り付けられた gif の場合、補完メニューに画像が埋め込まれていますが、これを実現するには例えば下記のようにします。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">template</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'&lt;img src="path/to/'</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="s1">'.png"/&gt;'</span> <span class="o">+</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>最後に補完が確定したときに <code>replace</code> に選択された値が与えられて実行されます。この関数の返り値は次のように利用されるので、サンプルを参考に、条件を満たすように指定してください。String.replaceの詳しい仕様については <a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/replace" rel="nofollow noopener" target="_blank">String.replace - JavaScript | MDN</a> を参照してください。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">matchRegExp</span><span class="p">,</span> <span class="nx">replaceFunc</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span>
</pre></div></div>

<h1>
<span id="デザイン" class="fragment"></span><a href="#%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>デザイン</h1>

<p>出力される補完メニューはBootstrapのDropdownと同じHTML構造をしています。なので、Bootstrapを使っている環境では特に何もしなくてもいい感じにスタイルが勝手に適応されます。</p>

<p>Bootstrapを使っていない場合は、BootstrapのDropdownを参考によしなにスタイルを書いてください。リポジトリに jquery.textcomplete.css というファイルがあるので、それを土台に使うといいかも知れません。</p>

<h1>
<span id="今後実装される予定の機能" class="fragment"></span><a href="#%E4%BB%8A%E5%BE%8C%E5%AE%9F%E8%A3%85%E3%81%95%E3%82%8C%E3%82%8B%E4%BA%88%E5%AE%9A%E3%81%AE%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>今後実装される予定の機能</h1>

<ul>
<li>
<p>あいまい検索機能</p>

<p>各利用者が <code>search</code> 関数を実装しなければいけませんが、その中で使えるあいまい検索用の組み込み関数を用意しようと思っています。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">search</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">term</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fuzzySearch</span><span class="p">(</span><span class="nx">term</span><span class="p">,</span> <span class="cm">/* データ配列 */</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div>

<p>こんな感じで書くと勝手にいい具合に検索してくれる、みたいなイメージです。</p>
</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />16位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>266</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/128ad659e1474c7e20d6">この夏Google Analyticsが新しくなるって知ってた？Universal Analyticsを予習しよう</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-08 13:55:19</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[GoogleAnalytics]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>意外と認知度が低い感じですが、Google Analyticsがそろそろ新しくなりますよ！</p>

<p>現在パブリックベータとして提供されているUniversal Analyticsが <strong>予定では</strong> <a href="http://news.mynavi.jp/articles/2013/04/30/ga1/001.html" rel="nofollow noopener" target="_blank">7月中</a> に正式リリースになります。つまり今月！</p>

<p>世の中見渡していると非エンジニアなウェブマスター向けの紹介記事が多い印象なので、ここではJavaScriptのインタフェースがどう変わったか、それを使ってエンジニアはどういうことができるようになるか、みたいな、よりエンジニア向けの話題を中心に書いてみたいと思います。</p>

<p>ソースは<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/" rel="nofollow noopener" target="_blank">公式ドキュメント</a>なので、より詳しく知りたい方はそちらを参照してください。</p>

<h1>
<span id="簡単なまとめ" class="fragment"></span><a href="#%E7%B0%A1%E5%8D%98%E3%81%AA%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>簡単なまとめ</h1>

<p>Universal Analytics(analytics.js)は...</p>

<ul>
<li>これまでのやつ(ga.js)よりJavaScriptのインタフェースがイケてる</li>
<li>APIは存在するけどWebインタフェースが未実装の機能がまだまだ多い</li>
<li>ソーシャルボタンの効果測定とか、クライアント上でのエラー情報の集積とかする専用の機能がある</li>
<li>古いデータを引き継ぐ機能は未実装だがその内提供される</li>
</ul>

<h2>
<span id="この記事を読むと分かること" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%80%E3%81%A8%E5%88%86%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事を読むと分かること</h2>

<ul>
<li>これまでのやつ(ga.js)と比べて新しいやつ(analytics.js)がどう変わったか</li>
<li>Universal Analyticsの新機能で <strong>個人的に</strong> 気になってるもの</li>
</ul>

<h2>
<span id="この記事を読んでも分からないこと" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A7%E3%82%82%E5%88%86%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事を読んでも分からないこと</h2>

<ul>
<li>iOSやAndroid向けSDKの話</li>
<li>Universal Analyticsの新機能で <strong>個人的に</strong> 気になってないもの</li>
<li>いつUniversal Analyticsが公開されるか（僕が教えて欲しい）</li>
</ul>

<hr>

<h1>
<span id="ところで" class="fragment"></span><a href="#%E3%81%A8%E3%81%93%E3%82%8D%E3%81%A7"><i class="fa fa-link"></i></a>ところで…</h1>

<p><a href="http://blog.qiita.com/post/53841405700/google-analytics-is-available" rel="nofollow noopener" target="_blank">Qiitaに投稿した自分の記事にはGoogle Analytics埋め込めるようになりました。</a></p>

<p>送られてくるのはページビューだけですが、これ設定すると自分の記事がどれくらい読まれているか、とか、Twitterやはてブでどれくらい共有されてるか、とかが分かって楽しいです。<br>
あと大雑把にQiitaを利用している人の情報が分かるので「Chromeユーザ多すぎワロス」とか（なんとなく）分かって楽しいです。</p>

<p>以上お知らせでした</p>

<hr>

<h1>
<span id="universal-analyticsとは何か" class="fragment"></span><a href="#universal-analytics%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>Universal Analyticsとは何か</h1>

<p>これまでのGoogle Analytics(以下ga.js)では端末をまたいでユーザを識別することができませんでした。</p>

<p>例えば、同じアカウントでログインしているにも関わらず、会社PC、自宅PC、携帯でそれぞれアクセスしたら3人の別の人がアクセスしたと判断してました。</p>

<p>1番の違いは、この点に関して、同じアカウントなら同じ人として扱えるようになる点だろうと思います。</p>

<p>加えて、ga.jsは（PC向け）Webアプリケーション向け機能が多いですが、Universal Analyticsはモバイルサイト向けの機能の充実や、iOSとAndroid向けのSDKが提供されるなど、よりモバイル向けに機能が強化されているのも大きな違いです。</p>

<p>というわけで様々な環境からのアクセスを解析できるから Universal Analytics なわけですね。</p>

<h2>
<span id="読み込むjavascriptが変わってインタフェースが変わった" class="fragment"></span><a href="#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80javascript%E3%81%8C%E5%A4%89%E3%82%8F%E3%81%A3%E3%81%A6%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%81%8C%E5%A4%89%E3%82%8F%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>読み込むJavaScriptが変わってインタフェースが変わった</h2>

<p>今までは ga.js ってやつでしたが、今度からは analytics.js になります。名前なんてどうでもいいんですが、インタフェース的に結構変わってます。</p>

<p>以前のga.jsはなかなか酷くて、ページビューを送信する場合次のように書きました。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">ga.jsでアカウント設定＆ページビュー</span></div>
<div class="highlight"><pre><span></span><span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s1">'_setAccount'</span><span class="p">,</span> <span class="s1">'UA-XXXX-Y'</span><span class="p">]);</span>
<span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s1">'_trackPageview'</span><span class="p">]);</span>
</pre></div>
</div>

<p>グローバルに露出している <code>_gaq</code> という名前はいいとしても、なんで <code>_setAccount</code> とか <code>_trackPageview</code> みたいな内部APIが <code>_</code> で始まるんだよ、とか <code>push</code> ってなんだよ直感的じゃねーな、とか色々思うところがあります。</p>

<p>特に酷いのが送信後に何かをしたい場合で、例えばユーザがformにsubmitした、というイベントをga.jsでトラッキングしようとすると、イベント通知をGoogleに終えてからsubmitイベントを実行しないといけませんが、それを実現するには次のように書きます。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">ga.jsでイベント送信後に何かする方法</span></div>
<div class="highlight"><pre><span></span><span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s1">'_trackEvent'</span><span class="p">,</span> <span class="s1">'form'</span><span class="p">,</span> <span class="s1">'submit'</span><span class="p">]);</span>
<span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// _trackEventが終わったあとに実行される関数</span>
<span class="p">});</span>
</pre></div>
</div>

<p>非同期処理といえばコールバック関数、もしくは<a href="http://qiita.com/yuku_t/items/3d1cf51d7ae91305eaaa" id="reference-4465a069ed6a87dddc65">Deferredインタフェース</a>を使うのがJavaScript的にはよくある方法なんじゃないでしょうかね。サーバサイドではキューの方が一般的かも知れないけど。(ga.jsでも <code>hitCallback</code> が使えるという情報がありますが、公式ドキュメントでは上記の方法しか紹介されていませんでした。）</p>

<p>それが analytics.js では下記のように変更されます。だいぶ分かりやすくなった気がします。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">analytics.jsの場合</span></div>
<div class="highlight"><pre><span></span><span class="nx">ga</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'UA-XXXX-Y'</span><span class="p">);</span>
<span class="nx">ga</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'pageview'</span><span class="p">);</span>
<span class="nx">ga</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'event'</span><span class="p">,</span> <span class="s1">'form'</span><span class="p">,</span> <span class="s1">'submit'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hitCallback</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// イベント送信が終わったら実行されるコールバック</span>
<span class="p">});</span>
</pre></div>
</div>

<p>まず断っておきたいのは、グローバル関数である <code>ga</code> はデフォルト名で、問題がある場合は変更できます。あと、イベント完了後に何かをするにもコールバックを使うようになってます。</p>

<h2>
<span id="端末をまたいでログインユーザを追跡する" class="fragment"></span><a href="#%E7%AB%AF%E6%9C%AB%E3%82%92%E3%81%BE%E3%81%9F%E3%81%84%E3%81%A7%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%83%A6%E3%83%BC%E3%82%B6%E3%82%92%E8%BF%BD%E8%B7%A1%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>端末をまたいでログインユーザを追跡する</h2>

<p><code>clientId</code> というのがあって、おそらく、これを使います。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">ユーザの識別</span></div>
<div class="highlight"><pre><span></span><span class="nx">ga</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'UA-XXXX-Y'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">clientId</span><span class="o">:</span> <span class="s1">'ログインユーザID'</span> <span class="p">});</span>
</pre></div>
</div>

<p>何も指定しないとanalytics.jsが何か適当に埋めます。これをログインしているユーザのIDとかにすれば、端末が変わっても、ログインしていれば同じ値になるので、同じユーザとして追跡できることになります。</p>

<h1>
<span id="hitとは何か" class="fragment"></span><a href="#hit%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>Hitとは何か</h1>

<p>Hitってのは</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">ga</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'pageview'</span><span class="p">);</span>
</pre></div></div>

<p>でいうところの <code>pageview</code> の部分のことで、<code>pageview</code> <code>event</code> 以外に <code>appview</code> <code>transaction</code> <code>item</code> <code>social</code> <code>exception</code> <code>timing</code> があります。というか、これら以外は指定できないので注意。</p>

<p>それぞれ意味が違うので、目的に合わせて利用します。それぞれ引数が若干違うので、使う場合は<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/" rel="nofollow noopener" target="_blank">公式ドキュメント</a>を確認してください。</p>

<p>ここでは <code>social</code> と <code>exception</code> について取り上げようと思います。</p>

<h2>
<span id="ソーシャルボタンの効果測定" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B7%E3%83%A3%E3%83%AB%E3%83%9C%E3%82%BF%E3%83%B3%E3%81%AE%E5%8A%B9%E6%9E%9C%E6%B8%AC%E5%AE%9A"><i class="fa fa-link"></i></a>ソーシャルボタンの効果測定</h2>

<ul>
<li><a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/social-interactions" rel="nofollow noopener" target="_blank">Social Interactions - Web Tracking (analytics.js) - Google Analytics — Google Developers</a></li>
</ul>

<p><code>social</code> hitは、ページにTweetボタンとかLikeボタンとか置く場合が増えていると思いますが、それらが実際どれくらい押されているのかをトラッキングする専用のイベントです。</p>

<p>もちろん <code>event</code> を使ってもいいんですが、こっちを使っておくと何かとよしなにやってくれそうです。<br>
現時点では専用のページがあって、通常のイベントとは区別して見れるというだけなんですが、今後もっと色々と面白いことができるようになっていくんじゃないかと期待しています。</p>

<h3>
<span id="tweetボタンをトラッキングする" class="fragment"></span><a href="#tweet%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E3%83%88%E3%83%A9%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Tweetボタンをトラッキングする</h3>

<p>Tweetボタンをクリックされたり、実際にツイートされた回数を計測する方法です。詳しくは <a href="https://dev.twitter.com/docs/tfw-javascript" rel="nofollow noopener" target="_blank">Twitterのドキュメント</a>を参照してください。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Tweetボタンをトラッキングする</span></div>
<div class="highlight"><pre><span></span><span class="nx">twttr</span><span class="p">.</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">twttr</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">twttr</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ga</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'social'</span><span class="p">,</span> <span class="s1">'twitter'</span><span class="p">,</span> <span class="s1">'click'</span><span class="p">,</span> <span class="s1">'http://example.com'</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">twttr</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'tweet'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ga</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'social'</span><span class="p">,</span> <span class="s1">'twitter'</span><span class="p">,</span> <span class="s1">'tweet'</span><span class="p">,</span> <span class="s1">'http://example.com'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>

<p>FacebookのLikeボタンをトラッキングする方法は、上でリンクを貼った公式ドキュメントに書いてあるので、それを参考にしてください。</p>

<p>はてブボタンには、LikeボタンやTweetボタンのようにユーザの行動をフックするAPIが用意されていないので、トラッキングできないです。</p>

<p>あと、当たり前ですが、これで分かるのはページに埋め込まれているボタンを経由して行動をした場合のみです。</p>

<h2>
<span id="ブラウザ上でのエラーの計測" class="fragment"></span><a href="#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E4%B8%8A%E3%81%A7%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AE%E8%A8%88%E6%B8%AC"><i class="fa fa-link"></i></a>ブラウザ上でのエラーの計測</h2>

<ul>
<li><a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference#exception" rel="nofollow noopener" target="_blank">Exceptions - Analytics.js Field Reference - Google Analytics — Google Developers</a></li>
</ul>

<p>サーバ上で起こるエラーは把握できますが（ログがサーバに残るので）、ブラウザでJavaScriptがエラーをおこしたとしても、それを開発者が知ることは基本的にできません。</p>

<p>規模が大きな会社ではエラーが起きたら、その情報を自分のサーバに送ってあとで見れるようにしたりしているのかも知れませんが、そんなことにリソースを割く余裕は無い、というところも多いはず。</p>

<p><code>exception</code> hitは恐らくこういう用途で使うためのものです。恐らく、と言っているのは、現時点ではまだWebインタフェースが存在していなくて、データを送っても何も見れない状態だからです。</p>

<p>あと1つだけ注意があって、 <code>exception</code> で送れるデータが150Bまでなので、スタックトレースを全部送る、みたいなことはできそうにないです。</p>

<h1>
<span id="custom-dimensions--metrics-とは何か" class="fragment"></span><a href="#custom-dimensions--metrics-%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>Custom Dimensions &amp; Metrics とは何か</h1>

<p>ga.jsにはCustom Variablesというのがあって、これを使うと独自に定義した属性みたいなのをユーザに付与することができますが、それをもうちょっと便利にしたものです。</p>

<p>Dimentionsは文字列でmetricsは数値になります。DimensionsもMetricsも20個までしか作れないし、一回作ったら削除できないので注意が必要。</p>

<p>Mixpanelみたいにとりあえず送りつけたらその場でトラッキング開始してくれる、みたいな感じじゃなくて、事前にこちら側で、Custom Dimensionsの1番目はログインしてるかどうかを表します、というのを設定しておかなければならないのがちょっと面倒。（ga.jsのCustom Variablesもそんな感じでしたね）</p>

<p>設定ページにいくとスコープをどうするか聞かれます。スコープというのはその情報が、毎回異なるのか、セッション毎に異なるのか、ユーザに対して不変なのか（例えば性別は基本的に変わらないはず）で決まります。詳しくは <a href="https://developers.google.com/analytics/devguides/platform/features/customdimsmets" rel="nofollow noopener" target="_blank">Custom Dimensions &amp; Metrics - Feature Reference - Google Analytics — Google Developers</a> に書いてあります。</p>

<p>簡単な話が、例えば「ログインしてるかしてないか」を1つのdimentionにして、アクセスユーザに対して適切に設定してやれば、おそらく、簡単にアクセス全体に対するログインユーザの割合が分かったり、ログインユーザと非ログインユーザの行動の違いとかを簡単に比較できたりするんだと思います。</p>

<p>おそらく、とここで言っているのは、これまたドキュメントにはあるけどWebインタフェースからアクセスできない状態だからです。Universal Analyticsを有効にしていてもWebインタフェースにはga.js用のCustom Variablesが表示されます。ひどい</p>

<h2>
<span id="使ってみる" class="fragment"></span><a href="#%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>使ってみる</h2>

<p>Webインタフェースはないんだけどデータを送るだけなら既にできます。</p>

<div class="code-frame" data-lang="js+erb">
<div class="code-lang"><span class="bold">ログインユーザかどうか設定する</span></div>
<div class="highlight"><pre><span></span><span class="nx">ga</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'UA-XXXX-Y'</span><span class="p">);</span>
<span class="nx">ga</span><span class="p">(</span><span class="s1">'set'</span><span class="p">,</span> <span class="s1">'dimension1'</span><span class="p">,</span> <span class="s1">'</span><span class="cp">&lt;%=</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span><span class="s1">'</span><span class="p">);</span>
<span class="nx">ga</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'pageview'</span><span class="p">);</span>
</pre></div>
</div>

<p>仮にdimensionの1番目をログインしているかどうかに設定しているとすると、上記のようにしておけば、各ページビューがログインユーザによるものか、それとも非ログインユーザによるものかが判別できるようになります。</p>

<h1>
<span id="gajsからanalyticsjsへの移行" class="fragment"></span><a href="#gajs%E3%81%8B%E3%82%89analyticsjs%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C"><i class="fa fa-link"></i></a>ga.jsからanalytics.jsへの移行</h1>

<p>いまはまだデータを移行することはできません。Googleによればそのうち提供するらしいです。</p>

<p>なのですでにga.jsを使っている人は現状このままga.jsを使い続けて、移行する機能が提供された段階でanalytics.jsに移るというのがよさそう。</p>

<p>ちなみにga.jsとanalytics.jsが混在しても問題無い（とGoogleが明言している）ので、とりあえずUniversal Analyticsを導入しておく、というのもOKです。</p>

<h1>
<span id="合わせて読みたい" class="fragment"></span><a href="#%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>合わせて読みたい</h1>

<ul>
<li>
<p><a href="http://qiita.com/tatata111/items/a6e2574cb654986ed3f0" id="reference-b37d0e0843f2c6101ca9">GoogleAnalytics - Google Analyticsの利用時に注意すること - Qiita [キータ]</a></p>

<p>Google Analyticsの利用規約で気をつけるべき点についての解説記事</p>
</li>
<li>
<p><a href="http://qiita.com/kengos@github/items/1998a3f71e5b702d36c8" id="reference-c8433239ee39461944d9">GoogleAnalyticsを使ったメールマガジン等からのトラフィック分析 - Qiita [キータ]</a></p>

<p>キャンペーン機能の使い方。キャンペーン機能はga.jsとanalytics.jsのどちらでも利用できます。（違いがあるかまでは見てないです）</p>
</li>
<li>
<p><a href="http://www.ayudante.jp/column/2012-11-05/14-48/" rel="nofollow noopener" target="_blank">2012年Google Analyticsサミット報告｜コラム アユダンテ株式会社</a></p>

<p>昨年末に行われたGoogle Analyticsサミットでのお話。今回紹介しなかったUniversal Analyticsの新機能について網羅的に紹介されています。</p>
</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />17位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>263</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/16b799d0ec0a0ae3f78e">Backbone.js入門 「Events」</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-14 14:53:47</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="閲覧上の注意" class="fragment"></span><a href="#%E9%96%B2%E8%A6%A7%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>閲覧上の注意</h3>

<p>この記事で対象としているバージョン0.5.3は結構古いので注意してください。この記事でいえば、<code>bind</code>は無くなり、現在では<code>on</code>や<code>listenTo</code>が使われています。</p>

<p>その他の割りと新しい情報は <a href="http://www.adventar.org/calendars/15" rel="nofollow noopener" target="_blank">Backbone.js Advent Calendar 2012</a> などにあります。</p>

<p>（追記ここまで）</p>

<hr>

<p>ネタ切れ感が否めないBackbone.js Advent Calendarですが、今回から何回かに分けて懇切丁寧な入門記事を書いていこうと思います。<br>
以下のように書き進めていく予定です。</p>

<ol>
<li>Events</li>
<li>View</li>
<li>Model</li>
<li>ViewとModelの連携</li>
<li>Collection</li>
<li>ViewとModelとCollectionの連携</li>
<li>RouterとHistory</li>
</ol>

<p>なおここで扱うBackbone.jsのバージョンは0.5.3です。</p>

<h1>
<span id="backbonejs入門-events" class="fragment"></span><a href="#backbonejs%E5%85%A5%E9%96%80-events"><i class="fa fa-link"></i></a>Backbone.js入門 「Events」</h1>

<p><a href="http://documentcloud.github.com/backbone/" rel="nofollow noopener" target="_blank">Backbone.jsのドキュメント</a>を開くとまず最初に解説されているのが <code>Events</code> です。<br>
<code>Events</code> を直接使うことは無いかも知れません。それというのも <code>Model</code> <code>Collection</code> <code>Router</code> <code>View</code> は <code>Events</code> を拡張しており、しかも用途に特化した様々な機能を持っているため、これらを使った方が便利だからです。<br>
しかしながら、上記のオブジェクトを用いる中で間接的に <code>Events</code> を利用しているということができます。<br>
Backbone.jsでのプログラミングは、この <code>Events</code> が提供するインタフェースを用いて <strong><a href="http://ja.wikipedia.org/wiki/Observer_%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3" rel="nofollow noopener" target="_blank">オブザーバ・パターン</a></strong> を上手く使い、オブジェクト間の疎結合を促進することが基本的なコーディング方針です。</p>

<h2>
<span id="オブザーバパターン" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B6%E3%83%BC%E3%83%90%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a>オブザーバ・パターン</h2>

<p>JavaScriptに限らず、A.aが行われたら、B.aを行いたい、というような場面があります。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">A</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// do something</span>
    <span class="nx">B</span><span class="p">.</span><span class="nx">a</span><span class="p">();</span>
<span class="p">};</span>
</pre></div></div>

<p>これで問題無いように思えますが、AはBがaメソッドを持っていることを知っていなければなりませんし、後になってC.aを追加したくなるかも知れません。それに、動的にB.aが実行されるかどうかを切り替えたい場合は、さらにゴチャゴチャしてきます。<br>
このような場面でオブザーバ・パターンを用いることで、プログラムの見通しをよくすることができます。(Aのようなオブジェクトを <em>出版者</em> や <em>Subject</em> 、Bを <em>購読者</em> や <em>Observer</em> と呼びます)</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">A</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"doA"</span><span class="p">,</span> <span class="nx">B</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>  <span class="c1">// A に対して doA が trigger されたら B.a を実行する</span>
<span class="nx">A</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// do something</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"doA"</span><span class="p">)</span> <span class="c1">// =&gt; B.a が実行される</span>
<span class="p">}</span>
</pre></div></div>

<p>あとからC.aも実行したくなったら <code>A.bind("doA", C.a)</code> を実行すればよい訳です。</p>

<h2>
<span id="eventsの使い方" class="fragment"></span><a href="#events%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>Eventsの使い方</h2>

<p>ここでAを <code>Events</code> を用いて定義すると以下のようになります。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">A</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>
</pre></div></div>

<p><code>Events</code> を拡張したAには<code>bind</code>, <code>unbind</code> そして <code>trigger</code> の３つのメソッドが追加されています。</p>

<h3>
<span id="bindeventname-callback-context" class="fragment"></span><a href="#bindeventname-callback-context"><i class="fa fa-link"></i></a>bind(eventName, callback, [context])</h3>

<p>他のオブザーバ・パターンの実装では <strong>register</strong> と呼ばれることもあるメソッドで、<code>A.trigger(eventName)</code> によって <code>callback</code> が起動されるようになります。<code>context</code> はオプションの引数で、<code>callback</code> の <code>this</code> に束縛されます。<code>context</code> は後述する <em>Eventsを用いる時の注意点</em> でもう一度扱います。</p>

<h3>
<span id="unbindeventname-callback" class="fragment"></span><a href="#unbindeventname-callback"><i class="fa fa-link"></i></a>unbind([eventName], [callback])</h3>

<p>他のオブザーバ・パターンの実装では <strong>unregister</strong> と呼ばれることもあるメソッドで、既に束縛( <em>bind</em> )されているコールバック関数を解除することができます。<code>eventName</code> と <code>callback</code> は両方省略可能で、両方省略すると全てのコールバック関数が解除されます。</p>

<h3>
<span id="triggereventname-args" class="fragment"></span><a href="#triggereventname-args"><i class="fa fa-link"></i></a>trigger(eventName, [*args])</h3>

<p>他のオブザーバ・パターンの実装では <strong>notify</strong> と呼ばれることもあるメソッドで、束縛されているコールバック関数を起動します。第二引数以降はそれぞれコールバック関数に引数として渡されます。</p>

<p>ここで、<code>eventName</code> が <em>"all"</em> だった場合、このオブジェクトに束縛されている全てのコールバック関数が実行されます。</p>

<h2>
<span id="eventsを用いる時の注意点" class="fragment"></span><a href="#events%E3%82%92%E7%94%A8%E3%81%84%E3%82%8B%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>Eventsを用いる時の注意点</h2>

<p><code>Events</code> に限らず、コールバック関数内では <code>this</code> が何を指すのか気をつける必要があります。<br>
<code>bind</code> において、<code>context</code> を指定しなかった場合、コールバック関数内で <code>this</code> は <em>Subject</em> オブジェクトになります。つまり</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">B</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s2">"B"</span><span class="p">,</span>
    <span class="nx">b</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">};</span>
<span class="p">}</span>
<span class="nx">A</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">"A"</span><span class="p">;</span>
<span class="nx">A</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">,</span> <span class="nx">B</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span>
<span class="nx">A</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">);</span> <span class="c1">// =&gt; "A"</span>
</pre></div></div>

<p>これは意図しない動作でしょう。ここで、<code>this</code> をBにする方法はいくつかあります。まずは、<code>context</code> を使う方法です</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">A</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">,</span> <span class="nx">B</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nx">B</span><span class="p">);</span>
<span class="nx">A</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">);</span> <span class="c1">// =&gt; "B"</span>
</pre></div></div>

<p>もう一つは、<code>_.bind</code> を使って事前に <code>this</code> を束縛する方法です。(紛らわしいですが、この <code>bind</code> は <code>Events#bind</code> とは全くの別物です)</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">B</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">B</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nx">B</span><span class="p">);</span>
<span class="nx">A</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">,</span> <span class="nx">B</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span>
<span class="nx">A</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">);</span> <span class="c1">// =&gt; "B"</span>
</pre></div></div>

<p>この方法の利点は、金輪際、どのような状況で呼び出されようと、B.b() が "B" と出力するようになることです。B.b を何度もコールバック関数として使う場合は、先に <code>_.bind</code> しておくとよいでしょう。<br>
しかしながら、Bのメソッドが増えてくると、いちいち <code>_.bind</code> を呼ぶのが面倒です。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">B</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">b1</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b2</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b3</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b4</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b5</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b6</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b7</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b8</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b9</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
    <span class="nx">b10</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
<span class="p">};</span>
<span class="nx">B</span><span class="p">.</span><span class="nx">b1</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">B</span><span class="p">.</span><span class="nx">b1</span><span class="p">,</span> <span class="nx">B</span><span class="p">);</span>
<span class="c1">// ...  面倒</span>
<span class="nx">B</span><span class="p">.</span><span class="nx">b10</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">B</span><span class="p">.</span><span class="nx">b10</span><span class="p">,</span> <span class="nx">B</span><span class="p">);</span>
</pre></div></div>

<p>こういう場合は <code>_.bindAll</code> が便利です。<code>_.bind</code> を10回呼ぶ代わりに、次のように書くことができます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="s2">"b1"</span><span class="p">,</span><span class="s2">"b2"</span><span class="p">,</span><span class="s2">"b3"</span><span class="p">,</span><span class="s2">"b4"</span><span class="p">,</span><span class="s2">"b5"</span><span class="p">,</span><span class="s2">"b6"</span><span class="p">,</span><span class="s2">"b7"</span><span class="p">,</span><span class="s2">"b8"</span><span class="p">,</span><span class="s2">"b9"</span><span class="p">,</span><span class="s2">"b10"</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="次回は" class="fragment"></span><a href="#%E6%AC%A1%E5%9B%9E%E3%81%AF"><i class="fa fa-link"></i></a>次回は</h2>

<p>次回は「View」です。お楽しみに</p>

<hr>

<ol>
<li>Backbone.js入門 Events</li>
<li><a href="http://qiita.com/items/03f49c64d6c4bacdbb26">Backbone.js入門 MVC</a></li>
<li><a href="http://qiita.com/items/8ee2ed1949cd7c337f06">Backbone.js入門 View</a></li>
<li><a href="http://qiita.com/items/5acef8dd49f67fd7813c">Backbone.js入門 Model</a></li>
<li><a href="http://qiita.com/items/7ce4b1ceb5d18c9cef08">Backbone.js入門 ViewとModelの連携</a></li>
<li><a href="http://qiita.com/items/c19d2fff0dc23e4015ff">Backbone.js入門 Collection</a></li>
<li><a href="http://qiita.com/items/7095a32cc5e438172844">Backbone.js入門 ViewとModelとCollectionの連携</a></li>
<li><a href="http://qiita.com/items/13f3d1f71d31f3e78123">Backbone.js入門 RouterとHistory</a></li>
</ol>

<ul>
<li><a href="https://groups.google.com/forum/?fromgroups#!forum/backbonejs-ja" rel="nofollow noopener" target="_blank">BackboneJS 日本語メーリングリスト</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />18位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>255</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/717d636a174ec37ad967">JSHint入門 - JSHintを使ってJSコードの信頼性を高める</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-05 16:36:09</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[JavaScript]</b> <b>[JSHint]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>2016年2月現在、JSHintよりESLintの利用を奨励します。</p>

<hr>

<p><strong>全て</strong> の JavaScript ファイルは JSHint ないしその他のソース解析ツールで管理されるべきだと思っている。<br>
今回は JSHint の基本的な使い方を説明する。</p>

<h2>
<span id="インストール" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>インストール</h2>

<p>JSHint は Node.js で実装されているのでまずはそれをインストールする。Mac なら <code>brew install node</code> でサクッとインストール可能。また、インストールには npm を使うのでそれもいれる。そして npm をつかって JSHint をインストールする。 <code>-g</code> オプションはシステムにインストールするという意味。インストールディレクトリを PATH に追加するのを忘れない（デフォルトで追加されたかどうか記憶が曖昧）。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% brew install node
% curl https://npmjs.org/install.sh <span class="p">|</span> sh  <span class="c1"># npm のインストール</span>
% npm install -g jshint
</pre></div></div>

<h2>
<span id="jshintrcとjshintignoreをプロジェクトルートに設置する" class="fragment"></span><a href="#jshintrc%E3%81%A8jshintignore%E3%82%92%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%83%AB%E3%83%BC%E3%83%88%E3%81%AB%E8%A8%AD%E7%BD%AE%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>.jshintrcと.jshintignoreをプロジェクトルートに設置する</h2>

<p><code>.jshintrc</code> は <code>jshint</code> の設定を書く。<code>jshint</code> は個々のファイル単位や、関数単位での設定もできる。その方法は後述する。詳しいオプションの説明は <a href="http://www.jshint.com/docs/" rel="nofollow noopener" target="_blank">JSHint -Documentation</a> 参照。 <strong>Relaxing Options</strong> はデフォルトで禁止されているものを許可する項目なので、注意して使うようにする。</p>

<p>ここでは自分の設定を紹介する。ちなみに JSON 形式。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">.jshintrc</span></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">"strict"</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// "use strict" を強制</span>
  <span class="s2">"indent"</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1">// インデントの深さ</span>
  <span class="s2">"maxlen"</span> <span class="o">:</span> <span class="mi">80</span><span class="p">,</span>  <span class="c1">// 一行の最大長</span>
  <span class="s2">"unused"</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// 宣言したきり使っていない変数を検出  </span>

  <span class="c1">// グローバル変数へのアクセスの管理</span>
  <span class="s2">"undef"</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// グローバル変数へのアクセスを禁止</span>
  <span class="s2">"browser"</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// ブラウザ用のやつは許可</span>
  <span class="s2">"dojo"</span> <span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>  <span class="c1">// dojo tool kit用のやつは許可</span>
  <span class="s2">"devel"</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">//  consoleやalertを許可</span>
  <span class="s2">"debug"</span>    <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// debugger を許可</span>
  <span class="s2">"globals"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"_"</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="s2">"Backbone"</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>

  <span class="c1">// Relaxing Options - 危険性を認識した上で設定すること</span>
  <span class="s2">"eqnull"</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// == null を許可</span>
  <span class="s2">"expr"</span> <span class="o">:</span> <span class="kc">true</span>  <span class="c1">// x || (x = 1); とかができるようにする</span>
<span class="p">}</span>
</pre></div>
</div>

<p><em>グローバル変数のへのアクセスの管理</em> に並んでいる <code>browser</code> <code>dojo</code> <code>devel</code> によって具体的に許可される項目は <a href="https://github.com/jshint/jshint/blob/master/src/shared/vars.js" rel="nofollow noopener" target="_blank">/src/shared/vars.js</a> を読めば分かる。ちなみに <code>dojo</code> を入れているのは <code>require.js</code> を使っていて <code>define</code> と <code>require</code> を許可したかったため。<br>
<code>globals</code> で任意のグローバル変数を追加できる。個々の <code>globals</code> が何故 <code>false</code> なのかは後述。</p>

<p><code>.jshintignore</code> は名前から分かるように <code>jshint</code> コマンドで無視するファイルと記述する。ファイル名ではなく、ここではプロジェクトルートからの相対パスで記述する。現時点でグロブは使えない。プロジェクトで使うライブラリなどを指定する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>js/require-jquery.js
tests/vendor/qunit.js
</pre></div></div>

<h2>
<span id="実行してみる" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>実行してみる</h2>

<p>実行する時はプロジェクトルートで実行する。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% jshint js/**/*.js tests/**/*.js
</pre></div></div>

<p>この時 <code>.jshintignore</code> で指定されたファイルは無視される。</p>

<h2>
<span id="ファイルローカル関数ローカルな設定をする" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E9%96%A2%E6%95%B0%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%81%AA%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ファイルローカル、関数ローカルな設定をする</h2>

<p>どうしても全体より条件を緩くしたいファイルや関数は出てくる。逆に厳しくしたい時もあるかも知れないが、基本的には全体としては厳しく、必要に応じて緩和するようにした方がよい。それはさておき、このようなときは先頭に次のようなコードを入れる。 <code>/*</code> と <code>jshint</code> の間は <strong>くっつけて書く</strong> 。スペースが入ると単なるコメントとして扱われてしまうので注意。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="cm">/*jshint strict: false */</span>
</pre></div></div>

<p>これがファイルの先頭にあれば、そのファイルでは <code>use strict</code> の使用は強制されない。関数の先頭ならその関数で <code>use strict</code> を使わなくてよい。ちなみにこれをファイルの先頭においたとしてもグローバルに <code>use strict</code> するには <code>globalstrict: true</code>が別途必要である（グローバルで使うとサードパーティのライブラリが動かなくなる可能性が高いのでおすすめしない）。</p>

<p>グローバル変数へのアクセスの管理には <code>/*global */</code> を使う。<code>.jshintrc</code> で <code>"jquery": true</code> とするのは、全てのファイルの先頭で次のように宣言するのと等しい。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="cm">/*global jQuery: false $: false */</span>
</pre></div></div>

<p>ここで <code>false</code> の意味は、ローカルで <code>jQuery</code> と <code>$</code> を <strong>上書きできない</strong> という意味。 <code>true</code> で上書きできるようになるが、基本的に <code>false</code> 以外設定するべきではない。</p>

<h2>
<span id="vim使いはsyntasticをインストールしカレントディレクトリをプロジェクトルートにする" class="fragment"></span><a href="#vim%E4%BD%BF%E3%81%84%E3%81%AFsyntastic%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%88%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%83%AB%E3%83%BC%E3%83%88%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Vim使いはsyntasticをインストールしカレントディレクトリをプロジェクトルートにする</h2>

<p><a href="https://github.com/scrooloose/syntastic" rel="nofollow noopener" target="_blank">scrooloose/syntastic - GitHub</a> をインストールする。デフォルトで JavaScript の保存時に jshint がインストールされていれば実行してくれるようになる。この時カレントディレクトリにある <code>.jshintrc</code> はちゃんと考慮してくれるので（より正確に言えば設定ファイルを指定する <code>--config</code> オプションを使わずに <code>jshint</code> コマンドを起動してくれるのでデフォルトの動作であるカレントディレクトリの <code>.jshintrc</code> がそのまま使われる。）vim を起動する時は必ずプロジェクトルートで起動するようにする。そうすれば極論としては手で jshint コマンドを一度も叩く必要はない。</p>

<p>もし全ての JS ファイルで同じ <code>.jshintrc</code> を使いたいなら <code>g:syntastic_javascript_jshint_conf</code> で指定する。その場合、カレントディレクトリの <code>.jshintrc</code> が使われ無くなってしまうので <a href="https://github.com/thinca/vim-localrc" rel="nofollow noopener" target="_blank">thinca/vim-localrc - GitHub</a> とか使って設定を上書きする必要がある。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />19位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>242</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/516ec6fe59b77b93edc5">Facebookみたいにtextareaの一部を強調する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-25 14:41:26</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://camo.qiitausercontent.com/2d79e6daaf53311e30bb81cc7c3a0121b50ff365/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f62323631323037622d313433342d623538392d316534392d3161306366346561633230662e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2d79e6daaf53311e30bb81cc7c3a0121b50ff365/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f62323631323037622d313433342d623538392d316534392d3161306366346561633230662e676966" alt="bx07r4swyI.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/b261207b-1434-b589-1e49-1a0cf4eac20f.gif"></a></p>

<p>Facebookで人物を補完すると、その人物名の周りに枠が表示されて強調されますよね（gif画像参照）。</p>

<p>これのやり方を解説します。</p>

<h1>
<span id="tldr" class="fragment"></span><a href="#tldr"><i class="fa fa-link"></i></a>TL;DR</h1>

<p>textareaの強調表示は、textareaを透明にして後ろにいい感じの背景を設置してるだけ</p>

<hr>

<h2>
<span id="textareaの中にdomを入れても表示されない" class="fragment"></span><a href="#textarea%E3%81%AE%E4%B8%AD%E3%81%ABdom%E3%82%92%E5%85%A5%E3%82%8C%E3%81%A6%E3%82%82%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>textareaの中にDOMを入れても表示されない</h2>

<p>パッと考えるとtextareaの中にDOMツリーを入れるとそれが表示されるんじゃないか、と思うかも知れません</p>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">textareaの中に直接DOMを記述してみる</span></div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">textarea</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
</pre></div>
</div>

<p>が、ぜんぜんそんなことは無くて、そのまま文字列が表示されてしまいます。</p>

<p><a href="https://camo.qiitausercontent.com/d97a7db168ed3d120ca8d51cba7ba6ba21a0ccf7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f30643162353463392d323233312d373839312d303532392d6136656264613732623763302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d97a7db168ed3d120ca8d51cba7ba6ba21a0ccf7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f30643162353463392d323233312d373839312d303532392d6136656264613732623763302e706e67" alt="Screen Shot 2013-09-25 at 1.59.57 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/0d1b54c9-2231-7891-0529-a6ebda72b7c0.png"></a></p>

<p>ご存知のようにtextareaやinputは、他の要素のように子要素を表示するのではなく、自身のvalue属性の値を画面に表示する働きをします。value属性は文字列を格納するためのものなのでDOMを入れられないわけですね。</p>

<h2>
<span id="強調用のdomを重ねあわせる" class="fragment"></span><a href="#%E5%BC%B7%E8%AA%BF%E7%94%A8%E3%81%AEdom%E3%82%92%E9%87%8D%E3%81%AD%E3%81%82%E3%82%8F%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>強調用のDOMを重ねあわせる</h2>

<p>textareaにはDOMをそのまま入れられないので、仕方がなく周りに設置したDOMの位置を微調整して重ねあわせることでtextareaが強調されているかのように見せかけているわけです。</p>

<p>このとき問題になるのがtextareaと重ねあわせるDOMのz軸方向の位置関係です。textareaより手前にあるとtextareaを選択できなくなってしまします。一方でtextareaより奥にあると表示されません。</p>

<p>さてどうしたら良いのでしょう？</p>

<h3>
<span id="background-color-transparentが肝" class="fragment"></span><a href="#background-color-transparent%E3%81%8C%E8%82%9D"><i class="fa fa-link"></i></a>background-color: transparentが肝</h3>

<p>textareaの背景色を透明にして、後ろにあるDOMが表示されるようにすればよさそうですね。つまりtextareaが <code>background-color: transparent;</code> であればよいわけです。</p>

<h3>
<span id="いい感じの場所に背景色をつけるにはどうすればいいの" class="fragment"></span><a href="#%E3%81%84%E3%81%84%E6%84%9F%E3%81%98%E3%81%AE%E5%A0%B4%E6%89%80%E3%81%AB%E8%83%8C%E6%99%AF%E8%89%B2%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>いい感じの場所に背景色をつけるにはどうすればいいの？</h3>

<p>もう一つ考えなければならないのが、どこに背景を設置するかです。やり方はいろいろ考えられますが、後述するサンプル実装の場合は、textareaの文字列の背後に全く同じ透明な文字列を設置して、該当箇所を強調させています。全く同じ文字列を全く同じように背後に置いてあるので、位置がピタリと合う訳ですね。他にもやり方はありそうなので考えてみてください。</p>

<h2>
<span id="サンプル" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>サンプル</h2>

<p>で、試しに作ってみました。</p>

<ul>
<li><a href="https://github.com/yuku-t/jquery-overlay" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/yuku-t/jquery-overlay</a></li>
</ul>

<p>このプラグインは正規表現で指定された文字列に背景色を付けるシンプルなものです。</p>

<p>非常にシンプルなので、先日公開したtextareaに補完機能をつけるプラグインとも簡単に結合することが可能です。プラガブル万歳＼(^o^)／</p>

<ul>
<li><a href="http://yuku-t.com/jquery-textcomplete/#textarea3" class="autolink" rel="nofollow noopener" target="_blank">http://yuku-t.com/jquery-textcomplete/#textarea3</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/a4f2bec2b096ed33d70af18746db04ef455b6907/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f63653037303833382d306331302d393164342d313961612d6538333936623262636434302e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a4f2bec2b096ed33d70af18746db04ef455b6907/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f63653037303833382d306331302d393164342d313961612d6538333936623262636434302e676966" alt="kw1I6VWtpY.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/ce070838-0c10-91d4-19aa-e8396b2bcd40.gif"></a></p>

<h2>
<span id="textareaを使うと背景色を変えるくらいしか強調手段がない" class="fragment"></span><a href="#textarea%E3%82%92%E4%BD%BF%E3%81%86%E3%81%A8%E8%83%8C%E6%99%AF%E8%89%B2%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B%E3%81%8F%E3%82%89%E3%81%84%E3%81%97%E3%81%8B%E5%BC%B7%E8%AA%BF%E6%89%8B%E6%AE%B5%E3%81%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>textareaを使うと背景色を変えるくらいしか強調手段がない</h2>

<p>上記のサンプルページを表示してみた人は気がついたかも知れませんが、背景色を付ける以外の強調方法を使えません。例えば文字の色を変えたり、イタリックにしたり、太さを変えたり、大きさを変えたりしたくてもできないのです。</p>

<p>理由はtextareaを使っていることです。あくまでも表示されている文字列はtextarea由来のものであり、こいつらの一部の色を変えたり、イタリックにしたりすることができないのは最初に見た通りです（てか、それができるならこんな回りくどいことをしなくてもいいわけで）。</p>

<h3>
<span id="contenteditableを使えばなんとかなる" class="fragment"></span><a href="#contenteditable%E3%82%92%E4%BD%BF%E3%81%88%E3%81%B0%E3%81%AA%E3%82%93%E3%81%A8%E3%81%8B%E3%81%AA%E3%82%8B"><i class="fa fa-link"></i></a>contentEditableを使えばなんとかなる？</h3>

<p>contentEditableは使えないのか？と思う向きもあるかと思います。たしかにその通りでcontentEditableを使うこともできるかも知れません。こちらを使えば文字列の大きさも好き勝手に変えられるので表現力は上です。<br>
が、いかんせん面倒なのでやってない＋contentEditable内でのカーソル位置の制御が難しい（JavaScriptから調整不可？）なので、僕は諦めた次第です。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>textareaの強調表示は、textareaを透明にして後ろにいい感じの背景を設置してるだけ</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />20位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>199</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/c7ab1b1519825cc2c06f">GOPATH は適当に決めて問題ない</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-19 16:50:24</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Go]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="tldr" class="fragment"></span><a href="#tldr"><i class="fa fa-link"></i></a>TL;DR</h1>

<ul>
<li>
<code>go get</code> は Ruby でいう <code>gem</code> みたいなもん</li>
<li>
<code>$GOPATH</code> は自分の環境に合わせて好きに指定してよい

<ul>
<li>例えば <code>$HOME/.go</code> とか <code>$HOME/go</code> とか</li>
</ul>
</li>
<li>好きに設定してもいいけど、一度設定したらそれをずっと使い続けた方がたぶんいい</li>
</ul>

<h1>
<span id="ことの始まり" class="fragment"></span><a href="#%E3%81%93%E3%81%A8%E3%81%AE%E5%A7%8B%E3%81%BE%E3%82%8A"><i class="fa fa-link"></i></a>ことの始まり</h1>

<p>homebrewでGoをインストールしたらのっけから</p>

<blockquote>
<p>Go 1.1 から <code>go get</code> コマンドは <code>$GOROOT</code> をパッケージダウンロード先として使わなくなりなりました。<br>
<code>go get</code> 使うには <code>$GOPATH</code> が必要です。</p>
</blockquote>

<p>と言われて、間違った設定をしてあとで苦労したくなかったので色々と調べた。</p>

<h2>
<span id="go-get-コマンド" class="fragment"></span><a href="#go-get-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89"><i class="fa fa-link"></i></a>go get コマンド</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>% go help get
</pre></div></div>

<blockquote>
<p>使い方: go get [-d] [-fix] [-u] [build flags] [packages]</p>

<p>パッケージ（依存するものも）をダウンロードしてインストールする。</p>

<p>-d フラグがあるとダウンロードだけでインストールしない。<br>
-fix フラグは fix tool をダウンロードしたパッケージの依存関係を解消する前に実行する。（詳しくは <code>godoc fix</code> を見れば分かるらしい。）<br>
-u フラグがあるとパッケージとその依存パッケージをアップデートする。</p>

<p>build flagsは <code>go build</code> と <code>go install</code> のフラグを指定する。</p>

<p>パッケージを確認するとき <code>get</code> はローカルにインストールされている Go のバージョンと適合するブランチやタグを探す。最も重要なルールは、ローカルで走っているのが "go1" だったとすると、 <code>get</code> は "go1" という名前のブランチとタグを探すということ。もしそういうバージョンが無かったら、最新のものを取ってくる。</p>

<p>パッケージの指定の仕方については <code>go help packages</code> を見る。</p>

<p>どうやってソースコードを見つけるかは <code>go help remote</code> を見る。</p>
</blockquote>

<h2>
<span id="gopath" class="fragment"></span><a href="#gopath"><i class="fa fa-link"></i></a>GOPATH</h2>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>% go help gopath
</pre></div></div>

<blockquote>
<p>Goパスは import 文の解決に使われる。go/build パッケージで実装されている。</p>

<p>環境変数 GOPATH は Go コードを探す場所を表す。（PATH みたいな感じ）<br>
Unix の場合はコロンで区切る。<br>
Windows の場合はセミコロンで区切る。<br>
Plan 9だとリスト。</p>

<p>GOPATH は標準の Go の外でパッケージをビルドしたりインストールする際に設定されていなければならない。</p>

<p>GOPATH に入っているディレクトリはそれぞれ決められた構造を持っていなければならない:</p>

<p>（詳しくは割愛）</p>

<p>例:</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>GOPATH=/home/user/gocode

/home/user/gocode/
    src/
        foo/
            bar/               (go code in package bar)
                x.go
            quux/              (go code in package main)
                y.go
    bin/
        quux                   (installed command)
    pkg/
        linux_amd64/
            foo/
                bar.a          (installed package object)
</pre></div></div>

<p>Go は GOPATH の各ディレクトリからソースコードを探すが、ダウンロードしたファイルは常に GOPATH の中で一番最初のディレクトリにインストールされる。</p>
</blockquote>

<h2>
<span id="結局どうすればいいのか" class="fragment"></span><a href="#%E7%B5%90%E5%B1%80%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>結局どうすればいいのか</h2>

<p>GOPATH は決まった場所を指定するものではなく、自分の環境で好きな場所を勝手に指定すればよい、という性質のものらしい。つまり、正しい場所を指定しておかないと Go が使えないとかそういった性質のものではない（それを恐れていた）、と。</p>

<p>インターネットを観測した感じだと</p>

<ul>
<li><code>$HOME/go</code></li>
<li><code>$HOME/.go</code></li>
</ul>

<p>あたりを設定している人が多い印象。設定は <code>.bashrc</code> や <code>.zshrc</code> で行う。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">~/.bashrc</span></div>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/.go
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />21位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>182</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/40bcc63bb8ad94f083f1">zshでログイン・ログアウト時に実行されるファイル</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-16 23:39:55</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Zsh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今まではバカの一つ覚えのように何でもかんでも<code>$HOME/.zshrc</code>に書いていたけど、サーバ管理をよくするようになってきて、複数アカウントの共通設定とかをしたくなったので調べた。</p>

<h1>
<span id="順番" class="fragment"></span><a href="#%E9%A0%86%E7%95%AA"><i class="fa fa-link"></i></a>順番</h1>

<p>以下の<code>$ZDOTDIR</code>は指定されていない場合<code>$HOME</code>になる。</p>

<p>ログイン時</p>

<ol>
<li>/etc/zshenv</li>
<li>$ZDOTDIR/.zshenv</li>
<li>/etc/zprofile</li>
<li>$ZDOTDIR/.zprofile</li>
<li>$ZDOTDIR/.zshrc</li>
<li>/etc/zlogin</li>
<li>$ZDOTDIR/.zlogin</li>
</ol>

<p>ログアウト時</p>

<ol>
<li>$ZDOTDIR/.zlogout</li>
<li>/etc/zlogout</li>
</ol>

<p>言うまでもなく、個人的な設定は<code>$ZDOTDIR</code>に、汎用的な設定は<code>/etc</code>に書く。</p>

<h1>
<span id="各種説明" class="fragment"></span><a href="#%E5%90%84%E7%A8%AE%E8%AA%AC%E6%98%8E"><i class="fa fa-link"></i></a>各種説明</h1>

<h2>
<span id="zshenv" class="fragment"></span><a href="#zshenv"><i class="fa fa-link"></i></a>zshenv</h2>

<p>必ず実行される。<code>/etc/zshenv</code>は上書き不可で<code>$PATH</code>や<code>$MANPATH</code>の設定がされる。<br>
<code>$ZDOTDIR/.zshenv</code>にはいかなる場合も設定したい項目を設定する感じ。manファイルではできるだけ小さくシンプルに保つように勧めている。<br>
<code>ssh</code>コマンドの引数でログイン後に行うコマンドを指定すると、それだけを実行してssh接続を直ぐに切るが、そのような場合も<code>zshenv</code>は実行される。この場合以下のやつは全部実行されない。</p>

<h2>
<span id="zprofile" class="fragment"></span><a href="#zprofile"><i class="fa fa-link"></i></a>zprofile</h2>

<p>ログイン時に一回だけ実行される。なのでzshの関数の定義とかはここに書くといいのかも知れない。あと、外部の設定ファイルを読み込むのもここに書くとよさそう。</p>

<h2>
<span id="zshrc" class="fragment"></span><a href="#zshrc"><i class="fa fa-link"></i></a>zshrc</h2>

<p>インタラクティブシェルの時に実行される。つまり</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">zsh</span></div>
<div class="highlight"><pre><span></span><span class="c1"># ログイン時は4種類とも実行される</span>
$ zsh <span class="c1"># 既にログインしている状態で改めてzshを起動する</span>
<span class="c1"># /etc/zshenv</span>
<span class="c1"># $HOME/.zshenv</span>
<span class="c1"># /etc/zshrc</span>
<span class="c1"># $HOME/.zshrc</span>
$ <span class="c1"># zprofileとzloginは実行されない</span>
</pre></div>
</div>

<h2>
<span id="zlogin" class="fragment"></span><a href="#zlogin"><i class="fa fa-link"></i></a>zlogin</h2>

<p>ログイン時に一回だけ実行される。<code>zprofile</code>があるのにわざわざ用意されているということは<code>zshrc</code>で行ったなにかしらの設定に依存するが、一回だけでいいような処理を書く場所だと思われる。イマイチそういう状況が思い浮かばないがきっとそう。</p>

<h2>
<span id="zlogout" class="fragment"></span><a href="#zlogout"><i class="fa fa-link"></i></a>zlogout</h2>

<p>基本的にログインシェルから抜ける時に実行される。ただし、別プロセスに明け渡す形で終了する場合（<code>execve</code>システムコールを呼ぶとか？）は実行されないらしい。</p>

<h1>
<span id="利用例" class="fragment"></span><a href="#%E5%88%A9%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>利用例</h1>

<p>例えばマルチユーザモードでrvmをインストールした場合、rvmは標準で<code>/etc/profile.d/rvm.sh</code>を作成する。Linuxの<code>/etc/profile</code>では<code>/etc/profile.d/*.sh</code>が読み込まれるように設定されており、bashがこれを読むので、結果的に<code>rvm.sh</code>が読み込まれるけど、zshだと読み込んでくれない。そこで<code>/etc/zprofile</code>に以下を追記する</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">/etc/zprofile</span></div>
<div class="highlight"><pre><span></span><span class="k">for</span> i in /etc/profile.d/*.sh <span class="p">;</span> <span class="k">do</span>
    <span class="o">[</span> -r <span class="nv">$i</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="nv">$i</span>
<span class="k">done</span>
</pre></div>
</div>

<p>こうすればこのサーバでログインシェルとしてzshを使っている人全員がrvmを使えるようになる。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />22位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>159</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/0ac33cea18e10f14e185">Rubocopをsyntasticを使ってVimから自動実行する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-09 16:12:46</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rubyコードを静的にチェックしてくれる<a href="https://github.com/bbatsov/rubocop" rel="nofollow noopener" target="_blank">Rubocop</a>をVimから実行するプラグインには専用の<a href="https://github.com/ngmy/vim-rubocop" rel="nofollow noopener" target="_blank">vim-rubocop</a>もあるんですが、このためだけのためにインストールするのが嫌だったので、<a href="https://github.com/scrooloose/syntastic" rel="nofollow noopener" target="_blank">syntastic</a>から実行するようにしました。</p>

<p>追記: 2017年現在、 syntastic から <a href="https://github.com/w0rp/ale" rel="nofollow noopener" target="_blank">ale</a> に乗り換えました。ale は syntastic と異なり非同期で実行されるので Vim が固まりません。</p>

<h1>
<span id="インストール" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>インストール</h1>

<p>何はともあれNeoBundleでsyntasticをインストール（NeoBundle自体の使い方については <a href="http://qiita.com/puriketu99/items/1c32d3f24cc2919203eb" id="reference-02efd26ae246838cfbbe">Vim - NeoBundleの導入 - Qiita</a>などを参照してください）</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vimrc</span></div>
<div class="highlight"><pre><span></span>NeoBundle <span class="s1">'scrooloose/syntastic'</span>
</pre></div>
</div>

<p>それとRubocopもインストールします。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>gem i rubocop
</pre></div></div>

<h1>
<span id="rubocopを使うように設定する" class="fragment"></span><a href="#rubocop%E3%82%92%E4%BD%BF%E3%81%86%E3%82%88%E3%81%86%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Rubocopを使うように設定する</h1>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vimrc</span></div>
<div class="highlight"><pre><span></span>NeoBundle <span class="s1">'scrooloose/syntastic'</span>
<span class="k">let</span> <span class="k">g</span>:syntastic_mode_map <span class="p">=</span> { <span class="s1">'mode'</span>: <span class="s1">'passive'</span><span class="p">,</span>
            \ <span class="s1">'active_filetypes'</span>: [<span class="s1">'ruby'</span>] }
<span class="k">let</span> <span class="k">g</span>:syntastic_ruby_checkers <span class="p">=</span> [<span class="s1">'rubocop'</span>]
</pre></div>
</div>

<p><code>syntastic_mode_map</code> は <code>'active'</code> もしくは <code>'passive'</code> を指定します。 <code>'active'</code> だとバッファを保存するたびにsyntasticが走り、 <code>'passive'</code> の場合は <code>:SyntasticCheck</code> 実行時に走ります。</p>

<p><code>'active_filetypes'</code> は保存の度にsyntasticを走らせるファイルタイプを指定します。</p>

<p>２つをあわせると、基本的にsyntasticは走らせないけど、rubyのときだけは自動的に走らせる、という設定になります。</p>

<p><code>syntastic_ruby_checkers</code> はrubyでsyntasticが走らせるツールを指定するものです。</p>

<h1>
<span id="使ってみる" class="fragment"></span><a href="#%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>使ってみる</h1>

<p>あとはrubyファイルを開いて保存するだけです。</p>

<p>syntasticはVimをブロックするので大きなファイルだとストレスたまるかも知れません。その場合は <code>'active_filetypes'</code> ではなく<code>'passive_filetypes'</code> に指定して、必要なタイミングで <code>:SyntasticCheck</code> を実行するようにするといいでしょう。</p>

<p>もしくは <code>:SyntasticToggleMode</code> を実行すると active と passive を切り換えることもできます。</p>

<h1>
<span id="合わせて読みたい" class="fragment"></span><a href="#%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>合わせて読みたい</h1>

<ul>
<li><a href="http://qiita.com/yaotti/items/4f69a145a22f9c8f8333" id="reference-cc4a713efced5f4c00be">Ruby - Rubocopを使ってコーディングルールへの準拠チェックを自動化 - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />23位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>139</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/5ab4fbe404b718999a35">gem installでGitHubリポジトリにある最新版をインストールする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-06-06 16:38:45</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>稀に</p>

<blockquote>
<p>masterでは直ってるけど、Rubygemsにはまだ出てないから、Gemfileに</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s1">'spring'</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s2">"jonleighton/spring"</span>
</pre></div></div>

<p>って書いて <code>bundle update spring</code> を実行してね。</p>

<p>参考: <a href="https://github.com/jonleighton/spring/issues/143#issuecomment-17984728" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/jonleighton/spring/issues/143#issuecomment-17984728</a></p>
</blockquote>

<p>みたいなことがある。だいたいの場合はこれでいいんだけど、ここで引用しているspringの場合、これで直るのは <code>bundle exec spring</code> だけで、 <code>bundle exec</code> 無しだと実行できない。（僕の勘違いかも知れないので、正しいやり方を知っている人は是非コメントで教えてください。）</p>

<p>我慢して古いバージョンをRubygemsから引っ張ってきてインストールしてもいいんだけど、やっぱりbundlerでインストールしてあるのと同じバージョンにしたい。</p>

<p>で、gemコマンドにはgitリポジトリを指定して直接インストールする機能が無いので、こういう場面ではspecific_installというgemを使う。今回の場合は以下のようになる。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>gem install specific_install
gem specific_install -l <span class="s1">'git://github.com/jonleighton/spring.git'</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />24位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>134</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/7c2077e31b2480a2689e">一日のGitコミットをMarkdownに変換するワンライナー</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-07 11:42:42</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> <b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="環境非依存化したもの" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E9%9D%9E%E4%BE%9D%E5%AD%98%E5%8C%96%E3%81%97%E3%81%9F%E3%82%82%E3%81%AE"><i class="fa fa-link"></i></a>環境非依存化したもの</h1>

<p><a href="/suin" class="user-mention js-hovercard" title="suin" data-hovercard-target-type="user" data-hovercard-target-name="suin">@suin</a> さんの協力により環境非依存になりました（zshとbashで動作確認）</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">"</span><span class="k">$(</span><span class="nv">PROJECT</span><span class="o">=</span><span class="k">$(</span><span class="nv">url</span><span class="o">=</span><span class="k">$(</span>git config remote.origin.url<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nv">url</span><span class="o">=</span><span class="si">${</span><span class="nv">url</span><span class="p">#*github.com?</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="si">${</span><span class="nv">url</span><span class="p">%.git</span><span class="si">}</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"hash | title"</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"-----|------"</span> <span class="o">&amp;&amp;</span> git log --since<span class="o">=</span><span class="s1">'12 hours ago'</span> --author<span class="o">=</span><span class="k">$(</span>git config user.email<span class="k">)</span> --pretty<span class="o">=</span><span class="s2">"format:[%h](https://github.com/</span><span class="nv">$PROJECT</span><span class="s2">/commit/%h) | %s"</span> <span class="p">|</span> perl -nle <span class="s2">"\$_ =~ s|#(\\d+)|[#\\1](https://github.com/</span><span class="si">${</span><span class="nv">PROJECT</span><span class="si">}</span><span class="s2">/pull/\\1)|g; print \$_"</span><span class="k">)</span><span class="s2">"</span> <span class="p">|</span> pbcopy
</pre></div></div>

<p>一応これが完成形ですが、ここまでくると一つのスクリプトファイルにした方がよさそうな気がしますね。</p>

<p><em>（追記ここまで）</em></p>

<hr>

<p>日報みたいなものを毎日書くことにしているんですが、そこにその日のコミットログを書いておくと便利だと気が付きました。</p>

<p>GitHubリポジトリが github.com/yuku-t/hoge にあり、authorにYukuという文字列を含むとします。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>git log --since<span class="o">=</span><span class="s1">'12 hours ago'</span> --author<span class="o">=</span>Yuku --pretty<span class="o">=</span><span class="s1">'format:[%h](https://github.com/yuku-t/hoge/commit/%h) | %s'</span> <span class="p">|</span> perl -nle <span class="s1">'$_ =~ s|#(\d+)|[#\1](https://github.com/yuku-t/hoge/pull/\1)|g; print $_'</span>
</pre></div></div>

<p>これ実行すると</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[abcdef](https://github.com/yuku-t/hoge/commit/abcdef) | コミットタイトル
[123456](https://github.com/yuku-t/hoge/commit/123456) | Merge pull request [#1](https://github.com/yuku-t/hoge/pull/1)
</pre></div></div>

<p>みたいなのが標準出力されます。コミットのハッシュとPullRequestのマージコミットの場合はそれに対するリンクも作成しています。</p>

<p>簡単にここで使ってる <code>git-log</code> のオプションについて説明するとこんな感じ。詳しくは <code>man git-log</code> 参照。</p>

<table>
<thead>
<tr>
<th>名前</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>--author</td>
<td>コミットした人で絞込み</td>
</tr>
<tr>
<td>--since</td>
<td>コミット日時で絞込み</td>
</tr>
<tr>
<td>--pretty</td>
<td>出力される内容を変更</td>
</tr>
</tbody>
</table>

<p>でIncrementsでは <a href="https://teams.qiita.com/" rel="nofollow noopener" target="_blank">Qiita:Team</a> を使っているので、Qiita Markdownのテーブル記法を使うようにワンライナーをちょちょっと改造する（<code>pbcopy</code> コマンド使ってるのでMac限定）</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">'</span>
<span class="s1">hash | title</span>
<span class="s1">-----|------'</span> &gt; tmp<span class="p">;</span> git log --since<span class="o">=</span><span class="s1">'12 hours ago'</span> --author<span class="o">=</span>Yuku --pretty<span class="o">=</span><span class="s1">'format:[%h](https://github.com/yuku-t/hoge/commit/%h) | %s'</span> <span class="p">|</span> perl -nle <span class="s1">'$_ =~ s|#(\d+)|[#\1](https://github.com/yuku-t/hoge/pull/\1)|g; print $_'</span> &gt;&gt; tmp<span class="p">;</span> pbcopy &lt; tmp<span class="p">;</span> rm tmp
</pre></div></div>

<p>これを実行すると以下の内容がクリップボードに入る</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>hash | title
-----|------
[abcdef](https://github.com/yuku-t/hoge/commit/abcdef) | コミットタイトル
[123456](https://github.com/yuku-t/hoge/commit/123456) | Merge pull request [#1](https://github.com/yuku-t/hoge/pull/1)
</pre></div></div>

<p>で、これをそのままMarkdownとして解釈させれば下記のようなテーブルになると</p>

<table>
<thead>
<tr>
<th>hash</th>
<th>title</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/yuku-t/hoge/commit/abcdef" rel="nofollow noopener" target="_blank">abcdef</a></td>
<td>コミットタイトル</td>
</tr>
<tr>
<td><a href="https://github.com/yuku-t/hoge/commit/123456" rel="nofollow noopener" target="_blank">123456</a></td>
<td>Merge pull request <a href="https://github.com/yuku-t/hoge/pull/1" rel="nofollow noopener" target="_blank">#1</a>
</td>
</tr>
</tbody>
</table>

<p>便利だなー</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />25位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>129</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/30015dba2b6497b80074">MavericksでC拡張を含むgemをインストールできない場合の対処法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-29 00:22:43</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Mac]</b> <b>[Boxen]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="tldr" class="fragment"></span><a href="#tldr"><i class="fa fa-link"></i></a>TL;DR</h1>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ xcode-select --install
$ sudo xcodebuild -license
</pre></div></div>

<h1>
<span id="流れ" class="fragment"></span><a href="#%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>流れ</h1>

<p>MavericksにOSをアップデートした後に <code>boxen</code> を実行したら <code>gem install json -v '1.8.1'</code> に失敗した。Boxenはシステムのrubyを使って実行しなければならず、MavericksからシステムのRubyが2.0.0p247に上がった影響で色々と環境構築から必要になるみたいだ。</p>

<p>分かりやすいように <code>gem</code> コマンドだけを実行するとこんなエラーがでる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo gem install json -v '1.8.1'
Fetching: json-1.8.1.gem (100%)
Building native extensions.  This could take a while...
ERROR:  Error installing json:
    ERROR: Failed to build gem native extension.

    /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby extconf.rb
mkmf.rb can't find header files for ruby at /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/lib/ruby/include/ruby.h


Gem files will remain installed in /Library/Ruby/Gems/2.0.0/gems/json-1.8.1 for inspection.
Results logged to /Library/Ruby/Gems/2.0.0/gems/json-1.8.1/ext/json/ext/generator/gem_make.out
</pre></div></div>

<p>何やらヘッダファイルが見つからないとのこと。Command Line Developer Toolsが必要らしいということが分かったのでインストール。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ xcode-select --install
</pre></div></div>

<p>これで十分だと思っていたら次はMakefileの生成に失敗して、Xcodeのライセンスに同意しないといけないので次のコマンドを実行。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo xcodebuild -license
</pre></div></div>

<p>これで無事にjson gemをインストールできた。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ sudo gem install json -v '1.8.1'
Building native extensions.  This could take a while...
Successfully installed json-1.8.1
1 gem installed
$ ./script/boxen  # 成功
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />26位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>115</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/77c23390e52168a2754a">.zshrcで見かけるautoloadの意味と使い方</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-27 00:21:19</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Zsh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>.zshrcにこういうのありませんか？</p>

<div class="code-frame" data-lang="zshrc"><div class="highlight"><pre><span></span>autoload -U compinit
</pre></div></div>

<p>今回はこの <code>autoload</code> が何をするものなのか解説します。</p>

<h2>
<span id="autoloadはシェル関数を読み込む" class="fragment"></span><a href="#autoload%E3%81%AF%E3%82%B7%E3%82%A7%E3%83%AB%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>autoloadはシェル関数を読み込む</h2>

<p><code>autoload</code> はシェル関数を <strong>自動読み込み</strong> するシェルの組み込み関数です。上記のスクリプトの場合、 <code>compinit</code> というシェル関数を自動読み込みします。</p>

<p>シェルコマンドは <code>PATH</code> に入っていればそれだけで実行可能でしたが、シェル関数の場合は関数を定義しなければ使えません。 <code>autoload</code> はファイルシステム上にある関数定義を読み込むための関数なのです。そして <code>autoload</code> 探索するディレクトリは <code>FPATH</code> に入っています。</p>

<p>余談ですが <code>FPATH</code> だと <code>:</code> 区切りの文字列、 <code>fpath</code> だと配列になります。<code>PATH</code> と <code>path</code> と同じですね。</p>

<ul>
<li><a href="http://qiita.com/yuku_t/items/1e6fc02d09038695f805" id="reference-b2de73adb6275b8a781f">シェル関数とシェルコマンドの違い</a></li>
</ul>

<h2>
<span id="autoloadを使ってみる" class="fragment"></span><a href="#autoload%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>autoloadを使ってみる</h2>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% mkdir ~/functions
% <span class="nv">FPATH</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/functions:</span><span class="si">${</span><span class="nv">FPATH</span><span class="si">}</span><span class="s2">"</span>  <span class="c1"># ~/functionsをfpathに登録</span>
% cat <span class="s">&lt;&lt; EOF &gt; ~/functions/test-func</span>
<span class="s">#!/bin/zsh</span>
<span class="s">echo Hello autoload</span>
<span class="s">EOF</span>
% ls ~/functions
. .. test-func
</pre></div></div>

<p>test-func という関数をfpathに登録したので実行してみます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% where test-func
test-func not found
% autoload test-func
% where test-func   <span class="c1"># (1)</span>
test-func <span class="o">()</span> <span class="o">{</span>
    <span class="c1"># undefined</span>
    <span class="nb">builtin</span> autoload -X
<span class="o">}</span>
% test-func
Hello autoload
% where test-func  <span class="c1"># (2)</span>
test-func <span class="o">()</span> <span class="o">{</span>
        <span class="nb">echo</span> Hello autoload
<span class="o">}</span>
</pre></div></div>

<p>たしかに <code>~/functions/test-func</code> の中身を持つ関数が作られました。</p>

<p>ところで <strong>(1)</strong> で表示される関数の中身がなんかおかしいですね。 <code>builtin</code> は引数を強制的に組み込み関数名として解釈する関数なので、結局 <code>autoload -X</code> をやっているだけですが、意図したものとは異なります。一方で一回関数を実行した後の <strong>(2)</strong> になると意図したものになっています。</p>

<p>実はこの <code>-X</code> オプションがない場合、 <code>autoload</code> コマンドは autoload という名前にも関わらず関数を登録するだけで、実体をロードしません。そして <code>-X</code> があると、関数を実際にロードしてかつ即座に実行します。つまり、こうすることでzshは関数を遅延読み込みしているわけですね。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># 下の2行は即座に実行される点で同じ</span>
autoload test-func<span class="p">;</span> test-func
autoload -X test-func  <span class="c1"># 余計な中間関数がないので若干効率的</span>
</pre></div></div>

<p>ロードだけして実行しない場合は <code>+X</code> オプションを使います。先ほどの <code>test-func</code> がまだロードされていない状態だとすると</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% where test-func
test-func not found
% autoload +X test-func  <span class="c1"># ロードする</span>
% where test-func  <span class="c1"># ロード済みになっている</span>
test-func <span class="o">()</span> <span class="o">{</span>
        <span class="nb">echo</span> Hello autoload
<span class="o">}</span>
</pre></div></div>

<p><code>-X</code> と <code>+X</code> オプションは覚えなくていいですが、zshrcでいくら <code>autoload</code> しようが立ち上がり速度にはそこまで影響がない、ということは覚えておいて損は無さそうです。</p>

<h2>
<span id="-uオプション" class="fragment"></span><a href="#-u%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>-Uオプション</h2>

<p>冒頭のコマンド</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>autoload -U compinit
</pre></div></div>

<p>ですが、この <code>-U</code> オプションは一体何の働きをするのでしょう？個人的な観測範囲でいえば <code>autoload</code> で <code>-U</code> を使っていない場面をみたことがありません。</p>

<p>実はこのオプションは、展開される関数の内部で <code>alias</code> の展開を <strong>しない</strong> ためのオプションです。つまり、これがないとあなたが適当に作った<code>alias</code> が干渉して、関数の動作が変わってしまう危険があるので、それを回避するために使うのです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% <span class="nb">alias</span> <span class="nv">foo</span><span class="o">=</span><span class="s1">'echo bar'</span>
% cat <span class="s">&lt;&lt; EOF &gt; with-U &gt; without-U</span>
<span class="s">foo</span>
<span class="s">EOF</span>
% autoload -U with-U<span class="p">;</span> with-U
zsh: <span class="nb">command</span> not found: foo
% autoload without-U<span class="p">;</span> without-U
bar
</pre></div></div>

<p>というわけで <code>autoload</code> を使うときは <strong>必ず</strong> <code>-U</code> オプションを使った方がよさそうです。</p>

<p>ちないに <code>-U</code> と <code>-X</code> は同時には使えないみたいです。なので <code>-U</code> してかつ即座に実行したい場合は下記のようにしなければいけません。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>autoload -U funcname<span class="p">;</span> funcname
</pre></div></div>

<p><code>-X</code> オプションの説明に、シェルスクリプト内部でしか使うことないと思う、みたいなことが書いてあって、たぶんここら辺の事情が関係しているんだと予想してます。</p>

<h2>
<span id="もうちょっと追いかけてみる" class="fragment"></span><a href="#%E3%82%82%E3%81%86%E3%81%A1%E3%82%87%E3%81%A3%E3%81%A8%E8%BF%BD%E3%81%84%E3%81%8B%E3%81%91%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>もうちょっと追いかけてみる</h2>

<p><code>autoload</code> みたいな組み込み関数についてのマニュアルは zshbuiltins(1) にあります。それによると</p>

<blockquote>
<p><code>-X</code>, <code>+X</code>, <code>-w</code> なしの <code>functions -u</code> と等しい</p>
</blockquote>

<p>とあります。そして <code>functions</code> は</p>

<blockquote>
<p><code>-M</code> なしの <code>typeset -f</code> と等しい</p>
</blockquote>

<p>つまり <code>autoload</code> は <code>typeset -fu</code> と等しい、ということになります。そもそも <code>typeset</code> が何をするのかというと、簡単な話が変数宣言です。</p>

<p>例えば環境変数を設定する <code>export</code> は <code>typeset -gx</code> と同じです。 <code>-g</code> はグローバルフラグで、 <code>-x</code> は宣言した変数が環境変数であることを意味します。これによって宣言された変数が環境変数として外部からも利用可能になります。</p>

<p>で、問題の <code>typeset -fu</code> ですが、 <code>-f</code> は関数(function)である、という意味で <code>-u</code> は(<code>-f</code> と一緒に使っている場合)その関数を自動読み込み(autoloading)する、という意味です。</p>

<p>なるほどなるほど</p>

<h2>
<span id="合わせて読みたい" class="fragment"></span><a href="#%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>合わせて読みたい</h2>

<ul>
<li>zshmisc(1) の AUTOLOADING FUNCTIONS</li>
<li>zshbuiltins(1)</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />27位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>101</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/5acef8dd49f67fd7813c">Backbone.js入門 「Model」</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-17 02:11:09</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="閲覧上の注意" class="fragment"></span><a href="#%E9%96%B2%E8%A6%A7%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>閲覧上の注意</h3>

<p>この記事で対象としているバージョン0.5.3は結構古いので注意してください。例えばこの記事の内容でいうと、<code>validate</code>に失敗したときに発生するイベントは<code>'error'</code>から<code>'invalid'</code>に変更されています。</p>

<p>その他の割りと新しい情報は <a href="http://www.adventar.org/calendars/15" rel="nofollow noopener" target="_blank">Backbone.js Advent Calendar 2012</a> などにあります。</p>

<p>（追記ここまで）</p>

<hr>

<p>今日のテーマは <code>Model</code> です。<br>
MVC に関する回で <em>Backbone.js における MVC は Rails などの WAF における MVC よりは伝統的な MVC に近い</em> というようなことを書きました。<br>
しかしながら、モデルに関して言えばどちらの場合も大差ありませんから、気分が楽です。<br>
Rails におけるモデルである ActiveRecord が OR マッパーとしての役割を持っていたり、データのバリデーション機能を持っていたりと、単なるデータを表す以上の機能を備えているように、Backbone.js における <code>Model</code> もサーバと通信してデータを取得・永続化させたり、バリデーションを行うなどの機能を持っています。<br>
今回は <em>データの設定</em> に加え、この <em>データの取得・永続化</em> と <em>データのバリデーション</em> に焦点を当てて <code>Model</code> の使い方を解説したいと思います。</p>

<h1>
<span id="基本的な使い方" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>基本的な使い方</h1>

<p><code>View</code> の回でも述べたように、<code>Model.extend</code> を使います。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"dateTime"</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>
    <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s2">"本文が入力されていません"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<h2>
<span id="initializeattributes-options" class="fragment"></span><a href="#initializeattributes-options"><i class="fa fa-link"></i></a>initialize([attributes][, options])</h2>

<p>インスタンスの初期化時に呼び出されます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Example</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"attrs"</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"options"</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Example</span><span class="p">({</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">});</span>
<span class="c1">// =&gt; "attrs" {a: 1}</span>
<span class="c1">// =&gt; "options" {b: 2}</span>
<span class="nx">e</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)</span> <span class="c1">// =&gt; true</span>
<span class="nx">e</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)</span> <span class="c1">// =&gt; 1</span>
<span class="nx">e</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)</span> <span class="c1">// =&gt; false</span>
<span class="nx">e</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)</span> <span class="c1">// =&gt; undefined</span>
</pre></div></div>

<p><code>has</code> や <code>get</code> は後述。<br>
ここのポイントは、<code>attrs</code> はモデルの値として設定されるが、<code>options</code> はそうではない、ということです。なので、例えばブログの本文や執筆時刻などのように <strong>データベースに保存する情報</strong> は <code>attrs</code> で渡し、<strong>データベースには保存しない設定項目</strong> を渡す場合は <code>options</code> を使うようにするとよいでしょう。</p>

<h1>
<span id="データの設定" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>データの設定</h1>

<p>モデルにデータを設定したり、それを取得、変更したりする方法です。</p>

<h2>
<span id="getattrname" class="fragment"></span><a href="#getattrname"><i class="fa fa-link"></i></a>get(attrName)</h2>

<p>モデルの属名を取得します。これは問題ないですよね。</p>

<h2>
<span id="escapeattrname" class="fragment"></span><a href="#escapeattrname"><i class="fa fa-link"></i></a>escape(attrName)</h2>

<p><code>get</code> と同じですが、XSS などの危険がある箇所ではこちらを使いましょう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span><span class="p">});</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">);</span> <span class="c1">// =&gt; &lt;script&gt;alert('xss')&lt;/script&gt;</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="s1">'text'</span><span class="p">);</span> <span class="c1">// =&gt; &amp;lt;script&amp;gt;alert(&amp;#x27;xss&amp;#x27;)&amp;lt;&amp;#x2F;script&amp;gt;</span>
</pre></div></div>

<h2>
<span id="hasattrname" class="fragment"></span><a href="#hasattrname"><i class="fa fa-link"></i></a>has(attrName)</h2>

<p>モデルに属性が設定されているかどうか。返り値は Boolean です。</p>

<h2>
<span id="setattrs-options" class="fragment"></span><a href="#setattrs-options"><i class="fa fa-link"></i></a>set(attrs, [options])</h2>

<p>属性を設定します。この時、change:attrName イベントが発生します。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">blog</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"change"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"change"</span><span class="p">)});</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"change:text"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"change:text"</span><span class="p">)});</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"foobar"</span><span class="p">});</span> <span class="c1">// change:text と change 両方が出力される</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"text"</span><span class="p">);</span> <span class="c1">// =&gt; foobar</span>
</pre></div></div>

<p>イベントを発生させたくない場合は silent オプションを使います。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">blog</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"hoge"</span><span class="p">},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span> <span class="c1">// 何も出力されない</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"text"</span><span class="p">);</span> <span class="c1">// =&gt; hoge</span>
</pre></div></div>

<p>注意点は、silent を使うと後述する <code>validate</code> を用いたバリデーションも <strong>実行されない</strong> 、という点です。</p>

<h2>
<span id="unsetattrname-options" class="fragment"></span><a href="#unsetattrname-options"><i class="fa fa-link"></i></a>unset(attrName, [options])</h2>

<p><code>attrName</code> の属性を削除して change:attrName イベントを発生させます。こちらもオプションで silent を指定することで抑制できます。</p>

<h2>
<span id="clearoptions" class="fragment"></span><a href="#clearoptions"><i class="fa fa-link"></i></a>clear(options)</h2>

<p>全ての属性を削除して change イベントを発生させます。こちらもオプションで silent を指定することで抑制できます。</p>

<h2>
<span id="previousattrname" class="fragment"></span><a href="#previousattrname"><i class="fa fa-link"></i></a>previous(attrName)</h2>

<p>ここまででモデルの属性まわりのメソッドの説明を行いましたが、その中で change イベントを発生させるものがいくつかありました。<br>
この change イベントに <code>bind</code> されたコールバック関数内でのみ意味を持つのが <code>previous</code> です。<br>
名前の通り、変更される前の値を取得することができます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"change:text"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">previous</span><span class="p">(</span><span class="s2">"text"</span><span class="p">),</span> <span class="nx">val</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">blog</span> <span class="o">=</span> <span class="nx">Blog</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"sample"</span><span class="p">});</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"example"</span><span class="p">});</span> <span class="c1">// =&gt; sample example</span>
</pre></div></div>

<p>前回の値を使ったバリデーションは <code>validate</code> で行うことができるので、こちらは主にログ管理などに使うことになるでしょう。</p>

<h2>
<span id="changeoptions" class="fragment"></span><a href="#changeoptions"><i class="fa fa-link"></i></a>change([options])</h2>

<p>小ネタになるのですが、例えば for ループの中で <code>set</code> を複数回に分けて呼び出して、少しずつ属性を設定するような場面があったら、毎回 change を発生させるのではなく、最後に一回だけ発生させたくなるでしょう。その時、最後の <code>set</code> でだけ silent を <code>false</code> にするのでもいいですが、<code>change</code> を使うと簡単にできます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// 何かの事情で model.set({a: 1, b: 1, c: 1, d: 1}) と書けない</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">b</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">c</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">d</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">change</span><span class="p">();</span> <span class="c1">// 最後に一回だけ change イベントを発生</span>
</pre></div></div>

<p><code>change</code> の代わりに <code>trigger('change')</code> でいいのではないかと思うかも知れませんが、ダメです。理由はソース参照</p>

<h1>
<span id="データの取得と永続化" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%8F%96%E5%BE%97%E3%81%A8%E6%B0%B8%E7%B6%9A%E5%8C%96"><i class="fa fa-link"></i></a>データの取得と永続化</h1>

<p>WEB サーバやブラウザの localStorage からデータを取得してモデルを作ったり、逆にそれらにモデルを保存する方法です。</p>

<h2>
<span id="id" class="fragment"></span><a href="#id"><i class="fa fa-link"></i></a>id</h2>

<p>モデルの主キー。主キーとわざわざ読んでいるのは、この値を使ってアクセスする API の URI を変更し、通常用いられる RESTful API では、この値がデータベース中での主キーと対応する為です。</p>

<h2>
<span id="urlroot" class="fragment"></span><a href="#urlroot"><i class="fa fa-link"></i></a>urlRoot</h2>

<p>次の <code>url</code> 中で用いられる。</p>

<h2>
<span id="url" class="fragment"></span><a href="#url"><i class="fa fa-link"></i></a>url()</h2>

<p>モデルのリソースの URI を返す。<code>id</code> と <code>urlRoot</code> を組み合わせて、<code>/urlRoot/id</code> とするのがデフォルト。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">urlRoot</span><span class="o">:</span> <span class="s1">'/api/blogs'</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">});</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span> <span class="c1">// =&gt; /api/blogs/1</span>
</pre></div></div>

<p>実際に <code>url</code> 自体を直接利用する機会は無いと思います。これは、後述する <code>fetch</code> <code>save</code> <code>destroy</code> の中で利用されます。</p>

<h2>
<span id="fetchoptions" class="fragment"></span><a href="#fetchoptions"><i class="fa fa-link"></i></a>fetch([options])</h2>

<p><code>model.url()</code> にアクセスして帰ってくる JSON を使ってモデルを更新します。例えば、次のようなモデルオブジェクトがあるとします。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">blog</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span> <span class="c1">// =&gt; /api/blogs/1</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span> <span class="c1">// =&gt; undefined</span>
</pre></div></div>

<p>そして、<code>/api/blogs/1</code> にアクセスすると次のような JSON が返ってくる場合</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">"text"</span><span class="o">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="s2">"datetime"</span><span class="o">:</span> <span class="s2">"December 14, 2011 01:36:00"</span><span class="p">}</span>
</pre></div></div>

<p><code>fetch</code> を実行すると次のようになります。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">blog</span><span class="p">.</span><span class="nx">fetch</span><span class="p">()</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span> <span class="c1">// =&gt; foobar</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'datetime'</span><span class="p">)</span> <span class="c1">// =&gt; December 14, 2011 01:36:00</span>
</pre></div></div>

<p><code>options</code> の値が内部では <code>jQuery.ajax</code> に渡されるので、<code>/api/blogs/1?foo=bar</code> のようにクエリ文字を渡したい場合は次のように書きます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">blog</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span><span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">foo</span><span class="o">:</span> <span class="s2">"bar"</span><span class="p">}});</span>
</pre></div></div>

<p>また、<code>fetch</code> した時は change イベントが発生します。抑制するには <code>options</code> に silent です。</p>

<h2>
<span id="parseresponse" class="fragment"></span><a href="#parseresponse"><i class="fa fa-link"></i></a>parse(response)</h2>

<p>さて先ほどの例だと datetime という属性も作られますが、現状では文字列のままです。<code>Date</code> 型のオブジェクトにしたい場合のように、サーバからの返り値を属性に設定するまえに処理したい場合には <code>parse</code> を使いましょう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">urlRoot</span><span class="o">:</span> <span class="s2">"/api/blogs"</span><span class="p">,</span>
    <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">datetime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">datetime</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">resopnse</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="nx">blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">});</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"datetime"</span><span class="p">);</span> <span class="c1">// =&gt; Date オブジェクト</span>
</pre></div></div>

<h2>
<span id="saveattrs-optionsdestroyoptions" class="fragment"></span><a href="#saveattrs-optionsdestroyoptions"><i class="fa fa-link"></i></a>save([attrs], [options])、destroy([options])</h2>

<p><code>url</code> で差される先にデータを保存及び削除します。当然ですが、サーバが RESTful インタフェースを実装している必要があります。Rails で実装する方法については <a href="http://qiita.com/items/1294">RailsアプリでBackbone.jsを使う</a> で取り上げました。</p>

<h1>
<span id="データのバリデーション" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>データのバリデーション</h1>

<h2>
<span id="validateattributes" class="fragment"></span><a href="#validateattributes"><i class="fa fa-link"></i></a>validate(attributes)</h2>

<p><code>set</code> と <code>save</code> で silent が false であるときに実行されます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>
    <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s2">"本文が入力されていません"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p>返り値が会った場合、error イベントが発生します。<br>
これを捕捉するため、<code>bind</code> を使ってもよいですが、特定の状況下でのみ処理を行いたいような場合は、次のように <code>options</code> として error ハンドラを渡すと簡単です。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">blog</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">blog</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s2">""</span><span class="p">})</span> <span class="c1">// =&gt; 本文が入力されていません</span>

<span class="nx">blog</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s2">""</span><span class="p">},</span> <span class="p">{</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span> <span class="c1">// =&gt; hoge</span>
</pre></div></div>

<p>このように、<code>options</code> で error ハンドラが渡された場合、<code>trigger('error')</code> は実行されないので注意が必要です。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>基本的な Model の使い方を見てきました。<br>
次回は、前回取り上げた <code>View</code> と <code>Model</code> の連携に関する話題です。<br>
それではまた明日。</p>

<hr>

<ol>
<li><a href="http://qiita.com/items/16b799d0ec0a0ae3f78e">Backbone.js入門 Events</a></li>
<li><a href="http://qiita.com/items/03f49c64d6c4bacdbb26">Backbone.js入門 MVC</a></li>
<li><a href="http://qiita.com/items/8ee2ed1949cd7c337f06">Backbone.js入門 View</a></li>
<li>Backbone.js入門 Model</li>
<li><a href="http://qiita.com/items/7ce4b1ceb5d18c9cef08">Backbone.js入門 ViewとModelの連携</a></li>
<li><a href="http://qiita.com/items/c19d2fff0dc23e4015ff">Backbone.js入門 Collection</a></li>
<li><a href="http://qiita.com/items/7095a32cc5e438172844">Backbone.js入門 ViewとModelとCollectionの連携</a></li>
<li><a href="http://qiita.com/items/13f3d1f71d31f3e78123">Backbone.js入門 RouterとHistory</a></li>
</ol>

<ul>
<li><a href="https://groups.google.com/forum/?fromgroups#!forum/backbonejs-ja" rel="nofollow noopener" target="_blank">BackboneJS 日本語メーリングリスト</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />28位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>95</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/8ee2ed1949cd7c337f06">Backbone.js入門 「View」</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-16 19:04:59</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="閲覧上の注意" class="fragment"></span><a href="#%E9%96%B2%E8%A6%A7%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>閲覧上の注意</h3>

<p>この記事で対象としているバージョン0.5.3は結構古いので注意してください。例えばこの記事の内容でいえば、<code>$el</code>プロパティなどが追加されています。</p>

<p>その他の割りと新しい情報は <a href="http://www.adventar.org/calendars/15" rel="nofollow noopener" target="_blank">Backbone.js Advent Calendar 2012</a> などにあります。</p>

<p>（追記ここまで）</p>

<hr>

<p>Backbone.js Advent Calendar もようやく折り返し地点。<br>
そんな節目のエントリで取り上げるのが Backbone.js プログラミングでの最重要登場人物の一人である <code>View</code> です。<br>
前回のエントリで Backbone.js では <code>View</code> が各種の処理を起動するということを説明しました。<br>
今回は <code>View</code> を使って、イベントハンドリングを行う方法について主に解説していこうと思います。</p>

<h1>
<span id="view-と-dom-tree" class="fragment"></span><a href="#view-%E3%81%A8-dom-tree"><i class="fa fa-link"></i></a>View と DOM tree</h1>

<p><code>View</code> の役割は大きく分けて2つあります。</p>

<ol>
<li>特定の DOM element を監視し、それを根とする部分木で起こったイベントへの処理を管理する</li>
<li>その部分木に対する DOM 操作</li>
</ol>

<p>です。よく分かりませんね。もう少し詳しく説明しましょう。</p>

<p>HTML が木と呼ばれる構造で表されることはご存知かと思います。例えば次のような HTML があったとしたら</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>hoge<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>foo<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>bar<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<p>これは以下のような木構造で表されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>html
|-- head
|   `-- title
|       `-- hoge
`-- body
    |-- h1
    |   `-- foo
    `-- div
        `-- p
             `-- bar
</pre></div></div>

<p>この時、木構造の一番上にある要素( <em>element</em> )を <strong>根</strong> ( <em>root</em> ) と呼びます。上記の木における根は <code>html</code> です。<br>
ここで、<code>head</code> の中だけを取り出すと</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>hoge<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</pre></div></div>

<p>ですが、これも <code>head</code> を根とする木構造になっています。<code>head</code> を根とする木は <code>html</code> を根とする木の一部を取り出したものなので、前者を後者の <strong>部分木</strong> と呼びます。部分木の取り方は一通りでなく、例えば <code>body</code> を根とする部分木なども存在します。<br>
HTML を IE や Firefox などの WEB ブラウザに読み込ませると、ブラウザは内部で単なる文字列である HTML 文書から、木構造を創り上ます。この木構造自体を <strong>DOM tree</strong>、各要素を <strong>DOM element</strong> と呼びます。</p>

<p>さて、ここで最初の HTML をブラウザに読み込み、表示された「bar」の文字をブラウザ上でクリックしたとします。この時ブラウザは click イベントを作り、<code>p</code> 要素に登録されている click イベントにハンドラに渡します。（この時渡されたイベントオブジェクトに対して、<code>stopPropagation()</code> を呼ばなかった場合）このイベントオブジェクトは次に <code>p</code> 要素の親である <code>div</code> 要素に渡され、一つずつ DOM tree を上に向かって進んでいきます。イベントが水中で発生した空気の泡のようにゆらゆらしながら木構造を上にたどっていく様から、これを <em>イベントバブリング</em> といいます。</p>

<p>Backbone.js において <code>View</code> は特定の要素を担当すると書きました。<br>
つまり、その要素を監視して、そこをイベントバブリングで通過するイベントを捕捉する手段を提供してくれるのが <code>View</code> なのです。<br>
そして、その要素の子供に対する操作(CSSを操作したり、新しい要素を追加したり)も <code>View</code> の役割です。<br>
このような役割を負った <code>View</code> を使うことで嬉しいのは、JavaScript の記述が一箇所に集まることです。<br>
jQuery を使った場合だと、DOM 操作とイベントハンドリングが全く別々の場所にあっても問題が無いですし、というか別々のところに記述されがちです。<br>
それを <code>View</code> を使うと、一つのオブジェクトの中に集められるので、コードがすっきりします。</p>

<p>次からで、具体的な使い方を見て行きましょう。</p>

<h2>
<span id="基本的な書き方" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E6%9B%B8%E3%81%8D%E6%96%B9"><i class="fa fa-link"></i></a>基本的な書き方</h2>

<p><code>View.extend</code> を用いて自分が必要とする View を作ります。<code>extend</code> は <code>View</code> に限らず <code>Model</code> や <code>Collection</code> などでも利用します。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="c1">// 設定項目を書いていく    </span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// インスタンスの生成時に呼ばれる</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span><span class="cm">/* 初期化項目 */</span><span class="p">});</span>
</pre></div></div>

<h2>
<span id="el" class="fragment"></span><a href="#el"><i class="fa fa-link"></i></a>el</h2>

<p><code>View</code> が管理する DOM element を指しています。<br>
設定方法は大きく分けて2通りです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">View1</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"body"</span><span class="p">)</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">view1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View1</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">View2</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
<span class="kd">var</span> <span class="nx">view2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View2</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"#hoge"</span><span class="p">)});</span>
</pre></div></div>

<p><code>View1</code> のようにクラスの定義に書きこむ方法では、インスタンスが全て同じ DOM element を監視することになります。そのため、ここで書いているように <code>body</code> のような <strong>一つしか存在しない要素</strong> に対する <code>View</code> を作る際に便利な方法です。<br>
一方 <code>View2</code> のようにインスタンスの生成時に渡す方法もあり、こちらの方が利用する機会は多いでしょう。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// class='hoge' を全て管理する View</span>
<span class="c1">// 個別対応が難しくなる</span>
<span class="k">new</span> <span class="nx">View2</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">".hoge"</span><span class="p">)});</span>

<span class="c1">// class='hoge' の数だけ View を作る</span>
<span class="c1">// 一つ一つが別々に管理する</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">".hoge"</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nx">View2</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="nx">elem</span><span class="p">});</span>
<span class="p">});</span>
</pre></div></div>

<p>ここまでは、既に DOM tree 上に存在する要素を用いる方法でしたが、新しく要素を作ることもできます。<br>
例えば <code>el</code> を指定せずに <code>View</code> のインスタンスを作ると <code>&lt;div&gt;&lt;/div&gt;</code> を指します。これはメモリ上に存在するだけで、ブラウザには表示されません。<br>
このような初期状態を設定するには <code>tagName</code> と <code>className</code> が使えます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">tagName</span><span class="o">:</span> <span class="s2">"span"</span><span class="p">,</span>
    <span class="nx">className</span><span class="o">:</span> <span class="s2">"foo"</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">();</span>
<span class="nx">myView</span><span class="p">.</span><span class="nx">el</span> <span class="c1">// =&gt; &lt;span class='foo'&gt;&lt;/span&gt; まだブラウザには表示されていない。</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"body"</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">myView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
<span class="nx">myView</span><span class="p">.</span><span class="nx">el</span> <span class="c1">// =&gt; &lt;span class='foo'&gt;&lt;/span&gt; ブラウザに表示されている。</span>
</pre></div></div>

<h2>
<span id="events" class="fragment"></span><a href="#events"><i class="fa fa-link"></i></a>events</h2>

<p><code>View</code> が管理する DOM element の指定方法が分かりました。次は、これを根とする DOM tree で発生したイベントを捕捉する方法です。こちらも指定方法が2通りありますがここではより一般的な <code>events</code> を使う方法を紹介します。もう一つの方法は <a href="http://qiita.com/items/1256">動的に作られる要素にイベントをbindする</a> を参照してください。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"foo"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"bar"</span><span class="p">&gt;</span>BAR<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"baz"</span><span class="p">&gt;</span>BAZ<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">el</span><span class="o">:</span> <span class="s2">"#foo"</span><span class="p">,</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"click"</span> <span class="o">:</span> <span class="s2">"click"</span><span class="p">,</span> <span class="c1">// #foo 以下で発生する全ての click イベント</span>
        <span class="s2">"click .bar"</span> <span class="o">:</span> <span class="s2">"clickBar"</span><span class="p">,</span> <span class="c1">// #foo 以下の .bar で発生する click イベント</span>
        <span class="s2">"click .baz"</span> <span class="o">:</span> <span class="s2">"clickBaz"</span>
    <span class="p">},</span>
    <span class="nx">click</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"click"</span><span class="p">)</span> <span class="p">},</span>
    <span class="nx">clickBar</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"clickBar"</span><span class="p">)</span> <span class="p">},</span>
    <span class="nx">clickBaz</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"clickBaz"</span><span class="p">)</span> <span class="p">}</span>
<span class="p">});</span>
<span class="k">new</span> <span class="nx">MyView</span><span class="p">();</span>
</pre></div></div>

<p>ここで BAR をクリックすると <code>click</code> と <code>clickBar</code> が、<strong>両方</strong> 出力されます。<br>
簡単ですね。<br>
これを jQuery を用いて書くとこんな感じになるでしょうか。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s2">"#foo"</span><span class="p">).</span><span class="nx">delegate</span><span class="p">(</span><span class="s2">"click"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"click"</span><span class="p">)</span> <span class="p">});</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#foo .bar"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"clickBar"</span><span class="p">)</span> <span class="p">});</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#foo .baz"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"clickBaz"</span><span class="p">)</span> <span class="p">});</span>
</pre></div></div>

<p>この程度の例だと、まだ <code>View</code> を使う良さがわかりにくいかも知れませんが、もっと大規模な JavaScript になってきた場合コードが分散してしまう可能性もありますし、<code>Model</code> と連携するようになってくると管理するのも大変です。<br>
また、今回は <code>click</code> イベントの場合だけをハンドリングするようにしましたが、他にも <code>dblclick</code> <code>mouseover</code> なども組み合わせていくこともできますし、どこに追加すればよいのかも一目瞭然です。</p>

<h2>
<span id="render" class="fragment"></span><a href="#render"><i class="fa fa-link"></i></a>render</h2>

<p>次のようなことをしたい場面での <code>View</code> の使い方です。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="c">&lt;!-- これを --&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"user"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="c">&lt;!-- このように変更したい --&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"user"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"name"</span><span class="p">&gt;</span>foo<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"text"</span><span class="p">&gt;</span>bar<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>この場合なら、<code>&lt;div id='user'&gt;&lt;/div&gt;</code> を <code>el</code> とする <code>View</code> を作ればいいわけです。<br>
その際に、<code>el</code> の下に対する DOM 操作を記述するのが <code>render</code> です。<br>
しかし、これは強制ではなく、別の名前を使っていても問題ありません。<br>
例えばこんな感じでしょうか。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">UserView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#user'</span><span class="p">),</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;span class="name"&gt;foo&lt;/span&gt;&lt;span class="text"&gt;bar&lt;/span&gt;'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="k">new</span> <span class="nx">UserView</span><span class="p">();</span>
</pre></div></div>

<p>これでも問題ありませんが、<code>Model</code> と連携したりして、もっと複雑になるとしんどいですし、というか、name や text の内容は簡単に変えられるようにしたいですね。<br>
こういう場合は underscore.js に含まれる <code>template</code> 機能を使いましょう。<br>
こんな感じで、まずはタグの中身を HTML に用意します。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="c">&lt;!-- type='text/template' を忘れずに(text/javascript でなければOK) --&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/template"</span> <span class="na">id</span><span class="o">=</span><span class="s">"user-template"</span><span class="p">&gt;</span>
  <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"name"</span><span class="o">&gt;&lt;%=</span> <span class="nx">name</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt;</span>
  <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"text"</span><span class="o">&gt;&lt;%=</span> <span class="nx">text</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt;</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>そして <code>render</code> メソッドを以下のようにします。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#user-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">(),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">}));</span>
<span class="p">}</span>
</pre></div></div>

<p>これなら、後で挿入する要素が増えても、元になっている HTML タグの中身を変更するだけでいいので楽ですね。<br>
underscore.js のドキュメントに関しては <a href="https://sites.google.com/site/nextliteracy/javascript/underscore-js" rel="nofollow noopener" target="_blank">有志の方が日本語訳を公開してくれている</a>ので、そちらを参照してください。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<ul>
<li>
<code>View</code> はある要素とその子要素で発生するイベントに対する処理を記述するもの</li>
<li>その要素は <code>View.el</code> で表される</li>
<li>イベントハンドリングのルールは <code>events</code> に書く</li>
</ul>

<p>次回は <code>Model</code>、そしてその次は <code>View</code> の中で <code>Model</code> を如何にして使うかに焦点を当てて解説していこうと思います。<br>
それではまた明日</p>

<hr>

<ol>
<li><a href="http://qiita.com/items/16b799d0ec0a0ae3f78e">Backbone.js入門 Events</a></li>
<li><a href="http://qiita.com/items/03f49c64d6c4bacdbb26">Backbone.js入門 MVC</a></li>
<li>Backbone.js入門 View</li>
<li><a href="http://qiita.com/items/5acef8dd49f67fd7813c">Backbone.js入門 Model</a></li>
<li><a href="http://qiita.com/items/7ce4b1ceb5d18c9cef08">Backbone.js入門 ViewとModelの連携</a></li>
<li><a href="http://qiita.com/items/c19d2fff0dc23e4015ff">Backbone.js入門 Collection</a></li>
<li><a href="http://qiita.com/items/7095a32cc5e438172844">Backbone.js入門 ViewとModelとCollectionの連携</a></li>
<li><a href="http://qiita.com/items/13f3d1f71d31f3e78123">Backbone.js入門 RouterとHistory</a></li>
</ol>

<ul>
<li><a href="https://groups.google.com/forum/?fromgroups#!forum/backbonejs-ja" rel="nofollow noopener" target="_blank">BackboneJS 日本語メーリングリスト</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />29位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>82</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/ad072418290a2b01a35a">Gitフックを使っておかしいRubyコードをコミットできないようにする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-20 16:12:09</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rubyコードを<a href="https://github.com/bbatsov/rubocop" rel="nofollow noopener" target="_blank">Rubocop</a>を使って静的に解析していますが、それを自動化するべくGitフックにしました。</p>

<p>下記の内容の.git/hooks/pre-commitファイルを作ります。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">.git/hooks/pre-commit</span></div>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
git diff --cached --name-only --diff-filter<span class="o">=</span>AM <span class="p">|</span> grep <span class="s1">'\.rb$'</span> <span class="p">|</span> xargs rubocop
<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>

<p><code>grep '\.rb$'</code> で拡張子が <code>rb</code> であるファイル、という意味なので、必要に応じてこの部分を変更してください。例えば <code>app</code> ディレクトリ以下のみにしたければ <code>^app/.*\.rb$</code> にします。<br>
忘れずに実行権限をつけます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>chmod +x .git/hooks/pre-commit
</pre></div></div>

<p>すると <code>git-commit</code> 時に自動的に追加・変更されたRubyファイルに対してRubocopが走るようになります。Rubocopに通らないとコミットできません <img alt=":trollface:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/trollface.png" title=":trollface:" width="20"> </p>

<h2>
<span id="背景" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>背景</h2>

<p><a href="http://qiita.com/yuku_t/items/0ac33cea18e10f14e185" id="reference-973aa2ef2dba450b7679">Ruby - Rubocopをsyntasticを使ってVimから自動実行する - Qiita</a> でVimからRubocopを使うようにしたのはいいけど、保存の度に一瞬Vimが止まってしまうのが非常にストレスフルだったので、Gitフックに移動させたのでした。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />30位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>78</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/78f32d6e5d21aee4e745">Capistrano3におけるRailsのデプロイタスクの内部実装</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-02 19:52:18</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[capistrano]</b> <b>[unicorn]</b> <b>[bundler]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://www.capistranorb.com/" rel="nofollow noopener" target="_blank">Capistrano</a>はRailsアプリケーション専用のデプロイツールとして生まれたという歴史的な背景から、今までRails用の機能がCoreモジュールに組み込まれていましたが、昨年リリースされたCapistrano3からはそういった特定のドメインに特化した機能がCoreから排除されて別のRubygemsとして提供されるようになりました。</p>

<p>本稿では、それらRailsデプロイまわりの機能について見ていきたいと思います。</p>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<p>Capistrano3のデプロイフレームワークについては下記の記事を参照してください。</p>

<ul>
<li><a href="http://qiita.com/yuku_t/items/01c0ec4389db143e27f5" id="reference-226e451ade2d92cfe6b9">Capistrano3のデプロイフレームワークの使い方 - Qiita</a></li>
</ul>

<h2>
<span id="capistranorailsとcapistranobundler" class="fragment"></span><a href="#capistranorails%E3%81%A8capistranobundler"><i class="fa fa-link"></i></a>capistrano/railsとcapistrano/bundler</h2>

<p>具体的にはRailsまわりの機能は<a href="https://github.com/capistrano/rails" rel="nofollow noopener" target="_blank">capistrano-rails</a>と<a href="https://github.com/capistrano/bundler" rel="nofollow noopener" target="_blank">capistrano-bundler</a>というRubygemsに分割されています。</p>

<p>とりあえずGemfileに入れときましょう。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'capistrano'</span><span class="p">,</span> <span class="s1">'~&gt; 3.0'</span>
  <span class="n">gem</span> <span class="s1">'capistrano-bundler'</span>
  <span class="n">gem</span> <span class="s1">'capistrano-rails'</span>
<span class="k">end</span>
</pre></div>
</div>

<p>そしてCapfileで <code>require</code> します。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Capfile</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'capistrano/setup'</span>   <span class="c1"># おまじない</span>
<span class="nb">require</span> <span class="s1">'capistrano/deploy'</span>

<span class="nb">require</span> <span class="s1">'capistrano/rails'</span>  <span class="c1"># 内部でcapistrano/bundlerをrequireしてる</span>

<span class="c1"># 個別に書く場合</span>
<span class="nb">require</span> <span class="s1">'capistrano/bundler'</span>  <span class="c1"># rails使う場合はbundlerは必須、、ですよね？</span>
<span class="nb">require</span> <span class="s1">'capistrano/rails/assets'</span>  <span class="c1"># asset:precompileとかが定義されてる</span>
<span class="nb">require</span> <span class="s1">'capistrano/rails/migrations'</span>  <span class="c1"># db:migrateとかが定義されてる</span>
</pre></div>
</div>

<p>capistrano/railsによってdeploy:compile_assetsとdeploy:migrateが、capistrano/bundlerによってbundler:installがそれぞれ追加されます。</p>

<table>
<thead>
<tr>
<th>タスク</th>
<th>内容</th>
<th>タイミング</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/capistrano/rails/blob/5f112183dad808078a56c8558046d84d182eddf6/lib/capistrano/tasks/assets.rake#L21-L25" rel="nofollow noopener" target="_blank">deploy:compile_assets</a></td>
<td>Assetsを1つのファイルにまとめて圧縮する</td>
<td><a href="https://github.com/capistrano/rails/blob/5f112183dad808078a56c8558046d84d182eddf6/lib/capistrano/tasks/assets.rake#L48" rel="nofollow noopener" target="_blank">deploy:updatedの後</a></td>
</tr>
<tr>
<td><a href="https://github.com/capistrano/rails/blob/5f112183dad808078a56c8558046d84d182eddf6/lib/capistrano/tasks/assets.rake#L9-L19" rel="nofollow noopener" target="_blank">deploy:normalize_assets</a></td>
<td>Assetsのタイムスタンプを更新する</td>
<td><a href="https://github.com/capistrano/rails/blob/5f112183dad808078a56c8558046d84d182eddf6/lib/capistrano/tasks/assets.rake#L51" rel="nofollow noopener" target="_blank">deploy:compile_assetsの直後</a></td>
</tr>
<tr>
<td><a href="https://github.com/capistrano/rails/blob/5f112183dad808078a56c8558046d84d182eddf6/lib/capistrano/tasks/migrations.rake#L5-L14" rel="nofollow noopener" target="_blank">deploy:migrate</a></td>
<td>DBのmigrationを実行する</td>
<td><a href="https://github.com/capistrano/rails/blob/5f112183dad808078a56c8558046d84d182eddf6/lib/capistrano/tasks/migrations.rake#L16" rel="nofollow noopener" target="_blank">deploy:updatedの後</a></td>
</tr>
<tr>
<td><a href="https://github.com/capistrano/bundler/blob/f1b70e2f6ff565f377eee851a597ff89fe9d9c4d/lib/capistrano/tasks/bundler.cap#L2-L31" rel="nofollow noopener" target="_blank">bundler:install</a></td>
<td>Bundlerを実行する</td>
<td><a href="https://github.com/capistrano/bundler/blob/f1b70e2f6ff565f377eee851a597ff89fe9d9c4d/lib/capistrano/tasks/bundler.cap#L45" rel="nofollow noopener" target="_blank">deploy:updatedの後</a></td>
</tr>
</tbody>
</table>

<p>と、こんな感じでcapistrano/railsやcapistrano/bundlerを <code>require</code> すると自動的にcapistrano/frameworkのフックに必要なタスクがぶら下がって、デプロイプロセスが動くようになっています。</p>

<h2>
<span id="unicornをリロードする" class="fragment"></span><a href="#unicorn%E3%82%92%E3%83%AA%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Unicornをリロードする</h2>

<p>後はこうしてサーバ上に展開された新しいアプリケーションが動作するようにUnicornをリロードするだけです。Unicornのタスクを記述する際は <a href="/satococoa" class="user-mention js-hovercard" title="satococoa" data-hovercard-target-type="user" data-hovercard-target-name="satococoa">@satococoa</a> さんの投稿が参考になります。</p>

<ul>
<li><a href="http://qiita.com/satococoa/items/9b0cc416ffc042680b9b" id="reference-d8947a940a52f5798fff">unicorn + rails 用 Capistrano 3 の設定ファイル - Qiita</a></li>
</ul>

<p>仮にこちらの記事のようにunicorn:restartタスクを作ったのなら、あとはこれをdeployタスクの中で実行するだけです。v3.0まではdeployタスクを実行後に自動的にdeploy:restartというタスクが実行されるので、そこの中で<code>invoke</code>します。v3.1移行は実行されないので、publishingタスクの後で実行されるように設定します。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/deploy.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
  <span class="n">after</span> <span class="ss">:publishing</span><span class="p">,</span> <span class="ss">:restart</span>

  <span class="n">desc</span> <span class="s1">'Restart application'</span>
  <span class="n">task</span> <span class="ss">:restart</span> <span class="k">do</span>
    <span class="n">invoke</span> <span class="s1">'unicorn:restart'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>これで <code>cap staging deploy</code> を実行すればデプロイ完了後にUnicornが自動的に再起動されるようになります。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />31位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>77</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/e58cbecf13407446bd50">よく実行するコマンドにキーバインドを割り当てると捗る話</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-13 00:55:29</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Zsh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>履歴を使えば同じコマンドを高速に実行できますが、キーバインドを使えばさらに高速化することが可能です。<br>
zshのキーバインドの基礎を紹介します。</p>

<h2>
<span id="zshのキーバインドの概要" class="fragment"></span><a href="#zsh%E3%81%AE%E3%82%AD%E3%83%BC%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%81%AE%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>zshのキーバインドの概要</h2>

<p>zshには <code>bindkey</code> という組み込み関数が存在します。詳しくは <a href="http://www.manpagez.com/man/1/zshzle/" rel="nofollow noopener" target="_blank">zshzle(1)</a> の ZLE BUILTINS を読めということなんですが、これを使うとキーバインドを設定できます。</p>

<p>例えばzshをemacsモードで使っているとCtrl-Aでカーソルを先頭に移動させられますが、あれは内部的にはこのキーバインド機能を使って実現されているようです。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">.zshrc</span></div>
<div class="highlight"><pre><span></span>bindkey -d  <span class="c1"># いったんキーバインドをリセット</span>
bindkey -e  <span class="c1"># emacsモードで使う</span>
<span class="c1"># bindkey -a  # vicmdモード</span>
<span class="c1"># bindkey -v # viinsモード</span>
</pre></div>
</div>

<p>おそらく.zshrcに上記のようなコマンドがある書いてある人が多いと思うんですが、この <code>bindkey -e</code> でemacsっぽい挙動をするキーバインドがあれやこれやと定義されるわけです。</p>

<p>オプション無しで <code>bindkey</code> コマンドを実行すると現時点で有効化されているキーバインドが一覧されます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% bindkey <span class="p">|</span> grep <span class="s1">'\^A'</span>
<span class="s2">"^A"</span> beginning-of-line
</pre></div></div>

<p>この行は『Ctrl-Aを押すとbeginning-of-lineが実行されます』という意味です。このbeginning-of-lineは先ほどのzshzle(1)のSTANDARD WIDGETSのMovementの中に書かれていています。</p>

<blockquote>
<p><strong>biginning-of-line</strong> <em>(^A) (unbound) (unbound)</em><br>
Move to the beginning of the line. If already at the beginning of the line,<br>
move to the beginning of the previous line, if any.</p>
</blockquote>

<p>蛇足ですが一行目の <em>(^A) (unbound) (unbound)</em> は左から順に</p>

<ol>
<li>
<code>bindkey -e</code> でCtrl-Aにバインドされる</li>
<li>
<code>bindkey -a</code> ではバインドされない</li>
<li>
<code>bindkey -v</code> ではバインドされない</li>
</ol>

<p>という意味です。</p>

<h2>
<span id="新しいキーバインドを作る" class="fragment"></span><a href="#%E6%96%B0%E3%81%97%E3%81%84%E3%82%AD%E3%83%BC%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>新しいキーバインドを作る</h2>

<p>好きな処理にキーバインドを当てるにはだいたいこんな感じのことをします</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">.zshrc</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> my_function<span class="o">()</span> <span class="o">{</span>
    <span class="c1"># やりたい処理</span>
    <span class="c1"># キー実行時のプロンプトの内容は $BUFFER で取れる</span>
    zle reset-prompt  <span class="c1"># プロンプトを再描画</span>
 <span class="o">}</span>
zle -N my_function  <span class="c1"># my_functionをwidgetとして登録</span>
bindkey <span class="s1">'^A'</span> my_function <span class="c1"># my_functionをCtrl-Aにバインド</span>
</pre></div>
</div>

<p>味噌は <code>zle -N</code> で関数をwidgetとして登録できること、そして <code>bindkey</code> は関数ではなくwidgetを割り当てるものである、ということです。</p>

<h2>
<span id="よく使うコマンドにキーバインドをあてる" class="fragment"></span><a href="#%E3%82%88%E3%81%8F%E4%BD%BF%E3%81%86%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AB%E3%82%AD%E3%83%BC%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%82%92%E3%81%82%E3%81%A6%E3%82%8B"><i class="fa fa-link"></i></a>よく使うコマンドにキーバインドをあてる</h2>

<p>なんとなくzshのキーバインドが何かわかってきたところで、日常的によく使うあれこれのコマンドにキーバインドを割り当てておくと大変便利です。</p>

<p>例えばgit-statusは息を吸う様に実行したくなります。毎回キーを打っていると腱鞘炎の危険があるのでもっと簡単に実行できるようにキーバインドを割り当てましょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="k">function</span> _git_status<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">$(</span>git rev-parse --is-inside-work-tree <span class="m">2</span>&gt; /dev/null<span class="k">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s1">'true'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> git status -sb <span class="c1"># git statusを実行したっぽくみせかける</span>
        git status -sb
    <span class="k">fi</span>
    zle reset-prompt
<span class="o">}</span>
zle -N git_status _git_status  <span class="c1"># _git_status関数をgit_status widgetとして登録</span>
bindkey <span class="s1">'^G^S'</span> git_status
</pre></div></div>

<p>gitリポジトリ内で間髪入れずにCtrl-G+Ctrl-Sと打つと <code>git status -sb</code> と表示されます。関数の中身をあれこれ変えれば好みのキーバインドを簡単に作ることができます。よく実行するコマンドを登録しておくといろいろと捗るのでおすすめです。</p>

<p>ちなみにemacsモードではCtrl-Gにはsend-breakというwidgetが登録されているのでCtrl-Gを押した後にグズグズしているとそちらが実行されます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />32位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>76</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/eed1b9067f7073cbe611">js-&gt;coffee移行にあたって考えたこと</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-01-19 00:50:35</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[CoffeeScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>個人製作のシステムのjsをcoffeeに完全移行したのでその雑感を書きます。あくまでも個人的な感想です。感じ方は人それぞれです。</p>

<p>ちなみに僕は勉強を兼ねて手で移行させましたが、js2coffeeというツールを使うと自動で変換してくれるらしいです。</p>

<h1>
<span id="先に結論" class="fragment"></span><a href="#%E5%85%88%E3%81%AB%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>先に結論</h1>

<p>coffeeの方がいいと思う。</p>

<p>よくある批判に「js書けばいいじゃん」というのがあるけど、極端な話、「アセンブラ書けばいいじゃん」と高級言語が出てきた頃に言ってた人と主張の方向性は似てると思う。極端すぎるけど。</p>

<p>jsには落とし穴がいっぱいある。慣れてもたまにはまる。<code>var</code>を忘れたり「関数の頭で全部の<code>var</code>を列挙する」というプラクティスに従ってたら、冗長になって管理するコスト高くなったり。</p>

<p>coffeeを使うとそういう余計な問題を意識しなくてよくなるのはとても大きい。</p>

<p>しかもjsでできることの全てをcoffeeでできる。工夫が必要になる場面もあるけど。</p>

<h1>
<span id="coffeeの方がイイ点" class="fragment"></span><a href="#coffee%E3%81%AE%E6%96%B9%E3%81%8C%E3%82%A4%E3%82%A4%E7%82%B9"><i class="fa fa-link"></i></a>coffeeの方がイイ点</h1>

<h2>
<span id="データサイズ" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B5%E3%82%A4%E3%82%BA"><i class="fa fa-link"></i></a>データサイズ</h2>

<p>もともと19KB程度あったjsファイルをcoffeeで書きなおしたところ、9KBになった。</p>

<p>このことから、普通にjsを書くよりcoffeeを書く方が圧倒的に少ないタイプ量で済むこと分かる。</p>

<p>また、生成されるjsファイルの大きさを見たところ15KBくらいだった。ただし、もとのjsにはドキュメントがついていたことを考えると、それほど大きな差はないと思われる。</p>

<p>ゆえに、jsコードが膨張する心配も無いと僕は結論づけた。</p>

<h2>
<span id="開発スピード" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E3%82%B9%E3%83%94%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>開発スピード</h2>

<p>上でも書いたように、タイプ量が減るということは開発スピードが上がることを意味する。</p>

<p>個人開発なので、開発コストは少しでも小さくしたかったので、これは以外と大きいと思った。</p>

<h2>
<span id="クラス" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>クラス</h2>

<p>prototypeベースの継承は理解すれば問題無いけれどなんだかんだ言ってクラスベースの方が個人的にしっくりくる。</p>

<p>おれおれクラス実装しているのよく見るけど、ライブラリ毎の微妙な違いとかいちいち考えるの面倒じゃないですか。</p>

<p>coffeeだと<code>class</code>という専用の構文で書くから、ぱっと見で定義が把握しやすい。</p>

<h2>
<span id="インデント言語" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%B3%E3%83%88%E8%A8%80%E8%AA%9E"><i class="fa fa-link"></i></a>インデント言語</h2>

<p>Pythonistaですから</p>

<h2>
<span id="ファイル分けが簡単" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%88%86%E3%81%91%E3%81%8C%E7%B0%A1%E5%8D%98"><i class="fa fa-link"></i></a>ファイル分けが簡単</h2>

<p>即時無名関数内にjsを定義するとプライベート関数とか使えて便利だけど、ソースコードをファイル単位で分割して管理するのがやりにくい。ファイルをまたがって使いたいような関数はグローバルにおかないと行けないから、少なくとも一つはグローバル空間を汚染しないといけなくなる。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// code1</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="k">this</span><span class="p">.</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">hoge</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
<span class="c1">// 本当はprivateにしたくても、code2で使うにはグローバルに置かざるをえない</span>
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// code2</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="k">this</span><span class="p">.</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">hoge</span><span class="p">();</span> 
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</pre></div></div>

<p>でもcoffeeならそういう問題がない。</p>

<div class="code-frame" data-lang="shell"><div class="highlight"><pre><span></span>$ cat src/coffee/* | coffee -sp &gt; src/js/main.js
</pre></div></div>

<p>追記：こんなことしなくても、coffeescriptが標準で方法を準備してくれている。<a href="http://qiita.com/items/1831" class="autolink">http://qiita.com/items/1831</a></p>

<p><code>cat</code>で結合してから<code>coffee</code>に渡すだけでよかったりする。つまり</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="c1"># code1</span>
<span class="nx">hoge</span> <span class="nf">-&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="c1"># code2</span>
<span class="nx">hoge</span><span class="p">()</span>
</pre></div></div>

<p>を<code>cat</code>して</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="c1"># code1</span>
<span class="nx">hoge</span> <span class="nf">-&gt;</span>
<span class="c1"># code2</span>
<span class="nx">hoge</span><span class="p">()</span>
</pre></div></div>

<p>コンパイルすれば以下のようにjsが生成される</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">hoge</span><span class="p">;</span>
  <span class="nx">hoge</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
  <span class="nx">hoge</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</pre></div></div>

<p>分かるようにグローバルを汚染すること無くファイルをまたいでプライベート関数を共有できている。</p>

<p>Rails3.1を使ってるとフレームワークの方が同じようなことをしてくれるらしい。</p>

<p>余談：まーjsでもcatでファイルをまたいだプライベートの共有できますけどね。つまり</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">hoge</span><span class="p">;</span>
<span class="nx">hoge</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">hoge</span><span class="p">();</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</pre></div></div>

<p>みたいにファイルを分割すれば。でも気持ち悪いことこの上ない。特に最初と最後のファイルが醜悪過ぎる。</p>

<h2>
<span id="学習コスト" class="fragment"></span><a href="#%E5%AD%A6%E7%BF%92%E3%82%B3%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>学習コスト</h2>

<p>今回僕は、coffeeを初めて触った。19KBのjsコードを手で変換するのに2時間弱かかり、その時に調べながらcoffeeへの変換を行った。</p>

<p>jsに関する事前知識が充実していたので、習得が早かったのもあるが、jsを一から勉強するのに比べればcoffeeの学習コストは小さいと感じた。</p>

<p>Pythonistaなのでリスト内包っぽく配列を書けるのが嬉しい。</p>

<h3>
<span id="初学者にはcoffeeの方が優しそう" class="fragment"></span><a href="#%E5%88%9D%E5%AD%A6%E8%80%85%E3%81%AB%E3%81%AFcoffee%E3%81%AE%E6%96%B9%E3%81%8C%E5%84%AA%E3%81%97%E3%81%9D%E3%81%86"><i class="fa fa-link"></i></a>初学者にはcoffeeの方が優しそう</h3>

<p>せっかく書いたから残すけど、あまり重要でないから読み飛ばしてOK</p>

<p>jsには初学者がよく躓く落とし穴が沢山あるが、その際たる例がcallback関数における<code>this</code>の挙動だと思う。</p>

<p>coffeeでは「どんな場面でも<code>=&gt;</code>を使えばよい」という一言でだいたい片が付く。「毎回<code>var self = this</code>って書いて、<code>this</code>の代わりに<code>self</code>を書けばいい」と教えるよりはましだと思う。</p>

<p>for-in文を知った初学者がやりがちな間違いとして、配列をinで回すという失敗もcoffeeなら「配列ならin、オブジェクトならofだよ」で済む。</p>

<p>あとjsでイディオム的に書かれる</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
    <span class="c1">// doSomething</span>
<span class="p">}</span>
</pre></div></div>

<p><code>hasOwnProperty</code>が何故必要か教えるのは面倒だし、タイプ量多くて嫌だけどcoffeeなら</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="k">own</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">obj</span>
    <span class="c1"># doSomething</span>
</pre></div></div>

<p>のように「とりあえず<code>own</code>てつけとけ」で済む。</p>

<h1>
<span id="coffeeの悪い点" class="fragment"></span><a href="#coffee%E3%81%AE%E6%82%AA%E3%81%84%E7%82%B9"><i class="fa fa-link"></i></a>coffeeの悪い点</h1>

<h2>
<span id="書ける人が少ない" class="fragment"></span><a href="#%E6%9B%B8%E3%81%91%E3%82%8B%E4%BA%BA%E3%81%8C%E5%B0%91%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>書ける人が少ない</h2>

<p>現状は。Railsさんの力でこれから先は分からないと思う。</p>

<p>それに学習コストは低いからそれほど問題とは思えない。</p>

<h2>
<span id="jsレベルでのデバッグがしんどい" class="fragment"></span><a href="#js%E3%83%AC%E3%83%99%E3%83%AB%E3%81%A7%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%8C%E3%81%97%E3%82%93%E3%81%A9%E3%81%84"><i class="fa fa-link"></i></a>jsレベルでのデバッグがしんどい</h2>

<p>これが一番問題な気がする。が、自分自身まだ直面したことないからよく分からない</p>

<h2>
<span id="コンパイルが必要" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%8C%E5%BF%85%E8%A6%81"><i class="fa fa-link"></i></a>コンパイルが必要</h2>

<p>自動化すればいい、というだけの話ではある。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />33位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>72</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/89044987d45ec58ea7c5">jQuery.fn.onに名前空間をつけることができる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-09 23:41:25</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>恥ずかしながら今日まで知らなかったのですが、jQueryはイベントハンドラを登録するときに名前空間をつけることができます。（名前空間というよりはクラスという言い方の方がしっくりくるのですが、jQueryのドキュメントがnamespaceと表現しているので名前空間と書くことにします）</p>

<p>例えば、あるボタンのクリックイベントにイベントハンドラをつける時にこういう風に書きますが</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* イベントハンドラ */</span> <span class="p">});</span>
</pre></div></div>

<p>こういう感じで . のあとに名前空間をつけても問題ありません。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click.n1.n2'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* イベントハンドラ */</span> <span class="p">});</span>
</pre></div></div>

<p>ボタンがクリックされたらいずれのイベントハンドラも正しく起動されます。</p>

<h2>
<span id="何が嬉しいのか" class="fragment"></span><a href="#%E4%BD%95%E3%81%8C%E5%AC%89%E3%81%97%E3%81%84%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>何が嬉しいのか</h2>

<p>通常であれば特に嬉しいことはありません。嬉しいのは <code>jQuery.fn.off</code> するときです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
</pre></div></div>

<p>イベントハンドラを解除するときはこのように書きますが、このボタンについているイベントハンドラが他にあったらそれらも全て消されてしまいます。<code>document</code> オブジェクトにイベントハンドラを登録している場合や、jQueryプラグインを作っていてどのような環境で使わるか作成者が分からないような場合は頭痛の種になりそうです。</p>

<h3>
<span id="名前空間を使うと綺麗に消すことができる" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E7%A9%BA%E9%96%93%E3%82%92%E4%BD%BF%E3%81%86%E3%81%A8%E7%B6%BA%E9%BA%97%E3%81%AB%E6%B6%88%E3%81%99%E3%81%93%E3%81%A8%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>名前空間を使うと綺麗に消すことができる</h3>

<p>このような場合、イベントに名前空間をつけていると次のように指定することでその名前空間に属するものだけを消すことができます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">'click.n1'</span><span class="p">);</span> <span class="c1">// n1に属するclickイベントを消す</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">'.n1'</span><span class="p">);</span>  <span class="c1">// n1に属する全てのイベントを消す</span>
</pre></div></div>

<h2>
<span id="注意" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>注意</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click.n1.n2'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{});</span>
</pre></div></div>

<p>は <code>n1</code> の中に <code>n2</code> がある、という <strong>意味ではない</strong> です。これは <code>n1</code> と <code>n2</code> がついているクリックイベント、なのです。ちょうどHTML要素のclass属性に複数の要素がついているのと同じです。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"n1 n2"</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</pre></div></div>

<p>このSPAN要素は <code>$('.n1')</code> でも <code>$('.n2')</code> でも <code>$('span.n1')</code> でも取り出せますよね？</p>

<p>それと同様にこちらも名前空間を指定することができる訳です。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">'.n1'</span><span class="p">);</span>  <span class="c1">// dblclick.n1とかも消える</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">'.n2'</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">'click.n1'</span><span class="p">);</span> <span class="c1">// dblclick.n1は消えない</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />34位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>71</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/443d3e772365cfc31e7d">tmux+Vimが不安定なら、いっそMacVimを使おう</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-05-18 11:18:12</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[Mac]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>最近tmux+VimをやめてMac版GVimである<a href="https://code.google.com/p/macvim/" rel="nofollow noopener" target="_blank">MacVim</a>を使うようになりました。</p>

<h1>
<span id="macvimへ移行した理由" class="fragment"></span><a href="#macvim%E3%81%B8%E7%A7%BB%E8%A1%8C%E3%81%97%E3%81%9F%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a>MacVimへ移行した理由</h1>

<p>これまでMacVimを敬遠してきました。というのも</p>

<ul>
<li>ターミナル上で動くのがVimのいいところだと思う</li>
<li>tmux上でVimとシェルを行き来するのに慣れてしまった（tmuxから出たくない）</li>
<li>改めて設定するのが面倒くさかった</li>
</ul>

<p>からなのですが、最近は</p>

<ul>
<li>tmux上のVimの描画がおかしくなることが多い

<ul>
<li>いちいち<code>:redraw!</code>を実行するのがつらい（キーバインドを実行するのすら面倒）</li>
</ul>
</li>
<li>tmux用のエスケープキーが惜しい</li>
</ul>

<p>という感じであまり上手く行っていませんでした。そこで先日から重い腰を上げてMacVimを試しに使っています。で、その結果としては</p>

<ul>
<li>体感でターミナル上よりさくさく動く(tmuxのオーバーヘッドが無いから？)</li>
<li>tmuxのpane切り替えを、OS Xのアプリケーション切り替えに変えるだけ</li>
<li>tmuxのステータスラインが無くなった分、使える画面領域が若干増えた</li>
<li>改めて設定することはほとんど無かった</li>
<li>tmux用のエスケープキーが開放された（私の場合は<code>Ctrl-J</code>)</li>
<li>色の細かい制御ができるようになった</li>
</ul>

<p>のでこのままMacVimに移行しようと決心しました。MacVimいいよ</p>

<h1>
<span id="macvimに行った設定" class="fragment"></span><a href="#macvim%E3%81%AB%E8%A1%8C%E3%81%A3%E3%81%9F%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>MacVimに行った設定</h1>

<p>MacVimを使う上で行った設定は下記3つ</p>

<ol>
<li>ターミナルから新しいタブを開いてファイルを編集する</li>
<li>文字サイズを設定する</li>
<li>挿入モードを抜けるときに自動的に英数入力に切り換える</li>
</ol>

<h2>
<span id="ターミナルから新しいタブを開いてファイルを編集する" class="fragment"></span><a href="#%E3%82%BF%E3%83%BC%E3%83%9F%E3%83%8A%E3%83%AB%E3%81%8B%E3%82%89%E6%96%B0%E3%81%97%E3%81%84%E3%82%BF%E3%83%96%E3%82%92%E9%96%8B%E3%81%84%E3%81%A6%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ターミナルから新しいタブを開いてファイルを編集する</h2>

<p>基本的にファイルはVimから直接（<a href="https://github.com/Shougo/unite.vim" rel="nofollow noopener" target="_blank">unite.vim</a>とか使って）開くけど、ターミナルからファイルを選択することもあります。<br>
その場合、既にMacVimが立ち上がっているなら、新しいウィンドウを作るのではなく、既存のものに新しいタブを作って開いて欲しい、と思いました。<br>
で探してみるとMacVimの <code>[Preferences] -&gt; [General] -&gt; [Open files from applications]</code> に <code>[in the current window] -&gt; [with a tab for each file]</code> という設定があったのでそれを選択。<br>
そして、ターミナルから開くために下記を.zshrcに追記しました。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">.zshrc</span></div>
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="si">${</span><span class="nv">OSTYPE</span><span class="si">}</span> in
darwin*<span class="o">)</span> <span class="c1"># Mac OS X</span>
  <span class="k">function</span> macvim <span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -d /Applications/MacVim.app <span class="o">]</span>
    <span class="k">then</span>
      <span class="o">[</span> ! -f <span class="nv">$1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> touch <span class="nv">$1</span>
      open -a MacVim <span class="nv">$1</span>
    <span class="k">else</span>
      vim <span class="nv">$1</span>
    <span class="k">fi</span>
  <span class="o">}</span>
  <span class="nb">alias</span> <span class="nv">vim</span><span class="o">=</span><span class="s1">'macvim'</span>
  <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
</div>

<p>これでzsh上で<code>% vim path/to/file</code>とやればMacVim上の新しいタブでファイルを開くことができます。</p>

<p>ちなみに<code>gvim</code>コマンドだと上手くいきませんでした。</p>

<h2>
<span id="文字サイズを設定する" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E3%82%B5%E3%82%A4%E3%82%BA%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>文字サイズを設定する</h2>

<p>MacVimのデフォルトの文字サイズがやたらと小さいのでそれを指定します。フォントにはRictyを使うようにしました。<br>
ホームディレクトリに.gvimrcファイルを置いとけばMacVimが勝手に読んでくれます。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">~/.gvimrc</span></div>
<div class="highlight"><pre><span></span><span class="k">set</span> <span class="nb">guifont</span><span class="p">=</span>Ricty:h16
</pre></div>
</div>

<p><code>h16</code>というのが文字の大きさです。Google先生に聞いた限り、フォントを指定せずに大きさだけを変更することはできない気配がします。</p>

<h2>
<span id="挿入モードを抜けるときに自動的に英数入力に切り換える" class="fragment"></span><a href="#%E6%8C%BF%E5%85%A5%E3%83%A2%E3%83%BC%E3%83%89%E3%82%92%E6%8A%9C%E3%81%91%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AB%E8%87%AA%E5%8B%95%E7%9A%84%E3%81%AB%E8%8B%B1%E6%95%B0%E5%85%A5%E5%8A%9B%E3%81%AB%E5%88%87%E3%82%8A%E6%8F%9B%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>挿入モードを抜けるときに自動的に英数入力に切り換える</h2>

<p>挿入モードで日本語入力をしていて、ノーマルモードに<code>CTRL-[</code>などで抜けたときに、自動的に英数字入力に戻さないと死んでしまう病気にかかっているので、KeyRemap4MacBookに新しい設定を追加しました。</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">private.xml</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;root&gt;</span>
  <span class="nt">&lt;appdef&gt;</span>
    <span class="nt">&lt;appname&gt;</span>MACVIM<span class="nt">&lt;/appname&gt;</span>
    <span class="nt">&lt;equal&gt;</span>org.vim.MacVim<span class="nt">&lt;/equal&gt;</span>
  <span class="nt">&lt;/appdef&gt;</span>
  <span class="nt">&lt;list&gt;</span>
    <span class="nt">&lt;item&gt;</span>
      <span class="nt">&lt;name&gt;</span>Leave InsMode with EISUU(MacVim)<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;identifier&gt;</span>private.app_macvim_esc_with_eisuu<span class="nt">&lt;/identifier&gt;</span>
      <span class="nt">&lt;only&gt;</span>MACVIM<span class="nt">&lt;/only&gt;</span>
      <span class="nt">&lt;autogen&gt;</span>
        --KeyToKey--
        KeyCode::ESCAPE,
        KeyCode::ESCAPE, KeyCode::JIS_EISUU
      <span class="nt">&lt;/autogen&gt;</span>
      <span class="nt">&lt;autogen&gt;</span>
        --KeyToKey--
        KeyCode::C, VK_CONTROL,
        KeyCode::C, VK_CONTROL, KeyCode::JIS_EISUU
      <span class="nt">&lt;/autogen&gt;</span>
      <span class="nt">&lt;autogen&gt;</span>
        --KeyToKey--
        KeyCode::BRACKET_LEFT, VK_CONTROL,
        KeyCode::BRACKET_LEFT, VK_CONTROL, KeyCode::JIS_EISUU
      <span class="nt">&lt;/autogen&gt;</span>
    <span class="nt">&lt;/item&gt;</span>
  <span class="nt">&lt;/list&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</pre></div>
</div>

<p>KeyRemap4MacBookの設定の仕方は<a href="http://qiita.com/items/b5f0e49d68469eb38c1b">この記事参照</a></p>

<h1>
<span id="macvimにしてよかったその他のこと" class="fragment"></span><a href="#macvim%E3%81%AB%E3%81%97%E3%81%A6%E3%82%88%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>MacVimにしてよかったその他のこと</h1>

<h2>
<span id="tmux用のエスケープキーバインドが開放された" class="fragment"></span><a href="#tmux%E7%94%A8%E3%81%AE%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%82%AD%E3%83%BC%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%81%8C%E9%96%8B%E6%94%BE%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>tmux用のエスケープキーバインドが開放された</h2>

<p>最初にも書いたようにtmux用のエスケープキーに使っていた<code>CTRL-J</code>が開放されました。<br>
なので個人的に使用頻度の高い<a href="https://github.com/Lokaltog/vim-easymotion" rel="nofollow noopener" target="_blank">vim-easymotion</a>に割り当てました。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vimrc</span></div>
<div class="highlight"><pre><span></span>NeoBundle <span class="s1">'Lokaltog/vim-easymotion'</span>
<span class="k">let</span> <span class="k">g</span>:EasyMotion_mapping_j <span class="p">=</span> <span class="s1">'&lt;C-j&gt;'</span>
<span class="k">let</span> <span class="k">g</span>:EasyMotion_mapping_k <span class="p">=</span> <span class="s1">'&lt;C-k&gt;'</span>
</pre></div>
</div>

<p>これを設定してから、これまでほとんど使って来なかった<code>i_CTRL-O</code>が神機能に昇格しました。</p>

<h2>
<span id="色の表現力が上がった" class="fragment"></span><a href="#%E8%89%B2%E3%81%AE%E8%A1%A8%E7%8F%BE%E5%8A%9B%E3%81%8C%E4%B8%8A%E3%81%8C%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>色の表現力が上がった</h2>

<p>例えば<a href="https://github.com/nathanaelkane/vim-indent-guides" rel="nofollow noopener" target="_blank">vim-indent-guides</a>の<code>g:indent_guides_color_change_percent</code>オプションなどはiTerm2上にいた頃は上手く機能させられていなかったのですが、MacVimに来たら何もしなくてもきちんと描画のされ方が区別されるようになりました。<br>
やったー</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>MacVim意外といいよ！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />35位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>68</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/cdffdff4ddb74747be7e">モデルのバリデーションエラーはカスタムイベントで通知すると便利</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-12 10:07:11</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://coding.smashingmagazine.com/2013/08/09/backbone-js-tips-patterns/" rel="nofollow noopener" target="_blank">Backbone.js Tips And Patterns | Smashing Coding</a> を読みました。</p>

<p>ほとんどは特に真新しくもない当たり前な内容なんですが、 "BROADCAST CUSTOM ERROR EVENT" はいいなと思ったので紹介します。</p>

<p>このパターンは Model で複数の属性のバリデーションを行いたい場面で使うものです。</p>

<h1>
<span id="return-an-error-object" class="fragment"></span><a href="#return-an-error-object"><i class="fa fa-link"></i></a>RETURN AN ERROR OBJECT</h1>

<p>まず、普通な <code>validate</code> の実装です。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Model</span></div>
<div class="highlight"><pre><span></span><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">attr</span><span class="o">:</span> <span class="s1">'name'</span><span class="p">,</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s1">'Name is required'</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>まず Backbone の基本事項として下記を再確認してください:</p>

<ol>
<li>
<code>validate</code> メソッドが真を返すと <code>invalid</code> イベントが発生する</li>
<li>返り値が <code>invalid</code> イベントのコールバックに渡される</li>
</ol>

<p>で、上記のコードサンプルは <code>errors</code> という配列を作っています。なんでわざわざこんなことをしているのかというと、コールバックに複数の属性の情報を渡すには配列などを利用するしか無いわけです。そして View のコールバックでその配列の値をパースします。</p>

<p>このパターンは <code>validate</code> メソッドで複数の属性を処理するときによく使われます。前述のサイトでは "RETURN AN ERROR OBJECT" という名前で紹介されています。</p>

<p>この方法で一応複数属性のバリデーションはできるんですが、レンダラが肥大化してしてしまいがち、という問題があります。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">View</span></div>
<div class="highlight"><pre><span></span><span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'invalid'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">renderMessages</span><span class="p">);</span>
<span class="p">},</span>
<span class="nx">renderMessages</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">errors</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">attr</span> <span class="o">===</span> <span class="s1">'name'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.name-message'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<p>ここでは <code>renderMessages</code> メソッドを定義しています。このメソッドでやるのがエラーメッセージをまとめてリストにして表示する、とかなら単純で大きな問題にはなりませんが、ここでやっているように属性毎にレンダリングする方法を変えたい、とかだと属性が増える度にどんどん肥大化していきます。</p>

<p>そのような問題に対して、個々の属性毎にレンダラを定義して、下記のようにリファクタリングすることもよく行います。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">View</span></div>
<div class="highlight"><pre><span></span><span class="nx">renderMessages</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">errors</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">attr</span> <span class="o">===</span> <span class="s1">'name'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">renderNameMessage</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
<span class="p">},</span>
<span class="nx">renderNameMessage</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.name-message'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">message</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>

<h1>
<span id="broadcast-custom-error-event" class="fragment"></span><a href="#broadcast-custom-error-event"><i class="fa fa-link"></i></a>BROADCAST CUSTOM ERROR EVENT</h1>

<p>この個別レンダラに対応するカスタムイベントを発行するのが "BROADCAST CUSTOM ERROR EVENT" です。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Model</span></div>
<div class="highlight"><pre><span></span><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'invalid:name'</span><span class="p">,</span> <span class="s1">'Name is required'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// 注意：バグがある。詳しくは後述</span>
<span class="p">}</span>
</pre></div>
</div>

<p>このように <code>invalid:ATTRIBUTE</code> となるようなイベントを発行します。対応する View では個別レンダラをコールバックに設定します。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">View</span></div>
<div class="highlight"><pre><span></span><span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'invalid:name'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">renderNameMessage</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<p>この方法のよいところは、 View で Model の <code>validate</code> メソッドの返り値の実装を知らなくてもよい点です。例えば今回の場合でいえば、 <code>attr</code> と <code>message</code> というプロパティを持つオブジェクトの配列が返される、ということを View が知っていなければなりません。しかし、カスタムイベントでメッセージを渡す方式であれば、属性名の種類さえ知っていればよいので View と Model の結合度はより小さくなります。</p>

<h1>
<span id="２つを組み合わせるのがオススメ" class="fragment"></span><a href="#%EF%BC%92%E3%81%A4%E3%82%92%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B%E3%82%8B%E3%81%AE%E3%81%8C%E3%82%AA%E3%82%B9%E3%82%B9%E3%83%A1"><i class="fa fa-link"></i></a>２つを組み合わせるのがオススメ</h1>

<p>ただ、引用しているブログ記事には重大なバグがあって、それは何かというと、 <code>validate</code> メソッドが何も返さないのでバリデーションに通ったとみなされてしまう、という点です。なので一つでもバリデーションに失敗したら <code>true</code> を返すようにする、などの修正が必要です。</p>

<p>ですが、オススメしたいのは "BROADCAST CUSTOM ERROR EVENT" と "RETURN AN ERROR OBJECT" を組み合わせる方式です。</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">Model</span></div>
<div class="highlight"><pre><span></span><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">attr</span><span class="o">:</span> <span class="s1">'name'</span><span class="p">,</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s1">'Name is required'</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'invalid:name'</span><span class="p">,</span> <span class="s1">'Name is required'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>何故組み合わせるべきだと思うのか。それは <code>change</code> と <code>change:ATTRIBUTE</code> イベントの構造と似せることが可能だからです。</p>

<p><code>change</code> と <code>change:ATTRIBUTE</code> イベントは属性が変更されたときに発生します。複数の属性が変更されたとき、属性毎に <code>change:ATTRIBUTE</code> イベントが発生した後に <code>change</code> イベントが発生します。個別対応したければ <code>change:ATTRIBUTE</code> を監視し、一括で問題無いなら <code>change</code> を使う、という使い分けがされます。</p>

<p>それと同じことが <code>invalid</code> と <code>invalid:ATTRIBUTE</code> でできるようになるわけです。インタフェースが似ているので使い勝手がよさそうです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />36位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>68</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/7095a32cc5e438172844">Backbone.js入門 「View と Model と Collection の連携」 </a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-20 02:29:12</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="閲覧上の注意" class="fragment"></span><a href="#%E9%96%B2%E8%A6%A7%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>閲覧上の注意</h3>

<p>この記事で対象としているバージョン0.5.3は結構古いので注意してください。</p>

<p>その他の割りと新しい情報は <a href="http://www.adventar.org/calendars/15" rel="nofollow noopener" target="_blank">Backbone.js Advent Calendar 2012</a> などにあります。</p>

<p>（追記ここまで）</p>

<hr>

<p>Backbone.js入門シリーズも佳境に差し掛かってきました。<br>
<code>View</code> と <code>Model</code> の連携は既に取り上げたので、今回は特に <code>Collection</code> と <code>View</code> <code>Model</code> との連携に主眼を当てて記述したいと思います。</p>

<h2>
<span id="view-と-collection-の連携" class="fragment"></span><a href="#view-%E3%81%A8-collection-%E3%81%AE%E9%80%A3%E6%90%BA"><i class="fa fa-link"></i></a>View と Collection の連携</h2>

<p>復習の意味も込めて、<code>View</code> と <code>Model</code> の連携方法をもう一度記述すると、大枠として次のようになります。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// モデルの定義</span>
<span class="nx">Hoge</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

<span class="c1">// ビューの定義</span>
<span class="nx">HogeView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"click .submit"</span><span class="o">:</span> <span class="s2">"update"</span> <span class="c1">// DOM のイベントを監視</span>
    <span class="p">},</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">"render"</span><span class="p">,</span> <span class="s2">"remove"</span><span class="p">);</span>
        <span class="c1">// オブザーバパターンを利用してモデルのイベントを購読</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"change"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"destroy"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">foo</span><span class="o">:</span> <span class="s2">"bar"</span><span class="p">});</span> <span class="c1">// change が発生し、this.render が呼ばれる</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">"#hoge-template"</span><span class="p">).</span><span class="nx">html</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// モデルのインスタンス</span>
<span class="nx">hoge</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hoge</span><span class="p">();</span>

<span class="c1">// モデルを渡してビューを初期化</span>
<span class="nx">hogeView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HogeView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">hoge</span><span class="p">});</span>
</pre></div></div>

<p><code>View</code> は <code>Model</code> へのリファレンスを保持していますが <code>Model</code> から見て <code>View</code> はイベントの購読者の一人に過ぎない という関係になっています。<br>
<code>View</code> と <code>Collection</code> の関係も基本的に同じ構造となります。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">HogeList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">model</span><span class="o">:</span> <span class="nx">Hoge</span>
<span class="p">});</span>

<span class="nx">HogeListView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"click .add"</span><span class="o">:</span> <span class="s2">"addItem"</span>
    <span class="p">},</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">"resetItems"</span><span class="p">,</span> <span class="s2">"appendItem"</span><span class="p">,</span> <span class="s2">"removeItem"</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"reset"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">resetItems</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">appendItem</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"remove"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">addItem</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hoge</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span> <span class="c1">// add イベントが発生し、this.appendItem が呼ばれる</span>
    <span class="p">},</span>
    <span class="nx">resetItems</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">appendItem</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span> 
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">appendItem</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HogeView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">});</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">removeItem</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">hogeList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HogeList</span><span class="p">();</span>
<span class="nx">hogeListView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HogeListView</span><span class="p">({</span><span class="nx">collection</span><span class="o">:</span> <span class="nx">hogeList</span><span class="p">});</span>
</pre></div></div>

<h2>
<span id="model-と-collection-の連携" class="fragment"></span><a href="#model-%E3%81%A8-collection-%E3%81%AE%E9%80%A3%E6%90%BA"><i class="fa fa-link"></i></a>Model と Collection の連携</h2>

<p><code>Model</code> と <code>Collection</code> は互いのリファレンスを保持しています。<code>model.collection</code> と <code>collection.models</code> です。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">hoge</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hoge</span><span class="p">();</span>
<span class="nx">hogeList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HogeList</span><span class="p">();</span>

<span class="nx">hoge</span><span class="p">.</span><span class="nx">collection</span> <span class="c1">// =&gt; undefined</span>
<span class="nx">hogeList</span><span class="p">.</span><span class="nx">models</span> <span class="c1">// =&gt; []</span>

<span class="nx">hogeList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">hoge</span><span class="p">);</span>

<span class="nx">hoge</span><span class="p">.</span><span class="nx">collection</span> <span class="o">===</span> <span class="nx">hogeList</span> <span class="c1">// =&gt; true</span>
<span class="nx">hogeList</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">hoge</span> <span class="c1">// =&gt; true</span>

<span class="nx">hogeList</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">hoge</span><span class="p">)</span> <span class="c1">// =&gt; true</span>

<span class="nx">hogeList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">hoge</span><span class="p">);</span>

<span class="nx">hoge</span><span class="p">.</span><span class="nx">collection</span> <span class="c1">// =&gt; undefined</span>
<span class="nx">hogeList</span><span class="p">.</span><span class="nx">models</span> <span class="c1">// =&gt; []</span>
</pre></div></div>

<h2>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h2>

<p>ユーザの入力によって <code>View</code> のメソッドが呼ばれ、その中で <code>Collection</code> を操作し、その操作の結果生じるイベントによって <code>View</code> の見た目を更新する、という流れになります。これは、<code>View</code> と <code>Model</code> の連携と同じ流れです。</p>

<p>さて、いよいよ次回最終回は <code>Router</code> と <code>History</code> です。<br>
それではまた明日。</p>

<hr>

<ol>
<li><a href="http://qiita.com/items/16b799d0ec0a0ae3f78e">Backbone.js入門 Events</a></li>
<li><a href="http://qiita.com/items/03f49c64d6c4bacdbb26">Backbone.js入門 MVC</a></li>
<li><a href="http://qiita.com/items/8ee2ed1949cd7c337f06">Backbone.js入門 View</a></li>
<li><a href="http://qiita.com/items/5acef8dd49f67fd7813c">Backbone.js入門 Model</a></li>
<li><a href="http://qiita.com/items/7ce4b1ceb5d18c9cef08">Backbone.js入門 ViewとModelの連携</a></li>
<li><a href="http://qiita.com/items/c19d2fff0dc23e4015ff">Backbone.js入門 Collection</a></li>
<li>Backbone.js入門 ViewとModelとCollectionの連携</li>
<li><a href="http://qiita.com/items/13f3d1f71d31f3e78123">Backbone.js入門 RouterとHistory</a></li>
</ol>

<ul>
<li><a href="https://groups.google.com/forum/?fromgroups#!forum/backbonejs-ja" rel="nofollow noopener" target="_blank">BackboneJS 日本語メーリングリスト</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />37位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>68</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/c14d4554f6af8b4e6159">RailsアプリでBackbone.jsを使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-05 21:01:12</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="backbonejs-advent-calendar-5日目" class="fragment"></span><a href="#backbonejs-advent-calendar-5%E6%97%A5%E7%9B%AE"><i class="fa fa-link"></i></a>Backbone.js Advent Calendar 5日目</h1>

<p>Backbone.jsの本家ドキュメントにtodoリストをブラウザのLocalStorageを使って保存するチュートリアルがあります。</p>

<ul>
<li><a href="http://documentcloud.github.com/backbone/docs/todos.html" title="todo.js" rel="nofollow noopener" target="_blank">todo.js</a></li>
</ul>

<p>今回は、このtodoアプリのバックエンドとして、Ruby on Railsを使うように変更してみたいと思います。</p>

<h2>
<span id="backbonejsとサーバの通信" class="fragment"></span><a href="#backbonejs%E3%81%A8%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E9%80%9A%E4%BF%A1"><i class="fa fa-link"></i></a>Backbone.jsとサーバの通信</h2>

<p>Backbone.jsはModelやCollectionの内容をサーバと同期するための手段を提供してくれています。標準で用意されているBackbone.syncはサーバがRESTfulと呼ばれるインタフェースを提供していることを前提に動作しますが、同期する方法を自作することも可能で、例えば上記のtodoリストのチュートリアルではLocalStorageにデータを保存するために、Storeという名前のオブジェクトを自作して用いています。そのため、Backbone.jsとサーバを同期する際は大きく分けて2通りの方法があることが分かります。</p>

<p>1.サーバにRESTfulなインタフェースを作り、標準のBackbone.syncを使う<br>
2.独自のインタフェースを作り、独自の同期方法を実装する</p>

<p>Railsではscaffoldという機能を使うことで極めて簡単にRESTfulなAPIを作ることができるので、今回はこの機能を使ってみることにしましょう。</p>

<h2>
<span id="railsの用意" class="fragment"></span><a href="#rails%E3%81%AE%E7%94%A8%E6%84%8F"><i class="fa fa-link"></i></a>Railsの用意</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rails new todos
$ <span class="nb">cd</span> todos
$ rails g scaffold todo text:string <span class="k">done</span>:boolean
$ rake db:migrate
</pre></div></div>

<p>あとはunderscore.jsとbackbone.jsをapp/assets/javascriptsに追加し、underscore.jsがbackbone.jsより先に読み込まれるように、app/assets/javascripts/application.jsを以下のように変えます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">//= require jquery</span>
<span class="c1">//= require underscore</span>
<span class="c1">//= require backbone</span>
<span class="c1">//= require todos</span>
</pre></div></div>

<p>Rubyを一行も書いていませんが、なんとこれで終わりです！あとはhtmlとjavascriptをがりがりと書いていくだけです</p>

<h2>
<span id="htmlとjavascriptを書く" class="fragment"></span><a href="#html%E3%81%A8javascript%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>htmlとjavascriptを書く</h2>

<p><a href="http://documentcloud.github.com/backbone/examples/todos/index.html" rel="nofollow noopener" target="_blank">元のチュートリアルのhtml</a>のbodyタグ内をapp/views/todos/index.html.erbにコピペします。このチュートリアルでは新しくTodoを作った時にDOMを作るのに、underscore.jsのテンプレート機能（とjQuery)を利用していますが、erbのロジックととunderscore.jsが標準で用意しているロジックが競合するため、そのままだとRailsがunderscore.jsのテンプレート用のロジックをerbのものだと勘違いしてエラーとなってしまいます。そこでtodos.jsに</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">_</span><span class="p">.</span><span class="nx">templateSettings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">interpolate</span><span class="o">:</span> <span class="sr">/\{\{(.+?)\}\}/g</span><span class="p">,</span>
  <span class="nx">evaluate</span><span class="o">:</span> <span class="sr">/\{%(.+?)%\}/g</span><span class="p">,</span>
  <span class="nx">escape</span><span class="o">:</span> <span class="sr">/\{%-(.+?)%\}/g</span>
<span class="p">};</span>
</pre></div></div>

<p>と記述して標準のロジックを変更してしまうことにします。上記の記述では、Python用WebフレームワークであるDjangoのテンプレートエンジンに似た記法を採用しています。そしてこの新しいロジックに合うようにコピペしたhtml内の二つの<code>&lt;script type="text/template"&gt;</code>タグの中身を以下のように変更します。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/template"</span> <span class="na">id</span><span class="o">=</span><span class="s">"item-template"</span><span class="p">&gt;</span>
  <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo {{ done ? 'done' : '' }}"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"display"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"check"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"checkbox"</span> <span class="p">{{</span> <span class="nx">done</span> <span class="o">?</span> <span class="s1">'checked="checked"'</span> <span class="o">:</span> <span class="s1">''</span> <span class="p">}}</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-text"</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
      <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-destroy"</span><span class="o">&gt;&lt;</span><span class="err">/span&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"edit"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-input"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="nx">value</span><span class="o">=</span><span class="s2">""</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>
  <span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/template"</span> <span class="na">id</span><span class="o">=</span><span class="s">"stats-template"</span><span class="p">&gt;</span>
  <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">total</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-count"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"number"</span><span class="o">&gt;</span><span class="p">{{</span> <span class="nx">remaining</span> <span class="p">}}</span><span class="o">&lt;</span><span class="err">/span&gt;</span>
      <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"word"</span><span class="o">&gt;</span><span class="p">{{</span> <span class="nx">remaining</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s1">'item'</span> <span class="o">:</span> <span class="s1">'items'</span> <span class="p">}}</span><span class="o">&lt;</span><span class="err">/span&gt; left.</span>
    <span class="o">&lt;</span><span class="err">/span&gt;</span>
  <span class="p">{</span><span class="o">%</span> <span class="p">}</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-clear"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#"</span><span class="o">&gt;</span>
        <span class="nx">Clear</span> <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"number-done"</span><span class="o">&gt;</span><span class="p">{{</span> <span class="nx">done</span> <span class="p">}}</span><span class="o">&lt;</span><span class="err">/span&gt;</span>
        <span class="nx">completed</span> <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"word-done"</span><span class="o">&gt;</span><span class="p">{{</span> <span class="nx">done</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s1">'item'</span> <span class="o">:</span> <span class="s1">'items'</span> <span class="p">}}</span><span class="o">&lt;</span><span class="err">/span&gt;</span>
      <span class="o">&lt;</span><span class="err">/a&gt;</span>
    <span class="o">&lt;</span><span class="err">/span&gt;</span>
  <span class="p">{</span><span class="o">%</span> <span class="p">}</span> <span class="o">%</span><span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>最後にチュートリアルのjsをtodos.jsにコピペし、<code>TodoList</code>コレクションのlocalStorageプロパティを削除し、代わりに<code>url</code>プロパティに<code>"/todos"</code>をセットします。次のようになるはずです</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nb">window</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

  <span class="c1">// localStorage: new Store("todos"), 削除</span>

  <span class="nx">url</span><span class="o">:</span> <span class="s2">"/todos"</span><span class="p">,</span>

  <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">});</span>
</pre></div></div>

<p>これで完成です。Railsを起動してアクセスしたら、動作していることが確認できるはずです。詳しい動作説明などは元のチュートリアルを参照してください。<br>
このように、Railsのscaffold機能を用いることで、簡単にBackbone.jsのバックエンドを用意することができます。</p>

<h2>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h2>

<p>Backbone.jsはRESTfulなAPIを対象とすると書きましたが、ある程度のカスタマイズを行うことができます。</p>

<p>まず、APIのURLのカスタマイズを行うことができ、上記のように、ModelやCollectionのurlプロパティまたはメソッドやurlRootプロパティでカスタマイズすることができます。</p>

<p>そして、サーバから返されるjsonは初期状態では以下のような形式を期待されていますが</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"hoge"</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span><span class="p">}]</span>
</pre></div></div>

<p>例えば、他に検索ヒット数やページャのページ数などを同時に返して、以下のような形式になる場合は</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nx">info</span><span class="o">:</span> <span class="p">{</span><span class="nx">results</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">total_pages</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">current_page</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span>
<span class="nx">todos</span><span class="o">:</span> <span class="p">[{</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"hoge"</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span><span class="p">}]}</span>
</pre></div></div>

<p>parseメソッドを用いてカスタマイズすることができます。上記の例の場合なら</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">info</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">info</span><span class="p">;</span>  <span class="c1">// ここでヒット件数の処理なども記述できる</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">todos</span>  <span class="c1">// 返される値がモデルにセットされる。Collectionだから配列を返している</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />38位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>67</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/03f49c64d6c4bacdbb26">Backbone.js入門 「MVC」</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-15 09:36:12</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="閲覧上の注意" class="fragment"></span><a href="#%E9%96%B2%E8%A6%A7%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>閲覧上の注意</h3>

<p>この記事で対象としているバージョン0.5.3は結構古いので注意してください。</p>

<p>その他の割りと新しい情報は <a href="http://www.adventar.org/calendars/15" rel="nofollow noopener" target="_blank">Backbone.js Advent Calendar 2012</a> などにあります。</p>

<p>（追記ここまで）</p>

<hr>

<p>予定では View の日ですが、当初の予定を変更して、今回は Backbone.js における MVC について解説したいと思います。<br>
なお、今回の内容は、私の認識方法の紹介であり、異なる考え方をする人もいると思います。<br>
とりあえず大事なことは「Rails の MVC と同じものだと考えてはいけない」ということです。</p>

<h1>
<span id="backbonejs-と-mvc" class="fragment"></span><a href="#backbonejs-%E3%81%A8-mvc"><i class="fa fa-link"></i></a>Backbone.js と MVC</h1>

<p>Ruby on Railsに代表される MVC アーキテクチャを採用した WEB アプリケーションフレームワーク (WAF) に慣れ親しんでいる人にとって、MVC という単語は馴染み深いものだと思います。<br>
しかしながら、本来 MVC は GUI を持ったアプリケーションを設計するために開発されたものであり、そのような本来の MVC と WAF における MVC は、登場人物の名前は同じですが、根本的に異なるものです。<br>
Backbone.js はどちらかというと、ここでいうところの <em>本来の MVC</em> に近いアーキテクチャになっており、本記事を読む人の大半が慣れ親しんでいる Rails 型の MVC とは考え方が <strong>異なる</strong> ということをまず意識することが大切です。</p>

<h2>
<span id="backbonejs-と-rails-の-mvc-の違い" class="fragment"></span><a href="#backbonejs-%E3%81%A8-rails-%E3%81%AE-mvc-%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>Backbone.js と Rails の MVC の違い</h2>

<ul>
<li>参考: <a href="https://gist.github.com/1362110" rel="nofollow noopener" target="_blank">サバクラ両方で動く JavaScript の大規模開発を行うために — Gist</a>
</li>
</ul>

<p>両者の違いが生まれるのは、それぞれの <strong>ユーザとのインタラクションの仕方が違うから</strong> です。</p>

<h3>
<span id="rails-の場合" class="fragment"></span><a href="#rails-%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>Rails の場合</h3>

<p>詳しくは参考ページに譲りますが、WAF では基本的にユーザとのやり取りは HTTP を用い、ユーザから与えられるのは、ユーザが見ようとしているページの URL です。(参考ページ内では <em>Model2</em> という名前で解説されています。) <br>
そして、ユーザには HTTP を用いて主に HTML が返されます。<br>
HTTP リクエストを受け取った Controller は内部で Model を介して DB にアクセスし、得られたデータを View に埋め込む形で HTML を生成し、HTTP レスポンスとしてユーザに返します。まるで Model と View は Controller の為のユーティリティモジュールのようです。</p>

<h3>
<span id="伝統的な-mvc" class="fragment"></span><a href="#%E4%BC%9D%E7%B5%B1%E7%9A%84%E3%81%AA-mvc"><i class="fa fa-link"></i></a>伝統的な MVC</h3>

<p>一方 GUI アプリケーションでは、ユーザは「ボタンをクリックする」などの動作によって、システムとやり取りをします。<br>
この時最初にユーザのインタラクションを受け取るのは、クリックされたボタンに対応する View なのです。<br>
そこから、ボタンクリックに設定されたアクションを、Controller を呼び出す形で実行し、Controller 内部で Model が更新され、その更新がトリガーとなって View が変更されます。</p>

<h3>
<span id="backbonejs-の-mvc" class="fragment"></span><a href="#backbonejs-%E3%81%AE-mvc"><i class="fa fa-link"></i></a>Backbone.js の MVC</h3>

<p>Backbone.js でもこれとほぼ同様で、ユーザが発生させた様々なイベントを View が捕捉することが起点となって、処理が始まります。<br>
伝統的な GUI アプリケーションと少し異なるのは、URL の変更イベント (hashchange, popstate) を監視するために、Router と呼ばれる専用のオブジェクトが用意されていることですが、Router もユーザの行動を捕捉して処理の起点になるという意味においては、URL バーを管理する View である、つまり、Router は View の一種だと考えることができます。<br>
実は Backbone.js の古いバージョンでは Router が Controller という名前でしたが変更されました。詳しい事情は知りませんが、おそらく、先に述べたように、Router は Controller というよりは View に近くこのような名前付けはミスリーディングである、と考えたのではないでしょうか。では Controller はどこにあるのでしょう？<br>
Backbone.js では View が Controller を内包していると言えるのではないかと、筆者は考えています。（ここから先は意見の別れるところかも知れません）<br>
実際、次回以降で見ていくように View が捕捉したイベントで起動されるのは View のメソッドであり、その中で Model の操作を行う場面が多々あります。<br>
本来の MVC において View は Model を参照しませんが、Backbone.js では View が Model を保持していることを取り上げて、「Backbone.js はここが違う」という風に説明している場合がありますが、このように View が Controller の機能も含んでいると考えれば、View が Model を参照しているのは元々の MVC アーキテクチャの構造と一致します。また、「Router が Controller なのか」というような記述を見かけることがありますが、上記の話からも「Backbone.js の View は、旧来の View と Controller の両方の役割を担っている」と言った方が的を得ているのではないかと思います。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<ol>
<li>Backbone.js の MVC と Rails の MVC は似て非なるもの</li>
<li>Backbone.js には Controller という名前のオブジェクトがない</li>
<li>Backbone.js では View の役割が大きい(一般的な View と Controller の両方の役割を持っている)</li>
</ol>

<h2>
<span id="今回はここまで" class="fragment"></span><a href="#%E4%BB%8A%E5%9B%9E%E3%81%AF%E3%81%93%E3%81%93%E3%81%BE%E3%81%A7"><i class="fa fa-link"></i></a>今回はここまで</h2>

<p>当初の予定では View の使い方について解説する予定でしたが、準備として MVC について書き始めたら意外と分量が行ったので今回はここまで。<br>
次回こそは View について扱います。<br>
ではまた明日。</p>

<hr>

<ol>
<li><a href="http://qiita.com/items/16b799d0ec0a0ae3f78e">Backbone.js入門 Events</a></li>
<li>Backbone.js入門 MVC</li>
<li><a href="http://qiita.com/items/8ee2ed1949cd7c337f06">Backbone.js入門 View</a></li>
<li><a href="http://qiita.com/items/5acef8dd49f67fd7813c">Backbone.js入門 Model</a></li>
<li><a href="http://qiita.com/items/7ce4b1ceb5d18c9cef08">Backbone.js入門 ViewとModelの連携</a></li>
<li><a href="http://qiita.com/items/c19d2fff0dc23e4015ff">Backbone.js入門 Collection</a></li>
<li><a href="http://qiita.com/items/7095a32cc5e438172844">Backbone.js入門 ViewとModelとCollectionの連携</a></li>
<li><a href="http://qiita.com/items/13f3d1f71d31f3e78123">Backbone.js入門 RouterとHistory</a></li>
</ol>

<ul>
<li><a href="https://groups.google.com/forum/?fromgroups#!forum/backbonejs-ja" rel="nofollow noopener" target="_blank">BackboneJS 日本語メーリングリスト</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />39位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>65</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/19e10905920bfcc5d500">A successful Git branching modelから重要なとこを抽出</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-01-24 23:20:10</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Git使うなら絶対に一度は読んだ方がいい良エントリ</p>

<ul>
<li><a href="http://nvie.com/posts/a-successful-git-branching-model/" rel="nofollow noopener" target="_blank">A successful Git branching model</a></li>
<li><a href="http://keijinsonyaban.blogspot.com/2010/10/successful-git-branching-model.html" rel="nofollow noopener" target="_blank">日本語訳</a></li>
</ul>

<p>理屈は本文読めということで、ルール的な箇所を抽出</p>

<h1>
<span id="ブランチの種類" class="fragment"></span><a href="#%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%AE%E7%A8%AE%E9%A1%9E"><i class="fa fa-link"></i></a>ブランチの種類</h1>

<ol>
<li>メインブランチ</li>
<li>サポートブランチ</li>
</ol>

<p>サポートブランチはさらに3種類に分類される</p>

<h1>
<span id="メインブランチ" class="fragment"></span><a href="#%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81"><i class="fa fa-link"></i></a>メインブランチ</h1>

<ul>
<li>メインブランチはmasterとdevelopの二つ</li>
<li>この二つは常に存在するし、削除しない</li>
<li>masterでの開発は一切しない</li>
<li>developで開発してmasterにマージするのが大きな流れ</li>
</ul>

<h1>
<span id="サポートブランチ" class="fragment"></span><a href="#%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81"><i class="fa fa-link"></i></a>サポートブランチ</h1>

<ul>
<li>フィーチャーブランチ</li>
<li>リリースブランチ</li>
<li>ホットフィックスブランチ</li>
<li>用が済めば削除される</li>
</ul>

<h2>
<span id="フィーチャーブランチ" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81"><i class="fa fa-link"></i></a>フィーチャーブランチ</h2>

<ul>
<li>developから分岐してdevelopにマージされる</li>
<li>命名規則は特に無し（他の種類のブランチと区別がつくように）</li>
<li>個々の機能を実装する</li>
<li>originにはpushしない</li>
</ul>

<h3>
<span id="フィーチャーブランチの一生" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%AE%E4%B8%80%E7%94%9F"><i class="fa fa-link"></i></a>フィーチャーブランチの一生</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ git checkout -b myfeature develop
$ <span class="c1"># 機能の開発</span>
$ git commit -m <span class="s1">'Implement myfeature'</span>
$ git checkout develop
$ git merge --no-ff myfeature <span class="c1"># --no-ffフラグでマージして</span>
$ git branch -D myfeature <span class="c1"># 開発が終了したブランチは削除する</span>
$ git push origin develop
</pre></div></div>

<p><code>--no-ff</code>フラグについては本文参照</p>

<h2>
<span id="リリースブランチ" class="fragment"></span><a href="#%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81"><i class="fa fa-link"></i></a>リリースブランチ</h2>

<ul>
<li>developから分岐してmasterにマージされる</li>
<li>デプロイ用の変更を開発環境に反映したければdevelopにもマージする</li>
<li>命名規則は<code>release-*</code>
</li>
<li>機能開発はしない</li>
<li>デプロイの準備をする</li>
</ul>

<h3>
<span id="リリースブランチの一生" class="fragment"></span><a href="#%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%AE%E4%B8%80%E7%94%9F"><i class="fa fa-link"></i></a>リリースブランチの一生</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ git checkout -b release-1.2 develop <span class="c1"># version1.2のためのリリースブランチ</span>
$ <span class="c1"># リリースのための作業</span>
$ git commit -m <span class="s1">'Version 1.2'</span>
$ git checkout master
$ git merge --no-ff release-1.2
$ git tag -a <span class="m">1</span>.2
$ git branch -D release-1.2
</pre></div></div>

<h2>
<span id="ホットフィックスブランチ" class="fragment"></span><a href="#%E3%83%9B%E3%83%83%E3%83%88%E3%83%95%E3%82%A3%E3%83%83%E3%82%AF%E3%82%B9%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81"><i class="fa fa-link"></i></a>ホットフィックスブランチ</h2>

<ul>
<li>masterから分岐してdevelopとmasterにマージされる</li>
<li>本番環境発覚したバグなどに対応する</li>
<li>命名規則は<code>hotfix-*</code>
</li>
<li>機能開発ではない</li>
</ul>

<h3>
<span id="ホットフィックスブランチの一生" class="fragment"></span><a href="#%E3%83%9B%E3%83%83%E3%83%88%E3%83%95%E3%82%A3%E3%83%83%E3%82%AF%E3%82%B9%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%AE%E4%B8%80%E7%94%9F"><i class="fa fa-link"></i></a>ホットフィックスブランチの一生</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ git checkout -b hotfix-1.2.1 master
$ <span class="c1">#バグフィックス</span>
$ git commit -m <span class="s1">'Fixed severe production problem'</span>
$ <span class="c1"># バージョンを一つ上げる</span>
$ git commit -am <span class="s1">'Version 1.2.1'</span>
$ git checkout master
$ git merge --no-ff hotfix-1.2.1
$ git tag -a <span class="m">1</span>.2.1
$ git checkout develop <span class="c1"># もしリリースブランチがあれば、そっちにマージ</span>
$ git merge --no-ff hotfix-1.2.1
$ git branch -D hotfix-1.2.1
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />40位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>64</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/13f3d1f71d31f3e78123">Backbone.js入門 「Router と History」 </a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-20 11:23:44</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="閲覧上の注意" class="fragment"></span><a href="#%E9%96%B2%E8%A6%A7%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>閲覧上の注意</h3>

<p>この記事で対象としているバージョン0.5.3は結構古いので注意してください。</p>

<p>その他の割りと新しい情報は <a href="http://www.adventar.org/calendars/15" rel="nofollow noopener" target="_blank">Backbone.js Advent Calendar 2012</a> などにあります。</p>

<p>（追記ここまで）</p>

<hr>

<p>Backbone.js入門の最終回は <code>Router</code> と <code>History</code> です。<br>
<a href="http://qiita.com/items/1376">Backbone.js入門 「MVC」</a>で述べたように、URL が変更された時に発生する <code>popstate</code> または <code>hashchange</code> イベントを監視してルーチンを起動するのが <code>Router</code> の役目です。<code>History</code> は <code>Router</code> の裏方で頑張る実体で、直接操作することはほとんどありません。<br>
URL が変更された時にアクセスされるのが <code>Router</code> なので、Rails 的な MVC の枠組みで言えばコントローラと言えますし、伝統的な MVC で言えば全てのアンカーとブラウザの進退ボタンを管理するビューだと言えます。<code>View</code> がビューとコントローラの役割を両方もっていたように、<code>Router</code> も両方の役割を負っていると考えるのが自然でしょう。</p>

<h2>
<span id="基本的な使い方" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>基本的な使い方</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">MyRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"foo/:hoge"</span><span class="o">:</span> <span class="s2">"bar"</span> <span class="c1">// (1)</span>
    <span class="p">},</span>
    <span class="nx">bar</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">hoge</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">hoge</span><span class="p">);</span> <span class="c1">// (2)</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="k">new</span> <span class="nx">MyRouter</span><span class="p">();</span>
<span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</pre></div></div>

<p>このような設定があるとき <code>&lt;a href="#foo/hogehoge"&gt;foo&lt;/a&gt;</code> をクリックすると、URL のハッシュ値が <code>#foo/hogehoge</code> に変更されます。<br>
その上で、<strong>(1)</strong> に記述されたルールが適応され <code>bar</code> が実行されます。<code>routes</code> にある <code>:hoge</code> という部分に対応する hogehoge が代入されて <code>bar</code> に渡されます。その結果 <strong>(2)</strong> が実行されて hogehoge とアラートされます。</p>

<h2>
<span id="pushstateを使う" class="fragment"></span><a href="#pushstate%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>pushStateを使う</h2>

<p>HTML5 の pushState が使えるブラウザではハッシュではなく、pushState を用いたルーティングをするように内部で書き換えることができます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">({</span><span class="nx">pushState</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
</pre></div></div>

<p>この時、どこまでが実際の url でどこからがハッシュ値なのかが分からないため root で教えてやる必要があります。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">({</span><span class="nx">pushState</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">root</span><span class="o">:</span> <span class="s2">"/hoge/"</span><span class="p">});</span>
</pre></div></div>

<p>これにより、pushState によって URL が <code>/hoge/foo</code> に変更されるとその際に発生する popstate イベントに反応して <strong>(2)</strong> が実行されるようになります。<br>
上で使った <code>&lt;a href="#foo/hogehoge"&gt;</code> をクリックすることで popstate をさせたい場合は、jQuery と後述する <code>navigate</code> を使って次のように書くことができます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyRouter</span><span class="p">();</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"a[href^=#]"</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"click"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"href"</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="p">});</span>
</pre></div></div>

<p>これにより <code>/hoge/foo/hogehoge</code> に URL が変わり、hogehoge と アラートされます。</p>

<p>pushState を有効にすることで、リソースを異なるページで管理しているように見せかけることができるようになりますが、以降でユーザが直接その URL にアクセスしてきたとしても同様のページを表示するようにしなければなりません。</p>

<h2>
<span id="routernavigatefragment-triggerroute" class="fragment"></span><a href="#routernavigatefragment-triggerroute"><i class="fa fa-link"></i></a>Router#navigate(fragment, [triggerRoute])</h2>

<p>明示的にルーティングを変更します。<code>triggerRoute</code> に true を渡すと URL の書き換えと同時に、対応するコールバック関数を実行します。</p>

<h2>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h2>

<p>以上で Backbone.js 入門は終わりです。<br>
今回の一連の連載記事で Backbone.js で用いるオブジェクト達の利用方法を一通り見てきました。<br>
これから Backbone.js を使ってみようと思う方の役にたてていれば幸いです。</p>

<p>Backbone.js は世界的に広く使われ始めた JavaScript フレームワークですが、日本ではまだそれほど多くの導入事例があるわけではありません。<br>
一緒に Backbone.js を盛り上げていきましょう！</p>

<hr>

<ol>
<li><a href="http://qiita.com/items/16b799d0ec0a0ae3f78e">Backbone.js入門 Events</a></li>
<li><a href="http://qiita.com/items/03f49c64d6c4bacdbb26">Backbone.js入門 MVC</a></li>
<li><a href="http://qiita.com/items/8ee2ed1949cd7c337f06">Backbone.js入門 View</a></li>
<li><a href="http://qiita.com/items/5acef8dd49f67fd7813c">Backbone.js入門 Model</a></li>
<li><a href="http://qiita.com/items/7ce4b1ceb5d18c9cef08">Backbone.js入門 ViewとModelの連携</a></li>
<li><a href="http://qiita.com/items/c19d2fff0dc23e4015ff">Backbone.js入門 Collection</a></li>
<li><a href="http://qiita.com/items/7095a32cc5e438172844">Backbone.js入門 ViewとModelとCollectionの連携</a></li>
<li>Backbone.js入門 RouterとHistory</li>
</ol>

<ul>
<li><a href="https://groups.google.com/forum/?fromgroups#!forum/backbonejs-ja" rel="nofollow noopener" target="_blank">BackboneJS 日本語メーリングリスト</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />41位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>60</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/fd517a4c3d13f6f3de40">引数のデフォルト値はimmutableなものにする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-05-25 02:54:08</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>関数定義で引数のデフォルト値を設定できる</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'baz'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bar</span>
</pre></div></div>

<p><code>foo()</code>を実行すると、<code>['baz']</code> というリストが返ってくる</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="p">[</span><span class="s1">'baz'</span><span class="p">]</span>
</pre></div></div>

<p>さて同じコードをもう一度実行するとどうなるだろうか？</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="p">[</span><span class="s1">'baz'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">]</span>
</pre></div></div>

<p>結果が変わってしまっている。何故このようなことになるかというと、Pythonでは関数のデフォルト値は最初の一回しか評価されないためだ。そして、Pythonのリストは変更可能なオブジェクト(mutable)であり、<code>append()</code>はリストに対し破壊的に引数を追加するため、2回目の実行で予期しない結果が返ってきてしまうことになる。</p>

<p>この問題をクリアするにはimmutableなオブジェクトをデフォルトにすればいい。今回の<code>foo</code>関数の場合だと</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bar</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'baz'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bar</span>
</pre></div></div>

<p>のようにする。この関数は何度引数なしで呼び出しても、Noneはimmutableなので毎回同じ結果を返す。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="p">[</span><span class="s1">'baz'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="p">[</span><span class="s1">'baz'</span><span class="p">]</span>
</pre></div></div>

<p>Pythonではstrはimmutableなので文字列をデフォルト値として用いるのは特に問題ない。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />42位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>59</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/f53a9d3ea92614b0927d">プルリクエストを自動補完してcheckoutする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-02 10:45:29</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> <b>[GitHub]</b> <b>[percol]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h2>

<p>プルリクエストのレビュー、動作確認をするためにローカルでcheckoutしたいが、ブランチ名を調べて入力するのが面倒くさい。<a href="http://qiita.com/kenbeese@github/items/a5410b9a4f322b38ac3b" id="reference-32c52d9eaa4e1c1089df">別名をつけてcheckoutできるようにする方法</a>があるが、プルリクエストの番号を調べる必要があってそれも面倒。</p>

<p>もっと簡単にcheckoutしたい!!!</p>

<h2>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h2>

<p>プルリクエストの一覧からブランチを選択してcheckoutできるようにしました。</p>

<p><a href="https://camo.qiitausercontent.com/cda9b4490cfd287cc7637c9ca4ce1cf394026bbe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f32353930323239392d346235302d313637302d656665312d3034613665343566363631622e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cda9b4490cfd287cc7637c9ca4ce1cf394026bbe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f32353930323239392d346235302d313637302d656665312d3034613665343566363631622e676966" alt="BIjYohy0TtY.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/25902299-4b50-1670-efe1-04a6e45f661b.gif"></a></p>

<h3>
<span id="1-プルリクエスト一覧を取得する" class="fragment"></span><a href="#1-%E3%83%97%E3%83%AB%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E4%B8%80%E8%A6%A7%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. プルリクエスト一覧を取得する</h3>

<p>まずプルリクエスト一覧を取得します。そのために<a href="https://github.com/yuku-t/dotfiles/blob/master/bin/prfetch" rel="nofollow noopener" target="_blank">prfetch</a>というスクリプトを書きました。<br>
手っ取り早く下記でインストールできます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/yuku-t/dotfiles/master/bin/prfetch
chmod +x prfetch
mv prfetch ~/bin  <span class="c1"># ~/bin はPATHに入っているとする</span>
</pre></div></div>

<p>prfetchは<a href="https://github.com/schacon/ruby-git" rel="nofollow noopener" target="_blank">ruby-git</a>, <a href="https://github.com/octokit/octokit.rb" rel="nofollow noopener" target="_blank">octokit.rb</a>, <a href="https://github.com/geemus/netrc" rel="nofollow noopener" target="_blank">netrc</a>に依存しているので、それらもインストールします。（必要に応じて <code>sudo</code> をつけてください）</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>gem install git octokit netrc
</pre></div></div>

<p>このnetrcというのはoctokitがGitHub APIを叩く際の認証情報を記述するためのもので <code>~/.netrc</code> に次のようなファイルを設置します。<code>パスワードorアプリケーショントークン</code>となっているところには、ログインパスワードか、GitHubの<a href="https://github.com/settings/applications" rel="nofollow noopener" target="_blank">Application Setting</a>のPersonal Access Tokensで新しく作ったトークンを入力します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">~/.netrc</span></div>
<div class="highlight"><pre><span></span>machine api.github.com
  login GitHubユーザ名
  password パスワードorアプリケーショントークン
</pre></div>
</div>

<p>パスワードとかを書いているのでファイルの権限には気をつけてください。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>chmod <span class="m">600</span> ~/.netrc
</pre></div></div>

<p>インストールできていればoriginがGitHubに向いているようなgitリポジトリでprfetchコマンドを叩くと、プルリクエスト一覧が標準出力されます。</p>

<p><a href="https://camo.qiitausercontent.com/2814d68945a65620f1dbd5146fa4ea4d5b53094a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f39663535666538632d646564632d346431642d653838322d6538323637393932616532302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/2814d68945a65620f1dbd5146fa4ea4d5b53094a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f39663535666538632d646564632d346431642d653838322d6538323637393932616532302e706e67" alt="Screen Shot 2013-12-01 at 11.59.01 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/9f55fe8c-dedc-4d1d-e882-e8267992ae20.png"></a></p>

<h3>
<span id="2-percolを使って絞り込む" class="fragment"></span><a href="#2-percol%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E7%B5%9E%E3%82%8A%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>2. percolを使って絞り込む</h3>

<p>プルリクエストの絞り込みには<a href="https://github.com/mooz/percol" rel="nofollow noopener" target="_blank">percol</a>を使います。これは複数行にまたがる標準入力からインタラクティブに一行を選択し、それを標準出力できるようにしてくれるコマンドです。</p>

<p>上のgifで途中ピンクの行が上下に動いていましたが、あの部分がpercolです。</p>

<p>下記でpercolをインストールします。（これも必要に応じて <code>sudo</code> をつけてください）</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>easy_install percol
</pre></div></div>

<h3>
<span id="3-選択されたプルリクエストをcheckout" class="fragment"></span><a href="#3-%E9%81%B8%E6%8A%9E%E3%81%95%E3%82%8C%E3%81%9F%E3%83%97%E3%83%AB%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92checkout"><i class="fa fa-link"></i></a>3. 選択されたプルリクエストをcheckout</h3>

<p>最後に選択されたものをcheckoutすれば完了です。percolで選択された行のブランチ名を取り出してcheckoutします。全てを合わせるとこれで完了。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>prfetch <span class="p">|</span> percol <span class="p">|</span> cut -f3 <span class="p">|</span> xargs git checkout
</pre></div></div>

<h2>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h2>

<p>今回声を大にして申し上げたいのは <strong>percol最高</strong> ということなのであります。<br>
加えて開発者の <a href="/mooz@github" class="user-mention js-hovercard" title="mooz@github" data-hovercard-target-type="user" data-hovercard-target-name="mooz@github">@mooz@github</a> 氏はなかなかのナイスガイであると、付け加えさせていただきます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />43位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>59</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/2e088d5cab803cb6b1ee">Gitリポジトリ内の特定の語を全て置換する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-05-19 14:05:13</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> <b>[Git]</b> <b>[sed]</b> <b>[GNU]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>FooをBarにする場合、先にfoo-&gt;barをしてしまうと、Fooまでbarになってしまうので注意（FooはBarになって欲しいはず)</p>

<h1>
<span id="bsd-mac" class="fragment"></span><a href="#bsd-mac"><i class="fa fa-link"></i></a>BSD (Mac)</h1>

<p>BSDでは<code>--in-place</code>がバックアップファイルの拡張子を受け取るので、バックアップファイルが要らない場合は''を指定する</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>git grep -l Foo | xargs sed -i '' -e 's/Foo/Bar/g'
git grep -l foo | xargs sed -i '' -e 's/foo/bar/g'
</pre></div></div>

<p>''を忘れると<code>-e</code>というのが末尾に追加されたバックアップファイルが作成される（置換はちゃんと行われる。この動作はバグなんじゃないかと思うけど、よく分からない）</p>

<h1>
<span id="gnu" class="fragment"></span><a href="#gnu"><i class="fa fa-link"></i></a>GNU</h1>

<p>GNUのsed若干実装が違うため、''を渡す必要がない。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>git grep -l Foo | xargs sed -i -e 's/Foo/Bar/g'
git grep -l foo | xargs sed -i -e 's/foo/bar/g'
</pre></div></div>

<p>逆に、バックアップファイルが欲しい場合（拡張子.bakをつける)</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>git grep -l Foo | xargs sed -i.bak -e 's/Foo/Bar/g'
git grep -l foo | xargs sed -i.bak -e 's/foo/bar/g'
</pre></div></div>

<p>iと.bakが連続している点に注意</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />44位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>58</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/2f7935f924b6e6c0732d">大人数でBoxen使うならboxen-webが断然便利</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-18 16:09:44</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> <b>[GitHub]</b> <b>[Boxen]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://boxen.github.com" rel="nofollow noopener" target="_blank">Boxen</a>をWebアプリケーションとして配布できる<a href="https://github.com/boxen/boxen-web" rel="nofollow noopener" target="_blank">boxen-web</a>を使ってみた。</p>

<h1>
<span id="簡単なまとめ" class="fragment"></span><a href="#%E7%B0%A1%E5%8D%98%E3%81%AA%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>簡単なまとめ</h1>

<p>boxen-webは...</p>

<ul>
<li>Boxenのインストールから実行までを1行のシェルコマンドでできるようにする

<ul>
<li>デザイナなどの非エンジニアに優しい</li>
</ul>
</li>
<li>Boxenを使う上で<strong>必須ではない</strong>
</li>
<li>OAuthを用いた認証によりメンバーのみアクセス可能</li>
<li>Heroku上で動作するのでサーバを用意する必要はない</li>
<li>GitHubの利用が必須</li>
<li>デプロイすると下記のようなサイトができる</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/11c3aeb53c9f409b5c1356c2bea1a50c8da96d18/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303331362f32303133303331363230343334342e706e673f31333633343334323435" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/11c3aeb53c9f409b5c1356c2bea1a50c8da96d18/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303331362f32303133303331363230343334342e706e673f31333633343334323435" alt="Boxen Web" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20130316/20130316204344.png?1363434245"></a></p>

<h2>
<span id="この記事で分かること" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E5%88%86%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事で分かること</h2>

<ul>
<li>boxen-webをデプロイする方法</li>
<li>新しいMacをboxen-webを使ってセットアップする方法</li>
</ul>

<h2>
<span id="この記事で分からないこと" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E5%88%86%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事で分からないこと</h2>

<ul>
<li>Boxenの使い方</li>
<li>Herokuの詳しい使い方</li>
</ul>

<h2>
<span id="注意事項" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85"><i class="fa fa-link"></i></a>注意事項</h2>

<p>Boxen自体はGitHub外のプライベートリポジトリでホストできるが、boxen-webを使う場合はGitHub上でホストされていなければならない。例えば、<a href="http://qiita.com/items/c6f20de0e4f4c352046c">Boxen使わなくても許されるのは2012年までだよね</a>に従ってBitbucketを使ってプライベートリポジトリを作った場合はboxen-webを使えない。</p>

<h1>
<span id="boxen-webとは何か" class="fragment"></span><a href="#boxen-web%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>boxen-webとは何か</h1>

<p>boxen-webはGitHub社が開発しているオープンソースのMac自動設定ツールBoxenを簡単にチームで共有できるようにするツール。中身はRailsで書かれておりHeroku上で動作する。<br>
Webアプリケーションにアクセスすると表示されるワンライナーを実行するだけでセットアップが完了するので非エンジニアでも簡単に使える。（boxen-webを使わずにBoxenを使う場合一旦git-cloneしてきてからスクリプトを叩く必要がある）</p>

<p>GitHubのOAuthによってクライアントを認証し、部外者がアクセスできないようになっている。</p>

<p>現在利用できるのはGitHub上でホストされているBoxenリポジトリのみ。GitHub:Enterpriseのサポートはissueには上がっているがいつになるかは不明。</p>

<h1>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h1>

<ol>
<li>事前準備</li>
<li>GitHub OAuth Applicationの用意</li>
<li>boxen-webの用意</li>
<li>Herokuにデプロイ</li>
<li>新しいMacをboxen-webでセットアップする手順</li>
</ol>

<h2>
<span id="事前準備" class="fragment"></span><a href="#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>事前準備</h2>

<h3>
<span id="boxenを作る" class="fragment"></span><a href="#boxen%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>Boxenを作る</h3>

<p>チーム用にBoxenを用意する。詳しくは<a href="http://qiita.com/items/c6f20de0e4f4c352046c">Boxen使わなくても許されるのは2012年までだよね</a>参照。</p>

<h3>
<span id="organizationとteamを作る" class="fragment"></span><a href="#organization%E3%81%A8team%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>OrganizationとTeamを作る</h3>

<p>GitHubにOrganizationとTeamを作る。OrganizationとTeamの関係は一対多、つまり、1つのOrganizationに複数のTeamを作れる。そしてOrganizationのmemberとは少なくとも1つのTeamに所属しているGitHubアカウント。</p>

<p>boxen-webはOrganizationではなくTeam単位で作るものであることに注意。<br>
Boxen自体にプロジェクト単位やチーム単位でセットアップする設定を書けるので、AllみたいなTeamを作って全員このTeamに含めてしまうのがいいのではないだろうか。</p>

<p>OrganizationとTeamの作り方はGoogle先生に聞いてほしい。Teamには固有のID（整数）が割り振られる。それについてはTeamのページのURLを見れば分かる。このIDは後で必要になる。</p>

<h2>
<span id="github-oauth-applicationの用意" class="fragment"></span><a href="#github-oauth-application%E3%81%AE%E7%94%A8%E6%84%8F"><i class="fa fa-link"></i></a>GitHub OAuth Applicationの用意</h2>

<p>OrganizationのOrganization Applications設定へ行って"Register new application"を押す。<br>
下記の<code>NAME</code> はHerokuに作るアプリケーションの名前に置きかえる。</p>

<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>Application Name</td>
<td>Boxen Web</td>
</tr>
<tr>
<td>Main URL</td>
<td><a href="https://NAME.herokuapp.com" class="autolink" rel="nofollow noopener" target="_blank">https://NAME.herokuapp.com</a></td>
</tr>
<tr>
<td>Callback URL</td>
<td><a href="https://NAME.herokuapp.com/auth/github/callback" class="autolink" rel="nofollow noopener" target="_blank">https://NAME.herokuapp.com/auth/github/callback</a></td>
</tr>
</tbody>
</table>

<h2>
<span id="boxen-webを用意" class="fragment"></span><a href="#boxen-web%E3%82%92%E7%94%A8%E6%84%8F"><i class="fa fa-link"></i></a>boxen-webを用意</h2>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span><span class="nb">cd</span> ~/src
git clone git://github.com/boxen/boxen-web.git
<span class="nb">cd</span> boxen-web
</pre></div>
</div>

<h3>
<span id="ローカルで動作確認する" class="fragment"></span><a href="#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%81%A7%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ローカルで動作確認する</h3>

<p>boxen-webの動作確認をローカルですることができる。必須ではないので、一旦ここは飛ばしていきなりデプロイしていい。デプロイが上手くいかなかったらここに戻ってくる。</p>

<p>まず、前提としてHerokuなのでDBはPostgreSQLである。またそのPostgreSQLはBoxenでセットアップされたものでなければならない。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">Puppetfile</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 追記</span>
<span class="n">github</span> <span class="s2">"postgresql, "</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="s2">"</span>
</pre></div>
</div>

<p>そして下記を実行する。上手くいかなかったら自分のmanifestに<code>include postgresql</code>と追記して<code>script/boxen</code>を実行する。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span><span class="nb">cd</span> ~/src/my-boxen
script/boxen postgresql <span class="c1"># PostgreSQLをインストール</span>
</pre></div>
</div>

<p>次にboxen-webをインストールする。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span>script/bootstrap
</pre></div>
</div>

<p>続いて以下の環境変数を設定する。一つでも欠けているとエラーになる。</p>

<table>
<thead>
<tr>
<th>名前</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>REPOSITORY</td>
<td>GitHub上でのリポジトリの名前</td>
</tr>
<tr>
<td>GITHUB_CLIENT_ID</td>
<td>OAuth Applicationで作ったやつ</td>
</tr>
<tr>
<td>GITHUB_CLIENT_SECRET</td>
<td>OAuth Applicationで作ったやつ</td>
</tr>
<tr>
<td>GITHUB_TEAM_ID</td>
<td>アクセスを許可するTeamのID</td>
</tr>
<tr>
<td>SECRET_TOKEN</td>
<td>
<code>$ rake secret</code> で取得する</td>
</tr>
</tbody>
</table>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span>rake db:migrate
script/server
</pre></div>
</div>

<p>するとローカルでサーバが立ち上がる。<a href="http://localhost:9393" class="autolink" rel="nofollow noopener" target="_blank">http://localhost:9393</a> にアクセスしてみる。エラーが起きなければOK。500が発生する場合は環境変数がおかしい可能性が高いので確認する。</p>

<h2>
<span id="herokuにデプロイ" class="fragment"></span><a href="#heroku%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4"><i class="fa fa-link"></i></a>Herokuにデプロイ</h2>

<h3>
<span id="herokuの準備" class="fragment"></span><a href="#heroku%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>Herokuの準備</h3>

<ol>
<li>Herokuのアカウントを持っていない人は <a href="http://get.heroku.com" class="autolink" rel="nofollow noopener" target="_blank">http://get.heroku.com</a> でアカウントを作る。</li>
<li>
<a href="https://toolbelt.heroku.com" class="autolink" rel="nofollow noopener" target="_blank">https://toolbelt.heroku.com</a> からHeroku Toolbeltをダウンロードしてインストールする。これはHerokuを使うためのCLIツール。</li>
<li>
<code>heroku login</code>を実行するとメールアドレスとパスワードを聞かれるので正しく入力する。</li>
</ol>

<h3>
<span id="herokuにアプリケーションを作る" class="fragment"></span><a href="#heroku%E3%81%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>Herokuにアプリケーションを作る</h3>

<p><code>NAME</code>はGitHub OAuth Applicationで設定したものと同じにする。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span><span class="c1"># ~/src/boxen-webで下記を実行</span>
heroku create NAME
</pre></div>
</div>

<p>これで空のアプリケーションが作られた。gitのremoteが設定されていればOK</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span>git remote -v
<span class="c1">#=&gt; heroku git@heroku.com:NAME.git (fetch)</span>
<span class="c1">#=&gt; heroku git@heroku.com:NAME.git (push)</span>
<span class="c1">#=&gt; origin git://github.com/boxen/boxen-web.git (fetch)</span>
<span class="c1">#=&gt; origin git://github.com/boxen/boxen-web.git (push)</span>
</pre></div>
</div>

<h3>
<span id="デプロイ" class="fragment"></span><a href="#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4"><i class="fa fa-link"></i></a>デプロイ</h3>

<p>Heroku用の環境変数を設定してデプロイする。環境変数の値は前述した「ローカルで動作確認する」参照。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">Terminal</span></div>
<div class="highlight"><pre><span></span><span class="c1"># ~/src/boxen-webで下記を実行</span>
heroku config:set <span class="se">\</span>
  <span class="nv">REPOSITORY</span><span class="o">=</span>user_or_organication/repo_name <span class="se">\</span>
  <span class="nv">GITHUB_CLIENT_ID</span><span class="o">=</span>your_github_client_id <span class="se">\</span>
  <span class="nv">GITHUB_CLIENT_SECRET</span><span class="o">=</span>your_github_client_secret <span class="se">\</span>
  <span class="nv">GITHUB_TEAM_ID</span><span class="o">=</span>team_id <span class="se">\</span>
  <span class="nv">SECRET_TOKEN</span><span class="o">=</span>your_secret_token
git push heroku master
heroku run bundle <span class="nb">exec</span> rake db:migrate
</pre></div>
</div>

<p>https::NAME.herokuapp.com にアクセスしたらGitHubにリダイレクトされるのでアクセスを許可。再びherokuapp.comにリダイレクトされて "WELCOME TO BOXEN" という画面が表示されればOK</p>

<p><a href="https://camo.qiitausercontent.com/11c3aeb53c9f409b5c1356c2bea1a50c8da96d18/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303331362f32303133303331363230343334342e706e673f31333633343334323435" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/11c3aeb53c9f409b5c1356c2bea1a50c8da96d18/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303331362f32303133303331363230343334342e706e673f31333633343334323435" alt="Boxen Web" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20130316/20130316204344.png?1363434245"></a></p>

<h1>
<span id="新しいmacをboxen-webでセットアップする手順" class="fragment"></span><a href="#%E6%96%B0%E3%81%97%E3%81%84mac%E3%82%92boxen-web%E3%81%A7%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>新しいMacをboxen-webでセットアップする手順</h1>

<h2>
<span id="boxenの管理者がすること" class="fragment"></span><a href="#boxen%E3%81%AE%E7%AE%A1%E7%90%86%E8%80%85%E3%81%8C%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>Boxenの管理者がすること</h2>

<p>その人の設定が既にBoxenにある場合、例えばMacを新しく買い換えた場合、は特にすることはない。</p>

<p>新しくメンバーが加わった場合は以下を実行する。</p>

<ol>
<li>GitHubアカウントを教えてもらう</li>
<li>OrganizationのTeamにその人を追加する</li>
<li>Boxenのリポジトリにmodules/people/manifests/ACCOUNT.ppを作る

<ul>
<li>その人のための設定を書く</li>
</ul>
</li>
<li>忘れずにGitHubにgit-pushする</li>
</ol>

<h2>
<span id="boxen-web利用者がすること" class="fragment"></span><a href="#boxen-web%E5%88%A9%E7%94%A8%E8%80%85%E3%81%8C%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>boxen-web利用者がすること</h2>

<ol>
<li>GitHubアカウントを持っていなければ作る</li>
<li>必要に応じて公開鍵を設定する（Boxenでアクセスするプライベートリポジトリに正しくアクセスできるようにするため）</li>
<li>Xcodeをインストールする（CLIでもGUIでもどちらでもOK）</li>
<li>
<a href="https://NAME.herokuapp.com" class="autolink" rel="nofollow noopener" target="_blank">https://NAME.herokuapp.com</a> にアクセスする</li>
<li>ワンライナーを端末にコピペ実行してしばらく待つ</li>
<li>.zshrc（や.bashrc）に下記を追記する</li>
</ol>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">.zshrc</span></div>
<div class="highlight"><pre><span></span><span class="o">[</span> -f /opt/boxen/env.sh <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> /opt/boxen/env.sh
<span class="o">[</span> -f /opt/boxen/nvm/nvm.sh <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> /opt/boxen/nvm/nvm.sh
</pre></div>
</div>

<h1>
<span id="合わせて読みたい" class="fragment"></span><a href="#%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>合わせて読みたい</h1>

<ul>
<li><a href="http://qiita.com/items/c6f20de0e4f4c352046c">Boxen使わなくても許されるのは2012年までだよね #Mac #Boxen #GitHub - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />45位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>57</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/7ce4b1ceb5d18c9cef08">Backbone.js入門 「View と Model の連携」</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-18 09:44:03</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="閲覧上の注意" class="fragment"></span><a href="#%E9%96%B2%E8%A6%A7%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>閲覧上の注意</h3>

<p>この記事で対象としているバージョン0.5.3は結構古いので注意してください。</p>

<p>その他の割りと新しい情報は <a href="http://www.adventar.org/calendars/15" rel="nofollow noopener" target="_blank">Backbone.js Advent Calendar 2012</a> などにあります。</p>

<p>（追記ここまで）</p>

<hr>

<p>今日のテーマは <code>View</code> と <code>Model</code> の連携です。</p>

<h2>
<span id="基本的なパターン" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a>基本的なパターン</h2>

<p>例えばブログサービスを作っているとします。<br>
おそらく <code>Blog</code> というモデルや、それを表示するページのビューを作ることになると思いますが、記事の全文を表示するビューや複数の記事をリスト形式で表示するビュー、編集ビューなどなど、一つのモデルに対して複数のビューが存在するのが一般的ではないでしょうか。<br>
このように <code>View</code> と <code>Model</code> は基本的に <em>多対一</em> の関係になっています。<br>
そのため、<code>Model</code> の属性が変更されたら、複数の <code>View</code> に変更を通知・反映しなければなりません（でなければユーザはシステムが不整合を起こしているように見えてしまいます）。<br>
ここで思い出していただきたいのが、<a href="http://qiita.com/yuku_t/items/16b799d0ec0a0ae3f78e" id="reference-ba820eea4d739eaef821">Backbone.js入門 「Events」</a> で取り上げた <strong>オブザーバ・パターン</strong> です。<br>
<a href="http://qiita.com/yuku_t/items/5acef8dd49f67fd7813c" id="reference-5f7fde28cdeba88cf1a0">Backbone.js入門 「Model」</a> で説明したように、<code>Model</code> の属性値が変更されると change イベントが発生するので、それをトリガーにして、<a href="http://qiita.com/yuku_t/items/8ee2ed1949cd7c337f06" id="reference-9cf837764708d3fcdfd1">Backbone.js入門 「View」</a> で説明した <code>render</code> メソッドを起動してやるようにするのが、オーソドックスなパターンです。<br>
例題を使って説明していきましょう。<br>
このブログサービスには <code>(・∀・)ｲｲﾈ!!</code> ボタンがあり、それをクリックするとイイね数が増えていくという機能があるとします。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// ブログモデル</span>
<span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
<span class="nx">blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">like</span><span class="o">:</span> <span class="mi">0</span><span class="p">});</span> <span class="c1">// (1)</span>

<span class="c1">// ブログ閲覧用のビュー</span>
<span class="kd">var</span> <span class="nx">ShowBlogView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"click .likeBtn"</span><span class="o">:</span> <span class="s2">"countUp"</span> <span class="c1">// (2)</span>
    <span class="p">},</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">"render"</span><span class="p">);</span>  <span class="c1">// (3)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"change"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span> <span class="c1">// (4)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span> <span class="c1">// (5)</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">"#ViewA-template"</span><span class="p">).</span><span class="nx">html</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">));</span> <span class="c1">// (6)</span>
    <span class="p">},</span>
    <span class="nx">countUp</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">like</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'like'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span> <span class="c1">// (7)</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">showBlogView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShowBlogView</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"#blog"</span><span class="p">),</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">blog</span><span class="p">});</span> <span class="c1">// (8)</span>
</pre></div></div>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/template"</span> <span class="na">id</span><span class="o">=</span><span class="s">"ViewA-template"</span><span class="p">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"likeBtn"</span><span class="o">&gt;</span><span class="p">(</span><span class="err">・∀・</span><span class="p">)</span><span class="nx">ｲｲﾈ</span><span class="o">!!&lt;</span><span class="err">/span&gt;</span>
        <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"likeCnt"</span><span class="o">&gt;&lt;%=</span> <span class="nx">like</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"text"</span><span class="o">&gt;&lt;%=</span> <span class="nx">text</span> <span class="o">%&gt;&lt;</span><span class="err">/div&gt;</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"blog"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>順番に説明していきましょう。</p>

<p>まず <strong>(1)</strong> で <code>Blog</code> モデルのインスタンスを生成し、<code>text</code> を foo  <code>like</code> を 0 に初期化しています。<br>
そして <strong>(8)</strong> で <code>ShowBlogView</code> ビューのインスタンスを生成し、<code>el</code> を設定し、<code>model</code> に先ほど作った <code>Blog</code> インスタンスを渡しています。このように <code>model</code> という名前でオブジェクトを渡すと、<code>View</code> インスタンスに <code>model</code> という名前で代入されます。<strong>(4)</strong> では、これを利用して、ブログの change イベントが発生したら <code>render</code> を起動するようにしています。Backbone.js 入門「Events」の最後で書いたように、コールバック関数として渡される <code>render</code> のコンテキストを束縛するために、<strong>(3)</strong> で <code>_.bindAll</code> を使っています。そして、初期化の最後に <strong>(5)</strong> で自ら <code>render</code> を実行し、 <strong>(6)</strong> で DOM 操作を行なっています。</p>

<p><strong>(6)</strong> の結果、 <code>&lt;div id='blog'&gt;&lt;/div&gt;</code> は次のようになっているはずです。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"blog"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"likeBtn"</span><span class="p">&gt;</span>(・∀・)ｲｲﾈ!!<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"likeCnt"</span><span class="p">&gt;</span>0<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"text"</span><span class="p">&gt;</span>foo<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p>ここでユーザが <code>(・∀・)ｲｲﾈ!!</code> をクリックしました。<br>
すると <strong>(2)</strong> で書いてあるように、<code>countUp</code> メソッドが呼ばれ、<strong>(7)</strong> でブログの <code>like</code> の値が1上昇します。この時 change:like イベントが発生し、<strong>(4)</strong> の結果、改めて <code>render</code> が呼ばれますが、今度はモデルの値が <code>{text: 'foo', like: 1}</code> になっているので、<code>&lt;div id='blog'&gt;&lt;/div&gt;</code> の中身は結果として次のように変更されます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"blog"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"likeBtn"</span><span class="p">&gt;</span>(・∀・)ｲｲﾈ!!<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"likeCnt"</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"text"</span><span class="p">&gt;</span>foo<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></div>

<p><code>(・∀・)ｲｲﾈ!!</code> をクリックしたら数字が1つ大きくなりました！<br>
現状では、<code>&lt;div id="blog"&gt;&lt;/div&gt;</code> の中身を全て書きなおしていて無駄が多い状態ですね。これが気になる場合は、 <strong>(4)</strong> の他に <code>this.model.bind('change:like', this.renderLikeCnt)</code> を追加し <code>renderLikeCnt</code> メソッドの中で必要な箇所だけを更新するようにする、などの方法が考えられると思います。</p>

<p>ここから先でブログのビューが増え、他のビューによってモデルが変更されても、change イベントが発生する度に <code>render</code> が呼ばれて、最新のモデルの状態を使って DOM を構築し直すことができます。</p>

<p>オブザーバ・パターンを用いた Backbone.js プログラミングの勘所が少しは分かっていただけたでしょうか。</p>

<h2>
<span id="次回は" class="fragment"></span><a href="#%E6%AC%A1%E5%9B%9E%E3%81%AF"><i class="fa fa-link"></i></a>次回は</h2>

<p>次回は <code>Collection</code> です。<br>
それではまた明日。</p>

<hr>

<ol>
<li><a href="http://qiita.com/yuku_t/items/16b799d0ec0a0ae3f78e">Backbone.js入門 Events</a></li>
<li><a href="http://qiita.com/yuku_t/items/03f49c64d6c4bacdbb26" id="reference-1f77d74c0d5fc7915b61">Backbone.js入門 MVC</a></li>
<li><a href="http://qiita.com/yuku_t/items/8ee2ed1949cd7c337f06">Backbone.js入門 View</a></li>
<li><a href="http://qiita.com/yuku_t/items/5acef8dd49f67fd7813c">Backbone.js入門 Model</a></li>
<li>Backbone.js入門 ViewとModelの連携</li>
<li><a href="http://qiita.com/yuku_t/items/c19d2fff0dc23e4015ff" id="reference-7f745d2800d72e336177">Backbone.js入門 Collection</a></li>
<li><a href="http://qiita.com/yuku_t/items/7095a32cc5e438172844" id="reference-9e2a511187c1ef48b69d">Backbone.js入門 ViewとModelとCollectionの連携</a></li>
<li><a href="http://qiita.com/yuku_t/items/13f3d1f71d31f3e78123" id="reference-1e0f88c66031ce849666">Backbone.js入門 RouterとHistory</a></li>
</ol>

<ul>
<li><a href="https://groups.google.com/forum/?fromgroups#!forum/backbonejs-ja" rel="nofollow noopener" target="_blank">BackboneJS 日本語メーリングリスト</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />46位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>52</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/f2530dfe7ba71e907392">CoffeeScriptとJavaScriptやPythonやRubyの文法の比較</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-01-20 23:21:26</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Python]</b> <b>[JavaScript]</b> <b>[CoffeeScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>PythonやRubyだとあんな感じで書くけど、CoffeeScriptだとどうかなーというのを思い浮かぶがままに書き下していく。</p>

<ul>
<li>JavaScriptも追加</li>
</ul>

<h1>
<span id="コメント" class="fragment"></span><a href="#%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>コメント</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="c1"># comment</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># comment</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// comment</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="c1"># comment</span>
</pre></div></div>

<h1>
<span id="複数行にまたがるコメント" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E8%A1%8C%E3%81%AB%E3%81%BE%E3%81%9F%E3%81%8C%E3%82%8B%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>複数行にまたがるコメント</h1>

<p>Pythonには複数行コメントがないので文字列で代用する</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="sd">'''</span>
<span class="sd">comment</span>
<span class="sd">'''</span>

<span class="sd">"""</span>
<span class="sd">comment</span>
<span class="sd">"""</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="cm">=begin</span>
<span class="cm">comment</span>
<span class="cm">=end</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">comment</span>
<span class="cm">*/</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="cm">###</span>
<span class="cm">comment</span>
<span class="cm">###</span>
</pre></div></div>

<h1>
<span id="文字の埋め込み" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E3%81%AE%E5%9F%8B%E3%82%81%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>文字の埋め込み</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">100</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s2">"{0}px"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
<span class="s2">"100px"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s2">"</span><span class="si">%d</span><span class="s2">px"</span> <span class="o">%</span> <span class="n">width</span>
<span class="s2">"100px"</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">100</span>
<span class="nb">p</span> <span class="s2">"</span><span class="si">#{</span><span class="n">width</span><span class="si">}</span><span class="s2">px"</span>
<span class="c1"># =&gt; 100px</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">width</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">""</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s2">"px"</span><span class="p">);</span>
</pre></div></div>

<p>Rubyに似てる</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">width = </span><span class="mi">100</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"</span><span class="si">#{</span><span class="nx">width</span><span class="si">}</span><span class="s">px"</span>
<span class="c1"># 100px</span>
</pre></div></div>

<h1>
<span id="複数行にまたがる文字列" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E8%A1%8C%E3%81%AB%E3%81%BE%E3%81%9F%E3%81%8C%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>複数行にまたがる文字列</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="s1">'''a</span>
<span class="s1">... b'''</span>
<span class="s2">"a</span><span class="se">\n</span><span class="s2">b"</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="s1">'a</span>
<span class="s1">b'</span>
<span class="c1"># =&gt; "a\nb"</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">a</span> <span class="o">=</span> <span class="s1">'a\</span>
<span class="s1">      b'</span><span class="p">;</span>
<span class="c1">// "a\n     b"</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">a = </span><span class="s">'a</span>
<span class="s">b'</span>
<span class="c1"># "ab"</span>
</pre></div></div>

<h1>
<span id="連想配列" class="fragment"></span><a href="#%E9%80%A3%E6%83%B3%E9%85%8D%E5%88%97"><i class="fa fa-link"></i></a>連想配列</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:a</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">d</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">d = a: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">b: </span><span class="mi">2</span>
<span class="nv">d = </span><span class="p">{</span><span class="nv">a: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">b: </span><span class="mi">2</span><span class="p">}</span> <span class="c1"># もOK</span>
<span class="c1"># 複数行にまたがる場合は`,`を省略可</span>
<span class="nv">d =</span>
  <span class="nv">a: </span><span class="mi">0</span>  <span class="c1"># 途中にコメントも入れられる</span>
  <span class="nv">b: </span><span class="mi">2</span>
<span class="nv">d = </span><span class="p">{</span>
  <span class="nv">a: </span><span class="mi">0</span>
  <span class="nv">b: </span><span class="mi">2</span>
<span class="p">}</span>
</pre></div></div>

<h1>
<span id="配列" class="fragment"></span><a href="#%E9%85%8D%E5%88%97"><i class="fa fa-link"></i></a>配列</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">l</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="o">]</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">l = </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="c1">#複数行にまたがる場合は`,`が省略可</span>
<span class="nv">l = </span><span class="p">[</span>
  <span class="mi">1</span>
  <span class="mi">3</span>
  <span class="mi">5</span>
<span class="p">]</span>
</pre></div></div>

<h1>
<span id="連続した配列" class="fragment"></span><a href="#%E9%80%A3%E7%B6%9A%E3%81%97%E3%81%9F%E9%85%8D%E5%88%97"><i class="fa fa-link"></i></a>連続した配列</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="mi">5</span><span class="p">]</span>
<span class="c1"># [0, 1, 2, 3, 4]</span>
<span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">4</span><span class="p">]</span>
<span class="c1"># [0, 1, 2, 3, 4]</span>

<span class="p">[</span><span class="mi">4</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># [4, 3, 2, 1, 0]</span>
<span class="p">[</span><span class="mi">4</span><span class="p">..</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># [4, 3, 2, 1, 0]</span>

<span class="p">[</span><span class="mi">2</span><span class="p">...</span><span class="mi">5</span><span class="p">]</span>
<span class="c1"># [2, 3, 4]</span>
<span class="p">[</span><span class="mi">2</span><span class="p">..</span><span class="mi">4</span><span class="p">]</span>
<span class="c1"># [2, 3, 4]</span>
</pre></div></div>

<h1>
<span id="配列へのアクセス" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9"><i class="fa fa-link"></i></a>配列へのアクセス</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[::</span><span class="mi">3</span><span class="p">]</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">9</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">l = </span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="mi">10</span><span class="p">]</span>
<span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># 1</span>
<span class="nx">l</span><span class="p">[</span><span class="mi">2</span><span class="p">...</span><span class="mi">4</span><span class="p">]</span>
<span class="c1"># [2, 3]</span>
<span class="nx">l</span><span class="p">[</span><span class="mi">2</span><span class="p">...]</span>
<span class="c1"># [2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="nx">l</span><span class="p">[...</span><span class="mi">4</span><span class="p">]</span>
<span class="c1"># [0, 1, 2, 3]</span>
<span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">l</span> <span class="k">by</span> <span class="mi">3</span>
<span class="c1"># [0, 3, 6, 9]</span>
<span class="nx">l</span><span class="p">[</span><span class="nx">l</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="c1"># 9</span>
<span class="nx">l</span><span class="p">[</span><span class="mi">3</span><span class="p">...</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="c1"># [0, 1, 2, 6, 8, 9, 6, 7, 8, 9]</span>
</pre></div></div>

<h1>
<span id="リスト内包表記" class="fragment"></span><a href="#%E3%83%AA%E3%82%B9%E3%83%88%E5%86%85%E5%8C%85%E8%A1%A8%E8%A8%98"><i class="fa fa-link"></i></a>リスト内包表記</h1>

<h2>
<span id="単純な場合" class="fragment"></span><a href="#%E5%8D%98%E7%B4%94%E3%81%AA%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>単純な場合</h2>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
<span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>
<span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
<span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="p">[(</span><span class="s1">'a'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s1">'b'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">'c'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">l = </span><span class="p">[</span><span class="s">'a'</span><span class="p">,</span> <span class="s">'b'</span><span class="p">,</span> <span class="s">'c'</span><span class="p">]</span>
<span class="nx">v</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">l</span>
<span class="c1"># ['a', 'b', 'c']</span>
<span class="p">[</span><span class="nx">v</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">l</span><span class="p">]</span>
<span class="c1"># [ ['a', 'b', 'c'] ]</span>
<span class="p">[</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">l</span>
<span class="c1"># [[0, 'a'], [1, 'b'], [2, 'c']]</span>
<span class="nv">d = a: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">b: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">c: </span><span class="mi">2</span>
<span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">d</span>
<span class="c1"># ['a', 'b', 'c']</span>
<span class="p">[</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">d</span>
<span class="c1"># [['a', 0], ['b', 1], ['c', 2]]</span>
</pre></div></div>

<h2>
<span id="リスト内包表記を使ったフィルタリング" class="fragment"></span><a href="#%E3%83%AA%E3%82%B9%E3%83%88%E5%86%85%E5%8C%85%E8%A1%A8%E8%A8%98%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>リスト内包表記を使ったフィルタリング</h2>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="mi">10</span><span class="p">]</span> <span class="k">when</span> <span class="nx">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">is</span> <span class="mi">0</span>
<span class="c1"># [0, 3, 6, 9]</span>
</pre></div></div>

<h2>
<span id="coffeescriptのリスト内包表記はもっといろいろできる" class="fragment"></span><a href="#coffeescript%E3%81%AE%E3%83%AA%E3%82%B9%E3%83%88%E5%86%85%E5%8C%85%E8%A1%A8%E8%A8%98%E3%81%AF%E3%82%82%E3%81%A3%E3%81%A8%E3%81%84%E3%82%8D%E3%81%84%E3%82%8D%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>CoffeeScriptのリスト内包表記はもっといろいろできる</h2>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">print</span> <span class="n">i</span>
<span class="mi">0</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mi">3</span>
<span class="mi">4</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="mi">5</span><span class="p">]</span>
<span class="c1"># 0</span>
<span class="c1"># 1</span>
<span class="c1"># 2</span>
<span class="c1"># 3</span>
<span class="c1"># 4</span>
</pre></div></div>

<h1>
<span id="関数" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>関数</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">[]</span>
<span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">func = </span><span class="nf">(arg, args...) -&gt;</span>
</pre></div></div>

<h1>
<span id="関数呼び出し" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97"><i class="fa fa-link"></i></a>関数呼び出し</h1>

<p>Pythonは関数呼び出しに()が必須</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">():</span> <span class="k">return</span> <span class="s1">'foo'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">__main</span><span class="o">.</span><span class="n">foo</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="s1">'foo'</span>
</pre></div></div>

<p>Rubyは不要</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span>
  <span class="s1">'foo'</span>
<span class="k">end</span>
<span class="nb">p</span> <span class="n">foo</span>
<span class="c1"># =&gt; foo</span>
<span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">x</span>
<span class="k">end</span>
<span class="nb">p</span> <span class="n">bar</span> <span class="s1">'bar'</span>
<span class="c1"># =&gt; bar</span>
</pre></div></div>

<p>JavaScriptはインスタンス生成時は不要。普通の呼び出し時は必須</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="s1">'foo'</span><span class="p">};</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">foo</span><span class="p">);</span>
<span class="c1">// 'function'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">foo</span><span class="p">());</span>
<span class="c1">// 'foo'</span>
<span class="nx">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">foo</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">construoctor</span> <span class="o">===</span> <span class="nx">foo</span><span class="p">);</span>
<span class="c1">// true</span>
</pre></div></div>

<p>CoffeeScriptは引数が渡されない場合は()が必要、引数ありの場合は不要</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">foo = </span><span class="nf">-&gt;</span> <span class="s">'foo'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="k">typeof</span> <span class="nx">foo</span>
<span class="c1"># 'function'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">foo</span><span class="p">()</span>
<span class="c1"># foo</span>
<span class="nv">bar = </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">foo</span> <span class="s">'bar'</span>
<span class="c1"># bar</span>
</pre></div></div>

<h1>
<span id="関数の戻り値" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E3%81%AE%E6%88%BB%E3%82%8A%E5%80%A4"><i class="fa fa-link"></i></a>関数の戻り値</h1>

<p>PythonとJavaScriptは<code>return</code>必須。無ければPythonなら<code>None</code>が、JavaScriptなら<code>undefined</code>が返る。</p>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">bar</span><span class="p">():</span> <span class="s1">'bar'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bar</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="bp">True</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">bar</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="s1">'bar'</span> <span class="p">};</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bar</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">);</span>
<span class="c1">// true</span>
</pre></div></div>

<p>RubyとCoffeeScriptは最後の文が<code>return</code>される。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bar</span>
  <span class="s1">'bar'</span>
<span class="k">end</span>
<span class="n">bar</span>
<span class="c1"># =&gt; 'bar'</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">bar = </span><span class="nf">-&gt;</span> <span class="s">'bar'</span>
<span class="nx">bar</span><span class="p">()</span>
<span class="c1"># 'bar'</span>
</pre></div></div>

<h1>
<span id="クラス" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>クラス</h1>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Klass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="o">...</span>         <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">Klass</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span>
<span class="s2">"hoge"</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Klass</span>
  <span class="kp">attr</span> <span class="s2">"name"</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">k</span> <span class="o">=</span> <span class="no">Klass</span><span class="o">.</span><span class="n">new</span> <span class="s1">'hoge'</span>
<span class="nb">p</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span>
<span class="c1"># =&gt; hoge</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">Klass</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Klass</span><span class="p">(</span><span class="s1">'hoge'</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="c1">// hoge</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nx">Klass</span>
  <span class="nv">constructor: </span><span class="nf">(name) -&gt;</span>
    <span class="vi">@name = </span><span class="nx">name</span>
<span class="nv">k = </span><span class="k">new</span> <span class="nx">Klass</span> <span class="s">'hoge'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">k</span><span class="p">.</span><span class="nx">name</span>
<span class="c1"># hoge</span>
</pre></div></div>

<h2>
<span id="継承" class="fragment"></span><a href="#%E7%B6%99%E6%89%BF"><i class="fa fa-link"></i></a>継承</h2>

<div class="code-frame" data-lang="py"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">print</span> <span class="s1">'parent'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="o">...</span>         <span class="nb">super</span><span class="p">(</span><span class="n">Child</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
<span class="o">...</span>         <span class="k">print</span> <span class="s1">'child'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Child</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
<span class="n">parent</span>
<span class="n">child</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parent</span>
  <span class="k">def</span> <span class="nf">foo</span>
    <span class="nb">p</span> <span class="s1">'parent'</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">Child</span> <span class="o">&lt;</span> <span class="no">Parent</span>
  <span class="k">def</span> <span class="nf">foo</span>
    <span class="k">super</span>
    <span class="nb">p</span> <span class="s1">'child'</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">c</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">new</span>
<span class="n">c</span><span class="o">.</span><span class="n">foo</span>
<span class="c1"># =&gt; parent</span>
<span class="c1"># =&gt; child</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">Parent</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'parent'</span><span class="p">);</span> <span class="p">};</span>
<span class="kd">function</span> <span class="nx">Child</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">Child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Parent</span><span class="p">;</span>
<span class="nx">Child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'child'</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Child</span><span class="p">;</span>
<span class="nx">c</span><span class="p">.</span><span class="nx">foo</span><span class="p">();</span>
<span class="c1">// parent</span>
<span class="c1">// child</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nx">Parent</span>
  <span class="nv">foo: </span><span class="nf">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">'parent'</span>
<span class="k">class</span> <span class="nx">Child</span> <span class="nx">extend</span> 
  <span class="nv">foo: </span><span class="nf">-&gt;</span>
    <span class="k">super</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">'child'</span>
<span class="nv">c = </span><span class="k">new</span> <span class="nx">Child</span>
<span class="nx">c</span><span class="p">.</span><span class="nx">foo</span><span class="p">()</span>
<span class="c1"># parent</span>
<span class="c1"># child</span>
</pre></div></div>

<h1>
<span id="mixin" class="fragment"></span><a href="#mixin"><i class="fa fa-link"></i></a>Mixin</h1>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">Fooable</span>
  <span class="k">def</span> <span class="nf">foo</span>
    <span class="nb">p</span> <span class="s1">'foo'</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">Klass</span>
  <span class="kp">include</span> <span class="no">Fooable</span>
<span class="k">end</span>
<span class="n">k</span> <span class="o">=</span> <span class="no">Klass</span><span class="o">.</span><span class="n">new</span>
<span class="n">k</span><span class="o">.</span><span class="n">foo</span>
<span class="c1"># =&gt; 'foo</span>
</pre></div></div>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="c1"># https://gist.github.com/993415</span>
<span class="k">class</span> <span class="nx">Mixin</span>
  <span class="nv">augment: </span><span class="nf">(t) -&gt;</span>
    <span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">m</span> <span class="k">unless</span> <span class="nx">n</span> <span class="o">==</span> <span class="s">'augment'</span> <span class="o">or</span> <span class="o">!</span><span class="k">this</span><span class="p">[</span><span class="nx">n</span><span class="p">].</span><span class="nx">prototype</span><span class="o">?</span><span class="p">)</span> <span class="k">for</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">m</span> <span class="k">of</span> <span class="k">this</span>
<span class="k">class</span> <span class="nx">Fooable</span> <span class="k">extends</span> <span class="nx">Mixin</span>
  <span class="nv">foo: </span><span class="nf">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">'foo'</span>
<span class="k">class</span> <span class="nx">Klass</span>
  <span class="nv">constructor: </span><span class="nf">-&gt;</span>
    <span class="nx">Fooable</span><span class="o">::</span><span class="nx">augment</span> <span class="nx">@</span>
<span class="nv">k = </span><span class="k">new</span> <span class="nx">Klass</span>
<span class="nx">k</span><span class="p">.</span><span class="nx">foo</span><span class="p">()</span>
<span class="c1"># foo</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />47位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>43</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/737f2fe407f5d8d62648">ビューが画面に現れたら処理を実行する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-02 02:10:06</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="backbonejs-advent-calendar-2日目" class="fragment"></span><a href="#backbonejs-advent-calendar-2%E6%97%A5%E7%9B%AE"><i class="fa fa-link"></i></a>Backbone.js Advent Calendar 2日目!</h1>

<p>勢い良く走り始めたBackbone.js Advent Calendarですが、初日に引き続き2日目もビューに関連する話題です。</p>

<h2>
<span id="ビューの遅延評価をしたい" class="fragment"></span><a href="#%E3%83%93%E3%83%A5%E3%83%BC%E3%81%AE%E9%81%85%E5%BB%B6%E8%A9%95%E4%BE%A1%E3%82%92%E3%81%97%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>ビューの遅延評価をしたい</h2>

<p>Backbone.jsに限らずサービスを高速化するために、遅延評価を行いたい場面は沢山あります。たとえば画像掲示板のシステムを作っていたら、いきなり画像全てを読み込もうとするとサーバにも負荷がかかりますし、何よりユーザが表示しない画像まで読み込むのは無駄です。他にもTwitterのようなタイムラインに対して、一番下までユーザがスクロールしたら自動的に続きを読み込むような処理を行いたい場合もあるでしょう。<br>
という訳でユーザのスクロールをトリガーにしてイベントを発火させられる<code>Backbone.LazyView</code>というのを作ってみました。</p>

<ul>
<li><a href="https://github.com/taka84u9/backbone-lazyview" title="taka84u9/backbone-lazyview - GitHub" rel="nofollow noopener" target="_blank">taak84u9/backbone-lazyview - GitHub</a></li>
</ul>

<h3>
<span id="簡単な使い方" class="fragment"></span><a href="#%E7%B0%A1%E5%8D%98%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>簡単な使い方</h3>

<p><code>lazyview.js</code>を読み込むと<code>Backbone.LazyView</code>というオブジェクトがBackboneに追加されます。このオブジェクトは<code>Backbone.View</code>と全く同じインタフェースを持ちます。唯一の違いは<code>el</code>プロパティが指すエレメントがブラウザ上に現れたら<code>appear</code>というイベントが発行されることです。<br>
使い方は通常の<code>Backbone.View</code>と全く同じです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">FooLazyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LazyView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"appear"</span><span class="o">:</span> <span class="s2">"appear"</span>
    <span class="p">},</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">"appear"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">appear</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="cm">/* ここに処理を書く */</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">"hoge"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p>あとは<code>FooLazyView</code>コンストラクタを使ってオブジェクトを生成するだけです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FooLazyView</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"#foo"</span><span class="p">)});</span>
</pre></div></div>

<p>これで<code>$("#foo")</code>要素がブラウザに表示された瞬間に<code>view.appear</code>が実行されて<strong>hoge</strong>とアラートされます。代わりにimgタグのsrc属性を書き換えたり、Ajaxによる読み込みを行う処理を記述すれば遅延評価の完成です。</p>

<h2>
<span id="viewのクラスプロパティを使う" class="fragment"></span><a href="#view%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>Viewのクラスプロパティを使う</h2>

<p>上記だけだと寂しいので、ちょっとした小ネタを紹介します。<br>
例えばBackbone.Viewのrenderメソッド内でunderscore.jsのtemplate機能を使うというのはよくあるパターンだと思いますが、レンダリングの度にjQueryを使ってテンプレートをわざわざ取ってくるのもなんか嫌な感じですよね。こういう場合はクラスプロパティにテンプレートを文字列として保存したくなります。例えばこんな感じに書くかも知れません。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">SomeView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">"render"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">SomeView</span><span class="p">.</span><span class="nx">template</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="nx">SomeView</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"#template-of-some-view"</span><span class="p">).</span><span class="nx">html</span><span class="p">();</span>
</pre></div></div>

<p>もちろんこれでも問題ありませんが、下記のように書くこともできます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">SomeView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">"render"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">SomeView</span><span class="p">.</span><span class="nx">template</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>  <span class="c1">// クラスプロパティになる</span>
    <span class="nx">template</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"#template-of-some-view"</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>
<span class="p">});</span>
</pre></div></div>

<p>テンプレートを動的に選択したり、JSのロード時にDOM上にテンプレートが存在しない場合などは、underscore.jsのmemoizeなどを使ってもいいかも。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">SomeView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">"render"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">SomeView</span><span class="p">.</span><span class="nx">getTemplate</span><span class="p">(</span><span class="s2">"#template-of-some-view"</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">getTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">q</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">q</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">})</span>
<span class="p">});</span>
</pre></div></div>

<p>このようにextendメソッドの第二引数に渡されたオブジェクトがクラスプロパティになります。Viewに限らずModelやController、上で紹介したLazyViewでも同様です。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />48位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>42</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/8109974843f818f1e5a7">jQueryを使ってるページでJSの読み込みを手軽にbodyの最後に移動させる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-06 14:20:29</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML]</b> <b>[JavaScript]</b> <b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>JavaScriptの読み込みはレンダリングなどの処理をストップさせてしまうので、body要素の最後に設置すべきです。Google PageSpeed Insightsでもこの点をチェックされます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="c">&lt;!-- headの中ではなく --&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  コンテンツ

  <span class="c">&lt;!-- bodyの一番最後で読み込むべき --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">'/path/to/main.js'</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div></div>

<p>しかし既にhead要素の中でJavaScriptを読み込んでいる状態で、しかもbodyの中にscriptがインラインで記述されていて、その内容が読み込んでいるスクリプトに依存する場合、一旦その依存関係を解消してからでないと移動させられません。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="c">&lt;!-- すでにheadの中で読み込んでいる --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">'/path/to/main.js'</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  main.jsに依存関係のあるscriptを含むコンテンツ

  <span class="c">&lt;!-- このままでは移動させられない --&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div></div>

<p>ページ数が多いとその全てをいちいち直して回るのは非常に大変ですが、jQueryを使っている場合は次のようなコードを読み込むことで簡単に移行することができます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="nx">App</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1">// Appという名前は適当に変える</span>
      <span class="nx">_q</span><span class="o">:</span> <span class="p">[],</span>  <span class="c1">// queue</span>
      <span class="nx">ready</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">func</span> <span class="o">==</span> <span class="s1">'function'</span><span class="p">)</span> <span class="nx">App</span><span class="p">.</span><span class="nx">_q</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">App</span><span class="p">;</span>  <span class="c1">// $(document).ready() をサポートする</span>
      <span class="p">},</span>
      <span class="nx">unqueue</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">_q</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">App</span><span class="p">.</span><span class="nx">_q</span><span class="p">[</span><span class="nx">i</span><span class="p">]();</span>
        <span class="nx">App</span><span class="p">.</span><span class="nx">_q</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">jQuery</span> <span class="o">=</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">ready</span><span class="p">;</span>
  <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  jQueryの遅延実行を含むコンテンツ

  <span class="c">&lt;!-- スクリプトを読み込む --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"/path/to/main.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="c1">// main.jsにjqueryが含まれているので、ここではjQueryにアクセスできる</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">App</span><span class="p">.</span><span class="nx">unqueue</span><span class="p">();</span> <span class="p">});</span>
  <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div></div>

<p>そしてコンテンツ中の全てのscriptを <code>$(function({ ... })</code> で囲みます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// もとのコードを囲む</span>
<span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>これでほぼ何も考えることなくscriptの位置をbodyの最後に移動させることができます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />49位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>41</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/0307f1f86695b91a4034">default_scopeを持つModelへのbelongs_toでunscopedにするconcern</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-16 14:53:56</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>default_scope</code> を持つModelへの <code>belongs_to</code> では勝手に <code>default_scope</code> が使われるので自分で頑張ってオーバーライドする必要があります。</p>

<p>例えば公開・非公開設定を持つ <code>Article</code> とそれに紐づく <code>Comment</code> があるとします。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/models/article.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="kp">private</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>  <span class="c1"># private な記事を排除する</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/models/comment.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:article</span>
<span class="k">end</span>
</pre></div>
</div>

<p>このとき <code>Article</code> の <code>default_scope</code> が思わぬ形で影響する場合があります。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># 公開ArticleへのCommentからは問題なく辿れる</span>
<span class="n">public_article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="kp">private</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
<span class="n">public_comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">article</span><span class="p">:</span> <span class="n">public_article</span><span class="p">)</span>

<span class="no">Comment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">public_comment</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">article</span>  <span class="c1">#=&gt; Article</span>

<span class="c1"># 非公開ArticleへのCommentからはたどることができない</span>
<span class="n">private_article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="kp">private</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">private_comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">article</span><span class="p">:</span> <span class="n">private_article</span><span class="p">)</span>

<span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">private_comment</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">article_id</span>  <span class="c1">#=&gt; 2</span>
<span class="n">comment</span><span class="o">.</span><span class="n">article</span>  <span class="c1">#=&gt; nil</span>
<span class="n">comment</span><span class="o">.</span><span class="n">article</span><span class="o">.</span><span class="n">to_sql</span>  <span class="c1">#=&gt; ... WHERE items.private = 0 AND items.id = 2</span>
</pre></div></div>

<p>これを回避するために <code>Comment#article</code> を上書きしたりします</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/models/comment.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:article</span>

  <span class="k">def</span> <span class="nf">article</span>
    <span class="no">Article</span><span class="o">.</span><span class="n">unscoped</span> <span class="p">{</span> <span class="k">super</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>で、複数のModelが <code>Article</code> に紐づくとこれを毎回書くのはカッコ悪いし、 <code>super</code> を使うのもなんか嫌だったので<a href="http://techracho.bpsinc.jp/baba/2011_11_28/4729" rel="nofollow noopener" target="_blank">こちらの記事</a>を参考に concern にしてみました。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/models/concerns/unscoped_associations.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">UnscopedAssociations</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="k">module</span> <span class="nn">ClassMethods</span>
    <span class="k">def</span> <span class="nf">belongs_to_with_unscoped</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="n">belongs_to_without_unscoped</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">k</span> <span class="o">==</span> <span class="ss">:unscoped</span> <span class="p">})</span>
      <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:unscoped</span><span class="o">]</span>
        <span class="n">define_method</span> <span class="s2">"</span><span class="si">#{</span><span class="n">model</span><span class="si">}</span><span class="s2">_with_unscoped"</span> <span class="k">do</span>
          <span class="n">model</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">camelize</span><span class="o">.</span><span class="n">constantize</span><span class="o">.</span><span class="n">unscoped</span> <span class="k">do</span>
            <span class="nb">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">model</span><span class="si">}</span><span class="s2">_without_unscoped"</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
        <span class="n">alias_method_chain</span> <span class="n">model</span><span class="p">,</span> <span class="ss">:unscoped</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
      <span class="n">alias_method_chain</span> <span class="ss">:belongs_to</span><span class="p">,</span> <span class="ss">:unscoped</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>こんな感じで使います</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">app/models/comment.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">UnscopedAssociations</span>
  <span class="n">belongs_to</span> <span class="ss">:article</span><span class="p">,</span> <span class="ss">unscoped</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>

<p>便利</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">private_comment</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">article</span>  <span class="c1">#=&gt; Article</span>
<span class="n">comment</span><span class="o">.</span><span class="n">article_without_unscoped</span>  <span class="c1">#=&gt; nil</span>
</pre></div></div>

<h2>
<span id="関連する記事" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3%E3%81%99%E3%82%8B%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>関連する記事</h2>

<ul>
<li><a href="http://stackoverflow.com/a/4893758" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/a/4893758</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />50位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>39</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/4ffaa516914e7426419a">tmuxでSSH時に変更したwindow-nameを自動でもとに戻す</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-08 10:01:58</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[SSH]</b> <b>[tmux]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><ul>
<li><a href="http://qiita.com/catatsuy/items/631d1d5d0b357082ba74" id="reference-9cf496754fae83173db7">tmuxで色んなホストにsshする時に便利な.ssh/config - Qiita</a></li>
</ul>

<p>上記の記事の設定が便利ですが、コメントで <a href="/kawaz" class="user-mention js-hovercard" title="kawaz" data-hovercard-target-type="user" data-hovercard-target-name="kawaz">@kawaz</a> さんが指摘しているように、SSHを終了して戻ってきたときにwindow-nameが戻らないのが不便だったのでこんな感じの関数を登録しました。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">.zshrc</span></div>
<div class="highlight"><pre><span></span><span class="k">function</span> ssh<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">window_name</span><span class="o">=</span><span class="k">$(</span>tmux display -p <span class="s1">'#{window_name}'</span><span class="k">)</span>
    <span class="nb">command</span> ssh <span class="nv">$@</span>
    tmux rename-window <span class="nv">$window_name</span>
<span class="o">}</span>
</pre></div>
</div>

<p>あとは通常通りの <code>ssh</code> コマンドを使えば自動でtmuxのwindow-nameが切り替わります。tmuxの外にいても特にエラーなどは発生しません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />51位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>39</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/4a384669979f01625b7c">jQuery.lazyloadを使ってAutopagerを実装する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-11 16:18:51</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://github.com/tuupola/jquery_lazyload" rel="nofollow noopener" target="_blank">tuupola/jquery_lazyload</a> は本来 img タグを遅延読み込みするための jQuery プラグインだがその実体は jQuery オブジェクトが画面に出現したら <code>appear</code> イベントを発行するものなので、<code>appear</code> イベントにコールバックをバインドすれば「続きを読み込む」機能を簡単に実装できる。</p>

<p>例えば <code>/timeline</code> に timestamp でタイムスタンプを指定すればそこを起点として何件かとって来てくれるAPIが実装されており、タイムラインの各div要素の <code>data-timestamp</code> 属性がそのポストのタイムスタンプを表しているとすれば、これらを使って次のようにAutopagerを実装できる。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">loading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">'#more'</span><span class="p">)</span>  <span class="c1">// "もっと見る" ボタン</span>
  <span class="p">.</span><span class="nx">lazyload</span><span class="p">({</span> <span class="nx">threshold</span><span class="o">:</span> <span class="mi">200</span> <span class="p">})</span>  <span class="c1">// 200px 余裕をもって appear イベントを発行</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'appear'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  <span class="c1">// 非同期通信を抑制する</span>
    <span class="nx">loading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">'/timeline'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">timestamp</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'.timeline-item:last-child'</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">'timestamp'</span><span class="p">)</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// data を挿入する</span>
        <span class="nx">loading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ユーザにエラー通知</span>
        <span class="c1">// loading は true のままにすれば以降非同期通信は発生しない</span>
      <span class="p">});</span>
  <span class="p">})</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />52位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>37</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/bea95b1bc6e6ca8a495b">tmux内のvimでclipboardにunnamedが含まれるとヤンク・コピーができない</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-06-22 16:00:02</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[Mac]</b> <b>[tmux]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Macのtmux内で <code>clipboard+=unnamed</code> な Vim でヤンク・コピーをすると <code>E353: Nothing in register *</code> というエラーが出る。これはMacでtmuxを使うとpbcopy, pbpasteが使えない問題の余波によるものらしい。<br>
これを修正するには<a href="https://github.com/ChrisJohnsen/tmux-MacOSX-pasteboard" rel="nofollow noopener" target="_blank">ChrisJohnsen/tmux-MacOSX-pasteboard</a>を使う。homebrewでインストール可能。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>brew install reattach-to-user-namespace
</pre></div></div>

<p>自分でビルドするには <code>reattach-to-user-namespace</code> コマンドをビルドしてPATHを通してtmuxの設定を少し修正する。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>git clone https://github.com/ChrisJohnsen/tmux-MacOSX-pasteboard.git
<span class="nb">cd</span> tmux-MacOSX-pasteboard
make reattach-to-user-namespace
cp reattach-to-user-namespace ~/bin/
</pre></div></div>

<div class="code-frame" data-lang="conf">
<div class="code-lang"><span class="bold">.tmux.conf</span></div>
<div class="highlight"><pre><span></span>set-option -g default-command "reattach-to-user-namespace -l zsh"
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />53位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>37</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/6a06575964f9c80505bb">UNIXでPython,Ruby,Perl,Node.jsのバージョン管理環境構築</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-15 15:02:35</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Python]</b> <b>[Perl]</b> <b>[Mac]</b> <b>[Node.js]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>研究室の新入生向けに書いたやつ。<br>
各種スクリプト言語のバージョン管理をするための環境を構築する。<br>
pythonbrew, rvm, perlbrew, nvmでバージョン管理をし、pip, gem, cpanm, npmでパッケージの管理をする。</p>

<p>アプリについては<a href="http://qiita.com/items/2183">【まとめ】これ知らないプログラマって損してんなって思う汎用的なツール 100超</a>を読んで適当に入れればいい。</p>

<p>Macの人は「homebrewのインストール」までは順番にやっていく。それ以降は必要なものだけやればいい。<br>
その他のUNIX環境の人はyumなりaptなりを使って必要なパッケージを用意してから、「homebrewのインストール」以降で必要なものをやればいい。</p>

<h1>
<span id="osxのバージョンを上げる" class="fragment"></span><a href="#osx%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%92%E4%B8%8A%E3%81%92%E3%82%8B"><i class="fa fa-link"></i></a>OSXのバージョンを上げる</h1>

<p>[]-&gt;[Software Update...]</p>

<p>インストール完了するまで待つ</p>

<h1>
<span id="xcodeインストール" class="fragment"></span><a href="#xcode%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Xcodeインストール</h1>

<p><a href="https://developer.apple.com/downloads/index.action" rel="nofollow noopener" target="_blank">Download</a></p>

<p>ここからXcode for Lionの最新版をダウンロードしてインストール</p>

<h2>
<span id="任意xcode-command-line-toolsインストール" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Fxcode-command-line-tools%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>(任意)Xcode Command Line Toolsインストール</h2>

<p>Xcodeを起動して[Xcode]-&gt;[Preferences]-&gt;[Downloads]からCommand Line Toolsを選んでインストール。<br>
これがないとhomebrewが変になることが（極めて稀に）ある。</p>

<h1>
<span id="java-runtimeインストール" class="fragment"></span><a href="#java-runtime%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Java Runtimeインストール</h1>

<p>同様にJava for OS X Developer Packageをダウンロードしてインストール</p>

<h1>
<span id="homebrewインストールgit" class="fragment"></span><a href="#homebrew%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%ABgit"><i class="fa fa-link"></i></a>homebrewインストール(+git)</h1>

<p><a href="https://github.com/mxcl/homebrew/wiki/installation" rel="nofollow noopener" target="_blank">Installation - homebrew</a></p>

<p>端末で以下を実行</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ ruby -e <span class="s2">"</span><span class="k">$(</span>/usr/bin/curl -fksSL https://raw.github.com/mxcl/homebrew/master/Library/Contributions/install_homebrew.rb<span class="k">)</span><span class="s2">"</span>
$ brew install git
$ brew update
</pre></div></div>

<p>homebrew自体のバージョン管理のためにgitが必要</p>

<h1>
<span id="任意zshインストール" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Fzsh%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>(任意)zshインストール</h1>

<p>シェルにこだわりが無いなら</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ brew install zsh
</pre></div></div>

<h2>
<span id="任意oh-my-zshインストール" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Foh-my-zsh%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>(任意)oh-my-zshインストール</h2>

<p>今まで.zshrcを自分で用意したことがない人はこれをいれると捗る</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ curl -L https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh <span class="p">|</span> sh
</pre></div></div>

<h1>
<span id="python環境構築" class="fragment"></span><a href="#python%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89"><i class="fa fa-link"></i></a>python環境構築</h1>

<p><a href="https://github.com/utahta/pythonbrew/blob/master/README.rst" rel="nofollow noopener" target="_blank">pythonbrew</a></p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ curl -kL http://xrl.us/pythonbrewinstall <span class="p">|</span> bash
$ <span class="nb">echo</span> <span class="s1">'[[ -s "${HOME}/.pythonbrew/etc/bashrc" ]] &amp;&amp; source $HOME/.pythonbrew/etc/bashrc'</span> &gt;&gt; ~/.zshrc
$ pybrew install -fn <span class="m">2</span>.7.2 <span class="m">3</span>.2  <span class="c1"># 時間かかる</span>
</pre></div></div>

<h2>
<span id="任意virtualenvを分ける" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Fvirtualenv%E3%82%92%E5%88%86%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>(任意)virtualenvを分ける</h2>

<p>virtualenvを作ってパッケージを切り分けたい場合は</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ pybrew venv create lab -p <span class="m">2</span>.7.2
$ pybrew venv create lab -p <span class="m">3</span>.2
</pre></div></div>

<p>これでpython2.7.2と3.2にそれぞれ<code>lab</code>という名前のvirtualenvが作成される。よく分からない人は、とりあえず作っておくと、後で後悔しなくて済む可能性が高いのでやっとくことを勧める。</p>

<h2>
<span id="pythonのバージョンを切り替える方法" class="fragment"></span><a href="#python%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%92%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>pythonのバージョンを切り替える方法</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ pybrew switch <span class="m">2</span>.7.2
$ pybrew switch <span class="m">3</span>.2
</pre></div></div>

<p>virtualenvを作った人は</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ pybrew venv use lab -p <span class="m">2</span>.7.2
$ pybrew venv use lab -p <span class="m">3</span>.2
</pre></div></div>

<p>venvをまたいで使いたいモジュールはvenvを切ってからインストールするといい（ipythonインストール参照)</p>

<h2>
<span id="モジュールのインストール方法" class="fragment"></span><a href="#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>モジュールのインストール方法</h2>

<p>インストールしたいバージョンにpybrewで切り替えてから以下を実行</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ pip install PACKAGE_NAME
</pre></div></div>

<h2>
<span id="任意ipythonインストール" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Fipython%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>(任意)ipythonインストール</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ pybrew switch <span class="m">2</span>.7.2  <span class="c1"># venv無しの2.7.2に移動</span>
$ pip install ipython
$ pybrew venv use lab
</pre></div></div>

<p>ipythonの起動</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ ipython
</pre></div></div>

<p>このようにvenvなしの状態でインストールしたモジュールは全てのvenvから参照できる。</p>

<h1>
<span id="ruby環境構築" class="fragment"></span><a href="#ruby%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89"><i class="fa fa-link"></i></a>ruby環境構築</h1>

<p><a href="http://beginrescueend.com/" rel="nofollow noopener" target="_blank">rvm</a></p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ curl -L get.rvm.io <span class="p">|</span> bash -s stable
$ <span class="nb">echo</span> <span class="s1">'[[ -s "${HOME}/.rvm/scripts/rvm" ]] &amp;&amp; source $HOME/.rvm/scripts/rvm'</span> &gt;&gt; ~/.zshrc
$ rvm install <span class="m">1</span>.9.3  <span class="c1"># 時間かかる</span>
</pre></div></div>

<h2>
<span id="任意gemset" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Fgemset"><i class="fa fa-link"></i></a>(任意)gemset</h2>

<p>gemsetを使って環境の切り分け。こちらもよく分からない人はやっとくべき。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rvm use <span class="m">1</span>.9.3
$ rvm gemset create lab
$ rvm use <span class="m">1</span>.9.3@lab --default
</pre></div></div>

<p>globalという名前のgemsetが存在し、それに入っているgemは他の全てのgemsetからも参照できるので、汎用的なツールはglobalに入れるといい。(pryインストールの項目参照)</p>

<h2>
<span id="任意gemでドキュメントのインストールをしないようにする" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Fgem%E3%81%A7%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%82%92%E3%81%97%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>(任意)gemでドキュメントのインストールをしないようにする</h2>

<p>ドキュメントが要らない人だけ</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">'gem: --no-ri --no-rdoc'</span> &gt;&gt; ~/.gemrc
</pre></div></div>

<h2>
<span id="gemのインストール" class="fragment"></span><a href="#gem%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>gemのインストール</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ gem install PACKAGE_NAME
</pre></div></div>

<h2>
<span id="任意pryのインストール" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Fpry%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>(任意)pryのインストール</h2>

<p>ruby用のインタラクティブシェル。gemsetに寄らず必要なのでglobalに入れる</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ rvm use <span class="m">1</span>.9.3@global
$ gem install pry
$ rvm use <span class="m">1</span>.9.3@lab  <span class="c1"># 戻す</span>
</pre></div></div>

<p>起動するには</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ pry
</pre></div></div>

<h1>
<span id="perl環境構築" class="fragment"></span><a href="#perl%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89"><i class="fa fa-link"></i></a>perl環境構築</h1>

<p><a href="http://perlbrew.pl/" rel="nofollow noopener" target="_blank">perlbrew</a></p>

<p>デフォルトでperlbrewは$HOME/perl5/perlbrewにインストールされる。これが嫌な場合は</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">'export PERLBREW_ROOT=$HOME/.perl5/perlbrew'</span> &gt;&gt; .zshrc
$ <span class="nb">source</span> ~/.zshrc
</pre></div></div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ curl -kL http://install.perlbrew.pl <span class="p">|</span> bash
$ <span class="nb">echo</span> <span class="s1">'[[ -s "${HOME}/.perl5/perlbrew/etc/bashrc" ]] &amp;&amp; source $HOME/.perl5/perlbrew/etc/bashrc'</span> &gt;&gt; ~/.zshrc
$ perlbrew install perl-5.14.2  <span class="c1"># 時間かかる</span>
$ perlbrew switch perl-5.14.2
$ perlbrew install-cpanm
</pre></div></div>

<h1>
<span id="node環境構築" class="fragment"></span><a href="#node%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89"><i class="fa fa-link"></i></a>node環境構築</h1>

<p><a href="https://github.com/creationix/nvm" rel="nofollow noopener" target="_blank">nvm</a></p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ git clone git://github.com/creationix/nvm.git ~/.nvm
$ <span class="nb">echo</span> <span class="s1">'[[ -s "${HOME}/.nvm/nvm.sh" ]] &amp;&amp; source $HOME/.nvm/nvm.sh'</span> &gt;&gt; .zshrc
$ nvm install v0.6.15  <span class="c1"># 時間かかる</span>
$ nvm <span class="nb">alias</span> default v0.6.15
</pre></div></div>

<h2>
<span id="パッケージのインストール" class="fragment"></span><a href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>パッケージのインストール</h2>

<p>nvmでnodeを入れると自動的にnpmが使えるようになっている。<br>
npmはデフォルトでプロジェクト単位でパッケージを管理するので、rvmにおいてgemsetでパッケージを分けて管理したようなことをする必要がない。</p>

<p>パッケージをインストールするには以下のようにする</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ npm install PACKAGE_NAME
</pre></div></div>

<p>これを実行するとカレントディレクトリにnode_modulesというディレクトリが作成される。カレントディレクトリ以下のnodeプロジェクト全てからこのnode_moduelsは参照される。</p>

<p>グローバルな箇所に置きたい場合は-gオプションをつける。CoffeeScriptのインストール参照</p>

<h2>
<span id="任意coffeescriptのインストール" class="fragment"></span><a href="#%E4%BB%BB%E6%84%8Fcoffeescript%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>(任意)CoffeeScriptのインストール</h2>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ npm install -g coffee-script
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />54位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>35</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/9312fd82a0fd291b683f">Boxenをアップデートする方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-08 18:11:11</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Boxen]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Boxenも定期的にアップデートしていかなければいけません。で、Boxenをアップデートしようと思って、Puppetfileで指定されているBoxenのバージョンだけを変更して <code>script/boxen</code> を実行してもおそらくエラーが発生します。</p>

<p><a href="https://github.com/boxen/our-boxen" rel="nofollow noopener" target="_blank">boxen/our-boxen</a>をgit-pullでアップデートしてから <code>script/boxen</code> するのが正解。</p>

<h1>
<span id="puppet-boxenとour-boxenのおさらい" class="fragment"></span><a href="#puppet-boxen%E3%81%A8our-boxen%E3%81%AE%E3%81%8A%E3%81%95%E3%82%89%E3%81%84"><i class="fa fa-link"></i></a>puppet-boxenとour-boxenのおさらい</h1>

<p>簡単におさらいしておくと</p>

<table>
<thead>
<tr>
<th>repo</th>
<th>役割</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/boxen/puppet-boxen" rel="nofollow noopener" target="_blank">boxen/puppet-boxen</a></td>
<td>boxenのコアモジュール</td>
</tr>
<tr>
<td><a href="https://github.com/boxen/our-boxen" rel="nofollow noopener" target="_blank">boxen/our-boxen</a></td>
<td>boxenの容れ物</td>
</tr>
</tbody>
</table>

<p>Puppetfileで指定しているのはコアモジュールの方のバージョンです。</p>

<p>容れ物のバージョン毎に対応しているコアのバージョンが微妙に異なっているっぽく、コアだけをバージョンアップしてもダメな訳です。コア自体はBoxenでバージョン管理されていますが、容れ物の方はgitで管理されています。</p>

<p>で、our-boxenのmasterは基本的に正しい組み合わせになっているので、our-boxenをアップデートして、そのときついてくるpuppet-boxenを使うと失敗が少ないです。</p>

<h1>
<span id="our-boxenをアップデートする" class="fragment"></span><a href="#our-boxen%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>our-boxenをアップデートする</h1>

<p>ローカルにあるBoxenのリポジトリは本来our-boxenをgit-cloneして、masterをプライベートなリポジトリに向けていると思います。なので、まず最初に本家の<a href="https://github.com/boxen/our-boxen" rel="nofollow noopener" target="_blank">boxen/our-boxen</a>をremoteに設定してやりましょう。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">本家のリポジトリをupstreamという名前で登録</span></div>
<div class="highlight"><pre><span></span>% git remote add upstream git://github.com/boxen/our-boxen.git
<span class="c1"># 設定できてるか確認</span>
% git remote -v <span class="p">|</span> grep upstream
upstream        git://github.com/boxen/our-boxen.git <span class="o">(</span>fetch<span class="o">)</span>
upstream        git://github.com/boxen/our-boxen.git <span class="o">(</span>push<span class="o">)</span>
</pre></div>
</div>

<p>そしたらupstreamからpullします。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">本家の変更を取り込む</span></div>
<div class="highlight"><pre><span></span>% git pull upstream master
</pre></div>
</div>

<p>コンフリクトが発生したらよしなに解消してください。これでour-boxenのアップデートが完了したので、必要に応じて設定を更新してから <code>script/boxen</code> を実行します。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">Boxenを実行する</span></div>
<div class="highlight"><pre><span></span>% ./script/boxen
</pre></div>
</div>

<p>成功したら忘れずにコミットして、originにgit-pushしておきましょう。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">originへ変更をpushする</span></div>
<div class="highlight"><pre><span></span>% git add -A
% git commit -m <span class="s1">'Update our-boxen'</span>
% git push origin master
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />55位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>35</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/590c11c7f87006194e2b">JSLitmusを使ってJSのパフォーマンス測定をする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-05 17:39:12</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jslitmus]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>計測しないで推測ばかりしているアホの子だったから本腰いれて JavaScript のパフォーマンス測定環境について調べた。<br>
結論として <a href="http://www.broofa.com/Tools/JSLitmus/" rel="nofollow noopener" target="_blank">JSLitmus</a> を使うとかなり簡単にできる。</p>

<h2>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h2>

<ol>
<li>jslitmus.js をロードする</li>
<li>JSLitmus.test の第二引数に測定したい関数を渡す</li>
<li>#jslibmut_container エレメントを作る</li>
</ol>

<p>簡単！</p>

<h2>
<span id="例" class="fragment"></span><a href="#%E4%BE%8B"><i class="fa fa-link"></i></a>例</h2>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">'jslitmus.js'</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">'sample.js'</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">'jslitmus_container'</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">sample.js</span></div>
<div class="highlight"><pre><span></span><span class="c1">// グローバル変数とローカル変数に対するアクセス速度の違いを測定する</span>

<span class="kd">var</span> <span class="nx">global_var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">JSLitmus</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'global'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="nx">global_var</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">JSLitmus</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'local'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">local_var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="nx">local_var</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>

<p>ここで第二引数に渡された関数の実行時に <code>count</code> というのが渡されてそれを <code>while (count--) { … }</code> としているが、これは JavaScript の関数呼び出しのコストを抑えるために行う作法のようなものなので基本的にこのフォーマットに従うのがよい。</p>

<h2>
<span id="実行してみる" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>実行してみる</h2>

<p>先ほど作ったhtmlをブラウザで読み込む。すると以下のようになっているはず。</p>

<p><a href="https://camo.qiitausercontent.com/d2f9440a89a76089d73f550035dbf149cd283a91/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303132313230352f32303132313230353137333034352e706e673f31333534363936323537" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d2f9440a89a76089d73f550035dbf149cd283a91/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303132313230352f32303132313230353137333034352e706e673f31333534363936323537" alt="" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20121205/20121205173045.png?1354696257"></a></p>

<p>ここで <code>Rub Tests</code> ボタンを押すと何やら動き出して、しばらく経つと以下のようになる。</p>

<p><a href="https://camo.qiitausercontent.com/3722dede17e45761a2e68044deabd704a6a56654/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303132313230352f32303132313230353137333034362e706e673f31333534363936333537" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3722dede17e45761a2e68044deabd704a6a56654/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303132313230352f32303132313230353137333034362e706e673f31333534363936333537" alt="" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20121205/20121205173046.png?1354696357"></a></p>

<p>棒は実行できた回数を表すので長いほど速度が速い（沢山試行できた）ことを意味する。このことからグローバル変数へのアクセスよりローカル変数へのアクセスの方が（Chromeでは）4倍近く速いということが分かる。</p>

<h2>
<span id="tips" class="fragment"></span><a href="#tips"><i class="fa fa-link"></i></a>Tips</h2>

<h3>
<span id="自動実行する" class="fragment"></span><a href="#%E8%87%AA%E5%8B%95%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>自動実行する</h3>

<p>デフォルトで <code>Run Tests</code> ボタンをクリックしないと計測が開始しない。これを読み込み完了と同時に実行するようにするには</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">JSLitmus</span><span class="p">.</span><span class="nx">runAll</span><span class="p">();</span>
<span class="p">};</span>
</pre></div></div>

<p>とどっかに書いておけばOK.</p>

<h3>
<span id="複数ブラウザで同時実行" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%A7%E5%90%8C%E6%99%82%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>複数ブラウザで同時実行</h3>

<p>参考： <a href="http://qiita.com/items/161491a6a324bda3835b">JSのテストファイルを複数のブラウザで開いて手軽に確認する</a></p>

<h2>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h2>

<p>みんなでどんどん計測しよう！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />56位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>33</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/c19d2fff0dc23e4015ff">Backbone.js入門 「Collection」</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-19 02:08:22</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="閲覧上の注意" class="fragment"></span><a href="#%E9%96%B2%E8%A6%A7%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>閲覧上の注意</h3>

<p>この記事で対象としているバージョン0.5.3は結構古いので注意してください。</p>

<p>その他の割りと新しい情報は <a href="http://www.adventar.org/calendars/15" rel="nofollow noopener" target="_blank">Backbone.js Advent Calendar 2012</a> などにあります。</p>

<p>（追記ここまで）</p>

<hr>

<p>今回は <code>Collection</code> です。<br>
特に難しいことはなくて、複数の <code>Model</code> を扱うためのオブジェクトです。間違っても MVC の C ではないです。</p>

<h2>
<span id="基本的な使い方" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>基本的な使い方</h2>

<p>真新しさは特にありません。強いていうなら、<code>model</code> に何モデルの集まりを表すものかを指定するくらいです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

<span class="kd">var</span> <span class="nx">BlogList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">model</span><span class="o">:</span> <span class="nx">Blog</span>
<span class="p">});</span>
</pre></div></div>

<p>インスタンス生成時にモデルを渡すことで初期化することが可能です。渡すのは <code>Model</code> インスタンスでも、単なるオブジェクトでも構いません。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">blogA</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"foo"</span><span class="p">});</span>
<span class="kd">var</span> <span class="nx">blogs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlogList</span><span class="p">([</span><span class="nx">blogA</span><span class="p">]);</span>

<span class="c1">// 以下でも同じ</span>
<span class="kd">var</span> <span class="nx">blogs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlogList</span><span class="p">([{</span><span class="nx">text</span><span class="o">:</span> <span class="s2">"foo"</span><span class="p">}]);</span>
<span class="kd">var</span> <span class="nx">blogA</span> <span class="o">=</span> <span class="nx">blogs</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</pre></div></div>

<p><code>Collection#models</code> は実際の <code>Model</code> インスタンスが格納されている場所です。</p>

<h2>
<span id="addmodels-options" class="fragment"></span><a href="#addmodels-options"><i class="fa fa-link"></i></a>add(models, [options])</h2>

<p>モデルを追加します。追加するのは上で書いたインスタンス生成の場合と同じく、 <code>Model</code> のインスタンスでも、オブジェクトでもかまいません。<br>
add イベントが発生します。抑制するには <code>options</code> で silent を true にします。</p>

<h2>
<span id="removemodels-options" class="fragment"></span><a href="#removemodels-options"><i class="fa fa-link"></i></a>remove(models, [options])</h2>

<p>モデルを削除します。remove イベントが発生するので、抑制するには silent を使います。</p>

<h2>
<span id="resetmodels-options" class="fragment"></span><a href="#resetmodels-options"><i class="fa fa-link"></i></a>reset(models, [options])</h2>

<p>モデルを一旦全部削除してから、渡されたモデルで初期化します。reset イベントが発生します。抑制するには silent です。</p>

<h2>
<span id="getid" class="fragment"></span><a href="#getid"><i class="fa fa-link"></i></a>get(id)</h2>

<p><code>Model#id</code> の値を用いて、<code>Collection</code> の中からモデルオブジェクトを取得します。</p>

<h2>
<span id="each-map-filter-etc" class="fragment"></span><a href="#each-map-filter-etc"><i class="fa fa-link"></i></a>each, map, filter, etc.</h2>

<p>以下の二つは等価です。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">blogs</span><span class="p">.</span><span class="nx">models</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">blog</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* do something */</span><span class="p">});</span>

<span class="nx">blogs</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">blog</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* do something */</span><span class="p">});</span>
</pre></div></div>

<p>このようなモデルに対する配列操作をするためのショートカットメソッドが複数用意されています。</p>

<h2>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h2>

<p><code>Collection</code> に関しては以上です。<br>
明日は「Model と View と Collectionの連携」です。<br>
今回は特に難しい話題はありませんでしたが、明日は <code>View</code> との連携の中でどのように <code>Collection</code> を扱えばよいかに焦点を当てて解説したいと思います。<br>
それではまた明日。</p>

<hr>

<ol>
<li><a href="http://qiita.com/items/16b799d0ec0a0ae3f78e">Backbone.js入門 Events</a></li>
<li><a href="http://qiita.com/items/03f49c64d6c4bacdbb26">Backbone.js入門 MVC</a></li>
<li><a href="http://qiita.com/items/8ee2ed1949cd7c337f06">Backbone.js入門 View</a></li>
<li><a href="http://qiita.com/items/5acef8dd49f67fd7813c">Backbone.js入門 Model</a></li>
<li><a href="http://qiita.com/items/7ce4b1ceb5d18c9cef08">Backbone.js入門 ViewとModelの連携</a></li>
<li>Backbone.js入門 Collection</li>
<li><a href="http://qiita.com/items/7095a32cc5e438172844">Backbone.js入門 ViewとModelとCollectionの連携</a></li>
<li><a href="http://qiita.com/items/13f3d1f71d31f3e78123">Backbone.js入門 RouterとHistory</a></li>
</ol>

<ul>
<li><a href="https://groups.google.com/forum/?fromgroups#!forum/backbonejs-ja" rel="nofollow noopener" target="_blank">BackboneJS 日本語メーリングリスト</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />57位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>32</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/c6e7ed09cdca8b4559ed">開発サーバのログをDevtools Terminalで流しとくと便利</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-16 00:32:16</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Chrome]</b> <b>[AdventCalendar]</b> <b>[1分シリーズ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><ul>
<li><a href="https://chrome.google.com/webstore/detail/devtools-terminal/leakmhneaibbdapdoienlkifomjceknl" rel="nofollow noopener" target="_blank">Devtools Terminal</a></li>
</ul>

<p>Railsに限った話じゃないですが、開発時に立てたサーバのログを見ながら作業することがあると思います。そんなときはDevtools Terminalが便利です。</p>

<p>この拡張をインストールするとDeveloper ToolsにTerminalタブが追加されます。で、このタブの中身が端末のエミュレータになっていてるので、その画面の中で <code>tail -f</code> とかやっとくわけです。Devtools Terminal自体にはタブ機能がありませんが、その中でscreenとかtmuxを起動してやれば大丈夫です。</p>

<p><a href="https://camo.qiitausercontent.com/f31abc0f4caeb1c1a6ba6a89a583815329f995e0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f65386139313233312d643361622d626134332d366437332d6166653561353731333363392e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f31abc0f4caeb1c1a6ba6a89a583815329f995e0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f65386139313233312d643361622d626134332d366437332d6166653561353731333363392e6a706567" alt="Screen_Shot_2013-12-16_at_12.21.41_AM-2.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/e8a91231-d3ab-ba43-6d73-afe5a57133c9.jpeg"></a></p>

<p>無論こんなことをしなくても横に端末を並べて置いてそこで表示すればいいといえばいいのですが、画面の横に必ず固定されている、というのが嬉しい感じです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />58位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>32</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/581623db1e4ef4751931">Rails+RspecでSSL・非SSLのテストするときはshared_context使うと捗る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-06-13 18:02:33</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>RailsのコントローラのSSL・非SSLのときの振る舞いをテストするには <code>request.env['HTTPS']</code> に <code>'on'</code> か <code>'off'</code> を代入すればいい。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">describe</span> <span class="no">SomeController</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET new'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'access using SSL'</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">'HTTPS'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'on'</span> <span class="p">}</span>
      <span class="n">it</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:new</span> <span class="c1"># SSLでアクセスする</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'access not using SSL'</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">'HTTPS'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'off'</span> <span class="p">}</span>
      <span class="c1"># この中は非SSL</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>毎回 <code>before</code> ブロックを書くのは面倒くさいので <code>shared_context</code> を使うと捗る。以下の様なコードを用意する。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">shared_context</span> <span class="s1">'SSL'</span><span class="p">,</span> <span class="ss">ssl</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">'HTTPS'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'on'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">shared_context</span> <span class="s1">'not SSL'</span><span class="p">,</span> <span class="ss">ssl</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">'HTTPS'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'off'</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>

<p>すると以下のように書ける。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">describe</span> <span class="no">SomeController</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET new'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'access using SSL'</span><span class="p">,</span> <span class="ss">ssl</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span>
      <span class="n">it</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:new</span> <span class="c1"># SSLでアクセスする</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'access not using SSL'</span><span class="p">,</span> <span class="ss">ssl</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
      <span class="c1"># この中は非SSL</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />59位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>29</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/41b724a1c3569044372c">mergeコミットをrevertする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-03 18:35:50</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Git flowなんかを使っているとこんな感じのコミット履歴ができあがる</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>--A--------M
    \     /
     B---C   &lt;- feature/foo  branch
</pre></div></div>

<p>ここでブランチ <code>feature/foo</code> 自体が要らなくなったと場合は次のように revert する</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>git revert -m 1 M
</pre></div></div>

<p>すると</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>--A--------M---M'
    \     /
     B---C
</pre></div></div>

<p>となり、コミット <code>M'</code> と <code>A</code> は同じ状態になる。</p>

<p>詳しくは <a href="http://www.kernel.org/pub/software/scm/git/docs/howto/revert-a-faulty-merge.txt" rel="nofollow noopener" target="_blank">revert-a-faulty-merge.txt</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />60位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>25</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/46d1d834fbdae271d66c">gitoliteはどうやってユーザを判別しているか</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-17 22:32:21</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> <b>[SSH]</b> <b>[gitolite]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ちょっとしたコネタの紹介</p>

<p>gitoliteを<code>host</code>に<code>git</code>というユーザ名でインストールすると<code>ssh://git@host:reponame.git</code>で<code>reponame</code>というリポジトリに対するアクセス制御をすることができる。<br>
当然ながら<code>ssh://git@host:reponame.git</code>は<code>host</code>に<code>git</code>というユーザ名でSSH接続することを意味する。</p>

<p>で、不思議なのはgitoliteは一体どうやってユーザの判別をしているのか、ということだ。</p>

<p>なにせgitoliteはサーバ上にインストールされているのだから、gitoliteから見たらどのアクセスも<code>git</code>というユーザなのだ。どうやってgitoliteは「このアクセスはyuku_tからだ」「こっちのはyaottiからだ」という風に判断しているのだろう。（むしろこれができなければアクセス制御なんてできっこない）</p>

<p>答えは<code>git</code>ユーザの<code>authorized_keys</code>ファイルにある。</p>

<p><code>authorized_keys</code>が単なる公開鍵置き場だと思ったら大間違い。実はもっといろいろな設定ができるのだ。<br>
以下に<code>authorized_keys</code>の例を引用する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># gitolite start
command="/home/git/gitolite/src/gitolite-shell taka84u9",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAB3NzaC1y...== taka84u9
# gitolite end
</pre></div></div>

<p><code>ssh-rsa</code>以降が普段我々が公開鍵を設定している箇所だ。<br>
そしてその前半部分に<code>command</code>や<code>no-port-forwarding</code>など見覚えのない部分がある。<br>
実はsshdは公開鍵でユーザの認証を取ったあとの制御をこの部分で記述することができるのだ。<br>
そして、<code>command</code>というのがユーザがログイン後に実行するコマンドになる。よくよく見てみると</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>command="/home/git/gitolite/src/gitolite-shell taka84u9"
</pre></div></div>

<p><code>gitolite-shell</code>というコマンドに対して引数でユーザ名が渡されている。<br>
先ほどの疑問の答えがこれで、このスクリプトの中でアクセス制御が行われる。<br>
またこのユーザ名は<code>$GL_USER</code>という環境変数に格納されるためgitoliteで管理されているgitリポジトリのhookの中でユーザの判別もできる、という訳。</p>

<p>なかなか面白い実装だと思う。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />61位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>23</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/cc30710256da2427c974">Qiitaの通知を表示できるChrome拡張を作った</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-02-12 21:27:03</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> <b>[Chrome]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>画面の上の方に出てくる通知を見れるChrome拡張を勉強がてら作りました。よければ使ってみて下さい。</p>

<p><a href="https://chrome.google.com/webstore/detail/hcnchocfgcldaldkchelnhpidgmfaocc" rel="nofollow noopener" target="_blank">Chrome Web Store - Qiita Notifications</a><br>
<a href="https://github.com/taka84u9/qiita-notifications" rel="nofollow noopener" target="_blank">taka84u9/qiita-notifications</a></p>

<p><a href="https://camo.qiitausercontent.com/b705b00825cfe983e95ef5a39ed91a4b7d7fc160/68747470733a2f2f6c68342e676f6f676c6575736572636f6e74656e742e636f6d2f685a6842363075505534595737713659583347512d496a4f4e665a48316e754d364a7564484e4c7a41666547303550694551543375584d734d6f465145686d494542744b497370347630553d733634302d683430302d65333635" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/b705b00825cfe983e95ef5a39ed91a4b7d7fc160/68747470733a2f2f6c68342e676f6f676c6575736572636f6e74656e742e636f6d2f685a6842363075505534595737713659583347512d496a4f4e665a48316e754d364a7564484e4c7a41666547303550694551543375584d734d6f465145686d494542744b497370347630553d733634302d683430302d65333635" alt="Qiita Notifications" data-canonical-src="https://lh4.googleusercontent.com/hZhB60uPU4YW7q6YX3GQ-IjONfZH1nuM6JudHNLzAfeG05PiEQT3uXMsMoFQEhmIEBtKIsp4v0U=s640-h400-e365"></a></p>

<p>クロール間隔は150秒です。</p>

<p>HTTP通信の履歴からAPIを予測して（つまり非公開APIを用いて）作っているので、突然APIが変わったりして動かなくなったりする可能性があります。</p>

<p>また、バグなんかがあったら、GithubのページかQiitaに書いてくれれば、極力対応します。</p>

<p>ソースコードはオープンですが、最初の実装がQiitaに過剰にアクセスする感じだったので、キャッシュをさせたりなんなりしていたら、だんだんコードを綺麗に保つのが面倒になってしまって、つまり、汚いです。<br>
最初の仕事はリファクタリングですかね。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />62位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>23</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/05bc1c69bf9a179d9ec7">Modelの一対多を実装する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-11 09:43:54</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>例えば、Blogテーブルにuser_idカラムがあり、これがUserテーブルへの外部キー制約になっているような場合、WebフレームワークではBlogモデルにuserフィールドを持たせて、そのフィールドにメッセージを送ると、参照しているUserモデルのインスタンスを返してくれるようになっている場合が多いと思います。<br>
このような関係をBackbone.jsで実現しようと思い、つい以下のように書きたくなってしまうかも知れません。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
<span class="kd">var</span> <span class="nx">author</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">".user_id"</span><span class="p">).</span><span class="nx">html</span><span class="p">()});</span>
<span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
<span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">".text"</span><span class="p">).</span><span class="nx">html</span><span class="p">(),</span> <span class="nx">user_id</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">author</span><span class="p">});</span>
</pre></div></div>

<p>こうすれば確かに <code>entry.get("user")</code> で<code>author</code> へのリファレンスを得ることができます。<br>
僕も以前はこのような書き方をしたことがあったのですが、どうやらこれはBackbone.js的には正しくない使い方のようです。その理由はModelの<code>toJSON</code>メソッドの実装を見てみると分かります。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// Backbone.js 0.5.3 から改変して抜粋</span>
<span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p>ここで<code>attributes</code>はModelに対して<code>set</code>や<code>get</code>メソッドで取得する属性が実際に格納されている場所です。つまり、上記のentryオブジェクトのattributesは以下のようになっているわけです</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">entry</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">==</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">".text"</span><span class="p">).</span><span class="nx">html</span><span class="p">(),</span> <span class="nx">user_id</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">author</span><span class="p">}</span>
</pre></div></div>

<p>ここではModelであるはずのauthorに対して、再帰的にtoJSONを呼び出すという処理を行なっていませんね。<br>
Backbone.syncでModelをWebサーバど同期するためにRESTful APIを呼び出す際にModelオブジェクトに<code>toJSON</code>メソッドを呼び、その返り値を<code>JSON.stringify</code>したものをAPIに投げるという処理を行なっています。<br>
authorも同様にattributesなどを持っているので、これではUserテーブルにattributesカラムがあるかのようにAPIを呼び出していることになってしまいます。実際、scaffoldで作ったAPIに対してこのようなリクエストを発行してもRailsはエラーを出します。<br>
回避方法は大きく分けて二通りあります。</p>

<h2>
<span id="tojsonをオーバーライドする" class="fragment"></span><a href="#tojson%E3%82%92%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%89%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>toJSONをオーバーライドする</h2>

<p>BlogのtoJSONメソッドをオーバーライドしてuserを返り値から取り除けば回避できます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
    <span class="k">delete</span> <span class="nx">json</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p>これでも動きますが、次のおそらく意図しているであろう使い方の方が適当だと思います。</p>

<h2>
<span id="メソッドにする" class="fragment"></span><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>メソッドにする</h2>

<p>そもそもの悪の元凶は、userをattributesに入れてしまったことです。UserインスタンスをIDと紐付けて管理するオブジェクトを用意して、それに問い合わせるようにしてみます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">users</span><span class="p">[</span><span class="nx">author</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">author</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">getUser</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">users</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)];</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">({</span><span class="nx">user_id</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">id</span><span class="p">});</span>
<span class="nx">entry</span><span class="p">.</span><span class="nx">getUser</span><span class="p">();</span> <span class="c1">// =&gt; author</span>
</pre></div></div>

<h3>
<span id="collectionを使う" class="fragment"></span><a href="#collection%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>Collectionを使う</h3>

<p>Backbone.jsで複数のModelを管理するなら、Collectionを使うほうが適当だと思われます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">model</span><span class="o">:</span> <span class="nx">User</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserList</span><span class="p">([</span><span class="nx">author</span><span class="p">]);</span>
<span class="kd">var</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">userList</span><span class="o">:</span> <span class="nx">users</span><span class="p">,</span>
  <span class="nx">getUser</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userList</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">({</span><span class="nx">user_id</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">id</span><span class="p">});</span>
<span class="nx">entry</span><span class="p">.</span><span class="nx">getUser</span><span class="p">();</span> <span class="c1">// =&gt; author</span>
</pre></div></div>

<h2>
<span id="user側から参照しているblogの一覧を取得する" class="fragment"></span><a href="#user%E5%81%B4%E3%81%8B%E3%82%89%E5%8F%82%E7%85%A7%E3%81%97%E3%81%A6%E3%81%84%E3%82%8Bblog%E3%81%AE%E4%B8%80%E8%A6%A7%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>User側から参照しているBlogの一覧を取得する</h2>

<p>Userインスタンスに対して、このユーザが作ったBlogの一覧を取得したいことが考えられます。これもBlogのCollectionを作るのがいいと思います。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">BlogList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">model</span><span class="o">:</span> <span class="nx">Blog</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">blogs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlogList</span><span class="p">([</span><span class="nx">entry</span><span class="p">]);</span>
<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">blogList</span><span class="o">:</span> <span class="nx">blogs</span><span class="p">,</span>
  <span class="nx">getBlogs</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">blogList</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">blog</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div></div>

<p>余談ですが、ここCollectionインスタンスに<code>filter</code>メソッドを呼び出しています。同様に<code>each</code>、<code>reduce</code>、<code>find</code>などのunderscoreのメソッドが定義されており、これらは全てCollectionに追加されているModelの配列に対して呼び出されます。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>Modelの一対多を表現する場合は、リファレンスを属性として保持するのではなく、リファレンスを返すメソッドを実装し、内部ではCollectionを使うのが、意図されている実装方法なのではないかと思います。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />63位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>21</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/c83120ea22e892083651">CLOBBER無効時にリダイレクションでファイルを上書きするには&gt;|を使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-25 23:29:48</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Zsh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>シェルで <code>&gt;</code> を使うと標準出力をファイルに書き込めますが、意図せずファイルを上書きしてしまう危険があるので、これができないようにしている人も多いのではないでしょうか。</p>

<div class="code-frame" data-lang="zshrc"><div class="highlight"><pre><span></span>setopt noclobber
</pre></div></div>

<p>これを設定していると既にファイルが存在する場合エラーになります。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> foo &gt; hoge
$ ls
. .. hoge
$ <span class="nb">echo</span> foo &gt; hoge
zsh: file exists: hoge
</pre></div></div>

<p>これはこれで嬉しいのですが、時にはファイルが存在することを理解した上で、あえて上書きしたい場合もあります。そういう場合は <code>&gt;|</code> か <code>&gt;!</code> を使います。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ ls
. .. hoge
$ <span class="nb">echo</span> bar &gt;! hoge
$ cat hoge
bar
</pre></div></div>

<p>さらに <code>&gt;&gt;</code> でファイルに追記できますが、これもファイルが存在しない場合はエラーが発生してしまいます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> foo &gt;&gt; huga
zsh: no such file or directory: huga
</pre></div></div>

<p>ファイルが存在しない場合は新規作成したい場合（clobberが有効な状態のときの <code>&gt;&gt;</code> と同じ挙動）にするには先ほどと同様に <code>&gt;&gt;|</code> か <code>&gt;&gt;!</code> を使います。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> foo &gt;&gt;! huga
$ cat huga
foo
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />64位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>21</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/b5f0e49d68469eb38c1b">⌘+TabでWitchを操作する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-04-19 11:40:18</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Macにおいて「⌘+Tab」はアクティブなアプリケーションを変更するショートカットだが、組み込みだとウィンドウを変更できない。（これ自体はDock.appの機能）</p>

<p>何を言っているかと言うと、例えばChromeを2つのウィンドウに分割しているとして（片方は個人用、もう一方は仕事用）「⌘+Tab」ではChromeを選択できるが、それらの間をいったりきたりすることができない。</p>

<p>ウィンドウを変更するにはどうすればいいのかというとChromeが選択された状態で「⌘+`」を押す。はっきり言って面倒くさすぎる。</p>

<p>そういう場合に便利なのが<a href="http://manytricks.com/witch/" rel="nofollow noopener" target="_blank">Witch</a>なのだが、こちらは「Option+Tab」なのでちょっと親指がつらい。Witchはキーバインドを変更できるので「⌘+Tab」を割り当てればいいのだが、なんとDock.appの方のキーバインドを変更できないので、せっかく「⌘+Tab」を割り当ててもWitchまで命令が到達しないので意味が無い。</p>

<p>これを回避するには<a href="http://pqrs.org/macosx/keyremap4macbook/index.html.ja" rel="nofollow noopener" target="_blank">KeyRemap4MacBook</a>を使う。</p>

<p>これを使うとキーの割り当てを切り換えることができる。つまり、Witchは「Option+Tab 」、Dockは「⌘+Tab」で待ち受けている状態で、KeyRemap4MacBookが「⌘+Tab」を「Option+Tab」に置き換えてしまうことで、擬似的にWitchを「⌘+Tab」で操作できるようにすることができるのだ。</p>

<h2>
<span id="keyremap4macbook-の設定" class="fragment"></span><a href="#keyremap4macbook-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>KeyRemap4MacBook の設定</h2>

<p>KeyRemap4MacBookをインストールしたら設定を開いて「Misc &amp; Uninstall」タブの「Custom Setting」の「Open private.xml」をクリックする。</p>

<p><a href="https://camo.qiitausercontent.com/ea5cc37e639588b89b2ca8cf6b09337c470d3794/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303431392f32303133303431393131333335302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ea5cc37e639588b89b2ca8cf6b09337c470d3794/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303431392f32303133303431393131333335302e706e67" alt="" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20130419/20130419113350.png"></a></p>

<p>そしたらFinderが開いてそこにprivate.xmlというのがいるので、何かしらのテキストエディタで開いて下記をコピペ。すでに中身がある場合は <code>&lt;item&gt;&lt;/item&gt;</code> の中身だけをコピペする。</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">private.xml</span></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;root&gt;</span>
  <span class="nt">&lt;list&gt;</span>
    <span class="nt">&lt;item&gt;</span>
      <span class="nt">&lt;name&gt;</span>Swap Command+Tab and Option+Tab<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;identifier&gt;</span>private.use_witch<span class="nt">&lt;/identifier&gt;</span>
      <span class="nt">&lt;autogen&gt;</span>
        __KeyToKey__
        KeyCode::TAB, ModifierFlag::COMMAND_L,
        KeyCode::TAB, ModifierFlag::OPTION_L
      <span class="nt">&lt;/autogen&gt;</span>
      <span class="nt">&lt;autogen&gt;</span>
        __KeyToKey__
        KeyCode::TAB, ModifierFlag::OPTION_L,
        KeyCode::TAB, ModifierFlag::COMMAND_L
      <span class="nt">&lt;/autogen&gt;</span>
    <span class="nt">&lt;/item&gt;</span>
  <span class="nt">&lt;/list&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</pre></div>
</div>

<p>保存したらKeyRemap4MacBookの設定に戻って「Change Key」を選択して「Reload XML」をクリックすると出現する「Swap Command+Tab and Option+Tab」を選択する。</p>

<p><a href="https://camo.qiitausercontent.com/ee832eda5b54c852e31274b9bb5c16775f4f30b2/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303431392f32303133303431393131333835342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/ee832eda5b54c852e31274b9bb5c16775f4f30b2/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303133303431392f32303133303431393131333835342e706e67" alt="" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20130419/20130419113854.png"></a></p>

<p>これで「⌘+Tab」でWitchが「Option+Tab」でDockが動く。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />65位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>20</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/5cf770157380952e9476">簡単にトピックブランチだけでinteractive rebaseする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-03 13:39:25</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="背景" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>背景</h1>

<p>プルリクエストを投げる前にトピックブランチのコミットを綺麗にしたい</p>

<h1>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h1>

<p>トピックブランチの根本のsha1が分からないのでいちいち調べないといけないので面倒です。</p>

<h1>
<span id="解法-1---git-merge-base" class="fragment"></span><a href="#%E8%A7%A3%E6%B3%95-1---git-merge-base"><i class="fa fa-link"></i></a>解法 1 - git-merge-base</h1>

<p>こんな <code>branch-root</code> エイリアスを作ります。</p>

<div class="code-frame" data-lang="ini">
<div class="code-lang"><span class="bold">~/.gitconfig</span></div>
<div class="highlight"><pre><span></span><span class="k">[alias]</span>
  <span class="na">branch-root</span> <span class="o">=</span> <span class="s">merge-base master HEAD</span>
</pre></div>
</div>

<p>あとはこのように実行すればトピックブランチだけでinteractive rebaseができる</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ git rebase -i <span class="k">$(</span>git branch-root<span class="k">)</span>
</pre></div></div>

<h2>
<span id="解説" class="fragment"></span><a href="#%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>解説</h2>

<p><code>git-merge-base</code> は与えられたコミットの共通の祖先のsha1を出力してくれます。これを使うことで <code>branch-root</code> はトピックブランチの根本のsha1を標準出力します。</p>

<h1>
<span id="解法-2---git-rev-list" class="fragment"></span><a href="#%E8%A7%A3%E6%B3%95-2---git-rev-list"><i class="fa fa-link"></i></a>解法 2 - git-rev-list</h1>

<div class="code-frame" data-lang="ini">
<div class="code-lang"><span class="bold">~/.gitconfig</span></div>
<div class="highlight"><pre><span></span><span class="k">[alias]</span>
  <span class="na">branch-first</span> <span class="o">=</span> <span class="s">!git rev-list master..HEAD | tail -n 1</span>
</pre></div>
</div>

<p>こっちの場合は</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ git rebase -i <span class="k">$(</span>branch-first<span class="k">)</span>^
</pre></div></div>

<h2>
<span id="解説-1" class="fragment"></span><a href="#%E8%A7%A3%E8%AA%AC-1"><i class="fa fa-link"></i></a>解説</h2>

<p><code>git-rev-list</code> は与えられたrevisionにマッチするsha1を出力してくれるので、その中で一番古いものを出力します。こうすることで <code>branch-first</code> はトピックブランチの一番最初のsha1を標準出力します。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />66位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>20</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/abfb9f2664ee0a93b82e">cartonでライブラリ管理してるperlプロジェクトでvimを良い感じにする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-11-20 11:13:25</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Perl]</b> <b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Perlのプロジェクトでcartonを使っているとだいたい以下のようなディレクトリ構成になる。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>project_root
├── local
│   └── lib
│       └── perl5
│              └── darwin-2level   # macの場合
└── lib
</pre></div></div>

<p>vimでperlを開くといろいろと良い感じにしてくれるが、多くの場合システムの <code>@INC</code> を使うため不都合を被る場面がでてくる。</p>

<h2>
<span id="thincavim-localrc" class="fragment"></span><a href="#thincavim-localrc"><i class="fa fa-link"></i></a>thinca/vim-localrc</h2>

<p>使うのは <a href="https://github.com/thinca/vim-localrc" rel="nofollow noopener" target="_blank">thinca/vim-localrc</a></p>

<p>project_rootに.local.vimrcを作ってそこに色々と書いていく</p>

<h2>
<span id="gfで正しいファイルに飛べない問題" class="fragment"></span><a href="#gf%E3%81%A7%E6%AD%A3%E3%81%97%E3%81%84%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E9%A3%9B%E3%81%B9%E3%81%AA%E3%81%84%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>gfで正しいファイルに飛べない問題</h2>

<p>vimはgfでカーソル以下にあるファイルに飛ぶ機能がある。perlを開いていればそのモジュールに飛ぶ。しかし <code>@INC</code> には入っていないので飛ぶことができない。</p>

<p>これを解決するのは <code>.local.vimrc</code> に下記のように書く。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.local.vimrc</span></div>
<div class="highlight"><pre><span></span><span class="k">set</span> <span class="nb">path</span><span class="p">=</span><span class="sr">/path/</span><span class="k">to</span><span class="sr">/project_root/</span>lib<span class="p">,</span><span class="sr">/path/</span><span class="k">to</span><span class="sr">/project_root/</span>local<span class="sr">/lib/</span>perl5<span class="p">,</span><span class="sr">/path/</span><span class="k">to</span><span class="sr">/project_root/</span>local<span class="sr">/lib/</span>perl5/darwin<span class="m">-2</span>level
</pre></div>
</div>

<h3>
<span id="確認" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>確認</h3>

<p>lib以下のpmファイルを適当に開いて</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>:set path?
</pre></div></div>

<p>を確認して .local.vimrc で設定した内容になっていればOK</p>

<p>これで</p>

<div class="code-frame" data-lang="perl">
<div class="code-lang"><span class="bold">lib/Foo/Bar.pm</span></div>
<div class="highlight"><pre><span></span><span class="k">use</span> <span class="nn">Foo::</span><span class="o">^</span><span class="n">Baz</span><span class="p">;</span>   <span class="c1"># ^ にカーソルがある</span>
</pre></div>
</div>

<p>この状態で gf と打てば project_root/lib/Foo/Baz.pm に画面が遷移する。cartonでインストールしたpmでも大丈夫</p>

<h2>
<span id="syntasticでライブラリが見つけられない問題" class="fragment"></span><a href="#syntastic%E3%81%A7%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%8C%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%81%AA%E3%81%84%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>syntasticでライブラリが見つけられない問題</h2>

<p>syntasticには use しているライブラリの存在確認機能があるが carton 内のやつを見つけられないので、保存のたびにエラーが出る。</p>

<p>これに対しては以下を追記する。 <code>g:syntastic_perl_lib_path</code> に関しては <code>syntastic/syntax_chekers/perl.vim</code>を参照</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.local.vimrc</span></div>
<div class="highlight"><pre><span></span><span class="k">let</span> <span class="k">g</span>:syntastic_perl_lib_path <span class="p">=</span> <span class="s2">"/path/to/project_root/lib,/path/to/project_root/local/lib/perl5,/path/to/project_root/local/lib/perl5/darwin-2level"</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />67位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>19</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/3343df9f566e1557faee">1分で複数マシンにiTerm2を使ってSSHログインを決める</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-05 00:06:23</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[iTerm2]</b> <b>[1分シリーズ]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>iTerm2でおもむろに画面を分割します。</p>

<p><a href="https://camo.qiitausercontent.com/d985a784d4fad03cc41a79d96e8e81a31bd2b380/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f39313936616264392d653732332d303431372d623262652d6331323061303735333465622e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d985a784d4fad03cc41a79d96e8e81a31bd2b380/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f39313936616264392d653732332d303431372d623262652d6331323061303735333465622e706e67" alt="Screen Shot 2013-12-04 at 10.08.12 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/9196abd9-e723-0417-b2be-c120a07534eb.png"></a></p>

<p>次にそれぞれの画面で異なるホストへのsshコマンドを書きます（まだ実行しない）</p>

<p><a href="https://camo.qiitausercontent.com/4cf5a90aa7685f81eeaee0225637050fed7be91f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f34396563623961322d616430652d626133642d313362392d3836643462333366353936302e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/4cf5a90aa7685f81eeaee0225637050fed7be91f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f34396563623961322d616430652d626133642d313362392d3836643462333366353936302e706e67" alt="Screen Shot 2013-12-04 at 10.07.59 PM.png" title="Screen Shot 2013-12-04 at 10.07.59 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/49ecb9a2-ad0e-ba3d-13b9-86d4b33f5960.png"></a></p>

<p>そしておもむろにshift+command+iを押します</p>

<p><a href="https://camo.qiitausercontent.com/d0f9ca5316b6cd309cd36c2f7b980b5bfd4dce5b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f62336639336633652d323638322d656162652d333866362d3636373531363133383037632e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d0f9ca5316b6cd309cd36c2f7b980b5bfd4dce5b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f62336639336633652d323638322d656162652d333866362d3636373531363133383037632e706e67" alt="Screen Shot 2013-12-04 at 10.09.00 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/b3f93f3e-2682-eabe-38f6-66751613807c.png"></a></p>

<p>enter</p>

<p><a href="https://camo.qiitausercontent.com/a5777018e34b79ef2f2eadf60652843144fe53e1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f65313037343464302d656661382d393635632d366266332d6435623866343631666164332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a5777018e34b79ef2f2eadf60652843144fe53e1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f65313037343464302d656661382d393635632d366266332d6435623866343631666164332e706e67" alt="Screen Shot 2013-12-04 at 10.10.32 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/e10744d0-efa8-965c-6bf3-d5b8f461fad3.png"></a></p>

<p>あとは適当に実行したいコマンドを打てば複数のマシンに同時に同じコマンドを実行できます。<br>
ホスト数が増えるとダメだけど、数が少ないなら手軽で便利です。</p>

<h3>
<span id="注意" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>注意</h3>

<p>ヒューマンエラー発生率が高まるので、危険な操作はすべきではないです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />68位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>19</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/46756841237e8c6a7c31">_.templateを複数回使う時はコンパイルした方がいい</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-05 18:06:22</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Underscore.js]</b> <b>[jslitmus]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://underscorejs.org/" rel="nofollow noopener" target="_blank">underscore.js</a> には <code>_.tempalte</code> というテンプレートエンジンがついているが、これを使う時にコンパイル結果を使いまわすことができる</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s1">'&lt;span&gt;&lt;%= name %&gt;&lt;/span&gt;'</span><span class="p">;</span>

<span class="c1">// 利用後そのままコンパイル結果を捨てる</span>
<span class="nx">_</span><span class="p">.</span><span class="nx">tempalte</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'qiita'</span> <span class="p">});</span> <span class="c1">//=&gt; &lt;span&gt;qiita&lt;/span&gt;</span>

<span class="c1">// コンパイルした結果を使いまわす</span>
<span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
<span class="nx">tmpl</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">'qiita'</span><span class="p">});</span> <span class="c1">//=&gt; &lt;span&gt;qiita&lt;/span&gt;</span>
</pre></div></div>

<p>直感的にコンパイルしたものは使いまわした方がよいことは分かるが、果たしてどれくらい違うのか？<br>
測定してみた。</p>

<h2>
<span id="測定コード" class="fragment"></span><a href="#%E6%B8%AC%E5%AE%9A%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>測定コード</h2>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">underscore-tempalte-test.js</span></div>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s1">'\</span>
<span class="s1">  &lt;ul&gt;\</span>
<span class="s1">    &lt;% _.each(items, function(item) { %&gt;\</span>
<span class="s1">      &lt;li&gt;&lt;%= item %&gt;&lt;/li&gt;\</span>
<span class="s1">    &lt;% }); %&gt;\</span>
<span class="s1">  &lt;/ul&gt;'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="nx">items</span><span class="p">[</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span> <span class="p">}</span>

<span class="nx">JSLitmus</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'with compile'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="nx">tmpl</span><span class="p">({</span><span class="nx">items</span><span class="o">:</span> <span class="nx">items</span><span class="p">});</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">JSLitmus</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'without compile'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span><span class="nx">items</span><span class="o">:</span> <span class="nx">items</span><span class="p">});</span> <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>

<h2>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h2>

<p>左から Firefox, Opera, Chromeの結果</p>

<p><a href="https://camo.qiitausercontent.com/e76d05a75f6902f20bfbe6a2e91b9d96aeb671d9/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303132313230352f32303132313230353138303234342e706e673f31333534363938313731" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e76d05a75f6902f20bfbe6a2e91b9d96aeb671d9/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303132313230352f32303132313230353138303234342e706e673f31333534363938313731" alt="" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20121205/20121205180244.png?1354698171"></a></p>

<p>ちょっと洒落にならないくらい違った。2回以上使うならコンパイルして使いまわすぐらいの気持ちでいくのがよさそう。<br>
そしてやはりChromeは他の2つより純粋な JS の速度が速い。</p>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<ul>
<li><a href="http://qiita.com/items/590c11c7f87006194e2b">JSLitmusを使ってJSの性能測定をする</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />69位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>19</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/1e88b198e2b0ddb21520">コールバック関数内のthisを束縛する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2011-12-08 00:23:36</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Backbone.js]</b> <b>[AdventCalendar]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今回はBackbone.jsが依存するunderscore.jsに関する話題です。<br>
Backbone.jsに限らず、JavaScriptではコールバック関数内でthisがグローバルのwindowを差してしまうため、この問題に対処するために、以下のようにthatやselfといった変数にthisを代入してコールバック内で使うということをすることがあると思います。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">someFunc</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">;</span> <span class="c1">// window</span>
    <span class="nx">that</span><span class="p">;</span> <span class="c1">// 外側のthis</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div></div>

<p>これでもいいですが、若干面倒ですね。こんな時、ECMAScript5で導入されたbindを使えば</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">someFunc</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">;</span> <span class="c1">// 外側のthis</span>
  <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="p">}</span>
</pre></div></div>

<p>という風に書くことができますが、bindはブラウザによってはまだ実装されていなかったりするので、使うのを躊躇してしまいます。こういう時はunderscoreに定義されているbindを使えます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">someFunc</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">;</span> <span class="c1">// 外側のthis</span>
  <span class="p">},</span> <span class="k">this</span><span class="p">));</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="underscoreの便利関数を使う場合" class="fragment"></span><a href="#underscore%E3%81%AE%E4%BE%BF%E5%88%A9%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>underscoreの便利関数を使う場合</h2>

<p>underscoreにはbindだけでなくmapやforEachなどのECMA Script 5の関数を模倣した関数がいくつか定義されています。実際、これらは内部でネイティブで実装されていればそちらを使用し、なければJavaScriptで模倣するように実装されています。<br>
で、たとえばmapを使う場合でも、コールバックにthisを渡すには上記の様なthatやbindを使う必要がありますが、これらのunderscoreの関数群は関数コンテキストを渡すことができます。言葉で説明するとよくわかりませんが、つまりこういうことです。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">;</span> <span class="c1">// 外側のthis</span>
  <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">;</span> <span class="c1">// window</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div></div>

<p>ここではmapを使用していますが、他の関数も同様にコールバック関数の次にコンテキストを渡すことができるので、上手に使えば、コードを綺麗に保つことができます。<br>
もちろん、いかなる場合でもthatやselfを用いる、というのでも問題ないでしょう。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />70位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/1e6fc02d09038695f805">シェル関数とシェルコマンドの違い</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-26 13:24:24</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Zsh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>マニュアルによるとシェル関数とシェルコマンドの違いは「それを起動するシェルプロセスで実行されるか、フォークされて別プロセスで実行されるか」らしいです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% <span class="k">function</span> echo-pid-function <span class="o">{</span>
<span class="k">function</span>&gt; <span class="nb">echo</span> <span class="nv">$$</span>
<span class="k">function</span>&gt; <span class="o">}</span>
% cat <span class="s">&lt;&lt; 'EOF' &gt; echo-pid-command</span>
<span class="s">heredoc&gt; #!/bin/zsh</span>
<span class="s">heredoc&gt; echo $$</span>
<span class="s">heredoc&gt; EOF</span>
% <span class="nb">echo</span> <span class="nv">$$</span>
<span class="m">84532</span>
% echo-pid-function
<span class="m">84532</span>  <span class="c1"># シェルと同じ</span>
% ./echo-pid-command
<span class="m">84949</span>  <span class="c1"># シェルと違う</span>
</pre></div></div>

<h2>
<span id="バックグラウンドに移した場合の挙動の違い" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%82%AF%E3%82%B0%E3%83%A9%E3%82%A6%E3%83%B3%E3%83%89%E3%81%AB%E7%A7%BB%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E6%8C%99%E5%8B%95%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>バックグラウンドに移した場合の挙動の違い</h2>

<p>ctrl-zを押した時にフォアグラウンドジョブがバックグラウンドに移りますが、シェル関数はシェルと同じプロセス上で動いているので、シェル関数実行中にctrl-zすると、シェルが新しくフォークされます。<br>
この違いが特に重要なのは、バックグラウンドに移された関数内で環境変数を設定している場合です。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% <span class="k">function</span> test-func <span class="o">{</span> <span class="nv">FOO</span><span class="o">=</span><span class="s2">"bar</span><span class="si">${</span><span class="nv">FOO</span><span class="si">}</span><span class="s2">"</span> <span class="o">}</span>
% test-func<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$FOO</span>
bar
% test-func<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$FOO</span>
barbar
% test-func <span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="m">6053</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span>  + <span class="k">done</span>       test-func
% <span class="nb">echo</span> <span class="nv">$FOO</span>  <span class="c1"># barbarbar にならない</span>
barbar
</pre></div></div>

<p>ちなみにこの挙動はZsh特有で他のシェルとは異なるものなので注意が必要です。</p>

<h2>
<span id="シェル関数の利点" class="fragment"></span><a href="#%E3%82%B7%E3%82%A7%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AE%E5%88%A9%E7%82%B9"><i class="fa fa-link"></i></a>シェル関数の利点</h2>

<p>同一プロセス内で実行されることからシェル関数にはコマンドに比べて下記の利点があると言えそうです。</p>

<ul>
<li>フォークしないので処理の立ち上がりが若干速い。</li>
<li>同じプロセスから実行した全ての関数が同じプロセス上で動作するので、関数同士が簡単に環境変数を使ってやりとりができる。

<ul>
<li>コマンドの場合、プロセスが異なるので、親プロセスの環境変数を引き継ぎますが、子供で環境変数を変更してもその値は親プロセスには影響しない。</li>
</ul>
</li>
</ul>

<p>Zshの補完機能が関数で定義として実装されているのは、特に2つ目の利点の影響が大きそうです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />71位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/fed530acb97385ecbeee">git-rebaseのexecを使ってstashした内容を履歴に埋め込む</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-17 15:41:48</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>あなたはgitリポジトリでコードを書いています。</p>

<p>で、コミットをするとき「このコードはさっきのコミットと一緒にした方がいいな」と思った場合どうしますか？</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% git commit -a --amend -C HEAD
</pre></div></div>

<p>ですね？（HEADのコミットメッセージから変更がない場合）</p>

<p>では「このコードは2個前のコミットと一緒にした方がいいな」と思った場合どうしますか？一旦コミットして、あとから <code>git-rebase</code> しますか？</p>

<p>手っ取り早く済ませるには <code>git-stash</code> を使うといいでしょう。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% git stash
% git rebase -i HEAD~2
</pre></div></div>

<p>するとこんな感じの画面が表示されます。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">git-rebase後に表示される画面</span></div>
<div class="highlight"><pre><span></span>pick 45acd16 このコミットにいれたい
pick 45f6df0 一つ前のコミット
</pre></div>
</div>

<p>これを</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">execを挿入</span></div>
<div class="highlight"><pre><span></span>pick 45acd16 このコミットにいれたい
<span class="nb">exec</span> git stash pop<span class="p">;</span> git commit -a --amend -C HEAD
pick 45f6df0 一つ前のコミット
</pre></div>
</div>

<p>こんな感じに変更してエディタを閉じれば完了します。 この <code>exec</code> は後続する文字列をシェルで実行しろ、という意味です。なのでやってることは実質的に</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">git-rebase後に表示される画面</span></div>
<div class="highlight"><pre><span></span>edit 45acd16 このコミットにいれたい
pick 45f6df0 一つ前のコミット
</pre></div>
</div>

<p>して <code>edit</code> 箇所で止まってから</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% git stash pop<span class="p">;</span> git commit -a --amend -C HEAD
</pre></div></div>

<p>するのと同じです。ちなみに今回の場合 <code>exec</code> 以降を <code>;</code> で区切って二行にすると諸事情により意図した通りに動かないので注意が必要です。</p>

<div class="code-frame" data-lang="bash">
<div class="code-lang"><span class="bold">これだとダメ</span></div>
<div class="highlight"><pre><span></span>pick 45acd16 このコミットにいれたい
<span class="nb">exec</span> git stash pop
<span class="nb">exec</span> git commit -a --amend -C HEAD
pick 45f6df0 一つ前のコミット
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />72位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>18</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/5aeff2a617576b9bc6d2">複数プロセス間での排他制御</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-21 16:22:27</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>File.flock</code> を使うのが簡単、という結論に到達した。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'timeout'</span>
<span class="k">class</span> <span class="nc">AccessDenied</span> <span class="o">&lt;</span> <span class="no">StandardError</span><span class="p">;</span> <span class="k">end</span>
<span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="c1"># 10秒以内に終わらない場合はAccessDenied例外が発生</span>
  <span class="no">Timeout</span><span class="o">::</span><span class="n">timeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">open</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s1">'my-application.lock'</span><span class="p">),</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
      <span class="k">begin</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="no">File</span><span class="o">::</span><span class="no">LOCK_EX</span><span class="p">)</span>
        <span class="n">block</span><span class="o">.</span><span class="n">call</span>
      <span class="k">ensure</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="no">File</span><span class="o">::</span><span class="no">LOCK_UN</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">ex</span>
  <span class="k">raise</span> <span class="no">AccessDenied</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'timeout'</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">lock</span> <span class="k">do</span>
  <span class="c1"># 排他処理</span>
<span class="k">end</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />73位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>17</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/9aad19cf227123ace91a">Zshには組み込みでテトリスがインストールされている</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-01 23:36:40</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Zsh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://camo.qiitausercontent.com/062e9fa06fe5ba0b27b642dd3e7552c780153e74/68747470733a2f2f646c2e64726f70626f7875736572636f6e74656e742e636f6d2f752f323138343633342f696d616765732f7465747269732e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/062e9fa06fe5ba0b27b642dd3e7552c780153e74/68747470733a2f2f646c2e64726f70626f7875736572636f6e74656e742e636f6d2f752f323138343633342f696d616765732f7465747269732e676966" alt="tetris" data-canonical-src="https://dl.dropboxusercontent.com/u/2184634/images/tetris.gif"></a></p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% autoload -Uz tetris
</pre></div></div>

<p>を実行して <code>M-x tetris</code>（Macだと <code>esc+x</code> 後にtetrisと入力する。上のgifではこの方法を用いている）とするか、上記に加えて</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% zle -N tetris
% bindkey <span class="s1">'...'</span> tetris
</pre></div></div>

<p>を実行してから <code>...</code> と入力するとターミナルでテトリスを遊べます。</p>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<ul>
<li><a href="http://qiita.com/yuku_t/items/77c23390e52168a2754a" id="reference-c470d148b733e7670e3a">.zshrcで見かけるautoloadの意味と使い方</a></li>
</ul>

<p>一言で言えば <code>autoload</code> は <code>$fpath</code> のディレクトリに置いてあるzshスクリプトを関数として実行できるようにするものです。デフォルトで <code>$fpath</code> に指定されているディレクトリには800を超える関数が登録されていて（大半は補完機能のためのものですが）、その中の1つに tetris があります</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% <span class="nb">echo</span> <span class="nv">$fpath</span>
/usr/share/zsh/5.0.2/share/zsh/functions
% head -n <span class="m">7</span> /usr/share/zsh/5.0.2/share/zsh/functions/tetris
<span class="c1"># Someone once accused zsh of not being as complete as Emacs, because it</span>
<span class="c1"># lacks Tetris and an adventure game.</span>
<span class="c1">#</span>
<span class="c1"># autoload -Uz tetris</span>
<span class="c1"># zle -N tetris</span>
<span class="c1"># bindkey '...' tetris</span>
</pre></div></div>

<p>意訳</p>

<blockquote>
<p>zshにはEmacsみたいにテトリスとかアドベンチャーゲームがないからクソだって言っているやつがいたからカッとなって作った</p>
</blockquote>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />74位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>17</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/1613f1fccad7b3b0a511">実行時に標準出力がパイプされているかどうか判断するにはisattyを使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-09 14:31:04</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[MySQL]</b> <b>[tty]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>MySQLコマンドに <code>-e</code> オプションでSQLを渡すと、その結果が標準出力されますよね</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% mysql -e <span class="s1">'SELECT * FROM life;'</span>
+------------------------+
<span class="p">|</span> カルマ                 <span class="p">|</span>
+------------------------+
<span class="p">|</span> リア充爆発しろ         <span class="p">|</span>
<span class="p">|</span> 他人の不幸で飯がうまい <span class="p">|</span>
+------------------------+
</pre></div></div>

<p>でも、これをパイプで受け取ると中身が変わるんです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% mysql -e <span class="s1">'SELECT * FROM life;'</span> <span class="p">|</span> cat
カルマ
リア充爆発しろ
他人の不幸で飯がうまい
</pre></div></div>

<p>これどうやってんのかなと調べてみたら、標準出力がttyに結合してるかどうかを返す <code>isatty</code> なる関数が存在することを知りました。MySQLはこれの値を見て書きだす値を変更しているらしい。</p>

<p>で、これをRubyで書くとこんな感じで区別できる。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">isatty.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">puts</span> <span class="no">STDOUT</span><span class="o">.</span><span class="n">isatty</span>
</pre></div>
</div>

<p>実行してみる</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% ruby isatty.rb
<span class="nb">true</span>
% ruby isatty.rb <span class="p">|</span> cat
<span class="nb">false</span>
</pre></div></div>

<p>なるほどー</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />75位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>16</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/ec82601c4d4b1969becb">if elseif が連続し ||(論理和)が頻出する時はswitchが使えるかも知れない</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-05 12:40:25</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>プログラミングをしていると稀によくあるのが次のような <code>if</code> <code>else if</code> が連続する場面。特に || (論理和) が入ってくると何が何やら訳がわからなくなる。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">A</span> <span class="o">&amp;&amp;</span> <span class="nx">B</span> <span class="o">||</span> <span class="nx">C</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//1</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">D</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//2</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">E</span> <span class="o">||</span> <span class="nx">F</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//3</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">//4</span>
<span class="p">}</span>
</pre></div></div>

<p>論理式の横方向の位置を揃えるのが難しいのでコードの見た目的にも酷いことになりがち。こういう時は <code>switch</code> を使って次のように書ける</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="k">switch</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="nx">A</span> <span class="o">&amp;&amp;</span> <span class="nx">B</span><span class="o">:</span>
<span class="k">case</span> <span class="o">!!</span><span class="nx">C</span><span class="o">:</span>
  <span class="c1">//1</span>
  <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="o">!!</span><span class="nx">D</span><span class="o">:</span>
  <span class="c1">//2</span>
  <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="o">!!</span><span class="nx">E</span><span class="o">:</span>
<span class="k">case</span> <span class="o">!!</span><span class="nx">F</span><span class="o">:</span>
  <span class="c1">//3</span>
  <span class="k">break</span><span class="p">;</span>
<span class="k">default</span><span class="o">:</span>
  <span class="c1">//4</span>
<span class="p">}</span>
</pre></div></div>

<p>仕組みはいたって簡単で <code>switch(true)</code> なのでラベルが <code>true</code> ならよい。なので <code>C</code> のようBooleanじゃない可能性がある場合 <code>!!C</code> のようにして Boolean に変換してやる必要がある。<br>
いっそのこと全てのラベルを <code>!!(expr)</code> で装飾してしまうのもありか。</p>

<p>これを使えば一見複雑怪奇な <code>if</code> 文もあっさりと理解しやすくなる、、、かも知れないけど、やっぱり普通の無理に一つの論理式にしない方がいいと思う。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">A</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">B</span> <span class="o">||</span> <span class="nx">C</span><span class="p">)</span> <span class="o">||</span> <span class="nx">D</span> <span class="o">||</span> <span class="p">(</span><span class="nx">E</span> <span class="o">||</span> <span class="p">(</span><span class="nx">F</span> <span class="o">&amp;&amp;</span> <span class="nx">G</span><span class="p">))</span> <span class="o">||</span> <span class="nx">H</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//</span>
<span class="p">}</span>

<span class="k">switch</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="o">!!</span><span class="p">(</span><span class="nx">A</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">B</span> <span class="o">||</span> <span class="nx">C</span><span class="p">))</span><span class="o">:</span>
<span class="k">case</span> <span class="o">!!</span><span class="nx">D</span><span class="o">:</span>
<span class="k">case</span> <span class="o">!!</span><span class="p">(</span><span class="nx">E</span> <span class="o">||</span> <span class="p">(</span><span class="nx">F</span> <span class="o">&amp;&amp;</span> <span class="nx">G</span><span class="p">))</span><span class="o">:</span>
<span class="k">case</span> <span class="o">!!</span><span class="nx">H</span><span class="o">:</span>
  <span class="c1">//</span>
<span class="p">}</span>

<span class="nx">a</span> <span class="o">=</span> <span class="nx">A</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">B</span> <span class="o">||</span> <span class="nx">C</span><span class="p">);</span>
<span class="nx">b</span> <span class="o">=</span> <span class="nx">E</span> <span class="o">||</span> <span class="p">(</span><span class="nx">F</span> <span class="o">&amp;&amp;</span> <span class="nx">G</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">||</span> <span class="nx">D</span> <span class="o">||</span> <span class="nx">b</span> <span class="o">||</span> <span class="nx">H</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// これのほうがよさそう</span>
<span class="p">}</span>
</pre></div></div>

<p>ちなみに、最後のやつは本質的には上の２つと挙動が異なる。それは <code>b</code> に代入するときに <code>E || (F &amp;&amp; G)</code> が評価されている点だ。もし <code>a</code> が真なら本来は評価されないはずのものが評価されてしまっている。仮に <code>b</code> がかなり重たい処理を含むとするとパフォーマンスの低下につながらないとはいいきれない。もしくは何かしらの破壊的な変更を含む場合は、最後の方法をとることはできない。</p>

<p>以下は論理的に同じだけど冗長過ぎる気がする</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">A</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">B</span> <span class="o">||</span> <span class="nx">C</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// 全て</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">D</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 同じ</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">E</span> <span class="o">||</span> <span class="p">(</span><span class="nx">F</span> <span class="o">&amp;&amp;</span> <span class="nx">G</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// 処理を</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">H</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 行う</span>
<span class="p">}</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />76位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/d57415e96f716c10b016">&gt;fname 2&gt;&amp;1がこの順番でないといけない理由</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-26 00:48:37</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[ShellScript]</b> <b>[Zsh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>標準出力と標準エラー出力を両方とも同じファイルにリダイレクトする場合、次のように書きます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>..<span class="o">(</span>何かのコマンド<span class="o">)</span>.. &gt; fname <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>  
</pre></div></div>

<p>これを間違えて逆にしてしまうと、標準エラー出力の内容が標準出力され（つまりターミナルに普通に表示される）、標準出力がファイルにリダイレクトされます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>... <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> &gt; fname
</pre></div></div>

<p>なかなか覚え難いんですが、理屈がわかってしまえば当然の結果です。rubyで言えばこういうことです。</p>

<p>1つ目の場合、先に標準出力を外部ファイルを参照するように変更してから、標準エラー出力にもそれをコピーします。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># ... &gt; fname 2&gt;&amp;1</span>
<span class="vg">$stdout</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'fname'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span>
<span class="vg">$stderr</span> <span class="o">=</span> <span class="vg">$stdout</span>
<span class="c1"># $stderr と $stdout は同じものを指している</span>
</pre></div></div>

<p>2つ目の場合、標準エラー出力を標準出力が参照している内容に向けてから、標準出力の方向を変更します。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># ... 2&gt;&amp;1 &gt; fname</span>
<span class="vg">$stderr</span> <span class="o">=</span> <span class="vg">$stdout</span>
<span class="vg">$stdout</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'fname'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span>
<span class="c1"># $stderr と $stdout は別のものを指している</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />77位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/8049cd07120d49d40ef7">XMLHttpRequestを途中で止める</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-13 00:55:51</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>XMLHttpRequestを完了する前に途中で中断させるには <code>abort()</code> を実行します。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'…'</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
</pre></div></div>

<p>jQueryの場合も同様に <code>abort()</code> を使います。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">jqXHR</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="s1">'…'</span> <span class="p">});</span>
<span class="nx">jqXHR</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
</pre></div></div>

<h1>
<span id="タイムアウトを実装する" class="fragment"></span><a href="#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>タイムアウトを実装する</h1>

<p>具体的な利用場面としては、XHRにタイムアウトを設定したい場合。普通にしているとタイムアウトするまでに60秒待たされたりするので、それを例えば10秒でタイムアウトさせたい場合はこんな感じで書けます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// XMLHttpRequestを発行する</span>
<span class="kd">var</span> <span class="nx">jqXHR</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="s1">'…'</span> <span class="p">});</span>
<span class="nx">jqXHR</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Fail'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 10秒後まだpendingだったらabortする。</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">jqXHR</span><span class="p">.</span><span class="nx">state</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'pending'</span><span class="p">)</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
<span class="p">},</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
</pre></div></div>

<p><code>fail()</code> はXHR通信に失敗したときに実行される関数を登録するものですが、 <code>abort()</code> 時も実行されます。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />78位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/5f85ffc1a0b89c8cc24a">vim-powerlineをpowerlineにアップデートする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-01-20 02:36:34</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[Mac]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://lokaltog.github.com/powerline/" rel="nofollow noopener" target="_blank">Powerline — Powerline beta documentation</a></p>

<p>一時話題になった <a href="https://github.com/Lokaltog/vim-powerline" rel="nofollow noopener" target="_blank">Lokaltog/vim-powerline</a> は現在 <a href="https://github.com/Lokaltog/powerline" rel="nofollow noopener" target="_blank">Lokaltog/powerline</a> に置き換わっているらしい。<br>
そしてPython製になったので+pythonが必要。というわけでMacにVimを入れなおした。気分で+rubyもつけてみた。あとpowerlineは--with-feature=bigが必要らしい。</p>

<div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">install</span></div>
<div class="highlight"><pre><span></span>brew install https://gist.github.com/raw/3423922/6ebf1005ff68d4791f35f03f4d33940c243cbd70/vim.rb --HEAD --enable-interp<span class="o">=</span>ruby,python --with-feature<span class="o">=</span>big --force
pip install --user https://github.com/Lokaltog/powerline/tarball/develop
</pre></div>
</div>

<p>これで新しくなった powerline を使えるようになった。どんな新機能があるのかはこれから試してみる。</p>

<h2>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h2>

<p>vim-powerline から powerline への変更点</p>

<ul>
<li>vim プラグインだけじゃなくなった

<ul>
<li>bash, zsh のプロンプト</li>
<li>tmux のステータスバー</li>
</ul>
</li>
</ul>

<p>ということのよう。そして現在はまだβ版ということもあって Mac + iTerm2 な環境で動作させるには最新のiTerm2よりさらに新しい（つまり自分でビルドしないといけない）バージョンが必要。</p>

<p>なのでおとなしく昔のvim-powerlineに戻した。<br>
戻し方は <a href="https://github.com/Lokaltog/vim-powerline" rel="nofollow noopener" target="_blank">Lokaltog/vim-powerline</a> の develop ブランチを利用するだけ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />79位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>15</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/34250967a9e1a86723a8">bootstrapに適したページャをJSで手軽に作る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-06-26 22:15:47</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[bootstrap]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://gist.github.com/4306339" class="autolink" rel="nofollow noopener" target="_blank">https://gist.github.com/4306339</a></p>

<p>railsならkaminariとか使えば簡単にページャを作れますが、そういうリッチな道具が無い時、色々と気の利いたページャを作るのは面倒なので、JavaScriptで良い感じにしてくれるのを作った。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"jquery.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"bootstrap-pagination.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"pagination"</span>
  <span class="na">data-page</span><span class="o">=</span><span class="s">"5"</span>
  <span class="na">data-last</span><span class="o">=</span><span class="s">"10"</span>
  <span class="na">data-inner</span><span class="o">=</span><span class="s">"2"</span>
  <span class="na">data-outer</span><span class="o">=</span><span class="s">"3"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'.pagination'</span><span class="p">).</span><span class="nx">pagination</span><span class="p">();</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div></div>

<p>するとtwitter-bootstrapのページャのCSSに適したHTMLを良い感じに作ってくれる。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />80位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>13</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/ccfc7dbab9ce8206fdc2">AutomatorでExcelで正しく開けるcsvに変換する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-28 17:47:06</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> <b>[Excel]</b> <b>[Automator]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>詳しい事情は<a href="http://qiita.com/mashiro/items/0d0b9bbb0f4a6cca620c" id="reference-713f7a8f25d6b13472d3">Win/Mac どちらの Excel でも正しく開ける Unicode な csv の出力方法</a>を参照して欲しいのだけど、MacのExcelでUnicodeなcsvを適切に開くにはUTF-16LEなtsvにしなければなりません。</p>

<p>どうしてもUTF-8なcsvを吐き出すサービスがあり、毎回変換するのが面倒なのでAutomatorで自動化しました。</p>

<h3>
<span id="1-nkfをインストール" class="fragment"></span><a href="#1-nkf%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>1. nkfをインストール</h3>

<p>文字コードの変換に <a href="http://sourceforge.jp/projects/nkf/" rel="nofollow noopener" target="_blank">nkf</a> を使うのでインストールします。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>brew install nkf
</pre></div></div>

<h3>
<span id="2-automatorを起動してサービスを作る" class="fragment"></span><a href="#2-automator%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%A6%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>2. Automatorを起動してサービスを作る</h3>

<p><a href="https://camo.qiitausercontent.com/c539baf15045cc6286e7605618a7064ae78b52e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f31613566653436342d636239352d343531642d323366372d3665633764326466633935332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/c539baf15045cc6286e7605618a7064ae78b52e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f31613566653436342d636239352d343531642d323366372d3665633764326466633935332e706e67" alt="Screen Shot 2013-11-28 at 5.36.31 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/1a5fe464-cb95-451d-23f7-6ec7d2dfc953.png"></a></p>

<h3>
<span id="3-utilitiesのrun-shell-scriptをドラッグドロップ" class="fragment"></span><a href="#3-utilities%E3%81%AErun-shell-script%E3%82%92%E3%83%89%E3%83%A9%E3%83%83%E3%82%B0%E3%83%89%E3%83%AD%E3%83%83%E3%83%97"><i class="fa fa-link"></i></a>3. UtilitiesのRun Shell Scriptをドラッグドロップ</h3>

<p><a href="https://camo.qiitausercontent.com/e599e8d7a4798907a5df6c96468d33fe8d6e82f2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f34613761356166612d616464312d636565302d393164382d6561643330386631633365662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/e599e8d7a4798907a5df6c96468d33fe8d6e82f2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f34613761356166612d616464312d636565302d393164382d6561643330386631633365662e706e67" alt="Screen Shot 2013-11-28 at 5.41.14 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/4a7a5afa-add1-cee0-91d8-ead308f1c3ef.png"></a></p>

<h3>
<span id="4-pass-input-as-argumentsを選択してコードを書く" class="fragment"></span><a href="#4-pass-input-as-arguments%E3%82%92%E9%81%B8%E6%8A%9E%E3%81%97%E3%81%A6%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>4. Pass input: as argumentsを選択してコードを書く</h3>

<p><a href="https://camo.qiitausercontent.com/42f4dec8cac0dc55a254d96132426f714f1af06a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f38313661323862652d393131642d383935392d346637622d6138393332376537396134342e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/42f4dec8cac0dc55a254d96132426f714f1af06a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f38313661323862652d393131642d383935392d346637622d6138393332376537396134342e706e67" alt="Screen Shot 2013-11-28 at 5.37.27 PM.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/816a28be-911d-8959-4f7b-a89327e79a44.png"></a></p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="k">for</span> file
<span class="k">do</span>
    ruby -Ku -e <span class="s2">"require 'csv';CSV.foreach('</span><span class="nv">$file</span><span class="s2">', 'r') { |r| puts r.join(\"\t\") }"</span> &gt; <span class="si">${</span><span class="nv">file</span><span class="si">}</span>-tmp
    /usr/local/bin/nkf -w16 <span class="si">${</span><span class="nv">file</span><span class="si">}</span>-tmp &gt; <span class="nv">$file</span>
    rm <span class="si">${</span><span class="nv">file</span><span class="si">}</span>-tmp
<span class="k">done</span>
</pre></div></div>

<p>画面上のService receives selectedをdocumentsに変更する。<br>
あと終わったことを知らせるために何か選ぶ。ここでは'Display Notification'を使ってる。<br>
画像の中でnkfの位置が/opt/boxenの中になっているのは、僕のMacはBoxenを使ってセットしているため。より正確には下記を実行するとクリップボードに入るものをペーストするといいです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>which nkf <span class="p">|</span> pbcopy
</pre></div></div>

<h3>
<span id="5-保存する" class="fragment"></span><a href="#5-%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>5. 保存する</h3>

<p>⌘+Sを押して適当な名前をつける。ここではutf16て名前にした。</p>

<h3>
<span id="6-適当なファイルを選択して右クリック" class="fragment"></span><a href="#6-%E9%81%A9%E5%BD%93%E3%81%AA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E9%81%B8%E6%8A%9E%E3%81%97%E3%81%A6%E5%8F%B3%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>6. 適当なファイルを選択して右クリック</h3>

<p><a href="https://camo.qiitausercontent.com/339b327ab1462b4da121b293b9d27b95e52b6cdb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f33336161663131332d353438352d363532642d636532372d6530383164636531336432652e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/339b327ab1462b4da121b293b9d27b95e52b6cdb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3135332f33336161663131332d353438352d363532642d636532372d6530383164636531336432652e706e67" alt="Untitled.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/153/33aaf113-5485-652d-ce27-e081dce13d2e.png"></a></p>

<p>出てきたutf16をクリックしたら終わり。あとはExcelで開くだけ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />81位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>13</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/6b2f3a0b2025bb360da3">fugitiveの:Gblameで更に過去にさかのぼる方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-16 00:05:33</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>:Gblame</code> で <code>git-blame</code> の結果を表示できますが、ある行が変更されるその前の状態を表示したい場合は、その行にカーソルを移動させて <code>~</code> を押します。すると、その行を変更したcommitのsha1が012345だったとすると、 <code>git blame 012345^ -- file</code> を実行したような結果がvimdiffで表示されます。</p>

<p>ちなみに <code>~</code> は <code>[count]</code> を受け取るので <code>3~</code> は <code>git blame 012345^^^ - file</code> になります。また <code>-</code> は <code>git blame 012345 -- file</code> です。便利</p>

<h3>
<span id="tips-空白差分だけの変更を無視する" class="fragment"></span><a href="#tips-%E7%A9%BA%E7%99%BD%E5%B7%AE%E5%88%86%E3%81%A0%E3%81%91%E3%81%AE%E5%A4%89%E6%9B%B4%E3%82%92%E7%84%A1%E8%A6%96%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>tips: 空白差分だけの変更を無視する</h3>

<p>そもそも <code>~</code> が必要になる場面というのは、blameで得られた差分がインデントの変更みたいな、実質中身のない変更の場合のことも多いです。 <code>git-blame</code> は <code>-w</code> オプションでそういった空白のみの変更を無視してくれるので便利です。 <code>:Gblame w</code> で同様になります。 <code>:Gblame</code> を使うときはとりあえず <code>w</code> フラグを渡しとくといいかも知れません。</p>

<p>他のフラグや使い方については <code>:help fugitive-:Gblame</code> を参照してください。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />82位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/451f007c864090a9cc70">Closure Libraryを使ったJSファイル間の依存関係の記述 </a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-09 01:18:41</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Closure]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://developers.google.com/closure/library/" rel="nofollow noopener" target="_blank">Google Closure Library</a>の依存関係解決ツールは非常に便利。</p>

<h2>
<span id="closure-libraryのインストール" class="fragment"></span><a href="#closure-library%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>Closure Libraryのインストール</h2>

<ul>
<li><a href="http://code.google.com/p/closure-library/downloads/list" class="autolink" rel="nofollow noopener" target="_blank">http://code.google.com/p/closure-library/downloads/list</a></li>
</ul>

<p>ファイルをダウンロードしたら解凍しアプリケーションのpublicディレクトリに設置する。ここでいうpublicディレクトリに設置するというのは</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>application
`-- public
    `-- javascripts
        |-- closure-library
        |   |-- closure
        |   |   |-- bin
        |   |   |   `-- build
        |   |   |       |-- closurebuilder.py
        |   |   |       `-- depswriter.py
        |   |   `-- goog
        |   |       `-- base.js
        |   `-- third_party
        `-- myapp
            |-- base.js
            `-- main.js
</pre></div></div>

<p>のようになっているとしてpublicディレクトリ以下のファイル間のファイルシステム上での相対位置とURIとしての相対位置が同じになることを意味する。</p>

<h2>
<span id="依存関係の記述" class="fragment"></span><a href="#%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%81%AE%E8%A8%98%E8%BF%B0"><i class="fa fa-link"></i></a>依存関係の記述</h2>

<p>Railsのassetsパイプラインにはファイル間の依存関係を書く事ができるが、Closure Libraryではファイル単位ではなくObject単位での依存関係を記述することができる。</p>

<p>使うのは<code>goog.provide</code>と<code>goog.require</code>。これら自体は<code>closure-library/closure/goog/base.js</code>に定義されている。一つのファイルが提供・要求するオブジェクトの数に制限は無い。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// base.js</span>
<span class="nx">goog</span><span class="p">.</span><span class="nx">provide</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span> <span class="c1">// 提供するオブジェクトの宣言</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// main.js</span>
<span class="nx">goog</span><span class="p">.</span><span class="nx">provide</span><span class="p">(</span><span class="s1">'app.run'</span><span class="p">)</span> <span class="c1">// 提供するオブジェクトの宣言</span>

<span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span> <span class="c1">// 必要とするオブジェクトの宣言</span>

<span class="kd">var</span> <span class="nx">app</span><span class="p">;</span>

<span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">version</span><span class="p">)</span> <span class="c1">// =&gt; 1</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="依存ファイルの生成" class="fragment"></span><a href="#%E4%BE%9D%E5%AD%98%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>依存ファイルの生成</h2>

<p><code>goog.provide</code>と<code>goog.require</code>から依存関係を抽出する。これにはdepswriter.pyというスクリプトを使う。通常この結果をdeps.jsという名前で保存する。(Closure Library内部の依存関係はclocure-libaray/closure/goog/deps.jsに保存されており、goog/base.jsが読み込まれると自動でこちらも読み込まれるようになっている。)</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% python public/javascripts/closure-library/closure/bin/build/depswriter.py <span class="se">\</span>
  --root_with_prefix<span class="o">=</span><span class="s1">'public/javascripts/myapp ../../../myapp'</span> <span class="se">\</span>
  --output_file<span class="o">=</span>public/javascripts/myapp/deps.js
</pre></div></div>

<p><code>root_with_prefix</code>オプションで自分のJSコードの絶対パスとgoog/base.jsからの相対パスを指定する。間にスペースが一つ入っているのに注意。この指定されたディレクトリ以下のファイルが全て調べられ<code>output_file</code>ディレクトリに結果が保存される。</p>

<p>今回の場合deps.jsは次のようになる</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="c1">// This file was autogenerated by public/javascripts/closure/bin/build/depswriter.py.</span>
<span class="c1">// Please do not edit.</span>
<span class="nx">goog</span><span class="p">.</span><span class="nx">addDependency</span><span class="p">(</span><span class="s1">'../../../myapp/base.js'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'app'</span><span class="p">],</span> <span class="p">[]);</span>
<span class="nx">goog</span><span class="p">.</span><span class="nx">addDependency</span><span class="p">(</span><span class="s1">'../../../myapp/main.js'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'app.run'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'app'</span><span class="p">]);</span>
</pre></div></div>

<h2>
<span id="ブラウザで実行する開発時" class="fragment"></span><a href="#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%A7%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E9%96%8B%E7%99%BA%E6%99%82"><i class="fa fa-link"></i></a>ブラウザで実行する(開発時)</h2>

<p>goog/base.jsと先ほど作ったdeps.jsと起点となるファイルを読み込む</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>myapp<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"javascripts/closure-library/closure/goog/base.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"javascripts/myapp/deps.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"javascripts/myapp/main.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">run</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<p>この場合main.jsが読み込まれるとClosure Libraryが自動的に依存しているbase.jsを読み込む。</p>

<h2>
<span id="ソースコードを一つにまとめる" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E4%B8%80%E3%81%A4%E3%81%AB%E3%81%BE%E3%81%A8%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>ソースコードを一つにまとめる</h2>

<p>本番環境ではソースコードを一つにまとめたい。この用途にはclosurebuilder.pyを使う</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% python public/javascripts/closure-library/closure/bin/build/closurebuilder.py <span class="se">\</span>
  --root<span class="o">=</span>public/javascripts <span class="se">\</span>
  --namespace<span class="o">=</span>app.run <span class="se">\</span>
  --output_file<span class="o">=</span>public/javascripts/myapp.js <span class="se">\</span>
  --output_mode<span class="o">=</span>script
</pre></div></div>

<p><code>namespace</code>オプションで起点となるオブジェクトを指定する。今回ならmain.jsに提供しているので、このファイルを起点にして依存するファイルをまとめていく。<br>
myapp.jsというJSファイルが生成されているので、これをブラウザで読みこめばいい。下記はファイルの読み込みが一回で済む分だけ、前の例より効率がいい。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>myapp<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"javascripts/myapp.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">run</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="ソースコードを圧縮する" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E5%9C%A7%E7%B8%AE%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ソースコードを圧縮する</h2>

<p>JSファイルを圧縮するツールはいくつかあるが、ここでは<a href="http://code.google.com/closure/compiler/" rel="nofollow noopener" target="_blank">Google Closure Compiler</a>を使う。ダウンロードして解凍すると中にcompiler.jarがあるので適当な場所に設置する。上で使ったclosurebuilder.pyにはオプションでコンパイル時にClosure Compilerで圧縮するオプションがある。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% python public/javascripts/closure-library/closure/bin/build/closurebuilder.py <span class="se">\</span>
  --root<span class="o">=</span>public/javascripts <span class="se">\</span>
  --namespace<span class="o">=</span>app.run <span class="se">\</span>
  --output_file<span class="o">=</span>public/javascripts/myapp.js <span class="se">\</span>
  --output_mode<span class="o">=</span>compiled <span class="se">\</span>
  --compiler_jar<span class="o">=</span>path/to/compiler.jar <span class="se">\</span>
  --compiler_flags<span class="o">=</span><span class="s1">'--compilation_level=ADVANCED_OPTIMIZATIONS'</span>
</pre></div></div>

<p><code>compiler_jar</code>オプションで先程のcompiler.jarを指定する。<code>compiler_flags</code>は圧縮レベルで<code>WHITESPACE_ONLY</code> <code>SIMPLE_OPTIMIZATIONS</code> <code>ADVANCED_OPTIMIZATIONS</code>の三つの中から選ぶ。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />83位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/42bec1363ab10ec4dee6">Pythonの-mオプションを使えばフィルターの管理が楽</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-02-23 11:54:20</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Pythonの起動時に-mオプションとモジュール名を渡すと、そのモジュールを起動できる。<br>
例えば組み込みモジュールの <code>json.tool</code> は以下のようにjsonを文字列で受け取って整形して出力してくれる。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% <span class="nb">echo</span> <span class="s1">'{"json":"obj"}'</span> <span class="p">|</span> python -m json.tool
<span class="o">{</span>
    <span class="s2">"json"</span>: <span class="s2">"obj"</span>
<span class="o">}</span>
% <span class="nb">echo</span> <span class="s1">'{ 1.2:3.4}'</span> <span class="p">|</span> python -m json.tool
Expecting property name: line <span class="m">1</span> column <span class="m">2</span> <span class="o">(</span>char <span class="m">2</span><span class="o">)</span>
</pre></div></div>

<p>これを使ってよく使うフィルターを管理すると便利。<br>
まず <code>PYTHONPATH</code> 環境変数に適当なディレクトリを追加するように <code>.bashrc</code> なり <code>.zshrc</code> なりに記述する。ここでは <code>$HOME/pythonpath</code> とする。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$HOME</span>/pythonpath:<span class="nv">$PYTHONPATH</span>
</pre></div></div>

<p>つぎに <code>$HOME/pythonpath/filter</code> みたいなモジュールを作る。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>% mkdir -p ~/pythonpath/filter
% touch ~/pythonpath/__init__.py ~/pythonpath/filter/__init__.py
</pre></div></div>

<p>これであとは <code>$HOME/pythonpath/filter</code> 内にPythonスクリプトを置けば、簡単にそれを呼び出せる。<br>
例えば、<code>$HOME/pythonpath/filter/hoge.py</code> というスクリプトなら <code>python -m filter.hoge</code> 。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />84位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>11</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/5aa7d91bc27096748f74">jQuery.fn.cssで複数のプロパティに取得する場合1.9からは配列指定した方がいい</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-10-02 11:21:39</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[jQuery]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>jQuery.fn.css</code> はHTML要素の任意のCSSプロパティの値を取得します。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">'#sample'</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">'padding-left'</span><span class="p">);</span>  <span class="c1">// =&gt; #sample 要素の padding-left の値が返される</span>
</pre></div></div>

<p>1.以前は <code>jQuery.fn.css</code> は一度に1つのプロパティしか取得できませんでしたが、1.9からは配列を渡すことで一度に取得することができます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#sample'</span><span class="p">).</span><span class="nx">css</span><span class="p">([</span><span class="s1">'padding-left'</span><span class="p">,</span> <span class="s1">'padding-right'</span><span class="p">]);</span>
<span class="nx">props</span><span class="p">[</span><span class="s1">'padding-left'</span><span class="p">];</span>  <span class="c1">// =&gt; #sample の padding-left</span>
<span class="nx">props</span><span class="p">[</span><span class="s1">'padding-right'</span><span class="p">];</span>  <span class="c1">// =&gt; #sample の padding-right</span>
</pre></div></div>

<h2>
<span id="パフォーマンス" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>パフォーマンス</h2>

<p><code>jQuery.fn.css</code> は内部的に <code>window.getComputedStyle</code> を使っています。配列を使った指定の場合 <code>jQuery</code> のメソッド呼び出しの回数が抑制されることに加えて、内部関数の実行回数も抑制されるのでパフォーマンスが良いようです。</p>

<ul>
<li><a href="https://github.com/yuku-t/jquery-textcomplete/pull/7#issuecomment-24409630" rel="nofollow noopener" target="_blank">Add utility function named getStyles by ykzts · Pull Request #7 · yuku-t/jquery-textcomplete</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />85位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>11</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/161491a6a324bda3835b">JSのテストファイルを複数のブラウザで開いて手軽に確認する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-04 19:04:28</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[JavaScript]</b> <b>[Mac]</b> <b>[AppleScript]</b> <b>[Makefile]</b> <b>[qunit]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h1>
<span id="背景" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>背景</h1>

<ul>
<li>JavaScriptのテスト・ツールである <a href="http://qunitjs.com/" rel="nofollow noopener" target="_blank">Qunit</a> を使ってテストを書いた</li>
<li>できれば複数のブラウザでテストを実行して確認したい</li>
<li>でもいちいちブラウザを操作して回るのは面倒くさい</li>
<li>ブラウザは互いに重なり合わずに並んで欲しい（でないと結果が見れない）</li>
</ul>

<p>これをコマンド一発でできるようにする</p>

<h1>
<span id="どうなったか" class="fragment"></span><a href="#%E3%81%A9%E3%81%86%E3%81%AA%E3%81%A3%E3%81%9F%E3%81%8B"><i class="fa fa-link"></i></a>どうなったか</h1>

<p>こんな感じになった。 端末で <code>make</code> を実行するとブラウザがもりもり立ち上がって綺麗に勝手に整列してくれる</p>

<p><a href="https://camo.qiitausercontent.com/5343b800eb2d3f2484280a17e16a0a281e0c10b1/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303132313230342f32303132313230343138343934332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/5343b800eb2d3f2484280a17e16a0a281e0c10b1/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f792f79756b755f742f32303132313230342f32303132313230343138343934332e706e67" alt="" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yuku_t/20121204/20121204184943.png"></a></p>

<h1>
<span id="やり方" class="fragment"></span><a href="#%E3%82%84%E3%82%8A%E6%96%B9"><i class="fa fa-link"></i></a>やり方</h1>

<p>まずAppleScript Editorを開いて下記を記述し、名前をつけて保存で Application として保存する。仮にresize.appという名前で保存したとする。</p>

<p>簡単に説明するとまず画面の大きさを取得して、そのあと各ブラウザの大きさと位置を調整している。</p>

<div class="code-frame" data-lang="applescript"><div class="highlight"><pre><span></span><span class="k">tell</span> <span class="nb">application</span> <span class="s2">"Finder"</span>
    <span class="k">set</span> <span class="nv">s</span> <span class="k">to</span> <span class="na">bounds</span> <span class="k">of</span> <span class="na">window</span> <span class="k">of</span> <span class="nv">desktop</span>
    <span class="k">set</span> <span class="err">_width</span> <span class="k">to</span> <span class="nb">item</span> <span class="mi">3</span> <span class="k">of</span> <span class="nv">s</span>
    <span class="k">set</span> <span class="err">_height</span> <span class="k">to</span> <span class="nb">item</span> <span class="mi">4</span> <span class="k">of</span> <span class="nv">s</span>
<span class="k">end</span> <span class="k">tell</span>
<span class="k">tell</span> <span class="nb">application</span> <span class="s2">"System Events"</span>
    <span class="k">try</span>
        <span class="k">tell</span> <span class="nv">process</span> <span class="s2">"Firefox"</span>
            <span class="k">tell</span> <span class="na">window</span> <span class="mi">1</span>
                <span class="k">set</span> <span class="na">size</span> <span class="k">to</span> <span class="p">{</span><span class="err">_width</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="err">_height</span><span class="p">}</span>
                <span class="k">set</span> <span class="na">position</span> <span class="k">to</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">end</span> <span class="k">tell</span>
        <span class="k">end</span> <span class="k">tell</span>
    <span class="k">end</span> <span class="k">try</span>
    <span class="k">try</span>
        <span class="k">tell</span> <span class="nv">process</span> <span class="s2">"Chrome"</span>
            <span class="k">tell</span> <span class="na">window</span> <span class="mi">1</span>
                <span class="k">set</span> <span class="na">size</span> <span class="k">to</span> <span class="p">{</span><span class="err">_width</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="err">_height</span><span class="p">}</span>
                <span class="k">set</span> <span class="na">position</span> <span class="k">to</span> <span class="p">{</span><span class="err">_width</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">end</span> <span class="k">tell</span>
        <span class="k">end</span> <span class="k">tell</span>
    <span class="k">end</span> <span class="k">try</span>
    <span class="k">try</span>
        <span class="k">tell</span> <span class="nv">process</span> <span class="s2">"Opera"</span>
            <span class="k">tell</span> <span class="na">window</span> <span class="mi">1</span>
                <span class="k">set</span> <span class="na">size</span> <span class="k">to</span> <span class="p">{</span><span class="err">_width</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="err">_height</span><span class="p">}</span>
                <span class="k">set</span> <span class="na">position</span> <span class="k">to</span> <span class="p">{</span><span class="err">_width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">end</span> <span class="k">tell</span>
        <span class="k">end</span> <span class="k">tell</span>
    <span class="k">end</span> <span class="k">try</span>
<span class="k">end</span> <span class="k">tell</span>
</pre></div></div>

<p>そして Makefile を下記のようにする。 tests/index.html というのが Qunit のファイルでこれを表示すればテストが勝手に実行される状態になっている。 <code>open</code> は <code>-a</code> オプションで起動するアプリケーションを指定できる。</p>

<div class="code-frame" data-lang="Makefile">
<div class="code-lang"><span class="bold">Makefile</span></div>
<div class="highlight"><pre><span></span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">test</span>

<span class="nf">test</span><span class="o">:</span>
    @open tests/index.html -a Firefox
    @open tests/index.html -a Google<span class="se">\ </span>Chrome
    @open tests/index.html -a Opera
    @open resize.app
</pre></div>
</div>

<p>これで <code>make</code> をすればブラウザが綺麗に整列した状態でテストが確認できる</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />86位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/dc2caaad045226aa7bfd">class構文でprivateなメソッドを定義する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-01-30 16:47:16</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[CoffeeScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nx">Hoge</span>
  <span class="nv">private_ = </span><span class="nf">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">'private'</span>

  <span class="nv">public_: </span><span class="nf">-&gt;</span>
    <span class="nx">private_</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
</pre></div></div>

<p><code>private_</code>はそのまま呼び出すのではなく<code>call</code>や<code>apply</code>を使わないとprivateメソッドぽくならない。<br>
コンパイルすると</p>

<div class="code-frame" data-lang="javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Hoge</span><span class="p">,</span> <span class="nx">hoge</span><span class="p">;</span>

<span class="nx">Hoge</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">private_</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Hoge</span><span class="p">()</span> <span class="p">{}</span>

  <span class="nx">private_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'private'</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Hoge</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">public_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">private_</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Hoge</span><span class="p">;</span>
<span class="p">})();</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />87位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>9</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/9ef8d3da32ca993b5699">Unicorn worker毎にRailsログを別ファイルに書き出す</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-24 23:21:34</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[unicorn]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Unicornで複数のRailsプロセスを動かしていると同じproduction.logにログが書きだされます。その結果ログの中身が混ざって後からみたとき何がなにやら訳がわからない感じになります。ログは人力で見るものじゃないという声もあるかと思いますが、解析器に書けたときの揺れも大きくなってしまいます。ワーカー数が増えてくると尚更辛い感じです。</p>

<h1>
<span id="分割する" class="fragment"></span><a href="#%E5%88%86%E5%89%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>分割する</h1>

<p>config/unicorn.rb の <code>after_fork</code> の中でこんな感じに書いておくとワーカー毎にログが別々に出力されるようになります。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/unicorn.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">after_fork</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
  <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="k">begin</span>
    <span class="n">path</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">paths</span><span class="o">[</span><span class="s2">"log"</span><span class="o">].</span><span class="n">first</span>
    <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">".log"</span><span class="p">,</span> <span class="s2">"-</span><span class="si">#{</span><span class="n">worker</span><span class="o">.</span><span class="n">nr</span><span class="si">}</span><span class="s2">.log"</span><span class="p">),</span> <span class="s2">"a"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">binmode</span>
    <span class="n">f</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">autoflush_log</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="o">.</span><span class="n">new</span> <span class="n">f</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">log_formatter</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TaggedLogging</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">logger</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h1>
<span id="参考リンク" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF"><i class="fa fa-link"></i></a>参考リンク</h1>

<ul>
<li><a href="https://github.com/rails/rails/blob/v4.0.2/railties/lib/rails/application/bootstrap.rb#L32-L54" rel="nofollow noopener" target="_blank">Rails 4.0.2におけるロガー設定</a></li>
<li><a href="http://stackoverflow.com/questions/5551660/how-to-make-each-unicorn-worker-of-my-rails-application-log-to-a-different-file" rel="nofollow noopener" target="_blank">Rails 3でのやりかた</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />88位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>9</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/75b35795132ff0329350">外部コマンドの標準出力を端末の標準出力に流す</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-04 19:15:00</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>こう言う風に、少しずつ結果が標準出力に流れてくるコマンドがあるとします。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">test.rb</span></div>
<div class="highlight"><pre><span></span><span class="mi">5</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
  <span class="nb">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">2</span>
  <span class="nb">puts</span> <span class="n">i</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% ruby test.rb <span class="c1"># 0.2秒間隔で現れる</span>
<span class="m">0</span>
<span class="m">1</span>
<span class="m">2</span>
<span class="m">3</span>
<span class="m">4</span>
</pre></div></div>

<p>これをRubyから外部コマンドとして普通に実行すると、コマンドが全て完了してからいっきに結果が得られます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="sx">% ruby </span><span class="o">-</span><span class="n">e</span> <span class="s1">'puts `ruby test.rb`'</span> <span class="c1"># 1秒後に一気に現れる</span>
<span class="mi">0</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mi">3</span>
<span class="mi">4</span>
</pre></div></div>

<p>Rubyからそのコマンドの結果を受け取りたい場合はこれでもよいですが、例えばスクリプトからRakeタスクを実行するような場合は、標準出力に遅延なく流して欲しいです。<code>Open3.pipeline</code> 使うとそれができます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="sx">% ruby </span><span class="o">-</span><span class="n">r</span> <span class="n">open3</span> <span class="o">-</span><span class="n">e</span> <span class="s1">'Open3.pipeline("ruby test.rb")'</span> <span class="c1"># 0.2秒間隔で現れる</span>
<span class="mi">0</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mi">3</span>
<span class="mi">4</span>
</pre></div></div>

<p>サブプロセスを立ち上げてその標準出力を自分の標準出力につなげているだけなので、色などもそのまま表示されます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% cat test.zsh
autoload -U colors<span class="p">;</span> colors
<span class="nb">echo</span> <span class="si">${</span><span class="nv">fg</span><span class="p">[green]</span><span class="si">}</span>green
sleep <span class="m">0</span>.2
<span class="nb">echo</span> <span class="si">${</span><span class="nv">fg</span><span class="p">[blue]</span><span class="si">}</span>blue
% ruby -r open3 -e <span class="s1">'Open3.pipeline("zsh test.zsh")'</span>  <span class="c1"># 緑でgreen, 青でblueと表示される</span>
green
blue
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />89位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>9</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/49f152bbacdca1b31c70">NeoBundle+localrcでプロジェクト固有のプラグインを遅延読み込み</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-29 11:57:40</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="https://github.com/tpope/vim-rails" rel="nofollow noopener" target="_blank">tpope/vim-rails</a>のように、プロジェクトに応じて読み込むかを変えたいプラグインが存在する。Djangoプロジェクトでvim-railsを読み込んでも無意味だからだ。</p>

<p>それをNeoBundle+localrcで実現する</p>

<h1>
<span id="neobundlelazyの復習" class="fragment"></span><a href="#neobundlelazy%E3%81%AE%E5%BE%A9%E7%BF%92"><i class="fa fa-link"></i></a>NeoBundleLazyの復習</h1>

<p><a href="https://github.com/Shougo/neobundle.vim" rel="nofollow noopener" target="_blank">Shougo/neobundle.vim</a>の<code>:NeoBundleLazy</code>を使うと、特定のfiletypeのバッファを開いた時にだけプラグインを読み込むことが簡単にできる。これによって不必要なプラグインを読み込まずに済むようになるのでvimの高速化が期待できる。</p>

<p>例えば次のように書けばcoffeescriptのファイルを開いたタイミングで<a href="https://github.com/kchmck/vim-coffee-script" rel="nofollow noopener" target="_blank">kchmck/vim-coffee-script</a>を読み込む。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vimrc</span></div>
<div class="highlight"><pre><span></span>NeoBundleLazy <span class="s1">'kchmck/vim-coffee-script'</span><span class="p">,</span> {<span class="s1">'autoload'</span>: {<span class="s1">'filetypes'</span>: [<span class="s1">'coffee'</span>]}}
</pre></div>
</div>

<h1>
<span id="プロジェクト固有プラグインを遅延読み込み" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%9B%BA%E6%9C%89%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%82%92%E9%81%85%E5%BB%B6%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>プロジェクト固有プラグインを遅延読み込み</h1>

<p>同様のことをvim-railsで行いたいがfiletypeと結びつけるのは不適切だ。<a href="https://github.com/thinca/vim-localrc" rel="nofollow noopener" target="_blank">thinca/vim-localrc</a>を使い、Railsプロジェクト内でvimを開いたときは自動的にvim-railsを読み込むようにする。</p>

<p>まず忘れずにvim-railsを<code>:NeoBundleLazy</code>する。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">.vimrc</span></div>
<div class="highlight"><pre><span></span>NeoBundleLazy <span class="s1">'tpope/vim-rails'</span>
</pre></div>
</div>

<p>そしてRailsディレクトリに.local.vimrcファイルを設置して、その中で<code>:NeoBundleSource</code>を実行する。引数がNeoBundleLazyと若干異なることに注意。</p>

<div class="code-frame" data-lang="vim">
<div class="code-lang"><span class="bold">path/to/your/rails/project/.local.vimrc</span></div>
<div class="highlight"><pre><span></span>NeoBundleSource <span class="k">vim</span><span class="p">-</span>rails
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />90位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>9</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/9e928f2ff21e93e5ac43">rails newの-mオプションを使うと捗る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-23 00:45:52</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ruby 1.9.3<br>
rails 3.2<br>
に依存するが</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails new appname -m https://raw.github.com/RailsApps/rails3-application-templates/master/rails3-devise-rspec-cucumber-template.rb -T
</pre></div></div>

<p>を実行してみるといろいろやってくれる。これからrailsアプリを開始する人は是非とも使ってみるべし。</p>

<p>mysqlを使う場合は</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails new appname -m https://raw.github.com/RailsApps/rails3-application-templates/master/rails3-devise-rspec-cucumber-template.rb -T  -d mysql
</pre></div></div>

<p>を実行する前に <code>appname_development</code> というデータベースを自分で先に作っておかないとエラーが出る。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />91位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/75bbd1bf6422d4a59b94">デプロイしたリビジョンをファイルに書き出す</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-06 15:28:51</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> <b>[capistrano]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="追記" class="fragment"></span><a href="#%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>追記</h3>

<p>Capistrano 3.1からは何もしなくてもprevious_revisionとcurrent_revisionが <code>set</code> されるようです。</p>

<ul>
<li><a href="https://github.com/capistrano/capistrano/commit/32920c12570d237bdd355d662c28cec34bd9a2b3" rel="nofollow noopener" target="_blank">capistrano/capistrano#32920c1</a></li>
</ul>

<hr>

<p>Capistrano2の頃はデプロイするとそのときのリビジョンがREVISIONという名前のファイルに書きだされていた（ような気がする）のですが、Capistrano3ではデフォルトでそういうことをやらなくなったみたいです。</p>

<p>下記のタスクを追加するとファイルに保存されるようになります。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">config/deploy.rb</span></div>
<div class="highlight"><pre><span></span><span class="n">set</span> <span class="ss">:revision_file</span><span class="p">,</span> <span class="s1">'REVISION'</span>

<span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:save_current_revision</span> <span class="k">do</span>
    <span class="n">on</span> <span class="n">role</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">within</span> <span class="n">repo_path</span> <span class="k">do</span>
        <span class="n">set</span> <span class="ss">:revision</span><span class="p">,</span> <span class="n">capture</span><span class="p">(</span><span class="ss">:git</span><span class="p">,</span> <span class="ss">:'rev-parse'</span><span class="p">,</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:branch</span><span class="p">))</span>
      <span class="k">end</span>
      <span class="n">within</span> <span class="n">release_path</span> <span class="k">do</span>
        <span class="n">execute</span> <span class="ss">:echo</span> <span class="s2">"</span><span class="si">#{</span><span class="n">fetch</span> <span class="ss">:current_revision</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">#{</span><span class="n">fetch</span> <span class="ss">:revision_file</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">before</span> <span class="ss">:updated</span><span class="p">,</span> <span class="s1">'deploy:save_current_revision'</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />92位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/3729697c50e05be6a4d3">Rails4で自動EXPLAINが消えた理由</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-26 12:00:14</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rails3.2で導入された自動EXPLAINがRails4で早くも削除されていました。</p>

<ul>
<li><a href="https://github.com/rails/rails/commit/d3688e02ca52c0b72d3092e8498da51e06b7fc58" rel="nofollow noopener" target="_blank">remove AR auto-explain</a></li>
</ul>

<p>理由は大きく分けて2つあるようです。</p>

<ul>
<li>ほとんど使われていない</li>
<li>アセットパイプラインが壊れることがある - <a href="https://github.com/rails/rails/issues/9385" rel="nofollow noopener" target="_blank">cannot compile assets including scss files in production environment</a>
</li>
</ul>

<p>自動EXPLAINは消えましたが <code>ActiveRecord::Relation#explain</code> は残っているので問題なく使えるらしいです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />93位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/36051b0061f493f16c73">Dropbox/PublicをローカルのApacheで表示する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-01-28 20:06:16</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> <b>[Apache]</b> <b>[Dropbox]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="sh">
<div class="code-lang"><span class="bold">手順</span></div>
<div class="highlight"><pre><span></span><span class="c1"># 1. ~/Sites内に~/Dropbox/Publicへのシンボリックリンクを作る</span>
<span class="nb">cd</span> ~/Sites<span class="p">;</span> ln -s ~/Dropbox/Public Dropbox
<span class="c1"># 2. ~/Dropboxの権限を 755 にする</span>
chmod <span class="m">755</span> ~/Dropbox
<span class="c1"># 3. apacheのユーザディレクトリ設定でOptionsにFollowSymLinksを追加する</span>
sudo vim /etc/apache2/users/<span class="sb">`</span>whoami<span class="sb">`</span>.conf
<span class="c1"># 4. apacheを再起動する</span>
sudo apachectl restart
</pre></div>
</div>

<p>これで <code>~/Dropbox/Public/index.html</code> に <code>http://localhost/~USERNAME/Dropbox/index.html</code> でアクセスできる。ローカルで素早く確認できるので嬉しい。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />94位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/032f39635cbfceff5489">fast forward mergeが可能かどうかを判定する方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-11 19:25:07</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>git-rev-list</code> を使うと2つのリビジョン間の差分が分かります。この例の場合はmasterからみてorigin/masterが1つ先にあることを意味します。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% git rev-list --count master..origin/master
<span class="m">1</span>
</pre></div></div>

<p>これを応用するとfast forwardかどうかを判定することができます。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>% git rev-list --count branch..master
<span class="m">0</span>
</pre></div></div>

<p>これはbranchからみてmasterがどれだけ先にあるかを返します。これが0であるということはbranchがmasterに至るために必要なコミットが存在しないという意味なので、fast forwardなmergeが可能であることが分かります。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />95位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/73ce6040fc61ded7b654">Gitvで見ているコミットのページをgithubで開く</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-06-21 16:07:47</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="vim"><div class="highlight"><pre><span></span><span class="c">" http://cohama.hateblo.jp/entry/20130517/1368806202</span>
<span class="k">function</span><span class="p">!</span> s:gitv_get_current_hash<span class="p">()</span>
    <span class="k">return</span> matchstr<span class="p">(</span>getline<span class="p">(</span><span class="s1">'.'</span><span class="p">),</span> <span class="s1">'\[\zs.\{7\}\ze\]$'</span><span class="p">)</span>
<span class="k">endfunction</span>

augroup Gitv
    autocmd<span class="p">!</span>
    autocmd <span class="nb">FileType</span> gitv <span class="nb">nnoremap</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> G :<span class="p">&lt;</span>C<span class="p">-</span><span class="k">u</span><span class="p">&gt;</span>Gbrowse <span class="p">&lt;</span>C<span class="p">-</span><span class="k">r</span><span class="p">&gt;=&lt;</span>SID<span class="p">&gt;</span>gitv_get_current_hash<span class="p">()&lt;</span>CR<span class="p">&gt;&lt;</span>CR<span class="p">&gt;</span>
augroup END
</pre></div></div>

<p>上をvimrcに貼りつけておけば、gitvのファイルモードやブラウザモードで <code>G</code> を押したとき、選択されているコミットに対応したgithubのコミットページをブラウザで開いてくれる。</p>

<h1>
<span id="関連" class="fragment"></span><a href="#%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>関連</h1>

<ul>
<li><a href="http://qiita.com/yaotti/items/62947b0c981ae38fae82" id="reference-eb6aa55fa894cecde06b">tigで見ているコミットのページをgithubで開く - Qiita</a></li>
<li><a href="http://cohama.hateblo.jp/entry/20130517/1368806202" rel="nofollow noopener" target="_blank">tig なんて目じゃない！ Git のログ系 Vim プラグイン gitv ＆ gitv をGit 統合インターフェース化する最強の設定 - 反省はしても後悔はしない</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />96位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/e1b30b85e09cf55c7486">IPython起動時にスクリプトを自動的に読み込む</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-04-16 14:18:17</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Python]</b> <b>[IPython]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>IPython ver0.11から仕様が変更されて<code>IPYTHON_DIR/profile_&lt;name&gt;/startup/</code>ディレクトリの中身が自動的に実行されるようになった。<br>
<code>IPYTHON_DIR</code>はLinuxだと<code>$HOME/.config/ipython</code>他のUnix環境だと<code>$HOME/.ipython</code>。<br>
<code>&lt;name&gt;</code>は起動しているプロファイル文字列で何も指定しない場合は<code>default</code>が入る。<br>
つまりMacの人がプロファイルを指定せずにIPythonを起動すると<code>$HOME/.ipython/profile_default/startup</code>の中の<code>.py</code>もしくは<code>.ipy</code>ファイルが実行される。この時の実行順序はファイル名の辞書順なので、実行する順番をきっちり決めたい場合は<code>00-first.py</code> <code>99-last.py</code>みたいな感じで数字を前につけるといい。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre><span></span>$ cat ~/.ipython/profile_default/startup/00-first.py
print <span class="s1">'Hello World'</span>
$ ipython
Python <span class="m">2</span>.7.2 <span class="o">(</span>default, Feb <span class="m">16</span> <span class="m">2012</span>, <span class="m">15</span>:37:03<span class="o">)</span> 
Type <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for</span> more information.

IPython <span class="m">0</span>.12 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython<span class="s1">'s features.</span>
<span class="s1">%quickref -&gt; Quick reference.</span>
<span class="s1">help      -&gt; Python'</span>s own <span class="nb">help</span> system.
object?   -&gt; Details about <span class="s1">'object'</span>, use <span class="s1">'object??'</span> <span class="k">for</span> extra details.
Hello World

In <span class="o">[</span><span class="m">1</span><span class="o">]</span>: 
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />97位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/78a987aeec95618ee6d6">Qiita Chrome 拡張の最近の機能追加</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-03-21 21:48:00</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Qiita]</b> <b>[Chrome]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>前回: <a href="http://qiita.com/items/cc30710256da2427c974">Qiitaの通知を表示できるChrome拡張を作った</a></p>

<ul>
<li><a href="https://chrome.google.com/webstore/detail/hcnchocfgcldaldkchelnhpidgmfaocc" rel="nofollow noopener" target="_blank">Chrome Web Store - qiita-notifications</a></li>
<li><a href="https://github.com/taka84u9/qiita-notifications" rel="nofollow noopener" target="_blank">taka84u9/qiita-notifications</a></li>
</ul>

<p>何気に version 0.3.3 まできた Qiita Chrome 拡張に最近追加された機能の紹介。<br>
Chrome使ってる方はよければ使ってみて下さい。</p>

<h2>
<span id="最近投稿されたアイテムを表示できるようになりました" class="fragment"></span><a href="#%E6%9C%80%E8%BF%91%E6%8A%95%E7%A8%BF%E3%81%95%E3%82%8C%E3%81%9F%E3%82%A2%E3%82%A4%E3%83%86%E3%83%A0%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%97%E3%81%9F"><i class="fa fa-link"></i></a>最近投稿されたアイテムを表示できるようになりました</h2>

<p>ユーザへの通知に加えて最近投稿されたアイテムが表示できるようになりました。<br>
Qiita の UI にある「フォロー中」「すべての投稿」タブの内容が表示されます。<br>
下の画像だと分かりませんが、前回 qiita-notifications で表示した後に投稿されたアイテムに関しては、背景が緑色になるので、どこまで読んだか人目で分かるようになっています。<br>
(追記)二枚目の画像みたいになります</p>

<p><a href="https://camo.qiitausercontent.com/fc1ff79811171ba0bf530537e381f2ebc77ee368/68747470733a2f2f696d672e736b697463682e636f6d2f32303132303332312d636333697739757135396d6b6661783872346a747165326d386b2e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fc1ff79811171ba0bf530537e381f2ebc77ee368/68747470733a2f2f696d672e736b697463682e636f6d2f32303132303332312d636333697739757135396d6b6661783872346a747165326d386b2e6a7067" alt="" data-canonical-src="https://img.skitch.com/20120321-cc3iw9uq59mkfax8r4jtqe2m8k.jpg"></a></p>

<p><a href="https://camo.qiitausercontent.com/cd1f181c23af9e79c0ca1fe4bc9359e9343afa5d/68747470733a2f2f696d672e736b697463682e636f6d2f32303132303332312d676b663432797065613669727463636868736d6b6a78347032622e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/cd1f181c23af9e79c0ca1fe4bc9359e9343afa5d/68747470733a2f2f696d672e736b697463682e636f6d2f32303132303332312d676b663432797065613669727463636868736d6b6a78347032622e6a7067" alt="" data-canonical-src="https://img.skitch.com/20120321-gkf42ypea6irtcchhsmkjx4p2b.jpg"></a></p>

<h2>
<span id="日本語対応" class="fragment"></span><a href="#%E6%97%A5%E6%9C%AC%E8%AA%9E%E5%AF%BE%E5%BF%9C"><i class="fa fa-link"></i></a>日本語対応</h2>

<p>日本語対応しました。Chromeの言語設定が <code>ja</code> の時、日本語で表示されます。<br>
メニューボタン以外の日本語化したバージョンはリリースして間がないので、既にインストール済みの方の場合は自動的にバージョンが上がるまでしばらく待ってください。</p>

<p><a href="https://camo.qiitausercontent.com/7edb46b7d5ec9ec476176b8e4492eaefbbd194d6/68747470733a2f2f696d672e736b697463682e636f6d2f32303132303332312d663934646a6464327372716878376b64657467787472366e71662e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/7edb46b7d5ec9ec476176b8e4492eaefbbd194d6/68747470733a2f2f696d672e736b697463682e636f6d2f32303132303332312d663934646a6464327372716878376b64657467787472366e71662e6a7067" alt="" data-canonical-src="https://img.skitch.com/20120321-f94djdd2srqhx7kdetgxtr6nqf.jpg"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />98位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/035f54f74d6260250a6f">どうしても無名関数だと困る場合</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-01-18 02:02:25</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[CoffeeScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>CoffeeScriptで関数を定義すると必ず無名関数で定義される</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nv">hoge = </span><span class="nf">-&gt;</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">hoge</span><span class="p">;</span>

<span class="nx">hoge</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
</pre></div></div>

<p>基本的にこれで問題ないけど、無名関数だと困る場合がたまにある。具体的にはコンストラクタの名前にアクセスしたい場合。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">hoge</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
<span class="nx">h</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">hoge</span><span class="p">();</span>
<span class="nx">h</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="c1">// =&gt; ""</span>

<span class="kd">function</span> <span class="nx">hoge</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">h</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">hoge</span><span class="p">();</span>
<span class="nx">h</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="c1">// =&gt; "hoge"</span>
</pre></div></div>

<p>このような場面で無名関数でなく有名関数（？）を強制的に使いたい場合もclassを使えばできる。というか、コンストラクタとして使うのだからclassを使えというのは、至極当たり前な感じもする。</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nx">hoge</span>
<span class="nv">h = </span><span class="k">new</span> <span class="nx">hoge</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">h</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span>
</pre></div></div>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">hoge</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">hoge</span><span class="p">()</span> <span class="p">{}</span>

  <span class="k">return</span> <span class="nx">hoge</span><span class="p">;</span>

<span class="p">})();</span>

<span class="nx">h</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">hoge</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="c1">// =&gt; "hoge"</span>
</pre></div></div>

<p>さらに余談で、何故僕がこんな重箱の隅の問題にはまったかというと、gjstestというjsのテストフレームワークを使おうとして、コンストラクタの名前が空だと、結果をhtmlに出力した時にバグが生じるためでした。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />99位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/cc3895a375aedd6c05c5">Elasticsearchのデバッグのお供にelasticsearch-inquisitorが便利</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-29 02:14:24</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Elasticsearch]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Elasticsearchに登録されているインデックスを調べたくなってツールを探した結果、elasticsearch-inquisitorというpluginを見つけました。</p>

<p><a href="https://github.com/polyfractal/elasticsearch-inquisitor" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/polyfractal/elasticsearch-inquisitor</a></p>

<p>インストールするにはElasticsearchのディレクトリにある <code>bin/plugin</code> コマンドを使うだけです。Homebrew経由でインストール場合は/usr/local/Celler/elasticsearch/0.90.2/bin/pluginとかにあるあるはずです。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>bin/plugin -install polyfractal/elasticsearch-inquisitor
</pre></div></div>

<p>今までElasticsearchにこんな機能があることを知らなかったんですが便利ですね。</p>

<p>そして <a href="http://localhost:9200/_plugin/inquisitor/" class="autolink" rel="nofollow noopener" target="_blank">http://localhost:9200/_plugin/inquisitor/</a> にアクセスしたら既に使えるようになっています。インデックスの情報を簡単に確認することができます。ローカルでの開発のお供によさそうです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>yuku_tさんの<br />100位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/yuku_t/items/1a3ea60ba11f1802cc44">ChromeExtensionでUnderscoreのtemplateを使う</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-12-17 22:51:54</center>
	</td>
	<td style="width:200px;">
		@yuku_t<br />(Increments inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/153/profile-images/1505784567">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Node.js]</b> <b>[Chrome]</b> <b>[Underscore.js]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Chormeのmanifest version2から <code>eval</code> が禁止になった。<br>
使おうとすると <code>Uncaught Error: Code generation from strings disallowed for this context</code> とエラーが出る。<br>
<code>eval</code> なんか使わないという人が大多数だと思うが、実はほとんどのテンプレートエンジンが内部で <code>eval</code> ないし <code>new Function()</code> を使っているので、意外とこの制限にひっかかる場合が多い。</p>

<p>もともと<a href="http://underscorejs.org/" rel="nofollow noopener" target="_blank">Underscore.js</a>のテンプレートエンジンを使っていたのを、version2でも動くようにした時の方法を紹介する。</p>

<p>ちなみにGoogle謹製の<a href="http://angularjs.org/" rel="nofollow noopener" target="_blank">Angular.js  </a>には <code>eval</code> も <code>new Function()</code> も使わないテンプレートエンジンがあるそうだが、Angular.jsは巨大過ぎて使う気がしない。</p>

<h2>
<span id="_template-source" class="fragment"></span><a href="#_template-source"><i class="fa fa-link"></i></a>_.template source</h2>

<p>Underscore.js version 1.3.3からコンパイルしたテンプレートオブジェクトに <code>source</code> プロパティが追加された。<br>
これを使うと <code>new Function()</code> に渡される文字列を参照できる。<br>
例えば</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="s2">"&lt;b&gt;&lt;%= name %&gt;&lt;/b&gt;"</span><span class="p">).</span><span class="nx">source</span><span class="p">);</span>
</pre></div></div>

<p>を実行すると</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
<span class="kd">var</span> <span class="nx">__t</span><span class="p">,</span><span class="nx">__p</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="nx">__j</span><span class="o">=</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">join</span><span class="p">,</span><span class="nx">print</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">__p</span><span class="o">+=</span><span class="nx">__j</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span><span class="s1">''</span><span class="p">);};</span>
<span class="kd">with</span><span class="p">(</span><span class="nx">obj</span><span class="o">||</span><span class="p">{}){</span>
<span class="nx">__p</span><span class="o">+=</span><span class="s1">'&lt;b&gt;'</span><span class="o">+</span>
<span class="p">((</span><span class="nx">__t</span><span class="o">=</span><span class="p">(</span> <span class="nx">name</span> <span class="p">))</span><span class="o">==</span><span class="kc">null</span><span class="o">?</span><span class="s1">''</span><span class="o">:</span><span class="nx">__t</span><span class="p">)</span><span class="o">+</span>
<span class="s1">'&lt;/b&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">return</span> <span class="nx">__p</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<p>となる。仮にこれを <code>JST</code> という名前の変数に代入したとすると</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JST</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">'hello'</span><span class="p">}));</span>
</pre></div></div>

<p>は <code>&lt;b&gt;hello&lt;/b&gt;</code> になる。ようするにこいつを予め開発環境で作ってやり、extension ではこの関数を使えばいいわけだ。</p>

<h2>
<span id="変換する" class="fragment"></span><a href="#%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>変換する</h2>

<p>だんだん書くのが面倒になってきたので詳細は省くが、要約すれば次のようなスクリプトを用意する。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'underscore'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="c1">// テンプレート</span>
<span class="kd">var</span> <span class="nx">templates</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">foo</span><span class="o">:</span> <span class="s2">"&lt;b&gt;&lt;%= name %&gt;&lt;/b&gt;"</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="s2">"var JST = {};\n"</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">templates</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">data</span> <span class="o">+=</span> <span class="s2">"JST['"</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">"'] = "</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">templates</span><span class="p">[</span><span class="nx">name</span><span class="p">]).</span><span class="nx">source</span> <span class="o">+</span> <span class="s2">";\n"</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">writeSync</span><span class="p">(</span><span class="s2">"path/to/jst.js"</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
</pre></div></div>

<p>これを実行すると <code>path/to/jst.js</code> というファイルが生成される。extension でそれを読み込む。<br>
使い方は</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="nx">JST</span><span class="p">.</span><span class="nx">foo</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'hello'</span> <span class="p">});</span>  <span class="c1">//=&gt; &lt;b&gt;hello&lt;/b&gt;</span>
</pre></div></div>

<p>みたいな感じ。 <code>path/to/jst.js</code> の中身は</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">JST</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">JST</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
<span class="kd">var</span> <span class="nx">__t</span><span class="p">,</span><span class="nx">__p</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="nx">__j</span><span class="o">=</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">join</span><span class="p">,</span><span class="nx">print</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">__p</span><span class="o">+=</span><span class="nx">__j</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span><span class="s1">''</span><span class="p">);};</span>
<span class="kd">with</span><span class="p">(</span><span class="nx">obj</span><span class="o">||</span><span class="p">{}){</span>
<span class="nx">__p</span><span class="o">+=</span><span class="s1">'&lt;b&gt;'</span><span class="o">+</span>
<span class="p">((</span><span class="nx">__t</span><span class="o">=</span><span class="p">(</span> <span class="nx">name</span> <span class="p">))</span><span class="o">==</span><span class="kc">null</span><span class="o">?</span><span class="s1">''</span><span class="o">:</span><span class="nx">__t</span><span class="p">)</span><span class="o">+</span>
<span class="s1">'&lt;/b&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">return</span> <span class="nx">__p</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div>

<p>になる。これを応用すれば通常のWebサイトでも Underscore.js のテンプレートエンジンをコンパイル時間の分だけ高速化させることができるが、それは過剰な気がするのでそこまでやる必要はないと思う。</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
