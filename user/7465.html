<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (jnchito)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (jnchito さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />1位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2328</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/dedb3b889ab226933ccf">[初心者向け] RubyやRailsでリファクタリングに使えそうなイディオムとか便利メソッドとか</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-11-05 08:05:13</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[初心者]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに-遠回りせずに近道を探す" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB-%E9%81%A0%E5%9B%9E%E3%82%8A%E3%81%9B%E3%81%9A%E3%81%AB%E8%BF%91%E9%81%93%E3%82%92%E6%8E%A2%E3%81%99"><i class="fa fa-link"></i></a>はじめに: 遠回りせずに「近道」を探す</h2>

<p>RubyやRailsを始めたばかりの人は、もっと短く書く方法や便利な標準ライブラリの存在を知らずに遠回りした書き方をしてしまいがちです。</p>

<p>そこで、RubyやRails初心者の人によく見かける「遠回り(または車輪の再発明)」と、それを回避する「近道」をいろいろ集めてみました。</p>

<h3>
<span id="20131106-追記" class="fragment"></span><a href="#20131106-%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>2013.11.06 追記</h3>

<p>この投稿を書くに至った経緯などを自分のブログに書きました。<br>
こちらも合わせてどうぞ！</p>

<ul>
<li><a href="http://blog.jnito.com/entry/2013/11/06/072831" rel="nofollow noopener" target="_blank">昨日Qiitaに投稿した記事は普段のコードレビューの副産物 - give IT a try</a></li>
</ul>

<h2>
<span id="ruby編" class="fragment"></span><a href="#ruby%E7%B7%A8"><i class="fa fa-link"></i></a>Ruby編</h2>

<p>以下はRubyの標準機能を使ったイディオムやメソッドです。<br>
Railsプロジェクトでもそれ以外でも使えます。(Ruby 1.9以上を想定)</p>

<h3>
<span id="後置ifで行数を減らす" class="fragment"></span><a href="#%E5%BE%8C%E7%BD%AEif%E3%81%A7%E8%A1%8C%E6%95%B0%E3%82%92%E6%B8%9B%E3%82%89%E3%81%99"><i class="fa fa-link"></i></a>後置ifで行数を減らす</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">active?</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">send_mail_to</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">active?</span>
</pre></div></div>

<h3>
<span id="if--notではなくunlessを使う" class="fragment"></span><a href="#if--not%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Funless%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>if + notではなく、unlessを使う</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">user</span><span class="o">.</span><span class="n">destroy</span> <span class="k">if</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">active?</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">user</span><span class="o">.</span><span class="n">destroy</span> <span class="k">unless</span> <span class="n">user</span><span class="o">.</span><span class="n">active?</span>
</pre></div></div>

<p>ただし、unlessの条件がandやorでつながっていたり、否定形の条件が入っていたりすると、読み手の脳に負担がかかるので、複雑な条件はifを使う方が良いです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># こんなunlessは理解するのに時間がかかるのでNG</span>
<span class="n">user</span><span class="o">.</span><span class="n">destroy</span> <span class="k">unless</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active?</span> <span class="o">||</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">spam?</span>
</pre></div></div>

<h3>
<span id="三項演算子を使って行数を減らす" class="fragment"></span><a href="#%E4%B8%89%E9%A0%85%E6%BC%94%E7%AE%97%E5%AD%90%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E8%A1%8C%E6%95%B0%E3%82%92%E6%B8%9B%E3%82%89%E3%81%99"><i class="fa fa-link"></i></a>三項演算子を使って行数を減らす</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
  <span class="s2">"I appreciate for that."</span>
<span class="k">else</span>
  <span class="s2">"Thanks."</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span> <span class="p">?</span> <span class="s2">"I appreciate for that."</span> <span class="p">:</span> <span class="s2">"Thanks"</span>
</pre></div></div>

<p>ただし、三項演算子をネストさせたりすると極めて読みにくくなるのでやめておきましょう。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># 三項演算子のネストは読みづらい</span>
<span class="n">user</span><span class="o">.</span><span class="n">admin?</span> <span class="p">?</span> <span class="n">user</span><span class="o">.</span><span class="n">active?</span> <span class="p">?</span> <span class="s2">"I appreciate for that."</span> <span class="p">:</span> <span class="s2">"Are you OK?"</span> <span class="p">:</span> <span class="s2">"Thanks."</span>
</pre></div></div>

<h3>
<span id="代入してからifで存在を確認をまとめて書く" class="fragment"></span><a href="#%E4%BB%A3%E5%85%A5%E3%81%97%E3%81%A6%E3%81%8B%E3%82%89if%E3%81%A7%E5%AD%98%E5%9C%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%82%92%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>代入してからifで存在を確認、をまとめて書く</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">find_user</span>
<span class="k">if</span> <span class="n">user</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="n">find_user</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>ただし、このイディオムは「<code>==</code>と<code>=</code>を書き間違えたんじゃないか？」と読み手に勘違いされる恐れもあるので、好き嫌いが分かれるのも事実です。</p>

<h3>
<span id="子どものオブジェクトが存在する場合にのみそのプロパティやメソッドを呼び出して条件を確認するをひとつのifで書く" class="fragment"></span><a href="#%E5%AD%90%E3%81%A9%E3%82%82%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AB%E3%81%AE%E3%81%BF%E3%81%9D%E3%81%AE%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%82%84%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%A6%E6%9D%A1%E4%BB%B6%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E3%82%92%E3%81%B2%E3%81%A8%E3%81%A4%E3%81%AEif%E3%81%A7%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>子どものオブジェクトが存在する場合にのみ、そのプロパティやメソッドを呼び出して条件を確認する、をひとつのifで書く</h3>

<p>以下のコードは、<code>parent.children</code>が<code>nil</code>になっている可能性があるので、<code>children</code>が存在するときだけ<code>children.singleton?</code>を呼び出したい、というようなケースです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span>
  <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">singleton?</span>
    <span class="n">singleton</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">first</span>
    <span class="n">send_mail_to</span><span class="p">(</span><span class="n">singleton</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">singleton?</span>
  <span class="n">singleton</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">first</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">singleton</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>Ruby 2.3では safe navigation operator という新しい演算子（<code>&amp;.</code>）が追加されました。<br>
これを使うと <code>nil</code> かもしれないオブジェクトにメソッド呼び出しを試すことができます。<br>
もしオブジェクトが <code>nil</code> であれば戻り値も <code>nil</code> になります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.3以降（childrenがnilでもエラーにならず、nilが返る）</span>
<span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">&amp;.</span><span class="n">singleton?</span>
  <span class="n">singleton</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">first</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">singleton</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>その他、Ruby 2.3の新機能についてはこちらの記事をご覧ください。</p>

<p><a href="http://qiita.com/jnchito/items/0faac073cb77417d61c7" id="reference-91a6faf0870a55f0e2c7">サンプルコードでわかる！Ruby 2.3の主な新機能 - Qiita</a></p>

<h3>
<span id="メソッドの戻り値を返すときにreturnを使わない" class="fragment"></span><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E6%88%BB%E3%82%8A%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99%E3%81%A8%E3%81%8D%E3%81%ABreturn%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>メソッドの戻り値を返すときにreturnを使わない</h3>

<p>他の言語からやってきた人はついつい<code>return</code>を使いたくなりますが、<code>return</code>を使わない書き方の方がRubyっぽいです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_message</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">message</span> <span class="o">=</span> <span class="s1">'hello'</span>
  <span class="n">message</span> <span class="o">+=</span> <span class="s1">'!!'</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
  <span class="k">return</span> <span class="n">message</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_message</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">message</span> <span class="o">=</span> <span class="s1">'hello'</span>
  <span class="n">message</span> <span class="o">+=</span> <span class="s1">'!!'</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
  <span class="n">message</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="初期化プロパティセット戻り値として返すの代わりにobjecttapを使う" class="fragment"></span><a href="#%E5%88%9D%E6%9C%9F%E5%8C%96%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%82%BB%E3%83%83%E3%83%88%E6%88%BB%E3%82%8A%E5%80%A4%E3%81%A8%E3%81%97%E3%81%A6%E8%BF%94%E3%81%99%E3%81%AE%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%ABobjecttap%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>「初期化、プロパティセット、戻り値として返す」の代わりにObject#tapを使う</h3>

<p>tapを使わなくても行数は同じですが、ローカル変数の宣言や値を返却するためだけに書く最後の行がいらなくなります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_user</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"hoge@hoge.com"</span>
  <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Taro Yamada"</span>
  <span class="n">user</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_user</span>
  <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"hoge@hoge.com"</span>
    <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Taro Yamada"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="ではなく-で文字列を連結する" class="fragment"></span><a href="#%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F-%E3%81%A7%E6%96%87%E5%AD%97%E5%88%97%E3%82%92%E9%80%A3%E7%B5%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>"+”ではなく"#{ }"で文字列を連結する</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s2">"Hello, "</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">"!"</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s2">"Hello, </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!"</span>
</pre></div></div>

<h3>
<span id="複数行にわたる文字列はヒアドキュメントを使う" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E8%A1%8C%E3%81%AB%E3%82%8F%E3%81%9F%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97%E3%81%AF%E3%83%92%E3%82%A2%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>複数行にわたる文字列はヒアドキュメントを使う</h3>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s2">"Hello, world!</span><span class="se">\n</span><span class="s2">Good-bye, world!"</span>
</pre></div></div>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="dl">TEXT</span>
<span class="sh">Hello, world!</span>
<span class="sh">Good-bye, world!</span>
<span class="dl">TEXT</span>
</pre></div></div>

<p>Rubyのヒアドキュメントは高機能なので、もっと詳しく知りたい方は公式ドキュメントやネット上の情報を参考にしてください。</p>

<p><a href="http://docs.ruby-lang.org/ja/2.3.0/doc/spec=2fliteral.html#here" rel="nofollow noopener" target="_blank">ヒアドキュメント (行指向文字列リテラル)</a></p>

<h3>
<span id="定数はfreezeさせる" class="fragment"></span><a href="#%E5%AE%9A%E6%95%B0%E3%81%AFfreeze%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>定数はfreezeさせる</h3>

<p>文字列であれ、配列であれ、ハッシュであれ、定数宣言した値は<code>freeze</code>しておく方が無難です。万一変更されると困るので。</p>

<h4>
<span id="文字列の場合" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>文字列の場合</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">CONTACT_PHONE_NUMBER</span> <span class="o">=</span> <span class="s2">"03-1234-5678"</span>
<span class="no">CONTACT_PHONE_NUMBER</span> <span class="o">&lt;&lt;</span> <span class="s2">"@#$%^"</span>
<span class="nb">puts</span> <span class="no">CONTACT_PHONE_NUMBER</span> <span class="c1"># =&gt; 03-1234-5678@#$%^</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">CONTACT_PHONE_NUMBER</span> <span class="o">=</span> <span class="s2">"03-1234-5678"</span><span class="o">.</span><span class="n">freeze</span>
<span class="no">CONTACT_PHONE_NUMBER</span> <span class="o">&lt;&lt;</span> <span class="s2">"@#$%^"</span> <span class="c1"># =&gt; RuntimeError: can't modify frozen String</span>
</pre></div></div>

<h4>
<span id="配列の場合" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>配列の場合</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">ADMIN_NAMES</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"Tom"</span><span class="p">,</span> <span class="s2">"Alice"</span><span class="o">]</span>
<span class="no">ADMIN_NAMES</span> <span class="o">&lt;&lt;</span> <span class="s2">"Taro"</span>
<span class="no">ADMIN_NAMES</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">downcase!</span>
<span class="nb">puts</span> <span class="no">ADMIN_NAMES</span> <span class="c1"># =&gt; ["tom", "Alice"]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">ADMIN_NAMES</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"Tom"</span><span class="p">,</span> <span class="s2">"Alice"</span><span class="o">].</span><span class="n">freeze</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:freeze</span><span class="p">)</span>
<span class="no">ADMIN_NAMES</span> <span class="o">&lt;&lt;</span> <span class="s2">"Taro"</span> <span class="c1"># =&gt; RuntimeError: can't modify frozen Array</span>
<span class="no">ADMIN_NAMES</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">downcase!</span> <span class="c1"># =&gt; RuntimeError: can't modify frozen String</span>
</pre></div></div>

<h4>
<span id="整数の場合" class="fragment"></span><a href="#%E6%95%B4%E6%95%B0%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>整数の場合</h4>

<p>整数(<code>FixNum</code>)は変更不能なので<code>freeze</code>しなくても問題ありません。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># エラーにはならないが、あまり意味が無い</span>
<span class="no">ITEM_LIMIT</span> <span class="o">=</span> <span class="mi">500</span><span class="o">.</span><span class="n">freeze</span>
</pre></div></div>

<h3>
<span id="配列やハッシュを初期化する際最後の要素をあえてカンマ付きで書いておく" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%82%84%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E5%88%9D%E6%9C%9F%E5%8C%96%E3%81%99%E3%82%8B%E9%9A%9B%E6%9C%80%E5%BE%8C%E3%81%AE%E8%A6%81%E7%B4%A0%E3%82%92%E3%81%82%E3%81%88%E3%81%A6%E3%82%AB%E3%83%B3%E3%83%9E%E4%BB%98%E3%81%8D%E3%81%A7%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%8A%E3%81%8F"><i class="fa fa-link"></i></a>配列やハッシュを初期化する際、最後の要素をあえてカンマ付きで書いておく</h3>

<p>配列やハッシュを初期化する場合は、カンマで要素を区切ります。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">countries</span> <span class="o">=</span> <span class="o">[</span>
  <span class="ss">:japan</span><span class="p">,</span>
  <span class="ss">:italy</span><span class="p">,</span>
  <span class="ss">:uk</span>
<span class="o">]</span>

<span class="n">capitals</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">japan</span><span class="p">:</span> <span class="s1">'Tokyo'</span><span class="p">,</span>
  <span class="ss">italy</span><span class="p">:</span> <span class="s1">'Rome'</span><span class="p">,</span>
  <span class="ss">uk</span><span class="p">:</span> <span class="s1">'London'</span>
<span class="p">}</span>
</pre></div></div>

<p>Rubyでは次のように、最後の要素にカンマを付けても文法上エラーになりません。 </p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">countries</span> <span class="o">=</span> <span class="o">[</span>
  <span class="ss">:japan</span><span class="p">,</span>
  <span class="ss">:italy</span><span class="p">,</span>
  <span class="ss">:uk</span><span class="p">,</span>
<span class="o">]</span>

<span class="n">capitals</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">japan</span><span class="p">:</span> <span class="s1">'Tokyo'</span><span class="p">,</span>
  <span class="ss">italy</span><span class="p">:</span> <span class="s1">'Rome'</span><span class="p">,</span>
  <span class="ss">uk</span><span class="p">:</span> <span class="s1">'London'</span><span class="p">,</span>
<span class="p">}</span>
</pre></div></div>

<p>将来的に要素が追加される可能性が高い配列やハッシュであれば、1つ前の行を修正せずに新しい要素を追加できるので、プログラム修正の手間が少し省けます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">countries</span> <span class="o">=</span> <span class="o">[</span>
  <span class="ss">:japan</span><span class="p">,</span>
  <span class="ss">:italy</span><span class="p">,</span>
  <span class="ss">:uk</span><span class="p">,</span>
  <span class="ss">:india</span><span class="p">,</span> <span class="c1"># &lt;= 1つ前の行を修正せずに追加</span>
<span class="o">]</span>

<span class="n">capitals</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">japan</span><span class="p">:</span> <span class="s1">'Tokyo'</span><span class="p">,</span>
  <span class="ss">italy</span><span class="p">:</span> <span class="s1">'Rome'</span><span class="p">,</span>
  <span class="ss">uk</span><span class="p">:</span> <span class="s1">'London'</span><span class="p">,</span>
  <span class="ss">india</span><span class="p">:</span> <span class="s1">'New Delhi'</span><span class="p">,</span> <span class="c1"># &lt;= 1つ前の行を修正せずに追加</span>
<span class="p">}</span>
</pre></div></div>

<p>また、すべての要素にカンマを付けておけば、要素の順番を入れ替えたいときも行単位の単純なカット＆ペーストで修正できますね。</p>

<h3>
<span id="配列を作るとき-の代わりにw-i-を使う" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%82%92%E4%BD%9C%E3%82%8B%E3%81%A8%E3%81%8D-%E3%81%AE%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%ABw-i-%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>配列を作るとき、[ ]の代わりに%w( )、%i( )を使う</h3>

<p>文字列だけの配列を作りたい場合は<code>%w( )</code>を使うと少し短く書けます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">actions</span> <span class="o">=</span> <span class="o">[</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'new'</span><span class="p">,</span> <span class="s1">'create'</span><span class="o">]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">actions</span> <span class="o">=</span> <span class="sx">%w(index new create)</span> <span class="c1"># =&gt; ['index', 'new', 'create']</span>
</pre></div></div>

<p>Ruby 2.0なら<code>%i( )</code>でシンボルの配列も作れます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">actions</span> <span class="o">=</span> <span class="o">%</span><span class="n">i</span><span class="p">(</span><span class="n">index</span> <span class="kp">new</span> <span class="n">create</span><span class="p">)</span> <span class="c1"># =&gt; [:index, :new, :create]</span>
</pre></div></div>

<h3>
<span id="配列を順番に処理するときobjectmethodの代わりにmethodを使う" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%82%92%E9%A0%86%E7%95%AA%E3%81%AB%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8Dobjectmethod%E3%81%AE%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%ABmethod%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>配列を順番に処理するとき、"object.method"の代わりに"&amp;:method"を使う</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="p">}</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
</pre></div></div>

<p><code>map</code>に限らず、<code>each</code>や<code>select</code>などブロックで配列の中身を受け取るようなメソッドは同じように<code>&amp;:method</code>で処理できます。</p>

<h3>
<span id="nilか配列かを区別せずarray-で処理してしまう" class="fragment"></span><a href="#nil%E3%81%8B%E9%85%8D%E5%88%97%E3%81%8B%E3%82%92%E5%8C%BA%E5%88%A5%E3%81%9B%E3%81%9Aarray-%E3%81%A7%E5%87%A6%E7%90%86%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%86"><i class="fa fa-link"></i></a>nilか配列かを区別せず、Array( )で処理してしまう</h3>

<p>基本的に配列だが、nilが渡される場合もある変数を処理する場合、<code>Array()</code>（<code>Kernel#Array</code>）を使うと条件分岐を無くせます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># usersはnilが渡される場合もあるので分岐する</span>
<span class="k">if</span> <span class="n">users</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">send_direct_mail</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span> 
</pre></div></div>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># Array()を使うと、nilの場合は空の配列（[])が、それ以外は元の配列が返されるので分岐が不要 </span>
<span class="nb">Array</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">send_direct_mail</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>

<h3>
<span id="大きな数値を宣言する場合_を入れて読みやすくする" class="fragment"></span><a href="#%E5%A4%A7%E3%81%8D%E3%81%AA%E6%95%B0%E5%80%A4%E3%82%92%E5%AE%A3%E8%A8%80%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88_%E3%82%92%E5%85%A5%E3%82%8C%E3%81%A6%E8%AA%AD%E3%81%BF%E3%82%84%E3%81%99%E3%81%8F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>大きな数値を宣言する場合、"_"を入れて読みやすくする</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">ITEM_LIMIT</span> <span class="o">=</span> <span class="mi">1000000000</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">ITEM_LIMIT</span> <span class="o">=</span> <span class="mi">1_000_000_000</span>
</pre></div></div>

<h3>
<span id="単純なgetterメソッドを定義する代わりにattr_readerを使う" class="fragment"></span><a href="#%E5%8D%98%E7%B4%94%E3%81%AAgetter%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%ABattr_reader%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>単純なgetterメソッドを定義する代わりに、attr_readerを使う</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="s2">"No name"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">name</span>
    <span class="vi">@name</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">attr_reader</span> <span class="ss">:name</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="s2">"No name"</span>
  <span class="k">end</span>

  <span class="c1"># いらない</span>
  <span class="c1"># def name</span>
  <span class="c1">#   @name</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="要素の順番に意味がある配列は同時に別々の変数で受け取る" class="fragment"></span><a href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E9%A0%86%E7%95%AA%E3%81%AB%E6%84%8F%E5%91%B3%E3%81%8C%E3%81%82%E3%82%8B%E9%85%8D%E5%88%97%E3%81%AF%E5%90%8C%E6%99%82%E3%81%AB%E5%88%A5%E3%80%85%E3%81%AE%E5%A4%89%E6%95%B0%E3%81%A7%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B"><i class="fa fa-link"></i></a>要素の順番に意味がある配列は、同時に別々の変数で受け取る</h3>

<p><code>変数 = 配列</code>のように書くと変数には配列が格納されますが、<code>変数, 変数 = 配列</code>のように書くと配列の各要素を別々の変数に格納できます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">ans_array</span> <span class="o">=</span> <span class="mi">14</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">puts</span> <span class="s2">"商は</span><span class="si">#{</span><span class="n">ans_array</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>     <span class="c1"># =&gt; 商は4</span>
<span class="nb">puts</span> <span class="s2">"あまりは</span><span class="si">#{</span><span class="n">ans_array</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span> <span class="c1"># =&gt; あまりは2</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">quotient</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="mi">14</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">puts</span> <span class="s2">"商は</span><span class="si">#{</span><span class="n">quotient</span><span class="si">}</span><span class="s2">"</span>      <span class="c1"># =&gt; 商は4</span>
<span class="nb">puts</span> <span class="s2">"あまりは</span><span class="si">#{</span><span class="n">remainder</span><span class="si">}</span><span class="s2">"</span> <span class="c1"># =&gt; あまりは2</span>
</pre></div></div>

<p>ハッシュを<code>each</code>で回したときに、ブロックが受け取る引数も同じですね。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># keyとvalueを配列として受け取る</span>
<span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">'Tom'</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s1">'hoge@hoge.com'</span><span class="p">}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key_and_value</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"key: </span><span class="si">#{</span><span class="n">key_and_value</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="s2">"value: </span><span class="si">#{</span><span class="n">key_and_value</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># keyとvalueを別々の変数で受け取る</span>
<span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">'Tom'</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s1">'hoge@hoge.com'</span><span class="p">}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"key: </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="s2">"value: </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="配列を連結するのにではなくsplatを使う" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%82%92%E9%80%A3%E7%B5%90%E3%81%99%E3%82%8B%E3%81%AE%E3%81%AB%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Fsplat%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>配列を連結するのに+ではなく、*(splat)を使う</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="n">numbers_with_zero_and_100</span> <span class="o">=</span> <span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="n">numbers</span> <span class="o">+</span> <span class="o">[</span><span class="mi">100</span><span class="o">]</span> <span class="c1"># =&gt; [0, 1, 2, 3, 100]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="n">numbers_with_zero_and_100</span> <span class="o">=</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">numbers</span><span class="p">,</span> <span class="mi">100</span><span class="o">]</span> <span class="c1"># =&gt; [0, 1, 2, 3, 100]</span>
</pre></div></div>

<p>ちなみに<code>*</code>がないと、こうなります。(配列が展開されない)</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">numbers</span><span class="p">,</span> <span class="mi">100</span><span class="o">]</span> <span class="c1"># =&gt; [0, [1, 2, 3], 100]</span>
</pre></div></div>

<h3>
<span id="nilだったら初期化の代わりに--を使う" class="fragment"></span><a href="#nil%E3%81%A0%E3%81%A3%E3%81%9F%E3%82%89%E5%88%9D%E6%9C%9F%E5%8C%96%E3%81%AE%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%AB--%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>nilだったら初期化、の代わりに ||= を使う</h3>

<p>いわゆる遅延初期化のイディオムですね。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">twitter_client</span>
  <span class="vi">@twitter_client</span> <span class="o">=</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span> <span class="k">if</span> <span class="vi">@twitter_client</span><span class="o">.</span><span class="n">nil?</span>
  <span class="vi">@twitter_client</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">twitter_client</span>
  <span class="vi">@twitter_client</span> <span class="o">||=</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span> 
<span class="k">end</span>
</pre></div></div>

<p>初期化の処理が複数行にわたる場合は<code>begin/end</code>を使うことができます。（<a href="http://blog.honeybadger.io/rubyist_guide_to_memoization/" rel="nofollow noopener" target="_blank">参考</a>）</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">twitter_client</span>
  <span class="k">return</span> <span class="vi">@twitter_client</span> <span class="k">if</span> <span class="vi">@twitter_client</span>
  <span class="vi">@twitter_client</span> <span class="o">=</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span>
  <span class="c1"># 初期化に必要な処理</span>
  <span class="c1"># ...</span>
  <span class="vi">@twitter_client</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">twitter_client</span>
  <span class="vi">@twitter_client</span> <span class="o">||=</span> <span class="k">begin</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span>
    <span class="c1"># 初期化に必要な処理</span>
    <span class="c1"># ...</span>
    <span class="n">client</span> 
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="ハッシュのキーには文字列ではなくシンボルを使う" class="fragment"></span><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E3%82%AD%E3%83%BC%E3%81%AB%E3%81%AF%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>ハッシュのキーには文字列ではなくシンボルを使う</h3>

<p>ハッシュに値をセットする場合、キーには文字列よりもシンボルを使う方がベターです。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># キーに文字列を使う</span>
<span class="n">currencies</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'japan'</span> <span class="o">=&gt;</span> <span class="s1">'yen'</span><span class="p">,</span> <span class="s1">'america'</span> <span class="o">=&gt;</span> <span class="s1">'dollar'</span><span class="p">,</span> <span class="s1">'italy'</span> <span class="o">=&gt;</span> <span class="s1">'euro'</span> <span class="p">}</span> 
<span class="n">currencies</span><span class="o">[</span><span class="s1">'japan'</span><span class="o">]</span> <span class="c1"># =&gt; 'yen'</span>
</pre></div></div>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="c1"># キーにシンボルを使う</span>
<span class="n">currencies</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">japan</span><span class="p">:</span> <span class="s1">'yen'</span><span class="p">,</span> <span class="ss">america</span><span class="p">:</span> <span class="s1">'dollar'</span><span class="p">,</span> <span class="ss">italy</span><span class="p">:</span> <span class="s1">'euro'</span> <span class="p">}</span> 
<span class="n">currencies</span><span class="o">[</span><span class="ss">:japan</span><span class="o">]</span> <span class="c1"># =&gt; 'yen'</span>
</pre></div></div>

<p>シンボルを使うと以下のようなメリットがあります。</p>

<ul>
<li>
<code>{ key: value }</code> のように簡潔なリテラルで書ける。</li>
<li>文字列よりも速い。</li>
<li>文字列よりもメモリの使用効率が良い。</li>
</ul>

<p>参考： <a href="http://stackoverflow.com/questions/8189416/why-use-symbols-as-hash-keys-in-ruby" rel="nofollow noopener" target="_blank">Why use symbols as hash keys in Ruby? - Stack Overflow</a></p>

<h3>
<span id="メソッド全体rescueの対象にするときはbeginendを省く" class="fragment"></span><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%85%A8%E4%BD%93rescue%E3%81%AE%E5%AF%BE%E8%B1%A1%E3%81%AB%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AFbeginend%E3%82%92%E7%9C%81%E3%81%8F"><i class="fa fa-link"></i></a>メソッド全体rescueの対象にするときはbegin/endを省く</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="n">send_to_mail</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">rescue</span>
    <span class="c1"># 例外処理</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">send_to_mail</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">rescue</span>
  <span class="c1"># 例外処理</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="exceptionをrescueするのではなくstandarderrorをrescueする" class="fragment"></span><a href="#exception%E3%82%92rescue%E3%81%99%E3%82%8B%E3%81%AE%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Fstandarderror%E3%82%92rescue%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Exceptionをrescueするのではなく、StandardErrorをrescueする</h3>

<p>JavaやC#をやっていた人は「すべての例外を捕捉したい = Exceptionを捕捉する」と考えがちです。<br>
しかし、Rubyで<code>Exception</code>を捕捉すると、<code>NoMemoryError</code>等の致命的な例外も捕捉してしまいます。</p>

<p>実行時エラーを表すRubyの例外クラスは<code>Exception</code>のサブクラスである<code>StandardError</code>です。<br>
rescueでデフォルトで捕捉するのは<code>StandardError</code>とそのサブクラスなので、すべての実行時エラーを捕捉したい場合は<code>rescue</code>節に具体的な例外クラス名を書く必要はありません。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">send_to_mail</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">ex</span>
  <span class="c1"># NoMemoryError等の致命的な例外まで捕捉してしまうので良くない</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">send_to_mail</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">ex</span>
  <span class="c1"># すべての実行時エラー(＝ StandardErrorとそのサブクラス)が捕捉される</span>
<span class="k">end</span>
</pre></div></div>

<ul>
<li>参考: <a href="http://qiita.com/jnchito/items/a6046733dd5683ff35b7" class="autolink" id="reference-4781ab71b7949ba981b4">http://qiita.com/jnchito/items/a6046733dd5683ff35b7</a>
</li>
</ul>

<h3>
<span id="一度rescueした例外をもう一度再raiseする" class="fragment"></span><a href="#%E4%B8%80%E5%BA%A6rescue%E3%81%97%E3%81%9F%E4%BE%8B%E5%A4%96%E3%82%92%E3%82%82%E3%81%86%E4%B8%80%E5%BA%A6%E5%86%8Draise%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>一度rescueした例外をもう一度再raiseする</h3>

<p>「ある特定の例外クラス」だけでなく、「例外メッセージの中身」も確認して条件に合致すればrescue、そうでなければ対象外のエラーなのでそのままシステムエラーにしたい、というケースがたまにあります。</p>

<p>その場合はrescue節の中で<code>raise</code>を呼ぶと元のエラーを再raiseできます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">send_to_mail</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">ArgumentError</span> <span class="o">=&gt;</span> <span class="n">ex</span>
  <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">message</span> <span class="o">=~</span> <span class="sr">/blah blah blah/</span>
    <span class="c1"># ArgumentErrorかつ、メッセージも条件に合致すれば</span>
    <span class="c1"># 別の処理を実行してそのまま続行する</span>
    <span class="n">send_to_admin</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="c1"># メッセージが条件に合致しなかった場合は対処不能なエラーとして</span>
    <span class="c1"># 元のエラーを再度raiseする</span>
    <span class="k">raise</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="private-以下の行にクラスメソッドを定義してprivateなクラスメソッドを作ったと勘違いしない" class="fragment"></span><a href="#private-%E4%BB%A5%E4%B8%8B%E3%81%AE%E8%A1%8C%E3%81%AB%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%97%E3%81%A6private%E3%81%AA%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%9F%E3%81%A8%E5%8B%98%E9%81%95%E3%81%84%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>private 以下の行にクラスメソッドを定義して、privateなクラスメソッドを作ったと勘違いしない</h3>

<p>以下のようにprivateの下にインスタンスメソッドとクラスメソッドを定義したとします。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">secret_name</span>
    <span class="c1"># 外部から呼ばれたくないインスタンスメソッド</span>
    <span class="s2">"secret!"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">secret_data</span>
    <span class="c1"># 外部から呼ばれたくないクラスメソッド！？</span>
    <span class="s2">"secret!!"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>上のコードを実行すると、<code>secret_name</code>は呼び出せませんが、<code>self.secret_data</code>呼び出すことが可能です。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>

<span class="c1"># 呼び出せない</span>
<span class="n">user</span><span class="o">.</span><span class="n">secret_name</span>
<span class="c1"># =&gt; NoMethodError: private method `secret_name' called for #&lt;User:0x007fa90c1e7cd0&gt;</span>

<span class="c1"># 呼び出せる</span>
<span class="no">User</span><span class="o">.</span><span class="n">secret_data</span>
<span class="c1"># =&gt; "secret!!"</span>
</pre></div></div>

<p>以下のように<code>private_class_method</code>を付けると、外部から呼び出せなくなります。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">secret_name</span>
    <span class="c1"># 外部から呼ばれたくないインスタンスメソッド</span>
    <span class="s2">"secret!"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">secret_data</span>
    <span class="c1"># 外部から呼ばれたくないクラスメソッド</span>
    <span class="s2">"secret!!"</span>
  <span class="k">end</span>

  <span class="c1"># secret_dataをprivateなクラスメソッドにする</span>
  <span class="nb">private_class_method</span> <span class="ss">:secret_data</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="no">User</span><span class="o">.</span><span class="n">secret_data</span>
<span class="c1"># =&gt; NoMethodError: private method `secret_data' called for User:Class</span>
</pre></div></div>

<p>ですが、privateなインスタンスメソッドを作るときに比べると手間がかかるので、「どうしても」という場合以外は「クラスメソッドはpublicのままにしておく」という選択肢もアリかもしれません。<br>
（そもそもクラスメソッドを多用しすぎている場合は、クラス設計に何か問題がある可能性が高いです）</p>

<p>参考： <a href="http://tmtms.hatenablog.com/entry/20100629/ruby_private_class_method" rel="nofollow noopener" target="_blank">クラスメソッドのprivate化 - @tmtms のメモ</a></p>

<h3>
<span id="privateメソッドはそのクラスでしか呼び出せないと勘違いしない" class="fragment"></span><a href="#private%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%E3%81%9D%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A7%E3%81%97%E3%81%8B%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%9B%E3%81%AA%E3%81%84%E3%81%A8%E5%8B%98%E9%81%95%E3%81%84%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>privateメソッドはそのクラスでしか呼び出せない、と勘違いしない</h3>

<p>以下のようにprivateなインスタンスメソッド（<code>secret_price</code>）を定義したとします。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Item</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">secret_price</span>
    <span class="mi">1000</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>さらに、上の<code>Item</code>クラスを継承したクラスを定義します。この中で<code>secret_price</code>メソッドを呼び出すようにします。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">Item</span>
  <span class="k">def</span> <span class="nf">public_price</span>
    <span class="n">secret_price</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>すると、<code>Book</code>クラスのインスタンスから問題なく（<code>public_price</code>メソッド経由で）<code>secret_price</code>メソッドを呼び出すことができます。 </p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">new</span>
<span class="n">book</span><span class="o">.</span><span class="n">public_price</span>
<span class="c1"># =&gt; 1000</span>
</pre></div></div>

<p>Javaや.NETの経験が長いと、privateメソッドはそのクラスでしか呼び出せないと思ってしまいがちですが、Rubyでは継承先でprivateメソッドが呼ばれる可能性があります。<br>
そのクラスの中で呼び出されていないからといって安易にprivateメソッドを削除すると、継承先のクラスで呼び出されたときにエラーが発生するかもしれないので気をつけてください。</p>

<p>参考：<a href="http://blog.jnito.com/entry/20120315/1331754912" rel="nofollow noopener" target="_blank">JavaやC#の常識が通用しないRubyのprivateメソッド - give IT a try</a> </p>

<h3>
<span id="size---1ではなくマイナスのインデックスで最後の文字や要素を指定する" class="fragment"></span><a href="#size---1%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E3%83%9E%E3%82%A4%E3%83%8A%E3%82%B9%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%A7%E6%9C%80%E5%BE%8C%E3%81%AE%E6%96%87%E5%AD%97%E3%82%84%E8%A6%81%E7%B4%A0%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>size - 1ではなく、マイナスのインデックスで最後の文字や要素を指定する</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="o">]</span>
<span class="nb">name</span> <span class="o">=</span> <span class="s1">'Taro Yamada'</span>

<span class="n">numbers</span><span class="o">[</span><span class="n">numbers</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="c1"># =&gt; 5</span>
<span class="nb">name</span><span class="o">[</span><span class="nb">name</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="c1"># =&gt; 'a'</span>

<span class="n">numbers</span><span class="o">[</span><span class="mi">1</span><span class="o">..</span><span class="n">numbers</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="o">]</span> <span class="c1"># =&gt; [2, 3, 4]</span>
<span class="nb">name</span><span class="o">[</span><span class="mi">1</span><span class="o">..</span><span class="n">name</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="o">]</span> <span class="c1"># =&gt; "aro Yamad"</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="o">]</span>
<span class="nb">name</span> <span class="o">=</span> <span class="s1">'Taro Yamada'</span>

<span class="n">numbers</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span> <span class="c1"># =&gt; 5</span>
<span class="nb">name</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span> <span class="c1"># =&gt; 'a'</span>

<span class="n">numbers</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">2</span><span class="o">]</span> <span class="c1"># =&gt; [2, 3, 4]</span>
<span class="nb">name</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">2</span><span class="o">]</span> <span class="c1"># =&gt; "aro Yamad"</span>
</pre></div></div>

<h3>
<span id="配列の便利なメソッドいろいろ" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AE%E4%BE%BF%E5%88%A9%E3%81%AA%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%84%E3%82%8D%E3%81%84%E3%82%8D"><i class="fa fa-link"></i></a>配列の便利なメソッドいろいろ</h3>

<h4>
<span id="find-最初に見つかったものを返す" class="fragment"></span><a href="#find-%E6%9C%80%E5%88%9D%E3%81%AB%E8%A6%8B%E3%81%A4%E3%81%8B%E3%81%A3%E3%81%9F%E3%82%82%E3%81%AE%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>find: 最初に見つかったものを返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_admin</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
  <span class="k">end</span>
  <span class="kp">nil</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_admin</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:admin?</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>最初の見つかった要素のインデックスを返す場合は<code>find_index</code>。</p>

<h4>
<span id="select-条件に合うものすべてを返す" class="fragment"></span><a href="#select-%E6%9D%A1%E4%BB%B6%E3%81%AB%E5%90%88%E3%81%86%E3%82%82%E3%81%AE%E3%81%99%E3%81%B9%E3%81%A6%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>select: 条件に合うものすべてを返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_admins</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">admins</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">admins</span> <span class="o">&lt;&lt;</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
  <span class="k">end</span>
  <span class="n">admins</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_admins</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:admin?</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p><code>select</code>とは反対で<code>false</code>になる要素だけを集める場合は<code>reject</code>。</p>

<h4>
<span id="count-条件に合う要素の数を返す" class="fragment"></span><a href="#count-%E6%9D%A1%E4%BB%B6%E3%81%AB%E5%90%88%E3%81%86%E8%A6%81%E7%B4%A0%E3%81%AE%E6%95%B0%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>count: 条件に合う要素の数を返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">count_admin</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
  <span class="k">end</span>
  <span class="n">count</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">count_admin</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:admin?</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h4>
<span id="map-ある配列から別の配列を作る" class="fragment"></span><a href="#map-%E3%81%82%E3%82%8B%E9%85%8D%E5%88%97%E3%81%8B%E3%82%89%E5%88%A5%E3%81%AE%E9%85%8D%E5%88%97%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>map: ある配列から別の配列を作る</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user_names</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">names</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">names</span> <span class="o">&lt;&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
  <span class="k">end</span>
  <span class="n">names</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user_names</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h4>
<span id="flat_map-mapの結果をネストしないフラットな配列として受け取る" class="fragment"></span><a href="#flat_map-map%E3%81%AE%E7%B5%90%E6%9E%9C%E3%82%92%E3%83%8D%E3%82%B9%E3%83%88%E3%81%97%E3%81%AA%E3%81%84%E3%83%95%E3%83%A9%E3%83%83%E3%83%88%E3%81%AA%E9%85%8D%E5%88%97%E3%81%A8%E3%81%97%E3%81%A6%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B"><i class="fa fa-link"></i></a>flat_map: mapの結果をネストしないフラットな配列として受け取る</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">nested_array</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="o">]]</span>
<span class="n">mapped_array</span> <span class="o">=</span> <span class="n">nested_array</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">array</span><span class="o">|</span> <span class="n">array</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">}</span> <span class="p">}</span>
<span class="c1"># =&gt; [[10, 20, 30], [40, 50, 60]]</span>
<span class="n">flat_array</span> <span class="o">=</span> <span class="n">mapped_array</span><span class="o">.</span><span class="n">flatten</span>
<span class="c1"># =&gt; [10, 20, 30, 40, 50, 60]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">nested_array</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="o">]]</span>
<span class="n">flat_array</span> <span class="o">=</span> <span class="n">nested_array</span><span class="o">.</span><span class="n">flat_map</span> <span class="p">{</span><span class="o">|</span><span class="n">array</span><span class="o">|</span> <span class="n">array</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">}</span> <span class="p">}</span>
<span class="c1"># =&gt; [10, 20, 30, 40, 50, 60]</span>
</pre></div></div>

<h4>
<span id="compact-nil以外の要素を集める" class="fragment"></span><a href="#compact-nil%E4%BB%A5%E5%A4%96%E3%81%AE%E8%A6%81%E7%B4%A0%E3%82%92%E9%9B%86%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>compact: nil以外の要素を集める</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">numbmers_and_nil</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span>
<span class="n">only_numbers</span> <span class="o">=</span> <span class="n">numbmers_and_nil</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:nil?</span><span class="p">)</span> <span class="c1"># =&gt; [1, 2, 3, 6]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">numbers_and_nil</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span>
<span class="n">only_numbers</span> <span class="o">=</span> <span class="n">numbers_and_nil</span><span class="o">.</span><span class="n">compact</span> <span class="c1"># =&gt; [1, 2, 3, 6]</span>
</pre></div></div>

<h4>
<span id="any-最低でも1つ条件に合う要素があればtrueを返す" class="fragment"></span><a href="#any-%E6%9C%80%E4%BD%8E%E3%81%A7%E3%82%821%E3%81%A4%E6%9D%A1%E4%BB%B6%E3%81%AB%E5%90%88%E3%81%86%E8%A6%81%E7%B4%A0%E3%81%8C%E3%81%82%E3%82%8C%E3%81%B0true%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>any?: 最低でも1つ条件に合う要素があればtrueを返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">contains_nil?</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>
  <span class="kp">false</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">contains_nil?</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">any?</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:nil?</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>すべての要素が条件に合っている場合に<code>true</code>を返す場合は<code>all?</code>。</p>

<h4>
<span id="empty-1件もなければtrueを返す" class="fragment"></span><a href="#empty-1%E4%BB%B6%E3%82%82%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0true%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>empty?: 1件もなければtrueを返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">puts</span> <span class="s2">"empty!"</span> <span class="k">if</span> <span class="n">users</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">puts</span> <span class="s2">"empty!"</span> <span class="k">if</span> <span class="n">users</span><span class="o">.</span><span class="n">empty?</span>
</pre></div></div>

<h4>
<span id="firstlast-最初と最後の要素を返す" class="fragment"></span><a href="#firstlast-%E6%9C%80%E5%88%9D%E3%81%A8%E6%9C%80%E5%BE%8C%E3%81%AE%E8%A6%81%E7%B4%A0%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>first/last: 最初と最後の要素を返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">first_user</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
<span class="n">last_user</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="n">users</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">first_user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
<span class="n">last_user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">last</span>
</pre></div></div>

<h4>
<span id="sample-任意の要素を返す" class="fragment"></span><a href="#sample-%E4%BB%BB%E6%84%8F%E3%81%AE%E8%A6%81%E7%B4%A0%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>sample: 任意の要素を返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">users</span><span class="o">[</span><span class="nb">rand</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">users</span><span class="o">.</span><span class="n">sample</span>
</pre></div></div>

<h4>
<span id="each_with_index-eachでループしつつカウンタも同時に取得する" class="fragment"></span><a href="#each_with_index-each%E3%81%A7%E3%83%AB%E3%83%BC%E3%83%97%E3%81%97%E3%81%A4%E3%81%A4%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%82%82%E5%90%8C%E6%99%82%E3%81%AB%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>each_with_index: eachでループしつつ、カウンタも同時に取得する</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">", "</span> <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
  <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">users</span><span class="o">.</span><span class="n">each_with_index</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">counter</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">", "</span> <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="k">end</span>
</pre></div></div>

<h4>
<span id="ループ処理系のメソッド--with_index-カウンタ付きで元のループ処理を実行する" class="fragment"></span><a href="#%E3%83%AB%E3%83%BC%E3%83%97%E5%87%A6%E7%90%86%E7%B3%BB%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89--with_index-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E4%BB%98%E3%81%8D%E3%81%A7%E5%85%83%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%97%E5%87%A6%E7%90%86%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ループ処理系のメソッド + with_index: カウンタ付きで元のループ処理を実行する</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">users_with_index</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="o">[</span><span class="n">counter</span><span class="p">,</span> <span class="n">user</span><span class="o">]</span>
  <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">users_with_index</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">counter</span><span class="o">|</span>
  <span class="o">[</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">]</span>
<span class="k">end</span>
</pre></div></div>

<p><code>with_index</code>はカウンタの初期値を指定できます。（デフォルトはゼロ）<br>
なので、上のコードは次のように書いても同じです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">users_with_index</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">with_index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">counter</span><span class="o">|</span>
  <span class="o">[</span><span class="n">counter</span><span class="p">,</span> <span class="n">user</span><span class="o">]</span>
<span class="k">end</span>
</pre></div></div>

<h4>
<span id="join-配列を1つの文字列として返す" class="fragment"></span><a href="#join-%E9%85%8D%E5%88%97%E3%82%921%E3%81%A4%E3%81%AE%E6%96%87%E5%AD%97%E5%88%97%E3%81%A8%E3%81%97%E3%81%A6%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>join: 配列を1つの文字列として返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">numbers_text</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="s1">''</span>
  <span class="n">numbers</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">number</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
    <span class="n">text</span> <span class="o">+=</span> <span class="s1">', '</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">text</span> <span class="o">+=</span> <span class="n">number</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span>
  <span class="n">text</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">numbers_text</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
  <span class="n">numbers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span> <span class="c1"># [1, 2, 3] =&gt; "1, 2, 3"</span>
<span class="k">end</span>
</pre></div></div>

<h4>
<span id="maxmax_by-最大の要素を返す" class="fragment"></span><a href="#maxmax_by-%E6%9C%80%E5%A4%A7%E3%81%AE%E8%A6%81%E7%B4%A0%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>max/max_by: 最大の要素を返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">oldest_user</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">oldest</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">oldest</span> <span class="o">=</span> <span class="n">user</span> <span class="k">if</span> <span class="n">oldest</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="n">oldest</span><span class="o">.</span><span class="n">age</span>
  <span class="k">end</span>
  <span class="n">oldet</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">oldest_user</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">max_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:age</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>単純な数値や文字列の配列なら<code>numbers.max</code>だけでもOK。<br>
最小の要素を返す場合は<code>min</code>や<code>min_by</code>を使う。</p>

<h4>
<span id="each_with_object-ループを回しつつ別のオブジェクトを組み立ててそれを返す" class="fragment"></span><a href="#each_with_object-%E3%83%AB%E3%83%BC%E3%83%97%E3%82%92%E5%9B%9E%E3%81%97%E3%81%A4%E3%81%A4%E5%88%A5%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E7%B5%84%E3%81%BF%E7%AB%8B%E3%81%A6%E3%81%A6%E3%81%9D%E3%82%8C%E3%82%92%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>each_with_object: ループを回しつつ、別のオブジェクトを組み立ててそれを返す</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">admin_names</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
  <span class="k">end</span>
  <span class="n">ret</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">admin_names</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each_with_object</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">names</span><span class="o">|</span>
    <span class="n">names</span> <span class="o">&lt;&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>まあ、上のサンプルのような場合は<code>users.select(&amp;:admin?).map(&amp;:name)</code>って書けばいいんですけどね。</p>

<h4>
<span id="その他の情報源" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%83%85%E5%A0%B1%E6%BA%90"><i class="fa fa-link"></i></a>その他の情報源</h4>

<p>全部挙げていくとキリがないので、配列を操作するロジックを書く前にまず、<code>Array</code>や<code>Enumerable</code>のAPIドキュメントを読んで「車輪の再発明」をしていないかチェックしてください。</p>

<ul>
<li><a href="http://ruby-doc.org/core-2.0.0/Array.html" class="autolink" rel="nofollow noopener" target="_blank">http://ruby-doc.org/core-2.0.0/Array.html</a></li>
<li><a href="http://ruby-doc.org/core-2.0.0/Enumerable.html" class="autolink" rel="nofollow noopener" target="_blank">http://ruby-doc.org/core-2.0.0/Enumerable.html</a></li>
</ul>

<h3>
<span id="英語の文法や品詞を意識する" class="fragment"></span><a href="#%E8%8B%B1%E8%AA%9E%E3%81%AE%E6%96%87%E6%B3%95%E3%82%84%E5%93%81%E8%A9%9E%E3%82%92%E6%84%8F%E8%AD%98%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>英語の文法や品詞を意識する</h3>

<p>ケースバイケースで原則から外れる場合は十分ありえますが、文法や品詞の使いわけに明らかな逸脱(間違い)があると読み手が混乱します。</p>

<h4>
<span id="配列の変数名や配列を返すメソッド名は原則複数形にする" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AE%E5%A4%89%E6%95%B0%E5%90%8D%E3%82%84%E9%85%8D%E5%88%97%E3%82%92%E8%BF%94%E3%81%99%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%90%8D%E3%81%AF%E5%8E%9F%E5%89%87%E8%A4%87%E6%95%B0%E5%BD%A2%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>配列の変数名や配列を返すメソッド名は原則複数形にする</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># number = [1, 2, 3]</span>
<span class="n">numbers</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># def find_even_number(numbers)</span>
<span class="c1">#   numbers.select(&amp;:even?)</span>
<span class="c1"># end</span>

<span class="k">def</span> <span class="nf">find_even_numbers</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
  <span class="n">numbers</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:even?</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h4>
<span id="プロパティや変数名クラス名は原則名詞や形容詞に何かを操作するメソッドは原則動詞にする" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%82%84%E5%A4%89%E6%95%B0%E5%90%8D%E3%82%AF%E3%83%A9%E3%82%B9%E5%90%8D%E3%81%AF%E5%8E%9F%E5%89%87%E5%90%8D%E8%A9%9E%E3%82%84%E5%BD%A2%E5%AE%B9%E8%A9%9E%E3%81%AB%E4%BD%95%E3%81%8B%E3%82%92%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%E5%8E%9F%E5%89%87%E5%8B%95%E8%A9%9E%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>プロパティや変数名、クラス名は原則名詞や形容詞に、何かを操作するメソッドは原則動詞にする</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># reserve=予約する(動詞)、reserved=予約済みである(形容詞)</span>

<span class="c1"># chair.reserve?</span>
<span class="n">chair</span><span class="o">.</span><span class="n">reserved?</span> <span class="c1"># =&gt; false</span>

<span class="c1"># chair.reserved('Tom')</span>
<span class="n">chair</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span><span class="s1">'Tom'</span><span class="p">)</span>

<span class="n">chair</span><span class="o">.</span><span class="n">reserved?</span> <span class="c1"># =&gt; true</span>
</pre></div></div>

<p>その他、英語の使い方については以下の記事も参考になると思うので、あわせて読んでみてください。</p>

<p><a href="http://qiita.com/jnchito/items/459d58ba652bf4763820" id="reference-07d52428bc467bd2ade9">モデルやメソッドに名前を付けるときは英語の品詞に気をつけよう</a></p>

<h2>
<span id="rails編" class="fragment"></span><a href="#rails%E7%B7%A8"><i class="fa fa-link"></i></a>Rails編</h2>

<p>以下はRails開発時にのみ使えるイディオムやメソッドです。<br>
標準のRubyでは用意されていないので使えません。</p>

<p>ただし、大半のメソッドはActiveSupportのGemを導入することで使えるようになります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ gem install active_support
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'active_support/all'</span>

<span class="kp">nil</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; true</span>
</pre></div></div>

<h3>
<span id="nilチェックの代わりにobjecttrymethod_nameを使う" class="fragment"></span><a href="#nil%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%AE%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%ABobjecttrymethod_name%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>nilチェックの代わりにObject#try(:method_name)を使う</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">singleton?</span>
  <span class="n">singleton</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">first</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">singleton</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># childrenがnilならtry(:singleton?)はnilを返す</span>
<span class="c1"># nilでなければ、children.singleton?が普通に呼ばれる</span>
<span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:singleton?</span><span class="p">)</span>
  <span class="n">singleton</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">first</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">singleton</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="nilもしくは空っぽい値のチェックにblankpresentを使う" class="fragment"></span><a href="#nil%E3%82%82%E3%81%97%E3%81%8F%E3%81%AF%E7%A9%BA%E3%81%A3%E3%81%BD%E3%81%84%E5%80%A4%E3%81%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%ABblankpresent%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>「nil、もしくは空っぽい値」のチェックにblank?/present?を使う</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># String</span>
<span class="nb">name</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="nb">name</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; true</span>
<span class="nb">name</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nb">name</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; true</span>
<span class="nb">name</span> <span class="o">=</span> <span class="s2">" "</span>
<span class="nb">name</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; true</span>
<span class="nb">name</span> <span class="o">=</span> <span class="s2">"Tom"</span>
<span class="nb">name</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; false</span>

<span class="c1"># Array</span>
<span class="n">numbers</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="n">numbers</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; true</span>
<span class="n">numbers</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">numbers</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; true</span>
<span class="n">numbers</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="n">numbers</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; false</span>

<span class="c1"># Hash</span>
<span class="n">params</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="n">params</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; true</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">params</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; true</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Tom"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"hoge@hoge.com"</span> <span class="p">}</span>
<span class="n">params</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># =&gt; false</span>
</pre></div></div>

<p><code>present?</code>は<code>blank?</code>の反対で、「空ではない値」のときに<code>true</code>を返します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># String</span>
<span class="nb">name</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nb">name</span><span class="o">.</span><span class="n">present?</span> <span class="c1"># =&gt; false</span>
<span class="nb">name</span> <span class="o">=</span> <span class="s2">"Tom"</span>
<span class="nb">name</span><span class="o">.</span><span class="n">present?</span> <span class="c1"># =&gt; true</span>
</pre></div></div>

<h3>
<span id="空なら別の値を代入の代わりにpresenceを使う" class="fragment"></span><a href="#%E7%A9%BA%E3%81%AA%E3%82%89%E5%88%A5%E3%81%AE%E5%80%A4%E3%82%92%E4%BB%A3%E5%85%A5%E3%81%AE%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%ABpresence%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>「空なら別の値を代入」の代わりにpresenceを使う</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">blank?</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="s2">"What's your name?"</span>
<span class="k">else</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">presence</span> <span class="o">||</span> <span class="s2">"What's your name?"</span>
</pre></div></div>

<p><code>"".presence</code>や<code>[].presence</code>は<code>nil</code>を返すので注意してください。(<code>blank?</code>かどうかを判別しているため)</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">name</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nb">puts</span> <span class="nb">name</span><span class="o">.</span><span class="n">presence</span> <span class="o">||</span> <span class="s2">"What's your name?"</span> <span class="c1"># =&gt; What's your name?</span>
</pre></div></div>

<p><strong>2014.11.12 追記</strong><br>
<code>presence</code> を使うと便利なイディオムがありました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Newsが1件でも存在すればメール送信＆ツイート発信</span>
<span class="n">good_news</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">good_news</span>
<span class="k">if</span> <span class="n">good_news</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="n">send_mail</span><span class="p">(</span><span class="n">good_news</span><span class="p">)</span>
  <span class="n">tweet</span><span class="p">(</span><span class="n">good_news</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>上のようなコードはpresenceを使うと一行で代入と条件判断ができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">good_news</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">good_news</span><span class="o">.</span><span class="n">presence</span>
  <span class="n">send_mail</span><span class="p">(</span><span class="n">good_news</span><span class="p">)</span>
  <span class="n">tweet</span><span class="p">(</span><span class="n">good_news</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p><code>company.good_news.presence</code> は <code>company.good_news</code> が0件だと <code>nil</code> が返るので <code>false</code> 扱いになり、if文の中が実行されません。</p>

<p>同様に、「文字列に何かしらの値が入っている場合」を分岐させるケースでも役立ちます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># nameがnilや空文字列（""）だったらメッセージを表示したくない</span>
<span class="nb">name</span> <span class="o">=</span> <span class="n">blog</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="k">if</span> <span class="nb">name</span><span class="o">.</span><span class="n">present?</span>
  <span class="n">show_message</span><span class="p">(</span><span class="s2">"Hello, </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">!"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">name</span> <span class="o">=</span> <span class="n">blog</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">presence</span>
  <span class="n">show_message</span><span class="p">(</span><span class="s2">"Hello, </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">!"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="存在の有無を確認する場合はblankpresentを積極的に使う" class="fragment"></span><a href="#%E5%AD%98%E5%9C%A8%E3%81%AE%E6%9C%89%E7%84%A1%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AFblankpresent%E3%82%92%E7%A9%8D%E6%A5%B5%E7%9A%84%E3%81%AB%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>存在の有無を確認する場合はblank?/present?を積極的に使う</h3>

<p>Rubyの標準APIでは<code>nil?</code>や<code>empty?</code>のように「無い」を表すメソッドしかないので、「もしあるなら」をコードで表現するとぎこちなくなります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">user</span>
  <span class="c1"># userがいれば、何かを実行する</span>
  <span class="c1"># =&gt;「もしuserがいれば」ではなく「もしuserなら」と読めてしまう</span>
<span class="k">end</span>

<span class="k">unless</span> <span class="n">users</span><span class="o">.</span><span class="n">empty?</span>
  <span class="c1"># usersが空ではないなら、何かを実行する</span>
  <span class="c1"># =&gt; empty?の逆がないので、否定形で条件を書かざるを得ない</span>
<span class="k">end</span>
</pre></div></div>

<p>Railsであれば、<code>present?</code>を使って「もしあれば」を明示的に書くことができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">present?</span>
  <span class="c1"># userがいれば、何かを実行する</span>
  <span class="c1"># =&gt;「もしuserがいれば」と明示的に読める</span>
<span class="k">end</span>

<span class="k">if</span> <span class="n">users</span><span class="o">.</span><span class="n">present?</span>
  <span class="c1"># usersに1つ以上の要素があれば、何かを実行する</span>
  <span class="c1"># =&gt; 肯定形で条件が書ける</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="文字列の存在チェックはnilではなくblankを積極的に使う" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E5%AD%98%E5%9C%A8%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%AFnil%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Fblank%E3%82%92%E7%A9%8D%E6%A5%B5%E7%9A%84%E3%81%AB%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>文字列の存在チェックはnil?ではなく、blank?を積極的に使う</h3>

<p>「文字列に値が入っていない」状態は<code>nil</code>と<code>""</code>の区別をしないことが多いと思います。<br>
(<code>nil</code>は空白だが<code>""</code>は空白ではない、とわざわざ区別することはほとんどないはず)</p>

<p><code>nil?</code>を使うと<code>""</code>は入力済みであるというような条件文を書いてしまう恐れがあります。<br>
なのでRailsでは<code>nil?</code>の代わりに<code>blank?</code>を使う癖を付けておく方が良いです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">email</span><span class="o">.</span><span class="n">nil?</span>
  <span class="c1"># =&gt; emailが "" なら入力済みとして扱われてしまい、コールされない</span>
  <span class="nb">puts</span> <span class="s2">"Please input email!"</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">email</span><span class="o">.</span><span class="n">blank?</span>
  <span class="c1"># =&gt; emailが "" や " " の場合でも未入力と扱われるので、コールされる</span>
  <span class="nb">puts</span> <span class="s2">"Please input email!"</span>
<span class="k">end</span>
</pre></div></div>

<p>同じ理由でModelの<code>validates</code>で指定するオプションも、特別な理由が無い限り<code>allow_nil: true</code>ではなく、<code>allow_blank: true</code>を使うようにしましょう。</p>

<ul>
<li>参考: <a href="http://edgeguides.rubyonrails.org/active_record_validations.html#common-validation-options" class="autolink" rel="nofollow noopener" target="_blank">http://edgeguides.rubyonrails.org/active_record_validations.html#common-validation-options</a>
</li>
</ul>

<h3>
<span id="ロジックではなくクエリでフィルタリングする" class="fragment"></span><a href="#%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%A7%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ロジックではなく、クエリでフィルタリングする</h3>

<p>Ruby編で配列の便利なメソッドをいろいろ紹介しましたが、RailsのModelをフィルタリングしたい場合は配列を操作するのではなく、データベース(SQL)上でフィルタリングした方が効率的です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">admin_users</span>
  <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:admin?</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">admin_users</span>
  <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="mapではなくpluckを使う" class="fragment"></span><a href="#map%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Fpluck%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>mapではなく、pluckを使う</h3>

<p><code>pluck</code>を使うと必要なカラムだけをデータベースから取得するので処理効率が良くなります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">admin_user_ids</span>
  <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">admin_user_ids</span>
  <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="tap-の代わりに-new--ブロックを使う" class="fragment"></span><a href="#tap-%E3%81%AE%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%AB-new--%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>tap の代わりに new + ブロックを使う</h3>

<p>ActiveRecordであれば <code>new</code> に直接ブロックを渡して、プロパティをセットすることができます。<br>
（ <a href="/sachin21" class="user-mention js-hovercard" title="sachin21" data-hovercard-target-type="user" data-hovercard-target-name="sachin21">@sachin21</a> さん、コメントありがとうございます！ ）</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_user</span>
  <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"hoge@hoge.com"</span>
    <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Taro Yamada"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_user</span>
  <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"hoge@hoge.com"</span>
    <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Taro Yamada"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="railsにおけるタイムゾーンの扱いを理解する" class="fragment"></span><a href="#rails%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%BE%E3%83%BC%E3%83%B3%E3%81%AE%E6%89%B1%E3%81%84%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Railsにおけるタイムゾーンの扱いを理解する</h3>

<p>Railsの場合、application.rbに設定したタイムゾーンが使われる場合と、環境変数 TZ に設定されたタイムゾーンが使われる場合の2パターンがあります。<br>
両者のタイムゾーン設定が異なる場合、予期せぬ不具合が生まれる恐れがあります。</p>

<p>そうした不具合を防ぐため、コード内ではapplication.rbに設定されたタイムゾーンを使うように統一することが望ましいです。<br>
具体的には、<code>Date.today</code>ではなく<code>Date.current</code>を、<code>Time.now</code>ではなく<code>Time.current</code>（または<code>Time.zone.now</code>）を使うようにしてください。</p>

<p>詳しい内容はこちらの記事にまとめてあるので読んでみてください。</p>

<p><a href="http://qiita.com/jnchito/items/cae89ee43c30f5d6fa2c" id="reference-736e0eb36801122e7fea">RubyとRailsにおけるTime, Date, DateTime, TimeWithZoneの違い</a></p>

<h3>
<span id="日付や日時の便利メソッドを活用する" class="fragment"></span><a href="#%E6%97%A5%E4%BB%98%E3%82%84%E6%97%A5%E6%99%82%E3%81%AE%E4%BE%BF%E5%88%A9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>日付や日時の便利メソッドを活用する</h3>

<h4>
<span id="システム日付から見た昨日明日を求める" class="fragment"></span><a href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%97%A5%E4%BB%98%E3%81%8B%E3%82%89%E8%A6%8B%E3%81%9F%E6%98%A8%E6%97%A5%E6%98%8E%E6%97%A5%E3%82%92%E6%B1%82%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>システム日付から見た昨日/明日を求める</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Date</span><span class="o">.</span><span class="n">current</span> <span class="c1"># =&gt; Tue, 05 Nov 2013</span>

<span class="no">Date</span><span class="o">.</span><span class="n">yesterday</span>  <span class="c1"># =&gt; Tue, 04 Nov 2013</span>
<span class="no">Date</span><span class="o">.</span><span class="n">tomorrow</span> <span class="c1"># =&gt;  # =&gt; Tue, 06 Nov 2013</span>
</pre></div></div>

<h4>
<span id="システム日時から見たxx年前後xxヶ月前後xx週間前後xx日前後etcを求める" class="fragment"></span><a href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%97%A5%E6%99%82%E3%81%8B%E3%82%89%E8%A6%8B%E3%81%9Fxx%E5%B9%B4%E5%89%8D%E5%BE%8Cxx%E3%83%B6%E6%9C%88%E5%89%8D%E5%BE%8Cxx%E9%80%B1%E9%96%93%E5%89%8D%E5%BE%8Cxx%E6%97%A5%E5%89%8D%E5%BE%8Cetc%E3%82%92%E6%B1%82%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>システム日時から見たxx年前/後、xxヶ月前/後、xx週間前/後、xx日前/後、etcを求める</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Date</span><span class="o">.</span><span class="n">current</span> <span class="c1"># =&gt; 2013-11-05</span>

<span class="mi">2</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">ago</span>   <span class="c1"># =&gt; 2011-11-05 06:21:40 +0900</span>
<span class="mi">2</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">since</span> <span class="c1"># =&gt; 2015-11-05 06:21:40 +0900</span>

<span class="mi">2</span><span class="o">.</span><span class="n">months</span><span class="o">.</span><span class="n">ago</span>   <span class="c1"># =&gt; 2013-09-05 06:21:40 +0900</span>
<span class="mi">2</span><span class="o">.</span><span class="n">months</span><span class="o">.</span><span class="n">since</span> <span class="c1"># =&gt; 2014-01-05 06:21:40 +0900</span>
</pre></div></div>

<p>weeks, days, hours, minutes, secondsでも同じように使えます。</p>

<h4>
<span id="特定の日付日時から見た昨日明日先週来週xx日前後etcを求める" class="fragment"></span><a href="#%E7%89%B9%E5%AE%9A%E3%81%AE%E6%97%A5%E4%BB%98%E6%97%A5%E6%99%82%E3%81%8B%E3%82%89%E8%A6%8B%E3%81%9F%E6%98%A8%E6%97%A5%E6%98%8E%E6%97%A5%E5%85%88%E9%80%B1%E6%9D%A5%E9%80%B1xx%E6%97%A5%E5%89%8D%E5%BE%8Cetc%E3%82%92%E6%B1%82%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>特定の日付/日時から見た昨日/明日、先週/来週、xx日前/後、etcを求める</h4>

<p>結果を求める方法は一つだけでなく、いろいろな書き方があります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">current</span> <span class="c1"># =&gt; 2013-11-05</span>

<span class="n">date</span><span class="o">.</span><span class="n">yesterday</span> <span class="c1"># =&gt; 2013-11-04</span>
<span class="n">date</span><span class="o">.</span><span class="n">tomoroow</span>  <span class="c1"># =&gt; 2013-11-06</span>

<span class="n">date</span><span class="o">.</span><span class="n">prev_day</span> <span class="c1"># =&gt; 2013-11-04</span>
<span class="n">date</span><span class="o">.</span><span class="n">next_day</span> <span class="c1"># =&gt; 2013-11-06</span>

<span class="n">date</span><span class="o">.</span><span class="n">prev_day</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># =&gt; 2013-11-03</span>
<span class="n">date</span><span class="o">.</span><span class="n">next_day</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># =&gt; 2013-11-07</span>

<span class="n">date</span> <span class="o">-</span> <span class="mi">2</span><span class="o">.</span><span class="n">days</span> <span class="c1"># =&gt; 2013-11-03</span>
<span class="n">date</span> <span class="o">+</span> <span class="mi">2</span><span class="o">.</span><span class="n">days</span> <span class="c1"># =&gt; 2013-11-07</span>

<span class="n">date</span><span class="o">.</span><span class="n">ago</span><span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>   <span class="c1"># =&gt; 2013-11-03</span>
<span class="n">date</span><span class="o">.</span><span class="n">since</span><span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="n">days</span><span class="p">)</span> <span class="c1"># =&gt; 2013-11-07</span>

<span class="n">date</span><span class="o">.</span><span class="n">prev_month</span> <span class="c1"># =&gt; 2013-10-05</span>
<span class="n">date</span><span class="o">.</span><span class="n">next_month</span> <span class="c1"># =&gt; 2013-12-05</span>

<span class="n">date</span><span class="o">.</span><span class="n">prev_month</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># =&gt; 2013-09-05</span>
<span class="n">date</span><span class="o">.</span><span class="n">next_month</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># =&gt; 2014-01-05</span>

<span class="n">date</span> <span class="o">-</span> <span class="mi">2</span><span class="o">.</span><span class="n">months</span> <span class="c1"># =&gt; 2013-09-05</span>
<span class="n">date</span> <span class="o">+</span> <span class="mi">2</span><span class="o">.</span><span class="n">months</span> <span class="c1"># =&gt; 2014-01-05</span>

<span class="n">date</span><span class="o">.</span><span class="n">months_ago</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># =&gt; 2013-09-05</span>
<span class="n">date</span><span class="o">.</span><span class="n">months_since</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># =&gt; 2014-01-05</span>

<span class="n">date</span><span class="o">.</span><span class="n">ago</span><span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="n">months</span><span class="p">)</span>   <span class="c1"># =&gt; 2013-09-05</span>
<span class="n">date</span><span class="o">.</span><span class="n">since</span><span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="n">months</span><span class="p">)</span> <span class="c1"># =&gt; 2014-01-05</span>
</pre></div></div>

<p>week, year等でも考え方は同じです。<br>
Time型でも使えます。</p>

<h4>
<span id="ある日付日時から見た始まりと終わりの日付日時を求める" class="fragment"></span><a href="#%E3%81%82%E3%82%8B%E6%97%A5%E4%BB%98%E6%97%A5%E6%99%82%E3%81%8B%E3%82%89%E8%A6%8B%E3%81%9F%E5%A7%8B%E3%81%BE%E3%82%8A%E3%81%A8%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AE%E6%97%A5%E4%BB%98%E6%97%A5%E6%99%82%E3%82%92%E6%B1%82%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>ある日付/日時から見た始まりと終わりの日付/日時を求める</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">current</span> <span class="c1"># =&gt; 2013-11-05</span>

<span class="n">date</span><span class="o">.</span><span class="n">beginning_of_month</span> <span class="c1"># =&gt; 2013-11-01</span>
<span class="n">date</span><span class="o">.</span><span class="n">end_of_month</span>       <span class="c1"># =&gt; 2013-11-30</span>

<span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span> <span class="c1"># =&gt; 2013-11-05 00:00:00 +0900</span>
<span class="n">date</span><span class="o">.</span><span class="n">end_of_day</span>       <span class="c1"># =&gt; 2013-11-05 23:59:59 +0900</span>

<span class="n">datetime</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">current</span> <span class="c1"># =&gt; 2013-11-05T06:43:53+09:00</span>

<span class="n">datetime</span><span class="o">.</span><span class="n">beginning_of_hour</span> <span class="c1"># =&gt; 2013-11-05T06:00:00+09:00</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">end_of_hour</span>       <span class="c1"># =&gt; 2013-11-05T06:59:59+09:00</span>
</pre></div></div>

<p>week, year等でも考え方は同じです。<br>
Time型でも使えます。</p>

<h4>
<span id="1日の初めから終わりまで月の初めから終わりまでといった範囲を求める" class="fragment"></span><a href="#1%E6%97%A5%E3%81%AE%E5%88%9D%E3%82%81%E3%81%8B%E3%82%89%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%BE%E3%81%A7%E6%9C%88%E3%81%AE%E5%88%9D%E3%82%81%E3%81%8B%E3%82%89%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%BE%E3%81%A7%E3%81%A8%E3%81%84%E3%81%A3%E3%81%9F%E7%AF%84%E5%9B%B2%E3%82%92%E6%B1%82%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>1日の初めから終わりまで、月の初めから終わりまで、といった範囲を求める</h4>

<p><code>all_xxx</code> メソッドを使うと、「xxxの始めから終わりまで」をRangeオブジェクトとして取得できます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">current</span>
<span class="c1"># =&gt; Mon, 23 Nov 2015 16:45:23 JST +09:00</span>

<span class="c1"># その日の始まりと終わりの日時を取得</span>
<span class="n">time</span><span class="o">.</span><span class="n">all_day</span>
<span class="c1"># =&gt; Mon, 23 Nov 2015 00:00:00 JST +09:00..Mon, 23 Nov 2015 23:59:59 JST +09:00</span>

<span class="c1"># その日から見た月の始まりと、月の終わりの日時を取得する</span>
<span class="n">time</span><span class="o">.</span><span class="n">all_month</span>
<span class="c1"># =&gt; Sun, 01 Nov 2015 00:00:00 JST +09:00..Mon, 30 Nov 2015 23:59:59 JST +09:00</span>

<span class="c1"># その日から見た年の始まりと、年の終わりの日時を取得する</span>
<span class="n">time</span><span class="o">.</span><span class="n">all_year</span>
<span class="c1"># =&gt; Thu, 01 Jan 2015 00:00:00 JST +09:00..Thu, 31 Dec 2015 23:59:59 JST +09:00</span>
</pre></div></div>

<p>他にも<code>all_week</code>や<code>all_quarter</code>といったメソッドが定義されています。</p>

<h4>
<span id="ある日付から見た先週来週のxx曜日を求める" class="fragment"></span><a href="#%E3%81%82%E3%82%8B%E6%97%A5%E4%BB%98%E3%81%8B%E3%82%89%E8%A6%8B%E3%81%9F%E5%85%88%E9%80%B1%E6%9D%A5%E9%80%B1%E3%81%AExx%E6%9B%9C%E6%97%A5%E3%82%92%E6%B1%82%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>ある日付から見た先週/来週のxx曜日を求める</h4>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">current</span> <span class="c1"># =&gt; 2013-11-05</span>
<span class="n">date</span><span class="o">.</span><span class="n">tuesday?</span>     <span class="c1"># =&gt; true</span>

<span class="n">date</span><span class="o">.</span><span class="n">prev_week</span><span class="p">(</span><span class="ss">:monday</span><span class="p">)</span> <span class="c1"># =&gt; 2013-10-28</span>
<span class="n">date</span><span class="o">.</span><span class="n">next_week</span><span class="p">(</span><span class="ss">:monday</span><span class="p">)</span> <span class="c1"># =&gt; 2013-11-11</span>
</pre></div></div>

<p>他の曜日でも考え方は同じです。</p>

<h4>
<span id="その他の情報源-1" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%83%85%E5%A0%B1%E6%BA%90-1"><i class="fa fa-link"></i></a>その他の情報源</h4>

<p>日付、日時の操作例を挙げ始めるとキリがないので、詳しくはActiveSupportのAPIを参照してください。</p>

<ul>
<li><a href="http://guides.rubyonrails.org/active_support_core_extensions.html" class="autolink" rel="nofollow noopener" target="_blank">http://guides.rubyonrails.org/active_support_core_extensions.html</a></li>
</ul>

<h3>
<span id="語形やフォーマットを変える-20131114追記" class="fragment"></span><a href="#%E8%AA%9E%E5%BD%A2%E3%82%84%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B-20131114%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>語形やフォーマットを変える (2013.11.14追記)</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># キャメルケースにする</span>
<span class="s2">"my_book"</span><span class="o">.</span><span class="n">camelize</span> <span class="c1"># =&gt; "MyBook"</span>

<span class="c1"># アンダースコア区切り(スネークケース)にする</span>
<span class="s2">"MyBook"</span><span class="o">.</span><span class="n">underscore</span> <span class="c1"># =&gt; "my_book"</span>

<span class="c1"># ダッシュ(ハイフン)区切りにする</span>
<span class="s2">"my_book"</span><span class="o">.</span><span class="n">dasherize</span> <span class="c1"># =&gt; "my-book"</span>

<span class="c1"># 複数形にする</span>
<span class="s2">"book"</span><span class="o">.</span><span class="n">pluralize</span>            <span class="c1"># =&gt; "books"</span>
<span class="s2">"person"</span><span class="o">.</span><span class="n">pluralize</span>          <span class="c1"># =&gt; "people"</span>
<span class="s2">"fish"</span><span class="o">.</span><span class="n">pluralize</span>            <span class="c1"># =&gt; "fish"</span>
<span class="s2">"book_and_person"</span><span class="o">.</span><span class="n">pluralize</span> <span class="c1"># =&gt; "book_and_people"</span>
<span class="s2">"book and person"</span><span class="o">.</span><span class="n">pluralize</span> <span class="c1"># =&gt; "book and people"</span>
<span class="s2">"BookAndPerson"</span><span class="o">.</span><span class="n">pluralize</span>   <span class="c1"># =&gt; "BookAndPeople"</span>

<span class="c1"># 単数形にする</span>
<span class="s2">"books"</span><span class="o">.</span><span class="n">singularize</span>            <span class="c1"># =&gt; "book"</span>
<span class="s2">"people"</span><span class="o">.</span><span class="n">singularize</span>           <span class="c1"># =&gt; "person"</span>
<span class="s2">"books_and_people"</span><span class="o">.</span><span class="n">singularize</span> <span class="c1"># =&gt; "books_and_person"</span>
<span class="s2">"books and people"</span><span class="o">.</span><span class="n">singularize</span> <span class="c1"># =&gt; "books and person"</span>
<span class="s2">"BooksAndPeople"</span><span class="o">.</span><span class="n">singularize</span>   <span class="c1"># =&gt; "BooksAndPerson"</span>

<span class="c1"># 人間が読みやすくする(一文字目は大文字 + スペース区切り)</span>
<span class="s2">"my_books"</span><span class="o">.</span><span class="n">humanize</span> <span class="c1"># =&gt; "My books"</span>

<span class="c1"># タイトル形式にする(各単語の一文字目が大文字 + スペース区切り)</span>
<span class="s2">"my_books"</span><span class="o">.</span><span class="n">titleize</span> <span class="c1"># =&gt; "My Books"</span>

<span class="c1"># クラス名にする(キャメルケース + 単数形)</span>
<span class="s2">"my_book"</span><span class="o">.</span><span class="n">classify</span>  <span class="c1"># =&gt; "MyBook"</span>
<span class="s2">"my_books"</span><span class="o">.</span><span class="n">classify</span> <span class="c1"># =&gt; "MyBook"</span>

<span class="c1"># テーブル名にする(アンダースコア区切り + 複数形)</span>
<span class="s2">"my_book"</span><span class="o">.</span><span class="n">tableize</span> <span class="c1"># =&gt; "my_books"</span>
<span class="s2">"MyBook"</span><span class="o">.</span><span class="n">tableize</span>  <span class="c1"># =&gt; "my_books"</span>
</pre></div></div>

<h4>
<span id="その他の情報源-2" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%83%85%E5%A0%B1%E6%BA%90-2"><i class="fa fa-link"></i></a>その他の情報源</h4>

<p><code>constantize</code>や<code>demodulize</code>など、個人的に使用頻度が低そうだなと思ったメソッドは紹介しませんでした。<br>
他のメソッドも気になる方はRailsのAPIドキュメントを参照して下さい。</p>

<ul>
<li><a href="http://apidock.com/rails/String" class="autolink" rel="nofollow noopener" target="_blank">http://apidock.com/rails/String</a></li>
</ul>

<h3>
<span id="余分なスペースや改行を取り除く-20131114追記" class="fragment"></span><a href="#%E4%BD%99%E5%88%86%E3%81%AA%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%82%84%E6%94%B9%E8%A1%8C%E3%82%92%E5%8F%96%E3%82%8A%E9%99%A4%E3%81%8F-20131114%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>余分なスペースや改行を取り除く (2013.11.14追記)</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s2">"    My    </span><span class="se">\r\n</span><span class="s2">  </span><span class="se">\t</span><span class="s2">   </span><span class="se">\n</span><span class="s2">   books       "</span><span class="o">.</span><span class="n">squish</span> <span class="c1"># =&gt; "My books"</span>
</pre></div></div>

<h2>
<span id="まとめ-良いコードを書くために" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81-%E8%89%AF%E3%81%84%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8F%E3%81%9F%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>まとめ: 良いコードを書くために</h2>

<h3>
<span id="魚ではなく魚の釣り方を覚える" class="fragment"></span><a href="#%E9%AD%9A%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E9%AD%9A%E3%81%AE%E9%87%A3%E3%82%8A%E6%96%B9%E3%82%92%E8%A6%9A%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>魚ではなく、「魚の釣り方」を覚える</h3>

<p>「遠回り」や「車輪の再発明」をする前に、もっと良い書き方はないか、すでに同じメソッドが用意されていないか、書籍やAPIドキュメントをしっかり読みましょう。</p>

<ul>
<li>
<a href="http://goo.gl/ItJeDc" rel="nofollow noopener" target="_blank">プログラミング言語 Ruby</a> - オライリージャパン</li>
<li>
<a href="http://goo.gl/iu1Tc4" rel="nofollow noopener" target="_blank">Rails3レシピブック 190の技</a> - ソフトバンククリエイティブ</li>
<li>
<a href="http://ruby-doc.org" rel="nofollow noopener" target="_blank">ruby-doc.org</a>

<ul>
<li><a href="http://ruby-doc.org/core-2.0.0/String.html" rel="nofollow noopener" target="_blank">String</a></li>
<li><a href="http://ruby-doc.org/core-2.0.0/Array.html" rel="nofollow noopener" target="_blank">Array</a></li>
<li><a href="http://ruby-doc.org/core-2.0.0/Hash.html" rel="nofollow noopener" target="_blank">Hash</a></li>
<li><a href="http://ruby-doc.org/core-2.0.0/Enumerable.html" rel="nofollow noopener" target="_blank">Enumerable</a></li>
</ul>
</li>
<li>
<a href="http://guides.rubyonrails.org/" rel="nofollow noopener" target="_blank">RailsGuides</a>

<ul>
<li><a href="http://guides.rubyonrails.org/active_support_core_extensions.html" rel="nofollow noopener" target="_blank">Active Support Core Extensions</a></li>
<li><a href="http://guides.rubyonrails.org/active_record_querying.html" rel="nofollow noopener" target="_blank">Active Record Query Interface</a></li>
</ul>
</li>
</ul>

<h3>
<span id="チーム内でコードレビューをする" class="fragment"></span><a href="#%E3%83%81%E3%83%BC%E3%83%A0%E5%86%85%E3%81%A7%E3%82%B3%E3%83%BC%E3%83%89%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC%E3%82%92%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>チーム内でコードレビューをする</h3>

<p>書籍やAPIドキュメントだけでなく、同僚の知見も有効な情報源です。<br>
チーム内で定期的にコードレビューを行い、お互いの知見を交換しあいましょう。</p>

<p>また、コードの短さや簡潔さに凝りすぎると、独りよがりでわかりにくいコードを書いてしまう恐れもあるため、コードレビューを通じてチーム内で「わかりやすいコード」「わかりにくいコード」の判断基準を共有しておくことも重要です。</p>

<h2>
<span id="おまけ-トリビア的なテクニック" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91-%E3%83%88%E3%83%AA%E3%83%93%E3%82%A2%E7%9A%84%E3%81%AA%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>おまけ: トリビア的なテクニック</h2>

<p>こういう書き方もあるけど無理して使わなくても良いかも、と思うような記法も紹介しておきます。</p>

<h3>
<span id="1文字を表すのに文字を使う" class="fragment"></span><a href="#1%E6%96%87%E5%AD%97%E3%82%92%E8%A1%A8%E3%81%99%E3%81%AE%E3%81%AB%E6%96%87%E5%AD%97%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>「1文字」を表すのに「?+文字」を使う</h3>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s2">"index,new,create"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span> <span class="c1"># =&gt; ["index", "new", "create"]</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s2">"index,new,create"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sc">?,</span><span class="p">)</span> <span class="c1"># =&gt; ["index", "new", "create"]</span>
</pre></div></div>

<p>タイプ量は減りますが、直感的なわかりやすさに関しては微妙かも・・・。</p>

<h3>
<span id="配列を順番に処理するとき直接メソッドを呼ぶ代わりにmethodnameを使う" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%82%92%E9%A0%86%E7%95%AA%E3%81%AB%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E7%9B%B4%E6%8E%A5%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%91%BC%E3%81%B6%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%ABmethodname%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>配列を順番に処理するとき、直接メソッドを呼ぶ代わりに"&amp;method(:name)"を使う</h3>

<p>普通にブロックを書く方が一般的ですが、<code>&amp;method(:name)</code>みたいな引数を渡すこともできます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_users</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">process_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">process_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">user</span><span class="o">.</span><span class="n">mail_sent_at</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
  <span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_users</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">method</span><span class="p">(</span><span class="ss">:process_user</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">process_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">send_mail_to</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">user</span><span class="o">.</span><span class="n">mail_sent_at</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
  <span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="配列を順番に処理するときブロックを直接書く代わりにlambdaを使う" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%82%92%E9%A0%86%E7%95%AA%E3%81%AB%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%92%E7%9B%B4%E6%8E%A5%E6%9B%B8%E3%81%8F%E4%BB%A3%E3%82%8F%E3%82%8A%E3%81%ABlambda%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>配列を順番に処理するとき、ブロックを直接書く代わりにlambdaを使う</h3>

<p>複雑な条件式とかをlambdaにして明示的な名前を付けておくと多少読みやすくなるかも、です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">destroy_aged_admins</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">limit_age</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span>  <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="n">limit_age</span> <span class="p">}</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:destroy</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">destroy_aged_admins</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">limit_age</span><span class="p">)</span>
  <span class="n">aged_admin</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">){</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="n">limit_age</span> <span class="p">}</span>

  <span class="n">users</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aged_admin</span><span class="p">)</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:destroy</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<p>でも上のサンプルだとこう書いた方がわかりやすいかな。。。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">destroy_aged_admins</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">limit_age</span><span class="p">)</span>
  <span class="n">aged_admins</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="n">limit_age</span> <span class="p">}</span>
  <span class="n">aged_admins</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:destroy</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="何が何でもtrueかfalseで条件分岐させたいときを使う" class="fragment"></span><a href="#%E4%BD%95%E3%81%8C%E4%BD%95%E3%81%A7%E3%82%82true%E3%81%8Bfalse%E3%81%A7%E6%9D%A1%E4%BB%B6%E5%88%86%E5%B2%90%E3%81%95%E3%81%9B%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>何が何でもtrueかfalseで条件分岐させたいとき、!!を使う</h3>

<p>Rubyでは<code>false</code>と<code>nil</code>が<code>false</code>、それ以外の値がすべて<code>true</code>と評価されます。<br>
JavaやC#を長くやっていたので最初は僕も違和感がありましたが、使っているうちにこれはこれで良くできてるなと感じてきました。</p>

<p>しかし、世の中には「わしゃtrueかfalseで条件分岐させなきゃイヤなんぢゃ！！」というプログラマもいるかもしれません。<br>
そんな人は「イヤなんぢゃ！！」の<code>!!</code>を値の前に付ければ、Rubyが必ず<code>true</code>か<code>false</code>を返してくれます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">!!</span><span class="kp">nil</span>   <span class="c1"># =&gt; false</span>
<span class="o">!!</span><span class="kp">false</span> <span class="c1"># =&gt; false</span>
<span class="o">!!</span><span class="mi">0</span>     <span class="c1"># =&gt; true</span>
<span class="o">!![]</span>    <span class="c1"># =&gt; true</span>
<span class="o">!!</span><span class="kp">true</span>  <span class="c1"># =&gt; true</span>
</pre></div></div>

<p>実は<code>BasicObject</code>クラスには<code>!</code>というメソッドが用意されているので、こんな書き方もできます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="kp">nil</span><span class="o">.!.!</span>   <span class="c1"># =&gt; false</span>
<span class="kp">false</span><span class="o">.!.!</span> <span class="c1"># =&gt; false</span>
<span class="mi">0</span><span class="o">.!.!</span>     <span class="c1"># =&gt; true</span>
<span class="o">[].!.!</span>    <span class="c1"># =&gt; true</span>
<span class="kp">true</span><span class="o">.!.!</span>  <span class="c1"># =&gt; true</span>
</pre></div></div>

<p>このメソッドを使えば、<code>nil?</code>や<code>empty?</code>の逆も作れます。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="nb">puts</span> <span class="s2">"User exists!"</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span><span class="o">.!</span>
<span class="nb">puts</span> <span class="s2">"Some users exist!"</span> <span class="k">if</span> <span class="n">users</span><span class="o">.</span><span class="n">empty?</span><span class="o">.!</span>
</pre></div></div>

<p>・・・が、何もそこまでがんばる必要はないんじゃないかと僕は思います ^^;</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />2位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>296</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/fc8a61b421d026a23ffe">Rubyでメソッドの定義場所を見つける方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-13 16:27:26</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>RubyはModuleで組み込まれたメソッドや、<code>method_missing</code>を利用した「ゴーストメソッド」など、自分の見ているメソッドがそのクラス以外のどこで定義されているのか、分かりにくいケースがよくあります。<br>
特にJavaやC#から移ってきた僕のようなプログラマは、「メソッド = どこかのクラスで定義されているもの」という印象が強いので、「持ち主がよく分からないメソッド」の存在はデバッグ等で苦労させられます。</p>

<p>こういったケースでは、<code>Kernel#method</code>と<code>Method#source_location</code>を組み合わせることで、メソッドの定義場所を見つけることができます。<br>
たとえば、rails consoleで<code>blank?</code>メソッドの定義場所を見つけたい場合は、こんな感じです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails c
&gt; 'x'.method(:blank?).source_location
 =&gt; ["/Users/mypc/.rvm/gems/ruby-1.9.2-p320/gems/activesupport-3.2.3/lib/active_support/core_ext/object/blank.rb", 102] 
</pre></div></div>

<h3>
<span id="制限事項" class="fragment"></span><a href="#%E5%88%B6%E9%99%90%E4%BA%8B%E9%A0%85"><i class="fa fa-link"></i></a>制限事項</h3>

<ul>
<li>
<code>Method#source_location</code>はRuby 1.9以上でしか使えません。</li>
<li>irbやrails consoleで簡単にチェックできるメソッドならいいですが、gemの奥まった処理で使われているメソッドなどを調査しようと思うと、結構大変かもしれません。</li>
</ul>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<ul>
<li><a href="http://stackoverflow.com/questions/175655/how-to-find-where-a-method-is-defined-at-runtime" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/175655/how-to-find-where-a-method-is-defined-at-runtime</a></li>
</ul>

<h3>
<span id="20141210-追記" class="fragment"></span><a href="#20141210-%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>2014.12.10 追記</h3>

<p>最近はこの方法ではなく、 <strong>RubyMine</strong> を使ってます。<br>
RubyMine、便利！</p>

<p><a href="http://qiita.com/jnchito/items/bcb2bb5311a44113fdd9" id="reference-94fc9bef720673be708d">RubyMineのコードジャンプ機能は本当にすごい！！困ったときはCommand+Bを押すべし！</a></p>

<h3>
<span id="2017130-追記" class="fragment"></span><a href="#2017130-%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>2017.1.30 追記</h3>

<p>定数（クラス名やモジュール名を含む）の定義場所を調べたい場合はこちらの記事を参考にしてください。</p>

<p><a href="http://qiita.com/ksss/items/377eef080909564e4a25" id="reference-26aaaf0fb309fcab8811">Rubyでclassやconstの定義位置を調べる方法 - Qiita</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />3位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>256</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/7f41ff3df900909952db">[初心者向け] Railsで関連するデータ(親子関係)を保存する方法あれこれ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-21 05:58:34</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに-関連associationって何" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB-%E9%96%A2%E9%80%A3association%E3%81%A3%E3%81%A6%E4%BD%95"><i class="fa fa-link"></i></a>はじめに: 関連(association)って何？</h2>

<p>関連とはModel(データ)同士のつながりのことです。</p>

<p>単純な例で言うと、ブログの投稿(Post)とそれに対するコメント(Comment)は <strong>関連</strong> しています。<br>
たとえば以下のような1件の投稿と2件のコメントを考えてみます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>新しいMacBook Proを買いました！(投稿)
|-- わー、いいなあ！(コメント)
`-- うらやましすぎる！！(コメント)
</pre></div></div>

<p>上のデータを取得するRailsのコードはこんな感じになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span><span class="o">.</span><span class="n">text</span> <span class="c1">#=&gt; 新しいMacBook Proを買いました！</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 2</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; うらやましすぎる！！</span>
</pre></div></div>

<p>コメントから投稿を参照することもできます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">comment</span><span class="o">.</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
<span class="n">comment</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">text</span> <span class="c1">#=&gt; 新しいMacBook Proを買いました！</span>
</pre></div></div>

<p>親子関係で言い換えると、投稿が <strong>親</strong> で、コメントが <strong>子</strong> です。<br>
また、1件の投稿に対し、コメントは複数(0件以上)付けることができます。<br>
これをModelの定義で表現するとこのようになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Post</span>
  <span class="c1"># 投稿は複数のコメントを持つ。投稿から見るとコメントは子</span>
  <span class="n">has_many</span> <span class="ss">:comments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span>
  <span class="c1"># コメントから見ると投稿は親</span>
  <span class="n">belongs_to</span> <span class="ss">:post</span>
<span class="k">end</span>
</pre></div></div>

<p>ついでにクラス図も載せておきましょう。</p>

<p><a href="https://camo.qiitausercontent.com/a8a7a51b10de7084264e9dd3239f51d9c6f369a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f64646331393939652d666536642d376530342d633338612d6262623232316134626631622e6a706567" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a8a7a51b10de7084264e9dd3239f51d9c6f369a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f64646331393939652d666536642d376530342d633338612d6262623232316134626631622e6a706567" alt="diagram.jpg" title="diagram.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/ddc1999e-fe6d-7e04-c38a-bbb221a4bf1b.jpeg"></a></p>

<h2>
<span id="親子関係を保存する方法あれこれ" class="fragment"></span><a href="#%E8%A6%AA%E5%AD%90%E9%96%A2%E4%BF%82%E3%82%92%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%82%E3%82%8C%E3%81%93%E3%82%8C"><i class="fa fa-link"></i></a>親子関係を保存する方法あれこれ</h2>

<p>さて、データを取得するコードはわかりましたが、この親子関係を保存するときはどんなコードを書けば良いのでしょうか？</p>

<p>もしこんなコードを書いたとしても関連をうまく保存することはできません。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>
<span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>

<span class="c1"># 投稿にコメントが1件も付いていない</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 0</span>
</pre></div></div>

<p>親子関係を保存する方法はいくつかバリエーションがあるので、それを今から紹介していきます。</p>

<h3>
<span id="1-parentchildrencreate--parentchildrenbuild" class="fragment"></span><a href="#1-parentchildrencreate--parentchildrenbuild"><i class="fa fa-link"></i></a>1. parent.children.create / parent.children.build</h3>

<p><code>parent.children.create</code>の形式で子のデータを作ると関連が設定できます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>
<span class="n">comment</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 1</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
</pre></div></div>

<p><code>create</code>の代わりに<code>build</code>を使うこともできます。<br>
この場合、データは保存されません。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>
<span class="n">comment</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 1</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>

<span class="c1"># buildを使ったのでコメントは保存されていない</span>
<span class="n">comment</span><span class="o">.</span><span class="n">persisted?</span> <span class="c1">#=&gt; false</span>
</pre></div></div>

<h3>
<span id="2-parentchildren--child" class="fragment"></span><a href="#2-parentchildren--child"><i class="fa fa-link"></i></a>2. parent.children &lt;&lt; child</h3>

<p><code>parent.children &lt;&lt; child</code>という形式で関連を設定することもできます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>
<span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="n">comment</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 1</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
</pre></div></div>

<p><code>&lt;&lt;</code>を使うと、データが同時に保存されてしまう点に注意してください。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">comment</span><span class="o">.</span><span class="n">persisted?</span> <span class="c1">#=&gt; false</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="n">comment</span> <span class="c1"># コメントが保存される</span>
<span class="n">comment</span><span class="o">.</span><span class="n">persisted?</span> <span class="c1">#=&gt; true</span>
</pre></div></div>

<h4>
<span id="備考-parentchildren--children" class="fragment"></span><a href="#%E5%82%99%E8%80%83-parentchildren--children"><i class="fa fa-link"></i></a>[備考] parent.children = children</h4>

<p>同じような考え方で、<code>parent.children = children</code>という形式もあります。<br>
配列を渡すので複数のコメントを同時に設定できますが、既存のコメントは削除されるのが特殊な点です。<br>
使用する場合はこの副作用に十分注意してください。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>

<span class="n">comment_old</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"やった、コメント1番乗り！！"</span><span class="p">)</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="n">comment_old</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 1</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; やった、コメント1番乗り！！</span>

<span class="n">comment_1</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
<span class="n">comment_2</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"うらやましすぎる！！"</span><span class="p">)</span>
<span class="c1"># 新しい関連が保存されるのと同時に既存のコメントは削除される</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="o">[</span><span class="n">comment_1</span><span class="p">,</span> <span class="n">comment_2</span><span class="o">]</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 2</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; うらやましすぎる！！</span>

<span class="n">comment_1</span><span class="o">.</span><span class="n">persisted?</span> <span class="c1">#=&gt; true</span>
<span class="n">comment_2</span><span class="o">.</span><span class="n">persisted?</span> <span class="c1">#=&gt; true</span>
<span class="n">comment_old</span><span class="o">.</span><span class="n">destroyed?</span> <span class="c1">#=&gt; true</span>
</pre></div></div>

<h3>
<span id="3-childparent--parent" class="fragment"></span><a href="#3-childparent--parent"><i class="fa fa-link"></i></a>3. child.parent = parent</h3>

<p><code>child.parent = parent</code>というように、「子に親を設定する」という形式もあります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>
<span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">post</span>
<span class="n">comment</span><span class="o">.</span><span class="n">save</span> <span class="c1"># 関連を確定するためには子のsaveが必要</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 1</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
</pre></div></div>

<h4>
<span id="childnewparent-parent--childcreateparent-parent" class="fragment"></span><a href="#childnewparent-parent--childcreateparent-parent"><i class="fa fa-link"></i></a>Child.new(parent: parent) / Child.create(parent: parent)</h4>

<p>さらに、このバリエーションとして<code>new</code>や<code>create</code>の引数に親を渡す形式も考えられます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>
<span class="n">comment_1</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">,</span> <span class="ss">post</span><span class="p">:</span> <span class="n">post</span><span class="p">)</span>
<span class="n">comment_1</span><span class="o">.</span><span class="n">save</span>

<span class="n">comment_2</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"うらやましすぎる！！"</span><span class="p">,</span> <span class="ss">post</span><span class="p">:</span> <span class="n">post</span><span class="p">)</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 2</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; うらやましすぎる！！</span>
</pre></div></div>

<h3>
<span id="4-childparent_id--parent_id" class="fragment"></span><a href="#4-childparent_id--parent_id"><i class="fa fa-link"></i></a>4. child.parent_id = parent_id</h3>

<p>オブジェクトの代わりに親のidを子に設定する方法もあります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>
<span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">post_id</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span>
<span class="n">comment</span><span class="o">.</span><span class="n">save</span> <span class="c1"># 関連を確定するためには子のsaveが必要</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 1</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
</pre></div></div>

<h4>
<span id="childnewparent_id-parent_id--childcreateparent_id-parent_id" class="fragment"></span><a href="#childnewparent_id-parent_id--childcreateparent_id-parent_id"><i class="fa fa-link"></i></a>Child.new(parent_id: parent_id) / Child.create(parent_id: parent_id)</h4>

<p>idを設定する場合でも<code>new</code>や<code>create</code>を使うことができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span>
<span class="n">comment_1</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">,</span> <span class="ss">post_id</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">comment_1</span><span class="o">.</span><span class="n">save</span>

<span class="n">comment_2</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"うらやましすぎる！！"</span><span class="p">,</span> <span class="ss">post_id</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="c1">#=&gt; 2</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; わー、いいなあ！</span>
<span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">text</span> <span class="c1">#=&gt; うらやましすぎる！！</span>
</pre></div></div>

<p>親子関係を保存する主な方法はこんな感じです。</p>

<h2>
<span id="上の説明をrspecで表現する" class="fragment"></span><a href="#%E4%B8%8A%E3%81%AE%E8%AA%AC%E6%98%8E%E3%82%92rspec%E3%81%A7%E8%A1%A8%E7%8F%BE%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>上の説明をRSpecで表現する</h2>

<p>最後に、上の説明をRSpecで表現してみましょう。<br>
これは自分の説明が間違っていないか実際に動かして確認する目的で作成しました。</p>

<p>動作確認に使ったRailsアプリケーションと実際のSpecはこちらにあります。</p>

<ul>
<li><a href="https://github.com/JunichiIto/association-sandbox" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/association-sandbox</a></li>
<li><a href="https://github.com/JunichiIto/association-sandbox/blob/master/spec/models/comment_spec.rb" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/association-sandbox/blob/master/spec/models/comment_spec.rb</a></li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Comment</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:post</span><span class="p">)</span> <span class="p">{</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"新しいMacBook Proを買いました！"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">context</span> <span class="s2">"not associated"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_empty</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"parent.children.create"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="n">comment</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment</span><span class="o">]</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_persisted</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"parent.children.build"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="n">comment</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment</span><span class="o">]</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">be_persisted</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"parent.children &lt;&lt; child"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">be_persisted</span>

      <span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="n">comment</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment</span><span class="o">]</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_persisted</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"parent.children = children"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="n">comment_old</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"やった、コメント1番乗り！！"</span><span class="p">)</span>
      <span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="n">comment_old</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment_old</span><span class="o">]</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">comment_old</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_persisted</span>

      <span class="n">comment_1</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
      <span class="n">comment_2</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"うらやましすぎる！！"</span><span class="p">)</span>

      <span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="o">[</span><span class="n">comment_1</span><span class="p">,</span> <span class="n">comment_2</span><span class="o">]</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment_1</span><span class="p">,</span> <span class="n">comment_2</span><span class="o">]</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">comment_1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_persisted</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">comment_2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_persisted</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">comment_old</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_destroyed</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"child.parent = parent"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
      <span class="n">comment</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">post</span>
      <span class="n">comment</span><span class="o">.</span><span class="n">save</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"Child.new(parent: parent) / Child.create(parent: parent)"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="n">comment_1</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">,</span> <span class="ss">post</span><span class="p">:</span> <span class="n">post</span><span class="p">)</span>
      <span class="n">comment_1</span><span class="o">.</span><span class="n">save</span>

      <span class="n">comment_2</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"うらやましすぎる！！"</span><span class="p">,</span> <span class="ss">post</span><span class="p">:</span> <span class="n">post</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment_1</span><span class="p">,</span> <span class="n">comment_2</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"child.parent_id = parent_id"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">)</span>
      <span class="n">comment</span><span class="o">.</span><span class="n">post_id</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span>
      <span class="n">comment</span><span class="o">.</span><span class="n">save</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"Child.new(parent_id: parent_id) / Child.create(parent_id: parent_id)"</span> <span class="k">do</span>
    <span class="n">specify</span> <span class="k">do</span>
      <span class="n">comment_1</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"わー、いいなあ！"</span><span class="p">,</span> <span class="ss">post_id</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="n">comment_1</span><span class="o">.</span><span class="n">save</span>

      <span class="n">comment_2</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s2">"うらやましすぎる！！"</span><span class="p">,</span> <span class="ss">post_id</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">comment_1</span><span class="p">,</span> <span class="n">comment_2</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h2>
<span id="役に立つ情報源" class="fragment"></span><a href="#%E5%BD%B9%E3%81%AB%E7%AB%8B%E3%81%A4%E6%83%85%E5%A0%B1%E6%BA%90"><i class="fa fa-link"></i></a>役に立つ情報源</h2>

<p>関連についてもっと深く知りたい場合はRails Guidesをじっくり読みましょう。</p>

<ul>
<li><a href="http://guides.rubyonrails.org/association_basics.html" class="autolink" rel="nofollow noopener" target="_blank">http://guides.rubyonrails.org/association_basics.html</a></li>
</ul>

<p>RSpecでRailsでテストする方法を学習するためにはこちらの電子書籍がオススメです！(宣伝)</p>

<ul>
<li><a href="https://leanpub.com/everydayrailsrspec-jp" rel="nofollow noopener" target="_blank">Everyday Rails - RSpecによるRailsテスト入門</a></li>
</ul>

<p><a href="https://camo.qiitausercontent.com/8c5e9c770a53985b8a52589d3f0132c581240011/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f7469746c6570616765732e6c65616e7075622e636f6d2f65766572796461797261696c7372737065632d6a702f6c617267653f31333933353536313831" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8c5e9c770a53985b8a52589d3f0132c581240011/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f7469746c6570616765732e6c65616e7075622e636f6d2f65766572796461797261696c7372737065632d6a702f6c617267653f31333933353536313831" alt="Everyday Rails - RSpecによるRailsテスト入門" data-canonical-src="https://s3.amazonaws.com/titlepages.leanpub.com/everydayrailsrspec-jp/large?1393556181"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />4位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>129</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/8f44a3c52d4669fefa93">衝撃の事実!? &quot;# -*- encoding: utf-8 -*-&quot;じゃなくてもいいんです！</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-17 08:14:43</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Ruby 2.0以降ではデフォルトのエンコーディングがutf-8になったため、マジックコメントが不要になりました。（utf-8でスクリプトを書くのであれば）</p>

<p>本記事はRuby 1.9以前の場合、と考えてください。</p>

<p>参考：<a href="https://www.ruby-lang.org/ja/news/2013/02/24/ruby-2-0-0-p0-is-released/" rel="nofollow noopener" target="_blank">Ruby 2.0.0-p0 リリース</a></p>

<p></p><hr>

<p>みなさんご存知だと思いますが、日本語を含むRubyスクリプトの場合、ファイルの先頭にファイルのエンコーディングを表すマジックコメントがないとエラーになります。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">encoding_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'Japanese'</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span><span class="s1">'日本語'</span><span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span><span class="n">should</span> <span class="o">==</span> <span class="s1">'日本語'</span><span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># 実行結果(エラーになる)</span>
$ rspec encoding_spec.rb 
/Users/mypc/.rvm/gems/ruby-1.9.3-p194/gems/rspec-core-2.11.1/lib/rspec/core/configuration.rb:780:in <span class="sb">`</span>load<span class="s1">': /Users/mypc/dev/sandbox/encoding_spec.rb:4: invalid multibyte char (US-ASCII) (SyntaxError)</span>
<span class="s1">/Users/mypc/dev/sandbox/encoding_spec.rb:4: invalid multibyte char (US-ASCII)</span>
<span class="s1">/Users/mypc/dev/sandbox/encoding_spec.rb:4: syntax error, unexpected $end, expecting '</span><span class="o">}</span><span class="s1">'</span>
<span class="s1">  subject(:japanese) {'</span>日本語<span class="s1">'}</span>
<span class="s1">                         ^</span>
<span class="s1">    from /Users/mypc/.rvm/gems/ruby-1.9.3-p194/gems/rspec-core-2.11.1/lib/rspec/core/configuration.rb:780:in `block in load_spec_files'</span>
    from /Users/mypc/.rvm/gems/ruby-1.9.3-p194/gems/rspec-core-2.11.1/lib/rspec/core/configuration.rb:780:in <span class="sb">`</span>map<span class="s1">'</span>
<span class="s1">    from /Users/mypc/.rvm/gems/ruby-1.9.3-p194/gems/rspec-core-2.11.1/lib/rspec/core/configuration.rb:780:in `load_spec_files'</span>
    from /Users/mypc/.rvm/gems/ruby-1.9.3-p194/gems/rspec-core-2.11.1/lib/rspec/core/command_line.rb:22:in <span class="sb">`</span>run<span class="s1">'</span>
<span class="s1">    from /Users/mypc/.rvm/gems/ruby-1.9.3-p194/gems/rspec-core-2.11.1/lib/rspec/core/runner.rb:69:in `run'</span>
    from /Users/mypc/.rvm/gems/ruby-1.9.3-p194/gems/rspec-core-2.11.1/lib/rspec/core/runner.rb:8:in <span class="sb">`</span>block in autorun<span class="err">'</span>

</pre></div></div>

<h3>
<span id="マジックコメントは----encoding-utf-8---だけじゃない" class="fragment"></span><a href="#%E3%83%9E%E3%82%B8%E3%83%83%E3%82%AF%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AF----encoding-utf-8---%E3%81%A0%E3%81%91%E3%81%98%E3%82%83%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>マジックコメントは"# -*- encoding: utf-8 -*-"だけじゃない！</h3>

<p>ネットの情報を見ていると、エンコーディングを指定するマジックコメントは、<code># -*- encoding: utf-8 -*-</code>のように書かれていることが多いので、これを使っている人も多いと思います。</p>

<p>が！この書式が必須というわけではありません。</p>

<p>実は <code># coding: utf-8</code> だけでもOKなんです。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">encoding_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'Japanese'</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span><span class="s1">'日本語'</span><span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span><span class="n">should</span> <span class="o">==</span> <span class="s1">'日本語'</span><span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># 実行結果(ちゃんと動く)</span>
$ rspec encoding_spec.rb
.

Finished in <span class="m">0</span>.00042 seconds
<span class="m">1</span> example, <span class="m">0</span> failures
</pre></div></div>

<p>ちなみに、<code>coding</code>の前には任意のプレフィックスを付けられるので、<code># encoding: utf-8</code>と書いても正しく動きます。<br>
また、大文字小文字を区別しないので、以下のようなマジックコメントでも動作します。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">encoding_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># HOGEHOGECODING: UTF-8</span>
<span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'Japanese'</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span><span class="s1">'日本語'</span><span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span><span class="n">should</span> <span class="o">==</span> <span class="s1">'日本語'</span><span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h3>

<p>ネットのサンプルコードとかでよく見かける <code>-*-</code> は、Emacsで使われる「エンコーディング指定プラグラマ」というものみたいです。<br>
チームで開発するなら、Emacs固有のおまじないを埋め込むのはどうなんですかね〜？？・・・なんて発言すると、宗教戦争が起きそうなので聞かなかったことにしてください。</p>

<p>というわけで、Rubyのエンコーディング指定に関するちょっとしたトリビア(?)でした！</p>

<h3>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h3>

<p>プログラミング言語Ruby<br>
<a href="http://www.amazon.co.jp/dp/4873113946" class="autolink" rel="nofollow noopener" target="_blank">http://www.amazon.co.jp/dp/4873113946</a></p>

<p>Emacsのエンコーディング指定プラグマを挿入する<br>
<a href="http://d.hatena.ne.jp/syohex/20091002/1254496402" class="autolink" rel="nofollow noopener" target="_blank">http://d.hatena.ne.jp/syohex/20091002/1254496402</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />5位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>88</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/94f3ad15128f88bf89d6">noticeやalertの設定方法の違い</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-11 14:37:42</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">redirect_to</span> <span class="n">foos_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">"Foo saved"</span>
</pre></div></div>

<p>これでnoticeが表示されるので、</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="ss">:new</span><span class="p">,</span> <span class="ss">:alert</span> <span class="o">=&gt;</span> <span class="s2">"Some errors occured"</span>
</pre></div></div>

<p>これも当然alertが表示されるだろう、と思いきや動作しない。<br>
renderの場合はこのように書く必要があった。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Some errors occured"</span>
<span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="ss">:new</span>
</pre></div></div>

<p>ひっかけですね！！</p>

<p>NOTE: <a href="http://www.perfectline.ee/blog/adding-flash-message-capability-to-your-render-calls-in-rails" rel="nofollow noopener" target="_blank">こちらの記事</a>を参考にしました。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />6位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>62</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/a1833b48c3b47a955bdf">Herokuへのデプロイ時は常にproduction.rbの設定値でassets precompileされる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-02-07 08:46:37</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="コンテキスト" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>コンテキスト</h2>

<p>HerokuでRailsアプリケーションを運用する際は、本番環境とは別にステージング環境を用意することがよくあります。</p>

<p>ステージング環境では通常、Heroku上の<code>RACK_ENV</code>や<code>RAILS_ENV</code>といった環境変数を<code>staging</code>にします。</p>

<p>これらの環境変数が<code>staging</code>になっていると、<code>config/environments/staging.rb</code>の設定値を読み込んでアプリケーションが起動します。</p>

<h2>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h2>

<p>ただし、assets(CSSやJavaScript等)のprecompile時は必ずしも<code>staging.rb</code>が読み込まれるわけではないので注意が必要です。</p>

<p>たとえば、<code>application.css</code>とは別に<code>awesome.css</code>をprecompileしたい場合は以下のような指定が必要になります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="sx">%w( awesome.css )</span>
</pre></div></div>

<p>通常こうした設定値は<code>staging.rb</code>または<code>production.rb</code>に設定しますが、<a href="https://github.com/fastestforward/heroku_san" rel="nofollow noopener" target="_blank">heroku_san</a>や<code>git push</code>でステージング環境にソースコードをデプロイするときは<code>staging.rb</code>ではなく、<code>production.rb</code>を読み込んでassets precompileされます。</p>

<p><code>staging.rb</code>と<code>production.rb</code>を同時に変更している場合は、あたかも<code>staging.rb</code>が読み込まれているように錯覚してしまいますが、先に<code>staging.rb</code>だけを更新してHerokuにデプロイしたりすると、<code>awesome.css</code>がprecompileされないため、以下のようなエラーが発生します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>ActionView::Template::Error (awesome.css isn't precompiled): 
</pre></div></div>

<p>ステージング環境のエラーだから<code>staging.rb</code>に問題があるのだろうと思い込んでると、永遠に解決しないので要注意です。</p>

<h2>
<span id="対応策" class="fragment"></span><a href="#%E5%AF%BE%E5%BF%9C%E7%AD%96"><i class="fa fa-link"></i></a>対応策</h2>

<h3>
<span id="1-productionrbにassets-precompile関係の設定を書く" class="fragment"></span><a href="#1-productionrb%E3%81%ABassets-precompile%E9%96%A2%E4%BF%82%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>1. production.rbにassets precompile関係の設定を書く</h3>

<p>assets precompile関係の設定値が本番環境とステージング環境で変わらないのであれば、常に<code>production.rb</code>に設定値を書いておくという解決策が選択できます。<br>
変わったことをしないのであれば、これが一番手軽かもしれません。</p>

<h3>
<span id="2-デプロイ後に別途assets-precompileを実行する" class="fragment"></span><a href="#2-%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E5%BE%8C%E3%81%AB%E5%88%A5%E9%80%94assets-precompile%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. デプロイ後に別途assets precompileを実行する</h3>

<p>本番環境とステージング環境で設定を変える必要があるなら、コードのデプロイ後に<a href="https://github.com/heroku/heroku" rel="nofollow noopener" target="_blank">heroku</a>Gemを使ってassets precompileを実行しましょう。<br>
こうすると<code>staging.rb</code>の設定値を使ってassets precompileしてくれます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ heroku run rake assets:precompile --app your-app-staging
</pre></div></div>

<h3>
<span id="3-user_env_compileプラグインを導入する" class="fragment"></span><a href="#3-user_env_compile%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. user_env_compileプラグインを導入する</h3>

<p>別途assets precompileを実行するやり方だと、ついassets precompileを忘れてしまう恐れがあります。毎回デプロイと同時に実行する方法はないでしょうか？<br>
<code>user_env_compile</code>というHerokuのプラグインを導入すると、デプロイ時に<code>staging.rb</code>の設定値を使ってassets precompileするようになります。<br>
ただし、このプラグインは実験的なプラグインなので「予告なく削除されるかもしれない」という警告が出ます。<br>
その点に留意した上で使用してください。</p>

<p><a href="https://devcenter.heroku.com/articles/labs-user-env-compile" class="autolink" rel="nofollow noopener" target="_blank">https://devcenter.heroku.com/articles/labs-user-env-compile</a></p>

<h2>
<span id="備考" class="fragment"></span><a href="#%E5%82%99%E8%80%83"><i class="fa fa-link"></i></a>備考</h2>

<p>ローカル環境で<code>rake assets:precompile</code>を呼び出した場合も<code>production.rb</code>が読み込まれます。<code>development.rb</code>ではありません。<br>
もし<code>development.rb</code>を使いたいのであれば、下のように<code>RAILS_ENV</code>オプションをつけると<code>development.rb</code>を読み込ませることができます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rake assets:precompile RAILS_ENV=development
</pre></div></div>

<h2>
<span id="参考サイト" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%82%B5%E3%82%A4%E3%83%88"><i class="fa fa-link"></i></a>参考サイト</h2>

<ul>
<li><a href="http://www.johnplummer.com/tools/heroku-precompiling-assets-enviroment-variables.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.johnplummer.com/tools/heroku-precompiling-assets-enviroment-variables.html</a></li>
<li><a href="http://stackoverflow.com/questions/9830244/heroku-always-runs-assetsprecompile-with-the-production-environment-for-rails-3" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/9830244/heroku-always-runs-assetsprecompile-with-the-production-environment-for-rails-3</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />7位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>62</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/977018233568ccd83808">FactoryGirlでModel作成時のValidationをスキップする方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-11-28 17:26:10</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[RSpec]</b> <b>[FactoryGirl]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>実装の都合上、どうしてもFactoryGirlでModel作成時のValidationを避けたいときの回避策はこんな感じです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># spec/factories.rb</span>
<span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">email</span> <span class="s1">'foobar@hogehoge.com'</span>

    <span class="c1"># save時にvalidationをスキップする</span>
    <span class="n">to_create</span> <span class="k">do</span> <span class="o">|</span><span class="n">instance</span><span class="o">|</span>
      <span class="n">instance</span><span class="o">.</span><span class="n">save</span> <span class="ss">validate</span><span class="p">:</span> <span class="kp">false</span>
    <span class="k">end</span> 
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="参考サイト" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%82%B5%E3%82%A4%E3%83%88"><i class="fa fa-link"></i></a>参考サイト</h3>

<p><a href="http://stackoverflow.com/questions/7652956/bypass-rails-validations-when-creating-factorygirl-objects" rel="nofollow noopener" target="_blank">Bypass Rails validations when creating FactoryGirl objects</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />8位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>61</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/15cc04b77057632763e9">Devise関連のページだけをSSL化する手順</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-11-22 10:29:21</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[devise]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ログイン画面やパスワード変更画面など、Devise関連の画面のみSSL化して、それ以外はSSL化したくない場合の手順を紹介します。</p>

<h3>
<span id="手順" class="fragment"></span><a href="#%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>手順</h3>

<p>Devise関連のControllerでSSLを強制的に有効化します。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/environments/production.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># staging.rbがあればそちらも同様</span>
<span class="n">config</span><span class="o">.</span><span class="n">to_prepare</span> <span class="p">{</span> <span class="no">Devise</span><span class="o">::</span><span class="no">SessionsController</span><span class="o">.</span><span class="n">force_ssl</span> <span class="p">}</span>
<span class="n">config</span><span class="o">.</span><span class="n">to_prepare</span> <span class="p">{</span> <span class="no">Devise</span><span class="o">::</span><span class="no">RegistrationsController</span><span class="o">.</span><span class="n">force_ssl</span> <span class="p">}</span>
<span class="n">config</span><span class="o">.</span><span class="n">to_prepare</span> <span class="p">{</span> <span class="no">Devise</span><span class="o">::</span><span class="no">PasswordsController</span><span class="o">.</span><span class="n">force_ssl</span> <span class="p">}</span>
</pre></div>
</div>

<p>(2012.11.23変更)<br>
ログイン後、およびログアウト後は<code>https://</code>ではなく、<code>http://</code>でページを表示してほしいので、以下のようにDeviseのメソッドをオーバーライドします。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/application_controller.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">after_sign_in_path_for_with_http</span><span class="p">(</span><span class="n">resource_or_scope</span><span class="p">)</span>
  <span class="n">path</span> <span class="o">=</span> <span class="n">after_sign_in_path_for_without_http</span><span class="p">(</span><span class="n">resource_or_scope</span><span class="p">)</span>
  <span class="n">path_to_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">alias_method_chain</span> <span class="ss">:after_sign_in_path_for</span><span class="p">,</span> <span class="ss">:http</span>

<span class="k">def</span> <span class="nf">after_sign_out_path_for_with_http</span><span class="p">(</span><span class="n">resource_or_scope</span><span class="p">)</span>
  <span class="n">path</span> <span class="o">=</span> <span class="n">after_sign_out_path_for_without_http</span><span class="p">(</span><span class="n">resource_or_scope</span><span class="p">)</span>
  <span class="n">path_to_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">alias_method_chain</span> <span class="ss">:after_sign_out_path_for</span><span class="p">,</span> <span class="ss">:http</span>

<span class="k">def</span> <span class="nf">path_to_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="s2">"http://</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">host_with_port</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sr">/:80$/</span><span class="p">,</span><span class="s2">""</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">path</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">,</span><span class="s2">""</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</pre></div>
</div>

<p>ログアウト用のリンクを作っている場合は、リンク先を<code>https://</code>にします。<br>
ただし、ローカル環境では<code>http://</code>になっていると思うので、helperメソッドを使って切り分けましょう。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/views/layouts/application.html.haml</span></div>
<div class="highlight"><pre><span></span><span class="n">link_to</span> <span class="s1">'ログアウト'</span><span class="p">,</span> <span class="n">destroy_user_session_url</span><span class="p">(</span><span class="ss">protocol</span><span class="p">:</span> <span class="n">protocol_for_devise</span><span class="p">),</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/helpers/application_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">protocol_for_devise</span>
  <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="p">?</span> <span class="s1">'http://'</span> <span class="p">:</span> <span class="s1">'https://'</span>
<span class="k">end</span>
</pre></div>
</div>

<p>SSLのページで<code>http://</code>を読み込むような箇所があると、ブラウザによっては警告が出ます。<br>
たとえば、twitter-bootstrap-railsを使っていると、以下のように<code>http://</code>の読み込み処理があるので、URLを<code>https://</code>に変更します。(対象のリソースが<code>http://</code>と<code>https://</code>のどちらでも参照できる場合)</p>

<div class="code-frame" data-lang="diff">
<div class="code-lang"><span class="bold">app/views/layouts/application.html.haml</span></div>
<div class="highlight"><pre><span></span><span class="gd">- = javascript_include_tag "http://html5shim.googlecode.com/svn/trunk/html5.js"</span>
<span class="gi">+ = javascript_include_tag "https://html5shim.googlecode.com/svn/trunk/html5.js"</span>
</pre></div>
</div>

<p>以上で終わりです。<br>
正しく動作するか、サーバーで確認してみましょう。</p>

<h3>
<span id="確認環境" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>確認環境</h3>

<ul>
<li>Rails 3.2.8</li>
<li>Devise 2.1.2</li>
<li>Heroku Cedar Stack + <a href="https://devcenter.heroku.com/articles/ssl#piggyback-ssl" rel="nofollow noopener" target="_blank">Piggyback SSL</a>
</li>
</ul>

<h3>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h3>

<p>全画面とも強制的にSSL化する場合(非SSLなページが不要な場合)は、以下の設定だけでOKです。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/environments/production.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># staging.rbがあればそちらも同様</span>
<span class="n">config</span><span class="o">.</span><span class="n">force_ssl</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div>
</div>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<ul>
<li><a href="https://github.com/plataformatec/devise/wiki/How-To:-Use-SSL-(HTTPS)" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/plataformatec/devise/wiki/How-To:-Use-SSL-(HTTPS)</a></li>
<li><a href="http://stackoverflow.com/questions/9527158/how-should-i-go-about-making-all-devise-paths-use-https" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/9527158/how-should-i-go-about-making-all-devise-paths-use-https</a></li>
<li><a href="http://grosser.it/2008/11/24/rails-transform-path-to-url/" class="autolink" rel="nofollow noopener" target="_blank">http://grosser.it/2008/11/24/rails-transform-path-to-url/</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />9位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>46</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/57a160c087f17c2457bb">Rails consoleでreload!する場合の注意点</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-28 23:17:19</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><code>reload!</code>コマンドを使った時に、ちょっとハマったエピソードです。</p>

<h2>
<span id="ある日のできごと" class="fragment"></span><a href="#%E3%81%82%E3%82%8B%E6%97%A5%E3%81%AE%E3%81%A7%E3%81%8D%E3%81%94%E3%81%A8"><i class="fa fa-link"></i></a>ある日のできごと</h2>

<p>あるModelを作りました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hoge</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">foo</span>
    <span class="s1">'Hello'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p><code>rails c</code>でRailsのコンソールを立ち上げながら、Modelの挙動を確認しました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&gt; x = Hoge.find 1
&gt; x.foo
 =&gt; "Hello"
</pre></div></div>

<p>ちょっと訳あってメソッドを修正しました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hoge</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">foo</span>
    <span class="s1">'Bye'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>コンソールを再起動するのは面倒なので、Google先生に尋ねたところ、<code>reload!</code>と打てば良いと教えてもらいました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&gt; reload!
Reloading…
  =&gt; true
</pre></div></div>

<p>では、動作確認。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&gt; x.foo
  =&gt; "Hello"
</pre></div></div>

<p>あれ？変わってない・・・。<br>
悩むこと数十分。そしてギブアップ。</p>

<p>そこで隣にいた松村先生に質問したところ、<code>reload!</code>した後に、オブジェクトの再ロードも必要になると教えてもらいました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&gt; x = Hoge.find 1
&gt; x.foo
 =&gt; "Bye"
</pre></div></div>

<p>というわけで、<code>reload!</code>だけではなく、すでに読み込まれているオブジェクトに対してはそちらも再ロードが必要になります。</p>

<p>ちなみにオブジェクトに対して<code>reload</code>メッセージを送ってもダメです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&gt; x.reload
&gt; x.foo
  =&gt; "Hello"
</pre></div></div>

<p>以上、Rails初心者の方はご注意を！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />10位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>31</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/fef20d76ef723d256d1a">Everyday Rails Testing with RSpecはRSpec初心者～中級者にオススメの一冊！</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-12-11 04:25:03</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h3>
<span id="201427-追記-日本語版を発売しました" class="fragment"></span><a href="#201427-%E8%BF%BD%E8%A8%98-%E6%97%A5%E6%9C%AC%E8%AA%9E%E7%89%88%E3%82%92%E7%99%BA%E5%A3%B2%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F"><i class="fa fa-link"></i></a>2014.2.7 追記: 日本語版を発売しました！</h3>

<p>「この本は英語版しかありません」と書いていましたが、僕自身が日本語版の翻訳し、<a href="https://leanpub.com/everydayrailsrspec-jp" rel="nofollow noopener" target="_blank">Leanpubから発売</a>しました。</p>

<p>詳しくはこちらのエントリをご覧下さい。</p>

<ul>
<li><a href="http://blog.jnito.com/entry/2014/02/07/110505" rel="nofollow noopener" target="_blank">RSpec初心者必読！「Everyday Rails - RSpecによるRailsテスト入門」を発売しました - give IT a try</a></li>
<li><a href="http://blog.jnito.com/entry/2014/02/28/105922" rel="nofollow noopener" target="_blank">正式版公開のお知らせと幻のあとがき・Everyday Rails - RSpecによるRailsテスト入門 - give IT a try</a></li>
</ul>

<p></p><hr>

<p>注: この記事は<a href="http://blog.jnito.com/entry/2013/10/06/080252" rel="nofollow noopener" target="_blank">以前自分のブログに書いた記事</a>から転載したものです。書き下ろしじゃなくてごめんなさい(&gt;&lt;)。</p>

<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日、RSpec関連のこんな電子書籍を買いました。</p>

<ul>
<li>  <a href="https://leanpub.com/everydayrailsrspec" rel="nofollow noopener" target="_blank">Everyday Rails Testing with RSpec</a>
</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/883b268c7c6a3f765f85ef59bff5977af6411d96/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f4a2f4a756e6963686949746f2f32303133313231312f32303133313231313034323835392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/883b268c7c6a3f765f85ef59bff5977af6411d96/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f4a2f4a756e6963686949746f2f32303133313231312f32303133313231313034323835392e706e67" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/J/JunichiIto/20131211/20131211042859.png"></a></p>

<p>RSpecを学習するための書籍としてはなかなか良かったので、今回はこの本の内容を紹介します。</p>

<h2>
<span id="この本を購入した動機" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E6%9C%AC%E3%82%92%E8%B3%BC%E5%85%A5%E3%81%97%E3%81%9F%E5%8B%95%E6%A9%9F"><i class="fa fa-link"></i></a>この本を購入した動機</h2>

<p>RSpecは仕事でも使っていて、そこそこに使い慣れています。<br>
しかし、それでもModel以外のSpecを書くのは面倒くさかったり(=Modelほど慣れていない)、だんだんSpecがごちゃごちゃしてきて可読性や保守性が落ちてきたりします。<br>
「そこそこ使えるけど、もっと上手く書けるようになりたいな～」と思っていたときに見つけたのがこの本でした。</p>

<h2>
<span id="全体的な感想" class="fragment"></span><a href="#%E5%85%A8%E4%BD%93%E7%9A%84%E3%81%AA%E6%84%9F%E6%83%B3"><i class="fa fa-link"></i></a>全体的な感想</h2>

<p>タイトルにあるとおり、RSpec + Railsに特化した本です。<br>
仕事でメインで使っているのはRails + RSpecなので、この本のテーマは僕にうってつけでした。</p>

<p>取り扱う内容は幅広く、実践的なサンプルコードがたくさん出てきます。<br>
業務で「こういうSpecを書きたいんだけど、どう書けばいいかな？」と思うときに、参考になりそうなコードがたくさん載っています。(よっぽど特殊で複雑なケースでなければ)</p>

<p>対象となりそうな読者はRails + RSpecの未経験者から、僕のようにもうちょっとRSpecを上手く書けるようになりたい中級者になると思います。<br>
RSpecのセットアップ方法から説明してくれるので、RSpec初心者には特に嬉しいと思います。</p>

<p>ただし、そこまで高度でマニアックな話題は出てきません。<br>
中級者の人はRSpec再入門用として、苦手だった分野や今まで気付いていなかった「不完全さ」を穴埋めしていくような読み方になると思います。</p>

<h3>
<span id="本の目次" class="fragment"></span><a href="#%E6%9C%AC%E3%81%AE%E7%9B%AE%E6%AC%A1"><i class="fa fa-link"></i></a>本の目次</h3>

<p>参考までに、目次をピックアップするとこんな感じです。</p>

<ol>
<li> イントロダクション</li>
<li> RSpecのセットアップ</li>
<li> Model specs</li>
<li> ファクトリを使ったテストデータの作成</li>
<li> 基本的なController specsの書き方</li>
<li> より進んだController specsの書き方</li>
<li> Controller specをきれいに保つ</li>
<li> Feature specs</li>
<li> Specをスピードアップさせる</li>
<li> その他のテスト</li>
<li> テスト駆動開発に向けて</li>
<li> いろいろなアドバイス</li>
</ol>

<h2>
<span id="テストはdryにしすぎないスクロールが必要になるならdryを捨てる" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%81%AFdry%E3%81%AB%E3%81%97%E3%81%99%E3%81%8E%E3%81%AA%E3%81%84%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%AA%E3%82%89dry%E3%82%92%E6%8D%A8%E3%81%A6%E3%82%8B"><i class="fa fa-link"></i></a>テストはDRYにしすぎない。スクロールが必要になるならDRYを捨てる</h2>

<p>冒頭の動機に書いた、可読性や保守性が低下する問題の解決方法(指針)も載っていました。<br>
それはテストコードはDRYにしすぎない、ということです。</p>

<p>テストの前提条件を確認するために何画面分も上スクロールしなければならないのであれば黄色信号です。<br>
がんばってDRYにしようとせず、テストコードが一画面に収まるような書き方を検討すべきです。</p>

<p>・・・というようなことを書いてあるのを読んで「あー、なるほど！」と思いました。<br>
確かに可読性や保守性が悪いな～と感じていたテストコードのほとんどは、テストデータのセットアップを一カ所に書いて、どんどん下にテストケースを追加していくタイプのものでした。<br>
今後は画面スクロールがいらないようなテストコードを心がけてみようと思います。</p>

<h2>
<span id="最新版の実行環境に合わせて内容もアップデート" class="fragment"></span><a href="#%E6%9C%80%E6%96%B0%E7%89%88%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83%E3%81%AB%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A6%E5%86%85%E5%AE%B9%E3%82%82%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>最新版の実行環境に合わせて内容もアップデート</h2>

<p>この本の良いところのひとつは、最新版の実行環境に追従してくれることです。<br>
現時点ではRails 4.0, Capybara 2.1, Factory Girl 4.2, and RSpec 2.14に対応しています。</p>

<p>Railsをはじめ、この方面のフレームワークはどんどん仕様が変わっていくので、本の内容がすぐに古くなってしまいます。<br>
しかし、この本は電子書籍なので最新のフレームワークに合わせて内容をアップデートしてくれます。<br>
最新版の内容は無料で入手できるので、お金を払うのは最初の一度だけでOKです。</p>

<h2>
<span id="本の価格は最低12ドルただし17ドル以上を推奨" class="fragment"></span><a href="#%E6%9C%AC%E3%81%AE%E4%BE%A1%E6%A0%BC%E3%81%AF%E6%9C%80%E4%BD%8E12%E3%83%89%E3%83%AB%E3%81%9F%E3%81%A0%E3%81%9717%E3%83%89%E3%83%AB%E4%BB%A5%E4%B8%8A%E3%82%92%E6%8E%A8%E5%A5%A8"><i class="fa fa-link"></i></a>本の価格は「最低12ドル、ただし17ドル以上を推奨」</h2>

<p>本の価格は決まった定価はなく、「最低12ドル、ただし17ドル以上を推奨」となっています。<br>
不思議な価格設定ですが、自分で価格を指定できるんです。<br>
ごめんなさい、僕は12ドルで購入した人です・・・。</p>

<p>あと、この本はAmazonのような一般向けの販売サイトではなく、<a href="https://leanpub.com/%E2%80%8E" rel="nofollow noopener" target="_blank">Leanpub</a>というセルフパブリッシングサイトでのみ購入できます。</p>

<h2>
<span id="ところでこの本って英語ですよね" class="fragment"></span><a href="#%E3%81%A8%E3%81%93%E3%82%8D%E3%81%A7%E3%81%93%E3%81%AE%E6%9C%AC%E3%81%A3%E3%81%A6%E8%8B%B1%E8%AA%9E%E3%81%A7%E3%81%99%E3%82%88%E3%81%AD"><i class="fa fa-link"></i></a>ところで、この本って英語ですよね！？</h2>

<p>ここまでしれ～っと本の紹介をしていますが、「英語？ねえ、英語しかないの？？」と思いながら読んでいる方がいるんじゃないかと思います。<br>
いえ、ちゃんと翻訳版もありますよ！<a href="https://leanpub.com/everydayrailsrspec-cn" rel="nofollow noopener" target="_blank">中国語</a>ですけどね・・・。</p>

<p>はい、というわけで日本人はオリジナルの英語版を読むことになると思います。</p>

<p>でも、そんなに難しい英語ではないです。<br>
みなさん、GemのREADMEファイルやStackOverflowの解答例なんかは英語でも読みますよね？<br>
それができればこの本も十分読めると思います。</p>

<p>僕たちプログラマは英語の読み書きは不得意でも、Ruby(もちろんRuby以外でも可)という世界共通のプログラミング言語なら読み書きできます。<br>
細かい英単語の意味はイマイチわからなくても、コードを読んだら「あー、そういうことね」とだいたいわかったりするものです。<br>
英文の細部にとらわれず、わからない単語があってもガンガン読み進めていくのが洋書を読破するコツなんじゃないかな～と思います。</p>

<p>今まで洋書を買って読んだことがない、という人は一度思い切って買ってみると良いと思います。<br>
「食わずぎらい」を払拭できれば、あなたも洋書デビューです！</p>

<h3>
<span id="余談-洋書を読めるとこんなにたくさんのメリットが" class="fragment"></span><a href="#%E4%BD%99%E8%AB%87-%E6%B4%8B%E6%9B%B8%E3%82%92%E8%AA%AD%E3%82%81%E3%82%8B%E3%81%A8%E3%81%93%E3%82%93%E3%81%AA%E3%81%AB%E3%81%9F%E3%81%8F%E3%81%95%E3%82%93%E3%81%AE%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%E3%81%8C"><i class="fa fa-link"></i></a>余談: 洋書を読めるとこんなにたくさんのメリットが！！</h3>

<p>「洋書を読める + KindleやiPadで電子書籍が読める」の組み合わせは技術者にとって天国です。</p>

<p>たとえばこんなにたくさんのメリットがあります。</p>

<ul>
<li>  技術書の選択肢が莫大に増える

<ul>
<li>  洋書ならマイナーな言語やマニアックな技術の技術書がたくさん</li>
</ul>
</li>
<li>  読みたい本が読みたいときに手に入る

<ul>
<li>  洋書の大半は電子書籍版がある</li>
</ul>
</li>
<li>  翻訳を待たなくて良い

<ul>
<li>  そもそも読みたい本が翻訳される保証もない</li>
</ul>
</li>
<li>  読みにくい翻訳に苦しめられることもない

<ul>
<li>  日本語の方がかえって読みにくいこともたまにありますよね・・・</li>
</ul>
</li>
<li>  日本で買うより安い

<ul>
<li>  理屈からして翻訳版がオリジナルより安くなることはないですもんね</li>
<li>  年末に大幅な割引きセールをする出版社も多いです</li>
</ul>
</li>
</ul>

<p>さあ、あなたもLet's 洋書デビュー！</p>

<h2>
<span id="the-rspec-bookはどうなの" class="fragment"></span><a href="#the-rspec-book%E3%81%AF%E3%81%A9%E3%81%86%E3%81%AA%E3%81%AE"><i class="fa fa-link"></i></a>「The RSpec Book」はどうなの？</h2>

<p>RSpec関連の技術書といえば「The RSpec Book」もあります。<br>
日本で発売されているRSpecの技術書はこれぐらいなので、こっちの方が有名だと思います。</p>

<p><a href="https://camo.qiitausercontent.com/414c36a3b011370687fb4f9d0a4a46baf6617f91/687474703a2f2f6563782e696d616765732d616d617a6f6e2e636f6d2f696d616765732f492f35312d33543733357a4c4c2e5f534c3136305f2e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/414c36a3b011370687fb4f9d0a4a46baf6617f91/687474703a2f2f6563782e696d616765732d616d617a6f6e2e636f6d2f696d616765732f492f35312d33543733357a4c4c2e5f534c3136305f2e6a7067" data-canonical-src="http://ecx.images-amazon.com/images/I/51-3T735zLL._SL160_.jpg"></a><br>
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4798121932/junic05-22/" rel="nofollow noopener" target="_blank">The RSpec Book</a></p>

<p>僕もThe RSpec Bookは読みました。<br>
ただし、例によって洋書ですけどね。</p>

<p><a href="https://camo.qiitausercontent.com/3d9c077be664080de298f938cc9598701b4b7de4/687474703a2f2f6563782e696d616765732d616d617a6f6e2e636f6d2f696d616765732f492f35315955703759666b4b4c2e5f534c3136305f2e6a7067" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3d9c077be664080de298f938cc9598701b4b7de4/687474703a2f2f6563782e696d616765732d616d617a6f6e2e636f6d2f696d616765732f492f35315955703759666b4b4c2e5f534c3136305f2e6a7067" data-canonical-src="http://ecx.images-amazon.com/images/I/51YUp7YfkKL._SL160_.jpg"></a><br>
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/1934356379/junic05-22/" rel="nofollow noopener" target="_blank">The RSpec Book</a></p>

<p>こちらの本も良いと思います。<br>
ただし、Railsには特化していないので、基本的に「素のRSpec」を取り扱った本になります。<br>
RSpec自体の機能を掘り下げて学習するのには良い本です。<br>
Rails関連の話も全く扱わないのではなく、最後の方の章で出てきます。</p>

<p>あと、タイトルにRSpecと書いてあるわりにはCucumberの話もたくさん出てきます。<br>
Cucumberも一緒に勉強したい人には良いかもしれませんが、「Cucumberは別にええねん」という人にはちょっと退屈かもしれません。</p>

<p>というわけで、興味の対象が「RSpec + Rails」に絞られている人であれば、こちらの<a href="https://leanpub.com/everydayrailsrspec" rel="nofollow noopener" target="_blank">Everyday Rails Testing with RSpec</a>の方が役に立つんじゃないかな～と思います。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、今回は<a href="https://leanpub.com/everydayrailsrspec" rel="nofollow noopener" target="_blank">Everyday Rails Testing with RSpec</a>というRSpec関連の技術書を紹介してみました。</p>

<p>「RSpecって使ってみたいけど難しそう」と思っている人や、「もっと上手なRSpecの書き方を身につけたい」と思っている人にはオススメです。<br>
あと、「洋書食わず嫌い」の人も「はじめての洋書」としてぜひチャレンジしてみて下さい！</p>

<ul>
<li>  <a href="https://leanpub.com/everydayrailsrspec" rel="nofollow noopener" target="_blank">Everyday Rails Testing with RSpec</a>
</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/883b268c7c6a3f765f85ef59bff5977af6411d96/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f4a2f4a756e6963686949746f2f32303133313231312f32303133313231313034323835392e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/883b268c7c6a3f765f85ef59bff5977af6411d96/687474703a2f2f63646e2d616b2e662e73742d686174656e612e636f6d2f696d616765732f666f746f6c6966652f4a2f4a756e6963686949746f2f32303133313231312f32303133313231313034323835392e706e67" data-canonical-src="http://cdn-ak.f.st-hatena.com/images/fotolife/J/JunichiIto/20131211/20131211042859.png"></a></p>

<h3>
<span id="お知らせ-西脇rb東灘rbに参加してみませんか" class="fragment"></span><a href="#%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B-%E8%A5%BF%E8%84%87rb%E6%9D%B1%E7%81%98rb%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%97%E3%81%A6%E3%81%BF%E3%81%BE%E3%81%9B%E3%82%93%E3%81%8B"><i class="fa fa-link"></i></a>お知らせ: 西脇.rb&amp;東灘.rbに参加してみませんか？</h3>

<p>僕とAkiさん(<a href="https://twitter.com/spring_aki" rel="nofollow noopener" target="_blank">@spring_aki</a>)の二人で主催している <strong>西脇.rb/東灘.rb</strong> というRubyコミュニティがあります。<br>
毎月神戸近辺でRuby勉強会を開催していますので、初心者、上級者を問わず、Rubyに興味のある方はお気軽に参加してみて下さい。</p>

<p>Doorkeeperのコミュニティページでメンバー登録してもらうと、イベントの開催通知を受け取ることができます。</p>

<ul>
<li><a href="http://nishiwaki-higashinadarb.doorkeeper.jp/" rel="nofollow noopener" target="_blank">西脇.rb＆東灘.rb - Doorkeeper</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />11位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>27</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/efc20e994d31ba17f16c">turbo-sprockets-rails3 で Heroku x Rails3のデプロイ時間を30倍速くする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-06-26 05:04:30</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="rails3のassetsprecompileは遅い" class="fragment"></span><a href="#rails3%E3%81%AEassetsprecompile%E3%81%AF%E9%81%85%E3%81%84"><i class="fa fa-link"></i></a>Rails3のassets:precompileは遅い！</h2>

<p>HerokuもRailsも便利ですが、本番環境にデプロイするときに実行されるassets:precompileの速度はお世辞にも速いとは言えません。</p>

<p>Twitter BootstrapやらjQueryプラグインやら、なんやらかんやらでViewにお化粧を厚塗りしていくと、assets:precompileの時間だけで3分以上かかることも珍しくありません。</p>

<p>僕の場合、毎回確実にassets:precompileに10分以上かかってしまい、時々Herokuの15分という上限を超えてしまうRails appもありました。<br>
なので、「ちょっとした修正をデプロイしたいだけなのに、こんなに待たされるのはもう勘弁！！」という悩みを抱えていました。</p>

<h2>
<span id="turbo-sprockets-rails3で簡単に爆速化" class="fragment"></span><a href="#turbo-sprockets-rails3%E3%81%A7%E7%B0%A1%E5%8D%98%E3%81%AB%E7%88%86%E9%80%9F%E5%8C%96"><i class="fa fa-link"></i></a>turbo-sprockets-rails3で簡単に爆速化！！</h2>

<p>そんなときに見つけたのが<a href="https://github.com/ndbroadbent/turbo-sprockets-rails3" rel="nofollow noopener" target="_blank">turbo-sprockets-rails3</a>というGemです。<br>
これを使うと変更があったassetsだけを再コンパイルするので、assets:precompileの時間をぐっと短縮することができます。</p>

<h3>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h3>

<p>使い方は簡単です。<br>
Herokuで使うときはこんな感じで、GemとHerokuの環境変数を追加するだけです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># Gemfileにturbo-sprockets-rails3を追加
group :assets do
  gem 'turbo-sprockets-rails3'
end
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># Herokuに以下の環境変数を追加
$ heroku config:set BUILDPACK_URL=https://github.com/ndbroadbent/heroku-buildpack-turbo-sprockets.git
</pre></div></div>

<p>あとはHerokuにデプロイするだけでおしまいです。</p>

<p>最初のデプロイは全assetsがprecompileされるので、導入前と同じぐらいの時間がかかりますが、それ以降はassets:precompileの時間がぐんと短縮されます。(assetsに大きな変更がない限り)</p>

<h2>
<span id="beforeafter比較" class="fragment"></span><a href="#beforeafter%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>Before/After比較</h2>

<p>導入の前後でassets:precompileにかかる時間を比較すると、これぐらいの違いが出てきます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># 導入前
-----&gt; Preparing app for Rails asset pipeline
       Running: rake assets:precompile
       Asset precompilation completed (751.95s)
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># 導入後
-----&gt; Preparing app for Rails asset pipeline
       Running: rake assets:precompile
       Asset precompilation completed (24.34s)
</pre></div></div>

<p>このようにassets:precompileがすぐ終わるようになったので、躊躇せずにデプロイが行えるようになりました。</p>

<h2>
<span id="備考-rails4にすればturbo-sprockets-rails3は不要" class="fragment"></span><a href="#%E5%82%99%E8%80%83-rails4%E3%81%AB%E3%81%99%E3%82%8C%E3%81%B0turbo-sprockets-rails3%E3%81%AF%E4%B8%8D%E8%A6%81"><i class="fa fa-link"></i></a>備考: Rails4にすればturbo-sprockets-rails3は不要</h2>

<p>Rails4ではデフォルトでこの仕組みが導入されているので、元からassets:precompileが速いらしいです。<br>
なので、この記事はRails3限定(厳密に言うと3.2以上)ということになります。</p>

<ul>
<li>参考: <a href="http://yetimedia.tumblr.com/post/33320732456/moving-forward-with-the-rails-asset-pipeline" class="autolink" rel="nofollow noopener" target="_blank">http://yetimedia.tumblr.com/post/33320732456/moving-forward-with-the-rails-asset-pipeline</a>
</li>
</ul>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>もっと前から使っていれば良かった、<a href="https://github.com/ndbroadbent/turbo-sprockets-rails3" rel="nofollow noopener" target="_blank">turbo-sprockets-rails3</a>！！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />12位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>26</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/7d5d7e829690ea3c4d6f">【SQL腕試し問題！】締め切り日が近いイベントの一覧の取得するSQLを書いて下さい</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-24 06:03:58</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[SQL]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日、簡単そうに見えて意外と難しいSQLに遭遇したので、SQLの腕試し問題として出題してみます。<br>
みなさん奮って答えを考えてみて下さい！！</p>

<h2>
<span id="要件" class="fragment"></span><a href="#%E8%A6%81%E4%BB%B6"><i class="fa fa-link"></i></a>要件</h2>

<ul>
<li>イベントとスケジュールという二つのモデル(テーブル)がある。</li>
<li>イベントは複数のスケジュールを持つことができる。</li>
<li>スケジュールを一件も持たないイベントもある（スケジュール未定のイベント）。</li>
<li>スケジュールには締め切り日が設定されている。

<ul>
<li>イベント単位で同じ締め切り日は複数存在しないものとする。</li>
</ul>
</li>
<li>次のような条件でイベントとスケジュールの一覧を出したい。

<ul>
<li>システム日付以降に締め切り日がある、またはスケジュール未定のイベントのみを表示する。</li>
<li>スケジュールが複数あるイベントはシステム日付に最も近い締め切り日のスケジュールのみを表示する。</li>
<li>締め切り日順に並び替える（締め切り日が近いほど上）。ただしスケジュール未定であれば一番下に表示する。</li>
<li>締め切り日が同じであればイベントID順に並び替える（IDが小さいものほど上）。</li>
</ul>
</li>
</ul>

<h2>
<span id="例" class="fragment"></span><a href="#%E4%BE%8B"><i class="fa fa-link"></i></a>例</h2>

<h3>
<span id="イベントテーブル" class="fragment"></span><a href="#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB"><i class="fa fa-link"></i></a>イベントテーブル</h3>

<table>
<thead>
<tr>
<th style="text-align: left">id</th>
<th style="text-align: left">name</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">1</td>
<td style="text-align: left">Completed event</td>
</tr>
<tr>
<td style="text-align: left">2</td>
<td style="text-align: left">No schedule event</td>
</tr>
<tr>
<td style="text-align: left">3</td>
<td style="text-align: left">Continuing event</td>
</tr>
<tr>
<td style="text-align: left">4</td>
<td style="text-align: left">Future event 1</td>
</tr>
<tr>
<td style="text-align: left">5</td>
<td style="text-align: left">Future event 2</td>
</tr>
</tbody>
</table>

<h3>
<span id="スケジュールテーブル" class="fragment"></span><a href="#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB"><i class="fa fa-link"></i></a>スケジュールテーブル</h3>

<table>
<thead>
<tr>
<th style="text-align: left">id</th>
<th style="text-align: left">event_id</th>
<th style="text-align: left">due_date</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">1</td>
<td style="text-align: left">1</td>
<td style="text-align: left">2014/01/23</td>
</tr>
<tr>
<td style="text-align: left">2</td>
<td style="text-align: left">3</td>
<td style="text-align: left">2014/01/01</td>
</tr>
<tr>
<td style="text-align: left">3</td>
<td style="text-align: left">3</td>
<td style="text-align: left">2014/02/01</td>
</tr>
<tr>
<td style="text-align: left">4</td>
<td style="text-align: left">3</td>
<td style="text-align: left">2014/03/01</td>
</tr>
<tr>
<td style="text-align: left">5</td>
<td style="text-align: left">4</td>
<td style="text-align: left">2014/01/24</td>
</tr>
<tr>
<td style="text-align: left">6</td>
<td style="text-align: left">4</td>
<td style="text-align: left">2014/01/25</td>
</tr>
<tr>
<td style="text-align: left">7</td>
<td style="text-align: left">5</td>
<td style="text-align: left">2014/01/24</td>
</tr>
</tbody>
</table>

<h3>
<span id="期待する出力結果システム日付が-20140124-の場合" class="fragment"></span><a href="#%E6%9C%9F%E5%BE%85%E3%81%99%E3%82%8B%E5%87%BA%E5%8A%9B%E7%B5%90%E6%9E%9C%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%97%A5%E4%BB%98%E3%81%8C-20140124-%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>期待する出力結果(システム日付が 2014/01/24 の場合)</h3>

<table>
<thead>
<tr>
<th style="text-align: left">event_id</th>
<th style="text-align: left">name</th>
<th style="text-align: left">schedule_id</th>
<th style="text-align: left">due_date</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">4</td>
<td style="text-align: left">Future event 1</td>
<td style="text-align: left">5</td>
<td style="text-align: left">2014/01/24</td>
</tr>
<tr>
<td style="text-align: left">5</td>
<td style="text-align: left">Future event 2</td>
<td style="text-align: left">7</td>
<td style="text-align: left">2014/01/24</td>
</tr>
<tr>
<td style="text-align: left">3</td>
<td style="text-align: left">Continuing event</td>
<td style="text-align: left">3</td>
<td style="text-align: left">2014/02/01</td>
</tr>
<tr>
<td style="text-align: left">2</td>
<td style="text-align: left">No schedule event</td>
<td style="text-align: left"></td>
<td style="text-align: left"></td>
</tr>
</tbody>
</table>

<h2>
<span id="制約等" class="fragment"></span><a href="#%E5%88%B6%E7%B4%84%E7%AD%89"><i class="fa fa-link"></i></a>制約等</h2>

<ul>
<li>RDBMSはPostgreSQL 9.2.4とする(推奨)。

<ul>
<li>解答例を比較しやすいようにRDBMSを固定しようと思いましたが、必須条件ではなく推奨条件とします。他のRDBMSを使ってもOKです。SQL方言やRDBMS固有の関数も自由に使って下さい。</li>
</ul>
</li>
<li>システム日付は便宜的に以下のSQLで取得できる値とする。</li>
</ul>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="n">sysdate</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">sysdate_dummy</span>
</pre></div></div>

<h2>
<span id="スキーマ作成用のsql" class="fragment"></span><a href="#%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E4%BD%9C%E6%88%90%E7%94%A8%E3%81%AEsql"><i class="fa fa-link"></i></a>スキーマ作成用のSQL</h2>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">events</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">integer</span> <span class="k">PRIMARY</span> <span class="k">KEY</span>
  <span class="p">,</span><span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">events</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">'Completed event'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">events</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">'No schedule event'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">events</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">'Continuing event'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">events</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">'Future event 1'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">events</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="s1">'Future event 2'</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">schedules</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">integer</span> <span class="k">PRIMARY</span> <span class="k">KEY</span>
  <span class="p">,</span><span class="n">event_id</span> <span class="nb">integer</span>
  <span class="p">,</span><span class="n">due_date</span> <span class="nb">date</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">schedules</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">'2014/01/23'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">schedules</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">'2014/01/01'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">schedules</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">'2014/02/01'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">schedules</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">'2014/03/01'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">schedules</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">'2014/01/24'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">schedules</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">'2014/01/25'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">schedules</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="s1">'2014/01/24'</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sysdate_dummy</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">integer</span> <span class="k">PRIMARY</span> <span class="k">KEY</span>
  <span class="p">,</span><span class="n">sysdate</span> <span class="nb">date</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">sysdate_dummy</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">'2014/01/24'</span><span class="p">);</span>
</pre></div></div>

<h2>
<span id="解答方法" class="fragment"></span><a href="#%E8%A7%A3%E7%AD%94%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>解答方法</h2>

<ul>
<li>実行方法は自由ですが、<a href="http://sqlfiddle.com/" rel="nofollow noopener" target="_blank">SQL Fiddle</a>を使うとお手軽かもしれません。</li>
<li>SQLができたら<a href="https://gist.github.com/" rel="nofollow noopener" target="_blank">gist</a>や<a href="http://sqlfiddle.com/" rel="nofollow noopener" target="_blank">SQL Fiddle</a>のURLをこの記事のコメントに   貼り付けて下さい。工夫した点やアピールポイントがあればご自由にどうぞ。</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/33bec9b213822a8ddbbb5e054e5636469ca088b5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f33353431306135382d653938302d653134322d333935632d6565626265363636663138662e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/33bec9b213822a8ddbbb5e054e5636469ca088b5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f33353431306135382d653938302d653134322d333935632d6565626265363636663138662e706e67" alt="Screen Shot 2014-01-24 at 5.58.31.png" title="Screen Shot 2014-01-24 at 5.58.31.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/35410a58-e980-e142-395c-eebbe666f18f.png"></a></p>

<h2>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h2>

<ul>
<li>優勝者には素敵な商品が・・・出ません。順位を付ける予定もありません。各自、自己満足の世界でSQLを作って下さい。</li>
<li>この課題はとあるRailsの案件で必要になったSQLをベースとしています。Rails開発者の人はActiveRecordを使うならどうするか、というのを考えてみると良いかもしれません。</li>
</ul>

<h2>
<span id="僕の解答例" class="fragment"></span><a href="#%E5%83%95%E3%81%AE%E8%A7%A3%E7%AD%94%E4%BE%8B"><i class="fa fa-link"></i></a>僕の解答例</h2>

<p>僕はこんな感じで作ってみました。うーん、そこそこ複雑ですね～。<br>
あ、自力で答えを考えたい人はまだ見ないで下さいね！！</p>

<ul>
<li><a href="http://sqlfiddle.com/#!12/0bea5/2" class="autolink" rel="nofollow noopener" target="_blank">http://sqlfiddle.com/#!12/0bea5/2</a></li>
</ul>

<p>SQLだけ見たい人はこちらをどうぞ。</p>

<ul>
<li><a href="https://gist.github.com/JunichiIto/8588344" class="autolink" rel="nofollow noopener" target="_blank">https://gist.github.com/JunichiIto/8588344</a></li>
</ul>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<p>それではみなさん、Let's try!!</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />13位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>26</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/131fd2b087b21fe2ef43">Rubyのクラスメソッドはインスタンスメソッドと同じようにprivateにならない</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-08 23:35:36</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>これも他の言語からRubyにやってきた人は間違えやすいかも。<br>
private以下で定義したクラスメソッドはインスタンスメソッドと同じようにprivateになりそうな気がしますが、実はpublicのままです。<br>
<code>private_class_method</code>でそのメソッドを指定するか、特異クラスの中で定義する必要があります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'private class method'</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s1">'1. when use private keyword'</span> <span class="k">do</span>
    <span class="k">class</span> <span class="nc">PrivateKeyword</span>
      <span class="k">def</span> <span class="nf">a_public_instance_method</span><span class="p">;</span> <span class="k">end</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">a_public_class_method</span><span class="p">;</span> <span class="k">end</span>
    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">a_private_instance_method</span><span class="p">;</span> <span class="k">end</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">a_private_class_method</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:instance</span><span class="p">)</span> <span class="p">{</span> <span class="no">PrivateKeyword</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="n">instance</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:a_public_instance_method</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span> <span class="p">}</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="no">PrivateKeyword</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:a_public_class_method</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span> <span class="p">}</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="n">instance</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:a_private_instance_method</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>

    <span class="c1">#Maybe surprising!!</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="no">PrivateKeyword</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:a_private_class_method</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'2. when use private_class_method'</span> <span class="k">do</span>
    <span class="k">class</span> <span class="nc">PrivateClassMethod</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">a_private_class_method</span><span class="p">;</span> <span class="k">end</span>
      <span class="nb">private_class_method</span> <span class="ss">:a_private_class_method</span>
    <span class="k">end</span>

    <span class="c1"># Should be private</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="no">PrivateClassMethod</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:a_private_class_method</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'3. when use singleton class'</span> <span class="k">do</span>
    <span class="k">class</span> <span class="nc">InSingletonClass</span>
      <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
        <span class="k">def</span> <span class="nf">a_public_class_method</span><span class="p">;</span> <span class="k">end</span>
      <span class="kp">private</span>
        <span class="k">def</span> <span class="nf">a_private_class_method</span><span class="p">;</span> <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">specify</span> <span class="p">{</span> <span class="no">InSingletonClass</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:a_public_class_method</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span> <span class="p">}</span>

    <span class="c1"># Should be private</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="no">InSingletonClass</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:a_private_class_method</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rspec private_class_method_spec.rb
.......

Finished in 0.00232 seconds
7 examples, 0 failures
</pre></div></div>

<p>ちなみにprivateなクラスメソッドがそれほど多くないなら、2番目の<code>private_class_method</code>を使う方がシンプルでいいと思うんですが、どうでしょうか？<br>
そもそもあまりクラスメソッドが多いと、本当にオブジェクト指向プログラミングできてますか？ということになりそうですし。</p>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<p>Privateメソッドに関連する話として、「JavaやC#の常識が通用しないRubyのprivateメソッド」というタイトルで以前ブログを書きました。<br>
<a href="http://junichiito.hateblo.jp/entry/20120315/1331754912" class="autolink" rel="nofollow noopener" target="_blank">http://junichiito.hateblo.jp/entry/20120315/1331754912</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />14位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>25</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/a6046733dd5683ff35b7">rescue節で例外の型を指定しない場合に補足できるのはStandardErrorとそのサブクラスだけ</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-08 22:27:55</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Javaや.NETをやってた人にしてみると、<code>Exception</code>クラスは普通の例外の代表のように考えてしまうかもしれません。<br>
しかしRubyの<code>Exception</code>は<code>NoMemoryError</code>等の致命的な例外の親クラスにもなっているため、例外の型を指定しない<code>rescue</code>節では補足されません。<br>
補足されるのは通常の実行時エラーを表す<code>StandardError</code>とそのサブクラス(<code>ArgumentError</code>等)になります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'rescue'</span> <span class="k">do</span>
  <span class="n">shared_examples_for</span> <span class="s1">'rescue StandardError'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'should rescue StandardError'</span> <span class="k">do</span>
      <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="no">StandardError</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'when not specify exception'</span> <span class="k">do</span>
    <span class="n">subject</span> <span class="k">do</span>
      <span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">begin</span>
          <span class="k">raise</span> <span class="n">e</span>
        <span class="k">rescue</span>
        <span class="k">end</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'should not rescue Exception'</span> <span class="k">do</span>
      <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="no">Exception</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">Exception</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it_should_behave_like</span> <span class="s1">'rescue StandardError'</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'when specify exception'</span> <span class="k">do</span>
    <span class="n">subject</span> <span class="k">do</span>
      <span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">begin</span>
          <span class="k">raise</span> <span class="n">e</span>
        <span class="k">rescue</span> <span class="no">Exception</span>
        <span class="k">end</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'should rescue Exception'</span> <span class="k">do</span>
      <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="no">Exception</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
    <span class="k">end</span>

    <span class="n">it_should_behave_like</span> <span class="s1">'rescue StandardError'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rspec rescue_spec.rb
....

Finished in 0.00162 seconds
4 examples, 0 failures
</pre></div></div>

<p>Rubyの例外の階層関係についてはこちらのページの図がわかりやすいです。</p>

<p><a href="http://rubylearning.com/satishtalim/ruby_exceptions.html" class="autolink" rel="nofollow noopener" target="_blank">http://rubylearning.com/satishtalim/ruby_exceptions.html</a></p>

<p>例外クラスを自分で定義する場合も通常は<code>Exception</code>クラスではなく、<code>StandardError</code>クラスのサブクラスにすべき、ということになりますね。</p>

<h3>
<span id="参考ページ" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%83%9A%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>参考ページ</h3>

<p><a href="http://www.ruby-lang.org/ja/old-man/html/_C0A9B8E6B9BDC2A4.html#begin" class="autolink" rel="nofollow noopener" target="_blank">http://www.ruby-lang.org/ja/old-man/html/_C0A9B8E6B9BDC2A4.html#begin</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />15位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>23</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/51baa4d1ebfc15326fe0">Rubyで複数の変数に別々の値を代入するイディオム</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-24 10:11:40</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rubyで複数の変数に配列の値を展開するイディオムやその実行結果を色々調べてみました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># カンマ区切りでxとyに別々の値を代入</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="c1"># x =&gt; 1, y =&gt; 2</span>

<span class="c1"># 配列にしても同じ</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span> <span class="c1"># x =&gt; 1, y =&gt; 2</span>

<span class="c1"># 要素数が多いと切り捨てられる</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span>  <span class="c1"># x =&gt; 1, y =&gt; 2</span>

<span class="c1"># 配列とカンマ区切りが並ぶと、xには配列が代入される</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="c1"># x =&gt; [1, 2], y =&gt; 3</span>

<span class="c1"># *を付けると配列が展開される(x, y = 1, 2, 3, 4と同じ)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="c1"># x =&gt; 1, y =&gt; 2</span>

<span class="c1"># x, y = 2, 3, 4と同じ</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*[</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="c1"># x =&gt; 2, y =&gt; 3</span>

<span class="c1"># x, y = 3, 4と同じ</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*[]</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="c1"># x =&gt; 3, y =&gt; 4</span>

<span class="c1"># *を付けなければ、xには空の配列が代入される</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="c1"># x =&gt; [], y =&gt; 3</span>

<span class="c1"># 配列の配列だけなら、*があってもなくても同じ</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]]</span> <span class="c1"># x =&gt; [1, 2], y =&gt; [3, 4]</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]]</span> <span class="c1"># x =&gt; [1, 2], y =&gt; [3, 4]</span>

<span class="c1"># 配列の配列とカンマ区切りの値が混在していると、*の有無で挙動が変わる</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]]</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span> <span class="c1"># x =&gt; [[1, 2], [3, 4]], y =&gt; 5</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]]</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span> <span class="c1"># x =&gt; [1, 2], y =&gt; [3, 4]</span>

<span class="c1"># 値や配列が一つだと、xにのみ値が入る</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># x =&gt; 1, y =&gt; nil</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="c1"># x =&gt; 1, y =&gt; nil</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*[</span><span class="mi">1</span><span class="o">]</span> <span class="c1"># x =&gt; 1, y =&gt; nil</span>

<span class="c1"># 配列が空だと、どちらもnilになる</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">[]</span> <span class="c1"># x =&gt; nil, y =&gt; nil</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*[]</span> <span class="c1"># x =&gt; nil, y =&gt; nil</span>
</pre></div></div>

<h2>
<span id="なんでこんなこと調べたの" class="fragment"></span><a href="#%E3%81%AA%E3%82%93%E3%81%A7%E3%81%93%E3%82%93%E3%81%AA%E3%81%93%E3%81%A8%E8%AA%BF%E3%81%B9%E3%81%9F%E3%81%AE"><i class="fa fa-link"></i></a>なんでこんなこと調べたの？</h2>

<p>なんでこんなこと調べたのかというと、ここのコードの意味がよくわからなかったからです。</p>

<ul>
<li><a href="https://github.com/diophore/book-rspec-codebreaker/blob/master/codebreaker.rb#L19" rel="nofollow noopener" target="_blank">diophore/book-rspec-codebreaker/codebreaker.rb#L19</a></li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">secret</span><span class="p">,</span> <span class="n">guess</span> <span class="o">=</span> <span class="o">*[</span><span class="vi">@secret</span><span class="o">.</span><span class="n">to_a</span><span class="p">,</span> <span class="n">guess</span><span class="o">.</span><span class="n">to_a</span><span class="o">].</span><span class="n">transpose</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="o">|</span> <span class="n">mark</span> <span class="o">&gt;&gt;</span> <span class="s1">'+'</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">g</span> <span class="p">}</span><span class="o">.</span><span class="n">transpose</span> <span class="o">||</span> <span class="o">[]</span><span class="p">,</span> <span class="o">[]</span>
<span class="n">secret</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">mark</span> <span class="o">&lt;&lt;</span> <span class="s1">'-'</span> <span class="k">if</span> <span class="n">guess</span><span class="o">.</span><span class="n">delete_first</span> <span class="n">c</span> <span class="p">}</span>
</pre></div></div>

<p>おそらく<code>|| []</code>の部分は不要で、こう書いても動作は同じでした。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">secret</span><span class="p">,</span> <span class="n">guess</span> <span class="o">=</span> <span class="o">*[</span><span class="vi">@secret</span><span class="o">.</span><span class="n">to_a</span><span class="p">,</span> <span class="n">guess</span><span class="o">.</span><span class="n">to_a</span><span class="o">].</span><span class="n">transpose</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="o">|</span> <span class="n">mark</span> <span class="o">&gt;&gt;</span> <span class="s1">'+'</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">g</span> <span class="p">}</span><span class="o">.</span><span class="n">transpose</span><span class="p">,</span> <span class="o">[]</span>
<span class="n">secret</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">mark</span> <span class="o">&lt;&lt;</span> <span class="s1">'-'</span> <span class="k">if</span> <span class="n">guess</span><span class="o">.</span><span class="n">delete_first</span> <span class="n">c</span> <span class="p">}</span>
</pre></div></div>

<h3>
<span id="最後に-が必要な理由" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB-%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AA%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a>最後に", []"が必要な理由</h3>

<p><code>[@secret.to_a, guess.to_a].transpose.reject {|s, g| mark &gt;&gt; '+' if s == g }.transpose</code>の部分は通常、<code>[[1,2],[3,4]]</code>のような配列の配列が返ってきます。<br>
なので、<code>secret, guess = *[[1,2], [3, 4]]</code>となり、<code>secret = [1,2]</code>、<code>guess = [3,4]</code>となります。</p>

<p>しかし、全ての要素がrejectされると結果は<code>[]</code>になります。<br>
すると、<code>secret, guess = *[]</code>となり、<code>secret</code>も<code>guess</code>も<code>nil</code>となります。</p>

<p><code>secret</code>が<code>nil</code>だと、次の行で<code>undefined method 'each' for nil:NilClass</code>のエラーが出るので、<code>secret, guess = *[], []</code>として、<code>secret</code>に<code>[]</code>が代入されるようにしているわけです。</p>

<h3>
<span id="be-more-readable" class="fragment"></span><a href="#be-more-readable"><i class="fa fa-link"></i></a>Be more readable</h3>

<p>でもこれだとちょっとトリッキーなので、僕だったらこう書くかな～と思いました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">secret</span><span class="p">,</span> <span class="n">guess</span> <span class="o">=</span> <span class="o">*[</span><span class="vi">@secret</span><span class="o">.</span><span class="n">to_a</span><span class="p">,</span> <span class="n">guess</span><span class="o">.</span><span class="n">to_a</span><span class="o">].</span><span class="n">transpose</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="o">|</span> <span class="n">mark</span> <span class="o">&gt;&gt;</span> <span class="s1">'+'</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">g</span> <span class="p">}</span><span class="o">.</span><span class="n">transpose</span>
<span class="n">secret</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">mark</span> <span class="o">&lt;&lt;</span> <span class="s1">'-'</span> <span class="k">if</span> <span class="n">guess</span><span class="o">.</span><span class="n">delete_first</span> <span class="n">c</span> <span class="p">}</span> <span class="k">unless</span> <span class="n">secret</span><span class="o">.</span><span class="n">nil?</span>
</pre></div></div>

<p><code>(secret || []).each</code>と書くのも良いかもしれませんね。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />16位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>22</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/b2e4289c5ae8bc1b2ee9">syntax_fixでRubyの古いHash記法を1.9スタイルに一括置換する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-06-13 06:05:16</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h2>

<p>実行環境はRuby 1.9(または2.0)なのに、コード上では新旧のHash記法が混在して美しくない。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># 古い記法</span>
<span class="ss">:key</span> <span class="o">=&gt;</span> <span class="s1">'value'</span>
<span class="c1"># 新しい記法(Ruby 1.9以降)</span>
<span class="ss">key</span><span class="p">:</span> <span class="s1">'value'</span>
</pre></div></div>

<h2>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h2>

<p><a href="https://github.com/HeeL/syntax_fix" rel="nofollow noopener" target="_blank">syntax_fix</a>というGemを使うと簡単に一括置換できます。</p>

<p>対象となる拡張子は 'rb', 'erb', 'rake', 'haml' です。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ gem install syntax_fix
$ rbenv rehash # rbenvを使っている場合
$ cd your-app-dir
$ syntax_fix -v # -vオプションで進行状況が表示される
Reading files...
/your-app-dir/config/application.rb [CHANGED]
/your-app-dir/config/routes.rb [CHANGED]
/your-app-dir/db/schema.rb [CHANGED]
.
.
.
Done!
$ git diff # 念のため変更内容を確認
</pre></div></div>

<h2>
<span id="注意" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>注意</h2>

<p>変換後のテスト実行もお忘れなく！！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />17位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>20</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/caa12cbac013ed6a2f34">日本語URLのデコードに失敗してActionController::BadRequestが発生する場合の対処方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-13 19:46:46</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h2>

<p>Railsで日本語URLをリンクで使っている場合、たまにデコードできないパラメータを渡されて、<code>ActionController::BadRequest</code>が発生することがある。(userAgent = msnbotのときに多い？)</p>

<p>Controllerの<code>before_action</code>等で対処しようとしても、フレームワークの内部でエラーが起きるので、そこまで処理がやってこない。</p>

<h2>
<span id="対処方法" class="fragment"></span><a href="#%E5%AF%BE%E5%87%A6%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>対処方法</h2>

<p><code>ActionDispatch::Routing::RouteSet::Dispatcher</code>用のモンキーパッチを当てる。</p>

<p>以下のモンキーパッチの例ではデコードに失敗した文字列に空文字をセットしている。(sjisやeucでデコードしても正常な文字列として回復できなかったため)</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># config/initializers/active_dispatch_fix.rb</span>
<span class="k">module</span> <span class="nn">ActionDispatch::Routing::RouteSet::DispatcherFix</span>
  <span class="k">def</span> <span class="nf">call</span> <span class="n">env</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">env</span><span class="o">[</span><span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Routing</span><span class="o">::</span><span class="no">RouteSet</span><span class="o">::</span><span class="no">PARAMETERS_KEY</span><span class="o">]</span>
    <span class="n">params</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="k">unless</span> <span class="n">value</span><span class="o">.</span><span class="n">valid_encoding?</span>
        <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">"[INFO] Clear invalid value for </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">params</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="s1">''</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">super</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Routing</span><span class="o">::</span><span class="no">RouteSet</span><span class="o">::</span><span class="no">Dispatcher</span><span class="o">.</span><span class="n">send</span> <span class="ss">:prepend</span><span class="p">,</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Routing</span><span class="o">::</span><span class="no">RouteSet</span><span class="o">::</span><span class="no">DispatcherFix</span>
</pre></div></div>

<p>以下はRSpecでテストする場合のサンプルコード。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># spec/requests/examples_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s1">'Examples'</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s1">'with invalid parameter'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:invalid_path</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'/examples/%E3%E2%80%9A%BD%E3%C6%92'</span> <span class="p">}</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">allow</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:info</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'handles as RecordNotFound and writes log'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:info</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s1">'[INFO] Clear invalid value for some_key'</span><span class="p">)</span><span class="o">.</span><span class="n">once</span>
      <span class="n">expect</span><span class="p">{</span> <span class="n">get</span> <span class="n">invalid_path</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h3>

<ul>
<li>ベースにしたロジックはこちら。

<ul>
<li><a href="https://gist.github.com/morr/9399606" class="autolink" rel="nofollow noopener" target="_blank">https://gist.github.com/morr/9399606</a></li>
</ul>
</li>
<li>RSpecを読み書きするのが苦手な方はこちらの電子書籍を！

<ul>
<li><a href="https://leanpub.com/everydayrailsrspec-jp" rel="nofollow noopener" target="_blank">Everyday Rails - RSpecによるRailsテスト入門</a></li>
</ul>
</li>
</ul>

<h3>
<span id="special-thanks-to" class="fragment"></span><a href="#special-thanks-to"><i class="fa fa-link"></i></a>Special thanks to</h3>

<ul>
<li>
<a href="http://qiita.com/tkawa">@tkawa</a> -- 上記gistのURLを教えてくれました。ありがとうございました。</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />18位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>17</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/0c59c9c0ff01a2dbf47e">Rubyのワンライナーを使って、HAMLの%img{ }をimage_tagに置換する方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-02-14 19:18:46</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[haml]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="このtipsが必要になる背景" class="fragment"></span><a href="#%E3%81%93%E3%81%AEtips%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AB%E3%81%AA%E3%82%8B%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>このTipsが必要になる背景</h2>

<ul>
<li>デザイナーさんが画面デザインをHTMLで納品してくれる場合がある。</li>
<li>RailsプログラマとしてはHAMLで書き直したい。</li>
<li>大方のタグは <a href="http://html2haml.heroku.com/" rel="nofollow noopener" target="_blank">Html2Haml</a>で自動変換できる。</li>
<li>しかし、画像はassetsの下に置くのでパスが変わってしまう。</li>
<li>
<code>%img{ }</code>は全部<code>image_tag</code>メソッドを使って書き直したいが、数が多いので手作業でやるのは面倒。</li>
</ul>

<h2>
<span id="やりたいこと" class="fragment"></span><a href="#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>やりたいこと</h2>

<p>こんなimgタグを</p>

<p><code>%img{alt: "顔写真", height: "80", src: "img/face.jpg", width: "100"}</code></p>

<p>こう置換したい。</p>

<p><code>= image_tag "face.jpg", size: "100x80", alt: "顔写真"</code></p>

<h2>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h2>

<p>Rubyのワンライナーで置換してみた。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ ruby -pe <span class="s1">'sub(/%img{alt: "([^"]+)", height: "([^"]+)", src: "img\/([-\w.]+)", width: "([^"]+)"}/, "= image_tag \"\\3\", size: \"\\4x\\2\", alt: \"\\1\"")'</span> test.html.haml &gt; replaced.html.haml
</pre></div></div>

<h3>
<span id="実行例" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E4%BE%8B"><i class="fa fa-link"></i></a>実行例</h3>

<div class="code-frame" data-lang="haml">
<div class="code-lang"><span class="bold">test.html.haml</span></div>
<div class="highlight"><pre><span></span><span class="nt">%body</span>
  <span class="nt">%img</span><span class="p">{</span><span class="ss">alt</span><span class="p">:</span> <span class="s2">"顔写真1"</span><span class="p">,</span> <span class="ss">height</span><span class="p">:</span> <span class="s2">"80"</span><span class="p">,</span> <span class="ss">src</span><span class="p">:</span> <span class="s2">"img/face-1.jpg"</span><span class="p">,</span> <span class="ss">width</span><span class="p">:</span> <span class="s2">"100"</span><span class="p">}</span>
  <span class="nt">%hr</span>
  <span class="nt">%img</span><span class="p">{</span><span class="ss">alt</span><span class="p">:</span> <span class="s2">"顔写真2"</span><span class="p">,</span> <span class="ss">height</span><span class="p">:</span> <span class="s2">"100"</span><span class="p">,</span> <span class="ss">src</span><span class="p">:</span> <span class="s2">"img/face-2.jpg"</span><span class="p">,</span> <span class="ss">width</span><span class="p">:</span> <span class="s2">"120"</span><span class="p">}</span>
  <span class="nt">%p</span>
</pre></div>
</div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ ruby -pe <span class="s1">'sub(/%img{alt: "([^"]+)", height: "([^"]+)", src: "img\/([-\w.]+)", width: "([^"]+)"}/, "= image_tag \"\\3\", size: \"\\4x\\2\", alt: \"\\1\"")'</span> test.html.haml &gt; replaced.html.haml
</pre></div></div>

<div class="code-frame" data-lang="haml">
<div class="code-lang"><span class="bold">replaced.html.haml</span></div>
<div class="highlight"><pre><span></span><span class="nt">%body</span>
  <span class="p">=</span> <span class="n">image_tag</span> <span class="s2">"face-1.jpg"</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="s2">"100x80"</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="s2">"顔写真1"</span>
  <span class="nt">%hr</span>
  <span class="p">=</span> <span class="n">image_tag</span> <span class="s2">"face-2.jpg"</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="s2">"120x100"</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="s2">"顔写真2"</span>
  <span class="nt">%p</span>
</pre></div>
</div>

<h2>
<span id="解説" class="fragment"></span><a href="#%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>解説</h2>

<p>コマンドがややこしく見えると思うので解説します。</p>

<h3>
<span id="コマンドの基本形" class="fragment"></span><a href="#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AE%E5%9F%BA%E6%9C%AC%E5%BD%A2"><i class="fa fa-link"></i></a>コマンドの基本形</h3>

<p><code>ruby -pe 'sub(/正規表現/, "置換後の文字列")' 処理対象ファイルのパス &gt; 置換後のファイルパス</code> というのがこの処理の基本形。</p>

<ul>
<li>
<code>-e</code>オプションはワンライナーを実行する。</li>
<li>
<code>-p</code>オプションはファイルの内容を1行ずつ読み取る。</li>
<li>
<code>sub</code>は読み取った行のテキストを置換する。</li>
<li>
<code>処理対象ファイルのパス</code>でRubyに食わせるファイルを指定する。</li>
<li>最後に、<code>&gt; 置換後のファイルパス</code>という形で標準出力の内容を新しいファイルに書き込む。これを省略すると標準出力に置換後の文字列が表示される。動作確認するときに便利。</li>
</ul>

<h3>
<span id="subの処理" class="fragment"></span><a href="#sub%E3%81%AE%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>subの処理</h3>

<p><code>sub</code>の処理については以下の通り。</p>

<ol>
<li>
<p>正規表現で各値をキャプチャする。</p>

<ul>
<li><code>/%img{alt: "([^"]+)", height: "([^"]+)", src: "img\/([-\w.]+)", width: "([^"]+)"}/</code></li>
</ul>
</li>
<li>
<p>各値は以下のような番号でキャプチャされる。(丸括弧がキャプチャ用のメタ文字)</p>

<ul>
<li>alt: <code>\1</code>
</li>
<li>height: <code>\2</code>
</li>
<li>src: <code>\3</code> (ただし<code>img/</code>は含まない)</li>
<li>width: <code>\4</code>
</li>
</ul>
</li>
<li><p>キャプチャした文字列を利用して、置換後の文字列を組み立てる。</p></li>
</ol>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>"= image_tag \"\\3\", size: \"\\4x\\2\", alt: \"\\1\""
</pre></div></div>

<h2>
<span id="制限事項備考" class="fragment"></span><a href="#%E5%88%B6%E9%99%90%E4%BA%8B%E9%A0%85%E5%82%99%E8%80%83"><i class="fa fa-link"></i></a>制限事項＆備考</h2>

<ul>
<li>あくまで、altやheightなどの属性が同じ順番で並んでいることが前提です。順番が違ったり、存在する属性としない属性がバラバラだったりすると正規表現にマッチしません。</li>
<li>そこそこの努力で80点ぐらいの結果が出せることを目的としています。</li>
<li>一発で完璧にマッチする正規表現を作るのは難しいので、<a href="http://rubular.com" class="autolink" rel="nofollow noopener" target="_blank">http://rubular.com</a> で試行錯誤した方が近道だったりします。</li>
</ul>

<h2>
<span id="応用" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8"><i class="fa fa-link"></i></a>応用</h2>

<p>CSS(SCSS)の<code>url</code>も<code>image-url</code>に置き換えてみましょう。</p>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">test.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="nt">body</span> <span class="p">{</span>
  <span class="nt">text-align</span><span class="nd">:</span> <span class="nt">center</span><span class="o">;</span>
  <span class="nt">background</span><span class="nd">:</span> <span class="nt">url</span><span class="o">(</span><span class="s2">"../img/bg.jpg"</span><span class="o">)</span> <span class="nt">no-repeat</span> <span class="nt">center</span> <span class="nt">top</span> <span class="nn">#f8f8f8</span><span class="o">;</span>
<span class="p">}</span>

<span class="nn">#headWrapper</span> <span class="p">{</span>
  <span class="nt">background</span><span class="nd">:</span> <span class="nt">url</span><span class="o">(</span><span class="s2">"../img/head_bg.jpg"</span><span class="o">)</span> <span class="nt">repeat-x</span> <span class="nt">right</span> <span class="nt">top</span><span class="o">;</span>
  <span class="nt">height</span><span class="nd">:</span> <span class="nt">80px</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ ruby -pe <span class="s1">'sub(/url\(.?\.\.\/img\/([-\w.]+).?\)/, "image-url(\"\\1\")")'</span> test.css.scss &gt; replaced.css.scss
</pre></div></div>

<div class="code-frame" data-lang="scss">
<div class="code-lang"><span class="bold">replaced.css.scss</span></div>
<div class="highlight"><pre><span></span><span class="nt">body</span> <span class="p">{</span>
  <span class="nt">text-align</span><span class="nd">:</span> <span class="nt">center</span><span class="o">;</span>
  <span class="nt">background</span><span class="nd">:</span> <span class="nt">image-url</span><span class="o">(</span><span class="s2">"bg.jpg"</span><span class="o">)</span> <span class="nt">no-repeat</span> <span class="nt">center</span> <span class="nt">top</span> <span class="nn">#f8f8f8</span><span class="o">;</span>
<span class="p">}</span>

<span class="nn">#headWrapper</span> <span class="p">{</span>
  <span class="nt">background</span><span class="nd">:</span> <span class="nt">image-url</span><span class="o">(</span><span class="s2">"head_bg.jpg"</span><span class="o">)</span> <span class="nt">repeat-x</span> <span class="nt">right</span> <span class="nt">top</span><span class="o">;</span>
  <span class="nt">height</span><span class="nd">:</span> <span class="nt">80px</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h2>

<ul>
<li><a href="http://d.hatena.ne.jp/zariganitosh/20131107/ruby_oneliner_omission" rel="nofollow noopener" target="_blank">rubyのワンライナーに見る驚きの省略記法</a></li>
<li><a href="http://d.hatena.ne.jp/maeharin/20130113/ruby_oneliner" rel="nofollow noopener" target="_blank">Rubyワンライナー入門</a></li>
</ul>

<h2>
<span id="おまけそもそも正規表現がわからないんですけどというプログラマさんへ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%8C%E3%82%8F%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%82%93%E3%81%A7%E3%81%99%E3%81%91%E3%81%A9%E3%81%A8%E3%81%84%E3%81%86%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9E%E3%81%95%E3%82%93%E3%81%B8"><i class="fa fa-link"></i></a>おまけ:「そもそも正規表現がわからないんですけど？」というプログラマさんへ</h2>

<p>それはマズいです！！今すぐ勉強してください！<br>
正規表現をマスターすればあなたの生産性は256倍向上します。</p>

<p>僕はオライリーの「フクロウ本」で勉強しました。<br>
一見、難しそうな本に見えますが、基本の「キ」から丁寧に教えてくれるので非常にわかりやすかったです。</p>

<p><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873113598/junic05-22/ref=nosim/" rel="nofollow noopener" target="_blank">詳説 正規表現 第3版</a><br>
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873113598/junic05-22/ref=nosim/" rel="nofollow noopener" target="_blank"><br>
<img src="https://camo.qiitausercontent.com/9772e9cf83ebbec6ff4f5af518dbdb7e2894c512/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f33353463646638382d636231632d616562312d653461352d3664643039346634623930332e6a706567" alt="51cRxtwo7IL._SL160_.jpg" title="51cRxtwo7IL._SL160_.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/354cdf88-cb1c-aeb1-e4a5-6dd094f4b903.jpeg"><br>
</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />19位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>14</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/576254d649c3748cb865">サーバーにデータを送信できる読み取り専用フォームを作る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-19 08:48:01</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[HTML]</b> <b>[JavaScript]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="動機" class="fragment"></span><a href="#%E5%8B%95%E6%A9%9F"><i class="fa fa-link"></i></a>動機</h2>

<p>入力画面 → 確認画面 → 登録完了画面というような画面遷移をするWebアプリケーションを作る際に、できるだけ入力画面と確認画面を共通化したい。<br>
さらに確認画面から登録完了画面に遷移するタイミングでデータを更新するので、入力画面からだけではなく確認画面からも入力値をサーバーに送信する必要がある。</p>

<h2>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h2>

<p>入力画面と確認画面は同じHTMLフォームを使いつつ、確認画面ではユーザーがフォームに表示されているデータを変更できないようにする。</p>

<h3>
<span id="確認環境" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>確認環境</h3>

<p>Mac</p>

<ul>
<li>Safari 5.1.7</li>
<li>Chrome 20.0.1132.57</li>
<li>Firefox 14.0.1</li>
</ul>

<p>Windows</p>

<ul>
<li>IE9</li>
<li>IE8</li>
<li>IE7</li>
</ul>

<h3>
<span id="テキストボックステキストエリアの場合" class="fragment"></span><a href="#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%83%9C%E3%83%83%E3%82%AF%E3%82%B9%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%82%A8%E3%83%AA%E3%82%A2%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>テキストボックス/テキストエリアの場合</h3>

<p>readonly属性を付ける。なお、disabled属性を付けるとサーバーにデータが送信できないので、今回の動機を充たさない。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">"a"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">value</span><span class="o">=</span><span class="s">"hoge"</span> <span class="na">readonly</span><span class="o">=</span><span class="s">"readonly"</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">name</span><span class="o">=</span><span class="s">"b"</span> <span class="na">readonly</span><span class="o">=</span><span class="s">"readonly"</span><span class="p">&gt;</span>piyo<span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
</pre></div></div>

<p>テキストボックスとテキストエリア以外はreadonly属性が使えないのでJavaScript(CoffeeScript)でユーザーの操作を無効化する等の工夫が必要になる。</p>

<h3>
<span id="セレクトボックスの場合" class="fragment"></span><a href="#%E3%82%BB%E3%83%AC%E3%82%AF%E3%83%88%E3%83%9C%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>セレクトボックスの場合</h3>

<p>onfocusイベントで変更前の値を保存し、onchangeイベントで強制的に変更前の値に戻す。<br>
ここでは画面内の全セレクトボックスにそのような処理を付加するjQuery + CoffeeScriptの例を示す。</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s">'select'</span><span class="p">).</span><span class="nx">live</span> <span class="s">'focus'</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="k">this</span><span class="p">.</span><span class="nv">previous_value = </span><span class="k">this</span><span class="p">.</span><span class="nx">value</span>

<span class="nx">$</span><span class="p">(</span><span class="s">'select'</span><span class="p">).</span><span class="nx">live</span> <span class="s">'change'</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="k">this</span><span class="p">.</span><span class="nv">value = </span><span class="k">this</span><span class="p">.</span><span class="nx">previous_value</span>
</pre></div></div>

<h3>
<span id="ラジオボタンの場合" class="fragment"></span><a href="#%E3%83%A9%E3%82%B8%E3%82%AA%E3%83%9C%E3%82%BF%E3%83%B3%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>ラジオボタンの場合</h3>

<p>チェックされていないラジオボタンにdisabled属性を付けることで、「1つしか選択できないラジオボタン」を作る。<br>
HTMLタグに直接disabled属性を付ける方法もあるが、ここでは画面内の全ラジオボタンに一括でdisabled属性を付与するjQuery + CoffeeScriptの例を示す。</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s">':radio:not(:checked)'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">'disabled'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</pre></div></div>

<h3>
<span id="チェックボックスの場合" class="fragment"></span><a href="#%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%83%9C%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>チェックボックスの場合</h3>

<p>jQueryのpreventDefaultメソッドを使って、onclickイベントを無効化する。</p>

<div class="code-frame" data-lang="coffeescript"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s">':checkbox'</span><span class="p">).</span><span class="nx">live</span> <span class="s">'click'</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
</pre></div></div>

<h2>
<span id="参考情報" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1"><i class="fa fa-link"></i></a>参考情報</h2>

<h3>
<span id="画面のデザインについて" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E3%81%AE%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>画面のデザインについて</h3>

<p>値の変更を抑制するだけではなく、フォームが読み取り専用になっていることがわかるように、視覚的な変化を加えることが望ましい。</p>

<h3>
<span id="参考にしたwebサイト" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9Fweb%E3%82%B5%E3%82%A4%E3%83%88"><i class="fa fa-link"></i></a>参考にしたWebサイト</h3>

<p><a href="http://www.koikikukan.com/archives/2009/04/26-003300.php" class="autolink" rel="nofollow noopener" target="_blank">http://www.koikikukan.com/archives/2009/04/26-003300.php</a></p>

<p><a href="http://stackoverflow.com/questions/1953017/why-cant-radio-buttons-be-readonly" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/1953017/why-cant-radio-buttons-be-readonly</a></p>

<p><a href="http://stackoverflow.com/questions/7427097/not-disabled-read-only-checkbox-in-jquery" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/7427097/not-disabled-read-only-checkbox-in-jquery</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />20位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>13</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/07f2e3ca29f9881b83d6">Rails 4で静的なHTMLやCSSからダイジェスト無しのパスで画像を参照したい場合</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-29 17:43:54</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h2>

<ul>
<li>前提: Rails 4を使っている。</li>
<li>やりたいこと: 静的なHTMLやCSS(ERBやSASSではない)で<code>app/assets/images</code>配下の画像を参照したい。

<ul>
<li>例: <code>&lt;img src="assets/avatar.png"&gt;</code>
</li>
</ul>
</li>
<li>開発環境では画像が表示されるが、本番環境では画像が表示されない。

<ul>
<li>理由: Rails 4ではダイジェスト付き(ランダム文字列)の画像しか作成されないから。</li>
<li>静的なHTMLやCSSでは<code>&lt;img src="assets/avatar-5b7746a0abe2edd0dc3a9145c40ec523.png"&gt;</code>みたいなタグは作れない。</li>
</ul>
</li>
<li>さあ困った。</li>
</ul>

<h2>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h2>

<p><a href="https://github.com/alexspeller/non-stupid-digest-assets" rel="nofollow noopener" target="_blank">non-stupid-digest-assets</a> gemを導入する。</p>

<h3>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h3>

<p>Gemfileに追加すればOK。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"non-stupid-digest-assets"</span>
</pre></div></div>

<p>本番環境にデプロイすれば、ダイジェスト無しの画像にもアクセスできるはず。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p><a href="https://github.com/alexspeller/non-stupid-digest-assets" rel="nofollow noopener" target="_blank">non-stupid-digest-assets</a> gem、便利！！</p>

<h3>
<span id="使用上の注意" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>使用上の注意</h3>

<p>ダイジェスト無しの画像は、更新してもブラウザのキャッシュが引き続き表示される可能性があるので、使いどころには十分注意しましょう。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />21位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/898d29d7dd4ad9abe43a">[Ruby] 配列の各要素を2連続させるイディオム</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-25 06:13:31</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h2>

<p>こんな配列を、</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
</pre></div></div>

<p>こうしたい。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
</pre></div></div>

<p>どういう書き方があるんだろう？</p>

<p>・・・という話題が某所で挙がったので、いくつかイディオムを考えてみました。</p>

<h2>
<span id="map" class="fragment"></span><a href="#map"><i class="fa fa-link"></i></a>#map</h2>

<p>よくあるアイデアは<code>map</code>を使う方法かもしれません。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="o">[</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">flatten</span> <span class="c1">#=&gt; [1, 1, 2, 2, 3, 3]</span>
</pre></div></div>

<p>しかし、もっといいメソッドがあります。</p>

<h2>
<span id="flat_map" class="fragment"></span><a href="#flat_map"><i class="fa fa-link"></i></a>#flat_map</h2>

<p><code>map</code> + <code>flatten</code>するなら、その名もズバリ、<code>flat_map</code>というメソッドが使えます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">].</span><span class="n">flat_map</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="o">[</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">]</span><span class="p">}</span> <span class="c1">#=&gt; [1, 1, 2, 2, 3, 3]</span>
</pre></div></div>

<h2>
<span id="zip" class="fragment"></span><a href="#zip"><i class="fa fa-link"></i></a>#zip</h2>

<p>しかし、個人的に一番好きなのは<code>zip</code>を使って宣言的に書く方法です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="n">array</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">array</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span> <span class="c1">#=&gt; [1, 1, 2, 2, 3, 3]</span>
</pre></div></div>

<p>変数への格納と<code>flatten</code>をなくせるともっとカッコいいんですが。</p>

<h2>
<span id="rspecで確認する" class="fragment"></span><a href="#rspec%E3%81%A7%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>RSpecで確認する</h2>

<p>ちゃんとテストも書いて確認しましょうね～。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">describe</span> <span class="s1">'duplicate each item'</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:array</span><span class="p">)</span> <span class="p">{</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span> <span class="p">}</span>
  <span class="n">shared_examples</span> <span class="s1">'duplicate each item'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s1">'use map'</span> <span class="k">do</span>
    <span class="n">subject</span> <span class="p">{</span> <span class="n">array</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="o">[</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">flatten</span> <span class="p">}</span>
    <span class="n">it_behaves_like</span> <span class="s1">'duplicate each item'</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s1">'use flat_map'</span> <span class="k">do</span>
    <span class="n">subject</span> <span class="p">{</span> <span class="n">array</span><span class="o">.</span><span class="n">flat_map</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="o">[</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">]</span><span class="p">}</span> <span class="p">}</span>
    <span class="n">it_behaves_like</span> <span class="s1">'duplicate each item'</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s1">'use zip'</span> <span class="k">do</span>
    <span class="n">subject</span> <span class="p">{</span> <span class="n">array</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">array</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span> <span class="p">}</span>
    <span class="n">it_behaves_like</span> <span class="s1">'duplicate each item'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>他にもいろいろやり方はあると思いますが、上の3つぐらいが一番シンプルかな～と思います。<br>
「もっと短くてクールなイディオムがあるぜ！」という方は、ぜひコメントをお願いします～。</p>

<h2>
<span id="あわせて読みたい" class="fragment"></span><a href="#%E3%81%82%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>あわせて読みたい</h2>

<ul>
<li><a href="http://qiita.com/jnchito/items/dedb3b889ab226933ccf" id="reference-e22cd6f59d4c32763cde">[初心者向け] RubyやRailsでリファクタリングに使えそうなイディオムとか便利メソッドとか</a></li>
<li><a href="http://www.ruby-doc.org/core-2.1.1/Array.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.ruby-doc.org/core-2.1.1/Array.html</a></li>
<li><a href="http://www.ruby-doc.org/core-2.1.1/Enumerable.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.ruby-doc.org/core-2.1.1/Enumerable.html</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />22位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/9a6edbead8b23cddd7f3">Twitter Bootstrap: Thumbnailsでサムネイルが横に広がる問題を解決する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-19 09:46:31</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[bootstrap]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Twitter BootstrapのThumbnailsを使っていると、印刷時にサムネイルが横に広がって画面と全然異なる見た目になる場合があります。</p>

<h3>
<span id="例" class="fragment"></span><a href="#%E4%BE%8B"><i class="fa fa-link"></i></a>例</h3>

<p><a href="http://twitter.github.com/bootstrap/components.html#thumbnails" class="autolink" rel="nofollow noopener" target="_blank">http://twitter.github.com/bootstrap/components.html#thumbnails</a></p>

<p><a href="https://camo.qiitausercontent.com/f5c7accfae0c16e6db8ee09ec3b4eab7720a8f0d/687474703a2f2f692e737461636b2e696d6775722e636f6d2f396446634c2e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/f5c7accfae0c16e6db8ee09ec3b4eab7720a8f0d/687474703a2f2f692e737461636b2e696d6775722e636f6d2f396446634c2e706e67" alt="enter image description here" data-canonical-src="http://i.stack.imgur.com/9dFcL.png"></a></p>

<p><a href="https://camo.qiitausercontent.com/53f965e8229594994deb0f85cefd9f11700657e3/687474703a2f2f692e737461636b2e696d6775722e636f6d2f6d6f7351582e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/53f965e8229594994deb0f85cefd9f11700657e3/687474703a2f2f692e737461636b2e696d6775722e636f6d2f6d6f7351582e706e67" alt="enter image description here" data-canonical-src="http://i.stack.imgur.com/mosQX.png"></a></p>

<p>これは<code>responsive.css</code>が悪さ(?)をしているせいです。<br>
以下のように印刷時に<code>responsive.css</code>が取込まれないようにすれば、横幅が広がる問題は解決します。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">"assets/css/bootstrap-responsive.css"</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span><span class="p">&gt;</span>
↓
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">"assets/css/bootstrap-responsive.css"</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">media</span><span class="o">=</span><span class="s">"screen"</span><span class="p">&gt;</span>
</pre></div></div>

<h3>
<span id="twitter-bootstrap-railsを使っている場合" class="fragment"></span><a href="#twitter-bootstrap-rails%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>twitter-bootstrap-railsを使っている場合</h3>

<p>twitter-bootstrap-railsを使っている場合は、<code>bootstrap_and_overrides.less</code>にある、</p>

<div class="code-frame" data-lang="less">
<div class="code-lang"><span class="bold">bootstrap_and_overrides.less</span></div>
<div class="highlight"><pre><span></span>@import "twitter/bootstrap/responsive";
</pre></div>
</div>

<p>の行を削除、もしくはscreen専用のファイルに移動すればOKです。</p>

<h3>
<span id="背景が真っ黒になる問題への対処" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF%E3%81%8C%E7%9C%9F%E3%81%A3%E9%BB%92%E3%81%AB%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C%E3%81%B8%E3%81%AE%E5%AF%BE%E5%87%A6"><i class="fa fa-link"></i></a>背景が真っ黒になる問題への対処</h3>

<p>また、背景色が真っ黒になる問題は、印刷時に適切な<code>background-color</code>があたるようにすれば、背景色を変えることができます。</p>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<p>この記事はStackOverflowで得られた回答を日本語に直したものです。<br>
<a href="http://stackoverflow.com/questions/12955718/twitter-bootstrap-how-to-print-thumbnails-as-same-as-screen" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/12955718/twitter-bootstrap-how-to-print-thumbnails-as-same-as-screen</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />23位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>12</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/9a2a78bd8140f1f823ae">HerokuでStaging環境のデータベースをProduction環境にコピーする手順</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-09-28 14:54:41</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="事前準備" class="fragment"></span><a href="#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>事前準備</h2>

<h3>
<span id="remoteオプションを追加する" class="fragment"></span><a href="#remote%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>remoteオプションを追加する</h3>

<p><code>--remote staging</code> <code>--remote production</code>のようなオプションで、Staging環境とProduction環境を使い分けられるようにしておきます。<br>
詳細は以下のブログ記事を参照してください。</p>

<p><a href="http://blog.mat-aki.net/heroku-staging-production-command-remote" class="autolink" rel="nofollow noopener" target="_blank">http://blog.mat-aki.net/heroku-staging-production-command-remote</a></p>

<h3>
<span id="pg-backupsアドオンを追加する" class="fragment"></span><a href="#pg-backups%E3%82%A2%E3%83%89%E3%82%AA%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>PG Backupsアドオンを追加する</h3>

<p>Staging, ProductionともにHerokuのPG Backupsアドオンを追加します。(無料)</p>

<h2>
<span id="手順" class="fragment"></span><a href="#%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>手順</h2>

<p>PG Backupsのcaptureとrestoreを使って、データをトランスファーします。<br>
間違って逆方向にコピーしたりしないよう、二人で作業することを推奨します。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># サイトにメンテナンスモードに変更</span>
$  heroku maintenance:on --remote staging
$  heroku maintenance:on --remote production

<span class="c1"># Staging環境のバックアップ状況を確認</span>
$  heroku pgbackups --remote staging

<span class="c1"># Staging環境のデータをコピー(バックアップ)</span>
$  heroku pgbackups:capture --remote staging

<span class="c1"># バックアップが増えたことを確認</span>
$  heroku pgbackups --remote staging

<span class="c1"># Staging =&gt; Productionへのコピー(リストア)を実施</span>
$  heroku pgbackups:restore DATABASE <span class="sb">`</span>heroku pgbackups:url --remote staging<span class="sb">`</span> --remote production

<span class="c1"># Production環境に接続してデータがちゃんとコピーされたことを確認</span>
$  heroku console --remote production

<span class="c1"># サイトのメンテナンスモードを解除</span>
$  heroku maintenance:off --remote production
$  heroku maintenance:off --remote staging

</pre></div></div>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p>PG Backupsのコマンドマニュアル<br>
<a href="https://devcenter.heroku.com/articles/pgbackups" class="autolink" rel="nofollow noopener" target="_blank">https://devcenter.heroku.com/articles/pgbackups</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />24位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/453e4bdb8bd2b9401a1a">RSpecでModelのテストをするときは、リレーションをchange from/toとしてテストしないように注意する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-21 11:23:50</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="問題-なぜかfailするテスト" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C-%E3%81%AA%E3%81%9C%E3%81%8Bfail%E3%81%99%E3%82%8B%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>問題: なぜかfailするテスト</h2>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span>  <span class="n">it</span> <span class="s1">'adds comment'</span> <span class="k">do</span>
    <span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s1">'Hello!'</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s1">'Hi!'</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">{</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="n">comment</span><span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="p">}</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="o">[</span><span class="n">comment</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div></div>

<p>このテストを実行するとfailします。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>result should have initially been [], but was #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Comment id: 1, text: "Hi!", post_id: 1, created_at: "2014-03-21 01:51:44", updated_at: "2014-03-21 01:51:44"&gt;]&gt;
./spec/models/comment_spec.rb:7:in `block (2 levels) in &lt;top (required)&gt;'
</pre></div></div>

<p>なぜでしょうか？</p>

<h2>
<span id="failする原因-postcommentsは実は配列ではない" class="fragment"></span><a href="#fail%E3%81%99%E3%82%8B%E5%8E%9F%E5%9B%A0-postcomments%E3%81%AF%E5%AE%9F%E3%81%AF%E9%85%8D%E5%88%97%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>failする原因: post.commentsは実は配列ではない</h2>

<p><code>post.comments</code>は配列ではなくリレーションなので、比較される寸前までデータベースに問い合わせない、というのが主要な原因です。</p>

<p><code>post.comments &lt;&lt; comment</code>の実行前に<code>post.comments</code>はいったんRSpec側に実際の<code>from</code>の値として保存されますが、まだデータベースに問い合わせていません。</p>

<p>そして、<code>post.comments &lt;&lt; comment</code>の実行後に<code>post.comments</code>の値を<code>from</code>と<code>to</code>のそれぞれで評価します。</p>

<p>しかし、どちらもこのタイミングでデータベースに問い合わせるので、<code>from</code>にもデータベースに保存された<code>comment</code>が返ってきてしまいます。</p>

<p>結果として、「<code>from</code>の値は<code>[]</code>ではなかった」と判断されてfailするわけです。</p>

<h2>
<span id="解決策-明示的に配列に変換する" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96-%E6%98%8E%E7%A4%BA%E7%9A%84%E3%81%AB%E9%85%8D%E5%88%97%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>解決策: 明示的に配列に変換する</h2>

<p><code>change{}</code>の中をリレーションではなく、確実に配列として返すようにします。具体的には<code>post.comments.to_a</code>です。<br>
こうすれば、<code>post.comments &lt;&lt; comment</code>の実行前にデータベースへの問い合わせが発生し、<code>[]</code>が実際の<code>from</code>として保存されます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span>  <span class="n">it</span> <span class="s1">'adds comment'</span> <span class="k">do</span>
    <span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s1">'Hello!'</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="s1">'Hi!'</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">{</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="n">comment</span><span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">to_a</span><span class="p">}</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="o">[</span><span class="n">comment</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div></div>

<h2>
<span id="参考情報" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1"><i class="fa fa-link"></i></a>参考情報</h2>

<p>この問題は前回のQiita記事のテストを書き直している最中に遭遇しました。(原因を特定するまでに結構時間がかかってしまった・・・)</p>

<ul>
<li><a href="http://qiita.com/jnchito/items/7f41ff3df900909952db" id="reference-5ad4c0b7cb17e64253d9">[初心者向け] Railsで関連するデータ(親子関係)を保存する方法あれこれ</a></li>
</ul>

<p>しっかり読めていませんが、たぶん同じようなことを言っている記事がこれです。</p>

<ul>
<li><a href="http://railsadventures.wordpress.com/2012/11/09/activerecord-lazy-scope-evaluation/" rel="nofollow noopener" target="_blank">ActiveRecord Lazy Scope Evaluation</a></li>
</ul>

<p>リレーションに関しては以下の書籍の「056 リレーションを理解する」を読むとわかりやすいです。</p>

<ul>
<li><a href="http://www.amazon.co.jp/gp/product/4797363827?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=4797363827&amp;linkCode=shr&amp;tag=junic05-22&amp;qid=1395368495&amp;sr=8-1&amp;keywords=rails3+%E3%83%AC%E3%82%B7%E3%83%94" rel="nofollow noopener" target="_blank">Rails3レシピブック 190の技</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />25位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>10</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/84faf51430792ec83d20">Herokuで現在実行中のSchedulerを止める方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-07-22 11:23:44</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>タイトルの通りです。<br>
妙なエラーを出し続けているタスクを「今すぐ止めたい！」というときに。</p>

<h2>
<span id="1-スケジューラーのプロセスidを確認する" class="fragment"></span><a href="#1-%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%A9%E3%83%BC%E3%81%AE%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9id%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. スケジューラーのプロセスIDを確認する</h2>

<p>下の例では<code>scheduler.2868</code>が対象のプロセスIDです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ heroku ps --app (your-app-name)
=== scheduler (1X): `bundle exec rake hoge_task`
scheduler.2868: up 2013/07/22 10:40:57 (~ 17m ago)

=== web (1X): `bundle exec rails server thin -p $PORT -e $RACK_ENV`
web.1: up 2013/07/21 15:50:50 (~ 19h ago)
</pre></div></div>

<h2>
<span id="2-プロセスidを指定してスケジューラーを停止させる" class="fragment"></span><a href="#2-%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9id%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%A6%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%A9%E3%83%BC%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>2. プロセスIDを指定して、スケジューラーを停止させる</h2>

<p><code>heroku ps:stop (プロセスID)</code>でプロセスを停止させます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ heroku ps:stop scheduler.2868 --app (your-app-name)
Stopping scheduler.2868 dyno... done
</pre></div></div>

<h2>
<span id="3-プロセスが停止したことを確認する" class="fragment"></span><a href="#3-%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%8C%E5%81%9C%E6%AD%A2%E3%81%97%E3%81%9F%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. プロセスが停止したことを確認する</h2>

<p>念のため、対象のプロセスがなくなっていることを確認しましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ heroku ps --app (your-app-name)
=== web (1X): `bundle exec rails server thin -p $PORT -e $RACK_ENV`
web.1: up 2013/07/21 15:50:50 (~ 19h ago)
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />26位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>9</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/4fa66cb1e56a94701ce2">Herokuにデプロイするとprecompileされたcssがnot foundになる場合</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-01-29 17:02:34</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="現象" class="fragment"></span><a href="#%E7%8F%BE%E8%B1%A1"><i class="fa fa-link"></i></a>現象</h2>

<ul>
<li>HerokuにRails 4アプリをデプロイすると、画面の表示が崩れている。</li>
<li>調べてみるとprecompileされたはずのCSSがNot Foundになっている。</li>
<li>デプロイには成功している。assets precompileも成功している。</li>
<li>うーん、なぜ？？</li>
</ul>

<h2>
<span id="確認ポイント" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>確認ポイント</h2>

<ul>
<li>それってステージング環境じゃないですか？

<ul>
<li>RAILS_ENV=stagingになっていませんか？</li>
</ul>
</li>
<li>rails_12factor gemを使っていませんか？

<ul>
<li>もしかしてこうなっていませんか？</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span>
<span class="k">end</span>
</pre></div></div>

<h2>
<span id="それってこうすると直るかも" class="fragment"></span><a href="#%E3%81%9D%E3%82%8C%E3%81%A3%E3%81%A6%E3%81%93%E3%81%86%E3%81%99%E3%82%8B%E3%81%A8%E7%9B%B4%E3%82%8B%E3%81%8B%E3%82%82"><i class="fa fa-link"></i></a>それってこうすると直るかも</h2>

<p><code>:staging</code>も付けてみて下さい。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Gemfile</span>
<span class="n">group</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:staging</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span>
<span class="k">end</span>
</pre></div></div>

<p>もしかして直りましたか？</p>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<p>ググっても原因がわからずハマっておりました・・・orz<br>
誰かのお役に立てば幸いです。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />27位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>9</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/a8250bff3294bbe43151">&quot;:w&quot;みたいなコロン付きのファイルをgit rmする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-20 08:14:34</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Vimの操作を間違って、<code>:w</code>なんてファイルを作ってしまい、さらにそれを<code>git add</code>してしまいました。<br>
こういうファイルをgitの管理外とするためには</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>git rm --cached '\:w'
</pre></div></div>

<p>と入力します。<br>
で、コロンをうまくエスケープさせようしたときの試行錯誤をシミュレートすると、こんな感じになります。</p>

<div class="code-frame" data-lang="Bash"><div class="highlight"><pre><span></span>$ touch :w
$ ls
:w              Rakefile        config.ru       log             vendor
Gemfile         app             db              public          webrat.log
Gemfile.lock    bin             doc             script
README.markdown config          lib             spec
$ git add .
$ git status
<span class="c1"># On branch master</span>
<span class="c1"># Your branch is ahead of 'origin/master' by 1 commit.</span>
<span class="c1">#</span>
<span class="c1"># Changes to be committed:</span>
<span class="c1">#   (use "git reset HEAD &lt;file&gt;..." to unstage)</span>
<span class="c1">#</span>
<span class="c1">#   new file:   :w</span>
<span class="c1">#</span>
$ git rm --cached :w
fatal: pathspec <span class="s1">'w'</span> did not match any files
$ git rm --cached <span class="se">\:</span>w
fatal: pathspec <span class="s1">'w'</span> did not match any files
$ git rm --cached <span class="s1">':w'</span>
fatal: pathspec <span class="s1">'w'</span> did not match any files
$ git rm --cached <span class="s1">'\:w'</span>
rm <span class="s1">':w'</span>
$ git status
<span class="c1"># On branch master</span>
<span class="c1"># Your branch is ahead of 'origin/master' by 1 commit.</span>
<span class="c1">#</span>
<span class="c1"># Untracked files:</span>
<span class="c1">#   (use "git add &lt;file&gt;..." to include in what will be committed)</span>
<span class="c1">#</span>
<span class="c1">#   :w</span>
nothing added to commit but untracked files present <span class="o">(</span>use <span class="s2">"git add"</span> to track<span class="o">)</span>
$ rm :w
$ git status
<span class="c1"># On branch master</span>
<span class="c1"># Your branch is ahead of 'origin/master' by 1 commit.</span>
<span class="c1">#</span>
nothing to commit <span class="o">(</span>working directory clean<span class="o">)</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />28位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>8</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/bf1d4ba5b1395754709f">【Mac限定】定期的にローカル環境のRailsログファイルを削除する方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-09-15 06:21:59</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="railsのログが肥大化する問題" class="fragment"></span><a href="#rails%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%8C%E8%82%A5%E5%A4%A7%E5%8C%96%E3%81%99%E3%82%8B%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>Railsのログが肥大化する問題</h2>

<p>Railsの開発をしていると、<code>development.log</code>や<code>test.log</code>がどんどん肥大化していきます。</p>

<p>ローカル環境のログであれば、数日前のログが見たいと思うことは滅多にないはずです。<br>
肥大化したログファイルは単なる無駄ですので、定期的にログファイルを消してあげましょう。</p>

<h2>
<span id="定期的にログファイルを削除する方法" class="fragment"></span><a href="#%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%AB%E3%83%AD%E3%82%B0%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>定期的にログファイルを削除する方法</h2>

<p>注) 以下の方法はMac限定です。</p>

<h3>
<span id="1-plistファイルを作成する" class="fragment"></span><a href="#1-plist%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. plistファイルを作成する</h3>

<p><code>~/Library/LaunchAgents/me.rails.clean-log-files.plist</code>というファイルを以下のように作成します。</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
<span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
<span class="nt">&lt;dict&gt;</span>
  <span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;string&gt;</span>me.rails.clean-log-files<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;key&gt;</span>Program<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;string&gt;</span>/bin/bash<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;array&gt;</span>
    <span class="nt">&lt;string&gt;</span>-l<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string&gt;</span>-c<span class="nt">&lt;/string&gt;</span>
    <span class="c">&lt;!-- TODO Replace ~/projects with path to your projects directory --&gt;</span>
    <span class="nt">&lt;string&gt;</span>find ~/projects -wholename '*/log/*.log' -print0 | xargs -0 rm<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;/array&gt;</span>
  <span class="c">&lt;!-- Cleans development log files every day at 5 AM --&gt;</span>
  <span class="nt">&lt;key&gt;</span>StartCalendarInterval<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;dict&gt;</span>
    <span class="nt">&lt;key&gt;</span>Minute<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>0<span class="nt">&lt;/integer&gt;</span>
    <span class="nt">&lt;key&gt;</span>Hour<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>5<span class="nt">&lt;/integer&gt;</span>
  <span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/plist&gt;</span>
</pre></div></div>

<p>ファイル名やLabelは好きな名前を付けて下さい。</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span>  <span class="c">&lt;!-- ~/Library/LaunchAgents/me.rails.clean-log-files.plist --&gt;</span>
  <span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;string&gt;</span>me.rails.clean-log-files<span class="nt">&lt;/string&gt;</span>
</pre></div></div>

<p>対象の親ディレクトリは自分の開発環境に合わせて変更して下さい。</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span>    <span class="c">&lt;!-- TODO Replace ~/projects with path to your projects directory --&gt;</span>
    <span class="nt">&lt;string&gt;</span>find ~/projects -wholename '*/log/*.log' -print0 | xargs -0 rm<span class="nt">&lt;/string&gt;</span>
</pre></div></div>

<p>ジョブを起動する時刻もお好みで変更して下さい。</p>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre><span></span>  <span class="c">&lt;!-- Cleans development log files every day at 5 AM --&gt;</span>
  <span class="nt">&lt;key&gt;</span>StartCalendarInterval<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;dict&gt;</span>
    <span class="nt">&lt;key&gt;</span>Minute<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>0<span class="nt">&lt;/integer&gt;</span>
    <span class="nt">&lt;key&gt;</span>Hour<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>5<span class="nt">&lt;/integer&gt;</span>
  <span class="nt">&lt;/dict&gt;</span>
</pre></div></div>

<h3>
<span id="2-ジョブをmacに登録する" class="fragment"></span><a href="#2-%E3%82%B8%E3%83%A7%E3%83%96%E3%82%92mac%E3%81%AB%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. ジョブをMacに登録する</h3>

<p>以下のコマンドを実行してジョブを登録します。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ launchctl load ~/Library/LaunchAgents/me.rails.clean-log-files.plist
</pre></div></div>

<p>念のため、ジョブが正常に登録されていることを確認します。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ launchctl list <span class="p">|</span> grep me.rails.clean-log-files
-   <span class="m">0</span>   me.rails.clean-log-files
</pre></div></div>

<p>ジョブを停止する場合は<code>unload</code>します。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ launchctl unload ~/Library/LaunchAgents/me.rails.clean-log-files.plist
</pre></div></div>

<h2>
<span id="ジョブの起動時刻にmacを起動していなくてもok" class="fragment"></span><a href="#%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AE%E8%B5%B7%E5%8B%95%E6%99%82%E5%88%BB%E3%81%ABmac%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%8F%E3%81%A6%E3%82%82ok"><i class="fa fa-link"></i></a>ジョブの起動時刻にMacを起動していなくてもOK！</h2>

<p>cronとは異なり、ジョブの起動時刻にMacを起動していなくても大丈夫です。<br>
起動時刻を過ぎていても、Macを立ち上げたタイミングでジョブが起動します。</p>

<p>これで毎日ローカル開発環境のログファイルが削除されます！</p>

<h3>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h3>

<p>この投稿は以下のブログ記事を参考にしています。</p>

<ul>
<li><a href="http://leonid.shevtsov.me/en/clean-your-development-log-files-every-day" rel="nofollow noopener" target="_blank">Clean your development log files every day</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />29位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/0422b5cd6268e050613a">Rails + HAML: 特定の間隔でネストしたタグ構造を作る</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-08-20 14:03:28</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[haml]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="実現したいこと" class="fragment"></span><a href="#%E5%AE%9F%E7%8F%BE%E3%81%97%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>実現したいこと</h2>

<p>Rails + HAMLでこんな構造のタグを作りたい (特定の間隔でネストさせる)</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>山田<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>田中<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>鈴木<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>佐藤<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>高橋<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>山本<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="こうやってもダメ" class="fragment"></span><a href="#%E3%81%93%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E3%82%82%E3%83%80%E3%83%A1"><i class="fa fa-link"></i></a>こうやってもダメ</h2>

<p>直感的にこんなコードを書いてみましたが・・・・</p>

<div class="code-frame" data-lang="haml"><div class="highlight"><pre><span></span><span class="p">-</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
  <span class="p">-</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="nt">%ul</span>
  <span class="nt">%li</span><span class="p">=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
</pre></div></div>

<p>あれっ？ネストしなかった。。。orz</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>山田<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>田中<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>鈴木<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>佐藤<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>高橋<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>山本<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</pre></div></div>

<h2>
<span id="each_sliceメソッドを使えばok" class="fragment"></span><a href="#each_slice%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%BF%E3%81%88%E3%81%B0ok"><i class="fa fa-link"></i></a>each_sliceメソッドを使えばOK</h2>

<p>こんなときはEnumerableモジュールのeach_sliceメソッドを使いましょう。</p>

<div class="code-frame" data-lang="haml"><div class="highlight"><pre><span></span><span class="p">-</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each_slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">users</span><span class="o">|</span>
  <span class="nt">%ul</span>
    <span class="p">-</span> <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="nt">%li</span><span class="p">=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
</pre></div></div>

<p>こうすれば特定の間隔でネストするタグ構造を作れます。<br>
めでたしめでたし。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>山田<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>田中<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>鈴木<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>佐藤<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>高橋<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>山本<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />30位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/e66b3ddf516061fde0c0">Amazon S3に保存されているDBバックアップを練習のためHerokuのステージング環境にリストアする手順</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-03-06 06:44:17</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="目的" class="fragment"></span><a href="#%E7%9B%AE%E7%9A%84"><i class="fa fa-link"></i></a>目的</h2>

<p>万一本番環境でDBのリストアが必要になった場合、素早く、そして間違いなくリストアするため、ステージング環境を使ってAmazon S3からのリストアが問題なく実施できることを定期的に確認する。(リストアテスト)</p>

<h2>
<span id="前提条件" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><i class="fa fa-link"></i></a>前提条件</h2>

<ul>
<li>Herokuのステージング環境にアクセスできる権限があること</li>
<li>保存先のAmazon S3にアクセスできる権限とツールがあること

<ul>
<li>ここではツールとして<a href="http://www.s3fox.net/" rel="nofollow noopener" target="_blank">S3Fox Organizer</a>の利用を前提とする</li>
<li>S3へは"pgbackups"と"heroku_backup_task"でdumpファイルが転送されていることを前提とする (<a href="http://psandvs.com/posts/7" rel="nofollow noopener" target="_blank">参考</a>)</li>
</ul>
</li>
<li>間違って本番環境を壊したりしてしまわないよう、他のメンバーと一緒に作業すること (ペアオペ)</li>
<li>
<code>--remote staging</code>のようなオプションでHerokuのステージング環境を指定できること

<ul>
<li>これは推奨条件なので、<code>--app awesome-app-staging</code>のような指定方法でも可</li>
<li><a href="http://blog.mat-aki.net/heroku-staging-production-command-remote" rel="nofollow noopener" target="_blank">参考: herokuでStagingとProductionの２つを同じレポジトリで管理しているときに便利にherokuコマンドを打つ方法</a></li>
</ul>
</li>
</ul>

<h2>
<span id="本番環境で実施する際の注意点" class="fragment"></span><a href="#%E6%9C%AC%E7%95%AA%E7%92%B0%E5%A2%83%E3%81%A7%E5%AE%9F%E6%96%BD%E3%81%99%E3%82%8B%E9%9A%9B%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>本番環境で実施する際の注意点</h2>

<p>この手順はステージング環境でリストアをするための手順だが、本番環境でもほぼ同じような手順になる。<br>
本番環境で実施する場合は以下の点に注意すること。</p>

<ul>
<li>以下の手順にある<code>--remote staging</code>を<code>--remote production</code>に変更する。</li>
<li>実施前にロストするデータの範囲(時間帯)を確認する

<ul>
<li>ただし、S3ではアップロード日時しか確認できないため、正確な範囲は特定が難しい。</li>
</ul>
</li>
<li>外部に顧客がいる場合は、作業実施前の通知と確認、実施後の通知を行う。

<ul>
<li>実施前の通知内容: 障害の原因、停止時間、ロストするデータの範囲</li>
</ul>
</li>
<li>Herokuのpgbackups内に有効なバックアップデータが残っている場合は、それを利用する。</li>
</ul>

<h2>
<span id="手順" class="fragment"></span><a href="#%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>手順</h2>

<h3>
<span id="1-ステージング環境のバックアップ" class="fragment"></span><a href="#1-%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E7%92%B0%E5%A2%83%E3%81%AE%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97"><i class="fa fa-link"></i></a>1. ステージング環境のバックアップ</h3>

<p>ステージング環境を最後に元の状態に戻すため、ステージング環境のDBをバックアップする。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ heroku pgbackups:capture --expire --remote staging

HEROKU_POSTGRESQL_WHITE_URL (DATABASE_URL)  ----backup---&gt;  b154

Capturing... done
Storing... done
</pre></div></div>

<p>上の出力結果から、バックアップデータのIDは<code>b154</code>、DBの名前(色)は<code>WHITE</code>だとわかる。</p>

<h4>
<span id="備考" class="fragment"></span><a href="#%E5%82%99%E8%80%83"><i class="fa fa-link"></i></a>備考</h4>

<p>aで始まるデータは自動バックアップ、bで始まるデータは手動バックアップによって作成されたデータを表している。</p>

<h3>
<span id="2-s3に保存されているdumpファイルのurlを取得する" class="fragment"></span><a href="#2-s3%E3%81%AB%E4%BF%9D%E5%AD%98%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8Bdump%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AEurl%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. S3に保存されているdumpファイルのURLを取得する</h3>

<p>Amazon S3にアクセスし、復元用のdumpファイルのURLを取得する。<br>
このとき、S3Fox Organizerで対象データを右クリックし、"Get Pre-signed Urls"を選択して、dumpファイルのURLを取得する。</p>

<p>ここでは以下のようなURLを取得できたと仮定する。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>http://awesome-app-backup.s3.amazonaws.com/b322.dump?AWSAccessKeyId=XXXX&amp;Expires=1362516166&amp;Signature=XXXX
</pre></div></div>

<h3>
<span id="3-データをリストアする" class="fragment"></span><a href="#3-%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%83%AA%E3%82%B9%E3%83%88%E3%82%A2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. データをリストアする</h3>

<p>S3のdumpファイルからステージング環境のDBへデータをリストアする。<br>
破壊的な操作になるので、間違いが無いように十分注意すること。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>## メンテナンスモードON
$ heroku maintenance:on --remote staging
Enabling maintenance mode for awesome-app-staging... done

## リストア実行
$ heroku pgbackups:restore HEROKU_POSTGRESQL_WHITE 'http://awesome-app-backup.s3.amazonaws.com/b322.dump?AWSAccessKeyId=XXXX&amp;Expires=1362516166&amp;Signature=XXXX' --remote staging

HEROKU_POSTGRESQL_WHITE_URL (DATABASE_URL)  &lt;---restore---  b322.dump

 !    WARNING: Destructive Action
 !    This command will affect the app: awesome-app-staging
 !    To proceed, type "awesome-app-staging" or re-run this command with --confirm awesome-app-staging

&gt; awesome-app-staging

Retrieving... done
Restoring... done

## 復元されたデータの確認(確認内容は任意)
$ heroku run console --remote staging
Running `console` attached to terminal... up, run.4513
irb(main):001:0* User.count
   (1.5ms)  SELECT COUNT(*) FROM "users" 
=&gt; 1834
irb(main):002:0&gt; exit

## メンテナンスモードOFF
$ heroku maintenance:off --remote staging
Disabling maintenance mode for awesome-app-staging... done
</pre></div></div>

<h3>
<span id="4-アプリケーションの確認" class="fragment"></span><a href="#4-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>4. アプリケーションの確認</h3>

<p>ステージング環境のアプリケーションにアクセスし、dumpファイルのデータがステージング環境に反映されていることを確認する。</p>

<h4>
<span id="備考-1" class="fragment"></span><a href="#%E5%82%99%E8%80%83-1"><i class="fa fa-link"></i></a>備考</h4>

<ul>
<li>carrierwaveで保存された画像データ等はステージング環境のままなので、データの整合性が崩れてシステムエラーや表示崩れなどの原因になる可能性がある。</li>
</ul>

<h3>
<span id="5-ステージング環境を元の状態に戻す" class="fragment"></span><a href="#5-%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E7%92%B0%E5%A2%83%E3%82%92%E5%85%83%E3%81%AE%E7%8A%B6%E6%85%8B%E3%81%AB%E6%88%BB%E3%81%99"><i class="fa fa-link"></i></a>5. ステージング環境を元の状態に戻す</h3>

<p>ステージング環境のバックアップデータをステージング環境のDBにリストアする。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>## メンテナンスモードON
$ heroku maintenance:on --remote staging
Enabling maintenance mode for awesome-app-staging... done

## リストア実行
$ heroku pgbackups:restore HEROKU_POSTGRESQL_WHITE b154 --remote staging


HEROKU_POSTGRESQL_WHITE_URL (DATABASE_URL)  &lt;---restore---  b154
                                                            HEROKU_POSTGRESQL_WHITE_URL (DATABASE_URL)
                                                            2013/03/05 10:05.01
                                                            217.5KB

 !    WARNING: Destructive Action
 !    This command will affect the app: awesome-app-staging
 !    To proceed, type "awesome-app-staging" or re-run this command with --confirm awesome-app-staging

&gt; awesome-app-staging

Retrieving... done
Restoring... done

## 復元されたデータの確認(確認内容は任意)
$ heroku run console --remote staging
Running `console` attached to terminal... up, run.4513
irb(main):001:0* User.count
   (1.5ms)  SELECT COUNT(*) FROM "users" 
=&gt; 16
irb(main):002:0&gt; exit

## メンテナンスモードOFF
$ heroku maintenance:off --remote staging
Disabling maintenance mode for awesome-app-staging... done
</pre></div></div>

<p>ステージング環境のアプリケーションにアクセスし、リストアテスト前の状態になっていればOK。</p>

<p>お疲れ様でした！！</p>

<h2>
<span id="参考資料" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99"><i class="fa fa-link"></i></a>参考資料</h2>

<ul>
<li><a href="https://devcenter.heroku.com/articles/pgbackups" rel="nofollow noopener" target="_blank">PG Backups</a></li>
<li><a href="http://psandvs.com/posts/7" rel="nofollow noopener" target="_blank">Heroku SchedulerでAmazon S3に定期的にDBバックアップ</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />31位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>7</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/cc0ebb21110e159057c4">Rails3.2.9以降ではActiveModelのid項目にオブジェクトを直接設定するとNoMethodErrorになる</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-01-11 16:17:36</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="発生する問題" class="fragment"></span><a href="#%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>発生する問題</h2>

<p>Rails3.2.8までは以下のようなコードが動いていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Rails3.2.8</span>
<span class="n">hoge</span> <span class="o">=</span> <span class="no">Hoge</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">piyo</span><span class="o">.</span><span class="n">hoge_id</span> <span class="o">=</span> <span class="n">hoge</span>

<span class="n">piyo</span><span class="o">.</span><span class="n">hoge_id</span> <span class="c1"># =&gt; 1</span>
</pre></div></div>

<p>Rails3.2.9以降で同じコードを実行すると、<code>NoMethodError</code>が発生します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Rails3.2.9</span>
<span class="n">hoge</span> <span class="o">=</span> <span class="no">Hoge</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">piyo</span><span class="o">.</span><span class="n">hoge_id</span> <span class="o">=</span> <span class="n">hoge</span>
<span class="c1"># NoMethodError: undefined method `to_i' for #&lt;Hoge:0x007f9c4bbafe20&gt;</span>
</pre></div></div>

<p>これはハッシュでbuild/createするような場合も同様です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Rails3.2.9</span>
<span class="n">hoge</span> <span class="o">=</span> <span class="no">Hoge</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">'fuga'</span><span class="p">,</span> <span class="ss">hoge_id</span><span class="p">:</span> <span class="n">hoge</span> <span class="p">}</span>

<span class="n">piyo</span><span class="o">.</span><span class="n">build_fuga</span><span class="p">(</span><span class="n">parmas</span><span class="p">)</span>
<span class="c1"># NoMethodError: undefined method `to_i' for #&lt;Hoge:0x007f9c4bbafe20&gt;</span>
</pre></div></div>

<h2>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h2>

<p>解決策としては<code>hoge_id</code>には<code>hoge</code>オブジェクトではなく、<code>hoge.id</code>のように、明示的にidを渡します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Rails3.2.9</span>
<span class="n">hoge</span> <span class="o">=</span> <span class="no">Hoge</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">piyo</span><span class="o">.</span><span class="n">hoge_id</span> <span class="o">=</span> <span class="n">hoge</span><span class="o">.</span><span class="n">id</span>

<span class="n">piyo</span><span class="o">.</span><span class="n">hoge_id</span> <span class="c1"># =&gt; 1</span>
</pre></div></div>

<h2>
<span id="備考" class="fragment"></span><a href="#%E5%82%99%E8%80%83"><i class="fa fa-link"></i></a>備考</h2>

<p>Rails3.2.8からRails3.2.10 or 3.2.11にバージョンアップした場合でも同じ問題が発生するので、注意してください。</p>

<h2>
<span id="参考サイト" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%82%B5%E3%82%A4%E3%83%88"><i class="fa fa-link"></i></a>参考サイト</h2>

<ul>
<li><a href="http://stackoverflow.com/questions/13348980/activerecord-to-i-method-removed-in-rails-3-2-9" class="autolink" rel="nofollow noopener" target="_blank">http://stackoverflow.com/questions/13348980/activerecord-to-i-method-removed-in-rails-3-2-9</a></li>
<li><a href="https://github.com/rails/rails/commit/96a13fc7" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rails/rails/commit/96a13fc7</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />32位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/5f40d7d22103b66b6fa0">Pow + rbenvでlocalの.ruby-versionが無視される場合</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2013-05-29 07:34:33</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[pow]</b> <b>[rbenv]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="問題" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C"><i class="fa fa-link"></i></a>問題</h2>

<p>Pow + rbenvでRailsを開発している場合、通常Powはプロジェクトのルートディレクトリにある.ruby-versionを参照します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[your-app] cat .ruby-version 
1.9.3-p392
[your-app] rbenv local 1.9.3-p429 
[your-app] cat .ruby-version 
1.9.3-p429
</pre></div></div>

<p>しかしPowを再起動しても、なぜかRailsが以前のバージョンで動きつづけたりする場合があります。</p>

<h2>
<span id="原因" class="fragment"></span><a href="#%E5%8E%9F%E5%9B%A0"><i class="fa fa-link"></i></a>原因</h2>

<p>プロジェクトの上位ディレクトリに別の.ruby-versionがあると、Powがそのバージョンを参照してしまうようです。</p>

<h2>
<span id="解決策" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>解決策</h2>

<p>プロジェクトの上位ディレクトリに一つずつ移動して、.ruby-versionがないか確認します。<br>
上位ディレクトリに不要な.ruby-versionがあった場合は削除します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>[your-app] cd ..
[projects] cat .ruby-version 
1.9.3-p392
[projects] rm .ruby-version
</pre></div></div>

<h3>
<span id="確認時のpowのバージョン" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D%E6%99%82%E3%81%AEpow%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>確認時のPowのバージョン</h3>

<ul>
<li>0.4.0</li>
</ul>

<h3>
<span id="railsで使用中のrubyのバージョンを確認する" class="fragment"></span><a href="#rails%E3%81%A7%E4%BD%BF%E7%94%A8%E4%B8%AD%E3%81%AEruby%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Railsで使用中のRubyのバージョンを確認する</h3>

<p>Railsの内部から使用中のRubyのバージョンを確認する場合は以下の定数が使えます。<br>
怪しい場合はlogger等で確認してみましょう。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">RUBY_VERSION</span> <span class="c1"># =&gt; "1.9.3"</span>
<span class="no">RUBY_PATCHLEVEL</span> <span class="c1"># =&gt; 429</span>
</pre></div></div>

<h3>
<span id="参考にしたwebページ" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9Fweb%E3%83%9A%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>参考にしたWebページ</h3>

<ul>
<li>この現象はPowの<a href="https://github.com/37signals/pow/issues/363" rel="nofollow noopener" target="_blank">Issue</a>に挙げられています。</li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />33位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>6</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/fd6182aeedcd194d3937">historyコマンドで最新の数件だけを取得する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-28 22:36:28</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Linux]</b> <b>[UNIX]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="201285追記" class="fragment"></span><a href="#201285%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>2012.8.5追記</h2>

<p>この内容は<strong>oh-my-zsh</strong>を導入している場合には有効ですが、それ以外では<code>history -20</code>のようなコマンドを使う方がシンプルで簡単です。<br>
<strong>oh-my-zsh</strong>ユーザーの方は<a href="http://qiita.com/items/d01b12be2145fd97b504">こちらの記事</a>も参考にしてみてください。</p>

<hr>

<h2>
<span id="本文" class="fragment"></span><a href="#%E6%9C%AC%E6%96%87"><i class="fa fa-link"></i></a>本文</h2>

<p>普通に<code>history</code>って打つと大量に履歴が表示されるので、直前のコマンドだけに絞り込む方法を探していました。</p>

<p>デフォルト(10行)</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ <span class="nb">history</span> <span class="p">|</span> tail
</pre></div></div>

<p>件数を指定する場合</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ <span class="nb">history</span> <span class="p">|</span> tail -20
</pre></div></div>

<p>やり方を見るととてもあっけないですが、Linux/UNIXに慣れていないと、これが意外と思いつかないんですよね〜。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />34位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/fbbe7e9f77e68b9a11d7">case文では &amp;&amp; を and にそのまま書き換えられない</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-10-17 09:34:21</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>Rubyの論理演算子である <code>&amp;&amp;</code> と <code>and</code> は同じ動作をします。<br>
たとえば、以下のようなメソッドであればどちらも同じ挙動になります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">use_amp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">b</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">use_and</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">use_amp</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">true</span>  <span class="c1"># =&gt; true</span>
<span class="nb">puts</span> <span class="n">use_amp</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span> <span class="c1"># =&gt; false</span>

<span class="nb">puts</span> <span class="n">use_and</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">true</span>  <span class="c1"># =&gt; true</span>
<span class="nb">puts</span> <span class="n">use_and</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span> <span class="c1"># =&gt; false</span>
</pre></div></div>

<p>しかし、挙動は同じでも優先順位が異なる(<code>and</code>の方が低い)ため、常に互換性があるとは限りません。<br>
たとえば、case文の場合は <code>&amp;&amp;</code> を <code>and</code> にそのまま置き換えると構文エラーが発生します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">case_amp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="k">case</span>
  <span class="k">when</span> <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">b</span>
    <span class="mi">1</span>
  <span class="k">else</span>
    <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">case_and</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="c1"># 構文エラーが起きる</span>
  <span class="c1"># syntax error, unexpected keyword_and, expecting keyword_then or ',' or ';' or '\n'</span>
  <span class="c1">#  when a and b</span>
  <span class="c1">#            ^</span>
  <span class="c1"># warning: else without rescue is useless</span>
  <span class="c1"># syntax error, unexpected keyword_end, expecting $end</span>
  <span class="k">case</span>
  <span class="k">when</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span>
    <span class="mi">1</span>
  <span class="k">else</span>
    <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>これを正しく動作させるためには、<code>when (a and b)</code> のように括弧で囲む必要があります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">case_amp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="k">case</span>
  <span class="k">when</span> <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">b</span>
    <span class="mi">1</span>
  <span class="k">else</span>
    <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">case_and</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="k">case</span>
  <span class="k">when</span> <span class="p">(</span><span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="p">)</span>
    <span class="mi">1</span>
  <span class="k">else</span>
    <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">case_amp</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">true</span>  <span class="c1"># =&gt; 1</span>
<span class="nb">puts</span> <span class="n">case_amp</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span> <span class="c1"># =&gt; 0</span>

<span class="nb">puts</span> <span class="n">case_and</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">true</span>  <span class="c1"># =&gt; 1</span>
<span class="nb">puts</span> <span class="n">case_and</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span> <span class="c1"># =&gt; 0</span>
</pre></div></div>

<p>この問題に遭遇した時、しばらくの間「なんで構文エラーになるんだ!?」と頭を抱えてしまったので、Ruby初心者の方はご注意ください。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />35位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/d01b12be2145fd97b504">oh-my-zsh導入後にhistoryが全件表示されるのを解決する方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-08-05 10:33:36</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Zsh]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="問題と解決方法" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E3%81%A8%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>問題と解決方法</h2>

<p><strong>oh-my-zsh</strong>を導入すると、<code>history</code>コマンドを入力した際に、コマンドの全履歴が表示されるようになります。<br>
僕は毎回全件表示されるのはうれしくないので、以下の方法で標準の動きに戻しました。</p>

<div class="code-frame" data-lang="shell">
<div class="code-lang"><span class="bold">~/.zshrc</span></div>
<div class="highlight"><pre><span></span>alias history='fc -l'
</pre></div>
</div>

<p>またこの変更により、世間一般で使われている<code>history</code>コマンドのオプションが普通に使えるようになります。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># 最新の20件を表示</span>
% <span class="nb">history</span> -20
<span class="c1"># 全件を表示</span>
% <span class="nb">history</span> <span class="m">1</span>
</pre></div></div>

<h2>
<span id="原因" class="fragment"></span><a href="#%E5%8E%9F%E5%9B%A0"><i class="fa fa-link"></i></a>原因</h2>

<p>全件が表示されたり、通常のオプションが効かなくなったりしてしまうのは<code>~/.oh-my-zsh/lib/aliases.zsh</code>に以下の設定があるためです。</p>

<div class="code-frame" data-lang="shell">
<div class="code-lang"><span class="bold">~/.oh-my-zsh/lib/aliases.zsh</span></div>
<div class="highlight"><pre><span></span>alias history='fc -l 1'
</pre></div>
</div>

<p>ちなみにGithub上のコードはこちらです。<br>
<a href="https://github.com/robbyrussell/oh-my-zsh/blob/master/lib/aliases.zsh" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/robbyrussell/oh-my-zsh/blob/master/lib/aliases.zsh</a></p>

<h2>
<span id="裏話" class="fragment"></span><a href="#%E8%A3%8F%E8%A9%B1"><i class="fa fa-link"></i></a>裏話</h2>

<p>この問題を解決できたのは<a href="/yaotti" class="user-mention js-hovercard" title="yaotti" data-hovercard-target-type="user" data-hovercard-target-name="yaotti">@yaotti</a>さんの<a href="http://qiita.com/items/fd6182aeedcd194d3937#comment-a94326649bfb405d1bbb">コメント</a>のおかげです。<a href="/yaotti" class="user-mention js-hovercard" title="yaotti" data-hovercard-target-type="user" data-hovercard-target-name="yaotti">@yaotti</a>さん、どうもありがとうございました！！</p>

<p>今回僕はこんな感じで原因を特定していきました。</p>

<ol>
<li>
<code>history</code>コマンドは<code>fc -l</code>と同じはず (<a href="/yaotti" class="user-mention js-hovercard" title="yaotti" data-hovercard-target-type="user" data-hovercard-target-name="yaotti">@yaotti</a>さん情報)</li>
<li>
<code>alias history</code>でエイリアスを確認</li>
<li>
<code>history='fc -l 1'</code>と表示される (つまり全件表示)</li>
<li>おかしい。特に自分でエイリアスを設定した記憶はない。oh-my-zshが原因か？</li>
<li>まず手始めに<code>~/.zshrc</code>を読む</li>
<li>
<code>~/.oh-my-zsh/oh-my-zsh.rc</code>が怪しいので読む</li>
<li>
<code>~/.oh-my-zsh/lib</code>の下で何か色々と設定を読み込んでいる</li>
<li>
<code>grep history ~/.oh-my-zsh/lib/*</code>で検索</li>
<li>
<code>~/.oh-my-zsh/lib/aliases.zsh:alias history='fc -l 1'</code>が表示される。これが原因か！</li>
<li>
<code>~/.zshrc</code>でエイリアスを上書きすることで解決！</li>
</ol>

<p>なかなか苦労しましたが、これでスッキリしました。ついでにLinux/UNIXの勉強にもなりました。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />36位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>5</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/2522d7a091db6a83e8bf">&quot;$(&apos;.dropdown-toggle&apos;).dropdown()&quot;を呼ばなくてもbootstrap-dropdownは正常に動く</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-11 19:05:11</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[bootstrap]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>僕の勘違いでした。<br>
<a href="http://twitter.github.com/bootstrap/javascript.html#dropdowns" rel="nofollow noopener" target="_blank">Bootstrapの解説ページ</a>を読むと、あたかもこのJavaScript↓</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$('.dropdown-toggle').dropdown()
</pre></div></div>

<p>を呼ばないと、ドロップダウンが有効にならないような印象を受けたのですが、この呼び出しは不要です。<br>
解説を良く読むと、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>data-toggle="dropdown"
</pre></div></div>

<p>の属性がタグについていると、自動的にドロップダウンが有効になることがわかりました。</p>

<p>じゃあ、<code>$('.dropdown-toggle').dropdown()</code>はどういう時に使うのかというと、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&lt;a class="dropdown-toggle" data-toggle="dropdown" href="#menu1"&gt;
  Dropdown
  &lt;b class="caret"&gt;&lt;/b&gt;
&lt;/a&gt;
</pre></div></div>

<p>ではなく、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>&lt;a class="dropdown-toggle" href="#menu1"&gt;
  Dropdown
  &lt;b class="caret"&gt;&lt;/b&gt;
&lt;/a&gt;
</pre></div></div>

<p>のように、<code>data-toggle="dropdown"</code>の属性が付いていない場合に、あのJavaScriptを呼ぶことで後からドロップダウンを有効にさせたりすることができます。</p>

<p>まあ今のところドロップダウンは最初から有効にする画面しか作っていないので、JavaScriptの呼び出しは全く不要なわけです。</p>

<p>くそう、だまされた！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />37位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/183c465367225f34fa7e">Fugitive Pluginの:Gbrowseコマンドで使用されるブラウザを設定する</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-29 00:16:43</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> <b>[Git]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>GitコマンドをVim上で操作する際に便利な<strong>Fugitive</strong>というPluginがあります。</p>

<p><a href="https://github.com/tpope/vim-fugitive/" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/tpope/vim-fugitive/</a></p>

<p>この中の<code>:Gbrowse</code>というコマンドを使うと、現在開いているファイルに対応するGithub上のURLをWebブラウザで開いてくれます。</p>

<p>しかし、僕のMacでは<code>:Gbrowse</code>コマンドを使っても何も反応がありませんでした。</p>

<p>いろいろ調べたところ、<code>~/.gitconfig</code>というファイルに設定を追加する必要がありました。<br>
以下は使用するWebブラウザにChromeを指定する場合の設定です。</p>

<div class="code-frame" data-lang="ini">
<div class="code-lang"><span class="bold">~/.gitconfig</span></div>
<div class="highlight"><pre><span></span><span class="k">[web]</span>
    <span class="na">browser</span> <span class="o">=</span> <span class="s">open</span>
<span class="k">[browser "chrome"]</span>
    <span class="na">cmd</span> <span class="o">=</span> <span class="s">open -a 'Google Chrome.app'</span>
</pre></div>
</div>

<p><code>git web--browse</code>というコマンドを使うと、コマンドライン上から設定もできるようですが、ややこしそうなので直接設定ファイルを変更しました。</p>

<p>詳しくはReadmeファイルのFAQ欄を参考にしてみてください。</p>

<p><a href="https://github.com/tpope/vim-fugitive/blob/master/README.markdown" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/tpope/vim-fugitive/blob/master/README.markdown</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />38位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>4</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/3df417988aff0f5af5bd">pow + xip.ioでページが開けない場合</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-18 08:22:08</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[pow]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="症状" class="fragment"></span><a href="#%E7%97%87%E7%8A%B6"><i class="fa fa-link"></i></a>症状</h2>

<p>pow(powder)を使っているRailsアプリケーションで、<a href="http://myapp.dev" class="autolink" rel="nofollow noopener" target="_blank">http://myapp.dev</a> は開くのに、<a href="http://myapp.10.0.0.1.xip.io" class="autolink" rel="nofollow noopener" target="_blank">http://myapp.10.0.0.1.xip.io</a> は「サーバーが見つかりません」になってしまう。<br>
同様にxip.ioのWebサイト( <a href="http://xip.io" class="autolink" rel="nofollow noopener" target="_blank">http://xip.io</a> )も開くことができない。</p>

<h2>
<span id="原因" class="fragment"></span><a href="#%E5%8E%9F%E5%9B%A0"><i class="fa fa-link"></i></a>原因</h2>

<p>DNSの名前解決がうまくいっていない。</p>

<h2>
<span id="対処方法" class="fragment"></span><a href="#%E5%AF%BE%E5%87%A6%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>対処方法</h2>

<p>Google Public DNSを利用してみる。<br>
具体的にはDNSサーバーを 8.8.8.8 もしくは 8.8.4.4 に変更してみる。</p>

<h2>
<span id="参考にしたサイト" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9F%E3%82%B5%E3%82%A4%E3%83%88"><i class="fa fa-link"></i></a>参考にしたサイト</h2>

<p><a href="http://tomozo.hatenablog.com/entry/2012/06/21/124811" class="autolink" rel="nofollow noopener" target="_blank">http://tomozo.hatenablog.com/entry/2012/06/21/124811</a></p>

<p><a href="http://diary.holygrail.dj/entry/2012/06/28/173734" class="autolink" rel="nofollow noopener" target="_blank">http://diary.holygrail.dj/entry/2012/06/28/173734</a></p>

<p><a href="https://developers.google.com/speed/public-dns/docs/using" class="autolink" rel="nofollow noopener" target="_blank">https://developers.google.com/speed/public-dns/docs/using</a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />39位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/a1b466a041accfc9f338">RSpec 3のyield_receiver_to_any_instance_implementation_blocksオプションについて調べてみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2014-03-22 20:24:27</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="rspec-3で追加された不思議なオプション" class="fragment"></span><a href="#rspec-3%E3%81%A7%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F%E4%B8%8D%E6%80%9D%E8%AD%B0%E3%81%AA%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>RSpec 3で追加された不思議なオプション</h2>

<p><a href="http://qiita.com/yujinakayama/items/a1d31b2caa35642e8e69" id="reference-ec9215636f4c303d3b54">こちらのQiita記事</a>を参考にしながら、「<a href="https://leanpub.com/everydayrailsrspec-jp" rel="nofollow noopener" target="_blank">Everyday Rails - RSpecによるRailsテスト入門</a>」サンプルアプリケーションをRSpec 3にアップグレードしていました。</p>

<p><a href="/yujinakayama" class="user-mention js-hovercard" title="yujinakayama" data-hovercard-target-type="user" data-hovercard-target-name="yujinakayama">@yujinakayama</a>さんが作成された<a href="http://yujinakayama.me/transpec/" rel="nofollow noopener" target="_blank">Transpec</a>という便利なgemを使うと、あら不思議、既存のテストコードがRSpec 3対応のものに書き換えられてしまいます。</p>

<p>ただ、diffを確認していたところ、以下の<code>rspec_helper.rb</code>の変更が気になりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># spec_helper.rb</span>
<span class="n">config</span><span class="o">.</span><span class="n">mock_with</span> <span class="ss">:rspec</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="o">.</span><span class="n">yield_receiver_to_any_instance_implementation_blocks</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div>

<p>このオプションは何を意味しているのでしょうか？</p>

<h2>
<span id="開発者ブログになんか書いてある" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E8%80%85%E3%83%96%E3%83%AD%E3%82%B0%E3%81%AB%E3%81%AA%E3%82%93%E3%81%8B%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>開発者ブログになんか書いてある</h2>

<p>このオプションに関する説明はRSpec開発者のmyronmarston氏のブログに書いてありました。</p>

<p><a href="http://myronmars.to/n/dev-blog/2013/07/the-plan-for-rspec-3#mocks__block_implementations_will_yield_the_receiver" rel="nofollow noopener" target="_blank">ブログ原文</a></p>

<p><a href="https://camo.qiitausercontent.com/0ac7ca8546ad4f634fcac29c61cf345928a9af7e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f30323134313964612d383962632d653530312d303631662d6364636233346539386164362e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/0ac7ca8546ad4f634fcac29c61cf345928a9af7e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f30323134313964612d383962632d653530312d303631662d6364636233346539386164362e706e67" alt="Screen Shot 2014-03-22 at 19.49.35.png" title="Screen Shot 2014-03-22 at 19.49.35.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/021419da-89bc-e501-061f-cdcb34e98ad6.png"></a></p>

<p><a href="http://nilp.hatenablog.com/entry/2013/07/16/131641" rel="nofollow noopener" target="_blank">日本語訳</a><br>
<a href="https://camo.qiitausercontent.com/080c5e697584607ff87bf15d6b239a8a0c58c267/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f35343533343563372d323537662d313232352d653763312d6631363866643433306565322e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/080c5e697584607ff87bf15d6b239a8a0c58c267/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f35343533343563372d323537662d313232352d653763312d6631363866643433306565322e706e67" alt="Screen Shot 2014-03-22 at 20.17.37.png" title="Screen Shot 2014-03-22 at 20.17.37.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/545345c7-257f-1225-e7c1-f168fd430ee2.png"></a></p>

<p>が、この説明を読んでも何かピンと来ない・・・。<br>
というわけで、実際にコードを動かしながら確認してみました。</p>

<h2>
<span id="このオプションの目的はブロック引数にインスタンスを渡すかどうかを決めるだけ" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%9B%AE%E7%9A%84%E3%81%AF%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E5%BC%95%E6%95%B0%E3%81%AB%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E6%B8%A1%E3%81%99%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E6%B1%BA%E3%82%81%E3%82%8B%E3%81%A0%E3%81%91"><i class="fa fa-link"></i></a>このオプションの目的はブロック引数にインスタンスを渡すかどうかを決めるだけ</h2>

<p>実際に動かしてみると、なんてことはありません。<br>
このオプションは、<code>any_instance</code>を使っているメソッドでブロックを使ったときに、そのインスタンスをブロック引数として渡すかどうかの違いを決めるためのオプションでした。</p>

<p>上記のブログでも出ている以下のようなコードを例に挙げます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">allow_any_instance_of</span><span class="p">(</span><span class="no">User</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:age</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="p">((</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">birthdate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span>
<span class="k">end</span>
</pre></div></div>

<p><code>yield_receiver_to_any_instance_implementation_blocks</code>に<code>true</code>をセットすると、ブロック引数に<code>user</code>が渡されます。</p>

<p><code>false</code>をセットすると、ブロック引数に何も渡されません。(なので、<code>user.birthdate</code>がエラーで落ちます)</p>

<p>RSpec 2.14ではブロック引数に何も渡さないので、RSpec 3で挙動を合わせる必要があれば<code>false</code>を設定します。<br>
また、RSpec 3ではこのオプションのデフォルト値は<code>true</code>になっているので、何も設定しなければ<code>user</code>が渡されるようになっています。</p>

<h3>
<span id="おまけ-このオプションをfalseにする必要がある場合" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91-%E3%81%93%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92false%E3%81%AB%E3%81%99%E3%82%8B%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8B%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>おまけ: このオプションをfalseにする必要がある場合</h3>

<p><strong>2014.03.23追記</strong></p>

<p><a href="/yujinakayama" class="user-mention js-hovercard" title="yujinakayama" data-hovercard-target-type="user" data-hovercard-target-name="yujinakayama">@yujinakayama</a>さんが「どっちでもいいわけではない」理由をこの投稿のコメントに書いてくれました！<br>
なので、以下の僕の書いた内容は無視して、<a href="/yujinakayama" class="user-mention js-hovercard" title="yujinakayama" data-hovercard-target-type="user" data-hovercard-target-name="yujinakayama">@yujinakayama</a>さんのコメントを参考にしてくださいm(_ _)m</p>

<p>========</p>

<p>個人的な感想を言えば、「別にどっちでもえーやん。ブロック引数を渡したって既存のspecが壊れることは滅多にないでしょうに」と思いました。<br>
なので、このオプションは「常に<code>true</code>」でも実害がないと思うのですが、<code>false</code>にしなければならないケースをムリヤリ考えてみました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># user.saveは常にtrueを返すようにする</span>
<span class="n">f</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="kp">true</span> <span class="p">}</span>
<span class="n">allow_any_instance_of</span><span class="p">(</span><span class="no">User</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:save</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">)</span>
</pre></div></div>

<p><code>false</code>にしなければ落ちてしまうケースは、上のようなテストコードを書いていた場合です。<br>
ブロックにラムダを渡している場合は引数の数が厳密にチェックされるので、ブロック引数が渡されると引数の数が合わないと怒られてエラーになります。</p>

<p>が、おそらくレアケースだと思いますし、最悪エラーが出たらスペックを書き直せばいいと思うのですが、どうなんでしょう？？</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>ブロック引数が渡されるようになった背景は、クラスのインスタンスがないと凝った値を返したりするときに不便、ということみたいです。<br>
確かに、その必要性については僕も十分理解できます。ないより、あった方が絶対便利ですもんね。</p>

<p>というか、<code>any_instance</code>の存在は知っていましたが、ブロックを使えることは知らなかったので、今回の件で「こんなことができるんだ」と勉強になりました。(^^;)</p>

<h3>
<span id="お知らせ" class="fragment"></span><a href="#%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B"><i class="fa fa-link"></i></a>お知らせ</h3>

<ul>
<li>
<a href="https://leanpub.com/everydayrailsrspec-jp" rel="nofollow noopener" target="_blank">Everyday Rails - RSpecによるRailsテスト入門</a>はRSpec 3がリリースされ次第、RSpec 3対応版に無料アップデートされる予定ですので、RSpecの勉強をしたい方は参考にしてみてください。</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/8c5e9c770a53985b8a52589d3f0132c581240011/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f7469746c6570616765732e6c65616e7075622e636f6d2f65766572796461797261696c7372737065632d6a702f6c617267653f31333933353536313831" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/8c5e9c770a53985b8a52589d3f0132c581240011/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f7469746c6570616765732e6c65616e7075622e636f6d2f65766572796461797261696c7372737065632d6a702f6c617267653f31333933353536313831" alt="Everyday Rails - RSpecによるRailsテスト入門" data-canonical-src="https://s3.amazonaws.com/titlepages.leanpub.com/everydayrailsrspec-jp/large?1393556181"></a></p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />40位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/082ace565f2b3b69c260">RSpecでバージョン違いのエラーが出る場合の対処法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-28 22:54:51</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>RSpecって、<code>rspec spec</code>って打てばいいんだよね？<br>
っと思ったらこんなエラーが発生。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>`block in setup': You have already activated rspec-core 2.10.1, but
your Gemfile requires rspec-core 2.8.0. Using bundle exec may solve
this. (Gem::LoadError)
</pre></div></div>

<p>エイリアスで</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">alias</span> <span class="nv">be</span><span class="o">=</span> bundle <span class="nb">exec</span>
</pre></div></div>

<p>と設定しているので、<code>be rspec spec</code>って打てば動くだろうと思ったら、同じエラーが出て動かない。</p>

<p>結局、エイリアスを使わずに</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> rspec spec
</pre></div></div>

<p>って打ったら動いた。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span>$ bundle <span class="nb">exec</span> rspec
</pre></div></div>

<p>でもOK。</p>

<p>しかし、なんでエイリアスを使ったらエラーが出るんだろう？と思ってさらに調べてみた。<br>
なんかエイリアスの設定がおかしかった。。。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">alias</span> <span class="nv">be</span><span class="o">=</span> bundle <span class="nb">exec</span>
</pre></div></div>

<p>じゃなくて</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="nb">alias</span> <span class="nv">be</span><span class="o">=</span><span class="s2">"bundle exec"</span>
</pre></div></div>

<p>とすべきだった。ああ〜。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />41位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/bbb900cdae09df6ace46">MacBook Pro Retinaディスプレイモデル + VirtualBoxにWindows7をインストールする</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-17 07:39:23</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Mac]</b> <b>[VirtualBox]</b> <b>[windows7]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>今まではMacBook + BootcampでWindows7を動かしていましたが、再起動が面倒なので、新しいMacBook Pro Retinaディスプレイモデルには仮想化ソフトを使ってインストールすることにしました。<br>
最初はVMwareを使おうと思ったのですが、どうやらMacには無償版がないようなので、VirtualBoxを使うことにしました。</p>

<h2>
<span id="確認環境" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>確認環境</h2>

<ul>
<li>VirtualBox 4.1.18</li>
<li>Windows7 Home Premium 64bit (DVD)</li>
<li>Mac OS X 10.7.4</li>
<li>MacBook Pro Retinaモデル</li>
</ul>

<h2>
<span id="作業メモ等" class="fragment"></span><a href="#%E4%BD%9C%E6%A5%AD%E3%83%A1%E3%83%A2%E7%AD%89"><i class="fa fa-link"></i></a>作業メモ等</h2>

<h3>
<span id="インストール用dvdのアクセス方法ついて" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E7%94%A8dvd%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E6%96%B9%E6%B3%95%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>インストール用DVDのアクセス方法ついて</h3>

<p>手順は基本的に<a href="http://idita.blog11.fc2.com/blog-entry-147.html" rel="nofollow noopener" target="_blank">こちらのページ</a>を参考にさせてもらいました。</p>

<p>ただし、MBPにはDVDドライブが付属していないので別のMacにてインストール用DVDのisoイメージを作成し、それをMBPにコピーしました。<br>
isoイメージの作成方法は<a href="http://macfan.jp/guide/2009/08/13/windowsiso.html" rel="nofollow noopener" target="_blank">こちらのページ</a>を参考にしてください。</p>

<p>また、isoイメージのサイズは3GBオーバーになり、ネットワーク越しのファイルのコピーに何度も失敗したので、UNIXのsplitコマンドを使ってファイルを256MB程度に分割してから、共有フォルダ経由でMBPにコピーしました。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># コピー元のMac側</span>
$ split -b 256m <span class="o">[</span>isoイメージファイル名<span class="o">]</span>
$ ls
xaa xab xac ...
</pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre><span></span><span class="c1"># MBP側 - /Volumes/Publicをコピー元の共有フォルダとしている場合</span>
$ <span class="nb">cd</span> <span class="o">[</span>コピー先のディレクトリ<span class="o">]</span>
$ cp <span class="k">$(</span>ls /Volumes/Public/x*<span class="k">)</span> .
<span class="c1"># 分割したファイルを結合</span>
$ cat x* &gt; <span class="o">[</span>isoイメージファイル名<span class="o">]</span>
</pre></div></div>

<p>VirtualBoxで「インストールメディアを選択」する場合はこのisoイメージファイルを選択します。</p>

<h3>
<span id="ライセンス認証について" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E8%AA%8D%E8%A8%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>ライセンス認証について</h3>

<p>過去にMacBookにインストールしたDVDを使ったので、ライセンス認証は電話を使った認証を要求されるのかと思いましたが、意外とインターネットを使用した認証だけで終了しました。<br>
ライセンス認証の方法については<a href="http://windows.microsoft.com/ja-JP/windows7/activate-windows-7-on-this-computer" rel="nofollow noopener" target="_blank">こちらのページ</a>を参照してください。</p>

<h3>
<span id="画面表示について" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E8%A1%A8%E7%A4%BA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>画面表示について</h3>

<p>さすがにRetinaに最適化はされていないので、フォント表示等はボンヤリ＆カクカクしていますが、Webページのデザイン崩れを確認する程度ならこれぐらいでも十分かなと思います。</p>

<h3>
<span id="メモリの割当てについて" class="fragment"></span><a href="#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E5%89%B2%E5%BD%93%E3%81%A6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>メモリの割当てについて</h3>

<p>なお、メモリの割当ては最初2GBにしていましたが、起動するだけでがっぽりMac側のメモリを食ってしまうので、1GBに下げました。</p>

<h3>
<span id="ディスクイメージの容量について" class="fragment"></span><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%81%AE%E5%AE%B9%E9%87%8F%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>ディスクイメージの容量について</h3>

<p>可変サイズにしていますが、OSインストール直後でvdiファイルのサイズが9GBちょっとです。<br>
ブラウザしか使わないなら、20GBぐらいで十分かもしれません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />42位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>3</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/a1c1780d9884bcb5f62c">Rails3.1をHerokuにデプロイする際の変更個所</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-12 13:25:47</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Heroku]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>ローカルでは問題なく動いていたRailsアプリがHerokuでなぜか動かない！という時のチェックポイント等。というか作業メモです。</p>

<h3>
<span id="確認環境" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>確認環境</h3>

<ul>
<li>Rails 3.2.6</li>
<li>Heroku Cedar Stack</li>
</ul>

<h2>
<span id="変更点" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E7%82%B9"><i class="fa fa-link"></i></a>変更点</h2>

<div class="code-frame" data-lang="Gemfile"><div class="highlight"><pre><span></span># Production用のgemを追加
group :production do
  gem 'pg'
  gem 'thin'
end
</pre></div></div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/environments/production.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># logの出力先を標準出力に変更(不要？)</span>
<span class="n">config</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
</pre></div>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/application.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1">#以下の行を追加</span>
<span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">initialize_on_precompile</span> <span class="o">=</span> <span class="kp">false</span>
</pre></div>
</div>

<p>このあたりはちょっと僕も何が正解なのか確信がありません。<br>
何か問題が起きたら、Herokuのトラブルシューティングページをしっかり読むことをオススメします。</p>

<p><a href="https://devcenter.heroku.com/articles/rails3x-asset-pipeline-cedar" class="autolink" rel="nofollow noopener" target="_blank">https://devcenter.heroku.com/articles/rails3x-asset-pipeline-cedar</a></p>

<hr>

<h2>
<span id="以下は初回投稿時201284以前に公開していた内容です" class="fragment"></span><a href="#%E4%BB%A5%E4%B8%8B%E3%81%AF%E5%88%9D%E5%9B%9E%E6%8A%95%E7%A8%BF%E6%99%82201284%E4%BB%A5%E5%89%8D%E3%81%AB%E5%85%AC%E9%96%8B%E3%81%97%E3%81%A6%E3%81%84%E3%81%9F%E5%86%85%E5%AE%B9%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>以下は初回投稿時(2012.8.4以前)に公開していた内容です</h2>

<p>ローカルでは問題なく動いていたRailsアプリがHerokuでなぜか動かない！という時のチェックポイント等。というか作業メモです。</p>

<h3>
<span id="確認環境-1" class="fragment"></span><a href="#%E7%A2%BA%E8%AA%8D%E7%92%B0%E5%A2%83-1"><i class="fa fa-link"></i></a>確認環境</h3>

<ul>
<li>Rails 3.1.1</li>
<li>Heroku Cedar Stack</li>
</ul>

<h2>
<span id="変更点-1" class="fragment"></span><a href="#%E5%A4%89%E6%9B%B4%E7%82%B9-1"><i class="fa fa-link"></i></a>変更点</h2>

<div class="code-frame" data-lang="Gemfile"><div class="highlight"><pre><span></span># Production用のgemを追加
group :production do
  gem 'pg'
  gem 'execjs'
  gem 'therubyracer'
end
</pre></div></div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/environments/production.rb</span></div>
<div class="highlight"><pre><span></span><span class="c1"># falseからtrueに変更</span>
<span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># logの出力先を標準出力に変更</span>
<span class="n">config</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
</pre></div>
</div>

<p>以上です。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />43位</center></td>
	<td colspan="3">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>2</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/bf744923ff360d1c4e91">MacVim + vim-ref + Rubyリファレンスで文字化けが発生した場合の対処方法</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2012-07-11 14:29:29</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Vim]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p><a href="http://d.hatena.ne.jp/holypp/20110703/1309711799" rel="nofollow noopener" target="_blank">こちらのサイト</a>を参考にしながらvim-refというプラグインを入れたが、MacVimでRubyリファレンスを開くと文字化けが発生した。<br>
この問題は.vimrcに以下の設定を入れることで解決した。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>let g:ref_refe_encoding = 'euc-jp'
</pre></div></div>

<p>NOTE: 自分のブログ記事からの再掲です。<br>
<a href="http://d.hatena.ne.jp/JunichiIto/20120708/1341745241" class="autolink" rel="nofollow noopener" target="_blank">http://d.hatena.ne.jp/JunichiIto/20120708/1341745241</a></p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
