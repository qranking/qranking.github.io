<html>
	<head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075493-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110075493-1');
</script>
<!-- Google AdSense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6168511236629369",
    enable_page_level_ads: true
  });
</script>

		<meta charset="UTF-8" />
		<title>Qiita Ranking (jnchito)</title>
		<link rel="stylesheet" type="text/css" href="../qranking.css">
	</head>
	<body>
<div class="headerContainer">
<h1>Qiitaいいね数ランキング (jnchito さんの投稿分)</h1>
</div><!--class="headerContainer"-->
<p><a href="#" onclick="javascript:window.history.back(-1);return false;">[戻る]</a></p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>が同じ値の場合は投稿日時の新しいものが上位としています。</p>
<p><i><img width="16" height="16" src="../thumb-up-120px.png" /></i>がついていない記事は表示していません。</p>
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />1位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>186</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/40e0c7d32fde352607be">【初心者向け】「コミットの粒度がわからない問題」の模範解答を考えてみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-25 10:09:08</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[Git]</b> <b>[GitHub]</b> <b>[新人プログラマ応援]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日参加した<a href="https://rails-developers-meetup.connpass.com/event/60765/" rel="nofollow noopener" target="_blank">Rails Developers Meetup</a>の中で、「コミットの粒度がわからない問題」が少し話題になっていました。</p>

<blockquote class="twitter-tweet">
<p>「commitの粒度がわからない」すいません、私もです…！よく迷っちゃいます…！！！ <a href="https://twitter.com/hashtag/railsdm?src=hash" rel="nofollow noopener" target="_blank">#railsdm</a></p>— まえとー (@maetoo11) <a href="https://twitter.com/maetoo11/status/888014333334003712" rel="nofollow noopener" target="_blank">July 20, 2017</a>
</blockquote>



<blockquote class="twitter-tweet">
<p>commitの粒度がわからない問題、ある。（ほんとわからない）  <a href="https://twitter.com/hashtag/railsdm?src=hash" rel="nofollow noopener" target="_blank">#railsdm</a></p>— おおた (@ota42y) <a href="https://twitter.com/ota42y/status/888014298131202049" rel="nofollow noopener" target="_blank">July 20, 2017</a>
</blockquote>



<p>普段僕は感覚的に「それっ、ここでコミット！」とコミットしているんですが、具体的にどういうルールでやってるの？と聞かれると、きれいに明文化しづらいものです。</p>

<p>とはいえ、できるだけ明文化できるよう、模範解答を考えてみました。<br>
この記事ではそんな「適切なコミット粒度」について解説します。</p>

<h3>
<span id="動画で明文化" class="fragment"></span><a href="#%E5%8B%95%E7%94%BB%E3%81%A7%E6%98%8E%E6%96%87%E5%8C%96"><i class="fa fa-link"></i></a>動画で明文化・・・！？</h3>

<p>すいません、「明文化した模範解答」というのは半分ウソです <img alt=":droplet:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f4a7.png" title=":droplet:" width="20"> </p>

<p>なかなかパシッ！とルールを明文化できないので、いったん動画の中でつらつらと「コミットの粒度」について語ってみることにしました。</p>

<p>それがこちらの動画です。</p>

<p><a href="https://www.youtube.com/watch?v=kwdsOz9YF8k&amp;feature=youtu.be" rel="nofollow noopener" target="_blank">【初心者向け】「コミットの粒度がわからない問題」の模範解答を考えてみた - YouTube<img src="https://camo.qiitausercontent.com/18558c66e533214ba4ee789e8353f10ae609c343/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f62386163613961612d333839392d303961632d663566612d6463326238363565613935342e706e67" alt="Screen Shot 2017-09-25 at 10.10.46.png" title="Screen Shot 2017-09-25 at 10.10.46.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/b8aca9aa-3899-09ac-f5fa-dc2b865ea954.png"></a></p>

<p>そしてこの記事では動画の内容をざっくりとピックアップしてみました。</p>

<p>というわけで、動画が本編でこちらの記事はオマケになるので、できるだけ動画の方から先に視聴するようにしてください。</p>

<p>ちなみに動画の長さは35分程度です。<br>
さくっと視聴するために1.5倍速ぐらいで視聴することをオススメします。</p>

<h3>
<span id="議論の前提" class="fragment"></span><a href="#%E8%AD%B0%E8%AB%96%E3%81%AE%E5%89%8D%E6%8F%90"><i class="fa fa-link"></i></a>議論の前提</h3>

<p>「コミットの粒度」という話題は言語やフレームワークを問わずに議論できるはずですが、念のため僕が普段開発している環境をお知らせしておきます。</p>

<ul>
<li>使用する変更管理ツール＝gitとGitHub</li>
<li>使用する言語とフレームワーク＝RubyとRuby on Rails</li>
<li>対象アプリケーション＝仕事で開発するRailsアプリケーション</li>
</ul>

<p>上記の環境に近い人ほど、以下の議論が伝わりやすいかもしれません。</p>

<p>それでは以下が議論の本編（動画の大まかな内容）です。</p>

<h2>
<span id="sonicgardenのメンバーに聞いてみた0200" class="fragment"></span><a href="#sonicgarden%E3%81%AE%E3%83%A1%E3%83%B3%E3%83%90%E3%83%BC%E3%81%AB%E8%81%9E%E3%81%84%E3%81%A6%E3%81%BF%E3%81%9F0200"><i class="fa fa-link"></i></a>SonicGardenのメンバーに聞いてみた（02:00～）</h2>

<p>僕一人の意見に偏るといけないので、僕が勤めている<a href="http://www.sonicgarden.jp/" rel="nofollow noopener" target="_blank">ソニックガーデン</a>のメンバー（全員Railsプログラマ）に「適切なコミット粒度」について質問してみました。</p>

<p>以下はメンバーから出た意見です。</p>

<h3>
<span id="意見1チケット単位または戻したい単位でコミット" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B1%E3%83%81%E3%82%B1%E3%83%83%E3%83%88%E5%8D%98%E4%BD%8D%E3%81%BE%E3%81%9F%E3%81%AF%E6%88%BB%E3%81%97%E3%81%9F%E3%81%84%E5%8D%98%E4%BD%8D%E3%81%A7%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>意見1：チケット単位、または戻したい単位でコミット</h3>

<ul>
<li>機能単位（1タスク、1チケット）で1コミットする</li>
<li>大きなチケットはブランチを分けて、squashを使って1コミットにまとめる</li>
</ul>

<h3>
<span id="意見2コミットはドラクエのセーブと同じ" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B2%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%AF%E3%83%89%E3%83%A9%E3%82%AF%E3%82%A8%E3%81%AE%E3%82%BB%E3%83%BC%E3%83%96%E3%81%A8%E5%90%8C%E3%81%98"><i class="fa fa-link"></i></a>意見2：コミットはドラクエのセーブと同じ</h3>

<ul>
<li>ドラクエ＝ためた経験値を失いたくないと思ったらセーブ</li>
<li>開発＝ここまで書いたコード、ここまで作った機能を失いたくない、と思ったらコミット</li>
</ul>

<h3>
<span id="意見3正常に動く単位にする" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B3%E6%AD%A3%E5%B8%B8%E3%81%AB%E5%8B%95%E3%81%8F%E5%8D%98%E4%BD%8D%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>意見3：正常に動く単位にする</h3>

<ul>
<li>コミットした時点ではプログラムがちゃんと動く、テストコードが全部パスする状態に保つ</li>
<li>ロールバックするケースもあるので、ロールバックしたときにプログラムが壊れている、というのは運用しづらい</li>
</ul>

<h3>
<span id="意見4todoリスト単位でコミットする" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B4todo%E3%83%AA%E3%82%B9%E3%83%88%E5%8D%98%E4%BD%8D%E3%81%A7%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>意見4：TODOリスト単位でコミットする</h3>

<ul>
<li>大きな機能を実装する前はTODOリスト（例：カラムを追加する、計算ロジックを実装する、画面を作成する、etc）を作成する</li>
<li>TODOリストのTODOを1つ終わらせるたびに1コミットする</li>
</ul>

<h3>
<span id="意見5コミットの前に機能ブランチを作る" class="fragment"></span><a href="#%E6%84%8F%E8%A6%8B5%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%AE%E5%89%8D%E3%81%AB%E6%A9%9F%E8%83%BD%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>意見5：コミットの前に機能ブランチを作る</h3>

<ul>
<li>コードの変更管理の単位はコミットだけではない</li>
<li>コミットよりも一段大きな単位として、ブランチとマージ（pull request）という単位もある</li>
<li>大きな機能を実装する場合は、ブランチを切って「機能実装に着手する前にロールバック」できるようにしておくことも大事</li>
</ul>

<h2>
<span id="極端なもしもを考えてみる1050" class="fragment"></span><a href="#%E6%A5%B5%E7%AB%AF%E3%81%AA%E3%82%82%E3%81%97%E3%82%82%E3%82%92%E8%80%83%E3%81%88%E3%81%A6%E3%81%BF%E3%82%8B1050"><i class="fa fa-link"></i></a>極端な「もしも」を考えてみる（10:50～）</h2>

<p>「粒度」というのは簡単にいうと「大きさ」のことです。<br>
適切な大きさを考えるのであれば、「極端に大きい粒度」と「極端に小さい粒度」を想像してみると、両者のデメリットから「適切な粒度」が見えてきます。</p>

<h3>
<span id="極端に大きかったら" class="fragment"></span><a href="#%E6%A5%B5%E7%AB%AF%E3%81%AB%E5%A4%A7%E3%81%8D%E3%81%8B%E3%81%A3%E3%81%9F%E3%82%89"><i class="fa fa-link"></i></a>極端に大きかったら？</h3>

<p>まったくコミットしなかったら？もしくは、リリース直前に1回だけコミットするとしたら？</p>

<ul>
<li>コミットしない＝元に戻れない</li>
<li>「何かあったらここまで戻りたい」「この変更を加えたらプログラムが壊れるかもしれない」と思ったときにコミット</li>
<li>最悪、プログラムが壊れたときにはロールバックできるようにする</li>
</ul>

<h3>
<span id="極端に小さかったら" class="fragment"></span><a href="#%E6%A5%B5%E7%AB%AF%E3%81%AB%E5%B0%8F%E3%81%95%E3%81%8B%E3%81%A3%E3%81%9F%E3%82%89"><i class="fa fa-link"></i></a>極端に小さかったら？</h3>

<p>もし1行毎にコミットしたら？</p>

<ul>
<li>コミットログが大量に増える</li>
<li>コミットメッセージの付け方にも困りそう</li>
<li>コミットのdiffを見たときに、他の行や他のファイルの変更点もある程度見えないと、どういう目的でどういう変更がなされたのか把握しづらい</li>
</ul>

<h3>
<span id="粒度を考えてみるとわかるコミットの役割" class="fragment"></span><a href="#%E7%B2%92%E5%BA%A6%E3%82%92%E8%80%83%E3%81%88%E3%81%A6%E3%81%BF%E3%82%8B%E3%81%A8%E3%82%8F%E3%81%8B%E3%82%8B%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%AE%E5%BD%B9%E5%89%B2"><i class="fa fa-link"></i></a>粒度を考えてみるとわかる、コミットの役割</h3>

<ul>
<li>何か問題が起きたときに「ここへ戻りたい！」というポイントを保存する</li>
<li>コミットはあとから変更内容を振り返るときにも使われる</li>
<li>blameして「この行はどういう目的で書かれたんだろう？」と振り返るときにも使われる</li>
</ul>

<h2>
<span id="その他の流儀1640" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%B5%81%E5%84%801640"><i class="fa fa-link"></i></a>その他の流儀（16:40～）</h2>

<p>僕は必ずしも適用しているわけではありませんが、こういう考え方もあります。</p>

<h3>
<span id="generatorで自動生成したら即コミットする" class="fragment"></span><a href="#generator%E3%81%A7%E8%87%AA%E5%8B%95%E7%94%9F%E6%88%90%E3%81%97%E3%81%9F%E3%82%89%E5%8D%B3%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>generatorで自動生成したら即コミットする</h3>

<ul>
<li>generatorで自動生成したら即コミット、そのあと、手で書き換えたら再度コミット</li>
<li>どれが自動生成されたコードで、どれが人間の手で書いたコードなのかがあとから分かる</li>
<li>ただし、すでに途中まで手で変更を加えている状態で、generatorを使うと結局手で変更したコードが混じってしまう（し、それだとプログラムが壊れた状態でコミットすることにもなりかねない）</li>
</ul>

<h2>
<span id="実際のコミットログを見てみる1920" class="fragment"></span><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AE%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%83%AD%E3%82%B0%E3%82%92%E8%A6%8B%E3%81%A6%E3%81%BF%E3%82%8B1920"><i class="fa fa-link"></i></a>実際のコミットログを見てみる（19:20～）</h2>

<p>最後に、実際のコミットログを見ながら、僕がどんな粒度で、どんな考え方でコミットしているのかを自分で考察してみました。</p>

<p>ここで使ったのは以下のコミットログです。</p>

<p><a href="https://github.com/JunichiIto/train-ticket-rails/commits/master" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/train-ticket-rails/commits/master</a></p>

<ul>
<li>rails newしたあとの初回コミット

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/a5e94d1c9fc9a6bda63558651470e36372ca5f92" rel="nofollow noopener" target="_blank">Initial commit</a></li>
</ul>
</li>
<li>モデルを追加

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/3e172dbd929d9979e9079ac177ded70032a2fd75" rel="nofollow noopener" target="_blank">Add gate model</a></li>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/f8518ead6b906e1691f0d1ad1d580f963539d3bc" rel="nofollow noopener" target="_blank">Add ticket model</a></li>
</ul>
</li>
<li>改札口モデルに降車メソッド（<code>exit?</code>メソッド）の正常系を実装

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/a9df86e3e19d7a57c19350654230f601b302d8b9" rel="nofollow noopener" target="_blank">Implementing exit method</a></li>
</ul>
</li>
<li>降車メソッドの異常系（運賃不足の場合）を実装

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/98ab79dceeb7f1d31a23bddb737ed61000313330" rel="nofollow noopener" target="_blank">Calc fare</a></li>
</ul>
</li>
<li>切符モデルに降車駅を記録するロジックを実装

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/3e12fff283d2215bbe90dccc69ed841a2ff90895" rel="nofollow noopener" target="_blank">Mark exited gate</a></li>
</ul>
</li>
<li>画面（ControllerとView）の作成

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/eee80a375d869271b8bd4f1ccbe7ffcdda121a40" rel="nofollow noopener" target="_blank">Create views</a></li>
</ul>
</li>
<li>画面周り（見た目）の手直し

<ul>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/60513de10916315b99a226f8a60ae06f2b63476f" rel="nofollow noopener" target="_blank">Use bootstrap-sass</a></li>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/79d1c6b0d8904efdf28b7226a537dcccf235bc6a" rel="nofollow noopener" target="_blank">Tweak style</a></li>
<li><a href="https://github.com/JunichiIto/train-ticket-rails/commit/cf721264f93e3e6e7c5de22da96d82ba35f7fd74" rel="nofollow noopener" target="_blank">Tweak UI</a></li>
</ul>
</li>
</ul>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、いろいろ考えてみた結果、以下のようなタイミングでコミットするようにすると、そこそこ「適切な粒度」でコミットできるようになるんじゃないでしょうか？</p>

<ul>
<li>何かあったらここまで戻りたい！という単位でコミット</li>
<li>あとから振り返ったときに「変更の意図や目的」がわかる単位でコミット</li>
<li>正常に動く単位でコミット

<ul>
<li>ロールバックしたらプログラムが壊れた！とならないように</li>
</ul>
</li>
<li>TODOリストのTODOが1つ片付いたらコミット</li>
<li>大きな機能を実装する場合はまず機能ブランチを切って、最後にマージ（pull request）する</li>
<li>場合によっては複数のコミットを1コミットにsquashする

<ul>
<li>Rails本体の開発など</li>
</ul>
</li>
</ul>

<p>こうした内容を参考にしつつ、みなさんの開発の現場でも「適切なコミット粒度」について議論してみてください！</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />2位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>163</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/f182b6f0093a6a3701a1">サンプルコードでわかる！Ruby 2.5の主な新機能と変更点</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-10 08:22:48</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>Rubyは毎年12月25日にアップデートされます。<br>
<s>今年はまだpreview版がリリースされていませんが（2017年10月10日時点）、今年もそろそろリリースの日が近づいてきました。</s><br>
Ruby 2.5については2017年10月10日にpreview1がリリースされました。</p>

<p><a href="https://www.ruby-lang.org/en/news/2017/10/10/ruby-2-5-0-preview1-released/" rel="nofollow noopener" target="_blank">Ruby 2.5.0-preview1 Released</a></p>

<p>そこでこの記事ではこの2.5.0-preview1を参考にして、おそらくこんな感じでリリースされるであろうRuby 2.5の新機能や変更点をまとめてみました。</p>

<h3>
<span id="本記事の情報源" class="fragment"></span><a href="#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AE%E6%83%85%E5%A0%B1%E6%BA%90"><i class="fa fa-link"></i></a>本記事の情報源</h3>

<p>本記事は以下のNEWSページに掲載されている情報から、個人的に注目したい新機能をピックアップしたものです。</p>

<p><a href="https://github.com/ruby/ruby/blob/6c29f232a733228507a39fbc9f30b89ee960b165/NEWS" rel="nofollow noopener" target="_blank">NEWS（commit: 6c29f23）</a></p>

<p>この記事に掲載していない変更点もあるので、詳細はNEWSページをご覧ください。</p>

<p>また、説明している内容に間違いがあれば、コメントや編集リクエスト等で優しく指摘してやってください。<br>
ここで紹介していない新機能に関する編集リクエストも大歓迎です！</p>

<h3>
<span id="動作確認したrubyのバージョン" class="fragment"></span><a href="#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%9Fruby%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>動作確認したRubyのバージョン</h3>

<p>本記事は以下の環境で実行した結果を記載しています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ruby -v
ruby 2.5.0preview1 (2017-10-10 trunk 60153) [x86_64-darwin16]
</pre></div></div>

<h3>
<span id="コード例" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B"><i class="fa fa-link"></i></a>コード例</h3>

<p>本記事のコード例は以下のGitHubリポジトリに置いています。</p>

<p><a href="https://github.com/JunichiIto/ruby-2-5-sandbox" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/ruby-2-5-sandbox</a></p>

<p>それでは以下が本編です！</p>

<h2>
<span id="言語仕様上の変更点" class="fragment"></span><a href="#%E8%A8%80%E8%AA%9E%E4%BB%95%E6%A7%98%E4%B8%8A%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9"><i class="fa fa-link"></i></a>言語仕様上の変更点</h2>

<h3>
<span id="doendブロック内でbeginendなしのrescueelseensureが書けるようになった" class="fragment"></span><a href="#doend%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E5%86%85%E3%81%A7beginend%E3%81%AA%E3%81%97%E3%81%AErescueelseensure%E3%81%8C%E6%9B%B8%E3%81%91%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>do/endブロック内でbegin/endなしのrescue/else/ensureが書けるようになった</h3>

<p>Ruby2.5ではブロック内でbegin/endなしのrescue/else/ensureが書けるようになりました。<br>
これによりネストの深さと行数を節約できます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="k">begin</span>
    <span class="n">n</span> <span class="o">/</span> <span class="mi">0</span>
  <span class="k">rescue</span>
    <span class="c1"># rescue</span>
  <span class="k">else</span>
    <span class="c1"># else</span>
  <span class="k">ensure</span>
    <span class="c1"># ensure</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Ruby 2.5</span>
<span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="n">n</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">rescue</span>
  <span class="c1"># rescue</span>
<span class="k">else</span>
  <span class="c1"># else</span>
<span class="k">ensure</span>
  <span class="c1"># ensure</span>
<span class="k">end</span>
</pre></div></div>

<p>ただし、ブロックを<code>{}</code>で書いた場合は構文エラーになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="n">n</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">rescue</span>
  <span class="c1"># rescue</span>
<span class="k">else</span>
  <span class="c1"># else</span>
<span class="k">ensure</span>
  <span class="c1"># ensure</span>
<span class="p">}</span>
<span class="c1">#=&gt; SyntaxError: (irb):3: syntax error, unexpected keyword_rescue, expecting '}'</span>
<span class="c1">#     rescue</span>
<span class="c1">#     ^~~~~~</span>
</pre></div></div>

<p>do/endと{}で挙動が変わるの？と思ってしまったんですが、むしろ{}を除外することで提案が通ったそうです。</p>

<blockquote class="twitter-tweet">
<p>今までも何回か提案されていたけれど、{…rescue…}の違和感からrejectされ続けてきたモノなので、むしろ{}を除外したというのが今回通ったポイント <a href="https://t.co/eDNlrtlUwE" rel="nofollow noopener" target="_blank">https://t.co/eDNlrtlUwE</a></p>— †ꁐ𐨥ᐠ†-̱̏ (@n0kada) <a href="https://twitter.com/n0kada/status/894714200148262912?ref_src=twsrc%5Etfw" rel="nofollow noopener" target="_blank">August 8, 2017</a>
</blockquote>



<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12906" rel="nofollow noopener" target="_blank">Feature #12906: do/end blocks work with ensure/rescue/else</a>
</li>
</ul>

<h3>
<span id="トップレベルの定数探索のルールが変更された" class="fragment"></span><a href="#%E3%83%88%E3%83%83%E3%83%97%E3%83%AC%E3%83%99%E3%83%AB%E3%81%AE%E5%AE%9A%E6%95%B0%E6%8E%A2%E7%B4%A2%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E5%A4%89%E6%9B%B4%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>トップレベルの定数探索のルールが変更された</h3>

<p>下のような3つのクラスがあったとします。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="k">class</span> <span class="nc">Item</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Staff</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">ItemsController</span><span class="p">;</span> <span class="k">end</span>
</pre></div></div>

<p>さらにこの状態から、次のクラスを参照します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Staff</span><span class="o">::</span><span class="no">ItemsController</span>
</pre></div></div>

<p>ぱっと見、「こんなクラスは定義してないよ！」と思うかもしれませんが、Ruby 2.4では（警告付きで）ItemsControllerを参照したことになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="no">Staff</span><span class="o">::</span><span class="no">ItemsController</span>
<span class="c1">#=&gt; warning: toplevel constant ItemsController referenced by Staff::ItemsController</span>
<span class="c1">#=&gt; ItemsController</span>
</pre></div></div>

<p>なぜなら、トップレベルのクラス定義はObjectクラス以下にクラスが定義され、さらにRubyはStaffクラス、Objectクラスと順に継承関係をさかのぼってItemsControllerが定義されていないか探しに行っていたためです。</p>

<p>しかし、この仕様はプログラマが本来求めているものと異なるクラスが返される恐れがあり、わかりづらい不具合の原因になっていました。<br>
（<a href="https://qiita.com/jnchito/items/79aaca1c51a0ca20ba6e" id="reference-1d908de540387ce9d1bb">こちらの記事</a>で詳しく説明しています。）</p>

<p>そこでRuby 2.5では、継承関係をさかのぼらなくなりました（Staffクラス以下にItemsControllerが定義されていなければエラー）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.5</span>
<span class="no">Staff</span><span class="o">::</span><span class="no">ItemsController</span>
<span class="c1">#=&gt; NameError: uninitialized constant Staff::ItemsController</span>
<span class="c1">#   Did you mean?  ItemsController</span>
</pre></div></div>

<p>ItemsControllerを参照するためには、以下のいずれかの方法をとることになります（この書き方はいずれもRuby 2.4でも有効です）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">ItemsController</span>
<span class="no">Object</span><span class="o">::</span><span class="no">ItemsController</span>
<span class="o">::</span><span class="no">ItemsController</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/11547" rel="nofollow noopener" target="_blank">Feature #11547: remove top-level constant lookup</a>
</li>
</ul>

<h3>
<span id="refinementsでto_sを書き換えたときに文字列の式展開でもrefinements側のto_sが使われるようになった" class="fragment"></span><a href="#refinements%E3%81%A7to_s%E3%82%92%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E5%BC%8F%E5%B1%95%E9%96%8B%E3%81%A7%E3%82%82refinements%E5%81%B4%E3%81%AEto_s%E3%81%8C%E4%BD%BF%E3%82%8F%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>refinementsでto_sを書き換えたときに、文字列の式展開でもrefinements側のto_sが使われるようになった</h3>

<p>次のようなrefinementsを使ったクラス定義があったとします。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">B</span>
  <span class="n">refine</span> <span class="n">A</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">to_s</span>
      <span class="s1">'b'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">C</span>
  <span class="n">using</span> <span class="n">B</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@a</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">c1</span>
    <span class="vi">@a</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">c2</span>
    <span class="s2">"</span><span class="si">#{</span><span class="vi">@a</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>さらにクラスCのc1メソッドとc2メソッドを次のように呼び出します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c1</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c2</span>
</pre></div></div>

<p>明示的に<code>to_s</code>メソッドを呼びだしているc1メソッドはもちろん、式展開で暗黙的に<code>to_s</code>が使われるc2メソッドもどちらも同じ結果になる（module Bのrefinementsが有効になっている）と思いますが、Ruby 2.4ではこのようになっていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c1</span> <span class="c1">#=&gt; "b"</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c2</span> <span class="c1">#=&gt; "#&lt;A:0x00007f870a852d50&gt;"</span>
</pre></div></div>

<p>ごらんのとおり、c2メソッド（式展開を使った場合）はrefinementsが有効になっていません。<br>
ですが、Ruby 2.5ではどちらもrefinementsが有効になりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.5</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c1</span> <span class="c1">#=&gt; "b"</span>
<span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">c2</span> <span class="c1">#=&gt; "b"</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13812" rel="nofollow noopener" target="_blank">Feature #13812: Refinements で定義した to_s を String interpolation が呼んでくれない</a>
</li>
</ul>

<h2>
<span id="標準ライブラリ関連の変更点" class="fragment"></span><a href="#%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E9%80%A3%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9"><i class="fa fa-link"></i></a>標準ライブラリ関連の変更点</h2>

<h3>
<span id="bundlerが標準ライブラリに取り込まれた" class="fragment"></span><a href="#bundler%E3%81%8C%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AB%E5%8F%96%E3%82%8A%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>Bundlerが標準ライブラリに取り込まれた</h3>

<p>Bundlerが標準ライブラリに取り込まれました。<br>
なので、<code>gem install bundler</code>なしでBundlerが使えるようになります。</p>

<p>この記事の執筆時点ではBundler 1.15.4がインストールされるようです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ruby -v
ruby 2.5.0preview1 (2017-10-10 trunk 60153) [x86_64-darwin16]
$ bundler -v
Bundler version 1.15.4
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12733" rel="nofollow noopener" target="_blank">Feature #12733: Bundle bundler to ruby core</a>
</li>
</ul>

<h3>
<span id="erbのローカル変数をhashで渡せる-erbresult_with_hash-メソッド" class="fragment"></span><a href="#erb%E3%81%AE%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E5%A4%89%E6%95%B0%E3%82%92hash%E3%81%A7%E6%B8%A1%E3%81%9B%E3%82%8B-erbresult_with_hash-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>ERBのローカル変数をHashで渡せる ERB#result_with_hash メソッド</h3>

<p>これまでERBでテンプレート内で使われるローカル変数を渡すには、以下のようにbindingを渡したり、あるいは渡す変数を絞るために<a href="https://github.com/search?q=erb+result+openstruct&amp;type=Code&amp;ref=searchresults" rel="nofollow noopener" target="_blank">structを定義する</a>必要がありました。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'erb'</span>
<span class="nb">require</span> <span class="s1">'ostruct'</span>

<span class="n">namespace</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">template</span> <span class="o">=</span> <span class="s1">'Result: &lt;%= a * b %&gt;'</span>
<span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">namespace</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="nb">binding</span> <span class="p">})</span> <span class="c1">#=&gt; "Result: 6"</span>
</pre></div></div>

<p>これが、<code>ERB#result_with_hash</code>の導入により、最低限の変数だけ渡すのが以下のように簡単に書けるようになりました。</p>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'erb'</span>

<span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'Result: &lt;%= a * b %&gt;'</span><span class="p">)</span><span class="o">.</span><span class="n">result_with_hash</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#=&gt; "Result: 6"</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/8631" rel="nofollow noopener" target="_blank">Feature #8631: Add a new method to ERB to allow assigning the local variables from a hash</a>
</li>
</ul>

<h2>
<span id="実験中の変更点" class="fragment"></span><a href="#%E5%AE%9F%E9%A8%93%E4%B8%AD%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9"><i class="fa fa-link"></i></a>実験中の変更点</h2>

<h3>
<span id="バックトレースの表示順が逆になる" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A1%A8%E7%A4%BA%E9%A0%86%E3%81%8C%E9%80%86%E3%81%AB%E3%81%AA%E3%82%8B"><i class="fa fa-link"></i></a>バックトレースの表示順が逆になる？</h3>

<p>これはあくまで「実験段階」の変更点ですが、エラー発生時のバックトレースの出力順が逆になっています。</p>

<p>たとえば次のような例外が発生するスクリプトがあったとします。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">method_1</span>
  <span class="n">method_2</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">method_2</span>
  <span class="c1"># ZeroDivisionErrorを発生させる</span>
  <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">end</span>

<span class="n">method_1</span>
</pre></div></div>

<p>Ruby 2.4までは次のようにバックトレースが出力されていました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ruby ./test/error_example.rb 
./test/error_example.rb:7:in `/': divided by 0 (ZeroDivisionError)
    from ./test/error_example.rb:7:in `method_2'
    from ./test/error_example.rb:2:in `method_1'
    from ./test/error_example.rb:10:in `&lt;main&gt;'
</pre></div></div>

<p>Ruby 2.5ではこれが逆順で表示されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ ruby ./test/error_example.rb 
Traceback (most recent call last):
        3: from ./test/error_example.rb:10:in `&lt;main&gt;'
        2: from ./test/error_example.rb:2:in `method_1'
        1: from ./test/error_example.rb:7:in `method_2'
./test/error_example.rb:7:in `/': divided by 0 (ZeroDivisionError)
</pre></div></div>

<p><a href="https://bugs.ruby-lang.org/issues/8661" rel="nofollow noopener" target="_blank">元のIssue</a>を読むと、「バックトレースが長大になるとき、ターミナル上で上スクロールせずにエラーメッセージが確認できる」「上から下に実行過程が読める」というメリットがある、とのことです。</p>

<p>ただし、今のところ逆順に表示されるのは「組み込み定数である<code>STDERR</code>が変更されておらず、なおかつ、<a href="https://ja.wikipedia.org/wiki/Tty" rel="nofollow noopener" target="_blank">tty</a>（標準入出力となっている端末デバイス）に出力する場合のみ」となっているようです。</p>

<p>そのため、上記の条件に合致しない場合（irbなど）は今までの出力順になっています。</p>

<p>また、例外オブジェクトの<code>backtrace</code>で返される配列もこれまでどおりの順番です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">method_1</span>
  <span class="k">begin</span>
    <span class="n">method_2</span>
  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="c1"># Ruby 2.4も2.5も中身の順序は同じ</span>
    <span class="nb">puts</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>ただし、繰り返しになりますが、これはまだ「実験中」の仕様変更です。<br>
フィードバックを集めてからこの変更を適用するかどうかを決定するとのことです（<a href="https://bugs.ruby-lang.org/issues/8661#note-9" rel="nofollow noopener" target="_blank">参考</a>）。</p>

<p>僕個人の意見としては「今さら導入するにはユーザーへのインパクトが大きそうな割に、そこまで嬉しいメリットもないのでどちらかといえば反対」ですね。</p>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/8661" rel="nofollow noopener" target="_blank">Feature #8661: Add option to print backstrace in reverse order(stack frames first &amp; error last) - CommonRuby - Ruby Issue Tracking System</a>
</li>
</ul>

<h2>
<span id="オブジェクト全般の新機能" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%85%A8%E8%88%AC%E3%81%AE%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>オブジェクト全般の新機能</h2>

<h3>
<span id="ブロックの実行結果がそのまま戻り値になるyield_self" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C%E3%81%8C%E3%81%9D%E3%81%AE%E3%81%BE%E3%81%BE%E6%88%BB%E3%82%8A%E5%80%A4%E3%81%AB%E3%81%AA%E3%82%8Byield_self"><i class="fa fa-link"></i></a>ブロックの実行結果がそのまま戻り値になるyield_self</h3>

<p>Ruby 2.5ではレシーバがブロックの引数になり、ブロックの結果がそのまま戻り値になる<code>yield_self</code>が追加されました。<br>
Kernelモジュールのメソッドなので、すべてのオブジェクト（BasicObjectを除く）で使用できます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># レシーバ（= 2）を受け取り、ブロックの戻り値（= 2 * 10）がメソッド全体の戻り値になる</span>
<span class="mi">2</span><span class="o">.</span><span class="n">yield_self</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">}</span> <span class="c1">#=&gt; 20</span>
</pre></div></div>

<p>以下は配列に含まれる文字列をカンマで連結し、さらにそれを丸括弧で囲むコード例です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="o">[</span><span class="s1">'Alice'</span><span class="p">,</span> <span class="s1">'Bob'</span><span class="o">]</span>
<span class="n">names</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="o">.</span><span class="n">yield_self</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="s2">"(</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">)"</span> <span class="p">}</span> <span class="c1">#=&gt; "(Alice, Bob)"</span>
</pre></div></div>

<p>ちなみに、<code>yield_self</code>についてはこちらの記事でも紹介されています。</p>

<p><a href="https://qiita.com/opt-link/items/8195f3a03859bcb10920" id="reference-6c1609c8344df65a0b9b">Ruby2.5で導入されるyield_selfについて - Qiita</a></p>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/6721" rel="nofollow noopener" target="_blank">Feature #6721: Object#yield_self</a>
</li>
</ul>

<h2>
<span id="文字列正規表現に関する新機能" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>文字列/正規表現に関する新機能</h2>

<h3>
<span id="接頭辞や接尾辞を削除するdelete_prefixdelete_suffix" class="fragment"></span><a href="#%E6%8E%A5%E9%A0%AD%E8%BE%9E%E3%82%84%E6%8E%A5%E5%B0%BE%E8%BE%9E%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8Bdelete_prefixdelete_suffix"><i class="fa fa-link"></i></a>接頭辞や接尾辞を削除するdelete_prefix/delete_suffix</h3>

<p>Ruby 2.5では文字列から接頭辞や接尾辞を削除する<code>delete_prefix</code>と<code>delete_suffix</code>が追加されました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s1">'invisible'</span><span class="o">.</span><span class="n">delete_prefix</span><span class="p">(</span><span class="s1">'in'</span><span class="p">)</span> <span class="c1">#=&gt; "visible"</span>
<span class="s1">'pink'</span><span class="o">.</span><span class="n">delete_prefix</span><span class="p">(</span><span class="s1">'in'</span><span class="p">)</span> <span class="c1">#=&gt; "pink"</span>

<span class="s1">'worked'</span><span class="o">.</span><span class="n">delete_suffix</span><span class="p">(</span><span class="s1">'ed'</span><span class="p">)</span> <span class="c1">#=&gt; "work"</span>
<span class="s1">'medical'</span><span class="o">.</span><span class="n">delete_suffix</span><span class="p">(</span><span class="s1">'ed'</span><span class="p">)</span> <span class="c1">#=&gt; "medical"</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12694" rel="nofollow noopener" target="_blank">Feature #12694: Want a String method to remove heading substr</a>
</li>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13665" rel="nofollow noopener" target="_blank">Feature #13665: String#delete_suffix</a>
</li>
</ul>

<h3>
<span id="casecmpcasecmpに文字列以外の引数を渡したときに例外ではなくnilを返すようになった" class="fragment"></span><a href="#casecmpcasecmp%E3%81%AB%E6%96%87%E5%AD%97%E5%88%97%E4%BB%A5%E5%A4%96%E3%81%AE%E5%BC%95%E6%95%B0%E3%82%92%E6%B8%A1%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E4%BE%8B%E5%A4%96%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Fnil%E3%82%92%E8%BF%94%E3%81%99%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>casecmp/casecmp?に文字列以外の引数を渡したときに例外ではなくnilを返すようになった</h3>

<p>Ruby 2.5では<code>casecmp/casecmp?</code>メソッドに文字列以外の引数（数値など）を渡したときに<code>nil</code>を返すようになりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4</span>
<span class="s1">'abc'</span><span class="o">.</span><span class="n">casecmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#=&gt; TypeError</span>
<span class="s1">'abc'</span><span class="o">.</span><span class="n">casecmp?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#=&gt; TypeError</span>

<span class="c1"># Ruby 2.5</span>
<span class="s1">'abc'</span><span class="o">.</span><span class="n">casecmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#=&gt; nil</span>
<span class="s1">'abc'</span><span class="o">.</span><span class="n">casecmp?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#=&gt; nil</span>
</pre></div></div>

<p>シンボルでは以前から<code>nil</code>を返していたいので、それに挙動を合わせたようです。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># Ruby 2.4, 2.5</span>
<span class="ss">:abc</span><span class="o">.</span><span class="n">casecmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#=&gt; nil</span>
<span class="ss">:abc</span><span class="o">.</span><span class="n">casecmp?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#=&gt; nil</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13312" rel="nofollow noopener" target="_blank">Bug #13312: String#casecmp raises TypeError instead of returning nil</a>
</li>
</ul>

<h3>
<span id="正規表現で非包含オペレータが使えるようになったruby-241以降" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%A7%E9%9D%9E%E5%8C%85%E5%90%AB%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%BF%E3%81%8C%E4%BD%BF%E3%81%88%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9Fruby-241%E4%BB%A5%E9%99%8D"><i class="fa fa-link"></i></a>正規表現で非包含オペレータが使えるようになった（Ruby 2.4.1以降）</h3>

<p>これはRuby 2.5ではなく、Ruby 2.4.1からの新機能ですが、正規表現エンジンが鬼雲6.1.1にアップデートされ、非包含オペレータ（<code>(?~)</code>）が使えるようになりました。</p>

<p>以下は非包含オペレータを使って、DEBUGとINFOを含まない行を抜き出すコード例です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="dl">LOG</span>
<span class="sh">10:00 [INFO] Lorem ipsum dolor sit amet</span>
<span class="sh">10:10 [WARN] Lorem ipsum dolor sit amet</span>
<span class="sh">10:20 [INFO] Lorem ipsum dolor sit amet</span>
<span class="sh">10:25 [DEBUG] Lorem ipsum dolor sit amet</span>
<span class="sh">10:30 [ERROR] Lorem ipsum dolor sit amet</span>
<span class="sh">10:40 [INFO] Lorem ipsum dolor sit amet</span>
<span class="dl">LOG</span>

<span class="nb">puts</span> <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/^(?~DEBUG|INFO)$/</span><span class="p">)</span>
<span class="c1">#=&gt; 10:10 [WARN] Lorem ipsum dolor sit amet</span>
<span class="c1">#   10:30 [ERROR] Lorem ipsum dolor sit amet</span>
</pre></div></div>

<p>非包含オペレータの詳細については以下の記事を参照してください。</p>

<ul>
<li><a href="https://qiita.com/k-takata/items/4e45121081c83d3d5bfd" id="reference-fbed33eb53db80e61d08">鬼雲に非包含オペレータを実装した話 - Qiita</a></li>
<li><a href="https://techracho.bpsinc.jp/hachi8833/2017_03_23/37689" rel="nofollow noopener" target="_blank">Ruby 2.4.1新機能: Onigmo正規表現の非包含演算子(?~ )をチェック</a></li>
</ul>

<h3>
<span id="unicode-10をサポートするようになった" class="fragment"></span><a href="#unicode-10%E3%82%92%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>Unicode 10をサポートするようになった</h3>

<p>Ruby 2.5ではUnicode 10をサポートするようになりました。</p>

<p>これにより、たとえば正規表現で<a href="http://yanok.net/2017/06/unicode-100.html" rel="nofollow noopener" target="_blank">変体仮名</a>を表す<code>In_Kana_Extended_A</code>プロパティ（Unicode 10で追加されたプロパティ）を使えたりするようになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="s2">"A\u{1B10A}B"</span><span class="o">.</span><span class="n">match?</span><span class="p">(</span><span class="sr">/\p{In_Kana_Extended_A}/</span><span class="p">)</span> <span class="c1">#=&gt; true</span>
</pre></div></div>

<p>ちなみに<code>\u{1B10A}</code>というのはこんな文字です。（大半のブラウザでは表示できないはずです）</p>

<p><a href="https://camo.qiitausercontent.com/a1f5825216a0f69aee45e6d401845abbbb48da08/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f64303631636561362d313863622d633335332d366161362d6562393231643066336534332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/a1f5825216a0f69aee45e6d401845abbbb48da08/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f64303631636561362d313863622d633335332d366161362d6562393231643066336534332e706e67" alt="Screen Shot 2017-10-10 at 7.40.58.png" title="Screen Shot 2017-10-10 at 7.40.58.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/d061cea6-18cb-c353-6aa6-eb921d0f3e43.png"></a><br>
<a href="http://www.unicode.org/charts/PDF/Unicode-10.0/U100-1B100.pdf" class="autolink" rel="nofollow noopener" target="_blank">http://www.unicode.org/charts/PDF/Unicode-10.0/U100-1B100.pdf</a></p>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13685" rel="nofollow noopener" target="_blank">Feature #13685: Update Unicode data to Unicode Version 10.0.0</a>
</li>
</ul>

<h2>
<span id="配列に関する新機能" class="fragment"></span><a href="#%E9%85%8D%E5%88%97%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>配列に関する新機能</h2>

<h3>
<span id="unshiftpushのエイリアスメソッドとしてprependappendが追加された" class="fragment"></span><a href="#unshiftpush%E3%81%AE%E3%82%A8%E3%82%A4%E3%83%AA%E3%82%A2%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8%E3%81%97%E3%81%A6prependappend%E3%81%8C%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>unshift/pushのエイリアスメソッドとしてprepend/appendが追加された</h3>

<p>Ruby 2.5では<code>unshift</code>/<code>push</code>のエイリアスメソッドとして<code>prepend</code>/<code>append</code>が追加されました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span>
<span class="n">array</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; [1, 2, 3, 4]</span>
<span class="n">array</span>               <span class="c1">#=&gt; [1, 2, 3, 4]</span>

<span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
<span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1">#=&gt; [1, 2, 3, 4]</span>
<span class="n">array</span>               <span class="c1">#=&gt; [1, 2, 3, 4]</span>
</pre></div></div>

<p>個人的には<code>unshift</code>/<code>push</code>よりも直感的に理解しやすいメソッド名だなと思います <img alt=":smiley:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f603.png" title=":smiley:" width="20"> </p>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12746" rel="nofollow noopener" target="_blank">Feature #12746: class Array: alias .prepend to .unshift ?</a>
</li>
</ul>

<h2>
<span id="ハッシュに関する新機能" class="fragment"></span><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>ハッシュに関する新機能</h2>

<h3>
<span id="キーを特定のルールで変換するtransform_keystransform_keys" class="fragment"></span><a href="#%E3%82%AD%E3%83%BC%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8Btransform_keystransform_keys"><i class="fa fa-link"></i></a>キーを特定のルールで変換するtransform_keys/transform_keys!</h3>

<p>Ruby 2.5ではハッシュのキーを特定のルールで変換する<code>transform_keys</code>が追加されました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="nb">hash</span><span class="o">.</span><span class="n">transform_keys</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">k</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="c1">#=&gt; { 'a' =&gt; 1, 'b' =&gt; 2 }</span>
</pre></div></div>

<p><code>transform_keys!</code>はレシーバのハッシュ自身を変更させます（破壊的メソッド）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="nb">hash</span><span class="o">.</span><span class="n">transform_keys!</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">k</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="c1">#=&gt; { 'a' =&gt; 1, 'b' =&gt; 2 }</span>

<span class="nb">hash</span>
<span class="c1">#=&gt; { 'a' =&gt; 1, 'b' =&gt; 2 }</span>
</pre></div></div>

<p>ちなみにRuby 2.4ではハッシュの値を変換する<code>transform_values</code>メソッドが追加されていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="nb">hash</span><span class="o">.</span><span class="n">transform_values</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">}</span> <span class="c1">#=&gt; {a: 1, b: 4, c: 9}</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13583" rel="nofollow noopener" target="_blank">Feature #13583: Adding `Hash#transform_keys` method</a>
</li>
</ul>

<h3>
<span id="keyerrorにreceiverメソッドとkeyメソッドが追加された" class="fragment"></span><a href="#keyerror%E3%81%ABreceiver%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8key%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8C%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>KeyErrorにreceiverメソッドとkeyメソッドが追加された</h3>

<p>Ruby 2.5では<code>fetch</code>メソッドなどでキーが見つからなかったときに発生するKeyErrorに<code>receiver</code>メソッドと<code>key</code>メソッドが追加されました。</p>

<p><code>receiver</code>はエラーが起きたハッシュ自身を、<code>key</code>は見つからなかったキーを返します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">begin</span>
  <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="ss">foo</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">bar</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
  <span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:bax</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">KeyError</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="n">e</span><span class="o">.</span><span class="n">receiver</span> <span class="c1">#=&gt; {:foo=&gt;1, :bar=&gt;2}</span>
  <span class="n">e</span><span class="o">.</span><span class="n">key</span>      <span class="c1">#=&gt; :bax</span>
<span class="k">end</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/12063" rel="nofollow noopener" target="_blank">Feature #12063: KeyError#receiver and KeyError#name</a>
</li>
</ul>

<h2>
<span id="数値に関する新機能" class="fragment"></span><a href="#%E6%95%B0%E5%80%A4%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>数値に関する新機能</h2>

<h3>
<span id="roundfloorceiltruncateでレシーバをfloatに変換しなくなった" class="fragment"></span><a href="#roundfloorceiltruncate%E3%81%A7%E3%83%AC%E3%82%B7%E3%83%BC%E3%83%90%E3%82%92float%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%97%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>round/floor/ceil/truncateでレシーバをFloatに変換しなくなった</h3>

<p>Ruby 2.4までは<code>round</code>メソッドを使うと、レシーバをFloatに変換してから四捨五入をしていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="mi">2</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; 2.0</span>
</pre></div></div>

<p>そのため、大きな数になると丸め誤差の関係で数学的におかしな結果が返ってきていました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>      <span class="c1">#=&gt; 1.0e+25</span>
<span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span> <span class="c1">#=&gt; 10000000000000000905969664</span>
</pre></div></div>

<p>Ruby 2.5では無理にFloatに変換しないので、数学的に正しい結果が返ります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="mi">2</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>        <span class="c1">#=&gt; 2</span>
<span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; 10000000000000000000000000</span>
</pre></div></div>

<p>これは<code>floor</code>/<code>ceil</code>/<code>truncate</code>についでも同様です。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c1">#=&gt; 10000000000000000000000000</span>
<span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>     <span class="c1">#=&gt; 10000000000000000000000000</span>
<span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; 10000000000000000000000000</span>
</pre></div></div>

<p>参考: <a href="https://bugs.ruby-lang.org/issues/13420" rel="nofollow noopener" target="_blank">Feature #13420: Integer#{round,floor,ceil,truncate} should always return an integer, not a float</a></p>

<h3>
<span id="正しい精度で平方根を返すintegersqrt" class="fragment"></span><a href="#%E6%AD%A3%E3%81%97%E3%81%84%E7%B2%BE%E5%BA%A6%E3%81%A7%E5%B9%B3%E6%96%B9%E6%A0%B9%E3%82%92%E8%BF%94%E3%81%99integersqrt"><i class="fa fa-link"></i></a>正しい精度で平方根を返すInteger.sqrt</h3>

<p><code>round</code>メソッドと同様、<code>Math.sqrt</code>メソッドも引数をFloatとして扱うために、大きな数では精度が狂うケースがありました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">46</span>
<span class="c1"># 数学的には 100000000000000000000000 が正</span>
<span class="no">Math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span> <span class="c1">#=&gt; 99999999999999991611392</span>
</pre></div></div>

<p>このようなケースではRuby 2.5で追加された<code>Integer.sqrt</code>を使うと、正しい値が返ってきます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">46</span>
<span class="nb">Integer</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c1">#=&gt; 100000000000000000000000</span>
</pre></div></div>

<p>なお、平方根の値が小数になる場合は小数点以下が切り捨てられます。<br>
引数が整数以外の数値であれば、最初に整数に変換されてから平方根を計算します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>      <span class="c1">#=&gt; 1.7320508075688772</span>
<span class="nb">Integer</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="c1">#=&gt; 1</span>
<span class="nb">Integer</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">9</span><span class="o">.</span><span class="mi">9</span><span class="p">)</span> <span class="c1">#=&gt; 3</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13219" rel="nofollow noopener" target="_blank">Feature #13219: bug in Math.sqrt(n).to_i, to compute integer squareroot, new word to accurately fix it</a>
</li>
</ul>

<h2>
<span id="日時に関する新機能" class="fragment"></span><a href="#%E6%97%A5%E6%99%82%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>日時に関する新機能</h2>

<h3>
<span id="timeatメソッドでミリ秒ナノ秒を指定できるようになった" class="fragment"></span><a href="#timeat%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A7%E3%83%9F%E3%83%AA%E7%A7%92%E3%83%8A%E3%83%8E%E7%A7%92%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>Time#atメソッドでミリ秒/ナノ秒を指定できるようになった</h3>

<p><code>Time#at</code>メソッドでは第1引数にエポック秒を、第2引数にマイクロ秒を指定することができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">format_time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
  <span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-%d %H:%M:%S.%N'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">format_time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c1">#=&gt; "2017-12-25 00:00:00.000001000"</span>
</pre></div></div>

<p>Ruby 2.5では第3引数を指定することでミリ秒やナノ秒も設定できるようになりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># ミリ秒</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:millisecond</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.001000000"</span>

<span class="c1"># マイクロ秒</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:usec</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.000001000"</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:microsecond</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.000001000"</span>

<span class="c1"># ナノ秒</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:nsec</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.000000001"</span>
<span class="n">format_time</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1514127600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:nanosecond</span><span class="p">)</span>
<span class="c1">#=&gt; "2017-12-25 00:00:00.000000001"</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13919" rel="nofollow noopener" target="_blank">Feature #13919: Add a new method to create Time instances from unix time and nsec</a>
</li>
</ul>

<h2>
<span id="ファイルディレクトリ操作に関する新機能" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E6%93%8D%E4%BD%9C%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>ファイル/ディレクトリ操作に関する新機能</h2>

<h3>
<span id="dirglobメソッドに起点となるディレクトリを指定できるbaseオプションが追加された" class="fragment"></span><a href="#dirglob%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E8%B5%B7%E7%82%B9%E3%81%A8%E3%81%AA%E3%82%8B%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%A7%E3%81%8D%E3%82%8Bbase%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8C%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F"><i class="fa fa-link"></i></a>Dir#globメソッドに起点となるディレクトリを指定できるbaseオプションが追加された</h3>

<p>Ruby 2.5では<code>Dir#glob</code>メソッドに起点となるディレクトリを指定できるbaseオプションが追加されました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="c1"># ./test/dir_aディレクトリを起点とし、".rb"で終わるファイルを探す</span>
<span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'./*.rb'</span><span class="p">,</span> <span class="ss">base</span><span class="p">:</span> <span class="s1">'./test/dir_a'</span><span class="p">)</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13056" rel="nofollow noopener" target="_blank">Feature #13056: base option to Dir.glob</a>
</li>
</ul>

<h3>
<span id="やを返さないdirchildreneach_childメソッド" class="fragment"></span><a href="#%E3%82%84%E3%82%92%E8%BF%94%E3%81%95%E3%81%AA%E3%81%84dirchildreneach_child%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>"."や".."を返さないDir#children/each_childメソッド</h3>

<p>Rubyには指定されたパス内のファイルエントリ名を返す<code>Dir#entries</code>メソッドがあります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Dir</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="s1">'./test/dir_a'</span><span class="p">)</span>
<span class="c1">#=&gt; ['.', '..', 'code_a.rb', 'text_a.txt']</span>
</pre></div></div>

<p>ただし、上の結果を見ると分かるように<code>entries</code>メソッドでは"."や".."もファイルエントリとして返却されます。</p>

<p>Ruby 2.5で追加された<code>Dir#children</code>メソッドを使うと、"."や".."が含まれなくなります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Dir</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="s1">'./test/dir_a'</span><span class="p">)</span>
<span class="c1">#=&gt; ['code_a.rb', 'text_a.txt']</span>
</pre></div></div>

<p><code>Dir#each_child</code>メソッドは配列ではなく、Enumeratorオブジェクトを返します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Dir</span><span class="o">.</span><span class="n">each_child</span><span class="p">(</span><span class="s1">'./test/dir_a'</span><span class="p">)</span>
<span class="c1">#=&gt; #&lt;Enumerator: Dir:each_child(\"./test/dir_a\")&gt;"</span>

<span class="no">Dir</span><span class="o">.</span><span class="n">each_child</span><span class="p">(</span><span class="s1">'./test/dir_a'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1">#=&gt; ['code_a.rb', 'text_a.txt']</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/11302" rel="nofollow noopener" target="_blank">Feature #11302: Dir.entries and Dir.foreach without [".", ".."]</a>
</li>
</ul>

<h2>
<span id="setクラスに関する新機能" class="fragment"></span><a href="#set%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>Setクラスに関する新機能</h2>

<h3>
<span id="to_sがinspectのエイリアスメソッドになった" class="fragment"></span><a href="#to_s%E3%81%8Cinspect%E3%81%AE%E3%82%A8%E3%82%A4%E3%83%AA%E3%82%A2%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>to_sがinspectのエイリアスメソッドになった</h3>

<p>Ruby 2.5ではSetクラスの<code>to_s</code>メソッドが<code>inspect</code>メソッドのエイリアスメソッドになりました。<br>
これにより、要素の情報が表示されるようになります。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'set'</span>

<span class="n">s1</span> <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span>
<span class="n">s1</span> <span class="o">&lt;&lt;</span> <span class="s1">'tic'</span> <span class="o">&lt;&lt;</span> <span class="s1">'tac'</span>

<span class="c1"># Ruby 2.4</span>
<span class="n">s1</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#=&gt; #&lt;Set:0x00007f83b98357e0&gt;</span>

<span class="c1"># Ruby 2.5</span>
<span class="n">s1</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#=&gt; #&lt;Set: {"tic", "tac"}&gt;</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13676" rel="nofollow noopener" target="_blank">Feature #13676: to_s method is not overriden for Set</a>
</li>
</ul>

<h3>
<span id="がincludeのエイリアスメソッドになった" class="fragment"></span><a href="#%E3%81%8Cinclude%E3%81%AE%E3%82%A8%E3%82%A4%E3%83%AA%E3%82%A2%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>===がinclude?のエイリアスメソッドになった</h3>

<p>Ruby 2.5ではSetクラスの<code>===</code>が<code>include?</code>のエイリアスメソッドになりました。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'set'</span>

<span class="no">Set</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; true</span>
<span class="no">Set</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#=&gt; false</span>

<span class="no">Set</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span> <span class="o">===</span> <span class="mi">2</span> <span class="c1">#=&gt; true</span>
<span class="no">Set</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span> <span class="o">===</span> <span class="mi">5</span> <span class="c1">#=&gt; false</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13801" rel="nofollow noopener" target="_blank">Feature #13801: Implement case equality test for Set#===</a>
</li>
</ul>

<h2>
<span id="threadクラスに関する新機能" class="fragment"></span><a href="#thread%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%96%B0%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>Threadクラスに関する新機能</h2>

<h3>
<span id="スレッドに指定したキーのデータが格納されていなければデフォルト値を返すthreadfetchメソッド" class="fragment"></span><a href="#%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%AD%E3%83%BC%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E6%A0%BC%E7%B4%8D%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99threadfetch%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>スレッドに指定したキーのデータが格納されていなければデフォルト値を返すThread#fetchメソッド</h3>

<p>Rubyでは<code>Thread#[]</code>/<code>[]=</code>を使ってスレッド固有のデータを読み書きすることができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'bar'</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="c1">#=&gt; "bar"</span>
</pre></div></div>

<p>Ruby 2.5では<code>Thread#fetch</code>メソッドが追加され、<code>Hash#fetch</code>メソッドと同じように指定されたキーが見つからないときのデフォルト値を指定することができます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'bar'</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">)</span>  <span class="c1">#=&gt; "bar"</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:hoge</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">)</span> <span class="c1">#=&gt; "baz"</span>

<span class="c1"># 第2引数を指定しない場合はキーが見つからないとエラーになる</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span>  <span class="c1">#=&gt; "bar"</span>
<span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:hoge</span><span class="p">)</span> <span class="c1">#=&gt; KeyError: key not found: hoge</span>
</pre></div></div>

<ul>
<li>参考: <a href="https://bugs.ruby-lang.org/issues/13009" rel="nofollow noopener" target="_blank">Feature #13009: Implement fetch for Thread.current</a>
</li>
</ul>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、本記事ではRuby 2.5の新機能や変更点をまとめてみました。</p>

<p>do/endブロックの中にbegin/endなしでrescueが書ける点や、定数探索のルールが変わって予期せぬ不具合が発生しにくくなった点は日常的な開発で嬉しいポイントだと思います。</p>

<p>一方で、バックトレースの並びが逆順になるのは「うーん、ちょっと」という気がしました。<br>
ただ、これはまだ「実験中」の仕様変更ですので、フィードバック次第では従来のままになる可能性もあります。</p>

<p>その他にもいろいろと興味深い新機能が追加されています。<br>
<code>yield_self</code>なんかはこれから面白い使い方を研究していきたくなるメソッドですね。</p>

<p>さあ、みなさんもぜひRuby 2.5の新機能を試してみてください！</p>

<h3>
<span id="あわせて読みたい" class="fragment"></span><a href="#%E3%81%82%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>あわせて読みたい</h3>

<p>Ruby 2.3、2.4の新機能は以下の記事にまとめてあります。<br>
こちらもあわせてどうぞ。</p>

<ul>
<li><a href="https://qiita.com/jnchito/items/0faac073cb77417d61c7" id="reference-76fb074210ec59213c13">サンプルコードでわかる！Ruby 2.3の主な新機能 - Qiita</a></li>
<li><a href="https://qiita.com/jnchito/items/9f9d45581816f121af07" id="reference-eeadd8cfbdf641c745dc">サンプルコードでわかる！Ruby 2.4の新機能と変更点 - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />3位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>162</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/3a8d19fd9a30468cafd4">【翻訳】RSpecのリードメンテナだけど何か質問ある？</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-16 04:54:25</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日、Redditでこんな記事が載っていました。</p>

<p><a href="https://www.reddit.com/r/ruby/comments/73nrhk/ama_the_authors_of_effective_testing_with_rspec_3/" rel="nofollow noopener" target="_blank">AMA: The authors of "Effective Testing with RSpec 3", Myron Marston and Ian Dees : ruby</a></p>

<p>この記事は書籍「<a href="https://pragprog.com/book/rspec3/effective-testing-with-rspec-3" rel="nofollow noopener" target="_blank">Effective Testing with RSpec 3</a>」の筆者であるMyron Marston氏とIan Dees氏が、書籍に関する質問に何でも答えます、という企画です。</p>

<p>この2人のうち、Myron Marston氏はRSpecの開発者（リードメンテナ）です。<br>
Q&amp;Aを読んでいると、RSpecの開発者ならではの意見だなと思うところがたくさんあり、なかなか興味深い議論になっていました。</p>

<p>というわけで、この記事では先ほどのQ&amp;Aから「これは日本のRubyプログラマにも役立ちそう」と思ったやりとりをピックアップして翻訳してみます。</p>

<h3>
<span id="ピックアップしたqaの一覧" class="fragment"></span><a href="#%E3%83%94%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%97%E3%81%9Fqa%E3%81%AE%E4%B8%80%E8%A6%A7"><i class="fa fa-link"></i></a>ピックアップしたQ&amp;Aの一覧</h3>

<p>この記事でピックアップしたのは以下の7つのやりとりです。</p>

<ul>
<li>RSpecの中で必要最小限のDSLをおすすめするなら？</li>
<li>シンプルなスタイルと複雑なスタイル、選ぶならどっち？</li>
<li>RSpecのDSLは全員覚えるべき？</li>
<li>RSpecとMinitestをどう比較する？</li>
<li>追加して後悔している機能は何？</li>
<li>power-assertってどう思う？</li>
<li>RSpecで今後チャレンジしたいことは？</li>
</ul>

<h3>
<span id="備考" class="fragment"></span><a href="#%E5%82%99%E8%80%83"><i class="fa fa-link"></i></a>備考</h3>

<ul>
<li>ここでピックアップしたのはすべてMyron Marston氏による回答です。</li>
<li>Myron Marston氏から翻訳の許可はもらっています。</li>
<li>翻訳で怪しいところがあれば、コメントや編集リクエストでやさしく指摘してやってください。</li>
</ul>

<p>ではここからがQ&amp;Aの翻訳です！</p>

<hr>

<h2>
<span id="q-rspecの中で必要最小限のdslをおすすめするなら" class="fragment"></span><a href="#q-rspec%E3%81%AE%E4%B8%AD%E3%81%A7%E5%BF%85%E8%A6%81%E6%9C%80%E5%B0%8F%E9%99%90%E3%81%AEdsl%E3%82%92%E3%81%8A%E3%81%99%E3%81%99%E3%82%81%E3%81%99%E3%82%8B%E3%81%AA%E3%82%89"><i class="fa fa-link"></i></a>Q. RSpecの中で必要最小限のDSLをおすすめするなら？</h2>

<p>RSpecのDSLには数多くの選択肢があり、そのためにチームメンバーが一貫した構成とスタイルを維持しながらきれいなコードを書くことを困難にしています。<br>
あなたがおすすめする何か必要最小限のDSLはありますか？</p>

<h2>
<span id="a-何はともあれdescribeとit" class="fragment"></span><a href="#a-%E4%BD%95%E3%81%AF%E3%81%A8%E3%82%82%E3%81%82%E3%82%8Cdescribe%E3%81%A8it"><i class="fa fa-link"></i></a>A. 何はともあれ、describeとit</h2>

<p>あなたがRSpecのどんな側面を便利で有用だと思うのかによって答えは変わってきますが、一般論としてはこうなるでしょう。</p>

<ul>
<li><p><code>describe</code>と<code>it</code>。本当に必要なのはこれだけです。それと、失敗を報告するために例外を発生させる<code>example</code>のいくつか。残りのRSpecのAPIは無視できますし、そうしても便利なCLIコマンドを活用することができます。</p></li>
<li><p>私はネストしたコンテキスト（<code>describe</code>と<code>context</code>を使うコード）が、テストを整理するのに便利だと感じています。そして、それをよく使います。</p></li>
<li><p><code>expect</code>とマッチャを組み合わせることでもたらされる、失敗時のメッセージとその柔軟性も便利だと思います。しかし、これは人によって意見が異なるかもしれません。もしシンプルなAPIがお好みなら、設定ファイルに1行加えるだけで（<code>config.expect_with :minitest</code>）Minitestのアサーションを使うことも可能です。</p></li>
<li><p><code>before</code>と<code>let</code>も特定の状況下では便利です。しかし、残念なことに現場では誤用/濫用されるケースもよくあります。十分なメリットがあるときにだけ、<code>before</code>や<code>let</code>を使うというのが私の経験則ですが、それがspecを書くときのデフォルトの方法だとは伝わっていないようです。</p></li>
<li><p>私は<code>subject</code>やワンライナー構文（例: <code>it { is_expected...}</code>）を使うことはほとんどありません。特定の分野のプロジェクト（例：<a href="https://github.com/sinatra/mustermann/blob/v1.0.1/mustermann/spec/sinatra_spec.rb" rel="nofollow noopener" target="_blank">mustermann</a>）ではワンライナー構文はうまく機能しますが、大半のプロジェクトではあまり有益なテクニックではないと考えています。</p></li>
</ul>

<p>というわけで、私からの一般論としてのアドバイスは、あなた自身をあまり制限しようとせずに、まずはシンプルな機能から始めて、十分なメリットがあるときにだけその他の機能を使うようにすることです。</p>

<hr>

<h2>
<span id="q-シンプルなスタイルと複雑なスタイル選ぶならどっち" class="fragment"></span><a href="#q-%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E3%81%A8%E8%A4%87%E9%9B%91%E3%81%AA%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E9%81%B8%E3%81%B6%E3%81%AA%E3%82%89%E3%81%A9%E3%81%A3%E3%81%A1"><i class="fa fa-link"></i></a>Q. シンプルなスタイルと複雑なスタイル、選ぶならどっち？</h2>

<p>最近私はspecを書く2つの異なるアプローチについて考えてきました。<br>
1つは「シンプルな」スタイルです。これはRSpecの最小限の機能を使います。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">FoodFactory</span><span class="p">,</span> <span class="s1">'#make_food'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'makes bananas for monkeys'</span> <span class="k">do</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="no">FoodFactory</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:monkey</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">make_food</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:banana</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'makes hay for horses'</span> <span class="k">do</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="no">FoodFactory</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:horse</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">make_food</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:hay</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>もうひとつは「複雑な」スタイルです。こちらはRSpecの機能をたくさん使います（<code>context</code>、<code>subject</code>、<code>is_expected</code>、等）。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">FoodFactory</span><span class="p">,</span> <span class="s1">'#make_food'</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">factory</span><span class="o">.</span><span class="n">make_food</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:factory</span><span class="p">)</span> <span class="p">{</span> <span class="no">FoodFactory</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="n">animals</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s1">'for monkeys'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:animals</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:monkeys</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">is_expected</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:banana</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'for horses'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:animals</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:horses</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">is_expected</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:hay</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>あなたはどちらかひとつを選びますか？それとも両方をおすすめしますか？その理由は何ですか？</p>

<h2>
<span id="a-絶対にシンプルな方です" class="fragment"></span><a href="#a-%E7%B5%B6%E5%AF%BE%E3%81%AB%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E6%96%B9%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>A. 絶対にシンプルな方です</h2>

<p>私が確実に好きなのは、そして絶対におすすめするのは、あなたが最初に提示したシンプルなスタイルの方です。</p>

<p><code>subject</code>や<code>is_expected</code>といった機能には適切なユースケースがあります。しかし、残念ながらユーザーの中にはそれが「RSpecらしいスタイル」と考えて、すべてのspecをそういう書き方にしようとします。</p>

<p>あなたが書いてくれた複雑なスタイルの方は、RSpecの正しい理解が必要になりますし、制御フローもあっちこっちに飛びます。シンプルなスタイルはコード量も少なく、何よりずっと単純です。</p>

<p>specファイルが大きくなるにつれて、複雑なスタイルはだんだんと付き合っていくのが困難になります。あるexampleとそれが依存するいくつかの宣言文（例：<code>subject</code>や<code>let(:factory)</code>）の距離はどんどん離れていくでしょう。</p>

<p>加えて、ドキュメント文字列を手書きするのではなく、RSpecに出力させている場合は、ドキュメント文字列を使って（<code>--example</code>を使って）exampleをフィルタリングできなくなります。なぜならRSpecはそのexampleを実行するときにドキュメント文字列を生成するからです。なので、実行前にフィルタリングすることはできません。</p>

<p>この点については書籍「<a href="https://pragprog.com/book/rspec3/effective-testing-with-rspec-3" rel="nofollow noopener" target="_blank">Effective Testing with RSpec 3</a>」の中でもいくつかの場所で議論しています。</p>

<hr>

<h2>
<span id="q-rspecのdslは全員覚えるべき" class="fragment"></span><a href="#q-rspec%E3%81%AEdsl%E3%81%AF%E5%85%A8%E5%93%A1%E8%A6%9A%E3%81%88%E3%82%8B%E3%81%B9%E3%81%8D"><i class="fa fa-link"></i></a>Q. RSpecのDSLは全員覚えるべき？</h2>

<p>あなたはRSpecが複雑だと思いますか？そして人々はテストにフォーカスする代わりに、RSpecのDSLを学ぶ必要があると思いますか？</p>

<h2>
<span id="a-必ずしもrspecを選ぶ必要はありません" class="fragment"></span><a href="#a-%E5%BF%85%E3%81%9A%E3%81%97%E3%82%82rspec%E3%82%92%E9%81%B8%E3%81%B6%E5%BF%85%E8%A6%81%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93"><i class="fa fa-link"></i></a>A. 必ずしもRSpecを選ぶ必要はありません</h2>

<p>はい、RSpecは間違いなく複雑です。テストをするためのもっとシンプルな方法は他に存在します。</p>

<p>いいえ、テストをうまくやるためにRSpecを学ぶ必要はありません。Minitestのようなシンプルなテストライブラリを使うことはまったく問題ありません。</p>

<p>RSpecはとても魅力的な機能をたくさん持っていると私は考えています。そうした機能はテストによって開発を加速させたいと考える開発者にとって、たいへん便利なものです。ただし、学習曲線は確実に存在します。</p>

<p>Minitestを使った方がいいケースは確実にあります。たとえば、もし締め切りが厳しく、チームメンバーが他の言語でxUnit系のフレームワークを使い慣れており、RSpecを一度も使ったことがないのであれば、私は絶対そのチームにRSpecよりもMinitestを使うことをおすすめします。</p>

<hr>

<h2>
<span id="q-rspecとminitestをどう比較する" class="fragment"></span><a href="#q-rspec%E3%81%A8minitest%E3%82%92%E3%81%A9%E3%81%86%E6%AF%94%E8%BC%83%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Q. RSpecとMinitestをどう比較する？</h2>

<p>あなたはRSpecとMinitestをどのように比較していますか？</p>

<h2>
<span id="a-どっちも便利哲学が異なるので対立させるべきでない" class="fragment"></span><a href="#a-%E3%81%A9%E3%81%A3%E3%81%A1%E3%82%82%E4%BE%BF%E5%88%A9%E5%93%B2%E5%AD%A6%E3%81%8C%E7%95%B0%E3%81%AA%E3%82%8B%E3%81%AE%E3%81%A7%E5%AF%BE%E7%AB%8B%E3%81%95%E3%81%9B%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%A7%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>A. どっちも便利。哲学が異なるので対立させるべきでない</h2>

<p>どちらもとても便利です。開発の生産性が向上するなら、どちらを使っても構いません。</p>

<p>ですが、2つのライブラリは異なる哲学を持っています。Minitestは「ミニ」であることに焦点を置いており、それはそれで成功しています。小さくてシンプルなテスティングフレームワークになっていることは、本当に素晴らしいことです。フレームワーク本体のコードだって一気に読み上げることができます。</p>

<p>私は過去にMinitestを使ったときにMinitestに不足していてときどき不満に思った機能を、RSpecに実装し、RSpecを便利にしています。</p>

<p>RSpecでは第一級クラスによる抽象化も提供しています。これは複雑さを増す原因になりますが、一方で柔軟性も提供してくれます。</p>

<p>たとえば、<code>example</code>は（単なるメソッドではなく）オブジェクトであり、メタデータを追加できます。そのため、設定ファイルを通じてフィルタリングや挙動の変更を行うことができます。エクスペクテーションは（検証メソッドの代わりに）マッチャオブジェクトを利用します。このオブジェクトはコンポーザブル（組み合わせ可能）です。</p>

<p>ですが私は、Minitestの開発者にはRSpecをMinitestに対立するものとして議論の対象にしてほしくありません。私は2つのフレームワークをRailsとSinatraのようなものだと考えています。RailsとSinatraはどちらも便利ですし、それぞれに有益な利用シーンがあります。この2つを対立するフレームワークと見なす必要はないのです。</p>

<hr>

<h2>
<span id="q-追加して後悔している機能は何" class="fragment"></span><a href="#q-%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%A6%E5%BE%8C%E6%82%94%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%A9%9F%E8%83%BD%E3%81%AF%E4%BD%95"><i class="fa fa-link"></i></a>Q. 追加して後悔している機能は何？</h2>

<p>RSpec 3でなくした機能以外で、追加して後悔している機能は何ですか？また、それはなぜですか？</p>

<h2>
<span id="a-any_instanceワンライナー構文beforeallcontextです" class="fragment"></span><a href="#a-any_instance%E3%83%AF%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%8A%E3%83%BC%E6%A7%8B%E6%96%87beforeallcontext%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>A. any_instance、ワンライナー構文、before(:all/:context)です</h2>

<p>私が考える主な機能は以下のとおりです。</p>

<h3>
<span id="any_instanceを使ったモックとスタブ" class="fragment"></span><a href="#any_instance%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%A2%E3%83%83%E3%82%AF%E3%81%A8%E3%82%B9%E3%82%BF%E3%83%96"><i class="fa fa-link"></i></a><code>any_instance</code>を使ったモックとスタブ</h3>

<p>この機能をサポートするためのコードは極めて複雑で、必ずしもRubyの全機能とうまく協調しません（たとえば、スタブ化されたメソッドがprependされたモジュールの中で定義されている場合はうまく動きません）。</p>

<p>加えて、これを使うとテスト対象のコードが内部でやりとりしている複雑性を隠してしまいますし、RSpecの機能がユーザーに対して設計上の問題点を回避するのを促すことになってしまいます。これを使ってもコードの設計は改善しないのです。</p>

<h3>
<span id="ワンライナー構文例it--is_expectedto-blah--や-it--should-blah-" class="fragment"></span><a href="#%E3%83%AF%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%8A%E3%83%BC%E6%A7%8B%E6%96%87%E4%BE%8Bit--is_expectedto-blah--%E3%82%84-it--should-blah-"><i class="fa fa-link"></i></a>ワンライナー構文（例：<code>it { is_expected.to blah }</code> や <code>it { should blah }</code>）</h3>

<p>この機能は機会と場所を選びます（たとえば、<a href="https://github.com/sinatra/mustermann/blob/v1.0.1/mustermann/spec/sinatra_spec.rb" rel="nofollow noopener" target="_blank">mustermannのspec</a>にはピッタリです）。ですが、この機能はRSpecのユーザーを不幸な方向へ導いてしまいます。</p>

<p>何年にもわたって、私たちは数多くの質問やリクエストを受けています。それらはRSpecのDSLに機能を追加して、ワンライナー構文でもっと複雑なことをできるようにしたい、というものです。ですが、大半のケースでは単に<code>describe</code>と<code>it</code>を使う方がよいと私は考えています。</p>

<p>そして、できれば<code>subject</code>やワンライナー構文のサポートは、恩恵を受けることができる数少ないプロジェクトのために拡張gemにしたいと考えています。</p>

<h3>
<span id="beforeallとbeforecontext" class="fragment"></span><a href="#beforeall%E3%81%A8beforecontext"><i class="fa fa-link"></i></a><code>before(:all)</code>と<code>before(:context)</code>
</h3>

<p>この機能は理論上はすばらしく、とてもシンプルに見えますが、実際には問題を引き起こす原因になりがちです。なぜなら、RSpecとその周辺のエコシステムではexampleごとのライフサイクルを想定しているものが多いからです。</p>

<p>たとえば、exampleごとにDBのトランザクションをラップし（大半のプロジェクトがそうしているでしょう）、<code>before(:cotext)</code>フックを使ってDBレコードをいくつか作成すると、トランザクションの外部でレコードを作ったことになり、データが残ってしまって他のexampleが失敗する原因になります。</p>

<p>もし実行速度が気になっていて、一度の実行で一気にたくさんのアサーションを実行したいと考えているのであれば、<code>aggregate_failures</code>を使う方がいいでしょう。</p>

<hr>

<h2>
<span id="q-power-assertってどう思う" class="fragment"></span><a href="#q-power-assert%E3%81%A3%E3%81%A6%E3%81%A9%E3%81%86%E6%80%9D%E3%81%86"><i class="fa fa-link"></i></a>Q. power-assertってどう思う？</h2>

<p>power-assertについてはどう考えていますか？</p>

<h2>
<span id="a-便利そうelixirのexunitはとても良かった" class="fragment"></span><a href="#a-%E4%BE%BF%E5%88%A9%E3%81%9D%E3%81%86elixir%E3%81%AEexunit%E3%81%AF%E3%81%A8%E3%81%A6%E3%82%82%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>A. 便利そう。ElixirのExUnitはとても良かった</h2>

<p>あなたが言っているのは<a href="https://github.com/k-tsj/power_assert" rel="nofollow noopener" target="_blank">このライブラリ</a>（訳注：<a href="https://github.com/k-tsj/power_assert" rel="nofollow noopener" target="_blank">https://github.com/k-tsj/power_assert</a>）ですか？<br>
使ったことはありませんが、便利そうですね。</p>

<p>私は最近ちょっとだけElixirを使ったんですが、ExUnitは同じようなアプローチをとっていました。<br>
<code>assert</code>はマクロになっていて、渡された式のAST(抽象構文木)を受け取ります。さらにそれを分割し、異なる部分を評価し、とても役立つ失敗メッセージを提供します。個別の検証メソッドやマッチャは必要ありません。<br>
あれはとても良かったですね。</p>

<p>検証APIが小さくなればなるほど、人々はテストを簡単に始めることができます。<br>
これはとても素晴らしいことです。</p>

<hr>

<h2>
<span id="q-rspecで今後チャレンジしたいことは" class="fragment"></span><a href="#q-rspec%E3%81%A7%E4%BB%8A%E5%BE%8C%E3%83%81%E3%83%A3%E3%83%AC%E3%83%B3%E3%82%B8%E3%81%97%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Q. RSpecで今後チャレンジしたいことは？</h2>

<p>RSpecで今後やってみたい大きなチャレンジは何かありますか？</p>

<h2>
<span id="a-やれることはやりきったapiの大きな変更もないだろう" class="fragment"></span><a href="#a-%E3%82%84%E3%82%8C%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%82%84%E3%82%8A%E3%81%8D%E3%81%A3%E3%81%9Fapi%E3%81%AE%E5%A4%A7%E3%81%8D%E3%81%AA%E5%A4%89%E6%9B%B4%E3%82%82%E3%81%AA%E3%81%84%E3%81%A0%E3%82%8D%E3%81%86"><i class="fa fa-link"></i></a>A. やれることはやりきった。APIの大きな変更もないだろう</h2>

<p>私が考えている大きなチャレンジというのは特にありません。その理由の一つは、私がRSpecのことをほとんど「やりきった」と考えているからです。</p>

<p>RSpecは引き続きサポートされ、改善されますが、APIの大きな変更はもうないと思います。<br>
RSpecの機能はすでに十分豊富です。<br>
正直なところ、次のメジャーリリースで魅力的かつ大きな新機能を提供するのは難しいだろうと考えています。</p>

<p>(翻訳ここまで)</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、この記事ではRedditに載っていたRSpecに関するQ&amp;A企画を翻訳してみました。</p>

<p>Myron Marston氏が<code>subject</code>やワンライナー構文の追加を後悔していたり、これ以上のAPIの大きな変更は考えていなかったりする点が個人的にはすごく興味深かったです。</p>

<p>こうした筆者の考えやアドバイスはみなさんがRSpecを書くときに役立つ物も多いと思うので、ぜひ参考にしてみてください。</p>

<h3>
<span id="あわせて読みたい" class="fragment"></span><a href="#%E3%81%82%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>あわせて読みたい</h3>

<p><a href="http://blog.jnito.com/entry/2017/09/11/051550" rel="nofollow noopener" target="_blank">【書評】RSpecの初心者から上級者まで役立つ！「Effective Testing with RSpec 3」を読みました - give IT a try</a></p>

<p>このQ&amp;A企画の元になっている書籍「Effective Testing with RSpec 3」を読んだ感想をまとめています。<br>
今年出版されたばかりの洋書ですが、RSpecを書くときに参考になる考え方がたくさん載っていました。</p>

<p><a href="https://qiita.com/jnchito/items/91779b55cae0f4915da5" id="reference-047f8f530fb13572c55f">【アンチパターン】Arrange、Act、Assert（AAA）を意識できていないRSpecのコード例とその対処法 - Qiita</a></p>

<p>Q&amp;Aの中でMyron Marston氏も「ワンライナー構文は濫用すべきでない」と語っていましたが、この点は僕も同意見です。<br>
このQiita記事の中では僕も同じようなことを書いています。</p>

<p><a href="https://qiita.com/jnchito/items/a90b3b09d008227d3d60" id="reference-5e4bdafaa2779b84063e">サヨナラBetter Specs!? 雑で気楽なRSpecのススメ - Qiita</a></p>

<p>複雑なスタイルよりもシンプルなスタイルの方が良い、というのもやはり同意見です。<br>
僕も最近は複雑なスタイルを避けるようにしています。<br>
このQiita記事では具体的なコード例を挙げて、複雑なスタイルとシンプルなスタイル（雑なスタイル）をメリット・デメリット比較しています。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />4位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>105</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/c7e6e7abf83598a6516d">rspec-rails 3.7の新機能！System Specを使ってみた</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-10-24 07:35:35</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[RSpec]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日、RSpec 3.7がリリースされました。</p>

<p>参考: <a href="http://rspec.info/blog/2017/10/rspec-3-7-has-been-released/" rel="nofollow noopener" target="_blank">RSpec 3.7 has been released!</a></p>

<p>上記ブログの中で「今回のリリースはRailsのSystem Testの統合機能をいち早く使ってもらうためのリリースだ」と書いてあります。<br>
実際、ブログの中で触れられている新機能は「System Spec」機能の追加だけです。</p>

<p>というわけで、この記事はrspec-rails 3.7で導入されたSystem Specの紹介と使い方の説明をしていきます。</p>

<h3>
<span id="実行環境" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>実行環境</h3>

<p>この記事は以下のバージョンを対象にして書かれています。</p>

<ul>
<li>rspec-rails 3.7.1</li>
<li>Rails 5.1.4</li>
<li>Ruby 2.4.2</li>
<li>selenium-webdriver 3.6.0</li>
<li>Capybara 2.15.4</li>
<li>Chrome 62</li>
<li>ChromeDriver 2.33</li>
</ul>

<h3>
<span id="サンプルコード" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>サンプルコード</h3>

<p>この記事で使用したコードはこちらに置いてあります。</p>

<p><a href="https://github.com/JunichiIto/rails-5-1-system-test-sandbox/tree/rspec-3-7" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/rails-5-1-system-test-sandbox/tree/rspec-3-7</a></p>

<h2>
<span id="system-specとは" class="fragment"></span><a href="#system-spec%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>System Specとは？</h2>

<p>Rails 5.1ではSystemTestCaseという新機能が導入されました。<br>
これはいわゆるエンドツーエンド（E2E）テストを実行するための新機能です。<br>
このテストケースクラスを使うと、JavaScriptを利用する画面のテストが書けるようになります。</p>

<p>参考: <a href="https://qiita.com/jnchito/items/4d01f2faa1deee36bd27" id="reference-e56e98360302faf34e5d">Rails 5.1のSystemTestCaseを試してみた - Qiita</a></p>

<p>RailsではMinitestがデフォルトのテスティングフレームワークであるため、SystemTestCaseでもMinitestを使います。</p>

<p>rspec-rails 3.7で導入されたSystem Specは、このSystemTestCaseをRSpecから利用するための新機能です。</p>

<h2>
<span id="feature-specと何が違うのどっちを使えばいいの" class="fragment"></span><a href="#feature-spec%E3%81%A8%E4%BD%95%E3%81%8C%E9%81%95%E3%81%86%E3%81%AE%E3%81%A9%E3%81%A3%E3%81%A1%E3%82%92%E4%BD%BF%E3%81%88%E3%81%B0%E3%81%84%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>Feature Specと何が違うの？どっちを使えばいいの？</h2>

<p>rspec-railsではすでにFeature Spec（フィーチャスペック）というE2Eテスト用の機能が用意されています。<br>
System SpecもE2Eテスト用の機能なので、単純に考えるとE2Eテスト用の機能が複数存在することになります。</p>

<p>実際、この両者はよく似ているのですが、System SpecはRails標準のSystemTestCaseをラップしているため、以下のような違いがあります。</p>

<ul>
<li>デフォルトでselnium-webdriver + Chrome上でテストが実行される。</li>
<li>DatabaseCleanerやDatabaseRewinderを使ってトランザクション管理をする必要がない。</li>
<li>テストが失敗すると自動的にtmp/screenshotsディレクトリにスクリーンショットを保存してくれる。</li>
</ul>

<p>まだ本格的には使い込んでいませんが、ざっと見た感じでは「もうFeature SpecやDatabaseCleanerはいらなくなるのでは？」と思っています。</p>

<p>冒頭で紹介した<a href="http://rspec.info/blog/2017/10/rspec-3-7-has-been-released/" rel="nofollow noopener" target="_blank">公式ブログ</a>でも「Rails 5.1を使っている場合はFeature SpecよりもSystem Specの使用を推奨します」と書いてあります。</p>

<h2>
<span id="system-specを使ってみる" class="fragment"></span><a href="#system-spec%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>System Specを使ってみる</h2>

<p>ではここから、System Specを実際に使う方法を説明していきます。</p>

<h3>
<span id="使用するサンプルアプリケーション" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>使用するサンプルアプリケーション</h3>

<p>今回は以下のようなサンプルアプリケーションでSystem Specを実行してみます。<br>
このアプリケーションでは郵便番号を入力すると、JavaScriptによって自動的に住所が入力されるようになっています。</p>

<p><a href="https://camo.qiitausercontent.com/d81b8cc520a87c17fa8d0e01f417ac401c9ba6f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f34313632346631312d316234642d376636322d396433662d3437626265363365636162342e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/d81b8cc520a87c17fa8d0e01f417ac401c9ba6f8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f34313632346631312d316234642d376636322d396433662d3437626265363365636162342e676966" alt="y9W2aFx3zv.gif" title="y9W2aFx3zv.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/41624f11-1b4d-7f62-9d3f-47bbe63ecab4.gif"></a></p>

<p>コードはGitHubに置いてあります。</p>

<p><a href="https://github.com/JunichiIto/rails-5-1-system-test-sandbox/tree/rspec-3-7" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/rails-5-1-system-test-sandbox/tree/rspec-3-7</a></p>

<h3>
<span id="chromeとchromedriverをインストールする" class="fragment"></span><a href="#chrome%E3%81%A8chromedriver%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ChromeとChromeDriverをインストールする</h3>

<p>System SpecではChromeとChromeDriverをマシンにインストールする必要があります。<br>
どちらも最新版をインストールするようにしましょう。</p>

<p>ChromeDriverのインストールはいくつか方法があります。</p>

<ul>
<li>
<a href="https://sites.google.com/a/chromium.org/chromedriver/downloads" rel="nofollow noopener" target="_blank">自分でダウンロード</a>してPATHの通ったディレクトリに置く。</li>
<li>Homebrewでインストールする。</li>
</ul>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span># 新規インストール
$ brew install chromedriver

# 最新版にアップデート
$ brew upgrade chromedriver
</pre></div></div>

<ul>
<li>
<a href="https://github.com/flavorjones/chromedriver-helper" rel="nofollow noopener" target="_blank">chromedriver-helper</a> gemを使う。</li>
</ul>

<p>今回は一番手軽なchromedriver-helper gemを使うことにします。<br>
Gemfileにchromedriver-helperを追加して、<code>bundle install</code>してください。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">gem</span> <span class="s1">'chromedriver-helper'</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="rails-51以上であることを確認する" class="fragment"></span><a href="#rails-51%E4%BB%A5%E4%B8%8A%E3%81%A7%E3%81%82%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Rails 5.1以上であることを確認する</h3>

<p>System SpecはRailsのSystemTestCaseを利用するため、Rails 5.1以上であることが必須です。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'~&gt; 5.1.4'</span>
</pre></div>
</div>

<h3>
<span id="テスト関連のgemをインストールアップデートする" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E9%96%A2%E9%80%A3%E3%81%AEgem%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>テスト関連のgemをインストール/アップデートする</h3>

<p>テストに必要なgemを追加して、<code>bundle install</code>します。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<div class="highlight"><pre><span></span><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span>
<span class="k">end</span>
</pre></div>
</div>

<p>これまでRSpecを使っていなかった場合は、以下のコマンドで必要なファイルも追加してください。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails generate rspec:install
</pre></div></div>

<p>既存のプロジェクトですでにテスト用のgemがインストールされていた場合は、以下のコマンドで各種gemを最新版にアップデートしておきましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ bundle update rspec-rails capybara selenium-webdriver
</pre></div></div>

<h3>
<span id="system-specを書く" class="fragment"></span><a href="#system-spec%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>System Specを書く</h3>

<p>System Specを配置するspec/systemディレクトリを作ります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ mkdir spec/system
</pre></div></div>

<p>今回は<code>users_spec.rb</code>というファイルにSystem Specを書きます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ touch spec/system/users_spec.rb
</pre></div></div>

<p><code>users_spec.rb</code>に次のようなコードを書きます。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec/system/users_spec.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="s1">'Users'</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:system</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">'いとう'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'completes yubinbango automatically with JS'</span> <span class="k">do</span>
    <span class="c1"># User編集画面を開く</span>
    <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>

    <span class="c1"># Nameに"いとう"が入力されていることを検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_field</span> <span class="s1">'名前'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'いとう'</span>

    <span class="c1"># 郵便番号を入力</span>
    <span class="n">fill_in</span> <span class="s1">'郵便番号'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'158-0083'</span>
    <span class="c1"># 住所が自動入力されたことを検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_field</span> <span class="s1">'住所'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'東京都世田谷区奥沢'</span>

    <span class="c1"># 更新実行</span>
    <span class="n">click_button</span> <span class="s1">'Update User'</span>

    <span class="c1"># 正しく更新されていること（＝画面の表示が正しいこと）を検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'User was successfully updated.'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'いとう'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'158-0083'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'東京都世田谷区奥沢'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>3行目で<code>type: :system</code>と書いてあるのがポイントです。<br>
これでこのテストがSystem Specであることを宣言しています。</p>

<p>それ以外は基本的にFeature Specと書き方は変わりません。</p>

<h3>
<span id="system-specを実行する" class="fragment"></span><a href="#system-spec%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>System Specを実行する</h3>

<p>テストが書き終わったら、テストを実行してみましょう。<br>
実行方法は通常のRSpecの場合と変わりません。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails spec
</pre></div></div>

<p>セットアップがうまくいっていれば、自動的にChromeが起動してSystem Testで書いた内容を実行してくれるはずです。</p>

<p>Feature Specでは必要だったDatabaseCleaner/DatabaseRewinder用の設定や、<code>rails_helper.rb</code>での<code>Capybara.javascript_driver</code>の指定は不要になります。</p>

<h2>
<span id="応用編" class="fragment"></span><a href="#%E5%BF%9C%E7%94%A8%E7%B7%A8"><i class="fa fa-link"></i></a>応用編</h2>

<h3>
<span id="describeitではなくfeaturescenarioを使う" class="fragment"></span><a href="#describeit%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Ffeaturescenario%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>describe/itではなく、feature/scenarioを使う</h3>

<p>サンプルコードではdescribe/itを使っていますが、Feature Specと同様にfeature/scenarioを使って書くこともできます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="o">.</span><span class="n">feature</span> <span class="s1">'Users'</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:system</span> <span class="k">do</span>
  <span class="n">background</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">'いとう'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">scenario</span> <span class="s1">'completes yubinbango automatically with JS'</span> <span class="k">do</span>
    <span class="c1"># User編集画面を開く</span>
    <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>

    <span class="c1"># Nameに"いとう"が入力されていることを検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_field</span> <span class="s1">'名前'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'いとう'</span>

    <span class="c1"># 郵便番号を入力</span>
    <span class="n">fill_in</span> <span class="s1">'郵便番号'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'158-0083'</span>
    <span class="c1"># 住所が自動入力されたことを検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_field</span> <span class="s1">'住所'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">'東京都世田谷区奥沢'</span>

    <span class="c1"># 更新実行</span>
    <span class="n">click_button</span> <span class="s1">'Update User'</span>

    <span class="c1"># 正しく更新されていること（＝画面の表示が正しいこと）を検証する</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'User was successfully updated.'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'いとう'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'158-0083'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span> <span class="s1">'東京都世田谷区奥沢'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="ヘッドレスモードのchromeで実行する" class="fragment"></span><a href="#%E3%83%98%E3%83%83%E3%83%89%E3%83%AC%E3%82%B9%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AEchrome%E3%81%A7%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ヘッドレスモードのChromeで実行する</h3>

<p>ヘッドレスモード（画面を起動しないモード）でChromeを実行する場合は、<code>rails_helper.rb</code>に次の設定を追加します。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec/rails_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>

  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:system</span>
      <span class="n">caps</span> <span class="o">=</span> <span class="no">Selenium</span><span class="o">::</span><span class="no">WebDriver</span><span class="o">::</span><span class="no">Remote</span><span class="o">::</span><span class="no">Capabilities</span><span class="o">.</span><span class="n">chrome</span><span class="p">(</span><span class="s2">"chromeOptions"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s2">"args"</span> <span class="o">=&gt;</span> <span class="sx">%w(--headless --disable-gpu)</span><span class="p">})</span>
      <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:chrome</span><span class="p">,</span> <span class="ss">screen_size</span><span class="p">:</span> <span class="o">[</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1400</span><span class="o">]</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span> <span class="p">{</span> <span class="ss">desired_capabilities</span><span class="p">:</span> <span class="n">caps</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p><strong>2017.10.29 追記: 上の設定をもっとシンプルに書く</strong></p>

<p><a href="https://medium.com/table-xi/a-quick-guide-to-rails-system-tests-in-rspec-b6e9e8a8b5f6" rel="nofollow noopener" target="_blank">こちらのブログ</a>を参考にしたら、次のように簡単に書くことができました。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec/rails_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>

  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:system</span>
      <span class="n">driven_by</span> <span class="ss">:selenium_chrome_headless</span><span class="p">,</span> <span class="ss">screen_size</span><span class="p">:</span> <span class="o">[</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1400</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="js-trueのときだけchromeを起動する" class="fragment"></span><a href="#js-true%E3%81%AE%E3%81%A8%E3%81%8D%E3%81%A0%E3%81%91chrome%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>js: trueのときだけ、Chromeを起動する</h3>

<p>System Specは毎回Chromeが起動しますが、JavaScriptがなくても実行可能なテストであれば、Chromeなしで検証した方が速度面で有利です。<br>
<code>rails_helper.rb</code>に次のような設定を書けば、Feature Specのときと同じように、<code>js: true</code>のタグが付いているときだけChromeが起動するようになります。</p>

<div class="code-frame" data-lang="rb">
<div class="code-lang"><span class="bold">spec/rails_helper.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>

  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:system</span>
      <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:js</span><span class="o">]</span>
        <span class="n">driven_by</span> <span class="ss">:selenium_chrome_headless</span><span class="p">,</span> <span class="ss">screen_size</span><span class="p">:</span> <span class="o">[</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1400</span><span class="o">]</span>
      <span class="k">else</span>
        <span class="n">driven_by</span> <span class="ss">:rack_test</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<p>System SpecにもJSを使う必要があるテストにだけ、<code>js: true</code>のタグを付けます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="s1">'Users'</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:system</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">it</span> <span class="s1">'completes yubinbango automatically with JS'</span><span class="p">,</span> <span class="ss">js</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span>
    <span class="c1"># JSを使う必要があるテストを書く</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'does not complete yubinbango automatically without JS'</span> <span class="k">do</span>
    <span class="c1"># JSを使わずに済むテストを書く</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="テスト失敗時のスクリーンショットを確認する" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E5%A4%B1%E6%95%97%E6%99%82%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>テスト失敗時のスクリーンショットを確認する</h3>

<p>テストが途中で失敗した場合は、tmp/screenshotsディレクトリにスクリーンショットが保存されます。</p>

<p><a href="https://camo.qiitausercontent.com/72bb13f4b7ebb308221fa7a331640a3d5b632fa7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f30383033616261622d353965312d653532322d363333322d3438643832356538373235332e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/72bb13f4b7ebb308221fa7a331640a3d5b632fa7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f30383033616261622d353965312d653532322d363333322d3438643832356538373235332e706e67" alt="Screen Shot 2017-10-24 at 7.02.15.png" title="Screen Shot 2017-10-24 at 7.02.15.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/0803abab-59e1-e522-6332-48d825e87253.png"></a></p>

<h3>
<span id="ciでsystem-specを実行する" class="fragment"></span><a href="#ci%E3%81%A7system-spec%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>CIでSystem Specを実行する</h3>

<p>参考までにTravis CIとCircleCIでSystem Specを実行する場合の設定例を載せておきます。</p>

<p>いずれも「Chromeはヘッドレスモードで起動」「ChromeDriverはchromedriver-helperでインストール」する場合の設定です。<br>
必要なのは最新版のChromeをインストールすることだけですね。</p>

<div class="code-frame" data-lang="yml">
<div class="code-lang"><span class="bold">.travis.yml</span></div>
<div class="highlight"><pre><span></span>sudo: required
dist: trusty
language: ruby
rvm:
  - 2.4.2
cache: bundler
bundler_args: --without production --deployment

before_install:
  - gem install bundler --pre

  # Install latest Chrome
  - sudo apt-get update
  - sudo apt-get install -y libappindicator1 fonts-liberation
  - export CHROME_BIN=/usr/bin/google-chrome
  - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  - sudo dpkg -i google-chrome*.deb
script:
  - bundle exec rspec spec
</pre></div>
</div>

<div class="code-frame" data-lang="yml">
<div class="code-lang"><span class="bold">circle.yml</span></div>
<div class="highlight"><pre><span></span>general:
  artifacts:
    - "tmp/capybara"
machine:
  timezone:
    Asia/Tokyo
  ruby:
    version:
      2.4.2
test:
  override:
    - bundle exec rspec spec
dependencies:
  pre:
    # Install latest Chrome
    - sudo apt-get update
    - sudo apt-get install -y libappindicator1 fonts-liberation
    - export CHROME_BIN=/usr/bin/google-chrome
    - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo dpkg -i google-chrome*.deb
</pre></div>
</div>

<p>こちらはCircleCI 2.0用の設定例です。</p>

<div class="code-frame" data-lang="yaml">
<div class="code-lang"><span class="bold">.circleci/config.yml</span></div>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="l l-Scalar l-Scalar-Plain">jobs</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">docker</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">circleci/ruby:2.4.2-node-browsers</span>
    <span class="l l-Scalar l-Scalar-Plain">working_directory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/rails-5-1-sandbox</span>
    <span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">checkout</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install System Dependencies</span>
          <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
            <span class="no">sudo apt-get update</span>
            <span class="no">sudo apt-get install -y libappindicator1 fonts-liberation</span>
            <span class="no">export CHROME_BIN=/usr/bin/google-chrome</span>
            <span class="no">wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</span>
            <span class="no">sudo dpkg -i google-chrome*.deb</span>

      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">restore_cache</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">keys</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">v1-dependencies-{{ checksum "Gemfile.lock" }}</span>
            <span class="c1"># fallback to using the latest cache if no exact match is found</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">v1-dependencies-</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Bundle Install</span>
          <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
            <span class="no">bundle install --jobs=4 --retry=3 --path vendor/bundle</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">save_cache</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vendor/bundle</span>
          <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1-dependencies-{{ checksum "Gemfile.lock" }}</span>

      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create DB</span>
          <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bundle exec rake db:create db:schema:load --trace</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Run Tests</span>
          <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">RAILS_ENV=test bundle exec rspec</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">store_test_results</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/test-results</span>
</pre></div>
</div>

<p>CircleCI 2.0の設定例についてはこちらのブログも参考になると思います。</p>

<ul>
<li><a href="https://medium.com/table-xi/a-quick-guide-to-rails-system-tests-in-rspec-b6e9e8a8b5f6" rel="nofollow noopener" target="_blank">A Quick Guide to Rails System Tests in RSpec – Table XI – Medium</a></li>
</ul>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、この記事ではrspec-rails 3.7で導入されたSystem Specの使い方を説明しました。</p>

<p>従来のFeature Specと一緒と言えば一緒なんですが、System SpecはRailsが標準で用意してくれているSystemTestCaseをラップしてくれているので、そのぶん手軽に導入でき、なおかつスクリーンショットの自動撮影のような便利な機能も使えるようになっています。</p>

<p>僕自身はまだ本格的には使い込んでいないものの、これなら今後は全部System Specに置き換えていっても大丈夫そうだなと感じています。</p>

<p>みなさんもぜひrspec-rails 3.7のSystem Specを試してみてください！</p>

<h3>
<span id="あわせて読みたい" class="fragment"></span><a href="#%E3%81%82%E3%82%8F%E3%81%9B%E3%81%A6%E8%AA%AD%E3%81%BF%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>あわせて読みたい</h3>

<p>System Specでもブラウザの実行や画面要素の検証ではCapybaraを使います。<br>
Capybaraの詳しい使い方についてはこちらの記事が参考になると思います。</p>

<ul>
<li><a href="https://qiita.com/jnchito/items/607f956263c38a5fec24" id="reference-dd02bb2e359cf682f4e8">使えるRSpec入門・その4「どんなブラウザ操作も自由自在！逆引きCapybara大辞典」 - Qiita</a></li>
</ul>

<p>「そもそもRSpecがよくわかってないんだけど・・・」という方は、こちらの入門記事をご覧ください。</p>

<ul>
<li><a href="https://qiita.com/jnchito/items/42193d066bd61c740612" id="reference-e792b04c14958d283655">使えるRSpec入門・その1「RSpecの基本的な構文や便利な機能を理解する」 - Qiita</a></li>
</ul>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />5位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>42</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/c71b8f66f61214227555">【翻訳】&quot;Factory Girl&quot;が&quot;Factory Bot&quot;に変わった理由（と移行手順）</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-11-01 17:01:11</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Rails]</b> <b>[FactoryGirl]</b> <b>[FactoryBot]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;"><p>2017年10月に、Rubyのライブラリ(gem)である"Factory Girl"が"Factory Bot"に変わりました。</p>

<p>名前が変わった理由が以下のページに記載されていたので、翻訳してみます。</p>

<p><a href="https://github.com/thoughtbot/factory_bot/blob/master/NAME.md" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/thoughtbot/factory_bot/blob/master/NAME.md</a></p>

<h2>
<span id="プロジェクト名の歴史" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%90%8D%E3%81%AE%E6%AD%B4%E5%8F%B2"><i class="fa fa-link"></i></a>プロジェクト名の歴史</h2>

<h3>
<span id="factory-girl" class="fragment"></span><a href="#factory-girl"><i class="fa fa-link"></i></a>Factory Girl</h3>

<p>このライブラリはもともと2008年に"Factory Girl"という名前でリリースされました。</p>

<p>この名前を選んだ理由は書籍「デザインパターン」に載っていたファクトリメソッドパターンとオブジェクトの母（Object Mother）パターンに従っていたことと、ローリング・ストーンズに同じ名前の曲があったためです。</p>

<h3>
<span id="factory-bot" class="fragment"></span><a href="#factory-bot"><i class="fa fa-link"></i></a>Factory Bot</h3>

<p>"Factory Girl"という名前はこのライブラリの存在を知った一部の開発者を混乱させました。また、不快で問題があるように感じる人々もいました。そのため、2017年10月に私たちはこのライブラリの名前を"Factory Bot"に変更しました。</p>

<p>（翻訳ここまで）</p>

<p>名前が変更される詳しい経緯については以下のissueも参考になります。</p>

<ul>
<li><a href="https://github.com/thoughtbot/factory_bot/issues/921" rel="nofollow noopener" target="_blank">Repository Name · Issue #921 · thoughtbot/factory_bot</a></li>
</ul>

<h2>
<span id="参考factory-girlからfactory-botへ移行する方法" class="fragment"></span><a href="#%E5%8F%82%E8%80%83factory-girl%E3%81%8B%E3%82%89factory-bot%E3%81%B8%E7%A7%BB%E8%A1%8C%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>参考：Factory GirlからFactory Botへ移行する方法</h2>

<p>Factory BotとFactory Girlは名前が違うだけで基本的に同じものです。<br>
Railsプロジェクトの場合、移行したい場合は次のようにします。</p>

<h3>
<span id="1-gemfileを更新してbundle-install" class="fragment"></span><a href="#1-gemfile%E3%82%92%E6%9B%B4%E6%96%B0%E3%81%97%E3%81%A6bundle-install"><i class="fa fa-link"></i></a>1. Gemfileを更新してbundle install</h3>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre><span></span>  # Gemfile 
<span class="gd">- gem 'factory_girl_rails'</span>
<span class="gi">+ gem 'factory_bot_rails'</span>
</pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ bundle install
</pre></div></div>

<h3>
<span id="2-プロジェクト内のfactorygirlをfactorybotに置換" class="fragment"></span><a href="#2-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%86%85%E3%81%AEfactorygirl%E3%82%92factorybot%E3%81%AB%E7%BD%AE%E6%8F%9B"><i class="fa fa-link"></i></a>2. プロジェクト内のFactoryGirlをFactoryBotに置換</h3>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre><span></span>  # spec/factories/users.rb
<span class="gd">- FactoryGirl.define do</span>
<span class="gi">+ FactoryBot.define do</span>
</pre></div></div>

<h3>
<span id="3-プロジェクト内のfactory_girlをfactory_botに置換" class="fragment"></span><a href="#3-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%86%85%E3%81%AEfactory_girl%E3%82%92factory_bot%E3%81%AB%E7%BD%AE%E6%8F%9B"><i class="fa fa-link"></i></a>3. プロジェクト内のfactory_girlをfactory_botに置換</h3>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre><span></span><span class="gd">- g.fixture_replacement :factory_girl, dir: "spec/factories"</span>
<span class="gi">+ g.fixture_replacement :factory_bot, dir: "spec/factories"</span>
</pre></div></div>

<h3>
<span id="4-テストがすべてパスすることを確認" class="fragment"></span><a href="#4-%E3%83%86%E3%82%B9%E3%83%88%E3%81%8C%E3%81%99%E3%81%B9%E3%81%A6%E3%83%91%E3%82%B9%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>4. テストがすべてパスすることを確認</h3>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><span></span>$ rails spec
</pre></div></div>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />6位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>17</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/f07e58824f92395c353b">【初心者向け・動画付き】たい焼きクラスで学ぶ、楽しいオブジェクト指向プログラミング入門</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-30 10:40:59</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[oop]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>先日、こちらのQiita記事を拝見しました。</p>

<p><a href="https://qiita.com/daisakuhazui/items/920bca4fe1ad28c77cef" id="reference-3c2e839fa8d687a9d227">クラスとオブジェクトの関係性 - Qiita</a></p>

<p>この記事では「たい焼きの型」をクラスと見なして、クラスとオブジェクトの違いを説明しています。<br>
ただ、着眼点は良かったのですが、記事の中で使われているサンプルコードが少しオブジェクト指向プログラミングの面白さを伝え切れていないように感じました。</p>

<p>そこでこの記事では「たい焼き」をお題にして、オブジェクト指向プログラミングの考え方（というか、面白さ）を簡単に説明していきます。</p>

<h2>
<span id="動画がメインです" class="fragment"></span><a href="#%E5%8B%95%E7%94%BB%E3%81%8C%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>動画がメインです！</h2>

<p>この記事の内容はYouTubeで解説しています。<br>
というか、動画の方がメインで、この記事はオマケです。<br>
ぜひ最初に動画の方をチェックしてください！</p>

<p><a href="https://www.youtube.com/watch?v=HsivL1JBRaw&amp;feature=youtu.be" rel="nofollow noopener" target="_blank">【初心者向け】たい焼きクラスで学ぶ、楽しいオブジェクト指向プログラミング入門 - YouTube<img src="https://camo.qiitausercontent.com/973acd4e2558651e1d8b93326d55c1844293039f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f65643934656135392d663833322d363438342d346434642d6366323163633337626438362e706e67" alt="Screen Shot 2017-09-30 at 10.38.23.png" title="Screen Shot 2017-09-30 at 10.38.23.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/ed94ea59-f832-6484-4d4d-cf21cc37bd86.png"></a></p>

<p>ちなみに、動画の長さは30分ちょっとあるので、1.5倍速ぐらいで見ることをオススメします。</p>

<h2>
<span id="コードはgithubに置いています" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AFgithub%E3%81%AB%E7%BD%AE%E3%81%84%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99"><i class="fa fa-link"></i></a>コードはGitHubに置いています</h2>

<p>ソースコードはGitHubに置いてあるので、必要に応じてこちらも参照してください。</p>

<p><a href="https://github.com/JunichiIto/taiyaki-sandbox" rel="nofollow noopener" target="_blank">JunichiIto/taiyaki-sandbox: Sample app for object oriented programming</a></p>

<h2>
<span id="minitestで動作確認しています" class="fragment"></span><a href="#minitest%E3%81%A7%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99"><i class="fa fa-link"></i></a>Minitestで動作確認しています</h2>

<p>動画を見てもらうとわかると思いますが、作成したコードはMinitestを使って動作確認しています。<br>
あまり難しいことはやっていないと思いますが、何をやってるのかようわからん、という方はこちらの記事を参考にしてみてください。<br>
（test-unitの話がメインですが、記事の後半にMinitestの話も出てきます）</p>

<p><a href="https://qiita.com/jnchito/items/ff4f7a23addbd8dbc460" id="reference-5ed402b46853d4a33af9">Ruby標準のテスティングフレームワークで手軽にテストコードを書く方法 - Qiita</a></p>

<h2>
<span id="本物のたい焼きをイメージしながらコードを書いていきます" class="fragment"></span><a href="#%E6%9C%AC%E7%89%A9%E3%81%AE%E3%81%9F%E3%81%84%E7%84%BC%E3%81%8D%E3%82%92%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%84%E3%81%8D%E3%81%BE%E3%81%99"><i class="fa fa-link"></i></a>本物のたい焼きをイメージしながらコードを書いていきます</h2>

<p>動画の中ではこちらのWebサイトを見ながら、「本物のたい焼き」をイメージしています。<br>
（ただし、このサイトの情報どおりに実装しているわけではありません）</p>

<p><a href="http://www.ginnoan.com/contents/menu/index.html" rel="nofollow noopener" target="_blank">薄焼たい焼　銀のあん</a></p>

<p><a href="https://camo.qiitausercontent.com/fb4f9b3679cd58686142766b6ab8795579428e6f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f39616564346165622d333135332d303636612d363238342d6133656164643264643565382e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/fb4f9b3679cd58686142766b6ab8795579428e6f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f39616564346165622d333135332d303636612d363238342d6133656164643264643565382e706e67" alt="Screen Shot 2017-09-30 at 10.13.29.png" title="Screen Shot 2017-09-30 at 10.13.29.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/9aed4aeb-3153-066a-6284-a3eadd2dd5e8.png"></a></p>

<p>「本物のたい焼きはどんな状態を持つか？」ということを考えながらTaiyakiクラスを実装していくと、よりいっそう楽しくオブジェクト指向プログラミングができるできるはずです！</p>

<h2>
<span id="step-0-taiyakiクラスを定義する" class="fragment"></span><a href="#step-0-taiyaki%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Step 0. Taiyakiクラスを定義する</h2>

<p>何はともあれ、Taiyakiクラスを定義してあげましょう。<br>
中身はこれから実装していきます。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Taiyaki</span>
<span class="k">end</span>
</pre></div></div>

<h2>
<span id="step-1-あんこの種類を保持できるようにする" class="fragment"></span><a href="#step-1-%E3%81%82%E3%82%93%E3%81%93%E3%81%AE%E7%A8%AE%E9%A1%9E%E3%82%92%E4%BF%9D%E6%8C%81%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Step 1. 「あんこ」の種類を保持できるようにする</h2>

<p>Taiyakiクラスにインスタンス変数の<code>@anko</code>を追加し、「あんこ」の種類を保持できるようにします。</p>

<p>ここでは以下の2種類を想定します。</p>

<ul>
<li>あずき</li>
<li>白あん</li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'minitest/autorun'</span>

<span class="k">class</span> <span class="nc">Taiyaki</span>
  <span class="kp">attr_reader</span> <span class="ss">:anko</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">anko</span><span class="p">)</span>
    <span class="vi">@anko</span> <span class="o">=</span> <span class="n">anko</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TaiyakiTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="k">def</span> <span class="nf">test_taiyaki</span>
    <span class="n">taiyaki_1</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'あずき'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s1">'あずき'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">anko</span>

    <span class="n">taiyaki_2</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'白あん'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s1">'白あん'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">anko</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h2>
<span id="step-2-大きさを保持できるようにする" class="fragment"></span><a href="#step-2-%E5%A4%A7%E3%81%8D%E3%81%95%E3%82%92%E4%BF%9D%E6%8C%81%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Step 2. 「大きさ」を保持できるようにする</h2>

<p>Taiyakiクラスにインスタンス変数の<code>@size</code>を追加し、「大きさ」を保持できるようにします。</p>

<p>ここでは以下の2種類を想定します。</p>

<ul>
<li>ふつう</li>
<li>大きめ</li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'minitest/autorun'</span>

<span class="k">class</span> <span class="nc">Taiyaki</span>
  <span class="kp">attr_reader</span> <span class="ss">:anko</span><span class="p">,</span> <span class="ss">:size</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">anko</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="vi">@anko</span> <span class="o">=</span> <span class="n">anko</span>
    <span class="vi">@size</span> <span class="o">=</span> <span class="n">size</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TaiyakiTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="k">def</span> <span class="nf">test_taiyaki</span>
    <span class="n">taiyaki_1</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'あずき'</span><span class="p">,</span> <span class="s1">'ふつう'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s1">'あずき'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">anko</span>
    <span class="n">assert_equal</span> <span class="s1">'ふつう'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">size</span>

    <span class="n">taiyaki_2</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'白あん'</span><span class="p">,</span> <span class="s1">'大きめ'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s1">'白あん'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">anko</span>
    <span class="n">assert_equal</span> <span class="s1">'大きめ'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">size</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h2>
<span id="step-3-自分の状態を文字列として返せるようにする" class="fragment"></span><a href="#step-3-%E8%87%AA%E5%88%86%E3%81%AE%E7%8A%B6%E6%85%8B%E3%82%92%E6%96%87%E5%AD%97%E5%88%97%E3%81%A8%E3%81%97%E3%81%A6%E8%BF%94%E3%81%9B%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Step 3. 自分の状態を文字列として返せるようにする</h2>

<p>たい焼きに保持されているあんことサイズを文字列として返せるように、<code>to_s</code>メソッドを実装（オーバーライド）します。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'minitest/autorun'</span>

<span class="k">class</span> <span class="nc">Taiyaki</span>
  <span class="kp">attr_reader</span> <span class="ss">:anko</span><span class="p">,</span> <span class="ss">:size</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">anko</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="vi">@anko</span> <span class="o">=</span> <span class="n">anko</span>
    <span class="vi">@size</span> <span class="o">=</span> <span class="n">size</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_s</span>
    <span class="s2">"あんこ: </span><span class="si">#{</span><span class="n">anko</span><span class="si">}</span><span class="s2">, 大きさ: </span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TaiyakiTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="k">def</span> <span class="nf">test_taiyaki</span>
    <span class="n">taiyaki_1</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'あずき'</span><span class="p">,</span> <span class="s1">'ふつう'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s1">'あずき'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">anko</span>
    <span class="n">assert_equal</span> <span class="s1">'ふつう'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">size</span>
    <span class="n">assert_equal</span> <span class="s1">'あんこ: あずき, 大きさ: ふつう'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">taiyaki_2</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'白あん'</span><span class="p">,</span> <span class="s1">'大きめ'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s1">'白あん'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">anko</span>
    <span class="n">assert_equal</span> <span class="s1">'大きめ'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">size</span>
    <span class="n">assert_equal</span> <span class="s1">'あんこ: 白あん, 大きさ: 大きめ'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h2>
<span id="step-4-値段を計算できるようにする" class="fragment"></span><a href="#step-4-%E5%80%A4%E6%AE%B5%E3%82%92%E8%A8%88%E7%AE%97%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Step 4. 「値段」を計算できるようにする</h2>

<p>ここでは以下のルールで値段を計算します。</p>

<ul>
<li>ベースとなる値段は100円</li>
<li>白あんを選ぶと30円プラス</li>
<li>大きめを選ぶと50円プラス</li>
</ul>

<p>上のルールに従って値段を返せるように、Taiyakiクラスに<code>price</code>メソッドを追加します。<br>
また、<code>to_s</code>メソッドにも値段を出力するようにします。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'minitest/autorun'</span>

<span class="k">class</span> <span class="nc">Taiyaki</span>
  <span class="kp">attr_reader</span> <span class="ss">:anko</span><span class="p">,</span> <span class="ss">:size</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">anko</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="vi">@anko</span> <span class="o">=</span> <span class="n">anko</span>
    <span class="vi">@size</span> <span class="o">=</span> <span class="n">size</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">price</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="n">anko</span> <span class="o">==</span> <span class="s1">'白あん'</span>
      <span class="n">amount</span> <span class="o">+=</span> <span class="mi">30</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="s1">'大きめ'</span>
      <span class="n">amount</span> <span class="o">+=</span> <span class="mi">50</span>
    <span class="k">end</span>
    <span class="n">amount</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_s</span>
    <span class="s2">"あんこ: </span><span class="si">#{</span><span class="n">anko</span><span class="si">}</span><span class="s2">, 大きさ: </span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">price</span><span class="si">}</span><span class="s2">円"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TaiyakiTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="k">def</span> <span class="nf">test_taiyaki</span>
    <span class="n">taiyaki_1</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'あずき'</span><span class="p">,</span> <span class="s1">'ふつう'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s1">'あずき'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">anko</span>
    <span class="n">assert_equal</span> <span class="s1">'ふつう'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">size</span>
    <span class="n">assert_equal</span> <span class="mi">100</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">price</span>
    <span class="n">assert_equal</span> <span class="s1">'あんこ: あずき, 大きさ: ふつう, 100円'</span><span class="p">,</span> <span class="n">taiyaki_1</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">taiyaki_2</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'白あん'</span><span class="p">,</span> <span class="s1">'大きめ'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s1">'白あん'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">anko</span>
    <span class="n">assert_equal</span> <span class="s1">'大きめ'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">size</span>
    <span class="n">assert_equal</span> <span class="mi">180</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">price</span>
    <span class="n">assert_equal</span> <span class="s1">'あんこ: 白あん, 大きさ: 大きめ, 180円'</span><span class="p">,</span> <span class="n">taiyaki_2</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">taiyaki_3</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'あずき'</span><span class="p">,</span> <span class="s1">'大きめ'</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="mi">150</span><span class="p">,</span> <span class="n">taiyaki_3</span><span class="o">.</span><span class="n">price</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h2>
<span id="step-5-賞味期限を管理できるようにする" class="fragment"></span><a href="#step-5-%E8%B3%9E%E5%91%B3%E6%9C%9F%E9%99%90%E3%82%92%E7%AE%A1%E7%90%86%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Step 5. 「賞味期限」を管理できるようにする</h2>

<p>ここでは製造日の3日後を賞味期限に設定します。<br>
これに伴い、以下のインスタンスメソッドを追加します。</p>

<ul>
<li>
<code>produced_on</code> 製造日（システム日付）を返す</li>
<li>
<code>expire_on</code> 賞味期限（製造日の3日後）を返す</li>
<li>
<code>expired?</code> 賞味期限が過ぎていれば<code>true</code>、そうでなければ<code>false</code>
</li>
</ul>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">'minitest/autorun'</span>
<span class="nb">require</span> <span class="s1">'date'</span>

<span class="k">class</span> <span class="nc">Taiyaki</span>
  <span class="kp">attr_reader</span> <span class="ss">:anko</span><span class="p">,</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:produced_on</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">anko</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="vi">@anko</span> <span class="o">=</span> <span class="n">anko</span>
    <span class="vi">@size</span> <span class="o">=</span> <span class="n">size</span>
    <span class="vi">@produced_on</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span>
  <span class="k">end</span>

  <span class="c1"># 省略</span>

  <span class="k">def</span> <span class="nf">expire_on</span>
    <span class="n">produced_on</span> <span class="o">+</span> <span class="mi">3</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">expired?</span><span class="p">(</span><span class="n">today</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span>
    <span class="n">expire_on</span> <span class="o">&lt;</span> <span class="n">today</span>
  <span class="k">end</span>

  <span class="c1"># 省略</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TaiyakiTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="c1"># 省略</span>

  <span class="k">def</span> <span class="nf">test_expired</span>
    <span class="n">taiyaki</span> <span class="o">=</span> <span class="no">Taiyaki</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'あずき'</span><span class="p">,</span> <span class="s1">'ふつう'</span><span class="p">)</span>

    <span class="c1"># 製造日 = システム日付</span>
    <span class="n">assert_equal</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">,</span> <span class="n">taiyaki</span><span class="o">.</span><span class="n">produced_on</span>

    <span class="c1"># 賞味期限 = 製造日 + 3日</span>
    <span class="n">assert_equal</span> <span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">taiyaki</span><span class="o">.</span><span class="n">expire_on</span>

    <span class="c1"># 当日なら食べられる</span>
    <span class="n">refute</span> <span class="n">taiyaki</span><span class="o">.</span><span class="n">expired?</span>

    <span class="c1"># 3日目まで食べられる</span>
    <span class="n">refute</span> <span class="n">taiyaki</span><span class="o">.</span><span class="n">expired?</span><span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># 4日目を過ぎると食べられない</span>
    <span class="n">assert</span> <span class="n">taiyaki</span><span class="o">.</span><span class="n">expired?</span><span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<p>まだまだ「たい焼きクラス」で遊べそうな気がしますが、この例題はこれでおしまいです。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>というわけで、この記事では「たい焼きクラス」を使ってオブジェクト指向プログラミングの考え方を簡単に説明してみました。</p>

<p>このように、オブジェクト指向プログラミングではクラスを定義し、その中にデータ（インスタンス変数）とメソッドを持たせることで、実在する物（オブジェクト）に近い形でプログラミングをすることができます。</p>

<p>とりあえず、この記事ではあまり難しいことを言うつもりはありません。<br>
今までクラスやオブジェクトと言われてもピンと来なかった人が、この記事（と動画）を見て、「へ～、オブジェクト指向プログラミングってなんか面白い」と思ってもらえればそれでOKです。</p>

<p>詳しい話は後述する参考文献などで勉強してみてください。</p>

<h2>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h2>

<p><a href="http://amzn.to/2hD8dg2" rel="nofollow noopener" target="_blank">オブジェクト指向設計実践ガイド ~Rubyでわかる 進化しつづける柔軟なアプリケーションの育て方</a></p>

<p>オブジェクト指向設計やオブジェクト指向プログラミングを本格的に学びたい！というRubyプログラマの人にはこちらの本がオススメです。</p>

<p><a href="http://blog.jnito.com/entry/2017/05/30/120148" rel="nofollow noopener" target="_blank">プロを目指す人のためのRuby入門（2017年11月発売）</a></p>

<p>僕（伊藤淳一）が現在制作中のRubyの入門書です。<br>
この本の中でもRubyにおけるオブジェクト指向プログラミングの考え方をあれこれ説明しています。</p>

<p><a href="http://blog.jnito.com/entry/20100503/1272838579" rel="nofollow noopener" target="_blank">オブジェクト指向関連書籍リスト - give IT a try</a></p>

<p>僕がその昔読んだオブジェクト指向関連の書籍一覧です。<br>
ただ、記事を書いたのがかなり前なので、絶版になっている本も多いかもしれません。</p>
</div>
	</td>
</tr>
</table>
<br />
<table border="1">
<tr>
	<td rowspan="3"><center>jnchitoさんの<br />7位</center></td>
	<td colspan="4">
		<kbd><i><img alt="いいね" width="16" height="16" src="../thumb-up-120px.png" /></i>17</kbd>
		<a target="_blank" href="https://qiita.com/jnchito/items/c7e93c7a1fc7fc34a177">【動画付き】Railsでenumの状態を変更するリンクの作り方</a>
	</td>
</tr>
<tr>
	<td style="width:100px;"><center>投稿日時</center></td>
	<td style="width:200px;"><center>投稿者</center></td>
	<td style="width:150px;"><center>タグ</center></td>
	<td style="width:350px;"><center>本文</center></td>
</tr>
<tr>
	<td style="width:100px;">
		<!--投稿日時--><center>2017-09-27 08:57:06</center>
	</td>
	<td style="width:200px;">
		@jnchito<br />(SonicGarden Inc. 所属)<br><img width="80" height="80" src="https://qiita-image-store.s3.amazonaws.com/0/7465/profile-images/1500323590">
	</td>
	<td style="width:150px;">
		<!--タグ-->
		<center><b>[Ruby]</b> <b>[Rails]</b> <b>[RubyMine]</b> </center>
	</td>
	<td style="width:350px;">
		<!--本文-->
		<div style="width:350px;height:150px;overflow-x:hidden;overflow-y:scroll;">
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>Qiitaを見ているとこちらの記事が目に入りました。</p>

<p><a href="https://qiita.com/yusukeee/items/0e076e338f874e5d6e74" id="reference-de825f3b94c9629935fd">本当の初心者のためのenumを使った状態管理(クリック一つで状態変遷させるやつ)の実装 rails - Qiita</a></p>

<p>「ふんふん、なるほど～」と思いながら読んでいたら、GETでデータを変更しようとしていることに気づきました。</p>

<p>データを変更するのであれば、GET以外のHTTPメソッド（POST、PATCH、PUT、DELETE）を使う方がWebアプリケーションとして適切です。</p>

<p>最初は「GETを使わない方がいいですよ～」とコメントして終わろうかと思ったのですが、記事の最後の方に「初心者はview controller model route 全て具体例がないと実装できません（泣）」と書いてあります。</p>

<p>たしかに。<br>
上級者なら自力で埋められる情報の溝（不足している情報）も、初心者の人にとってはなかなか乗り越えるのが難しかったりします。</p>

<p>それならば、ということで「こうやれば実装できますよ」というのをrails newするところから動画に撮って説明してみようと思いました。</p>

<p>この記事ではその動画のポイントを説明していきます。</p>

<h2>
<span id="動画はこちらです" class="fragment"></span><a href="#%E5%8B%95%E7%94%BB%E3%81%AF%E3%81%93%E3%81%A1%E3%82%89%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>動画はこちらです</h2>

<p>サンプルアプリケーションを作成する様子はこちらに載せています。</p>

<p><a href="https://www.youtube.com/watch?v=-ZelWBGe4Ng&amp;feature=youtu.be" rel="nofollow noopener" target="_blank">Railsでenumの状態を変更するリンクの作り方 - YouTube<img src="https://camo.qiitausercontent.com/6bf129d99f5295fa7267b04563ea3fb6ee575990/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f63303830333931312d383863332d626261322d613034302d6362633361333865343134332e706e67" alt="Screen Shot 2017-09-27 at 8.50.11.png" title="Screen Shot 2017-09-27 at 8.50.11.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/c0803911-88c3-bba2-a040-cbc3a38e4143.png"></a></p>

<h3>
<span id="良くも悪くもノーカットですdroplet" class="fragment"></span><a href="#%E8%89%AF%E3%81%8F%E3%82%82%E6%82%AA%E3%81%8F%E3%82%82%E3%83%8E%E3%83%BC%E3%82%AB%E3%83%83%E3%83%88%E3%81%A7%E3%81%99droplet"><i class="fa fa-link"></i></a>良くも悪くもノーカットです<img alt=":droplet:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f4a7.png" title=":droplet:" width="20">
</h3>

<p>ちなみに、完全ノーカットでトータル36分あります。<br>
最初は10分ぐらいあればできるでしょー、と高をくくっていたんですが、途中でenumを使ったフォームの作り方で試行錯誤してしまい、時間を食ってしまいました。<br>
（言い訳すると、僕は普段<a href="https://github.com/brainspec/enumerize" rel="nofollow noopener" target="_blank">enumerize</a> gemを使うことが多く、Rails標準のenumは使ったことがないんですよね。。）</p>

<p>試行錯誤の時間が結構長いので、さっさと先に進みたい方は11:30～19:50のあたりをスキップしてください。</p>

<p>あと、どっちみち長いので動画は1.5倍速ぐらいで見た方が良いと思います。</p>

<h3>
<span id="rubymineを使ってます" class="fragment"></span><a href="#rubymine%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BE%E3%81%99"><i class="fa fa-link"></i></a>RubyMineを使ってます！</h3>

<p>動画の中では<a href="https://www.jetbrains.com/ruby/" rel="nofollow noopener" target="_blank">RubyMine</a>を使って開発しています。<br>
RubyMineを使ったRails開発に興味がある人も参考にしてみてください。</p>

<h2>
<span id="今回作成する画面" class="fragment"></span><a href="#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E7%94%BB%E9%9D%A2"><i class="fa fa-link"></i></a>今回作成する画面</h2>

<p>こんな感じでStatusをクリックすると"draft"と"published"が切り替わるリンクを作成します。</p>

<p><a href="https://camo.qiitausercontent.com/eecb51e619ef32870c76e9a35f0bbdfad9afc708/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f38386565326561352d633462382d343166632d636533372d6231373433343837303765642e676966" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/eecb51e619ef32870c76e9a35f0bbdfad9afc708/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f373436352f38386565326561352d633462382d343166632d636533372d6231373433343837303765642e676966" alt="7UM4exZ64a.gif" title="7UM4exZ64a.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/7465/88ee2ea5-c4b8-41fc-ce37-b174348707ed.gif"></a></p>

<h2>
<span id="コードはこちらです" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AF%E3%81%93%E3%81%A1%E3%82%89%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>コードはこちらです</h2>

<p>今回作成したサンプルアプリケーションは以下のGitHubリポジトリに置いています。</p>

<p><a href="https://github.com/JunichiIto/enum-sandbox" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/JunichiIto/enum-sandbox</a></p>

<p>ここを見れば、ViewもControllerもModelもRoutesも全部チェックできます。</p>

<h2>
<span id="アプリの簡単な解説" class="fragment"></span><a href="#%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E7%B0%A1%E5%8D%98%E3%81%AA%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>アプリの簡単な解説</h2>

<h3>
<span id="migration" class="fragment"></span><a href="#migration"><i class="fa fa-link"></i></a>Migration</h3>

<p>statusがenumになるカラムです。<br>
カーディナリティが低く（＝データの散らばりが少ない）、インデックスは付けても効果がなさそうなので、付けていません。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">db/migrate/20170926222713_create_articles.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CreateArticles</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">1</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:articles</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="mi">0</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="model" class="fragment"></span><a href="#model"><i class="fa fa-link"></i></a>Model</h3>

<p>モデルの実装はこんな感じです。<br>
statusを切り替えるための<code>toggle_status!</code>メソッドを用意しました。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/article.rb</span></div>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">enum</span> <span class="ss">status</span><span class="p">:</span> <span class="p">{</span> <span class="ss">draft</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">published</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">inclusion</span><span class="p">:</span> <span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="no">Article</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">keys</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">toggle_status!</span>
    <span class="k">if</span> <span class="n">draft?</span>
      <span class="n">published!</span>
    <span class="k">else</span>
      <span class="n">draft!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="routes" class="fragment"></span><a href="#routes"><i class="fa fa-link"></i></a>Routes</h3>

<p>既存のデータを書き換えるので、PATCHでtogle_statusアクションを定義しました。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<div class="highlight"><pre><span></span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:articles</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="ss">:toggle_status</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h3>
<span id="view" class="fragment"></span><a href="#view"><i class="fa fa-link"></i></a>View</h3>

<p>今回はshowの画面でstatusを変更できるようにしました。<br>
<code>link_to</code>メソッドに<code>method: :patch</code>のオプションが付いている点に注目してください。</p>

<div class="code-frame" data-lang="erb">
<div class="code-lang"><span class="bold">app/views/articles/show.html.erb</span></div>
<div class="highlight"><pre><span></span><span class="x">&lt;!-- 省略 --&gt;</span>

<span class="x">&lt;p&gt;</span>
<span class="x">  &lt;strong&gt;Status:&lt;/strong&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="vi">@article</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">article_toggle_status_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">),</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:patch</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/p&gt;</span>

<span class="x">&lt;!-- 省略 --&gt;</span>
</pre></div>
</div>

<h3>
<span id="controller" class="fragment"></span><a href="#controller"><i class="fa fa-link"></i></a>Controller</h3>

<p>Scaffoldで用意されるアクションに加えて、<code>toggle_status</code>アクションを追加しています。<br>
<code>before_action</code>に<code>:toggle_status</code>を追加することと、<code>set_article</code>メソッドの中で<code>|| params[:article_id]</code>を追加することも必要になるので注意してください。</p>

<div class="code-frame" data-lang="ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_article</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:toggle_status</span><span class="o">]</span>

  <span class="c1"># 省略</span>

  <span class="k">def</span> <span class="nf">toggle_status</span>
    <span class="vi">@article</span><span class="o">.</span><span class="n">toggle_status!</span>
    <span class="n">redirect_to</span> <span class="vi">@article</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">'Article was successfully updated.'</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="c1"># Use callbacks to share common setup or constraints between actions.</span>
    <span class="k">def</span> <span class="nf">set_article</span>
      <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="o">||</span> <span class="n">params</span><span class="o">[</span><span class="ss">:article_id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># 省略</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="system-test" class="fragment"></span><a href="#system-test"><i class="fa fa-link"></i></a>System test</h3>

<p>念のため、簡単なテストも書いておきました。<br>
リンクをクリックしたらstatusが切り替わることを検証しています。</p>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">test/system/articles_test.rb</span></div>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">"application_system_test_case"</span>

<span class="k">class</span> <span class="nc">ArticlesTest</span> <span class="o">&lt;</span> <span class="no">ApplicationSystemTestCase</span>
  <span class="nb">test</span> <span class="s1">'toggle status'</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">article_path</span><span class="p">(</span><span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">))</span>
    <span class="n">assert_link</span> <span class="s1">'published'</span>

    <span class="n">click_link</span> <span class="s1">'published'</span>
    <span class="n">assert_link</span> <span class="s1">'draft'</span>

    <span class="n">click_link</span> <span class="s1">'draft'</span>
    <span class="n">assert_link</span> <span class="s1">'published'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>こんな感じにすると、enumの状態を変更するリンクを作ることができます。</p>

<p><strong>データを変更する場合はGET以外のHTTPメソッドを使う！</strong></p>

<p>これがWebアプリケーションのセオリーですので、あまり意識していなかった人は気をつけるようにしてください。</p>
</div>
	</td>
</tr>
</table>
<br />
	</body>
</html>
